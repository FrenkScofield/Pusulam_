<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Ünite Tarama Sınavı Puan Giriş <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">
    <!--<div class="col-md-12" v-if="TCKIMLIKNOx != '56545519606'">Sayfa güncelleniyor. Daha sonra tekrar deneyiniz.</div>
    <div v-else>-->
    <div class="col-md-12">
        <div class="portlet box blue-hoki dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form collapse in" id="filters">
                <form role="form" style="padding:12px 20px">
                    <div class="row" style="line-height:34px;">
                        <c-donem controller="UniteTaramaSinavPuanGiris"
                                 @OnChange="DonemSelected">
                        </c-donem>
                    </div>
                    <div class="row" style="line-height:34px;">
                        <c-sube controller="UniteTaramaSinavPuanGiris"
                                @OnChange="SubeSelected">
                        </c-sube>
                    </div>
                    <div class="row" style="line-height:34px;">
                        <c-sinavgrup controller="UniteTaramaSinavPuanGiris"
                                     :idsube="ID_SUBE"
                                     :idset="ID_KADEME3"
                                     @OnChange="Kademe3Selected">
                        </c-sinavgrup>
                    </div>
                    <div class="row" style="line-height:34px;">
                        <c-unite-tarama-sinav controller="UniteTaramaSinavPuanGiris"
                                       :donem="DONEM"
                                       :idkademe3="ID_KADEME3"
                                       :idset="ID_UNITETARAMASINAV"
                                       @OnChange="SinavSelected">
                        </c-unite-tarama-sinav>
                    </div>
                    <div class="row" style="line-height:34px;">
                        <c-sinif-donem controller="UniteTaramaSinavPuanGiris"
                                       :idsube="ID_SUBE"
                                       :idkademe3="ID_KADEME3"
                                       :donem="DONEM"
                                       :idset="ID_SINIF"
                                       @OnChange="SinifSelected">
                        </c-sinif-donem>
                    </div>
                    <div class="row">
                        <div class="form-group" style="margin-top:10px;">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn yellow" @click="SubePuanRapor">Şube Puan Excel</button>
                                <button type="button" class="btn yellow" @click="SinifPuanRapor">Sınıf Puan Excel</button>
                                <button type="button" class="btn green" @click="OgrenciListele">Öğrenci Listele</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-if="OGRENCILIST.length>0">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Öğrenci Listesi </span>
                    <span class="caption-helper"></span>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">
                        <div class="portlet-body">
                            <table class="table table-striped table-bordered table-hover table-checkable">
                                <thead>
                                    <tr>
                                        <th style="width:80px;">NO</th>
                                        <th style="width:100px; text-align:center;">TCKİMLİKNO</th>
                                        <th>AD SOYAD</th>
                                        <th style="width:100px;">İŞLEM</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="odd gradeX" v-for="u in OGRENCILIST">
                                        <td>{{u.OGRNO}}</td>
                                        <td style="text-align:center;">{{u.TCKIMLIKNO}}</td>
                                        <td>{{u.ADSOYAD}}</td>
                                        <td><button v-for="c in u.CEVAP" style="margin:2px; width:100%;" type="button" class="btn green" @click="PuanGirModal(u.TCKIMLIKNO, c.DERS)">{{c.DERS}} Puan Gir</button></td>
                                        <td style="width: 16px!important;">
                                            <div v-for="c in u.CEVAP" style="margin:2px;">
                                                <i v-if="c.CEVAPSAYISI==0" class='fa fa-lg fa-circle-o' style="display:block; line-height:34px;" />
                                                <i v-else class='fa fa-lg fa-trash' style="display:block; line-height:34px; cursor:pointer;" title="Sil" @click="PuanSil(u.TCKIMLIKNO,c.DERS)" />
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>

    <div id="Puan_modal" class="modal fade in" tabindex="-1" data-replace="true">
        <div class="modal-dialog modal-full">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title" id="Puan_modal_title">Puan Gir</h4>
                </div>

                <div class="modal-body" style="padding-bottom:0px;" id="modal-body">
                    <div class="form-body form-horizontal">
                        <div class="row">
                            <c-unite-tarama-kitapcik controller="UniteTaramaSinavPuanGiris"
                                              :idabidesinav="ID_UNITETARAMASINAV"
                                              :ders="DERS"
                                              :tc="TCKIMLIKNO"
                                              @OnChange="KitapcikSelected" />
                        </div>
                        <div class="row" style="margin:0px;">
                            <table class="table table-striped table-bordered table-hover table-checkable order-column">
                                <thead>
                                    <tr>
                                        <th>SORU NO</th>
                                        <th>KAZANIM</th>
                                        <!--<th>BECERİ</th>-->
                                        <th>PUAN</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="odd gradeX" v-for="u in SORULIST">
                                        <td>{{u.SORUNO}}</td>
                                        <td>{{u.KAZANIM}}</td>
                                        <!--<td>{{u.BECERI}}</td>-->
                                        <td style="text-align:center;">
                                            <select class="form-control" v-model="u.PUAN">
                                                <option value="null" selected>Seçiniz...</option>
                                                <option v-for="i in u.MAXPUAN + 1" v-bind:value="i-1">{{i-1}}</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr v-if="SORULIST.length>0">
                                        <td colspan="3" style="text-align:right;">TOPLAM PUAN:</td>
                                        <td>{{TOPLAMPUAN}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn green" @click="PuanKaydet">Kaydet</button>
                    <button type="button" class="btn default" data-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="VueComponents/SinavFiltreleri.js?v=5"></script>
<script src="/VueComponents/UniteTarama/Filtreler.js?v=4"></script>
<script src="VueComponents/SubeGrupSinif.js?v=5"></script>

<script>
    var vue = new Vue({
        el: "#app",
        name: "UniteTaramaSinavPuanGiris.html",

        data: {
            DONEM: '',
            ID_UNITETARAMASINAV: 0,
            EXCELDATA: null,
            ID_SUBE: 0,
            ID_KADEME3: 0,
            ID_SINIF: 0,
            OGRENCILIST: [],
            TCKIMLIKNO: '',
            ID_DERS: '',
            DERS: '',
            SORULIST: [],
            ID_UNITETARAMAKITAPCIK: 0,
            TCKIMLIKNOx: ''
        },

        computed: {
            // a computed getter
            TOPLAMPUAN: function () {
                // `this` points to the vm instance
                var t = 0;
                for (var i = 0; i < this.SORULIST.length; i++) {
                    t += this.SORULIST[i].PUAN;
                }
                return t;
            }
        },

        mounted() {
            this.TCKIMLIKNOx = session.TCKIMLIKNO;
        },

        methods: {
            DonemSelected(DONEM) {
                this.DONEM = DONEM;
            },

            SubeSelected(ID_SUBE) {
                this.ID_SUBE = ID_SUBE;
                this.ID_KADEME3 = 0;
                this.ID_UNITETARAMASINAV = 0;
                this.ID_SINIF = 0;
                ListeTemizle(this.OGRENCILIST);
            },

            Kademe3Selected(ID_KADEME3) {
                this.ID_KADEME3 = ID_KADEME3;
                this.ID_UNITETARAMASINAV = 0;
                this.ID_SINIF = 0;
                ListeTemizle(this.OGRENCILIST);
            },

            SinavSelected(ID_UNITETARAMASINAV) {
                this.ID_UNITETARAMASINAV = ID_UNITETARAMASINAV;
                this.ID_SINIF = 0;
                ListeTemizle(this.OGRENCILIST);
            },

            SinifSelected(ID_SINIF) {
                this.ID_SINIF = ID_SINIF;
                ListeTemizle(this.OGRENCILIST);
            },

            KitapcikSelected(ID_UNITETARAMAKITAPCIK) {
                this.ID_UNITETARAMAKITAPCIK = ID_UNITETARAMAKITAPCIK;
                this.SoruListele();
            },

            OgrenciListele() {
                if (this.ID_UNITETARAMASINAV > 0 && this.ID_SINIF > 0) {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_UNITETARAMASINAV: this.ID_UNITETARAMASINAV,
                        ID_SINIF: this.ID_SINIF,
                        DONEM: this.DONEM
                    };

                    WebPost(this, 'UniteTaramaSinavPuanGiris', 'OgrenciListele', p, '', '', function (data, parent) {
                        if (data != null && data != '[]') {
                            vue.OGRENCILIST = JSON.parse(data);
                        } else {
                            vue.OGRENCILIST = [];
                            Alert_Warning("Bir hata oluştu!");
                        }
                    });
                } else {
                    this.OGRENCILIST = [];
                    Alert_Info("Sınıv ve sınıf seçimi yaptığınızdan emin olunuz.");
                }
            },

            PuanGirModal(TCKIMLIKNO, DERS) {
                console.log(DERS);
                this.TCKIMLIKNO = TCKIMLIKNO;
                this.DERS = DERS;
                this.SORULIST = [];

                if (this.ID_UNITETARAMASINAV > 0 && this.TCKIMLIKNO.length > 0 && this.DERS.length > 0) {
                    
                    $('#Puan_modal_title').text(DERS + ' Puan Girişi');
                    if (this.ID_UNITETARAMAKITAPCIK > 0) {
                        this.ID_UNITETARAMAKITAPCIK = 0;
                      
                    }
                    //this.KitapcikSelected(this.ID_ABIDEKITAPCIK);
                    $('#Puan_modal').modal();
                    
                    
                } else {
                    Alert_Info("Seçimleri yaptığınızdan emin olunuz.");
                    console.log("ytsydy");
                }
            },

            SoruListele() {
                console.log('soru list');
                if (this.ID_UNITETARAMAKITAPCIK > 0) {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_UNITETARAMASINAV: this.ID_UNITETARAMASINAV,
                        O_TCKIMLIKNO: this.TCKIMLIKNO,
                        DERS: this.DERS,
                        ID_UNITETARAMAKITAPCIK: this.ID_UNITETARAMAKITAPCIK
                    };

                    WebPost(this, 'UniteTaramaSinavPuanGiris', 'OgrenciPuanListele', p, '#modal-body', '', function (data, parent) {
                        if (data != null && data != '[]') {
                            vue.SORULIST = JSON.parse(data);
                        } else {
                            vue.SORULIST = [];
                            Alert_Warning("Bir hata oluştu!");
                        }
                    });
                } else {
                    vue.SORULIST = [];
                }
            },

            PuanKaydet() {
                var cont = true;
                for (var i = 0; i < this.SORULIST.length; i++) {
                    if (this.SORULIST[i].PUAN == null || this.SORULIST[i].PUAN == 'null') {
                        cont = false;
                    }
                }
                if (cont) {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        O_TCKIMLIKNO: this.TCKIMLIKNO,
                        SQLJSON: JSON.stringify(this.SORULIST),
                        ID_UNITETARAMAKITAPCIK: this.ID_UNITETARAMAKITAPCIK
                    };

                    WebPost(this, 'UniteTaramaSinavPuanGiris', 'OgrenciPuanKaydet', p, '', '', function (data, parent) {
                        if (data) {
                            Alert_Info("Puan Kaydedildi.");
                            $('#Puan_modal').modal('hide');
                            parent.OgrenciListele();
                        } else {
                            Alert_Warning("Bir hata oluştu!");
                        }
                    });
                } else {
                    Alert_Warning("Tüm sorular için puan seçimi yaptığınızdan emin olunuz!");
                }
            },

            PuanSil(TCKIMLIKNO, DERS) {
                Alert_Confirm("Emin misiniz?", TCKIMLIKNO + " TC' li öğrencinin " + DERS + " ders puanları silinecek.", function () {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        O_TCKIMLIKNO: TCKIMLIKNO,
                        DERS: DERS,
                        ID_UNITETARAMASINAV: vue.ID_UNITETARAMASINAV
                    };

                    WebPost(vue, "UniteTaramaSinavPuanGiris", "DersPuanSil", p, '', '', function (data, parent) {
                        if (data) {
                            Alert_Info("Silindi.");
                            parent.OgrenciListele();
                        } else {
                            Alert_Warning("Bir hata oluştu!");
                        }
                    });
                });
            },

            SubePuanRapor() {
                if (this.ID_SUBE > 0 && this.ID_UNITETARAMASINAV > 0) {
                    window.open("Rapor.aspx?raporTur=XLS&rapor=UniteTarama.UniteTaramaPuanRapor&p=" + session.TCKIMLIKNO + ";" + session.OTURUM + ";" + this.ID_UNITETARAMASINAV + ";" + this.DONEM + ";" + this.ID_SUBE + ';');
                } else {
                    Alert_Warning("Şube ve sınav seçimi yapıldığından emin olunuz!");
                }
            },

            SinifPuanRapor() {
                if (this.ID_SUBE > 0 && this.ID_SINIF > 0 && this.ID_UNITETARAMASINAV > 0) {
                    window.open("Rapor.aspx?raporTur=XLS&rapor=UniteTarama.UniteTaramaPuanRapor&p=" + session.TCKIMLIKNO + ";" + session.OTURUM + ";" + this.ID_UNITETARAMASINAV + ";" + this.DONEM + ";" + this.ID_SUBE + ';' + this.ID_SINIF);
                } else {
                    Alert_Warning("Sınıf ve sınav seçimi yapıldığından emin olunuz!");
                }
            }
        }
    });

    $('#Puan_modal').on('hidden.bs.modal', function () {
        vue.DERS = '';
    })
</script>

<script src="Scripts/PublicMethods.js"></script>