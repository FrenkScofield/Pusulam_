<head>
    <script src="Scripts/Rapor/amcharts.js"></script>
    <script src="Scripts/Rapor/jquery.easypiechart.js"></script>
    <script src="Scripts/Rapor/light.js"></script>
    <script src="Scripts/Rapor/serial.js"></script>
    <script src="Scripts/Rapor/pie.js"></script>
</head>
<style>
    table {
        font-family: 'Open Sans', sans-serif;
        width: 100%;
        border-collapse: collapse;
        border: 3px solid #44475C;
        margin: 10px 10px 0 10px;
    }

        table th {
            text-transform: uppercase;
            text-align: left;
            background: #44475C;
            color: #FFF;
            padding: 8px;
            min-width: 30px;
            text-align: center;
        }

        table td {
            text-align: left;
            padding: 8px;
            border-right: 2px solid #7D82A8;
            font-size: 10px !important;
            cursor: default !important;
            color: #000;
            font-weight: 700;
            text-align: center;
        }

    #PuanTablo {
        border: 3px solid #f58320;
    }

        #PuanTablo th {
            text-transform: uppercase;
            text-align: left;
            background: #f58320;
            color: #FFF;
            padding: 8px;
            min-width: 30px;
        }

        #PuanTablo td {
            text-align: left;
            padding: 8px;
            border-right: 2px solid #f58320;
            font-size: 10px !important;
            cursor: default !important;
        }

        #PuanTablo tbody tr:nth-child(2n) td {
            background: #e9c6a8;
        }


    table td:last-child {
        border-right: none;
    }

    table tbody tr:nth-child(2n) td {
        background: #D4D8F9;
    }

    .badge-danger {
        background-color: #F34C59;
        font-size: 9px !important;
    }

    #chartdiv {
        width: 100%;
        height: 500px;
        font-size: 11px;
    }

    #chartdiv2 {
        width: 100%;
        height: 300px;
        font-size: 11px;
    }

    #chartdiv3 {
        width: 100%;
        height: 300px;
        font-size: 11px;
    }
</style>

<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Sınav Analiz <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">
    <div class="col-md-12">
        <div class="portlet box green-haze dd-item" style="border:none; margin-bottom:0px!important;">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <div class="portlet-body form collapse in" id="filters">
                <div class="portlet light col-md-12" style="margin:0px; border-bottom-style: solid;border-bottom-width: 3px;border-bottom-color: rgb(0, 173, 239);">
                    <div class="portlet-body">
                        <div class="form-inline">
                            <div class="row">
                                <c-sube-multi controller="SinavAnaliz"
                                              @OnChange="SubeSelected">
                                </c-sube-multi>
                                <c-kademe3-multisube controller="SinavAnaliz"
                                                     :idsube="SUBELER"
                                                     @OnChange="Kademe3Selected">
                                </c-kademe3-multisube>
                                <c-sinif-multi controller="SinavAnaliz"
                                               :idsube="SUBELER"
                                               :idkademe3="ID_KADEME3"
                                               @OnChange="SinifSelected">
                                </c-sinif-multi>
                                
                            </div>
                            <div class="row">
                                <c-donem controller="SinavAnaliz"
                                         @OnChange="DonemSelected">
                                </c-donem>                       
                                <c-genel-ders :idkademe3="ID_KADEME3"
                                              :donem="DONEM"
                                              @OnChange="GenelDersSelected">
                                </c-genel-ders>
                                <c-yariyil @OnChange="YariyilSelected">
                                </c-yariyil>
                                <c-yazili-genel-yeni-sinifs controller="SinavAnaliz"
                                                     :donem="DONEM"
                                                     :yariyil="YARIYIL"
                                                     :idders="ID_DERS"                                                     
                                                     :siniflar="SINIFLAR"
                                                     @OnChange="YaziliSelected">
                                </c-yazili-genel-yeni-sinifs>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="portlet light" style="padding:0px;">
                <div class="col-md-12" style="display:inherit">
                    <input style="float:right;margin: 10px;" type="button" class="btn btn-success" @click="Yazdir()" value="Yazdır">
                    <input style="float:right;margin: 10px;" type="button" class="btn btn-success" @click="Raporla()" value="Raporla">
                </div>
            </div>
        </div>
    </div>
    
    <div class="portlet light" id="Tablodiv" style="min-height: 100px;padding:0px;" v-show="T1.length>0">
        <div class="form-inline">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12">
                    <div id="chartdiv"></div>
                </div>
            </div>

            <hr />
            <div class="row" style="page-break-after:always;">
                <div class="col-xs-12 col-sm-12 col-md-6" id="solsutun" style="page-break-after:always;">
                    <table id="tablobaslik"
                           data-height="400" class="table table-striped table-condensed" style="margin-bottom:0px; color:#111;page-break-after:always;">
                        <thead>
                            <tr>
                                <th>PUAN ARALIĞI</th>
                                <th>DERECE</th>
                                <th>SAYI</th>
                                <th>YÜZDE</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <tr>
                                <td id="5Baslik" >85-100 ARASI</td>
                                <td>PEKİYİ</td>
                                <td id="5Sayi"></td>
                                <td id="5Yuzde"></td>
                            </tr>
                            <tr>
                                <td id="4Baslik">70-84,99 ARASI</td>
                                <td>İYİ</td>
                                <td id="4Sayi"></td>
                                <td id="4Yuzde"></td>
                            </tr>
                            <tr>
                                <td id="3Baslik">60-69,99 ARASI</td>
                                <td>ORTA</td>
                                <td id="3Sayi"></td>
                                <td id="3Yuzde"></td>
                            </tr>
                            <tr>
                                <td id="2Baslik">50-59,99 ARASI</td>
                                <td>GEÇER</td>
                                <td id="2Sayi"></td>
                                <td id="2Yuzde"></td>
                            </tr>
                            <tr>
                                <td id="1Baslik">0-49,99 ARASI</td>
                                <td>GEÇMEZ</td>
                                <td id="1Sayi"></td>
                                <td id="1Yuzde"></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="background: #44475C!important;"></td>
                            </tr>
                            <tr>
                                <td colspan="2">SINAVDAN ALINAN ENBÜYÜK NOT</td>
                                <td colspan="2" id="MaxNot"></td>
                            </tr>
                            <tr>
                                <td colspan="2">SINAVDAN ALINAN ENDÜŞÜK NOT</td>
                                <td colspan="2" id="MinNot"></td>
                            </tr>
                            <tr>
                                <td colspan="2">NOT ORTALAMASI</td>
                                <td colspan="2" id="AvgNot"></td>
                            </tr>
                            <tr>
                                <td colspan="2">BAŞARILI ÖĞRENCİ SAYISI</td>
                                <td colspan="1" id="BasariliKisiSayi"></td>
                                <td colspan="1" id="BasariliKisiYuzde"></td>
                            </tr>
                            <tr>
                                <td colspan="2">BAŞARISIZ ÖĞRENCİ SAYISI</td>
                                <td colspan="1" id="BasarisizKisiSayi"></td>
                                <td colspan="1" id="BasarisizKisiYuzde"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p id="PrintMargin" style="page-break-after:always;"></p>
                <div class="col-xs-12 col-sm-12 col-md-6" id="sagsutun">
                    <div class="row">
                        <div class="col-md-12">
                            <div id="chartdiv2"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="chartdiv3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="/assets/global/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet" />
<script src="/assets/global/plugins/bootstrap-table/bootstrap-table.min.js"></script>
<script src="/VueComponents/YaziliYoklamaFiltreleri.js?v=4"></script>
<script src="/VueComponents/Genel.js?v=3"></script>

<script>
    var vue = new Vue({
        el: "#app",
        name: "SinavAnaliz.html",

        data: {
            TCKIMLIKNO: '',
            DONEM: '',
            ID_SINAV: 0,
            ID_KADEME3: 0,
            ID_DERS: 0,
            YARIYIL: '',
            SINIFLAR: [],
            SUBELER: [],
            T1: [],
            T2: [],
            T3: [],
            ID_KADEME: []
        },

        mounted() {

        },

        methods: {
            SubeSelected(SUBELER) {
                this.SUBELER = SUBELER;
            },

            Kademe3Selected(ID_KADEME3) {
                this.ID_KADEME3 = ID_KADEME3;
                this.ID_KADEME = 0
            },

            DonemSelected(DONEM) {
                this.DONEM = DONEM;
            },

            YaziliSelected(ID_SINAV) {
                this.ID_SINAV = ID_SINAV;
            },

            YariyilSelected(YARIYIL) {
                this.YARIYIL = YARIYIL;
            },

            SinifSelected(SINIFLAR) {
                this.SINIFLAR = SINIFLAR;

                if (this.ID_KADEME == 5) {
                    $("#5Baslik").html("85-100 ARASI")
                    $("#4Baslik").html("70-84,99 ARASI")
                    $("#3Baslik").html("60-69,99 ARASI")
                    $("#2Baslik").html("50-59,99 ARASI")
                    $("#1Baslik").html("0-49,99 ARASI")
                }
                else {
                    $("#5Baslik").html("85-100 ARASI")
                    $("#4Baslik").html("70-84,99 ARASI")
                    $("#3Baslik").html("55-69,99 ARASI")
                    $("#2Baslik").html("45-54,99 ARASI")
                    $("#1Baslik").html("0-44,99 ARASI")
                }
            },

            GenelDersSelected(ID_DERS) {
                this.ID_DERS = ID_DERS;
            },

            PuanDurum(puan) {

                if (this.ID_KADEME == 5) {
                    if (puan > 84 && puan < 101) { return "Pekiyi" }
                    else if (puan > 69 && puan < 85) { return "İyi" }
                    else if (puan > 59 && puan < 70) { return "Orta" }
                    else if (puan > 49 && puan < 60) { return "Geçer" }
                    else if (puan < 50) { return "Geçmez" }
                } else {
                    if (puan >= 85 && puan < 101) { return "Pekiyi" }
                    else if (puan >= 70 && puan < 85) { return "İyi" }
                    else if (puan >= 55 && puan < 70) { return "Orta" }
                    else if (puan >= 45 && puan < 60) { return "Geçer" }
                    else if (puan < 45) { return "Geçmez" }
                }


            },

            Yazdir() {
                if (this.DONEM == ''
                    || this.ID_SINAV == 0
                    || this.ID_KADEME3 == 0
                    || this.ID_DERS == 0
                    || this.YARIYIL == ''
                    || this.SINIFLAR.length == 0
                    || this.SUBELER.length == 0) {
                    Alert_Warning("Seçimleri yapmanız gerekmektedir.");
                } else {
                    window.open('../Rapor.aspx?rapor=Yazili.SinavAnaliz&raporTur=pdf&p=' + session.TCKIMLIKNO + ';' + session.OTURUM + ';' + this.ID_SINAV + ';' + JSON.stringify(this.SINIFLAR) + ';' + JSON.stringify(this.SUBELER) + ';' + this.DONEM, '_blank');
                }
            },

            Raporla() {
                if (this.DONEM == ''
                    || this.ID_SINAV == 0
                    || this.ID_KADEME3 == 0
                    || this.ID_DERS == 0
                    || this.YARIYIL == ''
                    || this.SINIFLAR.length == 0
                    || this.SUBELER.length == 0) {
                    Alert_Warning("Seçimleri yapmanız gerekmektedir.");
                } else {
                    $('#filters').collapse('hide');
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_SINAV: this.ID_SINAV,
                        ID_SINIFLAR: JSON.stringify(this.SINIFLAR),
                        ID_SUBELER: JSON.stringify(this.SUBELER),
                        DONEM: this.DONEM
                    };

                    WebPost(this, "SinavAnaliz", "SinavAnalizYeni", p, "#app", "Yükleniyor...", function (data, parent) {
                        if (data != null) {
                            parent.T1 = JSON.parse(data)[0].T1;
                            parent.T2 = JSON.parse(data)[0].T2;
                            parent.T3 = JSON.parse(data)[0].T3;

                            var xmaximum = 100;
                            var ymaximum = 160;
                            var renkler = ["#F31D13", "#F39913", "#E4DE1C", "#BDF11C", "#1CF140"]
                            var ymin = 1;
                            var donem = $('#DonemPicker').find("option:selected").text();
                            var sinavad = $('#YaziliPicker').find("option:selected").text();

                            var datapro = [];
                            var datapro2 = [];
                            var datapro3 = [];
                            $.each(parent.T1, function (j) {
                                var eleman = { "yuzde": this.YUZDE, "soruno": this.DERS + "<br>" + "Soru " + this.SN, "balloonTextField": this.KAZANIM, "color": "#0D52D1" };
                                datapro.push(eleman);
                                if (parent.T1.length == (j + 1)) {
                                    AmchartOlustur("chartdiv", datapro, xmaximum, "yuzde", "soruno", "color", "BAŞARI YÜZDESİ", true, ymin, ymaximum, undefined, donem + "(" + sinavad + ")" + " SORU ANALİZİ", "%", true, 2);
                                }
                            })

                            var basariliogrencisayisi = 0;
                            var basarisizogrencisayisi = 0;
                            var toplamogrencisayisi = parent.T2[0].TOPLAMKISISAYISI;
                            var dereceyegorekisiyasyisi = 0;
                            $.each(parent.T2, function (j) {
                                if (parseInt(this.KISISAYISI) > dereceyegorekisiyasyisi) {//dereceye göre en yüksek kişi sayısını buluyor.
                                    dereceyegorekisiyasyisi = this.KISISAYISI;
                                }
                                if (this.SIRA != 1)
                                    basariliogrencisayisi += parseInt(this.KISISAYISI);
                                else
                                    basarisizogrencisayisi += parseInt(this.KISISAYISI);
                                var yuzde = (parseFloat(this.KISISAYISI) / parseFloat(this.TOPLAMKISISAYISI) * 100).toFixed(2);
                                $("#" + this.SIRA + "Sayi").html(this.KISISAYISI);
                                $("#" + this.SIRA + "Yuzde").html("%" + yuzde);

                                var eleman2 = { "yuzde": this.DURUM, "soruno": this.KISISAYISI, "color": "#0D52D1" };
                                var eleman3 = { "durum": this.DURUM, "yuzde": yuzde, "color": renkler[parseInt(this.SIRA)] };
                                datapro2.push(eleman2);
                                datapro3.push(eleman3);
                                if (parent.T2.length == (j + 1)) {
                                    var maxdeger = 0;
                                    if (toplamogrencisayisi > (dereceyegorekisiyasyisi * 2)) {// grafikteki öğrenci sayısının ayarlanması
                                        maxdeger = dereceyegorekisiyasyisi + 10; //öğrenci sayısı dereceye göre en yüksek kişi sayısının 2 katından büyükse max değeri dereceye göre en yüksek kişi sayısına yakın tut.Çünkü öğrenci sayısı dereceye göre en yüksek kişi sayısından çok büyük olursa grafik düzgün gözükmez.
                                    }
                                    else { //öğrenci sayısı dereceye göre en yüksek kişi sayısının 2 katından az ise öğrenci sayısı max değer olarak ayarla.(Grafikte düzgün gözükebilir.)
                                        maxdeger = toplamogrencisayisi;
                                    }
                                    AmchartOlustur("chartdiv2", datapro2, maxdeger, "soruno", "yuzde", "color", "ÖĞRENCI SAYISI", true, 0, 200, "", "SAYI BAZINDA DERECE DAĞILIMI", "", true);
                                    AmChartPieOlustur("chartdiv3", datapro3, "yuzde", "durum", false, "YÜZDELİK BAZDA DERECE DAĞILIMI");
                                }
                            })


                            $.each(parent.T3, function (j) {
                                $("#MaxNot").html(this.ENYUKSEK);
                                $("#MinNot").html(this.ENDUSUK);
                                $("#AvgNot").html(this.ORTALAMA.toFixed(2));
                                $("#BasariliKisiSayi").html(basariliogrencisayisi);
                                $("#BasariliKisiYuzde").html("%" + parseFloat((basariliogrencisayisi) / toplamogrencisayisi).toFixed(2) * 100);
                                $("#BasarisizKisiSayi").html(basarisizogrencisayisi);
                                $("#BasarisizKisiYuzde").html("%" + parseFloat((basarisizogrencisayisi) / toplamogrencisayisi).toFixed(2) * 100);
                            })
                        } else {
                            Alert_Warning("Liste Bulunamadı..!");
                        }
                    });
                }
            }
        },
    });
</script>

<script src="Scripts/PublicMethods.js"></script>
