<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />

<div class="page-head">
    <div class="page-title col-md-12">
        <h1>
            Bültenler <small>Bülten Ekle</small>
            <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
</div>
<div class="row" id="app">
    <div class="col-sm-12">
        <div class="portlet light">
            <div class="row">
                <div class="col-sm-12 col-md-4">
                    <div class="form-horizontal" v-show="KAYIT">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Kampüs:</label>
                            <c-sube-multi-tumu controller="TopluSinavSonuclari" @OnChange="SubeSelected" :full="true"></c-sube-multi-tumu>
                        </div>
                    </div>

                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Ders:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="ders" v-model="Bulten.Ders" />
                            </div>
                        </div>
                    </div>
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Yayına Alma Tarihi:</label>
                            <div class="col-sm-9">
                                <input type="text" id="dpYaTarih" data-date-format="dd-mm-yyyy" placeholder="Yayına Alma Tarihi" class="form-control form-control-inline date-picker">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-4">
                    <div class="form-horizontal">
                        <div class="form-group" v-show="KAYIT">
                            <label class="col-sm-3 control-label">Gruplar:</label>
                            <c-kademe3-multisube controller="TopluSinavSonuclari"
                                                 :idsube="idsube"
                                                 :full="true"
                                                 @OnChange="Kademe3Selected">
                            </c-kademe3-multisube>
                        </div>
                    </div>
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Başlık:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="baslik" v-model="Bulten.Baslik" />
                            </div>
                        </div>
                    </div>

                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Yayından Kaldırma Tarihi:</label>
                            <div class="col-sm-9">
                                <input type="text" id="dpYbTarih" data-date-format="dd-mm-yyyy" placeholder="Yayından Kalldırma Tarihi" class="form-control form-control-inline date-picker">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="col-sm-12 col-md-4">
                    <div class="form-horizontal">
                        <div class="form-group" v-show="KAYIT">
                            <label class="col-sm-3 control-label">Kampüs:</label>
                            <c-sinif-multi-multisube controller="TopluSinavSonuclari"
                                                     :idsube="idsube"
                                                     :idkademe3="idkademe3"
                                                     :full="true"
                                                     @OnChange="SinifSelected">
                            </c-sinif-multi-multisube>
                        </div>
                    </div>

                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Link:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="link" v-model="Bulten.Link" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Dosya:</label>
                            <div class="col-sm-3">
                                <div class="fileinput fileinput-new" data-provides="fileinput">
                                    <div class="input-group" style="width:100%!important;">
                                        <div class="form-control uneditable-input input-fixed input-medium" data-trigger="fileinput" style="width:100%!important;">
                                            <i class="fa fa-file fileinput-exists"></i>&nbsp;
                                            <span class="fileinput-filename"> </span>
                                        </div>
                                        <span class="input-group-addon btn default btn-file">
                                            <span class="fileinput-new"> Dosya Seç </span>
                                            <span class="fileinput-exists"> Değiştir </span>
                                            <input type="file" name="..." id="BULTEN_DOSYA">
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Açıklama:</label>
                            <div class="col-sm-11">
                                <textarea id="aciklama" class="form-control" rows="6" v-model="Bulten.Aciklama"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12 text-right">
                    <button type="button" class="btn blue" @click="Kaydet">Kaydet</button>
                </div>
                
            </div>
        </div>
    </div>
</div>
<script src="../../../VueComponents/TopluSinavSonuclariFiltreleri.js?v=4"></script>
<script>
    var vue = new Vue({
        el: "#app",
        name: "BultenEkle.html",

        data: {
            TCKIMLIKNO: '',
            DONEM: 0,
            controller: 'Bulten',
            idsube: [],
            idkademe3: 0,
            idsinif: [],
            Bulten: {
                Ders: '',
                Baslik: '',
                Link: '',
                Aciklama: '',
                ID_BULTEN:0
            },
            ID_BULTEN: 0,
            BULTENLIST: [],
            KAYIT: true
        },

        mounted() {

            $('#dpYaTarih').datepicker({
                format: 'dd.mm.yyyy',
                language: 'tr',

            });

            $('#dpYbTarih').datepicker({
                format: 'dd.mm.yyyy',
                language: 'tr'
            });
            this.ID_BULTEN = getParameterByName("ID_BULTEN")
            if (this.ID_BULTEN) {
                this.BultenGetir()
            }
        },

        methods: {

            SubeSelected(item) {
                this.idsube = item;
                this.idkademe3 = 0;
                this.idsinif = 0;
            },
            Kademe3Selected(item) {
                this.idkademe3 = item;
                this.idsinif = 0;
            },
            SinifSelected(item) {
                this.idsinif = item;
            },
            Kaydet() {
                debugger;
                console.log(this.idsinif)
                if (this.KAYIT == true) {
                    if (this.idsinif.length == 0 || this.idsinif ==0) {
                        Alert_Error("Lütfen sınıf seçin.")
                        return;
                    }
                }                
               
                if (this.Bulten.Ders == '') {
                    Alert_Error("Lütfen ders ekleyin")
                    return;
                }
                if (this.Bulten.Baslik == '') {
                    Alert_Error("Lütfen başlık ekleyin")
                    return;
                }
                if (this.Bulten.Ders == '') {
                    Alert_Error("Lütfen ders ekleyin")
                    return;
                }
                
                var dpYaTarih = $("#dpYaTarih").val();
                var dpYbTarih = $("#dpYbTarih").val();
                if (dpYaTarih == '') {
                    Alert_Error("Lütfen Yayınlanma tarihi ekleyin")
                    return;
                }
                if (dpYbTarih == '') {
                    Alert_Error("Lütfen Yayından kaldırma tarihi ekleyin")
                    return;
                }
                if (Date.parse(dpYaTarih) > Date.parse(dpYbTarih)) {
                    Alert_Error("Yayınlanma tarihi bitiş tarihinden büyük olamaz.")
                    return;
                }
                let metot = this.KAYIT ? 'BultenEkle' : 'BultenDuzenle';
                if (this.KAYIT) {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        YAYIN_TARIH: dpYaTarih,
                        YAYIN_BITIS: dpYbTarih,
                        SINIF_LIST: JSON.stringify(this.idsinif),
                        SQLJSON: JSON.stringify(this.Bulten),
                    };
                }
                else {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        YAYIN_TARIH: dpYaTarih,
                        YAYIN_BITIS: dpYbTarih,
                        SINIF_LIST: JSON.stringify(this.idsinif),
                        SQLJSON: JSON.stringify(this.Bulten),
                        ID_BULTEN: this.ID_BULTEN
                    };
                }
                debugger;
                WebPost(this, this.controller, metot, p, '', '', function (data, parent) {
                    
                    if (data) {
                        parent.ID_BULTEN = data;
                       
                        let x = document.getElementById("BULTEN_DOSYA");
                        if ('files' in x) {

                            var formData = new FormData();
                            formData.append("file", x.files[0]);
                            formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                            formData.append("OTURUM", session.OTURUM);
                            formData.append("ID_BULTEN", data);
                            $.ajax({
                                url: vue.controller + '/DosyaKaydet',
                                processData: false,
                                contentType: false,
                                data: formData,
                                type: 'POST'
                            }).done(function (result) {
                                App.unblockUI('#app');
                                if (result != null) {
                                    // vue.Kaydedildi();
                                }
                                else
                                    Alert_Error("Dosya Yüklenirken Hata Oluştu")
                            })
                        }
                        Alert_Info("Başarılı bir şekilde kaydeyildi.")
                    }
                   
                });
            },
            BultenGetir() {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_BULTEN: this.ID_BULTEN
                    };
                    WebPost(this, this.controller, "BultenGetir", p, '', '', function (data, parent) {
                        if (JSON.parse(data)) {
                            let LIST = JSON.parse(data);
                           
                            for (var i = 0; i < LIST.length; i++) {
                                parent.Bulten.Ders = LIST[i].DERS;
                                parent.Bulten.Aciklama = LIST[i].ACIKLAMA;
                                parent.Bulten.Baslik = LIST[i].BASLIK;
                                parent.Bulten.Link = LIST[i].LINK;
                                
                                $("#dpYaTarih").datepicker("setDate", new Date(LIST[i].YAYIN_TARIH));
                                $("#dpYbTarih").datepicker("setDate", new Date(LIST[i].YAYIN_BITIS));
                            }
                            parent.Bulten.ID_BULTEN = parent.ID_BULTEN;
                            parent.KAYIT = false;
                           
                        }
                    });
            }

        },
    });
</script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
