<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />

<style>
    td {
        vertical-align: middle !important;
    }

    .row {
        margin-top: 10px !important;
    }
</style>

<div class="page-head">
    <div class="page-title col-md-12">
        <h1>
            Öğrenci Yükle <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
</div>

<div class="row" id="app">
    <div class="col-md-12" id="filtre_div">
        <div class="portlet box green-haze dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' id="filtreAc" style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <div class="portlet-body form collapse in" id="filters">
                <form role="form" style="padding:12px 20px">
                    <div class="row">
                        <c-donem controller="SinavListele"
                                 @OnChange="DonemSelected">
                        </c-donem>
                    </div>
                    <div class="row">
                        <c-sinavgrup controller="SinavListele"
                                     :id_kademe3="ID_KADEME3"
                                     @OnChange="SinavGrupSelected">
                        </c-sinavgrup>
                    </div>
                    <div class="row">
                        <div class="form-group" style="margin-top:10px;">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn green" @click="SinavListele">Sınav Listele</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-if="SINAVLISTESI.length>0">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Sınav Listesi </span>
                    <span class="caption-helper"></span>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">
                        <div class="portlet-body">
                            <table class="table table-striped table-bordered table-hover table-checkable" id="sinavtable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>SINAV ADI</th>
                                        <th>DÖNEM</th>
                                        <th>SINAV GRUBU</th>
                                        <th>KAYIT TARİHİ</th>
                                        <th>İŞLEM</th>
                                        <th>YÜKLE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="odd gradeX" v-for="u in SINAVLISTESI">
                                        <td>{{u.ID_ASSESSMENT}}</td>
                                        <td>{{u.AD}}</td>
                                        <td>{{u.DONEM}}</td>
                                        <td>{{u.KADEME3}}</td>
                                        <td>{{u.KYE_TARIH}}</td>
                                        <td><button type="button" class="btn green" @click="TcKontrol(u.ID_ASSESSMENT)">T.C. Eşleştir </button></td>
                                        <td>
                                            <div class="fileinput fileinput-new" data-provides="fileinput">
                                                <span class="fileinput-preview thumbnail" style="max-width: 1000px; max-height: 1000px;"> </span>
                                                <span>
                                                    <span class="btn default btn-file">
                                                        <span class="fileinput-new yellow"> Öğrenci Yükle </span>
                                                        <span class="fileinput-exists"> Değiştir </span>
                                                        <input type="file" name="..." accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" :id="'dosya'+u.ID_ASSESSMENT" data-preview-file-type="text">
                                                    </span>
                                                    <!--<a href="javascript:;" class="btn yellow fileinput-exists" @click="ExcelYukle()" v-if="FULLYETKILI==true"> Özel Optik Tanımla </a>-->
                                                    <a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                                                    <a href="javascript:;" @click="ExcelYukle(u.ID_ASSESSMENT)" class="btn green fileinput-exists" data-dismiss="modal"> Tamam </a>
                                                </span>
                                            </div>


                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>
    
    <div id="TcEslestir_modal" class="modal fade in" role="dialog" aria-hidden="true" tabindex="-1" data-replace="true">
        <div class="modal-dialog modal-full">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">{{BASLIK}}</h4>
                </div>

                <div class="modal-body">

                    <div class="form-body form-horizontal">

                        <div class="portlet light col-md-12">
                            <div class="col-md-12" style="padding:0px;">
                                <!-- BEGIN PORTLET-->
                                <div class="portlet-body form col-md-6">
                                    <form role="form">
                                        <div class="portlet light bordered">
                                            <div class="portlet-body">
                                                <table class="table table-striped table-bordered table-hover table-checkable" style="font-size:x-small; cursor:pointer" id="TblEslesmeyen">
                                                    <thead>
                                                        <tr>
                                                            <th style="font-size:x-small">TC KİMLİK NO</th>
                                                            <th style="font-size:x-small">ADI SOYADI</th>
                                                            <th style="font-size:x-small">İŞLEMLER</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr :id="u.ID_ASSESSMENTOGRENCI" class="odd gradeX" v-for="u in EslesmyenOgrenciListesi">
                                                            <td style="font-size:x-small"><input type="text" class="form-control" style="text-align:center;" v-model="u.TCKIMLIKNO" maxlength="11" onkeypress='return event.charCode >= 48 && event.charCode <= 57' /></td>
                                                            <td style="font-size:x-small">{{u.ADSOYAD}}</td>
                                                            <td style="font-size:x-small">
                                                                <button type="button" style="font-size:x-small; display:inline-block;" class="btn green btn-xs" @click="TcGuncelle(u)">KAYDET</button>
                                                                <button type="button" style="font-size:x-small; display:inline-block;" class="btn red btn-xs" @click="OptikSatirSil(u.ID_ASSESSMENTOGRENCI)">SİL</button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="portlet-body form col-md-6">
                                    <form role="form">
                                        <div class="portlet light bordered">

                                            <div class="portlet-body">
                                                <c-sinavgrup2 controller="AssessmentOgrenciYukle"
                                                              :id_kademe3="OL_IDKADEME3"
                                                              @OnChange="SinavGrupEslestirSelected">
                                                </c-sinavgrup2>
                                            </div>
                                            <div class="portlet-body">
                                                <table class="table table-striped table-bordered table-hover table-checkable" style="font-size:x-small; cursor:pointer;" id="TblOgrenci">
                                                    <thead>
                                                        <tr>
                                                            <th style="font-size:x-small">TC KİMLİK NO</th>
                                                            <th style="font-size:x-small">ADI</th>
                                                            <th style="font-size:x-small">SOYADI</th>
                                                            <th style="font-size:x-small">SUBE NO</th>
                                                            <th style="font-size:x-small">SUBE ADI</th>
                                                            <th style="font-size:x-small">SINIFI</th>
                                                            <th style="font-size:x-small">EŞLEŞTİR</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr id="u.TCKIMLIKNO" class="odd gradeX" style="font-size:x-small" v-for="u in OgrenciListesi">
                                                            <td style="font-size:x-small">{{u.TCKIMLIKNO}}</td>
                                                            <td style="font-size:x-small">{{u.AD}}</td>
                                                            <td style="font-size:x-small">{{u.SOYAD}}</td>
                                                            <td style="font-size:x-small">{{u.SUBENO}}</td>
                                                            <td style="font-size:x-small">{{u.SUBEAD}}</td>
                                                            <td style="font-size:x-small">{{u.SINIF}}</td>
                                                            <td style="font-size:x-small"><button type="button" style="font-size:x-small" class="btn green btn-xs" @click="Eslestir(u.TCKIMLIKNO)">Eşleştir</button></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <!-- END PORTLET-->
                        </div>


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn default" data-dismiss="modal">Kapat</button>
                    <!-- <button type="button" class="btn green" data-dismiss="modal" @click="DosyaKaydet">Tamam</button>-->
                </div>
            </div>
        </div>
    </div>
    
</div>
<script src="../../VueComponents/idset/Filtreler.js"></script>
<script src="VueComponents/SubeGrupSinif.js?v=5"></script>
<script src="VueComponents/SinavFiltreleri.js?v=5"></script>

<script>
    var vue = new Vue({
        el: "#app",
        name: "OgrenciYukle.html",

        data: {
            DONEM: '',
            ID_KADEME3: 0,
            OL_IDKADEME3: 0,
            ID_ASSESSMENT: 0,
            SINAVLISTESI: [],

            divTcEslestir: 0,
            EslesmyenOgrenciListesi: [],
            OgrenciListesi: [],

            BASLIK: '',
        },

        mounted() {
            vue = this;
            this.ListeOlustur('TblEslesmeyen');
            this.ListeOlustur('TblOgrenci');

            $('#dosyatable').DataTable({
                "aLengthMenu": [
                    [15, 20, -1],
                    [15, 20, "Hepsi"] // change per page values here
                ],
                "aaSorting": [[5, 'desc']],
                language: {
                    "url": "./Utility/dil.json"
                },
            });

            $('#TblEslesmeyen tbody').on('click', 'tr', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                    vue.seciliID = 0;
                }
                else {
                    $('#TblEslesmeyen tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                    vue.seciliID = parseInt($(this).attr("id"));
                }
            });
            $('#TblOgrenci tbody').on('click', 'tr', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                }
                else {
                    $('#TblOgrenci tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            });
        },

        methods: {
            DonemSelected(DONEM) {
                this.DONEM = DONEM;
                this.divTcEslestir = 0;
            },
            SinavGrupSelected(ID_KADEME3) {
                this.ID_KADEME3 = ID_KADEME3;
                this.OL_IDKADEME3 = ID_KADEME3;
                this.divTcEslestir = 0;
                this.ID_SINAV = 0;
                this.idSinav = 0;
            },
            SinavGrupEslestirSelected(ID_KADEME3) {
                this.OL_IDKADEME3 = ID_KADEME3;

                this.TcKontrol(undefined);

            },

            SinavListele() {
                var _this = this;

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    DONEM: this.DONEM,
                    ID_KADEME3: this.ID_KADEME3,
                };

                WebPost(this, "AssessmentOgrenciYukle", "SinavListele", p, '#sinavtable', 'Yükleniyor..', function (data, parent) {

                    _this.SINAVLISTESI = JSON.parse(data);

                    if (_this.SINAVLISTESI.length == 0) {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                    else {
                        $('#filters').collapse();
                    }
                });
            },

            ExcelYukle(idAssessment) {
                this.ID_ASSESSMENT = idAssessment != undefined ? idAssessment : this.ID_ASSESSMENT;
                var dosya = document.getElementById('dosya' + idAssessment).files;
                dosyaadi = $('#dosya' + idAssessment).val().replace(/^.*[\\\/]/, '');
                if (dosya.length == 0) {
                    Alert_Info('Lütfen Dosya Seçiniz.');
                    return;
                }
                var _this = this;

                ExcelVeriYukle("AssessmentOgrenci", dosya, function (response) {

                    $('.fileinput').fileinput("clear");
                    var json = JSON.parse(response);


                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        EXCEL: response,
                        ID_ASSESSMENT: _this.ID_ASSESSMENT,
                    };

                    WebPost(vue, "AssessmentOgrenciYukle", "OgrenciYukle", p, '', '', function (data, parent) {
                        if (data > 0) {
                            Alert_Info("Öğrenci Aktarımı Tamamlanmıştır.");
                        } else {
                            Alert_Warning("Öğrenci Aktarımı Sırasında Hata Oluştu..!");
                        }
                    }, 'RAISERROR');
                });
            },

            TcKontrol(idAssessment) {
                this.ID_ASSESSMENT = idAssessment != undefined ? idAssessment : this.ID_ASSESSMENT;

                this.BASLIK = 'TC KİMLİK NO EŞLEŞTİR';
                this.divTcEslestir = 1;
                var _this = this;
                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_ASSESSMENT: this.ID_ASSESSMENT,
                    ID_KADEME3: this.OL_IDKADEME3,
                };

                WebPost(this, "AssessmentOgrenciYukle", "EslesmeyenOgrenciListeGetir", p, '#TcEslestir_modal', 'Yükleniyor..', function (data, parent) {
                    if (data) {
                        var parseData = JSON.parse(data);
                        parent.EslesmyenOgrenciListesi = parseData[0].t1;
                        parent.OgrenciListesi = parseData[0].t2;

                        $("#TcEslestir_modal").modal();

                        $("#TblEslesmeyen").DataTable().destroy();
                        _this.$nextTick(function () {
                            _this.ListeOlustur('TblEslesmeyen');
                        });
                        $("#TblOgrenci").DataTable().destroy();
                        _this.$nextTick(function () {
                            _this.ListeOlustur('TblOgrenci');
                        });

                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                });
            },

            TcGuncelle(item) {

                if (item.TCKIMLIKNO.length != 11) {
                    Alert_Info('Hatalı TC');
                } else {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_ASSESSMENTOGRENCI: item.ID_ASSESSMENTOGRENCI,
                        TC_OGRENCI: item.TCKIMLIKNO,
                    };

                    WebPost(this, "AssessmentOgrenciYukle", "TcGuncelle", p, '', '', function (data, parent) {
                        console.log(data)
                        if (JSON.parse(data) != []) {
                            item.ADSOYAD = JSON.parse(data)[0].ADSOYAD;
                            Alert_Info("TC Guncellendi...");
                        }
                        else {
                            Alert_Warning("Bir hata oluştu. Daha sonra tekrar deneyiniz...");
                        }
                    })
                }
            },

            OptikSatirSil(ID) {
                Alert_Confirm("Emin misiniz?", "Kişi silinecek onaylıyor musunuz?", function () {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_ASSESSMENTOGRENCI: ID
                    };

                    WebPost(vue, "AssessmentOgrenciYukle", "OgrenciPasif", p, '', '', function (data, parent) {
                        if (data) {
                            Alert_Info("Kişi silindi...");
                            parent.TcKontrol(undefined);
                        }
                        else {
                            Alert_Warning("Bir hata oluştu. Daha sonra tekrar deneyiniz...");
                        }
                    })
                });
            },

            Eslestir(tc) {
                var _this = this;
                if (this.seciliID == 0) {
                    Alert_Warning("Öncelikle Eşleşmemiş Öğrenci Seçiniz!");
                    return;
                }
                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_ASSESSMENTOGRENCI: this.seciliID,
                    TC_OGRENCI: tc
                };

                WebPost(this, "AssessmentOgrenciYukle", "TcGuncelle", p, '#divEslestir', 'İşlem Yapılıyor...', function (data, parent) {

                    if (JSON.parse(data) != []) {
                        Alert_Info("Eşleştirme Tamamlandı...");

                        $('#TblEslesmeyen tr.selected').removeClass('selected');
                        $('#TblOgrenci tr.selected').removeClass('selected');


                        var result = $.grep(parent.EslesmyenOgrenciListesi, function (n, i) {
                            return n.ID_ASSESSMENTOGRENCI != _this.seciliID;
                        });
                        parent.EslesmyenOgrenciListesi = result;

                        _this.seciliID = 0;
                        $("#TblEslesmeyen").DataTable().destroy();
                        _this.$nextTick(function () {
                            _this.ListeOlustur('TblEslesmeyen');
                        });

                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                });
            },

            ListeOlustur(tabloAdi) {
                var tblOlustur = $('#' + tabloAdi).DataTable(
                    {
                        "aLengthMenu": [
                            [5, 15, 20, -1],
                            [5, 15, 20, "Hepsi"] // change per page values here
                        ],
                        "aaSorting": [[0, 'desc']],
                        language: {
                            "url": "./Utility/dil.json"
                        },
                    });
            },

        }
    });

</script>
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
