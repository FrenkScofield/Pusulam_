<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<!--<link href="assets/global/plugins/bootstrap-wysihtml5/bootstrap-wysihtml5.css" rel="stylesheet" type="text/css" />-->

<div class="page-head">
    <div class="page-title col-md-12">
        <h1>
            Duyuru Listesi  <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
</div>

<div class="row" id="app">

    <div class="col-md-12">
        <div class="portlet light">
            <div class="row">
                <div>
                    <div class="row form-group" style="margin-left: 5px;">
                        <c-sube-multi controller="DuyuruYonetimi"
                                      :idset="ID_SUBELIST"
                                      @OnChange="SubeSelected">
                        </c-sube-multi>
                    </div>
                    <div class="row form-group" style="margin-left: 5px;">
                        <c-kullanici-tipi-multi controller="DuyuruYonetimi"
                                                :idset="ID_KULLANICITIPILIST"
                                                @OnChange="KullaniciTipiSelected">
                        </c-kullanici-tipi-multi>
                    </div>
                    <div class="row">
                        <div class="form-group" style="margin-top:10px;">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn blue" @click="Listele">Listele</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row" v-if="DUYURULIST.length>0">
                        <table class="table table-striped table-bordered" id="tabloduyuru">

                            <thead>
                                <tr>
                                    <th>Banner Web Görseli</th>
                                    <th>Banner Mobil Görseli</th>
                                    <th>Ekleyen</th>
                                    <th>Yayın Süresi</th>
                                    <th>Duyuru Başlık</th>
                                    <th>Aktif / Pasif</th>
                                    <th>Düzenle</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="u in DUYURULIST">
                                    <td style="height:80px !important">
                                        {{u.FOTOGRAF}}
                                        <a :href="'https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/Yonetim/DuyuruYonetimi/'+[u.FOTOGRAF != '' ? u.FOTOGRAF :'DuyuruYoksaBuResimGozuk.png'] " target="_blank"> <img style="height: 100% !important;" :src="'https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/Yonetim/DuyuruYonetimi/' + [u.FOTOGRAF != '' ? u.FOTOGRAF :'DuyuruYoksaBuResimGozuk.png'] " /></a>
                                    </td>
                                    <td style="height:80px !important"><a :href="'https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/Yonetim/DuyuruYonetimi/'+ [u.FOTOGRAF_MOBIL != '' ? u.FOTOGRAF_MOBIL :'DuyuruYoksaBuResimGozuk.png']" target="_blank"><img style="height: 100% !important;" :src="'https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/Yonetim/DuyuruYonetimi/'+[u.FOTOGRAF_MOBIL != '' ? u.FOTOGRAF_MOBIL :'DuyuruYoksaBuResimGozuk.png']" /></a></td>
                                    <td>{{u.ADSOYAD}}</td>
                                    <td>{{u.BAS_TARIH}} - {{u.BIT_TARIH}}</td>
                                    <td>{{u.BASLIK}}</td>
                                    <td>
                                        <div class="col-md-9" style="height:34px; vertical-align:middle;">
                                            <div class="md-checkbox" style="margin:auto!important; width:20px!important; height:20px; margin:0px; margin-top:6px; display:block;">
                                                <input type="checkbox" v-model="u.AKTIF" :id="u.ID_DUYURU+'AKTIF'" class="md-check" v-bind:true-value="true" v-bind:false-value="false" @click="DuyuruAktifPasif(u)" />
                                                <label :for="u.ID_DUYURU+'AKTIF'">
                                                    <span></span>
                                                    <span class="check"></span>
                                                    <span class="box"></span>
                                                </label>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn green" @click="DuyuruGuncelle(u)">Düzenle</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                </div>

            </div>
          
        </div>
    </div>
</div>
<script src="../../../VueComponents/Genel.js?v=4"></script>
<script src="VueComponents/Filtre.js"></script>
<script src="assets/global/plugins/ckeditor/ckeditor.js"></script>
<script>
    var vue = new Vue({

        el: "#app",
        name: "DuyuruYonetimi",

        data: {
            TCKIMLIKNO: undefined,
            OTURUM: undefined,
            controller: 'DuyuruYonetimi',
            ID_DUYURU: 0,
            
            ID_SUBELIST: [],
            ID_KULLANICITIPILIST: [],
            DUYURULIST: [],
        },

        mounted() {
            
        },

        methods: {
            SubeSelected(val) {
                this.ID_SUBELIST = val;
            },
            KullaniciTipiSelected(val) {
                this.ID_KULLANICITIPILIST = val;
            },
            DuyuruGuncelle(item) {
                window.location.replace("/AnaSayfa.html#Yonetim/DuyuruYonetimi?ID_DUYURU=" + item.ID_DUYURU + '&OTURUM=' + session.OTURUM);
            },
            DuyuruAktifPasif(item) {

                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_DUYURU: item.ID_DUYURU };
                WebPost(this, "DuyuruListe", "DuyuruAktifPasif", p, '', '', function (data, parent) {
                    Alert_Info("Duyuru Durumu " + (item.AKTIF ? 'Aktif' : 'Pasif') + " Olarak Düzenlendi.");
                });
            },
            Listele() {
                debugger;
                ListeTemizle(this.DUYURULIST);
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SUBELIST: JSON.stringify(this.ID_SUBELIST), ID_KULLANICITIPILIST: JSON.stringify(this.ID_KULLANICITIPILIST) };
                WebPost(this, "DuyuruListe", "DuyuruListe", p, '', '', function (data, parent) {
                    vue.DUYURULIST = JSON.parse(data);

                    var aoColumns = [{ "mData": null },
                    { "mData": "FOTOGRAF" },
                    { "mData": "FOTOGRAF_MOBIL" },
                    { "mData": "ADSOYAD" },
                    { "mData": "YAYINTARIHI" },
                    { "mData": "BASLIK" },
                    { "mData": "ISLEM" },
                    { "mData": "CEKLER" }];

                    vue.$nextTick(() => {
                        //Glb_TabloYukle2("#tabloduyuru", aoColumns, vue.DUYURULIST);
                        vue.ListeOlustur("tabloduyuru")
                    });
                });
            },

            ListeOlustur(tabloAdi) {
                this.tblSorular = $('#' + tabloAdi).DataTable(
                    {
                        "aaSorting": [[0, 'asc']],
                        language: {
                            "url": "./Utility/dil.json"
                            ,
                        },
                    });
            },
            DuyuruKaydet() {

                if (strToDate(this.BIT_TARIH) < strToDate(this.BAS_TARIH)) {
                    Alert_Warning("Başlangıç Tarihi Bitiş Tarihinden Büyük Olamaz..")
                    return;
                }

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_KULLANICITIPILIST: JSON.stringify(this.ID_KULLANICITIPILIST),
                    ID_SUBELIST: JSON.stringify(this.ID_SUBELIST),
                    BASLIK: this.BASLIK,
                    ICERIK: $("#editor").val(),
                    BAS_TARIH: this.BAS_TARIH,
                    BIT_TARIH: this.BIT_TARIH,
                    ID_KADEMELIST: JSON.stringify(this.ID_KADEMELIST),
                    ID_KADEME3LIST: JSON.stringify(this.ID_KADEME3LIST),
                    ID_SINIFLIST: JSON.stringify(this.ID_SINIFLIST),
                    BANNER: false,
                    FOTOGRAF: "",
                    FOTOGRAF_MOBIL: "",
                }
                vue.Kaydet(p);

                if (vue.ID_DUYURU > 0) {
                    let mobilBanner = document.getElementById("upload_file_mobil");
                    let file = document.getElementById("file")
                    let webBanner = document.getElementById("upload_file");
                    if ('files' in file) {
                        var formData = new FormData();
                        for (var i = 0; i < webBanner.files.length; i++) {
                            formData.append("file", webBanner.files[i]);
                        }
                        formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                        formData.append("OTURUM", session.OTURUM);
                        formData.append("ID_DUYURU", vue.ID_DUYURU);
                        $.ajax({
                            url: vue.controller + '/DuyuruDosya',
                            processData: false,
                            contentType: false,
                            data: formData,
                            type: 'POST'
                        }).done(function (result) {
                            App.unblockUI('#app');
                            if (result != null) {
                                vue.Kaydedildi();
                            }
                            else
                                Alert_Error("Dosya Yüklenirken Hata Oluştu")
                        })
                    }
                    if ('files' in mobilBanner) {
                        var formData = new FormData();
                        for (var i = 0; i < webBanner.files.length; i++) {
                            formData.append("file", webBanner.files[i]);
                        }
                        formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                        formData.append("OTURUM", session.OTURUM);
                        formData.append("ID_DUYURU", vue.ID_DUYURU);
                        formData.append("MOBIL_BANNER", 1)
                        $.ajax({
                            url: vue.controller + '/DuyuruBanner',
                            processData: false,
                            contentType: false,
                            data: formData,
                            type: 'POST'
                        }).done(function (result) {
                            App.unblockUI('#app');
                            if (result != null) {
                                vue.Kaydedildi();
                            }
                            else
                                Alert_Error("Dosya Yüklenirken Hata Oluştu")
                        })

                    }

                    if ('files' in webBanner) {

                        var formData = new FormData();
                        for (var i = 0; i < webBanner.files.length; i++) {
                            formData.append("file", webBanner.files[i]);
                        }
                        formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                        formData.append("OTURUM", session.OTURUM);
                        formData.append("ID_DUYURU", vue.ID_DUYURU);
                        formData.append("MOBIL_BANNER", 0)
                        $.ajax({
                            url: vue.controller + '/DuyuruBanner',
                            processData: false,
                            contentType: false,
                            data: formData,
                            type: 'POST'
                        }).done(function (result) {
                            App.unblockUI('#app');
                            if (result != null) {
                                vue.Kaydedildi();
                            }
                            else
                                Alert_Error("Dosya Yüklenirken Hata Oluştu")
                        })

                    }
                }

                //return;

                //if (this.FOTOGRAF != "") {
                //    p.BANNER = true;
                //    p.FOTOGRAF = this.FOTOGRAF;
                //}
                //if (this.FOTOGRAF_MOBIL != "") {
                //    p.BANNER = true;
                //    p.FOTOGRAF_MOBIL = this.FOTOGRAF_MOBIL;
                //}

                //vue.Kaydet(p);

            },
            Kaydedildi() {
                bootbox.dialog({
                    message: "<font color='green'>Ödev Kaydedildi.</font>",
                    title: "<font color='green'>İşlem Tamam</font>",
                    buttons: {
                        success: {
                            label: "Tamam!",
                            className: "btn-success",
                            callback: function () {
                                location.reload();
                            }
                        },
                    }
                });
            },
            Kaydet(p) {
                debugger;
                var metodAdi = this.ID_DUYURU == 0 ? "DuyuruEkle" : "DuyuruGuncelle";

                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, SQLJSON: JSON.stringify(p), ID_DUYURU: this.ID_DUYURU };

                let test = 0
                WebPost(this, this.controller, metodAdi, p, '', '', function (data, parent) {
                    parent.ID_DUYURU == 0
                        ? Alert_Info("Duyuru Eklendi")
                        : Alert_Info("Duyuru Güncellendi");

                    parent.ID_DUYURU = data;
                });
            },



            uploadFile(idDiv, tip) {
                Metronic.blockUI({
                    target: "#app",
                    boxed: true,
                    message: "Yükleniyor ..."
                });

                var myFileList = document.getElementById(idDiv).files;

                if (idDiv == "file") {
                    $("#Dosyalar").html("");
                    ListeTemizle(this.DOSYALIST);
                }
                $.each(myFileList, function (j, el) {
                    var dosyaadi = el.name;
                    var ext = dosyaadi.split('.').pop();
                    if (tip == "image") {
                        if (ext === "png" || ext === "jpg" || ext === "img") {
                            var not = "sorun yok :)";
                        }
                        else {
                            alert("Sadece png ve jpg tipinde dosya ekleyebilirsiniz.");
                            return "";
                        }
                    }

                    var dosyauzantisi = el.name.split('.').pop();

                    var xhr = new XMLHttpRequest();
                    var formData = new FormData();

                    // FormData nesnesine bizim dosya ekleyin
                    formData.append('my_uploaded_file', el);

                    var guid = newGuid();
                    var myFileName = guid + "." + dosyauzantisi;
                    xhr.open('POST', "/FileUpload.ashx?name=" + myFileName + "&path=" + "~/site/Ortak/DuyuruFoto/", true);

                    // ve dosyayı gönder
                    xhr.send(formData);

                    if (idDiv == "file") {
                        //var row =   '<tr class="template-upload fade in">' +
                        //            '<td class="name" width="30%"><span>' + dosyaadi + '</span></td>' +
                        //            '<td class="size" width="20%"><span>Boyut :' + bytesToSize(el.size) + '</span></td>';
                        //row +=      '<td><p class="size" id="Ileti' + j + '">Yükleniyor...</p>';
                        //row +=      '<div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">';
                        //row +=      '<div class="progress-bar progress-bar-success" style="width:0%;" id="prg' + j + '"></div></div></td></tr>';
                        //$("#Dosyalar").append($(row));


                        xhr.upload.onprogress = function (e) {
                            if (e.lengthComputable) {
                                var rastgele = Math.floor((Math.random() * 50) + 1);
                                $("#prg" + j).css("width", rastgele + "%");
                            }
                        };
                    }
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            if (idDiv == "file") {
                                $("#prg" + j).attr("style", "width:75%;");
                                if (xhr.responseText === "Yasak") {
                                    $("#prg" + j).css("width", "0%");
                                    $("#Ileti" + j).html("Yasaklı dosya tipi");
                                    //document.getElementById('Ekle').removeAttribute('disabled');
                                    //$("#Ekle").html("Kaydet");
                                }
                                else {
                                    if (idDiv == "file") {
                                        vue.DOSYALIST.push(myFileName);
                                    }
                                }
                            }
                            else if (idDiv == "upload_file") {
                                vue.FOTOGRAF = myFileName;
                            }
                            else if (idDiv == "upload_file_mobil") {
                                vue.FOTOGRAF_MOBIL = myFileName;
                            }

                        }
                        else if (xhr.readyState == 4 && xhr.status == 404 && idDiv == "file") {

                            $("#Ileti" + j).html("Yüklenemedi");
                            $('#prg' + j).css("width", '1%');
                            //document.getElementById('Ekle').removeAttribute('disabled');
                            //$("#Ekle").html("Kaydet");
                        }
                        else if (xhr.status == 500 && idDiv == "file") {
                            $("#Ileti" + j).html("Hata");
                            $('#prg' + j).css("width", '1%');
                            //document.getElementById('Ekle').removeAttribute('disabled');
                            //$("#Ekle").html("Kaydet");
                        }
                        else {
                            return "";
                        }
                    };

                });
                Metronic.unblockUI("#app");
            },
        }
    });
</script>
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
