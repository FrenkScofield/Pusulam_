<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<style>
    td {
        vertical-align: middle !important;
    }

    .row {
        margin-top: 10px !important;
    }

    .modal-dialog {
        width: 400px;
    }

    table.dataTable {
        margin: 0px !important;
    }
</style>

<div class="row" id="app">
    <div class="page-head col-md-12">
        <!-- BEGIN PAGE TITLE -->
        <div class="page-title col-md-12">
            <h1>
                Sınav
                <small v-if="ID_SINAV==0">Cevap Anahtarı Düzenleme</small>
                 <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
            </h1>
        </div>
        <!-- END PAGE TITLE -->
    </div>

    <div class="col-md-12">
        <div class="portlet box green-haze dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>

            <div class="portlet-body form collapse in" id="filters">
                <form role="form" style="padding:12px 20px">


                    <div class="form-body form-horizontal">

                        <div class="row">
                            <c-donem controller="OptikTanimla"
                                     @OnChange="DonemSelected">
                            </c-donem>
                        </div>
                        <div class="row">
                            <c-sinavturu controller="OptikTanimla"
                                         :id_sinavturu="ID_SINAVTURU"
                                         @OnChange="SinavTuruSelected">
                            </c-sinavturu>
                        </div>
                        <div class="row">
                            <c-sinavgrup controller="OptikTanimla"
                                         :id_kademe3="ID_KADEME3"
                                         @OnChange="SinavGrupSelected">
                            </c-sinavgrup>
                        </div>
                        <div class="row">
                            <c-sinav-donem controller="OptikTanimla"
                                           :donem="DONEM"
                                           :id_sinavturu="ID_SINAVTURU"
                                           :id_kademe3="ID_KADEME3"
                                           :idsinav="ID_SINAV"
                                           :cevapanahtariduzenle ="true"
                                           @OnChange="SinavSelected">
                            </c-sinav-donem>
                        </div>
                        <div class="form-group" style="margin-top:10px;">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn green" @click="Listele">Listele</button>
                            </div>
                        </div>

                    </div>
                </form>
            </div>

        </div>
    </div>

    <div id="ders_modal" class="modal fade" tabindex="-1" data-replace="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">Ders Ekle</h4>
                </div>

                <div class="modal-body">
                    <span>Eklemek istediğiniz dersleri seçerek alt kısımda yer alan "TAMAM" butonuna tıklayınız.</span>
                    <div id="jstree_ders" style="padding:20px; padding-bottom:0px;"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn default" data-dismiss="modal">Kapat</button>
                    <button type="button" class="btn green" data-dismiss="modal" @click="DersEkle">Tamam</button>
                </div>
            </div>
        </div>
    </div>


    <div class="pull-right row" style="padding-bottom:20px;padding-right:30px" v-if="ID_SINAV>0 && JSONSECILIDERS.length >0">
        <!--<button type="button" class="btn yellow" @click="CATaslakYukle">Cevap Anahtarı Excel Yükle       </button>-->

        <div class="fileinput fileinput-new" data-provides="fileinput">
            <span class="fileinput-preview thumbnail" style="max-width: 1000px; max-height: 1000px;"> </span>
            <span>
                <span class="btn default btn-file">
                    <span class="fileinput-new yellow"> Cevap Anahtarı Excel'den Yükle </span>
                    <span class="fileinput-exists"> Değiştir </span>
                    <input type="file" name="..." accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="CADosya" data-preview-file-type="text">
                </span>
                <a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                <a href="javascript:;" @click="CATaslakYukle()" class="btn green fileinput-exists" data-dismiss="modal"> Tamam </a>
            </span>
        </div>

        <button type="button" class="btn gray" @click="CATaslakIndir">Cevap Anahtarı Excel Taslak İndir</button>
    </div>

    <div id="dersler" class="col-md-12" style="display:none;" v-show="ID_SINAV>0 ">
        <div v-for="u in JSONSECILIDERS" v-if="u.SORUSAYISI>0" class='portlet box blue-hoki dd-item' :id='"ders" + u.ID_SINAVDERS ' :data-id='u.ID_SINAVDERS' style='border:none;'>
            <div class='portlet-title dd-handle derssorudiv'>
                <div class='caption'>
                    <i class='fa fa-cogs'></i> {{u.parent + ' - ' + (u.TAKMAAD.length==0?u.text:u.TAKMAAD) + ' - '+ u.SORUSAYISI +' Soru'}}
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;' data-toggle='collapse' :data-target='"#table" + u.ID_SINAVDERS'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <div class='portlet-body collapse' :id='"table" + u.ID_SINAVDERS ' style='padding:0px;'>
                <table v-if="parseInt(u.SORUSAYISI)>0" :data-id='u.ID_SINAVDERS' class='table table-striped table-hover dataTable tabledersitem' style='margin:0px;'>
                    <thead>
                        <tr>
                            <th style="width:20px; text-align:center;">No</th>
                            <!--<th>Tür</th>-->
                            <th>A - Cevap</th>
                            <th style="text-align:center;">Bilgi</th>
                            <th style="text-align:center;">Bilişsel Süreç</th>
                            <th>Ünite</th>
                            <th style="text-align:center;">Karakter Sayısı</th>
                            <th v-if="OLCEKSINAVI" style="text-align:center;">Katsayı</th>
                            <th v-for="i in KITAPCIKSAYISI-1" class='"karsilikkolon" + i'>
                                <span>{{String.fromCharCode(65 + i)+" - Karşılık"}}</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="soru in u.SORULIST">
                            <td style="text-align:center;"> {{soru.SORUNO}} </td>
                            <!--<td>
                                <select :id='"t" + u.id + "-" + soru.SORUNO' class='form-control' v-model="soru.SORUTURU">
                                    <option value='1'>Test</option>
                                    <option value='2'>Açık Uçlu</option>
                                </select>
                            </td>-->
                            <td :id='"td" + u.id + "-" + soru.SORUNO'>
                                <select :id='"c" + u.id + "-" + soru.SORUNO' class='form-control' v-model="soru.ACEVAP" v-if="soru.SORUTURU==1">
                                    <option value='A'>A</option>
                                    <option value='B'>B</option>
                                    <option value='C'>C</option>
                                    <option value='D'>D</option>
                                    <option value='E'>E</option>
                                    <option value='F'>F</option>
                                </select>
                                <input :id='"c" + u.id+ "-" + soru.SORUNO' type='text' class='form-control' placeholder='Açık Uçlu Cevap' v-model="soru.ACEVAP" maxlength='14' v-else>
                            </td>
                            <td>
                                <select v-model="soru.ID_BILGI" class="form-control">
                                    <option value="0">Seçiniz</option>
                                    <option v-for="BILGI in BILGILIST" :value="BILGI.ID_BILGI">{{BILGI.AD}}</option>
                                </select>
                            </td>
                            <td>
                                <select v-model="soru.ID_BILISSELSUREC" class="form-control">
                                    <option value="0">Seçiniz</option>
                                    <option v-for="BILISSELSUREC in BILISSELSURECLIST" :value="BILISSELSUREC.ID_BILISSELSUREC">{{BILISSELSUREC.AD}}</option>
                                </select>
                            </td>
                            <td>
                                <input :id='"unite"+u.id+"-"+soru.SORUNO' class='form-control pull-left' style="width:calc(50% - 27px);" v-model="soru.KOD==0?'':soru.KOD" placeholder="Ünite Kodu" @keyup.enter='UniteAra(u,soru,"unite"+u.id+"-"+soru.SORUNO)' />
                                <input class='form-control pull-left' style="width:calc(50% - 27px); margin-left:10px;" v-model="soru.UNITE" placeholder="Ünite Adı" readonly />
                                <i class="fa fa-lg fa-arrow-circle-o-down pull-right" style="margin-top:10px; cursor:pointer;" @click="UniteKopyala(u,soru,soru.KOD,soru.UNITE)"></i>
                                <i class="fa fa-lg fa-crosshairs pull-right" @click="DersKonuSec(u,soru)" style="margin-top:10px; cursor:pointer;"></i>
                            </td>
                            <td style="width:30px!important;">
                                <input type="text" class='form-control' value="1" style="text-align:center;" v-model="soru.KARAKTERSAYISI" v-if="soru.SORUTURU==1" disabled />
                                <input type="text" class='form-control' maxlength="2" placeholder="Karakter Sayısı" value="1" style="text-align:center;" onkeypress='return event.charCode >= 48 && event.charCode <= 57' v-model="soru.KARAKTERSAYISI" disabled v-else />
                            </td>
                            <td v-if="OLCEKSINAVI"><input type="text" class='form-control' style="text-align:center;" v-model="soru.KATSAYI" onkeypress='return event.charCode >= 44 && event.charCode <= 57' /></td>
                            <td v-for="k in KITAPCIKSAYISI-1">
                                <select class='form-control' :id='"kar"+k+"-" + u.id + "-" + soru.SORUNO' v-if="soru.KARSILIKLIST!= undefined" v-model="soru.KARSILIKLIST[k-1].SIRA">
                                    <option v-for="l in parseInt(u.SORUSAYISI)" :value='l'> {{l}} </option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-12" style="text-align:right;" v-if="JSONSECILIDERS!=null">
            <button id="BTNKAYDET" type="button" class="btn green" @click="CevapAnahtariKaydet()">Kaydet</button>
        </div>
    </div>


    <div class="modal fade" id="dersKonuModal" role="dialog" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content" id="dersKonu">
                <div class="modal-header" id="unite_header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><label id="modal_baslik">Ünite Seçimi</label></h4>
                </div>
                <div class="modal-body">
                    <div id="div_uniteler" class="row" style="max-height:600px; overflow-y:auto">

                    </div>
                </div>
                <div class="modal-footer" id="div_footer">
                    <button type="button" class="btn success btn-default" data-dismiss="modal">Tamam</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../../../VueComponents/GenelSinavRaporuFiltreleri.js?v=17"></script>
<script src="VueComponents/SinavFiltreleri.js?v=5"></script>
<script>
    var vue = new Vue({
        el: "#app",
        name: "CevapAnahtariDuzenle.html",
        data: {
            ID_SINAV: 0,
            ID_SINAVTURU: 0,
            listID_SINAVTERCIHI: [],
            SINAVADI: '',
            SINAVKODU: '',
            OLCEKSINAVI: false,
            ID_KADEME3: 0,
            TARIH: '',
            YANLISSAYISI: 0,
            KITAPCIKSAYISI: 1,
            ID_DERS: 0,
            JSONDERS: null,
            JSONSECILIDERS: null,
            DONEM: '',
            ESKIDONEMSINIF: false,
            BILGILIST: [],
            BILISSELSURECLIST: []
        },
        mounted() {
            this.SinavDersGetir();
            var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM };
            WebPost(this, "SinavTanimla", "BilgiListele", p, "", "", function (data, parent) {
                parent.BILGILIST = JSON.parse(data);

                WebPost(parent, "SinavTanimla", "BilisselSurecListele", p, "", "", function (data, parent2) {
                    parent2.BILISSELSURECLIST = JSON.parse(data);

                    parent2.$nextTick(function () {
                        if (getParameterByName("ID_YAZILI") != null) {
                            parent2.ID_YAZILI = parseInt(getParameterByName("ID_YAZILI"));
                            parent2.YaziliBilgiGetir();
                        }
                    });
                })
            })
        },

        methods: {
            DonemSelected(DONEM) {
                this.DONEM = DONEM;
            },
            SinavGrupSelected(ID_KADEME3) {
                this.ID_KADEME3 = ID_KADEME3;
            },
            SinavTuruSelected(ID_SINAVTURU) {
                this.ID_SINAVTURU = ID_SINAVTURU
            },
            SinavSelected(ID_SINAV) {
                this.ID_SINAV = ID_SINAV;
            },
            Listele() {
                this.SinavBilgiGetir();
                $('#filters').collapse();
            },

            DersSelected(ID_DERS) {
                this.ID_DERS = ID_DERS;
            },
            SinavDersGetir() {
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM };
                WebPost(this, "CevapAnahtariDuzenle", "SinavDersListele", p, '', '', function (data, parent) {
                    parent.JSONDERS = JSON.parse(data);
                    $('#jstree_ders').jstree({ "plugins": ["checkbox"], core: { data: parent.JSONDERS } });

                    if (getParameterByName("ID_SINAV") != null) {
                        parent.ID_SINAV = parseInt(getParameterByName("ID_SINAV"));
                        parent.SinavBilgiGetir();
                    }
                })
            },
            DersIndexBul(id) {
                var last = -1;
                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                    if (this.JSONSECILIDERS[i].id.includes(id)) {
                        last = i;
                    }
                }
                return last;
            },
            DersIDSay(id) {
                var count = 0;

                if (id.substring(0, id.indexOf('_')).length > 0) {
                    id = id.substring(0, id.indexOf('_'));
                } else {
                    id = id;
                }

                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {

                    if (this.JSONSECILIDERS[i].id.substring(0, this.JSONSECILIDERS[i].id.indexOf('_')).length > 0) {
                        idx = this.JSONSECILIDERS[i].id.substring(0, this.JSONSECILIDERS[i].id.indexOf('_'));
                    } else {
                        idx = this.JSONSECILIDERS[i].id;
                    }

                    if (idx == id) {
                        count++;
                    }
                }
                return count;
            },
            DersIDSay2(list, id) {
                var count = 0;

                if (id.substring(0, id.indexOf('_')).length > 0) {
                    id = id.substring(0, id.indexOf('_'));
                } else {
                    id = id;
                }

                for (var i = 0; i < list.length; i++) {

                    if (list[i].id.substring(0, list[i].id.indexOf('_')).length > 0) {
                        idx = list[i].id.substring(0, list[i].id.indexOf('_'));
                    } else {
                        idx = list[i].id;
                    }

                    if (idx == id) {
                        count++;
                    }
                }
                return count;
            },
            Alert_Sinav(message, ID_SINAV2) {
                bootbox.dialog({
                    message: "<font color='green'>" + message + "</font>",
                    title: "<font color='green'>İşlem Tamam</font>",
                    buttons: {
                        success: {
                            label: "Tamam!",
                            className: "btn-success",
                            callback: function () {
                                console.log(ID_SINAV2)

                                if (ID_SINAV2 == true) {
                                    location.reload();
                                } else {
                                    window.location.replace((document.URL.indexOf('?') > -1 ? (document.URL.substring(0, document.URL.indexOf('?'))) : (document.URL)) + '?ID_SINAV=' + ID_SINAV2);
                                    location.reload();
                                    $('#filters').collapse();
                                }
                            }
                        },
                    }
                });
            },
            ///////////////////////////////////////////////////////////////////////////////////////////////////////
            SinavBilgiGetir() {
                this.JSONSECILIDERS = [];
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: this.ID_SINAV };
                WebPost(this, "CevapAnahtariDuzenle", "SinavBilgiGetir", p, "", "", function (data, parent) {

                    if (data == "") {
                        Alert_Error("İlgili Sınav için Düzenleyebileceğiniz Cevap Anahtarı ve Kazanım Yetkiniz Yok.");
                        $('#BTNKAYDET').attr("style", "visibility:hidden");
                        return;
                    }
                    $('#BTNKAYDET').attr("style", "visibility:visible");
                    var JSONx = JSON.parse(data)[0];

                    parent.ID_SINAVTURU = JSONx.ID_SINAVTURU;
                    parent.SINAVADI = JSONx.AD;
                    parent.SINAVKODU = JSONx.KOD;
                    parent.KITAPCIKSAYISI = JSONx.KITAPCIKSAYISI;
                    parent.ID_KADEME3 = JSONx.ID_KADEME3;
                    parent.TARIH = JSONx.SINAVTARIH;
                    parent.OLCEKSINAVI = JSONx.OLCEKSINAVI;
                    if (JSONx.OZEL) { parent.listID_SINAVTERCIHI.push("1"); }
                    if (JSONx.FREKANSHESAPLA) { parent.listID_SINAVTERCIHI.push("2"); }
                    if (JSONx.PUANGIZLE) { parent.listID_SINAVTERCIHI.push("3"); }
                    if (JSONx.YUKLEMEKAPAT) { parent.listID_SINAVTERCIHI.push("4"); }


                    parent.YANLISSAYISI = JSONx.YANLISSAYISI;
                    for (var i = 0; i < JSONx.JSONDERS.length; i++) {
                        var node = $('#jstree_ders').jstree("get_node", JSONx.JSONDERS[i].id);
                        if (!node.state.selected) {
                            $('#jstree_ders').jstree("select_node", node);
                        }
                    }

                    parent.DersEkle();
                    var _this = parent;
                    var json = JSONx;

                    var cnt = 0;
                    var id = 0;

                    var List = [];
                    for (var i = 0; i < json.JSONDERS.length; i++) {
                        if (List.indexOf(json.JSONDERS[i].id) == -1) {
                            var ders = _this.JSONSECILIDERS[_this.DersIndexBul(json.JSONDERS[i].id)];
                            ders.TAKMAAD = json.JSONDERS[i].text;
                            ders.SORUSAYISI = json.JSONDERS[i].SORUSAYISI;
                        }
                        else {
                            var ders = _this.JSONSECILIDERS[_this.DersIndexBul(json.JSONDERS[i].id)];
                            _this.DersCogaltExcel(ders, json.JSONDERS[i].SIRA, json.JSONDERS[i].text, json.JSONDERS[i].SORUSAYISI);
                        }
                        List.push(json.JSONDERS[i].id);
                    }


                    for (var i = 0; i < json.JSONDERS.length; i++) {
                        var ders = _this.JSONSECILIDERS[_this.DersIndexBulTakmaAd(json.JSONDERS[i].text)];
                        doluitem = json.JSONDERS[i];
                        var SORULIST = doluitem.SORULIST;
                        ders.SIRA = doluitem.SIRA;
                        ders.ID_SINAVDERS = doluitem.id_sinavders;
                        ders.SORULIST = SORULIST;
                    }

                    //for (var i = 0; i < _this.JSONSECILIDERS.length; i++) {
                    //    var index = _this.DersIndexBul(_this.JSONSECILIDERS[i].id);
                    //    var ders = json.JSONDERS[index];
                    //    doluitem = ders;
                    //    console.log(index+' '+doluitem.id + ' ' + _this.JSONSECILIDERS[i].id);
                    //    var SORULIST = doluitem.SORULIST;
                    //    _this.JSONSECILIDERS[i].SIRA = json.JSONDERS[i].SIRA;
                    //    _this.JSONSECILIDERS[i].ID_SINAVDERS = json.JSONDERS[i].id_sinavders;
                    //    _this.JSONSECILIDERS[i].SORULIST = SORULIST;
                    //}

                    $('#dersler').css("display", "block");
                })
            },

            DersCogaltExcel(ders, sira, takmaad, sorusayisi) {
                var newdersx = JSON.parse(JSON.stringify(ders));
                var id = '';
                if (ders.id.substring(0, ders.id.indexOf('_')).length > 0) {
                    id = ders.id.substring(0, ders.id.indexOf('_'));
                } else {
                    id = ders.id;
                }
                newdersx.id = id + '_' + this.DersIDSay(ders.id);
                newdersx.TAKMAAD = takmaad;
                newdersx.SORUSAYISI = sorusayisi;
                this.JSONSECILIDERS.splice(sira - 1, 0, newdersx);
                this.DersSorulariOlustur(newdersx);
                return newdersx;
            },

            DersSorulariOlustur(ders) {
                var SORULIST = new Array();
                for (var j = 0; j < parseInt(ders.SORUSAYISI); j++) {
                    var SORU = new Object();
                    SORU.SORUNO = j + 1;
                    SORU.SORUTURU = 1;
                    SORU.ACEVAP = 'A';
                    SORU.KOD = '';
                    SORU.UNITE = '';
                    SORU.KARAKTERSAYISI = '1';
                    SORU.ID_BILGI = 0;
                    SORU.ID_BILISSELSUREC = 0;
                    var KARSILIKLIST = new Array();
                    for (var k = 1; k < this.KITAPCIKSAYISI; k++) {
                        var KARSILIK = new Object();
                        KARSILIK.KITAPCIK = String.fromCharCode(65 + k);
                        KARSILIK.SIRA = j + 1;
                        KARSILIKLIST.push(KARSILIK);
                    }
                    SORU.KARSILIKLIST = KARSILIKLIST;
                    SORULIST.push(SORU);
                }

                ders.SORULIST = SORULIST;
                //$('#dersler').css("display", "block");
            },
            DersEkle() {
                var items = this.SeciliDersGetir();
                if (this.JSONSECILIDERS == null || this.JSONSECILIDERS.length == 0) {
                    this.JSONSECILIDERS = JSON.parse(JSON.stringify(items));
                } else {
                    for (var i = 0; i < items.length; i++) {
                        if (!this.search(this.JSONSECILIDERS, items[i].id)) {
                            this.JSONSECILIDERS.push(JSON.parse(JSON.stringify(items[i])));
                        }
                    }
                    for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                        if (!this.search(items, this.JSONSECILIDERS[i].id)) {
                            this.JSONSECILIDERS.splice(i, 1);
                        }
                    }
                }
                console.log(this.JSONSECILIDERS)
            },
            SeciliDersGetir() {
                return $('#jstree_ders').jstree('get_selected', true).filter(
                    function (data) {
                        data.SORUSAYISI = 0;
                        data.TAKMAAD = '';
                        data.SORULIST = new Array();
                        return data.id.substring(data.id.indexOf('.') + 1, 8) != "Sınıf"
                    });
            },
            DersIndexBulTakmaAd(TAKMAAD) {
                var last = -1;
                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                    if (this.JSONSECILIDERS[i].TAKMAAD.includes(TAKMAAD)) {
                        last = i;
                    }
                }
                return last;
            },
            DersKonuSec(DERS, SORU) {
                var id = DERS.id.substring(0, DERS.id.indexOf('_'));
                if (DERS.id.substring(0, DERS.id.indexOf('_')).length > 0) {
                    id = DERS.id.substring(0, DERS.id.indexOf('_'));
                } else {
                    id = DERS.id;
                }
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_DERS: id };
                WebPost(this, "CevapAnahtariDuzenle", "DersKonuListele", p, '#dersler', '', function (data, parent) {
                    $("#div_uniteler").html('');
                    var Uniteler = '<option value="0">Ünite Seçiniz ...</option>';
                    $('#dersKonuModal').modal();
                    var unitekodu = "";
                    $.each(data, function (j) {
                        if (this.KOD.substring(0, 6) != unitekodu) {
                            if (j != 0) {
                                Uniteler += '</optgroup>';
                                Uniteler += '</optgroup>';
                            }
                            unitekodu = this.KOD;
                            Uniteler += '<optgroup style="background-color:yellow;" label="' + vue.bosluk(this.KOD.length, this.AD) + '">';
                        }
                        else {
                            Uniteler += '</optgroup>';

                            if (this.SECILEBILIR) {
                                Uniteler += '<option value="' + this.KOD + '" unite="' + this.AD + '">' + vue.bosluk(this.KOD.length, this.AD) + '</option>';
                            } else {
                                Uniteler += '<optgroup label="' + vue.bosluk(this.KOD.length, this.AD) + '">';
                            }
                        }
                    })

                    Uniteler += '</optgroup>';
                    Uniteler += '</optgroup>';

                    $("#div_uniteler").html('' +
                        '<div class="col-md-12 selectunite">' +
                        '<select id="su' + DERS.id + "-" + SORU.SORUNO + '" class="form-control input-sm" data-live-search="true">' +
                        Uniteler +
                        '</select>' +
                        '</div>' +
                        '<br/>');

                    $('#su' + DERS.id + "-" + SORU.SORUNO).change(function () {
                        SORU.KOD = $(this).val();
                        SORU.UNITE = this.options[this.selectedIndex].getAttribute('unite');
                    })
                })
            },
            search(list, id) {
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id == id || list[i].id + 'x' == id || list[i].id == id + 'x') {
                        return true;
                    }
                }
                return false;
            },
            UniteKopyala(seciliders, soru, KOD, UNITE) {
                try {
                    seciliders.SORULIST[soru.SORUNO].KOD = KOD;
                    seciliders.SORULIST[soru.SORUNO].UNITE = UNITE;
                } catch (e) {

                }
            },
            bosluk(length, ad) {
                var str = '';
                for (var i = 0; i < (length - 6); i++) {
                    str += '&nbsp ';
                }
                return str + ad;
            },
            UniteAra(DERS, SORU, ID) {
                var text = $('#' + ID).val();
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_DERS: DERS.id.replace('x', ''), UNITEKOD: text };
                WebPost(this, "CevapAnahtariDuzenle", "UniteAra", p, '#dersler', '', function (data, parent) {
                    if (data != null) {
                        SORU.KOD = text;
                        SORU.UNITE = data;
                    } else {
                        SORU.KOD = text;
                        SORU.UNITE = 'Eşleşme bulunamadı!';
                    }
                    vue.$forceUpdate()
                });
            },
            KarsilikKontrol() {
                for (var k = 0; k < this.JSONSECILIDERS.length; k++) {
                    for (var i = 1; i < this.KITAPCIKSAYISI; i++) {
                        var KontrolList = new Array();
                        for (var j = 1; j <= this.JSONSECILIDERS[k].SORULIST.length; j++) {
                            if (KontrolList.indexOf($('#kar' + i + '-' + this.JSONSECILIDERS[k].id + '-' + j).val()) == -1) {
                                KontrolList.push($('#kar' + i + '-' + this.JSONSECILIDERS[k].id + '-' + j).val());
                            } else {
                                Alert_Info(this.JSONSECILIDERS[k].parent + ' ' + (this.JSONSECILIDERS[k].TAKMAAD == '' ? this.JSONSECILIDERS[k].text : this.JSONSECILIDERS[k].TAKMAAD) + ' dersinde ' + j + '.sorunun karşılığı ' + String.fromCharCode(65 + i) + ' kitapçığında ' + (KontrolList.indexOf($('#kar' + i + '-' + this.JSONSECILIDERS[k].id + '-' + j).val()) + 1) + '. soruda kullanılmış.');
                                return false;
                            }
                        }
                    }
                }
                return true;
            },
            getObjects(obj, key, val) {
                var objects = [];
                for (var i in obj) {
                    if (!obj.hasOwnProperty(i)) continue;
                    if (typeof obj[i] == 'object') {
                        objects = objects.concat(this.getObjects(obj[i], key, val));
                    } else if (i == key && obj[key] == val) {
                        objects.push(obj);
                    }
                }
                return objects;
            },

            CevapAnahtariKaydet() {
                $('#BTNKAYDET').attr("disabled", true);
                if (this.KarsilikKontrol()) {
                    var JSONx = new Object();
                    JSONx.ID_SINAVTURU = this.ID_SINAVTURU;
                    JSONx.AD = this.SINAVADI;
                    JSONx.KOD = this.SINAVKODU;
                    JSONx.KITAPCIKSAYISI = this.KITAPCIKSAYISI;
                    JSONx.ID_KADEME3 = this.ID_KADEME3;
                    JSONx.SINAVTARIH = this.TARIH;
                    JSONx.OZEL = this.listID_SINAVTERCIHI.indexOf("1") > -1 ? 1 : 0;
                    JSONx.FREKANSHESAPLA = this.listID_SINAVTERCIHI.indexOf("2") > -1 ? 1 : 0;
                    JSONx.PUANGIZLE = this.listID_SINAVTERCIHI.indexOf("3") > -1 ? 1 : 0;
                    JSONx.YUKLEMEKAPAT = this.listID_SINAVTERCIHI.indexOf("4") > -1 ? 1 : 0;
                    JSONx.YANLISSAYISI = this.YANLISSAYISI;
                    JSONx.OLCEKSINAVI = this.OLCEKSINAVI ? 1 : 0;
                    JSONx.JSONDERS = this.DersIDDuzelt();

                    var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: this.ID_SINAV, SQLJSON: JSON.stringify(JSONx).replace(new RegExp('\'', 'g'), '') };
                    console.log(p);
                    WebPost(this, "CevapAnahtariDuzenle", "CevapAnahtariKaydet", p, '', 'Yükleniyor..', function (data, parent) {
                        console.log(data);
                        if (parent.ID_SINAV == 0) {
                            parent.Alert_Sinav("Kaydedildi", data);
                            $('#BTNKAYDET').attr("disabled", false);
                        } else {
                            if (data) {
                                parent.Alert_Sinav("Kaydedildi", data);
                            }
                        }
                    });
                } else {
                    Alert_Error("Kaydedilirken hata oluştu.");
                    $('#BTNKAYDET').attr("disabled", false);
                }

            },

            DersIDDuzelt() {
                var dersler = this.JSONSECILIDERS.filter(function (data) {
                    return parseInt(data.SORUSAYISI) != 0;
                });
                for (var i = 0; i < dersler.length; i++) {
                    dersler[i].id = dersler[i].id.indexOf('_') > 0 ? dersler[i].id.substring(0, dersler[i].id.indexOf('_')) : dersler[i].id;
                }
                return dersler;
            },



            CATaslakIndir() {

                var idSinavDersList = [];
                $.each(this.JSONSECILIDERS, function (j, el) {
                    idSinavDersList.push(el.ID_SINAVDERS);
                });
                if (idSinavDersList.length > 0) {
                    window.open('../Rapor.aspx?rapor=Sinav.SinavCevapAnahtariTaslak&raporTur=xls&p=' + session.TCKIMLIKNO + ';' + session.OTURUM + ';' + this.ID_SINAV + ';' + JSON.stringify(idSinavDersList), '_blank');//+ this.idsinavturu + ';'
                }
            },
            CATaslakYukle() {
                var guid = '';
                var dosyaadi = '';
                var _this = this;
                var dosya = document.getElementById('CADosya').files;
                dosyaadi = $("#CADosya").val().replace(/^.*[\\\/]/, '');
                if (dosya.length == 0) {
                    Alert_Info('Lütfen Dosya Seçiniz.');
                    return;
                }

                CevapAnahtariTaslakYukle(dosya, function (response) {
                    $('.fileinput').fileinput("clear");
                    var json = JSON.parse(response);

                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_SINAV: vue.ID_SINAV,
                        SQLJSON: JSON.stringify(json)
                    };
                    WebPost(vue, "CevapAnahtariDuzenle", "CATaslakYukle", p, '', '', function (data, parent) {
                        console.log(data)
                        if (data) {
                            parent.Alert_Sinav("Kaydedildi", vue.ID_SINAV);
                        } else {
                            Alert_Warning("Bir sorun oluştu. Daha sonra tekrar deneyiniz...");
                        }
                    }, 'RAISERROR');
                });
            },

        }
    });
</script>
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>




