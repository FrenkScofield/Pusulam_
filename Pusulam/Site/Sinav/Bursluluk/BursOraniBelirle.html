<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<style>
    td {
        vertical-align: middle !important;
    }

    .row {
        margin-top: 10px !important;
    }
</style>
<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Sınav Listesi <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">


    <div class="col-md-12" style="margin-top: 10px !important;">
        <div class="portlet box blue-hoki dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form collapse in" id="filters">
                <form role="form" style="padding:12px 20px">
                    <div class="form-body form-horizontal form-group-lg">
                        <div class="row">
                            <label class="control-label col-md-3" style="vertical-align:middle;">Burs Oranı Türü</label>
                            <div class="col-md-9">
                                <select class="selectpicker form-control" v-model="BursTur" @change="divAc = false" title="Seçiniz...">
                                    <option value="1"> Puan'a Göre Belirle</option>
                                    <option value="2"> Sınav Ders Başarıya Göre Belirle</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <c-donem controller="BurslulukBursOraniBelirle"
                                     @OnChange="DonemSelected">
                            </c-donem>
                        </div>
                        <div class="row">
                            <c-sinavgrup controller="BurslulukBursOraniBelirle"
                                         :id_kademe3="ID_KADEME3"
                                         @OnChange="Kademe3Selected">
                            </c-sinavgrup>
                        </div>
                        <div class="row">
                            <c-sinav-donem controller="BurslulukBursOraniBelirle"
                                           :donem="DONEM"
                                           :id_sinavturu="12"
                                           :id_kademe3="ID_KADEME3"
                                           @OnChange="SinavSelected">
                            </c-sinav-donem>
                        </div>
                        <div class="row" v-show="BursTur==2">
                            <c-sinav-ders2 ilksecenek="Ders Seçiniz"
                                           :dersler="dersler"
                                           :sifirla="sinavDersSifirla"
                                           @OnChange="SinavDersSelected">
                            </c-sinav-ders2>
                        </div>

                        <div class="form-group">
                            <div class="col-md-12 text-right" style="margin-top: 10px !important;margin-bottom: 10px !important;">
                                <button type="button" class="btn green" @click="BursOranListele">Listele</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-if="divAc">
        <table class="table table-striped table-bordered"
               data-height="700"
               data-width="100%"
               style="margin-bottom:0px; color:#111; width:100%;">
            <thead>
                <tr>
                    <th>Min {{htmlBursTur}}</th>
                    <th v-if="BursTur==2">Max {{htmlBursTur}}</th>
                    <th v-if="BursTur==1"> Öğrenci Sayısı</th>
                    <th>Burs Oranı (%) </th>
                    <th>Ekle</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(u,j) in LISTE">
                    <td>
                        <input type="number"
                               v-model="u.MIN_DEGER"
                               min="0"
                               @change="u.MIN_DEGER = u.MIN_DEGER == '' ? 0 :  u.MIN_DEGER"
                               v-bind:style="[u.MIN_DEGER==0 ? {background: 'yellow'} : {background: 'white'}]" />
                    </td>
                    <td v-if="BursTur==2">
                        <input type="number"
                               v-model="u.MAX_DEGER"
                               min="0"
                               @change="u.MAX_DEGER = u.MAX_DEGER == '' ? 0 :  u.MAX_DEGER"
                               v-bind:style="[u.MAX_DEGER==0 ? {background: 'yellow'} : {background: 'white'}]" />
                    </td>
                    <td v-if="BursTur==1">
                        <input type="number"
                               v-model="u.OGRENCISAYISI"
                               min="0"
                               @change="u.OGRENCISAYISI = u.OGRENCISAYISI == '' ? 0 :  u.OGRENCISAYISI"
                               v-bind:style="[u.OGRENCISAYISI==0 ? {background: 'yellow'} : {background: 'white'}]" />
                    </td>
                    <td>
                        <input type="number"
                               v-model="u.BURSORANI"
                               min="0"
                               max="100"
                               @change="u.BURSORANI = Math.max(Math.min(u.BURSORANI,100), 0)"
                               v-bind:style="[u.BURSORANI==0 ? {background: 'yellow'} : {background: 'white'}]" />
                    </td>
                    <td>
                        <button type="button" class="btn red" @click="BursOranSil(j)">Sil</button>
                        <button type="button" class="btn yellow" @click="BursOranEkle" v-if="(j+1)==LISTE.length">Ekle</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="pull-right" style="margin:25px;">
            <button type="button" class="btn blue" @click="BurslulukSinavBursOranKaydet">Kaydet</button>
        </div>
    </div>

</div>
<script src="../../../VueComponents/GenelSinavRaporuFiltreleri.js?v=18"></script>
<script src="/VueComponents/DenemeSinavRaporlariFiltreleri.js?v=5"></script>
<script src="VueComponents/SinavFiltreleri.js?v=6"></script>
<script>
    var vue = new Vue({

        el: "#app",
        name: "BurslulukBursOraniBelirle.html",

        data: {
            DONEM: '',
            ID_BURSLULUKDOSYA: 0,
            BursTur: 0,
            htmlBursTur: '',
            LISTE: [],
            ID_KADEME3: 0,
            ID_SINAV: 0,
            ID_SINAVDERS: 0,
            idsube: 0,
            divAc: false,
            dersler: [],
        },


        methods: {
            DonemSelected(item) {
                this.DONEM = item;
                this.divAc = false;
            },
            BurslulukDosyaSelected(item) {
                this.ID_BURSLULUKDOSYA = item;
                this.divAc = false;
            },
            Kademe3Selected(item) {
                this.ID_KADEME3 = item;
                this.divAc = false;
            },
            SinavSelected(item) {
                this.ID_SINAV = item;
                this.divAc = false;

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_SINAV: this.ID_SINAV
                };
                this.dersler = [];
                WebPost(this, "BurslulukBursOraniBelirle", "SinavDersleriListele", p, '#SoruDuzenle_modal', 'Yükleniyor..', function (data, parent) {
                    if (data != null || data != undefined) {
                        parent.dersler = JSON.parse(data)[0].t1  // veriler
                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                });
            },
            SinavDersSelected(item) {
                this.ID_SINAVDERS = item;
                this.divAc = false;
            },

            BursOranListele() {
                var _this = this;
                this.divAc = false;

                if ((this.ID_SINAV > 0 && this.BursTur == 1)
                    || (this.ID_SINAVDERS > 0 && this.BursTur == 2)) {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_SINAV: this.ID_SINAV,
                        ID_SINAVDERS: this.ID_SINAVDERS,
                        BURSTUR: this.BursTur
                    };

                    this.LISTE = ListeTemizle(this.LISTE);
                    this.divAc = true;

                    $('#filters').collapse();

                    WebPost(this, "BurslulukBursOraniBelirle", "BursOranListele", p, '', 'Yükleniyor..', function (data, parent) {
                        if (data != null || data != undefined) {
                            _this.LISTE = JSON.parse(data);
                            if (_this.LISTE.length == 0) {
                                _this.BursOranEkle();
                            }
                        }
                        else {
                            //Alert_Warning("Liste Bulunamadı!");
                            _this.BursOranEkle();
                        }
                    });
                }
                else {
                    Alert_Warning("Sınav ve Burs Oran Türünü Seçiniz..!");
                }
            },
            BursOranEkle() {
                var p = {
                    ID_SINAV: this.ID_SINAV,
                    MIN_DEGER: null,
                    MAX_DEGER: null,
                    BURSORANI: null,
                    BURSTUR: parseInt( this.BursTur)
                };
                this.LISTE.push(p);
            },
            BurslulukSinavBursOranKaydet() {
                var _this = this;
                if (this.ID_SINAVDERS == 0 && parseInt( _this.BursTur) == 2) {
                     Alert_Warning("Ders Seçiniz..!");
                    return;
                }

                var hatalikayitlar = $.grep(this.LISTE, function (el, j) {
                    return parseInt(el.MIN_DEGER) > 0
                        && ((parseInt( _this.BursTur) == 2 && parseInt(el.MAX_DEGER) > 0) || parseInt( _this.BursTur) == 1)
                        && parseInt(el.BURSORANI) > 0
                });

                var hataliKayitSayisi = this.LISTE.length - hatalikayitlar.length;

                Alert_OkCancelConfirm(
                    "Burs Oranı Düzenleme"
                    , hataliKayitSayisi > 0
                        ? hataliKayitSayisi + " Adet Kayıt Girişinde Sorun Vardır. Bunlar Olmadan Kayıtları Eklemek İstiyor Musunuz?"
                        : "Kayıt İşlemine Devam Etmek İstiyor Musunuz?"
                    , function () {
                        var p = {
                            TCKIMLIKNO: session.TCKIMLIKNO,
                            OTURUM: session.OTURUM,
                            SQLJSON: JSON.stringify(_this.LISTE),
                            ID_SINAVDERS: _this.ID_SINAVDERS,
                        };

                        WebPost(_this, "BurslulukBursOraniBelirle", "BurslulukSinavBursOranKaydet", p, '', 'Yükleniyor..', function (data, parent) {
                            if (data != null || data != undefined) {
                                data > 0
                                    ? Alert_Info(data + " Adet Kayıt Eklendi..")
                                    : Alert_Info(" Liste Temizlendi..");
                                _this.BursOranListele();
                            }
                            else {
                                Alert_Warning("Kayıt Edilemedi..!");
                            }
                        });
                    }
                    , function () {
                        //Alert_Info("Kayıt İşlemi İptal Edildi..!");
                    }
                );
            },
            BursOranSil(j) {
                this.LISTE.splice(j, 1);
                if (this.LISTE.length == 0) {
                    this.BursOranEkle();
                }
            },

        },
        watch: {
            BursTur() {
                this.htmlBursTur = this.BursTur == 1 ? 'Puan' : 'Başarı Yüzdesi';
            }
        },
    });
</script>
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
