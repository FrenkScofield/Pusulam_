

<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<style>
    td {
        vertical-align: middle !important;
    }

    tr td:first-child {
        text-align: left !important;
    }

    tbody tr {
        height: 51px;
    }

    .row {
        margin-top: 10px !important;
    }

    .modal-dialog {
        width: 500px;
    }

    table.dataTable {
        margin: 0px !important;
    }
</style>


<div class="page-head">
    <div class="page-title col-md-12">
        <h1>
            Sınav <small>Ders Ünite</small>
            <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
</div>

<div class="row" id="app">

    <div class="col-md-12">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-plus font-green"></i>
                    <span class="caption-subject bold font-green uppercase">Kazanım Dosya Ekle/Sil</span>
                    <span class="caption-helper"></span>
                    <div class="note note-success" style="margin-top: 15px;">
                        <span class="label label-danger">NOTE!</span>
                        Eklenmek istenen dosya kazanımın kodu ile ilişkilendirilecektir.
                    </div>
                </div>
            </div>
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet-body" style="padding:0px;">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="row">
                                    <c-sinavgrup :controller="controller"
                                                 :id_kademe3="ID_KADEME3"
                                                 @OnChange="KademeDersSelected">
                                    </c-sinavgrup>
                                </div>
                                <div class="row">
                                    <c_ders :controller="controller"
                                            :id_kademe3="ID_KADEME3"
                                            @OnChange="DersSelected">
                                    </c_ders>
                                </div>
                            </div>
                            <div class="col-md-8" v-if="JSONUNITE.length > 0">
                                <div class="portlet light">
                                    <div class="portlet-title">
                                        <div class="caption">
                                            <i class="icon-list font-green"></i>
                                            <span class="caption-subject bold font-green uppercase">Üniteler</span>
                                            <span class="caption-helper"></span>
                                        </div>
                                        <div class="caption" style="float:right;">
                                        </div>
                                    </div>
                                    <div class="portlet-body form">
                                        <div class="portlet light bordered">
                                            <div class="portlet-body" style="padding:0px;">
                                                <table class="table table-striped table-bordered table-checkable" id='tblunite'>
                                                    <thead>
                                                        <tr>
                                                            <th>Kod</th>
                                                            <th>Ad</th>
                                                            <th style="width:100px!important;">İşlemler</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="odd gradeX" v-for="u in JSONUNITE">
                                                            <td>{{u.KOD}}</td>
                                                            <td v-html="u.AD" :style='"padding-left: "+(u.KOD.length*5)+"px;"'></td>
                                                            <td style="width:120px!important;">
                                                                <button type="button" class="btn btn-xs green" @click="DosyaListesi(u)">
                                                                    {{u.DOSYASAYISI > 0 || u.DOSYASAYISI==undefined ? 'Dosya Düzenle (' + u.DOSYASAYISI + ')' : 'Dosya Yükle'}}
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

        </div>
    </div>

    <!-- Dosya Yükle modal-->
    <div class="modal fade" id="modalDosyaListe" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">Dosya Listesi</h4>
                </div>
                <div class="modal-body" style="padding-bottom:0px;">

                    <div class="row">
                        <div class="col-md-12"><h4><strong v-html="UNITEDETAY.AD"></strong></h4> <span v-html="UNITEDETAY.KOD"></span></div>
                    </div>

                    <div class="margin-bottom-25">
                        <div class="input-icon" style=" float: right; padding-right: 30px; ">
                            <input type="file"
                                   name="..."
                                   id="dosya"
                                   data-preview-file-type="text"
                                   style="display:none;"
                                   accept="application/pdf"
                                   @change="DosyaGonder">
                            <i class="fa fa-3x fa-plus font-green" @click="DosyaSec" style="cursor:pointer; line-height:18px; margin-right:32px;"></i>
                        </div>
                    </div>
                    <div class="row" v-if="DOSYALIST != undefined && DOSYALIST.length > 0">
                        <div class="col-md-12"><h4><strong>Dosyalar</strong></h4></div>
                        <div class="col-md-12" v-for="(ITEM, index) in DOSYALIST" style="cursor:pointer">
                            <span class="fa fa-trash" style="margin-right:5px" @click="DosyaSil(ITEM.ID_KAZANIMDOSYA,index)"></span>
                            <a :href="'https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/kazanim/dosya/' + ITEM.GUID" target="_blank">{{index + 1}}. Dosya</a>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal"> Kapat </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="VueComponents/SinavFiltreleri.js"></script>
<script src="../../../VueComponents/Genel.js?v=6"></script>
<script>
    var tblUnite = null;
    var vue = new Vue({
        el: "#app",
        name: "KazanimDosya",
        data: {
            controller: 'KazanimDosya',
            ID_KADEME3: 0,
            ID_DERS: 0,
            JSONUNITE: [],
            DOSYALIST: [],
            UNITEDETAY: {}
        },

        mounted() {
            this.ListeOlustur();
        },
        updated() { },
        methods: {
            KademeDersSelected(ID_KADEME3) {
                this.ID_KADEME3 = ID_KADEME3;
                this.UniteGetir();
            },
            DersSelected(ID_DERS) {
                this.ID_DERS = ID_DERS;
                this.UniteGetir();
            },
            DosyaListesi(item) {
                this.UNITEDETAY = item;
                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    KOD: this.UNITEDETAY.KOD
                };
                WebPost(this, this.controller, "DersUniteDosyaListesi", p, '', '', function (data, parent) {
                    if (data != null) {
                        parent.DOSYALIST = JSON.parse(data);
                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                });

                $("#modalDosyaListe").modal();
            },

            UniteGetir() {
                this.JSONUNITE = [];
                if (tblUnite != null) {
                    tblUnite.rows().remove().draw();
                    tblUnite.destroy();
                }
                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_DERS: this.ID_DERS,
                    ID_KADEME3: this.ID_KADEME3
                };
                WebPost(this, this.controller, "DersUniteGetir", p, '', '', function (data, parent) {
                    if (data != null) {
                        parent.JSONUNITE = JSON.parse(data);

                        //DOM update olmasını bekleyip update olunca listeyi oluşturuyor.
                        Vue.nextTick(function () {
                            parent.ListeOlustur();
                        })
                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                })
            },

            ListeOlustur() {
                tblUnite = $('#tblunite').DataTable(
                    {
                        "columnDefs": [{ "width": "25%", "targets": 0 }],
                        language: {
                            "url": "./Utility/dil.json"
                        }
                    });
            },

            DosyaSec() {
                $('#dosya').click();
            },

            DosyaGonder(e) {
                var input = document.getElementById('dosya');
                if (e.target.files[0].type != "application/pdf") {
                    Alert_Warning("Sadcece PDF yüklenebilir.");
                    return;
                }
                if (input.files.length) {
                    App.blockUI({
                        target: '#app',
                        boxed: true,
                        message: 'Yükleniyor...'
                    });

                    if (e.target.files[0].type.indexOf('image') > -1)
                        compress(e);
                    else
                        vue.FormGonder(e.target.files[0]);


                } else {
                    alert('Please upload a file before continuing')
                }
            },

            FormGonder(file) {
                var formData = new FormData();
                formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                formData.append("OTURUM", session.OTURUM);
                formData.append("KOD", this.UNITEDETAY.KOD);
                formData.append("ID_MEDYATUR", file.type.indexOf('image') > -1 ? 2 : file.type.indexOf('video') > -1 ? 3 : 4);

                // HTML file input, chosen by user
                formData.append("file", file);

                $.ajax({
                    url: this.controller + '/DersUniteDosyaYukle',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST'
                }).done(function (result) {
                    App.unblockUI('#app');
                    if (result != null) {
                        vue.DOSYALIST.push(JSON.parse(result)[0]);
                        let temp = $.grep(vue.JSONUNITE, (el) => { return el.KOD == vue.UNITEDETAY.KOD })[0];
                        temp.DOSYASAYISI++;
                    }
                    else
                        Alert_Error("Dosya Yüklenirken Hata Oluştu");
                    $("#dosya").val(null);
                }).fail(function (a, b, c) {
                    App.unblockUI('#app');
                });
            },

            DosyaSil(ID_KAZANIMDOSYA, index) {

                Alert_Confirm("Dosya Silme", "Dosyayı silmek istediğinizden emin misiniz ?", () => {
                    var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_KAZANIMDOSYA: ID_KAZANIMDOSYA };
                    WebPost(vue, vue.controller, "DersUniteDosyaPasif", p, '', '', function (data, parent) {
                        if (data) {
                            vue.DOSYALIST.splice(index, 1);
                            let temp = $.grep(vue.JSONUNITE, (el) => { return el.KOD == vue.UNITEDETAY.KOD })[0];
                            temp.DOSYASAYISI--;
                        }
                        else {
                            Alert_Warning("Bir Hata Oluştu!");
                        }
                    });
                });

            },

        }
    });
</script>
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>

<script src="../assets/global/plugins/jquery-repeater/jquery.repeater.js" type="text/javascript"></script>

<script src="../assets/pages/scripts/form-repeater.min.js" type="text/javascript"></script>



