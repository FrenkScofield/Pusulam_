<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<style>
    td {
        vertical-align: middle !important;
    }

    .row {
        margin-top: 10px !important;
    }

    .modal-dialog {
        width: 400px;
    }

    table.dataTable {
        margin: 0px !important;
    }

    #table_soru img {
        max-width: 100% !important;
    }
</style>

<div class="row" id="app">
    <div class="page-head col-md-12">
        <!-- BEGIN PAGE TITLE -->
        <div class="page-title col-md-12">
            <h1>
                Sınav
                <small v-if="ID_SINAV==0">Sınav Tanımla</small>
                <small v-else>Sınav Düzenle <span style="color:red;">Ders ekleme ve çıkarma işlemlerinde optik ve katsayı tanımlamaları tekrar kontrol edilmelidir...</span></small>
                <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
            </h1>
        </div>
        <!-- END PAGE TITLE -->
    </div>

    <div class="col-md-12">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-magnifier font-green"></i>
                    <span class="caption-subject bold font-green uppercase">Sınav Bilgileri</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="pull-right" v-if="ONLINETEST">
                    <button v-if="ID_SINAV>0" type="button" class="btn yellow" @click="OptikTanimla(ID_SINAV)">Optik Form Tasarla</button>
                    <button v-if="ID_SINAV>0" type="button" class="btn yellow" @click="SinavListele()">Sınav Listele</button>
                    <div v-if="ID_SINAV==0">
                        <div class="fileinput fileinput-new" data-provides="fileinput">
                            <span class="fileinput-preview thumbnail" style="max-width: 1000px; max-height: 1000px;"> </span>
                            <span>
                                <span class="btn default btn-file">
                                    <span class="fileinput-new yellow"> Excel'den Yükle </span>
                                    <span class="fileinput-exists"> Değiştir </span>
                                    <input type="file" name="..." accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="Dosya" data-preview-file-type="text">
                                </span>
                                <a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                                <a href="javascript:;" @click="DosyaKaydet()" class="btn green fileinput-exists" data-dismiss="modal"> Tamam </a>
                            </span>
                        </div>
                        <button type="button" class="btn yellow" @click="OrnekExcelIndir">Excel Taslağı İndir</button>
                    </div>
                </div>
                <!--<span class="pull-right fa fa-lg" style="cursor:pointer;" onclick="YardimGoster(ID_MENU);"> </span>-->
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">
                        <div class="portlet-body" style="padding:0px;">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="row">
                                        <c-sinavturu controller="SinavTanimla"
                                                     :id_sinavturu="ID_SINAVTURU"
                                                     @OnChange="SinavTuruSelected">
                                        </c-sinavturu>
                                    </div>
                                    <div class="row">
                                        <div class="form-md-line-input">
                                            <label class="control-label col-md-3" style="vertical-align:middle;">Sinav Adı </label>
                                            <div class="col-md-9">
                                                <input type="text" maxlength="50" placeholder="Sınav Adı" class="form-control" v-model="SINAVADI" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-md-line-input">
                                            <label class="control-label col-md-3" style="vertical-align:middle;">Sinav Kodu </label>
                                            <div class="col-md-9">
                                                <input type="text" maxlength="20" placeholder="Sınav Kodu" class="form-control" v-model="SINAVKODU" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-md-line-input">
                                            <label class="control-label col-md-3" style="vertical-align:middle;">Rapor Başlık </label>
                                            <div class="col-md-9">
                                                <input type="text" placeholder="Rapor Başlık" class="form-control" v-model="RAPORBASLIK" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <c-sinavtercihleri controller="SinavTanimla"
                                                           :listidsinavtercihi="listID_SINAVTERCIHI"
                                                           @OnChange="SinavTercihiSelected">
                                        </c-sinavtercihleri>
                                    </div>
                                  
                                    <div class="row">
                                        <c-sinavgrup controller="SinavTanimla"
                                                     :id_kademe3="ID_KADEME3"
                                                     @OnChange="SinavGrupSelected">
                                        </c-sinavgrup>
                                    </div>
                                    <div class="row">
                                        <c-kitapciksayisi controller="SinavTanimla"
                                                          :kitapciksayisi="KITAPCIKSAYISI"
                                                          @OnChange="KitapcikSayisiSelected">
                                        </c-kitapciksayisi>
                                    </div>
                                    <div class="row">
                                        <c-yanlissayisi controller="SinavTanimla"
                                                        :yanlissayisi="YANLISSAYISI"
                                                        @OnChange="YanlisSayisiSelected">
                                        </c-yanlissayisi>
                                    </div>
                                    <div class="row">
                                        <c-tarih controller="SinavTanimla"
                                                 :tarih="TARIH"
                                                 @change-date="TarihSelected">
                                        </c-tarih>
                                    </div>
                                    <div class="row" v-if="YONERGE==undefined">
                                        <div class="form-md-line-input">
                                            <label class="control-label col-md-3">Yönerge Ekle</label>
                                            <div class="col-md-9">
                                                <div class="fileinput fileinput-new" data-provides="fileinput">
                                                    <div class="input-group" style="width:100%!important;">
                                                        <div class="form-control uneditable-input input-fixed input-medium" data-trigger="fileinput" style="width:100%!important;">
                                                            <i class="fa fa-file fileinput-exists"></i>&nbsp;
                                                            <span class="fileinput-filename"> </span>
                                                        </div>
                                                        <span class="input-group-addon btn default btn-file">
                                                            <span class="fileinput-new"> Dosya Seç </span>
                                                            <span class="fileinput-exists"> Değiştir </span>
                                                            <input type="file" name="..." id="yonergeDosya">
                                                        </span>
                                                        <a href="javascript:;" class="input-group-addon btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" v-else>
                                        <label class="control-label col-md-3">Yönerge:</label>
                                        <div class="form-md-line-input col-md-3">
                                            <a type="button" class="btn btn-primary" :href="YONERGE" target="_blank">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-arrow-down" viewBox="0 0 16 16">
                                                    <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293V6.5z" />
                                                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z" />
                                                </svg>
                                                Yönerge
                                            </a>
                                        </div>
                                        <div class="form-md-line-input col-md-4">
                                            <button id="btnSil" type="button" class="btn btn-danger" @click="YonergeSil()">Sil</button>
                                        </div>
                                    </div>
                                    <div class="row" v-if="ONLINETEST">
                                        <div class="form-md-line-input">
                                            <label class="control-label col-md-3" style="vertical-align:middle;">Ders Puanı Hesapla</label>
                                            <div class="col-md-9" style="height:34px; vertical-align:middle;">
                                                <div class="md-checkbox" style="margin:auto!important; width:20px!important; height:20px; margin:0px; margin-top:6px; display:block;">
                                                    <input type="checkbox" v-model="OLCEKSINAVI" id="OLCEKSINAVI" class="md-check" v-bind:true-value="true" v-bind:false-value="false" />
                                                    <label for="OLCEKSINAVI">
                                                        <span></span>
                                                        <span class="check"></span>
                                                        <span class="box"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="portlet light">
                                        <div class="portlet-title">
                                            <div class="caption">
                                                <i class="icon-list font-green"></i>
                                                <span class="caption-subject bold font-green uppercase">Dersler{{JSONSECILIDERS!=null?' ('+JSONSECILIDERS.length+') Ders Seçildi':''}}</span>
                                                <span class="caption-helper"></span>
                                            </div>
                                            <div class="tools" style="color:#32c5d2!important;">
                                                <span style="cursor:pointer;" data-toggle='modal' href='#ders_modal' title="Ders Ekle" v-if="JSONSECILIDERS==undefined||JSONSECILIDERS==null||JSONSECILIDERS.length==0">Ders Ekle<i class="fa fa-lg fa-plus-circle" style="margin-left:10px;" /></span>
                                                <span style="cursor:pointer;" data-toggle='modal' href='#ders_modal' title="Ders Ekle/Düzenle" v-else>Ders Ekle / Düzenle<i class="fa fa-lg fa-pencil" style="margin-left:10px;" /></span>
                                            </div>
                                        </div>
                                        <!-- BEGIN PORTLET-->
                                        <div class="portlet-body form">
                                            <div class="portlet light bordered">
                                                <div class="portlet-body" style="padding:0px;">
                                                    <table class="table table-striped table-bordered table-checkable">
                                                        <thead>
                                                            <tr>
                                                                <th>Grup</th>
                                                                <th>Ders Adı</th>
                                                                <th>Görünecek İsim</th>
                                                                <th style="width:100px!important;">Soru Sayısı</th>
                                                                <th style="width:100px!important;">İşlemler</th>
                                                                <th style="width:100px!important;" v-if="ID_SINAV!=0">Güncelle</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="ders in JSONSECILIDERS">
                                                                <td>{{ders.parent}}</td>
                                                                <td>{{ders.text}}</td>
                                                                <td><input class="form-control" v-model="ders.TAKMAAD" type="text" :placeholder="ders.text" maxlength="250" /></td>
                                                                <td><input class="form-control" v-model="ders.SORUSAYISI" v-on:change="DersSorulariOlustur(ders)" type="text" style="text-align:center;" onclick="javascript: this.value = ''" onkeypress='return event.charCode >= 48 && event.charCode <= 57' /></td>
                                                                <td style="width:100px!important;">
                                                                    <div class="btn-group">
                                                                        <button class="btn btn-xs green dropdown-toggle form-control" type="button" data-toggle="dropdown" aria-expanded="false">
                                                                            İşlemler
                                                                            <i class="fa fa-angle-down"></i>
                                                                        </button>
                                                                        <ul class="dropdown-menu pull-left" role="menu">
                                                                            <li @click="DersSil(ders.id)">
                                                                                <a href="javascript:;">
                                                                                    <i class="fa fa-lg fa-trash-o" /> Sil
                                                                                </a>
                                                                            </li>
                                                                            <li @click="DersCogaltManuel(ders)">
                                                                                <!--v-if="ders.id.indexOf('x')==-1"-->
                                                                                <a href="javascript:;">
                                                                                    <i class="fa fa-lg fa-files-o" /> Çoğalt
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    </div>
                                                                </td>
                                                                <td v-if="ID_SINAV!=0">
                                                                    <button type="button" class="btn yellow" @click="DersAdiGuncelle(ders.ID_SINAVDERS,ders.TAKMAAD.length>0?ders.TAKMAAD:ders.text)">Ders Adı Güncelle</button>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>

                                                <div style="text-align:right;">
                                                    <button v-if="ID_SINAV!=0" type="button" class="btn green" @click="SorulariOlustur()" title="Sorular silinip tekrar oluşturulacaktır!">Soruları Yeniden Oluştur</button>
                                                    <button v-else type="button" class="btn green" @click="SorulariOlustur()">Soruları Oluştur</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- END PORTLET-->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>

    <div id="ders_modal" class="modal fade" tabindex="-1" data-replace="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">Ders Ekle</h4>
                </div>

                <div class="modal-body">
                    <span>Eklemek istediğiniz dersleri seçerek alt kısımda yer alan "TAMAM" butonuna tıklayınız.</span>
                    <div id="jstree_ders" style="padding:20px; padding-bottom:0px;"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn default" data-dismiss="modal">Kapat</button>
                    <button type="button" class="btn green" data-dismiss="modal" @click="DersEkle">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <div class="pull-right row" style="padding-bottom:20px;padding-right:30px" v-if="ID_SINAV>0 && ONLINETEST==true">
        <!--<button type="button" class="btn yellow" @click="CATaslakYukle">Cevap Anahtarı Excel Yükle       </button>-->

        <div class="fileinput fileinput-new" data-provides="fileinput" >
            <span class="fileinput-preview thumbnail" style="max-width: 1000px; max-height: 1000px;"> </span>
            <span>
                <span class="btn default btn-file">
                    <span class="fileinput-new yellow"> Cevap Anahtarı Excel'den Yükle </span>
                    <span class="fileinput-exists"> Değiştir </span>
                    <input type="file" name="..." accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="CADosya" data-preview-file-type="text">
                </span>
                <a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                <a href="javascript:;" @click="CATaslakYukle()" class="btn green fileinput-exists" data-dismiss="modal"> Tamam </a>
            </span>
        </div>

        <button type="button" class="btn gray" @click="CATaslakIndir">Cevap Anahtarı Excel Taslak İndir</button>
    </div>
    <div id="dersler" class="col-md-12" style="display:none;">
        <div v-for="u in JSONSECILIDERS" v-if="u.SORUSAYISI>0" class='portlet box blue-hoki dd-item' :id='"ders" + u.id ' :data-id='u.id' style='border:none;'>
            <div class='portlet-title dd-handle derssorudiv'>
                <div class='caption'>
                    <i class='fa fa-cogs'></i> {{u.parent + ' - ' + (u.TAKMAAD.length==0?u.text:u.TAKMAAD) + ' - '+ u.SORUSAYISI +' Soru'}}
                </div>
                <div class='caption' style="margin-left:75px;" :id='"divToplam-"+u.id' v-if="OLCEKSINAVI">
                </div>

                <div class='actions'>
                    <label :for="'ks'+u.id">Optik Sırası:</label><input type="number" min="1" :id="'ks'+u.id" v-model="u.SIRA" style="color:black; margin-left:8px; width:50px; text-align:center;" />
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;' data-toggle='collapse' :data-target='"#table" + u.id'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                    <!--<a href='javascript:;' class='btn btn-default btn-sm' style='border:none;' @click='DersSil(u.id)'>
                        <i class='fa fa-times'></i>
                    </a>-->
                </div>
            </div>
            <div class='portlet-body collapse' :id='"table" + u.id ' style='padding:0px;'>
                <table v-if="parseInt(u.SORUSAYISI)>0" :data-id='u.id' class='table table-striped table-hover dataTable tabledersitem' style='margin:0px;'>
                    <thead>
                        <tr>
                            <th style="width:20px; text-align:center;">No</th>
                            <th>Tür</th>
                            <th>A - Cevap</th>
                            <th style="text-align:center;">Bilgi</th>
                            <th style="text-align:center;">Bilişsel Süreç</th>
                            <th>Ünite</th>
                            <th>Soru Bankası</th>
                            <th style="text-align:center;">Karakter Sayısı</th>
                            <th v-if="OLCEKSINAVI" style="text-align:center;">Katsayı</th>
                            <th v-for="i in KITAPCIKSAYISI-1" :class='"karsilikkolon" + i'>
                                <span>{{String.fromCharCode(65 + i)+" - Karşılık"}}</span>
                                <i class='fa fa-times' style='float:right;cursor:pointer;' @click='KitapcikSil()'></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="soru in u.SORULIST">
                            <td style="text-align:center;"> {{soru.SORUNO}} </td>
                            <td>
                                <select :id='"t" + u.id + "-" + soru.SORUNO' class='form-control' v-model="soru.SORUTURU">
                                    <option value='1'>Test</option>
                                    <option value='2'>Açık Uçlu</option>
                                </select>
                            </td>
                            <td :id='"td" + u.id + "-" + soru.SORUNO'>
                                <select :id='"c" + u.id + "-" + soru.SORUNO' class='form-control' v-model="soru.ACEVAP" v-if="soru.SORUTURU==1" :disabled="listID_SINAVTERCIHI.indexOf('6')>-1">
                                    <option value='A'>A</option>
                                    <option value='B'>B</option>
                                    <option value='C'>C</option>
                                    <option value='D'>D</option>
                                    <option value='E'>E</option>
                                    <option value='F'>F</option>
                                </select>
                                <input id='"c" + u.id+ "-" + soru.SORUNO' type='text' class='form-control' placeholder='Açık Uçlu Cevap' v-model="soru.ACEVAP" maxlength='14' v-else>
                            </td>
                            <td>
                                <select v-model="soru.ID_BILGI" class="form-control">
                                    <option value="0">Seçiniz</option>
                                    <option v-for="BILGI in BILGILIST" :value="BILGI.ID_BILGI">{{BILGI.AD}}</option>
                                </select>
                            </td>
                            <td>
                                <select v-model="soru.ID_BILISSELSUREC" class="form-control">
                                    <option value="0">Seçiniz</option>
                                    <option v-for="BILISSELSUREC in BILISSELSURECLIST" :value="BILISSELSUREC.ID_BILISSELSUREC">{{BILISSELSUREC.AD}}</option>
                                </select>
                            </td>
                            <td>
                                <input :id='"unite"+u.id+"-"+soru.SORUNO' class='form-control pull-left' style="width:calc(50% - 27px);" v-model="soru.KOD==0?'':soru.KOD" placeholder="Ünite Kodu" @keyup.enter='UniteAra(u,soru,"unite"+u.id+"-"+soru.SORUNO)' />
                                <input class='form-control pull-left' style="width:calc(50% - 27px); margin-left:10px;" v-model="soru.UNITE" placeholder="Ünite Adı" readonly />
                                <i class="fa fa-lg fa-arrow-circle-o-down pull-right" style="margin-top:10px; cursor:pointer;" @click="UniteKopyala(u,soru,soru.KOD,soru.UNITE)"></i>
                                <i class="fa fa-lg fa-crosshairs pull-right" @click="DersKonuSec(u,soru)" style="margin-top:10px; cursor:pointer;"></i>
                            </td>
                            <td>
                                <input :id='"soruBankasi"+u.id+"-"+soru.SORUNO'
                                       class='form-control pull-left'
                                       style="width:calc(100% - 27px);"
                                       v-model="soru.ID_SORUBANKASI"
                                       placeholder="Soru Bankası ID"
                                       @keyup.enter='SoruBankasiAra(soru,"soruBankasi"+u.id+"-"+soru.SORUNO)' />
                                <i class="fa fa-lg fa-crosshairs pull-right" @click="SoruBankasiSoruSec(soru,u.id)" style="margin-top:10px; cursor:pointer;"></i>
                            </td>
                            <td style="width:30px!important;">
                                <input type="text" class='form-control' value="1" style="text-align:center;" v-model="soru.KARAKTERSAYISI" v-if="soru.SORUTURU==1" disabled />
                                <input type="text" class='form-control' maxlength="2" placeholder="Karakter Sayısı" value="1" style="text-align:center;" onkeypress='return event.charCode >= 48 && event.charCode <= 57' v-model="soru.KARAKTERSAYISI" v-else />
                            </td>
                            <td v-if="OLCEKSINAVI">
                                <input type="text" class='form-control' style="text-align:center;" v-model="soru.KATSAYI" onkeypress='return event.charCode >= 44 && event.charCode <= 57'
                                       v-on:keyup="olcekSinaviKatSayiGirisi(u.id,u.SORULIST)" />
                            </td>
                            <td v-for="k in KITAPCIKSAYISI-1">
                                <select class='form-control' :id='"kar"+k+"-" + u.id + "-" + soru.SORUNO' v-if="soru.KARSILIKLIST!= undefined" v-model="soru.KARSILIKLIST[k-1].SIRA">
                                    <option v-for="l in parseInt(u.SORUSAYISI)" :value='l'> {{l}} </option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-12" style="text-align:right;">
        <button id="BTNKAYDET" type="button" class="btn green" @click="SinavOlustur()">Kaydet</button>
    </div>

    <div class="modal fade" id="dersKonuModal" role="dialog" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content" id="dersKonu">
                <div class="modal-header" id="unite_header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><label id="modal_baslik">Ünite Seçimi</label></h4>
                </div>
                <div class="modal-body">
                    <div id="div_uniteler" class="row" style="max-height:600px; overflow-y:auto">

                    </div>
                </div>
                <div class="modal-footer" id="div_footer">
                    <button type="button" class="btn success btn-default" data-dismiss="modal">Tamam</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="SoruBankasiModal" role="dialog" style="display: none;">
        <div class="modal-dialog  modal-lg" style="width:auto !important;">
            <div class="modal-content" id="soruBankasi">
                <div class="modal-header" id="unite_header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><label id="modal_baslik">Soru Seçimi</label></h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-bordered" id="table_soru">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ID_SORU</th>
                                <th>Soru Bilgileri</th>
                                <th>Soru Geçmişi</th>
                                <th>Soru Önizlemesi</th>
                                <th>Cevap Önizlemesi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="VueComponents/SinavFiltreleri.js?v=5"></script>
<script>
    var vue = new Vue({
        el: "#app",
        name: "SinavTanimla.html",
        data: {
            ID_SINAV: 0,
            ID_SINAVTURU: 0,
            listID_SINAVTERCIHI: [],
            SINAVADI: '',
            SINAVKODU: '',
            RAPORBASLIK: '',
            OLCEKSINAVI: false,
            ID_KADEME3: 0,
            TARIH: '',
            YANLISSAYISI: 0,
            KITAPCIKSAYISI: 1,
            ID_DERS: 0,
            JSONDERS: null,
            JSONSECILIDERS: null,
            BILGILIST: [],
            BILISSELSURECLIST: [],
            table: null,
            SECILISORU: null,
            DOSYALIST: [{ AD: '', GUID: '', UZANTI: '' }],
            YONERGE: undefined,
            ONLINETEST: true

        },
        mounted() {
            let ID_SINAV = getParameterByName("ID_SINAV");
            if (getParameterByName("ID_SINAV") != null) {
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: ID_SINAV };
                WebPost(this, "SinavTanimla", "SinavBilgiGetir", p, "", "", function (data, parent) {
                    var JSONx = JSON.parse(data);
                    if (JSONx[0].ID_SINAVTURU == 15) {
                        vue.SinavDersGetir(true);
                        vue.ONLINETEST = false;
                    }
                    else {
                        vue.SinavDersGetir(false);
                        vue.ONLINETEST = true;

                    }
                });
            }
            else {
                this.SinavDersGetir(false);
            }


            var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM };
            WebPost(this, "SinavTanimla", "BilgiListele", p, "", "", function (data, parent) {
                parent.BILGILIST = JSON.parse(data);

                WebPost(parent, "SinavTanimla", "BilisselSurecListele", p, "", "", function (data, parent2) {
                    parent2.BILISSELSURECLIST = JSON.parse(data);

                    parent2.$nextTick(function () {
                        if (getParameterByName("ID_YAZILI") != null) {
                            parent2.ID_YAZILI = parseInt(getParameterByName("ID_YAZILI"));
                            parent2.YaziliBilgiGetir();
                        }
                    });
                })
            })
        },

        computed: {
            total: function () {
                return this.items.reduce(function (prev, item) {
                    return sum + item.price;
                }, 0);
            },
        },

        methods: {

            olcekSinaviKatSayiGirisi(idSinavDers, soruList) {
                var toplam = 0;
                $.each(soruList, function (i, el) {
                    el.KATSAYI != undefined ?
                        toplam += parseFloat(el.KATSAYI)
                        : toplam = toplam;
                });
                $("#divToplam-" + idSinavDers).html("Toplam Puan : " + toplam)
            },

            SinavTuruSelected(ID_SINAVTURU) {
                this.ID_SINAVTURU = ID_SINAVTURU;
                if (ID_SINAVTURU == 15) {
                    this.listID_SINAVTERCIHI = ["6"];
                    this.ONLINETEST = false;
                    this.SinavDersGetir(true);
                }
                else {
                    this.ONLINETEST = true;
                    this.listID_SINAVTERCIHI = [];
                    this.SinavDersGetir(false);
                }
            },
            SinavTercihiSelected(listID_SINAVTERCIHI) {
                this.listID_SINAVTERCIHI = listID_SINAVTERCIHI;
                if (this.listID_SINAVTERCIHI == null) {
                    this.listID_SINAVTERCIHI = [];
                }
            },
            SinavGrupSelected(ID_KADEME3) {
                this.ID_KADEME3 = ID_KADEME3;
            },
            TarihSelected(TARIH) {
                this.TARIH = TARIH;
            },
            YanlisSayisiSelected(YANLISSAYISI) {
                this.YANLISSAYISI = YANLISSAYISI;
            },
            KitapcikSayisiSelected(KITAPCIKSAYISI) {
                this.KITAPCIKSAYISI = KITAPCIKSAYISI;

                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                    item = this.JSONSECILIDERS[i];
                    var SORULIST = new Array();
                    for (var j = 0; j < parseInt(this.JSONSECILIDERS[i].SORULIST.length); j++) {
                        var KARSILIKLIST = new Array();
                        for (var k = 1; k < this.KITAPCIKSAYISI; k++) {
                            var KARSILIK = new Object();
                            KARSILIK.KITAPCIK = String.fromCharCode(65 + k);
                            KARSILIK.SIRA = j + 1;
                            KARSILIKLIST.push(KARSILIK);
                        }
                        this.JSONSECILIDERS[i].SORULIST[j].KARSILIKLIST = KARSILIKLIST;
                    }
                }
            },
            DersSelected(ID_DERS) {
                this.ID_DERS = ID_DERS;
            },
            SinavDersGetir(onlineSinavMi) {
                debugger;
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM };
                WebPost(this, "SinavTanimla", "SinavDersListele", p, '', '', function (data, parent) {
                    parent.JSONDERS = JSON.parse(data);
                    if (getParameterByName("ID_SINAV") != null) {
                        parent.ID_SINAV = parseInt(getParameterByName("ID_SINAV"));

                        if (onlineSinavMi) {
                            $('#jstree_ders').jstree('destroy')
                            $('#jstree_ders').jstree({
                                "plugins": ["checkbox"], core: { data: parent.JSONDERS, multiple: false }, 'checkbox': {
                                    'deselect_all': true,
                                    'three_state': false,
                                }
                            })
                                .bind("loaded.jstree", function (event, data) {
                                    vue.SinavBilgiGetir()
                                });
                        }
                        else {
                            $('#jstree_ders').jstree('destroy')
                            $('#jstree_ders').jstree({
                                "plugins": ["checkbox"], core: { data: parent.JSONDERS, multiple: true }, 'checkbox': {
                                    'deselect_all': false,
                                    'three_state': false,
                                }
                            })
                                .bind("loaded.jstree", function (event, data) {
                                    vue.SinavBilgiGetir()
                                });
                            //setTimeout(() => { vue.SinavBilgiGetir() }, 1000);
                            //parent.SinavBilgiGetir();
                            console.log(vue.ONLINETEST);
                        }
                    }
                    else {
                        if (onlineSinavMi) {
                            $('#jstree_ders').jstree('destroy')
                            $('#jstree_ders').jstree({
                                "plugins": ["checkbox"], core: { data: parent.JSONDERS, multiple: false }, 'checkbox': {
                                    'deselect_all': true,
                                    'three_state': false,
                                }
                            })


                        }
                        else {
                            $('#jstree_ders').jstree('destroy')
                            $('#jstree_ders').jstree({
                                "plugins": ["checkbox"], core: { data: parent.JSONDERS, multiple: true }, 'checkbox': {
                                    'deselect_all': false,
                                    'three_state': false,
                                }
                            });

                        }



                    }
                })


            },
            DersEkle() {
                var items = this.SeciliDersGetir();
                if (this.JSONSECILIDERS == null || this.JSONSECILIDERS.length == 0) {
                    this.JSONSECILIDERS = JSON.parse(JSON.stringify(items));
                }
                else {
                    for (var i = 0; i < items.length; i++) {
                        if (!this.search(this.JSONSECILIDERS, items[i].id)) {
                            this.JSONSECILIDERS.push(JSON.parse(JSON.stringify(items[i])));
                        }
                    }
                    for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                        if (!this.search(items, this.JSONSECILIDERS[i].id)) {
                            this.JSONSECILIDERS.splice(i, 1);
                        }
                    }
                }
            },
            SeciliDersGetir() {
                return $('#jstree_ders').jstree('get_selected', true).filter(
                    function (data) {
                        data.SORUSAYISI = 0;
                        data.TAKMAAD = '';
                        data.SORULIST = new Array();
                        //return data.id.substring(data.id.indexOf('.') + 1, 8) != "Sınıf"
                        return data.id.indexOf("Sınıf") == -1
                    });
            },
            SeçiliDersIDGetir() {
                return $('#jstree_ders').jstree('get_selected').filter(
                    function (data) {
                        //return data.substring(data.indexOf('.') + 1, 8) != "Sınıf"
                        return data.id.indexOf("Sınıf") == -1
                    });
            },
            DersSil(id) {
                var index  // = this.DersIndexBul(id);


                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                    if (this.JSONSECILIDERS[i].id == id) {
                        index = i;
                    }
                }

                this.JSONSECILIDERS.splice(index, 1);
                index = this.DersIndexBul(id);
                if (index == -1) {
                    var node = $('#jstree_ders').jstree("get_node", id);
                    $('#jstree_ders').jstree("deselect_node", node);
                }
            },
            DersIndexBul(id) {
                var last = -1;
                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                    if (this.JSONSECILIDERS[i].id.includes(id)) {
                        last = i;
                    }
                }
                return last;
            },
            DersIDSay(id) {
                var count = 0;

                if (id.substring(0, id.indexOf('_')).length > 0) {
                    id = id.substring(0, id.indexOf('_'));
                } else {
                    id = id;
                }

                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {

                    if (this.JSONSECILIDERS[i].id.substring(0, this.JSONSECILIDERS[i].id.indexOf('_')).length > 0) {
                        idx = this.JSONSECILIDERS[i].id.substring(0, this.JSONSECILIDERS[i].id.indexOf('_'));
                    } else {
                        idx = this.JSONSECILIDERS[i].id;
                    }

                    if (idx == id) {
                        count++;
                    }
                }
                return count;
            },
            DersIDSay2(list, id) {
                var count = 0;

                if (id.substring(0, id.indexOf('_')).length > 0) {
                    id = id.substring(0, id.indexOf('_'));
                } else {
                    id = id;
                }

                for (var i = 0; i < list.length; i++) {

                    if (list[i].id.substring(0, list[i].id.indexOf('_')).length > 0) {
                        idx = list[i].id.substring(0, list[i].id.indexOf('_'));
                    } else {
                        idx = list[i].id;
                    }

                    if (idx == id) {
                        count++;
                    }
                }
                return count;
            },
            DersCogaltManuel(ders) {
                //if (this.DersIndexBul(ders.id + 'x') == -1) {
                var index = this.DersIndexBul(ders.id);
                var newders = JSON.parse(JSON.stringify(ders));
                var id = '';
                if (ders.id.substring(0, ders.id.indexOf('_')).length > 0) {
                    id = ders.id.substring(0, ders.id.indexOf('_'));
                } else {
                    id = ders.id;
                }
                newders.id = id + '_' + this.DersIDSay(ders.id);
                this.JSONSECILIDERS.splice(index + 1, 0, newders);
                this.DersSorulariOlustur(newders);
                return newders;
                //} else {
                //    Alert_Info("Bu ders zaten çoğaltılmış.");
                //}
            },
            KitapcikSil() {
                this.KITAPCIKSAYISI--;
                SorulariOlustur();
            },
            SorulariOlustur() {
                var _this = this;
                Alert_Confirm("DİKKAT", "Bu işleme devam ederseniz testlerdeki kazanımlar ve cevap anahtarı silinecektir", function () {


                    for (var i = 0; i < _this.JSONSECILIDERS.length; i++) {
                        item = _this.JSONSECILIDERS[i];
                        _this.JSONSECILIDERS[i].SIRA = i + 1;
                        var SORULIST = new Array();
                        for (var j = 0; j < parseInt(item.SORUSAYISI); j++) {
                            var SORU = new Object();
                            SORU.SORUNO = j + 1;
                            SORU.SORUTURU = 1;
                            SORU.ACEVAP = 'A';
                            SORU.KOD = '';
                            SORU.UNITE = '';
                            SORU.KARAKTERSAYISI = '1';
                            SORU.ID_BILGI = 0;
                            SORU.ID_BILISSELSUREC = 0;
                            var KARSILIKLIST = new Array();
                            for (var k = 1; k < _this.KITAPCIKSAYISI; k++) {
                                var KARSILIK = new Object();
                                KARSILIK.KITAPCIK = String.fromCharCode(65 + k);
                                KARSILIK.SIRA = j + 1;
                                KARSILIKLIST.push(KARSILIK);
                            }
                            SORU.KARSILIKLIST = KARSILIKLIST;
                            SORULIST.push(SORU);
                        }
                        _this.JSONSECILIDERS[i].SORULIST = SORULIST;
                    }

                    $('#dersler').css("display", "block");
                }
                );
            },
            DersSorulariOlustur(ders) {
                var SORULIST = new Array();
                for (var j = 0; j < parseInt(ders.SORUSAYISI); j++) {
                    var SORU = new Object();
                    SORU.SORUNO = j + 1;
                    SORU.SORUTURU = 1;
                    SORU.ACEVAP = 'A';
                    SORU.KOD = '';
                    SORU.UNITE = '';
                    SORU.KARAKTERSAYISI = '1';
                    SORU.ID_BILGI = 0;
                    SORU.ID_BILISSELSUREC = 0;
                    var KARSILIKLIST = new Array();
                    for (var k = 1; k < this.KITAPCIKSAYISI; k++) {
                        var KARSILIK = new Object();
                        KARSILIK.KITAPCIK = String.fromCharCode(65 + k);
                        KARSILIK.SIRA = j + 1;
                        KARSILIKLIST.push(KARSILIK);
                    }
                    SORU.KARSILIKLIST = KARSILIKLIST;
                    SORULIST.push(SORU);
                }

                ders.SORULIST = SORULIST;
                //$('#dersler').css("display", "block");
            },
            DersIDDuzelt() {
                var dersler = this.JSONSECILIDERS.filter(function (data) {
                    return parseInt(data.SORUSAYISI) != 0;
                });
                for (var i = 0; i < dersler.length; i++) {
                    dersler[i].id = dersler[i].id.indexOf('_') > 0 ? dersler[i].id.substring(0, dersler[i].id.indexOf('_')) : dersler[i].id;
                }
                return dersler;
            },
            SinavOlustur() {
                $('#BTNKAYDET').attr("disabled", true);

                if (this.KarsilikKontrol()) {
                    var JSONx = new Object();
                    JSONx.ID_SINAVTURU = this.ID_SINAVTURU;
                    JSONx.AD = this.SINAVADI;
                    JSONx.KOD = this.SINAVKODU;
                    JSONx.RAPORBASLIK = this.RAPORBASLIK;
                    JSONx.KITAPCIKSAYISI = this.KITAPCIKSAYISI;
                    JSONx.ID_KADEME3 = this.ID_KADEME3;
                    JSONx.SINAVTARIH = this.TARIH;
                    JSONx.OZEL = this.listID_SINAVTERCIHI.indexOf("1") > -1 ? 1 : 0;
                    JSONx.FREKANSHESAPLA = this.listID_SINAVTERCIHI.indexOf("2") > -1 ? 1 : 0;
                    JSONx.PUANGIZLE = this.listID_SINAVTERCIHI.indexOf("3") > -1 ? 1 : 0;
                    JSONx.YUKLEMEKAPAT = this.listID_SINAVTERCIHI.indexOf("4") > -1 ? 1 : 0;
                    JSONx.CEVAPANAHTARIYUKLEMEKAPAT = this.listID_SINAVTERCIHI.indexOf("5") > -1 ? 1 : 0;
                    JSONx.ONLINESINAV = this.listID_SINAVTERCIHI.indexOf("6") > -1 ? 1 : 0;
                    JSONx.SIRALAMAYIGIZLE = this.listID_SINAVTERCIHI.indexOf("7") > -1 ? 1 : 0;
                    JSONx.YANLISSAYISI = this.YANLISSAYISI;
                    JSONx.OLCEKSINAVI = this.OLCEKSINAVI ? 1 : 0;
                    JSONx.JSONDERS = this.DersIDDuzelt();

                    if (JSONx.ONLINESINAV == 1) {
                        let hatali = false;
                        $.each(JSONx.JSONDERS,
                            function (i, v) {
                                $.each(v.SORULIST,
                                    function (j, p) {

                                        let soru = p.ID_SORUBANKASI;
                                        if (soru == null || soru == undefined || soru == '') {
                                            hatali = true;
                                            return;
                                        }
                                    });
                            });

                        if (hatali === true) {
                            Alert_Error("Soru bankası boş bırakılamaz");
                            $('#BTNKAYDET').attr("disabled", false);
                            return;
                        }
                    }

                    let x = document.getElementById("yonergeDosya");
                    if (x.files.length == 1) {
                        if ('files' in x) {
                            var formData = new FormData();
                            let url = this.ID_SINAV == 0 ? "/YonergeSinavKaydet" : "/YonergeSinavGuncelle";
                            for (var i = 0; i < x.files.length; i++) {
                                formData.append("file", x.files[i]);

                                formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                                formData.append("OTURUM", session.OTURUM);
                                formData.append("ID_SINAV", vue.ID_SINAV);
                                formData.append("SQLJSON", JSON.stringify(JSONx).replace(new RegExp('\'', 'g'), ''));
                                $.ajax({
                                    url: "SinavTanimla" + url,
                                    processData: false,
                                    contentType: false,
                                    data: formData,
                                    type: 'POST'
                                }).done(function (result) {
                                    App.unblockUI('#app');
                                    if (result != null) {
                                        vue.Kaydedildi();
                                    } else
                                        Alert_Error("Dosya Yüklenirken Hata Oluştu");
                                });
                            }
                        }
                    } else {
                        var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: this.ID_SINAV, SQLJSON: JSON.stringify(JSONx).replace(new RegExp('\'', 'g'), '') };
                        WebPost(this, "SinavTanimla", this.ID_SINAV == 0 ? "SinavTanimla" : "SinavGuncelle", p, '', 'Yükleniyor..', function (data, parent) {
                            if (data == 0) {
                                Alert_Error("Yetkiniz bulunmamaktadır");
                                return;
                            } else if (data == 1) {

                                if (parent.ID_SINAV == 0) {
                                    parent.Alert_Sinav("Kaydedildi", data);
                                } else {
                                    if (data) {
                                        parent.Alert_Sinav("Kaydedildi", data);
                                    }
                                }
                            }

                        });

                    }
                } else {
                    $('#BTNKAYDET').attr("disabled", false);
                }
            },
            Alert_Sinav(message, ID_SINAV2) {
                bootbox.dialog({
                    message: "<font color='green'>" + message + "</font>",
                    title: "<font color='green'>İşlem Tamam</font>",
                    buttons: {
                        success: {
                            label: "Tamam!",
                            className: "btn-success",
                            callback: function () {
                                if (ID_SINAV2 == true) {
                                    location.reload();
                                } else {
                                    window.location.replace((document.URL.indexOf('?') > -1 ? (document.URL.substring(0, document.URL.indexOf('?'))) : (document.URL)) + '?ID_SINAV=' + ID_SINAV2);
                                }
                            }
                        },
                    }
                });
            },
            YonergeSil() {
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: this.ID_SINAV };
                WebPost(this, "SinavTanimla", "YonergeSil", p, "", "", function (data, parent) {
                    if (data != null) {
                        Alert_Info("Yönerge Başarı ile Silindi.");
                        parent.YONERGE = undefined;
                    }
                });
            },
            SinavBilgiGetir() {

                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: this.ID_SINAV };
                WebPost(this, "SinavTanimla", "SinavBilgiGetir", p, "", "", function (data, parent) {
                    var JSONx = JSON.parse(data)[0];
                    parent.ID_SINAVTURU = JSONx.ID_SINAVTURU;
                    parent.SINAVADI = JSONx.AD;
                    parent.SINAVKODU = JSONx.KOD;
                    parent.RAPORBASLIK = JSONx.RAPORBASLIK;
                    parent.KITAPCIKSAYISI = JSONx.KITAPCIKSAYISI;
                    parent.ID_KADEME3 = JSONx.ID_KADEME3;
                    parent.TARIH = JSONx.SINAVTARIH;
                    parent.OLCEKSINAVI = JSONx.OLCEKSINAVI;

                    console.log(JSONx.YONERGE);
                    if (JSONx.YONERGE) {
                        parent.YONERGE = 'https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/onlinesinav/yonerge/' + JSONx.YONERGE;

                    } else {
                        parent.YONERGE = undefined;
                    }

                    if (JSONx.OZEL) { parent.listID_SINAVTERCIHI.push("1"); }
                    if (JSONx.FREKANSHESAPLA) { parent.listID_SINAVTERCIHI.push("2"); }
                    if (JSONx.PUANGIZLE) { parent.listID_SINAVTERCIHI.push("3"); }
                    if (JSONx.YUKLEMEKAPAT) { parent.listID_SINAVTERCIHI.push("4"); }
                    if (JSONx.CEVAPANAHTARIYUKLEMEKAPAT) { parent.listID_SINAVTERCIHI.push("5"); }
                    if (JSONx.ONLINESINAV) { parent.listID_SINAVTERCIHI.push("6"); }
                    if (JSONx.SIRALAMAYIGIZLE) { parent.listID_SINAVTERCIHI.push("7"); }

                    parent.YANLISSAYISI = JSONx.YANLISSAYISI;

                    var jsDers = JSON.parse(data)[0].JSONDERS;

                    for (var i = 0; i < jsDers.length; i++) {
                        var node = $('#jstree_ders').jstree("get_node", jsDers[i].id);
                        if (!node.state.selected) {
                            $('#jstree_ders').jstree("select_node", node);
                        }
                    }

                    parent.DersEkle();
                    var _this = parent;
                    var json = JSONx;

                    var cnt = 0;
                    var id = 0;

                    var List = [];

                    for (var i = 0; i < jsDers.length; i++) {
                        if (List.indexOf(jsDers[i].id) == -1) {
                            var ders = _this.JSONSECILIDERS[_this.DersIndexBul(jsDers[i].id)];
                            ders.TAKMAAD = jsDers[i].text;
                            ders.SORUSAYISI = jsDers[i].SORUSAYISI;
                        } else {
                            var ders = _this.JSONSECILIDERS[_this.DersIndexBul(jsDers[i].id)];
                            _this.DersCogaltExcel(ders, jsDers[i].SIRA, jsDers[i].text, jsDers[i].SORUSAYISI);
                        }
                        List.push(jsDers[i].id);
                    }

                    for (var i = 0; i < jsDers.length; i++) {
                        var ders = _this.JSONSECILIDERS[_this.DersIndexBulTakmaAd(jsDers[i].text)];
                        doluitem = jsDers[i];
                        var SORULIST = doluitem.SORULIST;
                        ders.SIRA = doluitem.SIRA;
                        ders.ID_SINAVDERS = doluitem.id_sinavders;
                        ders.SORULIST = SORULIST;
                    }

                    $('#dersler').css("display", "block");

                })

            },

            DersIndexBulTakmaAd(TAKMAAD) {
                var last = -1;
                for (var i = 0; i < this.JSONSECILIDERS.length; i++) {
                    //if (this.JSONSECILIDERS[i].TAKMAAD.includes(TAKMAAD)) {
                    if (this.JSONSECILIDERS[i].TAKMAAD === TAKMAAD) {
                        last = i;
                    }
                }
                return last;
            },
            DersKonuSec(DERS, SORU) {
                var id = DERS.id.substring(0, DERS.id.indexOf('_'));
                if (DERS.id.substring(0, DERS.id.indexOf('_')).length > 0) {
                    id = DERS.id.substring(0, DERS.id.indexOf('_'));
                } else {
                    id = DERS.id;
                }
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_DERS: id };
                WebPost(this, "SinavTanimla", "DersKonuListele", p, '#dersler', '', function (data, parent) {
                    $("#div_uniteler").html('');
                    var Uniteler = '<option value="0">Ünite Seçiniz ...</option>';
                    $('#dersKonuModal').modal();
                    var unitekodu = "";
                    $.each(data, function (j) {
                        if (this.KOD.substring(0, 6) != unitekodu) {
                            if (j != 0) {
                                Uniteler += '</optgroup>';
                                Uniteler += '</optgroup>';
                            }
                            unitekodu = this.KOD;
                            Uniteler += '<optgroup style="background-color:yellow;" label="' + vue.bosluk(this.KOD.length, this.AD) + '">';
                        }
                        else {
                            Uniteler += '</optgroup>';

                            if (this.SECILEBILIR) {
                                Uniteler += '<option value="' + this.KOD + '" unite="' + this.AD + '">' + vue.bosluk(this.KOD.length, this.AD) + '</option>';
                            } else {
                                Uniteler += '<optgroup label="' + vue.bosluk(this.KOD.length, this.AD) + '">';
                            }
                        }
                    })

                    Uniteler += '</optgroup>';
                    Uniteler += '</optgroup>';

                    $("#div_uniteler").html('' +
                        '<div class="col-md-12 selectunite">' +
                        '<select id="su' + DERS.id + "-" + SORU.SORUNO + '" class="form-control input-sm" data-live-search="true">' +
                        Uniteler +
                        '</select>' +
                        '</div>' +
                        '<br/>');

                    $('#su' + DERS.id + "-" + SORU.SORUNO).change(function () {
                        SORU.KOD = $(this).val();
                        SORU.UNITE = this.options[this.selectedIndex].getAttribute('unite');
                    })
                })
            },


            SoruBankasiAra(SORU, ID) {
                var text = $('#' + ID).val();
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAV: this.ID_SINAV, UNITEKOD: SORU.KOD, ID_SORUBANKASI: text };
                WebPost(this, "SinavTanimla", "SoruBankasiAra", p, '#soruBankasi', '', function (data, parent) {
                    if (data != '[]') {
                        var veri = JSON.parse(data)[0];
                        if (veri.SORUGECMIS.length > 0) {
                            SORU.ID_SORUBANKASI = '';
                            var SORUGECMIS = '';
                            for (var i = 0; i < veri.SORUGECMIS.length; i++) {
                                SORUGECMIS += '<br />' + (i + 1) + '-) ' + veri.SORUGECMIS[i].DONEM + ' ' + veri.SORUGECMIS[i].SINAVTURU + ' <small>' + veri.SORUGECMIS[i].SINAVAD + '</small>';
                            }
                            Alert_Confirm("DİKKAT", "Bu soru şu sınavlarda kullanıldı: " + SORUGECMIS + "<br />Yine de kullanmak istiyor musunuz?", function () {
                                SORU.ID_SORUBANKASI = veri.ID_SORU;
                                SORU.UNITE = veri.UNITEAD;
                                SORU.KOD = veri.UNITEKOD;
                                SORU.ID_BILISSELSUREC = veri.ID_SORUDUZEY;
                            });
                        } else {
                            SORU.ID_SORUBANKASI = veri.ID_SORU;
                            SORU.UNITE = veri.UNITEAD;
                            SORU.KOD = veri.UNITEKOD;
                            SORU.ID_BILISSELSUREC = veri.ID_SORUDUZEY;
                        }
                    }
                    //if (data > 0) {
                    //    SORU.ID_SORUBANKASI = text;
                    //}
                    else {
                        SORU.ID_SORUBANKASI = '';
                        Alert_Warning('Eşleşme bulunamadı!');
                    }
                    vue.$forceUpdate()
                });
            },
            SoruBankasiSoruSec(SORU, idDers) {
                this.SECILISORU = SORU;
                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    KOD: SORU.KOD,
                    ID_SINAV: this.ID_SINAV,
                    ID_DERS: idDers.split("_")[0]
                };

                if (this.table != null)
                    this.table.destroy();

                $('#SoruBankasiModal').modal();

                this.table = $('#table_soru').DataTable({
                    "processing": true,
                    "serverSide": true,
                    "order": [[0, 'desc']],
                    "lengthMenu": [[5, 10, 50], [5, 10, 50]],
                    "columnDefs": [
                        {
                            "targets": 0,
                            "visible": false,
                            "searchable": true,
                            "orderable": false
                        },
                        { orderable: false, targets: '_all' }
                    ],
                    "ajax": {
                        "url": "/SinavTanimla/SoruListesiGetirSB",
                        "type": 'POST',
                        "data": function (d) {
                            p.SQLJSON = JSON.stringify(d);
                            return p;
                        },
                        "dataFilter": function (data) {
                            var json = JSON.parse(JSON.parse(data));
                            var sorular = JSON.parse(json.data);

                            sorular.forEach(function (val, index, arr) {


                                var soruGecmis = "";
                                var soruGecmisText = "";
                                if (val.SORUGECMIS.length > 0) {
                                    val.SORUGECMIS.forEach(function (gecmis, index1, arr1) {
                                        soruGecmis += '<div style="margin-bottom:10px;"> ' + (index1 + 1) + '-) ' + gecmis.DONEM + ' ' + gecmis.SINAVTURU + ' <small>' + gecmis.SINAVAD + '</small></div><br>';
                                        soruGecmisText += '<br />' + (index1 + 1) + '-) ' + gecmis.DONEM + ' ' + gecmis.SINAVTURU + ' <small>' + gecmis.SINAVAD + '</small>';
                                    });
                                    val.SORUGECMIS = soruGecmis;
                                }

                                var cevapx = val.CEVAP.filter(x => x.DEGER == 1)[0].CEVAPNO;
                                val.SORUBILGILERI += '<br />' +
                                    '<a onclick="SoruSecSB(' + val.ID_SORU + ',\'' + val.UNITEKOD + '\',\'' + val.UNITEAD + '\',\'' + cevapx + '\',\'' + val.ID_SORUDUZEY + '\',\'' + soruGecmisText + '\')" class="btn btn-sm green margin-top-10"> Soru Seç <i class="fa fa-lg fa-crosshairs"></i></a>';
                                jQuery.ajax({
                                    url: val.SORUHTML,
                                    success: function (result) {
                                        val.SORUHTML = result.replace(/"\/assets\/ckeditor\/plugins\/ckeditor_wiris/g, "\"https://sorubankasi.okyanuskoleji.k12.tr/assets/ckeditor/plugins/ckeditor_wiris");
                                    },
                                    async: false
                                });
                                switch (val.ID_SORUTUR) {
                                    case 4: {
                                        var CEVAP = '';
                                        if (val.CEVAP != null) {
                                            val.CEVAP.forEach(function (Cval, Cindex, Carr) {
                                                jQuery.ajax({
                                                    url: Cval.CEVAPHTML,
                                                    success: function (result) {
                                                        Cval.CEVAPHTML = result.replace(/"\/assets\/ckeditor\/plugins\/ckeditor_wiris/g, "\"https://sorubankasi.okyanuskoleji.k12.tr/assets/ckeditor/plugins/ckeditor_wiris");
                                                        //result;
                                                    },
                                                    async: false
                                                });
                                                CEVAP += '<div style="margin-bottom:10px;"><div style="width:30px; display:inline-block; vertical-align:middle;' + (Cval.DEGER == 1 ? 'color: red;' : '') + '">' + String.fromCharCode(64 + Cval.CEVAPNO) + ' -) ' + '</div><div style="width:calc(100% - 30px); display:inline-block; vertical-align:middle;">' + Cval.CEVAPHTML + '</div></div>';
                                            });
                                        }
                                        val.CEVAP = CEVAP;
                                        break;
                                    } //Test
                                    default:
                                }
                            });

                            json.data = sorular;

                            if (json.recordsTotal != null && json.recordsTotal == 0) {
                                $('#table_wrapper').css('display', 'none');
                            } else {
                                $('#table_wrapper').css('display', 'block');
                            }

                            vue.DATA = json;
                            return JSON.stringify(json);
                        },
                    },
                    "columns": [
                        { "data": "RowNumber" },
                        { "data": "ID_SORU" },
                        { "data": "SORUBILGILERI" },
                        { "data": "SORUGECMIS" },
                        { "data": "SORUHTML" },
                        { "data": "CEVAP" },
                    ],
                    language: {
                        "url": "./Utility/dil.json"
                    },
                    searching: true,
                    rowId: 'ID_SORU'
                });
                this.$forceUpdate();
            },


            search(list, id) {
                for (var i = 0; i < list.length; i++) {
                    if (list[i].id == id || list[i].id + 'x' == id || list[i].id == id + 'x') {
                        return true;
                    }
                }
                return false;
            },
            UniteKopyala(seciliders, soru, KOD, UNITE) {
                try {
                    seciliders.SORULIST[soru.SORUNO].KOD = KOD;
                    seciliders.SORULIST[soru.SORUNO].UNITE = UNITE;
                } catch (e) {

                }
            },
            bosluk(length, ad) {
                var str = '';
                for (var i = 0; i < (length - 6); i++) {
                    str += '&nbsp ';
                }
                return str + ad;
            },
            UniteAra(DERS, SORU, ID) {
                var text = $('#' + ID).val();
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_DERS: DERS.id.replace('x', ''), UNITEKOD: text };
                WebPost(this, "SinavTanimla", "UniteAra", p, '#dersler', '', function (data, parent) {
                    if (data != null) {
                        SORU.KOD = text;
                        SORU.UNITE = data;
                    } else {
                        SORU.KOD = text;
                        SORU.UNITE = 'Eşleşme bulunamadı!';
                    }
                    vue.$forceUpdate()
                });
            },
            KarsilikKontrol() {
                for (var k = 0; k < this.JSONSECILIDERS.length; k++) {
                    for (var i = 1; i < this.KITAPCIKSAYISI; i++) {
                        var KontrolList = new Array();
                        for (var j = 1; j <= this.JSONSECILIDERS[k].SORULIST.length; j++) {
                            if (KontrolList.indexOf($('#kar' + i + '-' + this.JSONSECILIDERS[k].id + '-' + j).val()) == -1) {
                                KontrolList.push($('#kar' + i + '-' + this.JSONSECILIDERS[k].id + '-' + j).val());
                            } else {
                                Alert_Info(this.JSONSECILIDERS[k].parent + ' ' + (this.JSONSECILIDERS[k].TAKMAAD == '' ? this.JSONSECILIDERS[k].text : this.JSONSECILIDERS[k].TAKMAAD) + ' dersinde ' + j + '.sorunun karşılığı ' + String.fromCharCode(65 + i) + ' kitapçığında ' + (KontrolList.indexOf($('#kar' + i + '-' + this.JSONSECILIDERS[k].id + '-' + j).val()) + 1) + '. soruda kullanılmış.');
                                return false;
                            }
                        }
                    }
                }
                return true;
            },
            getObjects(obj, key, val) {
                var objects = [];
                for (var i in obj) {
                    if (!obj.hasOwnProperty(i)) continue;
                    if (typeof obj[i] == 'object') {
                        objects = objects.concat(this.getObjects(obj[i], key, val));
                    } else if (i == key && obj[key] == val) {
                        objects.push(obj);
                    }
                }
                return objects;
            },
            SinavListele() {
                //window.location.replace('/anasayfa.html#Sinav/SinavListele?ID_SINAVTURU=' + this.ID_SINAVTURU + "&ID_KADEME3=" + this.ID_KADEME3);
                window.location.replace('/anasayfa.html#Sinav/SinavListele?ID_SINAV=' + this.ID_SINAV);
            },
            OptikTanimla(id) {
                window.location.replace('/anasayfa.html#Sinav/OptikTanimla?ID_SINAV=' + id);
            },
            DersAdiGuncelle(ID_SINAVDERS, AD) {
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_SINAVDERS: ID_SINAVDERS, TAKMAAD: AD };
                WebPost(this, "SinavTanimla", "DersAdiGuncelle", p, '', '', function (data, parent) {
                    if (data) {
                        Alert_Info("Kaydedildi");
                    }
                });
            },
            DosyaKaydet() {
                var guid = '';
                var dosyaadi = '';
                var _this = this;
                var dosya = document.getElementById('Dosya').files;
                dosyaadi = $("#Dosya").val().replace(/^.*[\\\/]/, '');
                if (dosya.length == 0) {
                    Alert_Info('Lütfen Dosya Seçiniz.');
                    return;
                }

                SinavTaslakYukle(dosya, function (response) {
                    $('.fileinput').fileinput("clear");
                    var json = JSON.parse(response);
                    _this.ID_SINAVTURU = $('select').find("option[data-subtext=" + json.TUR + "]").val();
                    _this.SINAVADI = json.AD;
                    _this.SINAVKODU = json.KOD;
                    _this.RAPORBASLIK = json.RAPORBASLIK;
                    _this.listID_SINAVTERCIHI = json.TERCIH.split(",");
                    _this.ID_KADEME3 = $('select option').filter(function () { return $(this).html() == json.GRUP; }).val();
                    _this.KITAPCIKSAYISI = json.KITAPCIK;
                    _this.YANLISSAYISI = json.YANLIS;
                    _this.TARIH = json.TARIH;
                    _this.OLCEKSINAVI = json.DERSPUANI == "EVET";

                    for (var i = 0; i < json.DERSLIST.length; i++) {
                        var node = $('#jstree_ders').jstree("get_node", json.DERSLIST[i].id);
                        if (!node.state.selected) {
                            $('#jstree_ders').jstree("select_node", node);
                        }
                    }

                    _this.DersEkle();

                    var cnt = 0;
                    var id = 0;

                    var List = [];
                    for (var i = 0; i < json.DERSLIST.length; i++) {
                        var idcount = _this.DersIDSay2(json.DERSLIST, json.DERSLIST[i].id);
                        if (idcount == 1 || List.indexOf(json.DERSLIST[i].id) == -1) {
                            _this.JSONSECILIDERS[i].TAKMAAD = json.DERSLIST[i].text;
                            _this.JSONSECILIDERS[i].SORUSAYISI = json.DERSLIST[i].SORUSAYISI;
                        } else {
                            var ders = _this.JSONSECILIDERS[_this.DersIndexBul(json.DERSLIST[i].id)];
                            var newders = _this.DersCogaltExcel(ders, json.DERSLIST[i].SIRA, json.DERSLIST[i].text, json.DERSLIST[i].SORUSAYISI);
                        }
                        List.push(json.DERSLIST[i].id);
                    }
                    //for (var i = 0; i < json.JSONDERS.length; i++) {
                    //    alert(json.JSONDERS[i].text);
                    //    var ders = _this.JSONSECILIDERS[_this.DersIndexBulTakmaAd(json.JSONDERS[i].text)];
                    //    doluitem = json.JSONDERS[i];
                    //    var SORULIST = doluitem.SORULIST;
                    //    ders.SIRA = doluitem.SIRA;
                    //    ders.ID_SINAVDERS = doluitem.id_sinavders;
                    //    ders.SORULIST = SORULIST;
                    //}
                    //for (var i = 0; i < _this.JSONSECILIDERS.length; i++) {
                    //    doluitem = json.DERSLIST[i];

                    for (var i = 0; i < json.DERSLIST.length; i++) {
                        var ders = _this.JSONSECILIDERS[_this.DersIndexBulTakmaAd(json.DERSLIST[i].text)];
                        doluitem = json.DERSLIST[i];
                        var SORULIST = doluitem.SORULIST;
                        ders.SIRA = json.DERSLIST[i].SIRA;
                        ders.ID_SINAVDERS = json.DERSLIST[i].id_sinavders;
                        ders.SORULIST = SORULIST;

                        for (var j = 0; j < SORULIST.length; j++) {
                            var index = -1;
                            var idders = 0;
                            if (ders.id.indexOf('_') > -1) {
                                idders = ders.id.substring(0, ders.id.indexOf('_'));
                            } else {
                                idders = ders.id;
                            }
                            _this.UniteAraExcel(idders, SORULIST[j], SORULIST[j].KOD);
                        }
                    }

                    $('#dersler').css("display", "block");
                });
            },
            DersCogaltExcel(ders, sira, takmaad, sorusayisi) {
                var newdersx = JSON.parse(JSON.stringify(ders));
                var id = '';
                if (ders.id.substring(0, ders.id.indexOf('_')).length > 0) {
                    id = ders.id.substring(0, ders.id.indexOf('_'));
                } else {
                    id = ders.id;
                }
                newdersx.id = id + '_' + this.DersIDSay(ders.id);
                newdersx.TAKMAAD = takmaad;
                newdersx.SORUSAYISI = sorusayisi;
                this.JSONSECILIDERS.splice(sira - 1, 0, newdersx);
                this.DersSorulariOlustur(newdersx);
                return newdersx;
            },
            DersCogalt(ders) {
                var index = this.DersIndexBul(ders.id);
                var newders = JSON.parse(JSON.stringify(ders));
                var id = ders.id.substring(0, ders.id.indexOf('_'));
                if (ders.id.substring(0, ders.id.indexOf('_')).length > 0) {
                    id = ders.id.substring(0, ders.id.indexOf('_'));
                } else {
                    id = ders.id;
                }
                newders.id = id + '_' + this.DersIDSay(ders.id);
                this.JSONSECILIDERS.splice(index + 1, 0, newders);
                this.DersSorulariOlustur(newders);
                return newders;
            },
            UniteAraExcel(ID_DERS, SORU, KOD) {
                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_DERS: ID_DERS, UNITEKOD: KOD };
                WebPost(this, "SinavTanimla", "UniteAra", p, '#dersler', '', function (data, parent) {
                    if (data != null) {
                        SORU.UNITE = data;
                    } else {
                        SORU.UNITE = 'Eşleşme bulunamadı!';
                    }
                    vue.$forceUpdate()
                });
            },
            OrnekExcelIndir() {
                window.open("Dosyalar/SinavTemplate/SINAVTASLAK.xlsx?v=002", "_blank")
            },
            CATaslakIndir() {
                var idSinavDersList = [];
                $.each(this.JSONSECILIDERS, function (j, el) {
                    idSinavDersList.push(el.ID_SINAVDERS);
                });
                if (idSinavDersList.length > 0) {
                    window.open('../Rapor.aspx?rapor=Sinav.SinavCevapAnahtariTaslak&raporTur=xlsx&p=' + session.TCKIMLIKNO + ';' + session.OTURUM + ';' + this.ID_SINAV + ';' + JSON.stringify(idSinavDersList), '_blank');//+ this.idsinavturu + ';'
                }
            },
            CATaslakYukle() {
                var guid = '';
                var dosyaadi = '';
                var _this = this;
                var dosya = document.getElementById('CADosya').files;
                dosyaadi = $("#CADosya").val().replace(/^.*[\\\/]/, '');
                if (dosya.length == 0) {
                    Alert_Info('Lütfen Dosya Seçiniz.');
                    return;
                }

                CevapAnahtariTaslakYukle(dosya, function (response) {
                    $('.fileinput').fileinput("clear");
                    var json = JSON.parse(response);

                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        ID_SINAV: vue.ID_SINAV,
                        SQLJSON: JSON.stringify(json)
                    };
                    WebPost(vue, "SinavTanimla", "CATaslakYukle", p, '', '', function (data, parent) {
                        console.log(data)
                        if (data) {
                            parent.Alert_Sinav("Kaydedildi", data);
                        } else {
                            Alert_Warning("Bir sorun oluştu. Daha sonra tekrar deneyiniz...");
                        }
                    }, 'RAISERROR');
                });
            },
        }
    });

    function SoruSecSB(ID_SORUBANKASI, UNITEKOD, UNITEAD, CEVAP, ID_SORUDUZEY, SORUGECMIS) {
        var _this = this;
        if (SORUGECMIS.length > 0) {
            Alert_Confirm("DİKKAT", "Bu soru şu sınavlarda kullanıldı: " + SORUGECMIS + "<br />Yine de kullanmak istiyor musunuz?", function () {
                vue.SECILISORU.ID_SORUBANKASI = ID_SORUBANKASI;
                vue.SECILISORU.KOD = UNITEKOD;
                vue.SECILISORU.UNITE = UNITEAD;
                vue.SECILISORU.ACEVAP = CEVAP == 1 ? 'A' : CEVAP == 2 ? 'B' : CEVAP == 3 ? 'C' : CEVAP == 4 ? 'D' : CEVAP == 5 ? 'E' : '';
                vue.SECILISORU.ID_BILISSELSUREC = ID_SORUDUZEY;
                $('#SoruBankasiModal').modal('hide');
            });
        } else {
            vue.SECILISORU.ID_SORUBANKASI = ID_SORUBANKASI;
            vue.SECILISORU.KOD = UNITEKOD;
            vue.SECILISORU.UNITE = UNITEAD;
            vue.SECILISORU.ACEVAP = CEVAP == 1 ? 'A' : CEVAP == 2 ? 'B' : CEVAP == 3 ? 'C' : CEVAP == 4 ? 'D' : CEVAP == 5 ? 'E' : '';
            vue.SECILISORU.ID_BILISSELSUREC = ID_SORUDUZEY;
            $('#SoruBankasiModal').modal('hide');
        }
    }




</script>
 
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>





