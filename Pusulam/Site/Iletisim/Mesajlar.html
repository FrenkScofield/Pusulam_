<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Mesajlarım  <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row chat" id="app">
    <div class="col-md-4 users">
        <div class="portlet light" style="padding:20px;">
            <!-- BEGIN PORTLET-->
            <div class="portlet-body" style="padding:0px;">
                <div class="input-icon" style="margin-bottom:10px;">
                    <i class="fa fa-search font-green"></i>
                    <input type="text" class="form-control" placeholder="Kişi Arama" style="background-color:#f2f3f7; border:none;" v-model="FILTERVALUE" @keyup="filter()">
                </div>
                <div id="chat-users" class="scrollable" style="overflow-y:auto; height:calc(75vh - 80px);">
                    <div class="classes dd-item" v-for="SINIF in SINIFLISTFILTERED">
                        <div class="dd-handle font-green" data-toggle="collapse" :data-target="'#SINIF' + SINIF.ID_SINIF">
                            <h4 style="display:inline-block; margin-top:10px;">{{SINIF.AD}} - ({{SINIF.KULLANICILISTE.length}} Kişi)</h4>
                            <i class='fa fa-chevron-down' style="float:right; margin:15px 4px;"></i>
                        </div>
                        <div :class="'message-users collapse' + (SINIFLISTFILTERED.length==1?' in':'')" :id="'SINIF' + SINIF.ID_SINIF">
                            <div class="message-user" v-for="KULLANICI in SINIF.KULLANICILISTE" @click="MesajGetir(KULLANICI, 20)">
                                <div class="message-user-image">
                                    <img src="../../img/okyanus_image.jpg" />
                                </div>
                                <div class="message-user-info">
                                    <div href="#"><b>{{KULLANICI.KIMEAD + ' ' + KULLANICI.KIMESOYAD}}</b></div>
                                    <div href="#" class="font-green">-> {{KULLANICI.KIMICINAD + ' ' + KULLANICI.KIMICINSOYAD}}</div>

                                    <div class="message-user-last" v-if="KULLANICI.SONMESAJ.length>0" :title="KULLANICI.SONMESAJ[0].AD">
                                        {{KULLANICI.SONMESAJ[0].AD}}
                                    </div>
                                </div>
                                <div class="message-user-info-right" v-if="KULLANICI.SONMESAJ.length>0">
                                    <span class="message-user-info-right-date">
                                        {{KULLANICI.SONMESAJ[0].KYE_TARIH}}
                                        <br />
                                        {{KULLANICI.SONMESAJ[0].KYE_SAAT}}
                                        <br />
                                        <span class="badge badge-success" v-if="KULLANICI.OKUNMAYANMESAJSAYISI>0"> {{KULLANICI.OKUNMAYANMESAJSAYISI}} </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <hr />
                    </div>
                </div>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>
    <div class="col-md-8 messages" v-show="DIVAC">
        <div class="portlet light" style="padding:20px;">
            <!-- BEGIN PORTLET-->
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase" v-if="KULLANICI!=undefined"> {{KULLANICI.KIMEAD + ' ' + KULLANICI.KIMESOYAD}} - <small>({{KULLANICI.KIMICINAD + ' ' + KULLANICI.KIMICINSOYAD}})</small> </span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools" style="color:#32c5d2!important; line-height:34px;">
                </div>
            </div>
            <div class="portlet-body" style="padding:0px;">
                <div id="chat-messages" class="scrollable" style="overflow-y:auto; height:calc(75vh - 145px);">
                    <div class="chat-messages">
                        <div class="chat-message" v-for="MESAJ in MESAJLISTE">
                            <div v-if="MESAJ.KIM[0].TCKIMLIKNO == TCKIMLIKNO">
                                <div class="chat-message-user-info chat-message-user-info-right">
                                    <b>{{MESAJ.KIM[0].AD + ' ' + MESAJ.KIM[0].SOYAD}}</b>
                                </div>
                                <div class="chat-message-message chat-message-message-right" :style="MESAJ.MESAJ[0].ID_MEDYATUR!=1&&MESAJ.MESAJ[0].ID_MEDYATUR!=4&&MESAJ.MESAJ[0].AD==''?'background-color:transparent;padding:0px;':''">
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==1">
                                        {{MESAJ.MESAJ[0].AD}}
                                    </span>
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==2">
                                        <img :src="'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID" @click="showContent('https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID)" style="cursor:pointer;" />
                                        <br />{{MESAJ.MESAJ[0].AD}}
                                    </span>
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==3">
                                        <video controls>
                                            <source :src="'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                        <br />{{MESAJ.MESAJ[0].AD}}
                                    </span>
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==4">
                                        <a :href="'https://docs.google.com/gview?embedded=true&url=https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID" target="_blank">Doküman Aç</a>
                                        <br />{{MESAJ.MESAJ[0].AD}}
                                    </span>
                                </div>
                                <div>
                                    <div class="chat-message-user-info chat-message-user-info-right">
                                        <small>{{MESAJ.MESAJ[0].KYE_TARIH}} - {{MESAJ.MESAJ[0].KYE_SAAT}}</small>
                                        <i v-if="MESAJ.MESAJ[0].OKUNDU" class="fa fa-check" style="color:#027bff"></i>
                                        <i v-else class="fa fa-check" style="color:#888"></i>
                                    </div>
                                </div>
                            </div>
                            <div v-else>
                                <div class="chat-message-user-info chat-message-user-info-left">
                                    <b>{{MESAJ.KIM[0].AD + ' ' + MESAJ.KIM[0].SOYAD}}</b>
                                </div>
                                <div class="chat-message-message chat-message-message-left" :style="MESAJ.MESAJ[0].ID_MEDYATUR!=1&&MESAJ.MESAJ[0].ID_MEDYATUR!=4&&MESAJ.MESAJ[0].AD==''?'background-color:transparent;padding:0px;':''">
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==1">
                                        {{MESAJ.MESAJ[0].AD}}
                                    </span>
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==2">
                                        <img :src="'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID" @click="showContent('https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID)" style="cursor:pointer;" />
                                        <br />{{MESAJ.MESAJ[0].AD}}
                                    </span>
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==3">
                                        <video controls>
                                            <source :src="'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                        <br />{{MESAJ.MESAJ[0].AD}}
                                    </span>
                                    <span v-if="MESAJ.MESAJ[0].ID_MEDYATUR==4">
                                        <a :href="'https://docs.google.com/gview?embedded=true&url=https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/' + MESAJ.MESAJ[0].GUID" target="_blank">Doküman Aç</a>
                                        <br />{{MESAJ.MESAJ[0].AD}}
                                    </span>
                                </div>
                                <div>
                                    <div class="chat-message-user-info chat-message-user-info-left">
                                        <small>{{MESAJ.MESAJ[0].KYE_TARIH}} - {{MESAJ.MESAJ[0].KYE_SAAT}}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="input-icon right">
                        <input type="file" name="..." id="dosya" data-preview-file-type="text" style="display:none;" @change="DosyaGonder">
                        <i class="fa fa-3x fa-send-o font-green" @click="MesajGonder" style="cursor:pointer; line-height:18px; margin-right:8px;"></i>
                        <i class="fa fa-3x fa-plus font-green" @click="DosyaSec" style="cursor:pointer; line-height:18px; margin-right:32px;"></i>
                        <input type="text" class="textarea form-control" id="mesaj" placeholder="Mesaj" style="background-color:#fff;" @keyup.enter="MesajGonder">
                    </div>
                </div>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>
    <div class="modal fade" id="contentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body" style="padding:0px;">
                    <i class="fa fa-3x fa-times-circle-o" data-dismiss="modal" style="position:absolute; top:25px; right:20px; color:crimson; cursor:pointer;"></i>
                    <img :src="IMAGEURL" style="width:100%" />
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var vueMesajlar = new Vue({
        el: "#app",
        name: "Mesajlar.html",

        data: {
            SINIFLIST: [],
            FILTERVALUE: '',
            SINIFLISTFILTERED: [],
            MESAJLISTE: [],
            KULLANICI: null,
            TCKIMLIKNO: session.TCKIMLIKNO,
            IMAGEURL: '',
            HEIGHT: 0,
            CONTROL: true,
            DIVAC: false
        },

        mounted() {
            var p = {
                TCKIMLIKNO: session.TCKIMLIKNO,
                OTURUM: session.OTURUM
            };

            WebPostLink(this, 'https://okyanusiletisim.okyanuskoleji.k12.tr/OkyanusApi/OgretmenMesaj/MesajListe', p, '', '', function (data) {
                vueMesajlar.SINIFLIST = data.MesajListeOgretmen;
                vueMesajlar.SINIFLISTFILTERED = data.MesajListeOgretmen;

                $('#chat-users').slimScroll({
                    height: 'calc(75vh - 80px)',
                    animate: false
                });

                if (vueanasayfa.OgretmenMesajKullanici != null) {
                    vueMesajlar.KULLANICI = JSON.parse(JSON.stringify(vueanasayfa.OgretmenMesajKullanici));
                    vueanasayfa.OgretmenMesajKullanici = null;
                    vueMesajlar.MesajKontrol();
                }
            });

            $('.scrollable').on('mousewheel DOMMouseScroll', function (e) {
                var e0 = e.originalEvent,
                    delta = e0.wheelDelta || -e0.detail;

                this.scrollTop += (delta < 0 ? 1 : -1) * 30;
                e.preventDefault();
            });
        },

        methods: {
            filter() {
                var SINIFLISTTEMP = JSON.parse(JSON.stringify(vueMesajlar.SINIFLIST));
                vueMesajlar.SINIFLISTFILTERED = SINIFLISTTEMP.filter(function (SINIF) {
                    var KULLANICILISTE = SINIF.KULLANICILISTE.filter(function (KULLANICI) {
                        return (KULLANICI.KIMEAD).toUpperCase().indexOf(vueMesajlar.FILTERVALUE.toUpperCase()) == 0
                            || (KULLANICI.KIMESOYAD).toUpperCase().indexOf(vueMesajlar.FILTERVALUE.toUpperCase()) == 0
                            || (KULLANICI.KIMICINAD).toUpperCase().indexOf(vueMesajlar.FILTERVALUE.toUpperCase()) == 0
                            || (KULLANICI.KIMICINSOYAD).toUpperCase().indexOf(vueMesajlar.FILTERVALUE.toUpperCase()) == 0;
                    });

                    if (KULLANICILISTE.length > 0) {
                        SINIF.KULLANICILISTE = KULLANICILISTE;
                        return SINIF;
                    }
                });
            },

            MesajKontrol() {
                //Yeni mesaj var ise MainPage.js den timer ile çağrılıyor.
                WebPostLink(this, 'https://okyanusiletisim.okyanuskoleji.k12.tr/OkyanusApi/OgretmenMesaj/MesajListe', { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM }, '-', '-', function (data) {
                    vueMesajlar.SINIFLIST = data.MesajListeOgretmen;
                    vueMesajlar.SINIFLISTFILTERED = data.MesajListeOgretmen;

                    $('#chat-users').slimScroll({
                        height: 'calc(75vh - 80px)',
                        animate: false
                    });
                    var users = getObjects(data.MesajListeOgretmen, 'ID_SINIF', 0);
                    if (users.length > 0) {
                        if (vueMesajlar.KULLANICI != null) {
                            vueMesajlar.MesajGetir(vueMesajlar.KULLANICI, 20);
                        }
                    }
                    //clearTimeout(vueanasayfa.OgretmenMesajListesiTimeOut);
                    //vueanasayfa.OgretmenMesajListesiTimeOut = setTimeout(function () { vueMesajlar.MesajKontrol() }, 30000);
                });
            },

            MesajGonder() {
                if ($('#mesaj').val() != '') {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        SQLJSON: { AD: $('#mesaj').val(), KULLANICILISTE: [{ TCKIMLIKNO_KIMICIN: vueMesajlar.KULLANICI.TCKIMLIKNO_KIMICIN, TCKIMLIKNO_KIME: vueMesajlar.KULLANICI.TCKIMLIKNO_KIME }] }
                    };

                    WebPostLink(this, 'https://okyanusiletisim.okyanuskoleji.k12.tr/OkyanusApi/OgretmenMesaj/BilgiNotEkle', p, '#chat-messages', '', function (data, parent) {
                        $('#mesaj').val('');
                        vueMesajlar.MesajGetir(vueMesajlar.KULLANICI, 20);
                    });
                }
            },

            MesajGetir(KULLANICI, MESAJSAYISI) {
                this.DIVAC = false;
                $('#chat-messages').slimScroll({ height: 'calc(75vh - 145px)' }).unbind('slimscroll');

                if (MESAJSAYISI == 20) {
                    vueMesajlar.MESAJLISTE = [];
                    vueMesajlar.HEIGHT = 0;
                    vueMesajlar.CONTROL = true;
                }

                vueMesajlar.KULLANICI = KULLANICI;

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    TCKIMLIKNO_KIME: KULLANICI.TCKIMLIKNO_KIME,
                    TCKIMLIKNO_KIMICIN: KULLANICI.TCKIMLIKNO_KIMICIN,
                    MESAJSAYISI: MESAJSAYISI
                };

                WebPostLink(this, 'https://okyanusiletisim.okyanuskoleji.k12.tr/OkyanusApi/OgretmenMesaj/MesajDetay', p, '#chat-messages', '', function (data, parent) {
                    var SON = false;
                    if (parent.MESAJLISTE.length == data.MesajDetay.length) {
                        SON = true;
                    }
                    parent.MESAJLISTE = data.MesajDetay;

                    parent.$nextTick(function () {
                        if (!SON) {
                            $('#chat-messages').slimScroll({ height: 'calc(75vh - 145px)' }).bind('slimscroll', function (e, pos) {
                                if (pos == 'top' && vueMesajlar.HEIGHT > 0 && vueMesajlar.CONTROL) {
                                    vueMesajlar.CONTROL = false;
                                    $('#chat-messages').slimScroll({ height: 'calc(75vh - 145px)' }).unbind('slimscroll');
                                    parent.MesajGetir(KULLANICI, MESAJSAYISI + 20);
                                }
                            });
                        }
                        vueMesajlar.DIVAC = true;
                        vueMesajlar.scrollTo();
                    });
                });
            },

            showContent(URL) {
                this.IMAGEURL = URL;
                vueMesajlar.$nextTick(function () {
                    $('#contentModal').modal();
                });
            },

            DosyaSec() {
                $('#dosya').click();
            },

            DosyaGonder(e) {
                var input = document.getElementById('dosya');
                if (input.files.length) {
                    App.blockUI({
                        target: '#app',
                        boxed: true,
                        message: 'Yükleniyor...'
                    });

                    if (e.target.files[0].type.indexOf('image') > -1) {
                        vueMesajlar.compress(e);
                    } else {
                        vueMesajlar.FormGonder(e.target.files[0]);
                    }
                } else {
                    alert('Please upload a file before continuing')
                }
            },

            resize(img) {
                var actualHeight = img.height
                var actualWidth = img.width
                let maxHeight = 900.0
                let maxWidth = 1600.0
                var imgRatio = actualWidth / actualHeight
                let maxRatio = maxWidth / maxHeight
                var compressionQuality = 0.5

                if (actualHeight > maxHeight || actualWidth > maxWidth) {
                    if (imgRatio < maxRatio) {
                        //adjust width according to maxHeight
                        imgRatio = maxHeight / actualHeight
                        actualWidth = imgRatio * actualWidth
                        actualHeight = maxHeight
                    } else if (imgRatio > maxRatio) {
                        //adjust height according to maxWidth
                        imgRatio = maxWidth / actualWidth
                        actualHeight = imgRatio * actualHeight
                        actualWidth = maxWidth
                    } else {
                        actualHeight = maxHeight
                        actualWidth = maxWidth
                        compressionQuality = 1
                    }
                }

                return { width: actualWidth, height: actualHeight }
            },

            compress(e) {
                const fileName = e.target.files[0].name;
                const reader = new FileReader();
                reader.readAsDataURL(e.target.files[0]);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        var size = vueMesajlar.resize(img);
                        const width = size.width;
                        const height = size.height;

                        const elem = document.createElement('canvas');

                        elem.width = width;
                        elem.height = height;
                        const ctx = elem.getContext('2d');
                        // img.width and img.height will contain the original dimensions
                        ctx.drawImage(img, 0, 0, width, height);
                        //toBlob polyfill
                        if (!HTMLCanvasElement.prototype.toBlob) {
                            Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
                                value: function (callback, type, quality) {
                                    var dataURL = this.toDataURL(type, quality).split(',')[1];
                                    setTimeout(function () {
                                        var binStr = atob(dataURL),
                                            len = binStr.length,
                                            arr = new Uint8Array(len);
                                        for (var i = 0; i < len; i++) {
                                            arr[i] = binStr.charCodeAt(i);
                                        }
                                        callback(new Blob([arr], { type: type || 'image/png' }));
                                    });
                                }
                            });
                        }

                        // toBlob usage
                        ctx.canvas.toBlob(function (blob) {
                            const file = new File([blob], fileName, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });

                            vueMesajlar.FormGonder(file);
                        }, 'image/jpeg', 0.85);
                    },
                        reader.onerror = error => console.log(error);
                };
            },

            FormGonder(file) {
                var formData = new FormData();
                formData.append("TCKIMLIKNO", session.TCKIMLIKNO);
                formData.append("OTURUM", session.OTURUM);
                formData.append("TCKIMLIKNO_KIME", vueMesajlar.KULLANICI.TCKIMLIKNO_KIME);
                formData.append("TCKIMLIKNO_KIMICIN", vueMesajlar.KULLANICI.TCKIMLIKNO_KIMICIN);
                formData.append("ID_MEDYATUR", file.type.indexOf('image') > -1 ? 2 : file.type.indexOf('video') > -1 ? 3 : 4);
                formData.append("AD", $('#mesaj').val());

                // HTML file input, chosen by user
                formData.append("file", file);

                $.ajax({
                    url: 'https://okyanusiletisim.okyanuskoleji.k12.tr/OkyanusApi/OgretmenMesaj/BilgiNotDokumanEkle',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST'
                }).done(function (result) {
                    App.unblockUI('#app');
                    vueMesajlar.MesajGetir(vueMesajlar.KULLANICI, 20);
                }).fail(function (a, b, c) {
                    App.unblockUI('#app');
                    vueMesajlar.MesajGetir(vueMesajlar.KULLANICI, 20);
                });
            },

            scrollTo() {
                vueMesajlar.$nextTick(function () {
                    if (vueMesajlar.HEIGHT != $('.chat-messages').height() && vueMesajlar.DIVAC) {
                        $('#chat-messages').slimScroll({
                            height: 'calc(75vh - 145px)',
                            scrollTo: ($('.chat-messages').height() - vueMesajlar.HEIGHT) + 'px',
                            animate: false
                        });

                        vueMesajlar.HEIGHT = $('.chat-messages').height() > 0 ? $('.chat-messages').height() : vueMesajlar.HEIGHT;
                        vueMesajlar.CONTROL = true;
                    }
                });
            }
        }
    });
</script>
<script src="Scripts/PublicMethods.js"></script>