<style>
    td {
        vertical-align: middle !important;
    }

    .row {
        margin-top: 10px !important;
    }
</style>
<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Zümre Çalışmaları - Onay İşlemleri <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">
    <div class="col-md-12">
        <div class="portlet box blue-hoki dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-list"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form collapse in" id="filters">
                <form role="form" style="padding:12px 20px">
                    <div class="row">
                        <c-donem :controller="CONTROLLER"
                                 @OnChange="DonemSelected" />
                    </div>
                    <div class="row">
                        <c-zumre-calisma :controller="CONTROLLER"
                                         :donem="DONEM"
                                         @OnChange="ZumreCalismaSelected" />
                    </div>
                    <div class="row">
                        <c-sube-multi :controller="CONTROLLER"
                                      @OnChange="SubeSelected">
                        </c-sube-multi>
                    </div>
                    <div class="row" style="margin-top:10px;">
                        <div class="col-md-12 text-right">
                            <button type="button" class="btn yellow" @click="OnayliExcel" style="margin-right:10px;">Onaylı Katılımcı Liste Excel</button>
                            <button type="button" class="btn green" @click="ListeGetir">Listele</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Onaysızlar </span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools" style="color:#32c5d2!important; line-height:34px;">
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form">
                <form role="form">
                    <table class="table table-striped table-bordered table-hover table-checkable" id="table_onaysiz" v-show="ONAYSIZLIST.length>0">
                        <thead>
                            <tr>
                                <th></th>
                                <th>TCNO</th>
                                <th>Ad Soyad</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </form>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>

    <div class="col-md-6">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Onaylılar </span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools" style="color:#32c5d2!important; line-height:34px;">
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form">
                <form role="form">
                    <table class="table table-striped table-bordered table-hover table-checkable" id="table_onayli" v-show="ONAYLILIST.length>0">
                        <thead>
                            <tr>
                                <th></th>
                                <th>TCNO</th>
                                <th>Ad Soyad</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </form>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>
</div>

<script src="VueComponents/Filtre.js"></script>
<script src="VueComponents/FiltreEk.js?v=001"></script>
<script src="VueComponents/ZumreCalisma/Filtreler.js"></script>
<script>
    var vue = new Vue({

        el: "#app",
        name: "KatilimciOnaylama.html",

        data: {
            CONTROLLER: 'ZumreCalismaKatilimciOnaylama',
            DONEM: '',
            ID_ZUMRECALISMA: 0,
            ID_SUBELIST: [],
            ONAYSIZLIST: [],
            ONAYLILIST: [],
            table_onaysiz: null,
            table_onayli: null
        },

        mounted() {
        },

        methods: {
            DonemSelected(item) {
                this.DONEM = item;
            },

            SubeSelected(item) {
                this.ID_SUBELIST = item;
            },

            ZumreCalismaSelected(item) {
                this.ID_ZUMRECALISMA = item;
            },

            ListeGetir() {
                if (this.ID_ZUMRECALISMA > 0 && this.ID_SUBELIST.length > 0) {
                    this.Onaysizlar();
                    this.Onaylilar();
                } else {
                    Alert_Warning("Zümre Çalışma ve Şube seçimi zorunludur!");
                }
            },

            Onaysizlar() {
                vue.ONAYSIZLIST = [];
                if (this.table_onaysiz != null) {
                    this.table_onaysiz.destroy();
                }

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_ZUMRECALISMA: this.ID_ZUMRECALISMA,
                    ID_SUBELIST: JSON.stringify(this.ID_SUBELIST),
                    ONAY: 0
                };

                this.table_onaysiz = $('#table_onaysiz').DataTable(
                    {
                        "processing": true,
                        "serverSide": true,
                        "order": [[2, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "visible": false,
                                "searchable": false,
                                "orderable": false
                            },
                            {
                                "targets": 3,
                                "visible": true,
                                "searchable": false,
                                "orderable": false
                            }
                        ],
                        "ajax": {
                            "url": "/" + this.CONTROLLER + "/ZumreCalismaOnayKatilimciListele",
                            "type": 'POST',
                            "data": function (d) {
                                vue.SEARCH = d.search.value;
                                vue.ORDERCOL = d.order[0].column;
                                vue.ORDERDIR = d.order[0].dir;
                                p.SQLJSON = JSON.stringify(d);
                                return p;
                            },
                            "dataFilter": function (data) {
                                var json = JSON.parse(JSON.parse(data));
                                json.data = JSON.parse(json.data);
                                vue.ONAYSIZLIST = json.data;
                                return JSON.stringify(json);
                            },
                        },
                        "autoWidth": false,
                        "columns": [
                            { "data": "RowNumber" },
                            { "data": "TCKIMLIKNO", "width": "60px" },
                            { "data": "ADSOYAD" },
                            {
                                "data": "ID_ZUMRECALISMAKATILIMCI",
                                "render": function (data, type, row, meta) {
                                    return type === 'display' && data != null ?
                                        "<a style='width:96px;' onclick='KatilimciOnay(" + data + ", true)' class='btn btn-sm green'> ONAYLA <i class='fa fa-plus'></i></a>" :
                                        data;
                                },
                                "width": "96px"
                            }
                        ],
                        language: {
                            "url": "./Utility/dil.json"
                        }
                    });
            },

            Onaylilar() {
                vue.ONAYLILIST = [];
                if (this.table_onayli != null) {
                    this.table_onayli.destroy();
                }

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_ZUMRECALISMA: this.ID_ZUMRECALISMA,
                    ID_SUBELIST: JSON.stringify(this.ID_SUBELIST),
                    ONAY: 1
                };

                this.table_onayli = $('#table_onayli').DataTable(
                    {
                        "processing": true,
                        "serverSide": true,
                        "order": [[2, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "visible": false,
                                "searchable": false,
                                "orderable": false
                            },
                            {
                                "targets": 3,
                                "visible": true,
                                "searchable": false,
                                "orderable": false
                            }
                        ],
                        "ajax": {
                            "url": "/" + this.CONTROLLER + "/ZumreCalismaOnayKatilimciListele",
                            "type": 'POST',
                            "data": function (d) {
                                vue.SEARCH = d.search.value;
                                vue.ORDERCOL = d.order[0].column;
                                vue.ORDERDIR = d.order[0].dir;
                                p.SQLJSON = JSON.stringify(d);
                                return p;
                            },
                            "dataFilter": function (data) {
                                var json = JSON.parse(JSON.parse(data));
                                json.data = JSON.parse(json.data);
                                vue.ONAYLILIST = json.data;
                                return JSON.stringify(json);
                            },
                        },
                        "autoWidth": false,
                        "columns": [
                            { "data": "RowNumber" },
                            { "data": "TCKIMLIKNO", "width": "60px" },
                            { "data": "ADSOYAD" },
                            {
                                "data": "ID_ZUMRECALISMAKATILIMCI",
                                "render": function (data, type, row, meta) {
                                    return type === 'display' && data != null ?
                                        "<a style='width:125px;' onclick='KatilimciOnay(" + data + ", false)' class='btn btn-sm red'> Onay Kaldır <i class='fa fa-trash'></i></a>" :
                                        data;
                                },
                                "width": "125px"
                            }
                        ],
                        language: {
                            "url": "./Utility/dil.json"
                        }
                    });
            },

            OnayliExcel() {
                if (this.ID_ZUMRECALISMA > 0) {
                    window.open("Rapor.aspx?raporTur=XLSX&rapor=ZumreCalisma.KatilimRapor&p="
                        + session.TCKIMLIKNO + ";"
                        + session.OTURUM + ";"
                        + this.ID_ZUMRECALISMA + ";"
                        + 1247);
                } else {
                    Alert_Warning("Zümre çalışma seçimi zorunludur!");
                }
            }
        }
    });

    function KatilimciOnay(ID, ONAY) {
        var p = {
            TCKIMLIKNO: session.TCKIMLIKNO,
            OTURUM: session.OTURUM,
            ID_ZUMRECALISMAKATILIMCI: ID,
            ONAY: ONAY
        };

        WebPost(vue, vue.CONTROLLER, "ZumreCalismaKatilimciOnay", p, '', '', function (data, parent) {
            if (data) {
                vue.ListeGetir();
            }
            else {
                Alert_Warning("Onaylama işlemi sırasında bir sorun oluştu! Daha sonra tekrar deneyiniz...");
            }
        });
    }
</script>
<script src="Scripts/PublicMethods.js"></script>
<script src="assets/global/plugins/icheck/icheck.min.js"></script>