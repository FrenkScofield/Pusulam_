<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />

<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Soru Listesi <small>Liste</small> <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">
    <div class="col-md-12">
        <div class="portlet box green-haze dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <div class="portlet-body form collapse in" id="filters">
                <div class="form-body form-horizontal">
                    <div class="row">
                        <c-upgrade-grup controller="SoruListele" @OnChange="GrupSelected">
                        </c-upgrade-grup>
                    </div>
                    <div class="row">
                        <c-kategori controller="SoruListele"
                                    @OnChange="KategoriSelected">
                        </c-kategori>
                    </div>
                    <div class="row">
                        <c-puan-araligi controller="SoruListele"
                                        :idtktkategori="ID_TKTKATEGORI"
                                        @OnChange="PuanAraligiSelected">
                        </c-puan-araligi>
                    </div>
                    <div class="row">
                        <div class="col-md-3 text-right" style="line-height:84px;">
                            Listeleme Türü
                        </div>
                        <div class="col-md-9">
                            <div class="form-group form-md-radios">
                                <div class="md-radio-list col-md-12">
                                    <div class="md-radio">
                                        <input type="radio" id="SECILEN" name="SECILEN" class="md-radiobtn" value="0" v-model="HANGITARIH">
                                        <label for="SECILEN">
                                            <span class="inc"></span>
                                            <span class="check"></span>
                                            <span class="box"></span> TÜMÜ
                                        </label>
                                    </div>
                                    <div class="md-radio" style="margin:0px;">
                                        <input type="radio" id="GIRILEN" name="GIRILEN" class="md-radiobtn" value="1" v-model="HANGITARIH">
                                        <label for="GIRILEN">
                                            <span></span>
                                            <span class="check"></span>
                                            <span class="box"></span> TARİHE GÖRE
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row" v-if="HANGITARIH==1">
                        <c-tarih-aralik-detayli>
                        </c-tarih-aralik-detayli>
                    </div>
                    <div class="row">
                        <div class="col-md-12 text-right">
                            <button type="button" class="btn green" @click="SoruListele">Listele</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-show="SORU_LISTESI.length>0">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Liste </span>
                    <span class="caption-helper"></span>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">
                        <div class="portlet-body">
                            <table class="table table-striped table-bordered table-hover" id="sample_1">
                                <thead>
                                    <tr>
                                        <th>KATEGORİ</th>
                                        <th>GRUP</th>
                                        <th>SEVİYE</th>
                                        <th>DÖNEM</th>
                                        <th>KAZANIM ADEDİ</th>
                                        <th>RESİM</th>
                                        <th>İŞLEMLER</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="odd gradeX" v-for="u in SORU_LISTESI">
                                        <td>{{u.KATEGORIAD}}</td>
                                        <td>{{u.GRUP}}</td>
                                        <td>{{u.SEVIYE}}</td>
                                        <td>{{u.DONEM}}</td>
                                        <td>{{u.KAZANIMADEDI}}</td>
                                        <td>
                                            <a class='mix-preview fancybox-button' @click='ResimGoster(u)' data-toggle='modal' href='#long'>
                                                <img :src='"https://pusulam.okyanuskoleji.k12.tr/Dosyalar/" + u.DOSYAAD+"."+u.DOSYAUZANTI' class='img-rounded' height="60" />
                                            </a>
                                        </td>
                                        <td>
                                            <a @click='SoruSil(u.ID_TKTSORU)' class='btn btn-sm red'> SİL <i class='fa fa-trash'></i></a>
                                            <a @click='SoruDuzenle(u.ID_TKTSORU, u.KAZANIMADEDI)' class='btn btn-sm green'> DÜZENLE <i class='fa fa-pencil'></i></a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <!-- END PORTLET-->
        </div>
    </div>

    <div id="edit" class="modal fade" tabindex="-1" data-replace="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">Resim</h4>
                </div>
                <div class="modal-body" valign="middle">
                    <span style="color: red;">Resim seçili ise resim güncellenir. Seçili değil ise eski resim ile kayıt edilir.</span>
                    <div class="row">
                        <div class="form-md-line-input">
                            <div>
                                <label class="control-label col-md-3" style="line-height:32px;">Soru Resmi </label>
                                <div class="col-md-9">
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="input-group" style="width:100%!important;">
                                            <div class="form-control uneditable-input input-fixed input-medium" data-trigger="fileinput" style="width:100%!important;">
                                                <i class="fa fa-file fileinput-exists"></i>&nbsp;
                                                <span class="fileinput-filename"> </span>
                                            </div>
                                            <span class="input-group-addon btn default btn-file">
                                                <span class="fileinput-new"> Resim Seç </span>
                                                <span class="fileinput-exists"> Değiştir </span>
                                                <input multiple="multiple" type="file" name="..." accept="image/*" id="Dosya">
                                            </span>
                                            <a href="javascript:;" class="input-group-addon btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="control-label col-md-3" style="line-height:32px;">Kazanım Adedi </label>
                                <div class="col-md-9">
                                    <input type="number" class="form-control" v-model="KAZANIMADEDI" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn dark btn-outline margin-right-10">Kapat</button>
                    <button type="button" class="btn btn-outline green" @click="Kaydet()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="long" class="modal fade" tabindex="-1" data-replace="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-body" align="center" valign="middle">
                <div class="row" style="margin-top:0px!important;">
                    <div class="col-md-12">
                        <img id="imgLong" class="form-control" style="max-height: calc(100vh - 150px); height:auto; width:100%;" text-align:" alt="" src="">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding-top:0px;">
                <button type="button" data-dismiss="modal" class="btn dark btn-outline">Kapat</button>
            </div>
        </div>
    </div>
</div>
<script src="VueComponents/SoruFiltreleri.js?v=3"></script>
<script>


    var tblSorular = null;

    var vue = new Vue({

        el: "#app",
        name: "SoruListesi.html",

        data: {
            ID_TKTYASARALIGI: 0,
            ID_TKTKATEGORI: 0,
            ID_TKTPUAN: 0,
            ID_SATISTURU: 0,
            SORU_LISTESI: [],
            id_tktsoru: 0,
            START: '',
            END: '',
            HANGITARIH: 0,
            KAZANIMADEDI: null
        },

        mounted() {
        },

        methods: {

            YasAraligiSelected(ID_TKTYASARALIGI) {
                this.ID_TKTYASARALIGI = ID_TKTYASARALIGI;
            },

            KategoriSelected(ID_TKTKATEGORI) {
                this.ID_TKTKATEGORI = ID_TKTKATEGORI;
            },

            PuanAraligiSelected(ID_TKTPUAN) {
                this.ID_TKTPUAN = ID_TKTPUAN;
            },

            GrupSelected(ID_SATISTURU) {
                this.ID_SATISTURU = ID_SATISTURU;
            },

            SoruListele() {
                $('#edit').modal('hide');
                this.SORU_LISTESI = [];
                if (tblSorular != null) {
                    tblSorular.rows().remove().draw();
                    tblSorular.destroy();
                }

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_TKTYASARALIGI: this.ID_TKTYASARALIGI,
                    ID_TKTKATEGORI: this.ID_TKTKATEGORI,
                    ID_TKTPUAN: this.ID_TKTPUAN,
                    ID_SATISTURU: this.ID_SATISTURU,
                    BASLANGIC: this.START,
                    BITIS: this.END,
                    HESAPTURU: this.HANGITARIH
                };

                WebPost(this, "SoruListele", "SoruListele", p, '#app', '', function (data, parent) {
                    if (data != null) {
                        $('#filters').collapse('hide');

                        parent.SORU_LISTESI = data;
                        //DOM update olmasını bekleyip update olunca listeyi oluşturuyor.

                        $("#sample_1").DataTable().destroy();
                        Vue.nextTick(function () {
                            parent.ListeOlustur();
                        })
                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                })

            },

            SoruSil(id_tktsoru) {
                Alert_Confirm("Emin misiniz?", "Soru Silinsin mi?", function () {
                    var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_TKTSORU: id_tktsoru };
                    WebPost(vue, "SoruListele", "SoruSil", p, '', '', function (data, parent) {
                        if (data == true) {
                            parent.SoruListele();
                        }
                    });

                });
            },

            ResimGoster(TktObject) {
                $("#imgLong").attr("src", "https://pusulam.okyanuskoleji.k12.tr/Dosyalar/" + TktObject.DOSYAAD + "." + TktObject.DOSYAUZANTI);
            },

            ListeOlustur() {
                tblSorular = $('#sample_1').DataTable(
                    {
                        "columnDefs": [{ "width": "25%", "targets": 0 }],
                        language: {
                            "url": "./Utility/dil.json"
                        }
                    });
            },

            SoruDuzenle(id_tktsoru, KAZANIMADEDI) {
                this.id_tktsoru = id_tktsoru;
                this.KAZANIMADEDI = KAZANIMADEDI;
                $('#edit').modal();
            },

            Kaydet() {
                var resimler = document.getElementById('Dosya').files;
                if (resimler.length == 0) {
                    //Alert_Info('Lütfen Resim Seçiniz.');
                    //return;
                } else {
                    var x = document.getElementById("Dosya");
                    var file = x.files[0];
                    DosyaYukle(file, this.id_tktsoru, 'TktSoru', function (sonuc) {
                        vue.SoruListele();
                    });
                }

                var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_TKTSORU: this.id_tktsoru, KAZANIMADEDI: this.KAZANIMADEDI };
                WebPost(vue, "SoruListele", "SoruGuncelle", p, '', '', function (data, parent) {
                    if (data == true) {
                        parent.SoruListele();
                    }
                });
                
            }
        }
    });

</script>

<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
<script src="Scripts/PublicMethods.js"></script>