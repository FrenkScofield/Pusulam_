<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1>
            Etkinlik Kağıdı <small></small> <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">
    <!--<div class="col-md-12" v-if="TCKIMLIKNO != '56545519606'">Sayfa güncelleniyor. Daha sonra tekrar deneyiniz.</div>
    <div v-else>-->
    <div>
        <div class="col-md-12">
            <div class="portlet box green-haze dd-item" style="border:none">
                <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                    <div class="caption">
                        <i class="icon-magnifier"></i>
                        <span class="caption-subject bold uppercase"> Filtreler </span>
                        <span class="caption-helper"></span>
                    </div>
                    <div class='actions'>
                        <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                            <i class='fa fa-chevron-down'></i>
                        </a>
                    </div>
                </div>
                <div class="portlet-body form collapse in" id="filters">
                    <div class="form-body form-horizontal">
                        <div class="row">
                            <c-sube controller="SinavKagidiOlustur"
                                    @OnChange="SubeSelected">
                            </c-sube>
                        </div>
                        <div class="row">
                            <c-sinavgrup controller="SinavKagidiOlustur"
                                         :idsube="ID_SUBE"
                                         @OnChange="SinavGrupSelected">
                            </c-sinavgrup>
                        </div>
                        <div class="row">
                            <c-donem controller="SinavKagidiOlustur"
                                     @OnChange="DonemSelected">
                            </c-donem>
                        </div>
                        <div class="row">
                            <c-sinif-multi-id_subes-donem controller="SinavKagidiOlustur"
                                                          :idsube="ID_SUBES"
                                                          :idsinavgrup="ID_SINAVGRUPS"
                                                          :donem="DONEM"
                                                          @OnChange="SinifSelected">
                            </c-sinif-multi-id_subes-donem>
                        </div>
                        <div class="row">
                            <c-sinav-listesi controller="SinavKagidiOlustur"
                                             @OnChange="SinavSelected">
                            </c-sinav-listesi>
                        </div>
                        <div class="row">
                            <c-tkttest-listesi controller="SinavKagidiOlustur"
                                               ortalama="true"
                                               @OnChange="TestSelected">
                            </c-tkttest-listesi>
                        </div>
                        <div class="row">
                            <c-sinav-listesi-multi v-if="ID_TKTTEST == 4"
                                                   controller="SinavKagidiOlustur"
                                                   :idtktsinav="ID_TKTSINAV"
                                                   @OnChange="OrtalamaSinavSelected">
                            </c-sinav-listesi-multi>
                        </div>
                        <!--<div class="row" v-if="ID_SINAVGRUP != 4 && ID_SINAVGRUP != 5">
                    <c-tarih controller="SinavKagidiOlustur"
                             @change-date="TarihSelected">
                    </c-tarih>
                </div>-->
                        <!--<div class="row" v-if="ID_SINAVGRUP != 4 && ID_SINAVGRUP != 5">
                    <div class="col-md-3 text-right" style="line-height:84px;">
                        Hesap Türü
                    </div>
                    <div class="col-md-9">
                        <div class="form-group form-md-radios">
                            <div class="md-radio-list col-md-12">
                                <div class="md-radio">
                                    <input type="radio" id="SECILEN" name="SECILEN" class="md-radiobtn" value="1" v-model="HANGITARIH">
                                    <label for="SECILEN">
                                        <span class="inc"></span>
                                        <span class="check"></span>
                                        <span class="box"></span> SEÇİLEN TARİHE GÖRE
                                    </label>
                                </div>
                                <div class="md-radio" style="margin:0px;">
                                    <input type="radio" id="GIRILEN" name="GIRILEN" class="md-radiobtn" value="0" v-model="HANGITARIH">
                                    <label for="GIRILEN">
                                        <span></span>
                                        <span class="check"></span>
                                        <span class="box"></span> CEVAP GİRİŞ TARİHİNE GÖRE
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>-->
                        <div class="row">
                            <div class="col-md-3 text-right" style="line-height:84px;">
                                Soru Seçim Türü
                            </div>
                            <div class="col-md-9">
                                <div class="form-group form-md-radios">
                                    <div class="md-radio-list col-md-12">
                                        <div class="md-radio">
                                            <input type="radio" id="HANGITARIHSORU0" name="HANGITARIHSORU0" class="md-radiobtn" value="0" v-model="HANGITARIHSORU">
                                            <label for="HANGITARIHSORU0">
                                                <span class="inc"></span>
                                                <span class="check"></span>
                                                <span class="box"></span> TÜMÜ
                                            </label>
                                        </div>
                                        <div class="md-radio" style="margin:0px;">
                                            <input type="radio" id="HANGITARIHSORU1" name="HANGITARIHSORU1" class="md-radiobtn" value="1" v-model="HANGITARIHSORU">
                                            <label for="HANGITARIHSORU1">
                                                <span></span>
                                                <span class="check"></span>
                                                <span class="box"></span> TARİHE GÖRE
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" v-if="HANGITARIHSORU==1">
                            <c-tarih-aralik-detayli>
                            </c-tarih-aralik-detayli>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="text-right">
                                    <button type="button" class="btn green" @click="OgrenciListele">Öğrenci Listele</button>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:10px;">
                                <div class="text-right">
                                    <button type="button" class="btn blue" @click="TopluSinavKagidiOlustur">Toplu Sınav Kağıdı Oluştur</button>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:10px;">
                                <div class="text-right">
                                    <button type="button" class="btn red" @click="SinavKagidiSilToplu">Toplu Sınav Kağıdı Sil</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-danger">
                Toplu oluşturma işlemleri için oluşturma tamamlandıktan sonra öğrenci listesini kontrol ediniz.
                Eğer etkinlik kağıdı oluşturulmayan öğrenci var ise Tkt ön test bilgisinin girilmiş olduğundan ve öğrencinin seviyesine uygun soruların sistemde mevcut olduğundan emin olunuz!
            </div>
        </div>

        <div class="col-md-12" v-show="OGRENCI_LISTESI.length>0">
            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="icon-list font-green"></i>
                        <span class="caption-subject bold font-green uppercase"> Öğrenci Listesi </span>
                        <span class="caption-helper"></span>
                    </div>
                </div>
                <!-- BEGIN PORTLET-->
                <div class="portlet-body form">
                    <form role="form">
                        <div class="portlet light bordered">
                            <div class="portlet-body">
                                <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1">
                                    <thead>
                                        <tr>
                                            <th>SINIF</th>
                                            <th>TcKimlikNo</th>
                                            <th>Ad</th>
                                            <th>Soyad</th>
                                            <th>Doğum Tarihi</th>
                                            <th>Ay</th>
                                            <th>Durum</th>
                                            <th>Oluşturma Şekli</th>
                                            <th>Soru Sayısı</th>
                                            <th>Oluşturan</th>
                                            <th>İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="odd gradeX" v-for="u in OGRENCI_LISTESI">
                                            <td>{{u.SINIF}}</td>
                                            <td>{{u.TCKIMLIKNO}}</td>
                                            <td>{{u.AD}}</td>
                                            <td>{{u.SOYAD}}</td>
                                            <td>{{u.DOGUMTARIHI}}</td>
                                            <td>{{u.YASAY}}</td>
                                            <td v-if="u.PUANGIRISI==0"><i class='fa fa-circle-o'></i></td>
                                            <td v-else-if="u.PUANGIRISI>0"><i class='fa fa-check'></i></td>
                                            <td v-html="u.OLUSTURMASEKLI"></td>
                                            <td v-if="u.SORUSAYISI<10" style="color:red;">{{u.SORUSAYISI}}</td>
                                            <td v-else>{{u.SORUSAYISI}}</td>
                                            <td>{{u.KYE_ADSOYAD}}<br />{{u.TARIH}}</td>

                                            <td v-if="u.DOGUMTARIHI===null">Doğum Tarihi Girilmemiş</td>
                                            <td v-else-if="u.PUANGIRISI==0">Puan Girilmemiş</td>
                                            <td v-else>
                                                <a class='btn btn-sm green' @click='SinavKagidiOlustur(u)'>Oluştur</a>
                                                <a class='btn btn-sm red' @click='SinavKagidiSil(u)' v-if="u.TARIH!=null">Sil</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- END PORTLET-->
            </div>
        </div>
    </div>
</div>

<script src="VueComponents/SoruFiltreleri.js?v=4"></script>
<script src="VueComponents/SubeGrupSinif.js?v=3"></script>
<script>

    var tblOgrenciler = null;
    var vue = new Vue({

        el: "#app",
        name: "SinavKagidiOlustur.html",

        data: {
            TCKIMLIKNO: '',
            DONEM: '',
            ID_SUBE: 0,
            ID_SINAVGRUP: 0,
            ID_SUBES: [],
            ID_SINAVGRUPS: [],
            ID_SINIF: [],
            OGRENCI_LISTESI: [],
            ID_TKTSINAV: 0,
            ID_TKTSINAVORTALAMALIST: [],
            KATEGORIPUAN_LISTESI: [],
            SECILI_OGRENCI: null,
            ID_TKTTEST: 0,
            TARIH: '',
            HANGITARIH: 0,
            START: '',
            END: '',
            HANGITARIHSORU: 0
        },

        mounted() {
            this.TCKIMLIKNO = session.TCKIMLIKNO;
            //$("#sample_1").DataTable().destroy();
            //Vue.nextTick(function () {
            //    vue.ListeOlustur();
            //});
        },

        methods: {
            TarihSelected(TARIH) {
                this.TARIH = TARIH;
            },

            DonemSelected(DONEM) {
                this.DONEM = DONEM;
            },

            SubeSelected(ID_SUBE) {
                this.ID_SUBE = ID_SUBE;
                this.ID_SUBES = [];
                this.ID_SUBES.push(ID_SUBE);
            },

            SinavGrupSelected(ID_SINAVGRUP) {
                this.ID_SINAVGRUP = ID_SINAVGRUP;
                this.ID_SINAVGRUPS = [];
                this.ID_SINAVGRUPS.push(ID_SINAVGRUP);
            },

            SinifSelected(ID_SINIF) {
                this.ID_SINIF = ID_SINIF;
            },

            TestSelected(ID_TKTTEST) {
                this.ID_TKTTEST = ID_TKTTEST;
            },

            SinavSelected(ID_TKTSINAV) {
                this.ID_TKTSINAV = ID_TKTSINAV;
            },

            OrtalamaSinavSelected(ID_TKTSINAVORTALAMALIST) {
                this.ID_TKTSINAVORTALAMALIST = ID_TKTSINAVORTALAMALIST;
            },

            OgrenciListele() {
                if (this.ID_SUBE == 0) {
                    Alert_Warning("Lütfen Şube Seçin.");
                    return;
                }
                if (this.ID_TKTSINAV == 0) {
                    Alert_Warning("Lütfen Sınav Seçin.");
                    return;
                }
                this.OGRENCI_LISTESI = [];
                if (tblOgrenciler != null) {
                    tblOgrenciler.rows().remove().draw();
                    tblOgrenciler.destroy();
                }

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    DONEM: this.DONEM,
                    ID_SUBE: this.ID_SUBE,
                    ID_SINAVGRUP: this.ID_SINAVGRUP,
                    ID_SINIFS: JSON.stringify(this.ID_SINIF),
                    ID_TKTSINAV: this.ID_TKTSINAV,
                    ID_TKTTEST: this.ID_TKTTEST
                };

                WebPost(this, "SinavKagidiOlustur", "UpgradeOgrenciListele", p, '', '', function (data, parent) {
                    if (data != null) {
                        $('#filters').collapse('hide');
                        parent.OGRENCI_LISTESI = data;
                        //DOM update olmasını bekleyip update olunca listeyi oluşturuyor.
                        $("#sample_1").DataTable().destroy();
                        Vue.nextTick(function () {
                            parent.ListeOlustur();
                        })
                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                })
            },

            ListeOlustur() {
                tblOgrenciler = $('#sample_1').DataTable(
                    {
                        language: {
                            "url": "./Utility/dil.json"
                        }
                    });
            },

            SinavKagidiOlustur(Ogrenci) {
                window.open("SinavKagidi.aspx?raporTur=PDF&rapor=Upgrade.SinavKagidi&p="
                    + session.TCKIMLIKNO + ";"
                    + session.OTURUM + ";"
                    + this.ID_TKTSINAV + ";"
                    + JSON.stringify(this.ID_TKTSINAVORTALAMALIST) + ";"
                    + Ogrenci.TCKIMLIKNO + ";"
                    + this.ID_SUBE + ";"
                    + this.ID_SINAVGRUP + ";"
                    + JSON.stringify(this.ID_SINIF) + ";"
                    + this.ID_TKTTEST + ";"
                    + this.DONEM + ";"
                    + this.TARIH + ";"
                    + this.HANGITARIH + ";"
                    + this.START + ";"
                    + this.END + ";"
                    + this.HANGITARIHSORU);
                vue.OgrenciListele();

            },

            SinavKagidiSil(Ogrenci) {
              
                Alert_Confirm("Emin misiniz?", "Seçilen öğrenci için seçilen etkinlik kağıdı bilgisi silinecek.", function () {
                    var p = {
                        TCKIMLIKNO: session.TCKIMLIKNO,
                        OTURUM: session.OTURUM,
                        TCKIMLIKNO_OGR: Ogrenci.TCKIMLIKNO,
                        ID_TKTSINAV: vue.ID_TKTSINAV,
                        //ID_SINAVGRUP: vue.ID_SINAVGRUP
                        DONEM: vue.DONEM,
                        TARIH: new Date().toLocaleString(),
                       TUR:"Silindi"
                    };

                    WebPost(vue, 'SinavKagidiOlustur', 'SinavKagidiSil', p, '', '', function (data, parent) {
                        if (data) {
                            Alert_Info("Sınav Kağıdı Silindi.");
                            vue.OgrenciListele();
                        } else {
                            Alert_Warning("Bir hata oluştu!");
                        }
                    });
                });
            },

            TopluSinavKagidiOlustur() {                               
                if (this.ID_SUBE == 0) Alert_Warning("Lütfen Şube Seçin.");
                else if (this.ID_TKTSINAV == 0) Alert_Warning("Lütfen Sınav Seçin.");
                else window.open("SinavKagidi.aspx?raporTur=PDF&rapor=Upgrade.SinavKagidi&p="
                    + session.TCKIMLIKNO + ";"
                    + session.OTURUM + ";"
                    + this.ID_TKTSINAV + ";"
                    + JSON.stringify(this.ID_TKTSINAVORTALAMALIST) + ";0;"
                    + this.ID_SUBE + ";"
                    + this.ID_SINAVGRUP + ";"
                    + JSON.stringify(this.ID_SINIF) + ";"
                    + this.ID_TKTTEST + ";"
                    + this.DONEM + ";"
                    + this.TARIH + ";"
                    + this.HANGITARIH + ";"
                    + this.START + ";"
                    + this.END + ";"
                    + this.HANGITARIHSORU);
            },

            SinavKagidiSilToplu() {                
                if (this.ID_SUBE == 0) Alert_Warning("Lütfen Şube Seçin.");
                else if (this.ID_TKTSINAV == 0) Alert_Warning("Lütfen Sınav Seçin.");
                else
                    Alert_Confirm("Emin misiniz?", "Seçilen kriterlere uygun öğrenciler için seçilen etkinlik kağıdı bilgisi silinecek.", function () {
                        var p = {
                            TCKIMLIKNO: session.TCKIMLIKNO,
                            OTURUM: session.OTURUM,
                            ID_SUBE: vue.ID_SUBE,
                            ID_SINIFS: JSON.stringify(vue.ID_SINIF),
                            ID_TKTSINAV: vue.ID_TKTSINAV,
                            //ID_SINAVGRUP: vue.ID_SINAVGRUP
                            DONEM: vue.DONEM,
                            TARIH: new Date().toLocaleString(),
                            TUR: "Toplu Silindi"
                        };

                        WebPost(vue, 'SinavKagidiOlustur', 'SinavKagidiSilToplu', p, '', '', function (data, parent) {
                            if (data) {
                                Alert_Info("Sınav Kağıdı Silindi.");
                                vue.OgrenciListele();
                            } else {
                                Alert_Warning("Bir hata oluştu!");
                            }
                        });
                    });
            },
        }
    });

</script>


<script src="Scripts/PublicMethods.js"></script>
