<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />

<div class="page-head">
    <!-- BEGIN PAGE TITLE -->
    <div class="page-title col-md-12">
        <h1 style="line-height:24px; vertical-align:middle;">
            Soru Tanımla <small>Resim Ekle</small>  <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
    <!-- END PAGE TITLE -->
</div>

<div class="row" id="app">
    <div class="col-md-12">
        <div class="portlet box green-haze dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <div class="portlet-body form collapse in" id="filters">
                <div class="form-body form-horizontal">
                    <div class="row">
                        <c-upgrade-grup controller="SoruEkle" @OnChange="GrupSelected">
                        </c-upgrade-grup>
                    </div>
                    <div class="row">
                        <c-kategori controller="SoruEkle"
                                    @OnChange="KategoriSelected">
                        </c-kategori>
                    </div>
                    <div class="row">
                        <c-puan-araligi controller="SoruEkle"
                                        :idtktkategori="ID_TKTKATEGORI"
                                        @OnChange="PuanAraligiSelected">
                        </c-puan-araligi>
                    </div>
                    <div class="row">
                        <c-tkt-donem controller="SoruEkle"
                                     @OnChange="DonemSelected">
                        </c-tkt-donem>
                    </div>
                    <div class="row">
                        <label class="control-label col-md-3">Kazanım Adedi </label>
                        <div class="col-md-9">
                            <input type="number" class="form-control" v-model="KAZANIMADEDI" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-md-line-input">
                            <label class="control-label col-md-3">Soru Resmi </label>
                            <div class="col-md-9">
                                <div class="fileinput fileinput-new" data-provides="fileinput">
                                    <div class="input-group" style="width:100%!important;">
                                        <div class="form-control uneditable-input input-fixed input-medium" data-trigger="fileinput" style="width:100%!important;">
                                            <i class="fa fa-file fileinput-exists"></i>&nbsp;
                                            <span class="fileinput-filename"> </span>
                                        </div>
                                        <span class="input-group-addon btn default btn-file">
                                            <span class="fileinput-new"> Resim Seç </span>
                                            <span class="fileinput-exists"> Değiştir </span>
                                            <input multiple="multiple" type="file" name="..." accept="image/*" id="Dosya">
                                        </span>
                                        <a href="javascript:;" class="input-group-addon btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-12 text-right">
                            <button type="button" class="btn green" @click="SoruListele">Listele</button>
                            <button type="button" class="btn green" @click="Kaydet">Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-show="SORU_LISTESI.length>0">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Liste </span>
                    <span class="caption-helper"></span>
                </div>
            </div>
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">

                        <div class="portlet-body">
                            <table class="table table-striped table-bordered table-hover table-checkable order-column" id="sample_1">
                                <thead>
                                    <tr>
                                        <th>Kategori</th>
                                        <th>GRUP</th>
                                        <th>SEVİYE</th>
                                        <th>DÖNEM</th>
                                        <th>KAZANIM ADEDİ</th>
                                        <th>EKLENME TARİHİ</th>
                                        <th>RESİM</th>
                                        <th>İŞLEMLER</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="odd gradeX" v-for="u in SORU_LISTESI">
                                        <td>{{u.KATEGORIAD}}</td>
                                        <td>{{u.GRUP}}</td>
                                        <td>{{u.SEVIYE}}</td>
                                        <td>{{u.DONEM}}</td>
                                        <td>{{u.KAZANIMADEDI}}</td>
                                        <td>{{u.KYE_TARIH}}</td>
                                        <td>
                                            <a class='mix-preview fancybox-button' @click='ResimGoster(u)' data-toggle='modal' href='#long'>
                                                <img :src='"https://pusulam.okyanuskoleji.k12.tr/Dosyalar/" + u.DOSYAAD+"."+u.DOSYAUZANTI' class='img-rounded' height="60" />
                                            </a>
                                        </td>
                                        <td><a @click='SoruSil(u.ID_TKTSORU)' class='btn btn-sm red'> SİL <i class='fa fa-trash'></i></a></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="long" class="modal fade" tabindex="-1" data-replace="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-body" align="center" valign="middle">
                <div class="row" style="margin-top:0px!important;">
                    <div class="col-md-12">
                        <img id="imgLong" class="form-control" style="max-height: calc(100vh - 150px); height:auto; width:100%;" text-align:" alt="" src="">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding-top:0px;">
                <button type="button" data-dismiss="modal" class="btn dark btn-outline">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script src="VueComponents/SoruFiltreleri.js?v=3"></script>
<script>
    var idTktPuan = null;
    var vue = new Vue({
        el: "#app",
        name: "SoruTanimla.html",

        data: {
            ID_TKTYASARALIGI: 0,
            ID_TKTKATEGORI: 0,
            ID_TKTPUAN: 0,
            ID_TKTDONEM: [],
            SORU_LISTESI: [],
            ID_SATISTURU: 0,
            tblSorular: null,
            KAZANIMADEDI: null
        },

        mounted() {
        },

        methods: {
            YasAraligiSelected(ID_TKTYASARALIGI) {
                this.ID_TKTYASARALIGI = ID_TKTYASARALIGI;
            },

            KategoriSelected(ID_TKTKATEGORI) {
                this.ID_TKTKATEGORI = ID_TKTKATEGORI;
            },

            PuanAraligiSelected(ID_TKTPUAN) {
                this.ID_TKTPUAN = ID_TKTPUAN;
                idTktPuan = ID_TKTPUAN;
            },

            DonemSelected(ID_TKTDONEM) {
                this.ID_TKTDONEM = ID_TKTDONEM;
            },

            GrupSelected(ID_SATISTURU) {
                this.ID_SATISTURU = ID_SATISTURU;
            },

            Kaydet() {
                if (this.KAZANIMADEDI == null || this.KAZANIMADEDI<=0) {
                    Alert_Info('Lütfen Kazanım Adedi Seçiniz.');
                    return;
                }
                var resimler = document.getElementById('Dosya').files;
                if (resimler.length == 0) {
                    Alert_Info('Lütfen Resim Seçiniz.');
                    return;
                }
                else if (this.ID_TKTPUAN == 0) {
                    Alert_Info('Lütfen Puan Aralığı Seçiniz.');
                    return;
                }
                else {
                    var _this = this;

                    var idDonem = '';
                    $.each(_this.ID_TKTDONEM, function (i) {
                        idDonem += this + ',';
                    });

                    var x = document.getElementById("Dosya");
                    var txt = "";
                    var count = 0;
                    if ('files' in x) {
                        for (var i = 0; i < x.files.length; i++) {
                            var file = x.files[i];
                            var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_TKTPUAN: _this.ID_TKTPUAN, ID_TKTDONEMS: idDonem, ID_SATISTURU: this.ID_SATISTURU, KAZANIMADEDI: vue.KAZANIMADEDI };
                            SqlWebActionSync("POST", "SoruEkle", "SoruEkle", JSON.stringify(p), '', '', function (data) {
                                if (data > 0) {
                                    DosyaYukle(file, data, 'TktSoru', function (sonuc) {
                                        count++;
                                        if (sonuc && count == x.files.length) {
                                            Alert_Info("Kaydedildi!");
                                            vue.SoruListele();
                                        }
                                    });
                                }
                                else {
                                    Alert_Warning("Kaydedilirken Sorun Oluştu!");
                                }
                            })
                        }
                    }
                }
            },

            SoruListele() {
                vue.SORU_LISTESI = [];

                var idDonem = '';
                $.each(vue.ID_TKTDONEM, function (i) {
                    idDonem += this + ',';
                });

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_TKTKATEGORI: this.ID_TKTKATEGORI,
                    ID_TKTPUAN: this.ID_TKTPUAN,
                    ID_SATISTURU: this.ID_SATISTURU,
                    ID_TKTDONEMS: idDonem
                };

                WebPost(vue, "SoruEkle", "SoruListelebyDonem", p, '#app', '', function (data, parent) {
                    if (data != null) {
                        $('#filters').collapse('hide');
                        parent.SORU_LISTESI = data;

                        $("#sample_1").DataTable().destroy();
                        $('#sample_1 tbody').empty();
                        Vue.nextTick(function () {
                            $('#sample_1').DataTable(
                                {
                                    "order": [[3, 'desc']],
                                    "columnDefs": [{ "width": "25%", "targets": 0 }],
                                    language: { "url": "./Utility/dil.json" }
                                });
                        })
                    }
                    else {
                        Alert_Warning("Liste Bulunamadı!");
                    }
                })

            },

            ResimGoster(TktObject) {
                $("#imgLong").attr("src", "https://pusulam.okyanuskoleji.k12.tr/Dosyalar/" + TktObject.DOSYAAD + "." + TktObject.DOSYAUZANTI);
            },

            SoruSil(id_tktsoru) {
                Alert_Confirm("Emin misiniz?", "Soru Silinsin mi?", function () {
                    var p = { TCKIMLIKNO: session.TCKIMLIKNO, OTURUM: session.OTURUM, ID_TKTSORU: id_tktsoru };
                    WebPost(vue, "SoruEkle", "SoruSil", p, '', '', function (data, parent) {
                        if (data == true) {
                            parent.SoruListele();
                        }
                    });

                });
            }
        }

    });
</script>

<script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
<script src="Scripts/PublicMethods.js"></script>