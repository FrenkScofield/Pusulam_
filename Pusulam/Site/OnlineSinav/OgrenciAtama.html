<link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<link href="assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet" type="text/css" />
<div class="page-head">
    <div class="page-title col-md-12">
        <h1>
            Öğrenci Listesi <span onclick="YardimGoster(ID_MENU);" class="pull-right" style="cursor:pointer;"><img src="assets/global/img/info.gif" class="info-image-icon" /> </span>
        </h1>
    </div>
</div>

<div class="row" id="app">
    <div class="col-md-12">
        <div class="portlet box blue-hoki dd-item" style="border:none">
            <div class="portlet-title dd-handle" data-toggle='collapse' data-target='#filters' style="cursor:pointer;">
                <div class="caption">
                    <i class="icon-magnifier"></i>
                    <span class="caption-subject bold uppercase"> Filtreler </span>
                    <span class="caption-helper"></span>
                </div>
                <div class='actions'>
                    <a href='javascript:;' class='btn btn-default btn-sm' style='border:none;'>
                        <i class='fa fa-chevron-down'></i>
                    </a>
                </div>
            </div>
            <!-- BEGIN PORTLET-->
            <div class="portlet-body form collapse in" id="filters">
                <form role="form" style="padding:12px 20px">
                    <div class="row">
                        <label class="control-label col-md-3" style="vertical-align:middle;">Dış Öğrenci</label>
                        <div class="col-md-9" style="height:34px; vertical-align:middle;">
                            <div class="md-checkbox" style="margin:auto!important; width:20px!important; height:20px; margin:0px; margin-top:6px; display:block;">
                                <input type="checkbox" v-model="disOgrenciEkle" id="disOgrenciEkle" class="md-check" v-bind:true-value="true" v-bind:false-value="false" v-on:click="disOgrenciChanged()" />
                                <label for="disOgrenciEkle">
                                    <span></span>
                                    <span class="check"></span>
                                    <span class="box"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <c-donem :controller="controller"
                                 @OnChange="DonemSelected">
                        </c-donem>
                    </div>
                    <div class="row" v-if="!disOgrenciEkle">
                        <c-sube-multi :controller="controller"
                                      @OnChange="SubeSelected">
                        </c-sube-multi>
                    </div>
                    <div class="row" v-if="!disOgrenciEkle">
                        <c-kademe3 :controller="controller"
                                   :idsubelist="ID_SUBELIST"
                                   :idset="ID_KADEME3"
                                   @OnChange="Kademe3Selected">
                        </c-kademe3>
                    </div>
                    <div class="row" v-if="disOgrenciEkle">
                        <c-kademe3-tumu :controller="controller"
                                        :idset="ID_KADEME3"
                                        @OnChange="DisOgrenciKademe3Selected">
                        </c-kademe3-tumu>
                    </div>
                    <div class="row">
                        <c-sinav-turu :controller="controller"
                                      :idkademe3="ID_KADEME3"
                                      :idset="ID_SINAVTURU"
                                      :donem="DONEM"
                                      :sinavdurum=true
                                      @OnChange="SinavTuruSelected">
                        </c-sinav-turu>
                    </div>
                    <div class="row">
                        <c-sinav :controller="controller"
                                 :idkademe3="ID_KADEME3"
                                 :idsinavturu="ID_SINAVTURU"
                                 :donem="DONEM"
                                 :onlinesinav=true
                                 :idset="ID_SINAV"
                                 @OnChange="SinavSelected">
                        </c-sinav>
                    </div>
                    <div v-show="ID_SINAV>0 && !disOgrenciEkle">
                        <div class="row">

                            <c-sinif-alan-multi :controller="controller"
                                                @OnChange="SinifAlanSelected">
                            </c-sinif-alan-multi>
                        </div>
                        <div class="row" v-show="!disOgrenciEkle">
                            <c-sinif-multi :controller="controller"
                                           :idkademe3="ID_KADEME3"
                                           :idsubelist="ID_SUBELIST"
                                           :idsinifalanlist="ID_SINIFALANLIST"
                                           :idset="ID_SINIFLIST"
                                           @OnChange="SinifSelected">
                            </c-sinif-multi>
                        </div>
                        <div class="row" v-if="ID_SINIFLIST.filter((x)=>{return x > 0 }).length == 1 && !disOgrenciEkle">
                            <c-ogrenci-multi :controller="controller"
                                             :idsiniflist="ID_SINIFLIST"
                                             :idset="TC_OGRENCILIST"
                                             @OnChange="OgrenciSelected">
                            </c-ogrenci-multi>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group" style="margin-top:10px;">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn green" v-if="!disOgrenciEkle" @click="OgrenciAta" :disabled="ID_SINAV == 0 || (ID_SINIFLIST.length == 0 ) || (ID_SINIFLIST.length == 1 && TC_OGRENCILIST.length == 0 )">Sınav Ata</button>
                                <button type="button" class="btn green" v-if="disOgrenciEkle" @click="OgrenciYukleModal" :disabled="ID_KADEME3 == 0 || ID_SINAV==0">Kurum Dışı Öğrenciye Sınav Atama</button>
                                <button type="button" class="btn green" @click="Liste" :disabled="ID_SINAV==0" >Listele</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-if="LISTE != undefined">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase"> Sınav Detay </span>
                    <span class="caption-helper"></span>
                </div>
            </div>
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">
                        <div class="row">
                            <div v-if="LISTE != undefined" :class="(OGRENCILIST != undefined ? 'col-md-6' : 'col-md-12')">
                                <table class="table table-striped table-bordered table-hover table-checkable" style="margin: 0px;">
                                    <thead>
                                        <tr style="background: #e1e5e8;">
                                            <th>Ekleyen Kişi</th>
                                            <th>Kayıt Tarihi</th>
                                            <th>Eklenen Öğrenci Sayısı</th>
                                            <th>Öğrenci Listesi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="u in LISTE">
                                            <td> {{u.ADSOYAD}} </td>
                                            <td> {{u.TARIH }} </td>
                                            <td> {{u.OGRENCISAYISI}} </td>
                                            <td>
                                                <button type="button" class="btn yellow" @click="OgrenciListSelected(u.OGRENCILIST)" :disabled="u.OGRENCISAYISI==0">Öğrenci Listesi</button>
                                                <button type="button" class="btn red" @click="OgrenciAtamaKaldir(u.TCKIMLIKNO,u.KYE_TARIH)">
                                                    <i class="icon-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div v-show="OGRENCILIST != undefined" class="col-md-6">
                                <table class="table table-striped table-bordered table-hover table-checkable"
                                       style="margin:0px;"
                                       id="ogrenciTable">
                                    <thead>
                                        <tr style="background: #e1e5e8;">
                                            <th> T.C. Kimlik No </th>
                                            <th> Kampüs </th>
                                            <th> Sınıf </th>
                                            <th> Ad Soyad </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="u in OGRENCILIST">
                                            <td> {{u.TCKIMLIKNO}} </td>
                                            <td> {{u.SUBEAD}} </td>
                                            <td> {{u.SINIFAD}} </td>
                                            <td> {{u.ADSOYAD}} </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-12" v-if="APILISTE != undefined">
        <div class="portlet light">
            <div class="portlet-title">
                <div class="caption">
                    <i class="icon-list font-green"></i>
                    <span class="caption-subject bold font-green uppercase">API Sınav Detay </span>
                    <span class="caption-helper"></span>
                </div>
            </div>
            <div class="portlet-body form">
                <form role="form">
                    <div class="portlet light bordered">
                        <div class="row">
                            <div  class="col-md-12">
                                <table id="APIOGRENCILIST" class="table table-striped table-bordered table-hover table-checkable" style="margin: 0px;">
                                    <thead>
                                        <tr style="background: #e1e5e8;">
                                            <th>Ekleyen Kişi</th>
                                            <th>Kayıt Tarihi</th>
                                            <th>TC Kimlik No</th>
                                            <th>Ad Soyad</th>
                                            <th>Sınıf</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="u in APILISTE">
                                            <td> {{u.EKLEYEN}} </td>
                                            <td> {{u.TARIH }} </td>
                                            <td> {{u.TCKIMLIKNO}} </td>
                                            <td> {{u.ADSOYAD}} </td>
                                            <td> {{u.SINIF}} </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                             
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="DisOgrenci_modal" class="modal fade in" tabindex="-1" data-replace="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">Dış Öğrenci Atama</h4>
                    <div class="portlet-body form collapse in" id="filters">
                        <form role="form" style="padding:12px 20px">
                            <div class="row">
                                <div class="fileinput fileinput-new" data-provides="fileinput">
                                    <span class="fileinput-preview thumbnail" style="max-width: 1000px; max-height: 1000px;"> </span>
                                    <span>
                                        <span class="btn default btn-file">
                                            <span class="fileinput-new yellow"> Kurum Dışı Öğrenci Excel Yükle </span>
                                            <span class="fileinput-exists"> Değiştir </span>
                                            <input type="file" name="..." accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="dosya" @change="previewFile" data-preview-file-type="text">
                                        </span>
                                        <a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> Sil </a>
                                        <a href="javascript:;" class="btn green fileinput-exists" data-dismiss="modal"> Tamam </a>
                                    </span>
                                </div>
                                <button type="button" style="float:right" class="btn yellow" @click="ExcelTaslakIndir">Taslak İndir</button>
                            </div>
                        </form>
                    </div>


                </div>
                <div class="col-md-12 col-xs-12" v-show="ATANMAYAN>0">
                    <h5 class="bold text-center">ATANMAYAN ÖĞRENCİLER</h5>
                    <table class="table table-striped table-bordered table-hover table-checkable"
                           style="margin:0px;max-height:500px; overflow:auto;"
                           id="DisOgrenciErrTable">
                        <thead>
                            <tr style="background: #e1e5e8;">
                                <th> T.C. </th>
                                <th> Adı </th>
                                <th> Soyadı </th>
                                <th style="width:200px;"> Hata Detayı </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="u in ATANAMAYACAK_OGRENCILER">
                                <td> {{u.TCKIMLIKNO}} </td>
                                <td> {{u.AD}} </td>
                                <td> {{u.SOYAD}} </td>
                                <td class="text-danger" style="font-size:8px;">Kurum İçi</td>
                            </tr>

                        </tbody>
                    </table>
                </div>
                <div class="modal-body" style="padding-bottom:10px;min-height:500px;">
                    <div class="col-md-5 col-xs-12">
                        <h5 class="bold text-center">ATANACAK ÖĞRENCİLER</h5>

                        <table class="table table-striped table-bordered table-hover table-checkable"
                               style="margin:0px; max-height:500px; overflow:auto;"
                               id="DisOgrenciValidTable">
                            <thead>
                                <tr style="background: #e1e5e8;">
                                    <th> T.C. </th>
                                    <th> Adı </th>
                                    <th> Soyadı </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="u in ATANACAK_DIS_OGRENCILER">
                                    <td> {{u.TCKIMLIKNO}} </td>
                                    <td> {{u.AD}} </td>
                                    <td> {{u.SOYAD}} </td>

                                </tr>

                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-7 col-xs-12">
                        <h5 class="bold text-center">ATANMAYACAK ÖĞRENCİLER</h5>
                        <table class="table table-striped table-bordered table-hover table-checkable"
                               style="margin:0px;max-height:500px; overflow:auto;"
                               id="DisOgrenciErrTable">
                            <thead>
                                <tr style="background: #e1e5e8;">
                                    <th> T.C. </th>
                                    <th> Adı </th>
                                    <th> Soyadı </th>
                                    <th style="width:200px;"> Hata Detayı </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="u in ATANMAYACAK_DIS_OGRENCILER">
                                    <td> {{u.TCKIMLIKNO}} </td>
                                    <td> {{u.AD}} </td>
                                    <td> {{u.SOYAD}} </td>
                                    <td class="text-danger" style="font-size:8px;"> {{u.HATA}} </td>
                                </tr>

                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="modal-footer" style="margin-top:10px;">
                    <button type="button" class="btn green" @click="ExcelYukle" data-dismiss="modal"> Kaydet </button>
                    <button type="button" class="btn default" data-dismiss="modal">Vazgeç</button>
                </div>
            </div>
        </div> 
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js" integrity="sha512-wBcFatf7yQavHQWtf4ZEjvtVz4XkYISO96hzvejfh18tn3OrJ3sPBppH0B6q/1SHB4OKHaNNUKqOmsiTGlOM/g==" crossorigin="anonymous"></script>
<script src="../../VueComponents/Filtre.js"></script>
<script src="../../VueComponents/FiltreEk.js"></script>

<script>
    var vue = new Vue({
        el: "#app",
        name: "OnlineSinavOgrenciAtama",

        data: {
            TCKIMLIKNO: '',
            OTURUM: '',
            controller: 'OnlineSinavOgrenciAtama',

            DONEM: '',
            ID_SINAVTURU: 0,
            ID_KADEME3: 0,
            ID_SINAV: 0,
            ID_SUBELIST: [],
            ID_SINIFLIST: [],
            TC_OGRENCILIST: [],
            ID_SINIFALANLIST: [],

            LISTE: undefined,
            OGRENCILIST: undefined,
            APILISTE: undefined,
            disOgrenciEkle: false,
            ATANACAK_DIS_OGRENCILER: [],
            ATANMAYACAK_DIS_OGRENCILER: [],
            ATANAMAYACAK_OGRENCILER: [],
            ATANMAYAN: 0
        },

        mounted() {

            this.TCKIMLIKNO = session.TCKIMLIKNO;
            this.OTURUM = session.OTURUM;

        },

        methods: {
            DonemSelected(val) {
                this.DONEM = val;
                this.ID_SINAVTURU = 0;
                this.ID_SINAV = 0;
            },
            SubeSelected(val) {

                this.ID_SUBELIST = val;
                this.ID_KADEME3 = 0;
                this.ID_SINAVTURU = 0;
                this.ID_SINAV = 0;

                this.ID_SINIFALANLIST = [];
                this.ID_SINIFLIST = [];
                this.TC_OGRENCILIST = [];
                this.LISTE = undefined;
                this.APILISTE = undefined;


            },
            Kademe3Selected(val) {
                this.ID_KADEME3 = val;
                this.ID_SINAVTURU = 0;
                this.ID_SINAV = 0;
                this.LISTE = undefined;
                this.APILISTE = undefined;
            },
            SinavTuruSelected(val) {
                this.ID_SINAVTURU = val
                this.ID_SINAV = 0;
                this.LISTE = undefined;
                this.APILISTE = undefined;
            },
            SinavSelected(val) {
                this.ID_SINAV = val;
                
                this.LISTE = undefined;
                this.APILISTE = undefined;
               
            },
            SinifAlanSelected(item) {
                this.ID_SINIFALANLIST = item;
                this.ID_SINIFLIST = [];
            },
            SinifSelected(val) {
                this.ID_SINIFLIST = val;
                this.TC_OGRENCILIST = [];
            },
            OgrenciSelected(val) {
                this.TC_OGRENCILIST = val;
            },
            OgrenciListSelected(OGRENCILIST) {
              
                this.OGRENCILIST = OGRENCILIST;

                let sort = [
                    [1, 'asc'],
                    [2, 'asc'],
                    [3, 'asc']
                ];
                ListeOlustur("ogrenciTable", sort);
            },
            Liste() {
                this.Listele();
                this.APIOgrenciListele();
            },
            Listele() {
                 
                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_SINAV: this.ID_SINAV,
                    DIS_OGRENCI: vue.disOgrenciEkle
                };
                this.LISTE = undefined;
                this.OGRENCILIST = undefined;

                WebPost(this, this.controller, "OnlineSinavOgrenciListele", p, '', '', function (data, parent) {
                    
                    if (data != '[]')
                        vue.LISTE = JSON.parse(data);

                });
                

            },
            APIOgrenciListele() {
              
                 var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_SINAV: this.ID_SINAV,
                    DIS_OGRENCI: vue.disOgrenciEkle
                };
                this.APILISTE = undefined;
 
                WebPost(this, this.controller, "APIOnlineSinavOgrenciListele", p, '', '', function (data, parent) {
                    if (data != '[]')
                        vue.APILISTE = JSON.parse(data);

                    let sort = [
                        [1, 'asc'],
                        [2, 'asc'],
                        [3, 'asc']
                    ];
                    ListeOlustur("APIOGRENCILIST", sort);

                });

            },
            OgrenciAta() {

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_SINAV: this.ID_SINAV,
                    ID_SINIFLIST: JSON.stringify(this.ID_SINIFLIST),
                    TC_OGRENCILIST: JSON.stringify(this.TC_OGRENCILIST)
                };

                WebPost(this, this.controller, "OnlineSinavOgrenciAta", p, '', '', function (data, parent) {

                    (data)
                        ? Alert_Info("Kayıt İşlemi Tamamlandı")
                        : Alert_Error("Hata...")

                    vue.Liste();
                });

            },
            OgrenciYukleModal() {

                $('#DisOgrenci_modal').modal();
            },

            OgrenciAtamaKaldir(tc, kyeTarih) {

                let p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    ID_SINAV: this.ID_SINAV,
                    TC_EKLEYEN: tc,
                    KYE_TARIH: kyeTarih,
                };

                WebPost(this, this.controller, "OnlineSinavOgrenciAtamaKaldir", p, '', '', function (data, parent) {

                    (data > 0)
                        ? Alert_Warning("Sınava Başlamayan " + data + " Öğrencinin Ataması Kaldırılamadı")
                        : Alert_Info("Öğrencilerin Sınav Ataması Kaldırıldı")

                    vue.Liste();
                });
            },
            disOgrenciChanged() {
                disOgrenciEkle = this.disOgrenciEkle;
                this.LISTE = undefined;
                this.APILISTE = undefined;
            },
            DisOgrenciKademe3Selected(val) {
                this.ID_KADEME3 = val;

            },
            ExcelTaslakIndir() {
                window.open("Dosyalar/ExcelTaslak/KurumDisiOgrenciAtamaTaslak.xlsx", "_blank");
            },
            ExcelYukle() {

                var dosya = document.getElementById('dosya').files;
                dosyaadi = $('#dosya').val().replace(/^.*[\\\/]/, '');
                if (dosya.length == 0) {
                    Alert_Info('Lütfen Dosya Seçiniz.');
                    return;
                }

                var _this = this;

                var p = {
                    TCKIMLIKNO: session.TCKIMLIKNO,
                    OTURUM: session.OTURUM,
                    SQLJSON: JSON.stringify(vue.ATANACAK_DIS_OGRENCILER),
                    ID_SINAV: vue.ID_SINAV
                };
                
                WebPost(_this, _this.controller, "OnlineSinavKurumDisiOgrenciAtama", p, '', '', function (data, parent) {

                    if (data != null) {
                        $('#dosya').val('');
                        vue.ATANAMAYACAK_OGRENCILER = JSON.parse(data);
                        vue.Liste();
                        vue.ATANMAYAN = 1;
                    }
                    else {
                        Alert_Info("Öğrencilerin Sınav Ataması Yapıldı")
                        $('#dosya').val('');
                        vue.ATANAMAYACAK_OGRENCILER = [];
                        vue.ATANMAYAN = 0;
                        vue.Liste();
                        ATANACAK_DIS_OGRENCILER = [];
                    }

                });

            },
            previewFile(e) {

                selectedFile = document.getElementById('dosya').files[0];

                if (selectedFile.length == 0) {
                    Alert_Info('Lütfen Dosya Seçiniz.');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function (event) {
                    let data = event.target.result;
                    var workbook = XLSX.read(data, {
                        type: 'binary'
                    });
                    let tumData = []
                    let eklenecekData = [];
                    let hataliData = [];
                    workbook.SheetNames.forEach(sheet => {
                        let rowObject = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheet]);

                        tumData.push(rowObject);

                    });


                    tumData[0].forEach((item, i) => {
                        if (item.TCKIMLIKNO && item.AD && item.SOYAD) {
                            let plusTc = parseInt(item.TCKIMLIKNO) + 1;
                            item.TCKIMLIKNO = plusTc;
                            eklenecekData.push(item);
                            } else { hataliData.push(item); }


                    });
                    hataliData.forEach((item, i) => {
                        let hata = "";
                        if (!item.TCKIMLIKNO) {
                            hata = "(*) Zorunlu alanları kotrol ediniz => TC Kimlik - Ad - Soyad ";
                        }
                        if (!item.AD) {
                            hata = "(*) Zorunlu alanları kotrol ediniz => TC Kimlik - Ad - Soyad ";
                        }
                        if (!item.SOYAD) {
                            hata = "(*) Zorunlu alanları kotrol ediniz => TC Kimlik - Ad - Soyad ";
                        }

                        item["HATA"] = hata;
                    });
                    eklenecekData.forEach((item, i) => {
                        item["ID_KADEME3"] = vue.ID_KADEME3;
                        item["DONEM"] = vue.DONEM;

                    });

                    //eklenecekData["SINAV"] = vue.ID_SINAV;


                    vue.ATANACAK_DIS_OGRENCILER = eklenecekData;
                    vue.ATANMAYACAK_DIS_OGRENCILER = hataliData;
                };

                reader.onerror = function (event) {
                    //console.error("Dosya Okunamadı" + event.target.error.code);
                };
                reader.readAsBinaryString(selectedFile);
            }


        }
    });
</script>
<script src="Scripts/PublicMethods.js"></script>

<script src="assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
<script src="assets/global/plugins/bootstrap-datepicker/locales/bootstrap-datepicker.tr.min.js" type="text/javascript"></script>
<script src="assets/pages/scripts/components-date-time-pickers.min.js" type="text/javascript"></script>
