/*
Deployment script for Pusulam

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Pusulam"
:setvar DefaultFilePrefix "Pusulam"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Disabling all DDL triggers...'
GO
DISABLE TRIGGER ALL ON DATABASE
GO
PRINT N'Altering [dbo].[OzelSayfaYetki]...';


GO
ALTER TABLE [dbo].[OzelSayfaYetki]
    ADD [ID_KADEME3] INT NULL;


GO
PRINT N'Altering [dbo].[sp_Menu]...';


GO
ALTER procedure [dbo].[sp_Menu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUYARDIM		INT				= 1,
	@ID_MENU			INT				= 1,
	@ID_KADEME			INT				= NULL,
	@ID_KULLANICITIPI	INT				= NULL	
AS
BEGIN

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU

	DECLARE @TCKIMLIKNOTEMP VARCHAR(11) = @TCKIMLIKNO
	
	IF @return_variable = 1
	BEGIN
	
		SELECT DISTINCT ID_KADEME INTO #KADEMELER FROM OkyanusDB.dbo.v4KullaniciKademe WHERE TCKIMLIKNO = @TCKIMLIKNOTEMP
		IF @ISLEM = 1	--	Menü Getir
		BEGIN	
			IF dbo.fn_GenelHak(@TCKIMLIKNO)>0
			BEGIN
					SELECT DISTINCT M.ID_MENU, M.AD, M.KOD, M.URL, M.RESIM
					FROM Menu							M
					where M.GIZLI = 0					
						 AND (		(@TCKIMLIKNO = '62362359264' AND ID_MENU IN (1099,1193,1200,1335,1344))
								OR	@TCKIMLIKNO != '62362359264')				
				UNION 				
					SELECT -1, 'Bağlantılar', '000', '', 'icon-directions'
					WHERE EXISTS (	SELECT * 
									FROM OzelSayfa		OS
									JOIN OzelSayfaYetki	Y	ON	Y.ID_OZELSAYFA = OS.ID_OZELSAYFA
									WHERE	AKTIF				= 1
										AND Y.ID_KULLANICITIPI	= 1) --	ADMİN
				UNION				
					SELECT	  -1
							, OS.AD
							, CASE WHEN OS.ID_OZELSAYFA		> 999	THEN '000999'		ELSE  RIGHT( '000000' + CAST(OS.ID_OZELSAYFA AS varchar),6) END
							, OS.YOL							
							, CASE WHEN OS.ID_OZELSAYFATURU	= 1		THEN 'icon-globe'	ELSE 'icon-doc' END
					FROM OzelSayfa		OS
					JOIN OzelSayfaYetki	Y	ON	Y.ID_OZELSAYFA = OS.ID_OZELSAYFA				
					WHERE	AKTIF				= 1
						AND Y.ID_KULLANICITIPI	= 1	--	ADMİN
				ORDER BY M.KOD

			END
			ELSE
			BEGIN				
				SELECT DISTINCT ID_KULLANICITIPI 
				INTO #v3SubeYetki FROM v3SubeYetki
				WHERE TCKIMLIKNO = @TCKIMLIKNOTEMP

				SELECT	DISTINCT
					 M.ID_MENU
					,M.AD
					,M.KOD
					--,M.URL					
					,URL	= CASE WHEN LEFT(M.URL, 7) = 'Dinamik' THEN eokul_v2.dbo.Fn_DinamikUrl(M.URL, @TCKIMLIKNOTEMP) ELSE M.URL END
					,M.RESIM
				INTO #MenuListe FROM Menu		M
				INNER JOIN MenuYetki			Y	ON Y.ID_MENU			= M.ID_MENU  
				INNER JOIN #v3SubeYetki			S	ON S.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
				INNER JOIN #KADEMELER			K	ON K.ID_KADEME			= Y.ID_KADEME
				WHERE M.GIZLI = 0

				UNION
								
				SELECT
					 M.ID_MENU
					,M.AD
					,M.KOD
					,M.URL
					,M.RESIM
				FROM Menu							M
				INNER  JOIN MenuKullaniciYetki		KY			ON M.ID_MENU		= KY.ID_MENU	
				WHERE KY.TCKIMLIKNO = @TCKIMLIKNOTEMP	AND M.GIZLI = 0
								
				UNION 

				SELECT -1, 'Bağlantılar', '000', '', 'icon-directions'
				WHERE EXISTS (	SELECT * 
								FROM OzelSayfa							OS
								JOIN OzelSayfaYetki						Y	ON	Y.ID_OZELSAYFA		= OS.ID_OZELSAYFA
								JOIN #KADEMELER							K	ON	K.ID_KADEME			= Y.ID_KADEME
								JOIN #v3SubeYetki						SY	ON	SY.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI 
								JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.TCKIMLIKNO		= @TCKIMLIKNOTEMP
																			AND KY.ID_KADEME3		= Y.ID_KADEME3
								WHERE AKTIF = 1)
				
				UNION

				SELECT	-1
						, OS.AD
						, CASE WHEN OS.ID_OZELSAYFA > 999 THEN '000999' ELSE  RIGHT( '000000' + CAST(OS.ID_OZELSAYFA AS varchar),6) END
						, OS.YOL
						, CASE WHEN OS.ID_OZELSAYFATURU	= 1 THEN 'icon-globe' ELSE 'icon-doc' END
				FROM OzelSayfa							OS
				JOIN OzelSayfaYetki						Y	ON	Y.ID_OZELSAYFA		= OS.ID_OZELSAYFA
				JOIN #KADEMELER							K	ON	K.ID_KADEME			= Y.ID_KADEME
				JOIN #v3SubeYetki						SY	ON	SY.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI 
				JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.TCKIMLIKNO		= @TCKIMLIKNOTEMP
															AND KY.ID_KADEME3		= Y.ID_KADEME3
				WHERE OS.AKTIF = 1

				-- CORPUS STUDIO
					UNION
					SELECT TOP 1
						ID_MENU				= -1,
						AD					= 'Corpus.Study',
						KOD					= '-00',
						URL					= '',
						RESIM				= 'icon-list'

					FROM Pusulam.dbo.CurpusStudy
					WHERE TCKIMLIKNO =  @TCKIMLIKNO

					UNION
					SELECT
						ID_MENU				= -1,
						AD					= 'Corpus.Study',
						KOD					= '-00001',
						URL					= 'https://okyanus.corpus.study/okul-kontrol.php?token='+TOKEN,
						RESIM				= 'icon-list'

					FROM Pusulam.dbo.CurpusStudy
					WHERE TCKIMLIKNO =  @TCKIMLIKNO AND YONETIM = 0

					-- CORPUS STUDIO YÖNETİM
					UNION
					SELECT
						ID_MENU				= -1,
						AD					= 'Corpus.Study Yönetim',
						KOD					= '-00002',
						URL					= 'https://okyanus.corpus.study/yonetim/ogrt-kontrol.php?token='+TOKEN,
						RESIM				= 'icon-list'
					FROM Pusulam.dbo.CurpusStudy
					WHERE TCKIMLIKNO =  @TCKIMLIKNO AND YONETIM = 1
					
				-- RehberlikOnline
					UNION
					SELECT TOP 1
						ID_MENU				= -1,
						AD					= 'Rehberlik Online',
						KOD					= '-01',
						URL					= '',
						RESIM				= 'icon-list'

					FROM Pusulam.dbo.RehberlikOnlineLink
					WHERE TCKIMLIKNO =  @TCKIMLIKNO
					
					UNION
					SELECT
						ID_MENU				= -1,
						AD					= TESTADI,
						KOD					= '-01' + RIGHT('000'+ CAST(ROW_NUMBER() OVER(ORDER BY TESTADI) AS varchar) ,3 ) ,
						URL					= LINK,
						RESIM				= 'icon-globe'

					FROM Pusulam.dbo.RehberlikOnlineLink
					WHERE TCKIMLIKNO =  @TCKIMLIKNO

				ORDER BY M.KOD



				--UPDATE #MenuListe SET URL = '#Ogrenci/Hedefler/MevcutDurum'
				--WHERE 
				--	ID_MENU = 1 
				--AND EXISTS(SELECT ID_KADEME			FROM #KADEMELER			WHERE ID_KADEME			= 5)
				--AND EXISTS(SELECT ID_KULLANICITIPI	FROM #v3SubeYetki		WHERE ID_KULLANICITIPI	= 4)
				--
				--UPDATE #MenuListe SET URL = '#Ogrenci/Hedefler/MevcutDurumOO'
				--WHERE 
				--		ID_MENU = 1 
				--	AND EXISTS(SELECT ID_KADEME			FROM #KADEMELER			WHERE ID_KADEME			= 4)
				--	AND EXISTS(SELECT ID_KULLANICITIPI	FROM #v3SubeYetki		WHERE ID_KULLANICITIPI	= 4)

				IF @TCKIMLIKNO = '98765432101'	--	GARANTİ BBVA
				BEGIN

					SELECT	DISTINCT
						 M.ID_MENU
						,M.AD
						,M.KOD
						,M.URL
						,M.RESIM
					FROM Menu		M
					WHERE M.ID_MENU = 1316
					
				END 
				ELSE
				BEGIN
					SELECT * FROM #MenuListe
					ORDER BY KOD
				END

				DROP TABLE #v3SubeYetki
				DROP TABLE #MenuListe
			END
		END
		
		IF @ISLEM = 2	--	Menü Getir YETKİ SAYFASI
		BEGIN
			SELECT 
					M.ID_MENU,
					replicate('-', LEN(KOD)-3)+AD AD,
					YETKILI = (SELECT COUNT(*) FROM MenuYetki Y WHERE Y.ID_KULLANICITIPI=@ID_KULLANICITIPI AND Y.ID_MENU=M.ID_MENU AND Y.ID_KADEME = @ID_KADEME)
			FROM Menu		M
			WHERE GIZLI = 0 AND (OZEL = 0 /*OR dbo.fn_GenelHak(@TCKIMLIKNO)>0*/)
			ORDER BY KOD 
		END
		
		
		IF @ISLEM = 3	--	Kullanıcı Menü Getir YETKİ SAYFASI
		BEGIN
			SELECT 
					M.ID_MENU,
					replicate('-', LEN(KOD)-3)+AD AD,
					YETKILI = (SELECT COUNT(*) FROM MenuKullaniciYetki Y WHERE Y.TCKIMLIKNO=@TC_YETKI AND Y.ID_MENU=M.ID_MENU)
			FROM Menu		M
			WHERE GIZLI = 0 AND (OZEL = 0 OR dbo.fn_GenelHak(@TCKIMLIKNO)>0)
			ORDER BY KOD 
		END
		
		
		IF @ISLEM = 4	--	Menü Yardım Getir
		BEGIN
			SELECT 
					YARDIMHTML
			FROM Menu		M
			WHERE ID_MENU=@ID_MENUYARDIM
		END

		DROP TABLE IF EXISTS #KADEMELER
	END

END TRY
		BEGIN CATCH
			
			SELECT 
				@ErrorSeverity	= ERROR_SEVERITY(),
				@ErrorState		= ERROR_STATE()
							
			SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
			RAISERROR (@MSG , -- Message text.
						@ErrorSeverity, -- Severity.
						@ErrorState -- State.
						);
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OzelSayfaIslemleri]...';


GO
ALTER procedure [dbo].[sp_OzelSayfaIslemleri]

	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,

	@AKTIF					BIT				= NULL,
	@ID_OZELSAYFA			INT				= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL

AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,AKTIF					= @AKTIF
				,ID_OZELSAYFA			= @ID_OZELSAYFA
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

		IF @_ID_LOG > 0
		BEGIN

			IF @ISLEM = 1	--	ÖZEL SAYFA TÜR LİSTESİ	
			BEGIN
				SELECT (
					SELECT ID_OZELSAYFATURU, AD
					FROM OzelSayfaTuru
					FOR JSON PATH,INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 2	--	ÖZEL SAYFA EKLE/DÜZENLE	
			BEGIN

				DROP TABLE IF EXISTS #TEMP

				SELECT	 AD					= JS.AD
						,ACIKLAMA			= JS.ACIKLAMA
						,YOL				= JS.YOL
						,ID_OZELSAYFATURU	= JS.ID_OZELSAYFATURU
						,ID_KULLANICITIPI	= KTL.VALUE
						--,ID_KADEME			= KL.VALUE
						,ID_KADEME3			= KL3.VALUE
				INTO #TEMP
				FROM OPENJSON (@SQLJSON)
				WITH(	 AD						NVARCHAR(MAX)
						,ACIKLAMA				NVARCHAR(MAX)
						,YOL					NVARCHAR(MAX)
						,ID_KULLANICITIPILIST	NVARCHAR(MAX) AS JSON
						--,ID_KADEMELIST			NVARCHAR(MAX) AS JSON
						,ID_KADEME3LIST			NVARCHAR(MAX) AS JSON
						,ID_OZELSAYFATURU		INT
				) AS JS
				CROSS APPLY OPENJSON (ID_KULLANICITIPILIST) AS KTL
				--CROSS APPLY OPENJSON (ID_KADEMELIST) AS KL
				CROSS APPLY OPENJSON (ID_KADEME3LIST) AS KL3
				JOIN v3KullaniciTipi	KT	ON	KT.ID_KULLANICITIPI	= KTL.VALUE
				--JOIN v3Kademe			K	ON	K.ID_KADEME			= KL.VALUE
				JOIN v3Kademe3			K3	ON	K3.ID_KADEME3		= KL3.VALUE

				UPDATE #TEMP SET
					YOL = 'http://' + YOL
				WHERE ID_OZELSAYFATURU = 1 
					AND YOL NOT LIKE  'http%'

				IF @ID_OZELSAYFA IS NULL
				BEGIN
					DECLARE @INSERTEDTABLE TABLE (ID INT)

					INSERT INTO OzelSayfa (ID_OZELSAYFATURU, YOL, AD, ACIKLAMA, KYE_TCKIMLIKNO)
					OUTPUT inserted.ID_OZELSAYFA INTO @INSERTEDTABLE(ID)
					SELECT TOP 1 ID_OZELSAYFATURU, YOL, AD, ACIKLAMA, @TCKIMLIKNO FROM #TEMP

					SET @ID_OZELSAYFA = (SELECT TOP 1 ID FROM @INSERTEDTABLE)

				END
				ELSE
				BEGIN

					UPDATE OzelSayfa SET
						AD			= (SELECT TOP 1 AD			FROM #TEMP),
						ACIKLAMA	= (SELECT TOP 1 ACIKLAMA	FROM #TEMP),
						YOL			= (SELECT TOP 1 YOL			FROM #TEMP)
					WHERE ID_OZELSAYFA = @ID_OZELSAYFA

				END


				DELETE FROM OzelSayfaYetki WHERE ID_OZELSAYFA = @ID_OZELSAYFA
				INSERT INTO OzelSayfaYetki (ID_OZELSAYFA, ID_KULLANICITIPI, ID_KADEME, ID_KADEME3)
				SELECT DISTINCT @ID_OZELSAYFA, ID_KULLANICITIPI, KB.ID_KADEME, KB.ID_KADEME3 
				FROM #TEMP			T
				JOIN v3KademeBilgi	KB	ON	KB.ID_KADEME3 = T.ID_KADEME3
				
				DROP TABLE IF EXISTS #TEMP
			END

			IF @ISLEM = 3	--	ÖZEL SAYFA DETAY		
			BEGIN
				SELECT ISNULL((
					SELECT	 ID_OZELSAYFA
							,AD
							,ACIKLAMA
							,YOL
							,ID_OZELSAYFATURU
							,ID_KULLANICITIPILIST	= (SELECT DISTINCT ID_KULLANICITIPI	FROM OzelSayfaYetki Y WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA FOR JSON PATH)
							,ID_KADEMELIST			= (SELECT DISTINCT ID_KADEME		FROM OzelSayfaYetki Y WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA FOR JSON PATH)
							,ID_KADEME3LIST			= (SELECT DISTINCT ID_KADEME3		FROM OzelSayfaYetki Y WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA FOR JSON PATH)
					FROM OzelSayfa		OS
					WHERE OS.ID_OZELSAYFA = @ID_OZELSAYFA
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')
			END

			IF @ISLEM = 4	--	ÖZEL SAYFA LİSTE		
			BEGIN
				DROP TABLE IF EXISTS #TEMP4

				SELECT	 ID_KULLANICITIPI	= KTL.VALUE 
						,ID_KADEME			= KL.VALUE
						,ID_KADEME3			= KL3.VALUE
				INTO #TEMP4
				FROM OPENJSON (@SQLJSON)
				WITH(	 ID_KULLANICITIPILIST	NVARCHAR(MAX) AS JSON
						,ID_KADEMELIST			NVARCHAR(MAX) AS JSON	
						,ID_KADEME3LIST			NVARCHAR(MAX) AS JSON						
				) AS JS
				CROSS APPLY OPENJSON (ID_KULLANICITIPILIST)	AS KTL
				CROSS APPLY OPENJSON (ID_KADEMELIST)		AS KL
				CROSS APPLY OPENJSON (ID_KADEME3LIST)		AS KL3

				SELECT ISNULL((
					SELECT DISTINCT
						 OS.ID_OZELSAYFA
						,OS.AD
						,OS.ACIKLAMA
						,OS.YOL
						,OS.ID_OZELSAYFATURU
						,OZELSAYFATURU			= OST.AD
						,OS.AKTIF
						,ID_KULLANICITIPILIST	= (	SELECT DISTINCT KT.AD
													FROM OzelSayfaYetki		Y  
													JOIN v3KullaniciTipi	KT	ON	KT.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
													WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA 
													FOR JSON PATH)
						,ID_KADEMELIST			= (	SELECT DISTINCT K.AD
													FROM OzelSayfaYetki		Y 
													JOIN v3Kademe			K	ON	K.ID_KADEME			= Y.ID_KADEME
													WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA 
													FOR JSON PATH)
						,ID_KADEME3LIST			= (	SELECT DISTINCT K.AD
													FROM OzelSayfaYetki		Y 
													JOIN v3Kademe3			K	ON	K.ID_KADEME3		= Y.ID_KADEME3
													WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA 
													FOR JSON PATH)
					FROM OzelSayfa		OS
					JOIN OzelSayfaTuru	OST	ON	OST.ID_OZELSAYFATURU= OS.ID_OZELSAYFATURU
					JOIN OzelSayfaYetki	Y	ON	Y.ID_OZELSAYFA		= OS.ID_OZELSAYFA
					JOIN #TEMP4			T	ON	T.ID_KADEME			= Y.ID_KADEME
											AND T.ID_KADEME3		= Y.ID_KADEME3
											AND T.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

				DROP TABLE IF EXISTS #TEMP4
			END

			IF @ISLEM = 5	--	ÖZEL SAYFA AKTIF/PASIF	
			BEGIN
				UPDATE OzelSayfa SET
					AKTIF = @AKTIF
				WHERE ID_OZELSAYFA = @ID_OZELSAYFA
			END

			IF @ISLEM = 6	--	ÖZEL SAYFA SİL			
			BEGIN
				DELETE FROM OzelSayfaYetki
				WHERE ID_OZELSAYFA = @ID_OZELSAYFA
				
				DELETE FROM OzelSayfa
				WHERE ID_OZELSAYFA = @ID_OZELSAYFA
			END

		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT	@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_AmazonChime]...';


GO
ALTER procedure [dbo].[sp_AmazonChime]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@MeetingId				VARCHAR(MAX)	= NULL,
	@AttendeeId				VARCHAR(MAX)	= NULL,
	@ID_SINIF				INT				= NULL,
	@OGRETMEN				VARCHAR(MAX)	= NULL,
	@Attendees				VARCHAR(MAX)	= NULL,
	@TC_OGRENCI				VARCHAR(MAX)	= NULL,
	@OGRENCILIST			VARCHAR(MAX)	= NULL,
	@SIFRE					VARCHAR(MAX)	= NULL,
	@KONU					VARCHAR(MAX)	= NULL,
	@ID_JITSIONLINEDERS		INT				= NULL,
	@ID_ODA					INT				= NULL
AS
BEGIN		
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,MeetingId				= @MeetingId
				,ID_SINIF				= @ID_SINIF
				,OGRETMEN				= @OGRETMEN
				,Attendees				= @Attendees
				,TC_OGRENCI				= @TC_OGRENCI
				,OGRENCILIST			= @OGRENCILIST
				,AttendeeId				= @AttendeeId
				,SIFRE					= @SIFRE
				,KONU					= @KONU
				,ID_JITSIONLINEDERS		= @ID_JITSIONLINEDERS
				,ID_ODA					= @ID_ODA
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @_ID_LOG > 0
		BEGIN		
			DECLARE @INSERTED TABLE (ID INT)					
			IF @ISLEM = 1
			BEGIN
				INSERT INTO AmazonOnlineDers (ID_MEETING, ID_SINIF, KYE_KULLANICI)
				OUTPUT INSERTED.ID_AMAZONONLINEDERS INTO @INSERTED
				SELECT @MeetingId, @ID_SINIF, @TCKIMLIKNO

				INSERT INTO AmazonOnlineDersKatilimci (ID_AMAZONONLINEDERS, TCKIMLIKNO, ID_ATTENDEE, JOINTOKEN)
				SELECT (SELECT ID FROM @INSERTED), @TCKIMLIKNO, JSON_VALUE(@OGRETMEN, '$.AttendeeId'), JSON_VALUE(@OGRETMEN, '$.JoinToken')

				INSERT INTO AmazonOnlineDersKatilimci (ID_AMAZONONLINEDERS, TCKIMLIKNO, ID_ATTENDEE, JOINTOKEN)
				SELECT (SELECT ID FROM @INSERTED), ExternalUserId, AttendeeId, JoinToken FROM OPENJSON(@Attendees) WITH (ExternalUserId VARCHAR(MAX), AttendeeId VARCHAR(MAX), JoinToken VARCHAR(MAX))
			END

			IF @ISLEM = 2
			BEGIN
				SELECT ISNULL(
				(
					SELECT SINIF, OGRETMEN, CONVERT(VARCHAR(MAX), XTABLE.KYE_TARIH, 104) + ' ' + CONVERT(VARCHAR(MAX), XTABLE.KYE_TARIH, 108) AS TARIH, ID_MEETING, ID_ATTENDEE
					FROM (
						SELECT S.AD AS SINIF, K.AD + ' ' + K.SOYAD AS OGRETMEN, MAX(KYE_TARIH) AS KYE_TARIH, MAX(DK.ID_AMAZONONLINEDERSKATILIMCI) AS ID_AMAZONONLINEDERSKATILIMCI
						FROM AmazonOnlineDers D
						JOIN AmazonOnlineDersKatilimci DK ON DK.ID_AMAZONONLINEDERS = D.ID_AMAZONONLINEDERS
						JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = D.KYE_KULLANICI
						JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = D.ID_SINIF
						WHERE DK.TCKIMLIKNO = @TC_OGRENCI AND D.AKTIF = 1
						GROUP BY S.AD, K.AD, K.SOYAD
					) AS XTABLE
					JOIN AmazonOnlineDersKatilimci DK ON DK.ID_AMAZONONLINEDERSKATILIMCI = XTABLE.ID_AMAZONONLINEDERSKATILIMCI
					JOIN AmazonOnlineDers D ON D.ID_AMAZONONLINEDERS = DK.ID_AMAZONONLINEDERS
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 3
			BEGIN
				UPDATE AmazonOnlineDers SET AKTIF = 0 WHERE ID_MEETING = @MeetingId
			END

			IF @ISLEM = 4
			BEGIN
				SELECT ISNULL(
				(
					SELECT DK.TCKIMLIKNO, DK.ID_ATTENDEE, DK.JOINTOKEN
					FROM AmazonOnlineDers D
					JOIN AmazonOnlineDersKatilimci DK ON DK.ID_AMAZONONLINEDERS = D.ID_AMAZONONLINEDERS
					WHERE D.ID_MEETING = @MeetingId AND DK.ID_ATTENDEE <> @AttendeeId
					FOR JSON PATH
				), '[]')

				SELECT * FROM AmazonOnlineDersKatilimci
			END

			IF @ISLEM = 5
			BEGIN
				INSERT INTO JitsiOnlineDers (ID_SINIF, KONU, SIFRE, KYE_KULLANICI)
				OUTPUT INSERTED.ID_JITSIONLINEDERS INTO @INSERTED
				SELECT @ID_SINIF, @KONU, @SIFRE, @TCKIMLIKNO

				INSERT INTO JitsiOnlineDersKatilimci (ID_JITSIONLINEDERS, TCKIMLIKNO)
				SELECT (SELECT ID FROM @INSERTED), value FROM OPENJSON(@OGRENCILIST)

				SELECT ID FROM @INSERTED
			END

			IF @ISLEM = 6
			BEGIN
				UPDATE JitsiOnlineDers SET AKTIF = 0 WHERE ID_JITSIONLINEDERS = @ID_JITSIONLINEDERS
			END

			IF @ISLEM = 7 -- VODAFONE EKLE
			BEGIN
			
				IF NOT EXISTS (SELECT TOP 1 1 FROM OnlineDersOgretmenVodafone WHERE TCKIMLIKNO = @TCKIMLIKNO)
					INSERT INTO OnlineDersOgretmenVodafone (TCKIMLIKNO, ID_ODA)
					VALUES (@TCKIMLIKNO, @ID_ODA)

			END
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_VeliUniteTaramaRaporu]...';


GO
ALTER procedure [dbo].[sp_VeliUniteTaramaRaporu]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_UNITETARAMASINAV	INT				= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI					
				,ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	ÖĞRENCİ RAPOR			
			BEGIN
				
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMPOGRENCIPUAN

				SELECT DISTINCT
					 SS.ID_DERS
					,O.TCKIMLIKNO
					,S.ID_UNITETARAMASINAV
					,SINAVAD		= S.AD
					,KITAPCIK		= SK.AD
					,SORUPUAN		= SS.PUAN
					,OGRENCIPUAN	= O.PUAN
					,KAZANIMKOD		= SS.KAZANIMKOD
					,SS.ID_UNITETARAMASORU
					,ADSOYAD	= CONCAT_WS(' ',OD.AD,OD.SOYAD)
					,OD.SUBEAD
					,OD.SINIFAD	
					,OD.ID_SINIF
					,OD.ID_SUBE
					,SS.SORUNO
					,DERSAD			= D.AD
					,KAZANIM		= ISNULL(DU.AD, '')
					,SINIFKATILIM	= NULL
					,OKULKATILIM	= NULL
					,GENELKATILIM	= NULL
				INTO #TEMP
				FROM UniteTaramaSinav						S
				JOIN UniteTaramaKitapcik					SK	ON	SK.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru						SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN UniteTaramaOgrenci						O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
																AND O.ID_UNITETARAMAKITAPCIK= SK.ID_UNITETARAMAKITAPCIK
				JOIN OkyanusDB.DBO.vw_OgrenciDetayTum		OD	ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
																AND OD.DONEM				= S.DONEM
				JOIN OkyanusDB.DBO.v3Ders					D	ON	D.ID_DERS				= SS.ID_DERS
				LEFT JOIN OkyanusDB.DBO.v3SinavDersUnite	DU	ON	DU.KOD					= SS.KAZANIMKOD
				WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV 
					AND (S.OVGORSUN				= 1
						OR EXISTS( SELECT TOP 1 1 FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI NOT IN(3,4) AND TCKIMLIKNO = @TCKIMLIKNO  ))
					AND S.AKTIF					= 1
					AND O.AKTIF					= 1
				ORDER BY O.TCKIMLIKNO

				UPDATE T SET
					 SINIFKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP S WHERE S.ID_SINIF = T.ID_SINIF	)
					,OKULKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP S WHERE S.ID_SUBE  = T.ID_SUBE	)
					,GENELKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP									)
				FROM #TEMP T
				WHERE T.TCKIMLIKNO	= @TC_OGRENCI	

				SELECT T.*
					,FOTOGRAF	= R.FOTOGRAF
				FROM #TEMP T
				LEFT JOIN OkyanusDB.DBO.v3Resim	R	ON	R.TCKIMLIKNO= T.TCKIMLIKNO
													AND R.SIRANO	= 1
				WHERE	T.TCKIMLIKNO= @TC_OGRENCI
				ORDER BY DERSAD, SORUNO, ID_UNITETARAMASORU

				
	
				SELECT DISTINCT
					 O.TCKIMLIKNO
					,S.ID_UNITETARAMASINAV
					,SINAVAD		= S.AD
					,YUZDE			= CEILING( CAST(CAST(SUM(O.PUAN) AS FLOAT) / SUM(SS.PUAN) * 100 AS DECIMAL(8,2)))
				FROM UniteTaramaSinav		S
				JOIN UniteTaramaKitapcik	K	ON	K.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru		SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN UniteTaramaOgrenci		O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
												AND O.ID_UNITETARAMAKITAPCIK= K.ID_UNITETARAMAKITAPCIK
				WHERE	O.TCKIMLIKNO = @TC_OGRENCI
					AND (S.OVGORSUN	 = 1
						OR EXISTS( SELECT TOP 1 1 FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI NOT IN(3,4) AND TCKIMLIKNO = @TCKIMLIKNO  ))
					AND S.AKTIF		 = 1
					AND O.AKTIF		 = 1
					AND S.DONEM		 = (SELECT DONEM FROM UniteTaramaSinav SUB WHERE SUB.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV)
				GROUP BY O.TCKIMLIKNO, S.ID_UNITETARAMASINAV, S.AD
				
				SELECT TCKIMLIKNO, ID_SUBE, ID_SINIF, UPPER(DERSAD) DERSAD, SUM(OGRENCIPUAN) OGRENCIPUAN 
				INTO #TEMPOGRENCIPUAN
				FROM #TEMP
				GROUP BY TCKIMLIKNO, ID_SUBE, ID_SINIF, DERSAD

				SELECT DISTINCT 
					 O.TCKIMLIKNO
					,O.DERSAD
					,OGRENCI= O.OGRENCIPUAN
					,SINIF	= (SELECT SUM(SNF.OGRENCIPUAN)/COUNT(DISTINCT TCKIMLIKNO)	FROM #TEMPOGRENCIPUAN SNF	WHERE SNF.DERSAD= O.DERSAD	AND SNF.ID_SINIF= O.ID_SINIF)
					,SUBE	= (SELECT SUM( SB.OGRENCIPUAN)/COUNT(DISTINCT TCKIMLIKNO)	FROM #TEMPOGRENCIPUAN SB	WHERE SB.DERSAD	= O.DERSAD	AND SB.ID_SUBE	= O.ID_SUBE	)
					,GENEL	= (SELECT SUM(GNL.OGRENCIPUAN)/COUNT(DISTINCT TCKIMLIKNO)	FROM #TEMPOGRENCIPUAN GNL	WHERE GNL.DERSAD= O.DERSAD								)
				FROM #TEMPOGRENCIPUAN	O
				WHERE O.TCKIMLIKNO = @TC_OGRENCI
				ORDER BY O.TCKIMLIKNO, O.DERSAD
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMPOGRENCIPUAN

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Reenabling DDL triggers...'
GO
ENABLE TRIGGER [CaptureStoredProcedureChanges] ON DATABASE
GO
PRINT N'Update complete.';


GO
