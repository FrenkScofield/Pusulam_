USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Abide]    Script Date: 22.11.2021 10:20:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Abide]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@AD					VARCHAR(MAX)	= NULL,
	@ID_ABIDESINAV		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@O_TCKIMLIKNO		VARCHAR(11)		= NULL,
	@DERS				VARCHAR(MAX)	= NULL,
	@ID_ABIDERESIM		INT				= NULL,
	@ID_ABIDESAYFATUR	INT				= NULL,
	@SIRA				INT				= NULL,
	@KITAPCIKSAYISI		INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@OVGORSUN			BIT				= NULL,
	@ID_ABIDEKITAPCIK	INT				= NULL,		
	@IP					VARCHAR(50)	= NULL
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
				,DONEM				= @DONEM
				,AD					= @AD
				,ID_ABIDESINAV		= @ID_ABIDESINAV
				,SQLJSON			= @SQLJSON
				,ID_SINIF			= @ID_SINIF
				,ID_SUBE			= @ID_SUBE
				,O_TCKIMLIKNO		= @O_TCKIMLIKNO
				,DERS				= @DERS
				,ID_ABIDERESIM		= @ID_ABIDERESIM
				,ID_ABIDESAYFATUR	= @ID_ABIDESAYFATUR
				,SIRA				= @SIRA
				,KITAPCIKSAYISI		= @KITAPCIKSAYISI
				,ID_KADEME3			= @ID_KADEME3
				,OVGORSUN			= @OVGORSUN
				,ID_ABIDEKITAPCIK	= @ID_ABIDEKITAPCIK
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    

		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		DECLARE @_ID_ABIDESINAV INT			= @ID_ABIDESINAV
		DECLARE @_ID_SINIF		INT			= @ID_SINIF
		DECLARE @_DONEM			VARCHAR(4)	= ISNULL(@DONEM, OkyanusDB.dbo.fn_AktifDonem() )

		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	SINAV TANIMLA
			BEGIN
				DECLARE @INSERTED TABLE(ID INT NOT NULL);  

				INSERT INTO AbideSinav(AD, DONEM, KYE_TCKIMLIKNO, ID_KADEME3)
				OUTPUT inserted.ID_ABIDESINAV
				INTO @INSERTED
				SELECT @AD, @DONEM, @TCKIMLIKNO, @ID_KADEME3

				DECLARE @cnt INT = 0;

				WHILE @cnt < @KITAPCIKSAYISI
				BEGIN
					INSERT INTO AbideKitapcik(ID_ABIDESINAV, AD)
					SELECT ID, CHAR(65 + @cnt) FROM @INSERTED
					SET @cnt = @cnt + 1;
				END;
			END

			IF @ISLEM = 2	--	SINAV LİSTELE
			BEGIN
				SELECT
				(
					SELECT	 S.ID_ABIDESINAV
							,S.AD
							,KADEME3		= K3.AD
							,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
							,ADSOYAD		= K.AD + ' ' + K.SOYAD 
							,KITAPCIKSAYISI	= (SELECT COUNT(*) FROM AbideKitapcik SK WHERE SK.ID_ABIDESINAV = S.ID_ABIDESINAV) 
							,S.OVGORSUN
					FROM AbideSinav S 
					INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.KYE_TCKIMLIKNO
					INNER JOIN v3Kademe3				 K3 ON K3.ID_KADEME3	= S.ID_KADEME3
					WHERE	S.DONEM		 = @DONEM 
						AND S.ID_KADEME3 = @ID_KADEME3
						AND S.AKTIF		 = 1 
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 3	--	SINAV DUZENLE
			BEGIN
				UPDATE AbideSinav SET 
					 AD			= @AD
					,ID_KADEME3 = @ID_KADEME3 
				WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				DECLARE @MEVCUTKITAPCIKSAYISI INT = (SELECT COUNT(*) FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV)

				IF @KITAPCIKSAYISI <> @MEVCUTKITAPCIKSAYISI
				BEGIN
					IF @KITAPCIKSAYISI > @MEVCUTKITAPCIKSAYISI
					BEGIN
						DECLARE @cntx INT = @MEVCUTKITAPCIKSAYISI;

						WHILE @cntx < @KITAPCIKSAYISI
						BEGIN
							INSERT INTO AbideKitapcik(ID_ABIDESINAV, AD)
							SELECT @ID_ABIDESINAV, CHAR(65 + @cntx)

							DECLARE @YENIID_ABIDEKITAPCIK INT = (SELECT ID_ABIDEKITAPCIK FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV AND AD = CHAR(65 + @cntx))

							IF EXISTS (SELECT * FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
							BEGIN
								INSERT INTO AbideSoruKarsilik(ID_ABIDESORU, ID_ABIDEKITAPCIK, SORUNO)
								SELECT S.ID_ABIDESORU, @YENIID_ABIDEKITAPCIK, S.SORUNO
								FROM AbideSoru S
							END
							
							SET @cntx = @cntx + 1;
						END;
					END
					ELSE
					BEGIN
						SELECT TOP(@MEVCUTKITAPCIKSAYISI - @KITAPCIKSAYISI) ID_ABIDEKITAPCIK 
						INTO #TEMPKITAPCIK
						FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV
						ORDER BY ID_ABIDEKITAPCIK DESC

						DELETE SK FROM AbideSoruKarsilik SK
						INNER JOIN #TEMPKITAPCIK K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK

						DELETE K FROM AbideKitapcik K
						INNER JOIN #TEMPKITAPCIK T ON T.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK
					END
				END
			END

			IF @ISLEM = 4	--	SINAV SİL
			BEGIN
				UPDATE AbideSinav SET AKTIF = 0 WHERE ID_ABIDESINAV = @ID_ABIDESINAV
			END

			IF @ISLEM = 5	--	SINAV EXCEL YÜKLE
			BEGIN
				IF EXISTS (	
							SELECT * FROM AbideOgrenci O 
							INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
							WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
						)
				BEGIN
					RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
				END
				ELSE
				BEGIN
					DELETE SK 
					FROM AbideSoruKarsilik	SK
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU	= SK.ID_ABIDESORU 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
				
					DELETE FROM AbideSoru		WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbideYorum		WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbidePuanAralik WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbideBeceri		WHERE ID_ABIDESINAV = @ID_ABIDESINAV

					DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  

					INSERT INTO AbideSoru (ID_ABIDESINAV, DERS, SORUNO, KAZANIM, BECERI, PUAN, ID_BILGI, ID_BILISSELSUREC)
					OUTPUT inserted.ID_ABIDESORU, inserted.SORUNO
					INTO @INSERTEDSORU
					SELECT @ID_ABIDESINAV, DERS, SORUNO, KAZANIM, BECERI, PUAN, ID_BILGI, ID_BILISSELSUREC 
					FROM OPENJSON(@SQLJSON, '$.SORULIST')
					WITH (
						DERS				VARCHAR(MAX),
						SORUNO				INT,
						KAZANIM				VARCHAR(MAX),
						BECERI				VARCHAR(MAX),
						PUAN				INT,
						ID_BILGI			INT,
						ID_BILISSELSUREC	INT
					)

					INSERT INTO AbideSoruKarsilik
					SELECT ID, K.ID_ABIDEKITAPCIK, S.SORUNO FROM @INSERTEDSORU S
					CROSS JOIN AbideKitapcik K WHERE K.ID_ABIDESINAV = @ID_ABIDESINAV
				
					INSERT INTO AbideYorum (ID_ABIDESINAV, DERS, DUZEY, YORUM, ONERI)
					SELECT @ID_ABIDESINAV, DERS, DUZEY, YORUM, ONERI FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
					WITH (
						DERS  VARCHAR(MAX),
						DUZEY VARCHAR(MAX),
						YORUM VARCHAR(MAX),
						ONERI VARCHAR(MAX)
					)
				
					INSERT INTO AbidePuanAralik(ID_ABIDESINAV, MAXIMUMPUAN, DUZEY)
					SELECT @ID_ABIDESINAV, MAXIMUMPUAN, DUZEY FROM OPENJSON(@SQLJSON, '$.PUANARALIKLIST')
					WITH (
						MAXIMUMPUAN INT,
						DUZEY		VARCHAR(MAX)
					)
				
					INSERT INTO AbideBeceri(ID_ABIDESINAV, DERS, BECERI, ACIKLAMA)
					SELECT @ID_ABIDESINAV, DERS, BECERI, ACIKLAMA FROM OPENJSON(@SQLJSON, '$.BECERILIST')
					WITH (
						DERS		VARCHAR(MAX),
						BECERI		VARCHAR(MAX),
						ACIKLAMA	VARCHAR(MAX)
					)
				END
			END

			IF @ISLEM = 6	--	SINAV EXCEL LİSTELE
			BEGIN
				SELECT
				(
					SELECT
					(SELECT [ID_ABIDESORU] ,[ID_ABIDESINAV] ,[DERS] ,[SORUNO] ,[KAZANIM] ,[BECERI] ,[PUAN] ,ID_BILGI = ISNULL([ID_BILGI], 0) ,ID_BILISSELSUREC = ISNULL([ID_BILISSELSUREC], 0) FROM [Pusulam].[dbo].[AbideSoru] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS SORULIST,
					(SELECT * FROM [Pusulam].[dbo].[AbideYorum] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS YORUMLIST,
					(SELECT * FROM [Pusulam].[dbo].[AbidePuanAralik] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS PUANARALIKLIST,
					(SELECT * FROM [Pusulam].[dbo].[AbideBeceri] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS BECERILIST
					FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
				)
			END

			IF @ISLEM = 7	--	ÖĞRENCİ LİSTELE
			BEGIN
			

				SELECT
				(
					SELECT	O.OGRNO 
							,O.TCKIMLIKNO
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT S.DERS, SUM(CASE WHEN AO.PUAN IS NULL THEN 0 ELSE 1 END) AS CEVAPSAYISI 
								FROM AbideSoru S
								LEFT JOIN AbideOgrenci AO ON AO.ID_ABIDESORU = S.ID_ABIDESORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
								WHERE S.ID_ABIDESINAV = @_ID_ABIDESINAV
								GROUP BY S.DERS
								FOR JSON PATH
							 ) AS CEVAP
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					WHERE O.ID_SINIF = @_ID_SINIF AND O.DONEM = @_DONEM
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8	--	ÖĞRENCİ PUAN LİSTELE
			BEGIN
				SELECT
				(
					SELECT S.ID_ABIDESORU, SK.SORUNO, S.KAZANIM, S.BECERI, S.PUAN AS MAXPUAN, AO.PUAN
					FROM AbideSoru S
					INNER JOIN AbideSoruKarsilik SK ON SK.ID_ABIDESORU = S.ID_ABIDESORU
					LEFT JOIN AbideOgrenci AO ON AO.ID_ABIDESORU = S.ID_ABIDESORU AND AO.TCKIMLIKNO = @O_TCKIMLIKNO AND AO.AKTIF = 1
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV AND S.DERS = @DERS AND (@ID_ABIDEKITAPCIK IS NULL OR SK.ID_ABIDEKITAPCIK = @ID_ABIDEKITAPCIK)
					ORDER BY SK.SORUNO
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 9	--	ÖĞRENCİ PUAN KAYDET
			BEGIN
				UPDATE AbideOgrenci SET AKTIF = 0 WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND ID_ABIDESORU IN (SELECT ID_ABIDESORU FROM OPENJSON(@SQLJSON) WITH (ID_ABIDESORU INT))

				INSERT INTO AbideOgrenci (ID_ABIDESORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO, ID_ABIDEKITAPCIK)
				SELECT ID_ABIDESORU, @O_TCKIMLIKNO, PUAN, @TCKIMLIKNO, @ID_ABIDEKITAPCIK FROM OPENJSON(@SQLJSON)
				WITH
				(
					ID_ABIDESORU INT,
					PUAN INT
				)
				WHERE PUAN IS NOT NULL
			END

			IF @ISLEM = 10	--	ÖĞRENCİ DERS PUAN SİL
			BEGIN
				UPDATE AO SET AO.AKTIF = 0 
				FROM AbideOgrenci AO 
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = AO.ID_ABIDESORU
				WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND S.DERS = @DERS AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			END

			IF @ISLEM = 11	--	RAPOR SAYFA TUR LİSTELE
			BEGIN
				
				DROP TABLE IF EXISTS #BOLUMNO11
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO11
				FROM AB

				SELECT * FROM (
					SELECT(
						SELECT
						(
							SELECT ST.ID_ABIDESAYFATUR
								,ST.AD
								,SIRA		= ISNULL(RD.SIRA, '')
								,RESIMGOR	= ISNULL(RD.RESIMGOR,0)
								,RD.AKTIF
								,ST.RESIMMI
								,RESIMLER	= (	SELECT	 R.ID_ABIDERESIM
														,R.SIRA
														,R.AD
														,R.ID_ABIDESAYFATUR 
														,R.DERS
												FROM AbideResim R 
												WHERE	R.ID_ABIDESAYFATUR	= ST.ID_ABIDESAYFATUR 
													AND R.ID_ABIDESINAV		= @ID_ABIDESINAV 
												ORDER BY SIRA 
												FOR JSON PATH, INCLUDE_NULL_VALUES
											)
							FROM AbideSayfaTur			ST
							LEFT JOIN AbideRaporDuzen	RD	ON	RD.ID_ABIDESAYFATUR = ST.ID_ABIDESAYFATUR 
															AND RD.ID_ABIDESINAV	= @ID_ABIDESINAV 
															AND RD.AKTIF			= 1
							ORDER BY ISNULL(CASE WHEN RD.SIRA = 0 THEN 999 ELSE RD.SIRA END, ST.ID_ABIDESAYFATUR)
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS LIST
						,(
							SELECT BOLUMNO, DERS, ID_ABIDESINAV
							FROM #BOLUMNO11
							ORDER BY BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS DERSLIST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)AS LIST
				)AS J
								
				DROP TABLE IF EXISTS #BOLUMNO11

			END

			IF @ISLEM = 12	--	RAPOR SAYFA SIRA KAYDET
			BEGIN
				UPDATE AbideRaporDuzen SET AKTIF = 0 WHERE ID_ABIDESINAV = @ID_ABIDESINAV
				DELETE AbideResim WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

				INSERT INTO AbideRaporDuzen(ID_ABIDESAYFATUR, ID_ABIDESINAV, SIRA, RESIMGOR)
				SELECT ID_ABIDESAYFATUR, @ID_ABIDESINAV, SIRA, RESIMGOR FROM OPENJSON(@SQLJSON)
				WITH
				(
					ID_ABIDESAYFATUR INT,
					RESIMGOR INT,
					SIRA INT
				)

				INSERT INTO AbideResim(ID_ABIDESINAV, ID_ABIDESAYFATUR, AD ,SIRA, DERS)
				SELECT	@ID_ABIDESINAV
						,JSON_Value (S.value, '$.ID_ABIDESAYFATUR') AS ID_ABIDESAYFATUR 
						,JSON_Value (S.value, '$.AD') AS AD 
						,JSON_Value (S.value, '$.SIRA') AS SIRA 
						,JSON_Value (S.value, '$.DERS') AS DERS 
				FROM OPENJSON (@SQLJSON) AS D
				CROSS APPLY OPENJSON (D.value, '$.RESIMLER') AS S
			END

			IF @ISLEM = 13	--	RESİM SİL
			BEGIN
				SELECT
				(
					SELECT AD, ID_ABIDESAYFATUR, ID_ABIDESINAV FROM AbideResim WHERE ID_ABIDERESIM = @ID_ABIDERESIM FOR JSON PATH, WITHOUT_ARRAY_WRAPPER 
				)
				DELETE FROM AbideResim WHERE ID_ABIDERESIM = @ID_ABIDERESIM
			END

			IF @ISLEM = 14	--	RESİM EKLE
			BEGIN
				INSERT INTO AbideResim(ID_ABIDESINAV, ID_ABIDESAYFATUR, AD ,SIRA,DERS)
				SELECT @ID_ABIDESINAV, @ID_ABIDESAYFATUR, @AD, @SIRA, @DERS
			END

			IF @ISLEM = 15	--	ÖĞRENCİ LİSTELE (RAPOR)
			BEGIN
				
				--DECLARE @ID_ABIDESINAV15	INT = @ID_ABIDESINAV
				--DECLARE @ID_SINIF15			INT = @ID_SINIF

				SELECT
				(
					SELECT	O.OGRNO 
							,O.TCKIMLIKNO
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT COUNT(1) 
								FROM AbideSoru S
								WHERE S.ID_ABIDESINAV = @_ID_ABIDESINAV 
								AND S.ID_ABIDESORU NOT IN (SELECT AO.ID_ABIDESORU FROM AbideOgrenci AO WHERE AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1)
							) AS GIRILMEYENCEVAPSAYISI
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					WHERE O.ID_SINIF = @_ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 16	--	RAPOR
			BEGIN

				DROP TABLE IF EXISTS #BOLUMNO
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO
				FROM AB


				DECLARE @SORUSAYISI INT = (SELECT COUNT(1) FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)



				
				SELECT	 K.TCKIMLIKNO
						,O.ID_SINIF
						,AD		= K.AD + ' ' + K.SOYAD
						,SUBE	= SB.AD 
						,SINIF	= S.AD
						,KADEME3= UPPER(K3.AD)
						,ID_KADEME
						,YARIYIL= IIF ( EXISTS (SELECT 1 FROM AbideSinav A WHERE A.ID_ABIDESINAV = @ID_ABIDESINAV AND MONTH(A.KYE_TARIH) IN (9,10,11,12,1)) , '1. DÖNEM' , '2. DÖNEM')
				INTO #OGRENCI
				FROM OkyanusDB.dbo.v3Kullanici			K
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO 
				INNER JOIN OkyanusDB.dbo.v3SinifTum		S	ON	S.ID_SINIF		= O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON	SB.ID_SUBE		= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= S.ID_SATISTURU
				INNER JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
				INNER JOIN OkyanusDB.dbo.v3Donem		D	ON	D.ID_DONEM		= O.ID_DONEM
															AND D.KOD			= O.DONEM
				WHERE	O.DONEM = @DONEM
					AND (@ID_SUBE		IS NULL OR @ID_SUBE			= 0  OR O.ID_SUBE	= @ID_SUBE		)
					AND (@ID_SINIF		IS NULL OR @ID_SINIF		= 0  OR O.ID_SINIF	= @ID_SINIF		)
					AND (@O_TCKIMLIKNO	IS NULL OR @O_TCKIMLIKNO	= '' OR K.TCKIMLIKNO= @O_TCKIMLIKNO	)

				SELECT * FROM #OGRENCI

				SELECT ST.ID_ABIDESAYFATUR
						,ST.AD
						,ST.RESIMMI
						,RD.SIRA
						,RD.RESIMGOR
				INTO #DUZEN
				FROM AbideRaporDuzen RD
				INNER JOIN AbideSayfaTur ST ON ST.ID_ABIDESAYFATUR = RD.ID_ABIDESAYFATUR
				WHERE RD.AKTIF = 1 AND RD.SIRA > 0 AND RD.ID_ABIDESINAV = @ID_ABIDESINAV
				
				SELECT * FROM #DUZEN ORDER BY SIRA

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 1)	--	Kapak Sayfa
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 1 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 2)	--	Önsöz
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 2 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 3)	--	Rapor Neyi İçerir
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 3 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 4)	--	Arka Kapak
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 4 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 5)	--	Beceri Adı ve Açıklama
				BEGIN

				
				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

					DECLARE @RESIMGOR INT = (SELECT TOP 1 ISNULL(RESIMGOR,0) FROM #DUZEN WHERE ID_ABIDESAYFATUR = 5)
									   
					SELECT T.*,B.BOLUMNO, @RESIMGOR AS RESIMGOR
					FROM AbideBeceri	T
					JOIN #BOLUMNO		B	ON	B.DERS	= T.DERS
					WHERE T.ID_ABIDESINAV = @ID_ABIDESINAV
					ORDER BY DERS, ID_ABIDEBECERI
										
					SELECT R.AD, R.DERS, B.BOLUMNO
					FROM AbideResim R 
					JOIN #BOLUMNO	B	ON	B.DERS	= R.DERS
					WHERE	R.ID_ABIDESINAV		= @ID_ABIDESINAV 
						AND R.ID_ABIDESAYFATUR	= 5
				END
				ELSE
				BEGIN
					SELECT 1
					
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 6)	--	Kazanım ve Alt Becerileri
				BEGIN
					SELECT *
					INTO #TEMP6
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 
	
					SELECT T.TCKIMLIKNO
							,CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END AS SORUNO
							,T.DERS
							,B.BOLUMNO
							,T.KAZANIM
							,T.BECERI
							,ISNULL((CASE	WHEN T.PUAN = AO.PUAN THEN ':)'
									WHEN AO.PUAN > 0 AND T.PUAN > AO.PUAN THEN ':|'
									WHEN AO.PUAN = 0 THEN ':(' 
								END), '') AS DURUM
					FROM #TEMP6				T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					LEFT JOIN AbideOgrenci	AO	ON	AO.TCKIMLIKNO = T.TCKIMLIKNO AND AO.ID_ABIDESORU = T.ID_ABIDESORU AND AO.AKTIF = 1
					ORDER BY TCKIMLIKNO, DERS, SORUNO

					DROP TABLE #TEMP6
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 7)	--	Soruların Çözülme Oranı
				BEGIN
					SELECT *
					INTO #TEMP7
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 	

					SELECT	 T.DERS
							,B.BOLUMNO
							,CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END AS SORUNO
							,T.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,AO.PUAN AS PUAN
							,T.PUAN AS MAXPUAN
							,T.ID_ABIDESORU
					INTO #OP
					FROM #TEMP7	T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = T.TCKIMLIKNO AND OO.DONEM = @DONEM
					LEFT JOIN AbideOgrenci AO ON AO.TCKIMLIKNO = T.TCKIMLIKNO AND AO.ID_ABIDESORU = T.ID_ABIDESORU AND AO.AKTIF = 1	

					SELECT   S.DERS
							,B.BOLUMNO
							,SK.SORUNO
							,O.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,O.PUAN
							,S.PUAN AS MAXPUAN
							,S.ID_ABIDESORU
					INTO #OPGENEL
					FROM AbideOgrenci O
					INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
					JOIN #BOLUMNO			B	ON	B.DERS	= S.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = @DONEM
					INNER JOIN AbideSoruKarsilik SK ON SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = O.ID_ABIDESORU
					WHERE O.AKTIF = 1 AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			
					SELECT	OP.TCKIMLIKNO
							,DERS
							,BOLUMNO
							,SORUNO
							,ID_ABIDESORU
							,OP.ID_SINIF
							,CASE WHEN PUAN IS NULL THEN '-' ELSE CAST(CONVERT(decimal(5,0), CAST(PUAN AS FLOAT) / CAST(MAXPUAN AS FLOAT) * 100.0) AS varchar) END AS OGRENCI 
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.ID_SINIF = OP.ID_SINIF AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS SINIF
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.ID_SUBE = OP.ID_SUBE AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS OKUL
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS GENEL
					FROM #OP AS OP
					INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = OP.TCKIMLIKNO
					ORDER BY OP.TCKIMLIKNO, DERS, SORUNO

					DROP TABLE #OP
					DROP TABLE #OPGENEL
					DROP TABLE #TEMP7
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 8)	--	Öğrenci Performansı
				BEGIN
					SELECT *
					INTO #TEMP8
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

					SELECT	T.TCKIMLIKNO
							,T.DERS
							,B.BOLUMNO
							,T.ID_ABIDESINAV
							,SUM(O.PUAN) AS PUAN
							,DUZEY	=	CASE	WHEN SUM(O.PUAN) IS NULL				THEN NULL 
												WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), '1') AS VARCHAR)												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					INTO #DERSPUAN
					FROM #TEMP8 T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					LEFT JOIN AbideOgrenci O ON O.TCKIMLIKNO = T.TCKIMLIKNO AND O.ID_ABIDESORU = T.ID_ABIDESORU AND O.AKTIF = 1
					GROUP BY T.TCKIMLIKNO, T.DERS, T.ID_ABIDESINAV,B.BOLUMNO, B.DERS

					SELECT	 DP.TCKIMLIKNO
							,DP.DERS
							,DP.BOLUMNO
							,ISNULL(DP.DUZEY + '. Düzey', '-') AS DUZEY
							,ISNULL(Y.YORUM, '-') AS YORUM
							,ISNULL(Y.ONERI, '-') AS ONERI
					FROM #DERSPUAN DP
					LEFT JOIN AbideYorum Y ON Y.DERS = DP.DERS AND Y.DUZEY = DP.DUZEY AND Y.ID_ABIDESINAV = DP.ID_ABIDESINAV
					ORDER BY DP.TCKIMLIKNO, DP.DERS					
					
					
					SELECT B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI, SUM(T.PUAN) MAXPUAN, SUM(O.PUAN) OGRPUAN, CAST( SUM(O.PUAN) / CAST(SUM(T.PUAN) AS float) * 100.0  AS decimal(8,2)) ORT
					FROM #TEMP8			T
					JOIN #BOLUMNO		B	ON	B.DERS			= T.DERS
					JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
											AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
											AND O.AKTIF			= 1
					GROUP BY B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI

					DROP TABLE #DERSPUAN
					DROP TABLE #TEMP8
				END
				ELSE
				BEGIN
					SELECT *
					FROM #BOLUMNO
					
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 9)	--	Grafiksel Gösterim (Her bir ders ayrı)
				BEGIN


--*********************************************************************************
					SELECT	O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)
							--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
							
							,DUZEY	=	CASE	WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') AS VARCHAR) 												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					FROM AbideOgrenci O
					INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO			B	ON	B.DERS	= S.DERS
					INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
					WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 10)	--	Grafiksel Gösterim (Tek grafikte tüm dersler)
				BEGIN
					SELECT	O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)
							
							,DUZEY	=	CASE WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1')
											 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') 
										END 
							--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
							,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
					FROM AbideOgrenci		O
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU	 = O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO		B	ON	B.DERS			 = S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV = S.ID_ABIDESINAV
					WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END
				ELSE
				BEGIN
					SELECT 1
				END

				SELECT   S.DERS
						,S.SORUNO
						,B.BOLUMNO
				FROM AbideSoru	S				
				JOIN #BOLUMNO	B	ON	B.DERS	= S.DERS
				WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

				DROP TABLE #DUZEN
				DROP TABLE #OGRENCI
				DROP TABLE #BOLUMNO

			END
						
			IF @ISLEM = 17	--	SINAV LİSTELE by OGRENCI
			BEGIN
				SELECT
				(
					SELECT DISTINCT S.ID_ABIDESINAV, S.AD, CONVERT(varchar, S.KYE_TARIH, 104) AS TARIH, K.AD + ' ' + K.SOYAD AS ADSOYAD,S.KYE_TARIH
					FROM AbideSinav		S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					JOIN AbideSoru		SO	ON	SO.ID_ABIDESINAV= S.ID_ABIDESINAV
					JOIN AbideOgrenci	O	ON	O.ID_ABIDESORU	= SO.ID_ABIDESORU
					WHERE	S.DONEM			= @DONEM 
						AND O.TCKIMLIKNO	= @O_TCKIMLIKNO
						AND S.AKTIF			= 1 
						AND S.OVGORSUN		= 1
					ORDER BY S.KYE_TARIH DESC
					FOR JSON PATH
				)
			END

			IF @ISLEM = 18	--	PUAN LİSTESİ GETİR (EXCEL)
			BEGIN
				SELECT DERS, MAX(SORUNO) AS SORUNO 
				FROM AbideSinav S
				INNER JOIN AbideSoru SS ON SS.ID_ABIDESINAV = S.ID_ABIDESINAV 
				WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
				GROUP BY DERS ORDER BY DERS

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DERS

				SELECT 
						SB.AD AS SUBE
						,K3.AD AS GRUP
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,SN.AD AS SINIF
						,SN.ID_SINIF
						,AO.TCKIMLIKNO
						,SORU.DERS
						,SORU.SORUNO
						,AO.PUAN
				INTO #TEMP
				FROM AbideOgrenci AO
				INNER JOIN AbideSoru SORU ON SORU.ID_ABIDESORU = AO.ID_ABIDESORU
				INNER JOIN AbideSinav SINAV ON SINAV.ID_ABIDESINAV = SORU.ID_ABIDESINAV
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = AO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = AO.TCKIMLIKNO AND O.DONEM = SINAV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = SN.ID_SATISTURU
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = ST.ID_KADEME3
				WHERE	SINAV.ID_ABIDESINAV = @ID_ABIDESINAV 
					AND SINAV.DONEM = @DONEM
					AND SINAV.AKTIF = 1 
					AND AO.AKTIF = 1
					AND (@ID_SUBE	IS NULL OR @ID_SUBE		= 0 OR O.ID_SUBE	= @ID_SUBE)
					AND (@ID_SINIF	IS NULL OR @ID_SINIF	= 0 OR O.ID_SINIF	= @ID_SINIF)

				DECLARE 
						@COLS AS NVARCHAR(MAX),
						@QUERY  AS NVARCHAR(MAX)

				SELECT DERS+'-'+CAST(SORUNO AS VARCHAR) AS DERS
				INTO #DERS
				FROM #TEMP
				GROUP BY DERS, SORUNO
				ORDER BY DERS, SORUNO

				SELECT @COLS = STUFF((SELECT ','+QUOTENAME(DERS2)+' VARCHAR(MAX) DEFAULT ''-''' 
									  FROM (
												SELECT
													T.DERS + '-' + CAST(T.SORUNO AS VARCHAR) AS DERS2
												FROM #TEMP T 
												GROUP BY T.DERS, T.SORUNO
											) AS S
										FOR XML PATH(''), TYPE
										).value('.', 'NVARCHAR(MAX)') 
									,1,1,'')

				SET @QUERY = '
					DROP TABLE IF EXISTS #T
					CREATE TABLE #T (SUBE VARCHAR(MAX), GRUP VARCHAR(MAX), ADSOYAD VARCHAR(MAX), SINIF VARCHAR(MAX), TCKIMLIKNO VARCHAR(MAX),' + @COLS + ')

					INSERT INTO #T (SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO)
					SELECT SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO FROM #TEMP

					WHILE EXISTS ( SELECT *  FROM #DERS)
					BEGIN

						DECLARE @DERSAD VARCHAR(100) = (SELECT TOP(1) DERS FROM #DERS ORDER BY DERS)	
						DECLARE @QUERY2 NVARCHAR(MAX)

						SET @QUERY2=	
						''
							UPDATE T
							SET T.[''+@DERSAD+''] = P.PUAN
							FROM #T T
							JOIN #TEMP P ON T.TCKIMLIKNO = P.TCKIMLIKNO AND P.DERS + ''''-'''' +  CAST(P.SORUNO AS VARCHAR) = ''''''+@DERSAD+''''''
						''
						EXEC sp_executesql @QUERY2; 

						DELETE FROM #DERS WHERE DERS = @DERSAD
					END
					SELECT DISTINCT * FROM #T
					DROP TABLE IF EXISTS #T
				'
				PRINT @QUERY
				EXEC sp_executesql @QUERY; 

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DERS
			END

			IF @ISLEM = 19	--	SINAV KARŞILIK YÜKLE
			BEGIN
				SELECT   ID_ABIDESINAV = JSON_Value (D.value, '$.ID_ABIDESINAV')
						,ID_ABIDESORU = JSON_Value (D.value, '$.ID_ABIDESORU')
						,ID_ABIDEKITAPCIK = JSON_Value (s.value, '$.ID_ABIDEKITAPCIK')
						,KITAPCIK = JSON_Value (s.value, '$.KITAPCIK')
						,SORUNO = JSON_Value (s.value, '$.SORUNO')
				INTO #TEMPKARSILIK
				FROM OPENJSON(@SQLJSON) d
				CROSS APPLY OPENJSON (d.value, '$.KARSILIKLIST') as s

				DELETE SK FROM AbideSoruKarsilik SK
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = SK.ID_ABIDESORU
				INNER JOIN AbideKitapcik K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK
				WHERE S.ID_ABIDESINAV = (SELECT TOP 1 ID_ABIDESINAV FROM #TEMPKARSILIK) AND K.AD <> 'A'

				--DELETE FROM AbideKitapcik WHERE ID_ABIDESINAV = (SELECT TOP 1 ID_ABIDESINAV FROM #TEMPKARSILIK) AND AD <> 'A'

				--DECLARE @INSERTEDKITAPCIK TABLE(ID_ABIDEKITAPCIK INT NOT NULL, KITAPCIK CHAR(1) NOT NULL);  

				--INSERT INTO AbideKitapcik (ID_ABIDESINAV, AD)
				--OUTPUT inserted.ID_ABIDEKITAPCIK, inserted.ad
				--INTO @INSERTEDKITAPCIK
				--SELECT DISTINCT ID_ABIDESINAV, KITAPCIK
				--FROM #TEMPKARSILIK

				INSERT INTO AbideSoruKarsilik(ID_ABIDESORU, ID_ABIDEKITAPCIK, SORUNO)
				SELECT T.ID_ABIDESORU, T.ID_ABIDEKITAPCIK, T.SORUNO
				FROM #TEMPKARSILIK T

				DROP TABLE #TEMPKARSILIK
			END

			IF @ISLEM = 20	--	SINAV KARŞILIK LİSTELE
			BEGIN
				SELECT
				(	
					SELECT  S.ID_ABIDESINAV, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.KAZANIM, S.BECERI, S.PUAN, 
							(
								SELECT K.ID_ABIDEKITAPCIK, SK.SORUNO, K.AD AS KITAPCIK FROM AbideSoruKarsilik SK
								INNER JOIN AbideKitapcik K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK AND K.ID_ABIDESINAV = S.ID_ABIDESINAV
								WHERE SK.ID_ABIDESORU = S.ID_ABIDESORU AND K.AD <> 'A'
								FOR JSON PATH
							) AS KARSILIKLIST
					FROM AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH
				)
			END

			IF @ISLEM = 21	--	SINAV KİTAPÇIK LİSTELE
			BEGIN
				SELECT	DISTINCT K.ID_ABIDEKITAPCIK
						,K.AD
						,CASE WHEN EXISTS(	
							SELECT 1 
							FROM AbideOgrenci O 
							INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
							WHERE O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND S.DERS = @DERS AND O.TCKIMLIKNO = @O_TCKIMLIKNO AND O.AKTIF = 1
						)
						THEN 1
						ELSE 0 
						END AS SECILI
				INTO #TEMPKITAPCIKSEC
				FROM AbideKitapcik K
				WHERE K.ID_ABIDESINAV = @ID_ABIDESINAV

				--IF NOT EXISTS (SELECT * FROM #TEMPKITAPCIKSEC WHERE SECILI = 1)
				--BEGIN
				--	UPDATE #TEMPKITAPCIKSEC SET SECILI = 1 WHERE AD = 'A'
				--END

				SELECT
				(
					SELECT * FROM #TEMPKITAPCIKSEC
					ORDER BY AD
					FOR JSON PATH
				)

				DROP TABLE #TEMPKITAPCIKSEC
			END

			IF @ISLEM = 22	--	PUANA GÖRE SIRALI GENEL SONUÇ LİSTELERİ
			BEGIN
				SELECT SNV.ID_ABIDESINAV, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, K.AD AS KITAPCIK, SK.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN AbideSoruKarsilik			SK	ON SK.ID_ABIDESORU = S.ID_ABIDESORU AND SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SNV.ID_ABIDESINAV = @ID_ABIDESINAV AND (@ID_KADEME3 = 0 OR SGS.ID_KADEME3 = @ID_KADEME3)

				SELECT * 
				FROM #OGRENCISORULIST
				ORDER BY KAMPUS, SINIF, TCKIMLIKNO, DERS, SORUNO

				SELECT 
					 TCKIMLIKNO
					,DERS
					,SUM(PUAN) AS TOPLAMPUAN
					,SUM(MAXPUAN) AS TOPLAMMAXPUAN
					,MAX(SORUNO) AS SORUSAYISI
					--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), 1) AS DUZEY					
					,DUZEY	=	CASE WHEN O.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') 
										THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), '1')  
									 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV),'1') 
								END 
				INTO #OGRENCILIST
				FROM #OGRENCISORULIST O
				GROUP BY TCKIMLIKNO, DERS, ID_ABIDESINAV


				SELECT   TCKIMLIKNO
						,DERS
						,TOPLAMPUAN
						,DUZEY 
						,SORUSAYISI
						,TOPLAMMAXPUAN
				FROM #OGRENCILIST ORDER BY DERS, TCKIMLIKNO DESC

				SELECT DERS, SORUSAYISI, TOPLAMMAXPUAN FROM #OGRENCILIST GROUP BY DERS, SORUSAYISI, TOPLAMMAXPUAN ORDER BY DERS

				DROP TABLE #OGRENCISORULIST
				DROP TABLE #OGRENCILIST
			END

			IF @ISLEM = 23	--	SINIFLARA GÖRE SORULARIN ÇÖZÜLME ORANLARI
			BEGIN
				SELECT SNV.ID_ABIDESINAV, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST2
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SNV.ID_ABIDESINAV = @ID_ABIDESINAV AND (@ID_KADEME3 = 0 OR SGS.ID_KADEME3 = @ID_KADEME3)

				SELECT OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, OS.KAMPUS, OS.SINIF, CONVERT(decimal(18,2), (CAST(SUM(OS.PUAN) AS FLOAT) / CAST(SUM(OS.MAXPUAN) AS FLOAT) * 100.0)) AS ORAN
				FROM #OGRENCISORULIST2 OS
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = OS.ID_ABIDESORU
				GROUP BY OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, OS.KAMPUS, OS.SINIF
				
				SELECT OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, 'GENEL', 'GENEL', CONVERT(decimal(18,2), (CAST(SUM(OS.PUAN) AS FLOAT) / CAST(SUM(OS.MAXPUAN) AS FLOAT) * 100.0)) AS ORAN
				FROM #OGRENCISORULIST2 OS
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = OS.ID_ABIDESORU
				GROUP BY OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM
				ORDER BY DERS, SORUNO
				
				SELECT KAMPUS, SINIF FROM #OGRENCISORULIST2 GROUP BY KAMPUS, SINIF ORDER BY KAMPUS, SINIF
				SELECT DERS, MAX(SORUNO) AS SORUSAYISI FROM #OGRENCISORULIST2 GROUP BY DERS ORDER BY DERS

				DROP TABLE #OGRENCISORULIST2
			END

			IF @ISLEM = 24	--	Yeterlilik Düzeylerine Göre Kampüs Öğrenci Sayıları
			BEGIN
			
				DECLARE @ID_KADEME3_ INT = @ID_KADEME3
				DECLARE @ID_ABIDESINAV_ INT = @ID_ABIDESINAV
				DECLARE @DONEM_ VARCHAR(4) = @DONEM

				SELECT SNV.ID_ABIDESINAV, SNV.AD AS SINAVAD, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST3
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SGS.ID_KADEME3 = @ID_KADEME3 AND (@ID_ABIDESINAV = 0 OR SNV.ID_ABIDESINAV = @ID_ABIDESINAV) AND SNV.DONEM = @DONEM

				SELECT 
					 SINAVAD
					,DERS
					,KAMPUS
					,TCKIMLIKNO					
					,DUZEY	=	CASE WHEN O.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') 
										THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), '1')  
								  	 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV),'1') 
								END 
				INTO #OGRENCILIST3
				FROM #OGRENCISORULIST3 O
				GROUP BY KAMPUS, TCKIMLIKNO, DERS, ID_ABIDESINAV, SINAVAD
				ORDER BY SINAVAD, DERS, KAMPUS, TCKIMLIKNO

				--DÜZEY ÖĞRENCİ SAYILARI KAMPÜS--
				SELECT DERS, SINAVAD, KAMPUS, DUZEY, COUNT(1) AS DUZEYOGRENCISAYISI
				INTO #KAMPUSDUZEYOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, SINAVAD, KAMPUS, DUZEY
				ORDER BY DERS, SINAVAD, KAMPUS, DUZEY

				--TOPLAM ÖĞRENCİ SAYILARI KAMPÜS--
				SELECT DERS, KAMPUS, COUNT(1) AS TOPLAMOGRENCISAYISI
				INTO #KAMPUSTOPLAMOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, KAMPUS
				ORDER BY DERS, KAMPUS

				--DÜZEY ÖĞRENCİ SAYILARI--
				SELECT DERS, SINAVAD, DUZEY, COUNT(1) AS DUZEYOGRENCISAYISI
				INTO #DUZEYOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, SINAVAD, DUZEY
				ORDER BY DERS, SINAVAD, DUZEY

				--TOPLAM ÖĞRENCİ SAYILARI--
				SELECT DERS, COUNT(1) AS TOPLAMOGRENCISAYISI
				INTO #TOPLAMOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS
				ORDER BY DERS

				--SONUÇ--
				SELECT 1 AS TUR, TOS.DERS, TOS.KAMPUS, TOS.TOPLAMOGRENCISAYISI, DOS.DUZEY, DOS.SINAVAD, DOS.DUZEYOGRENCISAYISI, CONVERT(DECIMAL(18,2), (CAST(DOS.DUZEYOGRENCISAYISI AS FLOAT) / CAST(TOS.TOPLAMOGRENCISAYISI AS FLOAT) * 100.0)) AS ORAN
				FROM #KAMPUSDUZEYOGRENCISAYILIST DOS
				INNER JOIN #KAMPUSTOPLAMOGRENCISAYILIST TOS ON TOS.KAMPUS = DOS.KAMPUS AND TOS.DERS = DOS.DERS
				UNION
				SELECT 2 AS TUR, TOS.DERS, 'TOPLAM', TOS.TOPLAMOGRENCISAYISI, DOS.DUZEY, DOS.SINAVAD, DOS.DUZEYOGRENCISAYISI, CONVERT(DECIMAL(18,2), (CAST(DOS.DUZEYOGRENCISAYISI AS FLOAT) / CAST(TOS.TOPLAMOGRENCISAYISI AS FLOAT) * 100.0)) AS ORAN
				FROM #DUZEYOGRENCISAYILIST DOS
				INNER JOIN #TOPLAMOGRENCISAYILIST TOS ON TOS.DERS = DOS.DERS
				ORDER BY DERS, TUR, KAMPUS, SINAVAD, DUZEY

				SELECT DUZEY FROM #DUZEYOGRENCISAYILIST GROUP BY DUZEY ORDER BY DUZEY
				SELECT KAMPUS FROM #KAMPUSDUZEYOGRENCISAYILIST GROUP BY KAMPUS ORDER BY KAMPUS
				SELECT SINAVAD FROM #DUZEYOGRENCISAYILIST GROUP BY SINAVAD ORDER BY SINAVAD
				SELECT DERS FROM #DUZEYOGRENCISAYILIST GROUP BY DERS ORDER BY DERS

				DROP TABLE #OGRENCISORULIST3
				DROP TABLE #OGRENCILIST3
				DROP TABLE #KAMPUSDUZEYOGRENCISAYILIST
				DROP TABLE #KAMPUSTOPLAMOGRENCISAYILIST
				DROP TABLE #DUZEYOGRENCISAYILIST
				DROP TABLE #TOPLAMOGRENCISAYILIST
			END
						
			IF @ISLEM = 25	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE AbideSinav SET OVGORSUN = @OVGORSUN WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				select 1
			END

			IF @ISLEM = 26	--	RAPOR ÖĞRENCİ HTML(JSON)
			BEGIN
				DROP TABLE IF EXISTS #BOLUMNO26
				DROP TABLE IF EXISTS #DUZEN26
				DROP TABLE IF EXISTS #OGRENCI26
				DROP TABLE IF EXISTS #TEMP5_1_26
				DROP TABLE IF EXISTS #TEMP5_2_26
				DROP TABLE IF EXISTS #TEMP6_26
				DROP TABLE IF EXISTS #TEMP7_26
				DROP TABLE IF EXISTS #TEMP8_1_26
				DROP TABLE IF EXISTS #TEMP8_2_26
				DROP TABLE IF EXISTS #TEMP9_26
				DROP TABLE IF EXISTS #TEMP10_26
				--DROP TABLE IF EXISTS #TEMP_SON_26
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO26
				FROM AB
				ORDER BY BOLUMNO

				--DECLARE @SORUSAYISI INT = (SELECT COUNT(1) FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
				
				SELECT DISTINCT
					 TCKIMLIKNO	= OD.TCKIMLIKNO
					,ID_SINIF	= OD.ID_SINIF
					,AD			= OD.AD + ' ' + OD.SOYAD
					,SUBE		= OD.SUBEAD
					,SINIF		= OD.SINIFAD
					,KADEME3	= UPPER(OD.KADEME3)
					,ID_KADEME	= KB.ID_KADEME
					,YARIYIL	= IIF ( EXISTS (SELECT TOP 1 1 FROM AbideSinav A WHERE A.ID_ABIDESINAV = @ID_ABIDESINAV AND MONTH(A.KYE_TARIH) IN (9,10,11,12,1)) , '1. DÖNEM' , '2. DÖNEM')
				INTO #OGRENCI26
				FROM OkyanusDB..vw_OgrenciDetayTum	OD
				JOIN OkyanusDB..v3KademeBilgi		KB	ON	KB.ID_KADEME3	= OD.ID_KADEME3
				WHERE	OD.DONEM = @_DONEM
					AND (@ID_SUBE		IS NULL OR @ID_SUBE			= 0  OR OD.ID_SUBE		= @ID_SUBE		)
					AND (@ID_SINIF		IS NULL OR @ID_SINIF		= 0  OR OD.ID_SINIF		= @ID_SINIF		)
					AND (@O_TCKIMLIKNO	IS NULL OR @O_TCKIMLIKNO	= '' OR OD.TCKIMLIKNO	= @O_TCKIMLIKNO	)
	
				SELECT	 ST.ID_ABIDESAYFATUR
						,ST.AD
						,ST.RESIMMI
						,RD.SIRA
						,RD.RESIMGOR
				INTO #DUZEN26
				FROM AbideRaporDuzen	RD
				JOIN AbideSayfaTur		ST	ON	ST.ID_ABIDESAYFATUR	= RD.ID_ABIDESAYFATUR
				WHERE	RD.AKTIF		= 1 
					AND RD.SIRA			> 0 
					AND RD.ID_ABIDESINAV= @ID_ABIDESINAV
					AND ST.ID_ABIDESAYFATUR NOT IN (1,2,3,4)

				
				-- CREATE TEMP TABLE
				BEGIN
				CREATE TABLE #TEMP5_1_26 
				(	
					 ID_ABIDEBECERI	INT
					,ID_ABIDESINAV	INT
					,DERS			VARCHAR(MAX)
					,BECERI			VARCHAR(MAX)
					,ACIKLAMA		VARCHAR(MAX)
					,BOLUMNO		INT
					,RESIMGOR		INT
				)

				CREATE TABLE #TEMP5_2_26 (
					AD	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT
				)
				END
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 5)	--	Beceri Adı ve Açıklama							
				BEGIN

				
				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

					DECLARE @RESIMGOR_26 INT = (SELECT TOP 1 ISNULL(RESIMGOR,0) FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 5)
									   
					INSERT INTO #TEMP5_1_26
					SELECT	 T.ID_ABIDEBECERI
							,T.ID_ABIDESINAV
							,T.DERS
							,T.BECERI
							,T.ACIKLAMA
							,B.BOLUMNO
							,RESIMGOR	= @RESIMGOR_26
					FROM AbideBeceri	T
					JOIN #BOLUMNO26		B	ON	B.DERS	= T.DERS
					WHERE T.ID_ABIDESINAV = @ID_ABIDESINAV
					ORDER BY DERS, ID_ABIDEBECERI
										
					INSERT INTO #TEMP5_2_26
					SELECT R.AD, R.DERS, B.BOLUMNO
					FROM AbideResim R 
					JOIN #BOLUMNO26	B	ON	B.DERS	= R.DERS
					WHERE	R.ID_ABIDESINAV		= @ID_ABIDESINAV 
						AND R.ID_ABIDESAYFATUR	= 5
				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP6_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SORUNO		INT,
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					KAZANIM		VARCHAR(MAX),
					BECERI		VARCHAR(MAX),
					DURUM		VARCHAR(2),
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 6)	--	Kazanım ve Alt Becerileri						
				BEGIN

	
					;WITH TEMP6 AS(
						SELECT O.TCKIMLIKNO, S.SORUNO, S.DERS, S.KAZANIM, S.BECERI, S.PUAN, S.ID_ABIDESORU		
						FROM #OGRENCI26		 O
						CROSS JOIN AbideSoru S 
						WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 
					)
					INSERT INTO #TEMP6_26
					SELECT   T.TCKIMLIKNO
							,SORUNO	= CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END 
							,T.DERS
							,B.BOLUMNO
							,T.KAZANIM
							,T.BECERI
							,DURUM	= ISNULL((CASE	WHEN T.PUAN = AO.PUAN THEN ':)'
													WHEN AO.PUAN > 0 AND T.PUAN > AO.PUAN THEN ':|'
													WHEN AO.PUAN = 0 THEN ':(' 
												END), '')
					FROM TEMP6				T
					JOIN #BOLUMNO26			B	ON	B.DERS			= T.DERS
					LEFT JOIN AbideOgrenci	AO	ON	AO.TCKIMLIKNO	= T.TCKIMLIKNO 
												AND AO.ID_ABIDESORU = T.ID_ABIDESORU 
												AND AO.AKTIF		= 1
					ORDER BY TCKIMLIKNO, DERS, SORUNO

				END


				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP7_26 (
					TCKIMLIKNO		VARCHAR(MAX),
					DERS			VARCHAR(MAX),
					BOLUMNO			INT,
					SORUNO			INT,
					ID_ABIDESORU	INT,
					ID_SINIF		INT,
					OGRENCI			VARCHAR(MAX),
					SINIF			decimal(5,0),
					OKUL			decimal(5,0),
					GENEL			decimal(5,0)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 7)	--	Soruların Çözülme Oranı							
				BEGIN
	
					WITH TEMP7 AS (
						SELECT O.TCKIMLIKNO, S.DERS, S.SORUNO, S.PUAN, S.ID_ABIDESORU	
						FROM #OGRENCI26 O
						CROSS JOIN AbideSoru S 
						WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 	
					)
					SELECT	 T.DERS
							,B.BOLUMNO
							,SORUNO	= CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END
							,T.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,AO.PUAN
							,MAXPUAN	= T.PUAN 
							,T.ID_ABIDESORU
					INTO #OP26
					FROM TEMP7	T
					JOIN #BOLUMNO26							B	ON	B.DERS			= T.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON	OO.TCKIMLIKNO	= T.TCKIMLIKNO 
																AND OO.DONEM		= @_DONEM
					LEFT JOIN AbideOgrenci					AO	ON	AO.TCKIMLIKNO	= T.TCKIMLIKNO 
																AND AO.ID_ABIDESORU = T.ID_ABIDESORU 
																AND AO.AKTIF		= 1	

					SELECT   S.DERS
							,B.BOLUMNO
							,SK.SORUNO
							,O.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,O.PUAN
							,MAXPUAN	= S.PUAN 
							,S.ID_ABIDESORU
					INTO #OPGENEL26
					FROM AbideOgrenci						O
					INNER JOIN AbideSoru					S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					JOIN #BOLUMNO26							B	ON	B.DERS				= S.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON	OO.TCKIMLIKNO		= O.TCKIMLIKNO 
																AND OO.DONEM			= @_DONEM
					INNER JOIN AbideSoruKarsilik			SK	ON	SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK 
																AND SK.ID_ABIDESORU		= O.ID_ABIDESORU
					WHERE	O.AKTIF			= 1 
						AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			
					INSERT INTO #TEMP7_26
					SELECT	OP.TCKIMLIKNO
							,DERS
							,BOLUMNO
							,SORUNO
							,ID_ABIDESORU
							,OP.ID_SINIF
							,OGRENCI= CASE WHEN PUAN IS NULL THEN '-' ELSE CAST(CONVERT(decimal(5,0), CAST(PUAN AS FLOAT) / CAST(MAXPUAN AS FLOAT) * 100.0) AS varchar) END 
							,SINIF	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.ID_SINIF = OP.ID_SINIF AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
							,OKUL	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.ID_SUBE = OP.ID_SUBE AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
							,GENEL	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
					FROM #OP26			OP
					INNER JOIN #OGRENCI26 O	ON	O.TCKIMLIKNO	= OP.TCKIMLIKNO
					ORDER BY OP.TCKIMLIKNO, DERS, SORUNO

					DROP TABLE IF EXISTS #OP26
					DROP TABLE IF EXISTS #OPGENEL26
				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP8_1_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX),
					YORUM		VARCHAR(MAX),
					ONERI		VARCHAR(MAX)
				)
				CREATE TABLE #TEMP8_2_26 (
					BOLUMNO		INT,
					TCKIMLIKNO	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BECERI		VARCHAR(MAX),
					MAXPUAN		INT,
					OGRPUAN		INT,
					ORT			decimal(8,2)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 8)	--	Öğrenci Performansı								
				BEGIN
					SELECT O.TCKIMLIKNO, S.DERS, S.ID_ABIDESINAV, S.ID_ABIDESORU, S.BECERI, S.PUAN
					INTO #TEMP8_26
					FROM #OGRENCI26 O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

					SELECT	T.TCKIMLIKNO
							,T.DERS
							,B.BOLUMNO
							,T.ID_ABIDESINAV
							,SUM(O.PUAN) AS PUAN
							,DUZEY	=	CASE	WHEN SUM(O.PUAN) IS NULL				THEN NULL 
												WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), '1') AS VARCHAR)												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					INTO #DERSPUAN26
					FROM #TEMP8_26			T
					JOIN #BOLUMNO26			B	ON	B.DERS			= T.DERS
					LEFT JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
												AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
												AND O.AKTIF			= 1
					GROUP BY T.TCKIMLIKNO, T.DERS, T.ID_ABIDESINAV,B.BOLUMNO, B.DERS

					INSERT INTO #TEMP8_1_26
					SELECT	 DP.TCKIMLIKNO
							,DP.DERS
							,DP.BOLUMNO
							,DUZEY	= ISNULL(DP.DUZEY + '. Düzey', '-')
							,YORUM	= REPLACE( ISNULL(Y.YORUM, '-'),N'*','<br>*') 
							,ONERI	= REPLACE( ISNULL(Y.ONERI, '-'),N'*','<br>*')
					FROM #DERSPUAN26 DP
					LEFT JOIN AbideYorum Y ON Y.DERS = DP.DERS AND Y.DUZEY = DP.DUZEY AND Y.ID_ABIDESINAV = DP.ID_ABIDESINAV
					ORDER BY DP.TCKIMLIKNO, DP.DERS					
					
					
					INSERT INTO #TEMP8_2_26
					SELECT	 B.BOLUMNO
							,T.TCKIMLIKNO
							, T.DERS
							, T.BECERI
							, SUM(T.PUAN) MAXPUAN
							, SUM(O.PUAN) OGRPUAN
							, CAST( SUM(O.PUAN) / CAST(SUM(T.PUAN) AS float) * 100.0  AS decimal(8,2)) ORT
					FROM #TEMP8_26		T
					JOIN #BOLUMNO26		B	ON	B.DERS			= T.DERS
					JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
											AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
											AND O.AKTIF			= 1
					GROUP BY B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI

					DROP TABLE IF EXISTS #DERSPUAN26
					DROP TABLE IF EXISTS #TEMP8_26
				END		

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP9_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SINAV		VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 9)	--	Grafiksel Gösterim (Her bir ders ayrı)			
				BEGIN

					INSERT INTO #TEMP9_26
					SELECT	 O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)							
							,DUZEY	=	CASE	WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN 
													CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') AS VARCHAR) 												
												ELSE 
													CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 	
					FROM AbideOgrenci		O
					INNER JOIN #OGRENCI26		SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO26		B	ON	B.DERS				= S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV	= S.ID_ABIDESINAV
					WHERE	O.AKTIF = 1 
						AND SN.AKTIF = 1
						--AND EXISTS (SELECT TOP 1 1 FROM #OGRENCI26 SO WHERE SO.TCKIMLIKNO = O.TCKIMLIKNO) 
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC

				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP10_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SINAV		VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX),
					MAXDUZEY	VARCHAR(MAX)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 10)--	Grafiksel Gösterim (Tek grafikte tüm dersler)	
				BEGIN
					INSERT INTO #TEMP10_26
					SELECT	 O.TCKIMLIKNO
							,SINAV		= SN.AD
							,S.DERS
							,BOLUMNO	= ISNULL(B.BOLUMNO, 999)
							
							,DUZEY		=	CASE WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN 
													 ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1')
												ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') 
											END 
							,MAXDUZEY	= (SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV)
					FROM AbideOgrenci		O
					INNER JOIN #OGRENCI26		SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO26		B	ON	B.DERS				= S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV	= S.ID_ABIDESINAV
					WHERE	O.AKTIF		= 1 
						AND SN.AKTIF	= 1
						--O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI26) AND 
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END

				--SELECT   S.DERS
				--		,S.SORUNO
				--		,B.BOLUMNO
				--INTO #TEMP_SON_26
				--FROM AbideSoru	S				
				--JOIN #BOLUMNO26	B	ON	B.DERS	= S.DERS
				--WHERE S.ID_ABIDESINAV	= @ID_ABIDESINAV

				SELECT (
					SELECT (	SELECT *, SINAVAD = (SELECT AD FROM AbideSinav WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
								FROM #OGRENCI26
								FOR JSON PATH
							) OGRENCI,
							(	SELECT * FROM #DUZEN26 --ORDER BY SIRA
								FOR JSON PATH
							) DUZEN,
							(SELECT	 DERS
									,BOLUMNO
									,BECERI				= JSON_QUERY(IIF (NOT EXISTS(SELECT TOP 1 1 FROM #TEMP5_1_26),
																NULL,
																(SELECT 
																	(	SELECT *
																		FROM #TEMP5_1_26	T
																		WHERE T.BOLUMNO = B.BOLUMNO
																		FOR JSON PATH
																	  ) AS BECERI,
																	  (	SELECT *
																		FROM #TEMP5_2_26	T
																		WHERE T.BOLUMNO = B.BOLUMNO
																		FOR JSON PATH
																	  ) AS RESIM
																	FOR JSON PATH
																)
															))
									,KAZANIMALTBECERI	= (	SELECT *
															FROM #TEMP6_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,SORUCOZULMEORANI	= (	SELECT *
															FROM #TEMP7_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,OGRENCIPERFORMANS	= JSON_QUERY(IIF (NOT EXISTS(SELECT TOP 1 1 FROM #TEMP8_1_26),NULL,
														(SELECT 
															(	SELECT *
																FROM #TEMP8_1_26	T
																WHERE T.BOLUMNO = B.BOLUMNO
																FOR JSON PATH
															  ) AS ONERI,
															  (	SELECT *
																FROM #TEMP8_2_26	T
																WHERE T.BOLUMNO = B.BOLUMNO
																FOR JSON PATH
															  ) AS PUAN
															FOR JSON PATH
															)))
									,GRAFIK				= (	SELECT *
															FROM #TEMP9_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,TEKGRAFIK			= (	SELECT *
															FROM #TEMP10_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									--,SORULIST			= (	SELECT *
									--						FROM #TEMP_SON_26	T
									--						WHERE T.BOLUMNO = B.BOLUMNO
									--						FOR JSON PATH
									--					  )
								FROM #BOLUMNO26	B
								FOR JSON PATH
								) DERS
					FOR JSON PATH
				)

				DROP TABLE IF EXISTS #BOLUMNO26
				DROP TABLE IF EXISTS #DUZEN26
				DROP TABLE IF EXISTS #OGRENCI26
				DROP TABLE IF EXISTS #TEMP5_1_26
				DROP TABLE IF EXISTS #TEMP5_2_26
				DROP TABLE IF EXISTS #TEMP6_26
				DROP TABLE IF EXISTS #TEMP7_26
				DROP TABLE IF EXISTS #TEMP8_1_26
				DROP TABLE IF EXISTS #TEMP8_2_26
				DROP TABLE IF EXISTS #TEMP9_26
				DROP TABLE IF EXISTS #TEMP10_26
				--DROP TABLE IF EXISTS #TEMP_SON_26

			END

			IF @ISLEM = 27  -- Abide Bildirim Listele
			BEGIN
				SELECT ISNULL((
		        	 SELECT DISTINCT
		        		 TC_GONDEREN		= '14531453'
		        		,TC_ALAN			= OV.TCKIMLIKNO
		        		,MESAJ				= S.AD +' Upgrade sınav sonucunuzu Okyanus Pusulam sistemimizden inceleyebilirsiniz'
		        	 FROM dbo.AbideSinav			S
		        	 JOIN dbo.AbideSoru				SS ON SS.ID_ABIDESINAV		= S.ID_ABIDESINAV
		        	 JOIN dbo.AbideOgrenci			AO ON AO.ID_ABIDESORU	    = SS.ID_ABIDESORU
		        	 JOIN dbo.v3OgrenciVeli			OV ON OV.TCKIMLIKNO_OGR     = AO.TCKIMLIKNO
		        	 WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
		        	 FOR JSON AUTO
		        ),'[]')
			END
		END
	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AkilliOgretimBarkod]    Script Date: 22.11.2021 10:31:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AkilliOgretimBarkod]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	EXCEL YÜKLE
			BEGIN
				
				DELETE FROM AkilliOgretimBarkod
				INSERT INTO AkilliOgretimBarkod (ALTKONUKOD, AKILLIOGRETIMBARKODKOD)
				SELECT ALTKONUKOD, AKILLIOGRETIMBARKODKOD
				FROM OPENJSON(@SQLJSON)
				WITH(
					ALTKONUKOD				VARCHAR(MAX),	
					AKILLIOGRETIMBARKODKOD	VARCHAR(MAX)
				)

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AraKarne]    Script Date: 22.11.2021 10:32:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AraKarne]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	--@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	
		ISLEM					= @ISLEM			
		,TCKIMLIKNO				= @TCKIMLIKNO		
		,TC_OGRENCI				= @TC_OGRENCI		
		,OTURUM					= @OTURUM			
		,IL						= @IL				
		,ILCE					= @ILCE			
		,ID_MENU				= @ID_MENU		
		,DONEM					= @DONEM			
		,ID_KADEME3				= @ID_KADEME3		
		,ID_SINAVTURU			= @ID_SINAVTURU	
		,ID_SINAV				= @ID_SINAV		
		,ID_DERS				= @ID_DERS		
		,ID_SUBE				= @ID_SUBE		
		,ID_SINIF				= @ID_SINIF		
		,DOSYAADI				= @DOSYAADI		
		,DOSYAGUID				= @DOSYAGUID		
		,ID_SINAVDOSYA			= @ID_SINAVDOSYA	
		,SQLJSON				= @SQLJSON		
		
		 					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--exec sp_AraKarne @ISLEM=2

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP= @IP
 
	DECLARE @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM VARCHAR(4)=@DONEM,@sTC_OGRENCI VARCHAR(11)=@TC_OGRENCI
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END

	IF @ID_LOG > 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)	--	ARA KARNE DENEME SINAVLARI
		BEGIN
			DROP TABLE IF EXISTS #SINAVOGRENCI
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #Y1
			DROP TABLE IF EXISTS #Y2
			DROP TABLE IF EXISTS #Y3

			SET @ID_KADEME3 = (
								SELECT SG.ID_KADEME3 
								FROM OkyanusDB.dbo.v3OgrenciTum			OT
								JOIN OkyanusDB.dbo.v3SubeGrupSinifTum	SG	ON	SG.ID_SINIF		= OT.ID_SINIF
								WHERE OT.DONEM = @DONEM AND OT.TCKIMLIKNO = @TC_OGRENCI)

			SELECT DISTINCT	 SO.ID_SINAV
					,SO.ID_SINAVDERS
					,SO.TCKIMLIKNO
					,SO.DOGRU
					,SO.YANLIS
					,SO.BOS
					,SO.NET
					,DERSAD		= D.TAKMAAD
					,SINAVAD	= S.AD
					,DERSPUAN	= SO.PUAN
					,S.ID_SINAVTURU
					,S.PUANGIZLE
					,S.SINAVTARIH
					,S.OLCEKSINAVI
			INTO #SINAVOGRENCI
			FROM vw_SinavOgrenciBolum		SO
			JOIN Sinav						S	ON	S.ID_SINAV		= SO.ID_SINAV				
			JOIN SinavDers					D	ON	D.ID_SINAV		= SO.ID_SINAV
												AND D.ID_SINAVDERS	= SO.ID_SINAVDERS
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND S.DONEM			= @DONEM 
				AND S.ID_KADEME3	= @ID_KADEME3		
				AND (OZEL=0			OR @OZELSINAVGOR=1)
				AND SO.TCKIMLIKNO	= @TC_OGRENCI
			

			SELECT 	 SUBEAD	= ISNULL(SB.AD,'')
					,ISNULL(SNF.AD, S.SINIF) AS SINIF
					,ADSOYAD	= S.AD + ' ' + S.SOYAD
					,SO.TCKIMLIKNO 
					,ID_SINIF	= ISNULL(OT.ID_SINIF,0)
					,SV.ID_SINAVTURU
			INTO #T1
			FROM #SINAVOGRENCI						SO
			JOIN Sinav								SV	ON	SV.ID_SINAV				= SO.ID_SINAV
			JOIN SinavOgrenci						S	ON	S.TCKIMLIKNO			= SO.TCKIMLIKNO
														AND S.ID_SINAV				= SO.ID_SINAV
			LEFT JOIN OkyanusDB.dbo.V3Sube			SB	ON	CAST(SB.SUBENO AS INT)	= CAST(S.SUBENO AS INT)
			LEFT JOIN OkyanusDB.dbo.v3OgrenciTum	OT	ON	OT.TCKIMLIKNO			= S.TCKIMLIKNO
														AND OT.DONEM				= SV.DONEM
			LEFT JOIN OkyanusDB.dbo.v3Sinif			SNF ON SNF.ID_SINIF = OT.ID_SINIF


			INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU)
			SELECT TOP 1 SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1 FROM #T1
			
				
			
			SELECT DISTINCT UPPER(D.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD,do.ID_SINIF
			INTO #T2
			FROM EOKUL_V2.DBO.dersogretmen	DO
			JOIN OkyanusDB.dbo.v3kullanici  K	ON	K.TCKIMLIKNO	= DO.TC_OGRETMEN
			JOIN OkyanusDB.dbo.v3SinavDers	D	ON	D.ID_DERS		= DO.ID_DERS
			JOIN OkyanusDB.dbo.v3OgrenciTum O	ON	O.ID_SINIF		= DO.ID_SINIF 
												AND O.DONEM			= DO.DONEMKOD
			where	O.TCKIMLIKNO	= @TC_OGRENCI
				AND DO.DONEMKOD		= @DONEM




			SELECT	 SO.ID_SINAV
					,SO.ID_SINAVDERS
					,SO.TCKIMLIKNO					
					,OT.TD
					,OT.TY
					,OT.TB
					,OT.TN
					,SO.DERSAD
					,SO.ID_SINAVTURU
					,SO.SINAVAD
					,SO.SINAVTARIH   
					,SO.OLCEKSINAVI
					,SO.DOGRU
					,SO.YANLIS
					,SO.BOS
					,SO.NET
					,SO.DERSPUAN
			INTO #T4
			FROM #SINAVOGRENCI		SO
			JOIN SinavOgrenciToplam	OT	ON	OT.ID_SINAV		= SO.ID_SINAV 
										AND OT.TCKIMLIKNO	= SO.TCKIMLIKNO


			SELECT DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
			INTO	#T3
			FROM	#T4			T4
			JOIN	SinavTuru	ST	ON	ST.ID_SINAVTURU	= T4.ID_SINAVTURU	
			JOIN	SinavDers	SD	ON	SD.TAKMAAD		= T4.DERSAD 
									AND SD.ID_SINAV		= T4.ID_SINAV
			GROUP BY DERSAD ,ST.ID_SINAVTURU,ST.AD 	
			 

			SELECT	 SO.TCKIMLIKNO
					,SO.ID_SINAV				
					,PUANTURU	= UPPER(PT.AD) 
					,SO.SINAVAD	
					,SO.PUANGIZLE
					,SO.ID_SINAVTURU
					,SO.SINAVTARIH
					,P.PUAN
					,P.ID_SINAVPUANTURU
					,P.GENELSIRA
					,P.ILSIRA
					,P.ILCESIRA
					,P.OKULSIRA
					,P.SINIFSIRA
					,GENELKATILIM	= OT.KATILIM_GENEL
					,ILKATILIM		= OT.KATILIM_IL
					,ILCEKATILIM	= OT.KATILIM_ILCE
					,SUBEKATILIM	= OT.KATILIM_OKUL
					,SINIFKATILIM	= OT.KATILIM_SINIF
			INTO #T5
			FROM #SINAVOGRENCI			SO
			JOIN vw_SinavOgrenciPuan	P	ON	P.TCKIMLIKNO		= SO.TCKIMLIKNO
											AND P.ID_SINAV			= SO.ID_SINAV
			JOIN SinavOgrenciToplam		OT	ON	OT.TCKIMLIKNO		= SO.TCKIMLIKNO
											AND OT.ID_SINAV			= SO.ID_SINAV			
			JOIN SinavPuanTuru			PT	ON	PT.ID_SINAVPUANTURU	= P.ID_SINAVPUANTURU
			WHERE SO.PUANGIZLE = 0


			---------------------------------------------------------------------
			-- YAZILI
		BEGIN
			SELECT k.TCKIMLIKNO,
			   o.ID_OGRENCI,
			   k.AD+' '+k.SOYAD as ADSOYAD,
			   s.SubeNo as SUBENO,
			   s.AD as SUBEAD,
			   sn.ID_SINIF,
			   sn.AD as SINIF,
			   --isnull(Cast(rs.FOTOGRAF AS VARBINARY(MAX)),Cast('' AS VARBINARY(MAX))) as FOTOGRAF	,
			   @ID_KADEME3 as ID_KADEME3
			INTO #Y1
		  FROM OkyanusDB.dbo.v3Kullanici k
		INNER JOIN OkyanusDB.dbo.v3OgrenciTum o on o.TCKIMLIKNO=k.TCKIMLIKNO
		INNER JOIN v3SinifTum sn on sn.ID_SINIF=o.ID_SINIF
		INNER JOIN v3Donem dn on dn.ID_DONEM=o.ID_DONEM AND dn.KOD=@DONEM
		INNER JOIN v3Sube s   on s.ID_SUBE=o.ID_SUBE
		LEFT JOIN OkyanusDB.dbo.v3Resim rs on rs.TCKIMLIKNO=O.TCKIMLIKNO
		 WHERE o.TCKIMLIKNO=@TC_OGRENCI

		  
			SELECT DISTINCT d.ID_DERS, do.ID_SINIF, upper(d.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD
			INTO #Y2
			FROM EOKUL_V2.DBO.dersogretmen do
			JOIN OkyanusDB.dbo.v3kullanici  k	on k.TCKIMLIKNO=do.TC_OGRETMEN
			JOIN OkyanusDB.dbo.v3SinavDers d on d.ID_DERS=do.ID_DERS
			JOIN OkyanusDB.dbo.v3OgrenciTum o on o.ID_SINIF=do.ID_SINIF AND o.DONEM=do.DONEMKOD
			WHERE o.TCKIMLIKNO=@TC_OGRENCI
			AND do.DONEMKOD=@DONEM


			SELECT	D.DERSAD AS DERSAD
					,Y.ID_DERS 
					,Y.AD + ' :' AS  SINAVADI
					,Y.ID_YAZILI AS ID_SINAVRAPOR
					,O.ID_OGRENCI
					,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
					,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
					,y.YAZILITARIH
			INTO #Y3
			FROM Yazili Y
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND o.DONEM=@DONEM
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
			WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND Y.DONEM = @DONEM
				AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
			GROUP BY D.DERSAD 
					,Y.ID_DERS
					,Y.AD 
					,Y.ID_YAZILI 
					,O.ID_OGRENCI
					,Y.YARIYIL
					,YO.TELAFI
					,y.YAZILITARIH
			order by o.ID_OGRENCI, d.DERSAD, Y.YARIYIL, Y.ID_YAZILI
		END

			
			--JSON SEND
			IF (@ISLEM = 1)
			BEGIN
				select(
						select * from(
							select 
							(						 
								SELECT DISTINCT * FROM #T1
								FOR JSON AUTO
							) as t1
							,( 
								SELECT DISTINCT  * FROM #T2
								FOR JSON AUTO
							)as t2
							,(
								SELECT  DISTINCT * FROM #T3 
								order by BOLUMNO
								FOR JSON AUTO
							) as t3 
							,( 
								SELECT  DISTINCT
										 ID_SINAV
										,SINAVAD
										,DERSAD
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU		AS VARCHAR) END AS DOGRU
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS	AS VARCHAR) END AS YANLIS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS		AS VARCHAR) END AS BOS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET		AS VARCHAR) END AS NET
										,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
										,OLCEKSINAVI					
										,TD
										,TY
										,TB
										,TN
										--,SINIFSIRA
										--,OKULSIRA
										--,ILCESIRA
										--,ILSIRA
										--,GENELSIRA
										,ID_SINAVTURU
										,SINAVTARIH   
								from #T4
								order by SINAVTARIH,DERSAD
								FOR JSON AUTO
							)as t4
							,(
								SELECT DISTINCT * FROM #T5
								ORDER BY SINAVTARIH,ID_SINAV,PUANTURU
								FOR JSON AUTO
							) as t5 
							,(
								SELECT DISTINCT PUANTURU,ID_SINAVPUANTURU,ID_SINAVTURU FROM #T5
								ORDER BY PUANTURU
								FOR JSON AUTO
							) as t6,
							
							(						 
								SELECT DISTINCT  * FROM #Y1
								FOR JSON AUTO
							) as y1
							,( 
								SELECT DISTINCT * FROM #Y2
								FOR JSON AUTO
							)as y2
							,(
								SELECT DISTINCT   DERSAD,ID_DERS  FROM #Y3 
								order by DERSAD
								FOR JSON AUTO
							) as y3 
							,( 
								select DISTINCT * from #Y3
								order by DERSAD
								FOR JSON AUTO
							)as y4	
						) as tablo FOR JSON AUTO
					) as tt
				END
			IF (@ISLEM = 2)
			BEGIN
							 
								SELECT DISTINCT * FROM #T1
								
								SELECT DISTINCT * FROM #T2
								
								SELECT DISTINCT * FROM #T3 
								order by BOLUMNO

								SELECT  DISTINCT
										 ID_SINAV
										,SINAVAD
										,DERSAD
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU		AS VARCHAR) END AS DOGRU
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS	AS VARCHAR) END AS YANLIS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS		AS VARCHAR) END AS BOS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET		AS VARCHAR) END AS NET
										,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
										,OLCEKSINAVI					
										,TD
										,TY
										,TB
										,TN
										--,SINIFSIRA
										--,OKULSIRA
										--,ILCESIRA
										--,ILSIRA
										--,GENELSIRA
										,ID_SINAVTURU
										,SINAVTARIH   
								from #T4
								order by SINAVTARIH,DERSAD

								SELECT DISTINCT * FROM #T5
								ORDER BY SINAVTARIH,ID_SINAV,PUANTURU

								SELECT DISTINCT PUANTURU,ID_SINAVPUANTURU,ID_SINAVTURU FROM #T5
								ORDER BY PUANTURU

								SELECT DISTINCT * FROM #Y1

								SELECT DISTINCT * FROM #Y2

								SELECT DISTINCT  DERSAD,ID_DERS  FROM #Y3 
								order by DERSAD

								SELECT DISTINCT * from #Y3
								order by DERSAD

		 END


			DROP TABLE IF EXISTS #SINAVOGRENCI
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #Y1
			DROP TABLE IF EXISTS #Y2
			DROP TABLE IF EXISTS #Y3
		END	
	
	END

	END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
						
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AraKarneCoklu]    Script Date: 22.11.2021 10:33:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AraKarneCoklu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@ID_SINAVTURU		varchar(100)	= NULL,
	@YAZILI_DONEM		varchar(100)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
		ISLEM				= @ISLEM		
		,TCKIMLIKNO			= @TCKIMLIKNO	
		,TC_OGRENCI			= @TC_OGRENCI	
		,OTURUM				= @OTURUM		
		,IL					= @IL			
		,ILCE				= @ILCE		
		,ID_MENU			= @ID_MENU	
		,DONEM				= @DONEM		
		,ID_KADEME3			= @ID_KADEME3	
		,ID_SINAV			= @ID_SINAV	
		,ID_DERS			= @ID_DERS	
		,ID_SUBE			= @ID_SUBE	
		,ID_SINIF			= @ID_SINIF	
		,DOSYAADI			= @DOSYAADI	
		,DOSYAGUID			= @DOSYAGUID	
		,ID_SINAVDOSYA		= @ID_SINAVDOSYA
		,ID_SINAVTURU		= @ID_SINAVTURU
		,YAZILI_DONEM		= @YAZILI_DONEM
		,SQLJSON			= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
 
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END


	IF @ID_LOG > 1
		BEGIN
			DECLARE @OV BIT = 0

			IF NOT EXISTS(SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
				BEGIN
					SET @OV = 1
				END

			IF (@ISLEM = 1 or @ISLEM = 2)	--	ARA KARNE DENEME SINAVLARI
				BEGIN
				--declare @ID_SINAVTURU INT=3,@DONEM varchar(4)='2017',@TC_OGRENCI varchar(11)='50764204008'

				DROP TABLE IF EXISTS #SINAVOGRENCI
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T3
				DROP TABLE IF EXISTS #T4
				DROP TABLE IF EXISTS #T5
				DROP TABLE IF EXISTS #Y1
				DROP TABLE IF EXISTS #Y2
				DROP TABLE IF EXISTS #Y3

				if @TC_OGRENCI is not null and @TC_OGRENCI <> ''
					BEGIN 
						SET @ID_SINIF = null
					END


				SELECT DISTINCT	 SO.ID_SINAV
						,SO.ID_SINAVDERS
						,SO.TCKIMLIKNO
						,SO.DOGRU
						,SO.YANLIS
						,SO.BOS
						,SO.NET
						,DERSAD		= D.TAKMAAD
						,SINAVAD	= S.AD
						,DERSPUAN	= SO.PUAN
						,S.ID_SINAVTURU
						,S.PUANGIZLE
						,S.SINAVTARIH
						,S.OLCEKSINAVI
						,GS.ID_KADEME
				INTO #SINAVOGRENCI
				FROM vw_SinavOgrenciBolum				SO
				JOIN Sinav								S	ON	S.ID_SINAV		= SO.ID_SINAV				
				JOIN SinavDers							D	ON	D.ID_SINAV		= SO.ID_SINAV
															AND D.ID_SINAVDERS	= SO.ID_SINAVDERS
				JOIN OkyanusDB.dbo.v3OgrenciTum			VO	ON	VO.TCKIMLIKNO	= SO.TCKIMLIKNO AND VO.DONEM = S.DONEM
				JOIN [dbo].[vw_SubeSinifGrupKademe]		GS	ON  GS.ID_SINIF			= VO.ID_SINIF
				WHERE	S.DONEM			= @DONEM  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND (@TC_OGRENCI is null or @TC_OGRENCI='' or SO.TCKIMLIKNO = @TC_OGRENCI)
					AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)
					AND (@ID_SINAVTURU is null or @ID_SINAVTURU='' or ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))


				SELECT	 SUBEAD	= ISNULL(SB.AD,'')
						,S.SINIF
						,ADSOYAD	= S.AD + ' ' + S.SOYAD
						,SO.TCKIMLIKNO 
						,ID_SINIF	= ISNULL(OT.ID_SINIF,0)
						,SV.ID_SINAVTURU
						,ID_KADEME
				INTO #T1
				FROM #SINAVOGRENCI						SO
				JOIN Sinav								SV	ON	SV.ID_SINAV				= SO.ID_SINAV
				JOIN SinavOgrenci						S	ON	S.TCKIMLIKNO			= SO.TCKIMLIKNO
															AND S.ID_SINAV				= SO.ID_SINAV
				LEFT JOIN OkyanusDB.dbo.V3Sube			SB	ON	CAST(SB.SUBENO AS INT)	= CAST(S.SUBENO AS INT)
				LEFT JOIN OkyanusDB.dbo.v3OgrenciTum	OT	ON	OT.TCKIMLIKNO			= S.TCKIMLIKNO
															AND OT.DONEM				= SV.DONEM

														
				--INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU,ID_KADEME)
				--SELECT TOP 1 SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1,ID_KADEME FROM #T1

				INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU,ID_KADEME)
				SELECT DISTINCT SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1,ID_KADEME FROM #T1
				WHERE (@ID_SINAVTURU is null or @ID_SINAVTURU='' or -1 in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))

			
				SELECT DISTINCT UPPER(D.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD,do.ID_SINIF
				INTO #T2
				FROM EOKUL_V2.DBO.dersogretmen	DO
				JOIN OkyanusDB.dbo.v3kullanici  K	ON	K.TCKIMLIKNO	= DO.TC_OGRETMEN
				JOIN OkyanusDB.dbo.v3SinavDers	D	ON	D.ID_DERS		= DO.ID_DERS
				JOIN OkyanusDB.dbo.v3OgrenciTum O	ON	O.ID_SINIF		= DO.ID_SINIF 
													AND O.DONEM			= DO.DONEMKOD
				where	(@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
					AND (@ID_SINIF is null or @ID_SINIF='' or o.ID_SINIF = @ID_SINIF)
					AND do.DONEMKOD=@DONEM


				SELECT	 SO.ID_SINAV
						,SO.ID_SINAVDERS
						,SO.TCKIMLIKNO					
						,OT.TD
						,OT.TY
						,OT.TB
						,OT.TN
						,SO.DERSAD
						,SO.ID_SINAVTURU
						,SO.SINAVAD
						,SO.SINAVTARIH   
						,SO.OLCEKSINAVI
						,SO.DOGRU
						,SO.YANLIS
						,SO.BOS
						,SO.NET
						,SO.DERSPUAN
				INTO #T4
				FROM #SINAVOGRENCI		SO
				JOIN SinavOgrenciToplam	OT	ON	OT.ID_SINAV		= SO.ID_SINAV 
											AND OT.TCKIMLIKNO	= SO.TCKIMLIKNO


				SELECT DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO, T4.TCKIMLIKNO
				INTO	#T3
				FROM	#T4			T4
				JOIN	SinavTuru	ST	ON	ST.ID_SINAVTURU	= T4.ID_SINAVTURU	
				JOIN	SinavDers	SD	ON	SD.TAKMAAD		= T4.DERSAD 
										AND SD.ID_SINAV		= T4.ID_SINAV
				GROUP BY DERSAD ,ST.ID_SINAVTURU,ST.AD,T4.TCKIMLIKNO


				SELECT	 SO.TCKIMLIKNO
						,SO.ID_SINAV				
						,PUANTURU	= UPPER(PT.AD) 
						,SO.SINAVAD	
						,SO.PUANGIZLE
						,SO.ID_SINAVTURU
						,SO.SINAVTARIH
						,ISNULL(P.PUAN				  ,0)	PUAN				 
						,ISNULL(P.ID_SINAVPUANTURU	  ,0)	ID_SINAVPUANTURU	 
						,ISNULL(P.GENELSIRA			  ,0)	GENELSIRA			 
						,ISNULL(P.ILSIRA			  ,0)	ILSIRA			 
						,ISNULL(P.ILCESIRA			  ,0)	ILCESIRA			 
						,ISNULL(P.OKULSIRA			  ,0)	OKULSIRA			 
						,ISNULL(P.SINIFSIRA			  ,0)	SINIFSIRA			 
						,GENELKATILIM	= OT.KATILIM_GENEL
						,ILKATILIM		= OT.KATILIM_IL
						,ILCEKATILIM	= OT.KATILIM_ILCE
						,SUBEKATILIM	= OT.KATILIM_OKUL
						,SINIFKATILIM	= OT.KATILIM_SINIF
				INTO #T5
				FROM #SINAVOGRENCI				SO
				JOIN SinavOgrenciToplam			OT	ON	OT.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND OT.ID_SINAV			= SO.ID_SINAV			
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV			
				LEFT JOIN vw_SinavOgrenciPuan	P	ON	P.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND P.ID_SINAV			= SO.ID_SINAV
				LEFT JOIN SinavPuanTuru			PT	ON	PT.ID_SINAVPUANTURU	= P.ID_SINAVPUANTURU
				JOIN OkyanusDB.dbo.v3OgrenciTum	O	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND O.DONEM				= S.DONEM
				WHERE	SO.PUANGIZLE = 0
					and (@TC_OGRENCI is null or @TC_OGRENCI='' or P.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF   is null or @ID_SINIF  ='' or O.ID_SINIF   = @ID_SINIF  )



	--------------------------------------------------------------------------------------
				/*
				--into puan
				SELECT 
						O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
						,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
						(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
						,ID_SINAVTURU,S.SINAVTARIH,GS.ID_KADEME
				INTO #PUAN
				FROM SinavOgrenci						O
				JOIN SinavOgrenciCevapBolum				B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				JOIN Sinav								S	ON	S.ID_SINAV			= O.ID_SINAV
				JOIN SinavDers							D	ON	D.ID_SINAV			= O.ID_SINAV	
															AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN OkyanusDB.dbo.v3OgrenciTum			VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				JOIN OkyanusDB.dbo.v3SinifTum			SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				JOIN [dbo].[vw_SubeSinifGrupKademe]		GS	ON  GS.ID_SINIF			= VO.ID_SINIF
				JOIN OkyanusDB.dbo.V3Sube				VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				JOIN SinavKitapcik						K	ON	K.ID_SINAV			= O.ID_SINAV
															AND	K.AD				= O.KITAPCIK
				JOIN OkyanusDB.dbo.v3Kullanici			VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				WHERE	S.DONEM			= @DONEM  
					and s.DURUM			= 2
					and s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					and (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)
					and (@ID_SINAVTURU is null or @ID_SINAVTURU='' or ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))
			
			
				--İNTO TT
				SELECT 
					t.ID_SINAVOGRENCI,t.TCKIMLIKNO,ID_SINAV
					,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				into #tt
				FROM #PUAN	t
				group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,ID_SINAV

			
				UPDATE T
				SET	 TD=D.TD
					,TY=D.TY
					,TB=D.TB
					,TN=D.TN
					,TS=D.TS
				FROM #tt T
				JOIN (
					SELECT T2.ID_SINAV,T2.TCKIMLIKNO,SUM(T2.TD) TD,SUM(T2.TY) TY,SUM(T2.TB) TB,SUM(T2.TN) TN,SUM(T2.TS) TS					
					FROM #tt T2
					GROUP BY T2.ID_SINAV,T2.TCKIMLIKNO,T2.ID_SINAV
				) AS D ON D.TCKIMLIKNO=T.TCKIMLIKNO AND T.ID_SINAV = D.ID_SINAV

				-- into tt1
				select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				into #tt1 
				from #tt t
				join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL
				--order by 1
			
			
				-- SORGULAR
			
				-- öğrenci
				SELECT DISTINCT SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO ,ID_SINIF,ID_SINAVTURU, ID_KADEME
				INTO #T1
				FROM #PUAN 

				INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU,ID_KADEME)
				SELECT DISTINCT SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1,ID_KADEME FROM #T1
				WHERE (@ID_SINAVTURU is null or @ID_SINAVTURU='' or -1 in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))

				-- öğretmen
				SELECT distinct upper(d.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD,do.ID_SINIF
				INTO #T2
				FROM EOKUL_V2.DBO.dersogretmen do
				join v3kullanici  k	on k.TCKIMLIKNO=do.TC_OGRETMEN
				join OkyanusDB.dbo.v3SinavDers d on d.ID_DERS=do.ID_DERS
				join OkyanusDB.dbo.v3OgrenciTum o on o.ID_SINIF=do.ID_SINIF AND o.DONEM=do.DONEMKOD
				where (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF is null or @ID_SINIF='' or o.ID_SINIF = @ID_SINIF)
				and do.DONEMKOD=@DONEM
						
				--ders dybn
				SELECT distinct P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
						,TD,TY,TB,TN
						,ID_SINAVTURU,p.SINAVTARIH
				INTO #T4
				FROM #PUAN				P						
				left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--WHERE p.TCKIMLIKNO	=@TC_OGRENCI
				group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
						,TD,TY,TB,TN
						,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH
				--order by p.SINAVTARIH

			
				-- dersler sorgu
				SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				INTO	#T3
				FROM	#T4			T4
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--ORDER BY SD.BOLUMNO


				SELECT DISTINCT ID_SINAV INTO #SINAVLAR FROM #PUAN

				SELECT  SUM(1) KATILIM,
						SOS.ID_SINAVPUANTURU,
						SOS.PUAN,
						S.ID_SINAV,		
						SO.TCKIMLIKNO,
						VO.ID_SINIF,
						VO.ID_SUBE,
						SB.ILCE,
						SB.IL
				INTO	#KATILIM
				FROM	#SINAVLAR					P
				JOIN	Sinav					S	ON	P.ID_SINAV=S.ID_SINAV
				join	SinavOgrenci			SO	ON	SO.ID_SINAV		= S.ID_SINAV
				left JOIN	SinavOgrenciSonuc		SOS	ON	SOS.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= SO.TCKIMLIKNO AND VO.DONEM = S.DONEM
				JOIN	OkyanusDB.DBO.v3Sube	SB	ON	SB.ID_SUBE		= VO.ID_SUBE
				GROUP BY S.ID_SINAV,SO.TCKIMLIKNO,VO.ID_SINIF,VO.ID_SUBE,SB.ILCE,SB.IL,SOS.ID_SINAVPUANTURU,SOS.PUAN
			
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'GENEL',DEGER = 'GENEL'
				INTO #GENEL
				FROM #KATILIM	
				GROUP BY ID_SINAV,ID_SINAVPUANTURU
				UNION ALL 
				SELECT	COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'IL',DEGER= IL
				FROM #KATILIM	
				GROUP BY ID_SINAV,IL,ID_SINAVPUANTURU
				UNION ALL 
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'ILCE',DEGER= ILCE
				FROM #KATILIM	
				GROUP BY ID_SINAV,ILCE,ID_SINAVPUANTURU
				UNION ALL 
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'OKUL',DEGER= CAST(ID_SUBE AS VARCHAR)
				FROM #KATILIM	
				GROUP BY ID_SINAV,ID_SUBE,ID_SINAVPUANTURU
				UNION ALL 
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'SINIF',DEGER= CAST(ID_SINIF AS VARCHAR)
				FROM #KATILIM	
				GROUP BY ID_SINAV,ID_SINIF,ID_SINAVPUANTURU

				SELECT K.* 
					,SINIFKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.ID_SINIF	AND G.ISLEM='SINIF'	)
					,SUBEKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.ID_SUBE		AND G.ISLEM='OKUL'	)
					,ILCEKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.ILCE		AND G.ISLEM='ILCE'	)
					,ILKATILIM		= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.IL			AND G.ISLEM='IL'	)
					,GENELKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER='GENEL'		AND G.ISLEM='GENEL'	)
				INTO #PUANLAMA
				FROM #KATILIM K	

				--puan
				SELECT DISTINCT P.TCKIMLIKNO,P.ID_SINAV,SINAVAD,PUANGIZLE,OS.PUAN,PT.AD PUANTURU,OS.ID_SINAVPUANTURU,P.ID_SINAVTURU,p.SINAVTARIH
						,PP.SINIFKATILIM
						,PP.SUBEKATILIM
						,PP.ILCEKATILIM
						,PP.ILKATILIM
						,PP.GENELKATILIM 	
						,OS.SINIFSIRA
						,OS.OKULSIRA
						,OS.ILCESIRA
						,OS.ILSIRA
						,OS.GENELSIRA		
				INTO #T5
				FROM		#PUAN				P						
				left JOIN	SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				left JOIN	SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= OS.ID_SINAVPUANTURU
				left JOIN	#PUANLAMA			PP	ON	PP.TCKIMLIKNO		= P.TCKIMLIKNO
													AND PP.ID_SINAV			= P.ID_SINAV												
													AND ((PP.ID_SINAVPUANTURU is null and PT.ID_SINAVPUANTURU is null) or PP.ID_SINAVPUANTURU = PT.ID_SINAVPUANTURU)
				WHERE P.PUANGIZLE=0
					and (@TC_OGRENCI is null or @TC_OGRENCI='' or P.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF   is null or @ID_SINIF  ='' or P.ID_SINIF   = @ID_SINIF  )
			
				DROP TABLE #GENEL
				DROP TABLE #KATILIM

				*/
				---------------------------------------------------------------------
				-- YAZILI

				Select DISTINCT k.TCKIMLIKNO,
					o.ID_OGRENCI,
					k.AD+' '+k.SOYAD as ADSOYAD,
					s.SubeNo as SUBENO,
					s.AD as SUBEAD,
					sn.ID_SINIF,
					sn.AD as SINIF,
					isnull(Cast(rs.FOTOGRAF AS VARBINARY(MAX)),Cast('' AS VARBINARY(MAX))) as FOTOGRAF,
					GS.ID_KADEME	   
				INTO #Y1
				from OkyanusDB.dbo.v3Kullanici k
				inner join OkyanusDB.dbo.v3OgrenciTum o on o.TCKIMLIKNO=k.TCKIMLIKNO
				inner join v3Donem dn on dn.ID_DONEM=o.ID_DONEM and dn.KOD=@DONEM
				inner join v3Sube s   on s.ID_SUBE=o.ID_SUBE
				inner join v3SinifTum sn on sn.ID_SINIF=o.ID_SINIF
				JOIN [dbo].[vw_SubeSinifGrupKademe]	 GS	ON  GS.ID_SINIF			= O.ID_SINIF
				left join OkyanusDB.dbo.v3Resim rs on rs.TCKIMLIKNO=O.TCKIMLIKNO
				where (@TC_OGRENCI is null or @TC_OGRENCI='' or O.TCKIMLIKNO = @TC_OGRENCI)
						and (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)

			-- select * from EOKUL_V2.DBO.Resim where CZKIMLIKNO='19057128520'
		  
				SELECT distinct d.ID_DERS, do.ID_SINIF, upper(d.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD
				INTO #Y2
				FROM EOKUL_V2.DBO.dersogretmen do
				join OkyanusDB.dbo.v3kullanici  k	on k.TCKIMLIKNO=do.TC_OGRETMEN
				join OkyanusDB.dbo.v3SinavDers d on d.ID_DERS=do.ID_DERS
				join OkyanusDB.dbo.v3OgrenciTum o on o.ID_SINIF=do.ID_SINIF AND o.DONEM=do.DONEMKOD
				where (@TC_OGRENCI is null or @TC_OGRENCI='' or O.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				and do.DONEMKOD=@DONEM



									 SELECT DISTINCT	YO.TCKIMLIKNO
											,D.DERSAD AS DERSAD
											,Y.ID_DERS 
											,Y.AD + ' :' AS  SINAVADI
											,Y.ID_YAZILI AS ID_SINAVRAPOR
											,O.ID_OGRENCI
											,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
											,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
									INTO #Y3
									FROM Yazili Y
									INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
									INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
									INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
									INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
									WHERE	Y.AKTIF = 1 
										AND YO.AKTIF = 1 
										AND Y.DONEM = @DONEM
										AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
										AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
										AND (@YAZILI_DONEM is null or @YAZILI_DONEM='' or Y.YARIYIL in (SELECT SUBSTRING(Value, 1, 1) FROM OPENJSON(@YAZILI_DONEM)))
										AND (Y.OVGORSUN = 1 OR @OV = 0)
										AND Y.ID_YAZILITURU = 1
										AND Y.KARNEDEGORUNSUN = 1
									GROUP BY YO.TCKIMLIKNO 
											,D.DERSAD 
											,Y.ID_DERS
											,Y.AD 
											,Y.ID_YAZILI 
											,O.ID_OGRENCI
											,Y.YARIYIL
											,YO.TELAFI


							 
									SELECT DISTINCT * FROM #T1
								
									SELECT DISTINCT * FROM #T2
								
									SELECT DISTINCT * FROM #T3 
									order by BOLUMNO

									select  DISTINCT
											TCKIMLIKNO
											,ID_SINAV
											,SINAVAD
											,DERSAD
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
											,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
											,OLCEKSINAVI					
											,TD
											,TY
											,TB
											,TN
											,ID_SINAVTURU
											,SINAVTARIH   
									from #T4
									order by SINAVTARIH,DERSAD

									SELECT DISTINCT	t.TCKIMLIKNO
											,t.ID_SINAV
											,SINAVAD
											,PUANGIZLE
											,PUAN
											,PUANTURU
											,t.ID_SINAVPUANTURU
											,ID_SINAVTURU
											,SINAVTARIH
											,SINIFSIRA
											,OKULSIRA
											,ILCESIRA
											,ILSIRA
											,GENELSIRA
											,t.SINIFKATILIM
											,t.SUBEKATILIM
											,t.ILCEKATILIM
											,t.ILKATILIM
											,t.GENELKATILIM  
									FROM #T5 t
									ORDER BY SINAVTARIH,t.ID_SINAV,PUANTURU

									SELECT DISTINCT PUANTURU,ID_SINAVPUANTURU,ID_SINAVTURU FROM #T5
									ORDER BY PUANTURU
									SELECT * FROM #Y1

									SELECT DISTINCT * FROM #Y2

									SELECT DISTINCT  DERSAD,ID_DERS  FROM #Y3 
									order by DERSAD

									select DISTINCT * from #Y3
									order by ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

			
				DROP TABLE IF EXISTS #SINAVOGRENCI
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T3
				DROP TABLE IF EXISTS #T4
				DROP TABLE IF EXISTS #T5
				DROP TABLE IF EXISTS #Y1
				DROP TABLE IF EXISTS #Y2
				DROP TABLE IF EXISTS #Y3

			END	
		END

	END TRY

	BEGIN CATCH
	 DECLARE @_ErrorSeverity INT;
	 DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END


	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Assessment]    Script Date: 22.11.2021 10:33:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Assessment]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@DONEM					VARCHAR(MAX)	= NULL,
	@ID_KADEME3				INT				= NULL,
	@PASIFGORUNSUN			BIT				= NULL,
	@AKTIF					BIT				= NULL,
	@ID_ASSESSMENTOGRENCI	INT				= NULL,
	@ID_ASSESSMENT			INT				= NULL,
	@SINAV					VARCHAR(MAX)	= NULL,
	@SORULIST				VARCHAR(MAX)	= NULL,
	@EXCEL					NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI				
				,DONEM					= @DONEM						
				,AKTIF					= @AKTIF				
				,ID_KADEME3				= @ID_KADEME3				
				,ID_ASSESSMENTOGRENCI	= @ID_ASSESSMENTOGRENCI	
				,ID_ASSESSMENT			= @ID_ASSESSMENT		
				,PASIFGORUNSUN			= @PASIFGORUNSUN		
				,SINAV					= @SINAV					
				,SORULIST				= @SORULIST				
				,EXCEL					= @EXCEL					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN
				SELECT (
					SELECT * 
					FROM AssessmentKategori
					FOR JSON AUTO				
				)
			END

			IF @ISLEM = 2	--	SINAV EKLE					
			BEGIN
			
				IF @ID_ASSESSMENT = 0 OR @ID_ASSESSMENT IS NULL
				BEGIN
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #SORULIST
				
					CREATE TABLE #TEMP ( ID_SINAV			INT
										,ID_KADEME3			INT
										,DONEM				VARCHAR(4)
										,AD			VARCHAR(MAX)
										,SUTUN_TCKIMLIKNO	VARCHAR(2)
										,SUTUN_ADSOYAD		VARCHAR(2)
										,SUTUN_SESKAYDI		VARCHAR(2)
										,SUTUN_FOTOGRAF		VARCHAR(2)
										,SUTUN_OZELNOT		VARCHAR(2)
										,SORULIST			NVARCHAR(MAX))

					INSERT INTO #TEMP (  ID_SINAV			
										,ID_KADEME3			
										,DONEM				
										,AD			
										,SUTUN_TCKIMLIKNO	
										,SUTUN_ADSOYAD
										,SUTUN_SESKAYDI		
										,SUTUN_FOTOGRAF		
										,SUTUN_OZELNOT		
										,SORULIST)
					SELECT * 
					FROM OPENJSON (@SINAV)
					WITH (	 ID_SINAV			INT
							,ID_KADEME3			INT
							,DONEM				VARCHAR(4)
							,AD			VARCHAR(MAX)
							,SUTUN_TCKIMLIKNO	VARCHAR(2)
							,SUTUN_ADSOYAD		VARCHAR(2)
							,SUTUN_SESKAYDI		VARCHAR(2)
							,SUTUN_FOTOGRAF		VARCHAR(2)
							,SUTUN_OZELNOT		VARCHAR(2)
							,SORULIST			NVARCHAR(MAX))

					DECLARE @ID TABLE (ID INT)
					INSERT INTO Assessment ( DONEM				
											,ID_KADEME3
											,AD			
											,SUTUN_TCKIMLIKNO	
											,SUTUN_ADSOYAD	
											,SUTUN_SESKAYDI		
											,SUTUN_FOTOGRAF		
											,SUTUN_OZELNOT		
											,KYE_TCKIMLIKNO
											)
					OUTPUT inserted.ID_ASSESSMENT INTO @ID(ID)
					SELECT TOP 1 DONEM				
								,ID_KADEME3
								,AD			
								,SUTUN_TCKIMLIKNO	
								,SUTUN_ADSOYAD		
								,SUTUN_SESKAYDI		
								,SUTUN_FOTOGRAF		
								,SUTUN_OZELNOT		
								,@TCKIMLIKNO
					FROM #TEMP
					SET @ID_ASSESSMENT = (SELECT TOP 1 ID FROM @ID)



					CREATE TABLE #SORULIST ( SORUNO					INT
											,SUTUN					VARCHAR(2)
											,ID_ASSESSMENT			INT
											,ID_ASSESSMENTKATEGORI	INT
											,CEVAP					VARCHAR(MAX)
											,SORU					VARCHAR(MAX)
											)
					SET @SORULIST = ( SELECT TOP 1 SORULIST FROM #TEMP )
					INSERT INTO #SORULIST (SORUNO, SUTUN, ID_ASSESSMENTKATEGORI, CEVAP, SORU, ID_ASSESSMENT)
					SELECT 
						 SORUNO					
						,SUTUN					
						,ID_ASSESSMENTKATEGORI	
						,CEVAP
						,SORU
						,@ID_ASSESSMENT
					FROM OPENJSON( @SORULIST )
					WITH (	 SORUNO		INT
							,SUTUN		VARCHAR(2)
							,ID_ASSESSMENTKATEGORI	INT
							,CEVAP		VARCHAR(MAX)
							,SORU		VARCHAR(MAX)
					)

					--SELECT * FROM AssessmentSoru

					INSERT INTO AssessmentSoru (ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,KYE_TCKIMLIKNO)
					SELECT ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,@TCKIMLIKNO FROM #SORULIST

				
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #SORULIST

					SELECT @ID_ASSESSMENT
				END
				ELSE IF  EXISTS ( SELECT TOP 1 1 FROM Assessment WHERE ID_ASSESSMENT = @ID_ASSESSMENT)
				BEGIN
					
					DROP TABLE IF EXISTS #TEMP2
					DROP TABLE IF EXISTS #SORULIST2
				
					CREATE TABLE #TEMP2 (ID_ASSESSMENT		INT
										,ID_KADEME3			INT
										,DONEM				VARCHAR(4)
										,AD			VARCHAR(MAX)
										,SUTUN_TCKIMLIKNO	VARCHAR(2)
										,SUTUN_ADSOYAD		VARCHAR(2)
										,SUTUN_SESKAYDI		VARCHAR(2)
										,SUTUN_FOTOGRAF		VARCHAR(2)
										,SUTUN_OZELNOT		VARCHAR(2)
										,SORULIST			NVARCHAR(MAX))

					INSERT INTO #TEMP2 ( ID_ASSESSMENT			
										,ID_KADEME3			
										,DONEM				
										,AD			
										,SUTUN_TCKIMLIKNO	
										,SUTUN_ADSOYAD		
										,SUTUN_SESKAYDI		
										,SUTUN_FOTOGRAF		
										,SUTUN_OZELNOT		
										,SORULIST)
					SELECT * 
					FROM OPENJSON (@SINAV)
					WITH (	 ID_ASSESSMENT		INT
							,ID_KADEME3			INT
							,DONEM				VARCHAR(4)
							,AD			VARCHAR(MAX)
							,SUTUN_TCKIMLIKNO	VARCHAR(2)
							,SUTUN_ADSOYAD		VARCHAR(2)
							,SUTUN_SESKAYDI		VARCHAR(2)
							,SUTUN_FOTOGRAF		VARCHAR(2)
							,SUTUN_OZELNOT		VARCHAR(2)
							,SORULIST			NVARCHAR(MAX))

					
					UPDATE A SET
						 A.DONEM			= T.DONEM
						,A.ID_KADEME3		= T.ID_KADEME3
						,A.AD				= T.AD
						,A.SUTUN_TCKIMLIKNO	= T.SUTUN_TCKIMLIKNO
						,A.SUTUN_ADSOYAD	= T.SUTUN_ADSOYAD
						,A.SUTUN_SESKAYDI	= T.SUTUN_SESKAYDI
						,A.SUTUN_FOTOGRAF	= T.SUTUN_FOTOGRAF
						,A.SUTUN_OZELNOT	= T.SUTUN_OZELNOT
						,A.KYD_TARIH		= GETDATE()
						,A.KYD_TCKIMLIKNO	= @TCKIMLIKNO
					FROM Assessment	A
					JOIN #TEMP2		T	ON	T.ID_ASSESSMENT	= A.ID_ASSESSMENT

					UPDATE S SET
						 S.AKTIF			= 0
						,S.KYI_TARIH		= GETDATE()
						,S.KYI_TCKIMLIKNO	= @TCKIMLIKNO
					FROM AssessmentSoru S
					JOIN #TEMP2			T	ON	T.ID_ASSESSMENT	= S.ID_ASSESSMENT

					UPDATE O SET
						O.AKTIF = 0
						,O.KYI_TARIH = GETDATE()
						,O.KYI_TCKIMLIKNO = @TCKIMLIKNO
					FROM AssessmentOgrenci O
					WHERE O.ID_ASSESSMENT = @ID_ASSESSMENT


					CREATE TABLE #SORULIST2 ( SORUNO				INT
											,SUTUN					VARCHAR(2)
											,ID_ASSESSMENT			INT
											,ID_ASSESSMENTKATEGORI	INT
											,CEVAP					VARCHAR(MAX)
											,SORU					VARCHAR(MAX)
											)
					
					SET @SORULIST = ( SELECT TOP 1 SORULIST FROM #TEMP2 )
					INSERT INTO #SORULIST2 (SORUNO, SUTUN, ID_ASSESSMENTKATEGORI, CEVAP, SORU, ID_ASSESSMENT)
					SELECT 
						 SORUNO					
						,SUTUN					
						,ID_ASSESSMENTKATEGORI	
						,CEVAP
						,SORU
						,@ID_ASSESSMENT
					FROM OPENJSON( @SORULIST )
					WITH (	 SORUNO		INT
							,SUTUN		VARCHAR(2)
							,ID_ASSESSMENTKATEGORI	INT
							,CEVAP		VARCHAR(MAX)
							,SORU		VARCHAR(MAX)
					)

					--SELECT * FROM AssessmentSoru

					INSERT INTO AssessmentSoru (ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,KYE_TCKIMLIKNO)
					SELECT ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,@TCKIMLIKNO FROM #SORULIST2
									
					DROP TABLE IF EXISTS #TEMP2
					DROP TABLE IF EXISTS #SORULIST2
										
					SELECT @ID_ASSESSMENT
				END

			END

			IF @ISLEM = 3	--	SINAV LİSTE					
			BEGIN

				SELECT ISNULL((
					SELECT	 A.AD
							,A.DONEM
							,A.ID_ASSESSMENT
							,A.ID_KADEME3
							,KL.AD+ ' ' + KL.SOYAD AS ADSOYAD							
							,K.AD AS KADEME3
							,KYE_TARIH = CONVERT(VARCHAR, A.KYE_TARIH ,104)
							,KYD_TARIH = ISNULL( CONVERT(VARCHAR, A.KYD_TARIH ,104) , '-')
							,A.AKTIF
					FROM Assessment			A
					JOIN v3Kademe3			K	ON	K.ID_KADEME3	= A.ID_KADEME3
					JOIN v3Kullanici		KL	ON	KL.TCKIMLIKNO	= A.KYE_TCKIMLIKNO
					LEFT JOIN v3Kullanici	KLD	ON	KLD.TCKIMLIKNO	= A.KYE_TCKIMLIKNO
					WHERE	( @PASIFGORUNSUN = 1 OR A.AKTIF = 1 )
						AND	A.ID_KADEME3 = @ID_KADEME3
						AND A.DONEM		 = @DONEM
					ORDER BY A.KYE_TARIH DESC
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 4	--	SINAV DETAY					
			BEGIN
			
				SELECT ISNULL((
					SELECT	 A.AD
							,A.DONEM
							,A.ID_KADEME3
							,A.SUTUN_FOTOGRAF
							,A.SUTUN_OZELNOT
							,A.SUTUN_ADSOYAD
							,A.SUTUN_SESKAYDI
							,A.SUTUN_TCKIMLIKNO
							,SORULIST.ID_ASSESSMENTSORU
							,SORULIST.CEVAP
							,SORULIST.SORU
							,SORULIST.ID_ASSESSMENTKATEGORI
							,SORULIST.SORUNO
							,SORULIST.SUTUN
							,[COUNT] = 1000
					FROM Assessment		A
					JOIN AssessmentSoru	SORULIST	ON	SORULIST.ID_ASSESSMENT	= A.ID_ASSESSMENT
					WHERE	A.AKTIF			= 1
						AND SORULIST.AKTIF	= 1
						AND A.ID_ASSESSMENT	= @ID_ASSESSMENT
					ORDER BY A.KYE_TARIH DESC, SORULIST.SORUNO
					FOR JSON AUTO
				),'[]')


			END

			IF @ISLEM = 5	--	ÖĞRENCİ YÜKLE				
			BEGIN
			
			
				DROP TABLE IF EXISTS #YEDEK
				DROP TABLE IF EXISTS #TEMP5
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #SORU
				DROP TABLE IF EXISTS #SORUDONGU

				DROP TABLE IF EXISTS #TEKOGR
				DROP TABLE IF EXISTS #TEKSORU

				DECLARE  @SUTUN_TCKIMLIKNO	VARCHAR(2)
						,@SUTUN_OZELNOT		VARCHAR(2)
						,@SUTUN_ADSOYAD		VARCHAR(2)
						,@SUTUN_SESKAYDI	VARCHAR(2)
						,@SUTUN_FOTOGRAF	VARCHAR(2)

				SELECT	 @SUTUN_TCKIMLIKNO	= SUTUN_TCKIMLIKNO
						,@SUTUN_OZELNOT		= SUTUN_OZELNOT
						,@SUTUN_SESKAYDI	= SUTUN_SESKAYDI
						,@SUTUN_FOTOGRAF	= SUTUN_FOTOGRAF
						,@SUTUN_ADSOYAD		= SUTUN_ADSOYAD
				FROM Assessment
				WHERE ID_ASSESSMENT = @ID_ASSESSMENT

				SELECT S.SORUNO, S.SUTUN, S.ID_ASSESSMENTSORU
				INTO #SORU
				FROM Assessment		A
				JOIN AssessmentSoru	S	ON	S.ID_ASSESSMENT = A.ID_ASSESSMENT
										AND S.AKTIF			= 1
				WHERE A.ID_ASSESSMENT = @ID_ASSESSMENT

				CREATE TABLE #TEMP5 (ID						INT IDENTITY(1,1)
									,ID_ASSESSMENTOGRENCI	INT
									,TCKIMLIKNO				VARCHAR(MAX)
									,OZELNOT				VARCHAR(MAX)
									,ADSOYAD				VARCHAR(MAX)
									,SESKAYDI				VARCHAR(MAX)
									,FOTOGRAF				VARCHAR(MAX)
									,JSONVALUE				VARCHAR(MAX) )

				
				SELECT 
					 RN						= ROW_NUMBER() OVER(PARTITION BY JSON_VALUE(E.VALUE, '$.'+@SUTUN_TCKIMLIKNO)  ORDER BY JSON_VALUE(E.VALUE, '$.'+@SUTUN_ADSOYAD))
					,TCKIMLIKNO				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_TCKIMLIKNO)
					,OZELNOT				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_OZELNOT)
					,ADSOYAD				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_ADSOYAD)
					,SESKAYDI				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_SESKAYDI)
					,FOTOGRAF				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_FOTOGRAF)
					,JSONVALUE				= E.VALUE
				INTO #YEDEK
				FROM OPENJSON (@EXCEL) E
				WHERE	JSON_VALUE(E.VALUE, '$.'+@SUTUN_TCKIMLIKNO) != ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_OZELNOT)	!= ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_ADSOYAD)	!= ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_SESKAYDI)	!= ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_FOTOGRAF)	!= ''


				INSERT INTO #TEMP5 (ID_ASSESSMENTOGRENCI, TCKIMLIKNO, OZELNOT, ADSOYAD, SESKAYDI, FOTOGRAF, JSONVALUE)
				SELECT NULL, SUBSTRING( TCKIMLIKNO,1,11), OZELNOT, ADSOYAD, SESKAYDI, FOTOGRAF, JSONVALUE FROM #YEDEK WHERE RN = 1

				DECLARE @ID5 TABLE(ID INT IDENTITY(1,1),ID_ASSESSMENTOGRENCI INT)

				UPDATE AssessmentOgrenci SET
					AKTIF = 0
					,KYI_TARIH = GETDATE()
					,KYI_TCKIMLIKNO = @TCKIMLIKNO
				WHERE ID_ASSESSMENT = @ID_ASSESSMENT

				UPDATE T SET
					T.ADSOYAD = K.AD + ' ' + K.SOYAD
				FROM #TEMP5 T
				JOIN v3Kullanici K ON K.TCKIMLIKNO = T.TCKIMLIKNO				


				INSERT INTO AssessmentOgrenci (ID_ASSESSMENT, TCKIMLIKNO, ADSOYAD, SESKAYDI, FOTOGRAF, OZELNOT, KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_ASSESSMENTOGRENCI INTO @ID5(ID_ASSESSMENTOGRENCI)
				SELECT @ID_ASSESSMENT, TCKIMLIKNO, ADSOYAD, SESKAYDI, FOTOGRAF, OZELNOT, @TCKIMLIKNO FROM #TEMP5 T ORDER BY T.ID
							
				
				UPDATE T SET
					ID_ASSESSMENTOGRENCI = I.ID_ASSESSMENTOGRENCI
				FROM #TEMP5	T
				JOIN @ID5	I	ON	I.ID = T.ID

				
				INSERT INTO AssessmentOgrenciCevap (ID_ASSESSMENTOGRENCI,ID_ASSESSMENTSORU,CEVAP)
				SELECT	 ID_ASSESSMENTOGRENCI
						,S.ID_ASSESSMENTSORU
						,CASE WHEN JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) IN ('Not answered','NOT ANSWERED') THEN NULL ELSE JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) END
				FROM #TEMP5  T
				CROSS APPLY #SORU S	


				--SELECT * INTO #DONGU FROM #TEMP5
				--WHILE EXISTS (SELECT TOP 1 ID FROM #DONGU)
				--BEGIN	
				--	DROP TABLE IF EXISTS #TEKOGR
				--	SELECT * INTO #TEKOGR FROM #DONGU ORDER BY 1 	
				--	DROP TABLE IF EXISTS #SORUDONGU
				--	SELECT * INTO #SORUDONGU FROM #SORU
				--	WHILE EXISTS (SELECT TOP 1 SORUNO FROM #SORUDONGU)
				--	BEGIN		
				--		DROP TABLE IF EXISTS #TEKSORU
				--		SELECT * INTO #TEKSORU FROM #SORUDONGU ORDER BY 1 
				--		INSERT INTO AssessmentOgrenciCevap (ID_ASSESSMENTOGRENCI,ID_ASSESSMENTSORU,CEVAP)
				--		SELECT	 ID_ASSESSMENTOGRENCI
				--				,S.ID_ASSESSMENTSORU
				--				,CASE WHEN JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) IN ('Not answered','NOT ANSWERED') THEN NULL ELSE JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) END
				--		FROM #TEKOGR  T
				--		CROSS APPLY #TEKSORU S	
				--		DELETE SD 
				--		FROM #SORUDONGU SD
				--		JOIN #TEKSORU	TS ON TS.ID_ASSESSMENTSORU = SD.ID_ASSESSMENTSORU
				--	END
				--	DELETE D 
				--	FROM #DONGU D
				--	JOIN #TEKOGR T	ON T.ID_ASSESSMENTOGRENCI = D.ID_ASSESSMENTOGRENCI
				--END

				
				DROP TABLE IF EXISTS #YEDEK
				DROP TABLE IF EXISTS #TEMP5
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #SORU
				DROP TABLE IF EXISTS #SORUDONGU

				DROP TABLE IF EXISTS #TEKOGR
				DROP TABLE IF EXISTS #TEKSORU

			END
						
			IF @ISLEM = 6	--	EŞLEŞMEYEN ÖĞRENCİ LİSTESİ	
			BEGIN
			
				SELECT  VK.TCKIMLIKNO,VK.AD,VK.SOYAD,RIGHT('000'+ VS.SUBENO,3)SUBENO,VS.AD SUBEAD,VSN.AD SINIF
				INTO	#T6
				FROM	V3Ogrenci			VO
				JOIN	V3Kullanici			VK	ON	VK.TCKIMLIKNO=VO.TCKIMLIKNO
				JOIN	V3SUBE				VS	ON	VS.ID_SUBE=VO.ID_SUBE
				JOIN	V3Sinif				VSN	ON	VSN.ID_SINIF=VO.ID_SINIF
				JOIN	v3KullaniciKademe3	VKK	ON	VKK.TCKIMLIKNO=VO.TCKIMLIKNO
				WHERE	ID_KADEME3 = @ID_KADEME3
					AND NOT EXISTS (SELECT TCKIMLIKNO FROM AssessmentOgrenci AO WHERE AO.TCKIMLIKNO = VK.TCKIMLIKNO AND ID_ASSESSMENT = @ID_ASSESSMENT)
				
				select(
					select * from(
						select 
						(
							SELECT * 
							FROM AssessmentOgrenci	AO
							WHERE	NOT EXISTS (SELECT TCKIMLIKNO FROM v3Kullanici K WHERE K.TCKIMLIKNO = AO.TCKIMLIKNO)
								AND	AO.ID_ASSESSMENT	= @ID_ASSESSMENT
								AND	AO.AKTIF			= 1
							FOR JSON AUTO
						) as t1,
						(
							select * from #T6
							order by SUBENO,SUBEAD,SINIF,AD,SOYAD
							FOR JSON AUTO
						) as t2					
					) as tablo FOR JSON AUTO
				) as tt
			

				DROP TABLE IF EXISTS #T6	
			END

			IF @ISLEM = 7	--	ÖĞRENCİ TC GUNCELLE			
			BEGIN
			
				UPDATE AO SET
					 AO.TCKIMLIKNO	= @TC_OGRENCI
					,AO.ADSOYAD		= CASE WHEN K.AD IS NULL THEN AO.ADSOYAD ELSE K.AD+' '+ K.SOYAD END
				FROM AssessmentOgrenci	AO
				LEFT JOIN v3Kullanici	K	ON	K.TCKIMLIKNO = @TC_OGRENCI
				WHERE ID_ASSESSMENTOGRENCI = @ID_ASSESSMENTOGRENCI

				SELECT ISNULL((
					SELECT ADSOYAD 
					FROM AssessmentOgrenci	AO
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = AO.TCKIMLIKNO
					WHERE ID_ASSESSMENTOGRENCI = @ID_ASSESSMENTOGRENCI
					FOR JSON AUTO
				),'[]')

			END
			
			IF @ISLEM = 8	--	ÖĞRENCİ SİL					
			BEGIN
			
				UPDATE AssessmentOgrenci SET
					 AKTIF = 0
					,KYI_TARIH = GETDATE()
					,KYI_TCKIMLIKNO = @TCKIMLIKNO
				WHERE ID_ASSESSMENTOGRENCI = @ID_ASSESSMENTOGRENCI

			END
			
			IF @ISLEM = 9	--	SINAV AKTİF PASİF YAP		
			BEGIN
			
				UPDATE Assessment SET
					 AKTIF = @AKTIF
					,KYD_TARIH = GETDATE()
					,KYD_TCKIMLIKNO = @TCKIMLIKNO
				WHERE ID_ASSESSMENT = @ID_ASSESSMENT

			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AssessmentOgrenciSinavRaporu]    Script Date: 22.11.2021 10:34:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AssessmentOgrenciSinavRaporu]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@ID_SUBEs				VARCHAR(MAX)= NULL,
	@DONEM					VARCHAR(MAX)= NULL,
	@ID_KADEME3				INT			= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,ID_SUBEs		= @ID_SUBEs				
				,DONEM			= @DONEM				
				,ID_KADEME3		= @ID_KADEME3			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN

			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU
			
			SELECT D.*
			INTO #TEMP
			FROM vw_AssessmentOgrenciCevapDurum	D
			JOIN Assessment						A	ON	A.ID_ASSESSMENT = D.ID_ASSESSMENT
			WHERE	A.ID_KADEME3	= @ID_KADEME3	
				AND A.DONEM			= @DONEM
				AND A.AKTIF			= 1
							
			SELECT  K.ID_ASSESSMENTKATEGORI, COUNT(1) SORUSAYISI,UPPER(K.AD) KATEGORI, S.ID_ASSESSMENT
			INTO #SORUSAYISI
			FROM AssessmentSoru		S			
			JOIN AssessmentKategori	K	ON	K.ID_ASSESSMENTKATEGORI = S.ID_ASSESSMENTKATEGORI
			WHERE	S.AKTIF	= 1
				AND S.ID_ASSESSMENT IN (SELECT DISTINCT ID_ASSESSMENT FROM #TEMP)
			GROUP BY K.ID_ASSESSMENTKATEGORI,K.AD, S.ID_ASSESSMENT
				
			SELECT DISTINCT T.ID_ASSESSMENTOGRENCI, ID_ASSESSMENTKATEGORI, A.ID_ASSESSMENT, O.TCKIMLIKNO
			INTO #OGRLIST
			FROM #TEMP				T
			JOIN Assessment			A	ON	A.ID_ASSESSMENT			= T.ID_ASSESSMENT
			JOIN AssessmentOgrenci	AO	ON	AO.ID_ASSESSMENTOGRENCI = T.ID_ASSESSMENTOGRENCI
			JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
			JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF
			WHERE	A.AKTIF	= 1
				AND AO.AKTIF= 1
				AND GS.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				
			SELECT 
				 ID_ASSESSMENTOGRENCI
				,ID_ASSESSMENT
				,TCKIMLIKNO
				,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.DURUM = 1) AS float) / NULLIF((SELECT SUM(SORUSAYISI) FROM #SORUSAYISI SS WHERE SS.ID_ASSESSMENT = O.ID_ASSESSMENT) , 0) * 100.0 AS decimal(8,2))
			INTO #GENELYUZDE
			FROM #OGRLIST O
			GROUP BY O.ID_ASSESSMENTOGRENCI, ID_ASSESSMENT, TCKIMLIKNO
			
			DECLARE @cols NVARCHAR(MAX)
			DECLARE @cols2 NVARCHAR(MAX)
			DECLARE @cols3 NVARCHAR(MAX)
			DECLARE @SQL NVARCHAR(MAX)
			DECLARE @SQL2 NVARCHAR(MAX) = ''

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.ID_ASSESSMENT )  FROM (SELECT DISTINCT T.ID_ASSESSMENT FROM #TEMP T) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols2 = STUFF((SELECT DISTINCT ',' +  'MAX(P.[' + CAST(C.ID_ASSESSMENT AS varchar)+']) AS '+ QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols3 = STUFF((SELECT			',' +  QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c ORDER BY ID_ASSESSMENT FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			
			DROP TABLE IF EXISTS #TEMP_TBL
			CREATE TABLE #TEMP_TBL( [TCKIMLIKNO]	VARCHAR(MAX),
									[KAMPÜS]		VARCHAR(MAX),
									[GRUP]			VARCHAR(MAX),
									[SINIF]			VARCHAR(MAX),
									[AD SOYAD]		VARCHAR(MAX))

			SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD INTO #DONGU FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT
			WHILE EXISTS(SELECT * FROM #DONGU)
			BEGIN
				DECLARE @SINAVAD VARCHAR(MAX) 
				DECLARE @ID_ASSESSMENT INT 

				SELECT TOP 1 @SINAVAD = SINAVAD, @ID_ASSESSMENT = ID_ASSESSMENT FROM #DONGU ORDER BY ID_ASSESSMENT
		 
				SET @SQL2  = @SQL2 + ' 
					ALTER TABLE #TEMP_TBL ADD ['+CAST(@SINAVAD AS varchar)+'] DECIMAL(8,2)
				'
				DELETE FROM #DONGU WHERE ID_ASSESSMENT = @ID_ASSESSMENT
			END

			EXEC(@SQL2)

			SET @SQL = '
					INSERT INTO #TEMP_TBL (  TCKIMLIKNO
											,'+@cols3+'
											,[AD SOYAD]				
											,[KAMPÜS]			
											,[GRUP]					
											,[SINIF]				
											)
					SELECT	 O.TCKIMLIKNO
							,'+@cols2+'
							,ADSOYAD = K.AD+'' ''+ K.SOYAD
							,GS.SUBEAD
							,GS.KADEME3
							,GS.SINIF							
					FROM (
						SELECT TCKIMLIKNO,YUZDE,ID_ASSESSMENT
						FROM #GENELYUZDE
					) AS D
					PIVOT ( SUM(YUZDE) FOR ID_ASSESSMENT IN ('+@cols+') ) AS P			
					JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= P.TCKIMLIKNO
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO			= O.TCKIMLIKNO
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF			
					GROUP BY K.AD+'' ''+ K.SOYAD,O.TCKIMLIKNO,SUBEAD,KADEME3,SINIF
			'

			PRINT @SQL
			EXEC(@SQL)
			
			IF @ISLEM = 1	--	JSON
			BEGIN
				SELECT ISNULL((				
					SELECT * FROM #TEMP_TBL
					ORDER BY [KAMPÜS], GRUP, SINIF, [AD SOYAD]
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END
			IF @ISLEM = 2	--	DATASET
			BEGIN
				SELECT * FROM #TEMP_TBL
				ORDER BY [KAMPÜS], GRUP, SINIF, [AD SOYAD]

			END

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AssessmentSinavaKatilmayanlar]    Script Date: 22.11.2021 10:36:47 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AssessmentSinavaKatilmayanlar]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@ID_ASSESSMENT			INT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SUBEs				= @ID_SUBEs				
				,ID_ASSESSMENT			= @ID_ASSESSMENT			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN					
			
			SELECT AO.TCKIMLIKNO
			INTO #KATILANLAR
			FROM AssessmentOgrenci AO	
			WHERE	AO.ID_ASSESSMENT = @ID_ASSESSMENT
				AND AO.AKTIF		 = 1

			SELECT  DISTINCT	
				 [Kampüs]	= GS.SUBEAD
				,[Grup]		= GS.KADEME3
				,[Sınıf]	= GS.SINIF
				,[Sınav Adı]= A.AD
				,[T.C. No]	= O.TCKIMLIKNO
				,[Ad Soyad]	= K.AD+' '+K.SOYAD
			FROM v3OgrenciTum		O	
			JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN Assessment			A	ON	A.ID_KADEME3	= GS.ID_KADEME3
										AND A.DONEM			= O.DONEM
			WHERE	A.ID_ASSESSMENT = @ID_ASSESSMENT
				AND O.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				AND O.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #KATILANLAR)

			DROP TABLE #KATILANLAR

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AssessmentSinavOgrenciRaporu]    Script Date: 22.11.2021 10:37:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AssessmentSinavOgrenciRaporu]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@ID_ASSESSMENT			INT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SUBEs				= @ID_SUBEs				
				,ID_ASSESSMENT			= @ID_ASSESSMENT			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU
			
			SELECT *
			INTO #TEMP
			FROM vw_AssessmentOgrenciCevapDurum
			WHERE	ID_ASSESSMENT = @ID_ASSESSMENT

			SELECT K.ID_ASSESSMENTKATEGORI, COUNT(1) SORUSAYISI,UPPER(K.AD) KATEGORI
			INTO #SORUSAYISI
			FROM AssessmentSoru		S
			JOIN AssessmentKategori	K	ON	K.ID_ASSESSMENTKATEGORI = S.ID_ASSESSMENTKATEGORI
			WHERE	ID_ASSESSMENT	= @ID_ASSESSMENT
				AND AKTIF			= 1
			GROUP BY K.ID_ASSESSMENTKATEGORI,K.AD

			SELECT DISTINCT T.ID_ASSESSMENTOGRENCI, ID_ASSESSMENTKATEGORI
			INTO #OGRLIST
			FROM #TEMP				T
			JOIN Assessment			A	ON	A.ID_ASSESSMENT			= T.ID_ASSESSMENT
			JOIN AssessmentOgrenci	AO	ON	AO.ID_ASSESSMENTOGRENCI = T.ID_ASSESSMENTOGRENCI
			JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
			JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF							
			WHERE	A.AKTIF		= 1
				AND AO.AKTIF	= 1
				AND GS.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))


			SELECT 
				 ID_ASSESSMENTOGRENCI
				,O.ID_ASSESSMENTKATEGORI
				,S.KATEGORI
				,S.SORUSAYISI 
				,DOGRUSAYISI = (SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.ID_ASSESSMENTKATEGORI = O.ID_ASSESSMENTKATEGORI AND T.DURUM = 1)
				,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.ID_ASSESSMENTKATEGORI = O.ID_ASSESSMENTKATEGORI AND T.DURUM = 1) AS float) / NULLIF(S.SORUSAYISI , 0) * 100.0 AS decimal(8,2))
			INTO #KATEGORIYUZDE
			FROM #OGRLIST O
			JOIN #SORUSAYISI S ON S.ID_ASSESSMENTKATEGORI = O.ID_ASSESSMENTKATEGORI



			SELECT 
				 ID_ASSESSMENTOGRENCI
				,DOGRUSAYISI = (SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.DURUM = 1)
				,(SELECT SUM(SORUSAYISI) FROM #SORUSAYISI) TOPLAMSORUSAYISI
				,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.DURUM = 1) AS float) / NULLIF((SELECT SUM(SORUSAYISI) FROM #SORUSAYISI) , 0) * 100.0 AS decimal(8,2))
			INTO #GENELYUZDE
			FROM #OGRLIST O
			GROUP BY O.ID_ASSESSMENTOGRENCI


			DECLARE @cols NVARCHAR(MAX)
			DECLARE @SQL NVARCHAR(MAX)
			DECLARE @SQL2 NVARCHAR(MAX) = ''

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.KATEGORI)  FROM #SORUSAYISI c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

			DROP TABLE IF EXISTS #TEMP_TBL
			CREATE TABLE #TEMP_TBL( ID_ASSESSMENTOGRENCI	INT,
									[KAMPÜS]		VARCHAR(MAX),
									[GRUP]			VARCHAR(MAX),
									[SINIF]			VARCHAR(MAX),
									[AD SOYAD]		VARCHAR(MAX),
									[SESKAYDI]		VARCHAR(MAX),
									[FOTOĞRAF]		VARCHAR(MAX),
									[ÖZEL NOT]		VARCHAR(MAX))

				SELECT DISTINCT KATEGORI INTO #DONGU FROM #SORUSAYISI
				WHILE EXISTS(SELECT * FROM #DONGU)
				BEGIN
					DECLARE @KATEGORI VARCHAR(MAX)  = (SELECT TOP 1 KATEGORI FROM #DONGU ORDER BY KATEGORI)
		 
					SET @SQL2  = @SQL2 + ' 
						ALTER TABLE #TEMP_TBL ADD ['+CAST(@KATEGORI AS varchar)+'] DECIMAL(8,2)
					'
					DELETE FROM #DONGU WHERE KATEGORI = @KATEGORI
				END				
				EXEC(@SQL2)
				ALTER TABLE #TEMP_TBL ADD [GENEL] DECIMAL(8,2)	



			SET @SQL = '
					INSERT INTO #TEMP_TBL (  ID_ASSESSMENTOGRENCI
											,'+@cols+'
											,[AD SOYAD]				
											,[KAMPÜS]			
											,[GRUP]					
											,[SINIF]				
											,[SESKAYDI]			
											,[FOTOĞRAF]	
											,[GENEL]
											,[ÖZEL NOT]				
											)
					SELECT	 P.*
							,AO.ADSOYAD
							,GS.SUBEAD
							,GS.KADEME3
							,GS.SINIF
							,AO.SESKAYDI
							,AO.FOTOGRAF
							,GENELYUZDE = GY.YUZDE
							,AO.OZELNOT
					FROM (
						SELECT KATEGORI,ID_ASSESSMENTOGRENCI,YUZDE 
						FROM #KATEGORIYUZDE
					) AS D
					PIVOT ( SUM(YUZDE) FOR KATEGORI IN ('+@cols+') ) AS P
					JOIN AssessmentOgrenci	AO	ON	AO.ID_ASSESSMENTOGRENCI = P.ID_ASSESSMENTOGRENCI
					JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF
					JOIN #GENELYUZDE		GY	ON	GY.ID_ASSESSMENTOGRENCI	= AO.ID_ASSESSMENTOGRENCI
					WHERE AO.AKTIF = 1		
			'

			PRINT @SQL
			EXEC(@SQL)


			
			IF @ISLEM = 1	--	JSON
			BEGIN
				SELECT ISNULL((				
					SELECT * FROM #TEMP_TBL
					ORDER BY [KAMPÜS], GRUP, SINIF, [AD SOYAD]
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END
			IF @ISLEM = 2	--	DATASET
			BEGIN
				SELECT * FROM #TEMP_TBL
				ORDER BY [KAMPÜS], GRUP, SINIF, [AD SOYAD]

			END

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AssessmentSinavSoruAnalizi]    Script Date: 22.11.2021 10:38:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AssessmentSinavSoruAnalizi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@ID_ASSESSMENT			INT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SUBEs				= @ID_SUBEs				
				,ID_ASSESSMENT			= @ID_ASSESSMENT			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN

		
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #DONGU
			DROP TABLE IF EXISTS #SORUYUZDE
			DROP TABLE IF EXISTS #SUBELIST
			DROP TABLE IF EXISTS #SORUGENELORT

			DECLARE @GENELSORUNO INT = 999999
			
			SELECT ID_SUBE, UPPER(AD) AS SUBEAD
			INTO #SUBELIST 
			FROM v3Sube
			WHERE ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			ORDER BY ID_SUBE
			
			SELECT D.*,O.ID_SUBE, O.TCKIMLIKNO
			INTO #TEMP
			FROM vw_AssessmentOgrenciCevapDurum	D
			JOIN AssessmentOgrenci				AO	ON	AO.ID_ASSESSMENTOGRENCI	= D.ID_ASSESSMENTOGRENCI
			JOIN v3Ogrenci						O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
			JOIN #SUBELIST						SL	ON	SL.ID_SUBE				= O.ID_SUBE
			WHERE	D.ID_ASSESSMENT = @ID_ASSESSMENT
				AND AO.AKTIF		= 1
						
			SELECT	 ID_ASSESSMENTSORU
					,SORUNO
					,ID_SUBE 
					,SORU
					,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTSORU = O.ID_ASSESSMENTSORU AND T.ID_SUBE = O.ID_SUBE AND T.DURUM = 1) AS float) / NULLIF(COUNT(O.ID_ASSESSMENTOGRENCI) , 0) * 100.0 AS decimal(8,2))
			INTO #SORUYUZDE
			FROM #TEMP	O
			GROUP BY ID_ASSESSMENTSORU, SORUNO, ID_SUBE, SORU

			INSERT INTO #SORUYUZDE (ID_ASSESSMENTSORU,SORUNO,SORU,ID_SUBE,YUZDE)			
			SELECT	 @GENELSORUNO
					,@GENELSORUNO
					,''
					,ID_SUBE 
					,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_SUBE = O.ID_SUBE AND T.DURUM = 1) AS float) / NULLIF(COUNT(O.ID_ASSESSMENTOGRENCI) , 0) * 100.0 AS decimal(8,2))			
			FROM #TEMP	O
			GROUP BY ID_SUBE 
			
			DECLARE @colsP NVARCHAR(MAX)
			DECLARE @colsPS NVARCHAR(MAX)
			DECLARE @colsIN NVARCHAR(MAX)
			DECLARE @SQL NVARCHAR(MAX)
			DECLARE @SQL2 NVARCHAR(MAX) = ''
						
			SET @colsP	= STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.ID_SUBE ) FROM #SUBELIST C FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @colsPS	= STUFF((	SELECT DISTINCT ',' + '(P.' + QUOTENAME( C.ID_SUBE ) + ') AS '+QUOTENAME( C.SUBEAD ) FROM #SUBELIST  C FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @colsIN	= STUFF((	SELECT			',' +  QUOTENAME( C.SUBEAD ) FROM #SUBELIST C ORDER BY C.ID_SUBE FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

			DROP TABLE IF EXISTS #TEMP_TBL
			CREATE TABLE #TEMP_TBL( ID_ASSESSMENTSORU	INT,
									[SORU NO]	VARCHAR(MAX),
									[SORU]		VARCHAR(MAX))

			SELECT DISTINCT SUBEAD INTO #DONGU FROM #SUBELIST
			WHILE EXISTS(SELECT * FROM #DONGU)
			BEGIN
				DECLARE @SUBEAD VARCHAR(MAX)  = (SELECT TOP 1 SUBEAD FROM #DONGU ORDER BY SUBEAD)
		 
				SET @SQL2  = @SQL2 + ' 
					ALTER TABLE #TEMP_TBL ADD [' + @SUBEAD + '] DECIMAL(8,2)
				'
				DELETE FROM #DONGU WHERE SUBEAD = @SUBEAD
			END				
			EXEC(@SQL2)
			ALTER TABLE #TEMP_TBL ADD [GENEL] DECIMAL(8,2)	

			SELECT	 ID_ASSESSMENTSORU
					,SORUNO
					,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTSORU = O.ID_ASSESSMENTSORU AND T.DURUM = 1) AS float) / NULLIF(COUNT(O.ID_ASSESSMENTOGRENCI) , 0) * 100.0 AS decimal(8,2))	
			INTO #SORUGENELORT
			FROM #TEMP  O
			GROUP BY ID_ASSESSMENTSORU, SORUNO
		UNION 
			SELECT	 @GENELSORUNO
					,@GENELSORUNO
					,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.DURUM = 1) AS float) / NULLIF(COUNT(O.ID_ASSESSMENTOGRENCI) , 0) * 100.0 AS decimal(8,2))	
			FROM #TEMP  O
						
			SET @SQL = '
					INSERT INTO #TEMP_TBL (  ID_ASSESSMENTSORU
											,[SORU NO]
											,[SORU]
											,'+@colsIN+'
											,[GENEL]
											)
					SELECT	 P.ID_ASSESSMENTSORU
							,CASE WHEN P.SORUNO	= '+CAST(@GENELSORUNO AS varchar)+' THEN ''GENEL'' ELSE CAST(P.SORUNO AS VARCHAR) + ''. SORU'' END
							,SORU
							,'+@colsPS+'
							,S.YUZDE
					FROM (
						SELECT ID_ASSESSMENTSORU, SORUNO, ID_SUBE,YUZDE, SORU
						FROM #SORUYUZDE
					) AS D
					PIVOT ( SUM(YUZDE) FOR ID_SUBE IN ('+@colsP+') ) AS P
					JOIN #SORUGENELORT S ON S.ID_ASSESSMENTSORU = P.ID_ASSESSMENTSORU
				'

			PRINT @SQL
			EXEC(@SQL)
						
			IF @ISLEM = 1	--	JSON
			BEGIN
				SELECT ISNULL((				
					SELECT * FROM #TEMP_TBL
					ORDER BY ID_ASSESSMENTSORU, [SORU NO]
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END
			IF @ISLEM = 2	--	DATASET
			BEGIN
				SELECT * FROM #TEMP_TBL
				ORDER BY ID_ASSESSMENTSORU, [SORU NO]
			END

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #DONGU
			DROP TABLE IF EXISTS #SORUYUZDE
			DROP TABLE IF EXISTS #SUBELIST
			DROP TABLE IF EXISTS #SORUGENELORT

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_AssessmentSinifSinavRaporu]    Script Date: 22.11.2021 10:38:45 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_AssessmentSinifSinavRaporu]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU
			
				,DONEM			= @DONEM				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP 
		

		IF @_ID_LOG > 0
		BEGIN

			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU
			DROP TABLE IF EXISTS #SINIFGENEL
			
			SELECT D.*
			INTO #TEMP
			FROM vw_AssessmentOgrenciCevapDurum	D
			JOIN Assessment						A	ON	A.ID_ASSESSMENT = D.ID_ASSESSMENT
			WHERE	A.DONEM	= @DONEM
				AND A.AKTIF	= 1

			SELECT  K.ID_ASSESSMENTKATEGORI, COUNT(1) SORUSAYISI,UPPER(K.AD) KATEGORI, S.ID_ASSESSMENT
			INTO #SORUSAYISI
			FROM AssessmentSoru		S			
			JOIN AssessmentKategori	K	ON	K.ID_ASSESSMENTKATEGORI = S.ID_ASSESSMENTKATEGORI
			WHERE	S.AKTIF	= 1
				AND S.ID_ASSESSMENT IN (SELECT DISTINCT ID_ASSESSMENT FROM #TEMP)
			GROUP BY K.ID_ASSESSMENTKATEGORI,K.AD, S.ID_ASSESSMENT

			SELECT DISTINCT T.ID_ASSESSMENTOGRENCI, ID_ASSESSMENTKATEGORI, A.ID_ASSESSMENT, O.TCKIMLIKNO, O.ID_SINIF
			INTO #OGRLIST
			FROM #TEMP				T
			JOIN Assessment			A	ON	A.ID_ASSESSMENT			= T.ID_ASSESSMENT
			JOIN AssessmentOgrenci	AO	ON	AO.ID_ASSESSMENTOGRENCI = T.ID_ASSESSMENTOGRENCI
			JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
			JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF
			WHERE	A.AKTIF	 = 1
				AND AO.AKTIF = 1
				
			SELECT 
				 ID_ASSESSMENTOGRENCI
				,ID_ASSESSMENT
				,TCKIMLIKNO
				,ID_SINIF
				,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.DURUM = 1) AS float) / NULLIF((SELECT SUM(SORUSAYISI) FROM #SORUSAYISI SS WHERE SS.ID_ASSESSMENT = O.ID_ASSESSMENT) , 0) * 100.0 AS decimal(8,2))
			INTO #GENELYUZDE
			FROM #OGRLIST O
			GROUP BY O.ID_ASSESSMENTOGRENCI, ID_ASSESSMENT, TCKIMLIKNO, ID_SINIF

			SELECT	 ID_SINIF
					,ID_ASSESSMENT
					,YUZDE = CAST(AVG(YUZDE) AS decimal(8,2))
			INTO #SINIFGENEL
			FROM #GENELYUZDE	GY
			GROUP BY ID_SINIF, ID_ASSESSMENT
			


			DECLARE @cols NVARCHAR(MAX)
			DECLARE @cols2 NVARCHAR(MAX)
			DECLARE @cols3 NVARCHAR(MAX)
			DECLARE @SQL NVARCHAR(MAX)
			DECLARE @SQL2 NVARCHAR(MAX) = ''
			
			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.ID_ASSESSMENT )  FROM (SELECT DISTINCT T.ID_ASSESSMENT FROM #TEMP T) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols2 = STUFF((SELECT DISTINCT ',' +  'MAX(P.[' + CAST(C.ID_ASSESSMENT AS varchar)+']) AS '+ QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols3 = STUFF((SELECT			',' +  QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c  ORDER BY ID_ASSESSMENT FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			
			DROP TABLE IF EXISTS #TEMP_TBL
			CREATE TABLE #TEMP_TBL( [ID_SINIF]		VARCHAR(MAX),
									[KAMPÜS]		VARCHAR(MAX),
									[GRUP]			VARCHAR(MAX),
									[SINIF]			VARCHAR(MAX),)

			SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD INTO #DONGU FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT
			WHILE EXISTS(SELECT * FROM #DONGU)
			BEGIN
				DECLARE @SINAVAD VARCHAR(MAX) 
				DECLARE @ID_ASSESSMENT INT 

				SELECT TOP 1 @SINAVAD = SINAVAD, @ID_ASSESSMENT = ID_ASSESSMENT FROM #DONGU ORDER BY ID_ASSESSMENT
		 
				SET @SQL2  = @SQL2 + ' 
					ALTER TABLE #TEMP_TBL ADD ['+CAST(@SINAVAD AS varchar)+'] DECIMAL(8,2)
				'
				DELETE FROM #DONGU WHERE ID_ASSESSMENT = @ID_ASSESSMENT
			END
			EXEC(@SQL2)
			
			SET @SQL = '
					INSERT INTO #TEMP_TBL (  ID_SINIF
											,'+@cols3+'
											,[KAMPÜS]
											,[GRUP]
											,[SINIF]
											)
					SELECT	 P.ID_SINIF
							,'+@cols2+'
							,GS.SUBEAD
							,GS.KADEME3
							,GS.SINIF							
					FROM (
						SELECT ID_SINIF,YUZDE,ID_ASSESSMENT
						FROM #SINIFGENEL
					) AS D
					PIVOT ( SUM(YUZDE) FOR ID_ASSESSMENT IN ('+@cols+') ) AS P			
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= P.ID_SINIF		
					GROUP BY P.ID_SINIF,SUBEAD,KADEME3,SINIF
							
					
			'

			PRINT @SQL
			EXEC(@SQL)
			
			IF @ISLEM = 1	--	JSON
			BEGIN
				SELECT ISNULL((				
					SELECT * FROM #TEMP_TBL
					ORDER BY [KAMPÜS], GRUP, SINIF
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END
			IF @ISLEM = 2	--	DATASET
			BEGIN
				SELECT * FROM #TEMP_TBL
				ORDER BY [KAMPÜS], GRUP, SINIF

			END

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_BirimYetki]    Script Date: 22.11.2021 10:39:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_BirimYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPI	INT				= NULL,
	@IP					VARCHAR(50)	= NULL
		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENUS			= @ID_MENUS		
			,ID_MENU			= @ID_MENU		
			,ID_KADEME			= @ID_KADEME		
			,ID_SUBEs			= @ID_SUBEs		
			,ID_KULLANICITIPI	= @ID_KULLANICITIPI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	 
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kademe Listele
		BEGIN
			SELECT DISTINCT KD.ID_KADEME, KD.AD
			FROM v3KullaniciKademe	S
			INNER JOIN OkyanusDB.[dbo].v3Kademe		KD	ON KD.ID_KADEME	= S.ID_KADEME
			--WHERE S.TCKIMLIKNO = @TCKIMLIKNO
			ORDER BY ID_KADEME ASC
		END
				
		IF @ISLEM = 2	--	Kullanici Tipi Listele
		BEGIN			
			select * from [dbo].[v3KullaniciTipi]
			--WHERE S.TCKIMLIKNO = @TCKIMLIKNO
			--WHERE ID_KULLANICITIPI<>1
			ORDER BY AD ASC
		END
				
		IF @ISLEM = 3	--	Birim Yetki Kaydet
		BEGIN			

			DELETE MenuYetki WHERE ID_KADEME=@ID_KADEME and ID_KULLANICITIPI=@ID_KULLANICITIPI			

			INSERT INTO MenuYetki(ID_KADEME,ID_KULLANICITIPI,ID_MENU) 
			((SELECT @ID_KADEME,@ID_KULLANICITIPI,Value FROM dbo.fn_Split(@ID_MENUS, ',', null) ) )

			--SELECT KOD,LEN(KOD) / 3 AS SAYI 
			--INTO #K 
			--FROM Menu M 
			--WHERE M.ID_MENU IN (SELECT ID_MENU FROM MenuYetki MY WHERE MY.ID_KADEME=@ID_KADEME and MY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
			

			--DECLARE @TABLE TABLE (ID_MENU INT)
			--DECLARE @I INT=0

			--WHILE @I<(SELECT MAX(SAYI) FROM #K)
			--BEGIN
			--	INSERT INTO @TABLE(ID_MENU)
			--	SELECT M.ID_MENU FROM MENU M WHERE M.KOD IN (SELECT SUBSTRING(KOD,1,(@I*3)) FROM #K)
				
			--	SET @I+=1
			--END


			--INSERT INTO MenuYetki(ID_KADEME,ID_KULLANICITIPI,ID_MENU) 			
			--(SELECT @ID_KADEME,@ID_KULLANICITIPI,ID_MENU FROM @TABLE T WHERE T.ID_MENU NOT IN (SELECT ID_MENU FROM MenuYetki MY WHERE MY.ID_KADEME=@ID_KADEME and MY.ID_KULLANICITIPI=@ID_KULLANICITIPI))
			
			--DROP TABLE #K


			
		END
			
		IF @ISLEM = 4	--	Kullanıcı Kademe Listele
		BEGIN

			SELECT ISNULL((
				SELECT DISTINCT KD.ID_KADEME, KD.AD
				FROM		v3KullaniciKademe			S
				INNER JOIN	v3SubeYetki					SY	ON	SY.TCKIMLIKNO	= S.TCKIMLIKNO
				INNER JOIN	OkyanusDB.[dbo].v3Kademe	KD	ON	KD.ID_KADEME	= S.ID_KADEME
				WHERE	S.TCKIMLIKNO = @TCKIMLIKNO
					AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				ORDER BY ID_KADEME ASC
				FOR JSON AUTO
			),'[]')
		END

	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Bulten]    Script Date: 22.11.2021 10:40:07 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Bulten]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@YAYIN_TARIH			VARCHAR(MAX)    = NULL,
	@YAYIN_BITIS			VARCHAR(MAX)	= NULL,
	@SINIF_LIST				VARCHAR(MAX)    = NULL,
	@DOSYA_GUID				VARCHAR(MAX)	= NULL,
	@ID_BULTEN				INT			    = NULL,
	@YAYINDA				BIT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN			
			IF @ISLEM = 1	--	BÜLTEN LİSTESİ			
			BEGIN
				SELECT SO.ID_SUBE, S.ID_SINIF, S.ID_KADEME3 
				INTO #OGRENCISUBESINIF
				FROM OkyanusDB.dbo.v3Ogrenci SO
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif S ON S.ID_SINIF = SO.ID_SINIF
				WHERE TCKIMLIKNO = @TC_OGRENCI
				UNION
				SELECT S.ID_SUBE, S.ID_SINIF, S.ID_KADEME3 FROM OkyanusDB.dbo.v4SinifOgrenci SO
				INNER JOIN OkyanusDB.dbo.v4Sinif S ON S.ID_SINIF = SO.ID_SINIF AND S.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3AktifDonem D ON D.DONEM = S.DONEM AND D.AKTIF = 1
				WHERE TC_OGRENCI = @TC_OGRENCI AND SO.AKTIF = 1

				SELECT
				ISNULL(
				(
					SELECT 
						TARIH = B.YAYIN_TARIH
					   ,DERS  = B.DERS
					   ,B.ACIKLAMA
					   ,EKLEYEN = K.AD + ' ' + K.SOYAD
					   ,B.DOSYA_GUID
					   ,B.LINK
					   ,B.BASLIK		
					FROM Bulten								B
					JOIN OkyanusDB.dbo.v3Kullanici			K  ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
					JOIN BultenSinif						BS ON BS.ID_BULTEN = B.ID_BULTEN 
					WHERE B.AKTIF = 1 AND YAYIN_TARIH <= (CAST (GETDATE() AS DATE)) AND YAYIN_BITIS >= (CAST (GETDATE() AS DATE))
				    AND	(BS.ID_SINIF IN (SELECT O.ID_SINIF FROM #OGRENCISUBESINIF O) OR BS.ID_SINIF = 0)
					ORDER BY B.YAYIN_TARIH DESC
					FOR JSON PATH
				 ), '[]')

				--SELECT
				--ISNULL(
				--(
				--	SELECT distinct D.ID_DOKUMHAN,
				--					D.ACIKLAMA,
				--					D.DOSYA,
				--					isnull(nullif(D.ICERIK,''),'yok') AS ICERIK,
				--					Convert(varchar(50),D.YAYINTARIHI,104) as TARIH,
				--					ISNULL((SELECT DOSYA as AD, RIGHT(DOSYA, 3) AS UZANTI FROM eokul_v2.dbo.DokumanDosya DD WHERE DD.ID_DOKUMAN = D.ID_DOKUMHAN FOR JSON PATH), '[]') as DOSYALAR,
				--					isnull(D.LINK,'') AS LINK,
				--					isnull(D.DERS,'') AS DERS,
				--					isnull(K.AD+' '+K.SOYAD,'') as EKLEYEN,
				--					'BUL' as MODUL,
				--					ID_KULLANICI=0,
				--					D.SILINMETARIHI,
				--					D.YAYINTARIHI
				--	FROM eokul_v2.dbo.Dokumhan D
				--	INNER JOIN eokul_v2.dbo.DokumhanYetki DY ON DY.ID_DOKUMHAN = D.ID_DOKUMHAN
				--	INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.AD = DY.GRUP
				--	INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = D.TC_KULLANICI
				--	WHERE D.IPTAL = 0
				--	AND (DY.ID_SUBE IN (SELECT O.ID_SUBE FROM #OGRENCISUBESINIF O))
				--	AND (DY.ID_SINIF IN (SELECT O.ID_SINIF FROM #OGRENCISUBESINIF O) OR DY.ID_SINIF = 0)
				--	AND (K3.ID_KADEME3 IN (SELECT O.ID_KADEME3 FROM #OGRENCISUBESINIF O) OR DY.GRUP = '')
				--	AND d.SILINMETARIHI  >= CAST(GETDATE() as date)
				--	AND d.YAYINTARIHI    <= CAST(GETDATE() as date)
				--	order by d.YAYINTARIHI desc, d.ID_DOKUMHAN desc
				--	FOR JSON PATH
				--), '[]')

				DROP TABLE #OGRENCISUBESINIF
			END

			IF @ISLEM = 2   --  Bülten Ekle
			BEGIN			

				CREATE TABLE #BULTEN(ID_BULTEN INT)

				INSERT INTO  Bulten (DERS,BASLIK,LINK,ACIKLAMA,YAYIN_TARIH,YAYIN_BITIS,KYE_TCKIMLIKNO,KYE_TARIH,AKTIF)
				OUTPUT INSERTED.ID_BULTEN INTO #BULTEN(ID_BULTEN)
				SELECT Ders,Baslik,Link,Aciklama,@YAYIN_TARIH,@YAYIN_BITIS,@TCKIMLIKNO,GETDATE(),1
				FROM OPENJSON(@SQLJSON)
				WITH
				(
				  Ders			 VARCHAR(MAX),
				  Baslik		 VARCHAR(MAX),
				  Link			 VARCHAR(MAX),
				  Aciklama		 VARCHAR(MAX)
				)

				INSERT INTO BultenSinif(ID_BULTEN,ID_SINIF)
				SELECT (SELECT ID_BULTEN FROM #BULTEN),S.VALUE
				FROM OPENJSON(@SINIF_LIST)		S WHERE S.VALUE > 0

				SELECT ID_BULTEN FROM #BULTEN
			END

			IF @ISLEM = 3   -- Bülten Dosya Kaydet
			BEGIN
				UPDATE Bulten SET DOSYA_GUID = @DOSYA_GUID WHERE ID_BULTEN = @ID_BULTEN
			END
			IF @ISLEM = 4   -- Bülten Listele
			BEGIN
				IF @YAYINDA = 1
				BEGIN
				SELECT ISNULL((
						SELECT 
							 ID_BULTEN
							,BASLIK
							,CAST(FORMAT(YAYIN_TARIH,'dd.MM.yyyy') AS VARCHAR(MAX)) + ' - ' + CAST(FORMAT(YAYIN_BITIS,'dd.MM.yyyy') AS VARCHAR(MAX)) AS TARIH
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM Bulten					B
						JOIN v3Kullanici			K ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
						WHERE YAYIN_TARIH <= (CAST (GETDATE() AS DATE)) AND YAYIN_BITIS >= (CAST (GETDATE() AS DATE)) AND B.AKTIF = 1
						ORDER BY YAYIN_TARIH
						FOR JSON PATH
				),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT 
							 ID_BULTEN
							,BASLIK
							,CAST(FORMAT(YAYIN_TARIH,'dd.MM.yyyy') AS VARCHAR(MAX)) + ' - ' + CAST(FORMAT(YAYIN_BITIS,'dd.MM.yyyy') AS VARCHAR(MAX)) AS TARIH
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM Bulten					B
						JOIN v3Kullanici			K ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
						WHERE NOT(YAYIN_TARIH <= (CAST (GETDATE() AS DATE)) AND YAYIN_BITIS >= (CAST (GETDATE() AS DATE))) AND B.AKTIF = 1
						ORDER BY YAYIN_TARIH
						FOR JSON PATH
				),'[]')
				END
			END

			IF @ISLEM = 5   -- Bülten Sil
			BEGIN
				UPDATE Bulten SET AKTIF = 0 WHERE ID_BULTEN = @ID_BULTEN
				IF @YAYINDA = 1
				BEGIN
				SELECT ISNULL((
						SELECT 
							 ID_BULTEN
							,BASLIK
							,CAST(FORMAT(YAYIN_TARIH,'dd.MM.yyyy') AS VARCHAR(MAX)) + ' - ' + CAST(FORMAT(YAYIN_BITIS,'dd.MM.yyyy') AS VARCHAR(MAX)) AS TARIH
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM Bulten					B
						JOIN v3Kullanici			K ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
						WHERE YAYIN_TARIH <= (CAST (GETDATE() AS DATE)) AND YAYIN_BITIS >= (CAST (GETDATE() AS DATE)) AND B.AKTIF = 1
						ORDER BY YAYIN_TARIH
						FOR JSON PATH
				),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT 
							 ID_BULTEN
							,BASLIK
							,CAST(FORMAT(YAYIN_TARIH,'dd.MM.yyyy') AS VARCHAR(MAX)) + ' - ' + CAST(FORMAT(YAYIN_BITIS,'dd.MM.yyyy') AS VARCHAR(MAX)) AS TARIH
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM Bulten					B
						JOIN v3Kullanici			K ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
						WHERE NOT(YAYIN_TARIH <= (CAST (GETDATE() AS DATE)) AND YAYIN_BITIS >= (CAST (GETDATE() AS DATE))) AND B.AKTIF = 1
						ORDER BY YAYIN_TARIH
						FOR JSON PATH
				),'[]')
				END
			END

			IF @ISLEM = 6   -- Bülten Getir 
			BEGIN
				SELECT ISNULL((
					SELECT 
						DERS
					   ,BASLIK
					   ,LINK
					   ,ACIKLAMA
					   ,YAYIN_TARIH
					   ,YAYIN_BITIS					   
					FROM BULTEN B
					WHERE ID_BULTEN = @ID_BULTEN
					FOR JSON PATH
				),'{}')				
			END

			IF @ISLEM = 7  -- Bülten Düzenle
			BEGIN				
				UPDATE B 
				SET B.DERS = J.Ders,B.BASLIK = J.Baslik, B.LINK = J.Link,B.ACIKLAMA = J.Aciklama, B.YAYIN_TARIH = @YAYIN_TARIH, B.YAYIN_BITIS = @YAYIN_BITIS
				FROM Bulten as B
				JOIN OPENJSON(@SQLJSON)
				WITH (
				  ID_BULTEN		 INT,
				  Ders			 VARCHAR(MAX),
				  Baslik		 VARCHAR(MAX),
				  Link			 VARCHAR(MAX),
				  Aciklama		 VARCHAR(MAX)
				) AS J ON J.ID_BULTEN = B.ID_BULTEN WHERE B.ID_BULTEN = @ID_BULTEN

				SELECT @ID_BULTEN
			END	
		END	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_BurslulukBursOraniBelirle]    Script Date: 22.11.2021 10:40:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_BurslulukBursOraniBelirle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@BURSTUR			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
		DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
		DECLARE @LOGJSON VARCHAR(MAX)

		SET @LOGJSON = (
			SELECT	 
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENU			= @ID_MENU		
			,ID_SINAV			= @ID_SINAV		
			,ID_SINAVDERS		= @ID_SINAVDERS	
			,BURSTUR			= @BURSTUR		
			,SQLJSON			= @SQLJSON		
			FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
		)	

		DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM =@OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	EXCEL OGRENCI KAYDETME	
		BEGIN
			SELECT (
				SELECT *
				FROM BurslulukSinavBursOrani
				WHERE	ID_SINAV = @ID_SINAV
					AND BURSTUR  = @BURSTUR
					AND (	@BURSTUR = 1 
						OR	(@BURSTUR= 2 AND ID_SINAVDERS = @ID_SINAVDERS ))
				FOR JSON AUTO
			) AS J
		END

		IF @ISLEM = 2	--	BURS ORANI EKLE			
		BEGIN
			SELECT 
				 ID_SINAV		= ID_SINAV	
				,MIN_DEGER		= MIN_DEGER	
				,MAX_DEGER		= MAX_DEGER	
				,BURSORANI		= BURSORANI
				,BURSTUR		= BURSTUR
				,OGRENCISAYISI	= OGRENCISAYISI	
			INTO #BURSORAN	
			FROM OPENJSON (@SQLJSON)
			WITH (
				 ID_SINAV		INT
				,MIN_DEGER		DECIMAL(8,3)
				,MAX_DEGER		DECIMAL(8,3)
				,BURSORANI		DECIMAL(8,3)
				,BURSTUR		INT
				,OGRENCISAYISI	INT
			) AS J


			SELECT * 
			INTO #ORANKAYDET
			FROM #BURSORAN
			WHERE	(MIN_DEGER		> 0 AND MIN_DEGER		IS NOT NULL)
			--	AND (MAX_DEGER		> 0 AND MAX_DEGER		IS NOT NULL)
				AND (BURSORANI		> 0 AND BURSORANI		IS NOT NULL)
				AND (	BURSTUR = 1
					OR	(	BURSTUR != 1 
						AND (MAX_DEGER		> 0 AND MAX_DEGER		IS NOT NULL)
						)
					)
				AND (	BURSTUR != 1
					OR	(	BURSTUR = 1 
						AND (OGRENCISAYISI	> 0 AND OGRENCISAYISI	IS NOT NULL)
						)
					)


			DELETE FROM BO
			FROM BurslulukSinavBursOrani BO
			JOIN #BURSORAN				 B	ON	B.ID_SINAV	= BO.ID_SINAV
											AND	B.BURSTUR	= BO.BURSTUR
											AND (	(B.BURSTUR	= 2 AND BO.ID_SINAVDERS = @ID_SINAVDERS)
												OR	B.BURSTUR	= 1
												)


			INSERT INTO BurslulukSinavBursOrani (
				 ID_SINAV	
				,MIN_DEGER	
				,MAX_DEGER	
				,BURSORANI	
				,BURSTUR
				,OGRENCISAYISI
				,ID_SINAVDERS
			)
			SELECT   ID_SINAV	
					,MIN_DEGER	
					,MAX_DEGER	
					,BURSORANI	
					,BURSTUR
					,CASE WHEN BURSTUR = 1 THEN OGRENCISAYISI ELSE NULL END
					,CASE WHEN BURSTUR = 2 THEN @ID_SINAVDERS ELSE NULL END
			FROM #ORANKAYDET
			ORDER BY BURSORANI desc, MAX_DEGER desc, MIN_DEGER desc

			SELECT COUNT(1) FROM #ORANKAYDET

		END
		

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	go
	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_BurslulukOgrenciIslemleri]    Script Date: 22.11.2021 10:40:54 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_BurslulukOgrenciIslemleri]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_BURSLULUKDOSYA	INT				= NULL,
	@ID_BURSOGRENCI		INT				= NULL,
	@RAPORGENEL			BIT				= NULL,
	@DOSYAADI			VARCHAR(50)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@ID_SINAVs			NVARCHAR(MAX)	= NULL,
	@displayLength		INT				= 0,
	@displayStart		INT				= 0,
	@whereClause		VARCHAR(MAX)	='',
	@orderByClause		VARCHAR(MAX)	='',
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT			
				ISLEM				 =@ISLEM				
				,TCKIMLIKNO			 =@TCKIMLIKNO			
				,OTURUM				 =@OTURUM				
				,ID_MENU			 =@ID_MENU			
				,ID_BURSLULUKDOSYA	 =@ID_BURSLULUKDOSYA	
				,ID_BURSOGRENCI		 =@ID_BURSOGRENCI		
				,RAPORGENEL			 =@RAPORGENEL			
				,DOSYAADI			 =@DOSYAADI			
				,DONEM				 =@DONEM				
				,ID_SINAVs			 =@ID_SINAVs			
				,displayLength		 =@displayLength		
				,displayStart		 =@displayStart		
				,whereClause		 =@whereClause		
				,orderByClause		 =@orderByClause		
				,SQLJSON			 =@SQLJSON							
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	EXCEL OGRENCI KAYDETME	
		BEGIN

			DECLARE @ID_TABLE TABLE ( ID INT )			
			
			INSERT INTO BurslulukDosya (AD, DONEM)
			OUTPUT INSERTED.ID_BURSLULUKDOSYA INTO @ID_TABLE(ID)
			VALUES (@DOSYAADI, (SELECT TOP 1 DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1))

			SET @ID_BURSLULUKDOSYA = (SELECT TOP 1 ID FROM @ID_TABLE)

			INSERT INTO BurslulukSinavOgrenci (
				 TCKIMLIKNO		
				,OGRENCI_ADSOYAD
				,OKULADI		
				,SINIFDUZEYI
				,SUBEAD
				,VELI_ADSOYAD	
				,MAIL			
				,TELEFON_EV		
				,TELEFON_CEP	
				,BASVURUTARIH	
				,SINAVTARIH		
				,SEANS
				,ID_KADEME3
				,ID_SUBE
				,ID_SINAV
				,ID_BURSLULUKDOSYA
			)
			SELECT 
				 TCKIMLIKNO			= J.TCKIMLIKNO		
				,OGRENCI_ADSOYAD	= J.OGRENCI_ADSOYAD
				,OKULADI			= J.OKULADI		
				,SINIFDUZEYI		= J.SINIFDUZEYI
				,SUBEAD				= J.SUBEAD
				,VELI_ADSOYAD		= J.VELI_ADSOYAD	
				,MAIL				= J.MAIL			
				,TELEFON_EV			= J.TELEFON_EV		
				,TELEFON_CEP		= J.TELEFON_CEP	
				,BASVURUTARIH		= CAST(J.BASVURUTARIH AS date) 
				,SINAVTARIH			= CAST(J.SINAVTARIH	AS date) 
				,SEANS				= J.SEANS
				,ID_KADEME3			= K3.ID_KADEME3
				,ID_SUBE			= ISNULL(SB.ID_SUBE,0)
				,ID_SINAV			= ISNULL(S.ID_SINAV,0)
				,ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
			FROM OPENJSON(@SQLJSON)
			WITH(
				 TCKIMLIKNO			VARCHAR(MAX)
				,OGRENCI_ADSOYAD	VARCHAR(MAX)
				,OKULADI			VARCHAR(MAX)
				,SINIFDUZEYI		VARCHAR(MAX)
				,SUBEAD            	VARCHAR(MAX)
				,VELI_ADSOYAD		VARCHAR(MAX)
				,MAIL				VARCHAR(MAX)
				,TELEFON_EV			VARCHAR(MAX)
				,TELEFON_CEP		VARCHAR(MAX)
				,BASVURUTARIH		VARCHAR(MAX)
				,SINAVTARIH			VARCHAR(MAX)
				,SEANS				VARCHAR(MAX)
			) AS J
			LEFT JOIN v3Sube	SB	ON  SB.AD  = REPLACE( J.SUBEAD, 'Okyanus Koleji-', '')
			LEFT JOIN v3Kademe3	K3	ON	SUBSTRING( K3.AD, 0, CHARINDEX('.', K3.AD, 0))	= SUBSTRING( SINIFDUZEYI, 0, CHARINDEX('.', SINIFDUZEYI, 0))
			LEFT JOIN Sinav		S	ON	S.ID_SINAV IN (SELECT VALUE FROM OPENJSON (@ID_SINAVs))
									AND S.ID_KADEME3	= K3.ID_KADEME3
			WHERE J.TCKIMLIKNO != ''
			
			SELECT @ID_BURSLULUKDOSYA


		END

		IF @ISLEM = 2	--	OGRENCI LISTE			
		BEGIN
			SELECT TCKIMLIKNO
			INTO #OGRLIST
			FROM BurslulukSinavOgrenci
			WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA
			GROUP BY TCKIMLIKNO
			HAVING COUNT(1)>1
			
			SELECT 
				 BO.TCKIMLIKNO
				,BO.OGRENCI_ADSOYAD	
				,BO.SINIFDUZEYI		
				,BO.SUBEAD			
				,BO.SEANS			
				,ISLEM = '
							<button type="button" class="btn yellow" onclick="funcOgrenciDuzenleModalAc('+CAST(BO.ID_BURSOGRENCI AS VARCHAR)+')">Düzenle</button>
							<button type="button" class="btn red   " onclick="funcBurslulukOgrenciSil('  +CAST(BO.ID_BURSOGRENCI AS VARCHAR)+')">Sil</button>
						'
				,TCKIMLIKNOHTML		= '<div '+ 
										CASE WHEN OL.TCKIMLIKNO IS NOT NULL THEN 'style="color:red"' ELSE '' END 
									  +'>'+BO.TCKIMLIKNO+'</div>'
				,BO.OKULADI			
				,BO.ID_BURSOGRENCI
				,BO.VELI_ADSOYAD	
				,BO.MAIL			
				,BO.TELEFON_EV		
				,BO.TELEFON_CEP		
				,BO.BASVURUTARIH	
				,BO.SINAVTARIH		
				,BO.ID_KADEME3		
				,BO.ID_SUBE			
				,TCVAR = CASE WHEN OL.TCKIMLIKNO IS NOT NULL THEN 1 ELSE 0 END 
			INTO #TEMPx
			FROM BurslulukSinavOgrenci	BO
			LEFT JOIN #OGRLIST			OL	ON	OL.TCKIMLIKNO	= BO.TCKIMLIKNO
			WHERE ID_BURSLULUKDOSYA		= @ID_BURSLULUKDOSYA


			--SELECT ISNULL((
			--	SELECT 
			--	 BO.ID_BURSOGRENCI
			--	,BO.TCKIMLIKNO		
			--	,BO.OGRENCI_ADSOYAD	
			--	,BO.OKULADI			
			--	,BO.SINIFDUZEYI		
			--	,BO.SUBEAD			
			--	,BO.VELI_ADSOYAD	
			--	,BO.MAIL			
			--	,BO.TELEFON_EV		
			--	,BO.TELEFON_CEP		
			--	,BO.BASVURUTARIH	
			--	,BO.SINAVTARIH		
			--	,BO.SEANS			
			--	,BO.ID_KADEME3		
			--	,BO.ID_SUBE			
			--	,TCVAR = CASE WHEN OL.TCKIMLIKNO IS NOT NULL THEN 1 ELSE 0 END 

			--	FROM BurslulukSinavOgrenci	BO
			--	LEFT JOIN #OGRLIST			OL	ON	OL.TCKIMLIKNO	= BO.TCKIMLIKNO
			--	WHERE ID_BURSLULUKDOSYA		= @ID_BURSLULUKDOSYA
			--	FOR JSON PATH
			--),'') AS OGRENCILISTE

			DROP TABLE IF EXISTS #OGRLIST


			
				DECLARE @COLUMNNAME VARCHAR(MAX) = (SELECT name FROM tempdb.sys.columns where object_id = object_id('tempdb..#TEMPx')  AND column_id = (SELECT JSON_Value (value, '$.column') FROM OPENJSON(@SQLJSON,'$.order')))
				SET @orderByClause = (SELECT ' ORDER BY TCVAR desc, CASE WHEN TCVAR = 1 THEN TCKIMLIKNO END ,'+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
				SET @whereClause = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				SET @displayStart = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT))
				SET @displayLength = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				--IF	@whereClause=''
				--BEGIN
				--	SET @whereClause='where ID_BURSLULUKDOSYA='''+@ID_BURSLULUKDOSYA+''''
				--END
				--ELSE
				BEGIN
					DECLARE @COLUMNS VARCHAR(max) = ''					
					SET @COLUMNS='('+(SELECT ' ' + name + ' LIKE ''%' + @whereClause + '%'' OR' AS [text()] FROM tempdb.sys.columns WHERE object_id = object_id('tempdb..#TEMPx')
					For XML PATH (''))+')'
					SET @COLUMNS = SUBSTRING(@COLUMNS,1,LEN(@COLUMNS)-3)+') '
					SET @whereClause='WHERE '+@COLUMNS
					--SET @whereClause=@whereClause+' and ID_BURSLULUKDOSYA='''+@ID_BURSLULUKDOSYA+''''
				END
				Declare @query varchar(MAX)
				set @query='
							SELECT * INTO #TEMP FROM   
									(
										SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * FROM(
											SELECT
											*  FROM #TEMPx
											'+@whereClause+'
										) 
									RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))
									+ '
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM #TEMPx) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'
				execute (@query)
				
							DROP TABLE #TEMPx

		END

		IF @ISLEM = 3	--	OGRENCI DUZENLE			
		BEGIN

			UPDATE BO SET			
				 BO.TCKIMLIKNO		= J.TCKIMLIKNO		
				,BO.OGRENCI_ADSOYAD	= J.OGRENCI_ADSOYAD
				,BO.OKULADI			= J.OKULADI		
				,BO.SINIFDUZEYI		= J.SINIFDUZEYI
				,BO.SUBEAD			= J.SUBEAD
				,BO.VELI_ADSOYAD	= J.VELI_ADSOYAD	
				,BO.MAIL			= J.MAIL			
				,BO.TELEFON_EV		= J.TELEFON_EV		
				,BO.TELEFON_CEP		= J.TELEFON_CEP	
				,BO.BASVURUTARIH	= CAST(J.BASVURUTARIH AS date) 
				,BO.SINAVTARIH		= CAST(J.SINAVTARIH	AS date) 
				,BO.SEANS			= J.SEANS
				,BO.ID_KADEME3		= K3.ID_KADEME3
				,BO.ID_SUBE			= ISNULL(SB.ID_SUBE,0)
				,BO.ID_SINAV		= ISNULL(S.ID_SINAV,0)
			FROM OPENJSON(@SQLJSON)
			WITH(
				 ID_BURSOGRENCI		INT
				,TCKIMLIKNO			VARCHAR(MAX)
				,OGRENCI_ADSOYAD	VARCHAR(MAX)
				,OKULADI			VARCHAR(MAX)
				,SINIFDUZEYI		VARCHAR(MAX)
				,SUBEAD            	VARCHAR(MAX)
				,VELI_ADSOYAD		VARCHAR(MAX)
				,MAIL				VARCHAR(MAX)
				,TELEFON_EV			VARCHAR(MAX)
				,TELEFON_CEP		VARCHAR(MAX)
				,BASVURUTARIH		VARCHAR(MAX)
				,SINAVTARIH			VARCHAR(MAX)
				,SEANS				VARCHAR(MAX)
			) AS J
			JOIN BurslulukSinavOgrenci		BO	ON	BO.ID_BURSOGRENCI	= J.ID_BURSOGRENCI
			LEFT JOIN v3Sube				SB	ON  SB.AD  = REPLACE( J.SUBEAD, 'Okyanus Koleji-', '')
			LEFT JOIN v3Kademe3				K3	ON	SUBSTRING( K3.AD, 0, CHARINDEX('.', K3.AD, 0))	= SUBSTRING( J.SINIFDUZEYI, 0, CHARINDEX('.', J.SINIFDUZEYI, 0))			
			LEFT JOIN Sinav					S	ON	S.ID_SINAV	= (SELECT TOP 1 ID_SINAV FROM BurslulukSinavOgrenci	BO2	WHERE BO2.ID_BURSLULUKDOSYA	= BO.ID_BURSLULUKDOSYA AND BO2.ID_KADEME3 = K3.ID_KADEME3)
			SELECT 1 

		END

		IF @ISLEM = 4	--	OGRENCI SIL				
		BEGIN
			DELETE FROM BurslulukSinavOgrenci WHERE ID_BURSOGRENCI = @ID_BURSOGRENCI
			SELECT @ID_BURSOGRENCI
		END

		IF @ISLEM = 5	--	OGRENCI LISTESI RAPOR	
		BEGIN

			SELECT 
				 BO.ID_BURSOGRENCI
				,BO.TCKIMLIKNO		
				,BO.OGRENCI_ADSOYAD	
				,BO.OKULADI			
				,BO.SINIFDUZEYI		
				,BO.SUBEAD			
				,BO.VELI_ADSOYAD	
				,BO.MAIL			
				,BO.TELEFON_EV		
				,BO.TELEFON_CEP		
				,CONVERT(VARCHAR, BO.BASVURUTARIH,104)BASVURUTARIH
				,CONVERT(VARCHAR, BO.SINAVTARIH	 ,104)SINAVTARIH
				,BO.SEANS			
			FROM BurslulukSinavOgrenci	BO
			WHERE ID_BURSLULUKDOSYA		= @ID_BURSLULUKDOSYA

		END

		IF @ISLEM = 6	--	BURSLULUK SINAV LISTE	
		BEGIN
			SELECT(
				SELECT S.AD, S.ID_SINAV, S.ID_KADEME3
				FROM Sinav S
				WHERE	S.ID_SINAVTURU	= 12
					AND S.DONEM			= @DONEM
					AND S.AKTIF			= 1
					AND S.ID_SINAV	NOT IN (SELECT DISTINCT BS.ID_SINAV FROM BurslulukSinavOgrenci BS)
				FOR JSON AUTO
			) AS J
		END
		
		IF @ISLEM = 7	--	BURSLULUK DOSYA SİL		
		BEGIN
			
			DELETE FROM BurslulukDosya
			WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA
						
			DELETE FROM BurslulukSinavOgrenci
			WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA

			SELECT 1

		END

		IF @ISLEM = 8	--	KATILIM RAPORU			
		BEGIN
			DECLARE  @xID_BURSLULUKDOSYA	INT = @ID_BURSLULUKDOSYA
					,@xRAPORGENEL			BIT = @RAPORGENEL
			DECLARE  @GENEL					INT = 9999

			DROP TABLE IF EXISTS #KATILIMSAYISI
			DROP TABLE IF EXISTS #KATILIMYUZDESI
		
			SELECT ID_KADEME3	= BSO.ID_KADEME3
				,ID_SUBE		= BSO.ID_SUBE
				,SINAVGUN		= CASE WHEN @xRAPORGENEL = 0 THEN DATENAME(dw, BSO.SINAVTARIH)	ELSE NULL END	
				,SINAVTARIH		= CASE WHEN @xRAPORGENEL = 0 THEN BSO.SINAVTARIH					ELSE NULL END
				,SEANS			= CASE WHEN @xRAPORGENEL = 0 THEN BSO.SEANS						ELSE NULL END
				,BASVURAN_OGRSAY= COUNT(DISTINCT BSO.TCKIMLIKNO)	
				,KATILAN_OGRSAY	= COUNT(DISTINCT SOP.TCKIMLIKNO)	
			INTO #KATILIMSAYISI
			FROM BurslulukSinavOgrenci	BSO
			LEFT JOIN SinavOgrenciPuan	SOP	ON	SOP.TCKIMLIKNO	= BSO.TCKIMLIKNO
											AND SOP.ID_SINAV	= BSO.ID_SINAV
			WHERE BSO.ID_BURSLULUKDOSYA = @xID_BURSLULUKDOSYA 
			GROUP BY BSO.ID_KADEME3, BSO.ID_SUBE, CASE WHEN @xRAPORGENEL = 0 THEN BSO.SINAVTARIH END, CASE WHEN @xRAPORGENEL = 0 THEN BSO.SEANS END,CASE WHEN @xRAPORGENEL = 0 THEN DATENAME(dw, BSO.SINAVTARIH ) END

			INSERT INTO #KATILIMSAYISI (ID_KADEME3, ID_SUBE, SINAVGUN, SINAVTARIH, SEANS, BASVURAN_OGRSAY, KATILAN_OGRSAY)
			SELECT @GENEL, ID_SUBE, SINAVGUN, SINAVTARIH, SEANS, SUM(BASVURAN_OGRSAY), SUM(KATILAN_OGRSAY)
			FROM #KATILIMSAYISI
			GROUP BY ID_SUBE, SINAVGUN, SINAVTARIH, SEANS


			INSERT INTO #KATILIMSAYISI (ID_KADEME3, ID_SUBE, SINAVGUN, SINAVTARIH, SEANS, BASVURAN_OGRSAY, KATILAN_OGRSAY)
			SELECT ID_KADEME3
				,@GENEL
				,SINAVGUN
				,SINAVTARIH
				,SEANS
				,BASVURAN_OGRSAY	= SUM(BASVURAN_OGRSAY)
				,KATILAN_OGRSAY		= SUM(KATILAN_OGRSAY)
			FROM #KATILIMSAYISI
			GROUP BY ID_KADEME3, SINAVGUN, SINAVTARIH, SEANS


			SELECT ID_SUBE
				,SINAVGUN
				,SINAVTARIH
				,SEANS
				,KATILIMYUZDESI	= CAST( CAST(CAST(KATILAN_OGRSAY AS decimal(8,2))/NULLIF(CAST(BASVURAN_OGRSAY AS decimal(8,2)),0)*100.0  AS decimal(8,2)) AS VARCHAR)
			INTO #KATILIMYUZDESI
			FROM #KATILIMSAYISI
			WHERE ID_KADEME3 = @GENEL

			--		SORGULAR
			BEGIN
				SELECT * 
				FROM #KATILIMSAYISI
				ORDER BY ID_SUBE, ID_KADEME3

				SELECT *
				FROM #KATILIMYUZDESI
				ORDER BY ID_SUBE


				SELECT DISTINCT SB.ID_SUBE, SB.AD AS SUBEAD
				FROM #KATILIMSAYISI	KS
				JOIN v3Sube			SB	ON	SB.ID_SUBE	= KS.ID_SUBE


				SELECT DISTINCT K3.ID_KADEME3, K3.AD KADEMEAD
				FROM #KATILIMSAYISI	KS
				JOIN v3Kademe3		K3	ON	K3.ID_KADEME3	= KS.ID_KADEME3 
			UNION 
				SELECT @GENEL,'GENEL'
				
								
				SELECT DISTINCT CONVERT(varchar,SINAVTARIH,104) SINAVTARIH,SINAVGUN,SEANS
				FROM #KATILIMSAYISI

			END
		
			DROP TABLE IF EXISTS #KATILIMSAYISI
			DROP TABLE IF EXISTS #KATILIMYUZDESI

		END
		
		IF @ISLEM = 9	--	BURSLULUK TARIH SEANS	
		BEGIN
			
			SELECT ISNULL((
				SELECT DISTINCT CONVERT(VARCHAR, O.SINAVTARIH ,104 ) SINAVTARIH, O.SEANS
				FROM BurslulukSinavOgrenci O
				WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA
				FOR JSON AUTO
			),'[]') AS S

		END

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO
	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_CevapAnahtariDuzenle]    Script Date: 22.11.2021 10:41:15 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_CevapAnahtariDuzenle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	  
			ISLEM				 = @ISLEM		
			,TCKIMLIKNO			 = @TCKIMLIKNO	
			,OTURUM				 = @OTURUM		
			,TC_YETKI			 = @TC_YETKI	
			,DERSLIST			 = @DERSLIST	
			,ID_MENU			 = @ID_MENU	
			,ID_SINAV			 = @ID_SINAV	
			,SQLJSON			 = @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP 
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	SINAV BİLGİ GETİR (DERS PROGRAMINDAKİ DERSLER + CEVAPANAHTARIKULLANICIYETKI DERSLER)
			BEGIN
				DECLARE @ID_SINAVKITAPCIKX INT = (select  top 1  ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD='A')

				SELECT DISTINCT D.DERSAD AS DERSAD   
				INTO #DERSLIST
				FROM OKYANUSDB.[dbo].[v3DersProgram]	DP
				JOIN eokul_v2.dbo.Ders					D	ON	D.ID_DERS=DP.ID_DERS
				WHERE TCKIMLIKNO=@TCKIMLIKNO
			UNION 
				SELECT DISTINCT DERSAD 
				FROM CevapAnahtariKullaniciYetki 
				WHERE TCKIMLIKNO=@TCKIMLIKNO
			
			IF EXISTS (SELECT TOP 1 1 FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VE ÖLÇME DEĞERLENDİRME KULLANICILARI
			BEGIN
				INSERT INTO #DERSLIST (DERSAD)
				SELECT DISTINCT D.AD AS DERSAD   				
				FROM SinavDers			SD
				JOIN v3SinavDers		D	ON	D.ID_DERS=SD.ID_DERS
				WHERE	SD.ID_SINAV = @ID_SINAV
					AND D.AD NOT IN (SELECT DERSAD FROM #DERSLIST)
			END

				Select (
					Select 
						ID_SINAVTURU, 
						s.AD as AD, 
						(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) as KITAPCIKSAYISI, 
						s.KOD, 
						S.ID_KADEME3, 
						Convert(varchar, SINAVTARIH, 103) as SINAVTARIH,
						OZEL,
						FREKANSHESAPLA,
						PUANGIZLE,
						YUKLEMEKAPAT,
						YANLISSAYISI,
						OLCEKSINAVI,
						JSONDERS.ID_DERS as id,
						JSONDERS.ID_SINAVDERS as id_sinavders,
						JSONDERS.TAKMAAD as text,
						(select count(1)/(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) from SinavAnahtar sa where ID_SINAVDERS=JSONDERS.ID_SINAVDERS) as SORUSAYISI,
						JSONDERS.BOLUMNO as SIRA,
						SORULIST.SORUNO_A as SORUNO,
						SORULIST.ID_SINAVSORUTURU as SORUTURU,
						SORULIST.CEVAP as ACEVAP,
						SORULIST.KOD,
						UNITE = ISNULL(SD.AD, ''), 
						SORULIST.OPTIKKARAKTERSAYISI as KARAKTERSAYISI,
						SORULIST.KATSAYI,
						ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
						ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC,
						(select (select AD from SinavKitapcik where ID_SINAVKITAPCIK=ssa.ID_SINAVKITAPCIK) as KITAPCIK, SORUNO as SIRA from SinavAnahtar ssa where ID_SINAVKITAPCIK in (select ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD<>'A') and SORUNO_A=SORULIST.SORUNO and ID_SINAVDERS=JSONDERS.ID_SINAVDERS for json path) AS KARSILIKLIST
						,s.DONEM
					from	   Sinav						S
					inner join SinavDers			JSONDERS	ON	JSONDERS.ID_SINAV		= s.ID_SINAV 
					inner join SinavAnahtar			SORULIST	ON	SORULIST.ID_SINAVDERS	= JSONDERS.ID_SINAVDERS 
					INNER JOIN v3SinavDers					D	ON	D.ID_DERS				= JSONDERS.ID_DERS
					INNER JOIN #DERSLIST					L	ON	L.DERSAD				= D.AD 
					LEFT  JOIN v3SinavDersUnite				SD	ON	SD.KOD					= SORULIST.KOD
					where	s.ID_SINAV = @ID_SINAV 
						AND S.CEVAPANAHTARIYUKLEMEKAPAT = 0
						and ID_SINAVKITAPCIK=@ID_SINAVKITAPCIKX						
					order by id_sinavders, SORUNO		
				for json auto) as J
				
				DROP TABLE #DERSLIST
			END

			IF @ISLEM = 2   --	KAYDET
			BEGIN
				DROP TABLE IF EXISTS #DUZENLE
				DROP TABLE IF EXISTS #SINAVKITAPCIK

				SELECT   JSON_VALUE(S.VALUE,'$.ACEVAP')				AS ACEVAP
						,JSON_VALUE(S.VALUE,'$.KOD')				AS KOD
						,JSON_VALUE(S.VALUE,'$.SORUNO')				AS SORUNO
						,JSON_VALUE(S.VALUE,'$.ID_BILGI')			AS ID_BILGI
						,JSON_VALUE(S.VALUE,'$.ID_BILISSELSUREC')	AS ID_BILISSELSUREC
						,JSON_Value(D.value,'$.ID_SINAVDERS')		AS ID_SINAVDERS
						,JSON_Value(S.VALUE,'$.KATSAYI')			AS KATSAYI
						,JSON_VALUE(K.VALUE,'$.KITAPCIK')			AS KITAPCIK
						,JSON_VALUE(K.VALUE,'$.SIRA')				AS SIRA
				INTO #DUZENLE 
				FROM		OPENJSON (@SQLJSON, '$.JSONDERS') as D
				CROSS APPLY OPENJSON (D.value , '$.SORULIST') as S
				OUTER APPLY OPENJSON (S.value , '$.KARSILIKLIST') as K

				SELECT * INTO #SINAVKITAPCIK FROM SinavKitapcik SK WHERE SK.ID_SINAV=@ID_SINAV AND AD IN (SELECT DISTINCT KITAPCIK FROM #DUZENLE)

			--  SINAV ANAHTAR CEVAPLARINI DEĞİŞTİRİR (A,B,C KİTAPÇIKLARININ) 
				UPDATE	 SA
				SET		 SA.CEVAP				= D.ACEVAP
						,SA.KOD					= D.KOD
						,SA.ID_BILGI			= D.ID_BILGI
						,SA.ID_BILISSELSUREC	= D.ID_BILISSELSUREC
						,SA.KATSAYI				= D.KATSAYI
				FROM SinavAnahtar	SA
				JOIN #DUZENLE		D	ON	D.ID_SINAVDERS	= SA.ID_SINAVDERS
										AND D.SORUNO		= SA.SORUNO_A

			--	SINAV ANAHTAR SIRA NUMARASINI DEĞİŞTİRİR
				UPDATE SA
				SET	 SA.SORUNO	= D.SIRA
				FROM SinavAnahtar	SA
				JOIN #DUZENLE		D	ON	D.ID_SINAVDERS		= SA.ID_SINAVDERS
										AND D.SORUNO			= SA.SORUNO_A
				JOIN #SINAVKITAPCIK	SK	ON	SK.AD				= D.KITAPCIK
										AND SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK

			--	SINAV DURUMU BEKLEMEDE OLARAK DEĞİŞTİR
				UPDATE Sinav
				SET DURUM=0
				WHERE ID_SINAV=@ID_SINAV

						
				DROP TABLE #DUZENLE
				DROP TABLE #SINAVKITAPCIK

				SELECT @ID_SINAV
			END
		
		END

	END TRY
	BEGIN CATCH	
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_CevapAnahtariKullaniciYetki]    Script Date: 22.11.2021 10:41:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_CevapAnahtariKullaniciYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
			ISLEM			 = @ISLEM		
			,TCKIMLIKNO		 = @TCKIMLIKNO	
			,OTURUM			 = @OTURUM		
			,TC_YETKI		 = @TC_YETKI	
			,DERSLIST		 = @DERSLIST	
			,ID_MENU			 = @ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP 
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	DERS LİSTESİ
			BEGIN

			SELECT DISTINCT D.AD DERSAD,CASE WHEN C.DERSAD IS NULL THEN 0 ELSE 1 END YETKILI
			INTO #TEMP
			FROM OKYANUSDB.DBO.v3SinavDers		D	
			LEFT JOIN CevapAnahtariKullaniciYetki	C	ON	C.DERSAD	= D.AD 
														AND	C.TCKIMLIKNO= @TC_YETKI

				select(
						select * from(
							select 
							(						 
								SELECT DERSAD,YETKILI
								FROM #TEMP
								FOR JSON AUTO
							) as DersList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #TEMP
			END

			IF @ISLEM = 2 
			BEGIN
				DELETE FROM CevapAnahtariKullaniciYetki WHERE TCKIMLIKNO=@TC_YETKI

				INSERT INTO CevapAnahtariKullaniciYetki (TCKIMLIKNO,DERSAD,KYE_TCKIMLIKNO)
				SELECT @TC_YETKI,JSON_VALUE( J.VALUE,'$.DERSAD')  AS DERSAD , @TCKIMLIKNO
				FROM OPENJSON(@DERSLIST) AS J
				WHERE CAST(JSON_VALUE( J.VALUE,'$.YETKILI') AS BIT) = 1

				SELECT 1 
			END

		
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_CurpusStudyYukle]    Script Date: 22.11.2021 10:41:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_CurpusStudyYukle]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,

	@SQLJSON				VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
	
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	CurpusStudy LİSTESİ			
			BEGIN
				SELECT (
					SELECT	 CS.TCKIMLIKNO
							,ADSOYAD	= K.AD+' '+K.SOYAD
							,CS.TOKEN
							,CS.ID_KULLANICITIPI
							,CS.YONETIM
					FROM CurpusStudy	CS
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= CS.TCKIMLIKNO
					FOR JSON PATH,INCLUDE_NULL_VALUES
				)
			END
			
			IF @ISLEM = 2	--	CurpusStudy EXCEL YÜKLE			
			BEGIN

				DELETE FROM CurpusStudy	

				INSERT INTO CurpusStudy (TCKIMLIKNO, TOKEN, ID_KULLANICITIPI, YONETIM)
				SELECT TCKIMLIKNO, TOKEN, ID_KULLANICITIPI, YONETIM FROM OPENJSON(@SQLJSON)
				WITH(
					 TCKIMLIKNO			VARCHAR(MAX)
					,TOKEN				VARCHAR(MAX)
					,ID_KULLANICITIPI	VARCHAR(MAX)
					,YONETIM			BIT
				) 

			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Degerlendirme]    Script Date: 22.11.2021 10:42:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Degerlendirme]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@SQLJSON					VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPI			INT				= NULL,
	@ID_KADEME					INT				= NULL,
	@ID_SUBE					INT				= NULL,
	@TCPERSONEL					VARCHAR(MAX)	= NULL,
	@TCPERSONELLIST				VARCHAR(MAX)	= NULL,
	@ID_LISTELEMETIPI			INT				= NULL,
	@ID_SINIF					INT				= NULL,
	@ID_DEGERLENDIRMEPERIYOT	INT				= NULL,
	@ID_DEGERLENDIRMESORU		INT				= NULL,
	@ID_DEGERLENDIRMEYORUM		INT				= NULL,
	@YORUM						VARCHAR(MAX)	= NULL,
	@ID_DEGERLENDIRMEKATEGORI	INT				= NULL,
	@YORUMTUR					INT				= NULL,
	@ID_KADEMELIST				VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPILIST		VARCHAR(MAX)	= NULL,
	@RAPORTIPI					INT				= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@KUR_SINIF					BIT				= 0,
	@DURUM						INT				= 0,
	@TC_DEGERLENDIREN			VARCHAR(11)		= NULL,
	@TC_DEGERLENDIRILEN			VARCHAR(11)		= NULL,
	@IDAREKULLANICITIPI			VARCHAR(10)     = NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	
			ISLEM						 	= @ISLEM						
			,TCKIMLIKNO					 	= @TCKIMLIKNO					
			,OTURUM						 	= @OTURUM						
			,ID_MENU					 	= @ID_MENU					
			,DONEM						 	= @DONEM						
			,SQLJSON					 	= @SQLJSON					
			,ID_KULLANICITIPI			 	= @ID_KULLANICITIPI			
			,ID_KADEME					 	= @ID_KADEME					
			,ID_SUBE					 	= @ID_SUBE					
			,TCPERSONEL					 	= @TCPERSONEL					
			,TCPERSONELLIST				 	= @TCPERSONELLIST				
			,ID_LISTELEMETIPI			 	= @ID_LISTELEMETIPI			
			,ID_SINIF					 	= @ID_SINIF					
			,ID_DEGERLENDIRMEPERIYOT	 	= @ID_DEGERLENDIRMEPERIYOT	
			,ID_DEGERLENDIRMESORU		 	= @ID_DEGERLENDIRMESORU		
			,ID_DEGERLENDIRMEYORUM		 	= @ID_DEGERLENDIRMEYORUM		
			,YORUM						 	= @YORUM						
			,ID_DEGERLENDIRMEKATEGORI	 	= @ID_DEGERLENDIRMEKATEGORI	
			,YORUMTUR					 	= @YORUMTUR					
			,ID_KADEMELIST				 	= @ID_KADEMELIST				
			,ID_KULLANICITIPILIST		 	= @ID_KULLANICITIPILIST		
			,RAPORTIPI					 	= @RAPORTIPI					
			,ID_SUBELIST				 	= @ID_SUBELIST				
			,KUR_SINIF					 	= @KUR_SINIF					
			,DURUM						 	= @DURUM						
			,TC_DEGERLENDIREN			 	= @TC_DEGERLENDIREN			
			,TC_DEGERLENDIRILEN			 	= @TC_DEGERLENDIRILEN			
			,IDAREKULLANICITIPI			    = @IDAREKULLANICITIPI			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		 
	
		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	PERİYOT TANIMLA
			BEGIN
				IF CAST(JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEPERIYOT') AS INT) > 0
				BEGIN
					--IF  NOT EXISTS (SELECT * FROM DegerlendirmeYorum WHERE ID_DEGERLENDIRMEPERIYOT = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEPERIYOT'))
					--AND NOT EXISTS (SELECT * FROM DegerlendirmePuan WHERE ID_DEGERLENDIRMEPERIYOT = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEPERIYOT'))
					--BEGIN
						UPDATE DP SET DP.BASLANGIC = J.BASLANGIC, DP.BITIS = J.BITIS FROM DegerlendirmePeriyot DP 
						INNER JOIN OPENJSON(@SQLJSON) WITH(
							ID_DEGERLENDIRMEPERIYOT INT,
							BASLANGIC DATE,
							BITIS DATE
						) J ON J.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
					--END
					--ELSE
					--BEGIN
					--	RAISERROR ('Düzenlenmeye çalışan periyot için giriş yapıldığından düzenleme işlemi yapılamaz!' , -- Message text.
					--				16, -- Severity.
					--				1 -- State.
					--				);
					--END
				END
				ELSE
				BEGIN
					INSERT INTO DegerlendirmePeriyot ( [ID_KADEME]
													  ,[ID_KULLANICITIPI]
													  ,[BASLANGIC]
													  ,[BITIS]
													  ,[DONEM]
													  ,[KYE_TCKIMLIKNO])
					SELECT @ID_KADEME, @ID_KULLANICITIPI, BASLANGIC, BITIS, @DONEM, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
					WITH(
						BASLANGIC DATE,
						BITIS DATE
					)
				END

				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
							,[ID_KADEME]
							,[ID_KULLANICITIPI]
							--,[SIRA]
							,CONVERT(VARCHAR, [BASLANGIC], 104) AS [BASLANGIC]
							,CONVERT(VARCHAR, [BITIS], 104) AS [BITIS]
							,[DONEM]
							,[KYE_TCKIMLIKNO]
							,[KYE_TARIH] 
					FROM DegerlendirmePeriyot 
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
					ORDER BY CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END
			
			IF @ISLEM = 2	--	PERİYOT GETİR
			BEGIN
				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
						  ,[ID_KADEME]
						  ,[ID_KULLANICITIPI]
						  --,[SIRA]
						  ,CONVERT(VARCHAR, [BASLANGIC], 104) AS [BASLANGIC]
						  ,CONVERT(VARCHAR, [BITIS], 104) AS [BITIS]
						  ,[DONEM]
						  ,[KYE_TCKIMLIKNO]
						  ,[KYE_TARIH]  
					FROM DegerlendirmePeriyot 
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
					ORDER BY CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 3	--	SORU TANIMLA
			BEGIN
				IF CAST(JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMESORU') AS INT) > 0
				BEGIN
					--IF NOT EXISTS (SELECT * FROM DegerlendirmePuan WHERE ID_DEGERLENDIRMESORU = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMESORU'))
					--BEGIN
						UPDATE DS SET DS.SORU = J.SORU, DS.ID_DEGERLENDIRMEKATEGORI = J.ID_DEGERLENDIRMEKATEGORI FROM DegerlendirmeSoru DS 
						INNER JOIN OPENJSON(@SQLJSON) WITH(
							ID_DEGERLENDIRMESORU INT,
							ID_DEGERLENDIRMEKATEGORI INT,
							SORU VARCHAR(MAX)
						) J ON J.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
					--END
					--ELSE
					--BEGIN
					--	RAISERROR ('Düzenlenmeye çalışan soru için giriş yapıldığından düzenleme işlemi yapılamaz!' , -- Message text.
					--				16, -- Severity.
					--				1 -- State.
					--				);
					--END
				END
				ELSE
				BEGIN
					INSERT INTO DegerlendirmeSoru (	   [ID_KADEME]
													  ,[ID_KULLANICITIPI]
													  ,[DONEM]
													  ,[ID_DEGERLENDIRMEPERIYOT]
													  ,[SORU]
													  ,[ID_DEGERLENDIRMEKATEGORI]
													  ,[KYE_TCKIMLIKNO])
					SELECT @ID_KADEME, @ID_KULLANICITIPI, @DONEM, @ID_DEGERLENDIRMEPERIYOT, SORU, ID_DEGERLENDIRMEKATEGORI, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
					WITH(
						SORU VARCHAR(MAX),
						ID_DEGERLENDIRMEKATEGORI INT
					)
				END

				
				SELECT
				(
					SELECT DS.[ID_DEGERLENDIRMESORU]
						  ,DS.[ID_KADEME]
						  ,DS.[ID_KULLANICITIPI]
						  ,DS.[ID_DEGERLENDIRMEPERIYOT]
						  ,DS.[SORU]
						  ,DS.[ID_DEGERLENDIRMEKATEGORI]
						  ,DK.[AD] AS KATEGORI
						  ,DS.[DONEM]
						  ,DS.[KYE_TCKIMLIKNO]
						  ,DS.[KYE_TARIH]  
					FROM DegerlendirmeSoru DS
					LEFT JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME AND ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END
			
			IF @ISLEM = 4	--	SORU GETİR
			BEGIN
				SELECT
				(
					SELECT DS.[ID_DEGERLENDIRMESORU]
						  ,DS.[ID_KADEME]
						  ,DS.[ID_KULLANICITIPI]
						  ,DS.[ID_DEGERLENDIRMEPERIYOT]
						  ,DS.[SORU]
						  ,DS.[ID_DEGERLENDIRMEKATEGORI]
						  ,DK.[AD] AS KATEGORI
						  ,DS.[DONEM]
						  ,DS.[KYE_TCKIMLIKNO]
						  ,DS.[KYE_TARIH]  
					FROM DegerlendirmeSoru DS
					LEFT JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME AND ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 5	--	PERSONEL GETİR
			BEGIN
				SELECT
				(
					SELECT DISTINCT k.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD 
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ KK ON KK.TCKIMLIKNO = K.TCKIMLIKNO/* AND KK.ID_SUBE = SY.ID_SUBE*/
					--WHERE SY.ID_KULLANICITIPI = @ID_KULLANICITIPI 
					WHERE SY.ID_KULLANICITIPI  IN (SELECT    CAST( value AS INT)  FROM  STRING_SPLIT(@IDAREKULLANICITIPI, ',')) 
					AND (KK.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0)
					AND SY.ID_SUBE = @ID_SUBE
					ORDER BY ADSOYAD
					FOR JSON AUTO 
				) AS J
			END

			IF @ISLEM = 6	--	SORU - PUAN - YORUM GETİR
			BEGIN		
				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				IF @ID_DEGERLENDIRMEPERIYOT IS NULL
				BEGIN
					RAISERROR ('Puan Eklenecek Periyot Bulunamadı!' , -- Message text.
					16, -- Severity.
					1 -- State.
					);
				END
				ELSE
				BEGIN
					SELECT	@YORUM = DY.YORUM
					FROM DegerlendirmeYorum DY
					WHERE DY.KYE_TCKIMLIKNO = @TCKIMLIKNO
					AND DY.TCKIMLIKNO = @TCPERSONEL
					AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					AND DY.TUR = @YORUMTUR

					SELECT
					(
						SELECT	YORUM = ISNULL(@YORUM, ''),
								TCPERSONEL = @TCPERSONEL,
								ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT,
								SORULAR = (	
											SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, PUAN = ISNULL(DP.PUAN, 0)
											FROM DegerlendirmeSoru DS
											LEFT JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU 
																			AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT 
																			AND DP.TCKIMLIKNO = @TCPERSONEL 
																			AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
											WHERE DS.ID_KADEME = @ID_KADEME
											AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
											AND DS.DONEM = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
											AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
											ORDER BY DS.ID_DEGERLENDIRMESORU
											FOR JSON PATH
										)
						FOR JSON PATH
					) AS J
				END
			END

			IF @ISLEM = 7	--	SORU - PUAN - YORUM KAYDET
			BEGIN
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT, @TCPERSONEL = TCPERSONEL, @YORUM = YORUM
				FROM OPENJSON(@SQLJSON)
				WITH(
					ID_DEGERLENDIRMEPERIYOT INT,
					TCPERSONEL VARCHAR(11),
					YORUM VARCHAR(MAX)
				)

				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END
				
				DELETE FROM DegerlendirmeYorum WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND TCKIMLIKNO = @TCPERSONEL AND KYE_TCKIMLIKNO = @TCKIMLIKNO AND TUR = @YORUMTUR
				DELETE FROM DegerlendirmePuan WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND TCKIMLIKNO = @TCPERSONEL AND KYE_TCKIMLIKNO = @TCKIMLIKNO

				INSERT INTO DegerlendirmeYorum (ID_DEGERLENDIRMEPERIYOT, TCKIMLIKNO, YORUM, KYE_TCKIMLIKNO, TUR)
				SELECT @ID_DEGERLENDIRMEPERIYOT, @TCPERSONEL, @YORUM, @TCKIMLIKNO, @YORUMTUR

				INSERT INTO DegerlendirmePuan (ID_DEGERLENDIRMEPERIYOT, ID_DEGERLENDIRMESORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO)
				SELECT @ID_DEGERLENDIRMEPERIYOT, ID_DEGERLENDIRMESORU, @TCPERSONEL, PUAN, KYE_TCKIMLIKNO = @TCKIMLIKNO
				FROM OPENJSON(@SQLJSON, '$.SORULAR') 
				WITH(
					ID_DEGERLENDIRMESORU INT,
					PUAN TINYINT
				)

				SELECT	@YORUM = DY.YORUM
				FROM DegerlendirmeYorum DY
				WHERE DY.KYE_TCKIMLIKNO = @TCKIMLIKNO
				AND DY.TCKIMLIKNO = @TCPERSONEL
				AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

				SELECT
				(
					SELECT	YORUM = ISNULL(@YORUM, ''),
							TCPERSONEL = @TCPERSONEL,
							ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT,
							SORULAR = (	
										SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, PUAN = ISNULL(DP.PUAN, 0)
										FROM DegerlendirmeSoru DS
										LEFT JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU 
																		AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT 
																		AND DP.TCKIMLIKNO = @TCPERSONEL 
																		AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
										WHERE DS.ID_KADEME = @ID_KADEME
										AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
										AND DS.DONEM = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
										AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
										ORDER BY DS.ID_DEGERLENDIRMESORU
										FOR JSON PATH
									)
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 8	--	ÖĞRENCİ LİSTELE
			BEGIN
				CREATE TABLE #OGRENCI (AD VARCHAR(100) ,SOYAD VARCHAR(100),TCKIMLIKNO VARCHAR(11))

				INSERT INTO #OGRENCI (AD,SOYAD,TCKIMLIKNO)
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM OkyanusDB.DBO.vw_SinifOgrenci	O
				JOIN OkyanusDB.DBO.v3Kullanici		K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE ID_SINIF = @ID_SINIF

				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = (SELECT ID_KADEME FROM v3SinifTum WHERE ID_SINIF = @ID_SINIF)
				AND ID_KULLANICITIPI = 4

				IF @ID_LISTELEMETIPI = 0	--	TÜMÜ
				BEGIN
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCI
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 1	--	DEĞERLENDİRİLENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCI O
						WHERE O.TCKIMLIKNO IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 2	--	DEĞERLENDİRİLMEYENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCI O
						WHERE O.TCKIMLIKNO NOT IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END		
				
				DROP TABLE #OGRENCI		
			END

			IF @ISLEM = 9	--	ÖĞRETMEN - SORU - PUAN - YORUM GETİR
			BEGIN		
				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END

				IF @DONEM IS NULL
				BEGIN
					SELECT @DONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
				INTO #OGRETMEN
				FROM OkyanusDB.dbo.v3Ogrenci O
				INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
				WHERE O.TCKIMLIKNO = @TCPERSONEL
				GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

				INSERT INTO #OGRETMEN
				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
				FROM OkyanusDB.dbo.v3Ogrenci O
				INNER JOIN OkyanusDB.dbo.v3DersProgram DP ON DP.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DP.TCKIMLIKNO
				WHERE O.TCKIMLIKNO = @TCPERSONEL AND K.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #OGRETMEN)
				GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

				SELECT O.TCKIMLIKNO, @TCPERSONEL AS TCPERSONEL, O.ADSOYAD AS ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM AS GENELYORUM, DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS
						,(
							SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, SUBDP.PUAN 
							FROM DegerlendirmeSoru DS
							LEFT JOIN DegerlendirmePuan SUBDP ON DS.ID_DEGERLENDIRMESORU = SUBDP.ID_DEGERLENDIRMESORU AND SUBDP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND SUBDP.TCKIMLIKNO = @TCPERSONEL AND SUBDP.KYE_TCKIMLIKNO = O.TCKIMLIKNO
							WHERE DS.DONEM = @DONEM AND DS.ID_KADEME = @ID_KADEME AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
							ORDER BY DS.ID_DEGERLENDIRMESORU
							FOR JSON PATH, INCLUDE_NULL_VALUES
						) AS SORULIST
						,TUR = 0
				INTO #NORMALTABLO
				FROM #OGRETMEN O
				LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = @TCPERSONEL AND DY.KYE_TCKIMLIKNO = O.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR=0
				LEFT JOIN DegerlendirmeYorum DYI ON DYI.TCKIMLIKNO = @TCPERSONEL AND DYI.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DYI.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DYI.TUR=@YORUMTUR
				LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
				GROUP BY O.ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM, DYD.DURUM, O.TCKIMLIKNO

				INSERT INTO #NORMALTABLO(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
				SELECT DISTINCT DY.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 1    
				FROM DegerlendirmeYorum DY 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = DY.KYE_TCKIMLIKNO AND SY.ID_KULLANICITIPI IN (26, 91)
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
				WHERE DY.TCKIMLIKNO = @TCPERSONEL AND DY.TUR=1
				AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

				INSERT INTO #NORMALTABLO(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
				SELECT DISTINCT O.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 2    
				FROM OkyanusDB.dbo.v3Ogrenci O
				INNER JOIN OkyanusDB.dbo.v3SinifPersonel SD ON SD.ID_SINIF = O.ID_SINIF AND SD.ID_KULLANICITIPI = 100
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SD.TCKIMLIKNO
				LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = O.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = K.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR=2
				LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
				WHERE O.TCKIMLIKNO = @TCPERSONEL

				SELECT
				(
					SELECT * FROM #NORMALTABLO
					ORDER BY TUR, GIRIS DESC, ADSOYAD
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS J

				DROP TABLE #OGRETMEN
				DROP TABLE #NORMALTABLO
			END

			IF @ISLEM = 10	--	ÖĞRETMEN - SORU - PUAN - YORUM KAYDET
			BEGIN
				IF @TCPERSONEL IS NULL
				BEGIN
					SET @TCPERSONEL = JSON_VALUE(@SQLJSON, '$.TCPERSONEL')
				END

				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END

				IF @DONEM IS NULL
				BEGIN
					SELECT @DONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				IF @ID_DEGERLENDIRMEPERIYOT IS NULL
				BEGIN
					RAISERROR ('Puan Eklenecek Periyot Bulunamadı!' , -- Message text.
					16, -- Severity.
					1 -- State.
					);
				END
				ELSE
				BEGIN
					SELECT ID_DEGERLENDIRMEYORUM, DURUM, @TCKIMLIKNO AS TCKIMLIKNO
					INTO #YORUMDURUM
					FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
					WITH(
						ID_DEGERLENDIRMEYORUM INT,
						DURUM BIT
					)

					DELETE DYD FROM DegerlendirmeYorumDurum DYD
					INNER JOIN #YORUMDURUM YD ON /*YD.TCKIMLIKNO = DYD.KYE_TCKIMLIKNO AND*/ YD.ID_DEGERLENDIRMEYORUM = DYD.ID_DEGERLENDIRMEYORUM

					INSERT INTO DegerlendirmeYorumDurum ([ID_DEGERLENDIRMEYORUM], [DURUM] ,[KYE_TCKIMLIKNO])
					SELECT ID_DEGERLENDIRMEYORUM, DURUM, @TCKIMLIKNO FROM #YORUMDURUM

					DELETE DY FROM DegerlendirmeYorum DY 
					WHERE DY.KYE_TCKIMLIKNO = @TCKIMLIKNO 
					AND DY.TCKIMLIKNO = JSON_VALUE(@SQLJSON, '$.TCPERSONEL') 
					AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					AND DY.TUR = @YORUMTUR

					INSERT INTO DegerlendirmeYorum ([ID_DEGERLENDIRMEPERIYOT]
						  ,[TCKIMLIKNO]
						  ,[YORUM]
						  ,[KYE_TCKIMLIKNO]
						  ,TUR)
					SELECT @ID_DEGERLENDIRMEPERIYOT, JSON_VALUE(@SQLJSON, '$.TCPERSONEL'), JSON_VALUE(@SQLJSON, '$.YORUM'), @TCKIMLIKNO, @YORUMTUR
					WHERE JSON_VALUE(@SQLJSON, '$.YORUM') IS NOT NULL

					DROP TABLE #YORUMDURUM

					--LİSTELE				

					SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					INTO #OGRETMEN2
					FROM OkyanusDB.dbo.v3Ogrenci O
					INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
					WHERE O.TCKIMLIKNO = @TCPERSONEL
					GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

					INSERT INTO #OGRETMEN2
					SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					FROM OkyanusDB.dbo.v3Ogrenci O
					INNER JOIN OkyanusDB.dbo.v3DersProgram DP ON DP.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DP.TCKIMLIKNO
					WHERE O.TCKIMLIKNO = @TCPERSONEL AND K.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #OGRETMEN2)
					GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

					SELECT O.TCKIMLIKNO, @TCPERSONEL AS TCPERSONEL, O.ADSOYAD AS ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM AS GENELYORUM, DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS
							,(
								SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, SUBDP.PUAN 
								FROM DegerlendirmeSoru DS
								LEFT JOIN DegerlendirmePuan SUBDP ON DS.ID_DEGERLENDIRMESORU = SUBDP.ID_DEGERLENDIRMESORU AND SUBDP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND SUBDP.TCKIMLIKNO = @TCPERSONEL AND SUBDP.KYE_TCKIMLIKNO = O.TCKIMLIKNO
								WHERE DS.DONEM = @DONEM AND DS.ID_KADEME = @ID_KADEME AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
								ORDER BY DS.ID_DEGERLENDIRMESORU
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS SORULIST
							,TUR = 0
					INTO #NORMALTABLO2
					FROM #OGRETMEN2 O
					LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = @TCPERSONEL AND DY.KYE_TCKIMLIKNO = O.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = 0
					LEFT JOIN DegerlendirmeYorum DYI ON DYI.TCKIMLIKNO = @TCPERSONEL AND DYI.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DYI.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = @YORUMTUR
					LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
					GROUP BY O.ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM, DYD.DURUM, O.TCKIMLIKNO

					INSERT INTO #NORMALTABLO2(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
					SELECT DISTINCT DY.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 1    
					FROM DegerlendirmeYorum DY 
					INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = DY.KYE_TCKIMLIKNO AND SY.ID_KULLANICITIPI IN (26, 91)
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
					LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
					WHERE DY.TCKIMLIKNO = @TCPERSONEL AND DY.TUR = 1
					AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

					INSERT INTO #NORMALTABLO2(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
					SELECT DISTINCT DY.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 2    
					FROM OkyanusDB.dbo.v3Ogrenci O
					INNER JOIN OkyanusDB.dbo.v3SinifPersonel SD ON SD.ID_SINIF = O.ID_SINIF AND SD.ID_KULLANICITIPI = 100
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SD.TCKIMLIKNO
					LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = O.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = K.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = 2
					LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
					WHERE O.TCKIMLIKNO = @TCPERSONEL

					SELECT
					(
						SELECT * FROM #NORMALTABLO2
						ORDER BY TUR, GIRIS DESC, ADSOYAD
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS J

					DROP TABLE #OGRETMEN2
					DROP TABLE #NORMALTABLO2
				END

				
			END

			IF @ISLEM = 11	--	PERİYOT SİL
			BEGIN
				BEGIN TRY
					DELETE FROM DegerlendirmePeriyot WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					SELECT
					(
						SELECT [ID_DEGERLENDIRMEPERIYOT]
								,[ID_KADEME]
								,[ID_KULLANICITIPI]
								--,[SIRA]
								,CONVERT(VARCHAR, [BASLANGIC], 104) AS [BASLANGIC]
								,CONVERT(VARCHAR, [BITIS], 104) AS [BITIS]
								,[DONEM]
								,[KYE_TCKIMLIKNO]
								,[KYE_TARIH] 
						FROM DegerlendirmePeriyot 
						WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
						ORDER BY CAST(BASLANGIC AS DATE)
						FOR JSON AUTO
					)
				END TRY
				BEGIN CATCH
					RAISERROR ('Silinmeye çalışan periyot için giriş yapıldığından silme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
				END CATCH
			END

			IF @ISLEM = 12	--	SORU SİL
			BEGIN
				BEGIN TRY
					DELETE FROM DegerlendirmeSoru WHERE ID_DEGERLENDIRMESORU = @ID_DEGERLENDIRMESORU
					SELECT
					(
						SELECT DS.[ID_DEGERLENDIRMESORU]
							  ,DS.[ID_KADEME]
							  ,DS.[ID_KULLANICITIPI]
							  ,DS.[ID_DEGERLENDIRMEPERIYOT]
							  ,DS.[SORU]
							  ,DS.[ID_DEGERLENDIRMEKATEGORI]
							  ,DK.[AD] AS KATEGORI
							  ,[DONEM]
							  ,DS.[KYE_TCKIMLIKNO]
							  ,DS.[KYE_TARIH]  
						FROM DegerlendirmeSoru DS
						LEFT JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
						WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME AND ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END TRY
				BEGIN CATCH
					RAISERROR ('Silinmeye çalışan soru için giriş yapıldığından silme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
				END CATCH
			END

			IF @ISLEM = 13	--	PUAN TÜR LİSTELE
			BEGIN
				SELECT
				(
					SELECT * 
					FROM DegerlendirmePuanTur 
					ORDER BY PUAN
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 14	--	SINIF YORUM LİSTELE
			BEGIN
				IF @ID_KADEME IS NULL
				BEGIN
					SELECT @ID_KADEME = ST.ID_KADEME 
					FROM OkyanusDB.dbo.v3Sinif S 
					INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
					WHERE S.ID_SINIF = @ID_SINIF
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				IF @ID_DEGERLENDIRMEPERIYOT IS NULL
				BEGIN
					RAISERROR ('Periyot Bulunamadı!' , -- Message text.
					16, -- Severity.
					1 -- State.
					);
				END
				ELSE
				BEGIN
					IF @ID_LISTELEMETIPI = 0	--	TÜMÜ
					BEGIN
						SELECT
						(
							SELECT	O.TCKIMLIKNO, K.AD + ' ' +K.SOYAD AS ADSOYAD, ISNULL(DY.YORUM, '') AS YORUM, ISNULL(DY.ID_DEGERLENDIRMEYORUM, 0) AS ID_DEGERLENDIRMEYORUM, @ID_DEGERLENDIRMEPERIYOT as ID_DEGERLENDIRMEPERIYOT
							FROM OkyanusDB.dbo.v3Ogrenci O
							INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
							LEFT JOIN DegerlendirmeYorum DY ON O.TCKIMLIKNO = DY.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = @YORUMTUR
							WHERE O.ID_SINIF = @ID_SINIF
							ORDER BY ADSOYAD
							FOR JSON PATH
						) AS J
					END
					ELSE IF @ID_LISTELEMETIPI = 1	--	DEĞERLENDİRİLENLER
					BEGIN	
						SELECT
						(
							SELECT	O.TCKIMLIKNO, K.AD + ' ' +K.SOYAD AS ADSOYAD, ISNULL(DY.YORUM, '') AS YORUM, ISNULL(DY.ID_DEGERLENDIRMEYORUM, 0) AS ID_DEGERLENDIRMEYORUM, @ID_DEGERLENDIRMEPERIYOT as ID_DEGERLENDIRMEPERIYOT
							FROM OkyanusDB.dbo.v3Ogrenci O
							INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
							INNER JOIN DegerlendirmeYorum DY ON O.TCKIMLIKNO = DY.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
							WHERE O.ID_SINIF = @ID_SINIF AND DY.TUR = @YORUMTUR
							ORDER BY ADSOYAD
							FOR JSON PATH
						) AS J
					END
					ELSE IF @ID_LISTELEMETIPI = 2	--	DEĞERLENDİRİLMEYENLER
					BEGIN	
						SELECT
						(
							SELECT	O.TCKIMLIKNO, K.AD + ' ' +K.SOYAD AS ADSOYAD, ISNULL(DY.YORUM, '') AS YORUM, ISNULL(DY.ID_DEGERLENDIRMEYORUM, 0) AS ID_DEGERLENDIRMEYORUM, @ID_DEGERLENDIRMEPERIYOT as ID_DEGERLENDIRMEPERIYOT
							FROM OkyanusDB.dbo.v3Ogrenci O
							INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
							LEFT JOIN DegerlendirmeYorum DY ON O.TCKIMLIKNO = DY.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = @YORUMTUR
							WHERE O.ID_SINIF = @ID_SINIF AND DY.ID_DEGERLENDIRMEYORUM IS NULL
							ORDER BY ADSOYAD
							FOR JSON PATH
						) AS J
					END						
				END
			END

			IF @ISLEM = 15	--	YORUM KAYDET
			BEGIN
				IF @ID_DEGERLENDIRMEYORUM = 0
				BEGIN
					INSERT INTO DegerlendirmeYorum ([ID_DEGERLENDIRMEPERIYOT]
												,[TCKIMLIKNO]
												,[YORUM]
												,[KYE_TCKIMLIKNO]
												,[TUR])
					SELECT @ID_DEGERLENDIRMEPERIYOT, @TCPERSONEL, @YORUM, @TCKIMLIKNO, @YORUMTUR
				END
				ELSE
				BEGIN
					UPDATE DegerlendirmeYorum SET YORUM = @YORUM WHERE ID_DEGERLENDIRMEYORUM = @ID_DEGERLENDIRMEYORUM AND TUR = @YORUMTUR
				END				
			END

			IF @ISLEM = 16	--	KATEGORİ GETİR
			BEGIN
				SELECT
				(
					SELECT *
					FROM DegerlendirmeKategori 
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 17	--	KATEGORİ TANIMLA
			BEGIN
				IF CAST(JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEKATEGORI') AS INT) > 0
				BEGIN
					IF NOT EXISTS (SELECT TOP 1 1 FROM DegerlendirmeSoru WHERE ID_DEGERLENDIRMEKATEGORI = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEKATEGORI'))
					BEGIN
						UPDATE DK SET DK.AD = J.AD FROM DegerlendirmeKategori DK
						INNER JOIN OPENJSON(@SQLJSON) WITH(
							ID_DEGERLENDIRMEKATEGORI INT,
							AD VARCHAR(MAX)
						) J ON J.ID_DEGERLENDIRMEKATEGORI = DK.ID_DEGERLENDIRMEKATEGORI
					END
					ELSE
					BEGIN
						RAISERROR ('Düzenlenmeye çalışan soru için giriş yapıldığından düzenleme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
					END
				END
				ELSE
				BEGIN
					INSERT INTO DegerlendirmeKategori ([AD]
													  ,[KYE_TCKIMLIKNO])
					SELECT AD, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
					WITH(
						AD VARCHAR(MAX)
					)
				END

				
				SELECT
				(
					SELECT	*
					FROM DegerlendirmeKategori 
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 18	--	KATEGORİ SİL
			BEGIN
				BEGIN TRY
					DELETE FROM DegerlendirmeKategori WHERE ID_DEGERLENDIRMEKATEGORI = @ID_DEGERLENDIRMEKATEGORI
					SELECT
					(
						SELECT *
						FROM DegerlendirmeKategori 
						FOR JSON AUTO
					)
				END TRY
				BEGIN CATCH
					RAISERROR ('Silinmeye çalışan kategori için giriş yapıldığından silme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
				END CATCH
			END

			IF @ISLEM = 19	--	PERSONEL KADEME ŞUBE GETİR
			BEGIN
				IF (SELECT [dbo].[fn_GenelHak](@TCKIMLIKNO)) > 0
				BEGIN
					SELECT
					(
						SELECT DISTINCT K.ID_KADEME, K.AD 
						FROM OkyanusDB.dbo.v3SubeGrupSinif SGS
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = SGS.ID_KADEME3
						INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = SGS.ID_KADEME3
						INNER JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = KB.ID_KADEME
						WHERE SGS.ID_SUBE = @ID_SUBE
						FOR JSON PATH
					) AS J
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT DISTINCT PSK.ID_KADEME, K.AD
						FROM OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PSK
						INNER JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = PSK.ID_KADEME
						WHERE PSK.TCKIMLIKNO = @TCKIMLIKNO
						FOR JSON PATH
					) AS J
				END
			END

			IF @ISLEM = 20	--	KULLANICI TİPİ
			BEGIN
				SELECT
				(
					select * from [dbo].[v3KullaniciTipi]
					WHERE ID_KULLANICITIPI IN (53, 54, 59)
					ORDER BY AD ASC
				FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 21	--	PERSONEL GETİR - MULTİ
			BEGIN
				SELECT
				(
					SELECT DISTINCT k.TCKIMLIKNO, K.AD + ' ' + K.SOYAD + ' (' + KD.AD + ' - ' + KT.AD + ')' AS ADSOYAD 
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ KK ON KK.TCKIMLIKNO = K.TCKIMLIKNO /*AND KK.ID_SUBE = SY.ID_SUBE*/
					--INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = SY.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
					INNER JOIN OkyanusDB.dbo.v3Kademe KD ON KD.ID_KADEME = KK.ID_KADEME
					WHERE SY.ID_SUBE = @ID_SUBE
					AND (@ID_KADEMELIST IS NULL OR @ID_KADEMELIST='' OR KK.ID_KADEME IN (SELECT Value FROM OPENJSON(@ID_KADEMELIST)))
					AND (@ID_KULLANICITIPILIST IS NULL OR @ID_KULLANICITIPILIST='' OR SY.ID_KULLANICITIPI IN (SELECT Value FROM OPENJSON(@ID_KULLANICITIPILIST)))
					ORDER BY ADSOYAD
					FOR JSON AUTO 
				) AS J
			END

			IF @ISLEM = 22	--	PERİYOT GETİR - MULTİ
			BEGIN
				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
						  ,CONVERT(VARCHAR, [BASLANGIC], 104) + ' - ' + CONVERT(VARCHAR, [BITIS], 104) AS [AD]
					FROM DegerlendirmePeriyot DP
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
					ORDER BY CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 23	--	PDS RAPOR
			BEGIN
				DECLARE  @KULLANICITIPI VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
						,@KADEME		VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
						,@PUANTURSAYISI INT			 = (SELECT COUNT(1) FROM DegerlendirmePuanTur)

				SELECT DISTINCT SY.TCKIMLIKNO, SY.ID_SUBE 
				INTO #SUBETCLIST 
				FROM v3SubeYetki SY 
				INNER JOIN OkyanusDB.dbo.v4KullaniciKademe PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND PSK.ID_KADEME = @ID_KADEME
				WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI				

				SELECT DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLIST
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
				GROUP BY DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #GENELPUANORTALAMALARI
				FROM #TOPLAMPUANLIST
				GROUP BY BOLUM

				SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARI
				FROM #TOPLAMPUANLIST TC
				WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				GROUP BY TCKIMLIKNO, BOLUM

				SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #TOPLAMPUANORTALAMALARI
				FROM #TOPLAMPUANLIST TC
				GROUP BY TCKIMLIKNO, BOLUM

				SELECT TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				INTO #GENELSIRA
				FROM #TOPLAMPUANORTALAMALARI TC

				SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRA SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				INTO #GENELSIRA2
				FROM #GENELSIRA SS

				SELECT TCKIMLIKNO, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				INTO #SONSIRALI
				FROM #TOPLAMPUANLIST
				GROUP BY TCKIMLIKNO

				SELECT   DISTINCT
							SSS.SIRA
						,K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,@KADEME AS KADEME
						,@KULLANICITIPI AS KULLANICITIPI
				FROM OkyanusDB.dbo.v3Kullanici K
				INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = STC.ID_SUBE
				INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = STC.TCKIMLIKNO
				WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				ORDER BY SSS.SIRA

				SELECT DISTINCT K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, G.ORTALAMA AS GENEL,GS.SIRA AS GENELSIRA, SSS.SIRA
				FROM #KENDIPUANORTALAMALARI K
				INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN #GENELPUANORTALAMALARI G ON G.BOLUM = K.BOLUM
				INNER JOIN #GENELSIRA2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = K.TCKIMLIKNO
				ORDER BY SSS.SIRA, K.BOLUM	

				SELECT	 DISTINCT
							DY.TCKIMLIKNO
						,K.AD + ' ' +K.SOYAD AS ADSOYAD
						,UPPER(DY.YORUM) AS YORUM
						,CONVERT(varchar, DY.KYE_TARIH, 104) AS TARIH
						,DY.KYE_TARIH
				FROM DegerlendirmeYorum DY
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				WHERE DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT 
				AND (DY.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				AND DY.YORUM <> ''
				ORDER BY DY.KYE_TARIH DESC

				SELECT DISTINCT S.* FROM #SONSIRALI S
				INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = S.TCKIMLIKNO 
				ORDER BY SIRA

				DROP TABLE IF EXISTS #GENELPUANORTALAMALARI
				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARI
				DROP TABLE IF EXISTS #GENELSIRA
				DROP TABLE IF EXISTS #GENELSIRA2
				DROP TABLE IF EXISTS #TOPLAMPUANLIST
				DROP TABLE IF EXISTS #SUBETCLIST
				DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARI
				DROP TABLE IF EXISTS #SONSIRALI
				--DECLARE  @KULLANICITIPI VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
				--		,@KADEME		VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
				--		,@PUANTURSAYISI INT			 = (SELECT COUNT(*) FROM DegerlendirmePuanTur)

				--SELECT SY.TCKIMLIKNO, SY.ID_SUBE 
				--INTO #SUBETCLIST 
				--FROM v3SubeYetki SY 
				--INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND /*PSK.ID_SUBE = SY.ID_SUBE AND*/ PSK.ID_KADEME = @ID_KADEME
				--WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI				

				--SELECT DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				--INTO #TOPLAMPUANLIST
				--FROM DegerlendirmeSoru DS
				--INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				--INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				--WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
				--GROUP BY DK.AD, DP.TCKIMLIKNO
				--ORDER BY DP.TCKIMLIKNO

				--SELECT BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #GENELPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST
				--GROUP BY BOLUM

				--SELECT BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA, STC.ID_SUBE
				--INTO #SUBEPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST TC
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO
				--GROUP BY BOLUM, STC.ID_SUBE

				--SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #KENDIPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST TC
				--WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--GROUP BY TCKIMLIKNO, BOLUM

				--SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #TOPLAMPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST TC
				--GROUP BY TCKIMLIKNO, BOLUM

				--SELECT TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY BOLUM, STC.ID_SUBE ORDER BY ORTALAMA DESC) AS SIRA, STC.ID_SUBE 
				--INTO #SUBESIRA
				--FROM #TOPLAMPUANORTALAMALARI TC
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #SUBESIRA SUBSS WHERE SUBSS.BOLUM = SS.BOLUM AND SUBSS.ID_SUBE = SS.ID_SUBE) AS VARCHAR) AS SIRA, SS.ID_SUBE 
				--INTO #SUBESIRA2
				--FROM #SUBESIRA SS

				--SELECT TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				--INTO #GENELSIRA
				--FROM #TOPLAMPUANORTALAMALARI TC

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRA SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				--INTO #GENELSIRA2
				--FROM #GENELSIRA SS

				--SELECT TCKIMLIKNO, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				--INTO #SONSIRALI
				--FROM #TOPLAMPUANLIST
				--GROUP BY TCKIMLIKNO

				--SELECT   DISTINCT
				--		 SSS.SIRA
				--		,K.TCKIMLIKNO
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,CASE WHEN @ID_KULLANICITIPI = 59 THEN '-' ELSE SB.AD END AS SUBE
				--		--,SB.ID_SUBE
				--		,@KADEME AS KADEME
				--		,@KULLANICITIPI AS KULLANICITIPI
				--FROM OkyanusDB.dbo.v3Kullanici K
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = STC.TCKIMLIKNO
				--WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--ORDER BY SSS.SIRA

				--SELECT DISTINCT K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, S.ORTALAMA AS SUBE, G.ORTALAMA AS GENEL, SS.SIRA AS SUBESIRA, GS.SIRA AS GENELSIRA, SSS.SIRA
				--FROM #KENDIPUANORTALAMALARI K
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN #SUBEPUANORTALAMALARI S ON S.BOLUM = K.BOLUM AND S.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELPUANORTALAMALARI G ON G.BOLUM = K.BOLUM
				--INNER JOIN #SUBESIRA2 SS ON SS.TCKIMLIKNO = K.TCKIMLIKNO AND SS.BOLUM = K.BOLUM AND SS.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELSIRA2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				--INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = K.TCKIMLIKNO
				--ORDER BY SSS.SIRA, K.BOLUM	

				--SELECT	 DISTINCT
				--		 DY.TCKIMLIKNO
				--		,K.AD + ' ' +K.SOYAD AS ADSOYAD
				--		,UPPER(DY.YORUM) AS YORUM
				--		,CONVERT(varchar, DY.KYE_TARIH, 104) AS TARIH
				--		,DY.KYE_TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT 
				--AND (DY.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				--SELECT DISTINCT S.* FROM #SONSIRALI S
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = S.TCKIMLIKNO 
				--ORDER BY SIRA

				--DROP TABLE IF EXISTS #GENELPUANORTALAMALARI
				--DROP TABLE IF EXISTS #SUBEPUANORTALAMALARI
				--DROP TABLE IF EXISTS #KENDIPUANORTALAMALARI
				--DROP TABLE IF EXISTS #SUBESIRA
				--DROP TABLE IF EXISTS #GENELSIRA
				--DROP TABLE IF EXISTS #SUBESIRA2
				--DROP TABLE IF EXISTS #GENELSIRA2
				--DROP TABLE IF EXISTS #TOPLAMPUANLIST
				--DROP TABLE IF EXISTS #SUBETCLIST
				--DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARI
				--DROP TABLE IF EXISTS #SONSIRALI
			END

			IF @ISLEM = 24	--	PDS EXCEL
			BEGIN
				DECLARE  @KULLANICITIPIEXCEL	VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
						,@KADEMEEXCEL			VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
						,@PUANTURSAYISIEXCEL	INT			 = (SELECT COUNT(*) FROM DegerlendirmePuanTur)
				
				SELECT DISTINCT SY.TCKIMLIKNO, SY.ID_SUBE 
				INTO #SUBETCLISTEXCEL 
				FROM v3SubeYetki SY 
				INNER JOIN OkyanusDB.dbo.v4KullaniciKademe PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND PSK.ID_KADEME = @ID_KADEME
				WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI

				SELECT   DISTINCT
						 K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,@KADEMEEXCEL AS KADEME
						,@KULLANICITIPIEXCEL AS KULLANICITIPI
				FROM OkyanusDB.dbo.v3Kullanici K
				INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))

				SELECT CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISIEXCEL) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	((DS.DONEM = @DONEM AND @ID_DEGERLENDIRMEPERIYOT = 0)
				OR		(DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT))
				AND		DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT PERIYOT, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #GENELPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL
				GROUP BY PERIYOT, BOLUM

				SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #TOPLAMPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				SELECT PERIYOT, TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY PERIYOT, BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				INTO #GENELSIRAEXCEL
				FROM #TOPLAMPUANORTALAMALARIEXCEL TC

				SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRAEXCEL SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				INTO #GENELSIRAEXCEL2
				FROM #GENELSIRAEXCEL SS

				SELECT DISTINCT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, G.ORTALAMA AS GENEL, GS.SIRA AS GENELSIRA
				FROM #KENDIPUANORTALAMALARIEXCEL K
				INNER JOIN #GENELPUANORTALAMALARIEXCEL G ON G.BOLUM = K.BOLUM
				INNER JOIN #GENELSIRAEXCEL2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				ORDER BY K.TCKIMLIKNO, PERIYOT, K.BOLUM

				SELECT DISTINCT T.TCKIMLIKNO, PERIYOT, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (PARTITION BY PERIYOT ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				FROM #TOPLAMPUANLISTEXCEL T
				INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = T.TCKIMLIKNO
				GROUP BY T.TCKIMLIKNO, PERIYOT

				DROP TABLE IF EXISTS #GENELPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #GENELSIRAEXCEL
				DROP TABLE IF EXISTS #GENELSIRAEXCEL2
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
				DROP TABLE IF EXISTS #SUBETCLISTEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARIEXCEL
				--DECLARE  @KULLANICITIPIEXCEL	VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
				--		,@KADEMEEXCEL			VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
				--		,@PUANTURSAYISIEXCEL	INT			 = (SELECT COUNT(*) FROM DegerlendirmePuanTur)
				
				--SELECT DISTINCT SY.TCKIMLIKNO, SY.ID_SUBE 
				--INTO #SUBETCLISTEXCEL 
				--FROM v3SubeYetki SY 
				--INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND /*PSK.ID_SUBE = SY.ID_SUBE AND*/ PSK.ID_KADEME = @ID_KADEME
				--WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI

				--SELECT   K.TCKIMLIKNO
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,CASE WHEN @ID_KULLANICITIPI = 59 THEN '-' ELSE SB.AD END AS SUBE
				--		--,SB.ID_SUBE
				--		,@KADEMEEXCEL AS KADEME
				--		,@KULLANICITIPIEXCEL AS KULLANICITIPI
				--FROM OkyanusDB.dbo.v3Kullanici K
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = STC.ID_SUBE
				--WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))

				--SELECT CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISIEXCEL) AS MAXPUAN
				--INTO #TOPLAMPUANLISTEXCEL
				--FROM DegerlendirmeSoru DS
				--INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				--INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				--INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				----INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = DP.TCKIMLIKNO
				--WHERE	((DS.DONEM = @DONEM AND @ID_DEGERLENDIRMEPERIYOT = 0)
				--OR		(DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT))
				--AND		DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
				--AND		DS.ID_KADEME = @ID_KADEME
				--GROUP BY PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				--ORDER BY DP.TCKIMLIKNO

				--SELECT PERIYOT, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #GENELPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL
				--GROUP BY PERIYOT, BOLUM

				--SELECT PERIYOT, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA, STC.ID_SUBE
				--INTO #SUBEPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL TC
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO
				--GROUP BY PERIYOT, BOLUM, STC.ID_SUBE

				--SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #KENDIPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL TC
				--WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				--SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #TOPLAMPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL TC
				--GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				--SELECT PERIYOT, TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY PERIYOT, BOLUM, STC.ID_SUBE ORDER BY ORTALAMA DESC) AS SIRA, STC.ID_SUBE
				--INTO #SUBESIRAEXCEL
				--FROM #TOPLAMPUANORTALAMALARIEXCEL TC
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #SUBESIRAEXCEL SUBSS WHERE SUBSS.BOLUM = SS.BOLUM AND SUBSS.ID_SUBE = SS.ID_SUBE) AS VARCHAR) AS SIRA, SS.ID_SUBE
				--INTO #SUBESIRAEXCEL2
				--FROM #SUBESIRAEXCEL SS

				--SELECT PERIYOT, TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY PERIYOT, BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				--INTO #GENELSIRAEXCEL
				--FROM #TOPLAMPUANORTALAMALARIEXCEL TC

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRAEXCEL SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				--INTO #GENELSIRAEXCEL2
				--FROM #GENELSIRAEXCEL SS

				--SELECT DISTINCT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, S.ORTALAMA AS SUBE, G.ORTALAMA AS GENEL, SS.SIRA AS SUBESIRA, GS.SIRA AS GENELSIRA
				--FROM #KENDIPUANORTALAMALARIEXCEL K
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN #SUBEPUANORTALAMALARIEXCEL S ON S.BOLUM = K.BOLUM AND S.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELPUANORTALAMALARIEXCEL G ON G.BOLUM = K.BOLUM
				--INNER JOIN #SUBESIRAEXCEL2 SS ON SS.TCKIMLIKNO = K.TCKIMLIKNO AND SS.BOLUM = K.BOLUM AND SS.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELSIRAEXCEL2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				--ORDER BY K.TCKIMLIKNO, PERIYOT, K.BOLUM

				--SELECT DISTINCT T.TCKIMLIKNO, PERIYOT, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (PARTITION BY PERIYOT ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				--FROM #TOPLAMPUANLISTEXCEL T
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = T.TCKIMLIKNO
				--GROUP BY T.TCKIMLIKNO, PERIYOT

				--DROP TABLE IF EXISTS #GENELPUANORTALAMALARIEXCEL
				--DROP TABLE IF EXISTS #SUBEPUANORTALAMALARIEXCEL
				--DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				--DROP TABLE IF EXISTS #SUBESIRAEXCEL
				--DROP TABLE IF EXISTS #GENELSIRAEXCEL
				--DROP TABLE IF EXISTS #SUBESIRAEXCEL2
				--DROP TABLE IF EXISTS #GENELSIRAEXCEL2
				--DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
				--DROP TABLE IF EXISTS #SUBETCLISTEXCEL
				--DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARIEXCEL
			END

			IF @ISLEM = 25	--	KADEME GETİR
			BEGIN
				SELECT
				(
					SELECT ID_KADEME, AD FROM OkyanusDB.dbo.v3Kademe
					ORDER BY ID_KADEME
					FOR JSON PATH
				) AS J
			
			END

			IF @ISLEM = 26	--	PERİYOT GETİR - TİPSİZ
			BEGIN
				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
						  ,'('+ KT.AD + ')' + ' - ' + CONVERT(VARCHAR, [BASLANGIC], 104) + ' - ' + CONVERT(VARCHAR, [BITIS], 104) AS [AD]
					FROM DegerlendirmePeriyot DP
					INNER JOIN OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = DP.ID_KULLANICITIPI
					WHERE DONEM = @DONEM 
					AND ((DP.ID_KULLANICITIPI IN (53, 54, 59) AND @RAPORTIPI = 1) OR (DP.ID_KULLANICITIPI = 4 AND @RAPORTIPI = 2))
					AND ID_KADEME = @ID_KADEME 
					ORDER BY KT.AD, CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 27	--	DEĞERLENDİRME YAPMAYANLAR
			BEGIN
				IF @DURUM = 0 -- DEĞERLENDİRME YAPMAYANLAR
				BEGIN
					SELECT DISTINCT KYE_TCKIMLIKNO
					INTO #DEGERLENDIRMEYAPANLAR
					FROM DegerlendirmePuan P
					WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND P.TCKIMLIKNO <> '0'

					SELECT DISTINCT O.TCKIMLIKNO
					INTO #DEGERLENDIRMEYAPMAYANLAR
					FROM OkyanusDB.dbo.v3Ogretmen O
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PK ON PK.TCKIMLIKNO = O.TCKIMLIKNO
					LEFT JOIN #DEGERLENDIRMEYAPANLAR D ON D.KYE_TCKIMLIKNO = O.TCKIMLIKNO
					WHERE PK.ID_KADEME = @ID_KADEME 
					AND D.KYE_TCKIMLIKNO IS NULL
					--AND (PK.ID_SUBE IN (SELECT ID_SUBE FROM #SUBELIST) OR @GENELYETKI = 1)

					DECLARE @KADEMEAD VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)

					SELECT	 DY.TCKIMLIKNO
							,K.AD
							,K.SOYAD
							,STUFF(
									(	
										SELECT DISTINCT ', ' + S.AD
										FROM OkyanusDB.dbo.v3Sube S
										INNER JOIN OkyanusDB.dbo.v3SubeYetki SUBSY ON SUBSY.ID_SUBE = S.ID_SUBE AND SUBSY.TCKIMLIKNO = DY.TCKIMLIKNO
										ORDER BY ', ' + S.AD
										FOR XML PATH('')
									)
								  , 1, 1, '') SUBE
							,@KADEMEAD AS KADEME
							,ISNULL(O.BRANS, '-') AS BRANS
							,CASE WHEN ISNULL(KB.EMAIL, KB.EMAIL2) LIKE '%@%' THEN ISNULL(KB.EMAIL, KB.EMAIL2) ELSE '' END AS EPOSTA
					FROM #DEGERLENDIRMEYAPMAYANLAR DY 
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.TCKIMLIKNO
					LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
					LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi KB ON KB.TCKIMLIKNO = DY.TCKIMLIKNO
					ORDER BY SUBE, AD, SOYAD

					DROP TABLE #DEGERLENDIRMEYAPANLAR
					DROP TABLE #DEGERLENDIRMEYAPMAYANLAR
				END
				ELSE IF @DURUM = 2
				BEGIN
					DECLARE @P_ID_KADEME INT, @P_ID_KULLANICITIPI INT, @P_DONEM VARCHAR(MAX)

					SELECT @P_ID_KADEME = ID_KADEME, @P_ID_KULLANICITIPI = ID_KULLANICITIPI, @P_DONEM = DONEM 
					FROM DegerlendirmePeriyot P
					WHERE P.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

					IF @P_ID_KULLANICITIPI = 4
					BEGIN
						SELECT	DISTINCT 
								O.TCKIMLIKNO
								,K.AD
								,K.SOYAD
								,SUBE.AD AS SUBE
								,KD.AD AS KADEME
								,'-' AS BRANS
								,CASE WHEN ISNULL(KB.EMAIL, KB.EMAIL2) LIKE '%@%' THEN ISNULL(KB.EMAIL, KB.EMAIL2) ELSE '' END AS EPOSTA
						FROM OkyanusDB.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Satislar S ON S.ID_SOZLESME = O.ID_SOZLESME
						INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
						INNER JOIN OkyanusDB.dbo.v3Sube SUBE ON SUBE.ID_SUBE = O.ID_SUBE
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kademe KD ON KD.ID_KADEME = ST.ID_KADEME
						LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi KB ON KB.TCKIMLIKNO = O.TCKIMLIKNO
						WHERE ST.ID_KADEME = @P_ID_KADEME AND O.DONEM = @P_DONEM AND NOT EXISTS (SELECT TCKIMLIKNO FROM DegerlendirmePuan DP WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO = O.TCKIMLIKNO)
						ORDER BY SUBE, AD, SOYAD
					END
					ELSE
					BEGIN
						SELECT  DISTINCT 
								KK.TCKIMLIKNO
								,K.AD
								,K.SOYAD
								,STUFF(
										(	
											SELECT DISTINCT ', ' + S.AD
											FROM OkyanusDB.dbo.v3Sube S
											INNER JOIN OkyanusDB.dbo.v3SubeYetki SUBSY ON SUBSY.ID_SUBE = S.ID_SUBE AND SUBSY.TCKIMLIKNO = KK.TCKIMLIKNO
											ORDER BY ', ' + S.AD
											FOR XML PATH('')
										)
									, 1, 1, '') SUBE
								,KD.AD AS KADEME
								,ISNULL(O.BRANS, '-') AS BRANS
								,CASE WHEN ISNULL(KB.EMAIL, KB.EMAIL2) LIKE '%@%' THEN ISNULL(KB.EMAIL, KB.EMAIL2) ELSE '' END AS EPOSTA
						FROM OkyanusDB.dbo.v4KullaniciKademe KK
						INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = KK.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = KK.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kademe KD ON KD.ID_KADEME = KK.ID_KADEME
						LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
						LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi KB ON KB.TCKIMLIKNO = KK.TCKIMLIKNO
						WHERE KK.ID_KADEME = @P_ID_KADEME AND SY.ID_KULLANICITIPI = @P_ID_KULLANICITIPI AND NOT EXISTS (SELECT TCKIMLIKNO FROM DegerlendirmePuan DP WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO = KK.TCKIMLIKNO)
						ORDER BY SUBE, AD, SOYAD
					END
				END
				ELSE IF @DURUM = 1
				BEGIN
					SELECT
					(
						SELECT DISTINCT P.ID_DEGERLENDIRMEPERIYOT, K.TCKIMLIKNO AS TC_DEGERLENDIREN, K2.TCKIMLIKNO AS TC_DEGERLENDIRILEN, K.AD + ' ' + K.SOYAD AS DEGERLENDIREN, K2.AD + ' ' + K2.SOYAD AS DEGERLENDIRILEN, ISNULL(O.BRANS,'') AS BRANS
						FROM DegerlendirmePuan P
						INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = P.KYE_TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = P.TCKIMLIKNO
						LEFT  JOIN v3Ogretmen				 O	ON O.TCKIMLIKNO  = K.TCKIMLIKNO 
						WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND P.TCKIMLIKNO <> '0'
						ORDER BY DEGERLENDIREN, DEGERLENDIRILEN
						FOR JSON PATH
					)
				END
			END

			IF @ISLEM = 28	--	PERSONEL GETİR - MULTİ ŞUBE
			BEGIN
				SELECT
				(
					SELECT DISTINCT k.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD 
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ KK ON KK.TCKIMLIKNO = K.TCKIMLIKNO /*AND KK.ID_SUBE = SY.ID_SUBE*/
					WHERE SY.ID_KULLANICITIPI = @ID_KULLANICITIPI 
					AND KK.ID_KADEME = @ID_KADEME 
					AND (@ID_SUBELIST IS NULL OR @ID_SUBELIST='' OR SY.ID_SUBE IN (SELECT Value FROM OPENJSON(@ID_SUBELIST)))
					ORDER BY ADSOYAD
					FOR JSON AUTO 
				) AS J
			END

			IF @ISLEM = 29	--	ÖĞRENCİ LİSTELE V4
			BEGIN
				CREATE TABLE #OGRENCIV4 (AD VARCHAR(100) ,SOYAD VARCHAR(100),TCKIMLIKNO VARCHAR(11))

				IF @ID_SINIF < 0 
				BEGIN
					INSERT INTO #OGRENCIV4 (AD,SOYAD,TCKIMLIKNO)
					SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
					FROM OkyanusDB.dbo.v4SinifOgrenci	O
					JOIN v3Kullanici	K	ON K.TCKIMLIKNO	= O.TC_OGRENCI
					WHERE O.ID_SINIF = @ID_SINIF AND O.AKTIF = 1
				END
				ELSE
				BEGIN
				
					INSERT INTO #OGRENCIV4 (AD,SOYAD,TCKIMLIKNO)
					SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
					FROM v3OgrenciTum		O
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					WHERE O.ID_SINIF = @ID_SINIF

				END

				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = (SELECT ID_KADEME FROM v3SinifTum WHERE ID_SINIF = @ID_SINIF)
				AND ID_KULLANICITIPI = 4

				IF @ID_LISTELEMETIPI = 0	--	TÜMÜ
				BEGIN
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCIV4
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 1	--	DEĞERLENDİRİLENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCIV4 O
						WHERE O.TCKIMLIKNO IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 2	--	DEĞERLENDİRİLMEYENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCIV4 O
						WHERE O.TCKIMLIKNO NOT IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END		
				
				DROP TABLE #OGRENCIV4		
			END

			IF @ISLEM = 30	--	DEĞERLENDİRME SİL
			BEGIN
				DELETE DP
				FROM DegerlendirmePuan DP
				WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO = @TC_DEGERLENDIRILEN AND DP.KYE_TCKIMLIKNO = @TC_DEGERLENDIREN
				
				SELECT ID_DEGERLENDIRMEYORUM
				INTO #TEMPYORUM
				FROM DegerlendirmeYorum DY
				WHERE DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TCKIMLIKNO = @TC_DEGERLENDIRILEN AND DY.KYE_TCKIMLIKNO = @TC_DEGERLENDIREN

				DELETE YD
				FROM DegerlendirmeYorumDurum YD
				INNER JOIN #TEMPYORUM Y ON Y.ID_DEGERLENDIRMEYORUM = YD.ID_DEGERLENDIRMEYORUM

				DELETE Y
				FROM DegerlendirmeYorum Y 
				WHERE Y.ID_DEGERLENDIRMEYORUM IN (SELECT TY.ID_DEGERLENDIRMEYORUM FROM #TEMPYORUM TY)

				DROP TABLE #TEMPYORUM
			END
		END
	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DegerlendirmeFormu]    Script Date: 22.11.2021 10:42:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_DegerlendirmeFormu]
	@ISLEM			INT				= NULL,
	@TCKIMLIKNO		VARCHAR(11)		= NULL,
	@OTURUM			VARCHAR(36)		= NULL,
	@ID_MENU		INT				= NULL,

	@ID_DONEMDEGERLENDIRMEFORMUOO		INT				= NULL,
	@DONEM			NVARCHAR(4)		= NULL,
	@AY				NVARCHAR(MAX)	= NULL,
	@TC_OGRENCI		VARCHAR(11)		= NULL,
	@SQLJSON		NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

			--SET @DONEM = ISNULL((SELECT TOP 1 DONEM FROM v3AktifDonem WHERE DONEM = @DONEM),@AKTIFDONEM)
						
			IF @ISLEM = 1	--	DÖNEM LİSTESİ			
			BEGIN
			
				SELECT ISNULL((				
					SELECT DISTINCT DF.DONEM		
					FROM eokul_v2.dbo.DegerlendirmeFormuOgrenci		dfo
					INNER JOIN eokul_v2.dbo.DegerlendirmeFormuAlt	dfa on	dfo.ID_DEGERLENDIRMEALT	= dfa.ID_DEGERLENDIRMEALT
					INNER JOIN eokul_v2.dbo.DegerlendirmeFormu		df	on	df.ID_DEGERLENDIRMEFORMU= dfo.ID_DEGERLENDIRMEFORMU
					WHERE	DFO.TC_OGRENCI	= @TC_OGRENCI
						AND DFA.SILINDI		= 0			
						AND DF.SILINDI		= 0
					ORDER BY DF.DONEM DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END

			IF @ISLEM = 2	--	AY LİSTESİ				
			BEGIN
			
				SELECT ISNULL((				
					SELECT DISTINCT DF.AY
					FROM eokul_v2.dbo.DegerlendirmeFormuOgrenci		dfo
					INNER JOIN eokul_v2.dbo.DegerlendirmeFormuAlt	dfa on	dfo.ID_DEGERLENDIRMEALT	= dfa.ID_DEGERLENDIRMEALT
					INNER JOIN eokul_v2.dbo.DegerlendirmeFormu		df	on	df.ID_DEGERLENDIRMEFORMU= dfo.ID_DEGERLENDIRMEFORMU
					WHERE	DFO.TC_OGRENCI	= @TC_OGRENCI
						AND DF.DONEM		= @DONEM
						AND DFA.SILINDI		= 0
						AND DF.SILINDI		= 0
					--ORDER BY df.ID_DEGERLENDIRMEFORMU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END

			IF @ISLEM = 3	--	DEĞERLENDİRME LİSTESİ	
			BEGIN
			
				SELECT ISNULL((				
					SELECT	df.ANABASLIK,
							dfa.BASLIK,
							--dfo.ID_DEGERLENDIRMEOGRENCI,
							--dfo.ID_DEGERLENDIRMEFORMU,
							--dfo.ID_DEGERLENDIRMEALT,
							dfo.DEGER
					FROM eokul_v2.dbo.DegerlendirmeFormuOgrenci		dfo
					INNER JOIN eokul_v2.dbo.DegerlendirmeFormuAlt	dfa on	dfo.ID_DEGERLENDIRMEALT	= dfa.ID_DEGERLENDIRMEALT
					INNER JOIN eokul_v2.dbo.DegerlendirmeFormu		df	on	df.ID_DEGERLENDIRMEFORMU= dfo.ID_DEGERLENDIRMEFORMU
					WHERE	DFO.TC_OGRENCI	= @TC_OGRENCI
						AND df.AY			= @AY
						AND df.SILINDI		= 0
						AND dfa.SILINDI		= 0
						AND (	(@DONEM = DF.DONEM) 
							OR	(@DONEM = '' AND @AKTIFDONEM = DF.DONEM))
					ORDER BY dfo.ID_DEGERLENDIRMEFORMU,dfo.ID_DEGERLENDIRMEALT
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				
			END
			
			IF @ISLEM = 4	--	ÖĞRENCİ DETAY			
			BEGIN
			
				IF @DONEM IS NULL
					SET @DONEM = @AKTIFDONEM

				SELECT ISNULL((				
					SELECT	 D.TCKIMLIKNO
							,ADSOYAD	= CONCAT_WS(' ', D.AD, D.SOYAD)
							,KADEME3
							,SUBEAD
							,SINIFAD
							,ID_SUBE
							,ID_SINIF
							,FOTOGRAF	= ISNULL(R.FOTOGRAF,'')
					FROM OkyanusDB.dbo.vw_OgrenciDetayTum	D
					LEFT JOIN OkyanusDB.dbo.v3Resim			R	ON	R.TCKIMLIKNO	= D.TCKIMLIKNO
																AND R.SIRANO		= 1
					WHERE	D.DONEM			= @DONEM
						AND D.TCKIMLIKNO	= @TC_OGRENCI
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END
			
			IF @ISLEM = 5	--	DÖNEMLİK DEĞ. LİSTE		
			BEGIN
			
				SELECT ISNULL((
					
					Select distinct
						   dd.ID_DONEMDEGERLENDIRMEFORMUOO,
						   ddo.FORM,
						   od.SINIFAD,
						   od.AD,
						   od.SOYAD,
						   o.OGRNO,
						   DDO.DONEM
					  from eokul_v2.dbo.DonemDegerlendirmeFormuOgrenciOO DD
				inner join eokul_v2.dbo.DonemDegerlendirmeFormuOO		DDO ON	DDO.ID_DONEMDEGERLENDIRMEFORMUOO	= DD.ID_DONEMDEGERLENDIRMEFORMUOO
				inner join OkyanusDB.dbo.v3OgrenciTum					O	ON	O.ID_OGRENCI						= DD.ID_OGRENCI
																			AND O.DONEM								= DDO.DONEM
				inner join OkyanusDB.dbo.vw_OgrenciDetayTum				OD	ON	OD.ID_SINIF							= O.ID_SINIF
																			AND OD.TCKIMLIKNO						= O.TCKIMLIKNO
					 where OD.TCKIMLIKNO= @TC_OGRENCI
					   and dd.SILINDI	= 0
					   and ddo.SILINDI	= 0
					   and dd.ONAY		= 1
					ORDER BY dd.ID_DONEMDEGERLENDIRMEFORMUOO DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END
			
			IF @ISLEM = 6	--	DÖNEMLİK DEĞ. DETAY		
			BEGIN
			
				SELECT ISNULL((					
					Select top 10 D.FORMBASLIK,
						   DD.ID_DONEMDEGERLENDIRMEOGRENCIOO,
						   DD.ID_DONEMDEGERLENDIRMEFORMUOO,
						   DD.ID_DEGERLENDIRMEFORMUDETAYOO,
						   DD.DEGERLENDIRME
					  from eokul_v2.dbo.DonemDegerlendirmeFormuOgrenciOO	DD
					  join eokul_v2.dbo.DonemDegerlendirmeFormuDetayOO		D	ON	D.ID_DEGERLENDIRMEFORMUDETAYOO	= DD.ID_DEGERLENDIRMEFORMUDETAYOO
					 where DD.ID_DONEMDEGERLENDIRMEFORMUOO	= @ID_DONEMDEGERLENDIRMEFORMUOO					   
					   AND DD.TC_OGRENCI					= @TC_OGRENCI
					   and DD.SILINDI						= 0
					   order by dd.ID_DONEMDEGERLENDIRMEOGRENCIOO
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END
			
		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DemoOgrenci]    Script Date: 22.11.2021 10:43:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_DemoOgrenci]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINAVGRUP		INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINIFS			VARCHAR(MAX)	= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_TKTZEKATURUS	VARCHAR(MAX)	= NULL,
	@ID_TKTSINAV		INT				= NULL,
	@ID_TKTTEST			INT				= NULL,
	@TARIH				Date			= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	  
			ISLEM				 	= @ISLEM			
			,TCKIMLIKNO			 	= @TCKIMLIKNO		
			,OTURUM				 	= @OTURUM			
			,TC_OGRENCI			 	= @TC_OGRENCI		
			,ID_MENU			 	= @ID_MENU		
			,ID_SUBE			 	= @ID_SUBE		
			,ID_SINAVGRUP		 	= @ID_SINAVGRUP	
			,ID_SINIF			 	= @ID_SINIF		
			,ID_KADEME3			 	= @ID_KADEME3		
			,ID_SINIFS			 	= @ID_SINIFS		
			,SINIFLAR			 	= @SINIFLAR		
			,ID_TKTZEKATURUS	 	= @ID_TKTZEKATURUS
			,ID_TKTSINAV		 	= @ID_TKTSINAV	
			,ID_TKTTEST			 	= @ID_TKTTEST		
			,TARIH				 	= @TARIH			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	Demo Öğrenci Listele 
			BEGIN
				SELECT	 [FOTOGRAF]		= ISNULL(R.FOTOGRAF,'')
						,[ADSOYAD]		= K.AD +' '+ K.SOYAD
						,[OGRNO]	= O.OGRNO
						,[SINIF]		= SN.AD
						,[TCKIMLIKNO]	= O.TCKIMLIKNO
						,[OTURUM]		= K.OTURUM
						--,[İŞLEM]		= '<input style="float:right;margin: 10px;" type="button" class="btn btn-success" v-on:click="DemoLogin('+O.TCKIMLIKNO+')" value="Giriş Yap">'
				INTO #DemoOgrenciList
				FROM v3Ogrenci						O
				JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF		= O.ID_SINIF
				JOIN v3Sinif						SN	ON	SN.ID_SINIF		= O.ID_SINIF
				JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.DBO.v3Resim		R	ON	R.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	(O.ID_SUBE	= @ID_SUBE			OR @ID_SUBE		= 0 )
					AND (O.ID_SINIF = @ID_SINIF			OR @ID_SINIF	= 0 )
					AND (ID_KADEME3 = @ID_KADEME3		OR @ID_KADEME3	= 0 )
					--AND (K.AD		LIKE '%'+@AD+'%'	OR @AD			= '')
					--AND (K.SOYAD	LIKE '%'+@SOYAD+'%'	OR @SOYAD		= '')
				ORDER BY [ADSOYAD]--,[ÖĞRENCİ NO]


				select(
						select * from(
							select 
							(						 
								SELECT * FROM #DemoOgrenciList
								ORDER BY [ADSOYAD]
								FOR JSON AUTO
							) as DemoOgrenciList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #DemoOgrenciList

			END

			IF @ISLEM = 2
			BEGIN
			
				select(
						select * from(
							select 
							(						 
								SELECT TCKIMLIKNO,OTURUM FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TC_OGRENCI
								FOR JSON AUTO
							) as DemoOgrenciLogin	
						) as tablo FOR JSON AUTO
					) as tt
				
			END
		
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO


USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DenemeSinavRaporlari]    Script Date: 22.11.2021 10:43:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_DenemeSinavRaporlari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_KADEME3			INT				= NULL,	
	@ID_SINIF			INT				= NULL,	
	@ID_SINAV			INT				= NULL,
	@LIMIT				INT				= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	  
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENU			= @ID_MENU		
			,ID_SUBE			= @ID_SUBE		
			,ID_SINAVTURU		= @ID_SINAVTURU	
			,ID_KADEME3			= @ID_KADEME3		
			,ID_SINIF			= @ID_SINIF		
			,ID_SINAV			= @ID_SINAV		
			,LIMIT				= @LIMIT			
			,DONEM				= @DONEM			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN			
		DECLARE @SINAVGRUP INT = (SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV)
		IF @ISLEM = 1	--	Sınav Listele
		BEGIN
			SELECT
			(
				SELECT S.ID_SINAV, S.AD, CONVERT(VARCHAR,S.SINAVTARIH,104) AS SINAVTARIH, COUNT(DISTINCT SO.TCKIMLIKNO) AS KATILIM FROM Sinav S
				INNER JOIN SinavOgrenci SO ON SO.ID_SINAV=S.ID_SINAV
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO AND O.DONEM = S.DONEM
				WHERE S.DONEM=@DONEM AND AKTIF=1
				AND (@ID_SINAVTURU=0 OR ID_SINAVTURU=@ID_SINAVTURU)
				AND (@ID_KADEME3=0 OR ID_KADEME3=@ID_KADEME3)
				AND (@ID_SINIF=0 OR @ID_SINIF=O.ID_SINIF)
				AND (@ID_SUBE IS NULL OR @ID_SUBE = O.ID_SUBE)
				GROUP BY S.ID_SINAV, S.AD, S.SINAVTARIH
				ORDER BY CAST(SINAVTARIH AS DATE) DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS J
		END

		IF @ISLEM = 2	--	Katılmayan Listele
		BEGIN
			SELECT K.TCKIMLIKNO, K.AD+' '+K.SOYAD AS ADSOYAD, SU.AD AS OKUL, SN.AD AS SINIF 
			FROM OkyanusDB.dbo.v3OgrenciTum O
			INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO=O.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE=O.ID_SUBE
			LEFT JOIN SinavOgrenci SO ON SO.TCKIMLIKNO=O.TCKIMLIKNO AND SO.ID_SINAV=@ID_SINAV
			WHERE SO.ID_SINAVOGRENCI IS NULL 
			AND	  (@ID_SUBE=0 OR @ID_SUBE=O.ID_SUBE)
			AND   (@ID_SINIF=0 OR @ID_SINIF=O.ID_SUBE)
			AND   (@SINAVGRUP=SGS.ID_KADEME3)
			AND	  (O.DONEM=(SELECT DONEM FROM Sinav WHERE ID_SINAV=@ID_SINAV))
			ORDER BY O.ID_SUBE, O.ID_SINIF, K.AD, K.SOYAD

			SELECT CAST(S.DONEM AS VARCHAR) + '-' + CAST(CAST(S.DONEM AS INT)+1 AS VARCHAR) + ' OKYANUS KOLEJİ ' + K3.AD + ' ' + S.AD + ' SINAVINA KATILMAYAN ÖĞRENCİLER' FROM Sinav S INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = S.ID_KADEME3 WHERE ID_SINAV = @ID_SINAV
		END

		IF @ISLEM = 3	--	Baraj Altı Öğrenci Listele
		BEGIN
			DECLARE @PUANTURLERI VARCHAR(MAX)=''
			DECLARE @PUANTURLERIISIMLI VARCHAR(MAX)=''
			DECLARE @PUANTURLERIWHERE VARCHAR(MAX)=''
			DECLARE @PUANTURLERIISIM VARCHAR(MAX)=''
			DECLARE @DERSLER VARCHAR(MAX)=''
			DECLARE @DERSLERISIMLI VARCHAR(MAX)=''
			DECLARE @DERSLERSUM VARCHAR(MAX)='CAST(('

			SELECT	@PUANTURLERI+='['+CAST(SPT.ID_SINAVPUANTURU AS VARCHAR)+'],'
					,@PUANTURLERIISIMLI+='CAST(['+CAST(SPT.ID_SINAVPUANTURU AS VARCHAR)+'] AS DECIMAL(6,3)) AS [PT-'+SPT.AD+'],' 
					,@PUANTURLERIWHERE+='[PT-'+SPT.AD+'] < '+CAST(@LIMIT AS VARCHAR)+ ' AND '
					,@PUANTURLERIISIM+='[PT-'+SPT.AD+'],'
			FROM Sinav S
			INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU=S.ID_SINAVTURU
			WHERE S.ID_SINAV=@ID_SINAV

			SET @PUANTURLERI=SUBSTRING(@PUANTURLERI,0,LEN(@PUANTURLERI))
			SET @PUANTURLERIISIMLI=SUBSTRING(@PUANTURLERIISIMLI,0,LEN(@PUANTURLERIISIMLI))
			SET @PUANTURLERIWHERE=SUBSTRING(@PUANTURLERIWHERE,0,LEN(@PUANTURLERIWHERE)-3)
			SET @PUANTURLERIISIM=SUBSTRING(@PUANTURLERIISIM,0,LEN(@PUANTURLERIISIM))

			IF EXISTS(SELECT AD FROM SinavPuanTuru WHERE ID_SINAVTURU=(SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV=@ID_SINAV))
			BEGIN
				SELECT @DERSLER+='['+TAKMAAD+'],'
					,@DERSLERISIMLI+='CAST(['+TAKMAAD+'] AS DECIMAL(5,2)) AS [DR-'+TAKMAAD+'],'
					,@DERSLERSUM+='['+TAKMAAD+']+'
				FROM SinavDers SD WHERE SD.ID_SINAV=@ID_SINAV

				SET @DERSLER=SUBSTRING(@DERSLER,0,LEN(@DERSLER))
				SET @DERSLERISIMLI=SUBSTRING(@DERSLERISIMLI,0,LEN(@DERSLERISIMLI))
				SET @DERSLERSUM=SUBSTRING(@DERSLERSUM,0,LEN(@DERSLERSUM))+') AS DECIMAL(5,2)) AS [DR-TOPLAM]'

				DECLARE @SQL NVARCHAR(MAX)=''

				SET @SQL=
				'
				SELECT *
				INTO #TEMP
				FROM
				(
					SELECT TCKIMLIKNO, ADSOYAD, OKUL, SINIF, '+@PUANTURLERIISIMLI+', SD.TAKMAAD, SOCB.NET
					FROM
					(
						SELECT K.TCKIMLIKNO, K.AD+'' ''+K.SOYAD AS ADSOYAD, SU.AD AS OKUL, SN.AD AS SINIF, SOS.ID_SINAVPUANTURU, SOS.PUAN 
						FROM Sinav S
						INNER JOIN SinavOgrenci SO ON SO.ID_SINAV=S.ID_SINAV
						INNER JOIN SinavOgrenciPuan SOS ON SOS.ID_SINAV=SO.ID_SINAV AND SOS.TCKIMLIKNO = SO.TCKIMLIKNO
						INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVPUANTURU=SOS.ID_SINAVPUANTURU
						INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3KullaniciKademe3 K3 ON K3.TCKIMLIKNO=O.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO=O.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE=O.ID_SUBE
						INNER JOIN OkyanusDB.dbo.v3Sinif SN ON SN.ID_SINIF=O.ID_SINIF
						WHERE	S.ID_SINAV='+CAST(@ID_SINAV AS VARCHAR)+'
						AND		EXISTS (SELECT PUAN FROM SinavOgrenciPuan SOSS WHERE SOSS.ID_SINAV=SO.ID_SINAV AND SOSS.TCKIMLIKNO = SO.TCKIMLIKNO AND PUAN<='+CAST(@LIMIT AS VARCHAR)+')
						AND		('+CAST(@ID_SUBE AS VARCHAR)+'=0 OR '+CAST(@ID_SUBE AS VARCHAR)+'=O.ID_SUBE)
						AND		('+CAST(@SINAVGRUP AS VARCHAR)+'=K3.ID_KADEME3)
						AND		('+CAST(@ID_SINIF AS VARCHAR)+'=0 OR '+CAST(@ID_SINIF AS VARCHAR)+'=O.ID_SINIF)
						GROUP BY SOS.ID_SINAVPUANTURU, K.TCKIMLIKNO, K.AD, K.SOYAD, SU.AD, SN.AD, SOS.PUAN 
					) AS SourceTable
					PIVOT
					(
					AVG(PUAN)
					FOR ID_SINAVPUANTURU IN ('+@PUANTURLERI+')
					) AS PivotTable
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI IN (SELECT ID_SINAVOGRENCI FROM SinavOgrenci WHERE ID_SINAV='+CAST(@ID_SINAV AS VARCHAR)+' AND TCKIMLIKNO=PivotTable.TCKIMLIKNO)
					INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
				) AS SourceTableDers


				SELECT ROW_NUMBER() OVER(ORDER BY OKUL,SINIF,ADSOYAD) AS SIRA, /*P.TCKIMLIKNO,*/ P.OKUL, P.SINIF, P.ADSOYAD, '+@DERSLERISIMLI+','+@DERSLERSUM+','+@PUANTURLERIISIM+'  FROM #TEMP T
				PIVOT
				(
				AVG(NET)
				FOR TAKMAAD IN ('+@DERSLER+')
				) AS P
				WHERE '+@PUANTURLERIWHERE+'

				DROP TABLE #TEMP
				'

				PRINT @SQL
				EXEC(@SQL)
			END
			ELSE
			BEGIN
				SELECT 1 
			END

			SELECT	S.AD AS SINAVADI
					,CONVERT(VARCHAR, S.SINAVTARIH, 104) AS SINAVTARIHI
					,@PUANTURLERIISIM+' Puan Türünde '+CAST(@LIMIT AS VARCHAR)+' Puan Barajını Aşamayan Öğrenciler' AS TITLE FROM Sinav S WHERE S.ID_SINAV=@ID_SINAV
		END

		IF @ISLEM = 4	--	Kurum Soru Analizi
		BEGIN
			SELECT SD.TAKMAAD, SA.SORUNO_A, SA.SORUNO, SA.CEVAP, SK.AD, CASE WHEN SSI.ID_SINAVSORUDUZENLE IS NULL THEN 0 ELSE 1 END AS HATALI, SDU.AD AS KAZANIM
			INTO #CEVAPLAR 
			FROM Sinav S
			INNER JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV
			INNER JOIN SinavDers SD ON SD.ID_SINAV=S.ID_SINAV
			INNER JOIN SinavAnahtar SA ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
			LEFT JOIN SinavSoruIslem SSI ON SSI.ID_SINAVANAHTAR=SA.ID_SINAVANAHTAR 
			LEFT JOIN v3SinavDersUnite SDU ON SDU.KOD=SA.KOD
			WHERE S.ID_SINAV=@ID_SINAV
			ORDER BY SD.BOLUMNO, SK.AD, SA.SORUNO_A

			DECLARE @SUBENO VARCHAR(3), @OKUL VARCHAR(MAX), @SINAVADI VARCHAR(MAX)
			SELECT @SUBENO=RIGHT('000' + SUBENO, 3), @OKUL=AD FROM OkyanusDB.dbo.v3Sube WHERE ID_SUBE=@ID_SUBE
			SELECT @SINAVADI=AD FROM Sinav WHERE ID_SINAV=@ID_SINAV

			SELECT	SD.BOLUMNO
					,SD.TAKMAAD
					,C.SORUNO_A AS SORU
					,C.CEVAP AS DC
					,SUM(CASE WHEN SOC.CEVAP='A' THEN 1 ELSE 0 END) AS A 
					,SUM(CASE WHEN SOC.CEVAP='B' THEN 1 ELSE 0 END) AS B
					,SUM(CASE WHEN SOC.CEVAP='C' THEN 1 ELSE 0 END) AS C
					,SUM(CASE WHEN SOC.CEVAP='D' THEN 1 ELSE 0 END) AS D
					,SUM(CASE WHEN SOC.CEVAP='E' THEN 1 ELSE 0 END) AS E
					,SUM(CASE WHEN SOC.CEVAP='' THEN 1 ELSE 0 END) AS BOS
					,SUM(CASE WHEN SOC.CEVAP IS NOT NULL THEN 1 ELSE 0 END) AS TOPLAM
					,C.HATALI
					,C.KAZANIM
			INTO #ANALIZ
			FROM Sinav S
			INNER JOIN SinavOgrenci SO ON SO.ID_SINAV=S.ID_SINAV
			INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN #CEVAPLAR C ON C.TAKMAAD=SD.TAKMAAD AND C.SORUNO=SOC.SORUNO AND C.AD=SO.KITAPCIK
			WHERE S.ID_SINAV=@ID_SINAV AND SO.SUBENO=@SUBENO
			GROUP BY  SD.BOLUMNO, SD.TAKMAAD, C.SORUNO_A, C.CEVAP, C.HATALI, C.KAZANIM

			SELECT BOLUMNO, TAKMAAD, SORU, DC, 
			CAST(A AS VARCHAR)+' - %'+CAST(CAST((CAST(A AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS A, 
			CAST(B AS VARCHAR)+' - %'+CAST(CAST((CAST(B AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS B, 
			CAST(C AS VARCHAR)+' - %'+CAST(CAST((CAST(C AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS C, 
			CAST(D AS VARCHAR)+' - %'+CAST(CAST((CAST(D AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS D, 
			CAST(E AS VARCHAR)+' - %'+CAST(CAST((CAST(E AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS E, 
			CAST(BOS AS VARCHAR)+' - %'+CAST(CAST((CAST(BOS AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS BOS, 
			HATALI, KAZANIM FROM #ANALIZ
			ORDER BY BOLUMNO, SORU

			SELECT @OKUL, @SINAVADI
			
			SELECT 
			(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO=@SUBENO) AS SUBE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL AND S2.ILCE=S.ILCE
																											WHERE S.ID_SUBE=@ID_SUBE)) AS ILCE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL
																											WHERE S.ID_SUBE=@ID_SUBE)) AS IL
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV) AS GENEL

			DROP TABLE IF EXISTS #CEVAPLAR
			DROP TABLE IF EXISTS #ANALIZ			
		END

		IF @ISLEM = 5	--	Net Ortalamaları
		BEGIN
			IF(@ID_SUBE=0)
			BEGIN
				SELECT SO.TCKIMLIKNO, SUM(SOCB.NET) AS TOPLAMNET, SO.SUBENO
				INTO #SINAVOGRENCINET
				FROM SinavOgrenci SO 
				INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				WHERE SO.ID_SINAV=@ID_SINAV
				GROUP BY SO.TCKIMLIKNO, SO.SUBENO

				SELECT SU.SUBENO, SU.AD, CAST(AVG(SON.TOPLAMNET) AS DECIMAL(5,2)) AS NET
				FROM #SINAVOGRENCINET SON
				INNER JOIN OkyanusDB.dbo.v3Sube SU ON RIGHT('000' + SU.SUBENO, 3) = SON.SUBENO
				GROUP BY SU.SUBENO, SU.AD
				ORDER BY CAST(SU.SUBENO AS INT)

				DROP TABLE #SINAVOGRENCINET
			END
			ELSE
			BEGIN
				SELECT SO.TCKIMLIKNO, SUM(SOCB.NET) AS TOPLAMNET, SO.SINIF
				INTO #SINAVOGRENCINET2
				FROM SinavOgrenci SO 
				INNER JOIN SinavOgrenciCevapBolum SOCB	ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN OkyanusDB.dbo.v3Sube		SB	ON RIGHT('000' + SB.SUBENO, 3) = SO.SUBENO AND SB.ID_SUBE = @ID_SUBE
				WHERE SO.ID_SINAV = @ID_SINAV --AND SO.SUBENO=(SELECT RIGHT('000' + SUBENO, 3) FROM OkyanusDB.dbo.v3Sube WHERE ID_SUBE = @ID_SUBE)
				GROUP BY SO.TCKIMLIKNO, SO.SINIF

				SELECT 1, SN.AD AS SINIF, CAST(AVG(SON.TOPLAMNET) AS DECIMAL(5,2)) AS NET
				FROM #SINAVOGRENCINET2 SON
				INNER JOIN OkyanusDB.dbo.v3Sinif SN ON SN.AD = SON.SINIF
				GROUP BY SN.AD
				ORDER BY SN.AD 

				DROP TABLE #SINAVOGRENCINET2
			END			
		END
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DersCalismaProgrami]    Script Date: 22.11.2021 10:43:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_DersCalismaProgrami]
	@TCKIMLIKNO			NVARCHAR(11)	    = NULL,
	@TC_OGRENCI			NVARCHAR(11)	    = '',
	@OTURUM				NVARCHAR(36)	    = NULL,
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					= NULL,
	@ID_KADEME3         INT                 = NULL,
	@ID_DERS            INT                 = NULL,
	@ID_DERSUNITE       INT                 = NULL,
	@AD                 NVARCHAR(250)       = NULL,
	@KOD                NVARCHAR(20)        = NULL,
	@DONEM              NVARCHAR(4)         = NULL,
	@LINKLIST           NVARCHAR(MAX)		= NULL,
	@SQLJSON            NVARCHAR(MAX)		= NULL,
	@JSON            NVARCHAR(MAX)		= NULL,
	@VERILIS_TARIHI     DATETIME            = NULL,
	@SAAT               NVARCHAR(MAX)       = NULL,
	@HEDEFSORU          NVARCHAR(MAX)       = NULL,
	@OGRTCKIMLIKNO		VARCHAR(11)		    = NULL,
	@ID_SINIF           INT                 = NULL,
	@ID_SUBE            INT                 = NULL,
	@ID_SUBELER		    VARCHAR(MAX)	    = NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	    = NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO			=	@TCKIMLIKNO		
			,TC_OGRENCI			=	@TC_OGRENCI		
			,OTURUM				=	@OTURUM			
			,ISLEM				=	@ISLEM			
			,ID_MENU			=	@ID_MENU		
			,ID_KADEME3         =	@ID_KADEME3    
			,ID_DERS            =	@ID_DERS       
			,ID_DERSUNITE       =	@ID_DERSUNITE  
			,AD                 =	@AD            
			,KOD                =	@KOD           
			,DONEM              =	@DONEM         
			,LINKLIST           =	@LINKLIST      
			,SQLJSON            =	@SQLJSON       
			,[JSON]				=	@JSON          
			,VERILIS_TARIHI     =	@VERILIS_TARIHI
			,SAAT               =	@SAAT          
			,HEDEFSORU          =	@HEDEFSORU     
			,OGRTCKIMLIKNO		=	@OGRTCKIMLIKNO	
			,ID_SINIF           =	@ID_SINIF      
			,ID_SUBE            =	@ID_SUBE       
			,ID_SUBELER		    =	@ID_SUBELER		
			,ID_SINIFLAR        =	@ID_SINIFLAR   
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY   
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	 

	IF @ID_LOG > 1
	BEGIN
	   DECLARE @AKTIFDONEM VARCHAR(4)= (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
	    IF @ISLEM = 1	--	Odev Ekle güncelle			
		BEGIN		
			
			--UPDATE OKYANUSDB.DBO.v3SinavDersUnite
			--SET AD= @AD--, KOD = @KOD
			--WHERE ID_DERSUNITE=@ID_DERSUNITE

			--SET @KOD = ( SELECT KOD FROM OKYANUSDB.DBO.v3SinavDersUnite WHERE ID_DERSUNITE = @ID_DERSUNITE )
			
			UPDATE OKYANUSDB.DBO.v3SinavDersUniteOdev SET
				AKTIF = 0 
			WHERE KOD = @KOD

			INSERT INTO  OKYANUSDB.DBO.v3SinavDersUniteOdev (KOD, ODEV, KYE_TCKIMLIKNO) 
			SELECT @KOD, ODEV, @TCKIMLIKNO FROM OPENJSON(@LINKLIST) WITH (ODEV VARCHAR(MAX))


		END
		IF @ISLEM = 2	--	Ders ünite listesi		
		BEGIN	

			SELECT ISNULL((
				SELECT	 D1.ID_DERS
						,D1.ID_DERSUNITE
						,D1.KOD
						,D1.AD
						,LINKLIST = ISNULL((SELECT ODEV
											FROM OKYANUSDB.DBO.v3SinavDersUniteOdev L
											WHERE	L.KOD	= D1.KOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"ODEV":""}]')
				FROM v3SinavDersUnite		D1
				inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
				WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
				ORDER BY d1.KOD
				FOR JSON PATH, INCLUDE_NULL_VALUES
			),'[]')


		END
		IF @ISLEM = 8	--	Ders ünite listesi		
		BEGIN	

			SELECT ISNULL((
				SELECT	 D1.ID_DERS
						,D1.ID_DERSUNITE
						,D1.KOD
						,D1.AD
						,LINKLIST = ISNULL((SELECT HEDEFSORU,TARIH,SAAT,KAZANIMKOD
											FROM DersCalismaProgram L
											WHERE	L.KAZANIMKOD	= D1.KOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"HEDEFSORU":""},{"TARIH":""},{"SAAT":""},{"KAZANIMKOD":""}]')
				FROM v3SinavDersUnite		D1
				inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
				WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
				ORDER BY d1.KOD
				FOR JSON PATH, INCLUDE_NULL_VALUES
			),'[]')


		END
		IF @ISLEM = 3	--	Kazanım Program Ekle			
		BEGIN		
			
			--UPDATE DersCalismaProgram SET
			--	AKTIF = 0 
			--WHERE KAZANIMKOD = @KOD  AND TCKIMLIKNO=@TC_OGRENCI


				--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,KYE_TARIH,TARIH,SAAT,HEDEFSORU) 
			 --   SELECT @KOD,@TCKIMLIKNO,@TC_OGRENCI,KYE_TARIH,TARIH,SAAT,HEDEFSORU FROM OPENJSON(@LINKLIST) WITH (KYE_TARIH VARCHAR(MAX),TARIH VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX))

				INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			    SELECT @KOD,@TCKIMLIKNO, @TC_OGRENCI,VERILIS_TARIHI ,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) 




			--IF EXISTS(select * from DersCalismaProgram  d 
			--INNER JOIN
   --        OPENJSON(@LINKLIST) WITH(KAZANIMKOD VARCHAR(MAX),TARIH VARCHAR(MAX),KYE_TARIH VARCHAR(MAX)) j on j.KAZANIMKOD=D.KAZANIMKOD
			--where D.KAZANIMKOD=@KOD AND AKTIF=1 AND TCKIMLIKNO=@TC_OGRENCI AND D.KAZANIMKOD=j.KAZANIMKOD AND j.KYE_TARIH=D.KYE_TARIH AND j.TARIH=D.TARIH)
			--UPDATE D  SET
			--	AKTIF = 0
			--	from openjson(@LINKLIST)
			--	WITH (TARIH NVARCHAR(MAX),KAZANIMKOD NVARCHAR(MAX),KYE_TARIH NVARCHAR(MAX)) as json
			--	inner join DersCalismaProgram as D 
			--	on D.KAZANIMKOD= json.KAZANIMKOD
			--    WHERE D.KAZANIMKOD = @KOD  AND D.TARIH=json.TARIH AND D.KYE_TARIH=json.KYE_TARIH
   --         ELSE
			


			


			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO, @TC_OGRENCI,VERILIS_TARIHI ,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) 

			--"KYE_TARIH\":\"2019-11-21\",\"KAZANIMKOD\":\"İNK809001001\",\"TARIH\":\"2019-10-31\",\"SAAT\":\"9:30\",\"HEDEFSORU\":\"BRC\"}
			--UPDATE DersCalismaProgram SET
			--	AKTIF = 0 
			--WHERE KAZANIMKOD = @KOD

			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO,@TC_OGRENCI,VERILIS_TARIHI,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX))


		END
		IF @ISLEM = 9	--	Kazanım Program Sil			
		BEGIN		
			
			UPDATE DersCalismaProgram SET
				AKTIF = 0 
			WHERE KAZANIMKOD = @KOD  AND TCKIMLIKNO=@TC_OGRENCI


			IF EXISTS(select TOP 1 1 from DersCalismaProgram  d 
			INNER JOIN
           OPENJSON(@LINKLIST) WITH(KAZANIMKOD VARCHAR(MAX),TARIH VARCHAR(MAX),KYE_TARIH VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) j on j.KAZANIMKOD=D.KAZANIMKOD
			where D.KAZANIMKOD=@KOD AND AKTIF=0 AND TCKIMLIKNO=@TC_OGRENCI AND D.KAZANIMKOD=j.KAZANIMKOD AND j.KYE_TARIH=D.KYE_TARIH AND j.TARIH=D.TARIH AND D.HEDEFSORU=j.HEDEFSORU)
			UPDATE D  SET
				AKTIF = 1
				from openjson(@LINKLIST)
				WITH (TARIH NVARCHAR(MAX),KAZANIMKOD NVARCHAR(MAX),KYE_TARIH NVARCHAR(MAX),HEDEFSORU NVARCHAR(MAX)) as json
				inner join DersCalismaProgram as D 
				on D.KAZANIMKOD= json.KAZANIMKOD
			    WHERE D.KAZANIMKOD = @KOD  AND D.TARIH=json.TARIH AND D.KYE_TARIH=json.KYE_TARIH AND D.HEDEFSORU=json.HEDEFSORU
            
			 


			


			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO, @TC_OGRENCI,VERILIS_TARIHI ,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) 

			--"KYE_TARIH\":\"2019-11-21\",\"KAZANIMKOD\":\"İNK809001001\",\"TARIH\":\"2019-10-31\",\"SAAT\":\"9:30\",\"HEDEFSORU\":\"BRC\"}
			--UPDATE DersCalismaProgram SET
			--	AKTIF = 0 
			--WHERE KAZANIMKOD = @KOD

			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO,@TC_OGRENCI,VERILIS_TARIHI,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX))


		END
		IF @ISLEM = 4	--	ÖĞRENCİ KAZANIM LİSTELE YENİ			
		BEGIN
			DECLARE @ID_KADEME3_OGR INT

			SELECT @ID_KADEME3_OGR = ST.ID_KADEME3 
			FROM OkyanusDB.dbo.v3Ogrenci O
			JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
			WHERE O.TCKIMLIKNO = @OGRTCKIMLIKNO

			SELECT  SO.ID_SINAV
				,SD.TAKMAAD AS [DERS.AD]
				,SOCB.DOGRU AS [DERS.DOGRU]
				,SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS [DERS.SORU]
				,CASE WHEN SDU.AD IS NULL THEN CONVERT(VARCHAR(MAX),SA.KOD) ELSE SDU.AD END AS [DERS.UNITE.AD]
				,SA.KOD  AS [DERS.UNITE.KOD]
				,SUM(case SOC.DURUM when 'D' then 1 else 0 end) as [DERS.UNITE.DOGRU]
				,SUM(case SOC.DURUM when 'Y' then 1 else 0 end) as [DERS.UNITE.YANLIS]
				,SUM(case SOC.DURUM when 'B' then 1 else 0 end) as [DERS.UNITE.BOS]
				,COUNT(1) as [DERS.UNITE.SORU]
			INTO #TEMP1X
			FROM SinavOgrenci SO WITH(NOLOCK)
			INNER JOIN SinavOgrenciCevapBolum SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC WITH(NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
			INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN SinavAnahtar SA  WITH(NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
			INNER JOIN v3SinavDersUnite SDU WITH(NOLOCK) on SDU.KOD=SA.KOD
			INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
			WHERE SO.TCKIMLIKNO=@OGRTCKIMLIKNO AND S.AKTIF=1 AND S.OZEL = 0 AND ((@ID_KADEME3_OGR < 15 AND S.DONEM = @AKTIFDONEM) OR @ID_KADEME3_OGR >= 15) -- LİSE DEĞİLSE SADECE MEVCUT DÖNEM
			GROUP BY SO.ID_SINAV, SD.TAKMAAD, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SDU.AD, SA.KOD			

			SELECT
			(
				SELECT	DERSAD = [DERS.AD],
						DERSYUZDE = CONVERT(DECIMAL(5,2),CONVERT(DECIMAL(18,2),SUM([DERS.DOGRU]))/CONVERT(DECIMAL(18,2),SUM([DERS.SORU]))*100.0),
						UNITELER = (
							SELECT	UNITEAD = SUBT.[DERS.UNITE.AD], 
									TD = SUM(SUBT.[DERS.UNITE.DOGRU]), 
									TY = SUM(SUBT.[DERS.UNITE.YANLIS]), 
									TB = SUM(SUBT.[DERS.UNITE.BOS]),									
									LINKLIST = ISNULL((SELECT KYE_TARIH,KAZANIMKOD,TARIH,SAAT,HEDEFSORU
														FROM DersCalismaProgram L
														WHERE	L.KAZANIMKOD	= SUBT.[DERS.UNITE.KOD]
															    AND L.AKTIF = 1
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									MORPAKAZANIMLIST = ISNULL((SELECT MK.KOD
														FROM MorpaKazanim MK
														JOIN MorpaDers MD ON MD.ID_MORPADERS = MK.ID_MORPADERS AND MD.AKTIF = 1
														WHERE	MK.KOD_OKY	= SUBT.[DERS.UNITE.KOD]
															AND MK.AKTIF = 1
															AND MD.ID_KADEME3 = @ID_KADEME3_OGR
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									[UNITEYUZDE] = CONVERT(DECIMAL(5,2), SUM(SUBT.[DERS.UNITE.DOGRU]) / CONVERT(DECIMAL(5,2),SUM(SUBT.[DERS.UNITE.SORU]))) * 100,
									UNITEKOD= SUBT.[DERS.UNITE.KOD],						
								   [CALISMASAYISI]= (SELECT COUNT(DISTINCT KYE_TARIH) FROM [Pusulam].[dbo].[DersCalismaProgram] D Where D.TCKIMLIKNO=@OGRTCKIMLIKNO AND D.KAZANIMKOD= SUBT.[DERS.UNITE.KOD] AND D.AKTIF=1)
								  
							FROM #TEMP1X SUBT 
							WHERE SUBT.[DERS.AD] = T.[DERS.AD]
							GROUP BY SUBT.[DERS.AD], SUBT.[DERS.UNITE.KOD], SUBT.[DERS.UNITE.AD]
							ORDER BY UNITEYUZDE DESC
							FOR JSON PATH
						) 
				FROM #TEMP1X T
				GROUP BY [DERS.AD]
				ORDER BY DERSYUZDE DESC
				FOR JSON PATH
			) AS J

			DROP TABLE #TEMP1X
		END
		IF @ISLEM = 5	--	Ders ünite Program Listesi
		BEGIN
		SET LANGUAGE Turkish;
	SELECT
				(
					SELECT	GS.SUBEAD
							,GS.SINIF
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT VD.AD,S.HedefSoru,convert(varchar, S.TARIH, 6) as TARIH,S.SAAT,D.DERSAD
								,LINKLIST = ISNULL((SELECT ODEV
											FROM OKYANUSDB.DBO.v3SinavDersUniteOdev L
											WHERE	L.KOD	= S.KAZANIMKOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"ODEV":""}]')
								,YAKLASANODEVLIST = ISNULL (( SELECT BASLIK,O.TESLIM_TARIHI,DS.DERSAD
								                FROM OdevSinifOgrenci OSO WITH(NOLOCK)
												INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
					                            INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
												INNER JOIN eokul_v2.dbo.Ders DS WITH(NOLOCK) ON DS.ID_DERS = O.ID_DERS
					                            INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
												Where OSO.TCKIMLIKNO=@OGRTCKIMLIKNO 
												AND O.TESLIM_TARIHI=convert(varchar, getdate()+1, 23)
												
												FOR JSON PATH, INCLUDE_NULL_VALUES
												),'[{"ODEV":""}]')
								FROM DersCalismaProgram S INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD ON S.KAZANIMKOD=VD.KOD
								INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.TCKIMLIKNO AND S.KAZANIMKOD= VD.KOD
								INNER JOIN eokul_v2.[dbo].[Ders] D     ON D.ID_DERS=VD.ID_DERS
								--LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
								WHERE S.TCKIMLIKNO = @OGRTCKIMLIKNO AND  S.AKTIF=1 
								--GROUP BY S.TARIH
								ORDER BY TARIH 
								FOR JSON PATH
							 ) AS PROGRAMLIST
							
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO 
					INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS ON GS.ID_SINIF = O.ID_SINIF 
					WHERE 
					--O.ID_SINIF = @ID_SINIF  
					O.ID_SINIF=(Select (ID_SINIF ) FROM v3OgrenciTum OT INNER JOIN  Pusulam.dbo.v3AktifDonem AD	ON AD.DONEM	= OT.DONEM  Where TCKIMLIKNO=@OGRTCKIMLIKNO AND AD.AKTIF=1)
					AND K.TCKIMLIKNO=@OGRTCKIMLIKNO 
					--AND O.ID_SUBE=@ID_SUBE
					AND  O.ID_SUBE=(Select (ID_SUBE ) FROM v3OgrenciTum OT INNER JOIN  Pusulam.dbo.v3AktifDonem AD	ON AD.DONEM	= OT.DONEM  Where TCKIMLIKNO=@OGRTCKIMLIKNO AND AD.AKTIF=1)
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
		 END
		IF @ISLEM = 6   --  Ders Program Öğrenci Rapor
			BEGIN
				SELECT distinct 
					 D.SUBEAD
					,D.SINIF
					,K.AD
					,K.SOYAD
					,PROGRAMSAYISI = (SELECT COUNT(DISTINCT KYE_TARIH) FROM  DersCalismaProgram S where  S.TCKIMLIKNO=K.TCKIMLIKNO AND S.AKTIF=1) 
					,KAZANIMSAYISI = (SELECT COUNT(DISTINCT S.KAZANIMKOD) FROM  DersCalismaProgram S where  S.TCKIMLIKNO=K.TCKIMLIKNO AND S.AKTIF=1) 
				    ,D.ID_SUBE
					,D.ID_SINIF
				FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				INNER JOIN DersCalismaProgram                           P   ON P.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE=@ID_SUBE)) 
				--AND ( ( D.ID_SINIF=@ID_SINIF))  
				AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				
				ORDER BY  D.SUBEAD ASC,D.SINIF ASC, AD ASC 
				--,tarih DESC
			END
		IF @ISLEM = 7   --  Ders Program Öğretmen Rapor
			BEGIN
				SELECT distinct 
					 D.SUBEAD
					,D.SINIF
					,K.AD
					,K.SOYAD
					,OGRPROGRAMSAYISI = (SELECT COUNT(DISTINCT S.TCKIMLIKNO) FROM  DersCalismaProgram S where  S.KYE_TCKIMLIKNO=K.TCKIMLIKNO) 
					,TOPLAMPROGRAMSAYISI = (SELECT COUNT(1) FROM  DersCalismaProgram S where  S.KYE_TCKIMLIKNO=K.TCKIMLIKNO) 
				    ,D.ID_SUBE
					,D.ID_SINIF
				FROM  OkyanusDB.dbo.v3KullaniciSinif					    S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	    = D.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		    = d.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	    = S.TCKIMLIKNO 
				INNER JOIN DersCalismaProgram                           P   ON P.KYE_TCKIMLIKNO = K.TCKIMLIKNO								
				WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE=@ID_SUBE)) 
				--AND ( ( D.ID_SINIF=@ID_SINIF))  
				AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				ORDER BY  D.SUBEAD ASC,D.SINIF ASC, AD ASC 
				--,tarih DESC
			END
     

	END
END TRY
BEGIN CATCH	
	DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DersUnite]    Script Date: 22.11.2021 10:44:12 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_DersUnite]
	@TCKIMLIKNO			NVARCHAR(11)	    = NULL,
	@TC_OGRENCI			NVARCHAR(11)	    = '',
	@OTURUM				NVARCHAR(36)	    = NULL,
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					= NULL,
	@ID_KADEME3         INT                 = NULL,
	@ID_DERS            INT                 = NULL,
	@ID_DERSUNITE       INT                 = NULL,
	@ID_KAZANIMDOSYA	INT                 = NULL,
	@AD                 NVARCHAR(250)       = NULL,
	@KOD                NVARCHAR(20)        = NULL,
	@DONEM              NVARCHAR(4)         = NULL,
	@LINKLIST           NVARCHAR(MAX)		= NULL,
	@SQLJSON            NVARCHAR(MAX)		= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP

	IF @ID_LOG > 1
	BEGIN
	    IF @ISLEM = 1	--	Sınav Ders Liste		
		BEGIN					
			SELECT d.ID_DERS, d.AD FROM [dbo].[v3SinavDers] d where d.ID_KADEME3=@ID_KADEME3 
	    END
		IF @ISLEM = 2	--	Ders ünite listesi		
		BEGIN	

			SELECT ISNULL((
				SELECT	 D1.ID_DERS
						,D1.ID_DERSUNITE
						,D1.KOD
						,D1.AD
						,LINKLIST = ISNULL((SELECT LINK
											FROM OKYANUSDB.DBO.v3SinavDersUniteLink L
											WHERE	L.KOD	= D1.KOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"LINK":""}]')
						,DOSYASAYISI = (SELECT COUNT(1) FROM KazanimDosya KD WHERE KD.KOD = D1.KOD AND KD.AKTIF = 1)
				FROM v3SinavDersUnite		D1
				inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
				WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
				ORDER BY d1.KOD
				FOR JSON PATH, INCLUDE_NULL_VALUES
			),'[]')


		END
		IF @ISLEM = 3	--	unite silme				
		BEGIN		
			
			IF EXISTS (select TOP 1 1 from OKYANUSDB.DBO.v3SinavDersUnite U JOIN SinavAnahtar SA ON SA.KOD=U.KOD where ID_DERSUNITE=@ID_DERSUNITE)
			BEGIN
				RAISERROR ('Daha önce bir sınavda kullanıldığı için silinemez' , -- Message text.
				16, -- Severity.
				1-- State.
				);
			END
			ELSE
			BEGIN
				DELETE OKYANUSDB.DBO.v3SinavDersUnite
				WHERE ID_DERSUNITE=@ID_DERSUNITE			
			END



			--Update OKYANUSDB.DBO.v3SinavDersUnite SET AKTIF=0  where  ID_DERSUNITE=@ID_DERSUNITE AND 
		END
	    IF @ISLEM = 4	--	unite detay				
		BEGIN		
			select * from OKYANUSDB.DBO.v3SinavDersUnite where ID_DERSUNITE=@ID_DERSUNITE
		END
	    IF @ISLEM = 5	--	unite güncelle			
		BEGIN		
			
			UPDATE OKYANUSDB.DBO.v3SinavDersUnite
			SET AD= @AD--, KOD = @KOD
			WHERE ID_DERSUNITE=@ID_DERSUNITE

			SET @KOD = ( SELECT KOD FROM OKYANUSDB.DBO.v3SinavDersUnite WHERE ID_DERSUNITE = @ID_DERSUNITE )
			
			UPDATE OKYANUSDB.DBO.v3SinavDersUniteLink SET
				AKTIF = 0 
			WHERE KOD = @KOD

			INSERT INTO  OKYANUSDB.DBO.v3SinavDersUniteLink (KOD, LINK, KYE_TCKIMLIKNO) 
			SELECT @KOD, LINK, @TCKIMLIKNO FROM OPENJSON(@LINKLIST) WITH (LINK VARCHAR(MAX))


		END
		IF @ISLEM = 6	--	unite ekle				
		BEGIN
			
			IF EXISTS (select TOP 1 1 from OKYANUSDB.DBO.v3SinavDersUnite  where KOD=@KOD)
			BEGIN
				RAISERROR ('Bu kod daha önce eklenmiştir.' , -- Message text.
				16, -- Severity.
				1-- State.
				);
			END
			ELSE
			BEGIN
				INSERT INTO  OKYANUSDB.DBO.v3SinavDersUnite (ID_DERS, KOD, AD) values (@ID_DERS, @KOD, @AD)		

				UPDATE OKYANUSDB.DBO.v3SinavDersUniteLink SET
					AKTIF = 0 
				WHERE KOD = @KOD

				INSERT INTO  OKYANUSDB.DBO.v3SinavDersUniteLink (KOD, LINK, KYE_TCKIMLIKNO) 
				SELECT @KOD, LINK, @TCKIMLIKNO FROM OPENJSON(@LINKLIST) WITH (LINK VARCHAR(MAX))

			END

		END
		IF @ISLEM = 7	--	Genel Ders Liste		
		BEGIN
		
			IF EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM=@DONEM)
			BEGIN
				DECLARE @SIRA INT=	(SELECT SIRA FROM v3Kademe3 WHERE ID_KADEME3 =  @ID_KADEME3 )
				SET @ID_KADEME3 =	(SELECT ID_KADEME3 FROM v3Kademe3 WHERE SIRA=@SIRA  - (CAST((SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEM AS INT)))
			END
			

			IF @ID_KADEME3 IS NULL OR @ID_KADEME3=0
			BEGIN
				SELECT ID_KADEME3 INTO #KADEME3 FROM v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO
				
					SELECT SD.ID_DERS, SD.AD 
					FROM v3SinavDers				SD
					INNER JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = SD.ID_DERS
					WHERE	SD.ID_KADEME3 IN (SELECT ID_KADEME3 FROM #KADEME3)		
						AND D.AKTIF = 1 
						AND D.SNVDERS = 1
				UNION 
					SELECT D.ID_DERS,D.DERSAD 
					FROM eokul_v2.dbo.Ders			 D
					JOIN eokul_v2.dbo.DersEgitimTuru E ON E.ID_DERS = D.ID_DERS
					WHERE E.ID_EGITIMTURU = 6 -- YAZILI
						AND D.AKTIF =1 
						AND D.SNVDERS = 1
						AND d.ID_KADEME3 IN (SELECT ID_KADEME3 FROM #KADEME3)	
				ORDER BY AD					
			END
			ELSE
			BEGIN
					SELECT SD.ID_DERS, SD.AD 
					FROM v3SinavDers				SD
					INNER JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = SD.ID_DERS	
					where d.ID_KADEME3 = @ID_KADEME3 
						AND D.AKTIF = 1 
						AND D.SNVDERS = 1
				UNION
					SELECT D.ID_DERS,D.DERSAD 
					FROM eokul_v2.dbo.Ders			 D
					JOIN eokul_v2.dbo.DersEgitimTuru E ON E.ID_DERS = D.ID_DERS
					WHERE E.ID_EGITIMTURU = 6 -- YAZILI
						AND D.AKTIF =1 
						AND d.ID_KADEME3 = @ID_KADEME3
						AND D.SNVDERS = 1
				ORDER BY AD
			END
			
			DROP TABLE IF EXISTS #KADEME3	
		END
		IF @ISLEM = 8	--	UNITE EKLE EXCEL		
		BEGIN
			DROP TABLE IF EXISTS #JSEXEL
			DROP TABLE IF EXISTS #UNITE_VAR
			DROP TABLE IF EXISTS #UNITE_YOK

			SELECT KOD,AD	INTO #JSEXEL	FROM OPENJSON(@SQLJSON) WITH(KOD VARCHAR(MAX), AD VARCHAR(MAX)) JS 			
			SELECT JS.*		INTO #UNITE_VAR FROM OKYANUSDB.DBO.v3SinavDersUnite DU JOIN #JSEXEL JS ON JS.KOD = DU.KOD
			SELECT *		INTO #UNITE_YOK FROM #JSEXEL JS where JS.KOD NOT IN (SELECT DISTINCT V.KOD FROM #UNITE_VAR V)

			IF EXISTS (SELECT TOP 1 1 FROM #UNITE_YOK)
			BEGIN

				INSERT INTO OkyanusDB.dbo.v3SinavDersUnite (ID_DERS,KOD,AD,AKTIF)
				SELECT @ID_DERS, KOD, AD, 1 FROM #UNITE_YOK
					
			END

			IF EXISTS (SELECT TOP 1 1 FROM #UNITE_VAR)
			BEGIN

				UPDATE U SET
					U.AD = V.AD
				FROM OkyanusDB.dbo.v3SinavDersUnite U
				JOIN #UNITE_VAR V ON V.KOD = U.KOD

				--DECLARE @EKLENECEKLER INT = (SELECT COUNT(1) FROM #UNITE_YOK)
				--DECLARE @HATAMETNI VARCHAR(MAX) = 'Excel tablosundaki kodların tümü daha önce eklendiği için işlem yapılmamıştır.'
				--IF @EKLENECEKLER > 0
				--BEGIN
				--	SET @HATAMETNI = CAST(@EKLENECEKLER AS varchar)+' Adet ünite eklenmiştir. Aşağıdaki kodlar daha önce eklendiği için işlem yapılmamıştır.<br><br>'+(SELECT (SELECT STUFF((SELECT   '<br>' +CAST(K.KOD AS VARCHAR)	FROM #UNITE_VAR K ORDER BY KOD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')))
				--END
								
				----SELECT @HATAMETNI
				--RAISERROR (@HATAMETNI , -- Message text.
				--16, -- Severity.
				--1-- State.
				--);
			END
			
			

			
			DROP TABLE IF EXISTS #JSEXEL
			DROP TABLE IF EXISTS #UNITE_VAR
			DROP TABLE IF EXISTS #UNITE_YOK
		END
		IF @ISLEM = 9	--	Derse ait Uniteleri Sil	
		BEGIN

				DELETE FROM OKYANUSDB.DBO.v3SinavDersUnite
				WHERE KOD NOT IN (
					select SA.KOD 
					from SinavAnahtar SA
				) AND ID_DERS = @ID_DERS

			SELECT 1

		END
	    IF @ISLEM = 10	--	YAZILI Ders Liste		
		BEGIN	
			SELECT d.ID_DERS, ED.DERSAD AD 
			FROM [dbo].[v3SinavDers] d
			JOIN eokul_v2.dbo.Ders	ED ON ED.ID_DERS = d.ID_DERS
			where d.ID_KADEME3=@ID_KADEME3 			
				AND ED.AKTIF =1 
				AND ED.SNVDERS = 1
			UNION 
			SELECT D.ID_DERS,D.DERSAD 
			FROM eokul_v2.dbo.Ders			 D
			JOIN eokul_v2.dbo.DersEgitimTuru E ON E.ID_DERS = D.ID_DERS
			WHERE E.ID_EGITIMTURU = 6 -- YAZILI
				AND D.AKTIF =1 
				AND d.ID_KADEME3=@ID_KADEME3 
				AND D.SNVDERS = 1
			ORDER BY AD
	    END
	    IF @ISLEM = 11	--	Sınav Ders Liste		
		BEGIN
			SELECT	DISTINCT DAK.ID_DERS
					,[Sınıf Düzeyi]		= K.AD 
					,[Ders Adı]			= D.AD

					,[Ünite Kodu]		= DU.KOD	
					,[Ünite Adı]		= DU.AD 
					
					,[Konu Kodu]		= DK.KOD	
					,[Konu Adı]			= DK.AD 
					
					,[Alt Konu Kodu]	= DAK.KOD	
					,[Alt Konu Adı]		= DAK.AD 

			FROM v3SinavDersUnite		DAK
			inner join v3SinavDers		SD  ON SD.ID_DERS	= DAK.ID_DERS
			inner join v3Ders			D	ON D.ID_DERS	= DAK.ID_DERS
			inner join v3Kademe3		K	ON K.ID_KADEME3 = SD.ID_KADEME3

			INNER JOIN v3SinavDersUnite DU	ON	DU.KOD		= SUBSTRING(DAK.KOD,1,6)
			INNER JOIN v3SinavDersUnite DK	ON	DK.KOD		= SUBSTRING(DAK.KOD,1,9)

			WHERE SD.ID_KADEME3=@ID_KADEME3 AND  DAK.ID_DERS = @ID_DERS AND DAK.AKTIF=1 AND LEN(DAK.KOD) = 12
			ORDER BY DAK.KOD
	    END
		IF @ISLEM = 12	--	UNITE LINK EXCEL		
		BEGIN
			DROP TABLE IF EXISTS #JSEXEL12

			SELECT KOD, LINK
			INTO #JSEXEL12	
			FROM OPENJSON(@SQLJSON) 
			WITH(KOD VARCHAR(MAX), LINK VARCHAR(MAX)) 
					
			UPDATE L SET
				L.AKTIF = 0 
			FROM OkyanusDB.DBO.v3SinavDersUniteLink L
			JOIN OkyanusDB.DBO.v3SinavDersUnite		U	ON	U.KOD	= L.KOD
			JOIN #JSEXEL12							J	ON	J.KOD	= U.KOD			
			WHERE U.ID_DERS	= @ID_DERS

			INSERT INTO OkyanusDB.DBO.v3SinavDersUniteLink (KOD, LINK, KYE_TCKIMLIKNO)
			SELECT J.KOD, LINK, @TCKIMLIKNO 
			FROM #JSEXEL12						J			
			JOIN OkyanusDB.DBO.v3SinavDersUnite	U	ON	U.KOD	= J.KOD	
			WHERE U.ID_DERS	= @ID_DERS

			
			DROP TABLE IF EXISTS #JSEXEL12
		END
		IF @ISLEM = 13	--	UNITE DOSYA LISTE		
		BEGIN

			SELECT ISNULL((
				SELECT ID_KAZANIMDOSYA, KOD, GUID
				FROM KazanimDosya
				WHERE	KOD		= @KOD
					AND AKTIF	= 1
				FOR JSON PATH
			),'[]')

		END
		IF @ISLEM = 14	--	UNITE DOSYA PASIF		
		BEGIN

			UPDATE KazanimDosya SET
				AKTIF = 0 
			WHERE ID_KAZANIMDOSYA = @ID_KAZANIMDOSYA

		END
		IF @ISLEM = 15	--	UNITE DOSYA EKLE		
		BEGIN

			DECLARE @GUID_DOSYA VARCHAR(36) = NEWID()
			DECLARE @TABLEADD15 TABLE (ID_KAZANIMDOSYA INT)
			
			WHILE EXISTS(SELECT TOP 1 1 FROM KazanimDosya D WHERE D.GUID = @GUID_DOSYA)
			BEGIN
				SET @GUID_DOSYA = NEWID()
			END

			INSERT INTO KazanimDosya (KOD, GUID, KYE_TCKIMLIKNO)
			OUTPUT inserted.ID_KAZANIMDOSYA INTO @TABLEADD15(ID_KAZANIMDOSYA)
			VALUES (@KOD, @GUID_DOSYA, @TCKIMLIKNO)

			SELECT	 GUID				= @GUID_DOSYA
					,ID_KAZANIMDOSYA	= (SELECT TOP 1 ID_KAZANIMDOSYA FROM @TABLEADD15)
			FOR JSON PATH


		END
	END
END TRY
BEGIN CATCH	
	DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DisOgrenci]    Script Date: 22.11.2021 10:44:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Gökhan Kahraman>
-- Create date: <24-12-2020>
-- Description:	<dbo.DisOgrenci>
-- =============================================
ALTER PROCEDURE [dbo].[sp_DisOgrenci] 
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					=NULL,
	@SQLJSON			varchar(MAX)		='',
	@ID_SINAV			INT					=NULL,
	@TCKIMLIKNO			VARCHAR(11)			=NULL,
	@OTURUM				VARCHAR(36)			= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
SET NOCOUNT ON;
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM				=	@ISLEM		
			,ID_MENU			=	@ID_MENU	
			,SQLJSON			=	@SQLJSON	
			,ID_SINAV			=	@ID_SINAV	
			,TCKIMLIKNO			=	@TCKIMLIKNO	
			,OTURUM				=	@OTURUM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY

		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM=1 --DisOgrenci Listele
			BEGIN

			SELECT 
				DO.ID_DIS_OGRENCI
				,DO.TCKIMLIKNO
				,DO.AD
				,DO.SOYAD
				,DO.ID_KADEME3
				,K.AD
				,DO.DONEM
				,D.ACIKLAMA AS DONEM_ACIKLAMA
				,DO.EPOSTA
				,DO.VELI_AD_SOYAD
				,DO.SIFRE
				,DO.KYE_TCKIMLIKNO
				,DO.AKTIF  
				FROM DisOgrenci AS DO
		 JOIN OkyanusDB.dbo.v3AktifDonem AS D ON DO.DONEM=D.DONEM
		 JOIN OkyanusDB.dbo.v3Kademe3 AS K ON DO.ID_KADEME3=K.ID_KADEME3 FOR JSON AUTO			
			END

		IF @ISLEM=2 -- DisOgrenci EXCEL YUKLE
			BEGIN
				DECLARE @SINAV_GRUP INT=0
				DECLARE @SINAV_DONEM INT=0
				DECLARE @AKTIF_DONEM INT=(SELECT OkyanusDB.dbo.fn_AktifDonem())

				--Dışarıdan gelen SınavID ye göre Dönem ve Sınıf bilgisi bulunuyor ve değişkenlere atılıyor
				SELECT TOP 1 @SINAV_DONEM = DONEM
							,@SINAV_GRUP = ID_KADEME3 
				FROM Sinav 
				where ID_SINAV =  @ID_SINAV
				
			--JSON kontrolü
			If (ISJSON(@SQLJSON)=1)
				BEGIN
						 --TempTable Json ile dolduruluyor			
						SELECT TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBENO
						INTO #TMP_DisOgrenci
						FROM OPENJSON(@SQLJSON)
						WITH(TCKIMLIKNO VARCHAR(11),AD VARCHAR(200),SOYAD VARCHAR(200),ID_KADEME3 INT,DONEM INT,EPOSTA NVARCHAR(320),VELI_AD_SOYAD VARCHAR(300),KYE_TCKIMLIKNO VARCHAR(11),SUBENO INT)

						IF (SELECT COUNT(1) FROM #TMP_DisOgrenci)>0
						BEGIN
						

						SELECT TCORJ = K.TCKIMLIKNO, TCYENI = CONVERT(varchar(11),CONVERT(bigint, K.TCKIMLIKNO) + 1 )
						INTO #KUL
						FROM v3Kullanici K 
						JOIN v3SubeYetki SY ON K.TCKIMLIKNO = SY.TCKIMLIKNO

						--Öğrenci DisOgrenci tablsounda varsa DONEM ve ID_KADEME si sınava göre Update ediliyor
						UPDATE DisOgrenci SET DONEM=@SINAV_DONEM,ID_KADEME3=@SINAV_GRUP 
							   WHERE TCKIMLIKNO=@TCKIMLIKNO 
							   AND
							   EXISTS (SELECT TOP 1 1 FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)

						--TC kimlik numarası ve Aktif durum kontrolüne göre daha önce eklenmemiş ise ve AktifÖğrenci tablosunda yok ise DisOgrenci tablosuna yazılıyor
						INSERT INTO DisOgrenci (TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBE_NO)
						SELECT TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBENO
						FROM #TMP_DisOgrenci T
						WHERE	NOT EXISTS (SELECT TOP 1 1 FROM DisOgrenci D WHERE D.TCKIMLIKNO = T.TCKIMLIKNO AND AKTIF=1)
								AND NOT EXISTS(SELECT TOP 1 1 FROM v3Ogrenci O WHERE O.TCKIMLIKNO=(CONVERT(bigint,T.TCKIMLIKNO)-1))

						INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
						SELECT DISTINCT @ID_SINAV AS ID_SINAV, K.TCORJ, @TCKIMLIKNO
						FROM OPENJSON(@SQLJSON) WITH (TCKIMLIKNO VARCHAR(MAX)) J
						JOIN #KUL	K	ON	K.TCYENI = J.TCKIMLIKNO
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci O WHERE O.TCKIMLIKNO = K.TCORJ AND O.AKTIF = 1 AND O.ID_SINAV = @ID_SINAV)

						INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
						SELECT DISTINCT @ID_SINAV AS ID_SINAV, J.TCKIMLIKNO , @TCKIMLIKNO 
						FROM OPENJSON(@SQLJSON) WITH (TCKIMLIKNO VARCHAR(MAX)) J
						WHERE 	NOT EXISTS (SELECT TOP 1 1 
											FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK)
											WHERE	OS.AKTIF		= 1 
												AND OS.ID_SINAV		= @ID_SINAV 
												AND OS.TCKIMLIKNO	= J.TCKIMLIKNO 											
											)
							AND NOT EXISTS (SELECT TOP 1 1 
												FROM #KUL K
												WHERE	K.TCYENI		= J.TCKIMLIKNO
													--OR	K.TCYENI	= OS.TCKIMLIKNO
												)
					
					
						--CREATE TABLE #TMP_KurumIci(TCKIMLIKNO VARCHAR(50),AD VARCHAR(200),SOYAD VARCHAR(200))
						--INSERT INTO #TMP_KurumIci (TCKIMLIKNO,AD,SOYAD)
						--SELECT TCKIMLIKNO,AD,SOYAD
						--FROM OPENJSON(@SQLJSON) 
						--WITH(
						--	 TCKIMLIKNO	VARCHAR(11)
						--	,AD			VARCHAR(200)
						--	,SOYAD		VARCHAR(200)
						--) AS J

						--SELECT ISNULL((
						--	SELECT TCKIMLIKNO,AD,SOYAD FROM #TMP_KurumIci
						--	FOR JSON AUTO, INCLUDE_NULL_VALUES
						--),'[]')					
					
					END
					--Temp table siliniyor
					DROP TABLE #TMP_DisOgrenci;
				END
			END

		END

	END TRY

	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH
 
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Dokuman]    Script Date: 22.11.2021 10:45:14 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Dokuman]
	@TCKIMLIKNO			VARCHAR(11)			= NULL,
	@OTURUM				VARCHAR(36)			= NULL,
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					= NULL,
	@ID_DOKUMAN			INT					= NULL,
	@ID_DOKUMANTUR		INT					= NULL,
	@ID					INT					= NULL,--İlişkili tablonun birincil anahtarı (etkinlik, mesaj...)
	@DOSYAAD			VARCHAR(250)		= NULL,
	@DOSYAUZANTI		VARCHAR(5)			= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT 
			TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ISLEM				= @ISLEM			
			,ID_MENU			= @ID_MENU		
			,ID_DOKUMAN			= @ID_DOKUMAN		
			,ID_DOKUMANTUR		= @ID_DOKUMANTUR	
			,ID					= @ID				
			,DOSYAAD			= @DOSYAAD		
			,DOSYAUZANTI		= @DOSYAUZANTI	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	 

	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1 --Döküman Ekle
		BEGIN
			--VARSA SİL UPGRADE--
			DECLARE @ID_DOKUMANTEMP INT = (SELECT ID_DOKUMAN FROM DokumanDetay WHERE ID = @ID)	
			DELETE DD 
			FROM DokumanDetay DD
			INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
			WHERE DD.ID = @ID AND D.ID_DOKUMANTUR=1
			DELETE FROM Dokuman WHERE ID_DOKUMAN = @ID_DOKUMANTEMP AND ID_DOKUMANTUR=1
			--VARSA SİL UPGRADE--

			DECLARE @ID_DOKUMANLIST TABLE (ID_DOKUMAN INT)

			INSERT INTO Dokuman (ID_DOKUMANTUR,DOSYAAD,DOSYAUZANTI,KYE_KULLANICI)
			OUTPUT INSERTED.ID_DOKUMAN INTO @ID_DOKUMANLIST(ID_DOKUMAN)
			VALUES (@ID_DOKUMANTUR,@DOSYAAD,@DOSYAUZANTI,@TCKIMLIKNO)

			INSERT INTO DokumanDetay(ID_DOKUMAN, ID) VALUES((select TOP 1 ID_DOKUMAN from @ID_DOKUMANLIST), @ID)
		END

		IF @ISLEM = 2 --Dokuman Listele
		BEGIN

			SELECT ID_DOKUMAN
				  ,ID_DOKUMANTUR
				  ,DOKUMANTUR
				  ,DOSYAAD
				  ,DOSYAUZANTI
				  ,ID
				  ,KYE_KULLANICI
				  ,KYE_TARIH
			  FROM dbo.vw_Dokuman
			  WHERE
				(@ID IS NULL OR @ID=0 OR ID=@ID) AND
				(@ID_DOKUMAN IS NULL OR @ID_DOKUMAN=0 OR ID_DOKUMAN=@ID_DOKUMAN) AND
				(@ID_DOKUMANTUR IS NULL OR @ID_DOKUMANTUR=0 OR ID_DOKUMANTUR=@ID_DOKUMANTUR) 
			  ORDER BY KYE_TARIH Desc
		END


	END
END TRY
BEGIN CATCH	
	DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Donem]    Script Date: 22.11.2021 10:45:45 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Donem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM				 	=	@ISLEM		
			,TCKIMLIKNO			 	=	@TCKIMLIKNO	
			,OTURUM				 	=	@OTURUM		
			,ID_MENU			 	=	@ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY  
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	 

	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	DONEM Listele
		BEGIN
			SELECT * FROM [dbo].[v3AktifDonem]
			ORDER BY AKTIF DESC,DONEM DESC
		END
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2

	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_DSNetPuanOrtalamalariOS]    Script Date: 22.11.2021 10:47:46 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_DSNetPuanOrtalamalariOS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@DONEM				char(4)			= NULL,
	@ID_MENU			INT				= 0,
	@ID_KADEME3			INT				= 0,
	@ID_SINAVTURU		INT				= 0,
	@ID_SINAV			INT				= 0,
	@ID_DERS			INT				= 0,
	@ID_SUBE			INT				= 0,
	@ID_SINIF			INT				= 0,
	@ID_SINAVDOSYA		int				= 0,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= '[]',
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,DONEM						= @DONEM			
			,ID_MENU					= @ID_MENU		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@DONEM='2017',@ID_SINAVTURU=6,@ID_KADEME3=17,@ID_SINAVs='[0,168,158,160,145,70,78,144,143,67,69]',@ID_SUBEs='[427,11]',@ID_SINIFS='[0,104795,102205,102206,101684,101674,101675,101673,101681,102311]',@ID_DERSs='[914,977,978,980,981,1016,1047,1051]'

BEGIN TRY   

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	 
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END

	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	SINIF	
		BEGIN
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SIRALAMA_SINIF

			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[163]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 3
			--		,@ID_KADEME3	INT			= 18

			IF @ID_SINAVs<>'[]'  AND @ID_SINAVTURU = 0
			BEGIN
				SELECT @ID_SINAVTURU = ID_SINAVTURU FROM Sinav WHERE ID_SINAV=@ID_SINAV
			END
			IF @ID_SINAVs<>'[]' AND @ID_KADEME3=0
			BEGIN
				SET @ID_KADEME3= (SELECT TOP 1 ID_KADEME3 FROM Sinav WHERE ID_SINAV IN ((SELECT VALUE FROM OPENJSON(@ID_SINAVs))))
			END 

			SELECT S.ID_SINAV, SO.TCKIMLIKNO, ID_SINIF, VD.ID_DERS, SD.BOLUMNO, SD.TAKMAAD DERSAD, NET, DOGRU, YANLIS, BOS
					, O.ID_SUBE
			INTO	#TEMP_SINIFGENEL	FROM Sinav	S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			--JOIN	vw_SinavOgrenciSoru		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= S.ID_SINAV
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS 			
			JOIN	eokul_v2.DBO.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
																AND (
																	VD.DERSAD IN (SELECT D.DERSAD FROM eokul_v2.DBO.Ders D WHERE D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSs)))
																	OR @ID_DERSs = '[]'
																	)
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				--AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs)) OR @ID_SUBEs='[]' OR @ID_SUBEs='[0]')
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))




			SELECT * INTO #TEMP_SINIF FROM #TEMP_SINIFGENEL WHERE (ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs)) OR @ID_SUBEs='[]' OR @ID_SUBEs='[0]') 



			SELECT ID_DERS, DERSAD, BOLUMNO, ID_SINIF, ID_SUBE, ID_SINAV, NETORT = CAST(AVG(NET) AS DECIMAL(8,2)), SINIFKATILIM = COUNT(NET), SORUSAYISI= 0
			INTO #SINIFGENEL FROM #TEMP_SINIFGENEL
			GROUP BY ID_DERS, BOLUMNO, DERSAD, ID_SINIF, ID_SUBE, ID_SINAV
			
			SELECT	 S.*
					,GENELSIRA	= DENSE_RANK() OVER(PARTITION BY BOLUMNO			ORDER BY NETORT DESC) 
			INTO #SIRALAMA_GENEL FROM #SINIFGENEL	S




			SELECT ID_DERS, DERSAD, BOLUMNO, ID_SINIF, ID_SUBE, ID_SINAV, NETORT = CAST(AVG(NET) AS DECIMAL(8,2)), SINIFKATILIM = COUNT(NET), SORUSAYISI= 0
			INTO #SINIF FROM #TEMP_SINIF
			GROUP BY ID_DERS, BOLUMNO, DERSAD, ID_SINIF, ID_SUBE, ID_SINAV
			
			UPDATE	S 
			SET		S.SORUSAYISI=J.SORUSAYISI
			FROM	#SINIF AS S
			JOIN (
			SELECT ID_DERS,AVG(DOGRU+YANLIS+BOS) SORUSAYISI, BOLUMNO  FROM #TEMP_SINIF GROUP BY ID_DERS, BOLUMNO)  J ON J.ID_DERS=S.ID_DERS AND J.BOLUMNO = S.BOLUMNO

			SELECT	 S.*
					,SUBESIRA	= DENSE_RANK() OVER(PARTITION BY S.BOLUMNO,S.ID_SUBE	ORDER BY S.NETORT DESC) 
					,SG.GENELSIRA
			INTO #SIRALAMA_SINIF FROM #SINIF	S 
			JOIN #SIRALAMA_GENEL SG ON SG.BOLUMNO = S.BOLUMNO AND SG.ID_SINIF = S.ID_SINIF



			DECLARE @ID_EGITIMTURU VARCHAR(15)=
				CASE	WHEN @ID_SINAVTURU = 2 THEN 7
						WHEN @ID_SINAVTURU = 3 THEN 8
						WHEN @ID_SINAVTURU = 6 THEN 9
						ELSE @ID_SINAVTURU 
				END 


			SELECT	 SS.*					
					,SINAVTARIH	= CONVERT(VARCHAR,S.SINAVTARIH,103) 
					,SINAVAD	= S.AD
					,KADEME3	= UPPER(K3.AD)
					,SUBEAD		= SU.AD 
					,SINIFAD	= SN.AD					
					,ADSOYAD	= (
									SELECT TOP 1
										K.AD +' '+ K.SOYAD 
									FROM v3Kullanici						K
									INNER JOIN eokul_v2.dbo.DersOgretmen	DO	ON		DO.ID_SINIF		= SS.ID_SINIF
																					AND DO.ID_DERS		= SS.ID_DERS
																					AND DO.ID_EGITIMTURU= @ID_EGITIMTURU--S.ID_SINAVTURU
																					AND DO.DONEMKOD		= @DONEM
																					AND DO.TC_OGRETMEN	= K.TCKIMLIKNO
									)
			FROM		#SIRALAMA_SINIF SS
			JOIN		v3Sube						SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= SS.ID_SUBE
			JOIN		v3Sinif						SN	WITH (NOLOCK)	ON	SN.ID_SINIF			= SS.ID_SINIF
			JOIN		Sinav						S	WITH (NOLOCK)	ON	S.ID_SINAV			= SS.ID_SINAV
			JOIN		v3Kademe3					K3	WITH (NOLOCK)	ON	K3.ID_KADEME3		= S.ID_KADEME3
			ORDER BY	BOLUMNO,GENELSIRA,SUBESIRA


			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP_SINIFGENEL
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SIRALAMA_SINIF
			DROP TABLE IF EXISTS #SIRALAMA_GENEL
		END
		IF @ISLEM = 2	--	OKUL	
		BEGIN
			
			DROP TABLE IF EXISTS #SinavList
			DROP TABLE IF EXISTS ##GenelOrt 
			DROP TABLE IF EXISTS ##pivots
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Net

			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[427,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[163]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 3
			--		,@ID_KADEME3	INT			= 18

			IF @ID_SINAVs<>'[]' AND @ID_KADEME3=0
			BEGIN
				SET @ID_KADEME3= (SELECT TOP 1 ID_KADEME3 FROM Sinav WHERE ID_SINAV IN ((SELECT VALUE FROM OPENJSON(@ID_SINAVs))))
			END 

			SELECT DISTINCT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,ID_SINIF,VD.ID_DERS,SD.BOLUMNO,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OS.PUAN,OS.ID_SINAVPUANTURU,PT.AD PUANTURU
			INTO	#Temp
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
	   LEFT JOIN	SinavOgrenciPuan		OS	WITH (NOLOCK)	ON	OS.ID_SINAV			= SO.ID_SINAV
																AND OS.TCKIMLIKNO		= SO.TCKIMLIKNO
	   LEFT JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = OS.ID_SINAVPUANTURU
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON  SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			--JOIN	vw_SinavOgrenciSoru		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= OS.ID_SINAV
			--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVDERS		= SOS.ID_SINAVDERS
			--													AND SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.DBO.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs)) OR @ID_SUBEs='[]' OR @ID_SUBEs='[]')
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
				--AND PT.ID_SINAVTURU	= @ID_SINAVTURU
				--AND S.ID_KADEME3	= @ID_KADEME3

			--SELECT * FROM #Temp

			SELECT ID_SINAV,SINAVAD,PUANTURU,SINAVTARIH,ID_SUBE,SUBEAD, TCKIMLIKNO, PUAN
			INTO #Temp2
			FROM #Temp	T
			WHERE T.ID_SINAVPUANTURU IS NOT NULL
			GROUP BY ID_SINAV,SINAVAD,PUANTURU,SINAVTARIH,ID_SUBE,SUBEAD, TCKIMLIKNO, PUAN


				SELECT ID_SINAV,SINAVAD,ID_DERS,BOLUMNO,DERSAD,SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD
				INTO #Net FROM #Temp	T
				GROUP BY ID_DERS,BOLUMNO,ID_SINAV,SINAVTARIH,SINAVAD,DERSAD,ID_SUBE,SUBEAD

			
		INSERT INTO #Net			
			--SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD
			--FROM #Net	T
			--GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD

			--UNION ALL 
				SELECT ID_SINAV,SINAVAD,0,999,'TOPLAM',SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS,
				--CAST(AVG(NET) AS DECIMAL(8,2)) NET 
				NET = (SELECT CAST(AVG(TN) AS DECIMAL(8,2)) NET FROM SinavOgrenciToplam S JOIN OkyanusDB.DBO.vw_OgrenciDetayTum D ON D.TCKIMLIKNO = S.TCKIMLIKNO WHERE D.ID_SUBE = T.ID_SUBE AND S.ID_SINAV = T.ID_SINAV)
				,ID_SUBE,SUBEAD
				FROM #Temp	T
				GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD
			UNION ALL 
				SELECT ID_SINAV,SINAVAD,-1,1000,PUANTURU,SINAVTARIH,0 AS TS, CAST(AVG(PUAN) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD
				FROM #Temp2	T
				GROUP BY ID_SINAV,SINAVTARIH,PUANTURU,SINAVAD,ID_SUBE,SUBEAD


			Declare @SQL as varchar(max)
			Declare @Columns as varchar(max)
			Declare @Columns2 as varchar(max)
			Declare @Columns3 as varchar(max)

				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
				from 
					( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
				order by b.SINAVTARIH


				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
				from 
					( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
				order by b.SINAVTARIH

				Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst(CASE WHEN  '+QUOTENAME(SINAVAD)+' = ''-'' THEN NULL ELSE '+QUOTENAME(SINAVAD)+' END AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
				from 
					( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
				order by b.SINAVTARIH
		
				
			
			Set @SQL='	
				Select 								 
					--ID_SINAV,
					--SINAVTARIH,
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					DERSAD,
					BOLUMNO,
					-- TS,
					'+@Columns2+' 
				into ##pivots
				from (
					Select 
						SINAVAD,
						ID_SINAV,
						SINAVTARIH,
						ID_DERS,
						ID_SUBE,
						SUBEAD,
						DERSAD,
						BOLUMNO,
						-- TS,
						NET
					from #Net
				) AS S
				PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
				GROUP BY DERSAD,SUBEAD,ID_SUBE,ID_DERS,BOLUMNO			
	
				
				SELECT ID_DERS,BOLUMNO,DERSAD,'+@Columns3+'
				INTO ##GenelOrt
				FROM ##pivots 
				GROUP BY ID_DERS,BOLUMNO,DERSAD		
			'
			PRINT @SQL
			EXEC (@SQL)


			SELECT * FROM ##pivots 
			ORDER BY BOLUMNO


			SELECT * FROM ##GenelOrt ORDER BY BOLUMNO

			
			SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH , KADEME3 = UPPER(K3.AD)
			FROM dbo.fn_Split(@Columns,',',NULL) FN
			JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value
			JOIN v3Kademe3 K3 ON K3.ID_KADEME3=@ID_KADEME3

			SELECT DISTINCT ID_SUBE,SUBEAD FROM #Temp
			SELECT DISTINCT BOLUMNO,DERSAD FROM #Temp


			DROP TABLE IF EXISTS #SinavList
			DROP TABLE IF EXISTS ##GenelOrt 
			DROP TABLE IF EXISTS ##pivots
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Temp2
			DROP TABLE IF EXISTS #Net


							
		END
	

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Duyuru]    Script Date: 22.11.2021 10:48:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Duyuru]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_DUYURU				INT				= NULL,
	@ID_KULLANICITIPILIST	VARCHAR(MAX)	= NULL,
	@ID_SUBELIST			VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@GUID					VARCHAR(MAX)	= NULL,
	@MOBIL_BANNER			BIT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_DUYURU				= @ID_DUYURU	
				,ID_KULLANICITIPILIST	= @ID_KULLANICITIPILIST
				,ID_SUBELIST			= @ID_SUBELIST
				,SQLJSON				= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @ID_LOG > 0
		BEGIN
			IF @ISLEM = 1	--	DUYURU EKLE				
			BEGIN
				
				SELECT TOP 1 * 
				INTO #DUYURU
				FROM OPENJSON(@SQLJSON)
				WITH(	ID_DUYURU				INT,
						BANNER					BIT,
						TCKIMLIKNO				NVARCHAR(MAX),
						OTURUM					NVARCHAR(MAX),
						ID_KULLANICITIPILIST	NVARCHAR(MAX),
						ID_SUBELIST				NVARCHAR(MAX),
						BASLIK					NVARCHAR(MAX),
						ICERIK					NVARCHAR(MAX),
						BAS_TARIH				NVARCHAR(MAX),
						BIT_TARIH				NVARCHAR(MAX),
						ID_KADEMELIST			NVARCHAR(MAX),
						ID_KADEME3LIST			NVARCHAR(MAX),
						ID_SINIFLIST			NVARCHAR(MAX),
						FOTOGRAF				NVARCHAR(MAX),
						FOTOGRAF_MOBIL			NVARCHAR(MAX),
						DOSYALIST				NVARCHAR(MAX))

				DECLARE @ID TABLE (ID INT)
				INSERT INTO Duyuru (BASLIK,ICERIK,BANNER,FOTOGRAF,FOTOGRAF_MOBIL,BAS_TARIH,BIT_TARIH,KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_DUYURU INTO @ID(ID)
				SELECT TOP 1 BASLIK,ICERIK,BANNER,FOTOGRAF,FOTOGRAF_MOBIL,BAS_TARIH,BIT_TARIH,@TCKIMLIKNO AS KYE_TCKIMLIKNO FROM #DUYURU
				SET @ID_DUYURU = (SELECT TOP 1 ID FROM @ID)

				SELECT VALUE AS ID_KULLANICITIPI INTO #ID_KULLANICITIPILIST FROM OPENJSON(( SELECT TOP 1 ID_KULLANICITIPILIST	FROM #DUYURU))
				SELECT VALUE AS ID_SUBE			 INTO #ID_SUBELIST			FROM OPENJSON(( SELECT TOP 1 ID_SUBELIST			FROM #DUYURU))
				SELECT VALUE AS ID_KADEME		 INTO #ID_KADEMELIST		FROM OPENJSON(( SELECT TOP 1 ID_KADEMELIST			FROM #DUYURU))
				SELECT VALUE AS ID_KADEME3		 INTO #ID_KADEME3LIST		FROM OPENJSON(( SELECT TOP 1 ID_KADEME3LIST			FROM #DUYURU))
				SELECT VALUE AS ID_SINIF		 INTO #ID_SINIFLIST			FROM OPENJSON(( SELECT TOP 1 ID_SINIFLIST			FROM #DUYURU))
				SELECT VALUE AS DOSYA			 INTO #DOSYALIST			FROM OPENJSON(( SELECT TOP 1 DOSYALIST				FROM #DUYURU))


				IF EXISTS(SELECT * FROM #ID_KULLANICITIPILIST WHERE ID_KULLANICITIPI IN (4,5)) -- ÖĞRENCİ VEYA VELİ İSE
				BEGIN

					IF EXISTS(SELECT * FROM #ID_SINIFLIST)
					BEGIN

						SELECT GS.ID_SINIF, GS.ID_KADEME, GS.ID_KADEME3, GS.ID_SUBE
						INTO #SINIFLIST
						FROM #ID_SINIFLIST	SN
						JOIN Pusulam.DBO.vw_SubeSinifGrupKademeTum	GS	ON	GS.ID_SINIF		= SN.ID_SINIF

						INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
						SELECT @ID_DUYURU, ID_KULLANICITIPI, SNL.ID_SUBE, SNL.ID_KADEME, SNL.ID_KADEME3, SNL.ID_SINIF 
						FROM #ID_KULLANICITIPILIST	KL
						CROSS APPLY #SINIFLIST		SNL	
						WHERE KL.ID_KULLANICITIPI IN (4,5)

						DROP TABLE #SINIFLIST

					END
					ELSE
					BEGIN

						INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
						SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, NULL
						FROM #ID_KULLANICITIPILIST	KL
						OUTER APPLY #ID_SUBELIST	SL
						OUTER APPLY #ID_KADEMELIST	KDL
						OUTER APPLY #ID_KADEME3LIST	K3L
						WHERE KL.ID_KULLANICITIPI IN (4,5)

					END
				END

				INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI,ID_SUBE)
				SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE
				FROM #ID_KULLANICITIPILIST	KTL
				OUTER APPLY #ID_SUBELIST	SL
				WHERE ID_KULLANICITIPI NOT IN (4,5)

				INSERT INTO DuyuruDosya (ID_DUYURU, DOSYAYOL)
				SELECT @ID_DUYURU, DOSYA FROM #DOSYALIST

				SELECT @ID_DUYURU ID_DUYURU
				
				DROP TABLE IF EXISTS #DUYURU
				DROP TABLE IF EXISTS #ID_KULLANICITIPILIST 
				DROP TABLE IF EXISTS #ID_SUBELIST			
				DROP TABLE IF EXISTS #ID_KADEMELIST		
				DROP TABLE IF EXISTS #ID_KADEME3LIST		
				DROP TABLE IF EXISTS #ID_SINIFLIST			
				DROP TABLE IF EXISTS #DOSYALIST	
			END

			IF @ISLEM = 2	--	DUYURU LİSTE			
			BEGIN

				SELECT ISNULL((
					SELECT	DISTINCT
							 D.ID_DUYURU
							,D.FOTOGRAF
							,D.FOTOGRAF_MOBIL
							,ADSOYAD	= K.AD + ' ' + K.SOYAD
							,BAS_TARIH	= CONVERT(VARCHAR,D.BAS_TARIH,104)
							,BIT_TARIH	= CONVERT(VARCHAR,D.BIT_TARIH,104)
							,YAYINTARIHI= CONVERT(VARCHAR, D.BAS_TARIH, 104) +' - ' + CONVERT(VARCHAR, D.BIT_TARIH, 104)
							,D.BASLIK
							,D.AKTIF
							,ISLEM = NULL
							,CEKLER = NULL
					FROM Duyuru					D
					JOIN DuyuruYetki			Y	ON	Y.ID_DUYURU		= D.ID_DUYURU
					JOIN OkyanusDB.DBO.V3Kullanici	K	ON	K.TCKIMLIKNO	= D.KYE_TCKIMLIKNO
					WHERE	(@ID_KULLANICITIPILIST	IS NULL OR	Y.ID_KULLANICITIPI	IN (SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)))
						AND	(@ID_SUBELIST			IS NULL OR	Y.ID_SUBE			IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)))
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 3	--	DUYURU AKTIF / PASIF	
			BEGIN
				
				UPDATE D SET 
					D.AKTIF = CASE WHEN D.AKTIF = 1 THEN 0 ELSE 1 END 
				FROM Duyuru	D
				WHERE D.ID_DUYURU = @ID_DUYURU

			END

			IF @ISLEM = 4	--	DUYURU DETAY			
			BEGIN
				
				SELECT ISNULL((
					SELECT DISTINCT 
							 D.ID_DUYURU
							,D.FOTOGRAF
							,D.FOTOGRAF_MOBIL
							,ADSOYAD	= K.AD + ' ' + K.SOYAD
							,D.BAS_TARIH
							,D.BIT_TARIH
							,D.BASLIK
							,D.ICERIK
							,D.BANNER
							,ID_SUBELIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_SUBE AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_SUBE	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_KULLANICITIPILIST	=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_KULLANICITIPI AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_KULLANICITIPI	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_KADEMELIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_KADEME AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_KADEME	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_KADEME3LIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_KADEME3 AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_KADEME3	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_SINIFLIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_SINIF AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_SINIF	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,DOSYALIST				=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT '", "' + DD.DOSYAYOL 
																							FROM DuyuruDosya	DD
																							WHERE	DD.ID_DUYURU = D.ID_DUYURU
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + '"]' )
															),'[]')

							--,ID_SUBELIST			=ISNULL((	SELECT DISTINCT ID_SUBE
							--									FROM DuyuruYetki	SY
							--									WHERE	SY.ID_DUYURU = D.ID_DUYURU
							--										AND SY.ID_SUBE	IS NOT NULL
							--									FOR JSON PATH, INCLUDE_NULL_VALUES
							--								),'[]')

					FROM Duyuru					D
					JOIN OkyanusDB.DBO.V3Kullanici	K	ON	K.TCKIMLIKNO	= D.KYE_TCKIMLIKNO
					WHERE	D.ID_DUYURU = @ID_DUYURU
					FOR JSON PATH
				),'[]')

			END 
			
			IF @ISLEM = 5	--	DUYURU GUNCELLE			
			BEGIN
				
				IF EXISTS ( SELECT * FROM Duyuru WHERE ID_DUYURU = @ID_DUYURU )
				BEGIN

					SELECT TOP 1 * 
					INTO #DUYURU5
					FROM OPENJSON(@SQLJSON)
					WITH(	ID_DUYURU				INT,
							BANNER					BIT,
							TCKIMLIKNO				NVARCHAR(MAX),
							OTURUM					NVARCHAR(MAX),
							ID_KULLANICITIPILIST	NVARCHAR(MAX),
							ID_SUBELIST				NVARCHAR(MAX),
							BASLIK					NVARCHAR(MAX),
							ICERIK					NVARCHAR(MAX),
							BAS_TARIH				NVARCHAR(MAX),
							BIT_TARIH				NVARCHAR(MAX),
							ID_KADEMELIST			NVARCHAR(MAX),
							ID_KADEME3LIST			NVARCHAR(MAX),
							ID_SINIFLIST			NVARCHAR(MAX),
							FOTOGRAF				NVARCHAR(MAX),
							FOTOGRAF_MOBIL			NVARCHAR(MAX),
							DOSYALIST				NVARCHAR(MAX))

					UPDATE D SET
						 D.BASLIK			= K.BASLIK
						,D.ICERIK			= K.ICERIK
						,D.BANNER			= K.BANNER						
						,D.BAS_TARIH		= K.BAS_TARIH
						,D.BIT_TARIH		= K.BIT_TARIH
						,D.KYG_TCKIMLIKNO	= @TCKIMLIKNO
						,D.KYG_TARIH		= GETDATE()
					FROM Duyuru D
					JOIN #DUYURU5	K ON 1 = 1
					WHERE D.ID_DUYURU = @ID_DUYURU

					DELETE FROM DuyuruYetki WHERE ID_DUYURU = @ID_DUYURU
					DELETE FROM DuyuruDosya WHERE ID_DUYURU = @ID_DUYURU

					SELECT VALUE AS ID_KULLANICITIPI INTO #ID_KULLANICITIPILIST5	FROM OPENJSON(( SELECT TOP 1 ID_KULLANICITIPILIST	FROM #DUYURU5))
					SELECT VALUE AS ID_SUBE			 INTO #ID_SUBELIST5				FROM OPENJSON(( SELECT TOP 1 ID_SUBELIST			FROM #DUYURU5))
					SELECT VALUE AS ID_KADEME		 INTO #ID_KADEMELIST5			FROM OPENJSON(( SELECT TOP 1 ID_KADEMELIST			FROM #DUYURU5))
					SELECT VALUE AS ID_KADEME3		 INTO #ID_KADEME3LIST5			FROM OPENJSON(( SELECT TOP 1 ID_KADEME3LIST			FROM #DUYURU5))
					SELECT VALUE AS ID_SINIF		 INTO #ID_SINIFLIST5			FROM OPENJSON(( SELECT TOP 1 ID_SINIFLIST			FROM #DUYURU5))
					SELECT VALUE AS DOSYA			 INTO #DOSYALIST5				FROM OPENJSON(( SELECT TOP 1 DOSYALIST				FROM #DUYURU5))


					IF EXISTS(SELECT * FROM #ID_KULLANICITIPILIST5 WHERE ID_KULLANICITIPI IN (4,5)) -- ÖĞRENCİ VEYA VELİ İSE
					BEGIN

						IF EXISTS(SELECT * FROM #ID_SINIFLIST5)
						BEGIN

							SELECT GS.ID_SINIF, GS.ID_KADEME, GS.ID_KADEME3, GS.ID_SUBE
							INTO #SINIFLIST5
							FROM #ID_SINIFLIST5	SN
							JOIN Pusulam.DBO.vw_SubeSinifGrupKademeTum	GS	ON	GS.ID_SINIF	= SN.ID_SINIF

							INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
							SELECT @ID_DUYURU, ID_KULLANICITIPI, SNL.ID_SUBE, SNL.ID_KADEME, SNL.ID_KADEME3, SNL.ID_SINIF 
							FROM #ID_KULLANICITIPILIST5	KL
							CROSS APPLY #SINIFLIST5		SNL	
							WHERE KL.ID_KULLANICITIPI IN (4,5)

							DROP TABLE #SINIFLIST5

						END
						ELSE
						BEGIN

							INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
							SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, NULL 
							FROM #ID_KULLANICITIPILIST5		KL
							OUTER APPLY #ID_SUBELIST5		SL
							OUTER APPLY #ID_KADEMELIST5		KDL
							OUTER APPLY #ID_KADEME3LIST5	K3L
							WHERE KL.ID_KULLANICITIPI IN (4,5)

						END						
					END

					INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI,ID_SUBE)
					SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE
					FROM #ID_KULLANICITIPILIST5	KTL
					OUTER APPLY #ID_SUBELIST5	SL
					WHERE ID_KULLANICITIPI NOT IN (4,5)

					INSERT INTO DuyuruDosya (ID_DUYURU, DOSYAYOL)
					SELECT @ID_DUYURU, DOSYA FROM #DOSYALIST5

					SELECT @ID_DUYURU ID_DUYURU
				
					DROP TABLE IF EXISTS #DUYURU5
					DROP TABLE IF EXISTS #ID_KULLANICITIPILIST5
					DROP TABLE IF EXISTS #ID_SUBELIST5			
					DROP TABLE IF EXISTS #ID_KADEMELIST5		
					DROP TABLE IF EXISTS #ID_KADEME3LIST5		
					DROP TABLE IF EXISTS #ID_SINIFLIST5			
					DROP TABLE IF EXISTS #DOSYALIST5	

				END

			END
			
			IF @ISLEM = 6	--	DUYURULAR				
			BEGIN

				SELECT ID_DUYURU
				INTO #DUYURULIST6
				FROM Duyuru TD
				WHERE	TD.BAS_TARIH <= CAST(GETDATE() AS DATE)
					AND TD.BIT_TARIH >= CAST(GETDATE() AS DATE)
					AND AKTIF = 1

		
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME, ID_KADEME3, ID_SUBE
				INTO #TEMP6
				FROM OkyanusDB.dbo.v3KullaniciSubeKademe3 
				WHERE TCKIMLIKNO	= @TCKIMLIKNO

				SELECT ISNULL((
					SELECT DISTINCT
						 RN = ROW_NUMBER() OVER(ORDER BY TD.BIT_TARIH DESC,TD.ID_DUYURU DESC)
						,TD.ID_DUYURU
						,TD.BASLIK
						,TD.ICERIK
						,TD.BANNER
						,BAS_TARIH		= CONVERT(VARCHAR, TD.BAS_TARIH, 104)
						,BIT_TARIH		= CONVERT(VARCHAR, TD.BIT_TARIH, 104)
						,YAYINTARIHI	= CONVERT(VARCHAR, TD.BAS_TARIH, 104) +' - ' + CONVERT(VARCHAR, TD.BIT_TARIH, 104)
						,FOTOGRAF		= ISNULL(TD.FOTOGRAF,'') 
						,FOTOGRAF_MOBIL	= ISNULL(TD.FOTOGRAF_MOBIL,'') 
						,DOSYALIST	= ISNULL((	SELECT DISTINCT DOSYAYOL AS DOSYA
												FROM DuyuruDosya DD
												WHERE DD.ID_DUYURU = TD.ID_DUYURU
												FOR JSON PATH, INCLUDE_NULL_VALUES
											),'[]')
					FROM Duyuru	TD
					JOIN (	SELECT D.ID_DUYURU
							FROM #DUYURULIST6				D
							JOIN DuyuruYetki			DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN OkyanusDB.dbo.v3SubeYetki	SY	ON	SY.ID_KULLANICITIPI	= DY.ID_KULLANICITIPI
																AND SY.ID_SUBE			= DY.ID_SUBE
							WHERE	DY.ID_KULLANICITIPI	NOT IN (4,5)
								AND SY.TCKIMLIKNO	= @TCKIMLIKNO
						UNION
							SELECT D.ID_DUYURU
							FROM #DUYURULIST6							D
							JOIN DuyuruYetki						DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN OkyanusDB.dbo.v3KullaniciSinif			KS	ON	KS.ID_SINIF			= DY.ID_SINIF
							JOIN OkyanusDB.DBO.v3OgrenciVeli			OV	ON	OV.TCKIMLIKNO		= KS.TCKIMLIKNO
																			OR	OV.TCKIMLIKNO_OGR	= KS.TCKIMLIKNO
							WHERE	DY.ID_KULLANICITIPI	IN (4,5)
								AND KS.TCKIMLIKNO	= @TCKIMLIKNO
						UNION
							SELECT D.ID_DUYURU
							FROM #DUYURULIST6					D
							JOIN DuyuruYetki				DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN #TEMP6						KS	ON	KS.ID_SUBE			= DY.ID_SUBE
																	AND (	KS.ID_KADEME	= DY.ID_KADEME
																		OR	KS.ID_KADEME3	= DY.ID_KADEME3)
							JOIN OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO		= KS.TCKIMLIKNO
																	OR	OV.TCKIMLIKNO_OGR	= KS.TCKIMLIKNO
							WHERE	DY.ID_KULLANICITIPI	IN (4,5)
								AND KS.TCKIMLIKNO	= @TCKIMLIKNO
					) SD ON SD.ID_DUYURU = TD.ID_DUYURU
					ORDER BY RN
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

				DROP TABLE #TEMP6
				DROP TABLE #DUYURULIST6

			END

			IF @ISLEM = 7	-- DUYURU WEB BANNER 
			BEGIN
				IF @MOBIL_BANNER = 0
				BEGIN
					UPDATE DUYURU SET FOTOGRAF = @GUID , BANNER = 1 WHERE ID_DUYURU = @ID_DUYURU
				END
				ELSE
				BEGIN
					UPDATE DUYURU SET FOTOGRAF_MOBIL = @GUID , BANNER = 1 WHERE ID_DUYURU = @ID_DUYURU
				END
			END

			IF @ISLEM = 8  -- DUYURU DOSYA
			BEGIN
				INSERT INTO DuyuruDosya (ID_DUYURU, DOSYAYOL) VALUES (@ID_DUYURU,@GUID)
			END

		END 


	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState 		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Etut]    Script Date: 22.11.2021 10:48:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Etut]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= '',
	@OGRENCIDONEM		char(4)			= '',
	@AKTIFDONEM			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAVTURUS		VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@KOD				VARCHAR(MAX)	= '',
	@ETUT				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@SAAT				VARCHAR(MAX)	= NULL,
	@SURE				VARCHAR(MAX)	= NULL,	
	@YER				VARCHAR(MAX)	= NULL,	
	@ID_ETUTTURU		INT				= NULL,
	@TC_OGRENCIs		VARCHAR(MAX)	= NULL,		
	@KODs				VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ETUTJSON			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@KATILDI			BIT				= 0,
	@KATILACAK			BIT				= 0,
	@IP					VARCHAR(50)	= NULL




	--ETUT,TARIH,SAAT,SURE,ID_SUBE,YER,ID_DERS,DONEM,AKTIF,KYE_TCKIMLIKNO,ID_KADEME3,TC_OGRETMEN,ID_ETUTTURU
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM				 	= @ISLEM			
			,TCKIMLIKNO			 	= @TCKIMLIKNO		
			,TC_OGRENCI			 	= @TC_OGRENCI		
			,TC_OGRETMEN		 	= @TC_OGRETMEN	
			,OTURUM				 	= @OTURUM			
			,ID_MENU			 	= @ID_MENU		
			,DONEM				 	= @DONEM			
			,OGRENCIDONEM		 	= @OGRENCIDONEM	
			,AKTIFDONEM			 	= @AKTIFDONEM		
			,ID_KADEME3			 	= @ID_KADEME3		
			,ID_SINAVTURU		 	= @ID_SINAVTURU	
			,ID_SINAVTURUS		 	= @ID_SINAVTURUS	
			,ID_SINAV			 	= @ID_SINAV		
			,ID_DERS			 	= @ID_DERS		
			,ID_SUBE			 	= @ID_SUBE		
			,ID_SINIF			 	= @ID_SINIF		
			,ID_SUBEs			 	= @ID_SUBEs		
			,ID_SINIFs			 	= @ID_SINIFs		
			,ID_DERSs			 	= @ID_DERSs		
			,ID_SINAVs			 	= @ID_SINAVs		
			,KOD				 	= @KOD			
			,ETUT				 	= @ETUT			
			,TARIH				 	= @TARIH			
			,SAAT				 	= @SAAT			
			,SURE				 	= @SURE			
			,YER				 	= @YER			
			,ID_ETUTTURU		 	= @ID_ETUTTURU	
			,TC_OGRENCIs		 	= @TC_OGRENCIs	
			,KODs				 	= @KODs			
			,DERSAD				 	= @DERSAD			
			,ETUTJSON			 	= @ETUTJSON		
			,ID_ETUT			 	= @ID_ETUT		
			,KATILDI			 	= @KATILDI		
			,KATILACAK			 	= @KATILACAK		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END


	IF @ID_LOG > 1
	BEGIN
		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		
		SELECT @AKTIFDONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		PRINT @DONEM
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
			PRINT @DONEM
		END

		IF @ISLEM = 1	--	PUSULAM SINAV					
		BEGIN
			-- SINAVLAR

			drop table if exists #temp4T
			drop table if exists #TEMPORTT
			drop table if exists #t1
			drop table if exists #t3
			drop table if exists #temp
			drop table if exists #temp3
			drop table if exists #temp4
			drop table if exists #TEMPORT
			drop table if exists #TEMPORTS
			drop table if exists #tempY2
			drop table if exists #ttemp
			drop table if exists #ttemp3
			drop table if exists #TTEMPORTS
			--drop table if exists #UNITE

		
			SELECT 
				 S.ID_SINAV AS ID_SINAVBILGI
				,S.AD		AS ACIKLAMA
				,D.DERSAD	AS DERSAD
				,D.ID_DERS
				,SUBSTRING(V.KOD,1,6) AS UNITEKOD
				,SUBSTRING(V.KOD,1,9) AS KONUKOD
				,V.DURUM
			INTO #LISTEOGRENCI
			FROM  vw_SinavOgrenciSoru	V
			JOIN Sinav					S	ON	S.ID_SINAV		= V.ID_SINAV	
			JOIN v3OgrenciTUM			O	ON O.TCKIMLIKNO		= V.TCKIMLIKNO
			JOIN v3SinifTum				ST	ON ST.ID_SINIF		= O.ID_SINIF AND ST.DONEM = O.DONEM
			JOIN SinavDers				SD	ON	SD.ID_SINAVDERS	= V.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= SD.ID_DERS 
			JOIN eokul_v2.dbo.Ders		D2	ON	D2.DERSAD		= D.DERSAD	
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND (S.OZEL=0 OR @OZELSINAVGOR=1)
				AND S.DONEM			= @DONEM
				AND (D2.ID_DERS		IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs	= '[]' OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs)) )
				AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
				AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR (@ID_SINIFs	= '[]') AND O.DONEM = @AKTIFDONEM)
				AND (S.ID_SINAV		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))		)


			SELECT ID_SINAVBILGI
				,ACIKLAMA
				,ID_DERS
				,DERSAD
				,KOD=KONUKOD
				,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=UNITEKOD),'-') AS UNITE
				,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=KONUKOD ),'-') AS KONU
				,SUM(CASE WHEN DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
				,SUM(1) AS KONUSAYISI
			INTO #ttemp
			FROM #LISTEOGRENCI
			GROUP BY ID_SINAVBILGI , ACIKLAMA,DERSAD ,KONUKOD ,UNITEKOD, ID_DERS

			Select t2.ID_SINAVBILGI,  
					t2.ACIKLAMA,
					t2.DERSAD,
					ID_DERS,
					t2.KOD,
					t2.UNITE,
					t2.KONU,
					t2.KONUSAYISI,
					t2.DOGRUSAYISI,
					(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
			into #ttemp3
			from #ttemp t2
		order by t2.ID_SINAVBILGI,t2.KOD


			Select KOD,
					SUM(KONUSAYISI) as KONUSAYISI,
					SUM(DOGRUSAYISI) as DOGRUSAYISI
			into #TTEMPORTS
			from #ttemp3 
		group by KOD

			Select KOD,
					(Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
			into #TEMPORTT
			from #TTEMPORTS 


			Select t3.ID_SINAVBILGI,  
					t3.ACIKLAMA,
					t3.DERSAD,ID_DERS,
					t3.KOD,
					t3.UNITE,
					t3.KONU,
					--t3.KAZANIM,
					'%' + Cast(t3.YUZDE as varchar) as YUZDE
			into #temp4T
			from #ttemp3 t3
		order by t3.ID_SINAVBILGI,t3.KOD,t3.DERSAD

	  
		
			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
			from
			(
			Select distinct 
					ACIKLAMA,
					ID_SINAVBILGI	
				from #temp4T --order by ID_SINAVBILGI
			) as b
			order by b.ID_SINAVBILGI

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
			from
			(
			Select distinct 
					ACIKLAMA,
					ID_SINAVBILGI
				from #temp4T --order by ID_SINAVBILGI
			) as b
			order by b.ID_SINAVBILGI

		  declare @k int = (Select COUNT(1) from #temp4T)
		  print (@k)
		   
				if (Select COUNT(1) from #temp4T)>0
				begin
					drop table if exists ##pivotS
					drop table if exists ##TT
						Set @SQL='
							Select  DERSAD,ID_DERS, KOD, UNITE, KONU, '+@Columns2+' 
							into ##pivotS 
							from ( Select  ACIKLAMA, DERSAD,ID_DERS, KOD, KONU, YUZDE, UNITE from #temp4T ) AS PivotData
							PIVOT ( MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+') ) as PivotResult
							ORDER BY DERSAD,KOD

							SELECT * 
							INTO ##TT
							FROM ##pivotS
							GROUP BY DERSAD,ID_DERS,KOD,UNITE,KONU,'+@Columns+'
							'
							PRINT @SQL
							EXECute (@SQL)
						
		
			

				Select  p.*,ORTALAMA =  '%'+ Cast( CAST(
														(SELECT top 1 ORTALAMA FROM #TEMPORTT WHERE KOD = p.KOD)
												AS DECIMAL(10,2)) as varchar(10))
				INTO #t3 from ##TT p
				
				
		
			select(
				select * from(
					select 
					(					
						SELECT * FROM #t3
						FOR JSON AUTO
					) as TblListe,
					(					
						Select distinct  ACIKLAMA AS SINAVAD, ID_SINAVBILGI AS ID_SINAV from #temp4T
						FOR JSON AUTO
					) as TblSinav
				) as tablo FOR JSON AUTO
			) as tt

			END



			else 
			begin
			SELECT bos=null
						FOR JSON PATH
			--	select(
			--	select * from(
			--		select 
			--		(					
			--			SELECT bos=null
			--			FOR JSON PATH
			--		) as TblListe,
			--		(					
			--			Select bos=null
			--			FOR JSON PATH
			--		) as TblSinav
			--	) as tablo FOR JSON PATH
			--) as tt
			end 
			
			drop table if exists #temp4T
			drop table if exists #TEMPORTT
			drop table if exists #t1
			drop table if exists #t3
			drop table if exists #temp
			drop table if exists #temp3
			drop table if exists #temp4
			drop table if exists #TEMPORT
			drop table if exists #TEMPORTS
			drop table if exists #tempY2
			drop table if exists #ttemp
			drop table if exists #ttemp3
			drop table if exists #TTEMPORTS
			drop table if exists #LISTEOGRENCI

		END

		IF @ISLEM = 2	--	YAZILI YOKLAMA					
		BEGIN
			BEGIN
				drop table IF EXISTS ##pivotYY
				drop table IF EXISTS #TblYY
				drop table IF EXISTS #tempYY1
				drop table IF EXISTS #tempYY
				drop table IF EXISTS #tempYYOrt
				drop table IF EXISTS #tempPivot



					SELECT   Y.ID_YAZILI							AS ID_SINAVRAPOR		
							,Y.AD									AS ACIKLAMA
							,Y.ID_DERS
							,D.DERSAD								AS DERSAD
							,YS.KOD			
							,ISNULL((SELECT AD FROM OkyanusDB.dbo.v3SinavDersUnite SUBSDU WHERE SUBSDU.KOD = SUBSTRING(SDU.KOD, 1, 9)), '')	AS KONU
							,SDU.AD									AS KAZANIM	
							,SUM(YS.PUAN)							AS PUANDEGERI
							,ISNULL(YO.TELAFI, Sum(YOC.PUAN))		AS PUAN 
					INTO #tempYYX
					FROM Yazili				Y 
					JOIN YaziliSoru			YS	ON	YS.ID_YAZILI			= Y.ID_YAZILI
					JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI			= Y.ID_YAZILI
					JOIN YaziliOgrenciCevap YOC ON	YOC.ID_YAZILIOGRENCI	= YO.ID_YAZILIOGRENCI 
												AND YOC.ID_YAZILISORU		= YS.ID_YAZILISORU
					JOIN v3OgrenciTum		O	ON	O.TCKIMLIKNO			= YO.TCKIMLIKNO 
					JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS				= Y.ID_DERS
												AND D.ID_KADEME3			= Y.ID_KADEME3
					JOIN eokul_v2.dbo.Ders	D2	ON	D2.DERSAD				= D.DERSAD
					JOIN v3SinavDersUnite	SDU ON	SDU.KOD					= YS.KOD
					WHERE		Y.DONEM		= @DONEM 
							AND O.DONEM		= @OGRENCIDONEM
							AND Y.AKTIF		= 1 
							AND YO.AKTIF	= 1
							AND ( ( D2.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSs)) )		OR @ID_DERSs = ''  OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))) 
							AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFs)) )		OR @ID_SINIFs = '' ) 
					GROUP BY	Y.ID_YAZILI	
								,Y.AD		
								,Y.ID_DERS
								,D.DERSAD		
								,YS.KOD			
								,SDU.AD	
								,YO.TELAFI
								,SDU.KOD

					SELECT ID_SINAVRAPOR, ACIKLAMA, ID_DERS, DERSAD, KOD, KONU, KAZANIM, SUM(PUANDEGERI) AS PUANDEGERI, SUM(PUAN) AS PUAN 
					INTO #tempYY
					FROM #tempYYX
					GROUP BY ID_SINAVRAPOR, ACIKLAMA, ID_DERS, DERSAD, KOD, KONU, KAZANIM

					DROP TABLE #tempYYX

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/Convert(decimal(8,2),t.PUANDEGERI))*100.0) as YUZDE
					  into #tempYY1
					  from #tempYY t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   '%'+ CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/Convert(decimal(8,2),t.PUANDEGERI))*100.0) AS varchar(10))as YUZDE
					  into #tempPivot
					  from #tempYY t

					  Select KOD,
							 ID_DERS,
							 Convert(decimal(8,2),AVG(YUZDE)) as ORTALAMA
						into #tempYYOrt
						from #tempYY1
					group by KOD,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR	
						  from #tempYY1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR
						  from #tempYY1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR
		   
		  
					 -- IF EXISTS (SELECT TOP 1 * FROM #tempPivot)
					  BEGIN
						  Set @SQL='
									Select  ID_DERS, DERSAD, KONU,KAZANIM, KOD, '+@Columns2+'
									into ##pivotYY
									from ( Select ACIKLAMA, ID_DERS, DERSAD, KONU,KAZANIM, KOD, YUZDE from #tempPivot ) as PivotData
									PIVOT (MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+')) as PivotResult
									ORDER BY KONU
						   '
						   PRINT @SQL
						   EXEC (@SQL)
					   END
					  -- ELSE
					  -- BEGIN
							--Select ID_DERS=NULL, DERSAD=NULL, KONU=NULL, KOD=NULL into ##pivotYY 
					  -- END


					    Select p.*,
							  ORTALAMA = '%'+CAST(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #tempYYOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD)) AS VARCHAR)
						INTO #TblYY from ##pivotYY p

			
						--SELECT * FROM	#TblYY 
	
	
			END
		
			select(
				select * from(
					select 
					(					
						SELECT * FROM #TblYY
						FOR JSON AUTO
					) as TblListe,
					(					
						Select distinct  ACIKLAMA AS SINAVAD, ID_SINAVRAPOR AS ID_SINAV from #tempYY1
						FOR JSON AUTO
					) as TblSinav
				) as tablo FOR JSON AUTO
			) as tt

			
			drop table IF EXISTS ##pivotYY
			drop table IF EXISTS #TblYY
			drop table IF EXISTS #tempYY1
			drop table IF EXISTS #tempYY
			drop table IF EXISTS #tempYYOrt
			drop table IF EXISTS #tempPivot
		END 

		IF @ISLEM = 3	--	SINAV TURU						
		BEGIN 
			

				DECLARE @DONEMFARKI INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
				IF  (@DONEMFARKI<>0) 
				BEGIN
					DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
					SELECT @ID_KADEME3=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
				END

			

			select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
			INTO #GrupSinavTuru 
			from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
		union 
			select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
		union 
			select 0,15 , 'YAZILI', 'YAZ'
		union 
			select 0,16 , 'YAZILI', 'YAZ'
		union 
			select 0,17 , 'YAZILI', 'YAZ'
		union 
			select 0,18 , 'YAZILI', 'YAZ'


			
			IF EXISTS (SELECT TOP 1 1 FROM #GrupSinavTuru WHERE ID_KADEME3=@ID_KADEME3)
			BEGIN
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	= @ID_KADEME3	--in (SELECT VALUE FROM OPENJSON(@ID_KADEME3)) 
			END
			ELSE
			BEGIN
				SELECT 0 ID_SINAVTURU,@ID_KADEME3 ,'YAZILI' AD, 'YAZ' KISAAD
				UNION ALL 
				select DISTINCT ST.ID_SINAVTURU,@ID_KADEME3 , ST.AD, ST.KISAAD
				from SinavTuru		ST
				JOIN Sinav			S	ON	S.ID_SINAVTURU	= ST.ID_SINAVTURU
				JOIN v3KademeBilgi	KB	ON	KB.ID_KADEME3	= S.ID_KADEME3
				WHERE	KB.ID_KADEME= 4
					AND	S.AKTIF		= 1
					AND S.DURUM		= 2
			END

			drop table #GrupSinavTuru
		END

		IF @ISLEM = 4	--  SınavTürü Derslerini Listele	
		BEGIN	
			IF @ID_SINAVTURUS IS NULL
			BEGIN
				IF @ID_SINAVTURU = 0 
				BEGIN
					select(
						select * from(
							select 
							(
								SELECT DISTINCT 
									 D.ID_DERS
									,D.DERSAD	AS AD
									,D.ID_DERS	AS ID
								FROM Yazili								Y
								JOIN YaziliOgrenci						YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI
																			AND YO.AKTIF		= 1
								JOIN v3OgrenciTum						O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
								JOIN v3SinifTum							S	ON	S.ID_SINIF		= O.ID_SINIF
																			AND S.DONEM			= O.DONEM
								JOIN eokul_v2.dbo.Ders					D	ON	D.ID_DERS		= Y.ID_DERS
																			AND D.ID_KADEME3	= Y.ID_KADEME3
								WHERE	O.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
									AND Y.DONEM = @DONEM
									--AND O.DONEM	= @OGRENCIDONEM
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				
				END
				ELSE 
				BEGIN				
					DECLARE @DONEMFARKI2 INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
					IF  (@DONEMFARKI2<>0) 
					BEGIN
						DECLARE @SIRA2 INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
						SELECT @ID_KADEME3=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA2- @DONEMFARKI2
					END
					select(
						select * from(
							select 
							(
								SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
								FROM	SinavDers			SD	
								JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV							
								JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS
																AND D.ID_KADEME3= S.ID_KADEME3 
								WHERE	S.ID_SINAVTURU	= @ID_SINAVTURU 
									AND S.ID_KADEME3	= @ID_KADEME3
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END
			END
			ELSE 
			BEGIN
				DECLARE @DONEMFARKI3 INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
				IF  (@DONEMFARKI3<>0) 
				BEGIN
					DECLARE @SIRA3 INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
					SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA3- @DONEMFARKI3
				END

				select(
					select * from(
						select 
						(
							SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
							FROM	SinavDers			SD	
							JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV							
							JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS
															AND D.ID_KADEME3= S.ID_KADEME3 
							WHERE (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
								AND S.ID_KADEME3	= @ID_KADEME3
							FOR JSON AUTO
						) as t1								
					) as tablo FOR JSON AUTO
				) as tt
			END
		END 

		IF @ISLEM = 5	--	Etüt Sınav						
		BEGIN
						drop table if exists #TempOgr
						drop table if exists #TempOgr2
						drop table if exists #TempOgr3
						drop table if exists #TempOgrOrt
						drop table if exists #TempOgrOrt2
						drop table if exists #TblOgr
						--drop table if exists #UNITEKOD



		
						SELECT
							 S.ID_SINAV AS ID_SINAVBILGI
							,SO.TCKIMLIKNO
							,SO.AD + ' '+ SO.SOYAD ADSOYAD
							,O.ID_SINIF
							,S.AD AS ACIKLAMA
							,D.DERSAD AS DERSAD
							,D.ID_DERS
							,SUBSTRING(SA.KOD,1,9) AS KOD
							--,SA.KOD AS KOD
							,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=SUBSTRING(SA.KOD,1,6)),'-') AS UNITE
							,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=SUBSTRING(SA.KOD,1,9)),'-') AS KONU
							--,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=SUBSTRING(SA.KOD,1,12)),'-') AS KAZANIM
							,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
							,SUM(1) AS KONUSAYISI
						INTO #TempOgr
						FROM	   [Pusulam].dbo.Sinav S
						INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK)ON SO.ID_SINAV=S.ID_SINAV
						INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF AND ST.DONEM = O.DONEM
						INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
						INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
						INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
						INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
						INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=SD.ID_DERS
						INNER JOIN eokul_v2.dbo.Ders D2 ON D2.DERSAD=D.DERSAD
						INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						WHERE		S.AKTIF			= 1
								AND S.DURUM			= 2
								AND (OZEL=0 OR @OZELSINAVGOR=1)
								--AND S.ID_SINAVTURU	= @ID_SINAVTURU
								--AND S.ID_KADEME3	= @ID_KADEME3
								AND S.DONEM			= @DONEM
								AND (D2.ID_DERS		IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs	= '[]' OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs)))
								AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
								AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
								AND (S.ID_SINAV		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))		OR @ID_SINAVs	= '[]')
								AND SUBSTRING(SA.KOD,1,9)=@KOD
						GROUP BY S.ID_SINAV ,S.AD ,D.DERSAD ,SA.KOD,D.ID_DERS,SO.TCKIMLIKNO,SO.AD,SO.SOYAD,O.ID_SINIF
						ORDER BY S.ID_SINAV,SA.KOD

						--SELECT * FROM #TempOgr


					  Select t2.ID_SINAVBILGI,  
							 t2.ACIKLAMA,
							 t2.DERSAD,
							 t2.KOD,
							 t2.UNITE,
							 t2.KONU,
							 TCKIMLIKNO,ADSOYAD,ID_SINIF,
							 t2.KONUSAYISI,
							 t2.DOGRUSAYISI,
							(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
						into #TempOgr2
						from #TempOgr t2
					order by t2.ID_SINAVBILGI,t2.KOD


					  Select KOD,
							 TCKIMLIKNO,
							 SUM(KONUSAYISI) as KONUSAYISI,
							 SUM(DOGRUSAYISI) as DOGRUSAYISI
						into #TempOgrOrt2
						from #TempOgr2 
					group by KOD,TCKIMLIKNO

					  Select KOD,TCKIMLIKNO,
							 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
						into #TempOgrOrt
						from #TempOgrOrt2 


					  Select t3.ID_SINAVBILGI,  
							 t3.ACIKLAMA,
							 t3.DERSAD,
							 t3.KOD,
							 t3.UNITE,
							 t3.KONU,
							 TCKIMLIKNO,ADSOYAD,ID_SINIF,
							 '%' + Cast(t3.YUZDE as varchar) as YUZDE
						into #TempOgr3
						from #TempOgr2 t3
					order by t3.ID_SINAVBILGI,t3.KOD,t3.DERSAD

	  
		
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVBILGI	
						  from #TempOgr3 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVBILGI

					  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVBILGI
						  from #TempOgr3 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVBILGI
		  
		  
		   
		   
				begin
					drop table if exists ##TempOgrPivot
					drop table if exists ##TblOgr
						Set @SQL='
							Select  DERSAD, KOD, UNITE, KONU,TCKIMLIKNO,ADSOYAD,ID_SINIF, '+@Columns2+' 
							into ##TempOgrPivot 
							from ( Select  ACIKLAMA, DERSAD, KOD, KONU, YUZDE,TCKIMLIKNO,ADSOYAD,ID_SINIF, UNITE from #TempOgr3 ) AS PivotData
							PIVOT ( MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+') ) as PivotResult
							ORDER BY DERSAD,KOD--,UNITE

							SELECT * 
							INTO ##TblOgr
							FROM ##TempOgrPivot
							GROUP BY DERSAD,KOD,UNITE,KONU,TCKIMLIKNO,ADSOYAD,ID_SINIF,'+@Columns+'
							'
							PRINT @SQL
							EXECute (@SQL)
				END
		


				Select  p.*
							,ORT=(SELECT ORTALAMA FROM #TempOgrOrt WHERE KOD = p.KOD AND TCKIMLIKNO=P.TCKIMLIKNO)
							,ORTALAMA =  '%'+ Cast( CAST(
														(SELECT ORTALAMA FROM #TempOgrOrt WHERE KOD = p.KOD AND TCKIMLIKNO=P.TCKIMLIKNO)
												AS DECIMAL(10,2)) as varchar(10))
				INTO #TblOgr from ##TblOgr p
				
				select(
							select * from(
								select 
								(					
									SELECT * FROM #TblOgr
									FOR JSON AUTO
								) as TblListeOgr												
							) as tablo FOR JSON AUTO
						) as tt

				drop table if exists #TempOgr
				drop table if exists #TempOgr2
				drop table if exists #TempOgr3
				drop table if exists #TempOgrOrt
				drop table if exists #TempOgrOrt2
				drop table if exists #TblOgr

				--drop table if exists #UNITEKOD
				drop table if exists ##TempOgrPivot 
				drop table if exists ##TblOgr
		END		

		IF @ISLEM = 6	--	Etüt Yazılı						
		BEGIN
			BEGIN
				drop table IF EXISTS ##pivotYYOgr
				drop table IF EXISTS #TblYYOgr
				drop table IF EXISTS #tempYYOgr1
				drop table IF EXISTS #tempYYOgr
				drop table IF EXISTS #tempYYOgrOrt
				drop table IF EXISTS #tempPivotOgr


		--DECLARE  @DONEM VARCHAR(MAX)='2017'
		--		,@ID_DERSs VARCHAR(MAX)='[850,852,1046]'
		--		,@ID_SUBEs VARCHAR(MAX)='[11]'
		--		,@ID_SINIFs VARCHAR(MAX)='[]'
		--		,@ID_SINAVTURU INT=2
		--		,@ID_KADEME3 INT=18

					SELECT  Y.ID_YAZILI								AS ID_SINAVRAPOR		
							,Y.AD									AS ACIKLAMA
							,YO.TCKIMLIKNO
							,O.ID_SINIF
							,K.AD + ' ' + K.SOYAD					AS ADSOYAD
							,Y.ID_DERS
							,D.DERSAD									AS DERSAD
							,YS.KOD			
							,ISNULL((SELECT AD FROM OkyanusDB.dbo.v3SinavDersUnite SUBSDU WHERE SUBSDU.KOD = SUBSTRING(SDU.KOD, 1, 9)), '')	AS KONU
							,SDU.AD									AS KAZANIM	
							,SUM(YS.PUAN)							AS PUANDEGERI
							,ISNULL(YO.TELAFI, Sum(YOC.PUAN))		AS PUAN 
					INTO #tempYYOgr
					FROM Yazili Y 
					INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
					INNER JOIN V3SinifTum S ON S.ID_SINIF=O.ID_SINIF AND S.DONEM=O.DONEM
					INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=Y.ID_DERS
					INNER JOIN eokul_v2.dbo.Ders D2 ON D2.DERSAD=D.DERSAD
					INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
					WHERE		Y.DONEM = @DONEM AND Y.AKTIF = 1 AND YO.AKTIF = 1
								AND ( ( D2.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSs)) )		OR @ID_DERSs = ''  OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))) 
								AND (O.ID_SUBE			IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))			OR @ID_SUBEs	= '[]')
								AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFs)) )		OR @ID_SINIFs = '' ) 
								AND (Y.ID_YAZILI		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))			OR @ID_SINAVs	= '[]')
								AND SDU.KOD = @KOD
								--AND O.DONEM = @OGRENCIDONEM
					GROUP BY	Y.ID_YAZILI	
								,Y.AD	
								,YO.TCKIMLIKNO
								,O.ID_SINIF
								,K.AD + ' ' + K.SOYAD	
								,Y.ID_DERS
								,D.DERSAD		
								,YS.KOD			
								,SDU.AD	
								,SDU.KOD
								,YO.TELAFI

					
								--AND (D.ID_DERS		IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs	= '[]')
								--AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
								--AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
								--AND (S.ID_SINAV		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))		OR @ID_SINAVs	= '[]')
								--AND SUBSTRING(SA.KOD,1,9)=@KOD


					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   TCKIMLIKNO,ADSOYAD,ID_SINIF,
						   t.ID_DERS,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempYYOgr1
					  from #tempYYOgr t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   TCKIMLIKNO,ADSOYAD,ID_SINIF,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   '%'+ CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempPivotOgr
					  from #tempYYOgr t

					  Select KOD,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
							 ,TCKIMLIKNO
						into #tempYYOgrOrt
						from #tempYYOgr1
					--group by KOD,ID_DERS
					group by KOD,ID_DERS,TCKIMLIKNO

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR	
						  from #tempYYOgr1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR
						  from #tempYYOgr1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR
		   
		  
					 -- IF EXISTS (SELECT TOP 1 * FROM #tempPivotOgr)
					  BEGIN
						  Set @SQL='
									Select  ID_DERS,TCKIMLIKNO,ADSOYAD, DERSAD, KONU UNITE,KAZANIM KONU,ID_SINIF, KOD, '+@Columns2+'
									into ##pivotYYOgr
									from ( Select ACIKLAMA, ID_DERS,TCKIMLIKNO,ID_SINIF,ADSOYAD, DERSAD, KONU,KAZANIM, KOD, YUZDE from #tempPivotOgr ) as PivotData
									PIVOT (MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+')) as PivotResult
									ORDER BY KONU
						   '
						   PRINT @SQL
						   EXEC (@SQL)
					   END
					  -- ELSE
					  -- BEGIN
							--Select ID_DERS=NULL, DERSAD=NULL, KONU=NULL, KOD=NULL into ##pivotYYOgr 
					  -- END


					    Select	 p.*							
								,ORT		= (SELECT avg(ORTALAMA) FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD and p.TCKIMLIKNO=TCKIMLIKNO)
								,ORTALAMA	= '%'+CAST(CONVERT(DECIMAL(10,2),(SELECT avg(ORTALAMA) FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD and p.TCKIMLIKNO=TCKIMLIKNO)) AS VARCHAR)
							--,ORT=(SELECT ORTALAMA FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD)
							--,ORTALAMA = '%'+CAST(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD)) AS VARCHAR)
						INTO #TblYYOgr from ##pivotYYOgr p

			
						--SELECT * FROM	#TblYYOgr 
	
	
			END
		--SELECT * FROM #TblYYOgr
		--Select distinct  ACIKLAMA AS SINAVAD, ID_SINAVRAPOR AS ID_SINAV from #tempYYOgr1
			select(
				select * from(
					select 
					(					
						SELECT * FROM #TblYYOgr
						FOR JSON AUTO
					) as TblListeOgr
				) as tablo FOR JSON AUTO
			) as tt

			
			drop table IF EXISTS ##pivotYYOgr
			drop table IF EXISTS #TblYYOgr
			drop table IF EXISTS #tempYYOgr1
			drop table IF EXISTS #tempYYOgr
			drop table IF EXISTS #tempYYOgrOrt
			drop table IF EXISTS #tempPivotOgr
		END
				
		IF @ISLEM = 7	--	Öğretmen Liste					
		BEGIN
			

				select(
						select * from(
							select 
							(					
								SELECT DISTINCT K.TCKIMLIKNO, K.AD +' ' + K.SOYAD ADSOYAD
								FROM eokul_v2.dbo.DersOgretmen		DO
								JOIN OkyanusDB.DBO.v3Ogretmen		OG	ON	OG.TCKIMLIKNO	= DO.TC_OGRETMEN
								JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO	= DO.TC_OGRETMEN
								JOIN OkyanusDB.DBO.v3SubeGrupSinif	SG	ON	SG.ID_SINIF		= DO.ID_SINIF
								JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS		= DO.ID_DERS
								JOIN eokul_v2.dbo.Ders				DAD	ON	DAD.DERSAD		= D.DERSAD
								WHERE	SG.ID_SUBE	= @ID_SUBE
									AND ((DAD.ID_DERS= @ID_DERS OR @ID_DERS = 0)
										or (@ID_DERS = -99 and DAD.DERSAD = 'Akademi Öğrt.')									
									)
								ORDER BY ADSOYAD
								FOR JSON AUTO
							) as TblListeOgretmen												
						) as tablo FOR JSON AUTO
					) as tt

		END 

		IF @ISLEM = 8	--	ETUT KAYIT						
		BEGIN
			
			--select * from EtutTuru

			declare @tcOgrenciList	varchar(max)= NULL
			declare @kodList		varchar(max)= NULL

			IF @ID_ETUTTURU=1 -- sınav
			BEGIN
				 SELECT CAST(VALUE AS VARCHAR) as KONUKOD INTO #KODLISTESI FROM OPENJSON (@KODs)	 where value !=''

				 SELECT DISTINCT U.KONUKODESKI AS VALUE
				 INTO #KONUKOD
				 FROM UNiTEKARSiLiK U
				 JOIN #KODLISTESI K ON K.KONUKOD=U.KONUKOD 

				 
				Select @kodList		= Coalesce(@kodList		 +',','')+VALUE from ( SELECT CAST(VALUE AS VARCHAR) AS VALUE FROM #KONUKOD) as s
			END
			ELSE -- yazılı
			BEGIN
				Select @kodList		= Coalesce(@kodList		 +',','')+VALUE from ( SELECT CAST(VALUE AS VARCHAR) as VALUE FROM OPENJSON (@KODs)			) as s
			END

			Select @tcOgrenciList	= Coalesce(@tcOgrenciList+',','')+VALUE from ( SELECT CAST(ID_OGRENCI AS VARCHAR) AS VALUE FROM v3Ogrenci WHERE TCKIMLIKNO IN( SELECT CAST(VALUE AS VARCHAR) as VALUE FROM OPENJSON (@TC_OGRENCIs)	)) as s
			--(Select @kodList		= Coalesce(@kodList		 +',','')+VALUE from ( SELECT CAST(VALUE AS VARCHAR) as VALUE FROM OPENJSON (@KODs)			) as s)



			declare @idKullanici int	= (SELECT TOP 1 ID_KULLANICI FROM OKYANUSDB.DBO.V3KULLANiCi WHERE TCKIMLIKNO=@TCKIMLIKNO)
			declare @idOgretmen int		= (SELECT ID_OGRETMEN FROM OkyanusDB.DBO.v3Ogretmen WHERE TCKIMLIKNO=@TC_OGRETMEN) 
			declare @GRUP VARCHAR(MAX)	= (select AD from OkyanusDB.dbo.v3Kademe3 where ID_KADEME3=@ID_KADEME3) 

			DECLARE @TAR DATE=convert(datetime, @TARIH, 103)
			
			print @tcOgrenciList
			print @kodList
			print @idKullanici
			print @idOgretmen
			print @GRUP
			print @TAR


			--SELECT RESULT=NULL INTO #RESULT

			--CREATE TABLE #RESULT (R VARCHAR(MAX))
			--
			--INSERT INTO #RESULT (R)
			--exec eokul_v2.dbo.spEtudON 
			--	@UNITEKODU= @kodList,
			--	@ID_UNITE= 0,
			--	@ID_DERS= @ID_DERS,
			--	@YER= @YER,
			--	@ID_SUBE= @ID_SUBE,
			--	@TARIH= @TAR,
			--	@SAAT= @SAAT,
			--	@ETUD= @ETUT,
			--	@ID_OGRENCILER= @tcOgrenciList,
			--	@GRUP= @GRUP,
			--	@ID_OGRETMEN= @idOgretmen,
			--	@SURE= @SURE,
			--	@ID_ETUD= 0,
			--	@ISLEM=1,
			--	@ID_KULLANICI=@idKullanici,
			--	@OTURUM=@OTURUM
			--		
			----select * from #RESULT
			--IF EXISTS (SELECT R FROM #RESULT WHERE R LIKE 'Etüd oluşturuldu%')
			--BEGIN
			--	--SELECT * FROM Etut
			--	--YAZILI 0
			--	INSERT INTO ETUT ( ETUT,                   TARIH	  , SAAT, SURE, ID_SUBE, YER, ID_DERS, DONEM,KYE_TCKIMLIKNO, ID_KADEME3, TC_OGRETMEN, ID_ETUTTURU)
			--	VALUES			 (@ETUT,convert(datetime, @TARIH, 103) ,@SAAT,@SURE,@ID_SUBE,@YER,@ID_DERS,@DONEM,   @TCKIMLIKNO,@ID_KADEME3,@TC_OGRETMEN,@ID_ETUTTURU)
			--
			--	SET @ID_ETUT=SCOPE_IDENTITY()  
			--	--TC_OGRENCIs : "["10004443130","18005786768","18884111248","22042200002","24992028422","28570024592","37930624396","38284285998","41024147722","54937706078","58519081164"]"
			--	--KODs : ["KİM701002", "KİM701008", "KİM702002", "KİM703005"]
			--
			--	--SELECT * FROM EtutOgrenci
			--	INSERT INTO EtutOgrenci (ID_ETUT,TC_OGRENCI,KATILDI)
			--	SELECT @ID_ETUT,CAST(VALUE AS VARCHAR),0 FROM OPENJSON (@TC_OGRENCIs)
			--
			--	--SELECT * FROM EtutUnite
			--	INSERT INTO EtutUnite (ID_ETUT,KOD)
			--	SELECT @ID_ETUT,CAST(VALUE AS VARCHAR) FROM OPENJSON (@KODs)
			--END 
			--
			--	
			--SELECT R FROM #RESULT


			IF EXISTS (

						SELECT TOP 1 1 FROM Etut E
						WHERE	E.AKTIF			= 1
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
									BETWEEN  
										CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
									AND
										DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
								)
			) 
			BEGIN
				SELECT 'Etüde eklenmek istenen öğretmen aynı tarih ve yakın saatli başka bir etüde kayıtlı.'
			END
			ELSE IF EXISTS (
				SELECT TOP 1 1 
				FROM Etut						E
				JOIN EtutOgrenci				EO	ON	EO.ID_ETUT	= E.ID_ETUT
				JOIN OPENJSON (@TC_OGRENCIs)	O	ON	O.VALUE		= EO.TC_OGRENCI
				WHERE	E.AKTIF	= 1
					AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
									BETWEEN  
										CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
									AND
										DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
								)
			)
			BEGIN
				Declare @OGRENCILER varchar(max)=''
				Select @OGRENCILER = @OGRENCILER + Ad+' '+Soyad+',' from OkyanusDB.dbo.v3Kullanici where TCKIMLIKNO in
					(Select TCKIMLIKNO from OkyanusDB.dbo.v3Ogrenci where TCKIMLIKNO in
						(
						SELECT EO.TC_OGRENCI 
							FROM Etut						E
							JOIN EtutOgrenci				EO	ON	EO.ID_ETUT	= E.ID_ETUT
							JOIN OPENJSON (@TC_OGRENCIs)	O	ON	O.VALUE		= EO.TC_OGRENCI
							WHERE	E.AKTIF	= 1
								AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
												BETWEEN  
													CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
												AND
													DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)))
						))
				Select 'Etüde eklenmek istenen öğrencilerden bazıları aynı tarih ve yakın saatli başka bir etüde kayıtlı.'+@OGRENCILER
			END
			ELSE 
			BEGIN

			

				INSERT INTO ETUT ( ETUT,                   TARIH	  , SAAT, SURE, ID_SUBE, YER, ID_DERS, DONEM,KYE_TCKIMLIKNO, ID_KADEME3, TC_OGRETMEN, ID_ETUTTURU)
				VALUES			 (@ETUT,convert(datetime, @TARIH, 103) ,@SAAT,@SURE,@ID_SUBE,@YER,@ID_DERS,@DONEM,   @TCKIMLIKNO,@ID_KADEME3,@TC_OGRETMEN,@ID_ETUTTURU)

				SET @ID_ETUT=SCOPE_IDENTITY()  
			
				INSERT INTO EtutOgrenci (ID_ETUT,TC_OGRENCI,KATILDI)
				SELECT @ID_ETUT,CAST(VALUE AS VARCHAR),0 FROM OPENJSON (@TC_OGRENCIs)

			
				INSERT INTO EtutUnite (ID_ETUT,KOD)
				SELECT @ID_ETUT,CAST(VALUE AS VARCHAR) FROM OPENJSON (@KODs)

				
				
				SELECT CAST(VALUE AS VARCHAR) TCKIMLIKNO INTO #OGRLIST FROM OPENJSON (@TC_OGRENCIs)
				
				DECLARE @ID_KULLANICI INT =  (SELECT TOP 1 ID_KULLANICI FROM v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)



				--4-öğrencilere mesaj gönderiliyor.
				
				SET @DERSAD=(Select AD as DERSAD from OkyanusDB.dbo.v3SinavDers where ID_DERS=@ID_DERS)
				INSERT INTO eokul_v2.dbo.MesajV2
				(
					KONU	,
					ICERIK	,
					TARIH	
				)
				VALUES
				(
					@DERSAD+' etüdü oluşturuldu',
					'Sizin için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Size tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					GETDATE()
				)
				Declare @ID_MESAJ int
				SET @ID_MESAJ = SCOPE_IDENTITY()

				Insert Into eokul_v2.dbo.MesajDetayV2(ID_MESAJ,ID_GONDEREN,ID_ALAN,OKUNDU,SIL,GONDERENSIL,GUID_ALAN,GUID_GONDEREN,TC_ALAN,TC_GONDEREN)
					 Select @ID_MESAJ,@ID_KULLANICI,k.ID_KULLANICI,0,0,0,
						   '',--(Select GUID from Kullanici where KullaniciId=k.KullaniciId),
						   ''--(Select GUID from Kullanici where KullaniciId=@ID_KULLANICI) --mesajı gönderen kişi
						   ,vo.TCKIMLIKNO,
						   @TCKIMLIKNO
					  from #OGRLIST o
				inner join v3Ogrenci vo on vo.TCKIMLIKNO=o.TCKIMLIKNO
				inner join OkyanusDB.dbo.v3Kullanici K on K.TCKIMLIKNO=vo.TCKIMLIKNO

				--5-velilere mesaj gönderiliyor.
				INSERT INTO eokul_v2.dbo.MesajV2 ( KONU, ICERIK, TARIH )
				VALUES (
					 @DERSAD+' etüdü oluşturuldu',
					'Öğrenciniz için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Öğrencinize tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					GETDATE()
				)
				Declare @ID_MESAJ2 int
				SET @ID_MESAJ2 = SCOPE_IDENTITY()

				Insert Into eokul_v2.dbo.MesajDetayV2(ID_MESAJ,ID_GONDEREN,ID_ALAN,OKUNDU,SIL,GONDERENSIL,GUID_ALAN,GUID_GONDEREN,TC_ALAN,TC_GONDEREN)
				Select 
					 ID_MESAJ	= @ID_MESAJ2
					,ID_GONDEREN= @ID_KULLANICI
					,ID_ALAN	= k.ID_KULLANICI
					,OKUNDU		= 0
					,SIL		= 0
					,GONDERENSIL= 0
					,GUID_ALAN	= ''
					,GUID_GOND	= ''
					,TC_ALAN	= V.TCKIMLIKNO
					,TC_GONDEREN= @TCKIMLIKNO
				from #OGRLIST o
				inner join v3Ogrenci vo on vo.TCKIMLIKNO=o.TCKIMLIKNO
				inner join v3OgrenciVeli v     on v.TCKIMLIKNO_OGR=vo.TCKIMLIKNO
				inner join V3Kullanici k on k.TCKIMLIKNO=v.TCKIMLIKNO
				
				print '4'

				DROP TABLE IF EXISTS #BILDIRIMLIST


				SELECT DISTINCT
					K.TCKIMLIKNO--, OV.TCKIMLIKNO_OGR AS TC_OGRENICI					
				INTO #BILDIRIMLIST
				FROM #OGRLIST O
				INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	OV	WITH(NOLOCK) ON OV.TCKIMLIKNO_OGR	= O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON K.TCKIMLIKNO		= OV.TCKIMLIKNO
				WHERE K.AKTIF = 1
				
				WHILE EXISTS (SELECT TOP 1 1 FROM #BILDIRIMLIST)
				BEGIN
					DECLARE @TC_ALAN VARCHAR(MAX), @YOL VARCHAR(MAX)

					SELECT TOP 1 @TC_ALAN	= TCKIMLIKNO
					FROM #BILDIRIMLIST 
					ORDER BY TCKIMLIKNO 
										
					SET @YOL = (SELECT TOP 1 [PUSULAM SERVER] + '&URL=Etut/EtutProgramiOV' FROM fn_OturumGetir(@TC_ALAN) )

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Etüt'
						,@MESAJ				= 'Öğrencinize Etüt Oluşturulmuştur.'
						,@LINK				= @YOL
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= 'Öğrencinize Etüt Oluşturulmuştur. Detay için Linke Tıklayınız'
						,@LINK_ETIKET		= 'Etüte Git'

					DELETE FROM #BILDIRIMLIST WHERE TCKIMLIKNO = @TC_ALAN
				END
	
				DROP TABLE IF EXISTS #BILDIRIMLIST


				--6-öğretmene mesaj gönderiliyor
				INSERT INTO eokul_v2.dbo.MesajV2 ( KONU, ICERIK, TARIH )
				VALUES (
					@DERSAD+' etüdü oluşturuldu',
					'Sizin için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Size tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					GETDATE()
				)
				Declare @ID_MESAJO int
				SET @ID_MESAJO = SCOPE_IDENTITY()
			
				Insert Into eokul_v2.dbo.MesajDetayV2(ID_MESAJ,ID_GONDEREN,ID_ALAN,OKUNDU,SIL,GONDERENSIL,GUID_ALAN,GUID_GONDEREN,TC_ALAN,TC_GONDEREN)
				Select @ID_MESAJO,@ID_KULLANICI,k.ID_KULLANICI,0,0,0,
					'',--(Select GUID from Kullanici where KullaniciId=k.KullaniciId),
					'',--(Select GUID from Kullanici where KullaniciId=@ID_KULLANICI), --mesajı gönderen kişi				   
					K.TCKIMLIKNO,--(Select TcKimlikNo from Kullanici where KullaniciId=k.KullaniciId)	,		
					@TCKIMLIKNO--,(Select TCKIMLIKNO from OkyanusDB.dbo.v3Kullanici where ID_KULLANICI=@ID_KULLANICI)
				from OkyanusDB.dbo.v3Ogretmen oo
				inner join V3Kullanici k on k.TCKIMLIKNO=oo.TCKIMLIKNO
				where oo.TCKIMLIKNO=@TC_OGRETMEN
				
				print '7'


					----7-öğretmene mail gidiyor.
					--Declare @EMAIL varchar(1000)
					----SET @EMAIL=(Select top 1 isnull(Email,'') from Kullanici where GUID in (Select GUID from Ogretmen where ID_OGRETMEN=@ID_OGRETMEN))
					--SET @EMAIL = (select TOP 1 EMAIL from OkyanusDB.dbo.v3kullanicibilgi where tcKIMLIKNO IN (SELECT tcKIMLIKNO FROM OKYANUSDB.DBO.V3OGRETMEN WHERE TCKIMLIKNO=@TC_OGRETMEN))
					--IF LEN(@EMAIL)>0
					--BEGIN
					-- Insert Into eokul_v2.dbo.MailIcerik(MAIL,KONU,MODUL,ID_BAGLANTI)
					-- Select 'Sizin için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Size tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					--		'İnteraktif Etüt Bildirimi - '+@DERSAD+' Etüdü',
					--		'ETD',
					--		@ID_ETUT 

					-- Declare @ID_MAILICERIK int
					--	 Set @ID_MAILICERIK=(SCOPE_IDENTITY())

					-- Insert Into eokul_v2.dbo.MailDetay(ID_MAILICERIK,MAILADRES,GONDERILDI,ONCELIK)
					--	  Select @ID_MAILICERIK,@EMAIL,0,3
					--END

				  Select 'Etüd oluşturuldu -'+Cast(@ID_ETUT as varchar)



			END
			 

			--ETUTSINAV
			--SELECT * FROM EtutSinav

		END

		IF @ISLEM = 9	--	ETÜT LİSTESİ					
		BEGIN
			IF @ID_ETUT = 0 OR @ID_ETUT IS NULL
			BEGIN
				select(
						select * from(
							select 
							(	
								SELECT  DISTINCT
									 E.ID_ETUT
									,E.ETUT
									,YER
									,D.ID_DERS
									,D.DERSAD
									,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
									,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
									,SAAT ETUTSAAT
									,ADSOYAD	= K.AD+' '+ K.SOYAD
									,E.TC_OGRETMEN
									, SUBSTRING(E.SAAT,1, charindex(':',E.SAAT)-1) SAAT
									, SUBSTRING(E.SAAT, charindex(':',E.SAAT)+1,LEN(E.SAAT)) DAKIKA
									,E.SURE																		
									,E.AKTIF
									--,OGRENCILIST = (
									--					SELECT K.AD+' '+K.SOYAD ADSOYAD,K.TCKIMLIKNO,EO.KATILDI ,SN.AD SINIFAD,SB.AD SUBEAD
									--					FROM v3Kullanici K 
									--					JOIN EtutOgrenci EO ON K.TCKIMLIKNO = EO.TC_OGRENCI 
									--					JOIN v3Ogrenci O  ON O.TCKIMLIKNO = EO.TC_OGRENCI
									--					JOIN v3Sinif SN ON SN.ID_SINIF = O.ID_SINIF
									--					JOIN v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
									--					WHERE EO.ID_ETUT = E.ID_ETUT
									--						AND EO.AKTIF= 1 
									--					ORDER BY ADSOYAD
									--					FOR JSON PATH,INCLUDE_NULL_VALUES  )
								FROM Etut				E
								JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
								JOIN v3SubeYetki		Y	ON	Y.ID_SUBE	= E.ID_SUBE
								WHERE (E.ID_ETUT = @ID_ETUT OR @ID_ETUT=0 OR @ID_ETUT IS NULL)
								--AND E.AKTIF = 1
								AND DONEM	= @DONEM								
								AND Y.TCKIMLIKNO = @TCKIMLIKNO
								ORDER BY TARIH,ADSOYAD,DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
				END
				ELSE
				BEGIN
				select(
						select * from(
							select 
							(	
								SELECT  DISTINCT
									 E.ID_ETUT
									,E.ETUT
									,YER
									,D.ID_DERS
									,D.DERSAD
									,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
									,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
									,SAAT ETUTSAAT
									,ADSOYAD	= K.AD+' '+ K.SOYAD
									,E.TC_OGRETMEN
									, SUBSTRING(E.SAAT,1, charindex(':',E.SAAT)-1) SAAT
									, SUBSTRING(E.SAAT, charindex(':',E.SAAT)+1,LEN(E.SAAT)) DAKIKA
									,E.SURE																		
									,E.AKTIF
									,OGRENCILIST = (
														SELECT K.AD+' '+K.SOYAD ADSOYAD,K.TCKIMLIKNO,EO.KATILDI ,SN.AD SINIFAD,SB.AD SUBEAD
														FROM v3Kullanici K 
														JOIN EtutOgrenci EO ON K.TCKIMLIKNO = EO.TC_OGRENCI 
														JOIN v3Ogrenci O  ON O.TCKIMLIKNO = EO.TC_OGRENCI
														JOIN v3Sinif SN ON SN.ID_SINIF = O.ID_SINIF
														JOIN v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
														WHERE EO.ID_ETUT = E.ID_ETUT
															AND EO.AKTIF= 1 
														ORDER BY ADSOYAD
														FOR JSON PATH,INCLUDE_NULL_VALUES  )
								FROM Etut				E
								JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
								JOIN v3SubeYetki		Y	ON	Y.ID_SUBE	= E.ID_SUBE
								WHERE (E.ID_ETUT = @ID_ETUT OR @ID_ETUT=0 OR @ID_ETUT IS NULL)
								--AND E.AKTIF = 1
								AND DONEM	= @DONEM								
								AND Y.TCKIMLIKNO = @TCKIMLIKNO
								ORDER BY TARIH,ADSOYAD,DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
				END
		END

		IF @ISLEM = 10	--	ETÜT ÖĞRENCİ KATILIM			
		BEGIN
			UPDATE EO
			SET	KATILDI = @KATILDI
			FROM EtutOgrenci EO
			WHERE	ID_ETUT		= @ID_ETUT 
				AND TC_OGRENCI	= @TC_OGRENCI

			SELECT 1
		END

		IF @ISLEM = 11	--	ETÜT ÖĞRENCİ LİST				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT K.TCKIMLIKNO
									, @ID_ETUT ID_ETUT
									, K.AD+' '+ K.SOYAD ADSOYAD
									, CASE WHEN EO.TC_OGRENCI IS NOT NULL THEN 1 ELSE 0 END KATILACAK
								FROM v3Ogrenci			O 
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN EtutOgrenci	EO	ON	EO.TC_OGRENCI	= O.TCKIMLIKNO
															AND EO.ID_ETUT		= @ID_ETUT
															AND EO.AKTIF		= 1
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END

		IF @ISLEM = 12	--	ETÜT ÖĞRENCİ EKLE				
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1  FROM EtutOgrenci WHERE TC_OGRENCI = @TC_OGRENCI AND ID_ETUT = @ID_ETUT)
			BEGIN
				INSERT INTO EtutOgrenci(ID_ETUT,TC_OGRENCI,KATILDI)
				VALUES(@ID_ETUT , @TC_OGRENCI, 0)
			END

			UPDATE EtutOgrenci SET AKTIF = @KATILACAK,KATILDI = 0  WHERE TC_OGRENCI = @TC_OGRENCI AND ID_ETUT = @ID_ETUT 
			

			SELECT 1
		END

		IF @ISLEM = 13	--	SUBE KADEME DERS LİSTESİ		
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT D.DERSAD
								FROM eokul_v2.dbo.DersOgretmen		DO
								JOIN v3Sinif						SN	ON	SN.ID_SINIF = DO.ID_SINIF 
								JOIN OkyanusDB.dbo.v3SubeGrupSinif	GS	ON	GS.ID_SINIF = SN.ID_SINIF
								JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS	= DO.ID_DERS
								--JOIN v3Kullanici					K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE	ID_SUBE			= @ID_SUBE
									AND GS.ID_KADEME3	= @ID_KADEME3
								ORDER BY DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END
		
		IF @ISLEM = 14	--	SUBE KADEME DERS ÖĞRETMEN LİSTE	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT K.AD + ' ' + K.SOYAD ADSOYAD,TCKIMLIKNO
								FROM eokul_v2.dbo.DersOgretmen		DO
								JOIN v3Sinif						SN	ON	SN.ID_SINIF = DO.ID_SINIF 
								JOIN OkyanusDB.dbo.v3SubeGrupSinif	GS	ON	GS.ID_SINIF = SN.ID_SINIF
								JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS	= DO.ID_DERS
								JOIN v3Kullanici					K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE	ID_SUBE			= @ID_SUBE
									AND GS.ID_KADEME3	= @ID_KADEME3
									AND DERSAD			= @DERSAD
								ORDER BY ADSOYAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END
				
		IF @ISLEM = 15	--	ETÜT DÜZELT						
		BEGIN
				SELECT
					 ID_ETUT				AS T_ID_ETUT		
					,ETUT					AS T_ETUT
					,YER					AS T_YER
					,REPLACE(TARIH,'/','.') AS T_TARIH
					,SAAT+':'+DAKIKA		AS T_SAAT
					,SURE					AS T_SURE
					,TC_OGRETMEN			AS T_TC_OGRETMEN
				INTO #ETUT
				FROM OPENJSON (@ETUTJSON) 
				WITH (
					ID_ETUT		INT '$.ID_ETUT',
					ETUT		VARCHAR(MAX) '$.ETUT',
					YER			VARCHAR(MAX) '$.YER',
					TARIH		VARCHAR(MAX) '$.TARIH',
					SAAT		VARCHAR(MAX) '$.SAAT',
					DAKIKA		VARCHAR(MAX) '$.DAKIKA',
					SURE		VARCHAR(MAX) '$.SURE',
					TC_OGRETMEN VARCHAR(MAX) '$.TC_OGRETMEN'
				)
				
			SELECT @TC_OGRETMEN = T_TC_OGRETMEN, @TARIH = T_TARIH, @SAAT = T_SAAT,@ID_ETUT = T_ID_ETUT FROM #ETUT
			IF EXISTS (

						SELECT TOP 1 1 FROM Etut E
						WHERE	E.AKTIF			= 1
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND E.ID_ETUT		!=@ID_ETUT
							AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
									BETWEEN  
										CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
									AND
										DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
								)
			) 
			BEGIN
				SELECT 0
			END
			ELSE
			BEGIN
				UPDATE E
				SET  ETUT		= T_ETUT
					,YER		= T_YER
					,TARIH		= T_TARIH
					,SAAT		= T_SAAT
					,SURE		= T_SURE
					,TC_OGRETMEN= T_TC_OGRETMEN
				FROM Etut	E
				JOIN #ETUT	T	ON	T.T_ID_ETUT =E.ID_ETUT

				SELECT 1
			END

				DROP TABLE #ETUT
		END

		IF @ISLEM = 16	--	ETÜT AKTİF PASİF				
		BEGIN
			
			

			IF NOT EXISTS (	SELECT TOP 1 1
						FROM Etut	E
						JOIN Etut	G	ON	
									CAST(CAST(G.TARIH AS varchar)+' '+ G.SAAT  AS datetime2)
								BETWEEN  
									CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
								AND
									DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
									AND G.ID_ETUT != E.ID_ETUT
									AND G.TC_OGRETMEN = E.TC_OGRETMEN
						WHERE	E.ID_ETUT = @ID_ETUT
							AND G.AKTIF = 1
							AND E.AKTIF = 0
						 )
			BEGIN
				UPDATE E
				SET AKTIF = CASE WHEN AKTIF = 1 THEN 0 ELSE 1 END
				FROM Etut E
				WHERE E.ID_ETUT = @ID_ETUT

				SELECT 1
			END
			ELSE
			BEGIN
				SELECT 0
			END
		END

		IF @ISLEM = 17	--	ETÜT DETAY GETİR				
		BEGIN
			
			SELECT(
				SELECT	 E.ID_ETUT
						,E.ETUT
						,TARIH = CONVERT(VARCHAR, E.TARIH, 104)
						,E.SAAT
						,E.SURE
						,E.YER
						,ET.ETUT_TURU
						,ADSOYAD	= CONCAT_WS(' ', K.AD, K.SOYAD)
						,DERSAD
						,UNITELIST	= (
							SELECT SDU.KOD, SDU.AD
							FROM EtutUnite						EU	
							JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON	SDU.KOD			= EU.KOD
							WHERE EU.ID_ETUT = E.ID_ETUT
							FOR JSON PATH
						)
				FROM Etut					E
				JOIN EtutTuru				ET	ON	ET.ID_ETUT_TURU	= E.ID_ETUTTURU
				LEFT JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= E.TC_OGRETMEN
				JOIN eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
				WHERE E.ID_ETUT	= @ID_ETUT
				FOR JSON PATH
			)
			
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_EtutProgramiOV]    Script Date: 22.11.2021 10:49:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_EtutProgramiOV]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= '',
	@AKTIFDONEM			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@KOD				VARCHAR(MAX)	= '',
	@ETUT				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@SAAT				VARCHAR(MAX)	= NULL,
	@SURE				VARCHAR(MAX)	= NULL,	
	@YER				VARCHAR(MAX)	= NULL,	
	@ID_ETUTTURU		INT				= NULL,
	@TC_OGRENCIs		VARCHAR(MAX)	= NULL,		
	@KODs				VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ETUTJSON			VARCHAR(MAX)	= NULL,
	@BAS_TARIH			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@KATILDI			BIT				= 0,
	@KATILACAK			BIT				= 0,
	@IP					VARCHAR(50)	= NULL




	--ETUT,TARIH,SAAT,SURE,ID_SUBE,YER,ID_DERS,DONEM,AKTIF,KYE_TCKIMLIKNO,ID_KADEME3,TC_OGRETMEN,ID_ETUTTURU
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,AKTIFDONEM					= @AKTIFDONEM		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,ID_SINAVs					= @ID_SINAVs		
			,KOD						= @KOD			
			,ETUT						= @ETUT			
			,TARIH						= @TARIH			
			,SAAT						= @SAAT			
			,SURE						= @SURE			
			,YER						= @YER			
			,ID_ETUTTURU				= @ID_ETUTTURU	
			,TC_OGRENCIs				= @TC_OGRENCIs	
			,KODs						= @KODs			
			,DERSAD						= @DERSAD			
			,ETUTJSON					= @ETUTJSON		
			,BAS_TARIH					= @BAS_TARIH		
			,ID_ETUT					= @ID_ETUT		
			,KATILDI					= @KATILDI		
			,KATILACAK					= @KATILACAK		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY  
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	 
	

	IF @ID_LOG > 1
	BEGIN
		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		
		SELECT @AKTIFDONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		PRINT @DONEM
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
			PRINT @DONEM
		END

		IF @ISLEM = 1	--	SABİT ETÜT LİSTESİ				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										  TC_OGRETMEN	
										 ,D.ID_DERS	
										 ,ID_GUN		
										 ,DERSSAAT	
										 ,O.ID_SINIF	
										 ,KYE_TCKIMLIKNO
										 ,ADSOYAD		= K.AD+' '+K.SOYAD
										 ,D.DERSAD
								FROM EtutSabit			ES
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = ES.TC_OGRETMEN
								JOIN eokul_v2.DBO.Ders	D	ON	D.ID_DERS	 = ES.ID_DERS
								JOIN v3Ogrenci			O	ON	O.ID_SINIF	 = ES.ID_SINIF								
								WHERE O.TCKIMLIKNO =@TC_OGRENCI
								ORDER BY ID_GUN,DERSSAAT
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
				
		IF @ISLEM = 2	--	SINAV ETÜT LİSTESİ				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT  DISTINCT
									 E.ID_ETUT
									,E.ETUT
									,YER									
									,D.DERSAD
									,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
									,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
									,ADSOYAD	= K.AD+' '+ K.SOYAD									
									,SAAT
									,CASE WHEN GETDATE()>CAST(TARIH AS datetime) THEN EO.KATILDI ELSE NULL END KATILDI 
								FROM Etut				E
								JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
								JOIN EtutOgrenci		EO	ON	EO.ID_ETUT	= E.ID_ETUT
								WHERE	EO.TC_OGRENCI	= @TC_OGRENCI
									AND DONEM			= @DONEM
									AND E.AKTIF			= 1																		
								ORDER BY ADSOYAD,DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END
						
		IF @ISLEM = 3	--	SINAV ETÜT GRAFİĞİ				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT COUNT(1) TOPLAMETUTSAYISI
									, (SELECT COUNT(1) FROM EtutOgrenci O WHERE O.ID_ETUT_OGRENCI = EO.ID_ETUT_OGRENCI AND O.AKTIF=1 AND O.KATILDI = 1)  KATILIMSAYISI
								FROM Etut			E
								JOIN EtutOgrenci	EO	ON	EO.ID_ETUT	= E.ID_ETUT
								WHERE	EO.TC_OGRENCI = @TC_OGRENCI
									AND	GETDATE()>CAST(TARIH AS datetime) 
								GROUP BY EO.ID_ETUT_OGRENCI
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_EtutSabitOlustur]    Script Date: 22.11.2021 10:49:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_EtutSabitOlustur]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@ETUTLIST			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@IP					VARCHAR(50)	= NULL


AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,TC_OGRETMEN				= @TC_OGRETMEN
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,ETUTLIST					= @ETUTLIST	
			,ID_ETUT					= @ID_ETUT	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
 
	IF @ID_LOG > 1
	BEGIN
		
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		END

		IF @ISLEM = 1	--	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										 K.AD+' '+K.SOYAD ADSOYAD
										,D.DERSAD
										,k.TCKIMLIKNO
										,D.ID_DERS
								FROM eokul_v2.dbo.DersOgretmen	DO
								JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS	= DO.ID_DERS
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE DO.ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
		IF @ISLEM = 2
		BEGIN
			delete from EtutSabit
			where ID_SINIF = @ID_SINIF

			INSERT INTO EtutSabit (TC_OGRETMEN,ID_DERS,ID_GUN,DERSSAAT,LINK,SIFRE,ID_SINIF,KYE_TCKIMLIKNO)
			SELECT
				 TC_OGRETMEN= JSON_VALUE(J.VALUE,'$.NESNE.TCKIMLIKNO')		
				,ID_DERS	= JSON_VALUE(J.VALUE,'$.NESNE.ID_DERS')	
				,GUN		= JSON_VALUE(J.VALUE,'$.NESNE.GUN')		
				,DERSSAAT	= JSON_VALUE(J.VALUE,'$.NESNE.DERSSAAT')	
				,LINK		= JSON_VALUE(J.VALUE,'$.NESNE.LINK')
				,SIFRE		= JSON_VALUE(J.VALUE,'$.NESNE.SIFRE')
				,ID_SINIF	= @ID_SINIF 
				,TCKIMLIKNO	= @TCKIMLIKNO
				FROM OPENJSON (@ETUTLIST) AS J
			WHERE JSON_VALUE(J.VALUE,'$.NESNE.ID_DERS')>0

							
				
			 			 
			SELECT 1 
		END
		IF @ISLEM = 3	--	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										  TC_OGRETMEN	
										 ,D.ID_DERS	
										 ,ID_GUN		
										 ,DERSSAAT	
										 ,ID_SINIF	
										 ,KYE_TCKIMLIKNO
										 ,ADSOYAD		= K.AD+' '+K.SOYAD
										 ,D.DERSAD
										,LINK			= ISNULL(ES.LINK,'') 
										,SIFRE		= ISNULL(ES.SIFRE,'')
								FROM EtutSabit			ES
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = ES.TC_OGRETMEN
								JOIN eokul_v2.DBO.Ders	D	ON	D.ID_DERS	 = ES.ID_DERS
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ID_GUN,DERSSAAT
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
		
			
		
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_EtutSinifRapor]    Script Date: 22.11.2021 10:49:45 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_EtutSinifRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@BASLANGIC_TARIH	VARCHAR(25)		= NULL,
	@BITIS_TARIH		VARCHAR(25)		= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM				 	= @ISLEM			
			,TCKIMLIKNO			 	= @TCKIMLIKNO		
			,OTURUM				 	= @OTURUM			
			,ID_MENU			 	= @ID_MENU		
			,ID_SINIF			 	= @ID_SINIF		
			,TC_OGRETMEN		 	= @TC_OGRETMEN	
			,DONEM				 	= @DONEM			
			,BASLANGIC_TARIH	 	= @BASLANGIC_TARIH
			,BITIS_TARIH		 	= @BITIS_TARIH	
			,SQLJSON			 	= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	ETÜT SINIF LIST
		BEGIN
		
			DROP TABLE IF EXISTS #LISTE
			DROP TABLE IF EXISTS #OGRETMENETUTLERI
			DROP TABLE IF EXISTS #OGRETMENLIST
			
			SELECT DISTINCT O.TCKIMLIKNO, O.BRANS, ADSOYAD = K.AD + ' ' + K.SOYAD
			INTO #OGRETMENLIST
			FROM eokul_v2.dbo.DersOgretmen	DO
			JOIN OkyanusDB.dbo.v3Ogretmen	O	ON	O.TCKIMLIKNO	= DO.TC_OGRETMEN
			JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
			WHERE	DO.ID_SINIF = @ID_SINIF
				AND DONEMKOD = @DONEM
		UNION	
			SELECT DISTINCT O.TCKIMLIKNO,O.BRANS, ADSOYAD = K.AD + ' ' + K.SOYAD
			FROM OkyanusDB.dbo.v3DersProgram	DP
			JOIN OkyanusDB.dbo.v3Ogretmen		O	ON	O.TCKIMLIKNO	= DP.TCKIMLIKNO
			JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
			WHERE	DP.ID_SINIF = @ID_SINIF
	
			SELECT DISTINCT E.TC_OGRETMEN, E.ID_ETUT, CAST( E.SURE AS INT) SURE
			INTO #OGRETMENETUTLERI
			FROM Etut			E	  
			JOIN EtutOgrenci	EO	ON	EO.ID_ETUT		= E.ID_ETUT
			JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= EO.TC_OGRENCI
			WHERE	O.ID_SINIF		= @ID_SINIF
				AND CAST(E.TARIH AS date) >= CAST(@BASLANGIC_TARIH AS date)
				AND CAST(E.TARIH AS date) <= CAST(@BITIS_TARIH	   AS date)
	
			DECLARE @SUBEAD VARCHAR(100),@SINIFAD VARCHAR(100)

			SELECT @SUBEAD = SB.AD, @SINIFAD = SN.AD FROM OkyanusDB.dbo.v3SubeGrupSinif GS 
			JOIN v3Sube	SB ON SB.ID_SUBE = GS.ID_SUBE 
			JOIN v3Sinif SN	ON SN.ID_SINIF = GS.ID_SINIF
			WHERE GS.ID_SINIF = @ID_SINIF
	
			SELECT	 TC_OGRETMEN= OL.TCKIMLIKNO
					,ADSOYAD	= OL.ADSOYAD
					,BRANS		= OL.BRANS
					,SUBEAD		= @SUBEAD
					,SINIFAD	= @SINIFAD
					,SURE		= ISNULL(SUM(OE.SURE),0) 
			INTO #LISTE
			FROM #OGRETMENLIST			OL
			LEFT JOIN #OGRETMENETUTLERI	OE	ON	OE.TC_OGRETMEN	= OL.TCKIMLIKNO
			GROUP BY OL.TCKIMLIKNO, OL.BRANS, OL.ADSOYAD


				select(
						select * from(
							select 
							(	
								SELECT * FROM #LISTE
								ORDER BY ADSOYAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
					
			DROP TABLE IF EXISTS #LISTE
			DROP TABLE IF EXISTS #OGRETMENETUTLERI
			DROP TABLE IF EXISTS #OGRETMENLIST
		END

		IF @ISLEM = 2	--	ETÜT ÖĞRETMEN DETAY
		BEGIN
			SELECT (
				SELECT * FROM (
					SELECT (
						SELECT DISTINCT
							 E.ID_ETUT
							,E.ETUT
							,ETUT_TARIH = CONVERT(varchar(MAX), E.TARIH,104) +' '+E.SAAT 
							,E.YER
							,SURE
							--,ISNULL(EU.KOD,'')KOD
							, (SELECT U.AD UNITE FROM EtutUnite EU JOIN v3SinavDersUnite U ON U.KOD = EU.KOD WHERE EU.ID_ETUT = E.ID_ETUT  FOR JSON AUTO)  AS 'EU'
							,E.TARIH
						FROM Etut					E
						JOIN EtutOgrenci			EO	ON	EO.ID_ETUT		= E.ID_ETUT
						JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= EO.TC_OGRENCI
						--LEFT JOIN EtutUnite			EU	ON	EU.ID_ETUT		= E.ID_ETUT
						--LEFT JOIN v3SinavDersUnite	U	ON	U.KOD			= EU.KOD
						WHERE	O.ID_SINIF		= @ID_SINIF
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND CAST(E.TARIH AS date) >= CAST(@BASLANGIC_TARIH AS date)
							AND CAST(E.TARIH AS date) <= CAST(@BITIS_TARIH	   AS date)
						ORDER BY E.TARIH
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS UNITELISTE ,
					(	
						SELECT DISTINCT  
							 E.ID_ETUT
							,EO.TC_OGRENCI
							,EO.KATILDI
							,ADSOYAD = K.AD + ' ' + K.SOYAD
						FROM Etut			E
						JOIN EtutOgrenci	EO	ON	EO.ID_ETUT		= E.ID_ETUT
						JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= EO.TC_OGRENCI
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						WHERE	O.ID_SINIF		= @ID_SINIF
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND CAST(E.TARIH AS date) >= CAST(@BASLANGIC_TARIH AS date)
							AND CAST(E.TARIH AS date) <= CAST(@BITIS_TARIH	   AS date)
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS OGRENCILISTE
				) AS XX	
				FOR JSON AUTO, INCLUDE_NULL_VALUES
			) AS X
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO


USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_EtutTakvimi]    Script Date: 22.11.2021 10:50:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_EtutTakvimi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= '',
	@AKTIFDONEM			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@KOD				VARCHAR(MAX)	= '',
	@ETUT				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@SAAT				VARCHAR(MAX)	= NULL,
	@SURE				VARCHAR(MAX)	= NULL,	
	@YER				VARCHAR(MAX)	= NULL,	
	@ID_ETUTTURU		INT				= NULL,
	@TC_OGRENCIs		VARCHAR(MAX)	= NULL,		
	@KODs				VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ETUTJSON			VARCHAR(MAX)	= NULL,
	@BAS_TARIH			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@KATILDI			BIT				= 0,
	@OGRETMEN			BIT				= 0,
	@SABITETUT			BIT				= 0,
	@IP					VARCHAR(50)	= NULL




	--ETUT,TARIH,SAAT,SURE,ID_SUBE,YER,ID_DERS,DONEM,AKTIF,KYE_TCKIMLIKNO,ID_KADEME3,TC_OGRETMEN,ID_ETUTTURU
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,AKTIFDONEM					= @AKTIFDONEM		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,ID_SINAVs					= @ID_SINAVs		
			,KOD						= @KOD			
			,ETUT						= @ETUT			
			,TARIH						= @TARIH			
			,SAAT						= @SAAT			
			,SURE						= @SURE			
			,YER						= @YER			
			,ID_ETUTTURU				= @ID_ETUTTURU	
			,TC_OGRENCIs				= @TC_OGRENCIs	
			,KODs						= @KODs			
			,DERSAD						= @DERSAD			
			,ETUTJSON					= @ETUTJSON		
			,BAS_TARIH					= @BAS_TARIH		
			,ID_ETUT					= @ID_ETUT		
			,KATILDI					= @KATILDI		
			,OGRETMEN					= @OGRETMEN		
			,SABITETUT					= @SABITETUT		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	

	IF @ID_LOG > 1
	BEGIN
		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		
		SELECT @AKTIFDONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		PRINT @DONEM
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
			PRINT @DONEM
		END

						
		IF @ISLEM = 1	--	ETÜT TAKVİMİ					
		BEGIN
				
			DECLARE @DATE DATE = CONVERT(DATE, @BAS_TARIH, 104), @FIRSTDAY DATE, @LASTDAY DATE, @FIRSTWEEKDAY INT, @LASTWEEKDAY INT, @STARTDATE DATETIME, @ENDDATE DATETIME

			DROP TABLE IF EXISTS #DateList

			SELECT @FIRSTDAY = DATEADD(MONTH, DATEDIFF(MONTH, 0, @DATE), 0)
			SELECT @LASTDAY  = DATEADD(S, -1, DATEADD(MM, DATEDIFF(M, 0, @DATE) + 1, 0))

			SELECT @FIRSTWEEKDAY = DATEPART(DW, @FIRSTDAY)
			SELECT @LASTWEEKDAY  = DATEPART(DW, @LASTDAY)


			SELECT @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, @FIRSTWEEKDAY - 1	, @FIRSTDAY), 0)
			SELECT @ENDDATE	  = DATEADD(DAY, DATEDIFF(DAY, -(7 - @LASTWEEKDAY)	, @LASTDAY ), 0)

			;WITH DateList
			AS
			(
			SELECT @STARTDATE [Date]
			UNION ALL
			SELECT [Date] + 1 FROM DateList WHERE [Date] < @ENDDATE
			)
			SELECT [Date] = CAST([Date] AS DATE) INTO #DateList FROM DateList option (maxrecursion 0);

			IF @TC_OGRETMEN = '' OR @TC_OGRETMEN IS NULL
			BEGIN
				SELECT
			(
				SELECT 
					CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
					,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
					,GUN	= DAY(Date)
					,YIL	= YEAR(Date)
					,GUNAD	= DATENAME(DW, Date) 
					,AYAD	= DATENAME(MONTH, Date)
					,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
					,(
						SELECT * FROM (
								SELECT DISTINCT
									 E.ETUT								AS 'AD'
									,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BAS_TARIH'
									,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BIT_TARIH'
									,'#5C9BD1'							AS 'RENK'
									,E.ID_ETUT							AS 'ID_ETUT'
									,0									AS 'SABITETUT'				
									FROM Etut			E
									JOIN EtutOgrenci	EO	ON	EO.ID_ETUT = E.ID_ETUT
									WHERE	E.AKTIF		= 1
										AND EO.AKTIF	= 1
										AND TC_OGRENCI	= @TC_OGRENCI
										AND CONVERT(date,E.TARIH)	= CONVERT(date,DL.DATE)
							UNION ALL
								SELECT DISTINCT
									 D.DERSAD												AS 'AD'
									,CONVERT(VARCHAR(10), E.KYE_TARIH, 104)					AS 'BAS_TARIH'
									,CONVERT(VARCHAR(10), DATEADD(YEAR,1,E.KYE_TARIH), 104)	AS 'BIT_TARIH'
									,'#E43A45'												AS 'RENK'
									,E.ID_ETUTSABIT											AS 'ID_ETUT'
									,1														AS 'SABITETUT'				
									FROM EtutSabit			E		
									JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = E.ID_DERS	
									JOIN v3Ogrenci			O	ON	O.ID_SINIF= E.ID_SINIF			
									WHERE	E.ID_GUN	=DATEPART(weekday,CONVERT(date,DL.DATE)) 
										AND O.TCKIMLIKNO=@TC_OGRENCI

						) AS SS
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)AS 'Liste'
				FROM		#DateList		DL
				ORDER BY DL.Date ASC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS J
			END
			ELSE
			BEGIN
				SELECT
				(
					SELECT 
						CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
						,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
						,GUN	= DAY(Date)
						,YIL	= YEAR(Date)
						,GUNAD	= DATENAME(DW, Date) 
						,AYAD	= DATENAME(MONTH, Date)
						,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
						,(
							SELECT * FROM (
									SELECT DISTINCT
										 E.ETUT								AS 'AD'
										,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BIT_TARIH'
										,'#5C9BD1'							AS 'RENK'
										,E.ID_ETUT							AS 'ID_ETUT'
										,0									AS 'SABITETUT'				
										FROM Etut			E										
										WHERE	E.AKTIF		= 1											
											AND TC_OGRETMEN	= @TC_OGRETMEN
											AND CONVERT(date,E.TARIH)	= CONVERT(date,DL.DATE)
								UNION ALL
									SELECT DISTINCT
										 D.DERSAD												AS 'AD'
										,CONVERT(VARCHAR(10), E.KYE_TARIH, 104)					AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), DATEADD(YEAR,1,E.KYE_TARIH), 104)	AS 'BIT_TARIH'
										,'#E43A45'												AS 'RENK'
										,E.ID_ETUTSABIT											AS 'ID_ETUT'
										,1														AS 'SABITETUT'				
										FROM EtutSabit			E		
										JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = E.ID_DERS	
										JOIN v3Ogrenci			O	ON	O.ID_SINIF= E.ID_SINIF			
										WHERE	E.ID_GUN	=DATEPART(weekday,CONVERT(date,DL.DATE)) 
											AND E.TC_OGRETMEN=@TC_OGRETMEN

							) AS SS
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS 'Liste'
					FROM		#DateList		DL
					ORDER BY DL.Date ASC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			DROP TABLE #DateList
		END

		IF @ISLEM = 2	--	ETÜT DETAY				
		BEGIN
			IF @SABITETUT = 1
			BEGIN
				SELECT  DISTINCT
					 E.ID_ETUTSABIT AS ID_ETUT
					,DERSAD			AS ETUT
					,S.AD			AS YER
					,D.ID_DERS
					,D.DERSAD
					,null			AS UNITELIST 
					,G.GUN			AS TARIH
					,K.AD+' '+ K.SOYAD	AS ADSOYAD
					,E.TC_OGRETMEN
					,E.DERSSAAT			AS SAAT
					,40					AS SURE					
				FROM EtutSabit			E
				JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
				JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
				JOIN v3Sinif			S	ON	S.ID_SINIF	= E.ID_SINIF
				JOIN Gun				G	ON	G.ID_GUN	= E.ID_GUN
				WHERE E.ID_ETUTSABIT= @ID_ETUT						
				ORDER BY ADSOYAD,DERSAD
				FOR JSON PATH,INCLUDE_NULL_VALUES
			END
			ELSE	
			BEGIN
				SELECT  DISTINCT
					 E.ID_ETUT
					,E.ETUT
					,YER
					,D.ID_DERS
					,D.DERSAD
					,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
					,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
					,ADSOYAD	= K.AD+' '+ K.SOYAD
					,E.TC_OGRETMEN
					,SAAT					
					,E.SURE					
				FROM Etut				E
				JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
				JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
				WHERE E.ID_ETUT = @ID_ETUT
				AND E.AKTIF = 1				
				ORDER BY ADSOYAD,DERSAD
				FOR JSON PATH,INCLUDE_NULL_VALUES
			END
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Fatura]    Script Date: 22.11.2021 10:50:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Fatura]
	@ISLEM			INT				= NULL,
	@TCKIMLIKNO		VARCHAR(11)		= NULL,
	@OTURUM			VARCHAR(36)		= NULL,
	@ID_MENU		INT				= NULL,

	@TOPLAMTUTAR	FLOAT			= NULL,
	@ID				INT				= NULL,
	@ID_FATURAODEME	VARCHAR(MAX)	= NULL,
	@CEVAP			BIT				= NULL,
	@SQLJSON		NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,ID				= @ID
				,ID_FATURAODEME	= @ID_FATURAODEME
				,TOPLAMTUTAR	= @TOPLAMTUTAR
				,CEVAP			= @CEVAP
				,SQLJSON		= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		
		IF	(	@ISLEM = 3 
			AND NOT EXISTS(	SELECT TOP 1 1 
						FROM OPENJSON(@SQLJSON) 
						WITH (	APIKEY	VARCHAR(MAX)) J
						WHERE APIKEY = 'y78DKXNkkQCND34uLzPo8jIBCkxaPIiq')
			)
		BEGIN
			 SET @_ID_LOG = 0
			 RAISERROR ('HATA' , 16 , 1)
		END

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	FATURA ÖDEME EKLE			
			BEGIN
				DROP TABLE IF EXISTS #TEMP1
				SET @ID_FATURAODEME = 0

				SELECT ID, TUTAR
				INTO #TEMP1
				FROM OPENJSON(@SQLJSON)
				WITH (
					hr		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.hr) 
				WITH(
					ID		INT,
					TUTAR	FLOAT,
					SECILI	BIT
				)
				WHERE SECILI = 1

				IF NOT EXISTS (
					SELECT TOP 1 1
					FROM FaturaOdeme		FO
					JOIN FaturaOdemeDetay	D	ON	D.ID_FATURAODEME	= FO.ID_FATURAODEME
					JOIN #TEMP1				T	ON	T.ID				= D.ID_FATURA
					WHERE	CEVAP IS NULL
						OR	CEVAP = 1	)
				BEGIN

					DECLARE @ID_TABLE TABLE (ID INT)

					INSERT INTO FaturaOdeme (TUTAR, KYE_TCKIMLIKNO)
					OUTPUT inserted.ID_FATURAODEME INTO @ID_TABLE
					VALUES (@TOPLAMTUTAR, @TCKIMLIKNO)

					SET @ID_FATURAODEME = (SELECT ID FROM @ID_TABLE)

					INSERT INTO FaturaOdemeDetay(ID_FATURAODEME, ID_FATURA, TUTAR_KR)
					SELECT @ID_FATURAODEME, ID, TUTAR
					FROM OPENJSON(@SQLJSON)
					WITH (
						hr		NVARCHAR(MAX) AS JSON
					) AS J
					CROSS APPLY OPENJSON(J.hr) 
					WITH(
						ID		INT,
						TUTAR	FLOAT,
						SECILI	BIT
					)
					WHERE SECILI = 1

				END
				--RETURN
				SELECT @ID_FATURAODEME ID

				DROP TABLE IF EXISTS #TEMP1
				
			END

			--IF @ISLEM = 2	--	FATURA ÖDEME CEVAP SET		
			--BEGIN				
			--	UPDATE FaturaOdeme SET
			--		CEVAP = @CEVAP
			--	WHERE ID_FATURAODEME = @ID_FATURAODEME
			--END

			IF @ISLEM = 3	--	FATURA ÖDEME CEVAP			
			BEGIN
			
			
				UPDATE FO SET
					FO.CEVAP	= J.CEVAP,
					FO.TUTAR_KR	= J.AMOUNT
				FROM FaturaOdeme	FO
				JOIN OPENJSON(@SQLJSON) 
				WITH (
					ID		VARCHAR(MAX),
					CEVAP	BIT,
					AMOUNT	BIGINT
				) AS J ON SUBSTRING(J.ID, 4, CHARINDEX('_', J.ID) - 4) = FO.ID_FATURAODEME

				
				IF EXISTS (	SELECT TOP 1 1 
							FROM FaturaOdeme FO							
							JOIN OPENJSON(@SQLJSON) 
							WITH (
								ID		VARCHAR(MAX)
							) AS J ON cast(SUBSTRING(J.ID, 4, CHARINDEX('_', J.ID) - 4) as int) = FO.ID_FATURAODEME
							WHERE	CEVAP = 1 
								AND XBASEGONDERILDI = 0)
				--			select 1
					EXEC sp_FaturaGonderxBase @ID_FATURAODEME = @ID_FATURAODEME

			END

			IF @ISLEM = 4	--	FATURA ÖDEME CEVAP KONTROL	
			BEGIN

				SELECT CEVAP--	= ISNULL(CEVAP,0) 
				FROM FaturaOdeme 
				WHERE ID_FATURAODEME = SUBSTRING(@ID_FATURAODEME, 4, CHARINDEX('_', @ID_FATURAODEME) - 4)--@ID_FATURAODEME
				FOR JSON PATH, INCLUDE_NULL_VALUES

			END

			--SELECT FO.ID_FATURAODEME, D.ID_FATURA
			--INTO #TEMP
			--FROM FaturaOdeme		FO
			--JOIN FaturaOdemeDetay	D	ON	D.ID_FATURAODEME	= FO.ID_FATURAODEME
			--WHERE	CEVAP			= 1
			--	AND XBASEGONDERILDI = 0
			--
			--DECLARE @POSTCEVAP BIT = 0
			---- URL POST
			--IF @POSTCEVAP = 1
			--BEGIN
			--
			--	UPDATE FO SET
			--		XBASEGONDERILDI = 1
			--	FROM FaturaOdeme	FO
			--	JOIN #TEMP			T	ON	T.ID_FATURAODEME = FO.ID_FATURAODEME
			--
			--END 

			

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Filtre]    Script Date: 22.11.2021 11:12:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Filtre]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_KULLANICITIPI		INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_KADEME				INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_DERS				INT				= NULL,
	@DONEM					INT				= NULL,
	@ID_SINIFALAN			INT				= NULL,

	
	@ID_KULLANICITIPILIST	VARCHAR(MAX)	= NULL,
	@ID_SUBELIST			VARCHAR(MAX)	= NULL,
	@ID_KADEMELIST			VARCHAR(MAX)	= NULL,
	@ID_KADEME3LIST			VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST			VARCHAR(MAX)	= NULL,
	@ID_DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_SINIFALANLIST		VARCHAR(MAX)	= NULL,

	@DERSVARSASADECEKUR		BIT				= NULL,
	@DANISMAN				BIT				= NULL,
	@KURHARIC				BIT				= NULL,

	@SQLJSON				VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU
										
				,ID_KULLANICITIPI		= @ID_KULLANICITIPI
				,ID_SUBE				= @ID_SUBE
				,ID_KADEME				= @ID_KADEME
				,ID_KADEME3				= @ID_KADEME3
				,ID_SINIF				= @ID_SINIF
				,ID_DERS				= @ID_DERS
				,DONEM					= @DONEM
				,ID_SINIFALAN			= @ID_SINIFALAN
				
				,ID_KULLANICITIPILIST	= @ID_KULLANICITIPILIST
				,ID_SUBELIST			= @ID_SUBELIST
				,ID_KADEMELIST			= @ID_KADEMELIST
				,ID_KADEME3LIST			= @ID_KADEME3LIST
				,ID_SINIFALANLIST		= @ID_SINIFALANLIST
				,ID_SINIFLIST			= @ID_SINIFLIST
				,ID_DERSLIST			= @ID_DERSLIST
				,DERSVARSASADECEKUR		= @DERSVARSASADECEKUR
				,DANISMAN				= @DANISMAN
				,KURHARIC				= @KURHARIC
				,SQLJSON				= @SQLJSON

		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		
		IF @ID_LOG > 0
		BEGIN

			BEGIN
			
				DROP TABLE IF EXISTS #KULLANICITIPILIST
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #KADEMELIST
				DROP TABLE IF EXISTS #KADEME3LIST
				DROP TABLE IF EXISTS #SINIFLIST
				DROP TABLE IF EXISTS #DERSLIST
				DROP TABLE IF EXISTS #MENU_KT
				DROP TABLE IF EXISTS #ID_SINIFALANLIST

				
				CREATE TABLE #KULLANICITIPILIST (ID_KULLANICITIPI INT)
				IF @ID_KULLANICITIPILIST IS NOT NULL
					INSERT INTO #KULLANICITIPILIST (ID_KULLANICITIPI) SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)  
				INSERT INTO #KULLANICITIPILIST (ID_KULLANICITIPI) SELECT @ID_KULLANICITIPI WHERE @ID_KULLANICITIPI IS NOT NULL

				CREATE TABLE #SUBELIST (ID_SUBE INT)
				IF @ID_SUBELIST IS NOT NULL
					INSERT INTO #SUBELIST (ID_SUBE) SELECT VALUE FROM OPENJSON(@ID_SUBELIST)  
				INSERT INTO #SUBELIST (ID_SUBE) SELECT @ID_SUBE WHERE @ID_SUBE IS NOT NULL

				CREATE TABLE #KADEMELIST (ID_KADEME INT)
				IF @ID_KADEMELIST IS NOT NULL
					INSERT INTO #KADEMELIST (ID_KADEME) SELECT VALUE FROM OPENJSON(@ID_KADEMELIST) 
				INSERT INTO #KADEMELIST (ID_KADEME) SELECT @ID_KADEME WHERE @ID_KADEME IS NOT NULL

				CREATE TABLE #KADEME3LIST (ID_KADEME3 INT)
				IF @ID_KADEME3LIST IS NOT NULL	
					INSERT INTO #KADEME3LIST  (ID_KADEME3) SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST) 
				INSERT INTO #KADEME3LIST  (ID_KADEME3) SELECT @ID_KADEME3 WHERE @ID_KADEME3 IS NOT NULL

				CREATE TABLE #SINIFALANLIST (ID_SINIFALAN INT)
				IF @ID_SINIFALANLIST IS NOT NULL	
					INSERT INTO #SINIFALANLIST  (ID_SINIFALAN) SELECT VALUE FROM OPENJSON(@ID_SINIFALANLIST) 
				INSERT INTO #SINIFALANLIST  (ID_SINIFALAN) SELECT @ID_SINIFALAN WHERE @ID_SINIFALAN IS NOT NULL

				CREATE TABLE #SINIFLIST (ID_SINIF INT)
				IF @ID_SINIFLIST IS NOT NULL	
					INSERT INTO #SINIFLIST  (ID_SINIF) SELECT VALUE FROM OPENJSON(@ID_SINIFLIST) 
				INSERT INTO #SINIFLIST  (ID_SINIF) SELECT @ID_SINIF WHERE @ID_SINIF IS NOT NULL

				CREATE TABLE #DERSLIST (ID_DERS INT, KUR BIT, NORMAL BIT)
				IF @ID_DERSLIST IS NOT NULL	
					INSERT INTO #DERSLIST  (ID_DERS, KUR, NORMAL) 
					SELECT VALUE, D.KUR, D.NORMAL
					FROM OPENJSON(@ID_DERSLIST) DL
					INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = DL.VALUE

				INSERT INTO #DERSLIST  (ID_DERS, KUR, NORMAL) 
				SELECT D.ID_DERS, D.KUR, D.NORMAL
				FROM eokul_v2.dbo.Ders D 
				WHERE D.ID_DERS = @ID_DERS
				
				DROP TABLE IF EXISTS #MENU_KT
				DROP TABLE IF EXISTS #SUBE_KT


				SELECT DISTINCT KY.ID_KULLANICITIPI, KY.ID_KADEME 
				INTO #MENU_KT
				FROM MenuYetki							MK
				JOIN OKYANUSDB.DBO.VW_KullaniciYetki	KY	ON	KY.ID_KULLANICITIPI = MK.ID_KULLANICITIPI
															AND	KY.ID_KADEME		= MK.ID_KADEME
				WHERE	ID_MENU			= @ID_MENU
					AND	KY.TCKIMLIKNO	= @TCKIMLIKNO
				UNION		-- KİŞİ YETKİ VARSA ADMİN GİBİ 
				SELECT DISTINCT 1, K.ID_KADEME
				FROM MenuKullaniciYetki					MK
				CROSS APPLY OkyanusDB.dbo.v3Kademe		K
				WHERE	ID_MENU			= @ID_MENU
					AND	MK.TCKIMLIKNO	= @TCKIMLIKNO
				UNION		-- GENEL HAK VAR İSE MENU YETKİYE GEREK YOK
				SELECT DISTINCT 1, K.ID_KADEME
				FROM OkyanusDB.dbo.v3Kademe K
				WHERE dbo.fn_GenelHak (@TCKIMLIKNO) = 1

										
				DECLARE @AKTIFDONEM INT = (SELECT TOP 1 DONEM FROM OkyanusDB.DBO.v3AktifDonem WHERE AKTIF = 1 ORDER BY DONEM DESC)

				IF @DONEM IS NULL
				BEGIN
					SET @DONEM = @AKTIFDONEM
				END
			END
			
			IF @ISLEM = 1	--	ŞUBE LİSTE				
			BEGIN

				SELECT ID_KULLANICITIPI INTO #SUBE_KT FROM v3KullaniciTipi
				WHERE ID_KULLANICITIPI IN ( 1, 26, 27, 59, 60, 61, 91, 94)
								
				IF EXISTS ( SELECT TOP 1 M.ID_KULLANICITIPI FROM #MENU_KT	M JOIN #SUBE_KT	SB	ON	SB.ID_KULLANICITIPI	= M.ID_KULLANICITIPI ) 
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT S.AD, S.ID_SUBE, cast(S.SUBENO as int) SUBENO
						FROM OkyanusDB.DBO.v3Sube S
						FOR JSON PATH
					),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT S.AD, S.ID_SUBE, cast(S.SUBENO as int) SUBENO
						FROM OkyanusDB.DBO.v3Sube				S
						JOIN OkyanusDB.DBO.vw_KullaniciYetki	KY	ON	KY.ID_SUBE			= S.ID_SUBE
						--JOIN #MENU_KT							MY	ON	MY.ID_KULLANICITIPI = KY.ID_KULLANICITIPI
						--											AND	MY.ID_KADEME		= KY.ID_KADEME
						WHERE KY.TCKIMLIKNO = @TCKIMLIKNO
						FOR JSON PATH
					),'[]')
				END
				
				DROP TABLE IF EXISTS #SUBE_KT
			END
			
			IF @ISLEM = 2	--	KADEME LİSTE			
			BEGIN
							
				DROP TABLE IF EXISTS #KADEME_KT

				SELECT ID_KULLANICITIPI INTO #KADEME_KT FROM v3KullaniciTipi
				WHERE ID_KULLANICITIPI IN ( 1, 26, 27, 59, 60, 61, 91, 93, 94)

				IF EXISTS ( SELECT TOP 1 M.ID_KULLANICITIPI FROM #MENU_KT	M JOIN #KADEME_KT	SB	ON	SB.ID_KULLANICITIPI	= M.ID_KULLANICITIPI ) 
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT AD, K.ID_KADEME
						FROM OkyanusDB.DBO.v3Kademe		K
						JOIN OkyanusDB.DBO.v3SubeKademe	SK	ON	SK.ID_KADEME	= K.ID_KADEME
						WHERE	((EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )	AND  SK.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
						ORDER BY K.ID_KADEME
						FOR JSON PATH
					),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT K.AD, K.ID_KADEME
						FROM OkyanusDB.DBO.v3Kademe				K
						JOIN OkyanusDB.DBO.v3SubeKademe			SK	ON	SK.ID_KADEME		= K.ID_KADEME
						JOIN OkyanusDB.DBO.vw_KullaniciYetki	KY	ON	KY.ID_SUBE			= SK.ID_SUBE
																	AND KY.ID_KADEME		= SK.ID_KADEME
						JOIN #MENU_KT							MY	ON	MY.ID_KULLANICITIPI = KY.ID_KULLANICITIPI
																	AND	MY.ID_KADEME		= KY.ID_KADEME
						WHERE	KY.TCKIMLIKNO = @TCKIMLIKNO
							AND ((EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )	AND  SK.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
						ORDER BY K.ID_KADEME
						FOR JSON PATH
					),'[]')
				END
				
				DROP TABLE IF EXISTS #KADEME_KT
			END
			
			IF @ISLEM = 3	--	KADEME3 LİSTE			
			BEGIN
				
				DROP TABLE IF EXISTS #KADEME3_KT

				SELECT ID_KULLANICITIPI INTO #KADEME3_KT FROM v3KullaniciTipi
				WHERE ID_KULLANICITIPI IN ( 1, 26, 27, 53, 54, 59, 60, 61, 91, 93, 94)

				IF EXISTS ( SELECT TOP 1 M.ID_KULLANICITIPI FROM #MENU_KT	M JOIN #KADEME3_KT	SB	ON	SB.ID_KULLANICITIPI	= M.ID_KULLANICITIPI ) 
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT AD, K.ID_KADEME3,K.SIRA
						FROM OkyanusDB.DBO.v3Kademe3		K
						JOIN OkyanusDB.DBO.v3KademeBilgi	KB	ON	KB.ID_KADEME3	= K.ID_KADEME3
						JOIN OkyanusDB.DBO.v3SubeKademe		SK	ON	SK.ID_KADEME	= KB.ID_KADEME
						WHERE	((EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND  SK.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND  SK.ID_KADEME	IN ( SELECT ID_KADEME	FROM #KADEMELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND @ID_KADEMELIST IS NULL ))
						ORDER BY K.SIRA
						FOR JSON PATH
					),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT AD, K.ID_KADEME3,K.SIRA
						FROM OkyanusDB.DBO.v3Kademe3			K
						JOIN OkyanusDB.DBO.v3KademeBilgi		KB	ON	KB.ID_KADEME3		= K.ID_KADEME3
						JOIN OkyanusDB.DBO.v3SubeKademe			SK	ON	SK.ID_KADEME		= KB.ID_KADEME
						JOIN OkyanusDB.DBO.vw_KullaniciYetki	KY	ON	KY.ID_SUBE			= SK.ID_SUBE
																	AND KY.ID_KADEME3		= KB.ID_KADEME3
						--JOIN #MENU_KT							MY	ON	MY.ID_KULLANICITIPI = KY.ID_KULLANICITIPI
						--											AND	MY.ID_KADEME		= KY.ID_KADEME
						WHERE	KY.TCKIMLIKNO = @TCKIMLIKNO
							AND (@DANISMAN IS NULL OR @DANISMAN = 0 OR ( @DANISMAN = 1	AND	K.ID_KADEME3		IN ( SELECT S.ID_KADEME3 FROM OkyanusDB.dbo.v3SinifPersonel SD JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = SD.ID_SINIF WHERE SD.TCKIMLIKNO = KY.TCKIMLIKNO AND SD.ID_KULLANICITIPI = 100)))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND  SK.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND  SK.ID_KADEME	IN ( SELECT ID_KADEME	FROM #KADEMELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND @ID_KADEMELIST IS NULL ))
						ORDER BY K.SIRA
						FOR JSON PATH
					),'[]')
				END
				
				DROP TABLE IF EXISTS #KADEME3_KT
			END
			
			IF @ISLEM = 4	--	SINIF LİSTE				
			BEGIN				
				DROP TABLE IF EXISTS #SINIF_KT

				SELECT ID_KULLANICITIPI INTO #SINIF_KT FROM v3KullaniciTipi
				WHERE ID_KULLANICITIPI IN ( 1, 26, 27, 53, 54, 59, 60, 61, 91, 93, 94)

				IF EXISTS ( SELECT TOP 1 M.ID_KULLANICITIPI FROM #MENU_KT	M JOIN #SINIF_KT	SB	ON	SB.ID_KULLANICITIPI	= M.ID_KULLANICITIPI ) 
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT S.AD, S.ID_SINIF, SD.SUBEAD, SINIFSUBE= '('+ SD.SUBEAD + ') ' + SD.SINIF , SD.ID_KADEME3
						FROM OkyanusDB.DBO.vw_Sinif			S
						JOIN OkyanusDB.DBO.vw_v4SinifDetay	SD	ON	SD.ID_SINIF	= S.ID_SINIF
						WHERE	(@DONEM=S.DONEM)
							AND ((EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND  SD.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))		OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND  SD.ID_KADEME	IN ( SELECT ID_KADEME	FROM #KADEMELIST ))		OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )		AND @ID_KADEMELIST IS NULL ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #KADEME3LIST )	AND  SD.ID_KADEME3	IN ( SELECT ID_KADEME3	FROM #KADEME3LIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #KADEME3LIST )	AND @ID_KADEME3LIST IS NULL  ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #SINIFALANLIST )	AND  S.ID_SINIF		IN ( SELECT SA.ID_SINIF FROM #SINIFALANLIST T JOIN OkyanusDB.dbo.vw_SinifAlan SA ON SA.ID_SINIFALAN = T.ID_SINIFALAN) OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SINIFALANLIST )	AND @ID_SINIFALANLIST IS NULL )))
							AND(
								(
									(	EXISTS ( SELECT TOP 1 1 FROM #DERSLIST D WHERE D.KUR = 1 )
										AND S.ID_DERS IN ( ( SELECT D.ID_DERS FROM #DERSLIST D WHERE D.KUR = 1 ))
									)
									OR 
									(	EXISTS ( SELECT TOP 1 1 FROM #DERSLIST D WHERE D.KUR = 0 )
										AND S.KUR = 0 			
									)
									OR 
									(	
										EXISTS ( SELECT TOP 1 1 FROM #DERSLIST D WHERE D.KUR = 1 AND D.NORMAL = 1 )
									)
								)
								OR (NOT EXISTS ( SELECT TOP 1 1 FROM #DERSLIST )	AND @ID_DERSLIST IS NULL )
							)
							AND (@KURHARIC IS NULL OR @KURHARIC = 0 OR (@KURHARIC = 1 AND S.KUR = 0))
						ORDER BY SUBEAD, SD.ID_KADEME3 , S.AD
						FOR JSON PATH
					),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT S.AD, S.ID_SINIF, SD.SUBEAD, SINIFSUBE= '('+ SD.SUBEAD + ') ' + SD.SINIF , SD.ID_KADEME3
						FROM OkyanusDB.DBO.vw_Sinif				S
						JOIN OkyanusDB.DBO.vw_v4SinifDetay		SD	ON	SD.ID_SINIF			= S.ID_SINIF
						JOIN OkyanusDB.DBO.vw_KullaniciYetki	KY	ON	KY.ID_SUBE			= SD.ID_SUBE
																	AND KY.ID_SINIF			= S.ID_SINIF
						--JOIN #MENU_KT							MY	ON	MY.ID_KULLANICITIPI = KY.ID_KULLANICITIPI
						--											AND	MY.ID_KADEME		= KY.ID_KADEME						
						WHERE	KY.TCKIMLIKNO = @TCKIMLIKNO
							AND (@DONEM = S.DONEM)
							AND (@DANISMAN IS NULL OR @DANISMAN = 0 OR ( @DANISMAN = 1	AND	S.ID_SINIF		IN ( SELECT SD.ID_SINIF FROM OkyanusDB.dbo.v3SinifPersonel SD WHERE SD.TCKIMLIKNO = KY.TCKIMLIKNO AND SD.ID_KULLANICITIPI = 100)))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND SD.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND SD.ID_KADEME	IN ( SELECT ID_KADEME	FROM #KADEMELIST ))	OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #KADEMELIST )	AND @ID_KADEMELIST IS NULL ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #KADEME3LIST )	AND SD.ID_KADEME3	IN ( SELECT ID_KADEME3	FROM #KADEME3LIST ))OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #KADEME3LIST )	AND @ID_KADEME3LIST IS NULL  ))
							AND ((EXISTS ( SELECT TOP 1 1 FROM #SINIFALANLIST )	AND  S.ID_SINIF		IN ( SELECT SA.ID_SINIF FROM #SINIFALANLIST T JOIN OkyanusDB.dbo.vw_SinifAlan SA ON SA.ID_SINIFALAN = T.ID_SINIFALAN) OR	(NOT EXISTS ( SELECT TOP 1 1 FROM #SINIFALANLIST )	AND @ID_SINIFALANLIST IS NULL )))
							AND(
								(
									(	EXISTS ( SELECT TOP 1 1 FROM #DERSLIST D WHERE D.KUR = 1 )
										AND S.ID_DERS IN ( ( SELECT D.ID_DERS FROM #DERSLIST D WHERE D.KUR = 1 ))
									)
									OR 
									(	(EXISTS ( SELECT TOP 1 1 FROM #DERSLIST D WHERE D.KUR = 0 )
										AND (S.KUR = 0) OR @DERSVARSASADECEKUR = 0)
									)
									OR 
									(	
										EXISTS ( SELECT TOP 1 1 FROM #DERSLIST D WHERE D.KUR = 1 AND D.NORMAL = 1 )
									)
								)
								OR (NOT EXISTS ( SELECT TOP 1 1 FROM #DERSLIST )	AND @ID_DERSLIST IS NULL )
							)
							AND (@KURHARIC IS NULL OR @KURHARIC = 0 OR (@KURHARIC = 1 AND S.KUR = 0))
						ORDER BY SUBEAD, SD.ID_KADEME3 , S.AD
						FOR JSON PATH
					),'[]')					
				END
				
				DROP TABLE IF EXISTS #SINIF_KT
			END

			IF @ISLEM = 5	--	ÖĞRENCİ LİSTE			
			BEGIN
				DROP TABLE IF EXISTS #OGRENCI_KT

				SELECT ID_KULLANICITIPI INTO #OGRENCI_KT FROM v3KullaniciTipi
				WHERE ID_KULLANICITIPI IN ( 1, 3, 26, 27, 53, 54, 59, 60, 61, 91, 93, 94)

				IF EXISTS ( SELECT TOP 1 M.ID_KULLANICITIPI FROM #MENU_KT M JOIN #OGRENCI_KT SB ON SB.ID_KULLANICITIPI = M.ID_KULLANICITIPI ) 
				BEGIN
					
					SELECT ISNULL((
						SELECT * FROM (
								SELECT O.TCKIMLIKNO, K.AD, K.SOYAD, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.AD AS SINIFAD
								FROM OkyanusDB.dbo.v3OgrenciTum			O
								INNER JOIN OkyanusDB.dbo.v3Kullanici	K ON K.TCKIMLIKNO		= O.TCKIMLIKNO
								INNER JOIN OkyanusDB.dbo.v3SinifTum		S ON S.ID_SINIF			= O.ID_SINIF
								WHERE ((EXISTS (SELECT TOP 1 1 FROM #SINIFLIST ) AND O.ID_SINIF IN (SELECT ID_SINIF FROM #SINIFLIST)) OR (NOT EXISTS (SELECT TOP 1 1 FROM #SINIFLIST) AND @ID_SINIFLIST IS NULL))
							UNION
								SELECT K.TCKIMLIKNO, K.AD, K.SOYAD, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.AD AS SINIFAD
								FROM OkyanusDB.dbo.v4SinifOgrenci		O
								INNER JOIN OkyanusDB.dbo.v4Sinif		S ON S.ID_SINIF			= O.ID_SINIF
								INNER JOIN OkyanusDB.dbo.v3Kullanici	K ON K.TCKIMLIKNO		= O.TC_OGRENCI
								WHERE O.AKTIF = 1
								AND ((EXISTS (SELECT TOP 1 1 FROM #SINIFLIST ) AND O.ID_SINIF IN (SELECT ID_SINIF FROM #SINIFLIST)) OR (NOT EXISTS (SELECT TOP 1 1 FROM #SINIFLIST) AND @ID_SINIFLIST IS NULL))
						) XTABLE ORDER BY ADSOYAD
						FOR JSON PATH
					),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT * FROM (
								SELECT O.TCKIMLIKNO, K.AD, K.SOYAD, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.AD AS SINIFAD
								FROM OkyanusDB.dbo.v3Ogrenci			O
								INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON K.TCKIMLIKNO			= O.TCKIMLIKNO
								INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	VO	ON VO.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
								INNER JOIN OkyanusDB.dbo.v3SinifTum		S	ON S.ID_SINIF			= O.ID_SINIF
								WHERE VO.TCKIMLIKNO = @TCKIMLIKNO
							UNION
								SELECT K.TCKIMLIKNO, K.AD, K.SOYAD, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.AD AS SINIFAD
								FROM OkyanusDB.dbo.v4SinifOgrenci		O
								INNER JOIN OkyanusDB.dbo.v4Sinif		S	ON S.ID_SINIF			= O.ID_SINIF
								INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON K.TCKIMLIKNO			= O.TC_OGRENCI
								INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	VO	ON VO.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
								WHERE S.AKTIF = 1 AND O.AKTIF = 1 AND VO.TCKIMLIKNO = @TCKIMLIKNO AND (S.DONEM = @DONEM)
						) XTABLE ORDER BY ADSOYAD
						FOR JSON PATH
					),'[]')
				END
				
				DROP TABLE IF EXISTS #OGRENCI_KT
			END

			IF @ISLEM = 6	--	DÖNEM LİSTE				
			BEGIN
				SELECT ISNULL((
					SELECT D.DONEM, D.AKTIF, D.ACIKLAMA
					FROM OkyanusDB.DBO.v3AktifDonem D
					ORDER BY D.DONEM DESC
					FOR JSON PATH
				),'[]')
			END
			
			IF @ISLEM = 7	--	KULLANICI TİPİ LİSTE	
			BEGIN
				SELECT ISNULL((
					SELECT AD, KT.ID_KULLANICITIPI
					FROM OkyanusDB.DBO.v3KullaniciTipi	KT
					FOR JSON PATH
				),'[]')
			END
			
			IF @ISLEM = 8	--	KULLANICI LİSTE	(TIP)	
			BEGIN

				SELECT ISNULL((
					SELECT DISTINCT K.TCKIMLIKNO, ADSOYAD = CONCAT_WS(' ', K.AD, K.SOYAD)
					FROM v3Kullanici		K
					JOIN v3SubeYetki		SY	ON	SY.TCKIMLIKNO			= K.TCKIMLIKNO
					JOIN #KULLANICITIPILIST	KTL	ON	KTL.ID_KULLANICITIPI	= SY.ID_KULLANICITIPI
					JOIN #SUBELIST			SL	ON	SL.ID_SUBE				= SY.ID_SUBE
					ORDER BY ADSOYAD
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 9	--	SINIF ALAN LİSTE		
			BEGIN
				SELECT ISNULL((
					SELECT ID_SINIFALAN, AD AS ALAN
					FROM OkyanusDb.dbo.v4SinifAlan
					ORDER BY ALAN DESC
					FOR JSON PATH
				),'[]')
			END
			
			DROP TABLE IF EXISTS #KULLANICITIPILIST
			DROP TABLE IF EXISTS #SUBELIST
			DROP TABLE IF EXISTS #KADEMELIST
			DROP TABLE IF EXISTS #KADEME3LIST
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #DERSLIST
			DROP TABLE IF EXISTS #MENU_KT
			DROP TABLE IF EXISTS #SINIFALANLIST

		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_FiltreEk]    Script Date: 22.11.2021 11:13:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER procedure [dbo].[sp_FiltreEk]
	@ISLEM			INT				= NULL,
	@TCKIMLIKNO		VARCHAR(11)		= NULL,
	@OTURUM			VARCHAR(36)		= NULL,
	@ID_MENU		INT				= NULL,
	
	@DONEM			INT				= NULL,

	@ID_SUBELIST	VARCHAR(MAX)	= NULL,
	@ID_KADEME3LIST	VARCHAR(MAX)	= NULL,
	
	@ID_SUBE		INT				= NULL,
	@ID_KADEME3		INT				= NULL,
	@ID_KADEME		INT				= NULL,
	@ID_SINIF		INT				= NULL,
	@TC_OGRENCI		VARCHAR(11)		= NULL,
	@ID_DERSLIST	VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU	INT				= NULL,
	@SINAVDURUM		BIT				= NULL,
	@ONLINESINAV	BIT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
								
				,ID_SUBE		= @ID_SUBE
				,ID_KADEME3		= @ID_KADEME3
				,ID_KADEME		= @ID_KADEME
				,ID_SINIF		= @ID_SINIF
								
				,ID_SUBELIST	= @ID_SUBELIST
				,ID_KADEME3LIST	= @ID_KADEME3LIST
				,TC_OGRENCI		= @TC_OGRENCI
				,ID_DERSLIST	= @ID_DERSLIST
				,ID_SINAVTURU	= @ID_SINAVTURU
				,SINAVDURUM		= @SINAVDURUM
				,ONLINESINAV	= @ONLINESINAV
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		
		IF @ID_LOG > 0
		BEGIN

			BEGIN
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #KADEMELIST
				DROP TABLE IF EXISTS #KADEME3LIST
				DROP TABLE IF EXISTS #SINIFLIST
				DROP TABLE IF EXISTS #DERSLIST

				CREATE TABLE #SUBELIST (ID_SUBE INT)
				IF @ID_SUBELIST IS NOT NULL
					INSERT INTO #SUBELIST (ID_SUBE) SELECT VALUE FROM OPENJSON(@ID_SUBELIST)  
				INSERT INTO #SUBELIST (ID_SUBE) SELECT @ID_SUBE WHERE @ID_SUBE IS NOT NULL

				CREATE TABLE #KADEME3LIST (ID_KADEME3 INT)
				IF @ID_KADEME3LIST IS NOT NULL	
					INSERT INTO #KADEME3LIST  (ID_KADEME3) SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST) 
				INSERT INTO #KADEME3LIST  (ID_KADEME3) SELECT @ID_KADEME3 WHERE @ID_KADEME3 IS NOT NULL
										
				DECLARE @AKTIFDONEM INT = (SELECT TOP 1 DONEM FROM OkyanusDB.DBO.v3AktifDonem WHERE AKTIF = 1 ORDER BY DONEM DESC)

				DROP TABLE IF EXISTS #MENU_KT

				SELECT DISTINCT KY.ID_KULLANICITIPI, KY.ID_KADEME 
				INTO #MENU_KT
				FROM MenuYetki							MK
				JOIN OKYANUSDB.DBO.VW_KullaniciYetki	KY	ON	KY.ID_KULLANICITIPI = MK.ID_KULLANICITIPI
															AND	KY.ID_KADEME		= MK.ID_KADEME
				WHERE	ID_MENU			= @ID_MENU
					AND	KY.TCKIMLIKNO	= @TCKIMLIKNO
				UNION
				-- KİŞİ YETKİ VARSA ADMİN GİBİ 
				SELECT DISTINCT 1, K.ID_KADEME
				FROM MenuKullaniciYetki					MK
				CROSS APPLY OkyanusDB.dbo.v3Kademe		K
				WHERE	ID_MENU			= @ID_MENU
					AND	MK.TCKIMLIKNO	= @TCKIMLIKNO
				-- GENEL HAK VAR İSE MENU YETKİYE GEREK YOK
				UNION
				SELECT DISTINCT 1, K.ID_KADEME
				FROM OkyanusDB.dbo.v3Kademe K
				WHERE dbo.fn_GenelHak (@TCKIMLIKNO) = 1

				IF @DONEM IS NULL
				BEGIN
					SET @DONEM = @AKTIFDONEM
				END
			END
			
			IF @ISLEM = 1	-- DERS LİSTE			
			BEGIN
				
				DROP TABLE IF EXISTS #KADEME3_KT

				SELECT ID_KULLANICITIPI INTO #KADEME3_KT FROM v3KullaniciTipi
				WHERE ID_KULLANICITIPI IN ( 1, 26, 27, 53, 54, 59, 60, 61, 91, 93, 94)

				IF EXISTS ( SELECT TOP 1 M.ID_KULLANICITIPI FROM #MENU_KT	M JOIN #KADEME3_KT	SB	ON	SB.ID_KULLANICITIPI	= M.ID_KULLANICITIPI ) 
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT D.ID_DERS, D.DERSAD + ' (' + K3.AD + ')' AS AD
						FROM eokul_v2.dbo.Ders D
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = D.ID_KADEME3
						WHERE AKTIF = 1 AND IPTAL = 0 
						AND ((EXISTS ( SELECT * FROM #KADEME3LIST )	AND  D.ID_KADEME3	IN ( SELECT ID_KADEME3	FROM #KADEME3LIST ))	OR	(NOT EXISTS ( SELECT * FROM #KADEME3LIST )	AND @ID_KADEME3LIST IS NULL ))
						ORDER BY AD
						FOR JSON PATH
					),'[]')
				END
				ELSE
				BEGIN
					SELECT ISNULL((
						SELECT DISTINCT D.ID_DERS, D.DERSAD + ' (' + K3.AD + ')' AS AD
						FROM eokul_v2.dbo.Ders						D
						INNER JOIN OkyanusDB.dbo.v3Kademe3			K3 ON K3.ID_KADEME3 = D.ID_KADEME3
						INNER JOIN eokul_v2.dbo.DersOgretmen		DO	ON DO.ID_DERS = D.ID_DERS
						INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay	S	ON S.ID_SINIF = DO.ID_SINIF
						WHERE	AKTIF = 1 AND IPTAL = 0 AND DO.TC_OGRETMEN = @TCKIMLIKNO AND DO.DONEMKOD = @DONEM
							AND ((EXISTS ( SELECT * FROM #SUBELIST )	AND  S.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))		OR	(NOT EXISTS ( SELECT * FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))
							AND ((EXISTS ( SELECT * FROM #KADEME3LIST )	AND  D.ID_KADEME3	IN ( SELECT ID_KADEME3	FROM #KADEME3LIST ))	OR	(NOT EXISTS ( SELECT * FROM #KADEME3LIST )	AND @ID_KADEME3LIST IS NULL ))
						ORDER BY AD
						FOR JSON PATH
					),'[]')
				END
				
				DROP TABLE IF EXISTS #KADEME3_KT
			END

			IF @ISLEM = 2	-- KADEME ÖDEV TÜR LİSTELE - SELECT
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT OT.ID_ODEVTUR, OT.AD
					FROM OdevTur OT
					INNER JOIN OdevTurKademe OTK ON OTK.ID_ODEVTUR = OT.ID_ODEVTUR AND OTK.ID_KADEME = @ID_KADEME
					ORDER BY OT.ID_ODEVTUR
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 3	-- ÖĞRENCİ ODEV DERS LİSTELE
			BEGIN
				SELECT D.ID_DERS, D.DERSAD
				INTO #OGRENCIODEV3
				FROM OdevSinifOgrenci OSO 
				INNER JOIN OdevSinif OS ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = O.ID_DERS
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND O.AKTIF = 1
				AND O.DONEM = @DONEM

				SELECT
				ISNULL(
				(
					SELECT * FROM 
					(
						SELECT 0 AS TUR, 0 AS ID_DERS, 'Genel ('+ CAST(COUNT(1) AS VARCHAR) + ')' AS AD
						FROM #OGRENCIODEV3
						UNION
						SELECT 1 AS TUR, ID_DERS, DERSAD + ' (' + CAST(COUNT(1) AS VARCHAR) + ')' AS AD
						FROM #OGRENCIODEV3
						WHERE ID_DERS IS NOT NULL
						GROUP BY ID_DERS, DERSAD
					) X
					ORDER BY TUR, AD
					FOR JSON PATH
				), '[]')

				DROP TABLE #OGRENCIODEV3
			END

			IF @ISLEM = 4	-- ÖĞRETMEN LİSTELE
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT DISTINCT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.TC_OGRETMEN = SY.TCKIMLIKNO
					LEFT JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = DO.ID_DERS AND ((EXISTS ( SELECT * FROM #KADEME3LIST )	AND  D.ID_KADEME3	IN ( SELECT ID_KADEME3	FROM #KADEME3LIST ))	OR	(NOT EXISTS ( SELECT * FROM #KADEME3LIST )	AND @ID_KADEME3LIST IS NULL ))
																			AND D.AKTIF = 1 AND D.IPTAL = 0
					WHERE
					((EXISTS ( SELECT * FROM #SUBELIST )	AND  SY.ID_SUBE		IN ( SELECT ID_SUBE		FROM #SUBELIST ))		OR	(NOT EXISTS ( SELECT * FROM #SUBELIST )		AND @ID_SUBELIST IS NULL ))					
					AND DO.DONEMKOD = @DONEM
					AND (@ID_DERSLIST = '[]' OR @ID_DERSLIST IS NULL OR DO.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST)))
					ORDER BY ADSOYAD
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 5	-- BRANŞ LİSTELE
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT DISTINCT BRANS FROM OkyanusDB.dbo.v3Ogretmen WHERE BRANS IS NOT NULL ORDER BY BRANS 
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 6	-- SINAV TÜRÜ LİSTELE
			BEGIN
				SELECT
				ISNULL(
					(
						SELECT ST.ID_SINAVTURU, ST.AD
						FROM Sinav S
						JOIN SinavTuru ST ON ST.ID_SINAVTURU = S.ID_SINAVTURU
						WHERE (S.ID_KADEME3 = @ID_KADEME3 OR @ID_MENU IN(1332,1382)) AND S.DONEM = @DONEM AND S.AKTIF = 1 AND (S.DURUM = 2 OR @SINAVDURUM = 1)
						GROUP BY ST.ID_SINAVTURU, ST.AD
						ORDER BY ST.AD
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 7	-- SINAV LİSTELE
			BEGIN
				SELECT
				ISNULL(
					(
						SELECT S.ID_SINAV, '(' + CONVERT(varchar(10), S.SINAVTARIH, 104) + ') ' + S.AD AS AD
						FROM Sinav S
						WHERE	( S.ID_KADEME3	= @ID_KADEME3 OR @ID_MENU IN(1332,1382)) -- OnlineSinavOgrenciAtama
							AND S.ID_SINAVTURU	= @ID_SINAVTURU
							AND S.DONEM			= @DONEM 
							AND S.AKTIF			= 1 
							--AND S.DURUM			= 2 
							AND (	(@ONLINESINAV = 1 AND S.ONLINESINAV = 1	)
								OR	(@ONLINESINAV IS NULL AND S.DURUM	= 2 )
							)
						ORDER BY S.ID_KADEME3, S.SINAVTARIH DESC
						FOR JSON PATH
					),
					'[]'
				)
			END
			
			DROP TABLE IF EXISTS #SUBELIST
			DROP TABLE IF EXISTS #KADEME3LIST
			DROP TABLE IF EXISTS #MENU_KT
		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_FrekansEtkiListesi]    Script Date: 22.11.2021 11:13:28 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_FrekansEtkiListesi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_SINAVTURU			INT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SINAVTURU			= @ID_SINAVTURU			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		
		IF @_ID_LOG > 0
		BEGIN

			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
			
			IF @ISLEM = 1	--	FREKANS ETKİ LİSTESİ			
			BEGIN
				
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #ARALIKDERS

				select f.*,kb.ID_KADEME into #v2FrekansOgrenciDetayDonem 
				from v2FrekansOgrenciDetay			f
				join OkyanusDB.dbo.v3KademeBilgi	kb	on	kb.ID_KADEME3	= f.ID_KADEME3
				where	DONEM = @AKTIFDONEM 


				SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD, ID_KADEME3
				INTO #GenelFrekansKatki FROM #v2FrekansOgrenciDetayDonem	T
				WHERE	ID_SINAVTURU	= @ID_SINAVTURU
				GROUP BY TC_OGRETMEN, ID_SINAVTURU, DERSAD, ID_KADEME3

				SELECT ID_SINAVTURU
					,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
					,MAX(GF.FREKANS) MAXIMUM
					,MIN(GF.FREKANS) MINIMUM 
					,DERSAD
					,ID_KADEME3
				INTO #ARALIK 
				FROM #GenelFrekansKatki	GF
				GROUP BY ID_SINAVTURU, DERSAD, ID_KADEME3
							   				
				SELECT DISTINCT WA.DERSAD 
				INTO #ARALIKDERS
				FROM #ARALIK WA
				
				SELECT(
					SELECT (
						SELECT	 K.AD KADEME3
								,K.SIRA
								,A.DERSAD
								,A.MINIMUM
								,A.MAXIMUM
								,A.ARALIK
						FROM #ARALIK		A
						JOIN v3Kademe3		K	ON	K.ID_KADEME3	= A.ID_KADEME3
						ORDER BY K.SIRA, A.DERSAD
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS ARALIK,
					(
						SELECT DISTINCT DERSAD
						FROM #ARALIKDERS
						ORDER BY DERSAD
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS ARALIKDERS
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_FrekansOgrenciHesapla]    Script Date: 22.11.2021 11:13:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_FrekansOgrenciHesapla]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
-- EXEC sp_FrekansOgrenciHesapla
BEGIN TRY    

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	IF @ID_LOG > 1
	BEGIN
			SET @DONEM = (SELECT Donem FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)

			SELECT	D.* 
			INTO	#DERSLER 
			FROM	v3SinavDers D
			INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD
				--and AD			in ('Türk Edebiyatı','Dil ve Anlatım','Matematik','Geometri','Fizik','Kimya','Biyoloji','Tarih','Coğrafya','Felsefe','Din Kült. Ve A. B.','Main Course','Almanca','Sosyoloji')

			SELECT	 ID_EGITIMTURU
					,ID_SINAVTURU	--=  CASE ID_EGITIMTURU 
									--	WHEN 6  THEN 0
									--	WHEN 7  THEN 2
									--	WHEN 8  THEN 3
									--	WHEN 9  THEN 6
									--	WHEN 10 THEN 5
									--	--YENİ EKLENENLER
									--	WHEN 11 THEN 8 
									--	WHEN 12 THEN 9
									--	WHEN 13 THEN 7
									--	WHEN 14 THEN 10
									--
									--ELSE 0 END
			INTO #EgitimTuru FROM OkyanusDB.DBO.V3EgitimTuru
			WHERE PASIF = 0
		-- FREKANS OGRENCI
		BEGIN
			Delete from FrekansOgrenci WHERE DONEM=@DONEM 		

			SELECT	S.ID_SINAV, 
					S.ID_SINAVTURU, 
					S.SINAVTARIH,
					TAKMAAD =  DR.AD,
					SO.TCKIMLIKNO, 
					O.ID_OGRENCI, 
					KK3.ID_KADEME3, 
					SUM(SOCB.NET) AS TOPLAMNET, 
					SUM(SOCB.DOGRU + SOCB.YANLIS + SOCB.BOS) AS TOPLAMSORUSAYISI,
					MAX(SD.ID_DERS) ID_DERS
			INTO #TEMP
			FROM	   [Pusulam].dbo.SinavOgrenci				SO		WITH (NOLOCK) 
			INNER JOIN [Pusulam].dbo.Sinav						S		WITH (NOLOCK) ON	S.ID_SINAV				= SO.ID_SINAV
			INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum		SOCB	WITH (NOLOCK) ON	SOCB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			INNER JOIN [Pusulam].dbo.SinavDers					SD		WITH (NOLOCK) ON	SD.ID_SINAVDERS			= SOCB.ID_SINAVDERS
			INNER JOIN OkyanusDB.dbo.V3Ogrenci					O		WITH (NOLOCK) ON	O.TCKIMLIKNO			= SO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3KullaniciKademe3			KK3		WITH (NOLOCK) ON	KK3.TCKIMLIKNO			= O.TCKIMLIKNO
			INNER JOIN #DERSLER									DR		WITH (NOLOCK) ON	DR.ID_DERS				= SD.ID_DERS
			WHERE   S.DONEM			= @DONEM 
				AND S.DURUM			= 2
				AND S.FREKANSHESAPLA= 1
				AND S.AKTIF			= 1
				--AND	KK3.ID_KADEME3	IN (15, 16, 17, 18) 
				--AND S.ID_SINAVTURU	IN (2,3,4,5,6) --LİSE
			GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SO.TCKIMLIKNO, O.ID_OGRENCI, DR.AD, KK3.ID_KADEME3,S.SINAVTARIH--, (SOCB.DOGRU + SOCB.YANLIS + SOCB.BOS)
		UNION ALL
			SELECT	Y.ID_YAZILI AS ID_SINAV
					,0 AS ID_SINAVTURU
					,Y.YAZILITARIH AS SINAVTARIH
					,D.DERSAD AS TAKMAAD
					,YO.TCKIMLIKNO 
					,O.ID_OGRENCI
					,D.ID_KADEME3
					,CAST(ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS DECIMAL(8,2)) AS TOPLAMNET
					,100 AS TOPLAMSORUSAYISI
					,Y.ID_DERS
			FROM Yazili Y
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
			WHERE Y.DONEM = @DONEM AND Y.AKTIF = 1 AND YO.AKTIF = 1 AND YO.KATILMADI = 0
			GROUP BY Y.ID_YAZILI, Y.YAZILITARIH, D.DERSAD, YO.TCKIMLIKNO, O.ID_OGRENCI, D.ID_KADEME3, Y.ID_DERS, YO.TELAFI
			--SELECT		ONOT.ID_SINAVRAPOR ID_SINAV, 
			--			0 ID_SINAVTURU, 
			--			SR.TARIH SINAVTARIH,
			--			D.AD TAKMAAD, 
			--			ONOT.TC_OGRENCI TCKIMLIKNO, 
			--			ONOT.ID_OGRENCI, 
			--			D.ID_KADEME3, 
			--			-- cast(SR.SORUSAYISI decimal(8,2))/cast (SELECT SUM(PUAN) FROM eokul_v2.dbo.OgrenciNot OG WHERE OG.TC_OGRENCI=ONOT.TC_OGRENCI AND OG.ID_SINAVRAPOR=ONOT.ID_SINAVRAPOR) as decimal(8,2)) TOPLAMNET,
			--			----100 TOPLAMSORUSAYISI,
			--			--SR.SORUSAYISI TOPLAMSORUSAYISI,
						
			--			--ÇALIŞAN BUYDU
			--			--cast(
			--			--		cast((SELECT SUM(PUAN) FROM eokul_v2.dbo.OgrenciNot OG WHERE OG.TC_OGRENCI=ONOT.TC_OGRENCI AND OG.ID_SINAVRAPOR=ONOT.ID_SINAVRAPOR) as float)
			--			--	/	cast(100 as decimal(8,2)) 	
			--			--	*	SR.SORUSAYISI	
			--			--as decimal(8,2))			TOPLAMNET,
			--			--SR.SORUSAYISI				TOPLAMSORUSAYISI,

			--			TOPLAMNET			= cast((SELECT SUM(PUAN) FROM eokul_v2.dbo.OgrenciNot OG WHERE OG.TC_OGRENCI=ONOT.TC_OGRENCI AND OG.ID_SINAVRAPOR=ONOT.ID_SINAVRAPOR) as decimal(8,2)),
			--			TOPLAMSORUSAYISI	= 100,
			--			SR.ID_DERS
			--FROM		eokul_v2.dbo.OgrenciNot		ONOT
			--INNER JOIN	eokul_v2.dbo.SinavRapor		SR		ON	SR.ID_SINAVRAPOR		= ONOT.ID_SINAVRAPOR
			--INNER JOIN	#DERSLER					D		ON	D.ID_DERS				= SR.ID_DERS
			--WHERE		SR.DONEMKOD		=	@DONEM 
			--	--AND		D.ID_KADEME3	IN	(15, 16, 17, 18) --LİSE		
			--	AND		SR.isActive		=	1			
			--GROUP BY	ONOT.ID_SINAVRAPOR,ONOT.TC_OGRENCI,D.AD,ONOT.ID_OGRENCI,D.ID_KADEME3,SR.ID_DERS,SR.SORUSAYISI,SR.TARIH



			SELECT T1.ID_SINAV, T1.ID_SINAVTURU, T1.TAKMAAD, T1.TCKIMLIKNO, T1.ID_OGRENCI, T1.ID_KADEME3, T1.TOPLAMNET, T1.TOPLAMSORUSAYISI 
					,ILK_ID_SINAV	= (SELECT TOP 1 ID_SINAV FROM #TEMP G WHERE G.SINAVTARIH=MIN(T2.SINAVTARIH) 
																			AND G.ID_SINAVTURU	= T1.ID_SINAVTURU 
																			AND G.TCKIMLIKNO	= T1.TCKIMLIKNO 
																			AND G.TAKMAAD		= T1.TAKMAAD		
																ORDER BY G.SINAVTARIH,G.ID_SINAV				) 
					--, MIN(T2.ID_SINAV) AS ILK_ID_SINAV
			INTO	#TEMP2
			FROM	#TEMP	T1
			JOIN	#TEMP	T2	ON	T2.ID_SINAVTURU	= T1.ID_SINAVTURU 
								AND T2.TCKIMLIKNO	= T1.TCKIMLIKNO 
								AND T2.TAKMAAD		= T1.TAKMAAD
			GROUP BY T1.ID_SINAV, T1.ID_SINAVTURU, T1.TAKMAAD, T1.TCKIMLIKNO, T1.ID_OGRENCI, T1.ID_KADEME3, T1.TOPLAMNET, T1.TOPLAMSORUSAYISI
			ORDER BY TCKIMLIKNO, TAKMAAD

			Insert Into FrekansOgrenci (ID_SINAVTURU,ID_KADEME3,ID_OGRENCI,TCKIMLIKNO,ID_DERS,TAKMAAD,HBNET,ID_SINAV,NET,SS,ILK_ID_SINAV,ILK_NET,ILK_SS,FREKANS,DONEM)
			SELECT   T2.ID_SINAVTURU
					,T2.ID_KADEME3
					,T2.ID_OGRENCI
					,T2.TCKIMLIKNO
					,ID_DERS
					,T2.TAKMAAD
					,T1.TOPLAMNET HBNET
					,T2.ID_SINAV
					,ISNULL(convert(decimal(8,2),(cast(T1.TOPLAMSORUSAYISI	as float)	/ NULLIF(cast(T2.TOPLAMSORUSAYISI as float)	/NULLIF(cast(T2.TOPLAMNET as float),0 ),0 ))),0)as NET
					,T1.TOPLAMSORUSAYISI AS SS 
					,T2.ILK_ID_SINAV
					,T1.TOPLAMNET AS ILK_NET
					,T1.TOPLAMSORUSAYISI AS ILK_SS
					,CASE WHEN T2.ID_SINAV=T2.ILK_ID_SINAV				AND T2.ID_SINAVTURU!=0					THEN null
						  WHEN T1.TOPLAMNET=T1.TOPLAMSORUSAYISI AND T2.TOPLAMSORUSAYISI>0	THEN (Convert(DECIMAL(8,2),T2.TOPLAMNET)/T2.TOPLAMSORUSAYISI)*100
						  ELSE  convert(decimal(8,2),
								cast((T2.TOPLAMNET-			cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)								
								/
								NULLIF(
										cast((T1.TOPLAMSORUSAYISI-	cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)
								,0)
								*100 
								)
					 END AS FREKANS
					,@DONEM
			FROM		#TEMP2	T2
			INNER JOIN	#TEMP	T1	ON	T2.ILK_ID_SINAV	= T1.ID_SINAV 
									AND T2.ID_SINAVTURU	= T1.ID_SINAVTURU 
									AND T2.TCKIMLIKNO	= T1.TCKIMLIKNO 
									AND T2.TAKMAAD		= T1.TAKMAAD
			ORDER BY T2.ID_KADEME3, ID_OGRENCI, T2.TAKMAAD

			-------------------------------------------
			--Insert Into FrekansOgrenci (ID_SINAVTURU,ID_KADEME3,ID_OGRENCI,TCKIMLIKNO,ID_DERS,TAKMAAD,HBNET,ID_SINAV,NET,SS,ILK_ID_SINAV,ILK_NET,ILK_SS,FREKANS,DONEM)
			--SELECT   T2.ID_SINAVTURU
			--		,T2.ID_KADEME3
			--		,T2.ID_OGRENCI
			--		,T2.TCKIMLIKNO
			--		,ID_DERS
			--		,T2.TAKMAAD
			--		,T1.TOPLAMNET HBNET
			--		,T2.ID_SINAV
			--		,ISNULL(convert(decimal(8,2),(cast(T1.TOPLAMSORUSAYISI	as float)	/ NULLIF(cast(T2.TOPLAMSORUSAYISI as float)	/NULLIF(cast(T2.TOPLAMNET as float),0 ),0 ))),0)as NET
			--		,T1.TOPLAMSORUSAYISI AS SS 
			--		,T2.ILK_ID_SINAV
			--		,T1.TOPLAMNET AS ILK_NET
			--		,T1.TOPLAMSORUSAYISI AS ILK_SS
			--		,CASE WHEN T2.ID_SINAV=T2.ILK_ID_SINAV									THEN null
			--			  WHEN T1.TOPLAMNET=T1.TOPLAMSORUSAYISI AND T2.TOPLAMSORUSAYISI>0	THEN (Convert(DECIMAL(8,2),T2.TOPLAMNET)/T2.TOPLAMSORUSAYISI)*100
			--			  ELSE  convert(decimal(8,2),
			--					cast((T2.TOPLAMNET-			cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)								
			--					/
			--					NULLIF(
			--							cast((T1.TOPLAMSORUSAYISI-	cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)
			--					,0)
			--					*100 
			--					)
			--		 END AS FREKANS
			--		,@DONEM
			--FROM		#TEMP2	T2
			--INNER JOIN	#TEMP	T1	ON	T2.ILK_ID_SINAV	= T1.ID_SINAV 
			--						AND T2.ID_SINAVTURU	= T1.ID_SINAVTURU 
			--						AND T2.TCKIMLIKNO	= T1.TCKIMLIKNO 
			--						AND T2.TAKMAAD		= T1.TAKMAAD			
			--WHERE		T2.ID_SINAVTURU=0
			--ORDER BY T2.ID_KADEME3, ID_OGRENCI, T2.TAKMAAD
			-------------------------------------------


			DROP TABLE #TEMP
			DROP TABLE #TEMP2
		END			
		-- FREKANS OGRENCI DETAY 
		BEGIN 
			--TRUNCATE TABLE FrekansOgrenciDetay

			Delete from FrekansOgrenciDetay WHERE DONEM=@DONEM

			INSERT INTO FrekansOgrenciDetay (ID_SINAVTURU
											,ID_KADEME3
											,ID_OGRENCI
											,TC_OGRENCI
											,TAKMAAD
											,ID_SINAV
											,NET
											,SS
											,ILK_ID_SINAV
											,ILK_NET
											,HBNET
											,ILK_SS
											,FREKANS
											,DONEM
											,ID_SINIF
											,ID_SUBE
											,ID_DERS
											,TC_OGRETMEN
											,OGRETMENADSOYAD
											,DERSAD
											,SUBEAD
											,SINIFAD)
			(
						SELECT	
							FO.ID_SINAVTURU,FO.ID_KADEME3,FO.ID_OGRENCI,FO.TCKIMLIKNO TC_OGRENCI,FO.TAKMAAD,FO.ID_SINAV,FO.NET,FO.SS,ILK_ID_SINAV,ILK_NET,ILK_NET,ILK_SS,FREKANS,FO.DONEM
							
							,ISNULL(SVF.ID_SINIF, O.ID_SINIF)
							
							,O.ID_SUBE,FO.ID_DERS,OGT.TCKIMLIKNO TC_OGRETMEN,OGK.AD+' '+OGK.SOYAD OGRETMENADSOYAD,D.AD DERSAD
							,SB.AD SUBEAD
							
							,SINIFAD = ISNULL(SVF.AD, SNF.AD)
					--INTO	#TEMPOGRENCI 
					FROM	FrekansOgrenci				FO
					JOIN	v3Ogrenci					O	ON	O.ID_OGRENCI= FO.ID_OGRENCI	
					JOIN	Sinav						S	ON	S.ID_SINAV	= FO.ID_SINAV
					JOIN	v3Sube						SB	ON	SB.ID_SUBE	= O.ID_SUBE
					JOIN	v3Sinif						SNF	ON	SNF.ID_SINIF= O.ID_SINIF
					JOIN	#DERSLER					D	ON	D.ID_DERS	= FO.ID_DERS
					JOIN	eokul_v2.dbo.DersOgretmen	OS	ON	OS.ID_SINIF	= O.ID_SINIF
															AND OS.ID_DERS	= FO.ID_DERS
					JOIN	#EgitimTuru					ET	ON  ET.ID_EGITIMTURU = OS.ID_EGITIMTURU AND ET.ID_SINAVTURU = S.ID_SINAVTURU AND ET.ID_EGITIMTURU <> 6 -- YAZILI
					JOIN	OkyanusDB.dbo.v3Ogretmen	OGT ON	OGT.ID_OGRETMEN	= OS.ID_OGRETMEN
					JOIN	v3Kullanici					OGK	ON	OGK.TCKIMLIKNO	= OGT.TCKIMLIKNO
					LEFT JOIN v3Sinif					SV	ON	SV.ID_OGRENCI	= O.ID_OGRENCI AND FO.ID_SINAVTURU = 5
					LEFT JOIN v3Sinif					SVF	ON	SVF.ID_SINIF	= SV.ID_SINIF
					--JOIN	OkyanusDB.dbo.v3SubeGrupSinif	SGS	ON	SGS.ID_SINIF	= O.ID_SINIF
					WHERE	
						--	(FO.ID_SINAVTURU	<>	0 AND ((FO.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))) OR @ID_SINAVTURU='[]'))
						--AND (D.ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3)) OR @ID_KADEME3='[]')
						--AND (O.ID_SUBE			=	@ID_SUBE	OR @ID_SUBE	= 0)
						--AND (FO.TAKMAAD			=	@DERSAD		OR @DERSAD	= 'Tüm Dersler')
						--AND 
							(FO.DONEM			=	@DONEM)
						AND (S.FREKANSHESAPLA	=	1)
						AND S.AKTIF=1
						AND S.DURUM=2
			UNION ALL
					SELECT									
							FO.ID_SINAVTURU,FO.ID_KADEME3,FO.ID_OGRENCI,FO.TCKIMLIKNO TC_OGRENCI,FO.TAKMAAD,FO.ID_SINAV,FO.NET,FO.SS,ILK_ID_SINAV,ILK_NET,ILK_NET,ILK_SS,FREKANS,FO.DONEM
							,O.ID_SINIF,O.ID_SUBE,FO.ID_DERS,OGT.TCKIMLIKNO TC_OGRETMEN,OGK.AD+' '+OGK.SOYAD OGRETMENADSOYAD,D.AD DERSAD 
							,SB.AD SUBEAD,SNF.AD SINIFAD
					FROM	FrekansOgrenci				FO
					JOIN	v3Ogrenci					O	ON	O.ID_OGRENCI= FO.ID_OGRENCI
					JOIN	#DERSLER					D	ON	D.ID_DERS	= FO.ID_DERS
					JOIN	eokul_v2.dbo.DersOgretmen	OS	ON	OS.ID_SINIF	= O.ID_SINIF
															AND OS.ID_DERS	= FO.ID_DERS
															AND OS.ID_EGITIMTURU = 6 -- YAZILI 
					JOIN	OkyanusDB.dbo.v3Ogretmen	OGT ON	OGT.ID_OGRETMEN	= OS.ID_OGRETMEN
					JOIN	v3Kullanici					OGK	ON	OGK.TCKIMLIKNO	= OGT.TCKIMLIKNO
					JOIN	v3Sube						SB	ON	SB.ID_SUBE	= O.ID_SUBE
					JOIN	v3Sinif						SNF	ON	SNF.ID_SINIF= O.ID_SINIF
					WHERE	
						--	(FO.ID_SINAVTURU	=	0 AND ((0 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))) OR @ID_SINAVTURU='[]'))
						--AND (D.ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3)) OR @ID_KADEME3='[]')
						--AND (O.ID_SUBE			=	@ID_SUBE	OR @ID_SUBE	= 0)
						--AND (FO.TAKMAAD			=	@DERSAD		OR @DERSAD	= 'Tüm Dersler')
						--AND 
							(FO.DONEM			=	@DONEM)
							AND FO.ID_SINAVTURU = 0 -- YAZILI
					group by FO.ID_SINAVTURU,FO.ID_KADEME3,FO.ID_OGRENCI,FO.TCKIMLIKNO,FO.TAKMAAD,FO.ID_SINAV,FO.NET,FO.SS,ILK_ID_SINAV,ILK_NET,ILK_SS,FREKANS,FO.DONEM
							,O.ID_SINIF,O.ID_SUBE,FO.ID_DERS,OGT.TCKIMLIKNO,OGK.AD+' '+OGK.SOYAD ,D.AD  ,SB.AD,SNF.AD
			)
		END
		-- FREKANS OGRETMEN
		BEGIN
						

				DECLARE  @ID_STGENEL INT=9999

				
			--	INTO #SINAVTURU
			DROP TABLE IF EXISTS #SINAVTURU	
				DECLARE @SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				INSERT INTO @SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				INSERT INTO @SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
			SELECT * INTO #SINAVTURU FROM @SINAVTURU


			SELECT	 ID_SINAVTURU
					,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
			INTO #GenelFiltre2 FROM FrekansOgrenciDetay	T
			GROUP BY ID_SINAVTURU


			SELECT	 
						DERSAD
					,SUBEAD
					,OGRETMENADSOYAD
					,TC_OGRETMEN
					,T.ID_SUBE
					,ID_SINAVTURU
					,ID_KADEME3
			INTO #Filtre2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
			INTO #FiltreFrekans2 FROM #Filtre2	O
			INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
		UNION ALL			
			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
			FROM #Filtre2	O
			INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
		ORDER BY O.OGRETMENADSOYAD


			-- Öğretmen Genel
			SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SINAVTURU
		UNION ALL
			SELECT TC_OGRETMEN, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T			
			GROUP BY TC_OGRETMEN

			--DECLARE @GENELADET2 INT = (SELECT COUNT(DISTINCT TC_OGRETMEN) FROM #GenelFrekans2)

			SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
			INTO #GenelSira2 FROM #GenelFrekans2 T
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Genel
			SELECT TC_OGRETMEN, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, DERSAD, ID_SINAVTURU
		UNION ALL			
			SELECT TC_OGRETMEN, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, DERSAD


			SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD)
			INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelKampusFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE, ID_SINAVTURU
		UNION ALL
			SELECT TC_OGRETMEN, ID_SUBE, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE


			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
			INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreKampusFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU
		UNION ALL
			SELECT TC_OGRETMEN, ID_SUBE, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD), SUBEAD = S.AD
			INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
			INTO #OgrenciSinifListe2 
			FROM #Filtre2				O
			JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
											AND D.DERSAD = O.DERSAD 
											AND D.ID_SUBE = O.ID_SUBE 
											AND D.ID_SINAVTURU = O.ID_SINAVTURU 
											AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
		UNION ALL 			
			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
			FROM #Filtre2				O
			JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
											AND D.DERSAD = O.DERSAD 
											AND D.ID_SUBE = O.ID_SUBE 
											AND D.ID_SINAVTURU = O.ID_SINAVTURU 
											AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
			
			INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@ID_STGENEL,'GENEL','GNL',1,2)
				
			-- Liste
			SELECT 
				 [SINAV TÜRÜ]		= S.AD 
				,[STKISAAD]			= S.KISAAD
				,[BRANŞ]			= F.DERSAD
				,[TC_OGRETMEN]		= F.TC_OGRETMEN
				,[FREKANS]			= MAX(F.FREKANS)
				,[FREKANS KATKI]	= CASE 
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>75	THEN	'ÇOK ETKİLİ'
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>50	THEN	'ETKİLİ'
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>25	THEN	'NORMAL ETKİLİ'
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>-1	THEN	'AZ ETKİLİ'
										ELSE 'ETKİSİZ'
									END
				,[KAMPÜS GENEL]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2	tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU)>1							then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU ORDER BY K.SUBEAD		FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))					
				,[GENEL ZÜMRE]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2		tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD )>1	then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU AND K.DERSAD = F.DERSAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))
				,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR)
				--,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET2 AS VARCHAR)
					,F.ID_SINAVTURU
			INTO	#T1
			FROM #FiltreFrekans2				F
			INNER JOIN #OgrenciSinifListe2	O ON O.TC_OGRETMEN	= F.TC_OGRETMEN		AND O.ID_SINAVTURU = F.ID_SINAVTURU		AND O.DERSAD = F.DERSAD		
			INNER JOIN #SINAVTURU			S ON S.ID_SINAVTURU = F.ID_SINAVTURU
			LEFT  JOIN #GenelSira2			G ON G.TC_OGRETMEN	= F.TC_OGRETMEN		AND G.ID_SINAVTURU = S.ID_SINAVTURU
			GROUP BY S.AD, F.TC_OGRETMEN, F.ID_SINAVTURU, F.DERSAD, G.SN,S.KISAAD

			TRUNCATE TABLE FrekansOgretmen

			--DELETE FROM FrekansOgretmen WHERE DONEM=@DONEM

			INSERT INTO FrekansOgretmen (SINAVTURU,STKISAAD,BRANS,TC_OGRETMEN,FREKANS,FREKANSKATKI,KAMPUSGENEL,GENELZUMRE,GENEL,ID_SINAVTURU)
			SELECT [SINAV TÜRÜ],STKISAAD,[BRANŞ],TC_OGRETMEN,FREKANS,[FREKANS KATKI],[KAMPÜS GENEL],[GENEL ZÜMRE],GENEL,ID_SINAVTURU FROM #T1 WHERE FREKANS IS NOT NULL ORDER BY TC_OGRETMEN,BRANŞ,ID_SINAVTURU

				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2

			--SELECT	 [SINAV TÜRÜ]	= SINAVTURU
			--		,STKISAAD
			--		,[BRANŞ]		= BRANS
			--		,TC_OGRETMEN
			--		,FREKANS
			--		,[FREKANS KATKI]= FREKANSKATKI
			--		,[KAMPÜS GENEL]	= KAMPUSGENEL
			--		,[GENEL ZÜMRE]	=GENELZUMRE
			--		,GENEL
			--		,ID_SINAVTURU FROM FrekansOgretmen
			----where TC_OGRETMEN='46846434098'
			--ORDER BY TC_OGRETMEN,BRANS,ID_SINAVTURU
		END

			DROP TABLE #EgitimTuru

	END
	


	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_FrekansSinavOgrenci]    Script Date: 22.11.2021 11:14:04 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_FrekansSinavOgrenci]
	@ISLEM			INT				= NULL,
	@TCKIMLIKNO		VARCHAR(11)		= NULL,
	@OTURUM			VARCHAR(36)		= NULL,
	@ID_MENU		INT				= NULL,
	
	@TC_OGRENCI		VARCHAR(11)		= NULL,
	@DERSLIST		VARCHAR(MAX)	= NULL,
	@DONEM			VARCHAR(MAX)	= NULL,
	@ID_SUBELIST	VARCHAR(MAX)	= NULL,
	@ID_KADEME3		INT				= NULL,
	@ID_SINAVTURU	INT				= NULL,
	@ISJSON			BIT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,TC_OGRENCI		= @TC_OGRENCI
				,DERSLIST		= @DERSLIST
				,DONEM			= @DONEM
				,ID_KADEME3		= @ID_KADEME3
				,ID_SINAVTURU	= @ID_SINAVTURU
				,ID_SUBELIST	= @ID_SUBELIST
				,[ISJSON]		= @ISJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN

				

				--DECLARE	 @TC_OGRENCI	VARCHAR(MAX)= '19835634380'
				--		,@DERSLIST		VARCHAR(MAX)= '["Fizik","Tarih"]'
				--		,@DONEM			VARCHAR(MAX)= '2019'
				--		,@ID_KADEME3	INT			= 18
				--		,@ID_SINAVTURU	INT			= 3
				--		,@ID_SUBE		INT			= 447
				--		,@ISJSON		BIT			= 1


				DROP TABLE IF EXISTS #OGRLIST
				DROP TABLE IF EXISTS #FREKANS
				DROP TABLE IF EXISTS #SINAVLIST
				DROP TABLE IF EXISTS #SINAVWHILE

				;WITH SUBELIST AS (	SELECT ID_SUBE
									FROM v3Sube
									WHERE ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
				)
				SELECT K.TCKIMLIKNO, SD.ID_SINIF, SD.ID_SUBE, SD.ID_KADEME3,SD.SUBEAD, SD.SINIF, K.AD, K.SOYAD
				INTO #OGRLIST
				FROM OkyanusDB.dbo.vw_SinifOgrenci	SO
				JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF	= SO.ID_SINIF
				JOIN SUBELIST						SL	ON	SL.ID_SUBE	= SD.ID_SUBE
				JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO= SO.TCKIMLIKNO
				WHERE	SD.DONEM		= @DONEM
					AND ID_KADEME3		= @ID_KADEME3

				SELECT	 TCKIMLIKNO	= FO.TC_OGRENCI
						,ID_SINAV	= FO.ID_SINAV
						,SS			= FO.ILK_SS 
						,TAKMAAD	= REPLACE(FO.TAKMAAD,'.','')
						,FREKANS	= FO.FREKANS
				INTO #FREKANS
				FROM v2FrekansOgrenciDetay	FO
				JOIN #OGRLIST				OL	ON	OL.TCKIMLIKNO	= FO.TC_OGRENCI
				WHERE	DONEM				= @DONEM
					AND FO.ID_SINAVTURU		= @ID_SINAVTURU
					AND FO.TAKMAAD			IN (SELECT VALUE FROM OPENJSON(@DERSLIST))
				UNION 
				SELECT	 FO.TCKIMLIKNO
						,FO.ID_SINAV
						,SS
						,'TOPLAM'
						,FO.FREKANS
				FROM v2FrekansOgrenciSinav	FO
				JOIN #OGRLIST				OL	ON	OL.TCKIMLIKNO	= FO.TCKIMLIKNO
				WHERE	DONEM				= @DONEM
					AND FO.ID_SINAVTURU		= @ID_SINAVTURU

				INSERT INTO #FREKANS (TCKIMLIKNO, ID_SINAV, SS, TAKMAAD, FREKANS)
				SELECT TCKIMLIKNO, ID_SINAV = 0, SS, TAKMAAD, FREKANS = CAST(AVG(FREKANS) AS decimal(8,2))
				FROM #FREKANS
				GROUP BY TCKIMLIKNO,SS,TAKMAAD
				ORDER BY TCKIMLIKNO,TAKMAAD,ID_SINAV

				SELECT S.ID_SINAV, S.AD AS SINAVAD, ROW_NUMBER() OVER( ORDER BY S.SINAVTARIH) AS RN
				INTO #SINAVLIST
				FROM Sinav		S
				WHERE ID_SINAV IN (SELECT DISTINCT ID_SINAV FROM #FREKANS)
				UNION 
				SELECT ID_SINAV = 0,SINAVAD = 'ORT',RN = 999
				WHERE @ID_SINAVTURU != 6 -- AAYKS DEĞİLSE

				DECLARE  @COL_IDSINAV	varchar(max)
						,@COL_TAKMAAD	varchar(max)
						,@COL_TAKMAAD2	varchar(max)
						,@SQL			varchar(max)
						,@COL_TAKMAAD3	varchar(max) = ''	
						,@COL_SELECT	varchar(max) = ''
		
				SELECT @COL_IDSINAV = Coalesce(@COL_IDSINAV  +',','') + QUOTENAME(ID_SINAV) FROM #SINAVLIST ORDER BY  RN
				SELECT @COL_TAKMAAD = Coalesce(@COL_TAKMAAD  +',','') + QUOTENAME(TAKMAAD) FROM (SELECT TOP 999 TAKMAAD FROM #FREKANS GROUP BY TAKMAAD ORDER BY IIF(TAKMAAD = 'TOPLAM',1,0) ) AS S 
				SELECT @COL_TAKMAAD2 = Coalesce(@COL_TAKMAAD2  +',','') + 'F.TAKMAAD+''-' + CAST(ID_SINAV AS varchar) + ''' AS [TAKMAAD-' + CAST(ID_SINAV AS varchar) + ']' FROM #SINAVLIST ORDER BY  RN

				SELECT * INTO #SINAVWHILE FROM #SINAVLIST
				WHILE EXISTS(SELECT * FROM #SINAVWHILE)
				BEGIN
					DECLARE @ID_SINAV INT = (SELECT TOP 1 ID_SINAV FROM #SINAVWHILE ORDER BY RN)

					DECLARE @COL_TAKMAAD4	varchar(max)=NULL
					DECLARE @COL_WHILE	varchar(max)=NULL
					SELECT @COL_WHILE = Coalesce(@COL_WHILE  +',','') 
							+'['+TAKMAAD+'-'+CAST(@ID_SINAV AS varchar)+']'
					FROM (	SELECT TOP 99 TAKMAAD 
							FROM #FREKANS 				
							GROUP BY TAKMAAD
							ORDER BY  IIF(TAKMAAD = 'TOPLAM',1,0)) AS DD

					SET @COL_TAKMAAD4 = 'PIVOT (MAX(['+CAST(@ID_SINAV AS varchar)+'])	FOR [TAKMAAD-'+CAST(@ID_SINAV AS varchar)+']	IN(' + @COL_WHILE+  '))  as P ' 

		
					SET @COL_WHILE	= NULL
					SELECT @COL_WHILE = Coalesce(@COL_WHILE  +',','') 
							+'['+TAKMAAD+'-'+CAST(@ID_SINAV AS varchar)+'] = MAX('+'['+TAKMAAD+'-'+CAST(@ID_SINAV AS varchar)+']'+')'
					FROM (	SELECT TOP 99 TAKMAAD 
							FROM #FREKANS 				
							GROUP BY TAKMAAD
							ORDER BY  IIF(TAKMAAD = 'TOPLAM',1,0)) AS DD

					SET @COL_SELECT =  @COL_SELECT +','+  @COL_WHILE
					SET @COL_TAKMAAD3 = @COL_TAKMAAD3 +  @COL_TAKMAAD4

					DELETE FROM #SINAVWHILE WHERE ID_SINAV = @ID_SINAV

				END

				IF @ISJSON = 1
				BEGIN

					SET @SQL  ='SELECT (
									SELECT 
									(	SELECT O.TCKIMLIKNO, SUBEAD, SINIF, AD, SOYAD
											'+@COL_SELECT+' 
										FROM (
											SELECT * FROM (
												SELECT F.TCKIMLIKNO,FREKANS,ID_SINAV, '+@COL_TAKMAAD2+'
												FROM #FREKANS F
											) AS S
											PIVOT (MAX(S.FREKANS)	FOR S.ID_SINAV	IN('+@COL_IDSINAV+'))  as PP
										) AS D
										'+@COL_TAKMAAD3+'
										JOIN #OGRLIST	O	ON	O.TCKIMLIKNO	= P.TCKIMLIKNO
										GROUP BY O.TCKIMLIKNO, SUBEAD, SINIF, AD, SOYAD
										ORDER BY SUBEAD, SINIF, AD, SOYAD
										FOR JSON PATH,INCLUDE_NULL_VALUES
									) AS OGRLIST,
									(SELECT * FROM #SINAVLIST ORDER BY RN FOR JSON PATH) AS SINAVLIST,
									(SELECT DISTINCT TAKMAAD, IIF(TAKMAAD = ''TOPLAM'',1,0) AS RN , MAX(SS) AS SS FROM #FREKANS  GROUP BY TAKMAAD ORDER BY RN,TAKMAAD FOR JSON PATH) AS DERSLIST
									FOR JSON PATH
								)AS D '

					PRINT @SQL
					EXEC (@SQL)

				END
				ELSE
				BEGIN

					SET @SQL  ='SELECT O.TCKIMLIKNO, SUBEAD, SINIF, AD, SOYAD
									'+@COL_SELECT+' 
								FROM (
									SELECT * FROM (
										SELECT F.TCKIMLIKNO,FREKANS,ID_SINAV, '+@COL_TAKMAAD2+'
										FROM #FREKANS F
									) AS S
									PIVOT (MAX(S.FREKANS)	FOR S.ID_SINAV	IN('+@COL_IDSINAV+'))  as PP
								) AS D
								'+@COL_TAKMAAD3+'
								JOIN #OGRLIST	O	ON	O.TCKIMLIKNO	= P.TCKIMLIKNO
								GROUP BY O.TCKIMLIKNO, SUBEAD, SINIF, AD, SOYAD
								ORDER BY SUBEAD, SINIF, AD, SOYAD '
					PRINT @SQL
					EXEC (@SQL)
	
					SELECT * FROM #SINAVLIST
					ORDER BY RN

					SELECT DISTINCT TAKMAAD, IIF(TAKMAAD = 'TOPLAM',1,0) AS RN , MAX(SS) AS SS FROM #FREKANS  GROUP BY TAKMAAD ORDER BY RN,TAKMAAD

				END

			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_FrekansSistem]    Script Date: 22.11.2021 11:14:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_FrekansSistem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON					= @SQLJSON		
			,FREKANSKARNE				= @FREKANSKARNE	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--	exec sp_FrekansSistem @ISLEM=2,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN

	DECLARE @ID_STGENEL INT=9999
		
		BEGIN

			--	INTO #SINAVTURU
			DROP TABLE IF EXISTS #SINAVTURU	
				DECLARE @SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				INSERT INTO @SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				INSERT INTO @SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
			SELECT * INTO #SINAVTURU FROM @SINAVTURU

			--	INTO #DERSLER
			DROP TABLE IF EXISTS #DERSLER						
			SELECT	D.* 
			INTO	#DERSLER 
			FROM	v3SinavDers D
			INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD


		END
		
		IF @DONEM=''
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		END

--	exec sp_FrekansSistem @TCKIMLIKNO='36412660570',@FREKANSKARNE=1 ,@OTURUM='23C46AF7-B1C6-4B9D-8782-530181048CBA',@ISLEM=2,@DERSAD='Tümü',@DONEM='',@ID_SUBE=0,@ID_KADEME3='[0]',@ID_SINAVTURU='[-1]',@ID_SINIF=101676,@TC_OGRETMEN='36412660570'
		IF @ISLEM =	1-- 
		BEGIN 
		

--DECLARE @DERSAD VARCHAR(MAX) = 'GEOMETRİ', @ID_SUBE INT = 236, @ID_KADEME3 VARCHAR(MAX) = '[0,15,16,17,18]', @ID_SINAVTURU VARCHAR(MAX) = '[2,6]'

			SELECT	 
					 DERSAD
					,SUBEAD
					,OGRETMENADSOYAD
					,TC_OGRETMEN
					,T.ID_SUBE
					,ID_SINAVTURU
					,ID_KADEME3
			INTO #Filtre FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				AND (DERSAD	= @DERSAD OR @DERSAD = 'Tümü') 
				AND (ID_SUBE = @ID_SUBE OR @ID_SUBE = 0) 
				AND DONEM=@DONEM
			GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
			INTO #FiltreFrekans FROM #Filtre	O
			INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
			ORDER BY O.OGRETMENADSOYAD


			-- Öğretmen Genel
			SELECT TC_OGRETMEN, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN

			DECLARE @GENELADET INT = (SELECT COUNT(DISTINCT TC_OGRETMEN) FROM #GenelFrekans)

			SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC)
			INTO #GenelSira FROM #GenelFrekans
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Genel
			SELECT TC_OGRETMEN, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN, DERSAD


			SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans G WHERE G.DERSAD = F.DERSAD)
			INTO #GenelZumreSira FROM #GenelZumreFrekans	F
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelKampusFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN, ID_SUBE


			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
			INTO #GenelKampusSira FROM #GenelKampusFrekans	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreKampusFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD), SUBEAD = S.AD
			INTO #GenelZumreKampusSira FROM #GenelZumreKampusFrekans	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
			INTO #OgrenciSinifListe 
			FROM #Filtre					O
			INNER JOIN FrekansOgrenciDetay	D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

			-- Liste
			SELECT 
					 [SIRA]				= CASE WHEN @DERSAD = 'Tümü' THEN ISNULL(G.SN,9999) ELSE (SELECT MIN(SN) FROM #GenelZumreSira K WHERE K.TC_OGRETMEN=F.TC_OGRETMEN AND K.DERSAD=@DERSAD )   END
					,[BRANŞ]			= F.DERSAD 
					,[KAMPÜS]			= ISNULL( (SELECT STUFF((SELECT   '<br>' +CAST(K.SUBEAD AS VARCHAR)	FROM #GenelKampusSira K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[ÖĞRETMEN]			= F.OGRETMENADSOYAD 
					,[SORU SAYISI]		= SORUSAYISI
					,[HB NET]			= F.HBNET
					,[TC_OGRETMEN]		= F.TC_OGRETMEN
					,[FREKANS]			= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')
					,[SINIF SAYISI]		= O.SINIFSAY
					,[ÖĞRENCİ SAYISI]	= O.OGRSAY
					,[KAMPÜS ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN  AND K.DERSAD = tt.DERSAD )>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira	K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[KAMPÜS GENEL]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[GENEL ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND K.DERSAD = tt.DERSAD )>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET AS VARCHAR),'-')
					
			INTO		#T
			FROM		#FiltreFrekans		F
			INNER JOIN #OgrenciSinifListe	O ON O.TC_OGRETMEN = F.TC_OGRETMEN AND O.DERSAD = F.DERSAD
			LEFT  JOIN #GenelSira			G ON G.TC_OGRETMEN = F.TC_OGRETMEN

		
			select(
						select * from(
							select 
							(					
								SELECT		*
								FROM		#T 
								--ORDER BY [GENEL]--[ÖĞRETMEN]	,[GENEL]
								order by SIRA
								FOR JSON AUTO
							) as t												
						) as tablo FOR JSON AUTO
					) as tt
					
			DROP TABLE IF EXISTS #T
			DROP TABLE IF EXISTS #Filtre
			DROP TABLE IF EXISTS #FiltreFrekans
			DROP TABLE IF EXISTS #OgrenciSinifListe 

			DROP TABLE IF EXISTS #GenelFrekans
			DROP TABLE IF EXISTS #GenelSira

			DROP TABLE IF EXISTS #GenelZumreFrekans
			DROP TABLE IF EXISTS #GenelZumreSira

			DROP TABLE IF EXISTS #GenelKampusFrekans
			DROP TABLE IF EXISTS #GenelKampusSira

			DROP TABLE IF EXISTS #GenelZumreKampusFrekans
			DROP TABLE IF EXISTS #GenelZumreKampusSira

		


		END
		IF @ISLEM = 2 -- GENEL SIRALAMA 
		BEGIN 

			SELECT	 [SINAV TÜRÜ]	= SINAVTURU
					,STKISAAD
					,[BRANŞ]		= BRANS
					,TC_OGRETMEN
					,FREKANS
					,[FREKANS KATKI]= FREKANSKATKI
					,[KAMPÜS GENEL]	= KAMPUSGENEL
					,[GENEL ZÜMRE]	=GENELZUMRE
					,GENEL
					,ID_SINAVTURU 
			INTO	#T1
			FROM	FrekansOgretmen
			WHERE	TC_OGRETMEN	= @TCKIMLIKNO


			-- frekans karne değil ise  veya (ders,sinav türü,sınıf)tümü seçilmemişse Frekansogretmendeki gösterecek
			IF (@FREKANSKARNE=0 
				OR (	@DERSAD<>'Tümü' 
					AND -1	NOT IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) 
					AND 0	NOT IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3)) 					
					)
				)
			BEGIN
		
				SELECT	 ID_SINAVTURU
						,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
				INTO #GenelFiltre2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
					AND (DERSAD		= @DERSAD OR @DERSAD = 'Tümü') 
				GROUP BY ID_SINAVTURU


				SELECT	 
							DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
				INTO #Filtre2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
					AND (DERSAD		= @DERSAD OR @DERSAD = 'Tümü') 
					AND (ID_SUBE	= @ID_SUBE OR @ID_SUBE = 0)
					AND TC_OGRETMEN	= @TC_OGRETMEN
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			
				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
				INTO #FiltreFrekans2 FROM #Filtre2	O
				INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
			UNION ALL			
				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
				FROM #Filtre2	O
				INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
			ORDER BY O.OGRETMENADSOYAD


				-- Öğretmen Genel
				SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SINAVTURU
			UNION ALL				
				SELECT TC_OGRETMEN, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T			
				GROUP BY TC_OGRETMEN

				SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
				INTO #GenelSira2 FROM #GenelFrekans2 T
				WHERE FREKANS IS NOT NULL
				
				--------------------------------------------------------------------

				-- Öğretmen Zümre Genel
				SELECT TC_OGRETMEN, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, DERSAD, ID_SINAVTURU
			UNION ALL			
				SELECT TC_OGRETMEN, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, DERSAD


				SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
				INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE, ID_SINAVTURU
			UNION ALL
				SELECT TC_OGRETMEN, ID_SUBE, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
				INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Zümre Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreKampusFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU
			UNION ALL
				SELECT TC_OGRETMEN, ID_SUBE, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
				INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------


				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
				INTO #OgrenciSinifListe2 
				FROM #Filtre2				O
				JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
												AND D.DERSAD = O.DERSAD 
												AND D.ID_SUBE = O.ID_SUBE 
												AND D.ID_SINAVTURU = O.ID_SINAVTURU 
												AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
			UNION ALL 			
				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
				FROM #Filtre2				O
				JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
												AND D.DERSAD = O.DERSAD 
												AND D.ID_SUBE = O.ID_SUBE 
												AND D.ID_SINAVTURU = O.ID_SINAVTURU 
												AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

			
				INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@ID_STGENEL,'GENEL','GNL',1,2)

				-- Liste
				DELETE FROM #T1

				INSERT INTO #T1
				SELECT 
					 [SINAV TÜRÜ]		= S.AD 
					,[STKISAAD]			= S.KISAAD
					,[BRANŞ]			= F.DERSAD
					,[TC_OGRETMEN]		= F.TC_OGRETMEN
					,[FREKANS]			= MAX(F.FREKANS)
					,[FREKANS KATKI]	= CASE 
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>75	THEN	'ÇOK ETKİLİ'
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>50	THEN	'ETKİLİ'
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>25	THEN	'NORMAL ETKİLİ'
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>-1	THEN	'AZ ETKİLİ'
											ELSE 'ETKİSİZ'
										END
					,[KAMPÜS GENEL]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2	tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)								FROM #GenelKampusSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))					
					,[GENEL ZÜMRE]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2		tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD )>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)		FROM #GenelZumreSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD  AND K.ID_SINAVTURU=F.ID_SINAVTURU FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))
					,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR)
					--,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET2 AS VARCHAR)
					--,[GENEL]			= CASE WHEN G.ID_SINAVTURU=@ID_STGENEL THEN CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET3 AS VARCHAR) ELSE CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET2 AS VARCHAR) END 
						,F.ID_SINAVTURU
				--INTO	#T1
				FROM #FiltreFrekans2				F
				INNER JOIN #OgrenciSinifListe2	O ON O.TC_OGRETMEN	= F.TC_OGRETMEN		AND O.ID_SINAVTURU = F.ID_SINAVTURU		AND O.DERSAD = F.DERSAD		
				INNER JOIN #SINAVTURU			S ON S.ID_SINAVTURU = F.ID_SINAVTURU
				LEFT  JOIN #GenelSira2			G ON G.TC_OGRETMEN	= F.TC_OGRETMEN		AND G.ID_SINAVTURU = S.ID_SINAVTURU
				GROUP BY S.AD, F.TC_OGRETMEN, F.ID_SINAVTURU, F.DERSAD, G.SN,S.KISAAD

		

			END


			-------------------------------------------------	(2.2)	2. SAYFA ALT


			print 11
			SELECT	 DERSAD
					,SUBEAD
					,OGRETMENADSOYAD
					,MAX(T.SS) SORUSAYISI
					,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
					--,CAST(AVG(FREKANS) AS decimal(8,2)) FREKANS --coalesce(some_column, 0)
					,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
					,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
					,TC_OGRETMEN
					,ID_DERS
					,T.ID_SUBE
					,T.ID_SINAVTURU
					,ID_SINIF
					,SINIFAD
					,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
					,AVG(ILK_SS) ILK_SS
			INTO	#ORTALAMA3
			FROM	FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) )
				AND (DERSAD		= @DERSAD OR @DERSAD = 'Tümü') 
				AND (ID_SUBE	= @ID_SUBE OR @ID_SUBE = 0)
				AND TC_OGRETMEN	= @TC_OGRETMEN
				--AND FREKANS IS NOT NULL
			GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD


			SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
					,[BRANŞ]		= DERSAD
					,[SINAV TÜRÜ]	= ST.AD
					,[KAMPÜS]		= SUBEAD
					,[SINIF]		= ORT.SINIFAD	
					,[H.B. NET ORT.]= ORT.HBNET	
					,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
					,ORT.FREKANS		
					,ID_SINIF
					,TC_OGRETMEN
					,SIRA
					,ORT.ID_SINAVTURU
			INTO	#T2
			FROM	#ORTALAMA3	ORT
			JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
									AND ST.SIRA			<> 2
			WHERE	ORT.FREKANS IS NOT NULL
			ORDER BY ST.SIRA


			select(
						select * from(
							select 
							(						 
								SELECT * FROM #T1
								ORDER BY BRANŞ,ID_SINAVTURU
								FOR JSON AUTO
							) as t1
							,( 
								SELECT * FROM #T2
								ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
								FOR JSON AUTO
							)as t2							
						) as tablo FOR JSON AUTO
					) as tt


					
					
			DROP TABLE IF EXISTS #ORTALAMA3
			DROP TABLE IF EXISTS #T2
				DROP TABLE #T1
				DROP TABLE #Filtre2
				DROP TABLE #GenelFiltre2
				DROP TABLE #FiltreFrekans2
				DROP TABLE #OgrenciSinifListe2 

				DROP TABLE #GenelFrekans2
				DROP TABLE #GenelSira2

				DROP TABLE #GenelZumreFrekans2
				DROP TABLE #GenelZumreSira2

				DROP TABLE #GenelKampusFrekans2
				DROP TABLE #GenelKampusSira2

				DROP TABLE #GenelZumreKampusFrekans2
				DROP TABLE #GenelZumreKampusSira2

				
			DROP TABLE IF EXISTS #T
			DROP TABLE IF EXISTS #Filtre
			DROP TABLE IF EXISTS #FiltreFrekans
			DROP TABLE IF EXISTS #OgrenciSinifListe 

			DROP TABLE IF EXISTS #GenelFrekans
			DROP TABLE IF EXISTS #GenelSira

			DROP TABLE IF EXISTS #GenelZumreFrekans
			DROP TABLE IF EXISTS #GenelZumreSira

			DROP TABLE IF EXISTS #GenelKampusFrekans
			DROP TABLE IF EXISTS #GenelKampusSira

			DROP TABLE IF EXISTS #GenelZumreKampusFrekans
			DROP TABLE IF EXISTS #GenelZumreKampusSira
		END	
		IF @ISLEM = 3
		BEGIN 

			SELECT	[KAMPÜS]	= SUBEAD,
					[SINIF]		= SINIFAD,
					[BRANŞ]		= TAKMAAD,
					[SINAV TÜRÜ]= ST.AD,
					[AD SOYAD]	= K.AD+' '+K.SOYAD,
					[SORU SAYISI]=MAX(T.ILK_SS),
					[H.B NET]	= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
					[NET ORT]	= CAST(AVG(T.NET) AS DECIMAL(8,2)),
					[HEDEFE UZAKLIK]= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),
					--[HEDEF]		= 100,--T.ILK_SS-T.ILK_NET,
					--[FREKANS]	= CAST(AVG(FREKANS) AS DECIMAL(8,2))					
					[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					,TC_OGRENCI,TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU--,ID_SINAV
			INTO	#FREKANSOGRENCI
			FROM	FrekansOgrenciDetay	T
			JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
			JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
			WHERE 	T.ID_SINIF	= @ID_SINIF
				AND TC_OGRETMEN	= @TC_OGRETMEN
				AND T.DERSAD	= @DERSAD
				AND FREKANS		IS NOT NULL
				AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
			GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET--,ID_SINAV

			--SELECT * FROM #FREKANSOGRENCI ORDER BY OGRENCIADSOYAD

			select(
						select * from(
							select 
							(					
								SELECT		* 
								FROM		#FREKANSOGRENCI 
								ORDER BY	[AD SOYAD]
								FOR JSON AUTO
							) as t3
												
						) as tablo FOR JSON AUTO
					) as tt
			DROP TABLE #FREKANSOGRENCI
		END
		IF @ISLEM = 4
		BEGIN 

			SELECT	 SUBEAD
					,TAKMAAD
					,ST.AD SINAVTURU
					,CASE 
						WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
						ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
					END SINAVADI
					,CAST(CASE 
						WHEN ST.ID_SINAVTURU=0 THEN (	
														SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
														INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
														WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
														GROUP BY YO.TELAFI
													) 
						ELSE						(	T.FREKANS
													) 
					END AS decimal(8,2)) SINAVPUANI
					,K.AD+' '+K.SOYAD ADSOYAD
					,SINIFAD
					,SS 
					,HBNET
					,ILK_SS HEDEF
					,NET
			INTO	#OGRENCISINAV
			FROM	FrekansOgrenciDetay	T
			JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
			JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
			WHERE	TC_OGRENCI		=	@TC_OGRENCI
				AND TAKMAAD			=	@DERSAD
				AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
				AND T.FREKANS IS NOT NULL
			GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET

			IF (SELECT COUNT(1) FROM #OGRENCISINAV)>1
			BEGIN
				INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET)
				SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,HBNET,HEDEF,CAST(AVG(NET) AS DECIMAL(8,2))
				FROM	#OGRENCISINAV 
				GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HBNET,HEDEF
			END

			select(
						select * from(
							select 
							(					
								SELECT		[KAMPÜS]		= SUBEAD,
											[SINIF]			= SINIFAD,
											[BRANŞ]			= TAKMAAD,
											[SINAV TÜRÜ]	= SINAVTURU,
											[SINAV]			= SINAVADI,
											[SORU SAYISI]	= SS,
											[H.B. NET ORT.] = HBNET,
											[HEDEFE UZAKLIK]= HEDEF-HBNET,
											[SON NET]		= NET,
											[PUAN]			= SINAVPUANI,
											[FREKANS]		= SINAVPUANI,
											ADSOYAD
								FROM		#OGRENCISINAV 
								FOR JSON AUTO
							) as t4
												
						) as tablo FOR JSON AUTO
					) as tt
			
			DROP TABLE IF EXISTS #OGRENCISINAV
		END
		IF @ISLEM = 5
		BEGIN 
			
					
			

			DECLARE @SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
			IF (0 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
			BEGIN

					SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
							,'FREKANS' SINAVADI
					INTO	#FREKANSOGRETMEN2
					FROM	FrekansOgrenciDetay	T
					JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
					WHERE 	TC_OGRETMEN	= @TC_OGRETMEN --'56377383260'
						AND FREKANS IS NOT NULL
						AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
						--AND ID_SINAVTURU=0
					GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

					SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO ##PIVOT  FROM #FREKANSOGRETMEN2

					INSERT INTO @SINAVLAR (SINAVADI) VALUES ('FREKANS')

			END
			ELSE
			BEGIN

					SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
							,CASE 
								WHEN ST.ID_SINAVTURU=0 THEN (SELECT TOP 1 AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
								ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
							END SINAVADI
					INTO	#FREKANSOGRETMEN
					FROM	FrekansOgrenciDetay	T
					JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
					WHERE 	TC_OGRETMEN	= @TC_OGRETMEN --'56377383260'
						AND FREKANS IS NOT NULL
						AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
						--AND ID_SINAVTURU=0
					GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

					--TAHSİN--
					INSERT INTO #FREKANSOGRETMEN
					SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,999999999 as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
							,ST.KISAAD+' ORT' as SINAVADI
					FROM	FrekansOgrenciDetay	T
					JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
					WHERE 	TC_OGRETMEN	= @TC_OGRETMEN --'56377383260'
						AND FREKANS IS NOT NULL
						AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
						--AND ID_SINAVTURU=0
					GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
					--TAHSİN--
					
					DECLARE @cols	AS NVARCHAR(MAX),
							@cols2	AS NVARCHAR(MAX),
							@cols3	AS NVARCHAR(MAX),
							@SQL	AS NVARCHAR(MAX);

					--SET @cols = STUFF((SELECT distinct ',' + QUOTENAME(c.SINAVADI) 
					--			FROM #FREKANSOGRETMEN c
					--			FOR XML PATH(''), TYPE
					--			).value('.', 'NVARCHAR(MAX)') 
					--		,1,1,'')

					--SET @cols2 = STUFF((SELECT distinct ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
					----',' + QUOTENAME(c.SINAVADI) 
					--			FROM #FREKANSOGRETMEN c
					--			FOR XML PATH(''), TYPE
					--			).value('.', 'NVARCHAR(MAX)') 
					--		,1,1,'')

					--		--SUM DAN DOLAYI SORUN OLABILIR
					--SET @cols3 = STUFF((SELECT distinct ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
					----',' + QUOTENAME(c.SINAVADI) 
					--			FROM #FREKANSOGRETMEN c
					--			FOR XML PATH(''), TYPE
					--			).value('.', 'NVARCHAR(MAX)') 
					--		,1,1,'')

					--TAHSİN--
					SET @cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
								FROM #FREKANSOGRETMEN c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
								FOR XML PATH(''), TYPE
								).value('.', 'NVARCHAR(MAX)') 
							,1,1,'')
		
					SET @cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
					--',' + QUOTENAME(c.SINAVADI) 
								FROM #FREKANSOGRETMEN c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
								FOR XML PATH(''), TYPE
								).value('.', 'NVARCHAR(MAX)') 
							,1,1,'')

							--SUM DAN DOLAYI SORUN OLABILIR
					SET @cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
					--',' + QUOTENAME(c.SINAVADI) 
								FROM #FREKANSOGRETMEN c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
								FOR XML PATH(''), TYPE
								).value('.', 'NVARCHAR(MAX)') 
							,1,1,'')
					--TAHSİN--


					SET @SQL='SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols2 AS varchar(MAX))+' INTO ##PIVOT1 FROM (
						SELECT * FROM #FREKANSOGRETMEN
					)AS TABLO
					PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@cols AS varchar(MAX))+')) AS P'
					

					EXECUTE (@SQL)

					set @SQL='
						SELECT		TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols3 AS varchar(MAX))+'
								INTO		##PIVOT
								FROM		##PIVOT1 
								group by TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]'

								execute (@SQL)
								

					INSERT INTO @SINAVLAR (SINAVADI)
						SELECT	DISTINCT SINAVADI
						FROM	#FREKANSOGRETMEN
			END
			select(
						select * from(
							select 
							(					
								SELECT		*
								FROM		##PIVOT 
								FOR JSON AUTO
							) as t5,
							(					
								SELECT	SINAVADI
								FROM	@SINAVLAR
								FOR JSON AUTO
							) as t6
												
						) as tablo FOR JSON AUTO
					) as tt

			DROP TABLE ##PIVOT
			DROP TABLE ##PIVOT1
			DROP TABLE #FREKANSOGRETMEN
			DROP TABLE #FREKANSOGRETMEN2
			
		END
		IF @ISLEM = 6 -- DERSLER
		BEGIN 
			
			select(
						select * from(
							select 
							(	

								SELECT	DISTINCT D.AD
								FROM	#DERSLER			D
								JOIN	FrekansOgrenciDetay OD	ON	OD.DERSAD=D.AD
								WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@ID_KADEME3)) 
									AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU)) 

								FOR JSON AUTO
							) as t5
												
						) as tablo FOR JSON AUTO
					) as tt
		END
		IF @ISLEM = 7 -- SINAV TURU
		BEGIN 
			
			

			select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
			INTO #GrupSinavTuru 
			from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
		union 
			select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
		union 
			select 0,15 , 'YAZILI', 'YAZ'
		union 
			select 0,16 , 'YAZILI', 'YAZ'
		union 
			select 0,17 , 'YAZILI', 'YAZ'
		union 
			select 0,18 , 'YAZILI', 'YAZ'

				INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
				SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
				FROM v3Kademe3	K
				JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
				WHERE ID_KADEME3 IN ( 11,12,13,14)


				INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
				SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
				FROM v3Kademe3	K
				WHERE ID_KADEME3 IN ( 11,12,13,14)

					
			SELECT distinct	ID_SINAVTURU,AD,KISAAD
			FROM	#GrupSinavTuru 
			WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@ID_KADEME3)) 


			drop table #GrupSinavTuru
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_FrekansSistemEksikKazanim]    Script Date: 22.11.2021 11:14:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_FrekansSistemEksikKazanim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMKOD			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@EOKUL				INT		=	0,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMKOD					= @DONEMKOD		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON					= @SQLJSON		
			,EOKUL				 		= @EOKUL			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--select* from OkyanusDB.dbo.v3Kullanici where TCKIMLIKNO= '27296533692'
--	exec sp_FrekansSistemEksikKazanim @ID_MENU=1,@ISLEM=2,@DERSAD='Geometri',@DONEM='2017',@ID_SUBE=309,@ID_KADEME3='[0,15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='27296533692',@TC_OGRENCI='10987583618',@TCKIMLIKNO='27296533692',@OTURUM='E888F3FF-7DC1-4743-B683-4CE6141E16DC',@ID_SINIF=101525

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP 
	

	IF @DONEM=''
	BEGIN
		SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
	END
		
	 
	
	IF @ID_LOG > 1 or @EOKUL=1
	BEGIN
		drop table if exists #temp4T
		drop table if exists #TEMPORTT
		drop table if exists #t1
		drop table if exists #t3
		drop table if exists #temp
		drop table if exists #temp3
		drop table if exists #temp4
		drop table if exists #TEMPORT
		drop table if exists #TEMPORTS
		drop table if exists #tempY2
		drop table if exists #ttemp
		drop table if exists #ttemp3
		drop table if exists #TTEMPORTS
	
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		--OGRENCI 
		IF @ISLEM = 1
		BEGIN
		--Declare @UNITEDONEMKOD varchar(4)=(select DONEM from OKYANUSDB.DBO.v3AktifDonem WHERE AKTIF=1)
			IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY


				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.DERSAD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempsY
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND YO.TCKIMLIKNO = @TC_OGRENCI AND Y.DONEM = @DONEM AND D.DERSAD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.DERSAD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempY
					  from #tempsY t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempY2
					  from #tempsY t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTY
						from #tempY
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempY2
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivots
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTY WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2
						 from ##pivots p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY
			END
			ELSE	-- SINAVLAR
			BEGIN
			
					SELECT
						 S.ID_SINAV AS ID_SINAVBILGI
						,S.AD AS ACIKLAMA
						,SD.TAKMAAD AS DERSAD
						,SUBSTRING(SA.KOD,1,9) AS KONUKODU
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU						
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)) AS KAZANIM
						,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
						,SUM(1) AS KONUSAYISI
						,D.ID_DERS
						,S.SINAVTARIH
					INTO #temp
					FROM	   [Pusulam].dbo.Sinav					S	 WITH (NOLOCK) 
					INNER JOIN [Pusulam].dbo.SinavOgrenci			SO	 WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
					INNER JOIN OkyanusDB.dbo.v3Ogrenci				O	 WITH (NOLOCK) ON O.TCKIMLIKNO=SO.TCKIMLIKNO
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB WITH (NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevap		SOC  WITH (NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
					INNER JOIN [Pusulam].dbo.SinavKitapcik			SK	 WITH (NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
					INNER JOIN [Pusulam].dbo.SinavDers				SD   WITH (NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
					INNER JOIN eokul_v2.dbo.Ders					D    WITH (NOLOCK) ON D.ID_DERS=SD.ID_DERS
					INNER JOIN [Pusulam].dbo.SinavAnahtar			SA   WITH (NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
					INNER JOIN OkyanusDB.dbo.v3Kademe3				K3   WITH (NOLOCK) ON K3.ID_KADEME3=S.ID_KADEME3
					WHERE		S.FREKANSHESAPLA=1
							AND S.AKTIF=1
							AND S.DURUM=2
							AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
							--AND (O.ID_SINIF=@ID_SINIF)
							AND S.DONEM = @DONEM
							AND (D.DERSAD=@DERSAD)
							AND SO.TCKIMLIKNO = @TC_OGRENCI							
							AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
					GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD, SOC.DURUM,D.ID_DERS,SINAVTARIH
					ORDER BY S.ID_SINAV,SA.KOD

				  Select t2.ID_SINAVBILGI,  
						 t2.ACIKLAMA,
						 t2.ID_DERS,
						 t2.DERSAD,
						 t2.KONUKODU,
						 t2.UNITE,
						 t2.KONU,
						 t2.KONUSAYISI,
						 t2.DOGRUSAYISI,SINAVTARIH,
						(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
					into #temp3
					from #temp t2
				order by t2.ID_SINAVBILGI,t2.KONUKODU

				  Select KONUKODU,
						 ID_DERS,
						 SUM(KONUSAYISI) as KONUSAYISI,
						 SUM(DOGRUSAYISI) as DOGRUSAYISI
					into #TEMPORTS
					from #temp3 
				group by KONUKODU,ID_DERS

				  Select KONUKODU,
						 ID_DERS,
						 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
					into #TEMPORT
					from #TEMPORTS 

					
select KONUKODU,ID_SINAVBILGI,sum(KONUSAYISI) KONUSAYISI, sum(DOGRUSAYISI) DOGRUSAYISI,(Convert(decimal(6,2),(Convert(decimal(7,2),sum(DOGRUSAYISI))/convert(decimal(7,2),sum(KONUSAYISI)))*100))  as YUZDE into #k  from #temp group by KONUKODU,ID_SINAVBILGI

	  
				  Select t3.ID_SINAVBILGI,  
						 t3.ACIKLAMA,
						 t3.ID_DERS,
						 t3.DERSAD,
						 t3.KONUKODU,
						 t3.UNITE,
						 t3.KONU,
						 t3.KONUSAYISI,SINAVTARIH,
						 '('+Cast(k.KONUSAYISI as varchar)+') / '+Cast(k.YUZDE as varchar)+' %' as YUZDE
					into #temp4
					from #temp3 t3
					join #k		k	on k.ID_SINAVBILGI=t3.ID_SINAVBILGI and k.KONUKODU=t3.KONUKODU
				order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

				   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
				  from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI	
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI

				  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA+' (S.S.) / %')
					from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI
		   



		   DROP TABLE IF EXISTS ##pivot
				  Set @SQL='
						  with PivotData as
						  (
							Select 
							 ACIKLAMA,
							 ID_DERS,
							 DERSAD,
							 KONUKODU,
							 UNITE,
							 KONU,
							 YUZDE
							from #temp4
						  )

						  Select 
						   ID_DERS,
						   DERSAD,
						   KONUKODU,
						   ISNULL(UNITE,''-'') UNITE,
						   ISNULL(KONU,''-'') KONU,
						   '+@Columns2+'
						   into ##pivot
						   from PivotData
						   PIVOT
						   (
							MAX(YUZDE)
							FOR ACIKLAMA
							IN('+@Columns+')
						   ) as PivotResult
						   ORDER BY DERSAD,KONUKODU,UNITE
				   '
				   PRINT @SQL
				   PRINT '11'
				   EXEC (@SQL)
				   
--	exec sp_FrekansSistemEksikKazanim @ISLEM=1,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[6]',@TC_OGRETMEN='41318131710',@TC_OGRENCI='13882709862',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'

				   Select (Select Count(DERSAD) from ##pivot pp where pp.DERSAD=p.DERSAD) DERSADET,
						  p.*,
						  '('+Cast((SELECT SUM(KONUSAYISI) FROM #temp3 WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU) as varchar)+') / '+
						  Cast(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORT WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU)) as varchar)
						  +' %' 
						  as 'KAZANIM YÜZDE (T.S.S) / %'
					INTO #t1
					 from ##pivot p


					 select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t1 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
		   END
		END
	
		-- SINIF 
		IF @ISLEM = 2
		BEGIN
		IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT


				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.DERSAD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempOgrtYazili
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND O.ID_SINIF = @ID_SINIF AND Y.DONEM = @DONEM AND D.DERSAD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.DERSAD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI


					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempYO
					  from #tempOgrtYazili t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempPivot
					  from #tempOgrtYazili t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTYOGRT
						from #tempYO
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempPivot
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivotOgrtY
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTYOGRT WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2Y
						 from ##pivotOgrtY p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2Y 
										FOR JSON AUTO
									) as t3											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT


			END
		ELSE	-- SINAVLAR
			BEGIN
				SELECT
					 S.ID_SINAV AS ID_SINAVBILGI
					,S.SINAVTARIH
					,S.AD AS ACIKLAMA
					,SD.TAKMAAD AS DERSAD
					--,SUBSTRING(SA.KOD,1,9) AS KONUKODU				
					,SA.KOD AS KONUKODU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)),'-') AS UNITE
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)),'-') AS KONU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)),'-') AS KAZANIM
					,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
					,SUM(1) AS KONUSAYISI
				INTO #ttemp
				FROM	   [Pusulam].dbo.Sinav S
				INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK)ON SO.ID_SINAV=S.ID_SINAV
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
				INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
				INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=SD.ID_DERS
				INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
				WHERE		S.FREKANSHESAPLA=1  
						AND S.AKTIF=1
						AND S.DURUM=2
						AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
						AND S.DONEM = @DONEM
						AND (D.DERSAD=@DERSAD)
						AND O.ID_SINIF=@ID_SINIF
						AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
				GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,S.SINAVTARIH
				ORDER BY S.ID_SINAV,SA.KOD


			  Select t2.ID_SINAVBILGI,  
					 t2.ACIKLAMA,
					 t2.SINAVTARIH,
					 t2.DERSAD,
					 t2.KONUKODU,
					 t2.UNITE,
					 t2.KONU,
					 t2.KAZANIM,
					 t2.KONUSAYISI,
					 t2.DOGRUSAYISI,
					(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				into #ttemp3
				from #ttemp t2
			order by t2.ID_SINAVBILGI,t2.KONUKODU


			  Select KONUKODU,
					 SUM(KONUSAYISI) as KONUSAYISI,
					 SUM(DOGRUSAYISI) as DOGRUSAYISI
				into #TTEMPORTS
				from #ttemp3 
			group by KONUKODU

			  Select KONUKODU,
					 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
				into #TEMPORTT
				from #TTEMPORTS 


			  Select t3.ID_SINAVBILGI,  
					 t3.ACIKLAMA,
					 t3.DERSAD,
					 t3.SINAVTARIH,
					 t3.KONUKODU,
					 t3.UNITE,
					 t3.KONU,
					 t3.KAZANIM,
					 '('+ cast ( t3.KONUSAYISI as varchar)+') / ' + Cast(t3.YUZDE as varchar)+'%' as YUZDE
				into #temp4T
				from #ttemp3 t3
			order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

	  
		
			   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
			  from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH				   	
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI

			  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
				from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI
		  
		  
		   
		   
			if exists (Select TOP 1 1 from #temp4T)
			begin
					drop table if exists ##pivotS
					drop table if exists ##TT
					  Set @SQL='
					  with PivotData as
					  (
						Select 
						 ACIKLAMA,
						 DERSAD,
						 KONUKODU,
						-- UNITE,
						 KONU,
						 KAZANIM,
						 YUZDE
						from #temp4T
					  )

					  Select 
					   DERSAD,
					   KONUKODU,
					  -- UNITE,
					   KONU,
						 KAZANIM,
					   '+@Columns2+'
					   into ##pivotS
					   from PivotData
					   PIVOT
					   (
						MAX(YUZDE)
						FOR ACIKLAMA
						IN('+@Columns+')
					   ) as PivotResult
					   ORDER BY DERSAD,KONUKODU--,UNITE

					   SELECT * 
					   INTO ##TT
					   FROM ##pivotS
					   GROUP BY DERSAD,KONUKODU,KONU,KAZANIM,'+@Columns+'
							--,UNITE
					   '
					   PRINT @SQL
					   PRINT '1'
					   EXECute (@SQL)
					   PRINT '1'
		  
					  Select  p.*,ORTALAMA = '('+ cast( (SELECT sum(KONUSAYISI) FROM #ttemp3 WHERE KONUKODU = p.KONUKODU) as varchar) +') / '+ Cast(   
														CONVERT(DECIMAL(10,2),
																(SELECT ORTALAMA FROM #TEMPORTT WHERE KONUKODU = p.KONUKODU)
															   ) 
														  as varchar(10))+'%'
							  INTO #t3
						 from ##TT p
			 
					   PRINT '2'
				IF @EOKUL=1
				BEGIN 
					SELECT * FROM #t3 
				END
				ELSE
				BEGIN 
			--	drop table if exists ##pivotS
			--	exec sp_FrekansSistemEksikKazanim @ISLEM=2,@DERSAD='Biyoloji',@DONEM='2017',@ID_SINIF=101549,@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'
	
							select(
									select * from(
											select 
											(					
												SELECT		*
												FROM		#t3 
												FOR JSON AUTO
											) as t3											
										) as tablo FOR JSON AUTO
									) as tt
				END
			end
			else 
			begin
			select(
										select * from(
												select 
												(					
													SELECT		null
										
												) as t3											
											) as tablo FOR JSON AUTO
										) as tt
			end
			   --drop table if exists ##pivotS
			   drop table if exists #temp4T
			   drop table if exists #TEMPORTT
			   drop table if exists #t1
			   drop table if exists #t3
			   drop table if exists #temp
			   drop table if exists #temp3
			   drop table if exists #temp4
			   drop table if exists #TEMPORT
			   drop table if exists #TEMPORTS
			   drop table if exists #tempY2
			   drop table if exists #ttemp
			   drop table if exists #ttemp3
			   drop table if exists #TTEMPORTS
		   
			END
		END
		
		-- OGRETMEN
		IF @ISLEM = 3
		BEGIN
		
--	exec sp_FrekansSistemEksikKazanim @ISLEM=3,@DERSAD='Matematik',@DONEM='2017',@ID_SUBE=427,@ID_KADEME3='[15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='45103215326',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'


			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO

		SELECT
			 S.ID_SINAV AS ID_SINAVBILGI
			,S.AD +'('+CAST(S.ID_SINAV AS varchar(10))+')' AS ACIKLAMA
			,SD.TAKMAAD AS DERSAD
			,SA.KOD AS KONUKODU
			,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
			,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU
			,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
			,SUM(1) AS KONUSAYISI
			,K3.ID_KADEME3
			,K3.AD GRUP
			,S.SINAVTARIH
		INTO #tempO
		FROM	   [Pusulam].dbo.Sinav S
		INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
		INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
		INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
		INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
		INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
		INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=SD.ID_DERS
		INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
		INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
		INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
		INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF=O.ID_SINIF	AND DO.DONEMKOD=@DONEM								
		WHERE		S.FREKANSHESAPLA=1  
				AND S.AKTIF=1
				AND S.DURUM=2
				AND K3.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON (@ID_KADEME3))
				AND S.DONEM = @DONEM
				AND (D.DERSAD = @DERSAD)
				AND DO.TC_OGRETMEN=@TC_OGRETMEN
				AND S.AKTIF=1
				AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))
		GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,K3.ID_KADEME3,SINAVTARIH,K3.AD 
		ORDER BY S.ID_SINAV,SA.KOD


		  Select t2.ID_SINAVBILGI,  
		         t2.ACIKLAMA,
			     t2.DERSAD,
			     t2.KONUKODU,
			     t2.UNITE,
				 t2.KONU,
				 t2.KONUSAYISI,
				 t2.DOGRUSAYISI,SINAVTARIH,
			    (Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				,ID_KADEME3,GRUP
		    into #temp3O
		    from #tempO t2
	    order by t2.ID_SINAVBILGI,t2.KONUKODU


		  Select KONUKODU,
				 SUM(KONUSAYISI) as KONUSAYISI,
		         SUM(DOGRUSAYISI) as DOGRUSAYISI
			into #TEMPORTSO
	        from #temp3O
		group by KONUKODU

		  Select KONUKODU,
		         (Convert(decimal(10,0),(Convert(decimal(10,2),DOGRUSAYISI)/convert(decimal(10,2),KONUSAYISI))*100)) as ORTALAMA
			into #TEMPORTO
	        from #TEMPORTSO

	      Select t3.ID_SINAVBILGI,  
		         t3.ACIKLAMA,
			     t3.DERSAD,
			     t3.KONUKODU,
			     t3.UNITE,
				 t3.KONU,SINAVTARIH,
			     Cast(t3.YUZDE as varchar)+'%' as YUZDE
				 ,ID_KADEME3,GRUP
		    into #temp4O
		    from #temp3O t3
	    order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

		drop table #temp3O


		   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
		  from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
				   	
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI

		  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
		    from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI
--		   exec sp_FrekansSistem @ISLEM=3,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'




print '1'

IF EXISTS(Select TOP 1 1 from #temp4O)
BEGIN

		  Set @SQL='
		  

		  Select 
		   DERSAD,
		   KONU2 KONUKODU,
		   UNITE,
		   KONU,ID_KADEME3,GRUP,
		   '+@Columns2+',
		   ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTO TOR WHERE TOR.KONUKODU = KONU2))
		   into ##t4
		   from(
				Select 
				 ACIKLAMA,
				 DERSAD,			 
				KONUKODU KONU2,
				 UNITE,
				 KONU,
				 YUZDE
				 ,ID_KADEME3,GRUP
				from #temp4O) PivotData
		   PIVOT
		   (
				MAX(YUZDE)
				FOR ACIKLAMA
				IN('+@Columns+')
		   ) as PivotResult
		   ORDER BY DERSAD,KONU2,UNITE
		   
		   '
		   PRINT @SQL
		   
print '2'
		   EXEC (@SQL)

		  
					select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		##t4 
										FOR JSON AUTO
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt

							END
							ELSE
							BEGIN 
								select(
							select * from(
									select 
									(					
										SELECT NULL
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt
							END
			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO
		END
	END
	
	drop table if exists #temp4T
	drop table if exists #TEMPORTT
	drop table if exists #t1
	drop table if exists #t3
	drop table if exists #temp
	drop table if exists #temp3
	drop table if exists #temp4
	drop table if exists #TEMPORT
	drop table if exists #TEMPORTS
	drop table if exists #tempY2
	drop table if exists #ttemp
	drop table if exists #ttemp3
	drop table if exists #TTEMPORTS

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GelisimRaporu]    Script Date: 22.11.2021 12:06:28 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GelisimRaporu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVPUANTURUs	VARCHAR(MAX)	= NULL,
	@TN					bit				= 1,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,TC_OGRENCI					= @TC_OGRENCI			
			,TC_OGRETMEN				= @TC_OGRETMEN		
			,OTURUM						= @OTURUM				
			,IL							= @IL					
			,ILCE						= @ILCE				
			,ID_MENU					= @ID_MENU			
			,DONEM						= @DONEM				
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,ID_SINAV					= @ID_SINAV			
			,ID_DERS					= @ID_DERS			
			,ID_SUBE					= @ID_SUBE			
			,ID_SINIF					= @ID_SINIF			
			,DOSYAADI					= @DOSYAADI			
			,DOSYAGUID					= @DOSYAGUID			
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA		
			,DERSAD						= @DERSAD				
			,ID_DERSs					= @ID_DERSs			
			,ID_SINAVPUANTURUs			= @ID_SINAVPUANTURUs	
			,TN							= @TN					
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--EXEC [sp_GelisimRaporu] @ISLEM=1,@TCKIMLIKNO='34454003058',@OTURUM='AF6EC483-F078-4F55-AAAD-A4FFD02604D4',@DONEM='2017',@ID_DERS=153

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP =@IP
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END
	--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1 OR @ISLEM = 2
		BEGIN			
			SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			INTO	#GelisimRaporu
			FROM	Sinav					S
			JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
												AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
			JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
												AND K3.ID_KADEME3		= S.ID_KADEME3
			WHERE	S.DURUM			= 2 
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.DONEM			= @DONEM
				AND SO.TCKIMLIKNO	= @TC_OGRENCI
				AND (D.DERSAD IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))	OR ('TÜMÜ' IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))))		
			ORDER BY S.SINAVTARIH
				
			SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
			INTO	#GelisimRaporu2	
			FROM	#GelisimRaporu 		G		
			GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
			ORDER BY DERSAD
			
			INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
			SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
					[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
			FROM	#GelisimRaporu2 	G	
			JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
													AND SINAVLIST.DERSAD=G.DERSAD
			GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD
			
			------------------------------------------------------------------------
			-- PUANLAR

			SELECT S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
			INTO #Sonuc
			FROM SinavOgrenci				SO 
			JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
												AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
			JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
												AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
			JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2 
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.PUANGIZLE		= 0
				AND SO.TCKIMLIKNO	= @TC_OGRENCI
				AND S.DONEM			= @DONEM
				AND (D.DERSAD IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))	OR ('TÜMÜ' IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))))	
				--AND (SD.ID_DERS		IN (SELECT SUBSTRING(VALUE,3,999) FROM OPENJSON(@ID_DERSs))	OR ('D-0' IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))))	
			
			SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
			INTO	#Sonuc2
			FROM	#Sonuc	S
			WHERE	KOD		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVPUANTURUs))
			--WHERE	KOD		IN (SELECT  SUBSTRING(VALUE,3,999)  FROM OPENJSON(@ID_SINAVPUANTURUs))

			SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
					,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
			INTO	#Puan
			FROM	#Sonuc2			S
			JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
			GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			SELECT DISTINCT	G.ID_SINAV, G.TCKIMLIKNO,G.SINAVAD,G.ID_SINAVPUANTURU,G.PUANTURU		
			INTO #Puan2			
			FROM #Puan G
			GROUP BY G.ID_SINAV, G.TCKIMLIKNO,G.SINAVAD,G.ID_SINAVPUANTURU,G.SINAVAD,G.PUANTURU

			
			SELECT DISTINCT TCKIMLIKNO INTO #OGRENCI FROM #GelisimRaporu
					
			IF @ISLEM = 1 -- JSON SEND
			BEGIN
				select(
					select * 
					from(
						select 
						(					
							SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, G.SORUSAYISI, 
									[SINAV ADI] = SINAVAD, [DOĞRU] = DOGRU,[YANLIŞ] = YANLIS,[BOŞ] = BOS,NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET		-- SINAVLIST
							FROM	#GelisimRaporu2 	G	
							JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
																	AND SINAVLIST.DERSAD=G.DERSAD
							ORDER BY DERSAD,ID_SINAVTURU,TIP,SINAVTARIH
							FOR JSON AUTO
						) as t1,
						(
							SELECT DISTINCT	
									 ID_SINAV
									,TCKIMLIKNO
									,[SINAV ADI]	= SINAVAD
									,[DOĞRU]		= SUM(DOGRU) 
									,[YANLIŞ]		= SUM(YANLIS) 
									,[BOŞ]			= SUM(BOS) 
									,NET			= SUM(NET) 
									,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
									,SS				= SUM(DOGRU+YANLIS+BOS)
							FROM	#Sonuc	
							GROUP BY ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,SINAVAD

							FOR JSON AUTO
						) AS t2,
						(	
							SELECT DISTINCT	 G.TCKIMLIKNO,G.ID_SINAVPUANTURU,G.PUANTURU
									,[SINAV ADI] = P.SINAVAD,P.ID_SINAVPUANTURU,P.PUAN,[BAŞARI %] = P.BASARI-- ,P.PTKOD
							FROM #Puan G
							JOIN #Puan P	ON	P.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
							FOR JSON AUTO
						) AS t3,
						(
							SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
							FROM EtutOgrenci EO
							INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
							INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
							INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
							WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
							GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
							ORDER BY O.TCKIMLIKNO, E.TARIH DESC
							FOR JSON PATH
						) AS t4					
					) as tablo FOR JSON AUTO
				) as tt
			END
			IF @ISLEM = 2 -- DATASET
			BEGIN
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET		-- SINAVLIST
						,K.AD+ ' ' + K.SOYAD ADSOYAD, S.AD SUBEAD,SN.AD SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				JOIN	OkyanusDB.DBO.v3Ogrenci		O	ON	O.TCKIMLIKNO	= G.TCKIMLIKNO
				JOIN	OkyanusDB.DBO.v3Kullanici	K	ON	K.TCKIMLIKNO	= G.TCKIMLIKNO
				JOIN	OkyanusDB.DBO.v3Sube		S	ON	S.ID_SUBE		= O.ID_SUBE
				JOIN	OkyanusDB.DBO.v3Sinif		SN	ON	SN.ID_SINIF		= O.ID_SINIF
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT DISTINCT	
							ID_SINAV
						,TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= SUM(DOGRU+YANLIS+BOS)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
				FROM	#Sonuc	
				--WHERE	@TN=1
				GROUP BY ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,SINAVAD
							
				SELECT DISTINCT	 G.TCKIMLIKNO,G.ID_SINAVPUANTURU,G.PUANTURU
						,[SINAV ADI] = P.SINAVAD,P.ID_SINAVPUANTURU,P.PUAN,[BAŞARI %] = P.BASARI	--,P.PTKOD
				FROM #Puan G
				JOIN #Puan P	ON	P.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU

				SELECT TCKIMLIKNO FROM #OGRENCI

				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
							
			END
			DROP TABLE #OGRENCI
			DROP TABLE #GelisimRaporu
			DROP TABLE #GelisimRaporu2
			
			DROP TABLE #Puan
			DROP TABLE #Puan2
			DROP TABLE #Sonuc
			DROP TABLE #Sonuc2

		END
		
		IF @ISLEM = 3 -- Gelişim Raporu Filtre
		BEGIN 			
			--declare @ID_KADEME3 int =0 , @TCKIMLIKNO VARCHAR(MAX)='19070248786'
			
			IF @DONEM IS NULL OR @DONEM =''
			BEGIN
				SELECT @DONEM= DONEM FROM v3AktifDonem WHERE AKTIF=1
			END
				
		
			SELECT 'D-0' ID,'TÜMÜ' AD, 'DERS' DEGER INTO #GELISIMFILTRE
		UNION ALL
			SELECT	DISTINCT 
					--'D-'+CAST(D.ID_DERS AS VARCHAR) ID
					--,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.AD) AD
					'D-1' ID
					,'D-'+UPPER(D.DERSAD) AD
					,'DERS' DEGER 
			FROM	SinavOgrenci		SO
			JOIN	SinavOgrenciPuan	SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
											AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			JOIN	Sinav				S	ON	S.ID_SINAV			= SO.ID_SINAV
			JOIN	SinavDers			SD	ON	SD.ID_SINAV			= SO.ID_SINAV 
			JOIN	eokul_v2.dbo.Ders	D	ON	D.ID_DERS			= SD.ID_DERS 
			JOIN	v3Kademe3			K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
			WHERE	SO.TCKIMLIKNO	= @TC_OGRENCI
				AND S.DONEM			= @DONEM 
		UNION ALL
			SELECT  'P-'+PT.KOD , 'P-'+PT.KOD, 'PT' DEGER  
			FROM SinavOgrenci		SO
			JOIN SinavOgrenciPuan	SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
										AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			WHERE SO.TCKIMLIKNO=@TC_OGRENCI
			GROUP BY PT.KOD
		UNION ALL
			SELECT 'T-0','TOPLAM NET','TN' DEGER


				select(
						select * from(
							select 
							(					
								SELECT	DISTINCT ID, AD,DEGER
								FROM	#GELISIMFILTRE 
								ORDER BY DEGER

								FOR JSON AUTO
							) as GELISIMFILTRE 
												
						) as tablo FOR JSON AUTO
					) as tt
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GelisimRaporuLS]    Script Date: 22.11.2021 12:07:05 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GelisimRaporuLS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,RAPORTURLIST				= @RAPORTURLIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @ID_LOG > 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
			INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	

		IF (@ISLEM=4)
		BEGIN
		
			--DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

			INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
					TCKIMLIKNO	 VARCHAR(MAX),
					DERSAD VARCHAR(MAX),
					ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
					TCKIMLIKNO	 VARCHAR(MAX),
					DERSAD VARCHAR(MAX),
					ID_DERS INT,
					SINAVADI VARCHAR(MAX),
					ID_SINAVRAPOR INT,
					PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
			SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
					DOGRU DECIMAL(8,2),
					YANLIS DECIMAL(8,2),
					BOS DECIMAL(8,2),
					YUZDE DECIMAL(8,2),
					TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
					INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
			SELECT (
						SELECT 						
							--ÖĞRENCİ
							OGRENCI							= (	SELECT * 
																FROM #TEMP_OGRENCI 
																FOR JSON PATH)					
							--DERS ÖĞRETMEN
							,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
																FROM #TEMP_DERS_OGRETMEN 
																ORDER BY DERSAD, ADSOYAD
																FOR JSON PATH)
							--YOKLAMA DERS
							,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
																FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
																ORDER BY DERSAD FOR JSON PATH)
							-- YAZILI YOKLAMA SONUÇLARI
							,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
																, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
																FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
																JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
																JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
																WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
																	OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
																ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
																FOR JSON PATH)  
							--DENEME SINAVI DERSLERI
							,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
																		ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= T.DERSAD 
																	,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
																	,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
																FROM	#TEMP_DENEME_SONUCLARI_T	T
																JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
																--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
																ORDER BY ST.AD, BOLUMNO, T.DERSAD
																FOR JSON AUTO)
							--DENEME SINAVI DERSLERI
							,DENEMESINAVILISTESI			= (
																	SELECT	 DISTINCT 
																			ST.ID_SINAVTURU
																		,SINAVTURU	= ST.AD
																		,SINAVAD
																		,ID_SINAV
																		,SINAVTARIH
																	FROM	#TEMP_DENEME_SONUCLARI_T	T
																	JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
																	ORDER BY ST.AD, T.SINAVTARIH
																	FOR JSON AUTO
																)
							-- DENEME SINAVI SONUCLARI
							,DENEMESINAVISONUCLARI			=  (
																	SELECT	 ST.ID_SINAVTURU
																			,SINAVTURU	= ST.AD
																			,DERSAD		= TT.DERSAD 
																			,TT.ID_SINAV
																			,TT.OLCEKSINAVI
																			,TD = ISNULL(T2.TD,0)
																			,TY = ISNULL(T2.TY,0)
																			,TB = ISNULL(T2.TB,0)
																			,TN = ISNULL(T2.TN,0)
																			,TT.SINAVAD																	
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																			,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
																	FROM	#TEMP_DENEME_SONUCLARI_T	T
																	JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
																	JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																											AND SD.ID_SINAV			= T.ID_SINAV
																	JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																											AND TT.DERSAD			= T.DERSAD
																	JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																											AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
																	ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
																	FOR JSON AUTO
																)
								-- GELİŞİM ANALİZİ DERSLERİ
								,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
																	[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
																	[SINAVADI] = SINAVAD, 
																	[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
																	[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
																	[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
																	NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
																	,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
																FROM	#TEMP_GELISIM_RAPORU_2 	G	
																JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																												AND SINAVLIST.DERSAD		= G.DERSAD
																												AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
																JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
																ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
								--GELİŞİM ANAZILIZI SONUC
								,GELISIMANALIZISONUC		= (	SELECT	
																		G.TCKIMLIKNO
																	,G.STKISAAD + ' TOPLAM' AS STKISAAD
																	,G.ID_SINAVTURU
																	--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
																	,SINAVLIST.ID_SINAV
																	,[SINAVADI]		= SINAVAD
																	,[DOGRU]		= SUM(DOGRU) 
																	,[YANLIS]		= SUM(YANLIS) 
																	,[BOS]			= SUM(BOS) 
																	,NET			= SUM(NET) 
																	,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
																	,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
																	--,G.STKISAAD + ' TOPLAM' AS STKISAAD
																FROM	#TEMP_GELISIM_RAPORU_2 	G	
																JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																												AND SINAVLIST.DERSAD = G.DERSAD
																												AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
																WHERE SINAVAD <> 'ORTALAMA'
																GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
																ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
								--GELİŞİM ANALİZİ PUAN
								,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
																		G.TCKIMLIKNO
																	,G.ID_SINAVPUANTURU
																	,G.PUANTURU
																	,S.SINAVAD
																	,S.PUAN
																	,S.BASARI	
																	,S.BASARI as NET
																FROM #TEMP_PUAN G 
																JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																					AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
																FOR JSON AUTO)
								--NET ORTALAMA KARŞ
								,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
																FROM #TEMP_OO OO
																INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
																INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
																INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
																INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
																ORDER BY STKISAAD, BOLUMNO, DERSAD 
																FOR JSON PATH)
								--KONU ANALIZ
								,KONUANALIZ					= (	SELECT * 
																FROM #TEMP_KONUANALIZ TT 
																ORDER BY TT.DERSAD, TT.KOD 
																FOR JSON PATH)
								--ÖDEV RAPORU
								,ODEVRAPORU					= ( SELECT * 
																FROM #TEMP_ODEV_RAPORU 
																FOR JSON PATH)
								--ÖĞRETMEN DEĞERLENDİRME
								,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
																FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
																ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
																FOR JSON PATH)
								,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																		,K.AD + ' ' + K.SOYAD AS ADSOYAD
																		,DY.YORUM
																		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																		,CASE DY.TUR WHEN 0 THEN STUFF ((
																			SELECT DISTINCT ', ' + UPPER(D.AD)
																			FROM EOKUL_V2.DBO.dersogretmen DO
																			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																			FOR XML PATH('')), 1, 2, '') 
																			WHEN 1 THEN 'REHBERLİK'
																			WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
																FROM DegerlendirmeYorum				DY
																INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
																INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
																INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
																INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
																WHERE	DY.YORUM <> '' 
																	AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
																ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
																FOR JSON PATH)
								-- ETÜT RAPORU
								,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
																FROM #TEMP_ETUT_RAPORU
																ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
								,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																		,SINAV
																		,DERS
																		,DUZEY
																		,MAXDUZEY
																FROM #TEMP_NEREDEYIM_GRAFIGI
																ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
								--LUS RAPORU
								,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
																	OPT, 
																	CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
																	CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
																	YAZOGRETMEN, 
																	CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
																	CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
																	YAZOGRENCI, 
																	CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
																	CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
																	TOPLAM
																FROM #TEMP_RESULT
																WHERE TOPLAM != '-' FOR JSON PATH)
								,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
																FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
																JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
																JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
																JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
																JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
																GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
																ORDER BY ADSOYAD FOR JSON PATH)
								,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																		,SORUNO
																		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																				WHEN PUANORAN < 40						THEN '1'
																			END AS DURUM
																FROM #TEMP_YAZILISORUOGRENCI
																ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
								,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
																FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
																ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
																FOR JSON PATH)
						FOR JSON PATH
					)
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GelisimRaporuOO]    Script Date: 22.11.2021 12:07:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GelisimRaporuOO]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,RAPORTURLIST				= @RAPORTURLIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY  
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	 
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @ID_LOG > 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1 AND E.DONEM = @DONEM
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.ID_KULLANICITIPI = 4
				AND		DS.DONEM = @DONEMX
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	

		IF (@ISLEM=4)
		BEGIN
		
		 --DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

		    INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ID_DERS INT,
				 SINAVADI VARCHAR(MAX),
				 ID_SINAVRAPOR INT,
				 PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
		    SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
				 DOGRU DECIMAL(8,2),
				 YANLIS DECIMAL(8,2),
				 BOS DECIMAL(8,2),
				 YUZDE DECIMAL(8,2),
				 TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
				    INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
			SELECT (
				SELECT 						
					--ÖĞRENCİ
					OGRENCI							= (	SELECT * 
														FROM #TEMP_OGRENCI 
														FOR JSON PATH)					
					--DERS ÖĞRETMEN
					,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
														FROM #TEMP_DERS_OGRETMEN 
														ORDER BY DERSAD, ADSOYAD
														FOR JSON PATH)
					--YOKLAMA DERS
					,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
														ORDER BY DERSAD FOR JSON PATH)
					-- YAZILI YOKLAMA SONUÇLARI
					,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
														, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
														WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
															OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
														ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
														FOR JSON PATH)  
					--DENEME SINAVI DERSLERI
					,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
															 ST.ID_SINAVTURU
															,SINAVTURU	= ST.AD
															,DERSAD		= T.DERSAD 
															,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
															,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
														FROM	#TEMP_DENEME_SONUCLARI_T	T
														JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
														--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
														ORDER BY ST.AD, BOLUMNO, T.DERSAD
														FOR JSON AUTO)
					--DENEME SINAVI DERSLERI
					,DENEMESINAVILISTESI			= (
															SELECT	 DISTINCT 
																 ST.ID_SINAVTURU
																,SINAVTURU	= ST.AD
																,SINAVAD
																,ID_SINAV
																,SINAVTARIH
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
															ORDER BY ST.AD, T.SINAVTARIH
															FOR JSON AUTO
														)
					-- DENEME SINAVI SONUCLARI
					,DENEMESINAVISONUCLARI			=  (
															SELECT	 ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= TT.DERSAD 
																	,TT.ID_SINAV
																	,TT.OLCEKSINAVI
																	,TD = ISNULL(T2.TD,0)
																	,TY = ISNULL(T2.TY,0)
																	,TB = ISNULL(T2.TB,0)
																	,TN = ISNULL(T2.TN,0)
																	,TT.SINAVAD																	
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																	,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
															JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																									AND SD.ID_SINAV			= T.ID_SINAV
															JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																									AND TT.DERSAD			= T.DERSAD
															JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																									AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
															ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
															FOR JSON AUTO
														)
						-- GELİŞİM ANALİZİ DERSLERİ
						,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
															[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
															[SINAVADI] = SINAVAD, 
															[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
															[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
															[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
															NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
															,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD		= G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
														JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
														ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
						--GELİŞİM ANAZILIZI SONUC
						,GELISIMANALIZISONUC		= (	SELECT	
															 G.TCKIMLIKNO
															,G.STKISAAD + ' TOPLAM' AS STKISAAD
															,G.ID_SINAVTURU
															--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
															,SINAVLIST.ID_SINAV
															,[SINAVADI]		= SINAVAD
															,[DOGRU]		= SUM(DOGRU) 
															,[YANLIS]		= SUM(YANLIS) 
															,[BOS]			= SUM(BOS) 
															,NET			= SUM(NET) 
															,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															--,G.STKISAAD + ' TOPLAM' AS STKISAAD
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD = G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
														WHERE SINAVAD <> 'ORTALAMA'
														GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
														ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
						--GELİŞİM ANALİZİ PUAN
						,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
															 G.TCKIMLIKNO
															,G.ID_SINAVPUANTURU
															,G.PUANTURU
															,S.SINAVAD
															,S.PUAN
															,S.BASARI	
															,S.BASARI as NET
														FROM #TEMP_PUAN G 
														JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																		  AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
														FOR JSON AUTO)
						--NET ORTALAMA KARŞ
						,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
														FROM #TEMP_OO OO
														INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
														INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
														INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
														INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
														ORDER BY STKISAAD, BOLUMNO, DERSAD 
														FOR JSON PATH)
						--KONU ANALIZ
						,KONUANALIZ					= (	SELECT * 
														FROM #TEMP_KONUANALIZ TT 
														ORDER BY TT.DERSAD, TT.KOD 
														FOR JSON PATH)
						--ÖDEV RAPORU
						,ODEVRAPORU					= ( SELECT * 
														FROM #TEMP_ODEV_RAPORU 
														FOR JSON PATH)
						--ÖĞRETMEN DEĞERLENDİRME
						,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																,K.AD + ' ' + K.SOYAD AS ADSOYAD
																,DY.YORUM
																,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																,CASE DY.TUR WHEN 0 THEN STUFF ((
																	SELECT DISTINCT ', ' + UPPER(D.AD)
																	FROM EOKUL_V2.DBO.dersogretmen DO
																	INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																	WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																	FOR XML PATH('')), 1, 2, '') 
																 WHEN 1 THEN 'REHBERLİK'
																 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
														FROM DegerlendirmeYorum				DY
														INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
														INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
														INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
														INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
														WHERE	DY.YORUM <> '' 
															AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
														ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
														FOR JSON PATH)
						-- ETÜT RAPORU
						,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
														FROM #TEMP_ETUT_RAPORU
														ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
						,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																,SINAV
																,DERS
																,DUZEY
																,MAXDUZEY
														FROM #TEMP_NEREDEYIM_GRAFIGI
														ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
						--LUS RAPORU
						,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
															OPT, 
															CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
															CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
															YAZOGRETMEN, 
															CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
															CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
															YAZOGRENCI, 
															CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
															CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
															TOPLAM
														FROM #TEMP_RESULT
														WHERE TOPLAM != '-' FOR JSON PATH)
						,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
														JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
														JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
														JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
														JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
														GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														ORDER BY ADSOYAD FOR JSON PATH)
						,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																,SORUNO
																,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																		WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																		WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																		WHEN PUANORAN < 40						THEN '1'
																	END AS DURUM
														FROM #TEMP_YAZILISORUOGRENCI
														ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
				FOR JSON PATH
			)

		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GenelKazanimAnalizi]    Script Date: 22.11.2021 12:07:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	[dbo].[sp_GenelKazanimAnalizi]
--		@TCKIMLIKNO = N'56545519606',
--		@OTURUM = N'9ECE89E5-DD7E-4EBC-A920-A0B75E540AFF',
--		@ID_MENU = 1093,
--		@ID_SUBELER = 236,
--		@ISLEM = 1,
--		@DONEM = N'2017'

ALTER procedure [dbo].[sp_GenelKazanimAnalizi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= 0,
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@IP					VARCHAR(50)	= NULL
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SUBE					= @ID_SUBE	
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			IF @ISLEM = 1	--	Genel Kazanım Analizi Getir
			BEGIN
				SELECT	A.ID_SINAVRAPOR,
						ID_SUBE,
						SUBE,
						A.GRUP,
						DERS,
						A.SINAVADI,
						SINIF,
						ADSOYAD,
						K.KAZANIM,
						SORUNO,
						PUAN,
						PUANDEGERI 
				FROM eokul_v2.dbo.YaziliKazanimAnalizi A
				INNER JOIN eokul_v2.dbo.SinavRapor R ON R.ID_SINAVRAPOR=A.ID_SINAVRAPOR
				INNER JOIN eokul_v2.dbo.YaziliKazanimList K ON K.ID_KAZANIM=A.ID_KAZANIM
				WHERE (ID_SUBE=@ID_SUBE or @ID_SUBE=0) AND R.isActive=1 AND R.DONEMKOD=@DONEM
				ORDER BY SUBE, SINIF, DERS, SINAVADI, ADSOYAD, SORUNO
			END

			IF @ISLEM = 2	--	Genel Kazanım Analizi Getir Yeni
			BEGIN
				SELECT  Y.ID_SINAVRAPOR
						,SB.ID_SUBE
						,SB.AD AS SUBE
						,K3.AD AS GRUP
						,D.DERSAD AS DERS
						,Y.AD AS SINAVADI
						,S.AD AS SINIF
						,K.AD + ' ' +K.SOYAD AS ADSOYAD
						,U.AD AS KAZANIM
						,YS.SORUNO
						,YOC.PUAN
						,YS.PUAN AS PUANDEGERI
				--INTO #tablosY
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = Y.ID_KADEME3
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite U ON U.KOD = YS.KOD
				WHERE Y.DONEM = @DONEM AND O.ID_SUBE = @ID_SUBE
				ORDER BY SB.AD, S.AD, D.DERSAD, Y.AD, K.AD + ' ' +K.SOYAD, YS.SORUNO
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO


USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GenelListeler]    Script Date: 23.11.2021 14:36:17 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GenelListeler]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN	
			IF @ISLEM = 1 -- Bilgi Listele
			BEGIN
				SELECT
				ISNULL(
					(
						SELECT *
						FROM Bilgi
						FOR JSON PATH
					)
				, '[]')
			END

			IF @ISLEM = 2 -- Bilişsel Süreç Listele
			BEGIN
				SELECT
				ISNULL(
					(
						SELECT *
						FROM BilisselSurec
						FOR JSON PATH
					)
				, '[]')
			END
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GenelSoruAnalizi]    Script Date: 23.11.2021 14:36:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GenelSoruAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,SQLJSON					= @SQLJSON		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBE					= @ID_SUBE		
			,ID_DERS					= @ID_DERS		
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_KADEME3					= @ID_KADEME3		
			,TC_OGRENCI			 		= @TC_OGRENCI		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )

		IF (@ISLEM = 1 OR @ISLEM = 2)  -- SINIF
		BEGIN
			
		
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[427,236]'
		--			,@ID_SINIFs		VARCHAR(MAX)= NULL
		--			,@ID_DERSs		VARCHAR(MAX)= '[847,942]'
		--			,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--			,@DONEM			VARCHAR(MAX)= '2017'
		--			,@ISLEM			INT			= 1		

			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #SINIF_CEVAP
			DROP TABLE IF EXISTS #SORUKARSILIK
			DROP TABLE IF EXISTS #YUZDE
			DROP TABLE IF EXISTS #DERS

			
			
			SELECT DERSAD INTO #DERS from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'

			

			SELECT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM,OC.CEVAP OGRENCICEVAP,SA.CEVAP DOGRUCEVAP
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A, SD.BOLUMNO
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD				= SO.KITAPCIK 
																AND SD.ID_SINAV			= S.ID_SINAV
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
		left	JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND O.DONEM			= @OGRENCIDONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		


			DROP TABLE IF EXISTS #SINIF_CEVAP
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,COUNT(OGRENCICEVAP) CEVAPSAYISI,CASE WHEN OGRENCICEVAP = '' THEN 'BOS' ELSE OGRENCICEVAP  END AS OGRENCICEVAP   ,0 OGRSAY,SORUNO_A,BOLUMNO,DOGRUCEVAP
			INTO #SINIF_CEVAP 
			FROM #TEMP_SINIF T
			GROUP BY KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,OGRENCICEVAP,SORUNO_A,BOLUMNO,DOGRUCEVAP
			

			DROP TABLE IF EXISTS #TEMP
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH, OGRSAY,SORUNO_A,BOLUMNO
				,ISNULL(P.A,0) A, AYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.B,0) B, BYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.C,0) C, CYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.D,0) D, DYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.E,0) E, EYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.[BOS],0) BOS, BOSYUZDE=CAST(0 AS DECIMAL(8,2))
				,0 DOGRU, DOGRUYUZDE=CAST(0 AS DECIMAL(8,2))
				,DOGRUCEVAP
			INTO #TEMP
			FROM (
				SELECT * FROM #SINIF_CEVAP
			) AS Tbl
			PIVOT (MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]) ) AS P

			UPDATE T
			SET	AYUZDE = CAST(ISNULL(CAST(A AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				BYUZDE = CAST(ISNULL(CAST(B AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				CYUZDE = CAST(ISNULL(CAST(C AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				DYUZDE = CAST(ISNULL(CAST(D AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				EYUZDE = CAST(ISNULL(CAST(E AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				BOSYUZDE = CAST(ISNULL(CAST(BOS AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2))
			FROM #TEMP T

			UPDATE #TEMP 
			SET DOGRU=CASE DOGRUCEVAP
				WHEN 'A' THEN A 
				WHEN 'B' THEN B 
				WHEN 'C' THEN C 
				WHEN 'D' THEN D 
				WHEN 'E' THEN E
				ELSE NULL 
				END ,
				DOGRUYUZDE = CASE DOGRUCEVAP
				WHEN 'A' THEN AYUZDE 
				WHEN 'B' THEN BYUZDE 
				WHEN 'C' THEN CYUZDE 
				WHEN 'D' THEN DYUZDE 
				WHEN 'E' THEN EYUZDE
				ELSE NULL 
				END


			SELECT DISTINCT SK.AD KITAPCIK,SA.SORUNO_A,SA.SORUNO,SD.BOLUMNO
			INTO #SORUKARSILIK
			FROM Sinav			S
			JOIN #TEMP			T	ON	T.ID_SINAV			= S.ID_SINAV
			JOIN SinavDers		SD	ON	SD.ID_SINAV			= S.ID_SINAV
									AND SD.ID_DERS			= T.ID_DERS
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= S.ID_SINAV
									AND SK.AD				!='A'
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									AND SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
									AND SA.SORUNO_A			= T.SORUNO_A		
									

			IF @ISLEM = 1  -- DEVEXPRESS
			BEGIN
				select(
					select * from(
						select 
						(					
							SELECT * FROM #TEMP
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO,INCLUDE_NULL_VALUES
						) as TblVeri,					
						(					
							SELECT * FROM #SORUKARSILIK
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblSoruKarsilik
						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE
			BEGIN
				SELECT * FROM #TEMP
				ORDER BY BOLUMNO,SORUNO_A

				SELECT * FROM #SORUKARSILIK
				ORDER BY BOLUMNO,SORUNO_A	
				

				
			END
			



			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #SINIF_CEVAP
			DROP TABLE IF EXISTS #SORUKARSILIK
			DROP TABLE IF EXISTS #YUZDE
			DROP TABLE IF EXISTS #DERS			



		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Grup]    Script Date: 23.11.2021 14:37:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Grup]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@SUBELER			VARCHAR(MAX)	= NULL	,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL	,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SUBE					= @ID_SUBE	
			,ID_KADEME					= @ID_KADEME	
			,SUBELER					= @SUBELER	
			,ID_KADEMEs					= @ID_KADEMEs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
		
		SELECT ID_KULLANICITIPI 
		INTO #KULLANICITIPLER 
		FROM OkyanusDB.[dbo].[v3Kullanici]			K
		INNER JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO
		WHERE K.TCKIMLIKNO=@TCKIMLIKNO
		
		IF @ISLEM = 1	--	Grup Listele
		BEGIN
			--IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			--BEGIN
			--	select distinct st.ID_KADEME3 as ID_SINAVGRUP, k.AD as GRUP
			--	from		  [dbo].[vw_SubeGrupSinif]	sgs
			--	Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			--	Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
			--	Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
			--	Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			--	Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
			--	where (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sgs.ID_SUBE=@ID_SUBE)
			--END
			--ELSE
			--BEGIN
				select distinct st.ID_KADEME3 as ID_SINAVGRUP, k.AD as GRUP
				from		  [dbo].[vw_SubeGrupSinif]	sgs
				Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
				Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
				Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
				Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
				Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
				where (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sgs.ID_SUBE=@ID_SUBE)  AND
						(@SUBELER IS NULL OR @SUBELER='[]' OR sgs.ID_SUBE in (select value from openjson( @SUBELER)))  AND
					  (st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) 

				

			--END
		END
				
		IF @ISLEM = 2	--	Grup Listele by Kullanici
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN

				SELECT DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
				INTO #TEMP
				FROM [dbo].[vw_SubeGrupSinif]	K
				JOIN v3KullaniciKademe3			KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 				
				WHERE	(K.ID_SUBE=@ID_SUBE or @ID_SUBE=0 or @ID_SUBE is null)
					AND (KK.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0 OR @ID_KADEME IS NULL)
			UNION 
				SELECT K.ID_KADEME3 ID_SINAVGRUP, AD GRUP,SIRA 
				FROM v3Kademe3		K
				JOIN v3KademeBilgi	KB	ON	KB.ID_KADEME3	=	K.ID_KADEME3
				WHERE @ID_SUBE IN (706, 730)
					AND (KB.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0 OR @ID_KADEME IS NULL)

				SELECT * FROM #TEMP
				ORDER BY SIRA

				DROP TABLE #TEMP
			END
			ELSE
			BEGIN 	
				SELECT	K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP
				FROM	v3Kademe3			K
				JOIN	v3KullaniciKademe3	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	TCKIMLIKNO=@TCKIMLIKNO
					AND (KK.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0 OR @ID_KADEME IS NULL)

			END
		END
				
		IF @ISLEM = 3	--	Grup Listele MULTİ SUBE
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
				INTO	#TEMP1
				FROM	[dbo].[vw_SubeGrupSinif]	K
				JOIN	v3KullaniciKademe3			KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	(	K.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) 
							or (0 IN (SELECT VALUE FROM OPENJSON(@SUBELER))) 
							or @SUBELER='[]' 
							or @SUBELER is null)
					AND (	@ID_KADEMEs IS NULL 
						OR	@ID_KADEMEs = ''
						OR	@ID_KADEMEs = '[]'
						OR	KK.ID_KADEME IN (SELECT VALUE FROM OPENJSON(@ID_KADEMEs)))
				
				
				SELECT ID_SINAVGRUP, GRUP, SIRA FROM #TEMP1				
				UNION
				SELECT K.ID_KADEME3 ID_SINAVGRUP, AD GRUP,SIRA FROM v3Kademe3	K
				JOIN v3KademeBilgi	KB ON KB.ID_KADEME3 = K.ID_KADEME3
				WHERE (
					(706 IN (SELECT VALUE FROM OPENJSON(@SUBELER))) 
				OR	(730 IN (SELECT VALUE FROM OPENJSON(@SUBELER))) )
					AND (	@ID_KADEMEs IS NULL 
						OR	@ID_KADEMEs = ''
						OR	@ID_KADEMEs = '[]'
						OR	KB.ID_KADEME IN (SELECT VALUE FROM OPENJSON(@ID_KADEMEs)))

				ORDER BY SIRA

				DROP TABLE #TEMP1
			END
			ELSE
			BEGIN 	
				SELECT	K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP
				FROM	v3Kademe3			K
				JOIN	v3KullaniciKademe3	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 				
				WHERE	TCKIMLIKNO=@TCKIMLIKNO
					AND (	@ID_KADEMEs IS NULL 
						OR	@ID_KADEMEs = ''
						OR	@ID_KADEMEs = '[]'
						OR	KK.ID_KADEME IN (SELECT VALUE FROM OPENJSON(@ID_KADEMEs)))

			END
		END

		IF @ISLEM=4		--	TÜM Grup Listele MULTİ SUBE
		BEGIN
			SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
			INTO	#TEMP2
			FROM	[dbo].[vw_SubeGrupSinif]	K
			WHERE	(	   (K.ID_SUBE	IN	(SELECT value FROM OPENJSON(@SUBELER)))
						or (0			IN	(SELECT VALUE FROM OPENJSON(@SUBELER))) 
						or @SUBELER='[]' 
						or @SUBELER is null
					)

			SELECT * FROM #TEMP2
			ORDER BY SIRA

			DROP TABLE #TEMP2
		END

		IF @ISLEM=5		--	Tüm Grup Listele Şubesiz
		BEGIN
			SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
			FROM	[dbo].[vw_SubeGrupSinif]	K
			INNER JOIN OkyanusDB.dbo.v3KullaniciKademe3 K3 ON K3.ID_KADEME3=K.ID_KADEME3
			WHERE K3.TCKIMLIKNO=@TCKIMLIKNO
			ORDER BY SIRA
		END
		
		IF @ISLEM = 6	--	Grup Listele by Kullanici
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
				INTO	#TEMP6
				FROM	[dbo].[vw_SubeGrupSinif]	K
				JOIN	v3KullaniciKademe3			KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	(K.ID_SUBE=@ID_SUBE or @ID_SUBE=0)

				SELECT * FROM #TEMP6
				ORDER BY SIRA

				DROP TABLE #TEMP6
			END
			ELSE
			BEGIN 	
				SELECT	K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP,SIRA
				FROM	v3Kademe3			K
				JOIN	v3KullaniciKademe3	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	TCKIMLIKNO=@TCKIMLIKNO
			UNION 
				SELECT DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP,SIRA
				from v3Kademe3					K
				JOIN eokul_v2.DBO.KurSinifi		KS	ON	KS.ID_KADEME3	= K.ID_KADEME3
				JOIN v3Ogretmen					OG	ON	OG.ID_OGRETMEN	= KS.ID_DANISMAN
				where	OG.TCKIMLIKNO = @TCKIMLIKNO
					AND DONEMKOD = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				ORDER BY SIRA

			END
		END
		
		DROP TABLE IF EXISTS #KADEMELER
		DROP TABLE IF EXISTS #KULLANICITIPLER
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_KarmaListe3]    Script Date: 23.11.2021 14:38:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_KarmaListe3]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_BURSLULUKDOSYA	INT				= NULL,
	@KENDISINIF			BIT				= NULL,
	@BURSLULUK			BIT				= NULL,
	@SINIFKAPASITE		BIT				= 0, --0 xbase/ 1 öğr say
	@SINAVTARIH			VARCHAR(50)		= NULL,
	@SEANS				VARCHAR(50)		= NULL,
	@JSEXCEL			NVARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_BURSLULUKDOSYA			= @ID_BURSLULUKDOSYA	
			,KENDISINIF					= @KENDISINIF			
			,BURSLULUK					= @BURSLULUK			
			,SINIFKAPASITE				= @SINIFKAPASITE		
			,SINAVTARIH					= @SINAVTARIH			
			,SEANS						= @SEANS				
			,JSEXCEL					= @JSEXCEL			
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
	
		DROP TABLE IF EXISTS #SINAVSINIF
		DROP TABLE IF EXISTS #OGRENCILIST
		DROP TABLE IF EXISTS #OL
		DROP TABLE IF EXISTS #SL
		DROP TABLE IF EXISTS #TT
		DROP TABLE IF EXISTS #SNF
		DROP TABLE IF EXISTS #ATANACAK
		DROP TABLE IF EXISTS #ATANAMAYANLAR
		DROP TABLE IF EXISTS #WSB
		DROP TABLE IF EXISTS #WSN
		DROP TABLE IF EXISTS #KARMA
		DROP TABLE IF EXISTS #KarmaTemp
		DROP TABLE IF EXISTS #OGR

		DECLARE @ID_KARMALISTE INT
		SET @ID_KARMALISTE = (	SELECT TOP 1 
									ID_KARMALISTE 
								FROM KarmaListeSQL 
								WHERE	KYE_TCKIMLIKNO	= @TCKIMLIKNO 
									AND SINAVTARIH		= @SINAVTARIH 
									AND (	(	@BURSLULUK = 1 AND SEANS = @SEANS)
											OR	@BURSLULUK = 0
										)
								ORDER BY ID_KARMALISTE DESC
							)

		IF @ISLEM =	0
		BEGIN
			RAISERROR ('Daha sonra tekrar deneyiniz.' , -- Message text.
						16, -- Severity.
						1-- State.
						);
		END

		IF @ISLEM =	1	--	YENİ DAĞIT
		BEGIN

			DECLARE @BASTARIH DATETIME=GETDATE()

	

				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= S.ID_SINIF
					,ID_SUBE		= SGS.ID_SUBE
					,SNFOGRSAY		= CASE	WHEN @SINIFKAPASITE = 1 
											THEN (SELECT COUNT(TCKIMLIKNO) FROM v3Ogrenci G WHERE G.ID_SINIF = S.ID_SINIF )
											ELSE D.SINAVKAPASITE
										END
					,RND			= ROW_NUMBER() OVER(ORDER BY NEWID())
				INTO #SINAVSINIF 
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.DBO.v3SubeGrupSinif 		AS	SGS	ON	SGS.ID_SINIF	= SL.VALUE
				INNER JOIN OkyanusDB.dbo.v3Sinif				AS	S	ON	S.ID_SINIF		= SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= S.ID_DERSLIK
		UNION
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= S.ID_SINIF
					,ID_SUBE		= S.ID_SUBE
					,SNFOGRSAY		= CASE	WHEN @SINIFKAPASITE = 1 AND S.ID_SINIF_KAMPUS IS NULL 
												THEN (SELECT COUNT(TC_OGRENCI) FROM OkyanusDB.dbo.v4SinifOgrenci G WHERE G.ID_SINIF = S.ID_SINIF AND G.AKTIF = 1)
											WHEN (@SINIFKAPASITE = 1 AND S.ID_SINIF_KAMPUS IS NOT NULL ) OR (@SINIFKAPASITE = 0 AND S.ID_SINIF_KAMPUS IS NOT NULL )
												THEN (SELECT COUNT(TCKIMLIKNO) FROM v3Ogrenci G WHERE G.ID_SINIF = S.ID_SINIF_KAMPUS )
											ELSE D.SINAVKAPASITE
										END
					,RND			= ROW_NUMBER() OVER(ORDER BY NEWID())
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.dbo.v4Sinif				AS	S	ON	S.ID_SINIF		= SL.VALUE
				LEFT  JOIN OkyanusDB.dbo.v3Sinif				AS	KS	ON	KS.ID_SINIF		= S.ID_SINIF_KAMPUS
				LEFT  JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= KS.ID_DERSLIK
				WHERE S.AKTIF = 1
			
			
			
			CREATE TABLE #OGRENCILIST (TCKIMLIKNO VARCHAR(MAX),ID_SINIF INT,RND INT,SINAVSINIF INT,ID_SUBE INT,ID_SINAV INT,ID_SINAVTURU INT)
			
			BEGIN
				BEGIN
					
					

					IF (@BURSLULUK=0)
					BEGIN
						
						INSERT INTO #OGRENCILIST
						SELECT DISTINCT O.TCKIMLIKNO,O.ID_SINIF,ROW_NUMBER() OVER(ORDER BY NEWID()) RND,0 SINAVSINIF,SS.ID_SUBE,ID_SINAV,ID_SINAVTURU
						FROM #SINAVSINIF	SS
						JOIN OkyanusDB.dbo.vw_SinifOgrenci		O	ON	O.ID_SINIF	= SS.ID_SINIF

					END
					ELSE
					BEGIN
						INSERT INTO #OGRENCILIST (TCKIMLIKNO ,ID_SINIF ,RND ,SINAVSINIF ,ID_SUBE ,ID_SINAV ,ID_SINAVTURU )
						SELECT	DISTINCT J.TCKIMLIKNO
								,0
								,ROW_NUMBER() OVER(ORDER BY NEWID())
								,0
								,J.ID_SUBE
								,J.ID_SINAV
								,12
						FROM BurslulukSinavOgrenci	J
						JOIN Sinav					S	ON	S.ID_SINAV	= J.ID_SINAV												
						WHERE	J.ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
							AND J.SINAVTARIH		= @SINAVTARIH
							AND J.SEANS				= @SEANS
							AND J.ID_SUBE			IN (SELECT ID_SUBE FROM #SINAVSINIF)
								
						WHILE EXISTS (SELECT * FROM #OGRENCILIST WHERE ID_SINIF = 0 )
						BEGIN		
							DECLARE @T VARCHAR(11) = (SELECT TOP 1 TCKIMLIKNO FROM #OGRENCILIST WHERE ID_SINIF = 0 ORDER BY RND)

							UPDATE O
							SET O.ID_SINIF = (	SELECT TOP 1 
													ID_SINIF 
												FROM #SINAVSINIF SS 
												WHERE	SS.SNFOGRSAY > (SELECT COUNT(1) FROM #OGRENCILIST OL WHERE OL.ID_SINIF = SS.ID_SINIF AND OL.ID_SUBE = SS.ID_SUBE) 
													AND O.ID_SUBE = SS.ID_SUBE 
												ORDER BY SS.SNFOGRSAY DESC
											)
							FROM #OGRENCILIST O
							WHERE TCKIMLIKNO = @T
						END
					END	
					
				END
				
				
				
				IF @KENDISINIF = 1
				BEGIN
					UPDATE O
					SET SINAVSINIF = O.ID_SINIF
					FROM #OGRENCILIST O
				END
				ELSE
				BEGIN

					DECLARE @tc VARCHAR(11), @idSinif INT, @idSube INT 

				
					CREATE TABLE #SNF(ID_SUBE INT, ID_SINIF INT, SNFOGRSAY INT, RND INT, RNSB INT)
					CREATE TABLE #OGR(ID_SUBE INT, ID_SINIF INT, TCKIMLIKNO VARCHAR(11), RND INT)
					CREATE TABLE #KARMA(TCKIMLIKNO VARCHAR(11), ID_SINIF INT)
					
					INSERT INTO #OGR(ID_SUBE, ID_SINIF, TCKIMLIKNO, RND)
					SELECT SS.ID_SUBE, O.ID_SINIF, TCKIMLIKNO, RND = ROW_NUMBER() OVER(ORDER BY NEWID()) 
					FROM OkyanusDB.dbo.vw_SinifOgrenci	O
					JOIN #SINAVSINIF					SS	ON	SS.ID_SINIF = O.ID_SINIF 

					
					INSERT INTO #SNF(ID_SUBE ,ID_SINIF, SNFOGRSAY) 
					SELECT ID_SUBE, ID_SINIF, COUNT(1)
					FROM #OGR O
					GROUP BY ID_SUBE, ID_SINIF

					
					UPDATE S
					SET S.RNSB = K.RNSB
					FROM #SNF S
					JOIN (
						SELECT ID_SUBE, RNSB = ROW_NUMBER() OVER(ORDER BY ID_SUBE) 
						FROM #SNF K
						GROUP BY ID_SUBE) AS K ON K.ID_SUBE = S.ID_SUBE

					UPDATE S
					SET S.RND = K.RND
					FROM #SNF S
					JOIN (  SELECT 
								 ID_SUBE
								,ID_SINIF
								,RND = ROW_NUMBER() OVER(PARTITION BY ID_SUBE ORDER BY NEWID())
							FROM #SNF K
							GROUP BY ID_SUBE, ID_SINIF
					) AS K ON K.ID_SUBE = S.ID_SUBE AND K.ID_SINIF = S.ID_SINIF


				SELECT DISTINCT T.ID_SUBE, T.ID_SINIF, ADET = 0
				INTO #KarmaTemp FROM #SNF	T

				DECLARE @I_SUBE INT = 1, @COUNT_SUBE INT
				SET @COUNT_SUBE = (SELECT MAX(RNSB) FROM #SNF)
				-- Sube Kadar Dön
				WHILE @I_SUBE <= @COUNT_SUBE
				BEGIN

					DECLARE @I_SINIF INT = 1, @COUNT_SINIF INT, @SNFOGRSAY INT = 0
					SET @COUNT_SINIF = (SELECT COUNT(DISTINCT ID_SINIF) FROM #SNF WHERE RNSB = @I_SUBE)
					-- Sýnýf Kadar Dön
					WHILE @I_SINIF <= @COUNT_SINIF
					BEGIN
		
						SELECT @idSinif = ID_SINIF, @SNFOGRSAY = SNFOGRSAY FROM #SNF WHERE RND = @I_SINIF AND RNSB = @I_SUBE
			
						CREATE TABLE #OGRTEMP(ID_SUBE INT, TCKIMLIKNO VARCHAR(11), RND INT)

						INSERT INTO #OGRTEMP(ID_SUBE, TCKIMLIKNO, RND)
						SELECT DISTINCT ID_SUBE, TCKIMLIKNO, RND = ROW_NUMBER() OVER(ORDER BY NEWID()) 
						FROM #OGR
						WHERE ID_SINIF = @idSinif


						DECLARE @I INT = 1, @COUNT INT = 0
						SET @COUNT = (SELECT COUNT(1) FROM #OGRTEMP)

						SET @I = 1
						-- Sınıftaki Öğrenci Kadar Dön
						WHILE @I <= @COUNT
						BEGIN
	
							SELECT @tc = TCKIMLIKNO, @idSube = ID_SUBE FROM #OGRTEMP WHERE RND = @I
	
							SELECT TOP 1
								@idSinif = K.ID_SINIF
							FROM #SNF				T
							INNER JOIN #KarmaTemp	K	ON	T.ID_SINIF = K.ID_SINIF AND T.ID_SUBE = K.ID_SUBE AND T.SNFOGRSAY > K.ADET
							WHERE T.ID_SUBE = @idSube
							ORDER BY K.ADET

		
							INSERT INTO #KARMA(TCKIMLIKNO, ID_SINIF) VALUES(@tc, @idSinif)

							UPDATE #KarmaTemp
							SET ADET = ADET + 1
							WHERE ID_SINIF = @idSinif

							SET @I = @I + 1
						END

						DROP TABLE #OGRTEMP

						SET @I_SINIF = @I_SINIF + 1
					END


					SET @I_SUBE = @I_SUBE + 1
				END
				
			
				
				UPDATE O
				SET SINAVSINIF = T.ID_SINIF
				FROM #OGRENCILIST O
				JOIN #KARMA T ON T.TCKIMLIKNO = O.TCKIMLIKNO			

						
				
					
				END

				IF EXISTS( SELECT 1 FROM #OGRENCILIST WHERE SINAVSINIF IS NULL OR SINAVSINIF = 0)
				BEGIN
					RAISERROR ('Seçilen sınıf sayısı yeterli değildir.', 16, 1);
					RETURN;
				END
				ELSE
				BEGIN
						IF @BURSLULUK = 1
						BEGIN
							DELETE FROM KarmaListeSQL WHERE SINAVTARIH = CAST(@SINAVTARIH as datetime) AND SEANS = @SEANS AND KYE_TCKIMLIKNO = @TCKIMLIKNO
							INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO,BAS_TARIH,SEANS)
							VALUES (@SQLJSON,@KENDISINIF,@SINAVTARIH,@TCKIMLIKNO,@BASTARIH,@SEANS)
							SET @ID_KARMALISTE = SCOPE_IDENTITY()
						END
						ELSE
						BEGIN
							DELETE FROM KarmaListeSQL WHERE SINAVTARIH =  cast(@SINAVTARIH as datetime)  AND KYE_TCKIMLIKNO=@TCKIMLIKNO
							INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO,BAS_TARIH)
							VALUES (@SQLJSON,@KENDISINIF,@SINAVTARIH,@TCKIMLIKNO,@BASTARIH)
							SET @ID_KARMALISTE = SCOPE_IDENTITY()
						END
				

					DELETE FROM KarmaListeTemp WHERE ID_KARMALISTE NOT IN (SELECT ID_KARMALISTE FROM KarmaListeSQL)
					INSERT INTO KarmaListeTemp (ID_KARMALISTE,TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU)
					SELECT @ID_KARMALISTE,TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU FROM #OGRENCILIST
				END

			END

			SET @ISLEM = 3 -- RAPOR			
			

		END

		IF @ISLEM = 2	--	KarmaListeExcel YÜKLE
		BEGIN		
		
			DELETE FROM KarmaListeSQL WHERE SINAVTARIH =  cast(@SINAVTARIH as datetime)  AND KYE_TCKIMLIKNO=@TCKIMLIKNO
			INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO)
			VALUES ('EXCEL',0,cast(@SINAVTARIH as datetime),@TCKIMLIKNO)

			SET @ID_KARMALISTE = SCOPE_IDENTITY()
		
			DELETE FROM KarmaListeExcel WHERE ID_KARMALISTE NOT IN (SELECT ID_KARMALISTE FROM KarmaListeSQL)

			INSERT INTO KarmaListeExcel (ID_KARMALISTE,TCKIMLIKNO,ADSOYAD)
			SELECT	 @ID_KARMALISTE
					,TCKIMLIKNO		= JSON_VALUE (J.VALUE,'$.TCKIMLIKNO') 
					,ADSOYAD		= JSON_VALUE (J.VALUE,'$.ADSOYAD') 			
			FROM OPENJSON (@JSEXCEL) AS J
			--FOR JSON PATH
		END

		IF @ISLEM = 3	--	RAPOR
		BEGIN
	
				SELECT TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU INTO #OGRENCILIST2 FROM KarmaListeTemp WHERE ID_KARMALISTE = @ID_KARMALISTE

				SET @SQLJSON = (SELECT TOP 1 SQLJSON FROM KarmaListeSQL WHERE ID_KARMALISTE = @ID_KARMALISTE)

				
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= SL.VALUE 
					,ID_SUBE		= SGS.ID_SUBE
					--,SNFOGRSAY		= D.SINAVKAPASITE
					,SUBOGRSAY		= 0
					,SNFSAY			= 0
					,RND			= 0
					,MINSINIF		= 0
					--,ID_DERSSEVIYE	= NULL
					,DERSSEVIYE		= NULL
				INTO #SINAVSINIF2 
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.DBO.v3SubeGrupSinif 		AS	SGS	ON	SGS.ID_SINIF	= SL.VALUE
				INNER JOIN OkyanusDB.dbo.v3Sinif				AS	S	ON	S.ID_SINIF		= SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= S.ID_DERSLIK
			UNION
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= SL.VALUE 
					,ID_SUBE		= S.ID_SUBE
					--,SNFOGRSAY		= D.SINAVKAPASITE
					,SUBOGRSAY		= 0
					,SNFSAY			= 0
					,RND			= 0
					,MINSINIF		= 0
					--,ID_DERSSEVIYE	= SD.ID_DERSSEVIYE
					,DERSSEVIYE		= SD.DERSSEVIYE
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.dbo.v4Sinif				AS	S	ON	S.ID_SINIF		= SL.VALUE
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay		AS	SD	ON	SD.ID_SINIF		= S.ID_SINIF
				LEFT  JOIN OkyanusDB.dbo.v3Sinif				AS	KS	ON	KS.ID_SINIF		= S.ID_SINIF_KAMPUS
				LEFT  JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= KS.ID_DERSLIK
				WHERE S.AKTIF = 1



		
					IF @BURSLULUK = 0
					BEGIN
					
						SELECT	OL.TCKIMLIKNO
							,SINIFAD			= OSN.AD
							,SUBEAD				= SB.AD
							,ID_SUBE			= SB.ID_SUBE	
							,ID_SINIF			= OSN.ID_SINIF	
							,SINAVSINIFAD		= SSN.AD
							,SINIFSUBEAD		= SB.AD+'-'+OSN.AD
							,SINAVSINIFSUBEAD	= SB.AD+'-'+SSN.AD
							,ID_SINIFSINAV		= SSN.ID_SINIF
							,ADSOYAD			= K.AD+' '+K.SOYAD
							,RND
							,O.OGRNO
							,DERSSEVIYE			= NULL
							,SINAVAD			= CASE	WHEN OL.ID_SINAVTURU = 0 
													THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
													ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
													END
						FROM #OGRENCILIST2	OL
						JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= OL.TCKIMLIKNO
						JOIN v3Sinif		OSN	ON	OSN.ID_SINIF	= O.ID_SINIF
						JOIN v3Sinif		SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube			SB	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO						
					UNION
						SELECT	
							 TCKIMLIKNO			= OL.TCKIMLIKNO
							,SINIFAD			= OS.AD
							,SUBEAD				= SB.AD
							,ID_SUBE			= SB.ID_SUBE	
							,ID_SINIF			= OS.ID_SINIF	
							,SINAVSINIFAD		= ISNULL(SS.AD,SSN.AD)
							,SINIFSUBEAD		= SB.AD + '-' + OS.AD
							,SINAVSINIFSUBEAD	= SB.AD + '-' + ISNULL(SS.AD,SSN.AD)
							,ID_SINIFSINAV		= ISNULL(SS.ID_SINIF,SSN.ID_SINIF)
							,ADSOYAD			= K.AD + ' ' + K.SOYAD
							,RND
							,O.OGRNO
							--,ID_DERSSEVIYE		= OSN.ID_DERSSEVIYE
							,DERSSEVIYE			= OSN.DERSSEVIYE
							,SINAVAD			= CASE	WHEN OL.ID_SINAVTURU = 0 
													THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
													ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
													END
						FROM #OGRENCILIST2						OL
						JOIN v3Ogrenci							O	ON	O.TCKIMLIKNO	= OL.TCKIMLIKNO
						JOIN v3Sinif							OS	ON	OS.ID_SINIF		= O.ID_SINIF
						JOIN OkyanusDB.dbo.vw_v4SinifDetay		OSN	ON	OSN.ID_SINIF	= OL.ID_SINIF
						JOIN OkyanusDB.dbo.v4Sinif				SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube								SB	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						--JOIN v3Sinif							SS	ON	SS.ID_SINIF		= SSN.ID_SINIF_KAMPUS
						LEFT JOIN v3Sinif						SS	ON	SS.ID_SINIF		= SSN.ID_SINIF_KAMPUS

					END
					ELSE
					BEGIN

						SELECT	OL.TCKIMLIKNO
							,SINIFAD	  = ''
							,SUBEAD		  = SB.AD
							,ID_SUBE	  = SB.ID_SUBE	
							,ID_SINIF	  = OSN.ID_SINIF	
							,SINAVSINIFAD = SSN.AD
							,ID_SINIFSINAV= SSN.ID_SINIF
							,SINIFSUBEAD  = SB.AD+'-'+OSN.AD
							,SINAVSINIFSUBEAD  = SB.AD+'-'+SSN.AD

							,ADSOYAD	  = K.AD+' '+K.SOYAD
							,RND
							,OGRNO		= ''--row_number() over(order by OL.TCKIMLIKNO)
							,SINAVAD	= CASE	WHEN OL.ID_SINAVTURU = 0 
												THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
												ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
												END
						FROM #OGRENCILIST2	OL	
						JOIN v3Sinif		OSN	ON	OSN.ID_SINIF	= OL.ID_SINIF
						JOIN v3Sinif		SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube			SB	ON	SB.ID_SUBE		= OL.ID_SUBE
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= OL.TCKIMLIKNO
						ORDER BY OL.ID_SUBE,OL.SINAVSINIF,RND
					END

					-- SINIF
					SELECT	 SS.ID_SINIF
							,SINIFAD		= SD.SUBEAD +'-'+ SD.SINIF
							,KAGITSAYISI	= (SELECT COUNT(1) FROM #OGRENCILIST2 O WHERE O.SINAVSINIF = SS.ID_SINIF AND O.ID_SINAV = OL.ID_SINAV)
							,SINAVAD		= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,TARIH			= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,GUN			= datename(dw,
													CASE	WHEN OL.ID_SINAVTURU = 0 
																				THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																				ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																				END)
							,SEANS			= ISNULL(@SEANS,'')
							--,ID_DERSSEVIYE	= NULL
							,DERSSEVIYE		= NULL
					FROM #SINAVSINIF2					SS
					JOIN #OGRENCILIST2					OL	ON	OL.SINAVSINIF	= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sinif			S	ON	S.ID_SINIF		= SS.ID_SINIF
					JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= SS.ID_SINIF
					GROUP BY SS.ID_SINIF,OL.ID_SINAVTURU,OL.ID_SINAV,OL.ID_SUBE,SD.SUBEAD,SD.SINIF
				UNION 					
					SELECT	 SS.ID_SINIF
							,SINIFAD		= IIF(SD.SINIF IS NOT NULL ,SD.SUBEAD +'-'+ SD.SINIF,SB.AD+'-'+S.AD)
							,KAGITSAYISI	= (SELECT COUNT(1) FROM #OGRENCILIST2 O WHERE O.SINAVSINIF = SS.ID_SINIF AND O.ID_SINAV = OL.ID_SINAV)
							,SINAVAD		= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,TARIH			= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,GUN			= datename(dw,
													CASE	WHEN OL.ID_SINAVTURU = 0 
																				THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																				ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																				END)
							,SEANS			= ISNULL(@SEANS,'')
							--,SS.ID_DERSSEVIYE
							,OSD.DERSSEVIYE
					FROM #SINAVSINIF2						SS
					JOIN #OGRENCILIST2						OL	ON	OL.SINAVSINIF	= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v4Sinif				S	ON	S.ID_SINIF		= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE		= S.ID_SUBE
					JOIN OkyanusDB.dbo.vw_v4SinifDetay		OSD	ON	OSD.ID_SINIF	= OL.ID_SINIF
					LEFT JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= S.ID_SINIF_KAMPUS
					GROUP BY SS.ID_SINIF,OL.ID_SINAVTURU,OL.ID_SINAV,OL.ID_SUBE,SD.SUBEAD,SD.SINIF, OSD.DERSSEVIYE, S.AD, SB.AD--,SD.ID_DERSSEVIYE
					ORDER BY SS.ID_SINIF



					-- OKUL		
					SELECT	 ID_SINAV
							,OL.ID_SUBE
							,KAGITSAYISI= COUNT(1) 
							,SUBEAD		= SD.SUBEAD --(SELECT TOP 1 AD FROM v3Sube SB WHERE SB.ID_SUBE = OL.ID_SUBE )
							,SINAVAD	= CASE	WHEN OL.ID_SINAVTURU = 0 
														THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
														ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
														END
							,TARIH		= CASE	WHEN OL.ID_SINAVTURU = 0 
														THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
														ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
														END
							,GUN		= datename(dw,
												CASE	WHEN OL.ID_SINAVTURU = 0 
																			THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																			ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																			END)
							,SEANS		= ISNULL(@SEANS,'')
							--,SD.ID_DERSSEVIYE
							,SD.DERSSEVIYE
					FROM #OGRENCILIST2					OL
					JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= OL.ID_SINIF
					GROUP BY ID_SINAV,OL.ID_SUBE,ID_SINAVTURU,SD.SUBEAD, SD.DERSSEVIYE--,SD.ID_DERSSEVIYE


		END
		
		IF @ISLEM = 4	--	KARMA LISTE BURSLULUK LISTE
		BEGIN
		
			DROP TABLE IF EXISTS #TEMP

			SELECT  
				 ID_SUBE		= T.ID_SUBE
				,ID_SINAV		= T.ID_SINAV
				,ID_KADEME3		= T.ID_KADEME3
				,KADEME3		= K3.AD
				,BSV_SAY		= COUNT(1)	
				,SINAVAD		= S.AD
				,ID_SINAVTURU	= S.ID_SINAVTURU
			INTO #TEMP
			FROM BurslulukSinavOgrenci	T
			JOIN v3Kademe3				K3	ON	K3.ID_KADEME3	= T.ID_KADEME3
			JOIN Sinav					S	ON	S.ID_SINAV		= T.ID_SINAV
			WHERE	T.ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
				AND T.SINAVTARIH		= @SINAVTARIH
				AND T.SEANS				= @SEANS
			GROUP BY T.ID_SUBE, T.ID_SINAV, T.ID_KADEME3, K3.AD, S.AD, S.ID_SINAVTURU

			SELECT(
				SELECT   
					 ID_SUBE	= SB.ID_SUBE
					,SUBEAD		= SB.AD
					,ID_KADEME3	= SN.ID_KADEME3
					,ID_SINAV	= SN.ID_SINAV
					,SINAVAD	= SN.SINAVAD
					,KADEME3	= SN.KADEME3
					,BSV_SAY	= SN.BSV_SAY
					,ID_SINAVTURU
				FROM #TEMP		SN
				JOIN v3Sube		SB	ON	SB.ID_SUBE		= SN.ID_SUBE	
				WHERE SN.ID_SINAV > 0
				ORDER BY ID_SUBE,ID_KADEME3
				FOR JSON AUTO
			) AS S

			DROP TABLE IF EXISTS #TEMP

		END
		
		DROP TABLE IF EXISTS #ATANACAK
		DROP TABLE IF EXISTS #ATANAMAYANLAR
		DROP TABLE IF EXISTS #OGRENCILIST
		DROP TABLE IF EXISTS #OGRENCILIST2
		DROP TABLE IF EXISTS #OL
		DROP TABLE IF EXISTS #SINAVSINIF
		DROP TABLE IF EXISTS #SINAVSINIF2
		DROP TABLE IF EXISTS #SL
		DROP TABLE IF EXISTS #SNF
		DROP TABLE IF EXISTS #TT
		DROP TABLE IF EXISTS #WSB
		DROP TABLE IF EXISTS #WSN
		DROP TABLE IF EXISTS #KARMA
		DROP TABLE IF EXISTS #KarmaTemp
		DROP TABLE IF EXISTS #OGR

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_KazanimAnalizi]    Script Date: 23.11.2021 14:38:15 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	[dbo].[sp_KazanimAnalizi]
--		@TCKIMLIKNO = '52432651008',
--		@OTURUM = 'B06FE75D-2862-4589-946B-E4EB16D4B15F',
--		@ID_MENU = 1096,
--		@ID_SINIFLAR = '[0,101926,101927,101924,101925,101873,101875]',
--		@ID_SINAVLAR = '[0,11]',
--		@ISLEM = 1,
--		@DONEM = '2017'

ALTER procedure [dbo].[sp_KazanimAnalizi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVLAR		VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@IP					VARCHAR(50)	= NULL
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAVLAR				= @ID_SINAVLAR
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP

		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			IF @ISLEM = 1 OR @ISLEM = 2	--	Kazanım Analizi
			BEGIN
				SELECT	--COUNT(*)
						Y.ID_YAZILI
						,Y.AD						AS SINAVAD
						,Y.YAZILITARIH
						,O.ID_SUBE
						,SU.AD						AS SUBE
						,S.AD						AS SINIF
						,S.ID_SINIF
						,Y.ID_DERS
						,D.DERSAD					AS DERSAD
						,SDU.KOD
						,SDU.AD						AS KAZANIM
						,ISNULL(YOC.PUAN, 0)		AS PUAN
						,ISNULL(YS.PUAN, 0)			AS MAXPUAN
						,YS.SORUNO
				INTO #GENEL
				FROM Yazili									Y
				INNER JOIN eokul_v2.dbo.Ders				D	 ON	D.ID_DERS		= Y.ID_DERS
				INNER JOIN YaziliSoru						YS	 ON	YS.ID_YAZILI	= Y.ID_YAZILI
				INNER JOIN YaziliOgrenci					YO	 ON	YO.ID_YAZILI	= Y.ID_YAZILI
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU  ON	SDU.KOD			= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC	 ON	YOC.ID_YAZILISORU = YS.ID_YAZILISORU AND YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	 ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube				SU   ON	SU.ID_SUBE		= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif			S	 ON	S.ID_SINIF		= O.ID_SINIF
				WHERE	Y.ID_YAZILI IN (SELECT VALUE FROM OPENJSON(@ID_SINAVLAR))
				--AND		S.ID_SINIF  IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))
				AND		YO.KATILMADI = 0 AND YO.AKTIF = 1
				ORDER BY ID_SUBE, S.ID_SINIF, YO.TCKIMLIKNO, Y.ID_YAZILI, YS.SORUNO

				SELECT  g.ID_YAZILI,
						g.SINAVAD,
						g.YAZILITARIH,
						g.ID_DERS,
						g.ID_SUBE,
						g.SUBE,
						g.SINIF,
						g.ID_SINIF,
						g.DERSAD,
						g.KOD,
						g.KAZANIM,
						(Select SUM(MAXPUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI) as GENELMAXPUAN,
						(Select SUM(PUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI) as GENELPUAN,
						(Select SUM(MAXPUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE) as SUBEMAXPUAN,
						(Select SUM(PUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE) as SUBEPUAN,
						(Select SUM(MAXPUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE and gg.SINIF=g.SINIF ) as SINIFMAXPUAN,
						(Select SUM(PUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE and gg.SINIF=g.SINIF) as SINIFPUAN
				INTO #GENEL2
				FROM #GENEL g				
				GROUP BY	g.ID_YAZILI,
							g.YAZILITARIH,
							g.SINAVAD, 
							g.ID_SUBE,
							g.SUBE, 
							g.SINIF,
							g.ID_DERS,
							g.DERSAD,
							g.KOD,
							g.KAZANIM
							,g.ID_SINIF
				ORDER BY g.ID_YAZILI,g.DERSAD,g.KAZANIM

					
				SELECT DISTINCT 
						su.ID_YAZILI, 
						su.ID_DERS,
						su.KOD,
						su.SORUNO
				INTO #tempsorusayilari --uniteye göre
				FROM #GENEL su
				ORDER BY su.ID_YAZILI,su.KOD

				SELECT	su.ID_YAZILI, 
						su.ID_DERS,
						su.KOD,
						Count(su.SORUNO) as SORUSAYISI
				INTO #UniteSoruSayilari
				FROM #tempsorusayilari su
				GROUP BY su.ID_YAZILI,su.ID_DERS,su.KOD
				ORDER BY su.ID_YAZILI,su.KOD

				drop table #GENEL
				drop table #tempsorusayilari

				SELECT	t2.ID_YAZILI,
						t2.YAZILITARIH,
						t2.SINAVAD, 
						t2.ID_SUBE,
						t2.SUBE, 
						t2.SINIF,
						t2.ID_DERS,
						t2.DERSAD,
						t2.KOD,
						t2.KAZANIM,
						USS.SORUSAYISI,
						(Convert(decimal(7,2),(Convert(decimal(7,2),t2.GENELPUAN)/convert(decimal(7,2),t2.GENELMAXPUAN))*100)) as GENELYUZDE,
						(Convert(decimal(7,2),(Convert(decimal(7,2),t2.SUBEPUAN) /convert(decimal(7,2),t2.SUBEMAXPUAN ))*100)) as SUBEYUZDE,
						(Convert(decimal(7,2),(Convert(decimal(7,2),t2.SINIFPUAN)/convert(decimal(7,2),t2.SINIFMAXPUAN))*100)) as SINIFYUZDE
				INTO #temp3
				FROM #GENEL2 t2
				INNER JOIN #UniteSoruSayilari USS ON USS.ID_YAZILI = t2.ID_YAZILI AND USS.KOD = t2.KOD
				where t2.ID_SINIF  IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))
				


				DECLARE @SATIRSAYISI int=(SELECT COUNT(DISTINCT KAZANIM) FROM #temp3)

				Select distinct 
					ID_SUBE,
					SUBE,
					ID_YAZILI,
					YAZILITARIH,
					SINAVAD,
					SINIF
				into #temp4
				from #temp3
				--where ID_SINIF  IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))

				Declare @SUBEADET int=(Select COUNT(distinct SUBE) from #temp4)
				Declare @SINAVADET int=(Select COUNT(distinct SINAVAD) from #temp4)

				IF @ISLEM = 1
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								Select distinct 
										ID_SUBE,
										SUBE,
										SINAVAD,
										YAZILITARIH,
										SINIF,
										(Select Count(SUBE) from #temp4 t1 where t1.SUBE=t2.SUBE) as SUBESAYI,
										(Select Count(SINAVAD) from #temp4 t1 where t1.SINAVAD=t2.SINAVAD and t1.SUBE=t2.SUBE) as SINIFSAYI,
										@SUBEADET as SUBEADET,
										ISNULL((Select COUNT(distinct SINAVAD) from #temp4 WHERE ID_SUBE=t2.ID_SUBE),0) as SINAVADET
								from #temp4 t2
								order by SUBE,YAZILITARIH desc,SINIF
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T1,
							(
								SELECT  t3.ID_SUBE,
										t3.SUBE,
										t3.SINIF, 
										t3.DERSAD,
										t3.KOD,
										t3.SINAVAD,
										t3.KAZANIM,
										t3.SORUSAYISI,
										t3.GENELYUZDE,
										t3.SUBEYUZDE,
										t3.SINIFYUZDE,
								(SELECT COUNT(KOD) FROM #temp3 tt where tt.KOD=t3.KOD) as KONUSATIRSAYISI,
								@SATIRSAYISI as TOPLAMSATIRSAYISI
								from #temp3 t3
								order by t3.KOD,t3.DERSAD,t3.SUBE,t3.YAZILITARIH desc,t3.SINIF
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T2
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END
				ELSE
				BEGIN
					Select distinct 
							ID_SUBE,
							SUBE,
							SINAVAD,
							YAZILITARIH,
							SINIF,
							(Select Count(SUBE) from #temp4 t1 where t1.SUBE=t2.SUBE) as SUBESAYI,
							(Select Count(SINAVAD) from #temp4 t1 where t1.SINAVAD=t2.SINAVAD and t1.SUBE=t2.SUBE) as SINIFSAYI,
							@SUBEADET as SUBEADET,
							ISNULL((Select COUNT(distinct SINAVAD) from #temp4 WHERE ID_SUBE=t2.ID_SUBE),0) as SINAVADET
					from #temp4 t2

					SELECT  t3.ID_SUBE,
							t3.SUBE,
							t3.SINIF, 
							t3.DERSAD,
							t3.KOD,
							t3.SINAVAD,
							t3.YAZILITARIH,
							t3.KAZANIM,
							t3.SORUSAYISI,
							t3.GENELYUZDE,
							t3.SUBEYUZDE,
							t3.SINIFYUZDE,
					(SELECT COUNT(KOD) FROM #temp3 tt where tt.KOD=t3.KOD) as KONUSATIRSAYISI,
					@SATIRSAYISI as TOPLAMSATIRSAYISI
					from #temp3 t3
					order by t3.KOD,t3.DERSAD,t3.SUBE,t3.YAZILITARIH,t3.SINIF
				END
				
				drop table #GENEL2
				DROP TABLE IF EXISTS #temp1
				DROP TABLE IF EXISTS #temp2
				DROP TABLE IF EXISTS #temp3
				DROP TABLE IF EXISTS #temp4
				drop table #UniteSoruSayilari
			END 
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO


USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_KazanimAnaliziOO]    Script Date: 23.11.2021 14:38:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER procedure [dbo].[sp_KazanimAnaliziOO]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_YAZILI			INT				= 0,
	@ID_SINIF			INT				= 0,
	@ISLEM				INT				= 0,
	@IP					VARCHAR(50)	= NULL
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_YAZILI					= @ID_YAZILI	
			,ID_SINIF					= @ID_SINIF	
			,ISLEM						= @ISLEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
						
			IF @ISLEM = 1	--	Kazanım Analizi Orta Okul
			BEGIN

				SELECT  Y.AD AS SINAVAD
						,YS.KOD
						,SDU.AD AS KAZANIM 
						,YO.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,Y.DONEM
						,YS.PUAN AS SORUPUAN
						,YOC.PUAN AS OGRENCIPUAN
				INTO #TEMPOO
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.ID_YAZILI = @ID_YAZILI AND YO.KATILMADI = 0 AND YO.AKTIF = 1 AND O.ID_SINIF = @ID_SINIF


				SELECT	SINAVAD
						,KOD
						,KAZANIM
						,TCKIMLIKNO
						,ADSOYAD
						,DONEM
						,CONVERT(DECIMAL(18,2), CONVERT(DECIMAL(18,2), SUM(OGRENCIPUAN)) / CONVERT(DECIMAL(18,2), SUM(SORUPUAN)) * 100.0) AS YUZDE
						,SUM(SORUPUAN) AS KAZANIMPUANI
				FROM #TEMPOO
				GROUP BY SINAVAD, KOD, TCKIMLIKNO, KAZANIM, ADSOYAD, DONEM
				ORDER BY ADSOYAD,KOD


				SELECT	SINAVAD
						,KOD
						,KAZANIM
						,DONEM
						,CONVERT(DECIMAL(18,2), CONVERT(DECIMAL(18,2), SUM(OGRENCIPUAN)) / CONVERT(DECIMAL(18,2), SUM(SORUPUAN)) * 100.0) AS YUZDE
						,SUM(SORUPUAN) AS KAZANIMPUANI
				FROM #TEMPOO
				GROUP BY SINAVAD, KOD, KAZANIM, DONEM
				ORDER BY KOD, SINAVAD, KAZANIM


				DROP TABLE #TEMPOO

				SELECT	 S.AD AS SINIF
						,SB.AD AS SUBE
						,D.KOD + '-' + CAST(CAST(D.KOD AS INT) + 1 AS VARCHAR) AS DONEM
						,(SELECT AD FROM Yazili WHERE ID_YAZILI = @ID_YAZILI) AS SINAVAD
				FROM OkyanusDB.dbo.v3Sinif S
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif SGS ON SGS.ID_SINIF = S.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Donem D ON D.ID_DONEM = S.ID_DONEM
				WHERE S.ID_SINIF = @ID_SINIF

			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_KonuAnaliziCoklu]    Script Date: 23.11.2021 14:38:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_KonuAnaliziCoklu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@LIMIT				INT				= 100,
	@ID_SINAVS			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,LIMIT						= @LIMIT			
			,ID_SINAVS					= @ID_SINAVS		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0


BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	KONU ANALİZİ
		BEGIN
		
			--exec sp_KonuAnalizi @ISLEM=1, @TCKIMLIKNO='34454003058',@OTURUM='AF6EC483-F078-4F55-AAAD-A4FFD02604D4',@TC_OGRENCI='34454003058',@DONEM= '', @ID_MENU= 1031,@ID_SINAVS='[]'

			--SET @TCKIMLIKNO='53500095298'

			--declare 
			--@DONEM varchar(max)='2017',
			--@ID_SINAVTURU  varchar(max)='[2]',
			--@ID_SINAVS varchar(max)='[185]',
			--@TC_OGRENCI varchar(max)='',
			--@ID_SINIF int=102207,
			--@ID_SUBE int=427,
			--@LIMIT int = 100

			
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) )
			BEGIN
				SET @OZELSINAVGOR=1
			END

			SELECT @ID_SINIF=ID_SINIF,@ID_SUBE=ID_SUBE FROM v3Ogrenci WHERE TCKIMLIKNO =@TC_OGRENCI		
			SELECT @IL=IL,@ILCE=ILCE FROM V3SUBE WHERE ID_SUBE=@ID_SUBE

			IF OBJECT_ID('tempdb..#PUAN')		IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#KONU')		IS NOT NULL		DROP TABLE #KONU
			IF OBJECT_ID('tempdb..#KONUANALIZ')	IS NOT NULL		DROP TABLE #KONUANALIZ
			IF OBJECT_ID('tempdb..#TT')			IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#TT1')		IS NOT NULL		DROP TABLE #TT1
			IF OBJECT_ID('tempdb..#KK')			IS NOT NULL		DROP TABLE #KK
			IF OBJECT_ID('tempdb..#T1')			IS NOT NULL		DROP TABLE #T1
			IF OBJECT_ID('tempdb..#T2')			IS NOT NULL		DROP TABLE #T2
			IF OBJECT_ID('tempdb..#T3')			IS NOT NULL		DROP TABLE #T3
			IF OBJECT_ID('tempdb..#T4')			IS NOT NULL		DROP TABLE #T4
			IF OBJECT_ID('tempdb..#T5')			IS NOT NULL		DROP TABLE #T5

			SELECT	
					O.TCKIMLIKNO,
					count(1) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
					o.ID_SINAV
			into #KONU
			from SinavOgrenci				o
			JOIN OkyanusDb.dbo.v3Ogrenci	v3o	ON	v3o.TCKIMLIKNO				= o.TCKIMLIKNO	
			JOIN SinavOgrenciCevapBolum		b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
			JOIN SinavOgrenciCevap			c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
			JOIN SinavDers					d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
			JOIN SinavKitapcik				k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
			JOIN SinavAnahtar				a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 		
			JOIN v3SinavDersUnite			u	ON	u.KOD						= a.KOD
			JOIN Sinav						s	ON	s.ID_SINAV					= o.ID_SINAV
			WHERE	
					( @DONEM='' OR @DONEM=0 OR @DONEM=s.DONEM )
				AND ( @ID_SINAVTURU IS NULL OR @ID_SINAVTURU='[]' OR s.ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)) )
				AND ( @ID_SINAVS IS NULL OR @ID_SINAVS='[]' OR s.ID_SINAV in (SELECT Value FROM OPENJSON(@ID_SINAVS)))
				AND ( @TC_OGRENCI IS NULL OR @TC_OGRENCI='' OR @TC_OGRENCI='0' OR o.TCKIMLIKNO=@TC_OGRENCI)
				AND ( @ID_SINIF IS NULL OR @ID_SINIF=0 OR v3o.ID_SINIF=@ID_SINIF)
				AND ( @ID_SUBE IS NULL OR @ID_SUBE=0 OR v3o.ID_SUBE=@ID_SUBE)
				AND s.AKTIF=1 AND s.DURUM=2	and (OZEL=0 OR @OZELSINAVGOR=1)	
			GROUP BY O.TCKIMLIKNO, c.DURUM,d.TAKMAAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK
			ORDER BY d.TAKMAAD

			SELECT DISTINCT
					TCKIMLIKNO,
					KONUAD,
					KOD,						
					DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
					ISNULL( 
					CAST(((100 /
						CAST((
							CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
						))
						* CAST([D] AS INT)  
					) AS DECIMAL(11,2)) 
					,0) AS YUZDE
			INTO #TT1
			FROM ( SELECT * FROM #KONU )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
				
			SELECT 
				TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE 
			INTO #TT
			FROM #TT1
					UNION ALL 
			SELECT 
				TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE) 
				FROM #TT1
			GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV
			order by ID_SINAV,DERSAD,TOPLAMSORU,KOD



			SELECT	TCKIMLIKNO,KONUAD,
				DERSAD,
				KOD,
				CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
				SUM(DOGRU+YANLIS+BOS) SORU,
				SUM(DOGRU) DOGRU,
				SUM(YANLIS) YANLIS,
				SUM(BOS) BOS,
				CAST((cast(SUM(DOGRU) as decimal(11,2))/cast(SUM(DOGRU+YANLIS+BOS) as decimal(11,2))) * 100 as DECIMAL(11,2)) YUZDE
				--CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE
			INTO	#KONUANALIZ
			FROM	#TT
			GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD


			SELECT	*
					,SUM(SORU) TOPLAMSORU 
					,SUM(DOGRU) TOPLAMDOGRU
					,SUM(YANLIS) TOPLAMYANLIS
					,SUM(BOS) TOPLAMBOS
					,CAST((cast(SUM(DOGRU) as decimal(11,2))/cast(SUM(DOGRU+YANLIS+BOS) as decimal(11,2))) * 100 as DECIMAL(11,2)) TOPLAMYUZDE
					--,CAST(AVG(YUZDE)AS decimal(5,2)) TOPLAMYUZDE
					,CAST(CAST(SUM(DOGRU) AS FLOAT) *100.0 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) DOGRUYUZDE
					,CAST(CAST(SUM(YANLIS) AS FLOAT) *100.0 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) YANLISYUZDE
					,CAST(CAST(SUM(BOS) AS FLOAT) *100.0 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) BOSYUZDE
			INTO	#T1
			FROM	#KONUANALIZ
			GROUP BY TCKIMLIKNO,KONUAD,DERSAD,KOD,BOLUMYUZDE,SORU,DOGRU,YANLIS,BOS,YUZDE
			
			
			 
			SELECT * FROM #T1
			where (YUZDE<(@LIMIT+1) and KOD<>'') or KOD=''
			ORDER BY TCKIMLIKNO,DERSAD,KOD

			SELECT DISTINCT K.AD +' '+ SOYAD AS ADSOYAD, S.AD AS SINIF, SB.AD AS OKUL, K.TCKIMLIKNO 
			FROM OkyanusDB.dbo.v3Kullanici K 
			INNER JOIN #T1 T ON T.TCKIMLIKNO=K.TCKIMLIKNO AND ((YUZDE<(@LIMIT+1) and KOD<>'') or KOD='')
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=T.TCKIMLIKNO 
			INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF=O.ID_SINIF 
			INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE=O.ID_SUBE 
			
			IF OBJECT_ID('tempdb..#PUAN')		IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#KONU')		IS NOT NULL		DROP TABLE #KONU
			IF OBJECT_ID('tempdb..#KONUANALIZ')	IS NOT NULL		DROP TABLE #KONUANALIZ
			IF OBJECT_ID('tempdb..#TT')			IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#KK')			IS NOT NULL		DROP TABLE #KK
			IF OBJECT_ID('tempdb..#T1')			IS NOT NULL		DROP TABLE #T1
			IF OBJECT_ID('tempdb..#T2')			IS NOT NULL		DROP TABLE #T2
			IF OBJECT_ID('tempdb..#T3')			IS NOT NULL		DROP TABLE #T3
			IF OBJECT_ID('tempdb..#T4')			IS NOT NULL		DROP TABLE #T4
			IF OBJECT_ID('tempdb..#T5')			IS NOT NULL		DROP TABLE #T5
		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Kullanici]    Script Date: 23.11.2021 14:39:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Kullanici]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(150)	= NULL,
	@ID_MENU			INT				= NULL,
	--@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@ID_KULLANICITIPI	INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kullanıcıya Tipi Listele
		BEGIN
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
			BEGIN
				SELECT	DISTINCT SY.ID_KULLANICITIPI
				FROM	[dbo].[v3SubeYetki]	SY	
				WHERE	SY.ID_KULLANICITIPI=4
			END
			ELSE
			BEGIN
				SELECT	DISTINCT SY.ID_KULLANICITIPI
				FROM	[dbo].[v3Kullanici]	K
				JOIN	[dbo].[v3SubeYetki]	SY	ON	K.TCKIMLIKNO=SY.TCKIMLIKNO
				WHERE	K.TCKIMLIKNO=@TCKIMLIKNO AND K.AKTIF=1
			END
		END
			
	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO
	 
	 GO

	 USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_KullaniciMenuYetkiKaldir]    Script Date: 23.11.2021 14:59:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_KullaniciMenuYetkiKaldir]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_KULLANICI			VARCHAR(11)		= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
/*

	Olulturan Adı		: Kadir Cengiz
	Oluşturulma Tarih	: 30.04.2021
	
	--	sp Create

*/	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_KULLANICI			= @TC_KULLANICI
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)

	DECLARE @ID_LOG INT = 0

	BEGIN TRY
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP=@IP
		

		IF @ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	Kullanıcı Menu Yetki Listesi	
			BEGIN
				
				SELECT (
					SELECT DISTINCT
						 K.TCKIMLIKNO
						,K.AD
						,K.SOYAD
						,K.AKTIF
						,KULLANICITIPILIST	= ( SELECT DISTINCT KT.AD AS KULLANICITIPI
												FROM OkyanusDB..v3SubeYetki	KY
												JOIN OkyanusDB..v3KullaniciTipi		KT	ON	KT.ID_KULLANICITIPI	= KY.ID_KULLANICITIPI
												WHERE KY.TCKIMLIKNO	= MKY.TCKIMLIKNO
												FOR JSON PATH
												)
						,MENULIST			= ( SELECT DISTINCT M.AD AS MENU
												FROM MenuKullaniciYetki	SMY
												JOIN Menu				M	ON	M.ID_MENU = SMY.ID_MENU
												WHERE SMY.TCKIMLIKNO = MKY.TCKIMLIKNO
												FOR JSON PATH
												)
					FROM MenuKullaniciYetki	MKY
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= MKY.TCKIMLIKNO
					WHERE K.AKTIF = 1
					FOR JSON PATH
				)

			END
			IF @ISLEM = 2	--	Kullanıcı Menu Yetki Kaldır		
			BEGIN
				
				DELETE FROM MenuKullaniciYetki
				WHERE TCKIMLIKNO = @TC_KULLANICI

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_KullaniciYetki]    Script Date: 23.11.2021 15:00:14 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_KullaniciYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(150)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@ID_KULLANICITIPI	INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENUS					= @ID_MENUS			
			,ID_MENU					= @ID_MENU			
			,ID_KADEME					= @ID_KADEME			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SUBE					= @ID_SUBE			
			,TC_YETKI					= @TC_YETKI			
			,ID_KULLANICITIPI			= @ID_KULLANICITIPI	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kullanıcıya Yetkilerini Listele
		BEGIN
			SELECT DISTINCT KD.ID_KADEME, KD.AD
			FROM OkyanusDB.[dbo].v3KullaniciKademe	S
			INNER JOIN OkyanusDB.[dbo].v3Kademe		KD	ON KD.ID_KADEME	= S.ID_KADEME
			WHERE S.TCKIMLIKNO = @TCKIMLIKNO
			ORDER BY ID_KADEME ASC
		END
			
		
		IF @ISLEM = 3	-- Kullanıcı Tipine Göre Kullanıcı Listele
		BEGIN
			--SELECT K.TCKIMLIKNO,K.AD + ' ' + K.SOYAD ADSOYAD
			--FROM [dbo].[v3SubeYetki]	S
			--JOIN [dbo].[v3Kullanici]	K	ON K.TCKIMLIKNO=S.TCKIMLIKNO
			--WHERE ID_KULLANICITIPI=@ID_KULLANICITIPI  AND LEN(AD)>0
			--order by ADSOYAD
			SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
			FROM	   [dbo].[v3Sube]				SB
			INNER JOIN [dbo].[v3SubeKademe]			SK	ON SK.ID_SUBE		= SB.ID_SUBE
			INNER JOIN [dbo].[v3KullaniciKademe3]	K3	ON K3.ID_KADEME		= SK.ID_KADEME
			INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.ID_SUBE = SB.ID_SUBE AND SY.TCKIMLIKNO = K3.TCKIMLIKNO
			INNER JOIN [dbo].[v3Kullanici]			KL	ON KL.TCKIMLIKNO	= K3.TCKIMLIKNO	AND KL.AKTIF = 1
			WHERE	SY.ID_SUBE			= @ID_SUBE 
				AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI
				AND (K3.ID_KADEME3		= @ID_KADEME3	OR @ID_KADEME3 IS NULL OR @ID_KADEME3 = ''OR @ID_KADEME3 = 0)
		END
		
		IF @ISLEM = 4	--	Kullanıcı Menü Yetki Kaydet
		BEGIN			

			DELETE MenuKullaniciYetki where TCKIMLIKNO=@TC_YETKI

			INSERT INTO MenuKullaniciYetki(TCKIMLIKNO,ID_MENU) 
			select @TC_YETKI, ID_MENU from OPENJSON(@SQLJSON)
			WITH (   
						  ID_MENU int,
						  YETKILI bit
			 )
			WHERE YETKILI=1


			SELECT KOD,LEN(KOD) / 3 AS SAYI 
			INTO #K 
			FROM Menu M 
			WHERE M.ID_MENU IN (SELECT ID_MENU FROM MenuKullaniciYetki MY WHERE MY.TCKIMLIKNO=@TC_YETKI)
			

			DECLARE @TABLE TABLE (ID_MENU INT)
			DECLARE @I INT=0

			WHILE @I<(SELECT MAX(SAYI) FROM #K)
			BEGIN
				INSERT INTO @TABLE(ID_MENU)
				SELECT M.ID_MENU FROM MENU M WHERE M.KOD IN (SELECT SUBSTRING(KOD,1,(@I*3)) FROM #K)
				
				SET @I+=1
			END

			INSERT INTO MenuKullaniciYetki(TCKIMLIKNO,ID_MENU) 			
			(SELECT @TC_YETKI,ID_MENU FROM @TABLE T WHERE T.ID_MENU NOT IN (SELECT ID_MENU FROM MenuKullaniciYetki MY WHERE MY.TCKIMLIKNO=@TC_YETKI))
			
			DROP TABLE #K


		END

		IF @ISLEM = 5	--	Kullanıcı Şube Sınıf Getir
		BEGIN
			SELECT
			(
				SELECT K.AD, K.SOYAD, S.AD AS SUBE, S.ID_SUBE, SNF.AD AS SINIF, SNF.ID_SINIF FROM OkyanusDB.dbo.v3Kullanici K 
				INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO=K.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube S ON S.ID_SUBE=SY.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=K.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Satislar SAT ON SAT.ID_SOZLESME=O.ID_SOZLESME
				INNER JOIN OkyanusDB.dbo.v3Donem D ON D.ID_DONEM=SAT.ID_DONEM
				INNER JOIN OkyanusDB.dbo.v3Sinif SNF ON SNF.ID_SINIF=SAT.ID_SINIF
				WHERE K.TCKIMLIKNO=@TCKIMLIKNO AND D.KOD=(SELECT KOD FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)
				FOR JSON PATH
			) AS J
		END
	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_LUSRapor]    Script Date: 23.11.2021 15:00:46 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_LUSRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@SUBELER			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_KADEME3					= @ID_KADEME3	
			,SINIFLAR					= @SINIFLAR	
			,SUBELER					= @SUBELER	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		IF (@ISLEM = 1)	--	LUS RAPORU
		BEGIN
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) 
			BEGIN
				SET @OZELSINAVGOR=1
			END

			DECLARE @OV BIT = 0

			IF NOT EXISTS(SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
			BEGIN
				SET @OV = 1
			END

			SELECT O.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, O.OGRNO, SGS.SUBEAD, SGS.SINIF
			INTO #OGRENCI
			FROM OkyanusDB.dbo.v3OgrenciTum O
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
			WHERE O.DONEM = @DONEM
			AND (@SUBELER IS NULL OR @SUBELER='[]' OR @SUBELER='' OR O.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)))
			AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR @SUBELER='' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR O.TCKIMLIKNO = @TC_OGRENCI)

			--OPTIK--
			BEGIN
				SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
				INTO #OPTTUM
				FROM #OGRENCI O
				INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
				WHERE S.AKTIF = 1			
				AND S.DONEM = @DONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.OLCEKSINAVI = 1
				AND S.ID_SINAVTURU = 13 -- LUS

				SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, MAX(OPT.PUAN) AS PUAN
				INTO #OPTSON
				FROM #OGRENCI O
				INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, OPT.PUAN
		
				DELETE TUM
				FROM #OPTTUM TUM
				INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH


				SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, MAX(OPT.PUAN) AS PUAN
				INTO #OPTSON1
				FROM #OGRENCI O
				INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, OPT.PUAN

				DELETE TUM
				FROM #OPTTUM TUM
				INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
				--INTO #OPTSON2
				--FROM #OGRENCI O
				--INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY O.TCKIMLIKNO, OPT.PUAN

				--DELETE TUM
				--FROM #OPTTUM TUM
				--INNER JOIN #OPTSON2 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT * FROM #OPTSON
				--SELECT * FROM #OPTSON1
				--SELECT * FROM #OPTSON2
			END

			--ÖĞRETMEN GÖZLEM FORMU--
			BEGIN
				SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
				INTO #YAZTUM
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF = 1
				AND Y.AKTIF = 1				
				AND Y.DONEM = @DONEM
				AND Y.ID_YAZILITURU = 3 -- LUS
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, MAX(YAZ.PUAN) AS PUAN
				INTO #YAZSON
				FROM #OGRENCI O
				INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ.PUAN

				DELETE TUM
				FROM #YAZTUM TUM
				INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, MAX(YAZ.PUAN) AS PUAN
				INTO #YAZSON1
				FROM #OGRENCI O
				INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ.PUAN

				DELETE TUM
				FROM #YAZTUM TUM
				INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
				--INTO #YAZSON2
				--FROM #OGRENCI O
				--INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY O.TCKIMLIKNO, YAZ.PUAN

				--DELETE TUM
				--FROM #YAZTUM TUM
				--INNER JOIN #YAZSON2 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT * FROM #YAZSON
				--SELECT * FROM #YAZSON1
				--SELECT * FROM #YAZSON2
			END

			--ÖĞRENCİ DENEY RAPOR--
			BEGIN
				SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
				INTO #YAZ2TUM
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF = 1
				AND Y.AKTIF = 1				
				AND Y.DONEM = @DONEM
				AND Y.ID_YAZILITURU = 4 -- LUS
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, MAX(YAZ2.PUAN) AS PUAN
				INTO #YAZ2SON
				FROM #OGRENCI O
				INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ2.PUAN

				DELETE TUM
				FROM #YAZ2TUM TUM
				INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, MAX(YAZ2.PUAN) AS PUAN
				INTO #YAZ2SON1
				FROM #OGRENCI O
				INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ2.PUAN

				DELETE TUM
				FROM #YAZ2TUM TUM
				INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
				--INTO #YAZ2SON2
				--FROM #OGRENCI O
				--INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

				--DELETE TUM
				--FROM #YAZ2TUM TUM
				--INNER JOIN #YAZ2SON2 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT * FROM #YAZ2SON
				--SELECT * FROM #YAZ2SON1
				--SELECT * FROM #YAZ2SON2
			END

			SELECT O.*
					,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
					,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
					--,ISNULL(CAST(CONVERT(INT, OPTSON2.PUAN) AS VARCHAR), '-') AS OPT2
					,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
					,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
					--,ISNULL(CAST(YAZSON2.PUAN AS VARCHAR), '-') AS YAZOGRETMEN2
					,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
					,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
					--,ISNULL(CAST(YAZ2SON2.PUAN AS VARCHAR), '-') AS YAZOGRENCI2
					,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
			INTO #RESULT
			FROM #OGRENCI O
			LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
			--LEFT JOIN #OPTSON2 OPTSON2 ON OPTSON2.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
			--LEFT JOIN #YAZSON2 YAZSON2 ON YAZSON2.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO
			--LEFT JOIN #YAZ2SON2 YAZ2SON2 ON YAZ2SON2.TCKIMLIKNO = O.TCKIMLIKNO

			SELECT	DISTINCT
					TCKIMLIKNO,
					ADSOYAD,
					OGRNO,
					SUBEAD,
					SINIF,
					OPT, 
					CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
					CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
					YAZOGRETMEN, 
					CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
					CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
					YAZOGRENCI, 
					CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
					CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
					TOPLAM
			FROM #RESULT
			
			DROP TABLE #YAZSON
			DROP TABLE #YAZSON1
			--DROP TABLE #YAZSON2
			DROP TABLE #YAZ2SON
			DROP TABLE #YAZ2SON1
			--DROP TABLE #YAZ2SON2
			DROP TABLE #OPTSON
			DROP TABLE #OPTSON1
			--DROP TABLE #OPTSON2
			DROP TABLE #YAZTUM
			DROP TABLE #YAZ2TUM
			DROP TABLE #OPTTUM
			DROP TABLE #OGRENCI
			DROP TABLE #RESULT
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_MaddeFrekansAnalizi]    Script Date: 23.11.2021 15:01:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_MaddeFrekansAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SINIFALANLIST		VARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ICDISOGRENCI		INT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_DERSs					= @ID_DERSs		
			,SINIFALANLIST				= @SINIFALANLIST	
			,ID_KADEME3					= @ID_KADEME3		
			,SQLJSON					= @SQLJSON		
			,DONEM						= @DONEM			
			,ID_SINIFs					= @ID_SINIFs		
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ICDISOGRENCI				= @ICDISOGRENCI	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )


		IF (@ISLEM = 1 OR @ISLEM = 2)  -- 
		BEGIN
					
			IF @ICDISOGRENCI IS NULL 
				SET @ICDISOGRENCI = 0
			
			DROP TABLE IF EXISTS #ALTCEVAPLAR
			DROP TABLE IF EXISTS #ALTGRUP
			DROP TABLE IF EXISTS #DERECE
			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #USTCEVAPLAR
			DROP TABLE IF EXISTS #USTGRUP
			DROP TABLE IF EXISTS #SINAVBILGI
			DROP TABLE IF EXISTS #CEVAPLAR
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #SINIFALAN
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #SUBE
			DROP TABLE IF EXISTS #SINAV
			
			DROP TABLE IF EXISTS #ID_DERS
			SELECT VALUE ID_DERS INTO #ID_DERS FROM OPENJSON(@ID_DERSs)

			SELECT DERSAD INTO #DERS 
			from eokul_v2.dbo.Ders DA
			WHERE	(EXISTS(SELECT 1 FROM #ID_DERS D WHERE D.ID_DERS = DA.ID_DERS))
				OR (NOT EXISTS (SELECT 1 FROM #ID_DERS)  AND @ID_DERSs ='[]' AND DA.ID_KADEME3	=  @ID_KADEME3)
			DROP TABLE IF EXISTS #ID_DERS
			
			SELECT VALUE ALAN		INTO #SINIFALAN	FROM OPENJSON(@SINIFALANLIST)
			SELECT VALUE ID_SUBE	INTO #SUBE		FROM OPENJSON(@ID_SUBEs )
			SELECT VALUE ID_SINAV	INTO #SINAV		FROM OPENJSON(@ID_SINAVs)

			
			SELECT T.* 
			INTO #SINIFLIST
			FROM v3SinifTum	T
			JOIN v3Donem	D	ON	D.ID_DONEM	= T.ID_DONEM
			JOIN #SUBE		S	ON	S.ID_SUBE	= D.ID_SUBE
			WHERE	T.DONEM			= @OGRENCIDONEM
				AND @ICDISOGRENCI	IN (0,1)
				AND (	(SELECT COUNT(1) FROM #SINIFALAN) = 0
					OR	EXISTS (SELECT 1 FROM #SINIFALAN A WHERE T.AD LIKE '%'+ A.ALAN +'%')
					)

			SELECT	 S.ID_SINAV
					,S.AD SINAVAD
					,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH
					,SO.TCKIMLIKNO
					,VD.DERSAD DERSAD
					,SB.NET
					,DOGRU
					,OC.DURUM
					,OC.CEVAP OGRENCICEVAP
					,SA.CEVAP DOGRUCEVAP 
					,SA.SORUNO_A
					,SD.BOLUMNO 
					,ISNULL(SA.KOD,'') KOD 
					,S.OLCEKSINAVI 
					,SA.KATSAYI
			INTO	#TEMP_OGRENCI
			FROM	Pusulam.dbo.Sinav					S	WITH (NOLOCK)
			JOIN	#SINAV								TS					ON	TS.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
			JOIN	#SINIFLIST							SL	WITH (NOLOCK)	ON	SL.ID_SINIF						= O.ID_SINIF	
			JOIN	Pusulam.dbo.SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI 
			JOIN	Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders					VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			JOIN	#DERS								VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			JOIN	Pusulam.dbo.SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM 
			JOIN	Pusulam.dbo.SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD							= SO.KITAPCIK 
																			AND SD.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																			AND SA.SORUNO						= OC.SORUNO
																			AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
			WHERE	S.AKTIF			=  1
				AND S.DURUM			=  2
				AND (OZEL = 0		OR @OZELSINAVGOR = 1)
				AND @ICDISOGRENCI	= 1

		UNION 

			SELECT	 S.ID_SINAV
					,S.AD SINAVAD
					,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH
					,SO.TCKIMLIKNO
					,VD.DERSAD DERSAD
					,SB.NET
					,DOGRU
					,OC.DURUM
					,OC.CEVAP OGRENCICEVAP
					,SA.CEVAP DOGRUCEVAP 
					,SA.SORUNO_A
					,SD.BOLUMNO 
					,ISNULL(SA.KOD,'') KOD 
					,S.OLCEKSINAVI 
					,SA.KATSAYI
			FROM	Pusulam.dbo.Sinav					S	WITH (NOLOCK)
			JOIN	#SINAV								TS					ON	TS.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.v3Sube					SUB	WITH (NOLOCK)	ON	CAST(SUB.SUBENO AS INT)			= CAST(SO.SUBENO AS INT)
			JOIN	#SUBE								TB					ON	TB.ID_SUBE						= SUB.ID_SUBE
			JOIN	Pusulam.dbo.SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI 
			JOIN	Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders					VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			JOIN	#DERS								VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			JOIN	Pusulam.dbo.SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM 
			JOIN	Pusulam.dbo.SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD							= SO.KITAPCIK 
																			AND SD.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																			AND SA.SORUNO						= OC.SORUNO
																			AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
			WHERE	S.AKTIF			=  1
				AND S.DURUM			=  2
				AND (OZEL = 0		OR @OZELSINAVGOR = 1)
				AND (@ICDISOGRENCI	= 0
					OR (	@ICDISOGRENCI	= 2  
						AND SUBSTRING(SO.SINIF,1,4) = 'OKY-'
						)
					)

			DROP TABLE IF EXISTS #TEMP
			SELECT  DURUM, COUNT(DURUM) DURUMSAYISI,0 KISISAYISI, DERSAD, BOLUMNO, SORUNO_A, 0 CEVAPLAYANSAYISI
			INTO #TEMP
			FROM #TEMP_OGRENCI T
			GROUP BY BOLUMNO, SORUNO_A,DURUM, DERSAD

			UPDATE T
			SET  KISISAYISI			=		 (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO)				
				,CEVAPLAYANSAYISI	= ISNULL((SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO AND DURUM != 'B'),0)
			FROM #TEMP T

			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			SELECT DISTINCT TCKIMLIKNO,BOLUMNO,DOGRU NET, RN = 0 ,MAX_RN = 0
			INTO #OGRENCIBOLUMNET
			FROM #TEMP_OGRENCI 

			UPDATE O 
			SET O.RN=G.RN2
			FROM #OGRENCIBOLUMNET O 
			JOIN (	SELECT D.BOLUMNO, D.TCKIMLIKNO, RN2 = ROW_NUMBER() OVER(PARTITION BY D.BOLUMNO ORDER BY D.NET DESC,D.TCKIMLIKNO)  
					FROM #OGRENCIBOLUMNET D
				) AS G	ON	G.TCKIMLIKNO	= O.TCKIMLIKNO 
						AND G.BOLUMNO		= O.BOLUMNO
				
			UPDATE O 
			SET O.MAX_RN = D.MAX_RN
			FROM #OGRENCIBOLUMNET O 
			JOIN (
				SELECT MAX(RN) MAX_RN , BOLUMNO
				FROM #OGRENCIBOLUMNET S 
				GROUP BY S.BOLUMNO 
			) AS D ON D.BOLUMNO = O.BOLUMNO
				
				DROP TABLE IF EXISTS #OGRSAY
				SELECT BOLUMNO, OGRSAY = IIF( O.MAX_RN > 100, cast(O.MAX_RN * 27 / 100.0 as int) ,CAST(CAST(O.MAX_RN AS DECIMAL(8,2)) / 2 AS DECIMAL(8,2)))
				INTO #OGRSAY
				FROM #OGRENCIBOLUMNET O
				GROUP BY BOLUMNO, MAX_RN

				--DECLARE @OGRSAY INT = (SELECT TOP 1 cast(O.MAX_RN * 27 / 100.0 as int)  FROM #OGRENCIBOLUMNET O)

				DROP TABLE IF EXISTS #ALTGRUP
				SELECT O.* 
				INTO #ALTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN >= O.MAX_RN - S.OGRSAY + 1
					--	(	O.MAX_RN > 100	AND RN >= O.MAX_RN - S.OGRSAY + 1 )
					--OR	(	O.MAX_RN <= 100 AND RN > CAST(O.MAX_RN / 2 AS INT) )
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
								
				DROP TABLE IF EXISTS #USTGRUP
				SELECT O.* 
				INTO #USTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN <= S.OGRSAY
					--(	O.MAX_RN > 100  AND RN <= S.OGRSAY )
					--OR (	O.MAX_RN <= 100 AND RN <= CAST(O.MAX_RN / 2 AS INT))
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
			
				--SELECT * FROM #OGRSAY where bolumno = 1
				--SELECT * FROM #USTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #ALTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #TEMP_OGRENCI where bolumno = 1 and SORUNO_A = 1

			DROP TABLE IF EXISTS #DERECE
			SELECT 
				 O.BOLUMNO
				,O.SORUNO_A
				,O.DURUM
				,O.DERSAD
				,O.DOGRUCEVAP
				,O.KOD
				,TOPLAMYANIT		= T.KISISAYISI
				,DOGRUSAYISI		= ISNULL(T.DURUMSAYISI,0)
				,YANLISSAYISI		= 0
				,BOSSAYISI			= 0
				,USTKISISAYISI		= COUNT(DISTINCT U.TCKIMLIKNO)
				,ALTKISISAYISI		= COUNT(DISTINCT A.TCKIMLIKNO)
				,ZORLUKDERECESI		= CONVERT(DECIMAL(8,2),	CASE	WHEN	O.OLCEKSINAVI = 0 THEN	CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float) /NULLIF(CAST((S.OGRSAY * 2) AS float),0.0)
																	ELSE	CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float) /  (NULLIF(CAST((S.OGRSAY * 2) AS float),0.0) * O.KATSAYI)
																	END
															)
				,AYIRICILIK			= CONVERT(DECIMAL(8,2),	CASE	WHEN	O.OLCEKSINAVI = 0 THEN	CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  NULLIF(CAST(S.OGRSAY AS float),0.0)
																	ELSE	CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  (NULLIF(CAST(S.OGRSAY AS float),0.0) * O.KATSAYI)
																	END
															)
				--CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  NULLIF(CAST(S.OGRSAY AS float),0.0) ) 
				,SAPMA				= CONVERT(DECIMAL(8,2),0)
				,VARYANS			= CONVERT(DECIMAL(8,2),0)
				,MADDEGUVENILIRLIK	= CONVERT(DECIMAL(8,2),0)
				,KR20				= CONVERT(DECIMAL(8,2),0)
			INTO #DERECE
			FROM #TEMP			T
			JOIN #TEMP_OGRENCI	O	ON	O.BOLUMNO		= T.BOLUMNO
									AND O.SORUNO_A		= T.SORUNO_A
									AND O.DURUM			= T.DURUM
			JOIN #OGRSAY		S	ON	S.BOLUMNO		= O.BOLUMNO
			LEFT JOIN #USTGRUP	U	ON	U.TCKIMLIKNO	= O.TCKIMLIKNO 
									AND U.BOLUMNO		= O.BOLUMNO
			LEFT JOIN #ALTGRUP	A	ON	A.TCKIMLIKNO	= O.TCKIMLIKNO
									AND A.BOLUMNO		= O.BOLUMNO
			WHERE O.DURUM = 'D' AND O.KOD != ''
			GROUP BY O.BOLUMNO, O.SORUNO_A,O.DURUM,O.DERSAD,T.KISISAYISI,O.DOGRUCEVAP,T.DURUMSAYISI,O.KOD,T.CEVAPLAYANSAYISI,S.OGRSAY,O.OLCEKSINAVI, O.KATSAYI
			
			UPDATE #DERECE	SET
				BOSSAYISI	= B.DURUMSAYISI
			FROM #DERECE	T
			JOIN #TEMP		B	ON	B.BOLUMNO		= T.BOLUMNO
								AND B.SORUNO_A		= T.SORUNO_A
								AND B.DURUM			= 'B'
								
			UPDATE #DERECE	SET
				YANLISSAYISI	= Y.DURUMSAYISI
			FROM #DERECE	T
			JOIN #TEMP		Y	ON	Y.BOLUMNO		= T.BOLUMNO
								AND Y.SORUNO_A		= T.SORUNO_A
								AND Y.DURUM			= 'Y'

			DECLARE @VARYANS FLOAT,@V1  FLOAT,@P FLOAT,@KR20 DECIMAL(8,4)

			SET @V1			= (SELECT CONVERT(DECIMAL(8,2),SUM(DOGRUSAYISI))/MAX(TOPLAMYANIT) FROM #DERECE)				
			SET @VARYANS	= (SELECT SQUARE(SUM(CONVERT(DECIMAL(8,2),DOGRUSAYISI)-@V1)) / MAX(TOPLAMYANIT) FROM #DERECE)
			SET @P			= (SELECT SUM(  (CAST(DOGRUSAYISI AS DECIMAL(8,2))/TOPLAMYANIT)*ABS(1-CAST(DOGRUSAYISI AS DECIMAL(8,2))/TOPLAMYANIT)  ) FROM #DERECE)
			SET @KR20		= (SELECT CONVERT(DECIMAL(8,4), (COUNT(1)/(COUNT(1)-1))*(1-(@P/NULLIF(@VARYANS, 0.0)))) FROM #DERECE)

			--DECLARE @TOPLAMSORUSAYISI INT 
			--SET @TOPLAMSORUSAYISI = 
			--(SELECT SUM(SORUSAYISI) FROM (SELECT COUNT(DISTINCT SORUNO_A) SORUSAYISI				
			--FROM #TEMP
			--GROUP BY BOLUMNO, DERSAD) AS SS)

			DROP TABLE IF EXISTS #OGRBOLUMDOGRU
			SELECT BOLUMNO, MAX(DOGRU) DOGRU, TCKIMLIKNO
			INTO #OGRBOLUMDOGRU
			FROM #TEMP_OGRENCI 
			GROUP BY BOLUMNO,TCKIMLIKNO

			SELECT DISTINCT 
				 SINAVAD
				,SINAVTARIH
				,SINAVKATILIM		= COUNT(DISTINCT TCKIMLIKNO) 
				,TOPLAMSORUSAYISI	= (SELECT COUNT(1) FROM(SELECT G.BOLUMNO, G.SORUNO_A FROM #TEMP G GROUP BY G.BOLUMNO, G.SORUNO_A) AS TS) 
				,ORTALAMADOGRU		= (SELECT CAST(CAST( SUM(DOGRU)  AS FLOAT) / COUNT(DISTINCT TCKIMLIKNO) AS DECIMAL(8,2)) FROM #OGRBOLUMDOGRU )  --(SELECT CONVERT(DECIMAL(8,2),AVG(CONVERT(DECIMAL(8,2),DOGRUSAYISI))) FROM #DERECE)
				,KR20				= ISNULL(@KR20, 0)
			INTO #SINAVBILGI
			FROM #TEMP_OGRENCI 
			GROUP BY SINAVAD,SINAVTARIH
			
			DROP TABLE IF EXISTS #OGRBOLUMDOGRU

			--DECLARE @StandartSapma INT
			--SELECT @StandartSapma=STDEV(NET) FROM #TEMP_OGRENCI

			UPDATE D
			SET	 VARYANS			= ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI))
				,SAPMA				= SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)))
				,MADDEGUVENILIRLIK	= Convert(Decimal(8,2),isnull(D.AYIRICILIK*SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI))),0.00))
										--((	-- (Select AVG(Convert(Decimal(8,2),DOGRUSAYISI))-AVG(Convert(Decimal(8,2),YANLISSAYISI)) from #DERECE G WHERE G.BOLUMNO = D.BOLUMNO)
										--	--*(SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)))))
										--	D.AYIRICILIK
										--)
										--	*NULLIF(@StandartSapma,0)))
										--,0)
					
			FROM #DERECE D
				
			SELECT	 BOLUMNO,SORUNO_A
					,A	= ISNULL(P.A,0)
					,B	= ISNULL(P.B,0)
					,C	= ISNULL(P.C,0)
					,D	= ISNULL(P.D,0)
					,E	= ISNULL(P.E,0)
					,BOS= ISNULL(P.BOS,0)
					,TOPLAM= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
			INTO #CEVAPLAR
			FROM (
				SELECT CASE WHEN OGRENCICEVAP = '' THEN 'BOS' ELSE OGRENCICEVAP END OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A FROM #TEMP_OGRENCI
				GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
			) AS G
			PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
			ORDER BY BOLUMNO,SORUNO_A

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 
						(	
							
								SELECT  DISTINCT
										 BOLUMNO		 AS 'BOLUMNO'
										,DERSAD			 AS 'DERSAD'
										,COUNT(DISTINCT SORUNO_A) SORUSAYISI
										,(
													SELECT  
														 G.SORUNO_A				AS 'SORUNO_A'
														,G.DOGRUCEVAP			AS 'DOGRUCEVAP'
														,G.KOD					AS 'KOD'
														,G.TOPLAMYANIT			AS 'TOPLAMYANIT'
														,G.DOGRUSAYISI			AS 'DOGRUSAYISI'
														,G.YANLISSAYISI			AS 'YANLISSAYISI'
														,G.BOSSAYISI			AS 'BOSSAYISI'
														,G.USTKISISAYISI		AS 'USTKISISAYISI'
														,G.ALTKISISAYISI		AS 'ALTKISISAYISI'
														,G.ZORLUKDERECESI		AS 'ZORLUKDERECESI'
														,G.AYIRICILIK			AS 'AYIRICILIK'			
														,G.SAPMA				AS 'SAPMA'	
														,G.VARYANS				AS 'VARYANS'	
														,G.MADDEGUVENILIRLIK	AS 'MADDEGUVENILIRLIK'	
														,
															case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
																	when ZORLUKDERECESI < 0.35 then 'Zor'
																	when ZORLUKDERECESI < 0.65 then 'Önerilen'
																	when ZORLUKDERECESI < 0.80 then 'Kolay'
																	when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
															end as 'ZORLUKACIKLAMA',
															case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     														when AYIRICILIK < 0.30 then 'Sınırda'
		   															when AYIRICILIK < 0.40 then 'İyi'
		     														when AYIRICILIK > 0.39 then 'Çok İyi' 
															end as 'AYIRICILIKACIKLAMA'
														,isnull((case	WHEN ((ZORLUKDERECESI< 0.60	)						AND (AYIRICILIK < 0.20 ))		THEN 'Zor ve ayırt edici olmayan madde'
																		WHEN ((ZORLUKDERECESI< 0.60	)						AND (AYIRICILIK >=0.20 ))		THEN 'Zor fakat ayırt edici bir madde'
																		WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK < 0.20 ))	THEN 'Üzerinde çalışılması gereken madde'
																		WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK >=0.20 ))	THEN 'Tipik iyi madde'
																		WHEN ((ZORLUKDERECESI> 0.90))														THEN 'Eğer etkili bir öğretim varsa tercih edilir.'
																END),-1)  AS 'KALITE' --AS KALITE
														,C.A AS 'CEVAPLIST.A'
														,C.B AS 'CEVAPLIST.B'
														,C.C AS 'CEVAPLIST.C'
														,C.D AS 'CEVAPLIST.D'
														,C.E AS 'CEVAPLIST.E'
													FROM #DERECE	G
													JOIN #CEVAPLAR	C	ON	C.BOLUMNO	= G.BOLUMNO
																		AND C.SORUNO_A	= G.SORUNO_A
													WHERE G.BOLUMNO = D.BOLUMNO
													ORDER BY SORUNO_A
													FOR JSON PATH							
										) AS 'SORULIST'					
								FROM #DERECE D
								GROUP BY BOLUMNO,DERSAD
								FOR JSON PATH, INCLUDE_NULL_VALUES
						) as TblVeri,					
						(									
							SELECT 
								 SINAVAD
								,SINAVTARIH
								,SINAVKATILIM		
								,TOPLAMSORUSAYISI	
								,ORTALAMADOGRU		
								,KR20			
							FROM #SINAVBILGI
							FOR JSON AUTO, INCLUDE_NULL_VALUES
						) as TblSinavOzellik	,		
						(		
							SELECT BOLUMNO, DERSAD, COUNT(DISTINCT SORUNO_A) SORUSAYISI
							FROM #TEMP
							GROUP BY BOLUMNO, DERSAD
							ORDER BY BOLUMNO,DERSAD
							FOR JSON AUTO, INCLUDE_NULL_VALUES
						) as TblDersList						
						
					) as tablo 
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) as tt				

			END
			ELSE
			BEGIN
				SELECT D.*,
								case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
										when ZORLUKDERECESI < 0.35 then 'Zor'
										when ZORLUKDERECESI < 0.65 then 'Önerilen'
										when ZORLUKDERECESI < 0.80 then 'Kolay'
										when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
								end as [ZORLUKACIKLAMA],
								case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     							when AYIRICILIK < 0.30 then 'Sınırda'
		   								when AYIRICILIK < 0.40 then 'İyi'
		     							when AYIRICILIK > 0.39 then 'Çok İyi' 
								end as [AYIRICILIKACIKLAMA],
					isnull((case	WHEN ((ZORLUKDERECESI< 0.60	)							AND (AYIRICILIK < 0.20 ))	THEN 'Zor ve ayırt edici olmayan madde'
									WHEN ((ZORLUKDERECESI< 0.60	)							AND (AYIRICILIK >=0.20 ))	THEN 'Zor fakat ayırt edici bir madde'
									WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK < 0.20 ))	THEN 'Üzerinde çalışılması gereken madde'
									WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK >=0.20 ))	THEN 'Tipik iyi madde'
									WHEN ((ZORLUKDERECESI> 0.90))														THEN 'Eğer etkili bir öğretim varsa tercih edilir.'
							END),-1)  AS 'KALITE' --AS KALITE
					,ASAYISI	= C.A 
					,BSAYISI	= C.B 
					,CSAYISI	= C.C 
					,DSAYISI	= C.D 
					,ESAYISI	= C.E 
					,C.BOLUMNO,C.SORUNO_A
				FROM #DERECE	D
				JOIN #CEVAPLAR	C	ON	C.BOLUMNO	= D.BOLUMNO
									AND C.SORUNO_A	= D.SORUNO_A 
				ORDER BY D.BOLUMNO,D.SORUNO_A
				
				SELECT 
					 SINAVAD
					,SINAVTARIH
					,SINAVKATILIM		
					,TOPLAMSORUSAYISI	
					,ORTALAMADOGRU		
					,KR20				
				FROM #SINAVBILGI
									
				SELECT BOLUMNO, DERSAD, COUNT(DISTINCT SORUNO_A) SORUSAYISI
				FROM #TEMP
				GROUP BY BOLUMNO, DERSAD
				ORDER BY BOLUMNO,DERSAD
				
			END
			


			
			
			
				DROP TABLE IF EXISTS #ALTCEVAPLAR
				DROP TABLE IF EXISTS #ALTGRUP
				DROP TABLE IF EXISTS #DERECE
				DROP TABLE IF EXISTS #OGRENCIBOLUMNET
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMP_OGRENCI
				DROP TABLE IF EXISTS #USTCEVAPLAR
				DROP TABLE IF EXISTS #USTGRUP
				DROP TABLE IF EXISTS #SINAVBILGI
				DROP TABLE IF EXISTS #CEVAPLAR
				DROP TABLE IF EXISTS #DERS
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #SINIFALAN
				DROP TABLE IF EXISTS #SINIFLIST



		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	
GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_MentalUp]    Script Date: 23.11.2021 15:01:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_MentalUp]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	URL
			BEGIN
				SELECT (
					SELECT eokul_v2.dbo.Fn_DinamikUrl('DinamikUrl1', @TC_OGRENCI) AS [URL]
					FOR JSON PATH
				)
			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_MobilBirimYetki]    Script Date: 23.11.2021 15:01:46 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_MobilBirimYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPI	INT				= NULL,
	@IP					VARCHAR(50)	= NULL

		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENUS			= @ID_MENUS		
			,ID_MENU			= @ID_MENU		
			,ID_KADEME			= @ID_KADEME		
			,ID_SUBEs			= @ID_SUBEs		
			,ID_KULLANICITIPI	= @ID_KULLANICITIPI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	 
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kademe Listele
		BEGIN
			SELECT DISTINCT KD.ID_KADEME, KD.AD
			FROM v3KullaniciKademe	S
			INNER JOIN OkyanusDB.[dbo].v3Kademe		KD	ON KD.ID_KADEME	= S.ID_KADEME
			ORDER BY ID_KADEME ASC
		END
				
		IF @ISLEM = 2	--	Kullanici Tipi Listele
		BEGIN			
			SELECT * FROM [dbo].[v3KullaniciTipi]
			WHERE ID_KULLANICITIPI = 4
			ORDER BY AD ASC
		END
				
		IF @ISLEM = 3	--	Birim Yetki Kaydet
		BEGIN			

			DELETE dbo.Mobile_MenuYetki WHERE ID_KADEME=@ID_KADEME and ID_KULLANICITIPI=@ID_KULLANICITIPI			

			INSERT INTO Mobile_MenuYetki(ID_KADEME,ID_KULLANICITIPI,ID_MENU) 
			((SELECT @ID_KADEME,@ID_KULLANICITIPI,Value FROM dbo.fn_Split(@ID_MENUS, ',', null) ) )
			
		END
			
		IF @ISLEM = 4	--	Kullanıcı Kademe Listele
		BEGIN

			SELECT ISNULL((
				SELECT DISTINCT KD.ID_KADEME, KD.AD
				FROM		v3KullaniciKademe			S
				INNER JOIN	v3SubeYetki					SY	ON	SY.TCKIMLIKNO	= S.TCKIMLIKNO
				INNER JOIN	OkyanusDB.[dbo].v3Kademe	KD	ON	KD.ID_KADEME	= S.ID_KADEME
				WHERE	S.TCKIMLIKNO = @TCKIMLIKNO
					AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				ORDER BY ID_KADEME ASC
				FOR JSON AUTO
			),'[]')
		END

		IF @ISLEM = 5 --  Menü Getir YETKİ SAYFASI
		BEGIN
			SELECT 
					M.ID_MENU,
					replicate('-', LEN(KOD)-3)+AD AD,
					YETKILI = (SELECT COUNT(1) FROM Mobile_MenuYetki Y WHERE Y.ID_KULLANICITIPI=@ID_KULLANICITIPI AND Y.ID_MENU=M.ID_MENU AND Y.ID_KADEME = @ID_KADEME)
			FROM dbo.Mobile_Menu		M
			WHERE GIZLI = 0 AND (OZEL = 0 /*OR dbo.fn_GenelHak(@TCKIMLIKNO)>0*/)
			ORDER BY KOD 
		END
		

	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Odev]    Script Date: 23.11.2021 15:02:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Odev]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,

	@ID_KADEME					INT				= NULL,
	@ID_ODEVTUR					INT				= NULL,
	@DURUM						BIT				= NULL,
	@ID_ODEV					INT				= NULL,
	@ID_SINIF					INT				= NULL,
	@TC_ODEVVEREN				VARCHAR(11)		= NULL,
	@SQLJSON					VARCHAR(MAX)	= NULL,

	@TC_OGRENCI					VARCHAR(11)		= NULL,
	@BASLANGIC_TARIHI			VARCHAR(MAX)	= NULL,
	@BITIS_TARIHI				VARCHAR(MAX)	= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@ID_DERS					INT				= NULL,

	@ID_DERSLIST				VARCHAR(MAX)	= NULL,
	@ID_KADEME3LIST				VARCHAR(MAX)	= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@TC_OGRETMENLIST			VARCHAR(MAX)	= NULL,
	@TUR						INT				= NULL,
	@TC_OGRETMEN				VARCHAR(11)		= NULL,
	@RAPORMU					BIT				= 0,
	@APIKEY						VARCHAR(MAX)	= NULL,
	@GUNCELLEME					BIT				= NULL,
	@ID_ODEVSINIFOGRENCIDOSYA	INT				= NULL,
	@TAMAMLANDIDURUM			INT				= NULL,
	@OGRETMENODEVAD				VARCHAR(MAX)	= NULL,
	@OGRETMENODEVGUID			NVARCHAR(MAX)	= NULL,
	@OGRETMENUZANTI				NVARCHAR(MAX)	= NULL,
	@DOSYA						VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL


AS
BEGIN

/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 23.10.2020
	
	Öğrenci Ödev Dosya İşlemleri

	--	sp Alter
	--	ISLEM 6  UPDATE
	--	ISLEM 9  UPDATE
	--	ISLEM 10 UPDATE
	--	ISLEM 24 ADD
	--	ISLEM 24 ADD

*/

	DECLARE @ODEVKONTROLSURESI INT = -16
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU

				,ID_KADEME					= @ID_KADEME			
				,ID_ODEVTUR					= @ID_ODEVTUR			
				,DURUM						= @DURUM				
				,ID_ODEV					= @ID_ODEV			
				,ID_SINIF					= @ID_SINIF			
				,TC_ODEVVEREN				= @TC_ODEVVEREN		
				,SQLJSON					= @SQLJSON			
											 
				,TC_OGRENCI					= @TC_OGRENCI			
				,BASLANGIC_TARIHI			= @BASLANGIC_TARIHI	
				,BITIS_TARIHI				= @BITIS_TARIHI		
				,DONEM						= @DONEM				
				,ID_DERS					= @ID_DERS			
											
				,ID_DERSLIST				= @ID_DERSLIST		
				,ID_KADEME3LIST				= @ID_KADEME3LIST		
				,ID_SUBELIST				= @ID_SUBELIST		
				,TC_OGRETMENLIST			= @TC_OGRETMENLIST	
				,TUR						= @TUR				
				,TC_OGRETMEN				= @TC_OGRETMEN		
				,RAPORMU					= @RAPORMU			
				,APIKEY						= @APIKEY
				,GUNCELLEME					= @GUNCELLEME
				,ID_ODEVSINIFOGRENCIDOSYA	= @ID_ODEVSINIFOGRENCIDOSYA
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	DECLARE @ID_ODEVSINIFOGRENCI	INT 

	--BEGIN TRANSACTION [TranOdev]
	BEGIN TRY   
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		IF @ID_LOG > 0
		BEGIN
			IF @ISLEM = 1 -- KADEME ÖDEV TÜR LİSTELE
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT OT.ID_ODEVTUR, OT.AD, CASE WHEN OTK.ID_KADEME IS NULL THEN 0 ELSE 1 END AS DURUM, @ID_KADEME AS ID_KADEME
					FROM OdevTur OT WITH(NOLOCK)
					LEFT JOIN OdevTurKademe OTK WITH(NOLOCK) ON OTK.ID_ODEVTUR = OT.ID_ODEVTUR AND OTK.ID_KADEME = @ID_KADEME
					ORDER BY OT.ID_ODEVTUR
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 2 -- KADEME ÖDEV TÜR DURUM EKLE/GÜNCELLE
			BEGIN
				IF @DURUM = 0
				BEGIN
					DELETE FROM OdevTurKademe WHERE ID_ODEVTUR = @ID_ODEVTUR AND ID_KADEME = @ID_KADEME
				END

				IF @DURUM = 1 AND NOT EXISTS (SELECT TOP 1 1 FROM OdevTurKademe WITH(NOLOCK) WHERE ID_ODEVTUR = @ID_ODEVTUR AND ID_KADEME = @ID_KADEME)
				BEGIN
					INSERT INTO OdevTurKademe(ID_ODEVTUR, ID_KADEME, KYE_KULLANICI)
					VALUES (@ID_ODEVTUR, @ID_KADEME, @TCKIMLIKNO)
				END
			END	
			
			IF @ISLEM = 3 -- ÖDEV KAYDET
			BEGIN
				DECLARE @AKTIFDONEM VARCHAR(4) 
				SELECT @AKTIFDONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1

				DECLARE @ID_ODEVTABLE TABLE (ID_ODEV INT)
				DECLARE @ID_ODEV3 INT

				INSERT INTO Odev (DONEM, ID_KADEME3, ID_DERS, ID_MORPADERS, ID_ODEVTUR, BASLIK, ACIKLAMA, VERILIS_TARIHI, TESLIM_TARIHI, KYE_KULLANICI)
				OUTPUT inserted.ID_ODEV INTO @ID_ODEVTABLE
				SELECT @AKTIFDONEM, ID_KADEME3, ID_DERS, ID_MORPADERS, ID_ODEVTUR, BASLIK, ACIKLAMA, VERILIS_TARIHI, TESLIM_TARIHI, @TCKIMLIKNO 
				FROM OPENJSON (@SQLJSON)
				WITH(
					ID_SUBE			INT,
					ID_KADEME		INT,
					ID_KADEME3		INT,
					ID_ODEVTUR		INT,
					ID_DERS			INT,
					ID_MORPADERS	INT,
					VERILIS_TARIHI	VARCHAR(MAX),
					TESLIM_TARIHI	VARCHAR(MAX),
					BASLIK			VARCHAR(MAX),
					ACIKLAMA		VARCHAR(MAX)
				)

				SELECT @ID_ODEV3 = ID_ODEV FROM @ID_ODEVTABLE

				SELECT DISTINCT ID_SINIF = SO.ID_SINIF, VALUE = JO.VALUE
				INTO #OGRENCISINIF
				FROM OPENJSON (@SQLJSON, '$.TC_OGRENCILIST') JO
				INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci SO ON SO.TCKIMLIKNO = JO.VALUE

				INSERT INTO OdevSinif (ID_ODEV, ID_SINIF)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_SINIFLIST')
				WHERE VALUE <> '0' AND VALUE IN (SELECT ID_SINIF FROM #OGRENCISINIF)

				INSERT INTO OdevSinifOgrenci (ID_ODEVSINIF, TCKIMLIKNO)
				SELECT DISTINCT OS.ID_ODEVSINIF, SO.VALUE
				FROM #OGRENCISINIF SO
				INNER JOIN OdevSinif OS ON OS.ID_SINIF = SO.ID_SINIF AND OS.ID_ODEV = @ID_ODEV3
				WHERE SO.VALUE <> '0'

				DROP TABLE IF EXISTS #OGRENCISINIF

				INSERT INTO OdevLink (ID_ODEV, AD, LINK)
				SELECT @ID_ODEV3, AD, LINK
				FROM OPENJSON (@SQLJSON, '$.LINKLIST')
				WITH(
					AD VARCHAR(MAX),
					LINK VARCHAR(MAX)
				)
				WHERE LINK <> ''

				IF @DOSYA != ''
					INSERT INTO OdevDosya (ID_ODEV, AD, GUID, UZANTI)
					SELECT @ID_ODEV3, AD,GUID,UZANTI
					FROM OPENJSON(@DOSYA,'$.DOSYA')
					WITH(
						AD		VARCHAR(MAX),
						GUID	VARCHAR(MAX),
						UZANTI  VARCHAR(MAX)
					)			
				

				INSERT INTO OdevMorpaKazanim (ID_ODEV, ID_MORPAKAZANIM)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_MORPAKAZANIMLIST')
				WHERE VALUE <> 0

				INSERT INTO OdevMorpaMateryal(ID_ODEV, ID_MORPAMATERYAL)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_MORPAMATERYALLIST')
				WHERE VALUE <> 0

				SET @ISLEM		= 19
				SET @ID_ODEV	= @ID_ODEV3
				SET @GUNCELLEME	= 0
				--GOTO Branch_Islem19;
			END	

			IF @ISLEM = 4 -- SINIF ÖDEV LİSTELE
			BEGIN
				SELECT
				ISNULL((
					SELECT	 O.ID_ODEV
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR, O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR, O.TESLIM_TARIHI, 104)
							,DURUM =	CASE 
										WHEN O.KONTROL = 1 AND EXISTS (SELECT TOP 1 1 FROM OdevSinifOgrenci OSO WHERE OSO.ID_ODEVSINIF = S.ID_ODEVSINIF AND OSO.ID_ODEVDURUM IS NOT NULL) THEN 1
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
										END
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif S WITH(NOLOCK) ON S.ID_ODEV = O.ID_ODEV
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					WHERE O.AKTIF = 1 
					AND KYE_KULLANICI = @TCKIMLIKNO
					AND S.ID_SINIF = @ID_SINIF
					ORDER BY O.VERILIS_TARIHI DESC
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 5 -- ÖDEV SİL
			BEGIN
				UPDATE Odev SET AKTIF = 0 WHERE ID_ODEV = @ID_ODEV
			END

			IF @ISLEM = 6 -- ÖDEV ÖĞRENCİ LİSTELE
			BEGIN
				SELECT ISNULL((
					SELECT OSO.ID_ODEVSINIFOGRENCI
						,ADSOYAD			=  K.AD + ' ' + K.SOYAD
						,ID_ODEVDURUM		= ISNULL(CAST(OSO.ID_ODEVDURUM AS VARCHAR), '')
						,ACIKLAMA			= ISNULL(OSO.ACIKLAMA, '')
						,OGRENCIDOSYALIST	= ISNULL((	SELECT OD.GUID
														FROM OdevSinifOgrenciDosya OD
														WHERE OD.ID_ODEVSINIFOGRENCI	= OSO.ID_ODEVSINIFOGRENCI
															AND OD.AKTIF				= 1
														FOR JSON PATH
												),'[]')
					FROM OdevSinifOgrenci					OSO WITH(NOLOCK)
					INNER JOIN OdevSinif					OS	WITH(NOLOCK) ON	 OS.ID_ODEVSINIF		= OSO.ID_ODEVSINIF
					INNER JOIN Odev							O	WITH(NOLOCK) ON	 O.ID_ODEV				= OS.ID_ODEV
					INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON	 K.TCKIMLIKNO			= OSO.TCKIMLIKNO
					WHERE	O.AKTIF		= 1
						AND O.ID_ODEV	= @ID_ODEV
						AND OS.ID_SINIF = @ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 7 -- DANIŞMAN MI
			BEGIN
				IF EXISTS (SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SinifPersonel WITH(NOLOCK) WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 100)
				BEGIN
					SELECT CAST(1 AS BIT)
				END
				ELSE
				BEGIN
					SELECT CAST(0 AS BIT)
				END
			END
			
			IF @ISLEM = 8 -- SINIF ÖDEV VEREN LİSTESİ
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT DISTINCT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
					WHERE OS.ID_SINIF = @ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				)
				, '[]')
			END

			IF @ISLEM = 9 -- ÖDEV VEREN ÖDEV LİSTELE
			BEGIN
				SELECT ISNULL((
					SELECT   ID_ODEV		= O.ID_ODEV
							,DERSAD			= ISNULL(D.DERSAD, '')
							,BASLIK			= O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR, O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI	= CONVERT(VARCHAR, O.TESLIM_TARIHI , 104)
							,ADSOYAD		= K.AD + ' ' + K.SOYAD
							,DURUM			=	CASE 
													WHEN O.KONTROL = 1 AND EXISTS (SELECT TOP 1  1 FROM OdevSinifOgrenci OSO WITH(NOLOCK) WHERE OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF AND OSO.ID_ODEVDURUM IS NOT NULL) THEN 1
													WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
													WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) <  @ODEVKONTROLSURESI THEN 3
												END							
							,DOSYASAYISI	= (SELECT COUNT(1) FROM OdevDosya OD WITH(NOLOCK) WHERE OD.ID_ODEV = O.ID_ODEV)
					FROM Odev								O	WITH(NOLOCK)
					INNER JOIN OdevSinif					OS	WITH(NOLOCK) ON OS.ID_ODEV		= O.ID_ODEV
					LEFT  JOIN eokul_v2.dbo.Ders			D	WITH(NOLOCK) ON D.ID_DERS		= O.ID_DERS
					INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON K.TCKIMLIKNO	= O.KYE_KULLANICI
					WHERE	O.AKTIF				= 1
						AND OS.ID_SINIF			= @ID_SINIF
						AND (	O.KYE_KULLANICI	= @TC_ODEVVEREN
							OR	@TC_ODEVVEREN	= ''
							OR	@TC_ODEVVEREN IS NULL 
							)
					ORDER BY O.TESLIM_TARIHI DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				), '[]')
			END

			IF @ISLEM = 10 -- ÖDEV DETAY GETİR
			BEGIN
				SELECT ISNULL((
					SELECT	 O.ID_ODEV
							,O.ID_MORPADERS
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,O.ACIKLAMA
							,LINKLIST				= ISNULL((SELECT OL.AD, OL.LINK				FROM OdevLink			OL	WITH(NOLOCK) WHERE OL.ID_ODEV  = O.ID_ODEV FOR JSON PATH), '[]')
							,DOSYALIST				= ISNULL((SELECT OD.AD , OD.GUID, OD.UZANTI FROM OdevDosya			OD	WITH(NOLOCK) WHERE OD.ID_ODEV  = O.ID_ODEV FOR JSON PATH), '[]')
							,ID_MORPAKAZANIMLIST	= ISNULL((SELECT OMK.ID_MORPAKAZANIM		FROM OdevMorpaKazanim	OMK WITH(NOLOCK) WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,ID_MORPAMATERYALLIST	= ISNULL((SELECT OMM.ID_MORPAMATERYAL		FROM OdevMorpaMateryal	OMM WITH(NOLOCK) WHERE OMM.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,VERILIS_TARIHI			= O.VERILIS_TARIHI
							,TESLIM_TARIHI			= O.TESLIM_TARIHI
							,OGRENCIDOSYALIST		= ISNULL((	SELECT DISTINCT OD.ID_ODEVSINIFOGRENCIDOSYA, OD.GUID
																FROM OdevSinif				OS	 WITH(NOLOCK)
																JOIN OdevSinifOgrenci		OSO	 WITH(NOLOCK)ON	OSO.ID_ODEVSINIF		= OS.ID_ODEVSINIF
																JOIN OdevSinifOgrenciDosya	OD	 WITH(NOLOCK)ON	OD.ID_ODEVSINIFOGRENCI	= OSO.ID_ODEVSINIFOGRENCI
																WHERE	OS.ID_ODEV		= O.ID_ODEV
																	AND OSO.TCKIMLIKNO	= @TC_OGRENCI
																	AND OD.AKTIF		= 1
																	--AND EXISTS (SELECT TOP 1 1  FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI = 4 AND SY.TCKIMLIKNO = @TC_OGRENCI )
																FOR JSON PATH
														),'[]')
					FROM Odev					O WITH(NOLOCK)
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					WHERE	O.AKTIF		= 1
						AND O.ID_ODEV	= @ID_ODEV
					FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				), '{}')
			END

			IF @ISLEM = 11 -- ÖDEV KONTROL KAYDET
			BEGIN
				DROP TABLE IF EXISTS #BILDIRIMODEV
				DROP TABLE IF EXISTS #VELILIST

				SELECT J.ID_ODEVSINIFOGRENCI,J.ID_ODEVDURUM,J.ACIKLAMA 
				INTO #BILDIRIMODEV
				FROM dbo.OdevSinifOgrenci OSO 
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEVSINIFOGRENCI INT,
					ID_ODEVDURUM INT,
					ACIKLAMA VARCHAR(MAX)				
				) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI AND J.ID_ODEVDURUM != OSO.ID_ODEVDURUM


				UPDATE OSO SET OSO.ID_ODEVDURUM = J.ID_ODEVDURUM, OSO.ACIKLAMA = J.ACIKLAMA
				FROM OdevSinifOgrenci OSO
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEVSINIFOGRENCI INT,
					ID_ODEVDURUM INT,
					ACIKLAMA VARCHAR(MAX)				
				) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI

				UPDATE Odev SET KONTROL = 1 WHERE ID_ODEV = (SELECT TOP 1 ID_ODEV FROM OdevSinif OS WITH(NOLOCK) JOIN OdevSinifOgrenci OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF JOIN OPENJSON(@SQLJSON) WITH(ID_ODEVSINIFOGRENCI INT) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI)

				--BİLDİRİM--
				SELECT	OV.TCKIMLIKNO, 
						OV.TCKIMLIKNO_OGR, SUBSTRING(K.AD + ' ' + K.SOYAD + ' ' + ISNULL(D.DERSAD + ' - ', '') + O.BASLIK + ' ' + 'ödevi yapılmamıştır.', 0, 249) AS ACIKLAMA
				INTO #VELILIST
				FROM OdevSinifOgrenci OSO
				JOIN OdevSinif OS ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN Odev O ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = O.ID_DERS
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3OgrenciVeli OV ON OV.TCKIMLIKNO_OGR = OSO.TCKIMLIKNO
				INNER JOIN  #BILDIRIMODEV		 BO	ON BO.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI
				WHERE BO.ID_ODEVDURUM = 3
				--OPENJSON(@SQLJSON)
				--WITH(
				--	ID_ODEVSINIFOGRENCI INT,
				--	ID_ODEVDURUM INT,
				--	ACIKLAMA VARCHAR(MAX)				
				--) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI 
				--WHERE J.ID_ODEVDURUM = 3 

				DECLARE @VELITCTEMP VARCHAR(11) = '', @OGRENCITCTEMP VARCHAR(11) = ''
				DECLARE @BILDIRIM11 VARCHAR(250)		= ''
				DECLARE @BILDIRIMTAM11 VARCHAR(MAX)	= ''

				WHILE EXISTS (SELECT TOP 1 1 FROM #VELILIST)
				BEGIN
					SELECT TOP 1 @VELITCTEMP = TCKIMLIKNO, 
								 @OGRENCITCTEMP = TCKIMLIKNO_OGR,
								 @BILDIRIM11 = ACIKLAMA,
								 @BILDIRIMTAM11 = ACIKLAMA
					FROM #VELILIST

					DECLARE @LINK11 VARCHAR(MAX) = '', @LINK_ETIKET11 VARCHAR(MAX) = ''
					SET @LINK11			='https://pusulam.okyanuskoleji.k12.tr/AnaSayfaOutSide.html#OutSide/OSOdevListesi?TC_OGRENCI='+@OGRENCITCTEMP+'&TCKIMLIKNO='+@VELITCTEMP
					SET @LINK_ETIKET11	= 'Ödeve Git'

					SELECT @VELITCTEMP, 
						   @OGRENCITCTEMP,
						   @BILDIRIM11,
						   @BILDIRIMTAM11

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Ödev'
						,@MESAJ				= @BILDIRIM11
						,@LINK				= @LINK11
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @VELITCTEMP
						,@ID_UYGULAMA		= 2
						,@MESAJTAM			= @BILDIRIMTAM11
						,@LINK_ETIKET		= @LINK_ETIKET11

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Ödev'
						,@MESAJ				= @BILDIRIM11
						,@LINK				= @LINK11
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @VELITCTEMP
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @BILDIRIMTAM11
						,@LINK_ETIKET		= @LINK_ETIKET11

					DELETE FROM #VELILIST WHERE TCKIMLIKNO = @VELITCTEMP
				END

				DROP TABLE #VELILIST
			END

			IF @ISLEM = 12 -- ÖDEV GÜNCELLE
			BEGIN
				DECLARE @ID_ODEV12 INT
				SELECT @ID_ODEV12 = ID_ODEV
				FROM OPENJSON(@SQLJSON)
				WITH(ID_ODEV INT)

				UPDATE O SET O.BASLIK = J.BASLIK, O.ACIKLAMA = J.ACIKLAMA, O.VERILIS_TARIHI = J.VERILIS_TARIHI, O.TESLIM_TARIHI = J.TESLIM_TARIHI
				FROM Odev O
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEV INT,
					BASLIK VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					VERILIS_TARIHI VARCHAR(MAX),
					TESLIM_TARIHI VARCHAR(MAX)
				) J ON J.ID_ODEV = O.ID_ODEV

				DELETE FROM OdevDosya 
				WHERE ID_ODEV = @ID_ODEV12

					IF @OGRETMENODEVGUID != ''
					INSERT INTO OdevDosya (ID_ODEV, AD, GUID, UZANTI)
					SELECT @ID_ODEV, @OGRETMENODEVAD, @OGRETMENODEVGUID, @OGRETMENUZANTI

				DELETE FROM OdevLink 
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevLink (ID_ODEV, AD, LINK)
				SELECT @ID_ODEV12, AD, LINK
				FROM OPENJSON(@SQLJSON, '$.LINKLIST')
				WITH (
					AD VARCHAR(MAX),
					LINK VARCHAR(MAX)
				) WHERE LINK <> ''

				DELETE FROM OdevMorpaKazanim
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevMorpaKazanim (ID_ODEV, ID_MORPAKAZANIM)
				SELECT @ID_ODEV12, VALUE
				FROM OPENJSON(@SQLJSON, '$.ID_MORPAKAZANIMLIST')
				WHERE VALUE <> 0

				DELETE FROM OdevMorpaMateryal
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevMorpaMateryal (ID_ODEV, ID_MORPAMATERYAL)
				SELECT @ID_ODEV12, VALUE
				FROM OPENJSON(@SQLJSON, '$.ID_MORPAMATERYALLIST')
				WHERE VALUE <> 0

				EXEC Pusulam.dbo.sp_Odev
								 @TCKIMLIKNO		= @TCKIMLIKNO
								,@OTURUM			= @OTURUM
								,@ID_ODEV			= @ID_ODEV12
								,@ID_MENU			= @ID_MENU
								,@GUNCELLEME		= 1
								,@ISLEM				= 19
			END

			IF @ISLEM = 13 -- ÖDEV RAPOR
			BEGIN
				SELECT	 TCKIMLIKNO = SO.TCKIMLIKNO
						,ADSOYAD = K.AD + ' ' + K.SOYAD
						,KAMPUS = SD.SUBEAD
						,SINIF = SD.SINIF
						,OGRENCINO = OT.OGRNO
						,FOTOGRAF = ISNULL(R.FOTOGRAF,'')
				INTO #OGRENCI13
				FROM OkyanusDB.dbo.vw_SinifOgrenci SO WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = SO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay SD WITH(NOLOCK) ON SD.ID_SINIF = SO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Ogrenci OT WITH(NOLOCK) ON OT.TCKIMLIKNO = SO.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3Resim R WITH(NOLOCK) ON R.TCKIMLIKNO = SO.TCKIMLIKNO AND R.SIRANO = 1
				WHERE SO.ID_SINIF = @ID_SINIF AND SO.TCKIMLIKNO = @TC_OGRENCI

				SELECT	 DONEM = DO.ACIKLAMA
						,TARIH = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
						,DERS = ISNULL(D.DERSAD, '') 
						,DEGERLENDIRME = OD.AD
						,O.BASLIK
						,OSO.ID_ODEVDURUM
						,O.VERILIS_TARIHI
				INTO #OGRENCIODEV13
				FROM OdevSinifOgrenci OSO WITH(NOLOCK)
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3AktifDonem DO WITH(NOLOCK) ON DO.DONEM = O.DONEM
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND OS.ID_SINIF = @ID_SINIF
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND O.VERILIS_TARIHI BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI

				SELECT * FROM #OGRENCI13

				SELECT	 O.ID_ODEVDURUM
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI		
				FROM	#OGRENCIODEV13 O
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = O.ID_ODEVDURUM
				GROUP BY O.ID_ODEVDURUM, OD.AD

				SELECT * FROM #OGRENCIODEV13 ORDER BY VERILIS_TARIHI DESC

				DROP TABLE #OGRENCI13
				DROP TABLE #OGRENCIODEV13
			END

			IF @ISLEM = 14 -- ÖĞRENCİ ÖDEV LİSTESİ
			BEGIN

				DROP TABLE IF EXISTS #TEMP14
				SELECT	 ID_ODEV		= O.ID_ODEV
						,DERSAD			= ISNULL(D.DERSAD, '')
						,VERILIS_TARIHI	= O.VERILIS_TARIHI
						,TESLIM_TARIHI	= O.TESLIM_TARIHI
						,DURUM			= ISNULL(OD.AD, 'Kontrol Edilmedi')
						,BASLIK			= O.BASLIK
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,ID_ODEVTUR		= O.ID_ODEVTUR
						,ACIKLAMA		= IIF(OD.AD IS NULL OR OSO.ACIKLAMA = '' , NULL, OSO.ACIKLAMA)
						,TAMAMLANDI		= IIF(EXISTS (SELECT TOP 1 1 FROM OdevTamamlandi OT	WITH(NOLOCK) WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO), 1, 0)
				INTO #TEMP14
				FROM		Odev				O	WITH(NOLOCK)
				INNER JOIN	OdevSinif			OS	WITH(NOLOCK) ON	OS.ID_ODEV		= O.ID_ODEV
				INNER JOIN	OdevSinifOgrenci	OSO	WITH(NOLOCK) ON	OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
				LEFT  JOIN	eokul_v2.dbo.Ders	D	WITH(NOLOCK) ON	D.ID_DERS		= O.ID_DERS
				INNER JOIN	v3Kullanici			K	WITH(NOLOCK) ON	K.TCKIMLIKNO	= O.KYE_KULLANICI
				LEFT  JOIN	OdevDurum			OD	WITH(NOLOCK) ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				WHERE	O.AKTIF			= 1 
					AND O.DONEM			= @DONEM 
					AND OSO.TCKIMLIKNO	= @TC_OGRENCI 
					AND (	O.ID_DERS	= @ID_DERS 
						OR	@ID_DERS	= 0 
						OR	@ID_DERS IS NULL
						)

				SELECT (
					SELECT LISTE = (
						SELECT ISNULL((
							SELECT	 ID_ODEV
									,DERSAD
									,VERILIS_TARIHI= CONVERT(VARCHAR(MAX), VERILIS_TARIHI, 104)
									,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), TESLIM_TARIHI , 104)
									,DURUM
									,BASLIK
									,ADSOYAD
									,ID_ODEVTUR
									,ACIKLAMA
							FROM #TEMP14 T
							WHERE TAMAMLANDI = 0
							ORDER BY T.TESLIM_TARIHI DESC
							FOR JSON PATH
						), '[]')			
					)
					,TAMAMLANAN = (
						SELECT ISNULL((
							SELECT	 ID_ODEV
									,DERSAD
									,VERILIS_TARIHI= CONVERT(VARCHAR(MAX), VERILIS_TARIHI, 104)
									,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), TESLIM_TARIHI , 104)
									,DURUM
									,BASLIK
									,ADSOYAD
									,ID_ODEVTUR
									,ACIKLAMA
							FROM #TEMP14 T
							WHERE TAMAMLANDI = 1
							ORDER BY T.TESLIM_TARIHI DESC
							FOR JSON PATH
						), '[]')			
					)
					FOR JSON PATH
				)
				DROP TABLE IF EXISTS #TEMP14

			END

			IF @ISLEM = 15 -- VELİ ÖDEV RAPOR
			BEGIN
				SELECT	 TCKIMLIKNO = O.TCKIMLIKNO
						,ADSOYAD = K.AD + ' ' + K.SOYAD
						,KAMPUS = SB.AD
						,SINIF = S.AD
						,OGRENCINO = O.OGRNO
						,FOTOGRAF = ISNULL(R.FOTOGRAF,'')
				INTO #OGRENCI15
				FROM OkyanusDB.dbo.v3OgrenciTum O WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3SinifTum S WITH(NOLOCK) ON S.ID_SINIF = O.ID_SINIF AND S.DONEM = O.DONEM
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS WITH(NOLOCK) ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube SB WITH(NOLOCK) ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3Resim R WITH(NOLOCK) ON R.TCKIMLIKNO = K.TCKIMLIKNO AND R.SIRANO = 1
				WHERE O.TCKIMLIKNO = @TC_OGRENCI AND O.DONEM = @DONEM

				SELECT	 DONEM = O.DONEM
						,TARIH = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
						,DERS = ISNULL(D.DERSAD, '') 
						,DEGERLENDIRME = OD.AD
						,O.BASLIK
						,OSO.ID_ODEVDURUM
						,O.VERILIS_TARIHI
				INTO #OGRENCIODEV15
				FROM OdevSinifOgrenci OSO WITH(NOLOCK)
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND (O.ID_DERS = @ID_DERS OR @ID_DERS = 0 OR @ID_DERS IS NULL)
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND O.DONEM = @DONEM
				AND ((@ID_DERS > 0 AND O.ID_ODEVTUR <> 5) OR (@ID_DERS = 0 OR @ID_DERS IS NULL))

				SELECT * FROM #OGRENCI15

				SELECT	 O.ID_ODEVDURUM
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI		
				FROM	#OGRENCIODEV15 O
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = O.ID_ODEVDURUM
				GROUP BY O.ID_ODEVDURUM, OD.AD

				SELECT * FROM #OGRENCIODEV15 
				ORDER BY VERILIS_TARIHI DESC

				IF @ID_DERS > 0
				BEGIN
					SELECT DERSAD + ' Ödev Durumu' AS TITLE
					FROM eokul_v2.dbo.Ders WITH(NOLOCK)
					WHERE ID_DERS= @ID_DERS
				END
				ELSE
				BEGIN
					SELECT 'Genel Ödev Durumu' AS TITLE
				END

				DROP TABLE #OGRENCI15
				DROP TABLE #OGRENCIODEV15
			END

			IF @ISLEM = 16 -- ÖĞRETMEN ÖDEV RAPORU
			BEGIN
				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #TUMODEVLER
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))	
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #KONTROLEDILENODEVLER
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 1
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #KONTROLTARIHIGECMEYEN
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 0
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #KONTROLTARIHIGECEN
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 0
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				IF @RAPORMU = 0
				BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 T.ID_SINIF
							,T.ID_DERS
							,T.TCKIMLIKNO
							,T.ADSOYAD
							,T.SUBEAD
							,T.SINIFAD
							,T.DERSAD
							,T.SAYI AS VERILEN
							,ISNULL(K.SAYI, 0) AS KONTROLEDILEN
							,ISNULL(KG.SAYI, 0) AS KONTROLEDILMEYEN
							,ISNULL(KGM.SAYI, 0) AS KONTROLSURESIDOLMAYAN
					FROM #TUMODEVLER T
					LEFT JOIN #KONTROLEDILENODEVLER K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND K.ID_SINIF = T.ID_SINIF AND K.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECEN KG ON KG.TCKIMLIKNO = T.TCKIMLIKNO AND KG.ID_SINIF = T.ID_SINIF AND KG.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECMEYEN KGM ON KGM.TCKIMLIKNO = T.TCKIMLIKNO AND KGM.ID_SINIF = T.ID_SINIF AND KGM.ID_DERS = T.ID_DERS
					ORDER BY T.TCKIMLIKNO, T.ADSOYAD, T.SINIFAD, T.DERSAD
					FOR JSON PATH
				)
				, '[]')
				END
				ELSE 
				BEGIN
					SELECT	 T.ID_SINIF
							,T.ID_DERS
							,T.TCKIMLIKNO
							,T.ADSOYAD
							,T.SUBEAD
							,T.SINIFAD
							,T.DERSAD
							,T.SAYI AS VERILEN
							,ISNULL(K.SAYI, 0) AS KONTROLEDILEN
							,ISNULL(KG.SAYI, 0) AS KONTROLEDILMEYEN
							,ISNULL(KGM.SAYI, 0) AS KONTROLSURESIDOLMAYAN
					FROM #TUMODEVLER T
					LEFT JOIN #KONTROLEDILENODEVLER K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND K.ID_SINIF = T.ID_SINIF AND K.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECEN KG ON KG.TCKIMLIKNO = T.TCKIMLIKNO AND KG.ID_SINIF = T.ID_SINIF AND KG.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECMEYEN KGM ON KGM.TCKIMLIKNO = T.TCKIMLIKNO AND KGM.ID_SINIF = T.ID_SINIF AND KGM.ID_DERS = T.ID_DERS
					ORDER BY T.TCKIMLIKNO, T.ADSOYAD, T.SINIFAD, T.DERSAD
				END

				DROP TABLE #TUMODEVLER
				DROP TABLE #KONTROLEDILENODEVLER
				DROP TABLE #KONTROLTARIHIGECMEYEN
				DROP TABLE #KONTROLTARIHIGECEN
			END

			IF @ISLEM = 17 -- ÖĞRETMEN ÖDEV RAPOR DETAY
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 O.ID_ODEV
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), O.TESLIM_TARIHI, 104)
							,DURUM = CASE 
									WHEN O.KONTROL = 1 THEN 1
									WHEN O.KONTROL = 0 and DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
									WHEN O.KONTROL = 0 and DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
									END
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
					WHERE O.KYE_KULLANICI = @TC_OGRETMEN
					AND (@ID_DERS IS NULL OR @ID_DERS = 0 OR O.ID_DERS = @ID_DERS)
					AND O.ID_ODEVTUR = @ID_ODEVTUR
					AND OS.ID_SINIF = @ID_SINIF
					AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
					AND (
						@TUR = 1
						OR (@TUR = 2 AND O.KONTROL = 1)
						OR (@TUR = 3 AND O.KONTROL = 0 AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI)
						OR (@TUR = 4 AND O.KONTROL = 0 AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI)
					)
					FOR JSON PATH
				)
				, '[]')
			END	

			IF @ISLEM = 18 -- MORPA API
			BEGIN
				IF @APIKEY = 'D16EB1CA-062F-4CF8-8E3B-8700E44A06A0'
				BEGIN
					SELECT 
					(
						SELECT SUCCESS = 1,
							   DESCRIPTION = 'Başarılı!',
							   LIST = (
											ISNULL((
												SELECT	 O.ID_ODEV
														,O.ID_MORPADERS	
														,OS.ID_ODEVSINIF
														,SINIF = K3.DUZEY
														,SINIFAD = S.AD
														,BASLIK
														,ACIKLAMA
														,VERILIS_TARIHI
														,TESLIM_TARIHI
														--,KYE_KULLANICI
														,KYE_KULLANICI = (CASE WHEN O.ID_KADEME3 IN (7, 8, 9, 10) THEN (SELECT TOP 1 TCKIMLIKNO FROM OkyanusDB.dbo.v3SinifPersonel P WHERE P.ID_SINIF = OS.ID_SINIF AND P.ID_KULLANICITIPI = 100) ELSE O.KYE_KULLANICI END)
														,KYE_TARIH
														,MATERYALLIST = (SELECT DISTINCT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM JOIN MorpaMateryal MM ON MM.ID_MORPAMATERYAL = OMM.ID_MORPAMATERYAL AND MM.ID_MORPADERS = O.ID_MORPADERS WHERE OMM.ID_ODEV = O.ID_ODEV AND MM.AKTIF = 1 FOR JSON PATH)
														,KAZANIMLIST = (SELECT DISTINCT MK.KOD as ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK JOIN MorpaKazanim MK ON MK.ID_MORPAKAZANIM = OMK.ID_MORPAKAZANIM AND MK.AKTIF = 1 WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH)
														,OGRENCILIST = (
																			SELECT DISTINCT TCKIMLIKNO
																			FROM OdevSinifOgrenci OSO 
																			WHERE OS.ID_ODEV = O.ID_ODEV AND OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF FOR JSON PATH
																		)
												FROM Odev O WITH(NOLOCK)
												INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 WITH(NOLOCK) ON K3.ID_KADEME3 = O.ID_KADEME3
												INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
												INNER JOIN OkyanusDB.dbo.v3Sinif S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
												WHERE O.AKTIF = 1
												AND O.ID_ODEVTUR = 5
												AND O.VERILIS_TARIHI BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
												ORDER BY O.ID_ODEV
												FOR JSON PATH
											), '[]')
								)
						FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
					)
				END
				ELSE
				BEGIN
					SELECT 
					(
						SELECT SUCCESS = 0,
							   DESCRIPTION = 'Gönderilen apikey hatalı!',
							   LIST = '[]'
						FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
					)
				END
			END

			Branch_Islem19:

			IF @ISLEM = 19 -- ÖDEV BİLDİRİM - MAİL GÖNDER
			BEGIN
				DECLARE	@TC_ALAN VARCHAR(11)

				--DECLARE @MAIL VARCHAR(MAX)
				--DECLARE @MAILKONU VARCHAR(150)
				--DECLARE @ALANMAIL VARCHAR(MAX)
				DECLARE @DERSAD VARCHAR(100)
				DECLARE @ADSOYAD VARCHAR(150)
				DECLARE @BASLIK VARCHAR(150)
				DECLARE @ACIKLAMA VARCHAR(500)
				DECLARE @VERILISTARIHI VARCHAR(50)
				DECLARE @TESLIMTARIHI VARCHAR(50)
	   
				SELECT	 @DERSAD           = ISNULL(D.DERSAD, '')
						,@ADSOYAD          = ISNULL(K.AD + ' ' + K.SOYAD, '')
						,@BASLIK           = OD.BASLIK
						,@ACIKLAMA         = OD.ACIKLAMA
						,@VERILISTARIHI    = CONVERT(VARCHAR(MAX), OD.VERILIS_TARIHI, 104)
						,@TESLIMTARIHI     = CONVERT(VARCHAR(MAX), OD.TESLIM_TARIHI, 104)
				FROM Odev OD WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders				D WITH(NOLOCK) ON OD.ID_DERS = D.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K WITH(NOLOCK) ON K.TCKIMLIKNO = OD.KYE_KULLANICI
				WHERE OD.ID_ODEV = @ID_ODEV 
		

				--SET @MAIL = '<html><head>
				--<style>body{font-family:verdana;}.baslik{background-color:rgb(176, 229, 231);width:150px;}table{width:100%;}td {border:1px solid #e3e3e3;}</style>
				--</head><body><table><tr>
				--<td class="baslik">Öğretmen Ad</td>
				--<td>' + @ADSOYAD + '</td>
				--<td class="baslik">Ders</td>
				--<td>' + @DERSAD + '</td>
				--</tr><tr>
				--<td class="baslik">Konu</td>
				--<td>' + @BASLIK + '</td>
				--<td class="baslik">Veriliş-Teslim Tarihleri</td>
				--<td>' + @VERILISTARIHI + '-' + @TESLIMTARIHI+'</td>
				--</tr><tr>
				--<td colspan="4"><br>' + @ACIKLAMA + '<br></td>
				--</tr><tr>
				--<td colspan="4"><a href="http://interaktif.okyanuskoleji.k12.tr/" target="_blank">Giriş yapmak için tıklayın...</a></td>
				--</tr></table></body></html>'

				--SET @MAILKONU = (SELECT 'Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN 'Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK)

				SELECT DISTINCT OSO.TCKIMLIKNO
				INTO #OGRENCILIST
				FROM Odev O WITH(NOLOCK)
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OdevSinifOgrenci OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF
				WHERE O.ID_ODEV = @ID_ODEV
				
				/*
				IF @MAIL IS NOT NULL
				BEGIN
					SELECT DISTINCT
						KO.EMAIL,
						K.TCKIMLIKNO
					INTO #MAILLIST
					FROM #OGRENCILIST O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3KullaniciBilgi KO WITH(NOLOCK) ON KO.TCKIMLIKNO = K.TCKIMLIKNO
					WHERE KO.EMAIL LIKE '%_@_%_.__%' AND K.AKTIF=1
					UNION 
					SELECT  
						KB.EMAIL,
						K.TCKIMLIKNO
					FROM #OGRENCILIST O
					INNER JOIN OkyanusDB.dbo.v3OgrenciVeli OV WITH(NOLOCK) ON OV.TCKIMLIKNO_OGR = O.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = OV.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3KullaniciBilgi KB WITH(NOLOCK) ON KB.TCKIMLIKNO = K.TCKIMLIKNO
					WHERE KB.EMAIL LIKE '%_@_%_.__%' AND K.AKTIF=1

					WHILE EXISTS (SELECT TOP 1 * FROM #MAILLIST)
					BEGIN	
						SELECT TOP 1 
							 @TC_ALAN	= TCKIMLIKNO
							,@ALANMAIL	= EMAIL
						FROM #MAILLIST ORDER BY TCKIMLIKNO 


						EXEC OkyanusIletisim.dbo.sp_SendPushMail
								 @TCKIMLIKNO		= @TCKIMLIKNO
								,@HEADER			= @MAILKONU
								,@MESAJ				= @MAIL
								,@MAILADRES			= @ALANMAIL
								,@LINK				= ''
								,@TCKIMLIKNO_KIME	= @TC_ALAN
								,@ID_UYGULAMA		= 2

						DELETE FROM #MAILLIST WHERE TCKIMLIKNO = @TC_ALAN
					END
				END
				*/
				DECLARE @BILDIRIM VARCHAR(250)		= (SELECT SUBSTRING('Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN ' Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK, 0, 249))
				DECLARE @BILDIRIMTAM VARCHAR(MAX)	= (SELECT			'Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN ' Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK)

				SELECT DISTINCT
					O.TCKIMLIKNO , O.TCKIMLIKNO AS TC_OGRENICI
				INTO #BILDIRIMLIST
				FROM #OGRENCILIST O
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
				WHERE K.AKTIF=1
				UNION 
				SELECT DISTINCT
					K.TCKIMLIKNO, OV.TCKIMLIKNO_OGR AS TC_OGRENICI
				FROM #OGRENCILIST O
				INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	OV WITH(NOLOCK)	ON OV.TCKIMLIKNO_OGR = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K WITH(NOLOCK)	ON K.TCKIMLIKNO = ov.TCKIMLIKNO
				WHERE K.AKTIF = 1

				WHILE EXISTS (SELECT TOP 1 1 FROM #BILDIRIMLIST)
				BEGIN
					SELECT TOP 1 
						@TC_ALAN	= TCKIMLIKNO,
						@TC_OGRENCI	= TC_OGRENICI
					FROM #BILDIRIMLIST 
					ORDER BY TCKIMLIKNO 

			
					DECLARE @LINK VARCHAR(MAX) = '', @LINK_ETIKET VARCHAR(MAX) = ''

					IF @TC_ALAN <> @TC_OGRENCI
					BEGIN
						SET @LINK			='https://pusulam.okyanuskoleji.k12.tr/AnaSayfaOutSide.html#OutSide/OSOdevListesi?TC_OGRENCI='+@TC_OGRENCI+'&TCKIMLIKNO='+@TC_ALAN
						SET @LINK_ETIKET	= 'Ödeve Git'
					END

					--EXEC OkyanusIletisim.dbo.sp_SendPushMessage
					--		 @TCKIMLIKNO		= @TCKIMLIKNO
					--		,@HEADER			= 'Interaktif Ödev'
					--		,@MESAJ				= @BILDIRIM
					--		,@LINK				= @LINK
					--		,@MENU				= '000'
					--		,@TCKIMLIKNO_KIME	= @TC_ALAN
					--		,@ID_UYGULAMA		= 2
					--		,@MESAJTAM			= @BILDIRIMTAM
					--		,@LINK_ETIKET		= @LINK_ETIKET

						EXEC OkyanusIletisim.dbo.sp_SendPushMessage
							 @TCKIMLIKNO		= @TCKIMLIKNO
							,@HEADER			= 'Interaktif Ödev'
							,@MESAJ				= @BILDIRIM
							,@LINK				= @LINK
							,@MENU				= '000'
							,@TCKIMLIKNO_KIME	= @TC_ALAN
							,@ID_UYGULAMA		= 1
							,@MESAJTAM			= @BILDIRIMTAM
							,@LINK_ETIKET		= @LINK_ETIKET

					DELETE FROM #BILDIRIMLIST WHERE TCKIMLIKNO = @TC_ALAN
				END
	
				DROP TABLE IF EXISTS #BILDIRIMLIST
				--DROP TABLE IF EXISTS #MAILLIST
				DROP TABLE IF EXISTS #OGRENCILIST
			END

			IF @ISLEM = 20 -- MORPA API -- METE KONTROL
			BEGIN
				SELECT	 O.ID_ODEV
						,O.ID_MORPADERS	
						,OS.ID_ODEVSINIF
						,SINIF = K3.DUZEY
						,SINIFAD = S.AD
						,BASLIK
						,ACIKLAMA
						,VERILIS_TARIHI
						,TESLIM_TARIHI
						--,KYE_KULLANICI
						,KYE_KULLANICI = (CASE WHEN O.ID_KADEME3 IN (7, 8, 9, 10) THEN (SELECT TOP 1 TCKIMLIKNO FROM OkyanusDB.dbo.v3SinifPersonel P WITH(NOLOCK) WHERE P.ID_SINIF = OS.ID_SINIF AND P.ID_KULLANICITIPI = 100) ELSE O.KYE_KULLANICI END)
						,KYE_TARIH
						,MATERYALLIST = (SELECT DISTINCT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM WITH(NOLOCK) JOIN MorpaMateryal MM WITH(NOLOCK) ON MM.ID_MORPAMATERYAL = OMM.ID_MORPAMATERYAL AND MM.ID_MORPADERS = O.ID_MORPADERS WHERE OMM.ID_ODEV = O.ID_ODEV AND MM.AKTIF = 1 FOR JSON PATH)
						,KAZANIMLIST = (SELECT DISTINCT MK.KOD as ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK WITH(NOLOCK) JOIN MorpaKazanim MK WITH(NOLOCK) ON MK.ID_MORPAKAZANIM = OMK.ID_MORPAKAZANIM AND MK.AKTIF = 1 WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH)
						,OGRENCILIST = (
											SELECT DISTINCT TCKIMLIKNO
											FROM OdevSinifOgrenci OSO  WITH(NOLOCK)
											WHERE OS.ID_ODEV = O.ID_ODEV AND OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF FOR JSON PATH
										)
				FROM Odev O WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 WITH(NOLOCK) ON K3.ID_KADEME3 = O.ID_KADEME3
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.v3Sinif S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				WHERE O.AKTIF = 1
				AND O.ID_ODEVTUR = 5
				AND O.VERILIS_TARIHI >= CAST(DATEADD(DAY, -7, GETDATE()) AS DATE)
				ORDER BY O.ID_ODEV
			END

			IF @ISLEM = 21 -- ÖDEV TAMAMLA
			BEGIN
				INSERT INTO OdevTamamlandi(ID_ODEV,TCKIMLIKNO)
				SELECT @ID_ODEV, @TCKIMLIKNO
			END

			IF @ISLEM = 23 -- ÖĞRENCİ ÖDEV DOSYA EKLE
			BEGIN

				DECLARE @GUID_DOSYA VARCHAR(36) = NEWID()
				WHILE EXISTS(SELECT TOP 1 1 FROM OdevSinifOgrenciDosya D WHERE D.GUID = @GUID_DOSYA)
				BEGIN
					SET @GUID_DOSYA = NEWID()
				END

				SET @ID_ODEVSINIFOGRENCI = (SELECT OSO.ID_ODEVSINIFOGRENCI
											FROM Odev				O
											JOIN OdevSinif			OS	ON	OS.ID_ODEV		= O.ID_ODEV
											JOIN OdevSinifOgrenci	OSO	ON	OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
											WHERE	O.ID_ODEV	= @ID_ODEV
												AND TCKIMLIKNO	= @TC_OGRENCI)

				DECLARE @INSERT23 TABLE(ID INT)
				INSERT INTO OdevSinifOgrenciDosya (ID_ODEVSINIFOGRENCI, GUID) 
				OUTPUT inserted.ID_ODEVSINIFOGRENCIDOSYA INTO @INSERT23
				VALUES (@ID_ODEVSINIFOGRENCI, @GUID_DOSYA)

				SELECT	 GUID						= @GUID_DOSYA
						,ID_ODEVSINIFOGRENCIDOSYA	= (SELECT TOP 1 ID FROM @INSERT23)
				FOR JSON PATH

			END

			IF @ISLEM = 24 -- ÖĞRENCİ ÖDEV DOSYA SİL
			BEGIN

				UPDATE OdevSinifOgrenciDosya SET
					AKTIF		= 0,
					KYI_TARIH	= GETDATE()
				WHERE ID_ODEVSINIFOGRENCIDOSYA = @ID_ODEVSINIFOGRENCIDOSYA

			END
			IF @ISLEM = 25 -- ÖĞRENCİ ÖDEV İPTAL
			BEGIN
				DELETE FROM OdevTamamlandi WHERE ID_ODEV=@ID_ODEV  
			END
		END
	
	--COMMIT TRANSACTION [TranOdev]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [TranOdev]
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OdevTakibi]    Script Date: 23.11.2021 15:02:28 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OdevTakibi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_REHBERLIKENVANTER	INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@TESTADI				VARCHAR(MAX)	= NULL,
	@KLASOR					VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL


		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM							= @ISLEM					
			,TCKIMLIKNO						= @TCKIMLIKNO				
			,OTURUM							= @OTURUM					
			,ID_MENU						= @ID_MENU				
			,TC_OGRENCI						= @TC_OGRENCI				
			,ID_KADEME3						= @ID_KADEME3				
			,ID_SINIF						= @ID_SINIF				
			,ID_REHBERLIKENVANTER			= @ID_REHBERLIKENVANTER	
			,DONEM							= @DONEM					
			,TESTADI						= @TESTADI				
			,KLASOR							= @KLASOR					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
	
		IF @ISLEM = 1	--	
		BEGIN
			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TOPLAM

			SELECT	D.ID_DERS		[ID_DERS] ,
					D.DERSAD		[DERSAD] ,
					OD.AD			[ODEVDURUM] ,
					COUNT(1)		[SAYI]
			INTO #TEMP
			FROM	OdevSinifOgrenci			OSO 
			JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
			JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
			JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
			JOIN	eokul_v2.dbo.Ders			D	ON	D.ID_DERS		= ODV.ID_DERS AND D.AKTIF = 1 AND D.IPTAL = 0
			WHERE	(OSO.TCKIMLIKNO	= @TC_OGRENCI)
				AND (ODV.DONEM	= @DONEM or @DONEM = '')			
			GROUP BY D.DERSAD,D.ID_DERS,OD.AD
			UNION ALL 
			SELECT	0				,
					'Tümü'			,
					OD.AD AS ODEVDURUM	,
					COUNT(1)		
			FROM	OdevSinifOgrenci			OSO 
			JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
			JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
			JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
			WHERE	(OSO.TCKIMLIKNO	= @TC_OGRENCI)
				AND (ODV.DONEM	= @DONEM or @DONEM = '')		
			GROUP BY OD.AD

			SELECT ID_DERS, SUM(SAYI) TS 
			INTO #TOPLAM
			FROM #TEMP
			GROUP BY ID_DERS

			SELECT(
				SELECT (
					SELECT DISTINCT ID_DERS,DERSAD,
						(SELECT  ODEVDURUM
								,SAYI
								,YUZDE = CONVERT(DECIMAL(8,2),(CONVERT(DECIMAL(8,2),SAYI)/TS)*100.0) 
								FROM #TEMP		G 
								JOIN #TOPLAM	K	ON	K.ID_DERS = G.ID_DERS 
								WHERE G.ID_DERS	= T.ID_DERS 
								FOR JSON AUTO
						) AS DURUM
					FROM #TEMP T
					ORDER BY ID_DERS,DERSAD
					FOR JSON AUTO
				) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS SS
	
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TOPLAM

		END	
 
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OdulListesi]    Script Date: 23.11.2021 15:02:47 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OdulListesi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@MIN_NET			DECIMAL(8,2)	= NULL,
	@MIN_DERECE			INT				= NULL,
	@MAX_DERECE			INT				= NULL,
	@ID_SINAVPUANTURU	INT				= NULL,
	@IP					VARCHAR(50)	= NULL,

	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SUBEs					= @ID_SUBEs		
			,MIN_NET					= @MIN_NET		
			,MIN_DERECE					= @MIN_DERECE		
			,MAX_DERECE					= @MAX_DERECE		
			,ID_SINAVPUANTURU			= @ID_SINAVPUANTURU
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
			SELECT	 ST.TCKIMLIKNO
					,ST.ID_SINAV
					,O.ID_SUBE
					,O.ID_SINIF
					,ST.TN
					,PUAN= ISNULL(SP.PUAN,0)
					,DENSE_RANK() OVER(PARTITION BY ST.ID_SINAV, O.ID_SUBE ORDER BY ISNULL(SP.PUAN,TN) DESC) SIRA
			INTO #OGRENCILIST
			FROM SinavOgrenciToplam		ST
			LEFT JOIN SinavOgrenciPuan	SP	ON	SP.TCKIMLIKNO	= ST.TCKIMLIKNO
											AND SP.ID_SINAV		= ST.ID_SINAV							
			JOIN Sinav					S	ON	S.ID_SINAV		= ST.ID_SINAV
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= ST.TCKIMLIKNO
											AND O.DONEM			= S.DONEM
			WHERE	ST.ID_SINAV IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))
				AND O.ID_SUBE	IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				AND ST.TN > @MIN_NET
				AND (	SP.ID_SINAVPUANTURU = @ID_SINAVPUANTURU
					OR	0					= @ID_SINAVPUANTURU
					OR  S.PUANGIZLE			= 1
					)

			SELECT	 TCKIMLIKNO	= OL.TCKIMLIKNO
					,ID_SUBE	= OL.ID_SUBE
					,TN			= OL.TN
					,PUAN		= OL.PUAN
					,SIRA		= OL.SIRA
					,ID_SINAV	= S.ID_SINAV
					,SINAVAD	= S.AD
					,KADEME3	= GST.KADEME3
					,SINAVTARIH	= CONVERT(VARCHAR,S.SINAVTARIH ,104)
					,SUBEAD		= GST.SUBEAD
					,SINIFAD	= GST.SINIF
					,ADSOYAD	= K.AD + ' ' + K.SOYAD
					,MINNET		= @MIN_NET
			INTO #LISTE
			FROM #OGRENCILIST				OL
			JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= OL.TCKIMLIKNO
			JOIN Sinav						S	ON	S.ID_SINAV		= OL.ID_SINAV
			JOIN vw_SubeSinifGrupKademeTum	GST	ON GST.ID_SINIF		= OL.ID_SINIF
			WHERE OL.SIRA BETWEEN @MIN_DERECE AND @MAX_DERECE

		IF @ISLEM = 1	--	JSON
		BEGIN
			SELECT ISNULL(
				(
					SELECT * FROM #LISTE
					ORDER BY ID_SINAV, ID_SUBE, SIRA, PUAN
					FOR JSON AUTO
				),'[]'
			) AS S
		END
		IF @ISLEM = 2	--	DATASET
		BEGIN			
			SELECT * FROM #LISTE
			ORDER BY ID_SINAV, ID_SUBE, SIRA, PUAN
		END
		
		DROP TABLE IF EXISTS #OGRENCILIST	
		DROP TABLE IF EXISTS #LISTE	

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Ogrenci]    Script Date: 23.11.2021 15:03:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Ogrenci]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUP		INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINIFS			VARCHAR(MAX)	= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_TKTZEKATURUS	VARCHAR(MAX)	= NULL,
	@ID_TKTSINAV		INT				= NULL,
	@ID_TKTTEST			INT				= NULL,
	@TARIH				Date			= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ISJSON				BIT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SUBE					= @ID_SUBE		
			,ID_SUBELIST				= @ID_SUBELIST	
			,ID_SINAVGRUP				= @ID_SINAVGRUP	
			,ID_SINIF					= @ID_SINIF		
			,ID_KADEME					= @ID_KADEME		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINIFS					= @ID_SINIFS		
			,SINIFLAR					= @SINIFLAR		
			,ID_TKTZEKATURUS			= @ID_TKTZEKATURUS
			,ID_TKTSINAV				= @ID_TKTSINAV	
			,ID_TKTTEST					= @ID_TKTTEST		
			,TARIH						= @TARIH			
			,DONEM						= @DONEM			
			,TC_OGRENCI					= @TC_OGRENCI		
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ISJSON						= @ISJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
	
			SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
			IF @ISLEM = 1	--	Upgrade Öğrenci Listele 
			BEGIN
				SELECT DISTINCT o.ID_OGRENCI, o.TCKIMLIKNO, st.ID_SATISTURU 
				INTO #OGRENCILIST
				FROM [dbo].[v3OgrenciTum] o
				inner join [dbo].[v3SubeYetki]	sy		on sy.TCKIMLIKNO	=	o.TCKIMLIKNO 
				inner join [dbo].[v3SinifTum]	s		on s.ID_SINIF		=	o.ID_SINIF AND s.DONEM = o.DONEM
				inner join [dbo].[v3SatisTuru]	st		on st.ID_SATISTURU	=	s.ID_SATISTURU 
				WHERE 
				o.DONEM = @DONEM AND
				(@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  AND
				(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  AND
				(@ID_SINIFS IS NULL OR @ID_SINIFS='[]' OR s.ID_SINIF in (select value from openjson( @ID_SINIFS)) ) AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))

				SELECT O.ID_OGRENCI, OS.KYE_KULLANICI, CONVERT(VARCHAR, MAX(OS.KYE_TARIH),104) AS TARIH, SUM(OS.SAY) AS SORUSAYISI, OS.ID_TKTTEST, OS.ID_UPGRADEOGRENCISINAVDONEM
				INTO #OGRENCILIST2
				FROM #OGRENCILIST O
				LEFT JOIN (
							--SELECT OS.TCKIMLIKNO, S.ID_SATISTURU, OS.KYE_KULLANICI, OS.KYE_TARIH, 1 AS SAY
							--FROM UpgradeOgrenciSinav OS
							--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
							--WHERE OS.ID_TKTSINAV = @ID_TKTSINAV

							SELECT OSD.TCKIMLIKNO, S.ID_SATISTURU, OSD.KYE_KULLANICI, OSD.KYE_TARIH, 1 AS SAY, OSD.ID_TKTTEST, OSD.ID_UPGRADEOGRENCISINAVDONEM
							FROM UpgradeOgrenciSinavDonem OSD
							INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
							WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
						) OS ON OS.TCKIMLIKNO = O.TCKIMLIKNO AND OS.ID_SATISTURU = O.ID_SATISTURU
				GROUP BY O.ID_OGRENCI, OS.KYE_KULLANICI, OS.ID_TKTTEST, OS.ID_UPGRADEOGRENCISINAVDONEM


				SELECT 
					 o.ID_OGRENCI
					,k.AD
					,k.SOYAD
					,DOGUMTARIHI = CONVERT(VARCHAR, k.DOGUMTARIHI, 103)
					,o.TCKIMLIKNO 
					,PUANGIRISI = case when @ID_TKTTEST = 4 then 1 else (	
									SELECT COUNT(1) FROM TktOgrenciCevap oc
									Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
									INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
									WHERE s.ID_TKTTEST=@ID_TKTTEST AND os.TCKIMLIKNO=o.TCKIMLIKNO
									AND (os.DONEM = @DONEM OR @DONEM IS NULL)
									) end
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, GETDATE())-1
					,s.AD SINIF
					,K2.AD + ' ' + K2.SOYAD AS KYE_ADSOYAD 
					,OL.TARIH
					,OL.SORUSAYISI
					,CASE WHEN OL.ID_TKTTEST = 4 THEN 'Ortalamaya Göre;' + STUFF((SELECT '<br/>' + US.SINAVAD FROM UpgradeOgrenciSinavDonemEtkinlik OSDE JOIN UpgradeSinav US ON US.ID_TKTSINAV = OSDE.ID_TKTSINAV WHERE OSDE.ID_UPGRADEOGRENCISINAVDONEM = OL.ID_UPGRADEOGRENCISINAVDONEM FOR XML PATH, TYPE).value(N'.[1]', N'nvarchar(max)'),1, 0, N'') WHEN  OL.ID_TKTTEST IS NULL THEN '' ELSE (SELECT AD FROM TKTTest WHERE ID_TKTTEST = OL.ID_TKTTEST) END AS OLUSTURMASEKLI
				FROM		[dbo].[v3OgrenciTum]	o
				Inner Join	[dbo].[v3Kullanici]		k	on k.TCKIMLIKNO		=	o.TCKIMLIKNO
				inner join	[dbo].[v3SinifTum]		s	on s.ID_SINIF		=	o.ID_SINIF AND s.DONEM = o.DONEM
				INNER JOIN #OGRENCILIST2			OL	ON OL.ID_OGRENCI	=	o.ID_OGRENCI
				LEFT JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO	=	OL.KYE_KULLANICI 
				WHERE 
				o.DONEM = @DONEM
				ORDER BY k.AD, k.SOYAD

				DROP TABLE #OGRENCILIST2
				DROP TABLE #OGRENCILIST
			END

			IF @ISLEM = 2	--	TKT Öğrenci Listele 
			BEGIN
				SELECT distinct
					 O.ID_OGRENCI
					,REPLACE(UPPER(k.AD),'UNDEFİNED','') as AD
					,UPPER(k.SOYAD) as SOYAD
					,DOGUMTARIHI = CONVERT(VARCHAR, k.DOGUMTARIHI, 103)
					,O.TCKIMLIKNO 
					,PUANGIRISI1 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=1 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI2 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=2 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI3 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=3 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI4 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=4 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1
					,DURUM		= case when (DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1)<=(select max(YASAY2) from UpgradeYasAraligi) and (DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1)>=(select min(YASAY1) from UpgradeYasAraligi) then 1 else 0 end
				FROM	   [dbo].[v3OgrenciTum]		O
				Inner Join [dbo].[v3Kullanici]		k	on	k.TCKIMLIKNO	=	o.TCKIMLIKNO
				inner join [dbo].[v3SubeYetki]		sy	on	sy.TCKIMLIKNO	=	o.TCKIMLIKNO
				inner join [dbo].[v3SinifTum]		s	on	s.ID_SINIF		=	o.ID_SINIF 
				inner join [dbo].[v3SatisTuru]		st	on	st.ID_SATISTURU	=	s.ID_SATISTURU  
				where O.DONEM = @DONEM AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  AND
					(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  AND
					(@ID_SINIF IS NULL OR @ID_SINIF=0 OR s.ID_SINIF=@ID_SINIF)  AND
					(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))
			END

			IF @ISLEM = 4	--	Öğrenci Listele 
			BEGIN
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM v3OgrenciTum		O
				JOIN v3Kullanici	K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE ID_SINIF=@ID_SINIF
				ORDER BY K.AD, K.SOYAD
			END

			IF @ISLEM = 5	--	Öğrenci Listele by Veli
			BEGIN

				IF @ID_KADEME IS NULL
					SET @ID_KADEME = 0

				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO,ID_KADEME
				FROM V3KULLANici			K	
				JOIN V3OgrenciVeli			V	ON	V.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO		= K.TCKIMLIKNO
				JOIN vw_SubeSinifGrupKademe	GS	ON	GS.ID_SINIF			= O.ID_SINIF
				WHERE V.TCKIMLIKNO=@TCKIMLIKNO
					AND (@ID_KADEME = 0 OR GS.ID_KADEME = @ID_KADEME )
			END

			IF @ISLEM = 6	--	Öğrenci Listele MultiSinif
			BEGIN
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM V3OGRENCi		O
				JOIN V3KULLANici	K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE (@SINIFLAR='[]' or ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			END

			IF @ISLEM = 7	--	Demo Öğrenci Listele 
			BEGIN
				SELECT	 [FOTOĞRAF]		= ISNULL(R.FOTOGRAF,'')
						,[AD SOYAD]		= K.AD +' '+ K.SOYAD
						,[ÖĞRENCİ NO]	= O.OGRNO
						,[SINIF]		= SN.AD
						,[TCKIMLIKNO]	= O.TCKIMLIKNO
						,[İŞLEM]		= '<input style="float:right;margin: 10px;" type="button" class="btn btn-success" v-on:click="DemoLogin('+O.TCKIMLIKNO+')" value="Giriş Yap">'
				INTO #DemoOgrenciList
				FROM v3Ogrenci						O
				JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF		= O.ID_SINIF
				JOIN v3Sinif						SN	ON	SN.ID_SINIF		= O.ID_SINIF
				JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.DBO.v3Resim		R	ON	R.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	(O.ID_SUBE	= @ID_SUBE			OR @ID_SUBE		= 0 )
					AND (O.ID_SINIF = @ID_SINIF			OR @ID_SINIF	= 0 )
					AND (ID_KADEME3 = @ID_KADEME3		OR @ID_KADEME3	= 0 )
					--AND (K.AD		LIKE '%'+@AD+'%'	OR @AD			= '')
					--AND (K.SOYAD	LIKE '%'+@SOYAD+'%'	OR @SOYAD		= '')
				ORDER BY [AD SOYAD],[ÖĞRENCİ NO]
				
				select(
						select * from(
							select 
							(						 
								SELECT * FROM #DemoOgrenciList
								ORDER BY [AD SOYAD],[ÖĞRENCİ NO]
								FOR JSON AUTO
							) as DemoOgrenciList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #DemoOgrenciList

			END

			IF @ISLEM = 8	--	ÖĞRENCİ KADEME GETİR
			BEGIN
				SELECT DISTINCT ST.ID_KADEME
				FROM OkyanusDB.dbo.v3Ogrenci O
				JOIN OkyanusDB.dbo.v3Satislar S ON S.ID_SOZLESME = O.ID_SOZLESME
				JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				WHERE TCKIMLIKNO = @TC_OGRENCI
			END

			IF @ISLEM = 9	--	ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				SELECT
				ISNULL
				(
					(
						SELECT  ID_SINAV	= S.ID_SINAV, 
								TCKIMLIKNO	= FO.TC_OGRENCI, 
								TUR			= ST.KISAAD, 
								TARIH		= CONVERT(varchar(MAX), S.SINAVTARIH, 104), 
								AD			= S.AD, 
								FREKANS		= ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
						FROM v2FrekansOgrenciDetay FO
						JOIN Sinav S ON S.ID_SINAV = FO.ID_SINAV
						JOIN SinavTuru ST ON ST.ID_SINAVTURU = S.ID_SINAVTURU
						WHERE TC_OGRENCI = @TC_OGRENCI AND S.DONEM = @DONEM
						GROUP BY S.ID_SINAV, FO.TC_OGRENCI, ST.KISAAD, S.SINAVTARIH, S.AD
						ORDER BY S.SINAVTARIH DESC
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 10	--	ÖĞRENCİ FREKANS DETAY LİSTESİ
			BEGIN
				SELECT
				ISNULL
				(
					(						
						SELECT DISTINCT FO.TAKMAAD, ISNULL(CAST(FO.FREKANS AS VARCHAR(MAX)) + '%', 'HESAPLANMADI') AS FREKANS
						FROM v2FrekansOgrenciDetay FO
						JOIN Sinav S ON S.ID_SINAV = FO.ID_SINAV
						WHERE TC_OGRENCI = @TC_OGRENCI AND S.ID_SINAV = @ID_SINAV
						ORDER BY FO.TAKMAAD
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 11	--	ŞUBE SINAV ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				IF @ISJSON = 1
				BEGIN
					SELECT
					ISNULL
					(
						(						
							SELECT	 K.TCKIMLIKNO
									,FOD.SUBEAD
									,FOD.SINIFAD
									,ADSOYAD = K.AD + ' ' + K.SOYAD
									,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')									
									--,DERSLIST = ISNULL((SELECT DERSAD,NET,SS,FREKANS
									--					FROM v2FrekansOgrenciDetay L
									--					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI
														
									--					WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND L.ID_SINAV = @ID_SINAV  AND L.TC_OGRENCI=FOD.TC_OGRENCI		
														
									--					FOR JSON PATH, INCLUDE_NULL_VALUES
									--				),'[]')
 							  
							FROM v2FrekansOgrenciDetay FOD
							JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
							WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
							GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI
							ORDER BY SUBEAD, SINIFAD, ADSOYAD
							FOR JSON PATH
						),'[]')	

				END
				ELSE
				BEGIN
					SELECT	 K.TCKIMLIKNO
							,FOD.SUBEAD
							,FOD.SINIFAD
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
					FROM v2FrekansOgrenciDetay FOD
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
					GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				END
			END
			
			IF @ISLEM = 12	--	ŞUBE SINAV ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				IF @ISJSON = 1

				BEGIN
				
		
					SELECT  ID_SINAV,AD,ID_SINAVTURU,DONEM 
					INTO #TEMPSINAV 
					FROM Sinav  
					WHERE	ID_SINAVTURU	= @ID_SINAVTURU 
						AND DONEM			= @DONEM  
						AND FREKANSHESAPLA	= 1

					SELECT DISTINCT TAKMAAD INTO #DERSLER FROM SinavDers Where ID_SINAV in(Select ID_SINAV FROM Sinav  where ID_SINAVTURU=@ID_SINAVTURU AND DONEM=@DONEM  AND FREKANSHESAPLA=1 )
			
					SELECT	 K.TCKIMLIKNO
									,FOD.SUBEAD
									,FOD.SINIFAD
									,FOD.ID_SINIF
									,ADSOYAD = K.AD + ' ' + K.SOYAD
									,SINAVAD=S.AD
									,DERSAD=FOD.DERSAD
									,FREKANS=FOD.FREKANS
									,NET=FOD.NET
									,SORUSAYISI=FOD.SS
									--,DERSLIST = ((SELECT DISTINCT S.ID_SINAV, DERSAD,L.NET,L.SS,L.FREKANS,K.AD,K.SOYAD
									--						FROM v2FrekansOgrenciDetay L
									--						JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI				
									--						--JOIN Sinav S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU 
									--						JOIN #TEMPSINAV S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU
									--							WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  AND L.TC_OGRENCI=K.TCKIMLIKNO	And L.TC_OGRENCI=FOD.TC_OGRENCI 
									--							AND L.ID_SINAVTURU=@ID_SINAVTURU	AND S.DONEM=@DONEM	--AND SS.AD=S.AD  --AND L.TC_OGRENCI=OS.TCKIMLIKNO --AND L.TC_OGRENCI=T.TCKIMLIKNO
									--						    GROUP BY K.TCKIMLIKNO,K.AD,K.SOYAD,L.DERSAD,S.ID_SINAV,L.NET,L.FREKANS,L.SS												
									--							FOR JSON PATH, INCLUDE_NULL_VALUES
									--					))
							INTO #OGRFREKANS
							FROM v2FrekansOgrenciDetay FOD
							JOIN #TEMPSINAV S ON S.ID_SINAV=FOD.ID_SINAV AND S.ID_SINAVTURU=FOD.ID_SINAVTURU
							--JOIN #DERSLER D ON S.ID_SINAV=FOD.ID_SINAV --AND D.ID_SINAVTURU=FOD.ID_SINAVTURU
							JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
							WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAVTURU = @ID_SINAVTURU
							GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI,S.AD,FOD.DERSAD,FOD.FREKANS,FOD.NET,FOD.SS,FOD.ID_SINIF
							ORDER BY SUBEAD, SINIFAD, ADSOYAD
					
					select(
						select * from(
								select 
								(					
									SELECT		*
									FROM		#TEMPSINAV 
							
									FOR JSON AUTO
								) as t1,
								(					
									SELECT * FROM #DERSLER							
									FOR JSON AUTO
								) as t2,
								(					
									SELECT * FROM #OGRFREKANS	
									GROUP BY TCKIMLIKNO,SINAVAD,DERSAD,SUBEAD,SINIFAD,ADSOYAD,FREKANS,NET,SORUSAYISI,ID_SINIF
									FOR JSON AUTO
								) as t3	
							) as tablo FOR JSON AUTO
						) as tt


			
	
					--		SELECT 
					--      ( 
					--	SELECT		
					--			DISTINCT T.TCKIMLIKNO, SINAVLAR = (
					--				SELECT 	SINAVAD = SS.AD, 
					--				        SINAVFREKANS=ISNULL(CAST(CAST(AVG(OS.FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI'),
					--						SORUSAYISI=OS.SS,
					--						SINAVNET=OS.NET,
					--						TCKIMLIKNO=OS.TCKIMLIKNO,									
					--						DERSLIST = ISNULL((SELECT DISTINCT S.ID_SINAV, DERSAD,L.NET,L.SS,L.FREKANS,K.AD,K.SOYAD
					--										FROM v2FrekansOgrenciDetay L
					--										JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI				
					--										JOIN Sinav S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU 													
					--											WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  AND L.TC_OGRENCI=K.TCKIMLIKNO	And L.TC_OGRENCI=FOD.TC_OGRENCI 
					--											AND L.ID_SINAVTURU=@ID_SINAVTURU	AND S.DONEM=@DONEM	AND SS.AD=S.AD  --AND L.TC_OGRENCI=OS.TCKIMLIKNO --AND L.TC_OGRENCI=T.TCKIMLIKNO
					--										    GROUP BY K.TCKIMLIKNO,K.AD,K.SOYAD,L.DERSAD,S.ID_SINAV,L.NET,L.FREKANS,L.SS												
					--											FOR JSON PATH, INCLUDE_NULL_VALUES
					--									),'[]')
						  
					--			FROM v2FrekansOgrenciDetay FOD
					--			JOIN Sinav SS ON SS.ID_SINAV=FOD.ID_SINAV AND SS.ID_SINAVTURU=FOD.ID_SINAVTURU 					
					--			JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					--			JOIN v2FrekansOgrenciSinav OS ON SS.ID_SINAV=OS.ID_SINAV AND K.TCKIMLIKNO=OS.TCKIMLIKNO AND OS.ID_SINAVTURU=SS.ID_SINAVTURU
					--			WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  And FOD.TC_OGRENCI=T.TCKIMLIKNO 
					--			AND SS.ID_SINAVTURU=@ID_SINAVTURU AND SS.DONEM=@DONEM AND OS.TCKIMLIKNO=K.TCKIMLIKNO AND K.TCKIMLIKNO=FOD.TC_OGRENCI AND FOD.TC_OGRENCI=OS.TCKIMLIKNO AND OS.ID_SINAVTURU=@ID_SINAVTURU
					--			GROUP BY FOD.SUBEAD, FOD.SINIFAD,SS.AD,FOD.TC_OGRENCI, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI,OS.FREKANS,OS.SS,OS.NET,OS.TCKIMLIKNO
					--			ORDER BY SUBEAD, SINIFAD
					--				FOR JSON PATH
					--			) 
					--	 FROM v2FrekansOgrenciSinav T
					--	 inner join v2FrekansOgrenciDetay FD ON  FD.ID_SINAV=T.ID_SINAV
					--	 JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND T.TCKIMLIKNO=FD.TC_OGRENCI
					--	 WHERE 
					--	 FD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND K.TCKIMLIKNO=FD.TC_OGRENCI AND K.TCKIMLIKNO=T.TCKIMLIKNO AND T.DONEM=@DONEM AND T.ID_SINAVTURU=@ID_SINAVTURU
					
					--	GROUP BY FD.SUBEAD, FD.SINIFAD,FD.TC_OGRENCI,T.TCKIMLIKNO,T.ID_SINAV
					--	FOR JSON PATH
					--) AS J 
			

				END
				ELSE
				BEGIN
					SELECT	 K.TCKIMLIKNO
							,FOD.SUBEAD
							,FOD.SINIFAD
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
					FROM v2FrekansOgrenciDetay FOD
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
					GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				END
			END

			IF @ISLEM = 13	--	ÖĞRENCİ DÖNEM DETAY			
			BEGIN
			
				IF @DONEM IS NULL
					SET @DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)

				SELECT ISNULL((				
					SELECT	 D.TCKIMLIKNO
							,ADSOYAD	= CONCAT_WS(' ', D.AD, D.SOYAD)
							,KADEME3
							,SUBEAD
							,SINIFAD
							,ID_SUBE
							,ID_SINIF
							,FOTOGRAF	= ISNULL(R.FOTOGRAF,'')
					FROM OkyanusDB.dbo.vw_OgrenciDetayTum	D
					LEFT JOIN OkyanusDB.dbo.v3Resim			R	ON	R.TCKIMLIKNO	= D.TCKIMLIKNO
																AND R.SIRANO		= 1
					WHERE	D.DONEM			= @DONEM
						AND D.TCKIMLIKNO	= @TC_OGRENCI
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END

			IF @ISLEM = 14	--	Öğrenci Listele by Veli Sınav
			BEGIN

				IF @ID_KADEME IS NULL
					SET @ID_KADEME = 0

				SELECT DISTINCT K.AD ,K.SOYAD ,K.TCKIMLIKNO,ID_KADEME
				FROM V3KULLANici			K	
				JOIN V3OgrenciVeli			V	ON	V.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO		= K.TCKIMLIKNO
				JOIN SinavOgrenci			SO  ON  SO.TCKIMLIKNO       = O.TCKIMLIKNO --SINAV ÖĞRENCİ
				JOIN Sinav					S   ON	S.ID_SINAV			= SO.ID_SINAV
												AND S.DONEM				= OkyanusDB.dbo.fn_AktifDonem()
				JOIN vw_SubeSinifGrupKademe	GS	ON	GS.ID_SINIF			= O.ID_SINIF
				WHERE V.TCKIMLIKNO=@TCKIMLIKNO
					AND (@ID_KADEME = 0 OR GS.ID_KADEME = @ID_KADEME )
			END
		
			DROP TABLE IF EXISTS #KADEMELER
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2

	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciBilgiSistemi]    Script Date: 23.11.2021 15:03:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciBilgiSistemi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@TARIH					VARCHAR(MAX)	= NULL,
	@SINIF_LIST				VARCHAR(MAX)    = NULL,
	@DOSYA_GUID				VARCHAR(MAX)	= NULL,
	@ID_OGRENCIBILGI		INT			    = NULL,
	@ID_SINIF				INT				= NULL,
	@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

			IF @ISLEM = 1	--	Dokuman Listesi
			BEGIN
			
				
				SELECT SO.ID_SUBE, S.ID_SINIF, S.ID_KADEME3 
				INTO #OGRENCISUBESINIF
				FROM OkyanusDB.dbo.v3Ogrenci SO
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif S ON S.ID_SINIF = SO.ID_SINIF
				WHERE TCKIMLIKNO = @TC_OGRENCI
				UNION
				SELECT S.ID_SUBE, S.ID_SINIF, S.ID_KADEME3 FROM OkyanusDB.dbo.v4SinifOgrenci SO
				INNER JOIN OkyanusDB.dbo.v4Sinif S ON S.ID_SINIF = SO.ID_SINIF AND S.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3AktifDonem D ON D.DONEM = S.DONEM AND D.AKTIF = 1
				WHERE TC_OGRENCI = @TC_OGRENCI AND SO.AKTIF = 1

				SELECT
					ISNULL(
				(
					SELECT 
						TARIH = B.TARIH
					   ,DERS  = B.DERS
					   ,B.ACIKLAMA
					   ,EKLEYEN = K.AD + ' ' + K.SOYAD
					   ,B.DOSYA_GUID
					   ,B.LINK
					   ,B.BASLIK		
					FROM OgrenciBilgi						B
					JOIN OkyanusDB.dbo.v3Kullanici			K  ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
					JOIN OgrenciBilgiSinif					BS ON BS.ID_OGRENCIBILGI = B.ID_OGRENCIBILGI 
					WHERE DONEM = @AKTIFDONEM AND
					(BS.ID_SINIF IN (SELECT O.ID_SINIF FROM #OGRENCISUBESINIF O) OR BS.ID_SINIF = 0) AND B.AKTIF = 1
					ORDER BY B.TARIH DESC
					FOR JSON PATH
				 ), '[]')


				--SELECT ISNULL((				
				--	SELECT DISTINCT
				--		 D.ID_DOKUMHAN
				--		,D.ACIKLAMA
				--		,D.DOSYA
				--		,ICERIK		= D.ICERIK
				--		,TARIH		= CONVERT(VARCHAR,d.SILINMETARIHI,104) 
				--		,DOSYALAR	= (	SELECT DISTINCT DOSYA, DOKUMAN_GUID
				--						FROM eokul_v2.dbo.DokumanDosya	DD	
				--						WHERE	DD.ID_DOKUMAN	= D.ID_DOKUMHAN
				--							AND	DD.SILINDI		= 0
				--						FOR JSON PATH, INCLUDE_NULL_VALUES
				--					)
				--		,LINK		= D.LINK
				--		,DERS		= D.DERS
				--		,EKLEYEN	= CONCAT_WS(' ',K.AD,K.SOYAD)	
				--		,D.SILINMETARIHI
				--	FROM eokul_v2.dbo.Dokumhan				D
				--	JOIN eokul_v2.dbo.DokumhanYetki			DY	ON	DY.ID_DOKUMHAN	= D.ID_DOKUMHAN
				--	JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO	= D.TC_KULLANICI
				--	JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.ID_SINIF		= DY.ID_SINIF
				--	WHERE	KY.TCKIMLIKNO	= @TCKIMLIKNO
				--		AND D.DONEM			= @AKTIFDONEM
				--		AND D.MODUL			= 'OBS'
				--		AND D.IPTAL			= 0
				--	ORDER BY D.SILINMETARIHI DESC , D.ID_DOKUMHAN desc
				--	FOR JSON PATH, INCLUDE_NULL_VALUES
				--),'[]')

				
				
			END

			IF @ISLEM = 2   -- Bilgi Ekle
			BEGIN
				
				CREATE TABLE #BILGI(ID_OGRENCIBILGI INT)

				INSERT INTO OgrenciBilgi(DERS,BASLIK,LINK,ACIKLAMA,TARIH,KYE_TCKIMLIKNO,KYE_TARIH,AKTIF,DONEM)
				OUTPUT INSERTED.ID_OGRENCIBILGI INTO #BILGI(ID_OGRENCIBILGI)
				SELECT Ders,Baslik,Link,Aciklama,@TARIH,@TCKIMLIKNO,GETDATE(),1,@AKTIFDONEM
				FROM OPENJSON(@SQLJSON)
				WITH
				(
				  Ders			 VARCHAR(MAX),
				  Baslik		 VARCHAR(MAX),
				  Link			 VARCHAR(MAX),
				  Aciklama		 VARCHAR(MAX)
				)

				INSERT INTO OgrenciBilgiSinif(ID_OGRENCIBILGI,ID_SINIF)
				SELECT (SELECT ID_OGRENCIBILGI FROM #BILGI),S.VALUE
				FROM OPENJSON(@SINIF_LIST)		S WHERE S.VALUE > 0

				SELECT ID_OGRENCIBILGI FROM #BILGI
			END


			IF @ISLEM = 3   -- Bilgi Dosya Kaydet
			BEGIN
				UPDATE OgrenciBilgi SET DOSYA_GUID = @DOSYA_GUID WHERE ID_OGRENCIBILGI = @ID_OGRENCIBILGI
			END

			IF @ISLEM = 4   -- Bilgi Listele
			BEGIN
				
				SELECT ISNULL((
						SELECT DISTINCT
							 B.ID_OGRENCIBILGI
							,DERS
							,BASLIK
							,TARIH = (FORMAT(TARIH,'dd.MM.yyyy')) 
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM OgrenciBilgi			B
						JOIN v3Kullanici			K	ON K.TCKIMLIKNO			= B.KYE_TCKIMLIKNO
						JOIN OgrenciBilgiSinif		OBS ON OBS.ID_OGRENCIBILGI  = B.ID_OGRENCIBILGI
						WHERE OBS.ID_SINIF = ID_SINIF AND B.DONEM = @AKTIFDONEM AND B.AKTIF = 1
						ORDER BY TARIH
						FOR JSON PATH
				),'[]')
				
				
			END

			IF @ISLEM = 5   -- Bilgi Sil
			BEGIN
				UPDATE OgrenciBilgi SET AKTIF = 0 WHERE ID_OGRENCIBILGI = @ID_OGRENCIBILGI
				
				SELECT ISNULL((
						SELECT DISTINCT
							 B.ID_OGRENCIBILGI
							,DERS
							,BASLIK
							,TARIH = (FORMAT(TARIH,'dd.MM.yyyy')) 
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM OgrenciBilgi			B
						JOIN v3Kullanici			K	ON K.TCKIMLIKNO			= B.KYE_TCKIMLIKNO
						JOIN OgrenciBilgiSinif		OBS ON OBS.ID_OGRENCIBILGI  = B.ID_OGRENCIBILGI
						WHERE OBS.ID_SINIF = ID_SINIF AND B.DONEM = @AKTIFDONEM AND B.AKTIF = 1
						ORDER BY TARIH
						FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 6   -- Bilgi Getir 
			BEGIN
				SELECT ISNULL((
					SELECT 
						DERS
					   ,BASLIK
					   ,LINK
					   ,ACIKLAMA
					   ,TARIH				   
					FROM OgrenciBilgi 
					WHERE ID_OGRENCIBILGI = @ID_OGRENCIBILGI  
					FOR JSON PATH
				),'{}')				
			END

			IF @ISLEM = 7  -- Bilgi Düzenle
			BEGIN				
				UPDATE B 
				SET B.DERS = J.Ders,B.BASLIK = J.Baslik, B.LINK = J.Link,B.ACIKLAMA = J.Aciklama,  B.TARIH = @TARIH
				FROM OgrenciBilgi as B
				JOIN OPENJSON(@SQLJSON)
				WITH (
				  ID_OGRENCIBILGI		 INT,
				  Ders			 VARCHAR(MAX),
				  Baslik		 VARCHAR(MAX),
				  Link			 VARCHAR(MAX),
				  Aciklama		 VARCHAR(MAX)
				) AS J ON J.ID_OGRENCIBILGI = B.ID_OGRENCIBILGI WHERE B.ID_OGRENCIBILGI = @ID_OGRENCIBILGI

				SELECT @ID_OGRENCIBILGI
			END			
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciDersMuaf]    Script Date: 23.11.2021 15:03:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciDersMuaf]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DERS				BIT				= NULL,
	@DONEM				char(4)			= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,TC_OGRENCI					= @TC_OGRENCI	
			,ID_MENU					= @ID_MENU	
			,ID_SUBE					= @ID_SUBE	
			,ID_SINIF					= @ID_SINIF	
			,DERS						= @DERS		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
						
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	ÖĞRENCİ LİSTESİ SINIFA GÖRE
		BEGIN
			SELECT (
				SELECT	 O.TCKIMLIKNO
						,K.AD
						,K.SOYAD
						,DIN_MUAF		= ISNULL(DM.DIN_MUAF,0)				
						,ING_MUAF		= ISNULL(DM.INGILIZCE_MUAF,0)
				FROM v3Ogrenci				O
				JOIN v3Kullanici			K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OgrenciDersMuaf	DM	ON	DM.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE O.ID_SINIF = @ID_SINIF
				ORDER BY AD,SOYAD
				FOR JSON PATH
			)
		END

		IF @ISLEM = 2
		BEGIN			
			DECLARE @DIN BIT= (SELECT CASE WHEN @DERS = 0 THEN 1 ELSE 0 END)
			DECLARE @ING BIT= (SELECT CASE WHEN @DERS = 1 THEN 1 ELSE 0 END)

			IF EXISTS (SELECT TOP 1 1 FROM OgrenciDersMuaf WHERE TCKIMLIKNO = @TC_OGRENCI)
			BEGIN
				UPDATE OgrenciDersMuaf
				SET	 DIN_MUAF	= CASE WHEN DIN_MUAF = 0 THEN 1 ELSE 0 END					
				WHERE	TCKIMLIKNO  = @TC_OGRENCI
					AND @DIN		= 1

				UPDATE OgrenciDersMuaf
				SET	 INGILIZCE_MUAF = CASE WHEN INGILIZCE_MUAF = 0 THEN 1 ELSE 0 END			
				WHERE	TCKIMLIKNO  = @TC_OGRENCI
					AND @ING = 1 

				DELETE FROM OgrenciDersMuaf 
				WHERE	TCKIMLIKNO		= @TC_OGRENCI 
					AND INGILIZCE_MUAF	= 0
					AND DIN_MUAF		= 0
			END
			ELSE
			BEGIN

				INSERT INTO OgrenciDersMuaf (TCKIMLIKNO,DIN_MUAF,INGILIZCE_MUAF,KYE_TCKIMLIKNO)
				VALUES (@TC_OGRENCI,@DIN,@ING,@TCKIMLIKNO)
			END

			SELECT 1
		END

		IF @ISLEM = 3	--	ÖĞRENCİ LİSTESİ GENEL (EXCEL)
		BEGIN
			SELECT	 OD.SUBEAD
					,OD.KADEME3
					,OD.SINIFAD
					,OD.TCKIMLIKNO
					,OD.AD
					,OD.SOYAD
					,DIN_MUAF		= CASE WHEN ISNULL(DM.DIN_MUAF,0) = 0 THEN '' ELSE 'X' END
					,ING_MUAF		= CASE WHEN ISNULL(DM.INGILIZCE_MUAF,0) = 0 THEN '' ELSE 'X' END
			FROM OkyanusDB.dbo.v3Ogrenci			O
			JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.TCKIMLIKNO = O.TCKIMLIKNO AND OD.ID_SINIF = O.ID_SINIF
			JOIN OgrenciDersMuaf					DM	ON	DM.TCKIMLIKNO	= O.TCKIMLIKNO
			ORDER BY SUBEAD,OD.ID_KADEME3,SINIFAD,AD,SOYAD
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciFrekansMuaf]    Script Date: 23.11.2021 15:03:51 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciFrekansMuaf]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DERS				VARCHAR(100)	= NULL,
	@MUAF				BIT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,TC_OGRENCI					= @TC_OGRENCI	
			,ID_MENU					= @ID_MENU	
			,ID_SINIF					= @ID_SINIF	
			,DERS						= @DERS		
			,MUAF						= @MUAF		
			,ID_KADEME3					= @ID_KADEME3	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP 
	
						
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @cols NVARCHAR(MAX)
				,@SQL NVARCHAR(MAX)

		IF @ISLEM = 1	--	ÖĞRENCİ LİSTESİ SINIFA GÖRE
		BEGIN
			DECLARE @ID_KADEME3X INT
			DROP TABLE IF EXISTS #TEMP

			SET @ID_KADEME3X = (SELECT ID_KADEME3 FROM vw_SubeSinifGrupKademe WHERE ID_SINIF = @ID_SINIF)

			SELECT	 TCKIMLIKNO	= O.TCKIMLIKNO
					,ADSOYAD	= K.AD+' '+K.SOYAD
					,DERSAD		= REPLACE(FD.AD,'.','')
					,MUAF		= CASE WHEN FM.ID_OGRENCIFREKANSMUAF IS NULL THEN NULL ELSE 1 END
			INTO #TEMP
			FROM v3Ogrenci					O
			JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN v3FrekansDers				FD	ON	FD.ID_KADEME3	= @ID_KADEME3X
			LEFT JOIN OgrenciFrekansMuaf	FM	ON	FM.TCKIMLIKNO	= O.TCKIMLIKNO
												AND FM.DERSAD		= FD.AD
			WHERE O.ID_SINIF = @ID_SINIF
			ORDER BY DERSAD

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.DERSAD)  FROM #TEMP c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

			SET @SQL = 'SELECT (
							SELECT * FROM (
								SELECT * FROM #TEMP
							) AS T
							PIVOT (MAX(MUAF) FOR DERSAD IN ('+CAST(@cols AS varchar(MAX))+')) AS P				
							ORDER BY ADSOYAD
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)'

			IF @SQL IS NULL 
				SELECT '[{}]' 
			ELSE
				EXEC (@SQL)
			
			DROP TABLE IF EXISTS #TEMP
		END

		IF @ISLEM = 2
		BEGIN			
			
			
			SET @DERS = (	SELECT FD.AD 
							FROM vw_SubeSinifGrupKademe GS 
							JOIN v3Ogrenci				O	ON	O.ID_SINIF		= GS.ID_SINIF 
							JOIN v3FrekansDers			FD	ON	FD.ID_KADEME3	= GS.ID_KADEME3
							WHERE	O.TCKIMLIKNO = @TC_OGRENCI
								AND REPLACE(FD.AD,'.','') = @DERS
						)


			DELETE OgrenciFrekansMuaf WHERE TCKIMLIKNO = @TC_OGRENCI AND DERSAD = @DERS

			IF @MUAF = 1 
				INSERT INTO OgrenciFrekansMuaf (TCKIMLIKNO,DERSAD,KYE_TCKIMLIKNO)
				VALUES (@TC_OGRENCI,@DERS,@TCKIMLIKNO)

			SELECT 1
		END

		IF @ISLEM = 3	--	ÖĞRENCİ LİSTESİ GENEL (EXCEL)
		BEGIN
			DROP TABLE IF EXISTS #TEMP3

			SELECT	 TCKIMLIKNO	= O.TCKIMLIKNO
					,DERSAD		= REPLACE(FD.AD,'.','')
					,MUAF		= CASE WHEN FM.ID_OGRENCIFREKANSMUAF IS NULL THEN NULL ELSE 1 END
			INTO #TEMP3
			FROM OgrenciFrekansMuaf						FM
			JOIN OkyanusDB.dbo.vw_OgrenciDetayTum		O	ON	O.TCKIMLIKNO	= FM.TCKIMLIKNO
			JOIN OkyanusDB.dbo.v3AktifDonem				D	ON	D.DONEM			= O.DONEM AND D.AKTIF = 1
			JOIN OkyanusDB.dbo.v3FrekansDers			FD	ON	FD.ID_KADEME3	= O.ID_KADEME3 AND FD.AD = FM.DERSAD
			JOIN OkyanusDB.dbo.v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			WHERE O.ID_KADEME3 = @ID_KADEME3
			ORDER BY DERSAD

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.DERSAD) FROM #TEMP3 c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			DECLARE @cols2 VARCHAR(MAX)
			SET @cols2 = STUFF((SELECT DISTINCT ',CASE WHEN ' + QUOTENAME(C.DERSAD) + ' IS NULL THEN '''' ELSE ''X'' END AS ' + QUOTENAME(C.DERSAD) + '' FROM #TEMP3 c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

			SET @SQL = '	SELECT	 Şube		= OD.SUBEAD
									,Grup		= OD.KADEME3
									,Sınıf		= OD.SINIFAD
									,TCKIMLIKNO = OD.TCKIMLIKNO
									,AD			= OD.AD
									,SOYAD		= OD.SOYAD
									,'+ CAST(@cols2 AS varchar(MAX)) +' 
							FROM (
								SELECT * FROM (
									SELECT * FROM #TEMP3
								) AS T
								PIVOT (MAX(MUAF) FOR DERSAD IN ('+CAST(@cols AS varchar(MAX))+')) AS P			
							) X
							JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.TCKIMLIKNO = X.TCKIMLIKNO
							JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.TCKIMLIKNO = O.TCKIMLIKNO AND OD.ID_SINIF = O.ID_SINIF
							ORDER BY SUBEAD,OD.ID_KADEME3,SINIFAD,AD,SOYAD
					'

			EXEC (@SQL)
			
			DROP TABLE IF EXISTS #TEMP3
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciHarcama]    Script Date: 23.11.2021 15:04:07 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciHarcama]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,

	@TOPLAMTUTAR		FLOAT			= NULL,
	@ID_OGRENCIHARCAMA	INT				= NULL,
	@CEVAP				BIT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM	
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
				
				,ID_OGRENCIHARCAMA	= @ID_OGRENCIHARCAMA
				,TOPLAMTUTAR		= @TOPLAMTUTAR
				,CEVAP				= @CEVAP
				,SQLJSON			= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		
		IF	(	@ISLEM = 3 
			AND NOT EXISTS(	SELECT TOP 1 1 
						FROM OPENJSON(@SQLJSON) 
						WITH (	APIKEY	VARCHAR(MAX)) J
						WHERE APIKEY = 'y78DKXNkkQCND34uLzPo8jIBCkxaPIiq')
			)
		BEGIN
			 SET @_ID_LOG = 0
			 RAISERROR ('HATA' , 16 , 1)
		END

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	OGRENCIHARCAMA ÖDEME EKLE			
			BEGIN

				DROP TABLE IF EXISTS #TEMP1
				
				SELECT	 TCKIMLIKNO = TCKIMLIKNO
						,TUTAR_KR	= YUKLEME_FIYAT * 100
				INTO #TEMP1
				FROM OPENJSON(@SQLJSON)
				WITH (
					TCKIMLIKNO		VARCHAR(MAX),
					YUKLEME_FIYAT	DECIMAL(8,2)
				) AS J
				WHERE YUKLEME_FIYAT > 0

				DECLARE @ID_TABLE1 TABLE (ID INT)

				INSERT INTO OgrenciHarcama (TUTAR_KR, KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_OGRENCIHARCAMA INTO @ID_TABLE1
				SELECT SUM(TUTAR_KR) ,@TCKIMLIKNO
				FROM #TEMP1

				SET @ID_OGRENCIHARCAMA = (SELECT ID FROM @ID_TABLE1)

				INSERT INTO OgrenciHarcamaDetay(ID_OGRENCIHARCAMA, TC_OGRENCI, TUTAR_KR)
				SELECT @ID_OGRENCIHARCAMA, TCKIMLIKNO, TUTAR_KR
				FROM #TEMP1

				
				SELECT ISNULL((
					SELECT	 ID_OGRENCIHARCAMA, TUTAR_KR
					FROM OgrenciHarcama
					WHERE ID_OGRENCIHARCAMA	= @ID_OGRENCIHARCAMA
					FOR JSON PATH, ROOT('OgrenciHarcama')
				),'{"OgrenciHarcama":[]')

				DROP TABLE IF EXISTS #TEMP1

				
			END

			--IF @ISLEM = 2	--	OGRENCIHARCAMA ÖDEME CEVAP SET		
			--BEGIN
			--
			--	UPDATE OgrenciHarcama SET
			--		CEVAP = @CEVAP
			--	WHERE ID_OGRENCIHARCAMA = @ID_OGRENCIHARCAMA
			--
			--END

			IF @ISLEM = 3	--	OGRENCIHARCAMA ÖDEME CEVAP			
			BEGIN

				SELECT	 ID = SUBSTRING(ID, 5, CHARINDEX('_', ID) - 5)
						,CEVAP	
						,AMOUNT	
				INTO #TEMP3
				FROM OPENJSON(@SQLJSON) 
				WITH (
					ID		VARCHAR(MAX),
					CEVAP	BIT,
					AMOUNT	BIGINT
				)
			
				UPDATE FO SET
					FO.CEVAP	= J.CEVAP,
					FO.TUTAR_KR	= J.AMOUNT
				FROM OgrenciHarcama	FO
				JOIN #TEMP3			J	ON J.ID = FO.ID_OGRENCIHARCAMA

				SET @ID_OGRENCIHARCAMA = (SELECT TOP 1 ID FROM #TEMP3)
				
				IF EXISTS (	SELECT TOP 1 1 
							FROM OgrenciHarcama FO							
							JOIN #TEMP3			J	ON	J.ID	= FO.ID_OGRENCIHARCAMA
							WHERE	FO.CEVAP			= 1 
								AND FO.KANTINGONDERILDI	= 0)
				BEGIN
					EXEC sp_OgrenciHarcamaParaYukleKantin @ID_OGRENCIHARCAMA = @ID_OGRENCIHARCAMA
				END

				DROP TABLE IF EXISTS #TEMP3

			END

			IF @ISLEM = 4	--	OGRENCIHARCAMA ÖDEME CEVAP KONTROL	
			BEGIN
				
				SELECT CEVAP
				FROM OgrenciHarcama 
				WHERE ID_OGRENCIHARCAMA = @ID_OGRENCIHARCAMA
				FOR JSON PATH, INCLUDE_NULL_VALUES

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciHedef]    Script Date: 23.11.2021 15:04:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciHedef]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@PROGRAMKODU		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@PUANTURU			VARCHAR(5)		= NULL,
	@ID_SINAVPUANTURU	INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@OOBP				INT				= NULL,
	@OGRTCKIMLIKNO		VARCHAR(11)		= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,PROGRAMKODU				= @PROGRAMKODU		
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,PUANTURU					= @PUANTURU			
			,ID_SINAVPUANTURU			= @ID_SINAVPUANTURU	
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,SQLJSON					= @SQLJSON			
			,OOBP						= @OOBP				
			,OGRTCKIMLIKNO				= @OGRTCKIMLIKNO		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	
	 
	DECLARE @ID_KADEME3		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

	IF @ID_LOG > 1
	BEGIN

	DECLARE @AKTIFDONEM VARCHAR(4)= (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 

		IF @ISLEM = 1	--	Öğrenci Hedef Ekle						
		BEGIN
			IF NOT EXISTS(SELECT 1 FROM OgrenciHedef WHERE PROGRAMKODU=@PROGRAMKODU and  TCKIMLIKNO= @TCKIMLIKNO and DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) and AKTIF = 1)
			BEGIN
				INSERT INTO [dbo].[OgrenciHedef]
						   ([TCKIMLIKNO]
						   ,[PROGRAMKODU]
						   ,[DONEM])
					 VALUES
						   (@TCKIMLIKNO
						   ,@PROGRAMKODU
						   ,(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1))
			END
		END

		IF @ISLEM = 2	--	Öğrenci Hedef Listele					
		BEGIN
			SELECT 
			(
				SELECT	oh.[PROGRAMKODU]
						,tp.[UNIVERSITE]
						,tp.[FAKULTE]
						,tp.[BOLUM]
						,tp.[BOLUM2]
						,tp.[EGITIMDILI]
						,tp.[UCRETBURS]
						,tp.[IL]
						,tp.[UNIVERSITETURU]
						,tp.[OGRENIMSURESI]
						,tp.[OGRENIMTURU]
						,tp.[PUANTURU]
						,tp.[YIL]
						,tp.[TABANPUAN]
						,tp.[KONTENJAN]
						,tp.[PROGRAMTURU]
						,tp.[SONYGSYERLESTIRME]
						,tp.[OKULBIRINCILIGIKONTENJANI]
						,tp.[YERONCELIKLERI]
						,tp.[ENBUYUKPUAN]
						,tp.[BASARISIRALAMA]
						,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
									FROM UniversiteOzelKosul ok
									WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
									FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
				FROM OgrenciHedef oh
				INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU-- AND tp.YIL = oh.DONEM
				WHERE TCKIMLIKNO=@TCKIMLIKNO  AND TP.YIL = @AKTIFDONEM
					--AND TP.DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
					AND AKTIF=1
				ORDER BY KYE_TARIH DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) JSONDATA
		END

		IF @ISLEM = 3	--	Öğrenci Hedef Sil						
		BEGIN
			UPDATE OgrenciHedef SET AKTIF=0 where TCKIMLIKNO=@TCKIMLIKNO and PROGRAMKODU=@PROGRAMKODU
		END

		IF @ISLEM = 4	--	Öğrenci Hedef Listele Puan Tür Bazlı	
		BEGIN
			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO

			SELECT
			(
				SELECT 
				(
					SELECT	oh.[PROGRAMKODU]
							,tp.[UNIVERSITE]
							,tp.[FAKULTE]
							,tp.[BOLUM]
							,tp.[BOLUM2]
							,tp.[EGITIMDILI]
							,tp.[UCRETBURS]
							,tp.[IL]
							,tp.[UNIVERSITETURU]
							,tp.[OGRENIMSURESI]
							,tp.[OGRENIMTURU]
							,tp.[PUANTURU]
							,tp.[YIL]
							,[TABANPUAN] = ISNULL(tp.[TABANPUAN], 0)
							,tp.[KONTENJAN]
							,tp.[PROGRAMTURU]
							,tp.[SONYGSYERLESTIRME]
							,tp.[OKULBIRINCILIGIKONTENJANI]
							,tp.[YERONCELIKLERI]
							,tp.[ENBUYUKPUAN]
							,tp.[BASARISIRALAMA]
							,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
										FROM UniversiteOzelKosul ok
										WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
										FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
					FROM OgrenciHedef oh
					INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU --and tp.YIL = oh.DONEM
					WHERE TCKIMLIKNO=@OGRTCKIMLIKNO 
						--AND DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
						AND AKTIF=1 
						AND TP.YIL = @AKTIFDONEM
						AND (@PUANTURU = '0' OR tp.PUANTURU= (SELECT KOD FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVPUANTURU=@PUANTURU))
					ORDER BY tp.[TABANPUAN] DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS LIST,
				(
					SELECT COUNT(1) AS TERCIHSAYISI FROM OgrenciHedef WHERE TCKIMLIKNO=@OGRTCKIMLIKNO --and DONEM = @AKTIFDONEM
				) AS TERCIHSAYISI
				FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
			)
			
			--SELECT 
			--(
			--	SELECT	oh.[PROGRAMKODU]
			--			,tp.[UNIVERSITE]
			--			,tp.[FAKULTE]
			--			,tp.[BOLUM]
			--			,tp.[BOLUM2]
			--			,tp.[EGITIMDILI]
			--			,tp.[UCRETBURS]
			--			,tp.[IL]
			--			,tp.[UNIVERSITETURU]
			--			,tp.[OGRENIMSURESI]
			--			,tp.[OGRENIMTURU]
			--			,tp.[PUANTURU]
			--			,tp.[YIL]
			--			,tp.[TABANPUAN]
			--			,tp.[KONTENJAN]
			--			,tp.[PROGRAMTURU]
			--			,tp.[SONYGSYERLESTIRME]
			--			,tp.[OKULBIRINCILIGIKONTENJANI]
			--			,tp.[YERONCELIKLERI]
			--			,tp.[ENBUYUKPUAN]
			--			,tp.[BASARISIRALAMA]
			--			,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
			--						FROM UniversiteOzelKosul ok
			--						WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
			--						FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
			--			,(SELECT COUNT(*) FROM OgrenciHedef WHERE TCKIMLIKNO=@OGRTCKIMLIKNO and DONEM = @AKTIFDONEM) AS TERCIHSAYISI
			--	FROM OgrenciHedef oh
			--	INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU 
			--	WHERE TCKIMLIKNO=@OGRTCKIMLIKNO 
			--		--AND DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
			--		AND AKTIF=1 
			--		AND TP.YIL = @AKTIFDONEM
			--		AND (@PUANTURU = '0' OR tp.PUANTURU= (SELECT KOD FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVPUANTURU=@PUANTURU))
			--	ORDER BY tp.[TABANPUAN] DESC
			--	FOR JSON PATH, INCLUDE_NULL_VALUES
			--) JSONDATA
			
		END

		IF @ISLEM = 5	--	Öğrenci Puan Turu Son Puan				
		BEGIN
			SELECT 
			ISNULL
			(
			(				
				SELECT TOP 1 sos.PUAN + ISNULL((SELECT OOBP*0.6 FROM OgrenciOOBP WHERE TCKIMLIKNO=SO.TCKIMLIKNO),85*0.6) AS PUAN, ISNULL(HP.PUAN,sos.PUAN + ISNULL((SELECT OOBP*0.6 FROM OgrenciOOBP WHERE TCKIMLIKNO=SO.TCKIMLIKNO),85*0.6)) AS HEDEFPUAN FROM SinavOgrenciSonuc sos WITH(NOLOCK)
				INNER JOIN SinavOgrenci so WITH(NOLOCK) ON so.ID_SINAVOGRENCI=sos.ID_SINAVOGRENCI
				INNER JOIN SinavPuanTuru spt WITH(NOLOCK) ON spt.ID_SINAVPUANTURU=sos.ID_SINAVPUANTURU
				INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=so.ID_SINAV
				LEFT JOIN OgrenciHedefPuan HP ON HP.TCKIMLIKNO=SO.TCKIMLIKNO AND HP.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU
				WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO and spt.ID_SINAVPUANTURU = @ID_SINAVPUANTURU AND S.OZEL = 0
				ORDER BY s.SINAVTARIH DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			), '[{"PUAN": 0, "HEDEFPUAN": 560}]') AS PUANLAR
		END

		IF @ISLEM = 6	--	Öğrenci Net Listele						
		BEGIN
			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
			IF @ID_SINAVPUANTURU = 6 -- DİL
			BEGIN
				SELECT
				(
					SELECT
					ISNULL((
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
						FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
						INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
						INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
						LEFT JOIN OgrenciHedefNet HN ON HN.ID_SINAVTURU=4 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
						LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=4 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
						WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
						AND S.OZEL = 0
						AND SO.ID_SINAV=(
											SELECT ID_SINAV FROM
											(
												SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
												INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV AND S.AKTIF=1 AND S.OZEL = 0
												WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO AND S.ID_SINAVTURU=4
														AND DONEM = @AKTIFDONEM
											) XTABLE
											WHERE RN=1
										)
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),
					(
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AYT DİL' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
						FROM Sinav S  WITH(NOLOCK)
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
						INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
						INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
						LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
						where S.ID_SINAVTURU=4 AND S.OZEL = 0 AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=4  AND DONEM = @AKTIFDONEM AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND SUBS.OZEL = 0)
						GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, BOLUMNO, HN.NET, S.AD
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					)
					AS YKSSINAVSONUC,
					ISNULL((
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
						FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
						INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
						INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
						LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=2 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
						LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=2 AND SUBS.ID_SINAV<SO.ID_SINAV AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
						WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
						AND S.OZEL = 0
						AND SO.ID_SINAV=(
											SELECT ID_SINAV FROM
											(
												SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
												INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
												WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
													AND S.ID_SINAVTURU=2 
													AND S.AKTIF=1 
													AND S.OZEL = 0
													AND DONEM = @AKTIFDONEM
											) XTABLE
											WHERE RN=1
										)
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),
					(
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'TYT' AS AD, (COUNT(*)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
						FROM Sinav S WITH(NOLOCK) 
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
						INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
						INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
						LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
						where S.ID_SINAVTURU=2 
						AND S.ID_SINAV = (SELECT MAX(ID_SINAV) FROM Sinav SUBS WHERE ID_SINAVTURU=2 AND DONEM = @AKTIFDONEM AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND SUBS.OZEL = 0) 
						AND S.OZEL = 0
						GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					) AS TYTSINAVSONUC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SINAVSONUC
			END
			ELSE 
			BEGIN
				IF @ID_KADEME3 IN (17) -- 11 İse TYT-AYT VE AAYKS
				BEGIN
					SELECT
					(
						SELECT
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum		 SOC	WITH(NOLOCK)
							INNER JOIN SinavOgrenci			 SO		WITH(NOLOCK) ON SO.ID_SINAVOGRENCI	=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers			 SD		WITH(NOLOCK) ON SD.ID_SINAVDERS		=SOC.ID_SINAVDERS
							INNER JOIN Sinav				 S		WITH(NOLOCK) ON S.ID_SINAV			=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet		 HN		WITH(NOLOCK) ON HN.ID_SINAVTURU		=3 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2	WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=3 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV AND S.AKTIF=1 AND S.OZEL = 0
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO
														AND S.ID_SINAVTURU=3 
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=3 
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=3 
										AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
										AND SUBS.OZEL = 0
										AND DONEM = @AKTIFDONEM) 
							AND S.OZEL = 0
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						)
						AS YKSSINAVSONUC,
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
							INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
							INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=2 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=2 AND SUBS.ID_SINAV<SO.ID_SINAV AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
														AND S.ID_SINAVTURU=2 
														AND S.AKTIF=1 
														AND S.OZEL= 0
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'TYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=2 
							AND S.OZEL = 0
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) 
											WHERE ID_SINAVTURU=2 
											AND DONEM = @AKTIFDONEM
											AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV AND SUBS.OZEL = 0))
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						) AS TYTSINAVSONUC,					
						ISNULL(
							(
								SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
								FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
								INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
								INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
								INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
								LEFT JOIN OgrenciHedefNet HN  WITH(NOLOCK)ON HN.ID_SINAVTURU=6 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
								LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=6 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.SINAVTARIH DESC)
								WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
								AND S.OZEL = 0
								AND SO.ID_SINAV=(
													SELECT ID_SINAV FROM
													(
														SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
														INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
														WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO AND S.ID_SINAVTURU=6 AND S.AKTIF=1 AND S.OZEL = 0
														AND DONEM = @AKTIFDONEM
													) XTABLE
													WHERE RN=1
												)
								ORDER BY SD.BOLUMNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							),
							(
								SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AAYKS' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
								FROM Sinav S  WITH(NOLOCK)
								INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
								INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
								INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
								LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
								where S.ID_SINAVTURU=6 
								AND S.OZEL = 0
								AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=6 
												AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
												AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
												AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
												AND SUBS.OZEL = 0
												AND DONEM = @AKTIFDONEM)
								GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
								ORDER BY SD.BOLUMNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)
						)
						AS AAYKSSINAVSONUC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS SINAVSONUC					
				END
				ELSE IF @ID_KADEME3 IN (18) -- 12 İse TYT-AYT
				BEGIN
					SELECT
					(
						SELECT
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum		 SOC	WITH(NOLOCK)
							INNER JOIN SinavOgrenci			 SO		WITH(NOLOCK) ON SO.ID_SINAVOGRENCI	=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers			 SD		WITH(NOLOCK) ON SD.ID_SINAVDERS		=SOC.ID_SINAVDERS
							INNER JOIN Sinav				 S		WITH(NOLOCK) ON S.ID_SINAV			=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet		 HN		WITH(NOLOCK) ON HN.ID_SINAVTURU		=3 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2	WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=3 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV AND S.AKTIF=1 AND S.OZEL = 0
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO
														AND S.ID_SINAVTURU=3 
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=3 
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=3 
										AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
										AND SUBS.OZEL = 0
										AND DONEM = @AKTIFDONEM) 
							AND S.OZEL = 0
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						)
						AS YKSSINAVSONUC,
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
							INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
							INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=2 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=2 AND SUBS.ID_SINAV<SO.ID_SINAV AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
														AND S.ID_SINAVTURU=2 
														AND S.AKTIF=1 
														AND S.OZEL= 0
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'TYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=2 
							AND S.OZEL = 0
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) 
											WHERE ID_SINAVTURU=2 
											AND DONEM = @AKTIFDONEM
											AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV AND SUBS.OZEL = 0))
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						) AS TYTSINAVSONUC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS SINAVSONUC					
				END
				ELSE -- 9, 10 İse AAYKS
				BEGIN
					SELECT
					(
						SELECT
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
							INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
							INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=6 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=6 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.SINAVTARIH DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
													WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO AND S.ID_SINAVTURU=6 AND S.AKTIF=1 AND S.OZEL = 0
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AAYKS' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=6 
							AND S.OZEL = 0
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=6 
											AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
											AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
											AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
											AND SUBS.OZEL = 0
											AND DONEM = @AKTIFDONEM)
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						)
						AS AAYKSSINAVSONUC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS SINAVSONUC
				END
			END
		END

		IF @ISLEM = 7	--	Öğrenci Hedef Net Ekle					
		BEGIN
			DECLARE @OOOBP INT 
			IF EXISTS (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @OGRTCKIMLIKNO)
			BEGIN
				SET @OOOBP = (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @OGRTCKIMLIKNO)
			END
			ELSE
			BEGIN
				SET @OOOBP =  85
			END	

			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO

			IF @ID_SINAVPUANTURU = 6 -- DİL
			BEGIN
				UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
				INSERT INTO [dbo].[OgrenciHedefNet]
							([TCKIMLIKNO]
							,[ID_SINAVTURU]
							,[TAKMAAD]
							,[NET]
							,[DONEM])
				SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.TYTSINAVSONUC')
				WITH (
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2),
					ID_SINAVTURU INT
				) AS j

				INSERT INTO [dbo].[OgrenciHedefNet]
							([TCKIMLIKNO]
							,[ID_SINAVTURU]
							,[TAKMAAD]
							,[NET]
							,[DONEM])
				SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.YKSSINAVSONUC')
				WITH (
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2),
					ID_SINAVTURU INT
				) AS j

				--PUAN HESAPLA--
				DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (SELECT ID_SINAVPUANTURU FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVTURU in (2,4))
				INSERT INTO [dbo].[OgrenciHedefPuan]
							([TCKIMLIKNO]
							,[ID_SINAVPUANTURU]
							,[PUAN])
				SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,(SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)+ (@OOOBP * 0.6) AS PUAN FROM OPENJSON(@SQLJSON, '$.TYTSINAVSONUC')
				WITH (
					ID_SINAV INT,
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2)
				) AS J
				INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV
				GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

				INSERT INTO [dbo].[OgrenciHedefPuan]
							([TCKIMLIKNO]
							,[ID_SINAVPUANTURU]
							,[PUAN])
				SELECT @OGRTCKIMLIKNO
						,STP.ID_SINAVPUANTURU
						,(
							CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1 AND PUAN>100))
							THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1)) 
							ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
							END
							+ (@OOOBP * 0.6)
						) AS PUAN 
				FROM OPENJSON(@SQLJSON, '$.YKSSINAVSONUC')
				WITH (
					ID_SINAV INT,
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2)
				) AS J
				INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
				GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN
			END
			ELSE
			BEGIN
				IF @ID_KADEME3 IN (17, 18) -- 11, 12 İse TYT-YKS
				BEGIN
					UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
					INSERT INTO [dbo].[OgrenciHedefNet]
								([TCKIMLIKNO]
								,[ID_SINAVTURU]
								,[TAKMAAD]
								,[NET]
								,[DONEM])
					SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.TYTSINAVSONUC')
					WITH (
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2),
						ID_SINAVTURU INT
					) AS j

					INSERT INTO [dbo].[OgrenciHedefNet]
								([TCKIMLIKNO]
								,[ID_SINAVTURU]
								,[TAKMAAD]
								,[NET]
								,[DONEM])
					SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.YKSSINAVSONUC')
					WITH (
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2),
						ID_SINAVTURU INT
					) AS j

					--PUAN HESAPLA--
					DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (SELECT ID_SINAVPUANTURU FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVTURU in (2,3))
					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,(SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN) + (@OOOBP * 0.6) AS PUAN FROM OPENJSON(@SQLJSON, '$.TYTSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO
						  ,STP.ID_SINAVPUANTURU
						  ,(
								CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1 AND PUAN>100))
								THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1)) 
								ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
								END
								+ (@OOOBP * 0.6)
						   ) AS PUAN 
					FROM OPENJSON(@SQLJSON, '$.YKSSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN



					-- 11.SINIF AAYKS
					IF @ID_KADEME3 = 17
					BEGIN
						--UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@TCKIMLIKNO

						INSERT INTO [dbo].[OgrenciHedefNet]
									([TCKIMLIKNO]
									,[ID_SINAVTURU]
									,[TAKMAAD]
									,[NET]
									,[DONEM])
						SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.AAYKSSINAVSONUC')
						WITH (
							TAKMAAD VARCHAR(MAX),
							NET DECIMAL(5,2),
							ARTIS DECIMAL(5,2),
							ID_SINAVTURU INT
						) AS j

						--PUAN HESAPLA--
						DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (9, 11, 12, 13)
						INSERT INTO [dbo].[OgrenciHedefPuan]
									([TCKIMLIKNO]
									,[ID_SINAVPUANTURU]
									,[PUAN])
						SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN AS PUAN FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
						WITH (
							ID_SINAV INT,
							TAKMAAD VARCHAR(MAX),
							NET DECIMAL(5,2),
							ARTIS DECIMAL(5,2)
						) AS J
						INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV
						WHERE STP.ID_SINAVPUANTURU=9 AND SK.ID_SINAVPUANTURU=9
						GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

						INSERT INTO [dbo].[OgrenciHedefPuan]
									([TCKIMLIKNO]
									,[ID_SINAVPUANTURU]
									,[PUAN])
						SELECT @OGRTCKIMLIKNO
							  ,STP.ID_SINAVPUANTURU
							  ,(
									CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9 AND PUAN>100))
									THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9)) 
									ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
									END
									+ (@OOOBP * 0.6)
							   ) AS PUAN 
						FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
						WITH (
							ID_SINAV INT,
							TAKMAAD VARCHAR(MAX),
							NET DECIMAL(5,2),
							ARTIS DECIMAL(5,2)
						) AS J
						INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
						WHERE SK.ID_SINAVPUANTURU<>9
						GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN
					END
				END
				ELSE -- AAYKS
				BEGIN
					UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO

					INSERT INTO [dbo].[OgrenciHedefNet]
								([TCKIMLIKNO]
								,[ID_SINAVTURU]
								,[TAKMAAD]
								,[NET]
								,[DONEM])
					SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.AAYKSSINAVSONUC')
					WITH (
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2),
						ID_SINAVTURU INT
					) AS j

					--PUAN HESAPLA--
					DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (9, 11, 12, 13)
					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,(SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)+ (@OOOBP * 0.6) AS PUAN FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU = SK.ID_SINAVPUANTURU
					WHERE STP.ID_SINAVPUANTURU = 9
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO
						  ,STP.ID_SINAVPUANTURU
						  ,(
								CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9 AND PUAN>100))
								THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9)) 
								ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
								END
								+ (@OOOBP * 0.6)
						   ) AS PUAN 
					FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
					WHERE SK.ID_SINAVPUANTURU IN (11, 12, 13)
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN
				END
			END
			
		END

		IF @ISLEM = 8	--	Öğrenci Kazanım Listele					
		BEGIN
			SELECT  SO.ID_SINAV
				,SD.TAKMAAD AS [DERS.AD]
				,SOCB.DOGRU AS [DERS.DOGRU]
				,SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS [DERS.SORU]
				,CASE WHEN SDU.AD IS NULL THEN CONVERT(VARCHAR(MAX),SA.KOD) ELSE SDU.AD END AS [DERS.UNITE.AD]
				,SUM(case SOC.DURUM when 'D' then 1 else 0 end) as [DERS.UNITE.DOGRU]
				,SUM(case SOC.DURUM when 'Y' then 1 else 0 end) as [DERS.UNITE.YANLIS]
				,SUM(case SOC.DURUM when 'B' then 1 else 0 end) as [DERS.UNITE.BOS]
				,COUNT(1) as [DERS.UNITE.SORU]
			INTO #TEMP1
			FROM SinavOgrenci SO WITH(NOLOCK)
			INNER JOIN SinavOgrenciCevapBolum SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC WITH(NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
			INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN SinavAnahtar SA  WITH(NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
			INNER JOIN v3SinavDersUnite SDU WITH(NOLOCK) on SDU.KOD=SA.KOD
			INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
			WHERE SO.TCKIMLIKNO=@OGRTCKIMLIKNO AND S.AKTIF=1 AND S.OZEL = 0
			GROUP BY SO.ID_SINAV, SD.TAKMAAD, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SDU.AD, SA.KOD
			
			SELECT 
			(
				SELECT 
				[DERS.AD] AS DERSAD, [DERS.UNITE.AD] AS UNITEAD
				,SUM([DERS.UNITE.DOGRU]) AS TD
				,SUM([DERS.UNITE.YANLIS]) AS TY
				,SUM([DERS.UNITE.BOS]) AS TB
				,(SELECT 
						CONVERT(DECIMAL(5,2),CONVERT(DECIMAL(5,2),SUM(DS))/CONVERT(DECIMAL(5,2),SUM(SS))*100.0) 
					FROM (SELECT [DERS.SORU] AS SS, [DERS.DOGRU] DS FROM #TEMP1 SUBT WHERE SUBT.[DERS.AD]=T.[DERS.AD] GROUP BY SUBT.ID_SINAV, [DERS.SORU], [DERS.DOGRU]) ASD
					) 
					AS [DERSYUZDE]
				,CONVERT(DECIMAL(5,2), SUM([DERS.UNITE.DOGRU])/CONVERT(DECIMAL(5,2),SUM([DERS.UNITE.SORU])))*100 AS [UNITEYUZDE]
				FROM
				#TEMP1 T
				GROUP BY [DERS.AD], [DERS.UNITE.AD]
				ORDER BY [DERS.AD], CONVERT(DECIMAL(5,2), SUM([DERS.UNITE.DOGRU])/CONVERT(DECIMAL(5,2),SUM([DERS.UNITE.SORU])))*100 desc
				FOR JSON AUTO
			) J

			DROP TABLE #TEMP1
		END	

		IF @ISLEM = 9	--	OOBP EKLE/GUNCELLE						
		BEGIN
			IF EXISTS (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @TCKIMLIKNO)
			BEGIN
				UPDATE OgrenciOOBP SET OOBP = @OOBP WHERE TCKIMLIKNO = @TCKIMLIKNO
			END
			ELSE
			BEGIN
				INSERT INTO OgrenciOOBP (OOBP, TCKIMLIKNO) VALUES (@OOBP, @TCKIMLIKNO)
			END
		END

		IF @ISLEM = 10	--	OOBP GETİR								
		BEGIN
			IF EXISTS (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @TCKIMLIKNO)
			BEGIN
				SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @TCKIMLIKNO
			END
			ELSE
			BEGIN
				SELECT 85
			END			
		END

		IF @ISLEM = 11	--	PUAN TÜRÜ GETİR							
		BEGIN
			
			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
			IF @ID_KADEME3 IN (17, 18) -- 11, 12 İse TYT-YKS (11. SINIFLAR İÇİN AAYKS)
			BEGIN
				SELECT
				(
					SELECT ID_SINAVPUANTURU,SPT.ID_SINAVTURU,SPT.AD+' ('+ST.KISAAD+')' AD,KOD,MAX_PUAN 
					FROM OgrenciHedef					OH	WITH(NOLOCK)
					INNER JOIN UniversiteTabanPuanlari	U	WITH(NOLOCK)	ON U.PROGRAMKODU=OH.PROGRAMKODU
					INNER JOIN SinavPuanTuru			SPT WITH(NOLOCK)	ON SPT.KOD=U.PUANTURU
					INNER JOIN SinavTuru				ST	WITH(NOLOCK)	ON ST.ID_SINAVTURU	= SPT.ID_SINAVTURU
					WHERE	OH.TCKIMLIKNO=@OGRTCKIMLIKNO 
						AND U.YIL = @AKTIFDONEM and OH.AKTIF = 1
						AND (	@ID_KADEME3 = 17 AND SPT.ID_SINAVTURU IN (2,3,4,6)
							OR	SPT.ID_SINAVTURU IN (2,3,4)
							)

					GROUP BY SPT.ID_SINAVTURU, SPT.ID_SINAVPUANTURU, SPT.AD, SPT.KOD, SPT.MAX_PUAN,ST.KISAAD					
					ORDER BY ST.KISAAD,SPT.AD
					--ORDER BY COUNT(1) DESC
					FOR JSON AUTO
				) PUANTURLER
			END
			ELSE 
			BEGIN
				SELECT
				(
					SELECT SPT.* FROM OgrenciHedef OH WITH(NOLOCK)
					INNER JOIN UniversiteTabanPuanlari U WITH(NOLOCK)	ON U.PROGRAMKODU=OH.PROGRAMKODU
					INNER JOIN SinavPuanTuru SPT		 WITH(NOLOCK)	ON SPT.KOD=U.PUANTURU
					WHERE OH.TCKIMLIKNO=@OGRTCKIMLIKNO AND SPT.ID_SINAVTURU IN (6,4)
						AND U.YIL = @AKTIFDONEM and OH.AKTIF = 1
					GROUP BY SPT.ID_SINAVTURU, SPT.ID_SINAVPUANTURU, SPT.AD, SPT.KOD, SPT.MAX_PUAN
					ORDER BY COUNT(1) DESC
					FOR JSON AUTO
				) PUANTURLER
			END
		END

		IF @ISLEM = 12	--	Veli Öğrenci Hedef Listele				
		BEGIN
			SELECT 
			(
				SELECT	oh.[PROGRAMKODU]
						,tp.[UNIVERSITE]
						,tp.[FAKULTE]
						,tp.[BOLUM]
						,tp.[BOLUM2]
						,tp.[EGITIMDILI]
						,tp.[UCRETBURS]
						,tp.[IL]
						,tp.[UNIVERSITETURU]
						,tp.[OGRENIMSURESI]
						,tp.[OGRENIMTURU]
						,tp.[PUANTURU]
						,tp.[YIL]
						,tp.[TABANPUAN]
						,tp.[KONTENJAN]
						,tp.[PROGRAMTURU]
						,tp.[SONYGSYERLESTIRME]
						,tp.[OKULBIRINCILIGIKONTENJANI]
						,tp.[YERONCELIKLERI]
						,tp.[ENBUYUKPUAN]
						,tp.[BASARISIRALAMA]
						,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
									FROM UniversiteOzelKosul ok
									WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
									FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
				FROM OgrenciHedef oh
				INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU
				WHERE TCKIMLIKNO=@OGRTCKIMLIKNO 
					--AND DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
					AND TP.YIL = @AKTIFDONEM
					AND AKTIF=1
				ORDER BY KYE_TARIH DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) JSONDATA
		END

		IF @ISLEM = 13	--	ÖĞRENCİ KAZANIM LİSTELE YENİ			
		BEGIN
			DECLARE @ID_KADEME3_OGR INT

			SELECT @ID_KADEME3_OGR = ST.ID_KADEME3 
			FROM OkyanusDB.dbo.v3Ogrenci O
			JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
			WHERE O.TCKIMLIKNO = @OGRTCKIMLIKNO

			SELECT  SO.ID_SINAV
				,SD.TAKMAAD AS [DERS.AD]
				,SOCB.DOGRU AS [DERS.DOGRU]
				,SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS [DERS.SORU]
				,CASE WHEN SDU.AD IS NULL THEN CONVERT(VARCHAR(MAX),SA.KOD) ELSE SDU.AD END AS [DERS.UNITE.AD]
				,SA.KOD  AS [DERS.UNITE.KOD]
				,SUM(case SOC.DURUM when 'D' then 1 else 0 end) as [DERS.UNITE.DOGRU]
				,SUM(case SOC.DURUM when 'Y' then 1 else 0 end) as [DERS.UNITE.YANLIS]
				,SUM(case SOC.DURUM when 'B' then 1 else 0 end) as [DERS.UNITE.BOS]
				,COUNT(1) as [DERS.UNITE.SORU]
			INTO #TEMP1X
			FROM SinavOgrenci SO WITH(NOLOCK)
			INNER JOIN SinavOgrenciCevapBolum SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC WITH(NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
			INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN SinavAnahtar SA  WITH(NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
			INNER JOIN v3SinavDersUnite SDU WITH(NOLOCK) on SDU.KOD=SA.KOD
			INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
			WHERE SO.TCKIMLIKNO=@OGRTCKIMLIKNO AND S.AKTIF=1 AND S.OZEL = 0 AND ((@ID_KADEME3_OGR < 15 AND S.DONEM = @AKTIFDONEM) OR @ID_KADEME3_OGR >= 15) -- LİSE DEĞİLSE SADECE MEVCUT DÖNEM
			GROUP BY SO.ID_SINAV, SD.TAKMAAD, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SDU.AD, SA.KOD			

			SELECT
			(
				SELECT	DERSAD = [DERS.AD],
						DERSYUZDE = CONVERT(DECIMAL(5,2),CONVERT(DECIMAL(18,2),SUM([DERS.DOGRU]))/CONVERT(DECIMAL(18,2),SUM([DERS.SORU]))*100.0),
						UNITELER = (
							SELECT	UNITEAD = SUBT.[DERS.UNITE.AD], 
									TD = SUM(SUBT.[DERS.UNITE.DOGRU]), 
									TY = SUM(SUBT.[DERS.UNITE.YANLIS]), 
									TB = SUM(SUBT.[DERS.UNITE.BOS]),
									LINKLIST = ISNULL((SELECT DISTINCT LINK
														FROM OKYANUSDB.DBO.v3SinavDersUniteLink L
														WHERE	L.KOD	= SUBT.[DERS.UNITE.KOD]
															AND L.AKTIF = 1
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									AKILLIBARKODLIST = ISNULL((SELECT DISTINCT LINK = 'https://www.akilliogretim.com/VideoList/' + L.AKILLIOGRETIMBARKODKOD
														FROM Pusulam.dbo.AkilliOgretimBarkod L
														WHERE	L.ALTKONUKOD	= SUBT.[DERS.UNITE.KOD]															
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									MORPAKAZANIMLIST = ISNULL((SELECT MK.KOD
														FROM MorpaKazanim MK
														JOIN MorpaDers MD ON MD.ID_MORPADERS = MK.ID_MORPADERS AND MD.AKTIF = 1
														WHERE	MK.KOD_OKY	= SUBT.[DERS.UNITE.KOD]
															AND MK.AKTIF = 1
															AND MD.ID_KADEME3 = @ID_KADEME3_OGR
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									KAZANIMDOSYALIST = ISNULL((SELECT KD.GUID
														FROM KazanimDosya KD
														WHERE	KD.KOD	= SUBT.[DERS.UNITE.KOD]
															AND KD.AKTIF= 1
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									[UNITEYUZDE] = CONVERT(DECIMAL(5,2), SUM(SUBT.[DERS.UNITE.DOGRU]) / CONVERT(DECIMAL(5,2),SUM(SUBT.[DERS.UNITE.SORU]))) * 100
									
							FROM #TEMP1X SUBT 
							WHERE SUBT.[DERS.AD] = T.[DERS.AD]
							GROUP BY SUBT.[DERS.AD], SUBT.[DERS.UNITE.KOD], SUBT.[DERS.UNITE.AD]
							ORDER BY UNITEYUZDE DESC
							FOR JSON PATH
						) 
				FROM #TEMP1X T
				GROUP BY [DERS.AD]
				ORDER BY DERSYUZDE DESC
				FOR JSON PATH
			) AS J

			DROP TABLE #TEMP1X
		END

		
		IF @ISLEM = 14	--	Sınav Türü Net Grafik Listele
		BEGIN
			SELECT	 B.NET
					,DERSAD				= D.TAKMAAD
					,SIRA				= 1
					,SINAVAD			= V.AD 
			INTO #SINAVNETGRAFIK
			FROM		SinavOgrenci			O
			JOIN		SinavOgrenciCevapBolum	B	ON  B.ID_SINAVOGRENCI	= O.ID_SINAVOGRENCI
			JOIN		SinavDers				D	ON  D.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN		Sinav					V	ON  V.ID_SINAV			= O.ID_SINAV
			WHERE	v.AKTIF			= 1		
				AND v.DURUM			= 2	
				AND O.TCKIMLIKNO	= @OGRTCKIMLIKNO
				AND V.DONEM			= @AKTIFDONEM
				AND V.ID_SINAVTURU	= @ID_SINAVTURU
				AND (OZEL=0 OR 0=1)
			UNION
			SELECT	 NET = SUM(B.NET)
					,DERSAD				= 'Toplam Net'
					,SIRA				= 0
					,SINAVAD			= V.AD 
			FROM		SinavOgrenci			O
			JOIN		SinavOgrenciCevapBolum	B	ON  B.ID_SINAVOGRENCI	= O.ID_SINAVOGRENCI
			JOIN		Sinav					V	ON  V.ID_SINAV			= O.ID_SINAV
			WHERE	v.AKTIF			= 1		
				AND v.DURUM			= 2	
				AND O.TCKIMLIKNO	= @OGRTCKIMLIKNO
				AND V.DONEM			= @AKTIFDONEM
				AND V.ID_SINAVTURU	= @ID_SINAVTURU
				AND (OZEL=0 OR 0=1)
			GROUP BY V.AD

			SELECT (
				SELECT	 NETLIST = ISNULL((
											SELECT * FROM #SINAVNETGRAFIK ORDER BY SINAVAD, DERSAD FOR JSON PATH
										), '[]')
						,DERSLIST = ISNULL((
											SELECT DISTINCT SIRA, DERSAD FROM #SINAVNETGRAFIK where DERSAD<>'Toplam Net' ORDER BY SIRA, DERSAD FOR JSON PATH
										), '[]')
				FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
			)

			DROP TABLE #SINAVNETGRAFIK

		END

		IF @ISLEM = 15	--	SINAV TÜRÜ LİSTELE
		BEGIN
			SELECT
			(
				SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
				FROM SinavTuru				ST	WITH(NOLOCK)
				INNER JOIN Sinav			S	WITH(NOLOCK) ON S.ID_SINAVTURU	= ST.ID_SINAVTURU
				INNER JOIN SinavOgrenci		SO	WITH(NOLOCK) ON SO.ID_SINAV		= S.ID_SINAV
				INNER JOIN v3Ogrenci		O	WITH(NOLOCK) ON O.TCKIMLIKNO	= SO.TCKIMLIKNO
				INNER JOIN vw_SubeGrupSinif	GS	WITH(NOLOCK) ON GS.ID_SINIF		= O.ID_SINIF
				WHERE	SO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
					AND S.AKTIF			= 1 
					AND S.OZEL			= 0
					AND S.DONEM			= @AKTIFDONEM
				FOR JSON PATH
			) AS J
		END
	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	GO
	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciHedefOO]    Script Date: 23.11.2021 15:04:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciHedefOO]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@PROGRAMKODU		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@OGRTCKIMLIKNO		VARCHAR(11)		= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,PROGRAMKODU				= @PROGRAMKODU	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVTURU				= @ID_SINAVTURU
			,SQLJSON					= @SQLJSON		
			,OGRTCKIMLIKNO				= @OGRTCKIMLIKNO
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		 
		DECLARE @ID_KADEME3		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

		IF @ID_LOG > 1
		BEGIN		

		DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)

			IF @ISLEM = 1	--	Öğrenci Sınav Turu Dogru Sayıları
			BEGIN
				DECLARE	 @MAXID		INT	,@SINAVAD1 VARCHAR(MAX), @SINAVTARIH1 DATE
						,@MAXID2	INT	,@SINAVAD2 VARCHAR(MAX)
						
				

				SELECT TOP 1	 @MAXID		= SUBS.ID_SINAV
								,@SINAVAD1	= SUBS.KOD 
								,@SINAVTARIH1 = SUBS.SINAVTARIH 
				FROM		SinavOgrenci	SUBSO	WITH(NOLOCK) 
				INNER JOIN	Sinav			SUBS	WITH(NOLOCK)	ON	SUBS.ID_SINAV	= SUBSO.ID_SINAV 
				WHERE	SUBS.ID_SINAVTURU	= @ID_SINAVTURU 
					AND SUBSO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
					AND SUBS.DONEM			= @AKTIFDONEM
					AND SUBS.AKTIF			= 1 
					AND SUBS.OZEL			= 0 
					AND (SUBS.ID_SINAV = @ID_SINAV OR @ID_SINAV IS NULL OR @ID_SINAV = 0)
				ORDER BY SUBS.SINAVTARIH DESC
				
				SELECT TOP 1 
					 @MAXID2	= SUBS.ID_SINAV
					,@SINAVAD2	= SUBS.KOD 
				FROM SinavOgrenci	SUBSO	WITH(NOLOCK) 
				INNER JOIN Sinav	SUBS	WITH(NOLOCK) ON SUBS.ID_SINAV = SUBSO.ID_SINAV 
				WHERE	SUBS.ID_SINAVTURU	= @ID_SINAVTURU 
					AND SUBSO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
					AND SUBS.AKTIF			= 1 
					AND SUBS.ID_SINAV		<> @MAXID 
					AND SUBS.OZEL			= 0 
					AND SUBS.DONEM			= @AKTIFDONEM
					AND SUBS.SINAVTARIH		<= @SINAVTARIH1
				ORDER BY SUBS.SINAVTARIH DESC

				IF (@MAXID IS NOT NULL)-- AND (@MAXID2 IS NOT NULL)
				BEGIN
					SELECT	 SD.TAKMAAD
							,ISNULL(SUM(SOCB.DOGRU), 0) AS DOGRU
							,(SELECT COUNT(1) FROM SinavAnahtar SA WITH(NOLOCK) WHERE SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK = (SELECT ID_SINAVKITAPCIK FROM SinavKitapcik SK WITH(NOLOCK) WHERE SK.ID_SINAV = SO.ID_SINAV AND SK.AD = 'A')) AS SORUSAYISI
					INTO #BIRONCEKI
					FROM SinavOgrenci					SO		WITH(NOLOCK)
					INNER JOIN SinavDers				SD		WITH(NOLOCK)	ON	SD.ID_SINAV				= SO.ID_SINAV
					LEFT  JOIN SinavOgrenciCevapBolum	SOCB	WITH(NOLOCK)	ON	SOCB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
																				AND SOCB.ID_SINAVDERS		= SD.ID_SINAVDERS 
					LEFT  JOIN OgrenciHedefNet			OHN		WITH(NOLOCK)	ON	OHN.TCKIMLIKNO			= SO.TCKIMLIKNO 
																				AND OHN.ID_SINAVTURU		= @ID_SINAVTURU 
																				AND OHN.TAKMAAD				= SD.TAKMAAD 
																				AND OHN.AKTIF				= 1
					WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
					AND SO.ID_SINAV = @MAXID2
					GROUP BY SD.TAKMAAD, SD.BOLUMNO, SO.ID_SINAV, SD.ID_SINAVDERS
					ORDER BY SD.BOLUMNO
	
					SELECT
					(
						SELECT  SD.TAKMAAD, 
								ISNULL(MAX(O.DOGRU), 0) AS ONCEKIDOGRU, 
								ISNULL(O.SORUSAYISI, 0) AS ONCEKISORUSAYISI, 
								ISNULL(SUM(SOCB.DOGRU), 0) AS DOGRU, 
								(SELECT COUNT(1) FROM SinavAnahtar SA WITH(NOLOCK) WHERE SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK = (SELECT ID_SINAVKITAPCIK FROM SinavKitapcik SK WITH(NOLOCK) WHERE SK.ID_SINAV = SO.ID_SINAV AND SK.AD = 'A')) AS SORUSAYISI, 
								CAST(ISNULL(SUM(OHN.NET), 
								ISNULL(SUM(SOCB.DOGRU), 0)) AS INT) AS HEDEFDOGRU, 
								ISNULL(@SINAVAD1, '-') AS SINAVAD, 
								ISNULL(@SINAVAD2, '-') AS SINAVAD2, 
								CAST(ISNULL(SUM(OHN.NET), 
								ISNULL(SUM(SOCB.DOGRU), 0)) AS INT) - ISNULL(SUM(SOCB.DOGRU), 0) AS ARTIS, 
								@ID_SINAVTURU AS ID_SINAVTURU,
								SO.ID_SINAV 
						FROM		SinavOgrenci			SO	 WITH(NOLOCK)
						INNER JOIN	SinavDers				SD	 WITH(NOLOCK) ON SD.ID_SINAV			= SO.ID_SINAV
						LEFT  JOIN	#BIRONCEKI				O	 WITH(NOLOCK) ON O.TAKMAAD				= SD.TAKMAAD
						INNER JOIN	SinavOgrenciCevapBolum	SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
																			 AND SOCB.ID_SINAVDERS		= SD.ID_SINAVDERS --- left join
						LEFT  JOIN	OgrenciHedefNet			OHN	 WITH(NOLOCK) ON OHN.TCKIMLIKNO			= SO.TCKIMLIKNO 
																			 AND OHN.ID_SINAVTURU		= @ID_SINAVTURU 
																			 AND OHN.TAKMAAD			= SD.TAKMAAD 
																			 AND OHN.AKTIF				= 1
						WHERE	SO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
							AND SO.ID_SINAV		= @MAXID
						GROUP BY SD.TAKMAAD, SD.BOLUMNO, SO.ID_SINAV, SD.ID_SINAVDERS, O.SORUSAYISI
						ORDER BY SD.BOLUMNO
						FOR JSON PATH
					) AS J

					DROP TABLE #BIRONCEKI
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT SD.TAKMAAD, 0 AS ONCEKIDOGRU, 0 AS ONCEKISORUSAYISI, 0 AS DOGRU, (SELECT COUNT(1) FROM SinavAnahtar SA WITH(NOLOCK) WHERE SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK = (SELECT ID_SINAVKITAPCIK FROM SinavKitapcik SK WITH(NOLOCK) WHERE SK.ID_SINAV = S.ID_SINAV AND SK.AD = 'A')) AS SORUSAYISI, 0 AS HEDEFDOGRU, '-' AS SINAVAD, '-' AS SINAVAD2, 0 AS ARTIS, @ID_SINAVTURU AS ID_SINAVTURU, @MAXID AS ID_SINAV
						FROM		Sinav		S  WITH(NOLOCK)
						INNER JOIN	SinavDers	SD WITH(NOLOCK) ON SD.ID_SINAV = S.ID_SINAV
						WHERE S.ID_SINAV = (SELECT MAX(ID_SINAV) FROM Sinav WITH(NOLOCK) WHERE ID_SINAVTURU = @ID_SINAVTURU AND AKTIF = 1 AND OZEL = 0)
						AND  S.OZEL = 0
						FOR JSON PATH
					) AS J
				END
			END	

			IF @ISLEM = 2	--	SINAV TURU GETİR
			BEGIN
				SELECT
				(
					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
					FROM SinavTuru				ST	WITH(NOLOCK)
					INNER JOIN Sinav			S	WITH(NOLOCK) ON S.ID_SINAVTURU	= ST.ID_SINAVTURU
					INNER JOIN SinavOgrenci		SO	WITH(NOLOCK) ON SO.ID_SINAV		= S.ID_SINAV
					INNER JOIN v3Ogrenci		O	WITH(NOLOCK) ON O.TCKIMLIKNO	= SO.TCKIMLIKNO
					INNER JOIN vw_SubeGrupSinif	GS	WITH(NOLOCK) ON GS.ID_SINIF		= O.ID_SINIF
					WHERE	SO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
						AND S.AKTIF			= 1 
						AND S.OZEL			= 0
						AND (	(GS.ID_KADEME3	IN (11,12) AND ST.ID_SINAVTURU = 9) -- 5,6 SINIFLAR NÖS
							OR	(GS.ID_KADEME3	IN (13,14) AND ST.ID_SINAVTURU = 8) -- 7,8 SINIFLAR LGS
							)
					FOR JSON PATH
				) AS J
			END
	
			IF @ISLEM = 3	--	HEDEF EKLE
			BEGIN
				--UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
				delete from [OgrenciHedefNet] WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
				INSERT INTO [dbo].[OgrenciHedefNet]
							([TCKIMLIKNO]
							,[ID_SINAVTURU]
							,[TAKMAAD]
							,[NET]
							,[DONEM])
				SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.DOGRU+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  
				FROM OPENJSON(@SQLJSON)
				WITH (
					TAKMAAD VARCHAR(MAX),
					DOGRU INT,
					ARTIS INT,
					ID_SINAVTURU INT
				) AS j
			END

			IF @ISLEM = 4	--	ÖĞRENCİ SINAVTÜRÜ SINAVLARI
			BEGIN

				SELECT DISTINCT S.ID_SINAV, S.AD, S.KOD
				FROM Sinav			S
				JOIN SinavOgrenci	SO	ON	SO.ID_SINAV	=	S.ID_SINAV					
				WHERE	ID_SINAVTURU	= @ID_SINAVTURU
					AND S.DONEM			= @AKTIFDONEM
					AND SO.TCKIMLIKNO	= @OGRTCKIMLIKNO
					AND S.OZEL			= 0
					AND S.AKTIF			= 1
					AND S.DURUM			= 2

			END 


	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciIzleme]    Script Date: 23.11.2021 15:04:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciIzleme]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMSINAV			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMSINAV					= @DONEMSINAV		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON				 	= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
-----------------------------------------------------------------------------------------------
----------------Net sayıları sınavların soru sayılarına göre normalize ediliyor----------------

-----------INTSNV1037	ENDEKSLEME KAPATILIP NORMAL NETLERİ VE AĞIRLIKLI ORT EKLENDİ-----------
-----------------------------------------------------------------------------------------------


--	http://pusulam/Rapor.aspx?rapor=Sinav.OgrenciIzlemePivot&raporTur=xls&p=32051057542;8A65CF46-5A8A-40D0-95F2-D8F3F5FED778;2017;18;2;[11];[101672];[847,850,851]
--	http://pusulam/Rapor.aspx?rapor=Sinav.OgrenciIzlemePivot&raporTur=xls&p=32051057542;FD2297C4-AF4C-42A6-B6A3-7E0510FB7995;2017;14;8;[427];[102195];[144]

--	EXEC [sp_OgrenciIzleme] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='DD159E6F-D2B5-4A0A-8404-3191C46C529E',@DONEM='2018',@DONEMSINAV='2018',@ID_KADEME3=14,@ID_SINAVTURU=8,@ID_SUBEs='[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,730,447,448,706,444,446,443,309,256,430]',@ID_SINIFs='[0,108378,108377,106603,106604,106578,106580,106582,106646,106435,106427,107264,107270,107266,107271,107272,106136,109352,106310,106311,106312,106358,106360,106361,106819,106820,106821,106549,106550,106218,106219,106898,106899,106701,106700,106699,106366,106367,107502,107501,107500,107163,107164,107695,108862,108531,108534,108533,107396,107397,107497,106517,106518,106519,106520,106804,106805,106806,106807,106808,106834,108404,108410,108412,106478,106479,106480,107365,107366,107358,108941]',@ID_DERSs='[0,141,144,145,146,830,1110]'


--	EXEC [sp_OgrenciIzleme] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='43EFA6B0-F85F-43CA-9092-16C1FF8C1403',@DONEM='2018',@DONEMSINAV='2018',@ID_KADEME3=15,@ID_SINAVTURU=5,@ID_SUBEs='[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,730,447,448,706,444,446,443,309,256,430]',@ID_SINIFs='[0,108614,106609,106611,106643,106644,106645,106642,106664,107214,107210,107209,107211,108612,107251,107253,106137,106138,106139,106140,106765,106299,106300,106335,106334,106333,106822,106823,106824,106825,106551,106552,106553,107548,107549,107552,107561,106688,106689,106368,106369,107513,107505,107504,107503,107179,107180,107181,108550,108551,108552,106161,107496,107354,106854,106853,106852,106851,108341,108342,108343,106481,106482,106483,106484,107368,107376,107374,108942]',@ID_DERSs='[0,804]'

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME ,@IP = @IP
 				
	IF @ID_LOG > 1
	BEGIN
		
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		
				DECLARE @DONEMFARKI INT = CAST(@DONEM AS INT ) - CAST (@DONEMSINAV AS INT)
				IF  (@DONEMFARKI<>0) 
				BEGIN
					DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
					SELECT @ID_KADEME3=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
				END

		IF @ISLEM = 1 OR @ISLEM = 2
		BEGIN
			
			

			DROP TABLE IF EXISTS #TempNet
			DROP TABLE IF EXISTS #TempNet2
			DROP TABLE IF EXISTS #NETLISTE
			DROP TABLE IF EXISTS ##PivotsNet

			DROP TABLE IF EXISTS #TempPuan
			DROP TABLE IF EXISTS ##PivotsPuan
		
			Declare @SQL		as varchar(max)
				,	@Columns	as varchar(max)
				,	@Columns2	as varchar(max)
				,	@Columns3	as varchar(max)
				,	@Columns4	as varchar(max)
				,	@Columns5	as varchar(max)
				,	@Columns6	as varchar(max)

		--DECLARE  @DERSAD varchar(max)='Tümü'		
		--		,@ID_SUBEs		VARCHAR(MAX)= '[427,11]'
		--		,@ID_SINIFs		VARCHAR(MAX)= '[0,101671,101679,101672,101676,101680]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18

			
			SELECT  DISTINCT	SO.TCKIMLIKNO,SO.AD + ' ' + SO.SOYAD ADSOYAD, S.ID_SINAV, S.AD SINAVAD,S.SINAVTARIH, SOS.ID_SINAVPUANTURU, PT.AD PUANTURU,SOS.PUAN, O.ID_SUBE,O.ID_SINIF,VS.AD SUBEAD,VSN.AD SINIFAD
			INTO	#TempPuan
			FROM	Sinav					S
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					VS	ON	VS.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				VSN	ON	VSN.ID_SINIF		= O.ID_SINIF 
			JOIN	v3Donem					D	ON	D.ID_DONEM			= VSN.ID_DONEM
			JOIN	SinavOgrenciSonuc		SOS	ON	SOS.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavPuanTuru			PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			WHERE	S.DURUM			= 2 
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.PUANGIZLE		= 0
				AND S.ID_SINAVTURU	= @ID_SINAVTURU
				AND S.ID_KADEME3	= @ID_KADEME3
				AND S.DONEM			= @DONEMSINAV	
				AND D.KOD			= @DONEM			
				AND (O.ID_SUBE		IN	(SELECT Value FROM OPENJSON(@ID_SUBEs))		OR	@ID_SUBEs	= '[]')
				AND (O.ID_SINIF		IN	(SELECT Value FROM OPENJSON(@ID_SINIFs))	OR	@ID_SINIFs	= '[]')				
			ORDER BY SO.TCKIMLIKNO
					
			INSERT INTO #TempPuan 
			SELECT TCKIMLIKNO, ADSOYAD, 9999, 'Ağırlıklı Ort',DATEADD (YEAR,1, GETDATE()), ID_SINAVPUANTURU, PUANTURU, AVG(PUAN), ID_SUBE, ID_SINIF, SUBEAD, SINIFAD FROM #TempPuan 			
			GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAVPUANTURU, PUANTURU,  ID_SUBE, ID_SINIF, SUBEAD, SINIFAD 
			
			SELECT  SO.TCKIMLIKNO,SO.AD + ' ' + SO.SOYAD ADSOYAD, S.ID_SINAV, S.AD SINAVAD,S.SINAVTARIH, S.ID_SINAVTURU,SD.ID_SINAVDERS ,SD.TAKMAAD, DOGRU, YANLIS, BOS, NET
			, YUZDENET,O.ID_SUBE,O.ID_SINIF,VS.AD SUBEAD,VSN.AD SINIFAD
			INTO	#TempNet
			FROM	Sinav					S
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					VS	ON	VS.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				VSN	ON	VSN.ID_SINIF		= O.ID_SINIF
			JOIN	v3Donem					DN	ON	DN.ID_DONEM			= VSN.ID_DONEM
			JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
			WHERE	S.DURUM			= 2 
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAVTURU	= @ID_SINAVTURU
				AND S.ID_KADEME3	= @ID_KADEME3
				AND S.DONEM			= @DONEMSINAV
				AND DN.KOD			= @DONEM	
				AND (D.ID_DERS		IN	(SELECT Value FROM OPENJSON(@ID_DERSs))		OR	@ID_DERSs	= '[]')
				AND (O.ID_SUBE		IN	(SELECT Value FROM OPENJSON(@ID_SUBEs))		OR	@ID_SUBEs	= '[]')
				AND (O.ID_SINIF		IN	(SELECT Value FROM OPENJSON(@ID_SINIFs))	OR	@ID_SINIFs	= '[]')				
			ORDER BY S.SINAVTARIH
			
			SELECT TAKMAAD,MAX(SS) SS 
			INTO #TempNet2 
			FROM (
				SELECT	 DISTINCT 
						 ID_SINAVDERS
						,TAKMAAD
						,ID_SINAV
						--,SUM(DOGRU+YANLIS+BOS) SS	
						,(select max(sa.SORUNO_A) from SinavAnahtar sa where sa.ID_SINAVDERS = t.ID_SINAVDERS ) SS
				FROM #TempNet t
				--GROUP BY  TCKIMLIKNO,ID_SINAV, TAKMAAD,ID_SINAVDERS		
				) AS TEMP2
			GROUP BY  TAKMAAD

			SELECT DISTINCT TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD, ID_SINAVTURU,ID_SINAVDERS ,T.TAKMAAD, DOGRU, YANLIS, BOS, NET, YUZDENET,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD,SINAVTARIH
				,G.SS
				,NETORT = NET --CAST((CAST(NET AS DECIMAL(8,2))/nullif(SUM(DOGRU+YANLIS+BOS),0) * G.SS) AS DECIMAL(8,2))
			INTO #NETLISTE
			FROM #TempNet T
			JOIN #TempNet2 G ON G.TAKMAAD=T.TAKMAAD
			--GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD, ID_SINAVTURU,ID_SINAVDERS ,T.TAKMAAD, DOGRU, YANLIS, BOS, NET, YUZDENET,ID_SUBE,ID_SINIF,G.SS,SINIFAD,SUBEAD,SINAVTARIH
		UNION ALL			
			SELECT TCKIMLIKNO, ADSOYAD, 0, 'Ağırlıklı Ort', ID_SINAVTURU,0,T.TAKMAAD, 0, 0, 0, 0, 0,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD,DATEADD(YEAR,1,  GETDATE())
				,G.SS
				,NETORT	= CAST((CAST(SUM(NET) AS DECIMAL(8,2))/nullif(SUM(DOGRU+YANLIS+BOS),0)*G.SS	) AS DECIMAL(8,2)) 
			FROM #TempNet T
			JOIN #TempNet2 G ON G.TAKMAAD=T.TAKMAAD
			GROUP BY TCKIMLIKNO, ADSOYAD,  ID_SINAVTURU,T.TAKMAAD, ID_SUBE,ID_SINIF,G.SS,SINIFAD,SUBEAD


PRINT 1
			IF NOT EXISTS (SELECT * FROM #NETLISTE)
			BEGIN
				SELECT SIRA=NULL, TCKIMLIKNO=NULL, ADSOYAD=NULL, ID_SINAVTURU=NULL,TAKMAAD=NULL,ID_SUBE=NULL,ID_SINIF=NULL,SINIFAD=NULL,SUBEAD=NULL, SS=NULL INTO ##PivotsNet				
			END	
			
				
			IF NOT EXISTS (SELECT * FROM #TempPuan)
			BEGIN				
				SELECT TCKIMLIKNO=NULL, ADSOYAD=NULL, ID_SINAV=NULL, SINAVAD=NULL,SINAVTARIH=NULL, ID_SINAVPUANTURU=NULL, PUANTURU=NULL, PUAN=NULL, ID_SUBE=NULL, ID_SINIF=NULL, SUBEAD=NULL, SINIFAD=NULL INTO ##PivotsPuan				
				delete from ##PivotsPuan
			END		
			
PRINT 3
		--	Select distinct ID_SINAV,SINAVTARIH from #NETLISTE 
				-- PIVOT 
				BEGIN
					Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #NETLISTE  ) as b 
					ORDER BY SINAVTARIH 
PRINT 4

					Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX(P2.'+QUOTENAME(ID_SINAV)+') AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #NETLISTE  ) as b 				
					ORDER BY SINAVTARIH 

					Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(CAST(SUM(CAST( CASE WHEN  P2.'+QUOTENAME(ID_SINAV)+' = ''-'' THEN NULL ELSE P2.'+QUOTENAME(ID_SINAV)+' END AS DECIMAL(8,2)) ) AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #NETLISTE  ) as b 				
					ORDER BY SINAVTARIH 

			
					Select @Columns4=Coalesce(@Columns4+',','')+QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #TempPuan  ) as b 
					ORDER BY SINAVTARIH 
			
					--Select @Columns5=Coalesce(@Columns5+',','')+'ISNULL(CAST(MAX(CAST( CASE WHEN P2.'+QUOTENAME(ID_SINAV)+' = ''-'' THEN NULL ELSE P2.'+QUOTENAME(ID_SINAV)+' END AS DECIMAL(8,2) ) AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					--from 
					--	( Select distinct ID_SINAV,SINAVTARIH from #TempPuan  ) as b 				
					--ORDER BY SINAVTARIH 
						
					Select @Columns5=Coalesce(@Columns5+',','')+'ISNULL(CAST(MAX(P2.'+QUOTENAME(ID_SINAV)+') AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #TempPuan  ) as b 				
					ORDER BY SINAVTARIH 

					
PRINT @Columns	
PRINT @Columns2


					Set @SQL='	

					Select 								 
						0 SIRA, TCKIMLIKNO, ADSOYAD, ID_SINAVTURU,TAKMAAD,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD, SS,'+@Columns2+' 
					into ##PivotsNet
					from (
						Select 
							TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD, ID_SINAVTURU,ID_SINAVDERS ,TAKMAAD, DOGRU, YANLIS, BOS, NET, YUZDENET,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD,SINAVTARIH,SS,NETORT
						from #NETLISTE
					) AS S			
					PIVOT (MAX(NETORT) FOR ID_SINAV IN('+@Columns+')) as P2
					GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAVTURU, TAKMAAD,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD, SS

					INSERT INTO ##PivotsNet
					SELECT	1 SIRA, TCKIMLIKNO, ADSOYAD, ID_SINAVTURU, ''TOPLAM'' TAKMAAD,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD, SUM(SS) SS,'+@Columns3+'  
					FROM	##PivotsNet P2
					GROUP BY SIRA, TCKIMLIKNO, ADSOYAD, ID_SINAVTURU, ID_SUBE,ID_SINIF,SINIFAD,SUBEAD
'
				PRINT @SQL
				EXEC (@SQL)
			SET @SQL = '
					Select
						TCKIMLIKNO, ADSOYAD, ID_SINAVPUANTURU, PUANTURU,  ID_SUBE, ID_SINIF, SINIFAD, SUBEAD,'+@Columns5+' 
					into ##PivotsPuan
					from (
						Select 
							TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD,SINAVTARIH, ID_SINAVPUANTURU, PUANTURU, PUAN, ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
						from #TempPuan
					) AS S			
					PIVOT (MAX(PUAN) FOR ID_SINAV IN('+@Columns4+')) as P2
					GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAVPUANTURU, PUANTURU,  ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
				'
				PRINT @SQL
				EXEC (@SQL)
		
				--SELECT * FROM ##PivotsNet
				--ORDER BY ADSOYAD,TAKMAAD
		
				--SELECT * FROM ##PivotsPuan
				--ORDER BY ADSOYAD,PUANTURU

			END

		SELECT TOP 1 ST.KISAAD STKISAAD,K.AD KADEME3,D.ACIKLAMA DONEM
		INTO #BASLIK
		FROM ##PivotsNet	PT
		JOIN SinavTuru		ST ON ST.ID_SINAVTURU	= @ID_SINAVTURU
		JOIN V3KADEME3		K  ON K.ID_KADEME3		= @ID_KADEME3
		JOIN v3AktifDonem	D  ON D.DONEM			= @DONEM	

			IF @ISLEM = 1 -- JSON SEND
			BEGIN
		
					select(
							select * from(
								select 
								(					
									SELECT * FROM ##PivotsNet
									ORDER BY ADSOYAD,SIRA,TAKMAAD
									FOR JSON AUTO
								) as TblNet,
								(									
									Select distinct ID_SINAV,SINAVAD,SINAVTARIH from #NETLISTE order by SINAVTARIH		
									FOR JSON AUTO
								) as TblNetSinav,
								(					
									SELECT * FROM ##PivotsPuan
									ORDER BY ADSOYAD,PUANTURU
									FOR JSON AUTO
								) as TblPuan,
								(	
									Select distinct ID_SINAV,SINAVAD,SINAVTARIH from #TempPuan order by SINAVTARIH		
									FOR JSON AUTO
								) as TblPuanSinav,
								(	
									Select STKISAAD,KADEME3,DONEM from #BASLIK
									FOR JSON AUTO
								) as TblBaslik
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @ISLEM = 2 -- DATASET SEND
			BEGIN
				SELECT * 
				FROM ##PivotsNet
				ORDER BY ADSOYAD, SIRA, TAKMAAD

				;WITH SIRA AS (
				SELECT ID_SINAV,SIRA = CASE WHEN ID_SINAV = 0 THEN 'ORT' ELSE CAST(ROW_NUMBER() OVER (ORDER BY SINAVTARIH) AS VARCHAR) END FROM #NETLISTE GROUP BY ID_SINAV,SINAVTARIH
				)
				Select distinct 
					 N.ID_SINAV
					,SINAVAD =    '('
								+ RIGHT( '000' +  S.SIRA,3 )
								+ ')'
								+ SINAVAD
					,SINAVTARIH 
				from #NETLISTE	N
				JOIN SIRA		S	ON	S.ID_SINAV = N.ID_SINAV
				order by SINAVTARIH		
		
				SELECT * FROM ##PivotsPuan
				ORDER BY ADSOYAD,PUANTURU
				
				Select distinct ID_SINAV,SINAVAD,SINAVTARIH from #TempPuan order by SINAVTARIH		
				
				Select STKISAAD,KADEME3,DONEM from #BASLIK

			END

	
			DROP TABLE IF EXISTS #TempNet
			DROP TABLE IF EXISTS #TempNet2
			DROP TABLE IF EXISTS #NETLISTE
			DROP TABLE IF EXISTS ##PivotsNet

			DROP TABLE IF EXISTS #TempPuan
			DROP TABLE IF EXISTS ##PivotsPuan

			DROP TABLE IF EXISTS #BASLIK

		END		
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciMaddeAnalizi]    Script Date: 23.11.2021 15:05:15 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciMaddeAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,SQLJSON				 	= @SQLJSON		
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,DONEM						= @DONEM			
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
				
		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )
		
		IF (@ISLEM = 1 OR @ISLEM = 2)  -- 
		BEGIN
		
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[]'
			--		,@ID_SINIFs		VARCHAR(MAX)= NULL
			--		,@ID_DERSs		VARCHAR(MAX)= '[]'--'[847,942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
			--		,@ISLEM			INT			= 1		
					
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #DERS

			SELECT DERSAD INTO #DERS from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'
					
			SELECT	DISTINCT SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD,K.AD +' ' +K.SOYAD ADSOYAD
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM,CASE WHEN OC.DURUM = 'D' THEN '+' ELSE OC.CEVAP END OGRENCICEVAP
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM
					, SD.BOLUMNO, SA.SORUNO_A
			INTO	#TEMP_OGRENCI
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Kullanici				K	WITH (NOLOCK)	ON	K.TCKIMLIKNO		= O.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM 
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD				= SO.KITAPCIK 
																AND SD.ID_SINAV			= S.ID_SINAV
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
	  left JOIN		v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND O.DONEM			= @OGRENCIDONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		

				

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 
						(	
							SELECT * FROM #TEMP_OGRENCI 
							ORDER BY TCKIMLIKNO,BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblVeri,
						(								
							SELECT DISTINCT TCKIMLIKNO,ADSOYAD,ID_SUBE,ID_SINIF,SUBEAD,SINIFAD FROM #TEMP_OGRENCI 
							ORDER BY SUBEAD,SINIFAD,ADSOYAD
							FOR JSON AUTO
						) as TblOgrenciList,
						(								
							SELECT DISTINCT BOLUMNO,SORUNO_A,DERSAD,KOD,KAZANIM FROM #TEMP_OGRENCI 
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblSoruList						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE
			BEGIN
				SELECT * FROM #TEMP_OGRENCI 
				ORDER BY TCKIMLIKNO,BOLUMNO,SORUNO_A

				SELECT DISTINCT TCKIMLIKNO,ADSOYAD,ID_SUBE,ID_SINIF,SUBEAD,SINIFAD FROM #TEMP_OGRENCI 
				ORDER BY SUBEAD,SINIFAD,ADSOYAD

				SELECT DISTINCT BOLUMNO,SORUNO_A,DERSAD,KOD,KAZANIM FROM #TEMP_OGRENCI 
				ORDER BY BOLUMNO,SORUNO_A

				SELECT AD AS SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH  FROM Sinav
				WHERE ID_SINAV IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			END


			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #DERS
					

		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	GO
	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciRaporlari]    Script Date: 23.11.2021 15:05:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciRaporlari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SINAVOTURUM		tinyint			= NULL,
	@UNITEKOD			VARCHAR(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SINAVOTURUM				= @SINAVOTURUM	
			,UNITEKOD					= @UNITEKOD		
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
		IF @ISLEM = 1	--	Sınav Listele by Ogrenci
		BEGIN
			--Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 103) as SINAVTARIH, DURUM ,DONEM
			--from Sinav			s
			--join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	
			--where TCKIMLIKNO=@TC_OGRENCI

			select * from
			(
				Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, DONEM
				from Sinav			s
				join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
				join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	
				where s.AKTIF=1 and s.DURUM=2 and so.TCKIMLIKNO=@TC_OGRENCI AND (OZEL=0 OR @OZELSINAVGOR=1)
			) as XTABLE
			order by cast(SINAVTARIH as date) desc
		END
		
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgrenciTakvim]    Script Date: 23.11.2021 15:05:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgrenciTakvim]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@baslangic				VARCHAR(36) 	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM							= @ISLEM		
			,TCKIMLIKNO						= @TCKIMLIKNO	
			,OTURUM							= @OTURUM		
			,ID_MENU						= @ID_MENU	
			,baslangic						= @baslangic	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	Takvim Listele
			BEGIN
				DECLARE @ID_KULLANICI INT = (SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO)
				--DECLARE @OTURUM2 varchar(max) = (SELECT OTURUM FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO)
				DECLARE @DATE date = (select convert(date,@baslangic,103))

				CREATE TABLE #DUYURULAR (ID_ETKINLIK int
										,ID_KULLANICITIP int
										,GRUP varchar(max)
										,ETKINLIK varchar(max)
										,ACIKLAMA varchar(max)
										,BASTARIH varchar(max)
										,BITTARIH varchar(max)
										,ID_KULLANICI int
										,TARIH varchar(max)
										,UZUNLUK int
										,RENK varchar(max)
										,TIP varchar(max)
										,KullaniciTipi varchar(max))
										
				INSERT INTO #DUYURULAR
				EXEC eokul_v2.dbo.spTakvim_EtkinlikListOgrenci @ID_KULLANICI= @ID_KULLANICI, @OTURUM=@OTURUM, @BASTARIH=@DATE, @ID_TAKVIMLER=''

				SELECT
				(
					SELECT * FROM #DUYURULAR
					FOR JSON PATH
				) AS J

				DROP TABLE #DUYURULAR
			END
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OgretmenBilgileri]    Script Date: 23.11.2021 15:05:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OgretmenBilgileri]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
		@IP					VARCHAR(50)	= NULL,

	@TCOGRETMENLIST			VARCHAR(MAX)= NULL

AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TCOGRETMENLIST			= @TCOGRETMENLIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM IN (1, 2)	--	ÖĞRETMEN BİLGİLERİ	
			BEGIN

				DECLARE @AKTIFDONEM VARCHAR(4) = OkyanusDB.dbo.fn_AktifDonem()

				DROP TABLE IF EXISTS #OGRETMENLIST
				SELECT VALUE AS TCKIMLIKNO
				INTO #OGRETMENLIST
				FROM OPENJSON (@TCOGRETMENLIST)

				DROP TABLE IF EXISTS #SINIFLIST
				SELECT S.AD, DO.TC_OGRETMEN
				INTO #SINIFLIST
				FROM eokul_v2..DersOgretmen	DO
				JOIN v3Sinif				S	ON	S.ID_SINIF		= DO.ID_SINIF
				JOIN #OGRETMENLIST			OL	ON	OL.TCKIMLIKNO	= DO.TC_OGRETMEN
				WHERE DO.DONEMKOD	= @AKTIFDONEM

				DROP TABLE IF EXISTS #DERSLIST
				SELECT DISTINCT D.AD, DO.TC_OGRETMEN
				INTO #DERSLIST
				FROM eokul_v2..DersOgretmen DO
				JOIN OkyanusDB..v3Ders		D	ON	D.ID_DERS		= DO.ID_DERS
				JOIN #OGRETMENLIST			OL	ON	OL.TCKIMLIKNO	= DO.TC_OGRETMEN
				WHERE DO.DONEMKOD	= @AKTIFDONEM

				DROP TABLE IF EXISTS #SUBELIST
				SELECT DISTINCT S.AD, SY.TCKIMLIKNO
				INTO #SUBELIST
				FROM v3SubeYetki	SY
				JOIN v3Sube			S	ON	S.ID_SUBE		= SY.ID_SUBE
				JOIN #OGRETMENLIST	OL	ON	OL.TCKIMLIKNO	= SY.TCKIMLIKNO
				WHERE SY.ID_KULLANICITIPI = 3	--	ÖĞRETMEN

				DROP TABLE IF EXISTS #KADEMELIST
				SELECT DISTINCT VK.AD, KK.TCKIMLIKNO
				INTO #KADEMELIST
				FROM OkyanusDB.dbo.v4KullaniciKademe	KK 
				JOIN OkyanusDB.dbo.v3Kademe				VK	ON	VK.ID_KADEME	= KK.ID_KADEME
				JOIN #OGRETMENLIST						OL	ON	OL.TCKIMLIKNO	= KK.TCKIMLIKNO

				DROP TABLE IF EXISTS #DERSSAAT
				SELECT COUNT(DP.TCKIMLIKNO) DERSSAAT, DP.TCKIMLIKNO
				INTO #DERSSAAT
				FROM OkyanusDB.DBO.v3DersProgram	DP 
				JOIN OkyanusDB.DBO.v3Sinif			SN	ON	SN.ID_SINIF		= DP.ID_SINIF
				JOIN #OGRETMENLIST					OL	ON	OL.TCKIMLIKNO	= DP.TCKIMLIKNO
				GROUP BY DP.TCKIMLIKNO

				DROP TABLE IF EXISTS #TEMPTABLO
				SELECT DISTINCT 
					 [AD SOYAD]			= CONCAT_WS(' ', K.AD, K.SOYAD)
					,[TC KİMLİK NO]		= O.TCKIMLIKNO
					,SUBE				= '<div '+ IIF(@ISLEM = 1 , '' , 'style="color: #4ca6d5;font-family: Tahoma;font-size: 9px;font-weight: bold; margin-top:3px;"')+'>' 
											+ STUFF(( SELECT DISTINCT '<div>* ' + S.AD + '</div>' FROM #SUBELIST	S WHERE S.TCKIMLIKNO	= O.TCKIMLIKNO FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,0,'')
										+'</div>'
					,KADEME				= '<div '+ IIF(@ISLEM = 1 , '' , 'style="color: #4ca6d5;font-family: Tahoma;font-size: 9px;font-weight: bold; margin-top:3px;"')+'>' 
											+ STUFF(( SELECT DISTINCT '<div>* ' + S.AD + '</div>' FROM #KADEMELIST	S WHERE S.TCKIMLIKNO	= O.TCKIMLIKNO FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,0,'')
										+'</div>'
					,SINIF				= '<div '+ IIF(@ISLEM = 1 , '' , 'style="color: #4ca6d5;font-family: Tahoma;font-size: 9px;font-weight: bold; margin-top:3px;"')+'>' 
											+ STUFF(( SELECT DISTINCT '<div>* ' + S.AD + '</div>' FROM #SINIFLIST	S WHERE S.TC_OGRETMEN	= O.TCKIMLIKNO FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,0,'')
										+'</div>'
					,DERS				= '<div '+ IIF(@ISLEM = 1 , '' , 'style="color: #4ca6d5;font-family: Tahoma;font-size: 9px;font-weight: bold; margin-top:3px;"')+'>' 
											+ STUFF(( SELECT DISTINCT '<div>* ' + S.AD + '</div>' FROM #DERSLIST	S WHERE S.TC_OGRETMEN	= O.TCKIMLIKNO FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,0,'')
										+'</div>'
					,[TOPLAM DERS SAATİ]= (SELECT ISNULL(S.DERSSAAT,0)  FROM #DERSSAAT	S WHERE S.TCKIMLIKNO	= O.TCKIMLIKNO)
					,EMAIL				= IIF(KB.EMAIL IS NOT NULL OR KB.EMAIL != '',KB.EMAIL,KB.EMAIL2)
					,TELEFON			= PT.TELEFON
					--,SINIFLIST	= ISNULL(( SELECT DISTINCT S.AD FROM #SINIFLIST S WHERE S.TC_OGRETMEN	= O.TCKIMLIKNO FOR JSON PATH, INCLUDE_NULL_VALUES ),'[]')
					--,DERSLIST	= ISNULL(( SELECT DISTINCT S.AD FROM #DERSLIST	S WHERE S.TC_OGRETMEN	= O.TCKIMLIKNO FOR JSON PATH, INCLUDE_NULL_VALUES ),'[]')
					--,SUBELIST	= ISNULL(( SELECT DISTINCT S.AD FROM #SUBELIST	S WHERE S.TCKIMLIKNO	= O.TCKIMLIKNO FOR JSON PATH, INCLUDE_NULL_VALUES ),'[]')
					--,KADEMELIST	= ISNULL(( SELECT DISTINCT S.AD FROM #KADEMELIST S WHERE S.TCKIMLIKNO	= O.TCKIMLIKNO FOR JSON PATH, INCLUDE_NULL_VALUES ),'[]')
				INTO #TEMPTABLO
				FROM v3Ogretmen		O
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO					
				JOIN #OGRETMENLIST	OL	ON	OL.TCKIMLIKNO	= K.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi	KB	WITH (NOLOCK)  ON	KB.TCKIMLIKNO	= K.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3PersonelTelefon	PT	WITH (NOLOCK)  ON	PT.TCKIMLIKNO	= K.TCKIMLIKNO

				IF @ISLEM = 1
					SELECT ISNULL((
						SELECT *
						FROM #TEMPTABLO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
				ELSE					
					SELECT *
					FROM #TEMPTABLO

				DROP TABLE IF EXISTS #SINIFLIST
				DROP TABLE IF EXISTS #DERSLIST
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #KADEMELIST
				DROP TABLE IF EXISTS #DERSSAAT
				DROP TABLE IF EXISTS #OGRETMENLIST
				DROP TABLE IF EXISTS #TEMPTABLO

			END

		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState	INT;
		DECLARE @_MSG			VARCHAR(4000)

		SELECT	@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState	= ERROR_STATE(),
				@_MSG			= ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OkulNetPuanOrtalamalari]    Script Date: 23.11.2021 15:06:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OkulNetPuanOrtalamalari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	--@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM		VARCHAR(4)		= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON				 	= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,OGRENCIDONEM				= @OGRENCIDONEM	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_OkulNetPuanOrtalamalari @TCKIMLIKNO='32051057542',@OTURUM='374EDF4B-850F-49F8-92E3-29B16D759ACD',@OGRENCIDONEM='2018',@DONEM='2018',@ID_SINAVTURU=3,@ID_KADEME3=18,@ID_SINAVs='[439]',@ID_SUBEs='[11,134,200,236]',@ID_SINIFs='[0,106657,106658,106652,106660,106653,106661,106671,107230,107231,107228,107229,109428,107260,106337,106336,106339,106338,106374,107499]'

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
 
	IF @ID_LOG > 1
	BEGIN
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
	
		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrtOkul
		DROP TABLE IF EXISTS ##pivotsOkulNet
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrtOkul2
		DROP TABLE IF EXISTS ##pivotsOkulNet2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS ##GenelOrt2OkulNet
		DROP TABLE IF EXISTS ##pivots2OkulNet
		DROP TABLE IF EXISTS #COL2
		DROP TABLE IF EXISTS #ORT2
		DROP TABLE IF EXISTS #Temp22
		
		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null
-------------------------------------------------------------------------------------------------------------------
		BEGIN
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18

		--SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,ID_SINIF,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS
		--		,O.ID_SUBE,SU.AD SUBEAD
		--INTO	#Temp
		--FROM	Sinav					S	WITH (NOLOCK)
		--JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		--JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO AND O.DONEM = @OGRENCIDONEM
		--JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
		--JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
		--WHERE	S.AKTIF			=	1
		--	AND S.DURUM			=	2
		--	AND S.DONEM			=	@DONEM
		--	AND ID_SINAVTURU	=	@ID_SINAVTURU
		--	AND (S.OZEL = 0		OR	@OZELSINAVGOR = 1)
		--	AND S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
		--	AND (@ID_SINIFs = '' OR	@ID_SINIFs IS NULL OR @ID_SINIFs = '[]' OR ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)))
		
			SELECT	 S.ID_SINAV
					,SINAVAD = S.AD
					,SINAVTARIH
					,O.TCKIMLIKNO
					,O.ID_SINIF
					,VD.ID_DERS
					,SD.TAKMAAD DERSAD
					,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD
			INTO	#Temp
			FROM vw_SinavOgrenciBolum	B	WITH (NOLOCK)	
			JOIN Sinav					S	WITH (NOLOCK)	ON	S.ID_SINAV		= B.ID_SINAV
			JOIN v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO	= B.TCKIMLIKNO AND O.DONEM = @OGRENCIDONEM			
			JOIN SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS	= B.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS		= SD.ID_DERS
			JOIN v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE		= O.ID_SUBE
			WHERE S.AKTIF			=	1
				AND S.DURUM			=	2
				AND S.DONEM			=	@DONEM
				AND ID_SINAVTURU	=	@ID_SINAVTURU
				AND (S.OZEL = 0		OR	@OZELSINAVGOR = 1)
				AND S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
				AND (@ID_SINIFs = '' OR	@ID_SINIFs IS NULL OR @ID_SINIFs = '[]' OR ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)))
			ORDER BY ID_SUBE,TCKIMLIKNO,ID_DERS


			SELECT ID_SINAV,SINAVAD,ID_DERS,DERSAD,SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD
			INTO #Net
			FROM #Temp	T
			GROUP BY ID_DERS,ID_SINAV,SINAVTARIH,SINAVAD,DERSAD,ID_SUBE,SUBEAD
		
		INSERT INTO #Net			
			SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD
			FROM #Net	T
			GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b order by b.SINAVTARIH

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b  order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b order by b.SINAVTARIH



		Set @SQL='	
		
		DROP TABLE IF EXISTS ##pivotsOkulNet
		DROP TABLE IF EXISTS ##GenelOrtOkulNet
			Select 			
				MAX(ID_DERS)ID_DERS,
				ID_SUBE,
				SUBEAD,
				DERSAD,
				999 BOLUMNO,
				'+@Columns2+' 
			into ##pivotsOkulNet
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					DERSAD,
					-- TS,
					NET
				from #Net
			) AS S
			PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY DERSAD,ID_SUBE,SUBEAD			--, '+@Columns+' 		
			
			SELECT MAX(ID_DERS) AS ID_DERS,DERSAD,999 BOLUMNO,'+@Columns3+'
			INTO ##GenelOrtOkulNet
			FROM ##pivotsOkulNet 
			GROUP BY DERSAD					
		'
		PRINT @SQL
		EXEC (@SQL)

		
		BEGIN

			--SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,SO.TCKIMLIKNO
			--INTO	#Temp11
			--FROM	Sinav					S	WITH (NOLOCK)
			--JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV		
			--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			--JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			--WHERE	S.DURUM			= 2
			--	AND S.AKTIF			= 1
			--	AND (OZEL=0 OR @OZELSINAVGOR=1)
			--	AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))

			
			SELECT S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,SB.NET,SB.TCKIMLIKNO
			INTO	#Temp11
			FROM vw_SinavOgrenciBolum	SB	WITH (NOLOCK)	
			JOIN Sinav					S	WITH (NOLOCK)	ON	S.ID_SINAV			= SB.ID_SINAV
			JOIN SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			ORDER BY TCKIMLIKNO,ID_DERS

			SELECT SINAVAD,DERSAD,CAST(AVG(NET) AS decimal(8,2)) AS ORT INTO #ORT FROM #Temp11 
			GROUP BY DERSAD,SINAVAD			
		INSERT INTO #ORT
			SELECT SINAVAD,'TOPLAM',CAST(SUM(NET)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS ORT  FROM #Temp11
			GROUP BY SINAVAD

			SELECT value SINAVAD INTO #COL FROM string_split(@Columns,',')
			WHILE EXISTS (SELECT * FROM #COL)
			BEGIN
				DECLARE @COL VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL ORDER BY 1 DESC)
			SET @SQL = N'
					UPDATE P
					SET	P.'+@COL+' = O.ORT
					FROM ##GenelOrtOkulNet P
					JOIN #ORT	O ON O.DERSAD = P.DERSAD AND ''[''+ O.SINAVAD +'']'' = '''+@COL+'''
				'
				PRINT @SQL
				EXEC (@SQL)
				DELETE FROM #COL WHERE SINAVAD = (SELECT TOP 1 SINAVAD FROM #COL ORDER BY 1 DESC)
			END
		END
		
		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value

		
		DECLARE @ILK_ID_SINAV INT=(SELECT TOP 1 VALUE FROM OPENJSON(@ID_SINAVs) WHERE VALUE > 0)


		SELECT		DISTINCT SD.TAKMAAD , SD.TAKMAAD AS DERSAD,SD.BOLUMNO	BOLUM	
		INTO #BOLUMLER		
		FROM		##pivotsOkulNet			G
		JOIN		Sinav				S	ON	S.ID_SINAV	= @ILK_ID_SINAV
		JOIN		SinavDers			SD	ON	SD.ID_SINAV	= S.ID_SINAV 
		JOIN		eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= SD.ID_DERS
		ORDER BY BOLUM
		
		INSERT INTO #BOLUMLER (TAKMAAD,DERSAD,BOLUM)
		SELECT DISTINCT DERSAD,DERSAD,(SELECT MAX(BOLUM) FROM #BOLUMLER)+ ROW_NUMBER() OVER(ORDER BY DERSAD ASC) FROM ##pivotsOkulNet  P
		WHERE DERSAD !='TOPLAM' AND  DERSAD NOT IN (SELECT DERSAD FROM #BOLUMLER )


		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM ##pivotsOkulNet	G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		
		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM ##GenelOrtOkulNet G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD
		

		END
		------------------------------------------ PUAN
		BEGIN


		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
		
		SELECT DISTINCT	 S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,ID_SINIF
				,O.ID_SUBE,SU.AD SUBEAD
				,ISNULL(PT.ID_SINAVPUANTURU,0)ID_SINAVPUANTURU ,ISNULL(PT.AD,'') PUANTURU
				,ISNULL(SOS.PUAN,0) PUAN
		INTO	#Temp2
		FROM	Sinav					S	WITH (NOLOCK)
		JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO AND O.DONEM = @OGRENCIDONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
   LEFT JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
															AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
   LEFT JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
		WHERE	S.AKTIF			=	1
			AND S.DURUM			=	2
			AND S.DONEM			=	@DONEM
			AND S.ID_SINAVTURU	=	@ID_SINAVTURU
			AND (OZEL = 0		OR	@OZELSINAVGOR=1)
			AND S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			AND (@ID_SINIFs = '' OR	@ID_SINIFs IS NULL OR @ID_SINIFs = '[]' OR ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)))

		
		SELECT ID_SINAV,SINAVAD,SINAVTARIH,CAST(AVG(PUAN) AS DECIMAL(8,2)) PUAN ,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU
		INTO #Net2
		FROM #Temp2	T
		GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU

		SET @Columns	= NULL
		SET @Columns2	= NULL
		SET @Columns3	= NULL

		Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
		from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b order by b.SINAVTARIH

		Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
		from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b order by b.SINAVTARIH

		Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
		from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b order by b.SINAVTARIH
			
			
		if not exists (select 1 from #Net2)
		begin
			Select ID_SUBE=null,SUBEAD=null,ID_SINAVPUANTURU=null,PUANTURU=null into ##pivots2OkulNet

			SELECT ID_SINAVPUANTURU=null,PUANTURU=null INTO ##GenelOrt2OkulNet
		end
			
		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList2
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp2 T ON '['+T.SINAVAD+']'=FN.Value


		Set @SQL='	
			Select 
				ID_SUBE,
				SUBEAD,
				ID_SINAVPUANTURU,
				PUANTURU,
				'+@Columns2+' 
			into ##pivots2OkulNet
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_SUBE,
					SUBEAD,
					ID_SINAVPUANTURU,
					PUANTURU,
					PUAN
				from #Net2
			) AS S
			PIVOT (MAX(PUAN) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY SUBEAD,ID_SUBE,ID_SINAVPUANTURU,PUANTURU
			
			SELECT ID_SINAVPUANTURU,PUANTURU,'+@Columns3+'
			INTO ##GenelOrt2OkulNet
			FROM ##pivots2OkulNet 
			GROUP BY ID_SINAVPUANTURU,PUANTURU

		'
		PRINT @SQL
		EXEC (@SQL)

		
		BEGIN

			SELECT DISTINCT 
					 S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO
					,ISNULL(PT.ID_SINAVPUANTURU,0)ID_SINAVPUANTURU ,ISNULL(PT.AD,'') PUANTURU
					,ISNULL(SOS.PUAN,0) PUAN
			INTO	#Temp22
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
	   LEFT JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
																AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
	   LEFT JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))

			SELECT SINAVAD,PUANTURU,CAST(AVG(PUAN) AS decimal(8,2)) AS ORT INTO #ORT2 FROM #Temp22 
			GROUP BY SINAVAD,PUANTURU
			

			SELECT value SINAVAD INTO #COL2 FROM string_split(@Columns,',')
			WHILE EXISTS (SELECT * FROM #COL2)
			BEGIN
				DECLARE @COL2 VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL2 ORDER BY 1 DESC)
			SET @SQL = N'
					UPDATE P
					SET	P.'+@COL2+' = O.ORT
					FROM ##GenelOrt2OkulNet P
					JOIN #ORT2	O ON O.PUANTURU = P.PUANTURU AND ''[''+ O.SINAVAD +'']'' = '''+@COL2+'''
				'
				PRINT @SQL
				EXEC (@SQL)
				DELETE FROM #COL2 WHERE SINAVAD = @COL2
			END
		END
		
		END

		 select(
				select * from(
						select 
						(					
							SELECT	*
							FROM	##pivotsOkulNet 
							WHERE ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							ORDER BY	BOLUMNO
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t1,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList
							ORDER BY SINAVTARIH
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t2,
						(					
							SELECT		*
							FROM		##pivots2OkulNet 
							WHERE ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t3,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList2
							ORDER BY SINAVTARIH
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t4,
						(					
							SELECT		*
							FROM		##GenelOrtOkulNet 
							ORDER BY	BOLUMNO
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t5,
						(					
							SELECT		*
							FROM		##GenelOrt2OkulNet
							ORDER BY	ID_SINAVPUANTURU DESC
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t6
					) as tablo FOR JSON AUTO
				) as tt



		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrtOkul
		DROP TABLE IF EXISTS ##pivotsOkulNet
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrtOkul2
		DROP TABLE IF EXISTS ##pivotsOkulNet2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS ##GenelOrt2OkulNet
		DROP TABLE IF EXISTS ##pivots2OkulNet
		DROP TABLE IF EXISTS #COL2
		DROP TABLE IF EXISTS #ORT2
		DROP TABLE IF EXISTS #Temp22

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO
	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OkulRapor]    Script Date: 23.11.2021 15:06:28 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OkulRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@IL					VARCHAR(MAX)	= NULL,	 
	@ILCE				VARCHAR(MAX)	= NULL,
	@SUBENO				VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBE					= @ID_SUBE	
			,ID_SINIF					= @ID_SINIF	
			,IL							= @IL			
			,ILCE						= @ILCE		
			,SUBENO						= @SUBENO		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		DECLARE @ID_SINAV INT = 161, @ID_SUBE INT = 11, @IL VARCHAR(MAX) = '', @ILCE VARCHAR(MAX) = '', @SUBENO VARCHAR(MAX) = ''
--		exec dbo.sp_OkulRapor @ID_SINAV = 161, @ID_SUBE = 11

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP 
	
	IF @ID_LOG > 1
	BEGIN
		
		SELECT @IL = IL, @ILCE = ILCE, @SUBENO = RIGHT('000' + SUBENO, 3) FROM v3Sube
		WHERE ID_SUBE = @ID_SUBE

		DECLARE @SINIF VARCHAR(MAX)=(SELECT AD FROM OkyanusDB.dbo.v3SinifTum WHERE ID_SINIF=@ID_SINIF)

		DECLARE @SINAVAD VARCHAR(MAX), @SINAVTARIH VARCHAR(MAX)
		SELECT @SINAVAD = AD, @SINAVTARIH = CONVERT(VARCHAR(10), SINAVTARIH, 104)
		FROM Sinav
		WHERE ID_SINAV = @ID_SINAV


		--0--
		SELECT SUBEAD = AD, SUBEIL = IL, SUBEILCE = ILCE, SINAVAD = @SINAVAD, SINAVTARIH = @SINAVTARIH
		FROM v3Sube
		WHERE ID_SUBE = @ID_SUBE
		--1--
		SELECT ID_SINAVDERS, TAKMAAD, BOLUMNO
		FROM SinavDers
		WHERE ID_SINAV = @ID_SINAV
		ORDER BY BOLUMNO


		SELECT  ID_SINAV, SO.TCKIMLIKNO, ISNULL(K.AD, SO.AD) AS AD, ISNULL(K.SOYAD, SO.SOYAD) AS SOYAD, KITAPCIK, SINIF, ID_SINAVDOSYA, ID_SINAVOPTIKTEMP, SB.IL, SB.ILCE, SO.SUBENO
		INTO #SinavOgrenci 
		FROM		SinavOgrenci				SO
		INNER JOIN	v3Sube						SB	ON CAST(SB.SUBENO AS INT)	= CAST(SO.SUBENO AS INT)
		LEFT JOIN	OkyanusDB.dbo.v3Kullanici	K	ON K.TCKIMLIKNO				= SO.TCKIMLIKNO
		WHERE SO.ID_SINAV = @ID_SINAV AND SO.TCKIMLIKNO<>''


		SELECT DISTINCT SO.TCKIMLIKNO, SO.AD, SO.SOYAD, SB.DOGRU, SB.YANLIS, SB.BOS, SB.NET, SD.ID_SINAVDERS, SD.TAKMAAD, SO.IL, SO.ILCE, SO.SUBENO, SD.BOLUMNO, SO.SINIF, YUZDEDOGRU
		INTO #SinavOgrenciCevapBolum 
		FROM #SinavOgrenci					SO
		--INNER JOIN SinavOgrenciCevapBolum	SB	ON SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI		
		INNER JOIN [dbo].[vw_SinavOgrenciBolum]	SB	ON SB.TCKIMLIKNO		= SO.TCKIMLIKNO AND SB.ID_SINAV = @ID_SINAV
		INNER JOIN SinavDers				SD	ON SD.ID_SINAVDERS		= SB.ID_SINAVDERS

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
		INTO #DersGenelort 
		FROM #SinavOgrenciCevapBolum	SB
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,IL
		INTO #DersIlort 
		FROM #SinavOgrenciCevapBolum	SB
		WHERE IL = @IL
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, IL


		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,IL
			,ILCE
		INTO #DersIlceort FROM #SinavOgrenciCevapBolum	SB
		WHERE IL = @IL AND ILCE = @ILCE
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, IL, ILCE

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,SUBENO
		INTO #DersSubeort FROM #SinavOgrenciCevapBolum	SB
		--WHERE SUBENO = @SUBENO
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, SUBENO

		--2--
		-- Okul Net Oratalaması
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'Genel'
		FROM #DersGenelort
	UNION ALL
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'İl'
		FROM #DersIlort
	UNION ALL
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'İlçe'
		FROM #DersIlceort
	UNION ALL
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'Okul'
		FROM #DersSubeort
		WHERE SUBENO = @SUBENO
		ORDER BY SIRALAMA, BOLUMNO



--SELECT * INTO #TEMP_PUANLAR FROM [dbo].[fn_SinavOgrenciToplamDYBN](@ID_SINAV)


		-- Puanlar
		SELECT DISTINCT SO.TCKIMLIKNO, SO.AD, SO.SOYAD, SS.PUAN, SP.ID_SINAVPUANTURU, SP.KOD, SO.SINIF, SO.IL, SO.ILCE, SO.SUBENO, SS.GENELSIRA, SS.ILSIRA, SS.ILCESIRA, SS.OKULSIRA, SS.SINIFSIRA
		INTO #SinavOgrenciPuan 
		FROM #SinavOgrenci						SO
		INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SS	ON	SS.TCKIMLIKNO		= SO.TCKIMLIKNO 
													AND SS.ID_SINAV			= @ID_SINAV
		INNER JOIN SinavPuanTuru				SP	ON	SP.ID_SINAVPUANTURU	= SS.ID_SINAVPUANTURU

		-- Puan Genel Ort
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanGenelOrt FROM #SinavOgrenciPuan
		GROUP BY ID_SINAVPUANTURU, KOD

		-- Puan İl Ort
		SELECT ID_SINAVPUANTURU, KOD, IL, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanIlOrt FROM #SinavOgrenciPuan
		WHERE IL = @IL
		GROUP BY ID_SINAVPUANTURU, KOD, IL

		-- Puan İlçe Ort
		SELECT ID_SINAVPUANTURU, KOD, IL, ILCE, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanIlceOrt FROM #SinavOgrenciPuan
		WHERE IL = @IL AND ILCE = @ILCE
		GROUP BY ID_SINAVPUANTURU, KOD, IL, ILCE

		-- Puan Şube Ort
		SELECT ID_SINAVPUANTURU, KOD, SUBENO, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanSubeOrt FROM #SinavOgrenciPuan
		GROUP BY ID_SINAVPUANTURU, KOD, SUBENO


		--3--
		-- Okul Puan Ortalaması
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'Genel'
		FROM #SinavOgrenciPuanGenelOrt
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'İl'
		FROM #SinavOgrenciPuanIlOrt
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'İlçe'
		FROM #SinavOgrenciPuanIlceOrt
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'Okul'
		FROM #SinavOgrenciPuanSubeOrt
		WHERE SUBENO = @SUBENO
		ORDER BY SIRALAMA, ID_SINAVPUANTURU

		--4--
		-- Sınıf Net Ortalamaları
		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,SINIF
		FROM #SinavOgrenciCevapBolum	SB
		WHERE SUBENO = @SUBENO
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, SUBENO, SINIF
		ORDER BY SINIF, BOLUMNO

		--5--
		-- Sınıf Puan Ortalamaları
		SELECT ID_SINAVPUANTURU, KOD, SINIF, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO
		GROUP BY ID_SINAVPUANTURU, KOD, SINIF
		ORDER BY SINIF, ID_SINAVPUANTURU


		--6--
		-- Ders Başarı Oranları
		SELECT 
			 BASARIORAN	= CONVERT(DECIMAL(18, 2), AVG(CAST(YUZDEDOGRU	AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
		FROM #SinavOgrenciCevapBolum	SB
		WHERE SUBENO = @SUBENO
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO
		ORDER BY BOLUMNO


		-- Toplam Netler
		SELECT SUBENO, SINIF, TCKIMLIKNO, AD, SOYAD, ID_SINAVDERS = 0, TAKMAAD = 'Toplam', BOLUMNO = 99, DOGRU = SUM(DOGRU), YANLIS = SUM(YANLIS), BOS = SUM(BOS), NET = SUM(NET)
		INTO #ToplamNet FROM #SinavOgrenciCevapBolum
		GROUP BY SUBENO, SINIF, TCKIMLIKNO, AD, SOYAD

		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA = DENSE_RANK() OVER (ORDER BY NET DESC), SIRALAMA = 'Genel'
		INTO #ToplamNetGenel FROM #ToplamNet

		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA = DENSE_RANK() OVER (ORDER BY NET DESC), SIRALAMA = 'Şube'
		INTO #ToplamNetSube FROM #ToplamNet
		WHERE SUBENO = @SUBENO

		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA = DENSE_RANK() OVER (PARTITION BY SINIF ORDER BY NET DESC), SIRALAMA = 'Sınıf'
		INTO #ToplamNetSinif FROM #ToplamNet
		WHERE SUBENO = @SUBENO


		-- Öğrenci Okul Ders Ortalamaları
		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,SUBENO
			,ID_SINAVDERS
			,TAKMAAD
			,BOLUMNO
		INTO #OkulDersOrtalama FROM #SinavOgrenciCevapBolum
		WHERE SUBENO = @SUBENO
		GROUP BY ID_SINAVDERS, TAKMAAD, SUBENO, BOLUMNO

		--7--
		-- Toplam Nete Göre Öğrenci Listesi
		-- Toplam Netler
		SELECT SUBENO, SINIF, TCKIMLIKNO, AD, SOYAD, ID_SINAVDERS, TAKMAAD, BOLUMNO, DOGRU, YANLIS, BOS, NET, ONCELIK = 2, SIRA = 0
		FROM #ToplamNet
		WHERE SUBENO = @SUBENO
		UNION ALL
		-- Öğrenci Listesi
		SELECT S.SUBENO, S.SINIF, S.TCKIMLIKNO, S.AD, S.SOYAD, S.ID_SINAVDERS, S.TAKMAAD, S.BOLUMNO, S.DOGRU, S.YANLIS, S.BOS, S.NET, ONCELIK = 1, T.SIRA
		FROM #SinavOgrenciCevapBolum	S
		INNER JOIN #ToplamNetGenel		T	ON T.TCKIMLIKNO = S.TCKIMLIKNO
		WHERE S.SUBENO = @SUBENO
		UNION ALL
		-- Okul Ortalamaları
		SELECT SUBENO, SINIF = '', TCKIMLIKNO = '', AD = 'OKUL', SOYAD = 'ORTALAMALARI', ID_SINAVDERS, TAKMAAD, BOLUMNO, DOGRU, YANLIS, BOS, NET, ONCELIK = 3, SIRA = 0
		FROM #OkulDersOrtalama
		ORDER BY ONCELIK, SIRA, TCKIMLIKNO, BOLUMNO

		--8--
		-- Toplam Nete Göre Öğrenci Listesi Sıralama
		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA, SIRALAMA
		FROM #ToplamNetGenel
		WHERE SUBENO = @SUBENO
		UNION ALL
		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA, SIRALAMA
		FROM #ToplamNetSube
		WHERE SUBENO = @SUBENO
		UNION ALL
		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA, SIRALAMA
		FROM #ToplamNetSinif
		WHERE SUBENO = @SUBENO

		--9--
		-- Okul Puan Öğrenci Listesi
		SELECT *
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO
		ORDER BY IL, ILCE, SINIF, TCKIMLIKNO, ID_SINAVPUANTURU

		--10--
		-- Okul Puan Ortalamaları
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT))), SIRALAMA = 'Genel'
		FROM #SinavOgrenciPuan
		GROUP BY ID_SINAVPUANTURU, KOD
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT))), SIRALAMA = 'İl'
		FROM #SinavOgrenciPuan
		WHERE IL = @IL
		GROUP BY ID_SINAVPUANTURU, KOD
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT))), SIRALAMA = 'Okul'
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO
		GROUP BY ID_SINAVPUANTURU, KOD
		ORDER BY SIRALAMA, ID_SINAVPUANTURU

		--11--
		-- Sınıf Puan Ortalamaları
		SELECT ID_SINAVPUANTURU, KOD, SINIF, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT)))
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO--  AND (@SINIF IS NULL OR SINIF=@SINIF)
		GROUP BY ID_SINAVPUANTURU, KOD, SINIF

		SELECT SA.KOD, SD.ID_SINAVDERS, SD.TAKMAAD, SA.SORUNO
		INTO #UniteKod FROM Sinav	S
		INNER JOIN SinavDers		SD	ON SD.ID_SINAV			= S.ID_SINAV
		INNER JOIN SinavAnahtar		SA	ON SA.ID_SINAVDERS		= SD.ID_SINAVDERS
		INNER JOIN SinavKitapcik	SK	ON SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
		WHERE S.ID_SINAV = @ID_SINAV AND SK.AD = 'A'

		--12--
		-- Okul Konu Analizi
		SELECT 		
				 SD.ID_SINAVDERS
				,SD.TAKMAAD
				,SD.BOLUMNO
				,SDUKONU.AD AS UNITE
				,SDU.AD AS KONU
				,DOGRU	= SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END)
				,YANLIS	= SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END)
				,BOS	= SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END)
				,TOPLAM	= COUNT(OS.DURUM)
				,SS		= (SELECT COUNT(1) FROM #UniteKod U WHERE U.KOD = SDU.KOD)
				,DOGRU_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,YANLIS_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,BOS_YUZDE		= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
		FROM #SinavOgrenci					SO
		JOIN [dbo].[vw_SinavOgrenciSoru]	OS	ON	OS.ID_SINAV		= SO.ID_SINAV
												AND OS.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN SinavDers						SD	ON	SD.ID_SINAVDERS = OS.ID_SINAVDERS
		JOIN v3SinavDersUnite				SDU	ON SDU.KOD			= OS.KOD
		JOIN v3SinavDersUnite			SDUKONU	ON SDUKONU.KOD		= SUBSTRING(OS.KOD,1,9)
		WHERE SO.SUBENO = @SUBENO
		GROUP BY SD.ID_SINAVDERS, SD.TAKMAAD, SD.BOLUMNO, SDUKONU.AD, SDU.KOD, SDU.AD
		ORDER BY SD.BOLUMNO,SDU.KOD

		--13--
		-- Okul Sınıf Konu Analizi
		SELECT 		
				SD.ID_SINAVDERS
				,SD.TAKMAAD
				,SD.BOLUMNO
				,SDUKONU.AD AS UNITE
				,SDU.AD AS KONU
				,DOGRU	= SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END)
				,YANLIS	= SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END)
				,BOS	= SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END)
				,TOPLAM	= COUNT(OS.DURUM)
				,SS		= (SELECT COUNT(1) FROM #UniteKod U WHERE U.KOD = SDU.KOD)
				,DOGRU_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,YANLIS_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,BOS_YUZDE		= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,SO.SINIF
		FROM #SinavOgrenci					SO
		JOIN [dbo].[vw_SinavOgrenciSoru]	OS	ON	OS.ID_SINAV		= SO.ID_SINAV
												AND OS.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN SinavDers						SD	ON	SD.ID_SINAVDERS = OS.ID_SINAVDERS
		JOIN v3SinavDersUnite				SDU	ON SDU.KOD			= OS.KOD
		JOIN v3SinavDersUnite			SDUKONU	ON SDUKONU.KOD		= SUBSTRING(OS.KOD,1,9)
		WHERE SO.SUBENO = @SUBENO
		GROUP BY SD.ID_SINAVDERS, SD.TAKMAAD, SD.BOLUMNO, SDUKONU.AD, SDU.KOD, SDU.AD, SO.SINIF
		ORDER BY SO.SINIF,SD.BOLUMNO,SDU.KOD
		


		DROP TABLE #UniteKod


		-- Okul Soru Frekansı
					SELECT SD.TAKMAAD, SA.SORUNO_A, SA.SORUNO, SA.CEVAP, SK.AD, CASE WHEN SSI.ID_SINAVSORUDUZENLE IS NULL THEN 0 ELSE 1 END AS HATALI, SDU.AD AS KAZANIM
					INTO #CEVAPLAR 
					FROM Sinav S
					INNER JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV
					INNER JOIN SinavDers SD ON SD.ID_SINAV=S.ID_SINAV
					INNER JOIN SinavAnahtar SA ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
					LEFT JOIN SinavSoruIslem SSI ON SSI.ID_SINAVANAHTAR=SA.ID_SINAVANAHTAR 
					LEFT JOIN v3SinavDersUnite SDU ON SDU.KOD=SA.KOD
					WHERE S.ID_SINAV = @ID_SINAV
					ORDER BY SD.BOLUMNO, SK.AD, SA.SORUNO_A

					SELECT 		
							SD.BOLUMNO
							,SD.TAKMAAD
							,C.SORUNO_A AS SORU
							,C.CEVAP AS DC
							,SUM(CASE WHEN OS.CEVAP='A' THEN 1 ELSE 0 END) AS A 
							,SUM(CASE WHEN OS.CEVAP='B' THEN 1 ELSE 0 END) AS B
							,SUM(CASE WHEN OS.CEVAP='C' THEN 1 ELSE 0 END) AS C
							,SUM(CASE WHEN OS.CEVAP='D' THEN 1 ELSE 0 END) AS D
							,SUM(CASE WHEN OS.CEVAP='E' THEN 1 ELSE 0 END) AS E
							,SUM(CASE WHEN OS.CEVAP='' THEN 1 ELSE 0 END) AS BOS
							,SUM(CASE WHEN OS.CEVAP IS NOT NULL THEN 1 ELSE 0 END) AS TOPLAM
							,C.HATALI
							,C.KAZANIM
					INTO #ANALIZ
					FROM #SinavOgrenci					SO
					JOIN [dbo].[vw_SinavOgrenciSoru]	OS	ON	OS.ID_SINAV		= SO.ID_SINAV
															AND OS.TCKIMLIKNO	= SO.TCKIMLIKNO
					JOIN SinavDers						SD	ON	SD.ID_SINAVDERS = OS.ID_SINAVDERS
					JOIN #CEVAPLAR						C	ON C.TAKMAAD=SD.TAKMAAD AND C.SORUNO_A=OS.SORUNO_A AND C.AD=SO.KITAPCIK
					WHERE SO.SUBENO = @SUBENO
					GROUP BY  SD.BOLUMNO, SD.TAKMAAD, C.SORUNO_A, C.CEVAP, C.HATALI, C.KAZANIM

					--14--
					SELECT BOLUMNO, TAKMAAD, SORU, DC, 
			
					A_ADET	= A,
					A_ORAN	= CAST((CAST(A AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					B_ADET	= B,
					B_ORAN	= CAST((CAST(B AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					C_ADET	= C,
					C_ORAN	= CAST((CAST(C AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					D_ADET	= D,
					D_ORAN	= CAST((CAST(D AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					E_ADET	= E,
					E_ORAN	= CAST((CAST(E AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					BOS_ADET	= BOS,
					BOS_ORAN	= CAST((CAST(BOS AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					HATALI, KAZANIM FROM #ANALIZ
					ORDER BY BOLUMNO, SORU


					DROP TABLE IF EXISTS #CEVAPLAR
					DROP TABLE IF EXISTS #ANALIZ	



		DECLARE @ID_SINAVTUR INT = (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV)

		SELECT DISTINCT SO.ID_SINAV, TCKIMLIKNO, SINAVAD = S.AD, SINAVTARIH = CONVERT(VARCHAR(10), S.SINAVTARIH, 104), DT = S.SINAVTARIH
		INTO #SinavOgrenciTum FROM SinavOgrenci	SO
		INNER JOIN v3Sube						SB	ON CAST(SB.SUBENO AS INT) = CAST(SO.SUBENO AS INT)
		INNER JOIN Sinav						S	ON S.ID_SINAV = SO.ID_SINAV
		WHERE S.AKTIF=1 
		AND S.ID_SINAVTURU = @ID_SINAVTUR 
		AND SO.SUBENO = @SUBENO 
		AND S.ID_KADEME3=(SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV)
		AND S.DONEM=(SELECT DONEM FROM Sinav WHERE ID_SINAV=@ID_SINAV)


		SELECT DISTINCT SO.ID_SINAV, SO.SINAVAD, SO.SINAVTARIH, DT/*, SO.ID_SINAVOGRENCI*/, SO.TCKIMLIKNO, SB.DOGRU, SB.YANLIS, SB.BOS, SB.NET, SD.ID_SINAVDERS, SD.TAKMAAD, SD.BOLUMNO, YUZDEDOGRU
		INTO #SinavOgrenciCevapBolumTum FROM #SinavOgrenciTum					SO
		--INNER JOIN SinavOgrenciCevapBolum	SB	ON SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		INNER JOIN [dbo].[vw_SinavOgrenciBolum] SB ON SB.TCKIMLIKNO		= SO.TCKIMLIKNO AND SB.ID_SINAV = SO.ID_SINAV
		INNER JOIN SinavDers				SD	ON SD.ID_SINAVDERS		= SB.ID_SINAVDERS

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,ID_SINAV
			,SINAVAD
			,SINAVTARIH
			,DT
			,KATILIM=(SELECT COUNT(1) FROM (SELECT SO.TCKIMLIKNO FROM SinavOgrenci SO WHERE SO.ID_SINAV=SB.ID_SINAV AND SO.SUBENO=@SUBENO GROUP BY SO.TCKIMLIKNO) AS SUBTABLE)
		INTO #DersGenelortTum FROM #SinavOgrenciCevapBolumTum	SB
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, ID_SINAV, SINAVAD, SINAVTARIH, DT


		--15--
		SELECT * 
		FROM #DersGenelortTum
		ORDER BY DT, ID_SINAV, BOLUMNO



		-- Puanlar
		SELECT DISTINCT SO.TCKIMLIKNO, SS.PUAN, SS.ID_SINAVPUANTURU, SP.KOD, SO.ID_SINAV, SO.SINAVAD, SO.SINAVTARIH, SO.DT
		INTO #SinavOgrenciPuanTum		
		FROM #SinavOgrenciTum			SO
		INNER JOIN [dbo].[vw_SinavOgrenciPuan] SS ON SS.TCKIMLIKNO = SO.TCKIMLIKNO AND SS.ID_SINAV = SO.ID_SINAV
		INNER JOIN SinavPuanTuru		SP	ON SP.ID_SINAVPUANTURU	= SS.ID_SINAVPUANTURU

		-- Puan Genel Ort
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT))), ID_SINAV, SINAVAD, SINAVTARIH, DT
		INTO #SinavOgrenciPuanGenelOrtTum FROM #SinavOgrenciPuanTum
		GROUP BY ID_SINAVPUANTURU, KOD, ID_SINAV, SINAVAD, SINAVTARIH, DT

		--16--
		SELECT *
		FROM #SinavOgrenciPuanGenelOrtTum
		ORDER BY DT, ID_SINAV, ID_SINAVPUANTURU

		--17--
		-- KATILIM
		SELECT 
			(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO=@SUBENO) AS SUBE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL AND S2.ILCE=S.ILCE
																											WHERE S.ID_SUBE=@ID_SUBE)) AS ILCE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL
																											WHERE S.ID_SUBE=@ID_SUBE)) AS IL
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV) AS GENEL

		--18--
		select count(1) from Sinav s
		inner join SinavPuanTuru spt on spt.ID_SINAVTURU=s.ID_SINAVTURU
		where ID_SINAV=@ID_SINAV

		SELECT SD.BOLUMNO, SD.TAKMAAD, MAX(SA.SORUNO) AS SS 
		INTO #DERSSORUSAYI
		FROM SinavDers SD 
		INNER JOIN SinavAnahtar SA ON SA.ID_SINAVDERS = SD.ID_SINAVDERS
		WHERE SD.ID_SINAV = @ID_SINAV
		GROUP BY SD.BOLUMNO, SD.TAKMAAD
		ORDER BY SD.BOLUMNO
		
		--19--
		SELECT SB.ID_SUBE, SB.AD, O.TAKMAAD + '@@S.S=' + CAST(SS.SS AS VARCHAR) AS TAKMAAD, O.BOLUMNO, O.NET, SS.SS
		FROM #DersSubeort O
		INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.SUBENO = CAST(O.SUBENO AS INT)
		INNER JOIN #DERSSORUSAYI SS ON SS.BOLUMNO = O.BOLUMNO
		ORDER BY SB.AD, O.BOLUMNO

		--20--
		SELECT SB.ID_SUBE, SB.AD, O.KOD, O.PUAN
		FROM #SinavOgrenciPuanSubeOrt O
		INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.SUBENO = CAST(O.SUBENO AS INT)
		ORDER BY SB.AD, O.ID_SINAVPUANTURU

		DECLARE @PUANTURSAY INT = 0
		--	BARAJ	--
		SELECT @PUANTURSAY = COUNT(1) FROM Sinav S
		INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU = S.ID_SINAVTURU
		WHERE S.ID_SINAV = @ID_SINAV

		SELECT TCKIMLIKNO
		INTO #150BARAJ
		FROM #SinavOgrenciPuan SOP
		WHERE SOP.PUAN < 150 AND SOP.SUBENO = @SUBENO
		GROUP BY SOP.TCKIMLIKNO
		HAVING COUNT(1) = @PUANTURSAY

		--21--
		SELECT SOP.TCKIMLIKNO, SOP.AD, SOP.SOYAD, SPT.AD AS PUANTURU, SOP.PUAN
		FROM #SinavOgrenciPuan SOP
		INNER JOIN #150BARAJ B ON B.TCKIMLIKNO = SOP.TCKIMLIKNO
		INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVPUANTURU = SOP.ID_SINAVPUANTURU
		ORDER BY SOP.TCKIMLIKNO, SOP.ID_SINAVPUANTURU, SOP.PUAN

		--22--
		SELECT B.TCKIMLIKNO, SOCB.BOLUMNO, SOCB.TAKMAAD, SOCB.NET, SOCB.SINIF
		FROM #150BARAJ B
		INNER JOIN #SinavOgrenciCevapBolum SOCB ON SOCB.TCKIMLIKNO = B.TCKIMLIKNO
		ORDER BY B.TCKIMLIKNO, SOCB.BOLUMNO
		
		SELECT TCKIMLIKNO
		INTO #180BARAJ
		FROM #SinavOgrenciPuan SOP
		WHERE SOP.PUAN < 180 AND SOP.SUBENO = @SUBENO
		GROUP BY SOP.TCKIMLIKNO
		HAVING COUNT(1) = @PUANTURSAY

		--23--
		SELECT SOP.TCKIMLIKNO, SOP.AD, SOP.SOYAD, SPT.AD AS PUANTURU, SOP.PUAN
		FROM #SinavOgrenciPuan SOP
		INNER JOIN #180BARAJ B ON B.TCKIMLIKNO = SOP.TCKIMLIKNO
		INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVPUANTURU = SOP.ID_SINAVPUANTURU
		ORDER BY SOP.TCKIMLIKNO, SOP.ID_SINAVPUANTURU, SOP.PUAN
		
		--24--
		SELECT B.TCKIMLIKNO, SOCB.BOLUMNO, SOCB.TAKMAAD, SOCB.NET, SOCB.SINIF
		FROM #180BARAJ B
		INNER JOIN #SinavOgrenciCevapBolum SOCB ON SOCB.TCKIMLIKNO = B.TCKIMLIKNO
		ORDER BY B.TCKIMLIKNO, SOCB.BOLUMNO

		DECLARE @KATILIMBASLIK VARCHAR(MAX) = (SELECT CAST(S.DONEM AS VARCHAR) + '-' + CAST(CAST(S.DONEM AS INT)+1 AS VARCHAR) + ' OKYANUS KOLEJİ ' + K3.AD + ' ' + S.AD + ' SINAVINA KATILMAYAN ÖĞRENCİLER' FROM Sinav S INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = S.ID_KADEME3 WHERE ID_SINAV = @ID_SINAV)

		--25--
		SELECT K.TCKIMLIKNO, K.AD+' '+K.SOYAD AS ADSOYAD, SU.AD AS OKUL, SN.AD AS SINIF, @KATILIMBASLIK AS BASLIK 
		FROM OkyanusDB.dbo.v3OgrenciTum O
		INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
		INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
		INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO=O.TCKIMLIKNO
		INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE=O.ID_SUBE
		LEFT JOIN SinavOgrenci SO ON SO.TCKIMLIKNO=O.TCKIMLIKNO AND SO.ID_SINAV=@ID_SINAV
		WHERE SO.ID_SINAVOGRENCI IS NULL 
		AND	  (@ID_SUBE=0 OR @ID_SUBE=O.ID_SUBE)
		AND	  (SGS.ID_KADEME3=(SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV))
		AND	  (O.DONEM=(SELECT DONEM FROM Sinav WHERE ID_SINAV=@ID_SINAV))
		ORDER BY O.ID_SUBE, O.ID_SINIF, K.AD, K.SOYAD		
	
		DROP TABLE #150BARAJ
		DROP TABLE #180BARAJ
		DROP TABLE #SinavOgrenciPuanTum
		DROP TABLE #SinavOgrenciPuanGenelOrtTum
		DROP TABLE #SinavOgrenci
		DROP TABLE #SinavOgrenciCevapBolum
		DROP TABLE #SinavOgrenciTum
		DROP TABLE #SinavOgrenciCevapBolumTum
		DROP TABLE #DersGenelortTum
		DROP TABLE #DersGenelort
		DROP TABLE #DersIlort
		DROP TABLE #DersIlceort
		DROP TABLE #DersSubeort
		DROP TABLE #SinavOgrenciPuan
		DROP TABLE #SinavOgrenciPuanGenelOrt
		DROP TABLE #SinavOgrenciPuanIlOrt
		DROP TABLE #SinavOgrenciPuanIlceOrt
		DROP TABLE #SinavOgrenciPuanSubeOrt
		DROP TABLE #ToplamNet
		DROP TABLE #ToplamNetGenel
		DROP TABLE #ToplamNetSube
		DROP TABLE #ToplamNetSinif
		DROP TABLE #OkulDersOrtalama
		DROP TABLE #DERSSORUSAYI


	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OnlineDers]    Script Date: 23.11.2021 15:06:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OnlineDers]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	
	@TARIH						NVARCHAR(MAX)	= NULL,
	@TC_OGRENCI					NVARCHAR(11)	= NULL,
	@ID_SINIF					INT				= NULL,
	@ID_KADEME3					INT				= NULL,
	@EKRANPAYLASIMID			VARCHAR(MAX)	= NULL,
	@TC_OGRETMEN				VARCHAR(MAX)	= NULL,
	@LINK						VARCHAR(MAX)	= NULL,
	@HERKESISUSTUR				VARCHAR(MAX)	= NULL,
	@SQLJSON					NVARCHAR(MAX)	= NULL,
	@ID_SUBE					INT				= NULL,
		@IP					VARCHAR(50)	= NULL



AS
BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 10.09.2020
	
	--	sp Alter 
		--	ISLEM = 16,17 Add
	--	ÖĞRETMEN ONLINE DERS PROGRAMI, KALDIR

	
	Değiştiren Adı		: Burhan
	Değiştirilen Tarih	: 02.11.2020
	
	--	sp Alter 
		--	ISLEM = 18 Add
	--	ÖĞRETMEN ONLINE ÖĞRETMEN LİSTESİ

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 18.11.2020
	
	--	sp Alter 
		--	ISLEM = 19 Add

*/


		
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU

				,SQLJSON					= @SQLJSON
				,TARIH						= @TARIH
				,ID_SINIF					= @ID_SINIF
				,ID_KADEME3					= @ID_KADEME3
				,TC_OGRETMEN				= @TC_OGRETMEN
				,TC_OGRENCI					= @TC_OGRENCI
				,LINK						= @LINK
				,HERKESISUSTUR				= @HERKESISUSTUR
				,EKRANPAYLASIMID			= @EKRANPAYLASIMID
				,ID_SUBE					= @ID_SUBE				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	--IF @TCKIMLIKNO != '45964597234'
	--BEGIN
	--	RAISERROR ('Lütfen Daha Sonra Tekrar Deneyiniz' , 16,1);
	--	return
	--END
	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		
		IF @_ID_LOG > 0
		BEGIN
				
			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT OkyanusDB.dbo.fn_AktifDonem())
			DECLARE @URL	VARCHAR(MAX) = 'https://api.hz.web.tv/p201'
			DECLARE @SECRET VARCHAR(MAX) = 'b547xzsLKBi36FDd3OU7s64dWYByL7hCm2YiI6LMBy'
			DECLARE @RESULT	NVARCHAR(MAX)= NULL


			
			IF @ISLEM = 1	--	GENEL KLASÖR LİSTESİ					
			BEGIN
			
				SELECT ISNULL((
					SELECT DISTINCT 
						 K3.ID_KADEME3
						,K3.AD
						,K2.ID_KADEME2
						,K2.AD
						,LINK	= ISNULL((
							SELECT GK.LINK
							FROM OnlineDersGenelKlasor	GK	
							WHERE	GK.ID_KADEME2	= KB.ID_KADEME2
								AND	GK.ID_KADEME3	= KB.ID_KADEME3
						),'')
					FROM v3Kademe3					K3
					JOIN v3KademeBilgi				KB	ON	KB.ID_KADEME3	= K3.ID_KADEME3
					JOIN v3Kademe2					K2	ON	K2.ID_KADEME2	= KB.ID_KADEME2
					FOR JSON AUTO
				),'[]')

			END

			IF @ISLEM = 2	--	GENEL KLASÖR KAYDET						
			BEGIN

				DELETE FROM OnlineDersGenelKlasor 

				INSERT INTO OnlineDersGenelKlasor (ID_KADEME2, ID_KADEME3, LINK, KYE_TCKIMLIKNO)
				SELECT ID_KADEME2, ID_KADEME3, LINK, @TCKIMLIKNO
				FROM OPENJSON(@SQLJSON)
				WITH(
					ID_KADEME3	INT,
					K2			NVARCHAR(MAX) AS JSON
				) AS KADEME3
				CROSS APPLY OPENJSON(KADEME3.K2) 
				WITH (
					ID_KADEME2	INT,
					LINK		VARCHAR(MAX)
				) KADEME2

			END

			IF @ISLEM = 3	--	TARIH LIST								
			BEGIN
			
				DECLARE @TARIHLIST TABLE (BASTARIH VARCHAR(MAX), BITTARIH VARCHAR(MAX))
				DECLARE @PAZARTESI DATE = DATEADD(week, DATEDIFF(day, 0, getdate())/7, 0)
				
				WHILE (SELECT DATEDIFF(DAY,@PAZARTESI,CAST('15.06.' + CAST(CAST((SELECT OkyanusDB.dbo.fn_AktifDonem()) AS INT) + 1 AS VARCHAR) AS date) )) > 0
				BEGIN				
	
					INSERT INTO @TARIHLIST (BASTARIH, BITTARIH)
					SELECT	BASTARIH = CONVERT(VARCHAR,@PAZARTESI,104),
							BITTARIH = CONVERT(VARCHAR,DATEADD(day,6, @PAZARTESI),104) 
			
					SET @PAZARTESI = DATEADD(WEEK,1,@PAZARTESI)
	
				END

				SELECT ISNULL((
					SELECT BASTARIH, BITTARIH
					FROM @TARIHLIST
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 4	--	SINIF TARIH DERS LINK GÖRÜNTÜLE			
			BEGIN
				SELECT ISNULL((
					SELECT G.ID_GUN
						,G.GUN
						,SA.DERSNO
						,SA.BASSAAT
						,SA.BITSAAT
						,SN = ISNULL((	SELECT 
											 GSN.DERSAD
											,GSN.LINK
											,GSN.SIFRE
										FROM OnlineDersSinif	GSN	
										WHERE	GSN.DERSNO			= SA.DERSNO
											AND GSN.ID_GUN			= G.ID_GUN
											AND GSN.KYE_TCKIMLIKNO	= @TCKIMLIKNO
											AND GSN.ID_SINIF		= @ID_SINIF
											AND GSN.AKTIF			= 1
										FOR JSON PATH
						),'[]')
						
						,GENELDRIVEID = ISNULL((
							SELECT TOP 1 right(GK.LINK, charindex('/', reverse(GK.LINK) + '/') - 1)
							FROM OnlineDersGenelKlasor	GK
							JOIN v3SatisTuru			ST	ON	ST.ID_KADEME2	= GK.ID_KADEME2
															AND ST.ID_KADEME3	= GK.ID_KADEME3
							JOIN v3Sinif				SN	ON	SN.ID_SATISTURU	= ST.ID_SATISTURU
							WHERE SN.ID_SINIF = @ID_SINIF
						), '')
					FROM Gun					G
					CROSS APPLY OnlineDersSaat	SA
					ORDER BY G.ID_GUN, SA.DERSNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 5	--	SINIF TARIH DERS LINK KAYDET			
			BEGIN
							
				UPDATE OnlineDersSinif SET
					AKTIF = 0
				WHERE	ID_SINIF		= @ID_SINIF
					AND	KYE_TCKIMLIKNO	= @TCKIMLIKNO
					AND	AKTIF			= 1

				INSERT INTO OnlineDersSinif (ID_SINIF, ID_GUN, DERSNO, DERSAD, LINK, SIFRE, KYE_TCKIMLIKNO)
				SELECT @ID_SINIF, ID_GUN, DERSNO, DERSAD, LINK, SIFRE, @TCKIMLIKNO
				FROM OPENJSON(@SQLJSON)
				WITH (
					ID_GUN	INT,
					SA		NVARCHAR(MAX) AS JSON
				) AS T
				CROSS APPLY OPENJSON(T.SA) 
				WITH (
					DERSNO	INT,
					SN		NVARCHAR(MAX) AS JSON
				) AS S
				CROSS APPLY OPENJSON(S.SN) 
				WITH (
					DERSAD	VARCHAR(MAX),
					LINK	VARCHAR(MAX),
					SIFRE	VARCHAR(MAX)
				) AS N
				WHERE	DERSAD	IS NOT NULL
					AND LINK	IS NOT NULL
					AND LINK	!= ''
					AND DERSAD	!= ''

			END

			IF @ISLEM = 6	--	ÖĞRENCİ ONLINE DERS PROGRAM				
			BEGIN

			
				DROP TABLE IF EXISTS #TEMP6
				SELECT DISTINCT G.ID_GUN
					,G.GUN
					,SA.DERSNO
					,SA.BASSAAT
					,SA.BITSAAT
					,DERSVAR = IIF(SN.DERSAD IS NULL,0,1)
				INTO #TEMP6
				FROM Gun							G
				CROSS APPLY OnlineDersSaat			SA
				LEFT JOIN OnlineDersSinif			SN	ON	SN.DERSNO	= SA.DERSNO
														AND SN.ID_GUN	= G.ID_GUN
														AND SN.AKTIF	= 1
														AND SN.ID_SINIF	= (SELECT TOP 1 ID_SINIF FROM v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI)
				ORDER BY G.ID_GUN, SA.DERSNO

				SELECT(
					SELECT (
						SELECT ISNULL((		
							SELECT 
								G.ID_GUN
								,G.GUN
								,SA.DERSNO
								,SA.BASSAAT
								,SA.BITSAAT
								,OGRETMENKLASOR = ISNULL((SELECT TOP 1 LINK FROM OnlineDersOgretmenKlasor K WHERE K.KYE_TCKIMLIKNO = SN.KYE_TCKIMLIKNO AND K.ID_KADEME3 = (SELECT ID_KADEME3 FROM v3Sinif WHERE ID_SINIF = SN.ID_SINIF)), '')
								,SN.DERSAD
								,LINK		= ISNULL(SN.LINK,'')
								,SIFRE		= ISNULL(SN.SIFRE,'')
								,ADSOYAD	= (
									SELECT CONCAT_WS(' ', K.AD, K.SOYAD)
									FROM v3Kullanici	K
									WHERE	K.TCKIMLIKNO	= SN.KYE_TCKIMLIKNO
										AND K.AKTIF			= 1
								)
								,SINIFAD	= ISNULL((
									SELECT S.AD
									FROM OkyanusDB.dbo.vw_Sinif	S
									WHERE S.ID_SINIF	= SN.ID_SINIF
								),'')
							FROM #TEMP6					SA
							JOIN Gun					G	ON	G.ID_GUN	= SA.ID_GUN							
							LEFT JOIN OnlineDersSinif	SN	ON	SN.DERSNO	= SA.DERSNO
															AND SN.ID_GUN	= G.ID_GUN
															AND SN.AKTIF	= 1
															AND SN.ID_SINIF	= (SELECT TOP 1 ID_SINIF FROM v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI)
							WHERE EXISTS (SELECT TOP 1 1 FROM #TEMP6 S WHERE S.DERSNO = SA.DERSNO AND S.DERSVAR = 1)
							ORDER BY ID_GUN, DERSNO
							FOR JSON AUTO, INCLUDE_NULL_VALUES
						),'[]') 
					) AS LISTE,
					(	SELECT LINK
						FROM OnlineDersGenelKlasor	GK
						JOIN v3SatisTuru			ST	ON	ST.ID_KADEME2	= GK.ID_KADEME2
														AND ST.ID_KADEME3	= GK.ID_KADEME3
						JOIN v3Sinif				SN	ON	SN.ID_SATISTURU	= ST.ID_SATISTURU
						JOIN v3Ogrenci				O	ON	O.ID_SINIF		= SN.ID_SINIF
						WHERE O.TCKIMLIKNO = @TC_OGRENCI
					) AS GENELKLASOR,
					GENELKLASORID = (
						SELECT TOP 1 right(GK.LINK, charindex('/', reverse(GK.LINK) + '/') - 1)
						FROM OnlineDersGenelKlasor	GK
						JOIN v3SatisTuru			ST	ON	ST.ID_KADEME2	= GK.ID_KADEME2
														AND ST.ID_KADEME3	= GK.ID_KADEME3
						JOIN v3Sinif				SN	ON	SN.ID_SATISTURU	= ST.ID_SATISTURU
						JOIN v3Ogrenci				O	ON	O.ID_SINIF		= SN.ID_SINIF
						WHERE O.TCKIMLIKNO = @TC_OGRENCI
					),
					(	SELECT TOP 1 SUBEAD + '-' + SINIF +'-' + REPLACE(REPLACE(REPLACE( FORMAT(getdate(), 'dd.MM.yyyy HH:mm:ss'),'.','_'),':','_'),' ','_')
						FROM vw_SubeGrupSinif	SN
						JOIN v3Ogrenci			O	ON	O.ID_SINIF		= SN.ID_SINIF
						WHERE O.TCKIMLIKNO = @TC_OGRENCI				
					) AS DOSYAAD
					FOR JSON PATH
				)

				DROP TABLE IF EXISTS #TEMP6

			END

			IF @ISLEM = 7	--	SINIF ONLINE DERS PROGRAMI				
			BEGIN
				SELECT (		
				SELECT LISTE = ISNULL((
					SELECT G.ID_GUN
						,G.GUN
						,SA.DERSNO
						,SA.BASSAAT
						,SA.BITSAAT
						,OGRETMENKLASOR = ISNULL((SELECT TOP 1 LINK FROM OnlineDersOgretmenKlasor K WHERE K.KYE_TCKIMLIKNO = SN.KYE_TCKIMLIKNO AND K.ID_KADEME3 = (SELECT ID_KADEME3 FROM v3Sinif WHERE ID_SINIF = @ID_SINIF)), '')
						
						,SN.DERSAD
						,LINK		= ISNULL(SN.LINK,'')
						,SIFRE		= ISNULL(SN.SIFRE,'')
						,ADSOYAD	= (
							SELECT CONCAT_WS(' ', K.AD, K.SOYAD)
							FROM v3Kullanici	K
							WHERE	K.TCKIMLIKNO	= SN.KYE_TCKIMLIKNO
								AND K.AKTIF			= 1
						)
					FROM Gun							G
					CROSS APPLY OnlineDersSaat			SA
					LEFT JOIN OnlineDersSinif			SN	ON	SN.DERSNO	 = SA.DERSNO
															AND SN.ID_SINIF	 = @ID_SINIF
															AND SN.ID_GUN	 = G.ID_GUN
															AND SN.AKTIF	 = 1				
					ORDER BY G.ID_GUN, SA.DERSNO															
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]'),
				GENELKLASOR = (
					SELECT TOP 1 LINK
					FROM OnlineDersGenelKlasor	GK
					JOIN v3SatisTuru			ST	ON	ST.ID_KADEME2	= GK.ID_KADEME2
													AND ST.ID_KADEME3	= GK.ID_KADEME3
					JOIN v3Sinif				SN	ON	SN.ID_SATISTURU	= ST.ID_SATISTURU
					WHERE SN.ID_SINIF = @ID_SINIF
				),
				GENELKLASORID = (
					SELECT TOP 1 right(GK.LINK, charindex('/', reverse(GK.LINK) + '/') - 1)
					FROM OnlineDersGenelKlasor	GK
					JOIN v3SatisTuru			ST	ON	ST.ID_KADEME2	= GK.ID_KADEME2
													AND ST.ID_KADEME3	= GK.ID_KADEME3
					JOIN v3Sinif				SN	ON	SN.ID_SATISTURU	= ST.ID_SATISTURU
					WHERE SN.ID_SINIF = @ID_SINIF
				),
				DOSYAAD = (
					SELECT TOP 1 SUBEAD + ' - ' + SINIF + '-' + REPLACE(REPLACE(REPLACE( FORMAT(getdate(), 'dd.MM.yyyy HH:mm:ss'),'.','_'),':','_'),' ','_')
					FROM vw_SubeGrupSinif
					WHERE ID_SINIF = @ID_SINIF
				)
				FOR JSON PATH, WITHOUT_ARRAY_WRAPPER)
			END

			IF @ISLEM = 8	--	DERS PROGRAMI RAPOR						
			BEGIN
				SELECT * FROM (
					SELECT	 G.GUN
							,SA.DERSNO
							,SA.BASSAAT
							,SA.BITSAAT
							,DERSAD		= ISNULL((
								SELECT STUFF((
									SELECT '<hr />' +
										CASE	WHEN SN.DERSAD IS NULL THEN '<center>-</center>' 
												ELSE '<div style="font-size:8;margin:8px;">' +
													ISNULL(SN.DERSAD, '') + '</br>' 
													+ ISNULL((
														SELECT CONCAT_WS(' ', K.AD, K.SOYAD)
														FROM v3Kullanici	K
														WHERE	K.TCKIMLIKNO	= SN.KYE_TCKIMLIKNO
															AND K.AKTIF			= 1
													), '') 
													+ '</br><a href="' + ISNULL(SN.LINK,'') + '" target="_blank">' 
													+ (CASE WHEN @ID_SINIF = 0 THEN 'Derse Gitmek İçin Tıklayınız' ELSE SN.LINK END) + '.</a>
													</br> Şifre : '+
													ISNULL(SN.SIFRE,'')
													+'
													</div>'
											END
									FROM OnlineDersSinif	SN	
									WHERE	SN.DERSNO	= SA.DERSNO
									AND SN.ID_GUN	= G.ID_GUN
									AND SN.AKTIF	= 1
									AND (
											(@ID_SINIF = 0 AND SN.ID_SINIF	= (SELECT TOP 1 ID_SINIF FROM v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI)) 
											OR 
											(@ID_SINIF > 0 AND SN.ID_SINIF = @ID_SINIF)
										)
								FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 6, ''))
							,'<center>-</center>')
							
					FROM Gun							G
					CROSS APPLY OnlineDersSaat			SA				
				) TABLEX
				PIVOT (
					MAX(DERSAD)
					FOR GUN IN ([PAZARTESİ], [SALI], [ÇARŞAMBA], [PERŞEMBE], [CUMA], [CUMARTESİ], [PAZAR])
				) PIVOTTABLE
				WHERE [PAZARTESİ] IS NOT NULL OR [SALI] IS NOT NULL OR [ÇARŞAMBA] IS NOT NULL OR [PERŞEMBE] IS NOT NULL OR [CUMA] IS NOT NULL OR [CUMARTESİ] IS NOT NULL OR [PAZAR] IS NOT NULL
				ORDER BY DERSNO
			END

			
			IF @ISLEM = 12	--	ÖĞRETMEN KADEME3 KLASOR GETİR			
			BEGIN
				SELECT ISNULL(
				(
					SELECT TOP 1 LINK
					FROM OnlineDersOgretmenKlasor
					WHERE KYE_TCKIMLIKNO = @TCKIMLIKNO AND ID_KADEME3 = @ID_KADEME3
				), '')
			END

			IF @ISLEM = 13	--	ÖĞRETMEN KADEME3 KLASOR KAYDET			
			BEGIN
				DELETE FROM OnlineDersOgretmenKlasor WHERE KYE_TCKIMLIKNO = @TCKIMLIKNO AND ID_KADEME3 = @ID_KADEME3
				INSERT INTO OnlineDersOgretmenKlasor (ID_KADEME3, LINK, KYE_TCKIMLIKNO)
				SELECT @ID_KADEME3, @LINK, @TCKIMLIKNO
			END

			IF @ISLEM = 16	--	ÖĞRETMEN ONLINE DERS PROGRAMI			
			BEGIN

				SELECT LISTE = ISNULL((
					SELECT	 G.ID_GUN
							,G.GUN
							,SA.DERSNO
							,SA.BASSAAT
							,SA.BITSAAT
							,SN.DERSAD
							,SINIFAD = (SELECT S.AD FROM V3sinif S WHERE S.ID_SINIF = SN.ID_SINIF)
					FROM Gun							G
					CROSS APPLY OnlineDersSaat			SA
					LEFT JOIN OnlineDersSinif			SN	ON	SN.DERSNO		= SA.DERSNO
															AND KYE_TCKIMLIKNO	= @TC_OGRETMEN
															AND SN.ID_GUN		= G.ID_GUN
															AND SN.AKTIF		= 1
					ORDER BY G.ID_GUN, SA.DERSNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				
				
			END
			IF @ISLEM = 17	--	ÖĞRETMEN ONLINE DERS PROGRAMI KALDIR	
			BEGIN

				UPDATE OnlineDersSinif SET
					AKTIF = 0
				WHERE KYE_TCKIMLIKNO = @TC_OGRETMEN


				
			END
			IF @ISLEM = 18	--	ÖĞRETMEN ONLINE ÖĞRETMEN LİSTESİ		
			BEGIN

				SELECT ISNULL((
					SELECT DISTINCT K.AD,K.SOYAD,K.TCKIMLIKNO 
					FROM OnlineDersSinif	ODS
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF	= ODS.ID_SINIF
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= ODS.KYE_TCKIMLIKNO
				    WHERE GS.ID_SUBE = @ID_SUBE
						AND  ODS.AKTIF=1
					FOR JSON PATH
				),'[]')


				
			END

		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OrtalamaListesi]    Script Date: 23.11.2021 15:09:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	[dbo].[sp_OrtalamaListesi]
--		@TCKIMLIKNO = N'32051057542',
--		@OTURUM = N'7555E2BC-B486-44B4-946C-6E2FCB4BDB42',
--		@ID_MENU = 1090,
--		@ID_SINAV = 9826,
--		@ID_SUBELER = N'[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]',
--		@ID_SINIFLAR = N'[0,102208,102207,102293,104343,101677,101671,101679,101672,101676,101680,101926,101927,101924,101925,101873,101875,101435,101434,101709,101710,101707,101708,101826,102174,101497,101498,101417,101419,101613,101615,101614,101861,104756,101860,101867,100987,105219,105416,105417,102307,102306,102087,102086,102147,102146,104554,101943,101946,101525,101526,104673,104676]',
--		@ISLEM = 2,
--		@DONEM = N'2017'

ALTER procedure [dbo].[sp_OrtalamaListesi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= 0,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@RAPORTUR			BIT				= 0,
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
			,RAPORTUR					= @RAPORTUR	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			
			IF @ISLEM = 1 OR @ISLEM = 2	--	Ortalama Listesi Getir
			BEGIN
				IF 0 IN (SELECT VALUE FROM Openjson (@ID_SUBELER))
				BEGIN 
					SELECT  sb.AD                                                       AS SUBE, 
							''															AS SINIF, 
							o.SORUNO, 
							s.PUANDEGERI, 
							CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), o.PUAN))) AS ORTALAMA ,
							SR.SINAVADI SINAVAD,
							cast(SR.DONEMKOD+ ' - ' + cast(sr.DONEMKOD+1 as varchar)as varchar) DONEMKOD
					INTO   #ogrencinot 
					FROM   eokul_v2.dbo.OgrenciNot o 
					INNER JOIN eokul_v2.dbo.SinavRaporDetay s ON s.ID_SINAVRAPOR = o.ID_SINAVRAPOR AND s.SORUNO = o.SORUNO 
					INNER JOIN eokul_v2.dbo.SinavRapor SR ON SR.ID_SINAVRAPOR = o.ID_SINAVRAPOR 
					INNER JOIN OkyanusDb.dbo.v3Sinif sn ON sn.ID_SINIF = o.ID_SINIF 
					INNER JOIN OkyanusDb.dbo.v3Donem dn ON dn.ID_DONEM = sn.ID_DONEM 
					INNER JOIN OkyanusDb.dbo.v3Sube sb ON sb.ID_SUBE = dn.ID_SUBE 
					WHERE	o.ID_SINAVRAPOR = @ID_SINAV
							AND o.KATILMADI = 0 
					GROUP  BY sb.AD, o.SORUNO, s.PUANDEGERI	,SR.SINAVADI , SR.DONEMKOD

					IF @ISLEM = 1 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinot 
									ORDER BY SUBE, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinot o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 2 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinot 
						ORDER BY SUBE, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinot o 
						ORDER  BY o.SORUNO 
					END

					DROP TABLE #ogrencinot
				END 
				ELSE 
				BEGIN 
					SELECT  sb.AD                                                       AS SUBE, 
							sn.AD														AS SINIF, 
							o.SORUNO, 
							s.PUANDEGERI, 
							CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), o.PUAN))) AS ORTALAMA ,
							SR.SINAVADI SINAVAD,
							cast(SR.DONEMKOD+ ' - ' + cast(sr.DONEMKOD+1 as varchar)as varchar) DONEMKOD
					INTO   #ogrencinot2 
					FROM   eokul_v2.dbo.OgrenciNot o 
					INNER JOIN eokul_v2.dbo.SinavRaporDetay s ON s.ID_SINAVRAPOR = o.ID_SINAVRAPOR AND s.SORUNO = o.SORUNO 
					INNER JOIN eokul_v2.dbo.SinavRapor SR ON SR.ID_SINAVRAPOR = o.ID_SINAVRAPOR 
					INNER JOIN OkyanusDb.dbo.v3Sinif sn ON sn.ID_SINIF = o.ID_SINIF 
					INNER JOIN OkyanusDb.dbo.v3Donem dn ON dn.ID_DONEM = sn.ID_DONEM 
					INNER JOIN OkyanusDb.dbo.v3Sube sb ON sb.ID_SUBE = dn.ID_SUBE 
					WHERE   o.ID_SINAVRAPOR = @ID_SINAV
							AND o.KATILMADI = 0 
							AND ( ( sb.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
							AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
					GROUP  BY sb.AD, 
							sn.AD, 
							o.SORUNO, 
							s.PUANDEGERI,
							SR.SINAVADI,
							SR.DONEMKOD

					IF @ISLEM = 1 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinot2 
									ORDER BY SUBE, SINIF, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinot2 o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 2 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinot2 
						ORDER BY SUBE, SINIF, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinot2 o 
						ORDER  BY o.SORUNO 

					END

					DROP TABLE #ogrencinot2
				END 				
			END

			IF @ISLEM = 3 OR @ISLEM = 4	--	Ortalama Listesi Getir YENİ
			BEGIN
				IF @RAPORTUR = 0--0 IN (SELECT VALUE FROM Openjson (@ID_SUBELER))
				BEGIN 
					SELECT  SB.AD AS SUBE
							,'' AS SINIF
							,YS.SORUNO
							,YS.PUAN AS PUANDEGERI
							,CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), YOC.PUAN))) AS ORTALAMA
							,Y.AD AS SINAVAD
							,CAST(Y.DONEM+ ' - ' + cast(Y.DONEM+1 AS VARCHAR) as VARCHAR) DONEMKOD
					INTO #ogrencinotY
					FROM Yazili Y 
					INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
					INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					WHERE Y.ID_YAZILI = @ID_SINAV
						AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' OR 0 IN (SELECT VALUE FROM Openjson (@ID_SUBELER))) 
						--AND ( ( O.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
						AND YO.KATILMADI = 0 
					GROUP  BY SB.AD, YS.SORUNO, YS.PUAN, Y.AD, Y.DONEM

					IF @ISLEM = 3 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinotY 
									ORDER BY SUBE, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinotY o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 4 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinotY 
						ORDER BY SUBE, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinotY o 
						ORDER  BY o.SORUNO 
					END

					DROP TABLE #ogrencinotY
				END 
				ELSE 
				BEGIN 
					SELECT  SB.AD AS SUBE
							,S.AD AS SINIF
							,YS.SORUNO
							,YS.PUAN AS PUANDEGERI
							,CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), YOC.PUAN))) AS ORTALAMA
							,Y.AD AS SINAVAD
							,CAST(Y.DONEM+ ' - ' + cast(Y.DONEM+1 AS VARCHAR) as VARCHAR) DONEMKOD
					INTO #ogrencinotY2
					FROM Yazili Y 
					INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
					INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
					WHERE Y.ID_YAZILI = @ID_SINAV
						AND YO.KATILMADI = 0 
						AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
						AND ( ( O.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
					GROUP  BY SB.AD, S.AD, YS.SORUNO, YS.PUAN, Y.AD, Y.DONEM

					IF @ISLEM = 3 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinotY2 
									ORDER BY SUBE, SINIF, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinotY2 o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 4 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinotY2 
						ORDER BY SUBE, SINIF, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinotY2 o 
						ORDER  BY o.SORUNO 

					END

					DROP TABLE #ogrencinotY2
				END 				
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OsOdevListele]    Script Date: 23.11.2021 15:09:16 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OsOdevListele]
	@ISLEM						INT			= NULL,
	@ID_ODEV					INT			= NULL,
	@TCKIMLIKNO					VARCHAR(11)	= NULL,
	@TC_OGRENCI					VARCHAR(11)	= NULL,
	@ID_ODEVSINIFOGRENCI		INT			= NULL,
	@ID_ODEVSINIFOGRENCIDOSYA	INT			= NULL,
	@APIKEY						VARCHAR(MAX)= NULL,
	@TAMAMLANDIDURUM			INT			= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,TC_OGRENCI					= @TC_OGRENCI
				,ID_ODEV					= @ID_ODEV
				,APIKEY						= @APIKEY
				,ID_ODEVSINIFOGRENCI		= @ID_ODEVSINIFOGRENCI
				,ID_ODEVSINIFOGRENCIDOSYA	= @ID_ODEVSINIFOGRENCIDOSYA
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
	)

	BEGIN TRY    
		
		DECLARE @ID_LOG INT = 0
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = '', @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = 0, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP

		IF NOT EXISTS ( SELECT * FROM OkyanusDB.dbo.v3OgrenciVeli WHERE TCKIMLIKNO = @TCKIMLIKNO AND TCKIMLIKNO_OGR = @TC_OGRENCI )
		BEGIN
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ' Veli ve Öğrenci Bilgileri Hatalıdır. Lütfen interaktif sisteminden kontrol ediniz' --ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = 16, @STATE = 1, @ID_LOG = @ID_LOG, @ID_LOGTUR = 5

			return;

		END
		ELSE IF @ID_LOG > 0 AND @APIKEY = '7da3b771-8007-455b-9bf0-595528512aa0'
		BEGIN			
			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)

			IF @ISLEM = 1	--	ÖDEV LİSTESİ			
			BEGIN
				
				DROP TABLE IF EXISTS #TEMP1
				SELECT	 ID_ODEV		= O.ID_ODEV
						,DERSAD			= ISNULL(D.DERSAD, '')
						,VERILIS_TARIHI	= O.VERILIS_TARIHI
						,TESLIM_TARIHI	= O.TESLIM_TARIHI
						,DURUM			= ISNULL(OD.AD, 'Kontrol Edilmedi')
						,BASLIK			= O.BASLIK
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,ID_ODEVTUR		= O.ID_ODEVTUR
						,DOSYASAYISI	= (	SELECT COUNT(1) 
											FROM OdevSinifOgrenci		OSO	WITH(NOLOCK)
											JOIN OdevSinifOgrenciDosya	OD	WITH(NOLOCK) ON	OD.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI
											WHERE OSO.ID_ODEVSINIF	= OS.ID_ODEVSINIF
												AND OD.AKTIF		= 1
											)
						,TAMAMLANDI		= IIF(EXISTS (SELECT TOP 1 1 FROM OdevTamamlandi OT WITH(NOLOCK) WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO), 1, 0)
				INTO #TEMP1
				FROM		Odev				O	WITH(NOLOCK)
				INNER JOIN	OdevSinif			OS	WITH(NOLOCK) ON OS.ID_ODEV		= O.ID_ODEV
				INNER JOIN	OdevSinifOgrenci	OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
				LEFT  JOIN	eokul_v2.dbo.Ders	D	WITH(NOLOCK) ON D.ID_DERS		= O.ID_DERS
				INNER JOIN	v3Kullanici			K	WITH(NOLOCK) ON K.TCKIMLIKNO	= O.KYE_KULLANICI
				LEFT  JOIN	OdevDurum			OD	WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				WHERE	O.AKTIF			= 1 
					AND O.DONEM			= @AKTIFDONEM 
					AND OSO.TCKIMLIKNO	= @TC_OGRENCI

				SELECT (
						SELECT LISTE = (
							SELECT ISNULL((
								SELECT	 ID_ODEV
										,DERSAD
										,VERILIS_TARIHI = CONVERT(VARCHAR(MAX), T.VERILIS_TARIHI, 104)
										,TESLIM_TARIHI  = CONVERT(VARCHAR(MAX), T.TESLIM_TARIHI, 104)
										,DURUM
										,BASLIK
										,ADSOYAD
										,ID_ODEVTUR
										,DOSYASAYISI
								FROM #TEMP1 T
								WHERE TAMAMLANDI = 0
								ORDER BY T.TESLIM_TARIHI DESC
								FOR JSON PATH
							), '[]')			
						)
						,TAMAMLANAN = (
							SELECT ISNULL((
								SELECT	 ID_ODEV
										,DERSAD
										,VERILIS_TARIHI= CONVERT(VARCHAR(MAX), T.VERILIS_TARIHI, 104)
										,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), T.TESLIM_TARIHI, 104)
										,DURUM
										,BASLIK
										,ADSOYAD
										,ID_ODEVTUR
										,DOSYASAYISI
								FROM #TEMP1 T
								WHERE TAMAMLANDI = 1
								ORDER BY T.TESLIM_TARIHI DESC
								FOR JSON PATH
							), '[]')			
						)
						FOR JSON PATH
					)
				DROP TABLE IF EXISTS #TEMP1

			END

			IF @ISLEM = 2	--	ÖDEV DETAY				
			BEGIN
				SELECT ISNULL((
					SELECT	 O.ID_ODEV
							,O.ID_MORPADERS
							,DERSAD				= ISNULL(D.DERSAD, '') 
							,O.BASLIK
							,O.ACIKLAMA
							,LINKLIST			= ISNULL((SELECT OL.AD, OL.LINK FROM OdevLink OL WHERE OL.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,DOSYALIST			= ISNULL((SELECT OD.AD , OD.GUID, OD.UZANTI FROM OdevDosya OD WHERE OD.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,VERILIS_TARIHI		= O.VERILIS_TARIHI
							,TESLIM_TARIHI		= O.TESLIM_TARIHI
							,OGRENCIDOSYALIST	= ISNULL((	SELECT DISTINCT SOD.ID_ODEVSINIFOGRENCIDOSYA, SOD.GUID
															FROM OdevSinif				SOS
															JOIN OdevSinifOgrenci		SOSO	ON	SOSO.ID_ODEVSINIF		= SOS.ID_ODEVSINIF
															JOIN OdevSinifOgrenciDosya	SOD		ON	SOD.ID_ODEVSINIFOGRENCI	= SOSO.ID_ODEVSINIFOGRENCI
															WHERE	SOS.ID_ODEV		= O.ID_ODEV
																AND SOSO.TCKIMLIKNO	= OD.TCKIMLIKNO
																AND SOD.AKTIF		= 1
															FOR JSON PATH
													),'[]')
					FROM Odev									O
					INNER JOIN OdevSinif						S	ON	S.ID_ODEV	= O.ID_ODEV
					--INNER JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.ID_SINIF	= S.ID_SINIF	kur olmadığı için alttaki view eklendi				
					INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci	OD	ON	OD.ID_SINIF	= S.ID_SINIF
					LEFT JOIN eokul_v2.dbo.Ders					D	ON	D.ID_DERS	= O.ID_DERS
					WHERE O.AKTIF			= 1
						AND OD.TCKIMLIKNO	= @TC_OGRENCI
						--AND OD.DONEM		= @AKTIFDONEM
						AND O.ID_ODEV		= @ID_ODEV
					FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
				), '{}')
				

			END
			
			IF @ISLEM = 3	--	ÖĞRENCİ ÖDEV DOSYA EKLE	
			BEGIN

				DECLARE @GUID_DOSYA VARCHAR(36) = NEWID()
				WHILE EXISTS(SELECT TOP 1 1 FROM OdevSinifOgrenciDosya D WHERE D.GUID = @GUID_DOSYA)
				BEGIN
					SET @GUID_DOSYA = NEWID()
				END

				SET @ID_ODEVSINIFOGRENCI = (SELECT OSO.ID_ODEVSINIFOGRENCI
											FROM Odev				O
											JOIN OdevSinif			OS	ON	OS.ID_ODEV		= O.ID_ODEV
											JOIN OdevSinifOgrenci	OSO	ON	OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
											WHERE	O.ID_ODEV	= @ID_ODEV
												AND TCKIMLIKNO	= @TC_OGRENCI)

				DECLARE @INSERT23 TABLE(ID INT)
				INSERT INTO OdevSinifOgrenciDosya (ID_ODEVSINIFOGRENCI, GUID) 
				OUTPUT inserted.ID_ODEVSINIFOGRENCIDOSYA INTO @INSERT23
				VALUES (@ID_ODEVSINIFOGRENCI, @GUID_DOSYA)

				SELECT	 GUID						= @GUID_DOSYA
						,ID_ODEVSINIFOGRENCIDOSYA	= (SELECT TOP 1 ID FROM @INSERT23)
				FOR JSON PATH

			END

			IF @ISLEM = 4	--	ÖĞRENCİ ÖDEV DOSYA SİL	
			BEGIN

				UPDATE OdevSinifOgrenciDosya SET
					AKTIF		= 0,
					KYI_TARIH	= GETDATE()
				WHERE ID_ODEVSINIFOGRENCIDOSYA = @ID_ODEVSINIFOGRENCIDOSYA

			END

			IF @ISLEM = 5   -- ÖDEV TAMAMLA
			BEGIN
				INSERT INTO OdevTamamlandi(ID_ODEV,TCKIMLIKNO)
				SELECT @ID_ODEV, @TCKIMLIKNO
			END
			
			--IPTAL
			IF @ISLEM = 6	AND 1 = 0 -- ÖDEV TAMAMLANANLARI GETİR
			BEGIN
				SELECT ISNULL((
					SELECT	 O.ID_ODEV
							,ISNULL(D.DERSAD, '') AS DERSAD
							,CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104) AS VERILIS_TARIHI
							,CONVERT(VARCHAR(MAX), O.TESLIM_TARIHI, 104) AS TESLIM_TARIHI
							,ISNULL(OD.AD, 'Kontrol Edilmedi') AS DURUM
							,O.BASLIK
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,O.ID_ODEVTUR
							,DOSYASAYISI = (SELECT COUNT(OD.GUID) 
											FROM OdevSinifOgrenci		OSO
											JOIN OdevSinifOgrenciDosya	OD	ON	OD.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI
											WHERE OSO.ID_ODEVSINIF	= OS.ID_ODEVSINIF
												AND OD.AKTIF		= 1
											)
					FROM OdevSinifOgrenci OSO WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
					INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
					LEFT JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
					WHERE O.AKTIF = 1 AND O.DONEM = @AKTIFDONEM AND OSO.TCKIMLIKNO = @TC_OGRENCI 
					AND	(
								(ISNULL(@TAMAMLANDIDURUM, 0) = 0 AND NOT EXISTS (SELECT TOP 1 1 FROM OdevTamamlandi OT WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO))
								OR
								(ISNULL(@TAMAMLANDIDURUM, 0) = 1 AND EXISTS (SELECT TOP 1 1 FROM OdevTamamlandi OT WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO))
							)
					ORDER BY O.TESLIM_TARIHI DESC
					FOR JSON PATH,INCLUDE_NULL_VALUES
				), '[]')
			END

			IF @ISLEM = 7   -- ÖDEV TAMAMLAMA İPTAL
			BEGIN
				DELETE FROM OdevTamamlandi WHERE ID_ODEV=@ID_ODEV 
			END
		END
		

	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity, @STATE = @ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OSYM]    Script Date: 23.11.2021 15:09:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER procedure [dbo].[sp_OSYM]
(
	@TCKIMLIKNO									VARCHAR(11)		 = NULL,
	@OTURUM										VARCHAR(36)		 = NULL,
	@ID_MENU									INT				 = NULL,
	@PROGRAMKODU								VARCHAR(MAX)	 = '',
	@UNIVERSITE									VARCHAR(MAX)	 = '',
	@FAKULTE									VARCHAR(MAX)	 = '',
	@BOLUM										VARCHAR(MAX)	 = '',
	@BOLUM2										VARCHAR(MAX)	 = '',
	@EGITIMDILI									VARCHAR(MAX)	 ='',
	@UCRETBURS									VARCHAR(MAX)	 ='',
	@IL											VARCHAR(MAX)	 ='',
	@UNIVERSITETURU								VARCHAR(MAX)	 ='',
	@OGRENIMSURESI								VARCHAR(MAX)	 ='',
	@OGRENIMTURU								VARCHAR(MAX)	 ='',
	@PUANTURU									VARCHAR(MAX)	 ='',
	@YIL										CHAR(4)			 ='',
	@TABANPUAN									VARCHAR(MAX)	 ='',
	@KONTENJAN									VARCHAR(MAX)	 ='',
	@PROGRAMTURU								VARCHAR(MAX)	 ='',
	@SONYGSYERLESTIRME							VARCHAR(MAX)	 ='',
	@OKULBIRINCILIGIKONTENJANI					VARCHAR(MAX)	 ='',
	@YERONCELIKLERI								VARCHAR(MAX)	 ='',
	@ENBUYUKPUAN								VARCHAR(MAX)	 ='',
	@BASARISIRALAMA								VARCHAR(MAX)	 ='',
	@OZELKOSULACIKLAMA							VARCHAR(MAX)	 ='',
	@displayLength								INT				 = 0,
	@displayStart								INT				 = 0,
	@whereClause								VARCHAR(MAX)	 ='',
	@orderByClause								VARCHAR(MAX)	 ='',
	@ISLEM										INT				 =0,
	@DATATABLE dbo.UniversiteTabanPuanlariYeni READONLY,
	@SQLJSON									VARCHAR(MAX)	 ='',
	@DONEM										CHAR(4)			 =null,
	@FILTER										VARCHAR(MAX)	 ='',
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO										 =	 @TCKIMLIKNO									
			,OTURUM											 =	 @OTURUM										
			,ID_MENU										 =	 @ID_MENU									
			,PROGRAMKODU									 =	 @PROGRAMKODU								
			,UNIVERSITE										 =	 @UNIVERSITE									
			,FAKULTE										 =	 @FAKULTE									
			,BOLUM											 =	 @BOLUM										
			,BOLUM2											 =	 @BOLUM2										
			,EGITIMDILI										 =	 @EGITIMDILI									
			,UCRETBURS										 =	 @UCRETBURS									
			,IL												 =	 @IL											
			,UNIVERSITETURU									 =	 @UNIVERSITETURU								
			,OGRENIMSURESI									 =	 @OGRENIMSURESI								
			,OGRENIMTURU									 =	 @OGRENIMTURU								
			,PUANTURU										 =	 @PUANTURU									
			,YIL											 =	 @YIL										
			,TABANPUAN										 =	 @TABANPUAN									
			,KONTENJAN										 =	 @KONTENJAN									
			,PROGRAMTURU									 =	 @PROGRAMTURU								
			,SONYGSYERLESTIRME								 =	 @SONYGSYERLESTIRME							
			,OKULBIRINCILIGIKONTENJANI						 =	 @OKULBIRINCILIGIKONTENJANI					
			,YERONCELIKLERI									 =	 @YERONCELIKLERI								
			,ENBUYUKPUAN									 =	 @ENBUYUKPUAN								
			,BASARISIRALAMA									 =	 @BASARISIRALAMA								
			,OZELKOSULACIKLAMA								 =	 @OZELKOSULACIKLAMA							
			,displayLength									 =	 @displayLength								
			,displayStart									 =	 @displayStart								
			,whereClause									 =	 @whereClause								
			,orderByClause									 =	 @orderByClause								
			,ISLEM											 =	 @ISLEM										
 			,SQLJSON										 =	 @SQLJSON									
			,DONEM											 =	 @DONEM										
			,[FILTER]										 =	 @FILTER										
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			IF @ISLEM = 0	--	Üniversite taban puan insert
			BEGIN
				--UPDATE [dbo].[UniversiteTabanPuanlari]
				--	   SET [PROGRAMKODU] = d.PROGRAMKODU
				--		  ,[UNIVERSITE] = d.UNIVERSITE
				--		  ,[FAKULTE] = d.FAKULTE
				--		  ,[BOLUM] = d.BOLUM
				--		  ,[EGITIMDILI] = d.EGITIMDILI
				--		  ,[UCRETBURS] = d.UCRETBURS
				--		  ,[IL] = d.IL
				--		  ,[UNIVERSITETURU] = d.UNIVERSITETURU
				--		  ,[OGRENIMSURESI] = d.OGRENIMSURESI
				--		  ,[OGRENIMTURU] = d.OGRENIMTURU
				--		  ,[PUANTURU] = d.[PUANTURU]--CASE WHEN d.[PUANTURU] LIKE 'YGS%' THEN 'TYT' WHEN d.[PUANTURU] LIKE 'MF%' THEN 'SAY' WHEN d.[PUANTURU] LIKE 'TS%' THEN 'SOZ' WHEN d.[PUANTURU] LIKE 'TM%' THEN 'EA' WHEN d.[PUANTURU] LIKE 'DİL%' THEN 'DİL' END
				--		  ,[YIL] = d.YIL
				--		  ,[TABANPUAN] = d.[TABANPUAN] --CASE WHEN d.[TABANPUAN] is null THEN '0' ELSE d.[TABANPUAN] END
				--		  ,[KONTENJAN] = d.KONTENJAN
				--		  ,[PROGRAMTURU] = d.PROGRAMTURU
				--		  ,[SONYGSYERLESTIRME] = d.SONYGSYERLESTIRME
				--		  ,[OKULBIRINCILIGIKONTENJANI] = d.OKULBIRINCILIGIKONTENJANI
				--		  ,[YERONCELIKLERI] = d.YERONCELIKLERI
				--		  ,[ENBUYUKPUAN] = d.ENBUYUKPUAN
				--		  ,[BASARISIRALAMA] = d.BASARISIRALAMA
				--		  ,[OZELKOSULACIKLAMA] = d.OZELKOSULACIKLAMA
				--		FROM [dbo].[UniversiteTabanPuanlari] u
				--		INNER JOIN @DATATABLE d ON u.PROGRAMKODU = d.PROGRAMKODU and u.YIL=d.YIL;


				DELETE UniversiteTabanPuanlari WHERE YIL = (SELECT TOP 1 YIL FROM @DATATABLE d)

				INSERT INTO [dbo].[UniversiteTabanPuanlari]
						   ([PROGRAMKODU]
						   ,[UNIVERSITE]
						   ,[FAKULTE]
						   ,[BOLUM]
						   ,[BOLUM2]
						   ,[EGITIMDILI]
						   ,[UCRETBURS]
						   ,[IL]
						   ,[UNIVERSITETURU]
						   ,[OGRENIMSURESI]
						   ,[OGRENIMTURU]
						   ,[PUANTURU]
						   ,[YIL]
						   ,[TABANPUAN]
						   ,[KONTENJAN]
						   ,[PROGRAMTURU]
						   ,[SONYGSYERLESTIRME]
						   ,[OKULBIRINCILIGIKONTENJANI]
						   ,[YERONCELIKLERI]
						   ,[ENBUYUKPUAN]
						   ,[BASARISIRALAMA]
						   ,[OZELKOSULACIKLAMA])
					Select 
						[PROGRAMKODU]
						,[UNIVERSITE]
						,[FAKULTE]
						,[BOLUM]
						,[BOLUM2]
						,[EGITIMDILI]
						,[UCRETBURS]
						,[IL]
						,[UNIVERSITETURU]
						,[OGRENIMSURESI]
						,[OGRENIMTURU]
						,[PUANTURU]--CASE WHEN [PUANTURU] LIKE 'YGS%' THEN 'TYT' WHEN [PUANTURU] LIKE 'MF%' THEN 'SAY' WHEN [PUANTURU] LIKE 'TS%' THEN 'SOZ' WHEN [PUANTURU] LIKE 'TM%' THEN 'EA' WHEN [PUANTURU] LIKE 'DİL%' THEN 'DİL' END
						,[YIL]
						,[TABANPUAN]--CASE WHEN [TABANPUAN] is null THEN '0' ELSE [TABANPUAN] END
						,[KONTENJAN]
						,[PROGRAMTURU]
						,[SONYGSYERLESTIRME]
						,[OKULBIRINCILIGIKONTENJANI]
						,[YERONCELIKLERI]
						,[ENBUYUKPUAN]
						,[BASARISIRALAMA]
						,[OZELKOSULACIKLAMA]
					FROM @DATATABLE d -- Where [PROGRAMKODU] NOT IN (SELECT [PROGRAMKODU] FROM UniversiteTabanPuanlari u where u.[YIL]=d.[YIL])
			END

			IF @ISLEM = 1 	--	Üniversite taban puan select
			BEGIN
				DECLARE @COLUMNNAME VARCHAR(MAX)=(SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'UniversiteTabanPuanlari' AND TABLE_SCHEMA='dbo' AND ORDINAL_POSITION = (SELECT JSON_Value (value, '$.column') FROM OPENJSON(@SQLJSON,'$.order')))
				SET @orderByClause = (SELECT ' ORDER BY '+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
				SET @whereClause = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				SET @displayStart = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT))
				SET @displayLength = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF	@whereClause=''
				BEGIN
					SET @whereClause='where YIL='''+@DONEM+''''
				END
				ELSE
				BEGIN
					DECLARE @COLUMNS VARCHAR(max) = ''
					SET @COLUMNS='('+(SELECT ' ' + COLUMN_NAME + ' LIKE ''%' + @whereClause + '%'' OR' AS [text()] FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'UniversiteTabanPuanlari' AND TABLE_SCHEMA = 'dbo'
					For XML PATH (''))+')'
					SET @COLUMNS = SUBSTRING(@COLUMNS,1,LEN(@COLUMNS)-3)+') '
					SET @whereClause='WHERE '+@COLUMNS
					SET @whereClause=@whereClause+' and YIL='''+@DONEM+''''
				END
				Declare @query varchar(MAX)
				set @query='
							SELECT * INTO #TEMP FROM   
									(
										SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * FROM(
											SELECT
											*  FROM UniversiteTabanPuanlari 
											'+@whereClause+'
										) 
									RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM UniversiteTabanPuanlari) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'
				execute (@query)
			END

			IF @ISLEM = 2	--	Üniversite taban puan delete
			BEGIN
				DELETE UniversiteTabanPuanlari WHERE YIL = @DONEM
			END

			IF @ISLEM = 3 	--	Üniversite taban puan select ÖĞRENCİ
			BEGIN
				DECLARE @TUR VARCHAR(10), @SIRA INT
				SELECT @SIRA=JSON_Value (value, '$.column'), @TUR=JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')

				SET @orderByClause = ' ORDER BY '
								+ CASE WHEN @SIRA=0  THEN 'IL'
									   WHEN @SIRA=1  THEN 'UNIVERSITE'
									   WHEN @SIRA=2  THEN 'FAKULTE'
									   WHEN @SIRA=3  THEN 'BOLUM'
									   WHEN @SIRA=4  THEN 'UNIVERSITETURU'
									   WHEN @SIRA=5  THEN 'UCRETBURS'
									   WHEN @SIRA=6  THEN 'OGRENIMSURESI'
									   WHEN @SIRA=7  THEN 'PUANTURU'
									   WHEN @SIRA=8  THEN 'YIL'
									   WHEN @SIRA=9  THEN 'TABANPUAN'
									   WHEN @SIRA=10 THEN 'KONTENJAN' 
									   ELSE 'TABANPUAN' END
								+ ' ' +	@TUR					
				
				SET @whereClause = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				SET @displayStart = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT))
				SET @displayLength = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF	@whereClause=''
				BEGIN
					SET @whereClause='where YIL='''+@DONEM+''''
				END
				ELSE
				BEGIN
					DECLARE @COLUMNSOGRENCI VARCHAR(max) = ''
					SET @COLUMNSOGRENCI='(IL				LIKE ''%'+@whereClause+'%'' OR
										  UNIVERSITE		LIKE ''%'+@whereClause+'%'' OR
										  FAKULTE			LIKE ''%'+@whereClause+'%'' OR
										  BOLUM				LIKE ''%'+@whereClause+'%'' OR
										  UNIVERSITETURU	LIKE ''%'+@whereClause+'%'' OR
										  UCRETBURS			LIKE ''%'+@whereClause+'%'' OR
										  OGRENIMSURESI		LIKE ''%'+@whereClause+'%'' OR
										  PUANTURU			LIKE ''%'+@whereClause+'%'' OR
										  YIL				LIKE ''%'+@whereClause+'%'' OR
										  TABANPUAN			LIKE ''%'+@whereClause+'%'' OR
										  KONTENJAN			LIKE ''%'+@whereClause+'%'')'

					SET @whereClause='WHERE '+@COLUMNSOGRENCI
					SET @whereClause=@whereClause+' and YIL='''+@DONEM+''''
				END
				SET @whereClause+=' AND PROGRAMKODU NOT IN (SELECT PROGRAMKODU FROM OgrenciHedef WHERE TCKIMLIKNO='''+@TCKIMLIKNO+''' AND AKTIF=1 AND DONEM = ''' + @DONEM + ''')'
				Declare @queryogrenci varchar(MAX)
				set @queryogrenci='
							SELECT * INTO #TEMP FROM   
									(
										SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * FROM(
											SELECT 
												   *
											FROM UniversiteTabanPuanlari tp
											'+@whereClause+@FILTER+'
										) 
									RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT RowNumber, [PROGRAMKODU]
												  ,[UNIVERSITE]
												  ,[FAKULTE]
												  ,[BOLUM]
												  ,[BOLUM2]
												  ,[EGITIMDILI]
												  ,[UCRETBURS]
												  ,[IL]
												  ,[UNIVERSITETURU]
												  ,[OGRENIMSURESI]
												  ,[OGRENIMTURU]
												  ,[PUANTURU]
												  ,[YIL]
												  ,[TABANPUAN]
												  ,[KONTENJAN]
												  ,[PROGRAMTURU]
												  ,[SONYGSYERLESTIRME]
												  ,[OKULBIRINCILIGIKONTENJANI]
												  ,[YERONCELIKLERI]
												  ,[ENBUYUKPUAN]
												  ,[BASARISIRALAMA]
												  ,REPLACE((STUFF((SELECT CAST(''@@** '' + [KOSUL] AS VARCHAR(MAX)) 
															 FROM UniversiteOzelKosul ok
															 WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,'' '','''') , '',''))
															 FOR XML PATH ('''')), 1, 2, '''')),''@@'',''<br /><br />'') AS [OZELKOSULACIKLAMA] FROM #TEMP tp
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM UniversiteTabanPuanlari) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'
				execute (@queryogrenci)
			END

			IF @ISLEM = 4	--	Üniversite İl Listele
			BEGIN
				SELECT
				(
					SELECT IL FROM UniversiteTabanPuanlari 
					GROUP BY IL
					ORDER BY COUNT(IL) DESC
					FOR JSON PATH
				) ILLER
			END 

			IF @ISLEM = 5	--	Üniversite Tür Listele
			BEGIN
				SELECT
				(
					SELECT UNIVERSITETURU FROM UniversiteTabanPuanlari 
					GROUP BY UNIVERSITETURU
					ORDER BY COUNT(UNIVERSITETURU) DESC
					FOR JSON PATH
				) TURLER
			END 

			IF @ISLEM = 6	--	Üniversite Puan Türü Listele
			BEGIN
				SELECT
				(
					SELECT DISTINCT SPT.* FROM SinavOgrenciSonuc SOS
					INNER JOIN SinavOgrenci SO ON SO.ID_SINAVOGRENCI=SOS.ID_SINAVOGRENCI
					INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU=SOS.ID_SINAVPUANTURU
					WHERE SO.TCKIMLIKNO=@TCKIMLIKNO AND SPT.ID_SINAVTURU IN (2,3)
					FOR JSON AUTO
				) PUANTURLER
			END 

			IF @ISLEM = 7	--	Üniversite Bölüm Listele
			BEGIN
				SELECT
				(
					SELECT BOLUM FROM UniversiteTabanPuanlari 
					WHERE 
							BOLUM IS NOT NULL 
						AND (@IL='' or @IL='0' or IL=@IL) 
						AND (@UNIVERSITETURU='' or @UNIVERSITETURU='0' or UNIVERSITETURU=@UNIVERSITETURU) 
						AND (@PUANTURU='' or @PUANTURU='0' or PUANTURU=(SELECT KOD FROM SinavPuanTuru WHERE ID_SINAVPUANTURU=@PUANTURU)) 
						AND YIL = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
					GROUP BY BOLUM
					ORDER BY BOLUM ASC
					FOR JSON AUTO
				) PUANTURLER
			END 

			IF @ISLEM = 8	--	Üniversite Puan Türü Listele Genel
			BEGIN
				SELECT
				(
					SELECT DISTINCT SPT.* FROM SinavPuanTuru SPT
					WHERE SPT.ID_SINAVTURU IN (2,3, 4)
					FOR JSON AUTO
				) PUANTURLER
			END 


			IF @ISLEM = 9	--	OSYM OZEL KOŞULLAR EXCEL YÜKLE
			BEGIN

				
					DELETE FROM [Pusulam].[dbo].[UniversiteOzelKosul]
					


					--DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  
					INSERT INTO [Pusulam].[dbo].[UniversiteOzelKosul] ([NO],KOSUL)
					--OUTPUT inserted.NUMARA, inserted.KOSUL
					--INTO @INSERTEDSORU
					SELECT Kosul_No, Aciklama FROM OPENJSON(@SQLJSON)
					WITH (
						Kosul_No		INT,
						Aciklama	VARCHAR(MAX)
					)

					
					
				END
			END
		

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_OzelSayfaIslemleri]    Script Date: 23.11.2021 15:09:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_OzelSayfaIslemleri]

	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,

	@AKTIF					BIT				= NULL,
	@ID_OZELSAYFA			INT				= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,AKTIF					= @AKTIF
				,ID_OZELSAYFA			= @ID_OZELSAYFA
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

		IF @_ID_LOG > 0
		BEGIN

			IF @ISLEM = 1	--	ÖZEL SAYFA TÜR LİSTESİ	
			BEGIN
				SELECT (
					SELECT ID_OZELSAYFATURU, AD
					FROM OzelSayfaTuru
					FOR JSON PATH,INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 2	--	ÖZEL SAYFA EKLE/DÜZENLE	
			BEGIN

				DROP TABLE IF EXISTS #TEMP

				SELECT	 AD					= JS.AD
						,ACIKLAMA			= JS.ACIKLAMA
						,YOL				= JS.YOL
						,ID_OZELSAYFATURU	= JS.ID_OZELSAYFATURU
						,ID_KULLANICITIPI	= KTL.VALUE
						--,ID_KADEME			= KL.VALUE
						,ID_KADEME3			= KL3.VALUE
				INTO #TEMP
				FROM OPENJSON (@SQLJSON)
				WITH(	 AD						NVARCHAR(MAX)
						,ACIKLAMA				NVARCHAR(MAX)
						,YOL					NVARCHAR(MAX)
						,ID_KULLANICITIPILIST	NVARCHAR(MAX) AS JSON
						--,ID_KADEMELIST			NVARCHAR(MAX) AS JSON
						,ID_KADEME3LIST			NVARCHAR(MAX) AS JSON
						,ID_OZELSAYFATURU		INT
				) AS JS
				CROSS APPLY OPENJSON (ID_KULLANICITIPILIST) AS KTL
				--CROSS APPLY OPENJSON (ID_KADEMELIST) AS KL
				CROSS APPLY OPENJSON (ID_KADEME3LIST) AS KL3
				JOIN v3KullaniciTipi	KT	ON	KT.ID_KULLANICITIPI	= KTL.VALUE
				--JOIN v3Kademe			K	ON	K.ID_KADEME			= KL.VALUE
				JOIN v3Kademe3			K3	ON	K3.ID_KADEME3		= KL3.VALUE

				UPDATE #TEMP SET
					YOL = 'http://' + YOL
				WHERE ID_OZELSAYFATURU = 1 
					AND YOL NOT LIKE  'http%'

				IF @ID_OZELSAYFA IS NULL
				BEGIN
					DECLARE @INSERTEDTABLE TABLE (ID INT)

					INSERT INTO OzelSayfa (ID_OZELSAYFATURU, YOL, AD, ACIKLAMA, KYE_TCKIMLIKNO)
					OUTPUT inserted.ID_OZELSAYFA INTO @INSERTEDTABLE(ID)
					SELECT TOP 1 ID_OZELSAYFATURU, YOL, AD, ACIKLAMA, @TCKIMLIKNO FROM #TEMP

					SET @ID_OZELSAYFA = (SELECT TOP 1 ID FROM @INSERTEDTABLE)

				END
				ELSE
				BEGIN

					UPDATE OzelSayfa SET
						AD			= (SELECT TOP 1 AD			FROM #TEMP),
						ACIKLAMA	= (SELECT TOP 1 ACIKLAMA	FROM #TEMP),
						YOL			= (SELECT TOP 1 YOL			FROM #TEMP)
					WHERE ID_OZELSAYFA = @ID_OZELSAYFA

				END


				DELETE FROM OzelSayfaYetki WHERE ID_OZELSAYFA = @ID_OZELSAYFA
				INSERT INTO OzelSayfaYetki (ID_OZELSAYFA, ID_KULLANICITIPI, ID_KADEME, ID_KADEME3)
				SELECT DISTINCT @ID_OZELSAYFA, ID_KULLANICITIPI, KB.ID_KADEME, KB.ID_KADEME3 
				FROM #TEMP			T
				JOIN v3KademeBilgi	KB	ON	KB.ID_KADEME3 = T.ID_KADEME3
				
				DROP TABLE IF EXISTS #TEMP
			END

			IF @ISLEM = 3	--	ÖZEL SAYFA DETAY		
			BEGIN
				SELECT ISNULL((
					SELECT	 ID_OZELSAYFA
							,AD
							,ACIKLAMA
							,YOL
							,ID_OZELSAYFATURU
							,ID_KULLANICITIPILIST	= (SELECT DISTINCT ID_KULLANICITIPI	FROM OzelSayfaYetki Y WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA FOR JSON PATH)
							,ID_KADEMELIST			= (SELECT DISTINCT ID_KADEME		FROM OzelSayfaYetki Y WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA FOR JSON PATH)
							,ID_KADEME3LIST			= (SELECT DISTINCT ID_KADEME3		FROM OzelSayfaYetki Y WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA FOR JSON PATH)
					FROM OzelSayfa		OS
					WHERE OS.ID_OZELSAYFA = @ID_OZELSAYFA
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')
			END

			IF @ISLEM = 4	--	ÖZEL SAYFA LİSTE		
			BEGIN
				DROP TABLE IF EXISTS #TEMP4

				SELECT	 ID_KULLANICITIPI	= KTL.VALUE 
						,ID_KADEME			= KL.VALUE
						,ID_KADEME3			= KL3.VALUE
				INTO #TEMP4
				FROM OPENJSON (@SQLJSON)
				WITH(	 ID_KULLANICITIPILIST	NVARCHAR(MAX) AS JSON
						,ID_KADEMELIST			NVARCHAR(MAX) AS JSON	
						,ID_KADEME3LIST			NVARCHAR(MAX) AS JSON						
				) AS JS
				CROSS APPLY OPENJSON (ID_KULLANICITIPILIST)	AS KTL
				CROSS APPLY OPENJSON (ID_KADEMELIST)		AS KL
				CROSS APPLY OPENJSON (ID_KADEME3LIST)		AS KL3

				SELECT ISNULL((
					SELECT DISTINCT
						 OS.ID_OZELSAYFA
						,OS.AD
						,OS.ACIKLAMA
						,OS.YOL
						,OS.ID_OZELSAYFATURU
						,OZELSAYFATURU			= OST.AD
						,OS.AKTIF
						,ID_KULLANICITIPILIST	= (	SELECT DISTINCT KT.AD
													FROM OzelSayfaYetki		Y  
													JOIN v3KullaniciTipi	KT	ON	KT.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
													WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA 
													FOR JSON PATH)
						,ID_KADEMELIST			= (	SELECT DISTINCT K.AD
													FROM OzelSayfaYetki		Y 
													JOIN v3Kademe			K	ON	K.ID_KADEME			= Y.ID_KADEME
													WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA 
													FOR JSON PATH)
						,ID_KADEME3LIST			= (	SELECT DISTINCT K.AD
													FROM OzelSayfaYetki		Y 
													JOIN v3Kademe3			K	ON	K.ID_KADEME3		= Y.ID_KADEME3
													WHERE Y.ID_OZELSAYFA = OS.ID_OZELSAYFA 
													FOR JSON PATH)
					FROM OzelSayfa		OS
					JOIN OzelSayfaTuru	OST	ON	OST.ID_OZELSAYFATURU= OS.ID_OZELSAYFATURU
					JOIN OzelSayfaYetki	Y	ON	Y.ID_OZELSAYFA		= OS.ID_OZELSAYFA
					JOIN #TEMP4			T	ON	T.ID_KADEME			= Y.ID_KADEME
											AND T.ID_KADEME3		= Y.ID_KADEME3
											AND T.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

				DROP TABLE IF EXISTS #TEMP4
			END

			IF @ISLEM = 5	--	ÖZEL SAYFA AKTIF/PASIF	
			BEGIN
				UPDATE OzelSayfa SET
					AKTIF = @AKTIF
				WHERE ID_OZELSAYFA = @ID_OZELSAYFA
			END

			IF @ISLEM = 6	--	ÖZEL SAYFA SİL			
			BEGIN
				DELETE FROM OzelSayfaYetki
				WHERE ID_OZELSAYFA = @ID_OZELSAYFA
				
				DELETE FROM OzelSayfa
				WHERE ID_OZELSAYFA = @ID_OZELSAYFA
			END

		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT	@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Parametre]    Script Date: 23.11.2021 15:10:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Parametre]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_PARAMETREDEGER		INT				= NULL,
	@ID_PARAMETRE			INT				= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 16.09.20202
	
	--	sp CREATE 
		--	
	--	PARAMETRE 

*/
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU
				
				,ID_PARAMETREDEGER		= @ID_PARAMETREDEGER
				,ID_PARAMETRE			= @ID_PARAMETRE
				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	PARAMETRE LİST		
			BEGIN
				
				SELECT ISNULL((
					SELECT	 PG.ID_PARAMETREGRUP
							,PG.AD
							,PARAMETREDEGERLIST = (
								SELECT	 SPD.ID_PARAMETREDEGER
										,SPD.AD
										,SPD.DEGER
								FROM ParametreDeger	SPD
								WHERE SPD.ID_PARAMETREGRUP	= PG.ID_PARAMETREGRUP
								FOR JSON PATH
							)
							,PARAMETRELIST.ID_PARAMETRE
							,PARAMETRELIST.ID_PARAMETREDEGER
							,PARAMETRELIST.AD			
					FROM ParametreGrup			PG
					JOIN Parametre				PARAMETRELIST	ON	PARAMETRELIST.ID_PARAMETREGRUP	= PG.ID_PARAMETREGRUP
					LEFT JOIN ParametreDeger	PD				ON	PD.ID_PARAMETREDEGER			= PARAMETRELIST.ID_PARAMETREDEGER
					FOR JSON AUTO, INCLUDE_NULL_VALUES, ROOT('ParametreList')
				),'{"ParametreList":[]}')
				
			END
			
			IF @ISLEM = 2	--	PARAMETRE SET		
			BEGIN
				
				;WITH TABLE1 AS (
				SELECT ID_PARAMETREDEGER,AD,DEGER
				FROM OPENJSON(@SQLJSON)
				WITH(
					PARAMETREDEGERLIST NVARCHAR(MAX) AS JSON	
				) AS J
				CROSS APPLY OPENJSON(J.PARAMETREDEGERLIST)
				WITH(
					 ID_PARAMETREDEGER	INT
					,AD					VARCHAR(MAX)
					,DEGER				VARCHAR(MAX)
				) AS PD
				
				
				)
				UPDATE P SET
				P.DEGER	= T.DEGER
				FROM ParametreDeger	P
				JOIN TABLE1		T	ON	T.ID_PARAMETREDEGER = P.ID_PARAMETREDEGER

				;WITH TABLE2 AS (
					SELECT PL.ID_PARAMETRE, PL.ID_PARAMETREDEGER
					FROM OPENJSON (@SQLJSON) 
					WITH (
						PARAMETRELIST	NVARCHAR(MAX) AS JSON
					)
					AS J
					CROSS APPLY OPENJSON(J.PARAMETRELIST)
					WITH(
						ID_PARAMETRE		INT,
						ID_PARAMETREDEGER	INT
					) AS PL
				)
				
				UPDATE P SET
					P.ID_PARAMETREDEGER	= T.ID_PARAMETREDEGER
				FROM Parametre	P
				JOIN TABLE2		T	ON	T.ID_PARAMETRE = P.ID_PARAMETRE
				
			END

		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProjeDonem]    Script Date: 23.11.2021 15:10:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_ProjeDonem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@TC					VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@SINIFTIP			varchar(50)		= NULL,
	@ID_PROJETALEP		int				= NULL,
	@ID_PROJEDOSYA		int				= NULL,
	@ID_KULLANICI		int				= NULL,
	@ID_OGRENCI			int				= NULL,
	@SIRA				int				= NULL,
	@KRITER				int				= NULL,
	@DEGER				int				= NULL,
	@DURUM				int				= NULL,
	@YARIYIL			int				= 1,
	@DOSYA				NVARCHAR(MAX)	= NULL,
	@KONU				NVARCHAR(MAX)	= NULL,
	@KONTROL			NVARCHAR(MAX)	= NULL,
	@KONTROLTARIH		NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,TC							= @TC				
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_DERS					= @ID_DERS		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAGUID					= @DOSYAGUID		
			,SINIFTIP					= @SINIFTIP		
			,ID_PROJETALEP				= @ID_PROJETALEP	
			,ID_PROJEDOSYA				= @ID_PROJEDOSYA	
			,ID_KULLANICI				= @ID_KULLANICI	
			,ID_OGRENCI					= @ID_OGRENCI		
			,SIRA						= @SIRA			
			,KRITER						= @KRITER			
			,DEGER						= @DEGER			
			,DURUM						= @DURUM			
			,YARIYIL					= @YARIYIL		
			,DOSYA						= @DOSYA			
			,KONU						= @KONU			
			,KONTROL					= @KONTROL		
			,KONTROLTARIH				= @KONTROLTARIH	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)


	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1		-- KADEME
		BEGIN
			SELECT (
				SELECT TOP 1  kk.ID_KADEME
				FROM		OkyanusDB.dbo.v3Kullanici				K
				INNER JOIN	OkyanusDB.dbo.v4KullaniciKademe	kk	on	kk.TCKIMLIKNO = k.TCKIMLIKNO	
				WHERE K.TCKIMLIKNO = @TCKIMLIKNO and kk.ID_KADEME != 1 AND K.AKTIF = 1
				FOR JSON PATH
			)
		END

		
		IF @ISLEM = 2		-- SINIF DERS LİSTESİ				
		BEGIN
			--if @SINIFTIP='nor'			
			IF NOT EXISTS(SELECT TOP 1 1 FROM eokul_v2.DBO.KurSinifi WHERE ID_KUR = @ID_SINIF)
			begin
				SELECT(
					SELECT (
						SELECT  distinct
										sd.ID_DERS,
										d.DERSAD as DERSAD
						FROM		eokul_v2.dbo.DersOgretmen	sd
						inner join	OkyanusDB.dbo.v3Sinif		snf on	snf.ID_SINIF	= sd.ID_SINIF
						inner join	eokul_v2.dbo.Ders		d	on	d.ID_DERS		= sd.ID_DERS
						 left join	OkyanusDB.dbo.v3EgitimTuru	e	on	e.ID_EGITIMTURU	= sd.ID_EGITIMTURU
						WHERE SD.ID_SINIF	= @ID_SINIF 
						  AND DONEMKOD		= @AKTIFDONEM
						  AND e.ID_EGITIMTURU = 6
						ORDER BY DERSAD				
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end
			else --if @SINIFTIP='kur'
			begin
				SELECT(
					SELECT (
						SELECT distinct						
										sd.ID_DERS,
										d.DERSAD as DERSAD
						FROM eokul_v2.dbo.DersOgretmen sd
						inner join eokul_v2.dbo.KurSinifi snf on snf.ID_KUR=sd.ID_SINIF
						inner join eokul_v2.dbo.Ders d on d.ID_DERS=sd.ID_DERS
						 left join OkyanusDB.dbo.v3EgitimTuru e on e.ID_EGITIMTURU=sd.ID_EGITIMTURU
						WHERE SD.ID_SINIF=@ID_SINIF 
						  AND snf.DONEMKOD=@AKTIFDONEM 
						  and snf.AKTIF=1
						  AND e.ID_EGITIMTURU = 6
						  --AND d.AKTIF=1
						ORDER BY DERSAD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end
		END
				
		IF @ISLEM = 4		-- PROJE DURUM UPDATE				
		BEGIN	
			SET @ID_KULLANICI = ( SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)

			Update Pusulam.dbo.ProjeTalep Set  
				 DURUM			= @DURUM
				,ID_KULLANICI	= @ID_KULLANICI
				,KAYIT_TARIHI	= GETDATE() 
			where ID_PROJETALEP=@ID_PROJETALEP		
			select 1	
		END

		--OgretmenProjeTalepleri
		IF @ISLEM = 6		-- BRANŞ ÖĞRETMEN SINIF LİSTESİ		
		BEGIN
			IF @TC_OGRETMEN IS NULL OR @TC_OGRETMEN = ''
				SET @TC =(SELECT TCKIMLIKNO FROM OkyanusDB.dbo.v3Kullanici where OTURUM=@OTURUM)
			ELSE
				SET @TC = @TC_OGRETMEN


			--IF @ID_SINIF>70000			
			IF NOT EXISTS(SELECT TOP 1 1 FROM eokul_v2.DBO.KurSinifi WHERE ID_KUR = @ID_SINIF)
			BEGIN		
				SELECT(
					SELECT (					
						Select   
							ID_OGRENCI			= o.ID_OGRENCI,
							ADSOYAD				= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							FOTOGRAF			= isnull(Cast(r.FOTOGRAF AS VARBINARY(MAX)) ,0) ,
							OGRNO				= CAST(o.OgrNo AS VARCHAR),
							ID_SINIF			= sn.ID_SINIF,
							SINIFAD				= sn.AD,
							ID_DERS				= p.ID_DERS,
							KONU				= isnull(p.KONU,''),
							DURUM				= p.DURUM,
							DURUMACIKLAMA			= case when p.DURUM=0 then ''
													when p.DURUM=1 then 'Talebiniz alındı'
													when p.DURUM=2 then 'Kabul Edildi'
													when p.DURUM=3 then 'Reddedildi'
													end,
							ID_PROJETALEP		= p.ID_PROJETALEP ,
							KONTROLBIR			= isnull(pp.KONTROLBIR,''),
							KONTROLBIRTARIH		= isnull(pp.KONTROLBIRTARIH,''),
							KONTROLIKI			= isnull(pp.KONTROLIKI,''),
							KONTROLIKITARIH		= isnull(pp.KONTROLIKITARIH,''),
							KONTROLUC			= isnull(pp.KONTROLUC,''),
							KONTROLUCTARIH		= isnull(pp.KONTROLUCTARIH,''),
							KONTROLDORT			= isnull(pp.KONTROLDORT,''),
							KONTROLDORTTARIH	= isnull(pp.KONTROLDORTTARIH,''),
							PROJENOT			= isnull(pp.PROJENOT,0),
							PROJEDEGERLENDIRME	= isnull(pp.PROJEDEGERLENDIRME,''),
							DERSAD				= de.DERSAD,
							PLANOLUSTURMA		= isnull(pp.PLANOLUSTURMA,0),
							KAYNAKKULLANIM		= isnull(pp.KAYNAKKULLANIM,0),
							ISBIRLIGI			= isnull(pp.ISBIRLIGI,0),
							DILKULLANIM			= isnull(pp.DILKULLANIM,0),
							KAVRAMA				= isnull(pp.KAVRAMA,0),
							DERECE				= isnull(pp.DERECE,''),
							SIRA				= isnull(p.SIRA,0)
						from Pusulam.dbo.ProjeTalep p 
							inner join OkyanusDB.dbo.v3Ogrenci     o	on	p.ID_OGRENCI	= o.ID_OGRENCI
							inner join OkyanusDB.dbo.v3Donem       dn	on	dn.ID_DONEM		= o.ID_DONEM 
							inner join OkyanusDB.dbo.v3Kullanici   b	on	b.TCKIMLIKNO	= o.TCKIMLIKNO
							left join  Pusulam.dbo.ProjeNot			pp	on	pp.ID_PROJETALEP= p.ID_PROJETALEP
							left join  OkyanusDB.dbo.v3Resim		r	on	r.TCKIMLIKNO	= b.TCKIMLIKNO
							inner join OkyanusDB.dbo.v3Sinif       sn	on	sn.ID_SINIF		= p.ID_SINIF
							inner join eokul_v2.dbo.Ders			de	on	de.ID_DERS		= p.ID_DERS
							WHERE	p.ID_SINIF	= @ID_SINIF 
								and dn.KOD		= @AKTIFDONEM
								and p.YARIYIL	= @YARIYIL
								and
								  (((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC and ID_KULLANICITIPI  in (3,27,28,59))>0 and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen do  where do.TC_OGRETMEN=@TC and do.ID_SINIF=@ID_SINIF)) or
								   ((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC and ID_KULLANICITIPI  in (53,54))>0 and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen))
								  )
						order by b.AD,b.Soyad		
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS

				

			END
			ELSE
			BEGIN
			
				SELECT(
					SELECT (
					
						Select   
							ID_OGRENCI			= o.ID_OGRENCI,
							ADSOYAD				= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							FOTOGRAF			= isnull(Cast(r.FOTOGRAF AS VARBINARY(MAX)) ,0) ,
							OGRNO				= CAST(o.OgrNo AS VARCHAR),
							ID_SINIF			= S.ID_KUR,
							SINIFAD				= s.KURSINIFI,
							ID_DERS				= p.ID_DERS,
							KONU				= isnull(p.KONU,''),
							DURUM				= p.DURUM,
							DURUMACIKLAMA			= case when p.DURUM=0 then ''
													when p.DURUM=1 then 'Talebiniz alındı'
													when p.DURUM=2 then 'Kabul Edildi'
													when p.DURUM=3 then 'Reddedildi'
													end,
							ID_PROJETALEP		= p.ID_PROJETALEP ,
							KONTROLBIR			= isnull(pp.KONTROLBIR,''),
							KONTROLBIRTARIH		= isnull(pp.KONTROLBIRTARIH,''),
							KONTROLIKI			= isnull(pp.KONTROLIKI,''),
							KONTROLIKITARIH		= isnull(pp.KONTROLIKITARIH,''),
							KONTROLUC			= isnull(pp.KONTROLUC,''),
							KONTROLUCTARIH		= isnull(pp.KONTROLUCTARIH,''),
							KONTROLDORT			= isnull(pp.KONTROLDORT,''),
							KONTROLDORTTARIH	= isnull(pp.KONTROLDORTTARIH,''),
							PROJENOT			= isnull(pp.PROJENOT,0),
							PROJEDEGERLENDIRME	= isnull(pp.PROJEDEGERLENDIRME,''),
							DERSAD				= de.DERSAD,
							PLANOLUSTURMA		= isnull(pp.PLANOLUSTURMA,0),
							KAYNAKKULLANIM		= isnull(pp.KAYNAKKULLANIM,0),
							ISBIRLIGI			= isnull(pp.ISBIRLIGI,0),
							DILKULLANIM			= isnull(pp.DILKULLANIM,0),
							KAVRAMA				= isnull(pp.KAVRAMA,0),
							DERECE				= isnull(pp.DERECE,''),
							SIRA				= isnull(p.SIRA,0)
						from eokul_v2.DBO.KurSinifi		s 
						inner join eokul_v2.DBO.KurOgrenci		k	on	k.ID_KUR		= s.ID_KUR
						inner join OkyanusDB.dbo.v3Ogrenci     o	on	k.ID_OGRENCI	= o.ID_OGRENCI
						inner join OkyanusDB.dbo.v3Kullanici   b	on	b.TCKIMLIKNO	= o.TCKIMLIKNO
						inner join Pusulam.dbo.ProjeTalep		p	on	p.ID_OGRENCI	= o.ID_OGRENCI
						left join  Pusulam.dbo.ProjeNot		pp  on	pp.ID_PROJETALEP= p.ID_PROJETALEP
						left join  OkyanusDB.dbo.v3Resim		r	on	r.TCKIMLIKNO	= b.TCKIMLIKNO
						inner join eokul_v2.dbo.Ders		de	on	de.ID_DERS		= p.ID_DERS
						WHERE	s.ID_KUR	= @ID_SINIF 						
							and p.YARIYIL	= @YARIYIL
							and s.AKTIF		<>0  
							and
								(((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC 
																				and ID_KULLANICITIPI  in (3,27,28,59))>0 
																				and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen do  where do.ID_OGRETMEN in (Select ID_OGRETMEN from OkyanusDB.dbo.v3Ogretmen where TCKIMLIKNO=@TC) and do.ID_SINIF=@ID_SINIF)) or
								((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC 
																				and ID_KULLANICITIPI  in (53,54))>0 
																				and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen)))
						order by b.AD,b.Soyad					
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			END
		END

		--ProjeKontrol
		IF @ISLEM = 8		-- KONTROL KAYIT UPDATE				
		BEGIN
			
			IF (Select COUNT(1) from Pusulam.dbo.ProjeNot where ID_PROJETALEP=@ID_PROJETALEP)=0
			BEGIN
				INSERT INTO Pusulam.dbo.ProjeNot(ID_PROJETALEP)
				Values(@ID_PROJETALEP)
			END
			
			Update p 
			Set 
				 KONTROLBIR			= case when @SIRA = 1 then @KONTROL else p.KONTROLBIR end
				,KONTROLBIRTARIH	= case when @SIRA = 1 then @KONTROLTARIH else p.KONTROLBIRTARIH end
					
				,KONTROLIKI			= case when @SIRA = 2 then @KONTROL else p.KONTROLIKI end
				,KONTROLIKITARIH	= case when @SIRA = 2 then @KONTROLTARIH else p.KONTROLIKITARIH end

				,KONTROLUC			= case when @SIRA = 3 then @KONTROL else p.KONTROLUC end
				,KONTROLUCTARIH		= case when @SIRA = 3 then @KONTROLTARIH else p.KONTROLUCTARIH end

				,KONTROLDORT		= case when @SIRA = 4 then @KONTROL else p.KONTROLDORT end
				,KONTROLDORTTARIH	= case when @SIRA = 4 then @KONTROLTARIH else p.KONTROLDORTTARIH end

				,PROJEDEGERLENDIRME	= case when @SIRA = 5 then @KONTROL else p.PROJEDEGERLENDIRME end

			from Pusulam.dbo.ProjeNot p	
			where ID_PROJETALEP=@ID_PROJETALEP
			
			SELECT 1
		END
		
		IF @ISLEM = 10		-- ÖĞRENCİ PROJE TALEP LİSTESİ		
		BEGIN
		-- exec sp_ProjeDonem @TCKIMLIKNO='11198554824',@OTURUM='74AFE741-2F2C-44E4-A6DF-AEA4DCE0DC0A',@YARIYIL=1, @ISLEM=10

		
			IF @ID_OGRENCI = 0 or @ID_OGRENCI IS NULL
			BEGIN
				Set @TC=(Select TCKIMLIKNO from OkyanusDB.dbo.v3Kullanici where OTURUM=@OTURUM)
			END
			ELSE
			BEGIN
				Set @TC=(Select TCKIMLIKNO from OkyanusDB.dbo.v3Ogrenci where ID_OGRENCI=@ID_OGRENCI) 
			END

			IF @TC_OGRENCI != '' AND @TC_OGRENCI IS NOT NULL
			BEGIN
				Set @TC=@TC_OGRENCI
			END
			
			SELECT(
				SELECT (
					Select   
						--ID_OGRENCI			= o.ID_OGRENCI,
						--ID_DERS				= d.ID_DERS,
						DERSAD				= d.DERSAD ,
						KONU				= isnull(p.KONU,''),
						OGRETMENADSOYAD		= isnull(k.AD + ' ' +k.SOYAD,''),
						ID_PROJETALEP		= isnull(p.ID_PROJETALEP,0),
						KONTROLBIR			= isnull(pp.KONTROLBIR,''),
						KONTROLBIRTARIH		= isnull(pp.KONTROLBIRTARIH,''),
						KONTROLIKI			= isnull(pp.KONTROLIKI,''),
						KONTROLIKITARIH		= isnull(pp.KONTROLIKITARIH,''),
						KONTROLUC			= isnull(pp.KONTROLUC,''),
						KONTROLUCTARIH		= isnull(pp.KONTROLUCTARIH,''),
						KONTROLDORT			= isnull(pp.KONTROLDORT,''),
						KONTROLDORTTARIH	= isnull(pp.KONTROLDORTTARIH,''),
						--PROJENOT			= isnull(pp.PROJENOT,0),
						--DURUM				= isnull(p.DURUM,5),
						PROJEDEGERLENDIRME	= isnull(pp.PROJEDEGERLENDIRME,''),
						DOSYADURUM			= case when (Select COUNT(1) from ProjeDosya where ID_PROJETALEP=p.ID_PROJETALEP and SILINDI=0)>0 then 1 else 0 end,
						kk3.ID_KADEME
					from		OkyanusDB.dbo.v3Ogrenci		o 
					inner join	OkyanusDB.dbo.v3Sinif		sn	on	sn.ID_SINIF		= o.ID_SINIF
					left join	ProjeTalep					p	on	p.ID_OGRENCI	= o.ID_OGRENCI 
					left join	ProjeNot					pp  on	pp.ID_PROJETALEP= p.ID_PROJETALEP
					left join	OkyanusDB.dbo.v3Kullanici	k	on	k.TCKIMLIKNO	= p.TC_OGRETMEN
					inner join	eokul_v2.dbo.Ders			d	on	d.ID_DERS		= p.ID_DERS 
					inner join  v3KullaniciKademe3			kk3	on	kk3.TCKIMLIKNO	= o.TCKIMLIKNO
					WHERE	o.TCKIMLIKNO	= @TC
						and p.DURUM			= 2
						and p.YARIYIL		= @YARIYIL
						--and p.ID_PROJETALEP = @ID_PROJETALEP
					order by p.SIRA	
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS SS
			         
	
		END	
		
		--ProjeSinifListesi
		IF @ISLEM = 14		-- BR/DN ÖĞRETMEN KONTROL FORMU		
		BEGIN
			
			--if @SINIFTIP='nor'
			IF NOT EXISTS(SELECT TOP 1 1 FROM eokul_v2.DBO.KurSinifi WHERE ID_KUR = @ID_SINIF)
			begin	
				SELECT(
					SELECT (
						Select   
							ID_OGRENCI		= o.ID_OGRENCI,
							ADSOYAD			= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							OGRNO			= o.OGRNO,
							ID_SINIF		= sn.ID_SINIF,
							SINIFAD			= sn.AD,
							ID_PROJETALEP1	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP desc),0) ,
							DERSAD1			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							ID_DERS1		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							KONU1			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,				   
							DURUM1			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),5) ,	
							-----
							ID_PROJETALEP2	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),0) ,
							DERSAD2			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,
							ID_DERS2		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP),'') ,
							KONU2			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,				   
							DURUM2			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),5) ,	
							------
							ID_PROJETALEP3	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),0) ,
							DERSAD3			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,
							ID_DERS3		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP),'') ,
							KONU3			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,				   
							DURUM3			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP4	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),0) ,
							DERSAD4			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,
							ID_DERS4		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP),'') ,
							KONU4			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,				   
							DURUM4			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP5	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),0),
							DERSAD5			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,
							ID_DERS5		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP),'') ,
							KONU5			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,				   
							DURUM5			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),5) 
						from OkyanusDB.dbo.v3Ogrenci	o
						join OkyanusDB.dbo.v3Kullanici	b	on	b.TCKIMLIKNO=o.TCKIMLIKNO
						join OkyanusDB.dbo.v3Sinif		sn	on	sn.ID_SINIF=o.ID_SINIF	   
						WHERE	o.ID_SINIF = @ID_SINIF 
						order by b.AD,b.Soyad 
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end
			else --if @SINIFTIP='kur'
			begin
				SELECT(
					SELECT (
						SELECT   distinct
							ID_OGRENCI		= o.ID_OGRENCI,
							ADSOYAD			= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							OGRNO			= KO.OGRNO,
							ID_SINIF		= sn.ID_KUR,
							SINIFAD			= sn.KURSINIFI,
							-----
							ID_PROJETALEP1	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP desc),0) ,
							DERSAD1			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							ID_DERS1		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							KONU1			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,				   
							DURUM1			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),5) ,	
							-----
							ID_PROJETALEP2	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),0) ,
							DERSAD2			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,
							ID_DERS2		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP),'') ,
							KONU2			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,				   
							DURUM2			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),5) ,	
							------
							ID_PROJETALEP3	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),0) ,
							DERSAD3			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,
							ID_DERS3		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP),'') ,
							KONU3			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,				   
							DURUM3			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP4	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),0) ,
							DERSAD4			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,
							ID_DERS4		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP),'') ,
							KONU4			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,				   
							DURUM4			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP5	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),0),
							DERSAD5			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,
							ID_DERS5		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP),'') ,
							KONU5			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,				   
							DURUM5			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),5) 
						from eokul_V2.dbo.KurOgrenci	o
						join eokul_V2.dbo.KurSinifi		sn	on	sn.ID_KUR		= o.ID_KUR
						JOIN OkyanusDB.dbo.v3Ogrenci	ko	ON	KO.ID_OGRENCI	= O.ID_OGRENCI
						join OkyanusDB.dbo.v3Kullanici	b	on	b.TCKIMLIKNO	= Ko.TCKIMLIKNO	   
						WHERE	o.ID_KUR=@ID_SINIF and sn.AKTIF<>0
						order by ADSOYAD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end	
		END	
		
		IF @ISLEM = 16		-- PROJE DOSYA EKLE					
		BEGIN			 
			SET @ID_KULLANICI = (SELECT ID_KULLANICI FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)
			 
			Insert Into Pusulam.dbo.ProjeDosya(ID_PROJETALEP,DOSYA,DOSYAGUID,ID_KULLANICI,GUID)
			Values(@ID_PROJETALEP,@DOSYA,@DOSYAGUID,@ID_KULLANICI,'')

		END

		IF @ISLEM = 17		-- PROJE DOSYA SİL					
		BEGIN
			Update Pusulam.dbo.ProjeDosya Set SILINDI=1 where ID_PROJEDOSYA=@ID_PROJEDOSYA

			select 1
		END
				
		IF @ISLEM = 18		-- PROJE DOSYA LİSTELE				
		BEGIN						
			SELECT(
				SELECT (
					Select PT.KONU,PD.DOSYA, PD.ID_PROJETALEP, PD.ID_PROJEDOSYA
					from Pusulam.dbo.ProjeDosya PD 
					join Pusulam.dbo.ProjeTalep PT	on	PT.ID_PROJETALEP	= PD.ID_PROJETALEP
					where	SILINDI			= 0 
						and pt.ID_PROJETALEP= @ID_PROJETALEP
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS SS
		END
		
		IF @ISLEM = 20		-- PROJE TALEP EKLEME				
		BEGIN			
			SET @ID_KULLANICI =( SELECT ID_KULLANICI FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO) 	
			IF @ID_OGRENCI IS NULL OR @ID_OGRENCI = 0
			BEGIN
				SET @ID_OGRENCI =( SELECT ID_OGRENCI FROM OkyanusDB.DBO.v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI) 	
			END
			ELSE
			BEGIN
				SET @TC_OGRENCI =( SELECT TCKIMLIKNO FROM OkyanusDB.DBO.v3Ogrenci WHERE ID_OGRENCI = @ID_OGRENCI) 	
			END 

			SET @TC_OGRETMEN = (
									select DISTINCT o.TCKIMLIKNO 
									FROM ProjeTalep P
									JOIN eokul_v2.DBO.DersOgretmen DO ON DO.ID_DERS		= P.ID_DERS AND DO.ID_SINIF= P.ID_SINIF
									JOIN OkyanusDB.DBO.v3Ogretmen  O  ON O.ID_OGRETMEN  = DO.ID_OGRETMEN 
									WHERE	p.ID_SINIF			= @ID_SINIF
										AND P.ID_DERS			= @ID_DERS
										AND DO.ID_EGITIMTURU	= 6
								)


			IF (Select COUNT(1) from Pusulam.dbo.ProjeTalep where ID_PROJETALEP=@ID_PROJETALEP)>0 AND 0<>@ID_PROJETALEP
			BEGIN
					Update Pusulam.dbo.ProjeTalep Set DURUM=1,KONU=@KONU where ID_PROJETALEP=@ID_PROJETALEP
					--Set @ID_PROJETALEP=(Select ID_PROJETALEP from Pusulam.dbo.ProjeTalep where ID_OGRENCI=@ID_OGRENCI and SIRA=@SIRA)			
			END
			ELSE
			BEGIN
					Insert Into Pusulam.dbo.ProjeTalep(ID_SINIF,ID_OGRENCI,ID_DERS,KONU,DURUM,SIRA,ID_KULLANICI,YARIYIL,TC_OGRENCI,TC_OGRETMEN)
					Values(@ID_SINIF,@ID_OGRENCI,@ID_DERS,@KONU,1,@SIRA,@ID_KULLANICI,@YARIYIL,@TC_OGRENCI,@TC_OGRETMEN)	
					Set @ID_PROJETALEP=SCOPE_IDENTITY()					
			END	

			IF @DOSYAGUID IS NOT NULL OR @DOSYAGUID <> ''
			BEGIN
				Update Pusulam.dbo.ProjeDosya Set ID_PROJETALEP=@ID_PROJETALEP where DOSYAGUID=@DOSYAGUID
			END
			Select @ID_PROJETALEP
		END
		
		IF @ISLEM = 21		-- PROJE TALEP SİLME				
		BEGIN	
			SET @ID_KULLANICI = (SELECT ID_KULLANICI FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)
			Insert Into Pusulam.dbo.ProjeTalepSil(ID_PROJETALEP,ID_KULLANICI,SILINMETARIHI,ID_DERS,SIRA,DURUM,ID_OGRENCI,YARIYIL)
			Select ID_PROJETALEP,@ID_KULLANICI,GETDATE(),ID_DERS,SIRA,DURUM,ID_OGRENCI,YARIYIL from Pusulam.dbo.ProjeTalep where ID_PROJETALEP=@ID_PROJETALEP

			Delete from Pusulam.dbo.ProjeTalep where ID_PROJETALEP=@ID_PROJETALEP		
			Update Pusulam.dbo.ProjeDosya Set SILINDI=1 where ID_PROJETALEP=@ID_PROJETALEP
	
			Select 1
		END
		
		IF @ISLEM = 22		-- PROJE NOT EKLE					
		BEGIN
			IF (Select Count(1) from  Pusulam.dbo.ProjeNot where ID_PROJETALEP=@ID_PROJETALEP)=0
			BEGIN
				Insert Into  Pusulam.dbo.ProjeNot(ID_PROJETALEP) Values(@ID_PROJETALEP)
			END

			Update P 
			Set 				
				 PLANOLUSTURMA	= CASE WHEN @KRITER = 1 THEN @DEGER ELSE P.PLANOLUSTURMA	END
				,KAYNAKKULLANIM	= CASE WHEN @KRITER = 2 THEN @DEGER ELSE P.KAYNAKKULLANIM	END
				,ISBIRLIGI		= CASE WHEN @KRITER = 3 THEN @DEGER ELSE P.ISBIRLIGI		END
				,DILKULLANIM	= CASE WHEN @KRITER = 4 THEN @DEGER ELSE P.DILKULLANIM		END
				,KAVRAMA		= CASE WHEN @KRITER = 5 THEN @DEGER ELSE P.KAVRAMA			END
			FROM Pusulam.dbo.ProjeNot P
			where ID_PROJETALEP=@ID_PROJETALEP
			
			DECLARE @PROJENOT INT = (Select SUM(PLANOLUSTURMA+KAYNAKKULLANIM+ISBIRLIGI+DILKULLANIM+KAVRAMA) * 5 from Pusulam.dbo.ProjeNot where ID_PROJETALEP=@ID_PROJETALEP)

			Update	Pusulam.dbo.ProjeNot 
			Set		PROJENOT= @PROJENOT, 
					DERECE	= CASE 
								WHEN @PROJENOT < 50 THEN 'Geçmez'
								WHEN @PROJENOT > 49 and @PROJENOT < 60 THEN 'Geçer'
								WHEN @PROJENOT > 59 and @PROJENOT < 70 THEN 'Orta'
								WHEN @PROJENOT > 69 and @PROJENOT < 85 THEN 'İyi'
								WHEN @PROJENOT > 84 and @PROJENOT < 101 THEN 'Pekiyi'
								END
			where ID_PROJETALEP=@ID_PROJETALEP

			select 1

		END
	

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProjeDonemRapor]    Script Date: 23.11.2021 15:10:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_ProjeDonemRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIFs			NVARCHAR(MAX)	= NULL,
	@YARIYIL			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINIFs					= @ID_SINIFs	
			,YARIYIL					= @YARIYIL	
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	
		BEGIN
				
			DROP TABLE IF EXISTS #OGRENCILIST
 

			SELECT DISTINCT
					 TCKIMLIKNO			= K.TCKIMLIKNO
					,ADSOYAD			= K.AD+' '+K.SOYAD
					,OGRNO				= O.OGRNO
					,ID_OGRENCI			= O.ID_OGRENCI
					,SUBEAD				= GS.SUBEAD
					,KADEME3			= GS.KADEME3
					,SINIFAD			= GS.SINIF
					,DANISMANOGRETMEN	= ISNULL(OK.AD+' '+OK.SOYAD,'-')
					,ID_KADEME			= GS.ID_KADEME
			INTO #OGRENCILIST
			FROM v3OgrenciTum						O	
			JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN vw_SubeSinifGrupKademeTum			GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN ProjeTalep							PT	ON	PT.ID_OGRENCI	= O.ID_OGRENCI
			LEFT JOIN OkyanusDB.DBO.v3SinifPersonel	SD	ON	SD.ID_SINIF		= O.ID_SINIF AND SD.ID_KULLANICITIPI = 100
			LEFT JOIN v3Kullanici					OK	ON	OK.TCKIMLIKNO	= SD.TCKIMLIKNO
			WHERE GS.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
				AND DURUM = 2	-- PT ONAYLANDI
				AND (	(		GS.ID_KADEME != 5 	
							AND YARIYIL = @YARIYIL
						) 
						OR 
								GS.ID_KADEME = 5 
					)
	
			
			SELECT 
						 TCKIMLIKNO			
						,ADSOYAD			
						,OGRNO				
						,ID_OGRENCI			
						,SUBEAD				
						,KADEME3			
						,SINIFAD			
						,DANISMANOGRETMEN	
						,MAX([A0]) [A0],MAX([K0]) [K0],MAX([O0]) [O0]
						,MAX([A1]) [A1],MAX([K1]) [K1],MAX([O1]) [O1]
						,MAX([A2]) [A2],MAX([K2]) [K2],MAX([O2]) [O2]
						,MAX([A3]) [A3],MAX([K3]) [K3],MAX([O3]) [O3]
						,MAX([A4]) [A4],MAX([K4]) [K4],MAX([O4]) [O4]

			FROM (
				SELECT DISTINCT 
						 OL.TCKIMLIKNO			
						,OL.ADSOYAD			
						,OL.OGRNO				
						,OL.ID_OGRENCI			
						,OL.SUBEAD				
						,OL.KADEME3			
						,OL.SINIFAD			
						,OL.DANISMANOGRETMEN	
						,SDA			= 'A' + CAST(PT.SIRA AS VARCHAR)
						,SDK			= 'K' + CAST(PT.SIRA AS VARCHAR)
						,SDO			= 'O' + CAST(PT.SIRA AS VARCHAR)
						,DERSAD			= D.AD
						,DERSKONU		= PT.KONU
						,DERSOGRETMEN	= ISNULL(K.AD+' '+K.SOYAD,'-')
				FROM #OGRENCILIST		OL
				JOIN ProjeTalep			PT	ON	PT.ID_OGRENCI	= OL.ID_OGRENCI
				JOIN v3Ders				D	ON	D.ID_DERS		= PT.ID_DERS	
				LEFT JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= PT.TC_OGRETMEN
				WHERE DURUM = 2	-- PT ONAYLANDI	
					AND (	(		OL.ID_KADEME != 5 	
								AND PT.YARIYIL = @YARIYIL
							) 
							OR 
									OL.ID_KADEME = 5 
						)
			) AS S 
			PIVOT  ( MAX(DERSAD)		FOR SDA IN ([A0],[A1],[A2],[A3],[A4]) ) AS P
			PIVOT  ( MAX(DERSKONU)		FOR SDK IN ([K0],[K1],[K2],[K3],[K4]) ) AS P
			PIVOT  ( MAX(DERSOGRETMEN)	FOR SDO IN ([O0],[O1],[O2],[O3],[O4]) ) AS P
			GROUP BY	 TCKIMLIKNO			
						,ADSOYAD			
						,OGRNO				
						,ID_OGRENCI			
						,SUBEAD				
						,KADEME3			
						,SINIFAD			
						,DANISMANOGRETMEN	

			
			DROP TABLE IF EXISTS #OGRENCILIST

		END				

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_PuanaGoreYaziliSonuclari]    Script Date: 23.11.2021 15:11:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	@return_value = [dbo].[sp_PuanaGoreYaziliSonuclari]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_PuanaGoreYaziliSonuclari]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVLAR		VARCHAR(MAX)	= '',
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ID_DERSLER			VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@ID_KADEME3			INT				= 0,
	@YARIYIL			VARCHAR(10)		= '',
	@PUANARALIGI		VARCHAR(MAX)	= '',
	@TC					BIT				= 1,
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAVLAR				= @ID_SINAVLAR
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ID_DERSLER					= @ID_DERSLER	
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
			,ID_KADEME3					= @ID_KADEME3	
			,YARIYIL					= @YARIYIL	
			,PUANARALIGI				= @PUANARALIGI
			,TC							= @TC			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			DECLARE @MAXPUAN DECIMAL(6, 2)
			DECLARE @MINPUAN DECIMAL(6, 2)

			IF @ISLEM = 1 OR @ISLEM = 2	--	Toplu Yazılı Yoklama Sunuçları Getir
			BEGIN
				SELECT sr.ID_SINAVRAPOR, 
					   sr.SINAVADI, 
					   su.AD							AS KAMPUS, 
					   sn.AD                            AS SINIF, 
					   k.TCKIMLIKNO, 
					   k.AD + ' ' + k.SOYAD             AS ADSOYAD, 
					   Sum(oo.PUAN)                     AS PUAN 
				INTO   #tablos 
				FROM	   eokul_v2.dbo.SinavRapor		sr 
				INNER JOIN eokul_v2.dbo.OgrenciNot		oo ON oo.ID_SINAVRAPOR = sr.ID_SINAVRAPOR 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci		og ON og.ID_OGRENCI = oo.ID_OGRENCI 
				INNER JOIN OkyanusDB.dbo.v3Sube			su ON su.ID_SUBE = og.ID_SUBE 
				INNER JOIN OkyanusDB.dbo.v3Sinif		sn ON sn.ID_SINIF = oo.ID_SINIF 
				INNER JOIN OkyanusDB.dbo.v3Kullanici	k ON k.TCKIMLIKNO = og.TCKIMLIKNO 
				--INNER JOIN eokul_v2.dbo.Ders			d ON d.ID_DERS = sr.ID_DERS 
				WHERE  sr.DONEMKOD = @DONEM 
					   AND sr.isActive = 1 
					   AND k.AKTIF = 1 
					   AND ( ( sr.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
					   AND ( ( sr.ID_SINAVRAPOR	IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
					   AND ( ( su.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
					   AND ( ( og.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
					   AND ( sr.GRUP = (select AD from OkyanusDB.dbo.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3) OR @ID_KADEME3 = 0 ) 
				GROUP  BY sr.ID_SINAVRAPOR, 
						  sr.SINAVADI, 
						  su.AD, 
						  sn.AD, 
						  k.TCKIMLIKNO, 
						  k.AD, 
						  k.SOYAD 

				SELECT Cast(VALUE AS DECIMAL(6, 2)) AS PUAN 
				INTO   #puanlar 
				FROM   dbo.fn_Split(@PUANARALIGI, '-', NULL) 

				SET @MAXPUAN = (SELECT Max(PUAN) 
				  FROM   #puanlar) 
				SET @MINPUAN = (SELECT Min(PUAN) 
				  FROM   #puanlar)

				IF @ISLEM = 1 -- HTML
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.TCKIMLIKNO, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablos t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 							
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_SINAVRAPOR, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablos t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 						
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_SINAVRAPOR, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
				END 
				ELSE IF @ISLEM = 2 -- DEVEXPRESS
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.TCKIMLIKNO, 
								t.ADSOYAD, 
								t.PUAN 
						FROM   #tablos t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_SINAVRAPOR, 
								  SINAVADI 
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.ADSOYAD, 
								t.PUAN  
						FROM   #tablos t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_SINAVRAPOR, 
								  SINAVADI 
					END 
				END

				DROP TABLE #tablos
				DROP TABLE #puanlar
			END 

			IF @ISLEM = 3 OR @ISLEM = 4	--	Toplu Yazılı Yoklama Sunuçları Getir
			BEGIN
				SELECT  Y.ID_YAZILI
						,Y.AD								AS SINAVADI
						,SB.AD								AS KAMPUS
						,S.AD								AS SINIF
						,K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD				AS ADSOYAD
						,ISNULL(YO.TELAFI, Sum(YOC.PUAN))	AS PUAN 
				INTO #tablosY
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE		Y.DONEM = @DONEM 
							AND Y.AKTIF = 1 
							AND k.AKTIF = 1 
							AND ( ( Y.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
							AND ( ( Y.ID_YAZILI		IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
							AND ( ( SB.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
							AND ( ( S.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
							--AND ( Y.ID_KADEME3 = @ID_KADEME3 OR @ID_KADEME3 = 0 ) 
				GROUP  BY	Y.ID_YAZILI, 
							Y.AD, 
							SB.AD, 
							S.AD, 
							k.TCKIMLIKNO, 
							k.AD, 
							k.SOYAD,
							YO.TELAFI 



				SELECT Cast(VALUE AS DECIMAL(6, 2)) AS PUAN 
				INTO   #puanlarY 
				FROM   dbo.fn_Split(@PUANARALIGI, '-', NULL) 

				SET @MAXPUAN = (SELECT Max(PUAN) 
				  FROM   #puanlarY) 
				SET @MINPUAN = (SELECT Min(PUAN) 
				  FROM   #puanlarY)

				IF @ISLEM = 3 -- HTML
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.TCKIMLIKNO, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablosY t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 							
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_YAZILI, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablosY t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 						
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_YAZILI, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
				END 
				ELSE IF @ISLEM = 4 -- DEVEXPRESS
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.TCKIMLIKNO, 
								t.ADSOYAD, 
								t.PUAN 
						FROM   #tablosY t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_YAZILI, 
								  SINAVADI 
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.ADSOYAD, 
								t.PUAN  
						FROM   #tablosY t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_YAZILI, 
								  SINAVADI 
					END 
				END
			END 

			DROP TABLE #tablosY
			DROP TABLE #puanlarY			
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_RehberDanismanYoklama]    Script Date: 23.11.2021 15:11:14 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_RehberDanismanYoklama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_SINIFLIST			NVARCHAR(MAX)	= NULL,	
	@YOKLAMATARIH			NVARCHAR(MAX)	= NULL,	
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@BASLANGICTARIH			NVARCHAR(MAX)	= NULL,
	@BITISTARIH				NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 27.10.2020
	
	--	sp Create 
	--	Öğrenci Yoklama Raporu

*/	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SINIFLIST			= @ID_SINIFLIST	
				,YOKLAMATARIH			= @YOKLAMATARIH	
				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	OGRENCI YOKLAMA LİSTESİ			
			BEGIN
				
				DROP TABLE IF EXISTS #OGRLIST

				SELECT	 O.TCKIMLIKNO 
						,DP.DERSSAAT
						,YK.GELDI 
						,O.ID_SINIF
						,Y.TARIH
				INTO #OGRLIST
				FROM v3Ogrenci								O
				JOIN OPENJSON ( @ID_SINIFLIST )				SL	ON	SL.VALUE			= O.ID_SINIF
				LEFT JOIN OkyanusIletisim..Yoklama			Y	ON	Y.ID_SINIF			= O.ID_SINIF
																
				LEFT JOIN OkyanusDB..v3DersProgram			DP	ON	DP.ID_DERSPROGRAM	= Y.ID_DERSPROGRAM
				LEFT JOIN OkyanusIletisim..YoklamaKullanici	YK	ON	YK.ID_YOKLAMA		= Y.ID_YOKLAMA
																AND YK.TCKIMLIKNO		= O.TCKIMLIKNO
				WHERE Y.TARIH BETWEEN CAST(@BASLANGICTARIH AS date) AND CAST(@BITISTARIH AS date)

				SELECT (
					SELECT DISTINCT 
						 GS.SUBEAD
						,GS.SINIF
						,O.TCKIMLIKNO
						,K.AD
						,K.SOYAD
						,CONVERT(VARCHAR,O.TARIH,104) AS TARIH						
						,YOKLAMALISTE= (SELECT	 ODS.DERSNO
												,ODS.BASSAAT
												,ODS.BITSAAT
												,OG.GELDI
										FROM OnlineDersSaat	ODS
										LEFT JOIN #OGRLIST	OG	ON	OG.DERSSAAT		= ODS.DERSNO
																AND OG.TCKIMLIKNO	= O.TCKIMLIKNO
																AND OG.TARIH		= O.TARIH
										ORDER BY ODS.DERSNO
										
										FOR JSON PATH, INCLUDE_NULL_VALUES
										)
					FROM #OGRLIST			O
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= O.ID_SINIF				
					ORDER BY GS.SUBEAD,K.AD, K.SOYAD, GS.SINIF
					
					FOR JSON PATH
				)

				DROP TABLE IF EXISTS #OGRLIST

				
			END

			IF @ISLEM = 2	--	PERSONEL SINIF LİSTESİ			
			BEGIN
			
				DECLARE @ID_KULLANICITIPI	INT
				
				IF EXISTS ( SELECT TOP 1 1
							FROM v3SubeYetki
							WHERE TCKIMLIKNO			= @TCKIMLIKNO
								AND ID_KULLANICITIPI	= 26	
							)
					SET @ID_KULLANICITIPI = 26	-- REHBER
				ELSE
					SET @ID_KULLANICITIPI = 100	-- DANIŞMAN ÖĞRETMEN

				SELECT ISNULL((
					SELECT GS.ID_SINIF, GS.SUBEAD, GS.SINIF AS AD
					FROM OkyanusDB..v3SinifPersonel	SP
					JOIN vw_SubeGrupSinif			GS	ON	GS.ID_SINIF	= SP.ID_SINIF
					WHERE	ID_KULLANICITIPI	= @ID_KULLANICITIPI
						AND TCKIMLIKNO			= @TCKIMLIKNO
					ORDER BY SUBEAD, SINIF
					FOR JSON PATH
				),'[]')

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_RehberlikEnvanter]    Script Date: 23.11.2021 15:11:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_RehberlikEnvanter]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_REHBERLIKENVANTER	INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@TESTADI				VARCHAR(MAX)	= NULL,
	@KLASOR					VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
			SELECT	
				ISLEM							= @ISLEM					
				,TCKIMLIKNO						= @TCKIMLIKNO				
				,OTURUM							= @OTURUM					
				,ID_MENU						= @ID_MENU				
				,TC_OGRENCI						= @TC_OGRENCI				
				,ID_KADEME3						= @ID_KADEME3				
				,ID_SINIF						= @ID_SINIF				
				,ID_SUBE						= @ID_SUBE				
				,ID_REHBERLIKENVANTER			= @ID_REHBERLIKENVANTER	
				,DONEM							= @DONEM					
				,TESTADI						= @TESTADI				
				,KLASOR							= @KLASOR					
			FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
		)	
	
	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	
		BEGIN
			IF @ID_KADEME3 IS NULL OR @ID_KADEME3 = 0
			BEGIN
				SET @ID_KADEME3 = (	SELECT TOP 1 S.ID_KADEME3
									FROM OkyanusDB.DBO.v3Ogrenci		O
									JOIN OkyanusDB.DBO.v3SubeGrupSinif	S ON	S.ID_SINIF	= O.ID_SINIF
									WHERE O.TCKIMLIKNO =@TC_OGRENCI
								)
			END

			SELECT(
				SELECT (
					SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
					FROM RehberlikEnvanter	R
					JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3
					WHERE	(R.ID_KADEME3	=  @ID_KADEME3)
						AND (@DONEM	= 0		OR R.DONEM= @DONEM)
						AND AKTIF	= 1
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END	
		
		IF @ISLEM = 2	--	SINIF
		BEGIN
			
			SET @ID_KADEME3 = (	SELECT TOP 1 ID_KADEME3
									FROM OkyanusDB.DBO.v3SubeGrupSinif		
									WHERE ID_SINIF =@ID_SINIF
								)
			
			SELECT(
				SELECT (				
					SELECT * FROM (
							SELECT O.TCKIMLIKNO,S.AD SINIFAD,CONCAT(K.AD,' ',SOYAD) ADSOYAD
							FROM OkyanusDB.DBO.v3Ogrenci		O
							JOIN OkyanusDB.DBO.v3Sinif			S	ON	S.ID_SINIF	= O.ID_SINIF
							JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= O.TCKIMLIKNO
							WHERE	(O.TCKIMLIKNO =@TC_OGRENCI OR @TC_OGRENCI = '' OR @TC_OGRENCI IS NULL)
								AND S.ID_SINIF=@ID_SINIF
					) AS S
					CROSS JOIN (
							SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
							FROM RehberlikEnvanter	R
							JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3				
							WHERE	(R.ID_KADEME3	=  @ID_KADEME3)
								AND (ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER OR @ID_REHBERLIKENVANTER=0)
								AND (@DONEM	= 0		OR R.DONEM= @DONEM)						
								AND AKTIF	= 1
					) AS D
					ORDER BY ADSOYAD,DONEM,ID_REHBERLIKENVANTER
					FOR JSON PATH
				) AS LISTE
				FOR JSON PATH
			) AS SS


		END		
 
		IF @ISLEM = 3	--	SUBE KADEME3
		BEGIN
			
			--SET @ID_KADEME3 = (	SELECT TOP 1 ID_KADEME3
			--						FROM OkyanusDB.DBO.v3SubeGrupSinif		
			--						WHERE ID_SINIF =@ID_SINIF
			--					)
			
			SELECT(
				SELECT (				
					SELECT * FROM (
							SELECT O.TCKIMLIKNO,S.AD SINIFAD,CONCAT(K.AD,' ',SOYAD) ADSOYAD
							FROM OkyanusDB.DBO.v3Ogrenci		O
							JOIN OkyanusDB.DBO.v3Sinif			S	ON	S.ID_SINIF	= O.ID_SINIF
							JOIN OkyanusDB.dbo.v3SubeGrupSinif  GS	ON	GS.ID_SINIF	= S.ID_SINIF
							JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= O.TCKIMLIKNO
							WHERE	(O.TCKIMLIKNO =@TC_OGRENCI OR @TC_OGRENCI = '' OR @TC_OGRENCI IS NULL)								
								AND (S.ID_SINIF		= @ID_SINIF OR @ID_SINIF = 0)
								AND (GS.ID_SUBE		= @ID_SUBE  OR @ID_SUBE  = 0)
								AND GS.ID_KADEME3	= @ID_KADEME3
								--AND S.ID_SINIF=@ID_SINIF
					) AS S
					CROSS JOIN (
							SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
							FROM RehberlikEnvanter	R
							JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3				
							WHERE	(R.ID_KADEME3	=  @ID_KADEME3)
								AND (ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER OR @ID_REHBERLIKENVANTER=0)
								AND (@DONEM	= 0		OR R.DONEM= @DONEM)						
								AND AKTIF	= 1
					) AS D
					ORDER BY ADSOYAD,DONEM,ID_REHBERLIKENVANTER
					FOR JSON PATH
				) AS LISTE
				FOR JSON PATH
			) AS SS


		END	
	END

	END TRY
	BEGIN CATCH	
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_RehberlikEnvanterTanimlama]    Script Date: 23.11.2021 15:11:45 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_RehberlikEnvanterTanimlama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
 	@ID_KADEME3				INT				= NULL,
	@ID_REHBERLIKENVANTER	INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@TESTADI				VARCHAR(MAX)	= NULL,
	@KLASOR					VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM					
			,TCKIMLIKNO						= @TCKIMLIKNO				
			,OTURUM							= @OTURUM					
			,ID_MENU						= @ID_MENU				
			,ID_KADEME3						= @ID_KADEME3				
			,ID_REHBERLIKENVANTER			= @ID_REHBERLIKENVANTER	
			,DONEM							= @DONEM					
			,TESTADI						= @TESTADI				
			,KLASOR							= @KLASOR					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
	
		IF @ISLEM = 1	--	KAYDET/GUNCELLE
		BEGIN

			--IF NOT EXISTS(SELECT * FROM RehberlikEnvanter WHERE TESTADI=@TESTADI AND DONEM=@DONEM AND ID_KADEME3=@ID_KADEME3 AND AKTIF=0)
			IF @ID_REHBERLIKENVANTER IS NULL OR @ID_REHBERLIKENVANTER !> 0
			BEGIN
				DECLARE @ID_TABLE TABLE (ID INT)

				INSERT INTO RehberlikEnvanter (TESTADI,ID_KADEME3,DONEM,KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_REHBERLIKENVANTER INTO @ID_TABLE
				VALUES(@TESTADI,@ID_KADEME3,@DONEM,@TCKIMLIKNO)
								
				DECLARE @ID INT = (SELECT TOP 1 ID FROM @ID_TABLE)
				DECLARE @KADEME3 VARCHAR(20) = (SELECT AD FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3)
				SET @KLASOR= '/'+@DONEM+'/'+CAST(@ID AS varchar)+'/'+@KADEME3

				UPDATE RehberlikEnvanter 
				SET KLASOR=@KLASOR
				WHERE ID_REHBERLIKENVANTER=@ID

				select 1

			END
			ELSE
			BEGIN
				UPDATE RehberlikEnvanter
				SET	 TESTADI	= @TESTADI
				WHERE ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER
			END
		END		

		IF @ISLEM = 2	-- LISTELE
		BEGIN
			SELECT(
				SELECT (
					SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
					FROM RehberlikEnvanter	R
					JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3
					WHERE	(@ID_KADEME3=0 OR R.ID_KADEME3 = @ID_KADEME3)
						AND (@DONEM=0 OR R.DONEM= @DONEM)
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END

		IF @ISLEM = 3	--	AKTIF/PASIF
		BEGIN
			UPDATE RehberlikEnvanter
			SET AKTIF = CASE WHEN AKTIF=0 THEN 1 ELSE 0 END
			WHERE ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER		
			
			select 1	
		END
 
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_RehberlikOnlineYukle]    Script Date: 23.11.2021 15:12:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_RehberlikOnlineYukle]
	@ISLEM			INT			= NULL,
	@TCKIMLIKNO		VARCHAR(11)	= NULL,
	@OTURUM			VARCHAR(36)	= NULL,
	@ID_MENU		INT			= NULL,

	@SQLJSON		VARCHAR(MAX)= NULL,
		@IP					VARCHAR(50)	= NULL

	
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,SQLJSON		= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	REHBERLİK ONLINE EXCEL YÜKLE						
			BEGIN
			
				DROP TABLE IF EXISTS #TEMP
				
				DELETE FROM RehberlikOnlineLink	

				SELECT TCKIMLIKNO = J.TCKIMLIKNO, TESTADI = J.TESTADI, LINK = J.LINK 
				INTO #TEMP
				FROM OPENJSON(@SQLJSON)
				WITH(
					 TCKIMLIKNO	VARCHAR(MAX)
					,TESTADI	VARCHAR(MAX)
					,LINK		VARCHAR(MAX)
				)  J

				INSERT INTO RehberlikOnlineLink (TCKIMLIKNO, TESTADI, LINK)
				SELECT T.TCKIMLIKNO, T.TESTADI, T.LINK 
				FROM #TEMP			T				
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO = T.TCKIMLIKNO
				WHERE	T.TESTADI	 IS NOT NULL
					AND T.LINK		 LIKE 'http%'

				--SELECT COUNT(1) FROM RehberlikOnlineLink

				SELECT ISNULL((
					SELECT  TCHATA = ISNULL((
								SELECT DISTINCT T.TCKIMLIKNO 
								FROM #TEMP T
								WHERE NOT EXISTS (SELECT TOP 1 1 FROM v3Kullanici K WHERE K.TCKIMLIKNO = T.TCKIMLIKNO)
								FOR JSON PATH
							),'[]'),
							TESTADIHATA = ISNULL((
								SELECT DISTINCT T.TCKIMLIKNO
								FROM #TEMP T
								WHERE T.TESTADI	IS NULL
								FOR JSON PATH
							),'[]'),
							LINKHATA = ISNULL((
								SELECT DISTINCT T.TCKIMLIKNO
								FROM #TEMP T
								WHERE T.LINK NOT LIKE 'http%'
								FOR JSON PATH
							),'[]')
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')

				DROP TABLE IF EXISTS #TEMP

			END
			IF @ISLEM = 2	--	REHBERLİK ONLINE LİSTESİ			
			BEGIN
				SELECT ISNULL((
				SELECT	 VK.TCKIMLIKNO
							,ADSOYAD	= VK.AD+' '+VK.SOYAD
							,SUBEAD = ISNULL((SELECT K.SUBEAD FROM OkyanusDB..vw_OgrenciDetayTum K WHERE K.TCKIMLIKNO = ROL.TCKIMLIKNO AND K.DONEM = OkyanusDB.dbo.fn_AktifDonem() AND K.ID_SINIF >0),'--')
							,SINIFAD = ISNULL((SELECT K.SINIFAD FROM OkyanusDB..vw_OgrenciDetayTum K WHERE K.TCKIMLIKNO = ROL.TCKIMLIKNO AND K.DONEM = OkyanusDB.dbo.fn_AktifDonem() AND K.ID_SINIF >0),'--')
							,ROL.TESTADI
							,ROL.LINK
					FROM RehberlikOnlineLink			ROL
					JOIN v3Kullanici				VK	ON VK.TCKIMLIKNO	= ROL.TCKIMLIKNO

					--JOIN OkyanusDB..vw_OgrenciDetayTum	K	ON	K.TCKIMLIKNO	= ROL.TCKIMLIKNO
					--										AND K.DONEM			= OkyanusDB.dbo.fn_AktifDonem()
					--										AND K.ID_SINIF		> 0
					--										ORDER BY 1 DESC
					FOR JSON AUTO,INCLUDE_NULL_VALUES
				),'[]')


			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState	INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SifremiDegistir]    Script Date: 23.11.2021 15:12:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[sp_SifremiDegistir] 
@ISLEM			INT				= NULL,
@OLDPASS		VARCHAR(50)		= NULL,
@NEWPASS		VARCHAR(50)		= NULL,
@TCKIMLIKNO		VARCHAR(11)		= NULL,
@OTURUM			VARCHAR(36)		= NULL,
	@IP					VARCHAR(50)	= NULL

AS
BEGIN
DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM				= @ISLEM		
			,OLDPASS			= @OLDPASS	
			,NEWPASS			= @NEWPASS	
			,TCKIMLIKNO			= @TCKIMLIKNO	
			,OTURUM				= @OTURUM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	
	BEGIN TRY
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		IF @ID_LOG>1
		BEGIN
			IF @ISLEM=1
			BEGIN
				DECLARE @ERRCODE VARCHAR(2),@ERRMESSAGE VARCHAR(300)
				DROP TABLE IF EXISTS #UPDATE_TABLE
					CREATE TABLE #UPDATE_TABLE
					(
						ERRCODE		INT,
						ERRMESSAGE  varchar(200), 
					)

					IF  EXISTS (SELECT TOP 1 1 FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO AND (eokul_v2.dbo.clr_Crypto_CheckPass(@OLDPASS,isnull(SIFREHASH,-1))=1) )
						BEGIN
							UPDATE OkyanusDB.dbo.v3Kullanici 
							SET --SIFRE = @NEWPASS,
							   SIFREHASH=eokul_v2.dbo.clr_Crypto_HashPass(@NEWPASS) 
							WHERE AKTIF=1 
							AND TCKIMLIKNO=@TCKIMLIKNO

							SET @ERRCODE=0
							SET @ERRMESSAGE='Şifreniz başarıyla güncellendi!'
							INSERT INTO #UPDATE_TABLE (ERRCODE,ERRMESSAGE) VALUES(@ERRCODE,@ERRMESSAGE)
							SELECT * FROM #UPDATE_TABLE FOR JSON AUTO
						END
					ELSE
						BEGIN
							SET @ERRCODE=1
							SET @ERRMESSAGE='Eski şifrenizi yanlış girdiniz!'

							INSERT INTO #UPDATE_TABLE (ERRCODE,ERRMESSAGE) VALUES(@ERRCODE,@ERRMESSAGE)
							SELECT * FROM #UPDATE_TABLE FOR JSON AUTO
						END
				END
		END
	END TRY

	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH
		

END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavaKatilmayanOgrenciler]    Script Date: 23.11.2021 15:12:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	@return_value = [dbo].[sp_SinavaKatilmayanOgrenciler]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_SinavaKatilmayanOgrenciler]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1 OR @ISLEM = 2	--	KATILMAYAN
			BEGIN
				Select distinct 
					ID_OGRENCI,
					ID_SINAVRAPOR,
					ono.ID_SINIF
				into #tmp1 
				from eokul_v2.dbo.OgrenciNot ono 
				inner join OkyanusDb.Dbo.v3Sinif s on s.ID_SINIF=ono.ID_SINIF
				inner join OkyanusDb.Dbo.v3Donem d on d.ID_DONEM=s.ID_DONEM
				where ono.KATILMADI=1 
				and		ono.ID_SINAVRAPOR=@ID_SINAV
				AND		d.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELER))
				and		ono.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))

				IF @ISLEM = 1	--	JSON
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT DISTINCT
									sr.ID_SINAVRAPOR				,
									sr.SINAVADI						,
									o.ID_OGRENCI					,
									AD = K.AD+' '+K.SOYAD			,
									PUAN = (0)			            ,
									SINIF = sn.AD					,
									sr.DONEMKOD						,
									ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
									su.AD as SUBE
								FROM #tmp1 o
								INNER JOIN OkyanusDb.Dbo.v3Ogrenci		OG	on OG.ID_OGRENCI	= o.ID_OGRENCI
								INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= OG.TCKIMLIKNO
								INNER JOIN eokul_v2.dbo.SinavRapor		sr	on o.ID_SINAVRAPOR	= sr.ID_SINAVRAPOR
								INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on o.ID_SINIF		= sn.ID_SINIF
								INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= OG.ID_SUBE
								ORDER BY S_NO	
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T1
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END
				ELSE IF @ISLEM = 2	--	DEVEXPRESS
				BEGIN
					SELECT DISTINCT
						sr.ID_SINAVRAPOR				,
						sr.SINAVADI						,
						o.ID_OGRENCI					,
						AD = K.AD+' '+K.SOYAD			,
						PUAN = (0)			            ,
						SINIF = sn.AD					,
						sr.DONEMKOD						,
						ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
						su.AD as SUBE
					FROM #tmp1 o
					INNER JOIN OkyanusDb.Dbo.v3Ogrenci		OG	on OG.ID_OGRENCI	= o.ID_OGRENCI
					INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= OG.TCKIMLIKNO
					INNER JOIN eokul_v2.dbo.SinavRapor		sr	on o.ID_SINAVRAPOR	= sr.ID_SINAVRAPOR
					INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on o.ID_SINIF		= sn.ID_SINIF
					INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= OG.ID_SUBE
					ORDER BY S_NO	
				END
		
				drop table #tmp1
			END 

			IF @ISLEM = 3 OR @ISLEM = 4	--	KATILMAYAN YENİ
			BEGIN
				SELECT  O.ID_OGRENCI
						,Y.ID_YAZILI
						,O.ID_SINIF
						,YO.TCKIMLIKNO
						,O.ID_SUBE
						,Y.AD AS SINAVADI
						,Y.DONEM AS DONEMKOD
				INTO #tmp1Y
				FROM Yazili Y 
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE  Y.ID_YAZILI = @ID_SINAV
				AND YO.KATILMADI = 1 
				AND Y.AKTIF = 1
				AND ( ( O.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
				AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' )  

				IF @ISLEM = 3	--	JSON
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT DISTINCT
									O.ID_YAZILI				,
									O.SINAVADI						,
									o.ID_OGRENCI					,
									AD = K.AD+' '+K.SOYAD			,
									PUAN = (0)			            ,
									SINIF = sn.AD					,
									O.DONEMKOD						,
									ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
									su.AD as SUBE
								FROM #tmp1Y o
								INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= o.TCKIMLIKNO
								INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on o.ID_SINIF		= sn.ID_SINIF
								INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= o.ID_SUBE
								ORDER BY S_NO	
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T1
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END
				ELSE IF @ISLEM = 4	--	DEVEXPRESS
				BEGIN
					SELECT DISTINCT
						O.ID_YAZILI				,
						O.SINAVADI						,
						O.ID_OGRENCI					,
						AD = K.AD+' '+K.SOYAD			,
						PUAN = (0)			            ,
						SINIF = sn.AD					,
						O.DONEMKOD						,
						ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
						su.AD as SUBE
					FROM #tmp1Y O
					INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on O.ID_SINIF		= sn.ID_SINIF
					INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= O.ID_SUBE
					ORDER BY S_NO	
				END
		
				drop table #tmp1Y
			END 
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavAnaliz]    Script Date: 23.11.2021 15:12:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	[dbo].[sp_SinavAnaliz]
--		@TCKIMLIKNO = N'56545519606',
--		@OTURUM = N'9ECE89E5-DD7E-4EBC-A920-A0B75E540AFF',
--		@ID_MENU = 1088,
--		@ID_SINAV = 9826,
--		@ID_SUBELER = N'[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]',
--		@ID_SINIFLAR = N'[0,102208,102207,102293,104343,101677,101671,101679,101672,101676,101680,101926,101927,101924,101925,101873,101875,101435,101434,101709,101710,101707,101708,101826,102174,101497,101498,101417,101419,101613,101615,101614,101861,104756,101860,101867,100987,105219,105416,105417,102307,102306,102087,102086,102147,102146,104554,101943,101946,101525,101526,104673,104676]',
--		@ISLEM = 1,
--		@DONEM = N'2017'

ALTER procedure [dbo].[sp_SinavAnaliz]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= 0,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			
			DECLARE @TITLE VARCHAR(MAX)
			DECLARE @TKS INT

			IF @ISLEM = 1 OR @ISLEM = 2	--	Sınav Analiz Getir
			BEGIN
				SELECT o.SORUNO, 
					   sr.PUANDEGERI, 
					   d.AD															AS DERSAD, 
					   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), o.PUAN)))	AS ORTALAMA, 
					   Isnull(sr.KAZANIM, 'Belirtilmemiş')							AS KAZANIM 
				INTO   #tablo 
				FROM   eokul_v2.dbo.OgrenciNot o 
				INNER JOIN eokul_v2.dbo.SinavRaporDetay sr ON sr.ID_SINAVRAPOR = o.ID_SINAVRAPOR AND sr.SORUNO = o.SORUNO 
				INNER JOIN eokul_v2.dbo.SinavRapor s ON s.ID_SINAVRAPOR = o.ID_SINAVRAPOR 
				INNER JOIN OkyanusDB.dbo.v3SinavDers d ON d.ID_DERS = s.ID_DERS 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci og ON og.ID_OGRENCI = o.ID_OGRENCI 
				WHERE  o.ID_SINAVRAPOR = @ID_SINAV 
					   AND o.KATILMADI = 0 
					   AND ( ( og.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					   AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP  BY o.SORUNO, 
						  sr.PUANDEGERI, 
						  d.AD, 
						  sr.KAZANIM 

				SELECT o.ID_OGRENCI, 
					   Sum(o.PUAN) AS PUAN 
				INTO   #tablo2 
				FROM   eokul_v2.dbo.OgrenciNot o 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci og ON og.ID_OGRENCI = o.ID_OGRENCI 
				WHERE  o.ID_SINAVRAPOR = @ID_SINAV 
					   AND o.KATILMADI = 0 
					   AND ( ( og.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					   AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP  BY o.ID_OGRENCI 

				SELECT Count(1) AS KISISAYISI, 
					   'PEKIYI' AS DURUM, 
					   5        AS SIRA 
				INTO   #tablo3 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 101 
					   AND t.PUAN > 84 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'IYI'    AS DURUM, 
					   4        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 85 
					   AND t.PUAN > 69 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'ORTA'   AS DURUM, 
					   3        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 70 
					   AND t.PUAN > 59 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECER'  AS DURUM, 
					   2        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 60 
					   AND t.PUAN > 49 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECMEZ' AS DURUM, 
					   1        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 50 
				ORDER  BY SIRA DESC 

				IF @ISLEM = 1
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT t.SORUNO                                                    AS SN, 
									   t.DERSAD                                                    AS DERS, 
									   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
									   t.KAZANIM 
								FROM   #tablo t 
								ORDER  BY t.SORUNO 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T1,
							(
								SELECT t.KISISAYISI, 
								   t.DURUM, 
								   t.SIRA, 
								   (SELECT Sum(KISISAYISI) FROM #tablo3) AS TOPLAMKISISAYISI 
								FROM   #tablo3 t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T2,
							(
								SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
								   Min(t.PUAN)                                                 AS ENDUSUK, 
								   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
								FROM   #tablo2 t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T3		
						) AS XTABLE	
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END 
				ELSE IF @ISLEM = 2
				BEGIN
					SET @TITLE = (SELECT ACIKLAMA FROM [dbo].[v3AktifDonem] WHERE DONEM = @DONEM)
					SET @TITLE += ' ('+ (SELECT SNVKOD FROM eokul_v2.dbo.SinavRapor WHERE ID_SINAVRAPOR = @ID_SINAV) + ') SORU ANALİZİ'
					SELECT t.SORUNO                                                    AS SN, 
						   t.DERSAD                                                    AS DERS, 
						   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
						   t.KAZANIM 
					FROM   #tablo t 
					ORDER  BY t.SORUNO 

					SET @TKS = (SELECT Sum(KISISAYISI) FROM #tablo3)

					SELECT t.KISISAYISI, 
						   t.DURUM, 
						   t.SIRA, 
						   @TKS AS TOPLAMKISISAYISI,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),t.KISISAYISI)/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS YUZDE
					FROM   #tablo3 t 

					SELECT (@TKS - t.KISISAYISI) AS BASARILI, 
						   (t.KISISAYISI) AS BASARISIZ,  
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(@TKS - t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARILIYUZDE,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARISIZYUZDE
					FROM   #tablo3 t 
					WHERE  t.SIRA=1

					SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
						   Min(t.PUAN)                                                 AS ENDUSUK, 
						   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
					FROM   #tablo2 t 

					SELECT @TITLE
				END			
				
				DROP TABLE #tablo3
				DROP TABLE #tablo2 
				DROP TABLE #tablo 
			END

			IF @ISLEM = 3 OR @ISLEM = 4	--	Sınav Analiz Getir
			BEGIN
				
				SELECT   YS.SORUNO								AS SORUNO
						,YS.PUAN								AS PUANDEGERI															
						,D.DERSAD								AS DERSAD
						,CONVERT(DECIMAL(18,2), AVG(YOC.PUAN))	AS ORTALAMA 
						,ISNULL(SDU.AD, 'Belirtilmemiş')		AS KAZANIM 
				INTO   #tabloY 
				FROM Yazili Y 
				INNER JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS				= Y.ID_DERS
				INNER JOIN YaziliSoru						YS	ON	YS.ID_YAZILI			= Y.ID_YAZILI
				INNER JOIN YaziliOgrenci					YO	ON	YO.ID_YAZILI			= Y.ID_YAZILI 
				INNER JOIN YaziliOgrenciCevap				YOC ON	YOC.ID_YAZILIOGRENCI	= YO.ID_YAZILIOGRENCI 
																AND YOC.ID_YAZILISORU		= YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.TCKIMLIKNO			= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON	SDU.KOD					= YS.KOD
				WHERE	Y.ID_YAZILI		= @ID_SINAV 
					AND YO.KATILMADI	= 0 
					AND YO.AKTIF		= 1
					AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP BY YS.SORUNO, YS.PUAN, D.DERSAD, SDU.AD--, YO.TELAFI
				
				
				SELECT O.ID_OGRENCI, 
						--ISNULL(YO.TELAFI, Sum(YOC.PUAN)) AS PUAN 
						CASE WHEN YO.KATILMADI = 1 THEN YO.TELAFI ELSE Sum(YOC.PUAN) END AS PUAN
				INTO   #tablo2Y 
				FROM   YaziliOgrenci YO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO 
				WHERE  Y.ID_YAZILI = @ID_SINAV 
					   AND YO.KATILMADI = 0 
					   AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					   AND ( ( O.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP  BY O.ID_OGRENCI, YO.TELAFI ,YO.KATILMADI
				
				CREATE TABLE #tablo3Y (KISISAYISI INT,DURUM VARCHAR(20),SIRA INT)

				
				IF EXISTS ( SELECT ID_YAZILI FROM Yazili Y JOIN v3KademeBilgi KB ON KB.ID_KADEME3 = Y.ID_KADEME3 WHERE Y.ID_YAZILI = @ID_SINAV AND KB.ID_KADEME = 5) -- LISE İSE
				BEGIN
				INSERT INTO #tablo3Y
				SELECT Count(1) AS KISISAYISI, 
					   'PEKIYI' AS DURUM, 
					   5        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 101 
					   AND t.PUAN > 84 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'IYI'    AS DURUM, 
					   4        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 85 
					   AND t.PUAN > 69 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'ORTA'   AS DURUM, 
					   3        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 70 
					   AND t.PUAN > 59 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECER'  AS DURUM, 
					   2        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 60 
					   AND t.PUAN > 49 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECMEZ' AS DURUM, 
					   1        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 50 
				ORDER  BY SIRA DESC 
				END
				ELSE
				BEGIN
				INSERT INTO #tablo3Y
				SELECT Count(1) AS KISISAYISI, 
					   'PEKIYI' AS DURUM, 
					   5        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 101 
					   AND t.PUAN >= 85
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'IYI'    AS DURUM, 
					   4        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 85 
					   AND t.PUAN >= 70
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'ORTA'   AS DURUM, 
					   3        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 70 
					   AND t.PUAN >= 55 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECER'  AS DURUM, 
					   2        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 55 
					   AND t.PUAN >= 45 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECMEZ' AS DURUM, 
					   1        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 45 
				ORDER  BY SIRA DESC 
				END

				IF @ISLEM = 3
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT t.SORUNO                                                    AS SN, 
									   t.DERSAD                                                    AS DERS, 
									   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
									   t.KAZANIM 
								FROM   #tabloY t 
								ORDER  BY t.SORUNO 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T1,
							(
								SELECT t.KISISAYISI, 
								   t.DURUM, 
								   t.SIRA, 
								   (SELECT Sum(KISISAYISI) FROM #tablo3Y) AS TOPLAMKISISAYISI 
								FROM   #tablo3Y t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T2,
							(
								SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
								   Min(t.PUAN)                                                 AS ENDUSUK, 
								   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
								FROM   #tablo2Y t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T3		
						) AS XTABLE	
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END 
				ELSE IF @ISLEM = 4
				BEGIN
					SET @TITLE = (SELECT ACIKLAMA FROM [dbo].[v3AktifDonem] WHERE DONEM = @DONEM)
					SET @TITLE += ' ('+ (SELECT KOD FROM Yazili WHERE ID_YAZILI = @ID_SINAV) + ') SORU ANALİZİ'
					SELECT t.SORUNO                                                    AS SN, 
						   t.DERSAD                                                    AS DERS, 
						   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
						   t.KAZANIM 
					FROM   #tabloY t 
					ORDER  BY t.SORUNO 

					SET @TKS = (SELECT Sum(KISISAYISI) FROM #tablo3Y)

					SELECT t.KISISAYISI, 
						   t.DURUM, 
						   t.SIRA, 
						   @TKS AS TOPLAMKISISAYISI,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),t.KISISAYISI)/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS YUZDE
					FROM   #tablo3Y t 

					SELECT (@TKS - t.KISISAYISI) AS BASARILI, 
						   (t.KISISAYISI) AS BASARISIZ,  
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(@TKS - t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARILIYUZDE,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARISIZYUZDE
					FROM   #tablo3Y t 
					WHERE  t.SIRA=1

					SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
						   Min(t.PUAN)                                                 AS ENDUSUK, 
						   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
					FROM   #tablo2Y t 

					SELECT @TITLE
				END			
				
				DROP TABLE #tablo3Y
				DROP TABLE #tablo2Y
				DROP TABLE #tabloY 
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavHariciPuanSira]    Script Date: 23.11.2021 15:13:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavHariciPuanSira]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@DOGRULAMA			VARCHAR(44)		= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL	,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,DOGRULAMA					= @DOGRULAMA	
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
 
	IF @DOGRULAMA = '693M161f1Sv595Y' AND @ISLEM = 3  -- optik işlemlerinden geliyorsa 
		SET @ID_LOG=2
	ELSE
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1 
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @DONEM IS NULL OR @DONEM = ''
			SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
						
		IF @ISLEM = 1	--	PUANTURU
		BEGIN
			SELECT PT.ID_SINAVPUANTURU
				,PUANTURU = pt.AD
			FROM Sinav			S 
			JOIN SinavPuanTuru	PT	ON	PT.ID_SINAVTURU	= S.ID_SINAVTURU
			WHERE S.ID_SINAV = @ID_SINAV
			ORDER BY PT.ID_SINAVPUANTURU
		END

		IF @ISLEM = 2	--	SINAV DETAY GETİR
		BEGIN
		
			DROP TABLE IF EXISTS #OGRENCILIST

			SELECT  
				 TCKIMLIKNO			= JSON_VALUE(J.VALUE,'$.TCKIMLIKNO') 
				,ADSOYAD			= JSON_VALUE(J.VALUE,'$.ADSOYAD') 
				,ILCEKATILIM		= JSON_VALUE(J.VALUE,'$.ILCEKATILIM') 
				,ILKATILIM			= JSON_VALUE(J.VALUE,'$.ILKATILIM') 
				,GENELKATILIM		= JSON_VALUE(J.VALUE,'$.GENELKATILIM') 
				,ID_SINAV			= @ID_SINAV
				,ID_SINAVPUANTURU	= ID_SINAVPUANTURU	
				,PUAN				= PUAN
				,SINIFSIRA			= SINIFSIRA	
				,OKULSIRA			= OKULSIRA	
				,ILCESIRA			= ILCESIRA	
				,ILSIRA				= ILSIRA		
				,GENELSIRA			= GENELSIRA	
			INTO #OGRENCILIST
			FROM OPENJSON (@SQLJSON) AS J
			CROSS APPLY (
				SELECT PUAN				= replace(JSON_VALUE(H.VALUE,'$.PUAN'),',','.')
					,ID_SINAVPUANTURU	= JSON_VALUE(H.VALUE,'$.ID_SINAVPUANTURU')
					,SINIFSIRA			= JSON_VALUE(H.VALUE,'$.SINIFSIRA')
					,OKULSIRA			= JSON_VALUE(H.VALUE,'$.OKULSIRA')
					,ILCESIRA			= JSON_VALUE(H.VALUE,'$.ILCESIRA')
					,ILSIRA				= JSON_VALUE(H.VALUE,'$.ILSIRA')
					,GENELSIRA			= JSON_VALUE(H.VALUE,'$.GENELSIRA')
				FROM OPENJSON (J.VALUE,'$.HariciList') AS H 
			)AS S
			
			DELETE FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV
			
			INSERT INTO SinavOgrenciHariciPuanSiralama ( TCKIMLIKNO, ID_SINAV, ID_SINAVPUANTURU, PUAN, SINIFSIRA, OKULSIRA, ILCESIRA, ILSIRA, GENELSIRA, ILCEKATILIM, ILKATILIM, GENELKATILIM )
			SELECT DISTINCT OL.TCKIMLIKNO, OL.ID_SINAV, OL.ID_SINAVPUANTURU, OL.PUAN, OL.SINIFSIRA, OL.OKULSIRA, OL.ILCESIRA, OL.ILSIRA, OL.GENELSIRA, OL.ILCEKATILIM, OL.ILKATILIM, OL.GENELKATILIM
			FROM Sinav			S	
			JOIN SinavPuanTuru	PT	ON	PT.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN #OGRENCILIST	OL	ON	OL.ID_SINAV			= S.ID_SINAV	
									AND OL.ID_SINAVPUANTURU	= PT.ID_SINAVPUANTURU
			WHERE S.ID_SINAV = @ID_SINAV

			DROP TABLE IF EXISTS #OGRENCILIST
			
			SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV

			SET @ISLEM = 3

		END

		IF @ISLEM = 3
		BEGIN

			UPDATE P SET
				 P.PUAN			= PS.PUAN
				,P.SINIFSIRA	= PS.SINIFSIRA		
				,P.OKULSIRA		= PS.OKULSIRA			
				,P.ILCESIRA		= PS.ILCESIRA			
				,P.ILSIRA		= PS.ILSIRA			
				,P.GENELSIRA	= PS.GENELSIRA		
			FROM SinavOgrenci					SO
			JOIN SinavOgrenciSonuc				P	ON	P.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV			= SO.ID_SINAV
													AND PS.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND PS.ID_SINAVPUANTURU = P.ID_SINAVPUANTURU
			WHERE PS.ID_SINAV = @ID_SINAV

			UPDATE P SET
				 P.PUAN			= PS.PUAN
				,P.SINIFSIRA	= PS.SINIFSIRA		
				,P.OKULSIRA		= PS.OKULSIRA			
				,P.ILCESIRA		= PS.ILCESIRA			
				,P.ILSIRA		= PS.ILSIRA			
				,P.GENELSIRA	= PS.GENELSIRA		
			FROM SinavOgrenciPuan				P	
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV		= P.ID_SINAV
													AND PS.TCKIMLIKNO	= P.TCKIMLIKNO
													AND PS.ID_SINAVPUANTURU = P.ID_SINAVPUANTURU
			WHERE PS.ID_SINAV = @ID_SINAV


			UPDATE K SET 
				 K.KATILIM_GENEL= ISNULL(PS.GENELKATILIM,K.KATILIM_GENEL)
				,K.KATILIM_IL	= ISNULL(PS.ILKATILIM	,K.KATILIM_IL)
				,K.KATILIM_ILCE = ISNULL(PS.ILCEKATILIM	,K.KATILIM_ILCE)
			FROM SinavOgrenciToplam				K
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV		= K.ID_SINAV
													AND PS.TCKIMLIKNO	= K.TCKIMLIKNO
			WHERE	K.ID_SINAV	= @ID_SINAV			
				AND (	PS.GENELKATILIM IS NOT NULL
					OR	PS.ILCEKATILIM  IS NOT NULL
					OR  PS.ILKATILIM	IS NOT NULL)

		END

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavIstatistik]    Script Date: 23.11.2021 15:13:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavIstatistik]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				CHAR(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@DOSYAADI			VARCHAR(100)	= NULL,
	@DOSYAGUID			VARCHAR(50)		= NULL,
	@ID_SINAVDOSYA		INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL	,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
		IF @DONEM IS NULL OR @DONEM = ''
			SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
						
		IF @ISLEM = 1	--	SINAV İSTATİSTİK
		BEGIN

--		exec sp_SinavIstatistik @ISLEM=1, @TCKIMLIKNO='32051057542',@OTURUM='A51D1B28-244C-4A7E-8CCF-9564B00A9C35',@TC_OGRENCI='10502544810',@DONEM= 2017, @ID_MENU= 1029,@ID_SINAVTURU=9
			
			IF OBJECT_ID('tempdb..#TEMP')	IS NOT NULL		DROP TABLE #TEMP
			IF OBJECT_ID('tempdb..#PUAN')	IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#TT')		IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#T1')		IS NOT NULL		DROP TABLE #T1

			SELECT	
					count(1) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=MAX(D.ID_SINAVDERS)) TOPLAMSORU
					--,o.ID_SINAV
			into #TEMP 
			from SinavOgrenci		o
			JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
			JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
			JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS 
											and d.ID_SINAV					= o.ID_SINAV
			JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV 
			JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
											AND	K.AD						= o.KITAPCIK
			JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
											AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
											AND A.ID_SINAVDERS				= B.ID_SINAVDERS 
			JOIN v3SinavDersUnite		u	ON  u.KOD						= a.KOD			-- ktt almanca ünite olmadığından boş çıkıyor.
			WHERE	S.AKTIF			= 1		
				AND S.DURUM			= 2	
				AND o.TCKIMLIKNO	= @TC_OGRENCI	
				AND S.ID_SINAVTURU	= @ID_SINAVTURU					
				AND (OZEL=0 OR @OZELSINAVGOR=1)
			GROUP BY c.DURUM,d.TAKMAAD,u.kod,U.AD--,D.ID_SINAVDERS--,o.ID_SINAV
			ORDER BY d.TAKMAAD

			SELECT	 O.TCKIMLIKNO
					,PUAN				= ISNULL( S.PUAN,0) 
					,B.NET
					,O.ID_SINAV
					,B.ID_SINAVDERS
					,DERSAD				= D.TAKMAAD
					,PUANTURU			= ISNULL( T.AD,'') 
					,ID_SINAVPUANTURU	= ISNULL( T.ID_SINAVPUANTURU,0) 
					,SINAVAD			= V.AD 
					,V.SINAVTARIH
					,V.PUANGIZLE
			INTO	#PUAN
			FROM		SinavOgrenci			O
			JOIN		SinavOgrenciCevapBolum	B	ON  B.ID_SINAVOGRENCI	= O.ID_SINAVOGRENCI
			JOIN		SinavDers				D	ON  D.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN		Sinav					V	ON  V.ID_SINAV			= O.ID_SINAV
			left JOIN	SinavOgrenciPuan		S	ON  S.ID_SINAV			= O.ID_SINAV
													AND S.TCKIMLIKNO		= O.TCKIMLIKNO
			left JOIN	SinavPuanTuru			T	ON	T.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
			WHERE	v.AKTIF			= 1		
				AND v.DURUM			= 2	
				AND O.TCKIMLIKNO	= @TC_OGRENCI
				AND V.ID_SINAVTURU	= @ID_SINAVTURU
				AND V.DONEM			= @DONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)

			SELECT DERSAD,KOD,KONUAD,0 AS BOLUMYUZDE,TOPLAMSORU,ISNULL(max([D]),0) DOGRU,ISNULL(max([Y]),0) YANLIS,ISNULL(max([B]),0) BOS,--ID_SINAV,
			ISNULL( 
				CAST(((100 /
					CAST((
						ISNULL(max([D]),0)+ISNULL(max([Y]),0)+ISNULL(max([B]),0)) AS DECIMAL(11,2) 
					))
					* ISNULL(max([D]),0)
				) AS DECIMAL(11,2)) 
			,0) AS YUZDE
			into #TT
			FROM ( SELECT * FROM #TEMP )AS GTABLO--  WHERE LEN(KOD)<10 )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
			group by DERSAD,KOD,KONUAD,TOPLAMSORU

			select  DERSAD,KOD,KONUAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS--,ID_SINAV
			,YUZDE, 1 as TIP
			into #T1
			from #TT
	union all			
			SELECT	DERSAD,
					'' as KOD,
					DERSAD AS KONUAD,
					CAST(CAST(SUM(DOGRU) AS DECIMAL(8,2))/CAST(SUM(DOGRU+YANLIS+BOS) AS DECIMAL(8,2)) *100.0 AS DECIMAL(8,2)) AS BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS),
					SUM(DOGRU),
					SUM(YANLIS),
					SUM(BOS),
					CAST(CAST(SUM(DOGRU) AS DECIMAL(8,2))/CAST(SUM(DOGRU+YANLIS+BOS) AS DECIMAL(8,2)) *100.0  AS DECIMAL(8,2)),
					0 as TIP
			FROM #TT 
			GROUP BY DERSAD
									

			select(
				select * from(
					select 
					(
						select * from #T1
						order by DERSAD, TIP, YUZDE desc
						FOR JSON AUTO
					) as t1
					,( 
						SELECT ID_SINAV,SUM(NET) TOPLAMNET,PUAN,ID_SINAVPUANTURU,PUANTURU,SINAVAD,PUANGIZLE FROM #PUAN
						--WHERE PUANGIZLE = 0
						GROUP BY ID_SINAV,ID_SINAVPUANTURU,PUAN,PUANTURU,SINAVAD,SINAVTARIH,PUANGIZLE
						ORDER BY SINAVTARIH DESC
						FOR JSON AUTO
					)as t2
					,(
						SELECT   DERSAD
								,ID_SINAVPUANTURU
								,PUANTURU
								,(SELECT NET, SINAVAD FOR JSON PATH) AS D
						FROM #PUAN
						GROUP BY ID_SINAVDERS, DERSAD, NET, ID_SINAVPUANTURU, PUANTURU, SINAVAD,SINAVTARIH
						ORDER BY SINAVTARIH DESC
						FOR JSON PATH
					) as t3 
				) as tablo FOR JSON AUTO
			) as tt
			 



			
			IF OBJECT_ID('tempdb..#TEMP')	IS NOT NULL		DROP TABLE #TEMP
			IF OBJECT_ID('tempdb..#PUAN')	IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#TT')		IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#T1')		IS NOT NULL		DROP TABLE #T1

		END

		IF @ISLEM = 2	--	SINAV DETAY GETİR
		BEGIN
			SELECT
			(
				SELECT SD.TAKMAAD, SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS SORU, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SOCB.NET
				FROM SinavOgrenci SO
				INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN SinavDers SD ON SD.ID_SINAVDERS = SOCB.ID_SINAVDERS
				WHERE SO.TCKIMLIKNO=@TC_OGRENCI AND SO.ID_SINAV=@ID_SINAV
				GROUP BY SO.TCKIMLIKNO, SD.TAKMAAD, SD.BOLUMNO, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SOCB.NET
				ORDER BY SD.BOLUMNO
				FOR JSON PATH
			) AS J
		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavKatilim]    Script Date: 23.11.2021 15:31:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavKatilim] 
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMSINAV			char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
 	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


	--with recompile 
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMSINAV					= @DONEMSINAV		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.[sp_SinavKatilim] @TCKIMLIKNO='32051057542',@OTURUM='FD2297C4-AF4C-42A6-B6A3-7E0510FB7995',@ISLEM=2,@DONEM='2018',@ID_SINAVTURU=0,@ID_KADEME3=0,@ID_SINAVs='[]',@ID_SUBEs='[]',@ID_SINIFs='[]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
	
		DROP TABLE IF EXISTS #Okul
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Sinif
		DROP TABLE IF EXISTS #Genel
		DROP TABLE IF EXISTS ##Katilim
		DROP TABLE IF EXISTS ##Pivots
		DROP TABLE IF EXISTS ##PivotsSinif
		DROP TABLE IF EXISTS ##KatilimSinif
		DROP TABLE IF EXISTS #SinifKatilim
		DROP TABLE IF EXISTS #OkulKatilim
		DROP TABLE IF EXISTS #GenelSinif
		DROP TABLE IF EXISTS #OGRENCILIST




		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		--declare  @sID_SINIFs	varchar(max) = @ID_SINIFs
		--		,@sID_SUBEs		varchar(max) = @ID_SUBEs
		--		,@sID_KADEME3	int			 = @ID_KADEME3	
		--		,@sDONEMSINAV	varchar(max) = @ID_SUBEs	
		--		,@sDONEM		varchar(max) = @ID_SUBEs		
		--		,@sID_SINAVTURU	int			 = @ID_KADEME3		
		--		,@sID_SINAVs			



		IF @ID_SINAVTURU=0 
		BEGIN
			SELECT	top 1 @ID_KADEME3	= S.ID_KADEME3 
					,@DONEMSINAV		= S.DONEM
					,@DONEM				= S.DONEM
					,@ID_SINAVTURU		= S.ID_SINAVTURU
					,@ID_SINAVs			= '['+CAST(S.ID_SINAV AS VARCHAR)+']'
			FROM	Sinav	S
			WHERE	AKTIF=1 
				AND DURUM=2 
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF= 1)
				AND (SELECT COUNT(1) FROM SinavOgrenci SO WHERE SO.ID_SINAV = S.ID_SINAV)>1
			ORDER BY SINAVTARIH DESC
					,ID_SINAV   DESC

			SET @ID_SUBEs ='[]'
			SET @ID_SINIFs ='[]'


			--SELECT @ID_KADEME3,@DONEM,@ID_SINAVTURU,@ID_SINAVs,@ID_SUBEs,@ID_SINIFs
		END
		
			
			
			SELECT DISTINCT O.TCKIMLIKNO
			INTO #OGRENCILIST
			FROM v3OgrenciTum						O 	
			JOIN v3SinifTum							SN	ON	SN.ID_SINIF		= O.ID_SINIF
			JOIN OkyanusDB.DBO.v3SubeGrupSinifTum	T	ON	T.ID_SINIF		= SN.ID_SINIF
			WHERE	(SN.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@ID_SINIFs)) OR @ID_SINIFs = '[]')
				AND (O.ID_SUBE	 IN (SELECT VALUE FROM OPENJSON (@ID_SUBEs))  OR @ID_SUBEs  = '[]')	
				AND O.DONEM = @DONEM
				AND T.ID_KADEME3 = @ID_KADEME3
				
	

		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)
		Declare @Columns3 as varchar(max)
		Declare @Columns4 as varchar(max)
		Declare @Columns5 as varchar(max)
		Declare @Columns6 as varchar(max)
		
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[335,368]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[90,75,153]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18


		-- GENEL OGR SAYISI
		BEGIN


		
		
			SELECT	SNF.ID_SINIF,SNF.AD SINIFAD,SU.ID_SUBE,SU.AD SUBEAD,COUNT(DISTINCT O.TCKIMLIKNO) OGRSAY
			INTO	#Sinif
			FROM	v3OgrenciTum						O
			JOIN	#OGRENCILIST						OL	ON	OL.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN	v3SinifTum							SNF	ON	SNF.ID_SINIF	= O.ID_SINIF 
			JOIN	V3DONEM								D	ON	D.ID_DONEM		= SNF.ID_DONEM
			JOIN	v3Sube								SU	ON	SU.ID_SUBE		= O.ID_SUBE
			JOIN	OKYANUSDB.DBO.v3SubeGrupSinifTum	SG	ON	SG.ID_SINIF		= SNF.ID_SINIF
			WHERE	D.KOD			= @DONEM				
			GROUP BY SNF.ID_SINIF,SNF.AD,SU.ID_SUBE,SU.AD



			SELECT	 ID_SUBE,SUBEAD,SUM(OGRSAY) OGRSAY
			INTO	#Okul
			FROM	#Sinif 
			GROUP BY ID_SUBE,SUBEAD
		
		END
		
		
		SELECT SO.TCKIMLIKNO,YO.ID_SUBE,YO.ID_SINIF,S.ID_SINAV,S.AD SINAVAD,S.SINAVTARIH
		INTO	#Temp
		FROM	Sinav				S
		JOIN	SinavOgrenci		SO	ON	S.ID_SINAV		= SO.ID_SINAV
		JOIN	v3OgrenciTum		O	ON	O.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN	V3DONEM				D	ON	D.ID_DONEM		= O.ID_DONEM
		JOIN	v3OgrenciTum		YO	ON	YO.TCKIMLIKNO	= O.TCKIMLIKNO AND YO.DONEM = @DONEM
		JOIN	OKYANUSDB.DBO.v3SubeGrupSinifTum	T	ON	T.ID_SINIF	= O.ID_SINIF
														AND T.ID_KADEME3= S.ID_KADEME3
		WHERE	S.ID_SINAVTURU	=	@ID_SINAVTURU
			AND S.DONEM			=	@DONEMSINAV
			AND (O.ID_SUBE		IN	(SELECT Value FROM OPENJSON(@ID_SUBEs))  OR @ID_SUBEs ='[]')
			AND (S.ID_SINAV		IN	(SELECT Value FROM OPENJSON(@ID_SINAVs)) OR @ID_SINAVs='[]')			
		GROUP BY SO.TCKIMLIKNO,YO.ID_SUBE,YO.ID_SINIF,S.ID_SINAV,S.AD,S.SINAVTARIH


		SELECT ID_SINIF,ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH,COUNT(1) SINIFKATILIM 
		INTO #SinifKatilim
		FROM #Temp
		GROUP BY ID_SINIF,ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH

		
		SELECT ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH,COUNT(1) OKULKATILIM 
		INTO #OkulKatilim
		FROM #Temp
		GROUP BY ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH

		--SELECT * FROM #SinifKatilim
		--SELECT * FROM #OkulKatilim


		SELECT	O.SUBEAD, OK.ID_SUBE, ID_SINAV, SINAVAD, SINAVTARIH, O.OGRSAY, OK.OKULKATILIM,OGRSAY-OKULKATILIM KATILMAYAN,OKULKATILIM KATILAN, CAST((CAST(OKULKATILIM AS decimal(8,2)) / OGRSAY) * 100 AS decimal(8,2))  YUZDE
		INTO	#Genel
		FROM	#OkulKatilim	OK
		JOIN	#Okul			O	ON	O.ID_SUBE=OK.ID_SUBE
		
		SELECT	S.SINIFAD, SK.ID_SINIF, S.SUBEAD, ID_SINAV, SINAVAD, SINAVTARIH, S.OGRSAY, SK.SINIFKATILIM,OGRSAY-SINIFKATILIM KATILMAYAN,SINIFKATILIM KATILAN, CAST((CAST(SINIFKATILIM AS decimal(8,2)) / OGRSAY) * 100 AS decimal(8,2))  YUZDE
		INTO	#GenelSinif
		FROM	#SinifKatilim	SK
		JOIN	#Sinif			S	ON	S.ID_SINIF=SK.ID_SINIF


			--Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			--from 
			--	( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			--order by b.SINAVTARIH
			
			--Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX(P.'+QUOTENAME(SINAVAD)+')AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			--from 
			--	( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			--order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(MAX(P2.'+QUOTENAME(ID_SINAV)+'),0) AS ' +QUOTENAME(ID_SINAV) 
			from 
				( Select distinct ID_SINAV,SINAVTARIH from #Temp  ) as b 				
			ORDER BY SINAVTARIH 

			Select @Columns4=Coalesce(@Columns4+',','')+QUOTENAME(ID_SINAV) 
			from 
				( Select distinct ID_SINAV,SINAVTARIH from #Temp  ) as b 
			ORDER BY SINAVTARIH 
			
			Select @Columns5=Coalesce(@Columns5+',','')+'SUM('+QUOTENAME(ID_SINAV) +') AS ' +QUOTENAME(ID_SINAV) 
				+',CAST(CAST(SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/ SUM(OGRSAY)*100.0 AS DECIMAL(8,2)) AS YUZDEKATILAN'+CAST(ID_SINAV AS VARCHAR)
				+',CAST(CAST(SUM(OGRSAY)-SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/ SUM(OGRSAY)*100.0 AS DECIMAL(8,2)) AS YUZDEKATILMAYAN'+CAST(ID_SINAV AS VARCHAR)
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH

			Select @Columns6=Coalesce(@Columns6+',','')+'SUM('+QUOTENAME(ID_SINAV) +') AS '+QUOTENAME(ID_SINAV) +' ,CAST(CAST(SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/OGRSAY*100.0 AS DECIMAL(8,2)) AS YUZDEKATILAN'+CAST(ID_SINAV AS VARCHAR)
						+',CAST(CAST(sum(OGRSAY)-SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/sum(OGRSAY)*100.0 AS DECIMAL(8,2)) AS YUZDEKATILMAYAN'+CAST(ID_SINAV AS VARCHAR)
			from 
				( Select distinct ID_SINAV,SINAVTARIH from #Temp  ) as b 
			ORDER BY SINAVTARIH 

			--Select @Columns5=Coalesce(@Columns5+',','')+'SUM('+QUOTENAME(ID_SINAV) +') AS ' +QUOTENAME(ID_SINAV) 
			--from 
			--	( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			--order by b.SINAVTARIH



		IF NOT EXISTS (SELECT * FROM #Temp)
		BEGIN
		print 11
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##Pivots
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##Katilim
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##PivotsSinif
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##KatilimSinif
		END			

		Set @SQL='	
		
			Select 								 
				0 SIRA,SUBEAD,OGRSAY, 
				'+@Columns3+' 
			into ##Pivots
			from (
				Select 
					SUBEAD,ID_SUBE, ID_SINAV, SINAVAD, SINAVTARIH, OGRSAY, OKULKATILIM, KATILMAYAN, KATILAN,YUZDE
				from #Genel
			) AS S			
			PIVOT (MAX(KATILAN) FOR ID_SINAV IN('+@Columns4+')) as P2
			GROUP BY SUBEAD,ID_SUBE,OGRSAY


		
			SELECT SIRA,SUBEAD,OGRSAY,'+@Columns6+' INTO ##Katilim FROM ##Pivots
			group by SIRA,SUBEAD,OGRSAY
		UNION ALL	
			SELECT 1 SIRA,''GENEL'' SUBEAD,SUM(OGRSAY) OGRSAY,'+@Columns5+' FROM ##Pivots			
		ORDER BY SIRA,SUBEAD
		
		

			Select 								 
				0 SIRA,SINIFAD,OGRSAY,ID_SINIF,SUBEAD, 
				'+@Columns3+' 
			into ##PivotsSinif
			from (
				Select 
					SINIFAD,ID_SINIF, ID_SINAV, SINAVAD, SINAVTARIH, OGRSAY, SINIFKATILIM, KATILMAYAN, KATILAN,YUZDE,SUBEAD
				from #GenelSinif
			) AS S			
			PIVOT (MAX(KATILAN) FOR ID_SINAV IN('+@Columns4+')) as P2
			GROUP BY SINIFAD,ID_SINIF,OGRSAY,SUBEAD

			
			SELECT SIRA,SUBEAD = ''(''+SUBEAD+'') ''+SINIFAD ,OGRSAY,ID_SINIF,'+@Columns6+' INTO ##KatilimSinif FROM ##PivotsSinif
			group by SIRA,SINIFAD,OGRSAY,ID_SINIF,SUBEAD	
			
		UNION ALL	
			SELECT 1 SIRA,''GENEL'' SUBEAD,SUM(OGRSAY) OGRSAY,0,'+@Columns5+' FROM ##PivotsSinif			
			

	
		'
		PRINT @SQL
		EXEC (@SQL)
		
--		exec dbo.[sp_SinavKatilim] @TCKIMLIKNO='32051057542',@OTURUM='6807E433-4AC5-4F31-9EA2-0117900ACB29',@ISLEM=2,@DONEM='2017',@ID_SINAVTURU=2,@ID_KADEME3=18,@ID_SINAVs='[164]',@ID_SUBEs='[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]',@ID_SINIFs='[0,102208,102207,102293,104343,101677,101671,101679,101672,101676,101680,101926,101927,101924,101925,101873,101875,101435,101434,101709,101710,101707,101708,101826,102174,101497,101498,101417,101419,101613,101615,101614,101861,104756,101860,101867,100987,105219,105416,105417,102307,102306,102087,102086,102147,102146,104554,101943,101525,101526,104673,104676]'

		--SELECT * FROM ##Katilim

		--SELECT DISTINCT ID_SINAV,SINAVAD,SINAVTARIH FROM #Temp ORDER BY SINAVTARIH
			SELECT DISTINCT T.ID_SINAV,SINAVAD,T.SINAVTARIH,UPPER(K.AD) KADEME3, UPPER(ST.AD) SINAVTURU
		INTO #Temp2
		FROM #Temp		T
		JOIN Sinav		S	ON	S.ID_SINAV		= T.ID_SINAV
		JOIN v3Kademe3	K	ON	K.ID_KADEME3	= S.ID_KADEME3
		JOIN SinavTuru	ST	ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
		ORDER BY T.SINAVTARIH

		IF @ISLEM = 1
		BEGIN

		 select(
				select * from(
						select 
						(					
							SELECT		*
							FROM		##Katilim 
							FOR JSON AUTO
						) as t1,
						(					
							SELECT DISTINCT ID_SINAV,SINAVAD,SINAVTARIH,KADEME3,SINAVTURU FROM #Temp2
							ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t2,
						(					
							SELECT		*
							FROM		##KatilimSinif 	
							ORDER BY SIRA,SUBEAD
							FOR JSON AUTO
						) as t3		
					) as tablo FOR JSON AUTO
				) as tt
		END
		IF @ISLEM = 2
		BEGIN
			SELECT * FROM ##Katilim 

			SELECT DISTINCT ID_SINAV,SINAVAD,SINAVTARIH,KADEME3,SINAVTURU FROM #Temp2
			ORDER BY SINAVTARIH

			SELECT * FROM ##KatilimSinif
			ORDER BY SIRA,SUBEAD
		END

		
		DROP TABLE IF EXISTS #Okul
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Sinif
		DROP TABLE IF EXISTS #Genel
		DROP TABLE IF EXISTS ##Katilim
		DROP TABLE IF EXISTS ##Pivots
		DROP TABLE IF EXISTS ##PivotsSinif
		DROP TABLE IF EXISTS ##KatilimSinif
		DROP TABLE IF EXISTS #SinifKatilim
		DROP TABLE IF EXISTS #OkulKatilim
		DROP TABLE IF EXISTS #GenelSinif
		DROP TABLE IF EXISTS #OGRENCILIST


	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavKonuAnalizi]    Script Date: 23.11.2021 15:31:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavKonuAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@GRUPLAMATURU		INT				= 1,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,SQLJSON					= @SQLJSON		
			,DONEM						= @DONEM			
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,GRUPLAMATURU				= @GRUPLAMATURU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )

		IF (@ISLEM = 1 OR @ISLEM = 2)  -- SINIF
		BEGIN
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #DERS			
			
			SELECT DERSAD INTO #DERS 
			from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'

			
			SELECT	S.ID_SINAV
					,S.AD SINAVAD
					,SINAVTARIH		= CONVERT(VARCHAR,SINAVTARIH,103) 
					,SO.TCKIMLIKNO
					,O.ID_SINIF
					,SINIFAD		= SN.AD 
					,VD.ID_DERS
					,VD.DERSAD 
					,NET
					,DOGRU
					,YANLIS
					,BOS
					,O.ID_SUBE
					,SUBEAD			= SU.AD 
					,OC.DURUM
					,OGRENCICEVAP	= OC.CEVAP 
					,DOGRUCEVAP		= SA.CEVAP 
					,KOD			= CASE	WHEN @GRUPLAMATURU = 1 THEN ISNULL(SA.KOD,'') 
											WHEN @GRUPLAMATURU = 2 THEN SUBSTRING(SA.KOD, 1, 9) 
											WHEN @GRUPLAMATURU = 3 THEN SUBSTRING(SA.KOD, 1, 6) 
										ELSE '' END
					,KAZANIM		= CASE	WHEN @GRUPLAMATURU = 1 THEN U.AD 
										ELSE '' END
					,KONU			= CASE	WHEN @GRUPLAMATURU = 1 OR @GRUPLAMATURU = 2 THEN (SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 9)) 
										ELSE '' END 
					,UNITE			= (SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 6))
					,SA.SORUNO_A
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			INNER JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			INNER JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
			INNER JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
			INNER JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
			INNER JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI
			INNER JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			INNER JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			INNER JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			INNER JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN	SinavKitapcik			SK	WITH (NOLOCK)	ON	SK.ID_SINAV						= S.ID_SINAV	
			 														AND	SK.AD							= SO.KITAPCIK 
			INNER JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																	AND SA.SORUNO						= OC.SORUNO
																	AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
																	AND SA.KOD IS NOT NULL AND SA.KOD <> ''
			INNER JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD							= SA.KOD
			WHERE	S.DURUM			=	2
				AND S.AKTIF			=	1
				AND O.DONEM			=	@OGRENCIDONEM
				AND (OZEL = 0		OR	@OZELSINAVGOR=1)				
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		
				
			DROP TABLE IF EXISTS #TEMP
			SELECT KOD, KONU, UNITE, KAZANIM, DURUM, COUNT(DURUM) DURUMSAYISI, 0 KISISAYISI, (SELECT COUNT(DISTINCT CONCAT_WS('-',SORUNO_A,ID_SINAV)) FROM #TEMP_SINIF S WHERE S.KOD=T.KOD) SORUSAYISI, DERSAD
			INTO #TEMP
			FROM #TEMP_SINIF T
			GROUP BY KOD, KONU, UNITE, KAZANIM, DURUM, DERSAD

			UPDATE T
			SET KISISAYISI = (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.KOD=T.KOD)
			FROM #TEMP T
				

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 
						(					
							SELECT KOD, KONU, KAZANIM, UNITE, SORUSAYISI, DERSAD
							,DOGRUYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND G.KOD = T.KOD AND DURUM = 'D'),0.00)
							,YANLISYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND G.KOD = T.KOD AND DURUM = 'Y'),0.00)
							,BOSYUZDESI		= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND G.KOD = T.KOD AND DURUM = 'B'),0.00)
							FROM #TEMP T
							GROUP BY KONU, KAZANIM, KOD, UNITE, SORUSAYISI, DERSAD--,ID_SUBE,SUBEAD
							ORDER BY DERSAD, UNITE, KONU, KAZANIM
							FOR JSON AUTO,INCLUDE_NULL_VALUES
						) as TblVeri,					
						(		
							SELECT DISTINCT DERSAD
							FROM #TEMP_SINIF
							ORDER BY DERSAD
							FOR JSON AUTO
						) as TblDersList,			
						(		
							SELECT DISTINCT ID_SINAV, SINAVAD, SINAVTARIH
							FROM #TEMP_SINIF
							ORDER BY ID_SINAV DESC
							FOR JSON AUTO
						) as TblSinavList
						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE
			BEGIN
				SELECT KOD, KONU, KAZANIM, UNITE, SORUSAYISI, DERSAD
					,DOGRUYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND  G.KOD = T.KOD AND DURUM = 'D'),0.00)
					,YANLISYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND  G.KOD = T.KOD AND DURUM = 'Y'),0.00)
					,BOSYUZDESI		= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND  G.KOD = T.KOD AND DURUM = 'B'),0.00)
				FROM #TEMP T
				GROUP BY KAZANIM, UNITE, KOD, KONU, SORUSAYISI, DERSAD--,ID_SUBE,SUBEAD
				ORDER BY DERSAD, UNITE, KONU, KAZANIM
								
				SELECT DISTINCT DERSAD
				FROM #TEMP_SINIF
				ORDER BY DERSAD

				SELECT DISTINCT ID_SINAV, SINAVAD, SINAVTARIH
				FROM #TEMP_SINIF
				ORDER BY ID_SINAV DESC
			END
			
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #DERS
		END			
	END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavListele]    Script Date: 23.11.2021 15:31:50 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavListele]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@SORUNO				INT			    = NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SORUISLEM		INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@ID_SINAVANAHTAR	int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,	
	@OGRENCICEVAP		NVARCHAR(MAX)	= NULL,	
	@ID_SINAVOGRENCI	INT				= NULL,
	@OGR_AD				VARCHAR(MAX)	= NULL,
	@OGR_SOYAD			VARCHAR(MAX)	= NULL,
	@SUBENO				VARCHAR(MAX)	= NULL,
	@SUBEAD				VARCHAR(MAX)	= NULL,
	@SINIF				VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVDERS				= @ID_SINAVDERS	
			,SORUNO						= @SORUNO			
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SORUISLEM				= @ID_SORUISLEM	
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
			,SQLJSON					= @SQLJSON		
			,OGRENCICEVAP				= @OGRENCICEVAP	
			,ID_SINAVOGRENCI			= @ID_SINAVOGRENCI
			,OGR_AD						= @OGR_AD			
			,OGR_SOYAD					= @OGR_SOYAD		
			,SUBENO						= @SUBENO			
			,SUBEAD						= @SUBEAD			
			,SINIF						= @SINIF			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1 -- Eşleşmeyen öğrenci listesi		
		BEGIN
			SELECT		ID_SINAVOGRENCI,TCKIMLIKNO,SO.AD,SOYAD, SO.SUBENO,ISNULL(VS.AD,'') SUBEAD,SINIF
			INTO		#T1
			FROM		SinavOgrenci	SO
			LEFT JOIN	V3SUBE			VS ON SO.SUBENO=RIGHT ('000' + VS.SUBENO,3)
			WHERE	TCKIMLIKNO NOT IN 
						( SELECT DISTINCT TCKIMLIKNO FROM v3Ogrenci )
				AND	ID_SINAV=@ID_SINAV 
				
			SELECT  VK.TCKIMLIKNO,VK.AD,VK.SOYAD,RIGHT('000'+ VS.SUBENO,3)SUBENO,VS.AD SUBEAD,VSN.AD SINIF
			INTO	#T2
			FROM	V3Ogrenci			VO
			JOIN	V3Kullanici			VK	ON	VK.TCKIMLIKNO=VO.TCKIMLIKNO
			JOIN	V3SUBE				VS	ON	VS.ID_SUBE=VO.ID_SUBE
			JOIN	V3Sinif				VSN	ON	VSN.ID_SINIF=VO.ID_SINIF
			JOIN	v3KullaniciKademe3	VKK	ON	VKK.TCKIMLIKNO=VO.TCKIMLIKNO
			WHERE	ID_KADEME3=@ID_KADEME3


			select(
				select * from(
					select 
					(
						select * from #T1
						order by AD
						FOR JSON AUTO
					) as t1,
					(
						select * from #T2
						order by SUBENO,SUBEAD,SINIF,AD,SOYAD
						FOR JSON AUTO
					) as t2					
				) as tablo FOR JSON AUTO
			) as tt
		END
		IF @ISLEM = 2 -- sınavogrenci eşleştir			
		BEGIN
			
			UPDATE		 SO 
			SET 
						 AD			= KL.AD
						,SOYAD		= KL.SOYAD
						,SINIF		= SN.AD
						,SUBENO		= RIGHT('000' + SB.SUBENO, 3)
						,TCKIMLIKNO	= KL.TCKIMLIKNO			
			FROM		SinavOgrenci			SO
			INNER JOIN	v3Kullanici		KL	ON	KL.TCKIMLIKNO	= @TC_OGRENCI
			INNER JOIN	v3Ogrenci		KS	ON	KS.TCKIMLIKNO	= KL.TCKIMLIKNO
			INNER JOIN	v3Sinif			SN	ON	SN.ID_SINIF		= KS.ID_SINIF
			INNER JOIN	v3Sube			SB	ON	SB.ID_SUBE		= KS.ID_SUBE
			WHERE SO.ID_SINAVOGRENCI	=	@ID_SINAVOGRENCI
			
			-- IN (select ID_SINAVOGRENCI FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV)	
			
			--select(
			--	select * from(
			--		select 
			--		(
			--			select 1
			--			FOR JSON AUTO
			--		) as t1					
			--	) as tablo FOR JSON AUTO
			--) as tt
		END
		IF @ISLEM = 3 -- Sınav Kopyala					
		BEGIN
			declare @ID_SINAV_NEW INT --,@ID_SINAV int =43,@DONEM VARCHAR(4),@TCKIMLIKNO VARCHAR(11)='56545519606'
			SELECT @DONEM=DONEM FROM V3AktifDonem WHERE AKTIF=1

			-- SINAV INSERT
			DECLARE @ID_SINAVLIST TABLE (ID_SINAV int)
			insert into Sinav (ID_SINAVTURU,AD,KOD,DONEM,ID_KADEME3,SINAVTARIH,OZEL,FREKANSHESAPLA,PUANGIZLE,YUKLEMEKAPAT,YANLISSAYISI,OLCEKSINAVI,DURUM,KYE_TCKIMLIKNO,KYE_TARIH,AKTIF,ONLINESINAV)
			OUTPUT INSERTED.ID_SINAV INTO @ID_SINAVLIST(ID_SINAV)
			SELECT TOP 1
				ID_SINAVTURU,AD+'('+@DONEM+') Kopya',KOD+'('+@DONEM+') Kopya',@DONEM,ID_KADEME3,CAST(GETDATE() AS date),OZEL,FREKANSHESAPLA,PUANGIZLE,YUKLEMEKAPAT,YANLISSAYISI,OLCEKSINAVI,0,@TCKIMLIKNO,CAST(GETDATE() AS date),AKTIF,ONLINESINAV
			FROM Sinav where ID_SINAV=@ID_SINAV

			SET @ID_SINAV_NEW=(SELECT TOP 1 ID_SINAV FROM @ID_SINAVLIST)

			-- SINAVDERS INSERT
			INSERT INTO SinavDers (ID_SINAV,BOLUMNO,ID_DERS,TAKMAAD)
			SELECT @ID_SINAV_NEW,BOLUMNO,ID_DERS,TAKMAAD FROM SinavDers WHERE ID_SINAV=@ID_SINAV
			
			SELECT S.ID_SINAVDERS ESKIID,SD.ID_SINAVDERS YENIID 
			INTO #SINAVDERS
			FROM SinavDers	S
			JOIN SinavDers	SD	ON	SD.TAKMAAD	= S.TAKMAAD
								AND SD.ID_SINAV	= @ID_SINAV_NEW
			WHERE S.ID_SINAV	=	@ID_SINAV 

			-- KATSAYI INSERT
			INSERT INTO SinavKatsayi (ID_SINAV,ID_SINAVPUANTURU,ID_SINAVDERS,KATSAYI)
			SELECT @ID_SINAV_NEW,ID_SINAVPUANTURU,SD.YENIID,KATSAYI 
			FROM SinavKatsayi SK
			JOIN #SINAVDERS			SD	ON	SD.ESKIID=SK.ID_SINAVDERS
			WHERE ID_SINAV=@ID_SINAV

			-- SINAVNETKRITER INSERT
			DECLARE @ID_SINAVNETKRITERTABLE TABLE (ID_SINAVNETKRITER INT, ESKIID INT)

			MERGE INTO SinavNetKriter 
			USING 
			(
				SELECT DISTINCT SK.ID_SINAVNETKRITER, SK.ID_SINAVPUANTURU, SK.NET
				FROM SinavNetKriter SK
				JOIN SinavNetKriterDers SKD ON SKD.ID_SINAVNETKRITER = SK.ID_SINAVNETKRITER
				JOIN #SINAVDERS			SD	ON SD.ESKIID = SKD.ID_SINAVDERS
			)
			AS TEMP ON 1 = 0
			WHEN NOT MATCHED THEN
			INSERT ([NET] ,[ID_SINAVPUANTURU])
			VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
			OUTPUT TEMP.ID_SINAVNETKRITER AS ESKIID, inserted.ID_SINAVNETKRITER
			INTO @ID_SINAVNETKRITERTABLE (ESKIID, ID_SINAVNETKRITER);

			INSERT INTO SinavNetKriterDers (ID_SINAVDERS, ID_SINAVNETKRITER)
			SELECT SD.YENIID, T.ID_SINAVNETKRITER
			FROM @ID_SINAVNETKRITERTABLE T
			JOIN SinavNetKriterDers ESKD	ON ESKD.ID_SINAVNETKRITER = T.ESKIID
			JOIN #SINAVDERS			SD		ON SD.ESKIID = ESKD.ID_SINAVDERS

			--SINAVKITAPCIK INSERT
			INSERT INTO SinavKitapcik (ID_SINAV,AD)
			SELECT @ID_SINAV_NEW,AD FROM SinavKitapcik WHERE ID_SINAV=@ID_SINAV

			-- SINAVANAHTAR INSERT
			INSERT INTO SinavAnahtar (ID_SINAVKITAPCIK,ID_SINAVDERS,ID_SINAVSORUTURU,SORUNO_A,CEVAP,OPTIKKARAKTERSAYISI,KOD,KATSAYI,SORUNO,ID_BILGI,ID_BILISSELSUREC,ID_SORUBANKASI)
			SELECT SKK.ID_SINAVKITAPCIK,SD.YENIID,ID_SINAVSORUTURU,SORUNO_A,CEVAP,OPTIKKARAKTERSAYISI,KOD,KATSAYI,SORUNO,ID_BILGI,ID_BILISSELSUREC,ID_SORUBANKASI
			FROM SinavAnahtar	SA
			JOIN #SINAVDERS		SD	ON	SD.ESKIID=SA.ID_SINAVDERS
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK=SA.ID_SINAVKITAPCIK
			JOIN SinavKitapcik	SKK	ON	SKK.AD=SK.AD
									AND SKK.ID_SINAV=@ID_SINAV_NEW
			where SA.ID_SINAVDERS in (SELECT ID_SINAVDERS FROM SinavDers where ID_SINAV=@ID_SINAV )

			-- SONAVOPTIK INSERT
			INSERT INTO SinavOptikSabit (ID_SINAV,ID_SINAVOPTIK,BASLANGIC,OPTIKKARAKTERSAYISI)
			SELECT @ID_SINAV_NEW,ID_SINAVOPTIK,BASLANGIC,OPTIKKARAKTERSAYISI FROM SinavOptikSabit WHERE ID_SINAV=@ID_SINAV

			-- SINAVOPTIKDERS INSERT
			INSERT INTO SinavOptikDers (ID_SINAVDERS,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM)
			SELECT SD.YENIID,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM
			FROM SinavOptikDers		SOD
			JOIN #SINAVDERS			SD	ON	SD.ESKIID=SOD.ID_SINAVDERS
			
			--SINAVTABANPUAN INSERT
			INSERT INTO SinavTabanPuan (ID_SINAV,ID_SINAVPUANTURU,TABANPUAN)
			SELECT @ID_SINAV_NEW,ID_SINAVPUANTURU,TABANPUAN FROM SinavTabanPuan WHERE ID_SINAV=@ID_SINAV
						
			DROP TABLE IF EXISTS #SINAVDERS

			SELECT @ID_SINAV_NEW

		END
		IF @ISLEM = 4 -- SINAV BILGILERINI GETIR		
		BEGIN 
			SELECT ID_SINAV,AD,KOD,ID_KADEME3,ID_SINAVTURU FROM Sinav WHERE ID_SINAV=@ID_SINAV
		END
		IF @ISLEM = 5 -- SORU ISLEM BİLGİLERİ LISTELE	
		BEGIN 
			
			select(
				select * from(
					select 
					(
						SELECT ID_SORUISLEM,ACIKLAMA FROM SoruIslem
						FOR JSON AUTO
					) as t1		
				) as tablo FOR JSON AUTO
			) as tt
		END
		IF @ISLEM = 6 -- SINAV SORU ISLEM				
		BEGIN 
			UPDATE	Sinav
			SET		DURUM=0
			WHERE	ID_SINAV=(
					SELECT DISTINCT ID_SINAV 
					FROM	SinavAnahtar	SA	
					JOIN	SinavDers		SD	ON	SD.ID_SINAVDERS= SA.ID_SINAVDERS
					WHERE	SA.ID_SINAVDERS=@ID_SINAVDERS
				)


			IF @ID_SORUISLEM=3
			BEGIN
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) (				 
					--SELECT
					--	(SELECT	TOP 1 ID_SINAVANAHTAR
					--	FROM	SinavAnahtar	SA	
					--	JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
					--								--AND SK.AD				= 'A'
					--	WHERE	SA.ID_SINAVDERS	=	@ID_SINAVDERS
					--		AND SA.SORUNO_A		=	@SORUNO)
					--	,@ID_SORUISLEM
					--	,VALUE 
					--FROM OPENJSON(@OGRENCICEVAP)

					SELECT SA.ID_SINAVANAHTAR						
						,@ID_SORUISLEM
						,VALUE 
					FROM OPENJSON(@OGRENCICEVAP)
					JOIN SinavAnahtar		SA	ON	1	= 1
					JOIN SinavKitapcik		SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
					WHERE	SA.ID_SINAVDERS	=	@ID_SINAVDERS
						AND SA.SORUNO_A		=	@SORUNO
						
				)	
			END		
			ELSE
			BEGIN
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) (
						SELECT  ID_SINAVANAHTAR,@ID_SORUISLEM,NULL
						FROM	SinavAnahtar	SA	
						JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
													--AND SK.AD				= 'A'
						WHERE	SA.ID_SINAVDERS	=	@ID_SINAVDERS
							AND SA.SORUNO_A		=	@SORUNO
				)	
			END
		END
		IF @ISLEM = 7 -- SORU ISLEM LISTELE				
		BEGIN 
			
			select(
				select * from(
					select 
					(
					SELECT * FROM (
						SELECT  DISTINCT SSI.ID_SINAVANAHTAR,SK.ID_SINAV,SORUNO,SI.ACIKLAMA ISLEM,TAKMAAD--,*
						FROM	SinavAnahtar	SA	
						JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
						JOIN	SinavDers		SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
						JOIN	SinavSoruIslem	SSI	ON	SSI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						JOIN	SoruIslem		SI	ON	SI.ID_SORUISLEM		= SSI.ID_SORUISLEM	
						WHERE	SK.ID_SINAV	=	@ID_SINAV
							AND SK.AD='A') AS TABLO
						FOR JSON AUTO
					) as t1		
				) as tablo FOR JSON AUTO
			) as tt
		END
		IF @ISLEM = 8 -- SORU ISLEM SİL					
		BEGIN 			
			
			DELETE FROM SinavSoruIslem 
			WHERE ID_SINAVANAHTAR IN (
				SELECT ASA.ID_SINAVANAHTAR 
				FROM SinavAnahtar	SA 
				JOIN SinavAnahtar	ASA	ON	ASA.ID_SINAVDERS=SA.ID_SINAVDERS
										AND ASA.SORUNO_A=SA.SORUNO_A
			WHERE SA.ID_SINAVANAHTAR=@ID_SINAVANAHTAR)

			select(
				select * from(
					select 
					(
					SELECT * FROM (
						SELECT  DISTINCT SSI.ID_SINAVANAHTAR,SK.ID_SINAV,SORUNO,TAKMAAD
						,case 
							when SI.ID_SORUISLEM=3
								then 'Bu soru bütün sınavda '+
								substring(
								(SELECT distinct ',' + QUOTENAME(c.OGRENCICEVAP) 
																FROM SinavSoruIslem c
																where ID_SINAVANAHTAR=SSI.ID_SINAVANAHTAR and ID_SORUISLEM=3
																FOR XML PATH(''))
															,2,1000)
								+' şıkları seçenler için DOĞRU olsun.'
							else SI.ACIKLAMA
							end ISLEM
						FROM	SinavAnahtar	SA	
						JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
						JOIN	SinavDers		SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
						JOIN	SinavSoruIslem	SSI	ON	SSI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						JOIN	SoruIslem		SI	ON	SI.ID_SORUISLEM		= SSI.ID_SORUISLEM	
						WHERE	SK.ID_SINAV	=	@ID_SINAV
							AND SK.AD='A') AS TABLO
						FOR JSON AUTO
					) as t1		
				) as tablo FOR JSON AUTO
			) as tt

		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO
	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavSonuclari]    Script Date: 23.11.2021 15:32:05 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavSonuclari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT			    = NULL,
	@ID_SUBES			NVARCHAR(MAX)   = NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SINIFS			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL	,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	 

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

	IF @ID_LOG<1
	BEGIN
		IF EXISTS(SELECT TOP 1 1 FROM DisOgrenci WHERE TCKIMLIKNO=@TC_OGRENCI)
			BEGIN
				SET @ID_LOG=2
			END
	END
	IF @ID_LOG > 1
	BEGIN
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
						
		IF (@ISLEM = 1 OR @ISLEM = 2)	--	SINAV SONUÇLARI
		BEGIN
						
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5

			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #KONU
			
			DECLARE @GENEL INT = 999

			SELECT @ID_SINIF=ID_SINIF,@ID_SUBE=ID_SUBE FROM v3Ogrenci WHERE TCKIMLIKNO =@TC_OGRENCI		
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TC_OGRENCI)
			BEGIN
				SELECT  distinct 
					 SOT.TCKIMLIKNO
					,DO.AD+' '+DO.SOYAD ADSOYAD
					,K.AD AS SINIF
					--,SS.SUBEAD
					,'' AS SUBEAD
					,S.AD SINAVAD
					,CONVERT(VARCHAR, S.SINAVTARIH ,105) SINAVTARIH
					,(SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR)	FROM SinavOgrenci K WITH(NOLOCK) WHERE K.TCKIMLIKNO = SOT.TCKIMLIKNO and k.ID_SINAV = s.ID_SINAV FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
					,OP.PUAN
					,PT.KOD PUANTURU
					--,UPPER(ST.KISAAD+' SINAV SONUÇ BELGESİ') AS SINAVTURU
					,UPPER(S.RAPORBASLIK) AS SINAVTURU
					--,UPPER(ST.AD) AS SINAVTURUUZUN
					,'Testlerdeki Doğru ve Yanlış Sayıları' AS SINAVTURUUZUN
					,ST.ID_SINAVTURU
					,VD.ACIKLAMA DONEM
					,OP.SINIFSIRA,OP.OKULSIRA,OP.ILCESIRA,OP.ILSIRA,OP.GENELSIRA
					,S.PUANGIZLE
					,SINIFKATILIM	= SOT.KATILIM_SINIF
					,SUBEKATILIM	= SOT.KATILIM_OKUL
					,ILCEKATILIM	= SOT.KATILIM_ILCE
					,ILKATILIM		= SOT.KATILIM_IL
					,GENELKATILIM	= SOT.KATILIM_GENEL
					,ISNULL(PT.ID_SINAVPUANTURU,0) ID_SINAVPUANTURU
					,ID_KADEME = 0
					,S.SIRALAMAYIGIZLE

				INTO #T11
				FROM SinavOgrenciToplam			SOT WITH(NOLOCK)
				LEFT JOIN vw_SinavOgrenciPuan	OP  WITH(NOLOCK)	ON	OP.TCKIMLIKNO		= SOT.TCKIMLIKNO AND OP.ID_SINAV = SOT.ID_SINAV
				LEFT JOIN SinavPuanTuru			PT  WITH(NOLOCK)	ON	PT.ID_SINAVPUANTURU	= OP.ID_SINAVPUANTURU
				JOIN Sinav						S   WITH(NOLOCK)	ON	S.ID_SINAV			= SOT.ID_SINAV
				JOIN SinavTuru					ST  WITH(NOLOCK)	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN DisOgrenci					DO  WITH(NOLOCK)	ON	DO.TCKIMLIKNO		= SOT.TCKIMLIKNO
				--JOIN vw_SubeSinifGrupKademeTum	SS  WITH(NOLOCK)	ON	SS.ID_KADEME3		= DO.ID_KADEME3
				JOIN v3Kademe3					K	WITH(NOLOCK)	ON	K.ID_KADEME3		= DO.ID_KADEME3
				JOIN v3AktifDonem				VD  WITH(NOLOCK)	ON  VD.DONEM			= S.DONEM
				WHERE	SOT.TCKIMLIKNO	= @TC_OGRENCI
					AND	SOT.ID_SINAV	= @ID_SINAV
			END
			ELSE
			BEGIN
				SELECT  distinct 
				 SOT.TCKIMLIKNO
				,VK.AD+' '+VK.SOYAD ADSOYAD
				,SINIF
				,SS.SUBEAD
				,S.AD SINAVAD
				,CONVERT(VARCHAR, S.SINAVTARIH ,105) SINAVTARIH
				,(SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR)	FROM SinavOgrenci K WITH(NOLOCK) WHERE K.TCKIMLIKNO = SOT.TCKIMLIKNO and k.ID_SINAV = s.ID_SINAV FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
				,OP.PUAN
				,PT.KOD PUANTURU
				--,UPPER(ST.KISAAD+' SINAV SONUÇ BELGESİ') AS SINAVTURU
				,UPPER(S.RAPORBASLIK) AS SINAVTURU
				--,UPPER(ST.AD) AS SINAVTURUUZUN
				,'Testlerdeki Doğru ve Yanlış Sayıları' AS SINAVTURUUZUN
				,ST.ID_SINAVTURU
				,VD.ACIKLAMA DONEM
				,OP.SINIFSIRA,OP.OKULSIRA,OP.ILCESIRA,OP.ILSIRA,OP.GENELSIRA
				,S.PUANGIZLE
				,SINIFKATILIM	= SOT.KATILIM_SINIF
				,SUBEKATILIM	= SOT.KATILIM_OKUL
				,ILCEKATILIM	= SOT.KATILIM_ILCE
				,ILKATILIM		= SOT.KATILIM_IL
				,GENELKATILIM	= SOT.KATILIM_GENEL
				,ISNULL(PT.ID_SINAVPUANTURU,0) ID_SINAVPUANTURU
				,ID_KADEME = SS.ID_KADEME
				,S.SIRALAMAYIGIZLE

			INTO #T1
			FROM SinavOgrenciToplam			SOT WITH(NOLOCK)
			LEFT JOIN vw_SinavOgrenciPuan	OP  WITH(NOLOCK)	ON	OP.TCKIMLIKNO		= SOT.TCKIMLIKNO AND OP.ID_SINAV = SOT.ID_SINAV
			LEFT JOIN SinavPuanTuru			PT  WITH(NOLOCK)	ON	PT.ID_SINAVPUANTURU	= OP.ID_SINAVPUANTURU
			JOIN Sinav						S   WITH(NOLOCK)	ON	S.ID_SINAV			= SOT.ID_SINAV
			JOIN SinavTuru					ST  WITH(NOLOCK)	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN v3Kullanici				VK  WITH(NOLOCK)	ON	VK.TCKIMLIKNO		= SOT.TCKIMLIKNO
			JOIN V3Ogrenci					VO  WITH(NOLOCK)	ON	VO.TCKIMLIKNO		= SOT.TCKIMLIKNO
			JOIN vw_SubeSinifGrupKademeTum	SS  WITH(NOLOCK)	ON	SS.ID_SINIF			= VO.ID_SINIF
			JOIN v3AktifDonem				VD  WITH(NOLOCK)	ON  VD.DONEM			= S.DONEM
			WHERE	SOT.TCKIMLIKNO	= @TC_OGRENCI
				AND	SOT.ID_SINAV	= @ID_SINAV
			END
			SELECT 
				 DERSAD					= SD.TAKMAAD
				,TOPLAMSORU				= (SELECT SUM(DOGRU+YANLIS+BOS) FROM vw_SinavOgrenciBolum SB WITH(NOLOCK) WHERE SB.TCKIMLIKNO = B.TCKIMLIKNO	AND SB.ID_SINAVDERS = B.ID_SINAVDERS )
				,DOGRU					= B.DOGRU
				,YANLIS					= B.YANLIS
				,BOS					= B.BOS
				,NET					= B.NET
				,PUAN					= B.PUAN
				,OLCEKSINAVI			= S.OLCEKSINAVI
				,TCKIMLIKNO				= B.TCKIMLIKNO
				,BOLUMNO				= SD.BOLUMNO
				,YUZDENET				= B.YUZDENET
			
				,SINIFNETORTALAMA		= B.NET_SINIFORT
				,SINIFDOGRUORTALAMA		= B.DOGRU_SINIFORT 
				,SINIFYUZDENETORTALAMA	= B.YUZDENET_SINIFORT

				,SUBENETORTALAMA		= B.NET_OKULORT

				,GENELDOGRUORTALAMA		= B.DOGRU_GENELORT
				,GENELNETORTALAMA		= B.NET_GENELORT
				,GENELYUZDENETORTALAMA	= B.YUZDENET_GENELORT
				,YUZDEBASARI			= YUZDENET 
				
				,SINIFSIRA				= B.NET_SINIFSIRA
				,OKULSIRA				= B.NET_OKULSIRA
				,ILCESIRA				= B.NET_ILCESIRA
				,ILSIRA					= B.NET_ILSIRA
				,GENELSIRA				= B.NET_GENELSIRA
			
				,B.ID_SINAV
			INTO #T2 
			FROM vw_SinavOgrenciBolum	B  WITH(NOLOCK)
			JOIN SinavOgrenciToplam		T  WITH(NOLOCK)	ON	T.TCKIMLIKNO		= B.TCKIMLIKNO 
														AND T.ID_SINAV			= B.ID_SINAV
			JOIN Sinav					S  WITH(NOLOCK)	ON	S.ID_SINAV			= B.ID_SINAV
			JOIN SinavDers				SD WITH(NOLOCK)	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN v3SinavDers			D  WITH(NOLOCK)	ON	D.ID_DERS			= SD.ID_DERS		
			WHERE	B.ID_SINAV	= @ID_SINAV
				AND B.TCKIMLIKNO= @TC_OGRENCI
	
			INSERT INTO #T2 				
				SELECT 
				 'TOPLAM'					
				,sum(TOPLAMSORU)
				,ST.TD
				,ST.TY
				,ST.TB
				,ST.TN 
				,0 PUAN					
				,T.OLCEKSINAVI			
				,T.TCKIMLIKNO				
				,@GENEL BOLUMNO				
				,cast((TN/(TD+TY+TB)*100.0) as decimal(8,2))		
				
				,cast(avg(SINIFNETORTALAMA		 ) as decimal(8,2))	
				,cast(avg(SINIFDOGRUORTALAMA	) as decimal(8,2))	
				,cast(avg(SINIFYUZDENETORTALAMA	) as decimal(8,2))				
				,cast(avg(SUBENETORTALAMA		) as decimal(8,2))				
				,cast(avg(GENELDOGRUORTALAMA	) as decimal(8,2))	
				,cast(avg(GENELNETORTALAMA		 ) as decimal(8,2))	
				,cast(avg(GENELYUZDENETORTALAMA	 ) as decimal(8,2))	
				,cast((TN/(TD+TY+TB)*100.0) as decimal(8,2))	
				
				,ST.TN_SINIFSIRA				
				,ST.TN_OKULSIRA				
				,ST.TN_ILCESIRA				
				,ST.TN_ILSIRA					
				,ST.TN_GENELSIRA				
				,ST.ID_SINAV

				FROM #T2 T
				JOIN SinavOgrenciToplam	ST	ON	ST.ID_SINAV		= T.ID_SINAV
											AND ST.TCKIMLIKNO	= T.TCKIMLIKNO
				JOIN Sinav				S	ON	S.ID_SINAV		= T.ID_SINAV
				--JOIN v3KademeBilgi		KB	ON	KB.ID_KADEME3	= S.ID_KADEME3
				WHERE (SELECT TOP 1 ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = S.ID_KADEME3) = 4
				GROUP BY ST.TD
				,ST.TY
				,ST.TB
				,ST.TN 				
				,T.OLCEKSINAVI			
				,T.TCKIMLIKNO	
				,ST.TN_SINIFSIRA				
				,ST.TN_OKULSIRA				
				,ST.TN_ILCESIRA				
				,ST.TN_ILSIRA					
				,ST.TN_GENELSIRA
				,ST.ID_SINAV

			SELECT 
				 OS.SORUNO
				,OS.CEVAP OGRENCICEVAP
				,OS.DOGRUCEVAP
				,OS.DURUM
				,OS.ID_SINAVDERS
				,SD.TAKMAAD DERSAD
				,SD.BOLUMNO
			INTO #T3
			FROM vw_SinavOgrenciSoru	OS WITH(NOLOCK)
			JOIN SinavDers				SD WITH(NOLOCK)	ON	SD.ID_SINAVDERS	= OS.ID_SINAVDERS		
			WHERE	OS.TCKIMLIKNO	= @TC_OGRENCI
				AND OS.ID_SINAV		= @ID_SINAV
			ORDER BY SD.BOLUMNO,ID_SINAVDERS,SORUNO

			SELECT   
				DERSAD
				,BOLUMNO
				,OGRENCI	= YUZDENET 
				,SINIF		= SINIFYUZDENETORTALAMA
				,GENEL		= GENELYUZDENETORTALAMA
			INTO #T4
			FROM #T2	B
			WHERE BOLUMNO != @GENEL
			ORDER BY BOLUMNO
		
			SELECT	
					count(1) SORUSAYISI,
					SOS.DURUM,
					D.BOLUMNO,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(SB.YUZDEDOGRU) YUZDE,
					SOS.ID_SINAV
					,(SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR)	FROM SinavOgrenci K WITH(NOLOCK) WHERE K.TCKIMLIKNO = @TC_OGRENCI and k.ID_SINAV = SOS.ID_SINAV FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
			into #KONU
			from vw_SinavOgrenciSoru	SOS WITH(NOLOCK) 
			JOIN vw_SinavOgrenciBolum	SB  WITH(NOLOCK)	ON	SB.ID_SINAVDERS = SOS.ID_SINAVDERS AND SB.TCKIMLIKNO	= SOS.TCKIMLIKNO
			JOIN SinavDers				D   WITH(NOLOCK)	ON	D.ID_SINAVDERS	= SOS.ID_SINAVDERS AND D.ID_SINAV		= SOS.ID_SINAV
			JOIN v3SinavDersUnite		U	WITH(NOLOCK)	ON  U.KOD			= SOS.KOD
			WHERE  SOS.TCKIMLIKNO=@TC_OGRENCI AND SOS.ID_SINAV=@ID_SINAV
			GROUP BY SOS.DURUM,d.TAKMAAD,u.kod,u.AD,D.ID_SINAVDERS,SOS.ID_SINAV,D.BOLUMNO
			ORDER BY d.TAKMAAD

			SELECT DISTINCT
					KONUAD,
					DERSAD,
					BOLUMNO,
					KOD,						
					YUZDE AS BOLUMYUZDE
					,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
					ISNULL( 
								CAST((((	100 	/ NULLIF( 	
									CAST((		 
										CAST(ISNULL([D],0) AS INT)
										+CAST(ISNULL([Y],0) AS INT)
										+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) ) 
											,0)
									))
									* CAST([D] AS INT)  
								) AS DECIMAL(11,2)) 
						,0) AS YUZDE
						,KITAPCIK
			INTO #TT
			FROM ( SELECT * FROM #KONU  )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
			order by ID_SINAV,DERSAD,KOD

			SELECT	
				KONUAD,
				BOLUMNO,
				DERSAD,
				KOD,
				CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
				SUM(DOGRU+YANLIS+BOS) SORU,
				SUM(DOGRU) DOGRU,
				SUM(YANLIS) YANLIS,
				SUM(BOS) BOS,
				CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
				KITAPCIK
			INTO	#T5
			FROM	#TT
			GROUP BY KOD,KONUAD,DERSAD,BOLUMNO,KITAPCIK
		union 
			SELECT  DERSAD,
					BOLUMNO,
					DERSAD,
					'',
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE ,
					KITAPCIK
			FROM	#TT
			GROUP BY DERSAD,BOLUMNO,KITAPCIK
			order by BOLUMNO,kod


			IF @ISLEM = 1	--JSON SEND
			BEGIN
				select(
					select * from(
						select 
						(						 
							SELECT * FROM #T1
							ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t1
						,( 
							SELECT * FROM #T2
							ORDER BY BOLUMNO
							FOR JSON AUTO
						)as t2
						,(
							SELECT * 				
								,MAXSORU=(SELECT MAX (SORUNO) FROM #T3)
								,DERSSAYISI=(SELECT COUNT (DISTINCT BOLUMNO) FROM #T3) 
							FROM #T3
							ORDER BY BOLUMNO,ID_SINAVDERS,SORUNO
							FOR JSON AUTO
						) as t3 
						,( 
								
							SELECT * FROM #T4
							ORDER BY BOLUMNO					
							FOR JSON AUTO
						)as t4
						,(
							SELECT * FROM #T5
							ORDER BY BOLUMNO,DERSAD,KOD
							FOR JSON AUTO
						) as t5 
					) as tablo FOR JSON AUTO
				) as tt
			END
			IF @ISLEM = 2	--DATASET SEND
			BEGIN
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TC_OGRENCI)
			BEGIN
				SELECT * FROM #T11
				ORDER BY ID_SINAVPUANTURU
			END
			ELSE
			BEGIN
			SELECT * FROM #T1
				ORDER BY ID_SINAVPUANTURU
			END
				SELECT * FROM #T2
				ORDER BY BOLUMNO

				SELECT * 				
					,MAXSORU=(SELECT MAX (SORUNO) FROM #T3)
					,DERSSAYISI=(SELECT COUNT (DISTINCT BOLUMNO) FROM #T3) 
				FROM #T3
				ORDER BY BOLUMNO,ID_SINAVDERS,SORUNO
								
				SELECT * FROM #T4
				ORDER BY BOLUMNO
								
				SELECT * FROM #T5
				ORDER BY BOLUMNO,DERSAD,KOD


			END

			
			 
			
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5

			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #KONU
		END

		IF @ISLEM = 3   --ONLİNE TEST RAPOR
		BEGIN
			SELECT ISNULL((
						SELECT DISTINCT
						TCKIMLIKNO  = O.TCKIMLIKNO
						,AD			=K.AD 
						,SOYAD		=K.SOYAD
						,DOGRU		= OTOS.TD
						,YANLIS		= OTOS.TY
						,BOS		= OTOS.TB
						FROM Sinav						S
						JOIN OnlineTestOgrenciSonuc		OTOS ON  OTOS.ID_SINAV	 = S.ID_SINAV
						JOIN v3Ogrenci					O	 ON O.TCKIMLIKNO = OTOS.TCKIMLIKNO
						JOIN v3Kullanici				K	 ON  K.TCKIMLIKNO    = O.TCKIMLIKNO	
						WHERE S.ID_SINAV = @ID_SINAV AND S.DONEM = @DONEM  AND O.ID_SUBE = @ID_SUBE-- AND O.ID_SINIF =@ID_SINIF
				FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 4 -- ONLİNE TEST SINAV LİSTELE
			BEGIN
				SELECT ISNULL((
					SELECT 
					S.AD
					,S.ID_SINAV
					FROM Sinav				S
					WHERE S.ID_SINAVTURU  = 15 AND ID_KADEME3 = @ID_KADEME3
				FOR JSON PATH
				),'[]')
			END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END


	GO


	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Sinif]    Script Date: 23.11.2021 15:32:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Sinif]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@KADEME				VARCHAR(1)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@KUR				BIT				= NULL,
	@ESKIDONEMSINIF		BIT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SUBES			VARCHAR(MAX)	= NULL,
	@ID_KADEME3S		VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUP		INT				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,KADEME						= @KADEME			
			,DONEM						= @DONEM			
			,KUR						= @KUR			
			,ESKIDONEMSINIF				= @ESKIDONEMSINIF	
			,ID_SUBE					= @ID_SUBE		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SUBES					= @ID_SUBES		
			,ID_KADEME3S				= @ID_KADEME3S	
			,ID_SINAVGRUP				= @ID_SINAVGRUP	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	--exec sp_Sinif @TCKIMLIKNO= '56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@KADEME=2,@ID_SUBES='652,385,',@ID_SINAVGRUP=3,@ISLEM= 2,@ID_MENU=21

	IF @ID_LOG > 1
	BEGIN
		SELECT VALUE AS ID_KULLANICITIPI INTO #TEMPTIPLER FROM OPENJSON('[26,27,53,54,59,60,61,84,85,91]')

		DECLARE @AKTIFDONEM VARCHAR(4)=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		SELECT ID_KADEME 
		INTO #KADEMELER 
		FROM v3KullaniciKademe 
		WHERE TCKIMLIKNO=@TCKIMLIKNO

		SELECT ID_KULLANICITIPI 
		INTO #KULLANICITIPLER 
		FROM		OkyanusDB.[dbo].[v3Kullanici]	K
		INNER JOIN	OkyanusDB.[dbo].[v3SubeYetki]	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO
		WHERE K.TCKIMLIKNO=@TCKIMLIKNO


		IF @ISLEM = 1	--	Sınıf Listele
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD 
			FROM	   [dbo].[vw_SubeGrupSinif]		sgs
			INNER JOIN [dbo].[v3Sinif]				s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3AktifDonem]			ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(sgs.ID_SUBE=@ID_SUBE)  AND
				(sgs.ID_KADEME3=@ID_SINAVGRUP)  AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@KADEME) 
			ORDER BY AD
		END
		
		IF @ISLEM = 2	--	Sınıf Listele Multi Sube
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SUBEAD +' / '+ sgs.SINIF as AD ,st.ID_KADEME
			FROM	   [dbo].[vw_SubeGrupSinif]		sgs
			INNER JOIN [dbo].[v3Sinif]				s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3AktifDonem]			ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU		
			where 
					(sgs.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 
				AND
					(sgs.ID_KADEME3=@ID_KADEME3 or @ID_KADEME3=0 or @ID_KADEME3 is null)  
				AND 
					(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@KADEME) 
			ORDER BY AD
		END

		--SELECT * FROM [dbo].[vw_SubeGrupSinif]
		IF @ISLEM = 3	--	Sınıf Listele BY Kullanici
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
				FROM	vw_SubeGrupSinif	S
				JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
				WHERE	(@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
					AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 	
					AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
					AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
					AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
				ORDER BY S.SUBEAD,S.SINIF
			END
			ELSE
			BEGIN 
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI)
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					WHERE	
						(@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR S.ID_KADEME3=@ID_KADEME3) 	
					ORDER BY S.SUBEAD,S.SINIF
				END
				ELSE
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 				
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
					ORDER BY S.SUBEAD,S.SINIF
				END			
			END
		END

		IF @ISLEM = 4	--	Sınıf Listele BY Kullanici Multi Sube
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN

				IF @KUR = 1
				BEGIN
					SELECT DISTINCT	s.ID_SINIF,S.AD, SB.AD SUBEAD
					FROM OkyanusDB.dbo.v4Sinif	S
					JOIN OkyanusDB.dbo.V3SUBE	SB	ON	SB.ID_SUBE	= S.ID_SUBE
					WHERE	(S.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 	
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR S.ID_KADEME3=@ID_KADEME3) 	
					ORDER BY SUBEAD, S.AD
				END
				ELSE
				BEGIN
					SELECT DISTINCT	s.ID_SINIF,S.SINIF AD, S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
					WHERE	(S.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR kS.ID_KADEME3=@ID_KADEME3) 	
					ORDER BY S.SUBEAD, S.SINIF
				END
			END
			ELSE
			BEGIN 
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI)
				BEGIN
				
						IF @KUR = 1
						BEGIN
							SELECT DISTINCT	s.ID_SINIF,S.AD, SB.AD SUBEAD
							FROM OkyanusDB.dbo.v4Sinif	S
							JOIN OkyanusDB.dbo.V3SUBE	SB	ON	SB.ID_SUBE	= S.ID_SUBE
							WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE=@ID_SUBE) 
								AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR S.ID_KADEME3=@ID_KADEME3) 	
								AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES	) ))
								AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
							ORDER BY SUBEAD, S.AD
						END
						ELSE
						BEGIN
							SELECT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
							FROM	vw_SubeGrupSinif	S
							WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE=@ID_SUBE) 
								AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR S.ID_KADEME3=@ID_KADEME3) 	
								AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES	) ))
								AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
						END

				END
				ELSE
				BEGIN
					SELECT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 				
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
				END			
						
			END
		END

		IF @ISLEM = 5 -- SINIF LİSTELE TÜMÜ
		BEGIN
			SELECT SN.ID_SINIF,SN.AD
			FROM v3Sinif						SN
			JOIN OkyanusDB.DBO.v3SubeGrupSinif	G	ON	G.ID_SINIF= SN.ID_SINIF
			WHERE	ID_KADEME3  = @ID_KADEME3
				AND ID_SUBE		= @ID_SUBE

		END

		IF @ISLEM = 6 -- ÖĞRETMENİN REHBERLİK DIŞINDA GİRDİĞİ SINIF LİSTESİ
		BEGIN
			
			IF @TC_OGRETMEN IS NULL OR @TC_OGRETMEN = ''
				SET @TC_OGRETMEN = @TCKIMLIKNO

			SELECT (
				SELECT (
					SELECT DISTINCT
						S.ID_SINIF,
						SB.ID_SUBE,
						SB.AD SUBEAD,
						S.AD SINIFAD,
						SINIF = S.AD + ' (' + UPPER(SB.AD) +')',
						GS.ID_KADEME3
					FROM eokul_v2.dbo.DersOgretmen		DP
					JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS = DP.ID_DERS
					JOIN OkyanusDB.dbo.v3Sinif			S	ON	S.ID_SINIF = DP.ID_SINIF
					JOIN OkyanusDB.dbo.v3SubeGrupSinif	GS	ON	GS.ID_SINIF = S.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sube			SB	ON	SB.ID_SUBE = GS.ID_SUBE
					JOIN OkyanusDB.dbo.v3Donem			DO	ON	DO.ID_DONEM=S.ID_DONEM
					JOIN OkyanusDB.dbo.v3AktifDonem		AD	ON	AD.DONEM = DO.KOD  
					WHERE	DP.TC_OGRETMEN = @TC_OGRETMEN
						--AND D.AD		<> 'Rehberlik'
						AND AD.AKTIF	= 1
						AND DP.ID_EGITIMTURU= 6 -- YAZILI
					ORDER BY SUBEAD,SINIFAD
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END

		IF @ISLEM = 7 -- ÖĞRETMENİN DANIŞMAN OLDUĞU SINIF LİSTESİ
		BEGIN	
			IF @TC_OGRETMEN IS NULL OR @TC_OGRETMEN = ''
				SET @TC_OGRETMEN = @TCKIMLIKNO

			SELECT (
				SELECT (
					SELECT	S.ID_SINIF
							,SB.ID_SUBE
							,SB.AD AS SUBEAD
							,S.AD AS SINIFAD
							,S.AD + ' (' + UPPER(SB.AD) +')' AS SINIF
							,GS.ID_KADEME3
					  FROM OkyanusDB.dbo.v3SinifPersonel SD
					  INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = SD.ID_SINIF
					  INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif GS ON GS.ID_SINIF = S.ID_SINIF
					  INNER JOIN OkyanusDB.dbo.v3Sube SB ON	SB.ID_SUBE = GS.ID_SUBE
					  WHERE SD.TCKIMLIKNO = @TC_OGRETMEN AND SD.ID_KULLANICITIPI = 100
					ORDER BY SUBEAD,SINIFAD
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END
				
		IF @ISLEM = 8	--	Sınıf Listele BY Kullanici Multi Sube (ESKIDONEM)
		BEGIN
		
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT DISTINCT	s.ID_SINIF,S.SINIF AD, S.SUBEAD
				FROM	vw_SubeGrupSinifTum	S
				LEFT JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
				JOIN	v3SinifTum			ST	ON	ST.ID_SINIF	= S.ID_SINIF
				JOIN	v3Donem				D	ON	D.ID_DONEM	= ST.ID_DONEM 
				WHERE	(S.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 
					AND (@ID_KADEME3 IS NULL OR S.ID_KADEME3=@ID_KADEME3) 			
					AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
					AND (	((@DONEM	IS NULL OR @DONEM		= '') AND D.KOD = @AKTIFDONEM)
						OR	D.KOD = @DONEM
							)	
				ORDER BY S.SUBEAD, S.SINIF
			END
			ELSE
			BEGIN
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI OR KT.ID_KULLANICITIPI = 1 )
				BEGIN
					SELECT DISTINCT	S.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinifTum	S
					JOIN	v3SinifTum			ST	ON	ST.ID_SINIF	= S.ID_SINIF
					JOIN	v3Donem				D	ON	D.ID_DONEM	= ST.ID_DONEM 
					WHERE	
						(@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	='[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES)		))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	='[]'	OR S.ID_KADEME3	in (select value from openjson (@ID_KADEME3S)	))
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	=0		OR S.ID_KADEME3	=	@ID_KADEME3) 	
						AND (	((@DONEM	IS NULL OR @DONEM		= '') AND D.KOD = @AKTIFDONEM)
							OR	D.KOD = @DONEM
								)
				END
				ELSE
				BEGIN
					SELECT DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinifTum	S
					JOIN	v3SinifTum			ST	ON	S.ID_SINIF	= ST.ID_SINIF
					JOIN	v3Donem				D	ON	D.ID_DONEM	= ST.ID_DONEM 
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 				
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
						AND (	((@DONEM	IS NULL OR @DONEM		= '') AND D.KOD = @AKTIFDONEM)
							OR	D.KOD = @DONEM
								)
				END			
			END	
		END

		IF @ISLEM = 9	--	Sınıf Listele Dönem
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD 
			FROM	   [dbo].[vw_SubeGrupSinifTum]	sgs
			INNER JOIN [dbo].[v3SinifTum]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(sgs.ID_SUBE=@ID_SUBE)  AND
				(sgs.ID_KADEME3=@ID_KADEME3)  AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) AND s.DONEM = @DONEM
			ORDER BY AD
		END

		IF @ISLEM = 10	--	SINIF LİSTELE DÖNEM - MULTİ - GENEL (TKT)
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD, sgs.SUBEAD 
			FROM	   [dbo].[vw_SubeGrupSinifTum]	sgs
			INNER JOIN [dbo].[v3SinifTum]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) AND s.DONEM = @DONEM
				AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson (@ID_SUBES) ))
				AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR sgs.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
			ORDER BY SUBEAD, AD
		END

		IF @ISLEM = 11	--	SINIF ALAN LİSTELE
		BEGIN
			SELECT(
				SELECT ID_SINIFALAN, AD AS ALAN 
				FROM OkyanusDb.dbo.v4SinifAlan
				FOR JSON AUTO 
			)
		END

		

		--SELECT * FROM [dbo].[vw_SubeGrupSinif]
		IF @ISLEM = 12	--	Sınıf+KurSinif Listele BY Kullanici
		BEGIN
		
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD,0 KURSINIFIMI
				FROM	vw_SubeGrupSinif	S
				JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
				WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE		= @ID_SUBE) 
					AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3) 	
					AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
					AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3		in (select value from openjson (@ID_KADEME3S) ))
					AND (KS.ID_KADEME	IN (SELECT ID_KADEME FROM #KADEMELER))
			UNION 
				SELECT DISTINCT KS.ID_SINIF AS ID_KUR, KS.AD AS KURSINIFI,SB.AD,1
				FROM OkyanusDb.dbo.v4Sinif KS
				JOIN v3Sube					SB	ON	SB.ID_SUBE = KS.ID_SUBE
				WHERE	KS.DONEM		= @AKTIFDONEM AND KS.AKTIF = 1						
					AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR KS.ID_SUBE		= @ID_SUBE) 
					AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3)
					AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR KS.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
					AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR KS.ID_KADEME3	in (select value from openjson (@ID_KADEME3S) ))
				ORDER BY S.SUBEAD,S.SINIF
			END
			ELSE
			BEGIN 
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI)
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD,0 KURSINIFIMI
					FROM	vw_SubeGrupSinif	S
					WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		=0		OR S.ID_SUBE	= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	=0		OR S.ID_KADEME3	= @ID_KADEME3) 	
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	='[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES)	  ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	='[]'	OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
				UNION					
					SELECT DISTINCT KS.ID_SINIF AS ID_KUR, KS.AD AS KURSINIFI,SB.AD,1
					FROM OkyanusDb.dbo.v4Sinif KS
					JOIN v3Sube					SB	ON	SB.ID_SUBE = KS.ID_SUBE
					WHERE	KS.DONEM		= @AKTIFDONEM AND KS.AKTIF = 1							
						AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR KS.ID_SUBE		= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3)
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR KS.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR KS.ID_KADEME3	in (select value from openjson (@ID_KADEME3S) ))
					ORDER BY S.SUBEAD,S.SINIF
				END
				ELSE
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD,0 KURSINIFIMI
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE		= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3) 				
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3		in (select value from openjson (@ID_KADEME3S) ))
						AND (KS.ID_KADEME	IN (SELECT ID_KADEME FROM #KADEMELER))
				UNION					
					SELECT DISTINCT KS.ID_SINIF AS ID_KUR, KS.AD AS KURSINIFI,SB.AD,1
					FROM OkyanusDb.dbo.v4Sinif  KS
					JOIN v3Sube					SB	ON	SB.ID_SUBE		= KS.ID_SUBE
					JOIN OkyanusDB.dbo.v4SinifOgretmenDers SOD ON SOD.ID_SINIF = KS.ID_SINIF AND SOD.AKTIF = 1
					WHERE	KS.DONEM		= @AKTIFDONEM AND KS.AKTIF = 1	
						AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR KS.ID_SUBE		= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3)
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR KS.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR KS.ID_KADEME3	in (select value from openjson (@ID_KADEME3S) ))
						AND (SOD.TC_OGRETMEN = @TCKIMLIKNO)
					ORDER BY S.SUBEAD,S.SINIF
				END			
			END
		END		

		IF @ISLEM = 13	--	SINIF LİSTELE DÖNEM - MULTİ ŞUBE - TEK GRUP - GENEL (TKT)
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD, sgs.SUBEAD 
			FROM	   [dbo].[vw_SubeGrupSinifTum]	sgs
			INNER JOIN [dbo].[v3SinifTum]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) AND s.DONEM = @DONEM
				AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson (@ID_SUBES) ))
				AND (sgs.ID_KADEME3 = @ID_KADEME3)
			ORDER BY SUBEAD, AD
		END

		DROP TABLE IF EXISTS #KADEMELER
		DROP TABLE IF EXISTS #KULLANICITIPLER
		DROP TABLE IF EXISTS #TEMPTIPLER	
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifBazindaKazanimAnalizi]    Script Date: 23.11.2021 15:32:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	@return_value = [dbo].[sp_SinifBazindaKazanimAnalizi]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_SinifBazindaKazanimAnalizi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			IF @ISLEM = 1 OR @ISLEM = 2	--	Sınıf Bazında Kazanım Listesi
			BEGIN
				SELECT O.ID_OGRENCI, 
					   OG.OGRNO, 
					   O.ID_SINIF, 
					   SN.AD                            AS SINIF, 
					   ISNULL(K.AD + ' ' + K.SOYAD, '') AS ADSOYAD, 
					   O.SORUNO, 
					   O.PUAN, 
					   S.PUANDEGERI, 
					   ISNULL(S.KAZANIM, '')            AS KONUKODU, 
					   SB.AD                            AS SUBE 
				INTO   #OGRENCINOT 
				FROM   eokul_v2.dbo.OgrenciNot O 
				INNER JOIN eokul_v2.dbo.SinavRaporDetay S ON S.ID_SINAVRAPOR = O.ID_SINAVRAPOR AND S.SORUNO = O.SORUNO 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci OG ON OG.TCKIMLIKNO = O.TC_OGRENCI 
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OG.TCKIMLIKNO 
				INNER JOIN OkyanusDB.dbo.v3Sinif SN ON SN.ID_SINIF = O.ID_SINIF 
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = OG.ID_SUBE 
				WHERE  O.ID_SINAVRAPOR = @ID_SINAV
					   AND O.KATILMADI = 0 
					   AND K.AKTIF = 1 
					   AND ( ( SB.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
					   AND ( ( OG.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' )  
					   AND S.SILINDI = 0 

				IF @ISLEM = 1 -- HTML
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT * 
								FROM   #OGRENCINOT 
								ORDER  BY SUBE,
										  ID_SINIF, 
										  ID_OGRENCI, 
										  SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T1,
							(
								SELECT DISTINCT O.SORUNO, 
												O.PUANDEGERI, 
												O.KONUKODU 
								FROM   #OGRENCINOT O 
								ORDER  BY O.SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T2						
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE IF @ISLEM = 2 -- DEVEXPRESS
				BEGIN
					SELECT * 
					FROM   #OGRENCINOT 
					ORDER  BY SUBE,
							ID_SINIF, 
							ID_OGRENCI, 
							SORUNO 

					SELECT DISTINCT O.SORUNO, 
									O.PUANDEGERI, 
									O.KONUKODU 
					FROM   #OGRENCINOT O 
					ORDER  BY O.SORUNO 
				END

				DROP TABLE #OGRENCINOT
			END 

			IF @ISLEM = 3 OR @ISLEM = 4	--	Sınıf Bazında Kazanım Listesi Yeni
			BEGIN
				SELECT  O.ID_OGRENCI
						,O.OGRNO
						,O.ID_SINIF
						,S.AD AS SINIF
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,YS.SORUNO
						,YOC.PUAN
						,YS.PUAN AS PUANDEGERI
						,U.AD AS KONUKODU
						,SB.AD AS SUBE
				INTO #OGRENCINOTY
				FROM	   Yazili							Y 
				INNER JOIN YaziliSoru						YS	ON YS.ID_YAZILI			= Y.ID_YAZILI
				INNER JOIN YaziliOgrenci					YO	ON YO.ID_YAZILI			= Y.ID_YAZILI			AND YO.AKTIF		  = 1
				INNER JOIN YaziliOgrenciCevap				YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI	AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON O.TCKIMLIKNO			= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube				SB	ON SB.ID_SUBE			= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif			S	ON S.ID_SINIF			= O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici		K	ON K.TCKIMLIKNO			= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	U	ON U.KOD				= YS.KOD
				WHERE  Y.ID_YAZILI = @ID_SINAV
				AND YO.KATILMADI = 0 
				AND Y.AKTIF = 1
				AND ( ( O.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
				AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' )  

				IF @ISLEM = 3 -- HTML
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT * 
								FROM   #OGRENCINOTY 
								ORDER  BY SUBE,
										  ID_SINIF, 
										  ID_OGRENCI, 
										  SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T1,
							(
								SELECT DISTINCT O.SORUNO, 
												O.PUANDEGERI, 
												O.KONUKODU 
								FROM   #OGRENCINOTY O 
								ORDER  BY O.SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T2						
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE IF @ISLEM = 4 -- DEVEXPRESS
				BEGIN
					SELECT * 
					FROM   #OGRENCINOTY 
					ORDER  BY SUBE,
							ID_SINIF, 
							ID_OGRENCI, 
							SORUNO 

					SELECT DISTINCT O.SORUNO, 
									O.PUANDEGERI, 
									O.KONUKODU 
					FROM   #OGRENCINOTY O 
					ORDER  BY O.SORUNO 
				END

				DROP TABLE #OGRENCINOTY
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifDersAnalizi]    Script Date: 23.11.2021 15:32:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinifDersAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@GRUPLAMATURU		INT				= 1,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SUBEs					= @ID_SUBEs	
			,ID_SINAVs					= @ID_SINAVs	
			,ID_SINIFs					= @ID_SINIFs	
			,ID_DERSs					= @ID_DERSs	
			,OGRENCIDONEM				= @OGRENCIDONEM
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
			,ID_KADEME3					= @ID_KADEME3	
			,ID_SINAVTURU				= @ID_SINAVTURU
			,GRUPLAMATURU				= @GRUPLAMATURU
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )


		IF (@ISLEM = 1 OR @ISLEM = 2 OR @ISLEM = 3 OR @ISLEM = 4)  -- SINIF
		BEGIN					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #BOLUM
			DROP TABLE IF EXISTS #VERI
			DROP TABLE IF EXISTS #DERS

			SELECT DERSAD INTO #DERS FROM eokul_v2.dbo.Ders 
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'			

			SELECT	DISTINCT S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD,SB.NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM,OC.CEVAP OGRENCICEVAP,OC.ID_SINAVOGRENCICEVAP,SA.CEVAP DOGRUCEVAP
					,SA.SORUNO_A,
					CASE WHEN @GRUPLAMATURU = 1 THEN ISNULL(SA.KOD,'') WHEN @GRUPLAMATURU = 2 THEN SUBSTRING(SA.KOD, 1, 9) WHEN @GRUPLAMATURU = 3 THEN SUBSTRING(SA.KOD, 1, 6) ELSE '' END KOD, 
					CASE WHEN @GRUPLAMATURU = 1 THEN U.AD ELSE '' END KAZANIM, 
					CASE WHEN @GRUPLAMATURU = 1 OR @GRUPLAMATURU = 2 THEN (SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 9)) ELSE '' END KONU, 
					(SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 6)) UNITE
			INTO	#TEMP_OGRENCI
			FROM	Sinav					S	WITH (NOLOCK)
			INNER JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			INNER JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			INNER JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			INNER JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			INNER JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
			INNER JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			INNER JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			INNER JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD
			INNER JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM 
			INNER JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD				= SO.KITAPCIK 
																AND SD.ID_SINAV			= S.ID_SINAV
			INNER JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
																AND SA.KOD IS NOT NULL
			LEFT JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD-- KONU 
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND O.DONEM			= @OGRENCIDONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		

			DROP TABLE IF EXISTS #TEMP

			SELECT  DURUM, COUNT(DURUM) DURUMSAYISI,0 KISISAYISI, DERSAD, KOD, KAZANIM, KONU, UNITE, ID_SINIF
			INTO #TEMP
			FROM #TEMP_OGRENCI T
			GROUP BY KOD, DURUM, DERSAD, ID_SINIF, KAZANIM, KONU, UNITE

			UPDATE T
			SET KISISAYISI = (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.KOD=T.KOD AND G.DERSAD = T.DERSAD AND G.ID_SINIF = T.ID_SINIF)
			FROM #TEMP T

			SELECT DERSAD, KOD, KAZANIM, KONU, UNITE, ID_SINIF, CONVERT(decimal(8,2), CONVERT(decimal(8,2), DURUMSAYISI) / (KISISAYISI) * 100.0) BASARIYUZDESI
					,ISNULL((SELECT DURUMSAYISI FROM #TEMP SUBT WHERE SUBT.ID_SINIF = T.ID_SINIF AND SUBT.KOD = T.KOD AND SUBT.DERSAD = T.DERSAD AND SUBT.DURUM = 'D'), 0) AS DOGRUSAYISI		
					,ISNULL((SELECT DURUMSAYISI FROM #TEMP SUBT WHERE SUBT.ID_SINIF = T.ID_SINIF AND SUBT.KOD = T.KOD AND SUBT.DERSAD = T.DERSAD AND SUBT.DURUM = 'Y'), 0) AS YANLISSAYISI		
					,ISNULL((SELECT DURUMSAYISI FROM #TEMP SUBT WHERE SUBT.ID_SINIF = T.ID_SINIF AND SUBT.KOD = T.KOD AND SUBT.DERSAD = T.DERSAD AND SUBT.DURUM = 'B'), 0) AS BOSSAYISI		
			INTO #VERI
			FROM #TEMP T	
			WHERE DURUM	= 'D'
			GROUP BY KOD, DURUMSAYISI, KISISAYISI, ID_SINIF, KAZANIM, KONU, UNITE, DERSAD
 			ORDER BY ID_SINIF,KOD, KAZANIM, KONU, UNITE
			

			SELECT ID_SINIF,DERSAD, CONVERT(decimal(8,2),CONVERT(decimal(8,2),SUM(DURUMSAYISI))/(SUM(KISISAYISI))*100.0) BOLUMYUZDESI  						
			INTO #BOLUM
			FROM #TEMP	
			WHERE DURUM	= 'D'
			GROUP BY ID_SINIF,DERSAD

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 	
						(		
							SELECT   SINAVAD
									,SINAVTARIH
									,SINAVKATILIM	= COUNT(DISTINCT TCKIMLIKNO) 		
									,ID_SUBE
									,ID_SINIF			
									,SUBEAD
									,SINIFAD	
									,( 
											SELECT ID_SINIF,DERSAD, BOLUMYUZDESI  						
											FROM #BOLUM B
											WHERE B.ID_SINIF = O.ID_SINIF											
 											ORDER BY ID_SINIF	
											FOR JSON PATH
									) as DERSLIST
									,( 
											SELECT DERSAD, KOD, KAZANIM, KONU, UNITE, ID_SINIF, BASARIYUZDESI, DOGRUSAYISI, YANLISSAYISI, BOSSAYISI									
											FROM #VERI V
											WHERE V.ID_SINIF = O.ID_SINIF										
 											ORDER BY ID_SINIF	
											FOR JSON PATH
									) as KAZANIMLIST
							FROM #TEMP_OGRENCI  O
							GROUP BY SINAVAD,SINAVTARIH,SINIFAD,ID_SINIF,ID_SUBE,SUBEAD
							ORDER BY SUBEAD,SINIFAD
							FOR JSON PATH
						) as TblVeri				
						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE IF @ISLEM = 3
			BEGIN
				SELECT
				(
					SELECT	ID_SUBE,
							ID_SINIF, 
							SUBEAD,
							SINIFAD,
							SINAVLIST = 
									(
										SELECT ID_SINAV, 
												SINAVAD, 
												SINAVTARIH,
												SINAVKATILIM = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP_OGRENCI SUBO WHERE SUBO.ID_SINIF = O.ID_SINIF AND SUBO.ID_SINAV = O.ID_SINAV)
										FROM #TEMP_OGRENCI O 
										WHERE O.ID_SINIF = SS.ID_SINIF 
										GROUP BY O.ID_SINIF, ID_SINAV, SINAVAD, SINAVTARIH 
										FOR JSON PATH
									),
							KAZANIMLIST =
									(
										SELECT DERSAD, KAZANIM, KONU, UNITE, BASARIYUZDESI, DOGRUSAYISI, YANLISSAYISI, BOSSAYISI									
										FROM #VERI V
										WHERE V.ID_SINIF = SS.ID_SINIF AND (KAZANIM <> '' OR KONU <> '' OR UNITE <> '')
 										ORDER BY ID_SINIF, DERSAD, UNITE, KONU, KAZANIM
										FOR JSON PATH
									),
							DERSLIST =
									(
										SELECT ID_SINIF, DERSAD, BOLUMYUZDESI  						
										FROM #BOLUM B
										WHERE B.ID_SINIF = SS.ID_SINIF											
 										ORDER BY DERSAD, ID_SINIF	
										FOR JSON PATH
									)
					FROM #TEMP_OGRENCI SS
					GROUP BY ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
					ORDER BY ID_SUBE, ID_SINIF
					FOR JSON PATH
				) as j
			END
			ELSE IF @ISLEM = 4
			BEGIN
				SELECT	ID_SUBE,
						ID_SINIF, 
						SUBEAD,
						SINIFAD
				FROM #TEMP_OGRENCI SS
				GROUP BY ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
				ORDER BY ID_SUBE, ID_SINIF

				SELECT  ID_SINIF,
						ID_SINAV, 
						SINAVAD, 
						SINAVTARIH,
						SINAVKATILIM = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP_OGRENCI SUBO WHERE SUBO.ID_SINIF = O.ID_SINIF AND SUBO.ID_SINAV = O.ID_SINAV),
						SINIFAD,
						SUBEAD
				FROM #TEMP_OGRENCI O 
				GROUP BY ID_SINIF, SINIFAD, SUBEAD, ID_SINAV, SINAVAD, SINAVTARIH 

				SELECT ID_SINIF, ID_SINIF, DERSAD, BOLUMYUZDESI  						
				FROM #BOLUM B										
 				ORDER BY B.DERSAD, B.ID_SINIF	

				SELECT ID_SINIF, DERSAD, KAZANIM, KONU, UNITE, BASARIYUZDESI, DOGRUSAYISI, YANLISSAYISI, BOSSAYISI									
				FROM #VERI V
				WHERE KAZANIM <> '' OR KONU <> '' OR UNITE <> ''
 				ORDER BY ID_SINIF, DERSAD, UNITE, KONU, KAZANIM
			END
			ELSE
			BEGIN			
				SELECT * FROM #VERI
 				ORDER BY DERSAD,ID_SINIF

				SELECT * FROM #BOLUM
 				ORDER BY DERSAD,ID_SINIF

				SELECT   SINAVAD
						,SINAVTARIH
						,SINAVKATILIM	= COUNT(DISTINCT TCKIMLIKNO) 		
						,ID_SUBE
						,ID_SINIF			
						,SUBEAD
						,SINIFAD	
				FROM #TEMP_OGRENCI 
				GROUP BY SINAVAD,SINAVTARIH,SINIFAD,ID_SINIF,ID_SUBE,SUBEAD
				ORDER BY SUBEAD,SINIFAD				
			END

			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #BOLUM
			DROP TABLE IF EXISTS #VERI
		END			
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifDersProgram]    Script Date: 23.11.2021 15:33:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinifDersProgram]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_SINIF				INT				= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
				,ID_SINIF				= @ID_SINIF				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN
				
				DROP TABLE IF EXISTS #DERSPROGRAM
				
				IF @ID_SINIF IS NULL
					SET @ID_SINIF = (SELECT ID_SINIF FROM OkyanusDB.DBO.v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI)

				
				DECLARE @SAAT TABLE (DERSSAAT INT,ID_KADEME INT, SAAT VARCHAR(MAX) )
				INSERT INTO @SAAT (DERSSAAT, ID_KADEME, SAAT) 
				SELECT 1 ,5,'09:00 - 09:40' UNION 
				SELECT 2 ,5,'09:55 - 10:35' UNION 
				SELECT 3 ,5,'10:45 - 11:25' UNION 
				SELECT 4 ,5,'11:35 - 12:15' UNION 
				SELECT 5 ,5,'12:25 - 13:05' UNION 
				SELECT 6 ,5,'13:55 - 14:35' UNION 
				SELECT 7 ,5,'14:45 - 15:25' UNION 
				SELECT 8 ,5,'15:30 - 16:10' UNION 
				SELECT 9 ,5,'' 				UNION
				SELECT 10,5,''				UNION
				SELECT 1 ,4,'09:00 - 09:40' UNION 
				SELECT 2 ,4,'09:55 - 10:35' UNION 
				SELECT 3 ,4,'10:45 - 11:25' UNION 
				SELECT 4 ,4,'11:35 - 12:15' UNION 
				SELECT 5 ,4,'13:05 - 13:45' UNION 
				SELECT 6 ,4,'13:55 - 14:35' UNION 
				SELECT 7 ,4,'14:45 - 15:25' UNION 
				SELECT 8 ,4,'15:30 - 16:10' UNION 
				SELECT 9 ,4,'' 				UNION
				SELECT 10,4,''				UNION
				SELECT 1 ,3,'09:00 - 09:40' UNION 
				SELECT 2 ,3,'09:55 - 10:35' UNION 
				SELECT 3 ,3,'10:45 - 11:25' UNION 
				SELECT 4 ,3,'11:35 - 12:15' UNION 
				SELECT 5 ,3,'13:05 - 13:45' UNION 
				SELECT 6 ,3,'13:55 - 14:35' UNION 
				SELECT 7 ,3,'14:45 - 15:25' UNION 
				SELECT 8 ,3,'15:30 - 16:10' UNION 
				SELECT 9 ,3,'' 				UNION
				SELECT 10,3,''				UNION
				SELECT 1 ,2,'09:00 - 09:40' UNION 
				SELECT 2 ,2,'09:55 - 10:35' UNION 
				SELECT 3 ,2,'10:45 - 11:25' UNION 
				SELECT 4 ,2,'11:35 - 12:15' UNION 
				SELECT 5 ,2,'13:05 - 13:45' UNION 
				SELECT 6 ,2,'13:55 - 14:35' UNION 
				SELECT 7 ,2,'14:45 - 15:25' UNION 
				SELECT 8 ,2,'15:30 - 16:10' UNION 
				SELECT 9 ,2,'' 				UNION
				SELECT 10,2,''




				SELECT 
					 DERSSAAT	= DP.DERSSAAT
					,SAAT		= S.BASSAAT + ' - ' + S.BITSAAT
					,DP			= D.AD +' <br><small style="float: right; color: cornflowerblue;"> '+ CONCAT_WS(' ',K.AD,K.SOYAD) + '</small>'
					,GUN		= UPPER(G.GUN)
				INTO #DERSPROGRAM
				FROM OkyanusDB.DBO.v3DersProgram	DP
				JOIN OkyanusDB.DBO.v3Ders			D	ON	D.ID_DERS		= DP.ID_DERS
				JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO	= DP.TCKIMLIKNO
				JOIN Pusulam.DBO.GUN				G	ON	G.ID_GUN		= DP.GUN
				JOIN OkyanusDB.DBO.v3KademeBilgi	KB	ON	KB.ID_KADEME3	= D.ID_KADEME3
				JOIN Pusulam..OnlineDersSaat		S	ON	S.DERSNO		= DP.DERSSAAT --AND S.ID_KADEME		= KB.ID_KADEME														
				WHERE ID_SINIF = @ID_SINIF
				ORDER BY DERSSAAT


--SELECT G.GUN
--	,T.*
--FROM Gun	G
--JOIN #DERSPROGRAM	DP	ON	DP.GUN	= G.ID_GUN	
--JOIN #DERSPROGRAM	T	ON	T.GUN	= DP.GUN	AND T.DERSSAAT	= DP.DERSSAAT
--ORDER BY T.GUN,T.DERSSAAT
--FOR JSON AUTO, INCLUDE_NULL_VALUES

				
				SELECT(
					SELECT * FROM (
						SELECT(
							SELECT * FROM (
								SELECT * 
								FROM #DERSPROGRAM
							) AS VERI
							PIVOT ( MAX(DP)  FOR Gun  IN ([PAZARTESİ],[SALI],[ÇARŞAMBA],[PERŞEMBE],[CUMA]) ) AS P
							ORDER BY DERSSAAT
							FOR JSON PATH, INCLUDE_NULL_VALUES
						) AS DERSPROGRAM,
						ISNULL((	
							SELECT TCKIMLIKNO, SUBEAD, SINIFAD, KADEME3, ADSOYAD  = CONCAT_WS(' ', AD, SOYAD)
							FROM OkyanusDB.DBO.vw_OgrenciDetayTum	
							WHERE	TCKIMLIKNO	= @TC_OGRENCI
								AND ID_SINIF	= @ID_SINIF
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),'[]') AS OGRENCIDETAY
					) AS DD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
				
				DROP TABLE IF EXISTS #DERSPROGRAM

			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifListeRaporu]    Script Date: 23.11.2021 15:33:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinifListeRaporu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@VELI				BIT				= NULL,
	@ID_SUBELER		    VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	= NULL,
	@DANISMAN_OGRETMEN  BIT				= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,DONEM					= @DONEM		
				,SQLJSON				= @SQLJSON	
				,VELI					= @VELI	
				,ID_SUBELER				= @ID_SUBELER	
				,ID_SINIFLAR			= @ID_SINIFLAR
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP 
		

		IF @_ID_LOG > 0
		BEGIN
			
			
			IF  @ISLEM= 1 -- SINIF Listesi
			BEGIN  
				
				DROP TABLE IF EXISTS #OGRENCILIST

				SELECT DISTINCT 
					 ID_SINIF		= D.ID_SINIF
					,[ŞUBE]			= D.SUBEAD
					,[KUR SEVİYESİ]	= DS.SEVIYE
					,SIRA			= D.SIRA
					,GRUP			= D.KADEME3
					,SINIF			= D.SINIF
					,TCKIMLIKNO		= S.TCKIMLIKNO
					,[ÖĞR. AD SOYAD]= K.AD + ' '+ K.SOYAD  
					,[KAYIT TARIH]	= ISNULL(S.KAYITTARIH,'')
				INTO #OGRENCILIST
				FROM  OkyanusDB.dbo.vw_SinifOgrenci				S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay		D	ON  S.ID_SINIF		= D.ID_SINIF
				INNER JOIN  v3AktifDonem						AD	ON  AD.DONEM		= D.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici			K	ON  K.TCKIMLIKNO	= S.TCKIMLIKNO
				LEFT JOIN   OkyanusDB.dbo.v4SinifOgretmenDers	SD	ON  SD.ID_SINIF		= D.ID_SINIF 
				LEFT JOIN   OkyanusDB.dbo.v4DersSeviye			DS	ON  SD.ID_DERS		= DS.ID_DERS 
																	AND	SD.ID_DERSSEVIYE= DS.ID_DERSSEVIYE
				WHERE	AD.AKTIF=1        
					AND D.ID_SUBE		IN (SELECT VALUE FROM OPENJSON (@ID_SUBELER ))
					AND D.ID_SINIF		IN (SELECT VALUE FROM OPENJSON (@ID_SINIFLAR))


				IF @VELI = 1
				BEGIN

					SELECT 
						 OL.[ŞUBE]			
						,OL.[KUR SEVİYESİ]	
						,OL.SIRA			
						,OL.GRUP			
						,OL.SINIF			
						,OL.TCKIMLIKNO		
						,OL.[ÖĞR. AD SOYAD]
						,OL.[KAYIT TARIH]	
						,TC_VELI			= K.TCKIMLIKNO
						,[VELi AD SOYAD]	= CONCAT_WS(' ',K.AD, K.SOYAD)
					FROM #OGRENCILIST	OL
					JOIN OkyanusDB.dbo.v3OgrenciVeli	V	ON	V.TCKIMLIKNO_OGR	= OL.TCKIMLIKNO
					JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO		= V.TCKIMLIKNO
					ORDER BY [ŞUBE], SIRA, SINIF, [ÖĞR. AD SOYAD], [KUR SEVİYESİ]

				END				
				IF @DANISMAN_OGRETMEN = 1
				BEGIN	
					SELECT
						 OL.[ŞUBE]			
						,OL.[KUR SEVİYESİ]	
						,OL.SIRA			
						,OL.GRUP			
						,OL.SINIF			
						,OL.TCKIMLIKNO		
						,OL.[ÖĞR. AD SOYAD]
						,OL.[KAYIT TARIH]	
						,[TC DANISMAN]				= K.TCKIMLIKNO
						,[DANIŞMAN ÖĞRETMEN]		= CONCAT_WS(' ',K.AD, K.SOYAD)
					FROM #OGRENCILIST	OL
					JOIN OkyanusDB.dbo.v3SinifPersonel  P   ON	P.ID_SINIF			= OL.ID_SINIF
					JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO		= P.TCKIMLIKNO
					WHERE P.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@ID_SINIFLAR)) AND P.ID_KULLANICITIPI = 100
					ORDER BY [ŞUBE], SIRA, SINIF, [ÖĞR. AD SOYAD], [KUR SEVİYESİ]
				END
				IF @DANISMAN_OGRETMEN = 0 AND @VELI = 0
				BEGIN
					SELECT *
					FROM #OGRENCILIST
					ORDER BY [ŞUBE], SIRA, SINIF, [ÖĞR. AD SOYAD], [KUR SEVİYESİ]
				END

			END

			IF  @ISLEM= 2 -- SINIF Listesi Fotograflı
			BEGIN
				SELECT ISNULL(( 
					SELECT	 SUBEAD			= D.SUBEAD
							,[KUR SEVİYESİ]	= DS.SEVIYE
							,SINIF			= D.SINIF
							,TCKIMLIKNO		= S.TCKIMLIKNO
							,ADSOYAD		= K.AD + ' '+ K.SOYAD
							,FOTOGRAF		= ISNULL(R.FOTOGRAF,'') 
							,KAYIT_TARIH	= ISNULL(S.KAYITTARIH,'')
					FROM  OkyanusDB.dbo.vw_SinifOgrenci				S 
					INNER JOIN	OkyanusDB.dbo.vw_v4SinifDetay		D	ON	S.ID_SINIF		= D.ID_SINIF
					INNER JOIN	v3AktifDonem						AD	ON	AD.DONEM		= D.DONEM 
					INNER JOIN	OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO	= S.TCKIMLIKNO
					LEFT JOIN	OkyanusDB.dbo.v4SinifOgretmenDers	SD	ON	SD.ID_SINIF		= D.ID_SINIF 
					LEFT JOIN	OkyanusDB.dbo.v4DersSeviye			DS	ON	SD.ID_DERS		= DS.ID_DERS 
																		AND SD.ID_DERSSEVIYE= DS.ID_DERSSEVIYE
					LEFT JOIN	OkyanusDB.dbo.v3Resim				R	ON	R.TCKIMLIKNO	= S.TCKIMLIKNO
					WHERE	AD.AKTIF=1        
						AND D.ID_SUBE		IN (SELECT VALUE FROM OPENJSON (@ID_SUBELER ))
						AND D.ID_SINIF		IN (SELECT VALUE FROM OPENJSON (@ID_SINIFLAR))
					ORDER BY D.SUBEAD ASC,DS.SEVIYE DESC
				FOR JSON PATH),'[]')			
			   END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifMaddeAnalizi]    Script Date: 23.11.2021 15:33:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinifMaddeAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	-- kullanılmıyor
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_DERSs					= @ID_DERSs		
			,ID_KADEME3					= @ID_KADEME3		
			,TC_OGRENCI					= @TC_OGRENCI		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBE					= @ID_SUBE		
			,ID_DERS					= @ID_DERS		
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
						
		Declare  @SQL		as varchar(max)=null
				,@Columns	as varchar(max)=null
				,@Columns2	as varchar(max)=null
				,@Columns3	as varchar(max)=null

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )

		IF (@ISLEM = 1 OR @ISLEM = 3)  -- SINIF
		BEGIN
			
		
		------------------------------------------ SINIF		
			--DECLARE  
			--		 @ID_SUBEs		VARCHAR(MAX)= '[11]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2018'
			--		,@OGRENCIDONEM	VARCHAR(MAX)= '2018'
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #k
			DROP TABLE IF EXISTS #TblOrtalama
			DROP TABLE IF EXISTS #DERS

			
			
			SELECT DERSAD INTO #DERS from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'

			SELECT	DISTINCT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD--,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A, SD.BOLUMNO
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
			JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
			JOIN	v3SubeGrupSinifTum		GS	WITH (NOLOCK)	ON	GS.ID_SINIF						= SN.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK	WITH (NOLOCK)	ON	SK.ID_SINAV						= SO.ID_SINAV  
																AND SK.AD							= SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																AND SA.SORUNO						= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
	   left JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD							= SA.KOD
			WHERE	S.AKTIF			=	1
				AND S.DURUM			=	2
				AND GS.ID_KADEME3	=	@ID_KADEME3
				AND O.DONEM			=	@OGRENCIDONEM
				AND (S.OZEL = 0		OR	@OZELSINAVGOR	= 1)
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
			
			DROP TABLE IF EXISTS #SINIF_DYB
			SELECT KOD, KAZANIM, ID_SINIF, SINIFAD, ID_DERS, DERSAD, ID_SINAV, SINAVAD, SINAVTARIH, SUBEAD, ID_SUBE, COUNT(DURUM) DURUMSAYISI, DURUM , 0 OGRSAY, SORUNO_A, BOLUMNO
			INTO #SINIF_DYB 
			FROM #TEMP_SINIF T
			GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#SINIF_DYB	S
			JOIN    (SELECT SORUNO_A,ID_SINIF,ID_DERS,SUM(DURUMSAYISI)	OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO_A,ID_SINIF, ID_DERS) AS G	ON G.ID_SINIF=S.ID_SINIF  AND G.SORUNO_A = S.SORUNO_A AND S.ID_DERS = G.ID_DERS
			--JOIN    (SELECT SORUNO_A,ID_SINIF,SUM(DURUMSAYISI)	OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO_A,ID_SINIF) AS G	ON G.ID_SINIF=S.ID_SINIF  AND G.SORUNO_A = S.SORUNO_A 
							
			SELECT *, CAST(	(	SELECT CAST(DURUMSAYISI AS DECIMAL(8,2))/OGRSAY*100 
								FROM #SINIF_DYB G 
								WHERE	G.DURUM		= S.DURUM 
									AND G.ID_SINIF	= S.ID_SINIF 
									AND G.KOD		= S.KOD 
									AND G.SORUNO_A	= S.SORUNO_A  
									AND G.BOLUMNO	= S.BOLUMNO
							) AS DECIMAL(8,2)) AS YUZDE
			INTO #SINIF
			FROM #SINIF_DYB S
			ORDER BY SORUNO_A
		
			SELECT ID_SINIF, BOLUMNO,ID_SUBE, SORUNO_A, COUNT(DISTINCT TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
			INTO #OGRSAY
			FROM #TEMP_SINIF
			GROUP BY ID_SINIF, BOLUMNO, SORUNO_A, SUBEAD, SINIFAD, ID_SUBE
			
			Select distinct ID_SINIF,SINIFAD, ID_SUBE,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 
		
				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
				from 
					( Select DISTINCT ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,SINIFAD
				
				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
				ORDER BY SUBEAD,COL DESC,SINIFAD

				Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,COL DESC,SINIFAD
								
			

			Set @SQL='	
				Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into ##TblSinif
				from (
					Select *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF WHERE DURUM=''D''
					UNION ALL 
					Select *,SUBEAD COL from #SINIF WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
				GROUP BY SORUNO_A,KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
				
				INSERT INTO ##TblSinif
				SELECT '''',ID_DERS,DERSAD,''SINIF ORTALAMASI'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						, '+@Columns3+'
				FROM ##TblSinif
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM,ID_DERS,DERSAD
				
			'
			
			PRINT @SQL
			EXEC (@SQL)
			
				SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
				INTO #TblOrtalama
				FROM #SINIF
				WHERE DURUM='D'
				GROUP BY ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD
			UNION ALL				
				SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,0 ID_SUBE,'' SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
				FROM #SINIF
				WHERE DURUM='D'
				GROUP BY ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

			If (OBJECT_ID('tempdb..##TblSinif ') Is Null)			
			BEGIN
				SELECT KOD = NULL,ID_DERS= NULL,DERSAD= NULL,KAZANIM= NULL,SORUNO_A= NULL,ID_SINAV= NULL,SINAVAD= NULL,SINAVTARIH= NULL,DURUM= NULL,BOLUMNO= NULL INTO  ##TblSinif 
				DELETE FROM ##TblSinif 
			END

			BEGIN
				IF @ISLEM = 1  -- DEVEXPRESS
				BEGIN
					Select ID_SINIF, SINIFAD, SUBEAD, COL 
					from #k 
					ORDER BY SUBEAD, SINIFAD

					SELECT * FROM ##TblSinif 

					SELECT DISTINCT ID_SINIF,ID_SUBE,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF, OGRSAY

				
					SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD, YUZDE
					FROM #TblOrtalama
					ORDER BY SUBEAD,DERSAD

				END
				ELSE
				BEGIN
					select(
						select * from(
							select 
							(					
								Select ID_SINIF, SINIFAD, SUBEAD, COL 
								from #k 
								ORDER BY SUBEAD, SINIFAD
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) as TblSinifListesi,					
							(					
								SELECT * FROM ##TblSinif order by BOLUMNO,SORUNO_A
								FOR JSON AUTO
							) as TblVeri,
							(					
								SELECT DISTINCT ID_SINIF,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF, OGRSAY
								FOR JSON AUTO
							) as TblOgrSay,
							(	
								SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD, YUZDE
								FROM #TblOrtalama
								ORDER BY SUBEAD,DERSAD
								FOR JSON AUTO
							) as TblOrtalama
						) as tablo FOR JSON AUTO
					) as tt
				
				
				END
			END

			DROP TABLE IF EXISTS #k
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #TblOrtalama
			DROP TABLE IF EXISTS #DERS

		END
		-- kullanılmıyor
		IF @ISLEM = 2 -- OKUL
		BEGIN
			------------------------------------------ OKUL
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[11,444]'
			--		,@ID_DERSs		VARCHAR(MAX)= '[942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			DROP TABLE IF EXISTS ##TblOkul

		

			SELECT DISTINCT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,VD.ID_DERS,VD.DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A,BOLUMNO
			INTO	#TEMP_OKUL
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS

			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM

			JOIN	SinavKitapcik			SK	WITH (NOLOCK)	ON	SK.ID_SINAV = SO.ID_SINAV  AND SK.AD = SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK

			JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (SD.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs ='[]')		
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	


			
			DROP TABLE IF EXISTS #OKUL_DYB
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE		,COUNT(DURUM) DURUMSAYISI,DURUM ,0 OGRSAY,SORUNO_A,BOLUMNO
			INTO #OKUL_DYB 
			FROM #TEMP_OKUL T
			GROUP BY KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			--SELECT * FROM #OKUL_DYB 
		
			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#OKUL_DYB S
			JOIN    (
			SELECT SORUNO_A,ID_SUBE,SUM(DURUMSAYISI) OGRSAY FROM #OKUL_DYB
			GROUP BY SORUNO_A,ID_SUBE) AS G ON G.ID_SUBE=S.ID_SUBE   AND G.SORUNO_A = S.SORUNO_A --AND (G.KOD=S.KOD OR (G.KOD IS NULL AND S.KOD IS NULL))
		
			DROP TABLE IF EXISTS #OKUL
			SELECT *, CAST((SELECT CAST(DURUMSAYISI AS DECIMAL(8,2))/OGRSAY*100 FROM #OKUL_DYB G WHERE G.DURUM=S.DURUM AND G.ID_SUBE=S.ID_SUBE AND G.KOD=S.KOD AND G.SORUNO_A=S.SORUNO_A  AND G.BOLUMNO=S.BOLUMNO) AS DECIMAL(8,2)) AS YUZDE
			INTO #OKUL
			FROM #OKUL_DYB S
			ORDER BY SORUNO_A


				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SUBEAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SUBEAD)+'=''-'' then null else '+QUOTENAME(SUBEAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD


			Set @SQL='	
			
				Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into ##TblOkul
				from (
					Select * from #OKUL WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR SUBEAD IN('+@Columns+')) as P1	
				GROUP BY SORUNO_A,KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

				INSERT INTO ##TblOkul
				SELECT '''',0,'''',''ORTALAMA'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						,'+@Columns3+'
				FROM ##TblOkul
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM

			'
			PRINT @SQL
			EXEC (@SQL)

			Select distinct ID_SUBE,SUBEAD,SUBEAD COL from #TEMP_OKUL ORDER BY SUBEAD

			SELECT * FROM ##TblOkul ORDER BY BOLUMNO, SORUNO_A
		
		
			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			DROP TABLE IF EXISTS ##TblOkul
		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifNetPuanOrtalamalari]    Script Date: 23.11.2021 15:33:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinifNetPuanOrtalamalari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='32051057542',@OTURUM='10F4322D-70ED-4AB6-B4C6-0ECC61118DFC',@DONEM='2017',@ID_SINAVTURU=8,@ID_KADEME3=15,@ID_SINAVs='[243,330,286]',@ID_SUBEs='[427,11]',@ID_SINIFS='[107210,107209,108612,107251]',@ID_DERSs='[0,147,150,152,873,962,1119]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
	
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
				
		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11


		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null

		------------------------------------------ DERS NET
		BEGIN
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18

		SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS
				,O.ID_SUBE,SU.AD SUBEAD
		INTO	#Temp
		FROM	Sinav					S	WITH (NOLOCK)
		JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO 
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
		JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
		WHERE	S.DURUM			= 2
			AND S.AKTIF			= 1
			AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))

		--SELECT * FROM #Temp

			SELECT ID_SINAV,SINAVAD,ID_DERS,DERSAD,SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			INTO #Net
			FROM #Temp	T
			GROUP BY ID_DERS,ID_SINAV,SINAVTARIH,SINAVAD,DERSAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		--UNION ALL 
		--	SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		--	FROM #Temp	T
		--	GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			
			INSERT INTO #Net			
			SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			FROM #Net	T
			GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH
				
			
			--Select  SINAVAD, ID_SINAV, SINAVTARIH, ID_DERS, ID_SUBE, SUBEAD, DERSAD, NET into ##pivots from #Net
			--DELETE FROM ##pivots
			--SELECT TOP 1 ID_DERS,DERSAD INTO ##GenelOrt FROM #Net
			--DELETE FROM ##GenelOrt

			

			if not exists (select * from #Net)
			begin
				Select 				
					ID_DERS=null,
					ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					DERSAD=null
				into ##pivots

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt
			end

		

		Set @SQL='	
			
			Select
				ID_DERS,
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				DERSAD,
				999 BOLUMNO,
				'+@Columns2+' 
			into ##pivots
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					DERSAD,
					-- TS,
					NET
				from #Net
			) AS S
			PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY DERSAD,SUBEAD,ID_SUBE,ID_DERS,ID_SINIF,SINIFAD	
				
			SELECT ID_DERS,DERSAD,999 BOLUMNO,'+@Columns3+'
			INTO ##GenelOrt
			FROM ##pivots 
			GROUP BY ID_DERS,DERSAD		
		'
		PRINT @SQL
		EXEC (@SQL)
		
		SELECT * 
		INTO #PIVOTS
		FROM ##pivots 
		DROP TABLE IF EXISTS ##pivots
		
		SELECT * 
		INTO #GENELORT
		FROM ##GenelOrt 		
		DROP TABLE IF EXISTS ##GenelOrt


		BEGIN

			SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,SO.TCKIMLIKNO
			INTO	#Temp11
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV		
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))

			SELECT SINAVAD,DERSAD,CAST(AVG(NET) AS decimal(8,2)) AS ORT INTO #ORT  FROM #Temp11 
			GROUP BY DERSAD,SINAVAD
		INSERT INTO #ORT
			SELECT SINAVAD,'TOPLAM',CAST(SUM(NET)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS ORT  FROM #Temp11
			GROUP BY SINAVAD
			

			SELECT value SINAVAD INTO #COL FROM string_split(@Columns,',')
			WHILE EXISTS (SELECT * FROM #COL)
			BEGIN
				DECLARE @COL VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL ORDER BY 1 DESC)
			SET @SQL = N'
					UPDATE P
					SET	P.'+@COL+' = O.ORT
					FROM #GENELORT P
					JOIN #ORT	O ON O.DERSAD = P.DERSAD AND ''[''+ O.SINAVAD +'']'' = '''+@COL+'''
				'
				PRINT @SQL
				EXEC (@SQL)
				DELETE FROM #COL WHERE SINAVAD = (SELECT TOP 1 SINAVAD FROM #COL ORDER BY 1 DESC)
			END
		END

		DECLARE @ID_EGITIMTURU VARCHAR(15)=
		CASE @ID_SINAVTURU 
										WHEN  0 THEN 6 
										WHEN  2 THEN 7 
										WHEN  3 THEN 8 
										WHEN  6 THEN 9 
										WHEN  5 THEN 10
										--YENENLEEKLENEİ 
										WHEN  8  THEN 11
										WHEN  9 THEN 12
										WHEN  7 THEN 13
										WHEN  10 THEN 14
										
										END

			--CASE  WHEN @ID_SINAVTURU = 2 THEN 7
			--	  WHEN @ID_SINAVTURU = 3 THEN 8
			--	  WHEN @ID_SINAVTURU = 6 THEN 9
			--	  ELSE @ID_SINAVTURU 
			--	  END 

	


		
		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value

		DECLARE @ILK_ID_SINAV INT=(SELECT TOP 1 VALUE FROM OPENJSON(@ID_SINAVs) WHERE VALUE > 0)


		SELECT		DISTINCT SD.TAKMAAD , SD.TAKMAAD AS DERSAD,SD.BOLUMNO	BOLUM	
		INTO #BOLUMLER		
		FROM		#PIVOTS				G
		JOIN		Sinav				S	ON	S.ID_SINAV	= @ILK_ID_SINAV
		JOIN		SinavDers			SD	ON	SD.ID_SINAV	= S.ID_SINAV 
		JOIN		eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= SD.ID_DERS
		ORDER BY BOLUM
		
		INSERT INTO #BOLUMLER (TAKMAAD,DERSAD,BOLUM)
		SELECT DISTINCT DERSAD,DERSAD,(SELECT MAX(BOLUM) FROM #BOLUMLER)+ ROW_NUMBER() OVER(ORDER BY DERSAD ASC) FROM #PIVOTS  P
		WHERE DERSAD !='TOPLAM' AND  DERSAD NOT IN (SELECT DERSAD FROM #BOLUMLER )


		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS	G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		
		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		SELECT distinct P.*,isnull(K.AD+' '+K.SOYAD,'') ADSOYAD 
		INTO #T1
		FROM #PIVOTS p		
		JOIN eokul_v2.DBO.Ders				D	ON	D.ID_DERS = P.ID_DERS
		JOIN eokul_v2.DBO.Ders				D2	ON	D2.DERSAD = D.DERSAD
												AND D2.ID_KADEME3 = D.ID_KADEME3
												AND D2.AKTIF = 1
		left JOIN eokul_v2.DBO.dersOgretmen do	on	do.ID_SINIF=p.ID_SINIF 
												AND DO.ID_DERS=D2.ID_DERS 
												and do.ID_EGITIMTURU=@ID_EGITIMTURU
		left JOIN v3Kullanici	K	ON	K.TCKIMLIKNO=DO.TC_OGRETMEN
		where P.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))	
		ORDER BY ID_DERS DESC

		END
		------------------------------------------ PUAN
		BEGIN


		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
		SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO
				,SN.ID_SINIF,SN.AD SINIFAD
				,O.ID_SUBE,SU.AD SUBEAD
				,PT.ID_SINAVPUANTURU,PT.AD PUANTURU
				,SOS.PUAN
		INTO	#Temp2
		FROM	Sinav					S	WITH (NOLOCK)
		JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
															AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
		JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		WHERE	S.DURUM			= 2
			AND S.AKTIF			= 1
			AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			--AND PT.ID_SINAVTURU	= @ID_SINAVTURU
			--AND S.ID_KADEME3	= @ID_KADEME3

		--SELECT * FROM #Temp

		SELECT ID_SINAV,SINAVAD,SINAVTARIH,CAST(AVG(PUAN) AS DECIMAL(8,2)) PUAN ,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU,ID_SINIF,SINIFAD
		INTO #Net2
		FROM #Temp2	T
		GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU,ID_SINIF,SINIFAD


		SET @SQL 	  =NULL
		SET @Columns  =NULL
		SET @Columns2 =NULL
		SET @Columns3 =NULL

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b 
			order by b.SINAVTARIH

		--Select @Columns2=Coalesce(@Columns2+',','')+'MAX(CAST(ISNULL(CAST('+QUOTENAME(SINAVAD)+' AS VARCHAR),''-'') AS VARCHAR)) AS ' +QUOTENAME(SINAVAD) from (
			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b 
			order by b.SINAVTARIH
				
				
			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b 
			order by b.SINAVTARIH

			

			if not exists (select * from #Net2)
			begin
				Select 				
				ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					ID_SINAVPUANTURU=null,
					PUANTURU=null
				into ##pivots2

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt2
			end

		Set @SQL='	
			
			Select 				
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				ID_SINAVPUANTURU,
				PUANTURU,
				'+@Columns2+' 
			into ##pivots2
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					ID_SINAVPUANTURU,
					PUANTURU,
					-- TS,
					PUAN
				from #Net2
			) AS S
			PIVOT (MAX(PUAN) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY SUBEAD,ID_SUBE,ID_SINAVPUANTURU,PUANTURU,ID_SINIF,SINIFAD

	
			SELECT ID_SINAVPUANTURU,PUANTURU,'+@Columns3+'
			INTO ##GenelOrt2
			FROM ##pivots2 
			GROUP BY ID_SINAVPUANTURU,PUANTURU	
		'
		PRINT @SQL
		EXEC (@SQL)

		
		SELECT * 
		INTO #PIVOTS2
		FROM ##pivots2 
		DROP TABLE ##pivots2
		
		SELECT * 
		INTO #GENELORT2
		FROM ##GenelOrt2 		
		DROP TABLE ##GenelOrt2




		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList2
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp2 T ON '['+T.SINAVAD+']'=FN.Value
		--SELECT DISTINCT ID_SUBE,SUBEAD FROM #Temp2
		--SELECT DISTINCT ID_SINAVPUANTURU,PUANTURU FROM #Temp2

		
		END
		------------------------------------------ JSON SEND
		
		 select(
				select * from(
						select 
						(					
							SELECT		*
							FROM		#T1 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
								AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							ORDER BY	BOLUMNO 
							FOR JSON AUTO
						) as t1,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList
							ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t2,
						(					
							SELECT		*
							FROM		#PIVOTS2 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
								AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t3,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList2
							ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t4,

						(					
							SELECT		*
							FROM		#GENELORT 
							ORDER BY	ID_DERS DESC
							FOR JSON AUTO
						) as t5,
						(					
							SELECT		*
							FROM		#GENELORT2
							ORDER BY	ID_SINAVPUANTURU DESC
							FOR JSON AUTO
						) as t6
						
												
					) as tablo FOR JSON AUTO
				) as tt

		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinifOgretmenListesi]    Script Date: 23.11.2021 15:34:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinifOgretmenListesi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_SINIF				INT				= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
				,ID_SINIF				= @ID_SINIF
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN
				--DECLARE @ID_SINIF INT =111636

				IF @ID_SINIF IS NULL
					SET @ID_SINIF = (SELECT ID_SINIF FROM OkyanusDB.DBO.v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI)

				DROP TABLE IF EXISTS #OGRETMENLIST

				select 
					TCKIMLIKNO	= o.TCKIMLIKNO,
					ADSOYAD		= CONCAT_WS(' ', k.AD, k.SOYAD),
					ID_DERS		= DO.ID_DERS,
					BRANS		= isnull(O.BRANS,''),
					FOTOGRAF	= isnull((select TOP 1 FOTOGRAF	from  OkyanusDB.dbo.v3Resim R where R.TCKIMLIKNO=O.TCKIMLIKNO),''),
					RN			= ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY O.TCKIMLIKNO)
				INTO #OGRETMENLIST
				from OkyanusDB.dbo.v3Ogretmen		O
				join eokul_v2.DBO.DersOgretmen		do	on	do.TC_OGRETMEN	= o.TCKIMLIKNO
				join OkyanusDB.dbo.v3Kullanici		k	on	k.TCKIMLIKNO	= do.TC_OGRETMEN
				join OkyanusDB.dbo.vw_Sinif			S	on	S.ID_SINIF		= DO.ID_SINIF
				join OkyanusDB.dbo.v3KullaniciBilgi	KB	on	KB.TCKIMLIKNO	= k.TCKIMLIKNO
				where S.ID_SINIF = @ID_SINIF
				GROUP BY O.TCKIMLIKNO, CONCAT_WS(' ', k.AD, k.SOYAD), DO.ID_DERS, O.BRANS


				
				SELECT(
					SELECT * FROM (
						SELECT(
							SELECT TCKIMLIKNO 
								,FOTOGRAF
								,ADSOYAD
								,BRANS
								,DERS = (	SELECT DISTINCT D.AD
											FROM #OGRETMENLIST			S 
											JOIN OkyanusDB.DBO.v3Ders	D	ON	D.ID_DERS	= S.ID_DERS
											WHERE S.TCKIMLIKNO	= OL.TCKIMLIKNO
											ORDER BY D.AD
											FOR JSON PATH
										)
							FROM #OGRETMENLIST	OL
							WHERE OL.RN	= 1
							ORDER BY ADSOYAD
							FOR JSON PATH, INCLUDE_NULL_VALUES
						) AS OGRETMENLIST,
						ISNULL((	
							SELECT TCKIMLIKNO, SUBEAD, SINIFAD, KADEME3, ADSOYAD  = CONCAT_WS(' ', AD, SOYAD)
							FROM OkyanusDB.DBO.vw_OgrenciDetayTum	
							WHERE	TCKIMLIKNO	= @TC_OGRENCI
								AND ID_SINIF	= @ID_SINIF
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),'[]') AS OGRENCIDETAY
					) AS DD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
								
				DROP TABLE IF EXISTS #OGRETMENLIST

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SoruMaddeAnaliziOS]    Script Date: 23.11.2021 15:34:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SoruMaddeAnaliziOS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@DONEM='2017',@ID_SINAVTURU=6,@ID_KADEME3=17,@ID_SINAVs='[0,168,158,160,145,70,78,144,143,67,69]',@ID_SUBEs='[427,11]',@ID_SINIFS='[0,104795,102205,102206,101684,101674,101675,101673,101681,102311]',@ID_DERSs='[914,977,978,980,981,1016,1047,1051]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null


		IF (@ISLEM = 1 OR @ISLEM = 3)  -- SINIF
		BEGIN
			
		
		------------------------------------------ SINIF
		
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[11]'
			--		,@ID_SINIFs		VARCHAR(MAX)= '[0,101677,101671,101679,101672,101676,101680]'
			--		,@ID_DERSs		VARCHAR(MAX)= '[942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 2
			--		,@ID_KADEME3	INT			= 18
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif

			SELECT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A, SD.BOLUMNO
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	v3Sinif					SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	eokul_v2.dbo.Ders		VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD

			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.ID_SINAV			= SO.ID_SINAV
																AND SK.AD				= SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
		left	JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (VD2.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs ='[]')		
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		


			
			DROP TABLE IF EXISTS #SINIF_DYB
			SELECT KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE		,COUNT(DURUM) DURUMSAYISI,DURUM ,0 OGRSAY,SORUNO_A,BOLUMNO
			INTO #SINIF_DYB 
			FROM #TEMP_SINIF T
			GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			--SELECT * FROM #SINIF_DYB 
		
			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#SINIF_DYB S
			JOIN    (
			SELECT KOD,ID_SINIF,SUM(DURUMSAYISI) OGRSAY FROM #SINIF_DYB
			GROUP BY KOD,ID_SINIF) AS G ON G.ID_SINIF=S.ID_SINIF AND (G.KOD=S.KOD OR (G.KOD IS NULL AND S.KOD IS NULL))
			
		
			DROP TABLE IF EXISTS #SINIF
			SELECT *
				, CAST((	SELECT	CAST(SUM (DURUMSAYISI )AS DECIMAL(8,2))/OGRSAY*100 
							FROM #SINIF_DYB G 
							WHERE	G.DURUM=S.DURUM 
								AND G.ID_SINIF=S.ID_SINIF 
								AND G.KOD=S.KOD 
								--AND G.SORUNO_A=S.SORUNO_A  
								AND G.BOLUMNO=S.BOLUMNO							
							group by g.OGRSAY
							) 
						AS DECIMAL(8,2)
					) AS YUZDE
			INTO #SINIF
			FROM #SINIF_DYB S
			ORDER BY SORUNO_A



			SELECT ID_SINIF, BOLUMNO, SORUNO_A, COUNT(TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
			INTO #OGRSAY
			FROM #TEMP_SINIF
			GROUP BY ID_SINIF, BOLUMNO, SORUNO_A, SUBEAD, SINIFAD


			Select distinct ID_SINIF,SINIFAD,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 


				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
				ORDER BY SUBEAD,SINIFAD
				
				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,SINIFAD

				Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,SINIFAD
				

			Set @SQL='	
				DROP TABLE IF EXISTS #TblSinif

				Select  KOD,ID_DERS,DERSAD,KAZANIM,MIN(SORUNO_A) SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into #TblSinif
				from (
					Select *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
				GROUP BY KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

				INSERT INTO #TblSinif
				SELECT '''',0,'''',''SINIF ORTALAMA'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						, '+@Columns3+'
				FROM #TblSinif
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM

				SELECT	DISTINCT F.*
						,SORULIST	= ISNULL( (SELECT STUFF((SELECT   '' - '' + CAST(K.SORUNO_A AS VARCHAR)	FROM #SINIF K WHERE K.KOD = F.KOD AND K.ID_DERS = F.ID_DERS GROUP BY K.ID_DERS,K.SORUNO_A ORDER BY K.SORUNO_A FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 3, '''')),''-'')
				FROM #TblSinif F
				ORDER BY SORUNO_A

				SELECT	DISTINCT F.*						
				INTO ##TblSinif
				FROM #TblSinif F
				ORDER BY SORUNO_A

				DROP TABLE IF EXISTS #TblSinif
			'
			
			PRINT @SQL
			--EXEC (@SQL)
			


			--Select distinct ID_SINIF,SINIFAD,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL from #TEMP_SINIF ORDER BY SUBEAD,SINIFAD
			
			IF @ISLEM = 1  -- DEVEXPRESS
			BEGIN
				Select ID_SINIF,SINIFAD,SUBEAD, COL from #k ORDER BY SUBEAD,SINIFAD
				
				EXEC (@SQL)

				SELECT DISTINCT ID_SINIF,BOLUMNO,OGRSAY,COL FROM #OGRSAY ORDER BY COL, BOLUMNO, ID_SINIF, OGRSAY

			END
			ELSE
			BEGIN
				select(
					select * from(
						select 
						(					
							Select ID_SINIF, SINIFAD, SUBEAD, COL from #k ORDER BY SUBEAD, SINIFAD
							FOR JSON AUTO
						) as TblSinifListesi,					
						(					
							SELECT * FROM ##TblSinif order by BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblVeri,					
						(					
							SELECT DISTINCT ID_SINIF,BOLUMNO,OGRSAY,COL FROM #OGRSAY ORDER BY COL, BOLUMNO, ID_SINIF, OGRSAY
							FOR JSON AUTO
						) as TblOgrSay
					) as tablo FOR JSON AUTO
				) as tt
				
				
			END




			DROP TABLE IF EXISTS #k
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif





		END
		IF @ISLEM = 2 -- OKUL
		BEGIN
			------------------------------------------ OKUL
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[11,444]'
			--		,@ID_SINIFs		VARCHAR(MAX)= '[0,101677,101671,101679,101672,101676,101680]'
			--		,@ID_DERSs		VARCHAR(MAX)= '[942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 2
			--		,@ID_KADEME3	INT			= 18
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			DROP TABLE IF EXISTS ##TblOkul

		

			SELECT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,VD.ID_DERS,VD.DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A,BOLUMNO
			INTO	#TEMP_OKUL
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.ID_SINAV			= SO.ID_SINAV
																AND SK.AD				= SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
			JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (SD.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs ='[]')		
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	


			
			DROP TABLE IF EXISTS #OKUL_DYB
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE		,COUNT(DURUM) DURUMSAYISI,DURUM ,0 OGRSAY,SORUNO_A,BOLUMNO
			INTO #OKUL_DYB 
			FROM #TEMP_OKUL T
			GROUP BY KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			--SELECT * FROM #OKUL_DYB 
		
			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#OKUL_DYB S
			JOIN    (
			SELECT KOD,ID_SUBE,SUM(DURUMSAYISI) OGRSAY FROM #OKUL_DYB
			GROUP BY KOD,ID_SUBE) AS G ON G.ID_SUBE=S.ID_SUBE AND (G.KOD=S.KOD OR (G.KOD IS NULL AND S.KOD IS NULL))
	

			DROP TABLE IF EXISTS #OKUL
			SELECT *
				, CAST((	SELECT CAST(SUM(DURUMSAYISI) AS DECIMAL(8,2))/OGRSAY*100 
							FROM #OKUL_DYB G 
							WHERE	G.DURUM		= S.DURUM 
								AND G.ID_SUBE	= S.ID_SUBE 
								AND G.KOD		= S.KOD 
								--AND G.SORUNO_A	= S.SORUNO_A  
								AND G.BOLUMNO	= S.BOLUMNO												
							group by g.OGRSAY
							) AS DECIMAL(8,2)
						) AS YUZDE
			INTO #OKUL
			FROM #OKUL_DYB S
			ORDER BY SORUNO_A


				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SUBEAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SUBEAD)+'=''-'' then null else '+QUOTENAME(SUBEAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD


			Set @SQL='	
				DROP TABLE IF EXISTS #TblOkul
				Select  KOD,ID_DERS,DERSAD,KAZANIM,MIN(SORUNO_A) SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into #TblOkul
				from (
					Select * from #OKUL WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR SUBEAD IN('+@Columns+')) as P1	
				GROUP BY KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

				INSERT INTO #TblOkul
				SELECT '''',0,'''',''ORTALAMA'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						,'+@Columns3+'
				FROM #TblOkul
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM

				SELECT	DISTINCT F.*
						,SORULIST	= ISNULL( (SELECT STUFF((SELECT   '' - '' + CAST(K.SORUNO_A AS VARCHAR)	FROM #OKUL K WHERE K.KOD = F.KOD AND K.ID_DERS = F.ID_DERS GROUP BY K.ID_DERS,K.SORUNO_A ORDER BY K.SORUNO_A FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 3, '''')),''-'')
				FROM #TblOkul F
				ORDER BY SORUNO_A
				
				DROP TABLE IF EXISTS #TblOkul
			'

			Select distinct ID_SUBE,SUBEAD,SUBEAD COL from #TEMP_OKUL ORDER BY SUBEAD

			PRINT @SQL
			EXEC (@SQL)


			--Select distinct ID_SUBE,SUBEAD,SUBEAD COL from #TEMP_OKUL ORDER BY SUBEAD
			--SELECT * FROM ##TblOkul ORDER BY BOLUMNO, SORUNO_A
		
		
			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			--DROP TABLE IF EXISTS ##TblOkul
		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Sube]    Script Date: 23.11.2021 15:34:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Sube]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
		@IP					VARCHAR(50)	= NULL
--,
	--@KADEME				VARCHAR(1)		= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			
			SELECT DISTINCT ID_KULLANICITIPI INTO #KULLANICITIPLER FROM OkyanusDB.[dbo].[v3Kullanici]		K
			INNER JOIN OkyanusDB.[dbo].[v3SubeYetki]							SY ON SY.TCKIMLIKNO=K.TCKIMLIKNO
			WHERE K.TCKIMLIKNO=@TCKIMLIKNO
			

			IF @ISLEM = 1	--	Şube Listele
			BEGIN
				IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
				BEGIN
					SELECT S.ID_SUBE, S.SUBENO, S.AD  FROM OkyanusDB.[dbo].[v3Sube] S
					ORDER BY S.AD
				END
				ELSE
				BEGIN 
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]			S
					LEFT JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY ON SY.ID_SUBE=S.ID_SUBE						
					where SY.TCKIMLIKNO = @TCKIMLIKNO
					ORDER BY S.AD
				END
			END

			IF @ISLEM = 2	--	Şube Listele by Kullanici
			BEGIN
				IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
				BEGIN
					SELECT S.ID_SUBE, S.SUBENO, S.AD  FROM OkyanusDB.[dbo].[v3Sube] S
					ORDER BY S.AD
				END
				ELSE
				BEGIN 
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]			S
					LEFT JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY ON SY.ID_SUBE=S.ID_SUBE						
					where SY.TCKIMLIKNO = @TCKIMLIKNO
					ORDER BY S.AD
				END
			END
			
			IF @ISLEM = 3	--	Şube Listele tüm şubeler
			BEGIN				
				SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
				from OkyanusDB.[dbo].[v3Sube]			S	
				ORDER BY S.AD
			END
			

			IF @ISLEM = 4	--	Şube Listele(+KUR) by Kullanici
			BEGIN
				IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
				BEGIN
					SELECT S.ID_SUBE, S.SUBENO, S.AD  FROM OkyanusDB.[dbo].[v3Sube] S
					ORDER BY S.AD
				END
				ELSE
				BEGIN 
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]			S
					LEFT JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY ON SY.ID_SUBE=S.ID_SUBE						
					where SY.TCKIMLIKNO = @TCKIMLIKNO
				UNION
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]	S
					JOIN eokul_v2.DBO.KurSinifi		KS	ON	KS.ID_SUBE = S.ID_SUBE
					JOIN v3Ogretmen					OG	ON	OG.ID_OGRETMEN = KS.ID_DANISMAN
					where	OG.TCKIMLIKNO = @TCKIMLIKNO
						AND DONEMKOD = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
					ORDER BY AD
				END
			END

			DROP TABLE IF EXISTS #KULLANICITIPLER
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Takvim]    Script Date: 23.11.2021 15:35:08 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Takvim]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TAKVIM					VARCHAR(MAX)	= NULL,
	@RENK					VARCHAR(7)		= NULL,
	@ID_TAKVIM				INT				= NULL,
	@ID_KULLANICITIPI		INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@JSONKULLANICITIPI		VARCHAR(MAX)	= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ACIKLAMA				VARCHAR(MAX)	= NULL,
	@BAS_TARIH				VARCHAR(MAX)	= NULL,
	@BIT_TARIH				VARCHAR(MAX)	= NULL,
	@ID_TAKVIMETKINLIK		INT				= NULL,
	@ID_TAKVIMS				VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@ID_TATIL				INT				= NULL,
	@IP					VARCHAR(50)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM				
			,TCKIMLIKNO						= @TCKIMLIKNO			
			,OTURUM							= @OTURUM				
			,ID_MENU						= @ID_MENU			
			,TAKVIM							= @TAKVIM				
			,RENK							= @RENK				
			,ID_TAKVIM						= @ID_TAKVIM			
			,ID_KULLANICITIPI				= @ID_KULLANICITIPI	
			,ID_KADEME3						= @ID_KADEME3			
			,JSONKULLANICITIPI				= @JSONKULLANICITIPI	
			,AD								= @AD					
			,ACIKLAMA						= @ACIKLAMA			
			,BAS_TARIH						= @BAS_TARIH			
			,BIT_TARIH						= @BIT_TARIH			
			,ID_TAKVIMETKINLIK				= @ID_TAKVIMETKINLIK	
			,ID_TAKVIMS						= @ID_TAKVIMS			
			,SQLJSON						= @SQLJSON			
			,ID_TATIL						= @ID_TATIL			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP

		IF @ID_LOG > 1
		BEGIN
			SET LANGUAGE Turkish;

			IF @ISLEM = 1	--	Takvim Listele
			BEGIN
				SELECT
				(
					SELECT T.ID_TAKVIM, T.AD, CAST(COUNT(TE.ID_TAKVIMETKINLIK) AS VARCHAR) + ' adet etkinlik var' AS ETKINLIKSAYISI, T.RENK
					FROM [dbo].[Takvim] T
					LEFT JOIN TakvimEtkinlik TE ON TE.ID_TAKVIM=T.ID_TAKVIM AND (TE.AKTIF IS NULL OR TE.AKTIF=1)
					WHERE T.AKTIF=1
					GROUP BY T.ID_TAKVIM, T.AD, T.RENK
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 2	--	Takvim Ekle
			BEGIN
				INSERT INTO [dbo].[Takvim]
						   ([AD]
						   ,[RENK]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@TAKVIM
						   ,@RENK
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 3	--	Takvim Sil
			BEGIN
				UPDATE Takvim SET AKTIF = 0, SIL_TARIH=GETDATE(), SIL_TCKIMLIKNO=@TCKIMLIKNO WHERE ID_TAKVIM = @ID_TAKVIM
			END

			IF @ISLEM = 4	--	Kullanıcı Tipi Listele
			BEGIN
				SELECT
				(
					SELECT KT.ID_KULLANICITIPI, AD, CASE WHEN TY.ID_KULLANICITIPI IS NULL THEN 0 ELSE 1 END AS SELECTED FROM OkyanusDB.dbo.v3KullaniciTipi KT
					LEFT JOIN TakvimYetki TY ON TY.ID_KULLANICITIPI=KT.ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					GROUP BY KT.ID_KULLANICITIPI, AD, TY.ID_KULLANICITIPI
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 5	--	Kademe3 Listele
			BEGIN
				SELECT
				(
					SELECT K3.ID_KADEME3, AD, CASE WHEN TY.ID_KADEME3 IS NULL THEN 0 ELSE 1 END SELECTED FROM OkyanusDB.dbo.v3Kademe3 K3
					LEFT JOIN TakvimYetki TY ON TY.ID_KADEME3=K3.ID_KADEME3 AND TY.ID_KULLANICITIPI=@ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 6	--	Takvim Yetki Ekle
			BEGIN
				DELETE FROM TakvimYetki WHERE ID_TAKVIM = @ID_TAKVIM

				INSERT INTO [dbo].[TakvimYetki]
						   ([ID_TAKVIM]
						   ,[ID_KULLANICITIPI]
						   ,[ID_KADEME3]
						   ,[KYE_TCKIMLIKNO])
				SELECT @ID_TAKVIM, ID_KULLANICITIPI, ID_KADEME3, @TCKIMLIKNO
				FROM OPENJSON(@JSONKULLANICITIPI)
				WITH(ID_KULLANICITIPI INT, ID_KADEME3 INT, SELECTED BIT)
				WHERE SELECTED = 1
			END

			IF @ISLEM = 7	--	Takvim Etkinlik Listele
			BEGIN
				SELECT
				(
					SELECT	ID_TAKVIMETKINLIK
							,AD
							,ACIKLAMA
							,CONVERT(VARCHAR, BAS_TARIH, 104) AS BAS_TARIH
							,CONVERT(VARCHAR, BIT_TARIH, 104) AS BIT_TARIH 
					FROM TakvimEtkinlik 
					WHERE ID_TAKVIM=@ID_TAKVIM AND AKTIF=1 
					ORDER BY ID_TAKVIMETKINLIK DESC
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 8	--	Takvim Etkinlik Ekle
			BEGIN
				INSERT INTO [dbo].[TakvimEtkinlik]
						   ([ID_TAKVIM]
						   ,[AD]
						   ,[ACIKLAMA]
						   ,[BAS_TARIH]
						   ,[BIT_TARIH]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@ID_TAKVIM
						   ,@AD
						   ,@ACIKLAMA
						   ,CONVERT(date,@BAS_TARIH,104)
						   ,CONVERT(date,@BIT_TARIH,104)
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 9	--	Takvim Etkinlik Sil
			BEGIN
				UPDATE TakvimEtkinlik SET AKTIF = 0, SIL_TARIH = GETDATE(), SIL_TCKIMLIKNO = @TCKIMLIKNO WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 10	--	Takvim Etkinlik Güncelle
			BEGIN
				UPDATE TakvimEtkinlik SET AD = @AD, ACIKLAMA = @ACIKLAMA, BAS_TARIH = CONVERT(date,@BAS_TARIH,104), BIT_TARIH = CONVERT(date,@BIT_TARIH,104) WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 11	--	Duyuru Listele
			BEGIN
				CREATE TABLE #DUYURULAR (ID_DUYURUV2 INT, BASLIK VARCHAR(MAX), ICERIK VARCHAR(MAX), FOTOGRAF VARCHAR(MAX), TARIH VARCHAR(MAX), BANNER VARCHAR(MAX), EKDOSYA VARCHAR(MAX), FOTOGRAF_MOBIL VARCHAR(MAX))

				DECLARE @ID_KULLANICI INT = (SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);
				--DECLARE @OTURUM2 VARCHAR(MAX) = (SELECT OTURUM FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);

				INSERT INTO #DUYURULAR
				EXEC eokul_v2.dbo.spDuyuruAnasayfa @ID_KULLANICI= @ID_KULLANICI, @OTURUM=@OTURUM

				SELECT
				(
					SELECT * FROM #DUYURULAR
					FOR JSON PATH
				) AS J

				DROP TABLE #DUYURULAR
			END

			IF @ISLEM = 12	--	Takvim Getir
			BEGIN
				DECLARE @DATE DATE = CONVERT(DATE, @BAS_TARIH, 104), @FIRSTDAY DATE, @LASTDAY DATE, @FIRSTWEEKDAY INT, @LASTWEEKDAY INT, @STARTDATE DATETIME, @ENDDATE DATETIME

				SELECT @FIRSTDAY = DATEADD(MONTH, DATEDIFF(MONTH, 0, @DATE), 0)
				SELECT @LASTDAY  = DATEADD(S, -1, DATEADD(MM, DATEDIFF(M, 0, @DATE) + 1, 0))

				SELECT @FIRSTWEEKDAY = DATEPART(DW, @FIRSTDAY)
				SELECT @LASTWEEKDAY  = DATEPART(DW, @LASTDAY)


				SELECT @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, @FIRSTWEEKDAY - 1	, @FIRSTDAY), 0)
				SELECT @ENDDATE	  = DATEADD(DAY, DATEDIFF(DAY, -(7 - @LASTWEEKDAY)	, @LASTDAY ), 0)

				;WITH DateList
				AS
				(
				SELECT @STARTDATE [Date]
				UNION ALL
				SELECT [Date] + 1 FROM DateList WHERE [Date] < @ENDDATE
				)
				SELECT [Date] = CAST([Date] AS DATE) INTO #DateList FROM DateList option (maxrecursion 0);
				
				IF @ID_KULLANICITIPI NOT IN (4,5) AND (4 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO) AND 5 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO))
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								 SELECT DISTINCT TE.AD						AS 'AD'
								,TE.ACIKLAMA								AS 'ACIKLAMA'
								,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
								,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
								,T.RENK										AS 'RENK'
								,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
								,TE.ID_TAKVIM								AS 'ID_TAKVIM'
								,ISNULL((SELECT STUFF((SELECT   ', ' + CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
												LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
													AND  ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')),
										(SELECT STUFF((SELECT   ', ' + KT.AD
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))) 
								AS 'YETKI'

								--,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								--INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								--INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								--LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
								--LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									--AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									
									--AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,D.DERSAD + ' - (' + O.BASLIK + ')' AS AD
										,'#0000FF' AS RENK
										,'0' AS TC_OGRENCI
								FROM		OdevSinifOgrenci	OSO
								INNER JOIN	OdevSinif			OS	ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev				O	ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders	D	ON D.ID_DERS = O.ID_DERS
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF = 1
								AND O.KYE_KULLANICI = @TCKIMLIKNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,D.DERSAD + ' - (' + E.ETUT + ')' AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E					
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= E.TC_OGRETMEN
								WHERE	E.TC_OGRETMEN	= @TCKIMLIKNO
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								SELECT DISTINCT 
										 TE.AD										AS 'AD'
										,TE.ACIKLAMA								AS 'ACIKLAMA'
										,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
										,T.RENK										AS 'RENK'
										,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
										,TE.ID_TAKVIM								AS 'ID_TAKVIM'
										,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = TY.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									AND ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
									AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + O.BASLIK + ')' ELSE D.DERSAD + ' - (' + O.BASLIK + ')' END AS AD
										,'#0000FF' AS RENK
										,CASE WHEN O.ID_ODEVTUR = 5 THEN OSO.TCKIMLIKNO ELSE '0' END AS TC_OGRENCI
								FROM OdevSinifOgrenci					OSO
								INNER JOIN	OdevSinif					OS		ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev						O		ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders			D		ON D.ID_DERS = O.ID_DERS
								INNER JOIN	OkyanusDB.dbo.v3Kullanici	K		ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci		OG		ON OG.TCKIMLIKNO = @TCKIMLIKNO
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF=1
								AND (OSO.TCKIMLIKNO = @TCKIMLIKNO OR OSO.TCKIMLIKNO IN (SELECT TCKIMLIKNO_OGR FROM OkyanusDB.dbo.v3OgrenciVeli WHERE TCKIMLIKNO = @TCKIMLIKNO))
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + E.ETUT + ')' 
										ELSE D.DERSAD + ' - (' + E.ETUT + ')' 
									END AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E
								INNER JOIN	EtutOgrenci				EO	ON	EO.ID_ETUT		= E.ID_ETUT
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= EO.TC_OGRENCI
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci	OG	ON	OG.TCKIMLIKNO	= @TCKIMLIKNO
								WHERE	EO.TC_OGRENCI	= @TCKIMLIKNO
									AND EO.AKTIF		= 1
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				DROP TABLE #DateList
			END		

			IF @ISLEM = 13	--	TAKVİM ETKİNLİK EKLE EXCEL
			BEGIN
				INSERT INTO TakvimEtkinlik (ID_TAKVIM, AD, ACIKLAMA, BAS_TARIH, BIT_TARIH, KYE_TCKIMLIKNO)
				SELECT @ID_TAKVIM, AD, ACIKLAMA, BASLANGIC, BITIS, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
				WITH(
					AD VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					BASLANGIC VARCHAR(MAX),
					BITIS VARCHAR(MAX)
				)
			END	
			IF @ISLEM = 14 -- TATİL LİSTELE
			BEGIN
			
				SELECT 
					 ID
					,ADI
					,CONVERT(VARCHAR, BASLANGIC_TARIH, 104)	AS BASLANGIC_TARIH
					,CONVERT(VARCHAR, BITIS_TARIH, 104)		AS BITIS_TARIH 
				FROM Tatil 
				ORDER BY BASLANGIC_TARIH 			
			END 
			IF @ISLEM = 15 --TATİL EKLE
			BEGIN
				INSERT INTO Tatil (ADI,BASLANGIC_TARIH,BITIS_TARIH) 
				VALUES(@AD,@BAS_TARIH,@BIT_TARIH)
			END

			IF @ISLEM = 16 --TATİL Sil
			BEGIN
				DELETE FROM Tatil WHERE ID=@ID_TATIL
			END
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END

GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_TercihListeRapor]    Script Date: 23.11.2021 15:35:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_TercihListeRapor]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	--@DONEM					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @DONEM VARCHAR(MAX)	= NULL
	SELECT @DONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SUBELIST			= @ID_SUBELIST				
				,DONEM					= @DONEM	
				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	TERCİH LİSTESİ			
			BEGIN
				DROP TABLE IF EXISTS #HEDEF
				DROP TABLE IF EXISTS #OGRENCIHEDEF
							   
							   
				SELECT DISTINCT
					 H.TCKIMLIKNO
					--,T.*
					,T.PROGRAMKODU
					,T.UNIVERSITE
					,T.FAKULTE
					,T.BOLUM
					,SIRA	= ROW_NUMBER() OVER (PARTITION BY H.TCKIMLIKNO	ORDER BY H.ID_OGRENCIHEDEF) 
				INTO #HEDEF
				FROM OgrenciHedef				H
				JOIN OkyanusDB.DBO.v3OgrenciTum	O	ON	O.TCKIMLIKNO	= H.TCKIMLIKNO
													AND O.DONEM			= @DONEM--H.DONEM
				JOIN UniversiteTabanPuanlari	T	ON	T.PROGRAMKODU	= H.PROGRAMKODU
													AND T.YIL			= H.DONEM
													
				where	H.AKTIF = 1 
					--AND H.DONEM = @DONEM 
					AND O.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
					--and TCKIMLIKNO IN ('24107057040','10004955060','10006199714')
	
				--	SELECT * FROM #HEDEF ORDER BY TCKIMLIKNO,SIRA

				SELECT DISTINCT 
					 K.TCKIMLIKNO
					,K.AD
					,K.SOYAD
					,[KAMPÜS]	= SD.SUBEAD
					,SD.ID_KADEME3
					,GRUP		= SD.KADEME3
					,SD.SINIF				
					,H.PROGRAMKODU
					,H.UNIVERSITE
					,H.FAKULTE
					,H.BOLUM
					,H.SIRA
					,UNISIRA = 'ÜNİVERSİTE '	+ CAST(H.SIRA AS VARCHAR)
					,FAKSIRA = 'FAKÜLTE '		+ CAST(H.SIRA AS VARCHAR)
					,BOLSIRA = 'BÖLÜM '			+ CAST(H.SIRA AS VARCHAR)
					,PRKSIRA = 'PROGRAM KODU '	+ CAST(H.SIRA AS VARCHAR)
				INTO #OGRENCIHEDEF
				FROM #HEDEF							H
				JOIN OkyanusDB.dbo.vw_SinifOgrenci	SO	ON	SO.TCKIMLIKNO	= H.TCKIMLIKNO 
				JOIN OkyanusDB.DBO.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= SO.ID_SINIF
				JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO	= SO.TCKIMLIKNO
				WHERE	SD.DONEM	= @DONEM
					AND SD.ID_SINIF	> 0
					
				DECLARE @SQL	 NVARCHAR(MAX)
				DECLARE @colsSel NVARCHAR(MAX)

				DECLARE @colsUni NVARCHAR(MAX)
				DECLARE @colsFak NVARCHAR(MAX)
				DECLARE @colsBol NVARCHAR(MAX)
				DECLARE @colsPrK NVARCHAR(MAX)

				SET @colsSel = STUFF((	SELECT	  ',MAX(ISNULL(' +  QUOTENAME('PROGRAM KODU '	+  CAST(C.col AS VARCHAR) ) + ','''')) AS ' + QUOTENAME('PROGRAM KODU '	+  CAST(C.col AS VARCHAR) )
												+ ',MAX(ISNULL(' +  QUOTENAME('ÜNİVERSİTE '		+  CAST(C.col AS VARCHAR) ) + ','''')) AS ' + QUOTENAME('ÜNİVERSİTE '	+  CAST(C.col AS VARCHAR) )
												+ ',MAX(ISNULL(' +  QUOTENAME('FAKÜLTE '		+  CAST(C.col AS VARCHAR) ) + ','''')) AS ' + QUOTENAME('FAKÜLTE '		+  CAST(C.col AS VARCHAR) )
												+ ',MAX(ISNULL(' +  QUOTENAME('BÖLÜM '			+  CAST(C.col AS VARCHAR) ) + ','''')) AS ' + QUOTENAME('BÖLÜM '		+  CAST(C.col AS VARCHAR) )
									FROM (SELECT DISTINCT T.SIRA  AS col FROM #OGRENCIHEDEF T) c ORDER BY col FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')


				SET @colsPrK = STUFF((	SELECT ',' +  QUOTENAME('PROGRAM KODU '	+  CAST(C.col AS VARCHAR) )  FROM (SELECT DISTINCT T.SIRA  AS col FROM #OGRENCIHEDEF T) c ORDER BY col FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
				SET @colsUni = STUFF((	SELECT ',' +  QUOTENAME('ÜNİVERSİTE '	+  CAST(C.col AS VARCHAR) )  FROM (SELECT DISTINCT T.SIRA  AS col FROM #OGRENCIHEDEF T) c ORDER BY col FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
				SET @colsFak = STUFF((	SELECT ',' +  QUOTENAME('FAKÜLTE '		+  CAST(C.col AS VARCHAR) )  FROM (SELECT DISTINCT T.SIRA  AS col FROM #OGRENCIHEDEF T) c ORDER BY col FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
				SET @colsBol = STUFF((	SELECT ',' +  QUOTENAME('BÖLÜM '		+  CAST(C.col AS VARCHAR) )  FROM (SELECT DISTINCT T.SIRA  AS col FROM #OGRENCIHEDEF T) c ORDER BY col FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
								

				SET @SQL = 'SELECT	 DISTINCT 
									 TCKIMLIKNO
									,AD
									,SOYAD
									,[KAMPÜS]
									,ID_KADEME3
									,GRUP
									,SINIF
									,'+ @colsSel +'
							FROM #OGRENCIHEDEF		H
							PIVOT (MAX(PROGRAMKODU)		FOR PRKSIRA  IN('+ @colsPrK +') ) AS P
							PIVOT (MAX(UNIVERSITE)		FOR UNISIRA  IN('+ @colsUni +') ) AS P
							PIVOT (MAX(FAKULTE)			FOR FAKSIRA  IN('+ @colsFak +') ) AS P
							PIVOT (MAX(BOLUM)			FOR BOLSIRA  IN('+ @colsBol +') ) AS P
							GROUP BY TCKIMLIKNO, AD, SOYAD, [KAMPÜS], ID_KADEME3, GRUP, SINIF
							ORDER BY [KAMPÜS], ID_KADEME3, GRUP, AD, SOYAD'

				PRINT @SQL
				EXEC(@SQL)


			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_TestMaddeAnalizi]    Script Date: 23.11.2021 15:35:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_TestMaddeAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SINIFALANLIST		VARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ICDISOGRENCI		INT				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END	
		
		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )


		IF (@ISLEM = 1 OR @ISLEM = 2)  -- SINIF
		BEGIN
		
			IF @ICDISOGRENCI IS NULL 
				SET @ICDISOGRENCI = 0
			
			DROP TABLE IF EXISTS #ALTCEVAPLAR
			DROP TABLE IF EXISTS #ALTGRUP
			DROP TABLE IF EXISTS #DERECE
			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #USTCEVAPLAR
			DROP TABLE IF EXISTS #USTGRUP
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #SUBE
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #SINAV
			DROP TABLE IF EXISTS #SINIFALAN
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #TEMPDERS
			DROP TABLE IF EXISTS #GOSTERDERS
			DROP TABLE IF EXISTS #OGRBOLUM

			
			
			
			SELECT VALUE ID_SUBE  INTO #SUBE		FROM OPENJSON(@ID_SUBEs )
			SELECT VALUE ID_DERS  INTO #DERS		FROM OPENJSON(@ID_DERSs )
			SELECT VALUE ID_SINAV INTO #SINAV		FROM OPENJSON(@ID_SINAVs)
			SELECT VALUE ALAN	  INTO #SINIFALAN	FROM OPENJSON(@SINIFALANLIST)

			
			
			SELECT T.* 
			INTO #SINIFLIST
			FROM v3SinifTum	T
			JOIN v3Donem	D	ON	D.ID_DONEM	= T.ID_DONEM
			JOIN #SUBE		S	ON	S.ID_SUBE	= D.ID_SUBE
			WHERE	T.DONEM			= @OGRENCIDONEM
				AND @ICDISOGRENCI	IN (0,1)
				AND (	(SELECT COUNT(1) FROM #SINIFALAN) = 0
					OR	EXISTS (SELECT * FROM #SINIFALAN A WHERE T.AD LIKE '%'+ A.ALAN +'%')
					)



			--SELECT TOP 10 * FROM vw_SinavOgrenciSoru
			
			SELECT
				 ID_SINAV		= S.ID_SINAV
				,SINAVAD		= S.AD
				,SINAVTARIH		= CONVERT(VARCHAR,S.SINAVTARIH,103) 
				,TCKIMLIKNO		= OS.TCKIMLIKNO
				,ID_DERS		= SD.ID_DERS
				,DERSAD			= SD.TAKMAAD 
				,DOGRU			= OB.DOGRU
				,NET			= OB.NET
				,DURUM			= OS.DURUM
				,OGRENCICEVAP	= OS.CEVAP
				,DOGRUCEVAP		= SA.CEVAP--OS.DOGRUCEVAP
				,SORUNO_A		= OS.SORUNO_A	
				,BOLUMNO		= OB.BOLUMNO
				,OLCEKSINAVI	= S.OLCEKSINAVI 
				,KATSAYI		= SA.KATSAYI
				,OZNEL			= CAST(CASE WHEN S.OLCEKSINAVI = 1 AND SA.KATSAYI IS NOT NULL THEN 1 ELSE 0 END AS BIT)
				,PUAN			= OB.PUAN	
				,BILGI			= ISNULL(B.AD, '')
				,BILISSELSUREC	= ISNULL(BS.AD, '')
			INTO #TEMP_OGRENCI
			FROM Pusulam.dbo.Sinav					S	WITH (NOLOCK)		
			JOIN #SINAV								TS					ON	TS.ID_SINAV			= S.ID_SINAV
			JOIN Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN Pusulam.dbo.v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN #SINIFLIST							SL					ON	SL.ID_SINIF			= O.ID_SINIF
			JOIN #SUBE								TB					ON	TB.ID_SUBE			= O.ID_SUBE
			JOIN Pusulam.dbo.vw_SinavOgrenciBolum	OB					ON	OB.ID_SINAV			= S.ID_SINAV
																		AND OB.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= OB.ID_SINAVDERS
			JOIN Pusulam.dbo.vw_SinavOgrenciSoru	OS					ON	OS.ID_SINAV			= S.ID_SINAV
																		AND OS.TCKIMLIKNO		= SO.TCKIMLIKNO
																		AND OS.ID_SINAVDERS		= SD.ID_SINAVDERS
			JOIN Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																		AND SA.SORUNO_A			= OS.SORUNO_A
																		AND SA.ID_SINAVKITAPCIK	= OS.ID_SINAVKITAPCIK
			LEFT JOIN	Pusulam.dbo.Bilgi			B	WITH (NOLOCK)	ON	B.ID_BILGI			= SA.ID_BILGI
			LEFT JOIN	Pusulam.dbo.BilisselSurec	BS	WITH (NOLOCK)	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC														
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (S.OZEL			= 0		OR	@OZELSINAVGOR = 1)
				AND @ICDISOGRENCI	= 1
		UNION		
			SELECT
				 ID_SINAV		= S.ID_SINAV
				,SINAVAD		= S.AD
				,SINAVTARIH		= CONVERT(VARCHAR,S.SINAVTARIH,103) 
				,TCKIMLIKNO		= OS.TCKIMLIKNO
				,ID_DERS		= SD.ID_DERS
				,DERSAD			= SD.TAKMAAD 
				,DOGRU			= OB.DOGRU
				,NET			= OB.NET
				,DURUM			= OS.DURUM
				,OGRENCICEVAP	= OS.CEVAP
				,DOGRUCEVAP		= SA.CEVAP--OS.DOGRUCEVAP
				,SORUNO_A		= OS.SORUNO_A	
				,BOLUMNO		= OB.BOLUMNO
				,OLCEKSINAVI	= S.OLCEKSINAVI 
				,KATSAYI		= SA.KATSAYI
				,OZNEL			= CAST(CASE WHEN S.OLCEKSINAVI = 1 AND SA.KATSAYI IS NOT NULL THEN 1 ELSE 0 END AS BIT)
				,PUAN			= OB.PUAN	
				,BILGI			= ISNULL(B.AD, '')
				,BILISSELSUREC	= ISNULL(BS.AD, '')
			--INTO #TEMP_OGRENCI
			FROM Pusulam.dbo.Sinav					S	WITH (NOLOCK)		
			JOIN #SINAV								TS					ON	TS.ID_SINAV			= S.ID_SINAV
			JOIN Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV			
			JOIN Pusulam.dbo.v3Sube					SB	WITH (NOLOCK)	ON	CAST(SB.SUBENO AS INT)	= CAST(SO.SUBENO AS INT)
			JOIN #SUBE								TB					ON	TB.ID_SUBE			= SB.ID_SUBE
			JOIN Pusulam.dbo.vw_SinavOgrenciBolum	OB					ON	OB.ID_SINAV			= S.ID_SINAV
																		AND OB.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= OB.ID_SINAVDERS
			JOIN Pusulam.dbo.vw_SinavOgrenciSoru	OS					ON	OS.ID_SINAV			= S.ID_SINAV
																		AND OS.TCKIMLIKNO		= SO.TCKIMLIKNO
																		AND OS.ID_SINAVDERS		= SD.ID_SINAVDERS
			JOIN Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																		AND SA.SORUNO_A			= OS.SORUNO_A	
																		AND SA.ID_SINAVKITAPCIK	= OS.ID_SINAVKITAPCIK
			LEFT JOIN	Pusulam.dbo.Bilgi			B	WITH (NOLOCK)	ON	B.ID_BILGI			= SA.ID_BILGI
			LEFT JOIN	Pusulam.dbo.BilisselSurec	BS	WITH (NOLOCK)	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC														
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (S.OZEL			= 0		OR	@OZELSINAVGOR = 1)
				AND (@ICDISOGRENCI	= 0
					OR (	@ICDISOGRENCI	= 2  
						AND SUBSTRING(SO.SINIF,1,4) = 'OKY-'
						)
					)
			

			SELECT DISTINCT T.BOLUMNO 
			INTO #GOSTERDERS
			FROM #TEMP_OGRENCI	T
			JOIN #DERS			D	ON	D.ID_DERS =	T.ID_DERS


				DROP TABLE IF EXISTS #TEMP
				SELECT  DISTINCT DURUM, COUNT(DURUM) DURUMSAYISI,0 KISISAYISI, DERSAD, BOLUMNO, SORUNO_A, 0 CEVAPLAYANSAYISI, OZNEL
				INTO #TEMP
				FROM #TEMP_OGRENCI T
				GROUP BY BOLUMNO, SORUNO_A,DURUM, DERSAD, OZNEL

				UPDATE T
				SET	 KISISAYISI			=		 (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO)				
					,CEVAPLAYANSAYISI	= ISNULL((SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO AND DURUM != 'B'),0)
				FROM #TEMP T

				
				-- HİÇ DOĞRU YAPILMAMIŞSA
				INSERT INTO #TEMP (DURUM, DURUMSAYISI,KISISAYISI, DERSAD, BOLUMNO, SORUNO_A, CEVAPLAYANSAYISI, OZNEL)
				SELECT DISTINCT 'D', 0, T.KISISAYISI, T.DERSAD, T.BOLUMNO, T.SORUNO_A, 0, OZNEL
				FROM #TEMP T
				WHERE NOT EXISTS (
					SELECT DISTINCT BOLUMNO, SORUNO_A
					FROM #TEMP S
					WHERE DURUM = 'D'
						AND S.BOLUMNO = T.BOLUMNO
						AND S.SORUNO_A = T.SORUNO_A
				)
				
				DROP TABLE IF EXISTS #OGRENCIBOLUMNET
				SELECT DISTINCT TCKIMLIKNO,BOLUMNO, DOGRU AS NET, RN = 0, MAX_RN = 0 
				INTO #OGRENCIBOLUMNET
				FROM #TEMP_OGRENCI 

				UPDATE O 
				SET O.RN=G.RN2
				FROM #OGRENCIBOLUMNET O 
				JOIN (	SELECT D.BOLUMNO, D.TCKIMLIKNO, RN2 = ROW_NUMBER() OVER(PARTITION BY D.BOLUMNO ORDER BY D.NET DESC,D.TCKIMLIKNO)  
						FROM #OGRENCIBOLUMNET D
					) AS G	ON	G.TCKIMLIKNO	= O.TCKIMLIKNO 
							AND G.BOLUMNO		= O.BOLUMNO
				

				UPDATE O 
				SET O.MAX_RN = D.MAX_RN
				FROM #OGRENCIBOLUMNET O 
				JOIN (
					SELECT MAX(RN) MAX_RN , BOLUMNO
					FROM #OGRENCIBOLUMNET S 
					GROUP BY S.BOLUMNO 
				) AS D ON D.BOLUMNO = O.BOLUMNO
				
				--SELECT * FROM #OGRENCIBOLUMNET
				--ORDER BY RN,BOLUMNO
				--RETURN
				
				DROP TABLE IF EXISTS #OGRSAY
				SELECT BOLUMNO, OGRSAY = IIF( O.MAX_RN > 100, cast(O.MAX_RN * 27 / 100.0 as int) ,CAST(CAST(O.MAX_RN AS DECIMAL(8,2)) / 2 AS DECIMAL(8,2)))
				INTO #OGRSAY
				FROM #OGRENCIBOLUMNET O
				GROUP BY BOLUMNO, MAX_RN

				--DECLARE @OGRSAY INT = (SELECT TOP 1 cast(O.MAX_RN * 27 / 100.0 as int)  FROM #OGRENCIBOLUMNET O)

				DROP TABLE IF EXISTS #ALTGRUP
				SELECT O.* 
				INTO #ALTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN >= O.MAX_RN - S.OGRSAY + 1
					--	(	O.MAX_RN > 100	AND RN >= O.MAX_RN - S.OGRSAY + 1 )
					--OR	(	O.MAX_RN <= 100 AND RN > CAST(O.MAX_RN / 2 AS INT) )
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
								
				DROP TABLE IF EXISTS #USTGRUP
				SELECT O.* 
				INTO #USTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN <= S.OGRSAY
					--(	O.MAX_RN > 100  AND RN <= S.OGRSAY )
					--OR (	O.MAX_RN <= 100 AND RN <= CAST(O.MAX_RN / 2 AS INT))
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
			
				--SELECT * FROM #OGRSAY where bolumno = 1
				--SELECT * FROM #USTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #ALTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #TEMP_OGRENCI where bolumno = 1 and SORUNO_A = 1
				DROP TABLE IF EXISTS #DERECE
				SELECT DISTINCT O.BOLUMNO
					,O.SORUNO_A
					,O.DURUM
					,O.DERSAD
					,DOGRUCEVAP
					,DOGRUSAYISI	= ISNULL(T.DURUMSAYISI,0)
					,USTKISISAYISI	= COUNT(DISTINCT U.TCKIMLIKNO)
					,ALTKISISAYISI	= COUNT(DISTINCT A.TCKIMLIKNO)
					--,O.OLCEKSINAVI
					,ZORLUKDERECESI		= CONVERT(DECIMAL(8,2),	
											CASE WHEN O.OZNEL = 0 THEN	CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float) /	NULLIF(CAST((S.OGRSAY * 2) AS float),0.0)
												 ELSE					ISNULL(CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float)* O.KATSAYI /  NULLIF((	CAST((S.OGRSAY * 2) AS float) * O.KATSAYI),0.0),0.0)
											END
										)
					,AYIRICILIK			= CONVERT(DECIMAL(8,2),	CASE WHEN O.OZNEL = 0 THEN	CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  NULLIF(CAST(S.OGRSAY AS float),0.0)
																	 ELSE					ISNULL(CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float)* O.KATSAYI /  NULLIF((CAST(S.OGRSAY AS float) * O.KATSAYI),0.0),0)
																END
																)
					,VARYANS			= CONVERT(DECIMAL(8,2),0)
					,SAPMA				= CONVERT(DECIMAL(8,2),0)
					,T.KISISAYISI
					,T.CEVAPLAYANSAYISI
					,O.BILGI
					,O.BILISSELSUREC
				INTO #DERECE
				FROM #TEMP				T
				JOIN #TEMP_OGRENCI		O	ON	O.BOLUMNO		= T.BOLUMNO
											AND O.SORUNO_A		= T.SORUNO_A
											AND O.DURUM			= T.DURUM
				JOIN #OGRSAY			S	ON	S.BOLUMNO		= O.BOLUMNO
				LEFT JOIN #USTGRUP		U	ON	U.TCKIMLIKNO	= O.TCKIMLIKNO 
											AND U.BOLUMNO		= O.BOLUMNO
				LEFT JOIN #ALTGRUP		A	ON	A.TCKIMLIKNO	= O.TCKIMLIKNO
											AND A.BOLUMNO		= O.BOLUMNO
				WHERE O.DURUM = 'D' 
				GROUP BY O.BOLUMNO, O.SORUNO_A, O.DURUM, O.DERSAD, T.KISISAYISI, O.DOGRUCEVAP, T.DURUMSAYISI,T.CEVAPLAYANSAYISI, S.OGRSAY,O.OZNEL, O.KATSAYI, O.BILGI, O.BILISSELSUREC


				UPDATE #DERECE SET	
					 VARYANS			= ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)
					,SAPMA				= SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)))
					--,MADDEGUVENILIRLIK	= Convert(Decimal(8,2),isnull(AYIRICILIK*SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI))),0.00))


				-- HİÇ DOĞRU YAPILMAMIŞSA
				INSERT INTO #DERECE (BOLUMNO,SORUNO_A,DURUM,DERSAD,DOGRUCEVAP,DOGRUSAYISI,USTKISISAYISI,ALTKISISAYISI,ZORLUKDERECESI,AYIRICILIK,VARYANS,SAPMA,KISISAYISI,CEVAPLAYANSAYISI,BILGI,BILISSELSUREC)
				SELECT DISTINCT T.BOLUMNO, T.SORUNO_A, 'D', T.DERSAD, O.DOGRUCEVAP, 0, 0 , 0 ,0 ,0 ,0 ,0 ,T.KISISAYISI, 0 ,O.BILGI, O.BILISSELSUREC
				FROM #TEMP			T
				JOIN #TEMP_OGRENCI	O	ON	O.BOLUMNO		= T.BOLUMNO
										AND O.SORUNO_A		= T.SORUNO_A
										AND O.DURUM			= T.DURUM
				LEFT JOIN #DERECE	D	ON	D.BOLUMNO	= T.BOLUMNO
										AND	D.SORUNO_A	= T.SORUNO_A
				WHERE D.BOLUMNO IS NULL


				DROP TABLE IF EXISTS #USTCEVAPLAR
				SELECT O.TCKIMLIKNO,O.BOLUMNO,O.SORUNO_A, IIF(O.DURUM='B','BOS',O.OGRENCICEVAP) OGRENCICEVAP, U.TCKIMLIKNO UST_TC
				INTO #USTCEVAPLAR
				FROM #TEMP_OGRENCI		O
				JOIN #USTGRUP			U	ON	U.TCKIMLIKNO	= O.TCKIMLIKNO 
											AND U.BOLUMNO		= O.BOLUMNO
											
				DROP TABLE IF EXISTS #ALTCEVAPLAR
				SELECT O.TCKIMLIKNO,O.BOLUMNO,O.SORUNO_A,IIF(O.DURUM='B','BOS',O.OGRENCICEVAP) OGRENCICEVAP, A.TCKIMLIKNO ALT_TC
				INTO #ALTCEVAPLAR
				FROM #TEMP_OGRENCI		O
				JOIN #ALTGRUP			A	ON	A.TCKIMLIKNO	= O.TCKIMLIKNO 
											AND A.BOLUMNO		= O.BOLUMNO

											
			DECLARE @VARYANS FLOAT,@V1  FLOAT,@P FLOAT,@KR20 DECIMAL(8,4)

			SET @V1			= (SELECT CONVERT(DECIMAL(8,2),SUM(DOGRUSAYISI))/MAX(KISISAYISI) FROM #DERECE)				
			SET @VARYANS	= (SELECT SQUARE(SUM(CONVERT(DECIMAL(8,2),DOGRUSAYISI)-@V1)) / MAX(KISISAYISI) FROM #DERECE)
			SET @P			= (SELECT SUM(  (CAST(DOGRUSAYISI AS DECIMAL(8,2))/KISISAYISI)*ABS(1-CAST(DOGRUSAYISI AS DECIMAL(8,2))/KISISAYISI)  ) FROM #DERECE)
			SET @KR20		= (SELECT CONVERT(DECIMAL(8,4), (COUNT(1)/(COUNT(1)-1))*(1-(@P/NULLIF(@VARYANS, 0.0)))) FROM #DERECE)

			DROP TABLE IF EXISTS #TEMPDERS
			DROP TABLE IF EXISTS #OGRBOLUM
			--;WITH OGRBOLUM AS (
				SELECT DISTINCT 
					 TCKIMLIKNO
					,BOLUMNO
					,PUAN
					,NET
					,NETSIRA	= ROW_NUMBER() OVER(PARTITION BY BOLUMNO ORDER BY NET ) 
					,PUANSIRA	= ROW_NUMBER() OVER(PARTITION BY BOLUMNO ORDER BY PUAN) 
				INTO #OGRBOLUM
				FROM #TEMP_OGRENCI
			--)
			SELECT
				 O.OZNEL
				,O.BOLUMNO
				,SAPMA			= CAST((SELECT ISNULL( AVG(D.SAPMA) ,0)FROM #DERECE D WHERE D.BOLUMNO = O.BOLUMNO) AS DECIMAL(8,2))
				,KR20			= ISNULL(@KR20, 0)
				,ZORLUK			= CONVERT(DECIMAL(8,2),0)
				,AYIRICILIK		= CONVERT(DECIMAL(8,2),0)

				,MEDYAN			= CAST(CASE WHEN O.OZNEL = 1	THEN (SELECT TOP 1 S.PUAN	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO AND S.PUANSIRA	= MAX(B.PUANSIRA)/2)
								 								ELSE (SELECT TOP 1 S.NET	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO AND S.NETSIRA	= MAX(B.NETSIRA )/2)
								  END  AS  DECIMAL(8,2))
				,ORTALAMA		= CAST(CASE WHEN O.OZNEL = 1	THEN (SELECT AVG(S.PUAN)	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								 								ELSE (SELECT AVG(S.NET )	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								  END  AS  DECIMAL(8,2))
				,SINAVKATILIM	= ISNULL((SELECT DISTINCT KISISAYISI FROM #DERECE D WHERE D.BOLUMNO = O.BOLUMNO) ,0)
				,RANJ			= CAST(CASE WHEN O.OZNEL = 1	THEN (SELECT MAX(S.PUAN) - MIN(S.PUAN) FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								 								ELSE (SELECT MAX(S.NET ) - MIN(S.NET ) FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								  END  AS  DECIMAL(8,2))
				,SORUSAYISI		= (SELECT COUNT(DISTINCT G.SORUNO_A) FROM #TEMP G WHERE G.BOLUMNO = O.BOLUMNO) 
			INTO #TEMPDERS
			FROM #TEMP_OGRENCI	O
			JOIN #OGRBOLUM		B	ON	B.BOLUMNO = O.BOLUMNO
			GROUP BY O.BOLUMNO, O.OZNEL


			UPDATE T SET
				 ZORLUK		= CAST((SELECT (SUM(D.ZORLUKDERECESI	) * 1.0 / COUNT(1) /*SORUSAYISI*/)	FROM #DERECE D) AS DECIMAL(8,2))
				,AYIRICILIK = CAST((SELECT (SUM(D.AYIRICILIK		) * 1.0 / COUNT(1) /*SORUSAYISI*/)	FROM #DERECE D) AS DECIMAL(8,2))
				--,SORUSAYISI = (SELECT COUNT(DISTINCT D.SORUNO_A ) FROM #DERECE D WHERE D.BOLUMNO = T.BOLUMNO)
			FROM #TEMPDERS T

			SELECT ISNULL(SA.ID_BILGI, 0) AS ID_BILGI, ISNULL(SA.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC, COUNT(1) AS SAYI
			INTO #BILGIBILISSEL
			FROM SinavDers SD
			JOIN SinavAnahtar SA ON SA.ID_SINAVDERS = SD.ID_SINAVDERS 
			JOIN SinavKitapcik SK ON SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK
			WHERE SD.ID_SINAV = (SELECT TOP 1 ID_SINAV FROM #SINAV) AND SK.AD = 'A'
			GROUP BY SA.ID_BILGI, SA.ID_BILISSELSUREC
		
			SELECT *
			INTO #TEMPBB
			FROM (
				SELECT B.AD AS [BİLGİ - BİLİŞSEL SÜREÇ], BS.AD AS BILISSELSUREC, SAYI
				FROM #BILGIBILISSEL BB
				JOIN Bilgi B ON B.ID_BILGI = BB.ID_BILGI
				JOIN BilisselSurec BS ON BS.ID_BILISSELSUREC = BB.ID_BILISSELSUREC
			) AS pTablom
			PIVOT
			(
			SUM(SAYI)
			FOR BILISSELSUREC IN ([Hatırlama], [Anlama], [Uygulama], [Çözümleme], [Değerlendirme], [Yaratma])
			)
			AS Pvt

			IF (SELECT COUNT(1) FROM #TEMPBB) = 0
			BEGIN
				INSERT INTO #TEMPBB ([BİLGİ - BİLİŞSEL SÜREÇ], [Hatırlama], [Anlama], [Uygulama], [Çözümleme], [Değerlendirme], [Yaratma])
				SELECT AD, '', '', '', '', '', ''
				FROM Bilgi
			END

			DROP TABLE #BILGIBILISSEL

			IF @ISLEM = 1  -- JSON
			BEGIN			
				select(
					select * from(
						select 
						(	
							SELECT * ,
								case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
										when ZORLUKDERECESI < 0.35 then 'Zor'
										when ZORLUKDERECESI < 0.65 then 'Önerilen'
										when ZORLUKDERECESI < 0.80 then 'Kolay'
										when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
								end as [ZORLUKACIKLAMA],
								case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     							when AYIRICILIK < 0.30 then 'Sınırda'
		   								when AYIRICILIK < 0.40 then 'İyi'
		     							when AYIRICILIK > 0.39 then 'Çok İyi' 
								end as [AYIRICILIKACIKLAMA]
							FROM #DERECE							
							WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblVeri,					
						(		
							SELECT	 BOLUMNO,SORUNO_A
									,A		= ISNULL(P.A,0)
									,B		= ISNULL(P.B,0)
									,C		= ISNULL(P.C,0)
									,D		= ISNULL(P.D,0)
									,E		= ISNULL(P.E,0)
									,BOS	= ISNULL(P.BOS,0)
									,TOPLAM	= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
							FROM (
								SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
								FROM #USTCEVAPLAR
								WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
								GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
							) AS G
							PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblUstList	,		
						(		
							SELECT	 BOLUMNO
									,SORUNO_A
									,A		= ISNULL(P.A,0)
									,B		= ISNULL(P.B,0)
									,C		= ISNULL(P.C,0)
									,D		= ISNULL(P.D,0)
									,E		= ISNULL(P.E,0)
									,BOS	= ISNULL(P.BOS,0)
									,TOPLAM	= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
							FROM (
								SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
								FROM #ALTCEVAPLAR
								WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
								GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
							) AS G
							PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblAltList,
						(
							SELECT DISTINCT SINAVAD,SINAVTARIH
							FROM #TEMP_OGRENCI 
							WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
							FOR JSON AUTO
						) as TblSinavOzellik,
						(							
							SELECT DISTINCT 
								 T.BOLUMNO
								,T.DERSAD
								,D.SORUSAYISI
								,D.SINAVKATILIM
								,D.ORTALAMA
								,D.SAPMA
								,D.MEDYAN
								,D.ZORLUK
								,D.AYIRICILIK
								,D.RANJ
								,D.KR20
							FROM #TEMP		T
							JOIN #TEMPDERS	D	ON	D.BOLUMNO = T.BOLUMNO
							WHERE T.BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
							ORDER BY BOLUMNO,DERSAD 
							FOR JSON PATH, INCLUDE_NULL_VALUES
						) as TblDersList,
						(	
							SELECT	 [ZORLUK_CZ]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.20								)
									,[ZORLUK_Z]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.35 AND S.ZORLUKDERECESI > 0.19 )
									,[ZORLUK_O]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.65 AND S.ZORLUKDERECESI > 0.34 )
									,[ZORLUK_K]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.80 AND S.ZORLUKDERECESI > 0.64 )
									,[ZORLUK_CK]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND								S.ZORLUKDERECESI > 0.79 )
																											   
									--,[AYIRICILIK_K] = (SELECT COUNT(1) FROM #DERECE S WHERE S.AYIRICILIK < 0							)
									,[AYIRICILIK_Z] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.20							)
									,[AYIRICILIK_S] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.30 AND S.AYIRICILIK > 0.19 )
									,[AYIRICILIK_I] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.40 AND S.AYIRICILIK > 0.29 )
									,[AYIRICILIK_CI]= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND							S.AYIRICILIK > 0.39 )
							FOR JSON PATH
						) as TblGrup,
						(
							SELECT *
							FROM #TEMPBB
							FOR JSON PATH
						) AS BilgiBilisselSurec
						
					) as tablo FOR JSON AUTO
				) as tt		

			END
			ELSE
			BEGIN
				SELECT * ,
					case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
							when ZORLUKDERECESI < 0.35 then 'Zor'
							when ZORLUKDERECESI < 0.65 then 'Önerilen'
							when ZORLUKDERECESI < 0.80 then 'Kolay'
							when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
					end as [ZORLUKACIKLAMA],
					case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     				when AYIRICILIK < 0.30 then 'Sınırda'
		   					when AYIRICILIK < 0.40 then 'İyi'
		     				when AYIRICILIK > 0.39 then 'Çok İyi' 
					end as [AYIRICILIKACIKLAMA]
				FROM #DERECE
				WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
				ORDER BY BOLUMNO,SORUNO_A
				
				SELECT	 BOLUMNO,SORUNO_A
						,A	= ISNULL(P.A,0)
						,B	= ISNULL(P.B,0)
						,C	= ISNULL(P.C,0)
						,D	= ISNULL(P.D,0)
						,E	= ISNULL(P.E,0)
						,BOS= ISNULL(P.BOS,0)
						,TOPLAM= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
				FROM (
					SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
					FROM #USTCEVAPLAR
					WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
					GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
				) AS G
				PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
				ORDER BY BOLUMNO,SORUNO_A

				SELECT	 BOLUMNO,SORUNO_A
						,A	= ISNULL(P.A,0)
						,B	= ISNULL(P.B,0)
						,C	= ISNULL(P.C,0)
						,D	= ISNULL(P.D,0)
						,E	= ISNULL(P.E,0)
						,BOS= ISNULL(P.BOS,0)
						,TOPLAM= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
				FROM (
					SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
					FROM #ALTCEVAPLAR
					WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
					GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
				) AS G
				PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
				ORDER BY BOLUMNO,SORUNO_A

				SELECT DISTINCT SINAVAD,SINAVTARIH
				FROM #TEMP_OGRENCI 				
				WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
								
				
				SELECT DISTINCT 
					 T.BOLUMNO
					,T.DERSAD
					,D.SORUSAYISI
					,D.SINAVKATILIM
					,D.ORTALAMA
					,D.SAPMA
					,D.MEDYAN
					,D.ZORLUK
					,D.AYIRICILIK
					,D.RANJ
					,D.KR20
				FROM #TEMP		T
				JOIN #TEMPDERS	D	ON	D.BOLUMNO = T.BOLUMNO
				WHERE T.BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
				ORDER BY BOLUMNO,DERSAD 
								
				SELECT	 [ZORLUK_CZ]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.20								)
						,[ZORLUK_Z]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.35 AND S.ZORLUKDERECESI > 0.19 )
						,[ZORLUK_O]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.65 AND S.ZORLUKDERECESI > 0.34 )
						,[ZORLUK_K]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.80 AND S.ZORLUKDERECESI > 0.64 )
						,[ZORLUK_CK]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND								S.ZORLUKDERECESI > 0.79 )
																											   
						--,[AYIRICILIK_K] = (SELECT COUNT(1) FROM #DERECE S WHERE S.AYIRICILIK < 0							)
						,[AYIRICILIK_Z] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.20							)
						,[AYIRICILIK_S] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.30 AND S.AYIRICILIK > 0.19 )
						,[AYIRICILIK_I] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.40 AND S.AYIRICILIK > 0.29 )
						,[AYIRICILIK_CI]= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND							S.AYIRICILIK > 0.39 )
				

				SELECT * 
				FROM #TEMPBB			
			END
			
			DROP TABLE IF EXISTS #TEMPBB
			DROP TABLE IF EXISTS #ALTCEVAPLAR
			DROP TABLE IF EXISTS #ALTGRUP
			DROP TABLE IF EXISTS #DERECE
			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #USTCEVAPLAR
			DROP TABLE IF EXISTS #USTGRUP
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #SUBE
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #SINAV
			DROP TABLE IF EXISTS #SINIFALAN
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #TEMPDERS
			DROP TABLE IF EXISTS #GOSTERDERS
			DROP TABLE IF EXISTS #OGRBOLUM


		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_TopluSinavSonuclari]    Script Date: 23.11.2021 15:36:04 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_TopluSinavSonuclari]
	@ISLEM			INT				= NULL,
	@TCKIMLIKNO		VARCHAR(11)		= NULL,
	@TC_OGRENCI		VARCHAR(MAX)	= '[]',
	@OTURUM			VARCHAR(36)		= NULL,
	@ID_MENU		INT				= NULL,
	@ID_SINAV		INT				= NULL,
	@ID_SUBE		VARCHAR(MAX)	= '[]',
	@ID_SINIF		VARCHAR(MAX)	= '[]',
		@IP					VARCHAR(50)	= NULL

AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM					= @ISLEM		
			,TCKIMLIKNO				= @TCKIMLIKNO	
			,TC_OGRENCI				= @TC_OGRENCI	
			,OTURUM					= @OTURUM		
			,ID_MENU				= @ID_MENU	
			,ID_SINAV				= @ID_SINAV	
			,ID_SUBE				= @ID_SUBE	
			,ID_SINIF				= @ID_SINIF	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

declare 
	 @sISLEM			INT				= @ISLEM		
	,@sTCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO
	,@sTC_OGRENCI		VARCHAR(MAX)	= @TC_OGRENCI
	,@sOTURUM			VARCHAR(36)		= @OTURUM	
	,@sID_MENU			INT				= @ID_MENU	
	,@sID_SINAV			INT				= @ID_SINAV	
	,@sID_SUBE			VARCHAR(MAX)	= @ID_SUBE	
	,@sID_SINIF			VARCHAR(MAX)	= @ID_SINIF		


BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		
--	exec [sp_TopluSinavSonuclari] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='CFA249F9-6FA9-46BF-AC6B-0896681CD805',@ID_MENU= 1031,@ID_SINAV=43,@ID_SUBE='[444]',@ID_SINIF='[102077]',@TC_OGRENCI='[17978633802,23210156572]'

	IF @ID_LOG > 1
	BEGIN
		IF (@sISLEM = 1 OR @sISLEM = 2)	--	TOPLU SINAV SONUÇLARI
		BEGIN
		
			DROP TABLE IF EXISTS #PUAN
			DROP TABLE IF EXISTS #KONU
			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #RE
			DROP TABLE IF EXISTS #GRAFIK
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			--DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #ALINANBURS
			DROP TABLE IF EXISTS #BurslulukSinavOgrenci
			DROP TABLE IF EXISTS #BURSOGRENCI
			DROP TABLE IF EXISTS #OGRENCIBURS

			DECLARE @GENEL INT = 999

			SELECT   distinct
					 B.TCKIMLIKNO
					,B.DOGRU
					,B.YANLIS
					,B.BOS
					,B.NET
					,YUZDENET
					,O.ID_SINAV
					,ID_SINIF	= ISNULL(VO.ID_SINIF,0) 
					,ID_SUBE	= ISNULL(VO.ID_SUBE,0) 
					,D.ID_DERS
					,D.TAKMAAD DERSAD
					,O.AD +' ' +O.SOYAD ADSOYAD
					,VS.ILCE ILCE
					,VS.IL IL
					,VS.AD SUBEAD
					,O.SINIF
					,B.PUAN
					,S.OLCEKSINAVI
					,(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=B.ID_SINAVKITAPCIK ) TOPLAMSORU
					,d.BOLUMNO
					,D.ID_SINAVDERS
					,O.SUBENO
			INTO #PUAN
			FROM vw_SinavOgrenciBolum	B
			JOIN Sinav					S	ON	S.ID_SINAV		= B.ID_SINAV
			JOIN SinavDers				D	ON	D.ID_SINAVDERS	= B.ID_SINAVDERS
			JOIN SinavOgrenci			O	ON	O.TCKIMLIKNO	= B.TCKIMLIKNO	
											AND O.ID_SINAV		= B.ID_SINAV	
											AND O.KITAPCIK		= B.KITAPCIK
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT) = CAST(O.SUBENO AS INT)
			LEFT JOIN V3Ogrenci			VO	ON	VO.TCKIMLIKNO	= O.TCKIMLIKNO
			WHERE B.ID_SINAV = @ID_SINAV

			--SELECT * FROM #PUAN

			--	INTO #KONU
			SELECT	O.TCKIMLIKNO,
					count(DISTINCT c.SORUNO_A) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=B.ID_SINAVKITAPCIK) TOPLAMSORU,
					o.ID_SINAV
					,b.BOLUMNO
					,(	SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR) 
						FROM SinavOgrenci K WITH(NOLOCK) 
						INNER JOIN SinavDosya D ON D.ID_SINAVDOSYA = K.ID_SINAVDOSYA
						WHERE K.TCKIMLIKNO = o.TCKIMLIKNO and k.ID_SINAV = o.ID_SINAV 
						ORDER BY D.OTURUM
						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
			into #KONU
			from SinavOgrenci			o
			JOIN v3Sube					S	ON	CAST(S.SUBENO AS INT)	= CAST(O.SUBENO AS INT)
			LEFT JOIN V3Ogrenci			v	ON  v.TCKIMLIKNO			= o.TCKIMLIKNO
			JOIN vw_SinavOgrenciBolum	b	ON	B.TCKIMLIKNO			= O.TCKIMLIKNO 
											AND B.ID_SINAV				= O.ID_SINAV
											AND B.KITAPCIK				= O.KITAPCIK
			JOIN vw_SinavOgrenciSoru	c	ON	C.TCKIMLIKNO			= B.TCKIMLIKNO 
											AND C.ID_SINAVDERS			= B.ID_SINAVDERS
											AND C.ID_SINAVKITAPCIK		= B.ID_SINAVKITAPCIK
			JOIN SinavDers				d	ON	d.ID_SINAVDERS			= b.ID_SINAVDERS
											and d.ID_SINAV				= o.ID_SINAV					
			JOIN v3SinavDersUnite		u	ON  u.KOD					= C.KOD
			WHERE	(o.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')
				AND (S.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((V.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	or (@sID_SINIF	='[]' and o.SINIF LIKE 'OKY-%') )
				AND O.ID_SINAV=@sID_SINAV
			GROUP BY c.DURUM,d.TAKMAAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,B.ID_SINAVKITAPCIK,O.TCKIMLIKNO,b.BOLUMNO
			ORDER BY d.TAKMAAD

			SELECT DISTINCT
					TCKIMLIKNO,
					KONUAD,
					DERSAD,
					KOD,					
					BOLUMNO,
					YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
					ISNULL(
						CAST(
							((100 
								/ NULLIF(
										CAST(
											(CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) 
										AS DECIMAL(11,2) 
									),0) )
								* CAST([D] AS INT) 
						) AS DECIMAL(11,2)) 
					,0) AS YUZDE,
					(	SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR) 
						FROM SinavOgrenci K WITH(NOLOCK) 
						INNER JOIN SinavDosya D ON D.ID_SINAVDOSYA = K.ID_SINAVDOSYA
						WHERE K.TCKIMLIKNO = p.TCKIMLIKNO and k.ID_SINAV = p.ID_SINAV 
						ORDER BY D.OTURUM
						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
			INTO #TT
			FROM ( SELECT * FROM #KONU  )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
			order by ID_SINAV,DERSAD,TOPLAMSORU,KOD
			
			---------------------------------------------------------- SORGULAR ------------------------------------------------------

			--SORGU 1
			SELECT	DISTINCT  
					 O.TCKIMLIKNO
					,O.AD+' '+O.SOYAD ADSOYAD
					,O.SINIF
					,VS.AD SUBEAD
					,S.AD SINAVAD
					,CONVERT(VARCHAR, S.SINAVTARIH ,105) SINAVTARIH
					,(	SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR) 
						FROM SinavOgrenci K WITH(NOLOCK) 
						INNER JOIN SinavDosya D ON D.ID_SINAVDOSYA = K.ID_SINAVDOSYA
						WHERE K.TCKIMLIKNO = SOT.TCKIMLIKNO and k.ID_SINAV = S.ID_SINAV 
						ORDER BY D.OTURUM
						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
					,OS.PUAN
					,PT.AD PUANTURU
					--,UPPER(ST.KISAAD+' SINAV SONUÇ BELGESİ') AS SINAVTURU
					,UPPER(S.RAPORBASLIK) AS SINAVTURU
					--,UPPER(ST.AD) AS SINAVTURUUZUN
					,'Testlerdeki Doğru ve Yanlış Sayıları' AS SINAVTURUUZUN
					,ST.ID_SINAVTURU
					,VD.ACIKLAMA+' Eğitim Öğretim Yılı' DONEM
					,OS.SINIFSIRA
					,OS.OKULSIRA
					,OS.ILCESIRA
					,OS.ILSIRA
					,OS.GENELSIRA
					,S.PUANGIZLE
					,SINIFKATILIM	= SOT.KATILIM_SINIF
					,SUBEKATILIM	= SOT.KATILIM_OKUL
					,ILCEKATILIM	= SOT.KATILIM_ILCE
					,ILKATILIM		= SOT.KATILIM_IL
					,GENELKATILIM	= SOT.KATILIM_GENEL
					,ID_KADEME		= ISNULL((SELECT TOP 1 ID_KADEME FROM v3KademeBilgi KB WHERE KB.ID_KADEME3 = S.ID_KADEME3),0)
			INTO #T1
			FROM SinavOgrenci		O
			JOIN Sinav				S	ON	S.ID_SINAV			= O.ID_SINAV
			JOIN SinavTuru			ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN SinavOgrenciToplam	SOT	ON	SOT.ID_SINAV		= O.ID_SINAV
										AND SOT.TCKIMLIKNO		= O.TCKIMLIKNO
		LEFT JOIN SinavOgrenciPuan	OS	ON	OS.ID_SINAV			= O.ID_SINAV
										AND OS.TCKIMLIKNO		= O.TCKIMLIKNO
		LEFT JOIN SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= OS.ID_SINAVPUANTURU	
		LEFT JOIN V3Ogrenci			VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO
			JOIN V3Sube				VS	ON	CAST(VS.SUBENO AS INT) = CAST(O.SUBENO AS INT)
			JOIN v3AktifDonem		VD	ON  VD.DONEM			= S.DONEM
			JOIN SinavKitapcik		K	ON	K.ID_SINAV			= O.ID_SINAV
										AND	K.AD				= O.KITAPCIK
			WHERE	(o.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI	='[]')
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((VO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF))) or (@sID_SINIF	='[]' and o.SINIF LIKE 'OKY-%') )
				AND	O.ID_SINAV		= @sID_SINAV
			ORDER BY SUBEAD,SINIF,ADSOYAD

			--SORGU 2
			SELECT DISTINCT  P.TCKIMLIKNO,P.DERSAD,TOPLAMSORU,P.DOGRU,P.YANLIS,P.BOS,P.NET
				,P.PUAN,P.OLCEKSINAVI

				,SINIFNETORTALAMA	= OB.NET_SINIFORT
				,SINIFDOGRUORTALAMA	= OB.DOGRU_SINIFORT
				,GENELDOGRUORTALAMA	= OB.DOGRU_GENELORT
				,YUZDEBASARI		= OB.YUZDENET

				--,RANK() over(partition by P.ID_DERS,P.ID_SINIF			order by p.NET desc)	SINIFSIRA
				--,RANK() over(partition by P.ID_DERS,P.ID_SUBE			order by p.NET desc)		OKULSIRA
				--,RANK() over(partition by P.ID_DERS,P.ILCE				order by p.NET desc)	ILCESIRA
				--,RANK() over(partition by P.ID_DERS,P.IL				order by p.NET desc)		ILSIRA
				--,RANK() over(partition by P.ID_DERS						order by p.NET desc)	GENELSIRA
				,SINIFSIRA	= OB.NET_SINIFSIRA
				,OKULSIRA	= OB.NET_OKULSIRA
				,ILCESIRA	= OB.NET_ILCESIRA
				,ILSIRA		= OB.NET_ILSIRA
				,GENELSIRA	= OB.NET_GENELSIRA

				,P.BOLUMNO
				,OB.ID_SINAV
			INTO #T2
			FROM #PUAN	P
			JOIN vw_SinavOgrenciBolum	OB	ON	OB.ID_SINAV		= P.ID_SINAV 
											AND OB.TCKIMLIKNO	= P.TCKIMLIKNO 
											AND OB.ID_SINAVDERS = P.ID_SINAVDERS
			JOIN SinavOgrenci			O	ON	O.TCKIMLIKNO	= OB.TCKIMLIKNO
											AND O.ID_SINAV		= OB.ID_SINAV	
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT) = CAST(O.SUBENO AS INT)	
			WHERE	(P.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((P.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF))) or (@sID_SINIF	='[]' and o.SINIF LIKE 'OKY-%') )
				AND P.ID_SINAV=@sID_SINAV

			INSERT INTO #T2			
			SELECT DISTINCT  T.TCKIMLIKNO,'TOPLAM',SUM(TOPLAMSORU), ST.TD,ST.TY,ST.TB,ST.TN
				,0 PUAN
				,T.OLCEKSINAVI
				
				,cast(avg(T.SINIFNETORTALAMA		 ) as decimal(8,2))	
				,cast(avg(T.SINIFDOGRUORTALAMA		 ) as decimal(8,2))	
				,cast(avg(T.GENELDOGRUORTALAMA		 ) as decimal(8,2))	
				,cast((ST.TN/SUM(TOPLAMSORU)*100.0	 ) as decimal(8,2))	

				,ST.TN_SINIFSIRA	
				,ST.TN_OKULSIRA
				,ST.TN_ILCESIRA
				,ST.TN_ILSIRA
				,ST.TN_GENELSIRA
				,@GENEL 
				,T.ID_SINAV
			FROM #T2 T
			JOIN SinavOgrenciToplam	ST	ON	ST.ID_SINAV		= T.ID_SINAV
										AND	ST.TCKIMLIKNO	= T.TCKIMLIKNO
			JOIN Sinav				S	ON	S.ID_SINAV		= T.ID_SINAV
			WHERE (SELECT TOP 1 ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = S.ID_KADEME3) = 4
			GROUP BY T.TCKIMLIKNO,T.OLCEKSINAVI, ST.TD,ST.TY,ST.TB,ST.TN
				,ST.TN_SINIFSIRA	
				,ST.TN_OKULSIRA
				,ST.TN_ILCESIRA
				,ST.TN_ILSIRA
				,ST.TN_GENELSIRA
				,T.ID_SINAV

			
			--SORGU 3
			SELECT DISTINCT O.TCKIMLIKNO,C.SORUNO,C.CEVAP OGRENCICEVAP,C.DOGRUCEVAP DOGRUCEVAP,DURUM,C.ID_SINAVDERS,D.TAKMAAD DERSAD,BOLUMNO
			INTO #T3
			FROM  vw_SinavOgrenciSoru	c	
			JOIN SinavOgrenci			O	ON	O.TCKIMLIKNO			= C.TCKIMLIKNO
											AND O.ID_SINAV				= C.ID_SINAV			
			JOIN SinavDers				D	ON	D.ID_SINAVDERS			= C.ID_SINAVDERS	
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT)	= CAST(O.SUBENO AS INT)	
		LEFT JOIN V3OGRENCi				VO  ON  VO.TCKIMLIKNO			= O.TCKIMLIKNO
			WHERE	(o.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI = '[]')		
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	= '[]')
				AND ((VO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	or (@sID_SINIF	= '[]' and o.SINIF LIKE 'OKY-%') )
				AND O.ID_SINAV=@sID_SINAV
			
			--SORGU 4

			
			SELECT	TCKIMLIKNO	= B.TCKIMLIKNO,
					DERSAD		= SD.TAKMAAD,
					OGRENCI		= B.YUZDENET,
					--ID_SINIF	= PO.ID_SINIF,
					SINIF		= YUZDENET_SINIFORT,
					GENEL		= YUZDENET_GENELORT,
					BOLUMNO		= SD.BOLUMNO
			INTO #GRAFIK
			FROM vw_SinavOgrenciBolum	B
			JOIN SinavDers				SD	ON	SD.ID_SINAVDERS = B.ID_SINAVDERS
			JOIN #PUAN					PO	ON	PO.TCKIMLIKNO	= B.TCKIMLIKNO 
											AND PO.DERSAD		= SD.TAKMAAD
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT)	= CAST(PO.SUBENO AS INT)			
			WHERE	B.ID_SINAV = @sID_SINAV 
				AND	(PO.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')	
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((PO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	OR(@sID_SINIF	= '[]' and PO.SINIF LIKE 'OKY-%') )		


		--	SELECT	YUZDENETORT	=CONVERT(DECIMAL(18,2),AVG(CONVERT(DECIMAL(18,2),YUZDENET))) ,					
		--			DERSAD		= DERSAD,
		--			ISLEM		= 'OGRENCI',
		--			DEGER		= CAST(TCKIMLIKNO AS VARCHAR(20)),
		--			BOLUMNO		= BOLUMNO
		--	INTO	#T4 
		--	FROM	#PUAN P
		--	WHERE	(TCKIMLIKNO IN (SELECT value FROM OPENJSON (@sTC_OGRENCI)) OR @sTC_OGRENCI ='[]')
		--		AND ID_SINAV=@sID_SINAV				
		--	GROUP BY ID_SINAV,TCKIMLIKNO,DERSAD,BOLUMNO
		--UNION ALL
		--	SELECT	CONVERT(DECIMAL(18,2),AVG(CONVERT(DECIMAL(18,2),YUZDENET)))YUZDENETORT,
		--			DERSAD,
		--			ISLEM='SINIF',
		--			DEGER=	CAST(ID_SINIF AS VARCHAR(20)) 
		--			,BOLUMNO
		--	FROM	#PUAN 
		--	WHERE	(ID_SINIF IN (SELECT value FROM OPENJSON (@sID_SINIF)) OR @sID_SINIF ='[]') AND ID_SINAV=@sID_SINAV				
		--	GROUP BY ID_SINAV,ID_SINIF,DERSAD,BOLUMNO
		--UNION ALL
		--	SELECT	CONVERT(DECIMAL(18,2),AVG(CONVERT(DECIMAL(18,2),YUZDENET)))YUZDENETORT,
		--			DERSAD,
		--			ISLEM='GENEL',
		--			'GENEL'  AS DEGER
		--			,BOLUMNO
		--	FROM	#PUAN 
		--	WHERE	ID_SINAV=@sID_SINAV			
		--	GROUP BY ID_SINAV,DERSAD,BOLUMNO
		--	ORDER BY DERSAD,ISLEM,DEGER	,BOLUMNO		

			--SORGU 5
			SELECT	TCKIMLIKNO,
					KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE 
					,BOLUMNO
					,KITAPCIK
			INTO	#T5
			FROM	#TT
			GROUP BY KOD,KONUAD,DERSAD,TCKIMLIKNO,BOLUMNO,KITAPCIK
		union all
			SELECT  TCKIMLIKNO,
					DERSAD,
					DERSAD,
					'',
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE 
					,BOLUMNO
					,KITAPCIK
			FROM	#TT
			GROUP BY DERSAD,TCKIMLIKNO,BOLUMNO,KITAPCIK
			order by TCKIMLIKNO,DERSAD,KOD
			--------------------------------------------------------------------------------------------------
			SELECT COUNT(ID_SINAVDERS) ASS 
			INTO #RE 
			FROM #T3 
			WHERE TCKIMLIKNO=(SELECT TOP 1 TCKIMLIKNO FROM #T3)
			GROUP BY ID_SINAVDERS

		
			--SELECT DISTINCT  PO.TCKIMLIKNO,T.DERSAD,T.YUZDENETORT OGRENCI,PO.ID_SINIF ,CAST(0 AS float) SINIF,CAST(0 AS float) GENEL,T.BOLUMNO
			--INTO #GRAFIK
			--FROM #T4	T
			--JOIN #PUAN  PO	ON	PO.TCKIMLIKNO=T.DEGER AND T.ISLEM='OGRENCI'  AND T.DERSAD = PO.DERSAD
			--JOIN V3Sube	VS	ON	CAST(VS.SUBENO AS INT)	= CAST(PO.SUBENO AS INT)									
			--WHERE	(PO.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')	
			--	AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
			--	AND ((PO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	or (@sID_SINIF	= '[]' and PO.SINIF LIKE 'OKY-%') )
			--	
			--UPDATE K
			--SET K.SINIF=T.YUZDENETORT
			--	,K.GENEL=T1.YUZDENETORT
			--FROM #GRAFIK		K 			
			--JOIN #T4	T	ON K.ID_SINIF=T.DEGER AND T.ISLEM='SINIF' AND T.DERSAD = K.DERSAD
			--JOIN #T4	T1	ON T1.ISLEM='GENEL'  AND T1.DERSAD = K.DERSAD



			
		SELECT TCKIMLIKNO,BURSORANI,ID_SINAVDERS,BURSTUR,ROW_NUMBER () OVER(ORDER BY BURSORANI DESC ,BURSTUR) RN
		INTO #BURSOGRENCI
		FROM BurslulukSinavOgrenciSonuc
		WHERE ID_SINAV = @sID_SINAV

		SELECT TCKIMLIKNO,MIN(RN) RN
		INTO #ALINANBURS
		FROM #BURSOGRENCI
		GROUP BY TCKIMLIKNO

		SELECT TCKIMLIKNO,MAX(ID_BURSOGRENCI) ID_BURSOGRENCI
		INTO #BurslulukSinavOgrenci
		FROM BurslulukSinavOgrenci 
		WHERE ID_SINAV	= @sID_SINAV
		GROUP BY TCKIMLIKNO
		
		SELECT BO.TCKIMLIKNO
			,BO.BURSORANI
			,BURSTUR
			,BURS_IDSINAVDERS	= ISNULL(SD.ID_SINAVDERS,0)
			,BURS_BOLUMNO		= ISNULL(SD.BOLUMNO,0)
			,BURS_DERSAD		= ISNULL(SD.TAKMAAD,'')
		INTO #OGRENCIBURS
		FROM #BURSOGRENCI	BO
		JOIN #ALINANBURS	AB	ON	AB.RN			= BO.RN
		LEFT JOIN SinavDers	SD	ON	SD.ID_SINAVDERS = BO.ID_SINAVDERS



			IF @sISLEM = 1						--JSON SEND
			BEGIN
					select(
						select * from(
							select 
							(						 
								SELECT * FROM #T1
								FOR JSON AUTO
							) as t1
							,( 
								SELECT * FROM #T2
								FOR JSON AUTO
							)as t2
							,(
								SELECT *,MAXSORU=(SELECT MAX (ASS) FROM #RE),DERSSAYISI=(SELECT COUNT (1) FROM #RE) FROM #T3 
								ORDER BY ID_SINAVDERS,SORUNO
								FOR JSON AUTO
							) as t3 
							,( 
								SELECT * FROM #GRAFIK
								ORDER BY ID_SINIF,TCKIMLIKNO					
								FOR JSON AUTO
							)as t4
							,(
								SELECT * FROM #T5
								ORDER BY DERSAD,KOD
								FOR JSON AUTO
							) as t5 
						) as tablo FOR JSON AUTO
					) as tt
			END
			
			IF @sISLEM = 2						--DATASET SEND
			BEGIN
				SELECT DISTINCT * FROM #T1

				SELECT DISTINCT * FROM #T2

				SELECT DISTINCT *,MAXSORU=(SELECT MAX (ASS) FROM #RE),DERSSAYISI=(SELECT COUNT (1) FROM #RE) FROM #T3 
				ORDER BY ID_SINAVDERS,SORUNO

				SELECT DISTINCT * FROM #GRAFIK				

				SELECT DISTINCT * FROM #T5
				ORDER BY DERSAD,KOD
				
				SELECT distinct TCKIMLIKNO, ADSOYAD, SINIF, SINAVAD, SINAVTARIH, KITAPCIK, SUBEAD, SINIFKATILIM, SUBEKATILIM, GENELKATILIM, SINAVTURU, PUANGIZLE, TCKIMLIKNO, ID_KADEME FROM #T1

				SELECT DISTINCT T.TCKIMLIKNO
						,BURS_DERSAD	= ISNULL(OB.BURS_DERSAD	,'')
						,BURSTUR		= ISNULL(OB.BURSTUR		,0)
						,BURSORANI		= ISNULL(OB.BURSORANI	,0)
				FROM	#PUAN						T
				LEFT JOIN #OGRENCIBURS				OB	ON	OB.TCKIMLIKNO		= T.TCKIMLIKNO
				LEFT JOIN #BurslulukSinavOgrenci	BS2	ON	BS2.TCKIMLIKNO		= T.TCKIMLIKNO 
				LEFT JOIN BurslulukSinavOgrenci		BSO	ON	BSO.ID_BURSOGRENCI	= BS2.ID_BURSOGRENCI 

			END
			
			DROP TABLE IF EXISTS #PUAN
			DROP TABLE IF EXISTS #KONU
			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #RE
			DROP TABLE IF EXISTS #GRAFIK
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			--DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #ALINANBURS
			DROP TABLE IF EXISTS #BurslulukSinavOgrenci
			DROP TABLE IF EXISTS #BURSOGRENCI
			DROP TABLE IF EXISTS #OGRENCIBURS

		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_TopluYaziliYoklamaSonuclari]    Script Date: 23.11.2021 15:36:17 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--EXEC	@return_value = [dbo].[sp_TopluYaziliYoklamaSonuclari]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_TopluYaziliYoklamaSonuclari]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVLAR		VARCHAR(MAX)	= '',
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ID_DERSLER			VARCHAR(MAX)	= '',
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= null,
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@ID_KADEME3			INT				= 0,
	@YARIYIL			VARCHAR(10)		= '',
		@IP					VARCHAR(50)	= NULL

)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAVLAR				= @ID_SINAVLAR
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ID_DERSLER					= @ID_DERSLER	
			,SINIFLAR					= @SINIFLAR	
			,ID_DERS					= @ID_DERS	
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
			,ID_KADEME3					= @ID_KADEME3	
			,YARIYIL					= @YARIYIL	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			
			DECLARE @SQL AS VARCHAR(max) 
			DECLARE @Columns AS VARCHAR(max) 
			DECLARE @Columns2 AS VARCHAR(max) 
			DECLARE @Columns3 AS VARCHAR(max) 

			IF @ISLEM = 1 OR @ISLEM = 2	--	Toplu Yazılı Yoklama Sunuçları Getir
			BEGIN
				SELECT sr.ID_SINAVRAPOR, 
					   sr.SINAVADI, 
					   su.AD						    AS KAMPUS, 
					   sn.AD                            AS SINIF, 
					   k.TCKIMLIKNO, 
					   k.AD + ' ' + k.SOYAD             AS ADSOYAD, 
					   Sum(oo.PUAN)                     AS PUAN 
				INTO   #tablo 
				FROM	   eokul_v2.dbo.SinavRapor		sr 
				INNER JOIN eokul_v2.dbo.OgrenciNot		oo ON oo.ID_SINAVRAPOR = sr.ID_SINAVRAPOR 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci		og ON og.ID_OGRENCI = oo.ID_OGRENCI 
				INNER JOIN OkyanusDB.dbo.v3Sube			su ON su.ID_SUBE = og.ID_SUBE 
				INNER JOIN OkyanusDB.dbo.v3Satislar		sa ON sa.ID_SOZLESME = og.ID_SOZLESME 
				INNER JOIN OkyanusDB.dbo.v3Sinif		sn ON sn.ID_SINIF = sa.ID_SINIF 
				INNER JOIN OkyanusDB.dbo.v3Kullanici	k ON k.TCKIMLIKNO = og.TCKIMLIKNO 
				INNER JOIN eokul_v2.dbo.Ders			d ON d.ID_DERS = sr.ID_DERS 
				WHERE  sr.DONEMKOD = @DONEM 
					   AND sr.isActive = 1 
					   AND k.AKTIF = 1 
					   AND ( ( sr.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
					   AND ( ( sr.ID_SINAVRAPOR	IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
					   AND ( ( su.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
					   AND ( ( og.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
					   AND ( sr.GRUP = (select AD from OkyanusDB.dbo.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3) OR @ID_KADEME3 = 0 ) 
					   AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				GROUP  BY sr.ID_SINAVRAPOR, 
						  sr.SINAVADI, 
						  su.AD, 
						  sn.AD, 
						  k.TCKIMLIKNO, 
						  k.AD, 
						  k.SOYAD 
				ORDER  BY sr.ID_SINAVRAPOR, 
						  sr.SINAVADI, 
						  su.AD, 
						  sn.AD, 
						  k.AD, 
						  k.SOYAD 

				SELECT @Columns = COALESCE(@Columns+',', '') + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_SINAVRAPOR FROM #tablo) AS b 
				ORDER  BY b.ID_SINAVRAPOR 

				SELECT @Columns2 = COALESCE(@Columns2+',', '') + 'ISNULL(' + Quotename(SINAVADI) + ',-1) AS ' + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_SINAVRAPOR FROM   #tablo) AS b 
				ORDER  BY b.ID_SINAVRAPOR 

				SET @SQL=';with PivotData as   
						  ( Select   KAMPUS,  
									 SINAVADI,  
									 SINIF,  
									 TCKIMLIKNO,  
									 ADSOYAD,  
									 PUAN 
							from #Tablo   
						  )   
						  Select     KAMPUS, 
									 SINIF, 
									 TCKIMLIKNO, 
									 ADSOYAD,    
									 ' + @Columns2 + '    
						  into #pivot    
						  from PivotData    
						  PIVOT    
						  ( 
							SUM(PUAN) 
							FOR SINAVADI IN(' + @Columns + ')    
						  ) as PivotResult    
						  ORDER BY KAMPUS,SINIF,ADSOYAD
						  '

				IF @ISLEM = 1 -- HTML
				BEGIN
					SET @SQL = @SQL + 'SELECT
									  (        
										  Select * from #pivot p
										  FOR JSON PATH, INCLUDE_NULL_VALUES   
									  ) AS J'
				END 
				ELSE IF @ISLEM = 2 -- DEVEXPRESS
				BEGIN
					SET @SQL = @SQL + 'Select * from #pivot p'
				END
				
				EXEC (@SQL) 
				DROP TABLE #tablo
			END 

			IF @ISLEM = 3	--	Yazılı Listele
			BEGIN
				SELECT
				(
					Select DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD, TARIH
					from eokul_v2.dbo.SinavRapor SR
					where sr.isActive=1 
					AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM OkyanusDb.dbo.v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
					AND (@ID_DERSLER IS NULL OR @ID_DERSLER='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER)))
					AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
					AND SR.isActive=1
					and sr.DONEMKOD=@DONEM
					order by TARIH
					FOR JSON PATH
				) AS J
				--SELECT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
				--INTO #TEMPX
				--FROM	eokul_v2.dbo.OgrenciNot		O			
				--INNER JOIN	eokul_v2.dbo.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
				--INNER JOIN    OkyanusDb.dbo.v3Ogrenci		VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
				--INNER JOIN	OkyanusDb.dbo.v3Kullanici	VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
				--WHERE	SR.DONEMKOD=@DONEM
				--	AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM OkyanusDb.dbo.v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
				--	AND (@ID_SINIFLAR IS NULL OR @ID_SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFLAR)))
				--	AND (@ID_DERSLER IS NULL OR @ID_DERSLER='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER)))
				--	AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				--	AND sr.isActive=1

				--SELECT DISTINCT * FROM #TEMPX
				--DROP TABLE #TEMPX
			END 

			IF @ISLEM = 4	--	Yazılı Listele Test
			BEGIN
				IF @ID_DERS IS NULL
				BEGIN
					SELECT
					(
						Select DISTINCT ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						where sr.AKTIF=1 
						AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (@ID_DERSLER IS NULL OR @ID_DERSLER='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER)))
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						where sr.AKTIF=1 
						AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			END 

			IF @ISLEM = 5 OR @ISLEM = 6	--	Toplu Yazılı Yoklama Sunuçları Getir YENİ
			BEGIN
				SELECT DISTINCT Y.ID_YAZILI
						,Y.AD					AS SINAVADI
						,SB.AD					AS KAMPUS
						,S.AD					AS SINIF
						,K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD	AS ADSOYAD
						,ISNULL(YO.TELAFI, Sum(YOC.PUAN))			AS PUAN 
				INTO #tabloY
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE		Y.DONEM = @DONEM 
							AND Y.AKTIF = 1 
							AND k.AKTIF = 1 
							AND ( ( Y.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
							AND ( ( Y.ID_YAZILI		IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
							AND ( ( SB.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
							AND ( ( S.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
							--AND ( Y.ID_KADEME3 = @ID_KADEME3 OR @ID_KADEME3 = 0 ) 
							AND (@YARIYIL IS NULL OR @YARIYIL=0 OR Y.YARIYIL LIKE '%'+@YARIYIL+'%')
				GROUP BY	Y.ID_YAZILI, 
							Y.AD, 
							SB.AD, 
							S.AD, 
							K.TCKIMLIKNO, 
							K.AD, 
							K.SOYAD,
							YO.TELAFI
				ORDER BY	Y.ID_YAZILI, 
							Y.AD, 
							SB.AD, 
							S.AD, 
							ADSOYAD


				SELECT @Columns = COALESCE(@Columns+',', '') + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_YAZILI FROM #tabloY) AS b 
				ORDER  BY b.ID_YAZILI 

				SELECT @Columns2 = COALESCE(@Columns2+',', '') + 'ISNULL(' + Quotename(SINAVADI) + ',-1) AS ' + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_YAZILI FROM   #tabloY) AS b 
				ORDER  BY b.ID_YAZILI 
				
				SELECT @Columns3 = COALESCE(@Columns3+',', '') + ' CASE WHEN ' + Quotename(SINAVADI) +' = -1 THEN ''-'' ELSE CAST(' + Quotename(SINAVADI) +' AS VARCHAR) END AS ' + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_YAZILI FROM   #tabloY) AS b 
				ORDER  BY b.ID_YAZILI

				SET @SQL=';with PivotData as   
						  ( Select   KAMPUS,  
									 SINAVADI,  
									 SINIF,  
									 TCKIMLIKNO,  
									 ADSOYAD,  
									 PUAN 
							from #tabloY 
						  )   
						  Select     KAMPUS, 
									 SINIF, 
									 TCKIMLIKNO, 
									 ADSOYAD,    
									 ' + @Columns2 + '    
						  into #pivotY    
						  from PivotData    
						  PIVOT    
						  ( 
							SUM(PUAN) 
							FOR SINAVADI IN(' + @Columns + ')    
						  ) as PivotResult    
						  ORDER BY KAMPUS,SINIF,ADSOYAD
						  '

				IF @ISLEM = 5 -- HTML
				BEGIN
					SET @SQL = @SQL + 'SELECT
									  (        
										  Select * from #pivotY p
										  FOR JSON AUTO, INCLUDE_NULL_VALUES   
									  ) AS J'
				END 
				ELSE IF @ISLEM = 6 -- DEVEXPRESS
				BEGIN
					SET @SQL = @SQL + 'Select KAMPUS, 
										SINIF, 
										TCKIMLIKNO, 
										ADSOYAD,    '+@Columns3+' from #pivotY p'
				END
				
				EXEC (@SQL) 
				DROP TABLE #tabloY
			END 
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_SinavHariciPuanSira]    Script Date: 23.11.2021 15:13:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_SinavHariciPuanSira]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@DOGRULAMA			VARCHAR(44)		= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL	,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,DOGRULAMA					= @DOGRULAMA	
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
 
	IF @DOGRULAMA = '693M161f1Sv595Y' AND @ISLEM = 3  -- optik işlemlerinden geliyorsa 
		SET @ID_LOG=2
	ELSE
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1 
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @DONEM IS NULL OR @DONEM = ''
			SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
						
		IF @ISLEM = 1	--	PUANTURU
		BEGIN
			SELECT PT.ID_SINAVPUANTURU
				,PUANTURU = pt.AD
			FROM Sinav			S 
			JOIN SinavPuanTuru	PT	ON	PT.ID_SINAVTURU	= S.ID_SINAVTURU
			WHERE S.ID_SINAV = @ID_SINAV
			ORDER BY PT.ID_SINAVPUANTURU
		END

		IF @ISLEM = 2	--	SINAV DETAY GETİR
		BEGIN
		
			DROP TABLE IF EXISTS #OGRENCILIST

			SELECT  
				 TCKIMLIKNO			= JSON_VALUE(J.VALUE,'$.TCKIMLIKNO') 
				,ADSOYAD			= JSON_VALUE(J.VALUE,'$.ADSOYAD') 
				,ILCEKATILIM		= JSON_VALUE(J.VALUE,'$.ILCEKATILIM') 
				,ILKATILIM			= JSON_VALUE(J.VALUE,'$.ILKATILIM') 
				,GENELKATILIM		= JSON_VALUE(J.VALUE,'$.GENELKATILIM') 
				,ID_SINAV			= @ID_SINAV
				,ID_SINAVPUANTURU	= ID_SINAVPUANTURU	
				,PUAN				= PUAN
				,SINIFSIRA			= SINIFSIRA	
				,OKULSIRA			= OKULSIRA	
				,ILCESIRA			= ILCESIRA	
				,ILSIRA				= ILSIRA		
				,GENELSIRA			= GENELSIRA	
			INTO #OGRENCILIST
			FROM OPENJSON (@SQLJSON) AS J
			CROSS APPLY (
				SELECT PUAN				= replace(JSON_VALUE(H.VALUE,'$.PUAN'),',','.')
					,ID_SINAVPUANTURU	= JSON_VALUE(H.VALUE,'$.ID_SINAVPUANTURU')
					,SINIFSIRA			= JSON_VALUE(H.VALUE,'$.SINIFSIRA')
					,OKULSIRA			= JSON_VALUE(H.VALUE,'$.OKULSIRA')
					,ILCESIRA			= JSON_VALUE(H.VALUE,'$.ILCESIRA')
					,ILSIRA				= JSON_VALUE(H.VALUE,'$.ILSIRA')
					,GENELSIRA			= JSON_VALUE(H.VALUE,'$.GENELSIRA')
				FROM OPENJSON (J.VALUE,'$.HariciList') AS H 
			)AS S
			
			DELETE FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV
			
			INSERT INTO SinavOgrenciHariciPuanSiralama ( TCKIMLIKNO, ID_SINAV, ID_SINAVPUANTURU, PUAN, SINIFSIRA, OKULSIRA, ILCESIRA, ILSIRA, GENELSIRA, ILCEKATILIM, ILKATILIM, GENELKATILIM )
			SELECT DISTINCT OL.TCKIMLIKNO, OL.ID_SINAV, OL.ID_SINAVPUANTURU, OL.PUAN, OL.SINIFSIRA, OL.OKULSIRA, OL.ILCESIRA, OL.ILSIRA, OL.GENELSIRA, OL.ILCEKATILIM, OL.ILKATILIM, OL.GENELKATILIM
			FROM Sinav			S	
			JOIN SinavPuanTuru	PT	ON	PT.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN #OGRENCILIST	OL	ON	OL.ID_SINAV			= S.ID_SINAV	
									AND OL.ID_SINAVPUANTURU	= PT.ID_SINAVPUANTURU
			WHERE S.ID_SINAV = @ID_SINAV

			DROP TABLE IF EXISTS #OGRENCILIST
			
			SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV

			SET @ISLEM = 3

		END

		IF @ISLEM = 3
		BEGIN

			UPDATE P SET
				 P.PUAN			= PS.PUAN
				,P.SINIFSIRA	= PS.SINIFSIRA		
				,P.OKULSIRA		= PS.OKULSIRA			
				,P.ILCESIRA		= PS.ILCESIRA			
				,P.ILSIRA		= PS.ILSIRA			
				,P.GENELSIRA	= PS.GENELSIRA		
			FROM SinavOgrenci					SO
			JOIN SinavOgrenciSonuc				P	ON	P.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV			= SO.ID_SINAV
													AND PS.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND PS.ID_SINAVPUANTURU = P.ID_SINAVPUANTURU
			WHERE PS.ID_SINAV = @ID_SINAV

			UPDATE P SET
				 P.PUAN			= PS.PUAN
				,P.SINIFSIRA	= PS.SINIFSIRA		
				,P.OKULSIRA		= PS.OKULSIRA			
				,P.ILCESIRA		= PS.ILCESIRA			
				,P.ILSIRA		= PS.ILSIRA			
				,P.GENELSIRA	= PS.GENELSIRA		
			FROM SinavOgrenciPuan				P	
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV		= P.ID_SINAV
													AND PS.TCKIMLIKNO	= P.TCKIMLIKNO
													AND PS.ID_SINAVPUANTURU = P.ID_SINAVPUANTURU
			WHERE PS.ID_SINAV = @ID_SINAV


			UPDATE K SET 
				 K.KATILIM_GENEL= ISNULL(PS.GENELKATILIM,K.KATILIM_GENEL)
				,K.KATILIM_IL	= ISNULL(PS.ILKATILIM	,K.KATILIM_IL)
				,K.KATILIM_ILCE = ISNULL(PS.ILCEKATILIM	,K.KATILIM_ILCE)
			FROM SinavOgrenciToplam				K
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV		= K.ID_SINAV
													AND PS.TCKIMLIKNO	= K.TCKIMLIKNO
			WHERE	K.ID_SINAV	= @ID_SINAV			
				AND (	PS.GENELKATILIM IS NOT NULL
					OR	PS.ILCEKATILIM  IS NOT NULL
					OR  PS.ILKATILIM	IS NOT NULL)

		END

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END

	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_UniteTarama]    Script Date: 23.11.2021 15:37:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_UniteTarama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ID_UNITESINAV			INT				= NULL,
	@ID_UNITETARAMASINAV	INT			= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@O_TCKIMLIKNO			VARCHAR(11)		= NULL,
	@DERS					VARCHAR(MAX)	= NULL,
	@DERS_ID				INT             = NULL,
	@ID_DERS				INT             = NULL,
	@ID_UNITETARAMASORU		INT				= NULL,			
	@SIRA					INT				= NULL,
	@KITAPCIKSAYISI			INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@OVGORSUN				BIT				= NULL,
	@ID_UNITETARAMAKITAPCIK INT         =NULL,
	@ID_SINAVTURU			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURUS			VARCHAR(MAX)	= NULL,
	@ID_SINIFs				VARCHAR(MAX)	= NULL,
	@ID_SINAVs				VARCHAR(MAX)	= NULL,
	@ID_DERSs				VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM			char(4)			= '',
	@ID_ODEVTUR				INT				= NULL,
	@KOD					VARCHAR(MAX)	= NULL ,
	@ID_SUBELER				VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST			VARCHAR(MAX)	= NULL,
	@KODs					VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

	
AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM									=	@ISLEM					
			,TCKIMLIKNO								=	@TCKIMLIKNO				
			,OTURUM									=	@OTURUM					
			,ID_MENU								=	@ID_MENU				
			,DONEM									=	@DONEM					
			,AD										=	@AD						
			,ID_UNITESINAV							=	@ID_UNITESINAV			
			,ID_UNITETARAMASINAV					=	@ID_UNITETARAMASINAV	
			,SQLJSON								=	@SQLJSON				
			,ID_SINIF								=	@ID_SINIF				
			,ID_SUBE								=	@ID_SUBE				
			,ID_SUBEs								=	@ID_SUBEs				
			,O_TCKIMLIKNO							=	@O_TCKIMLIKNO			
			,DERS									=	@DERS					
			,DERS_ID							    =	@DERS_ID				
			,ID_DERS							    =	@ID_DERS				
			,ID_UNITETARAMASORU						=	@ID_UNITETARAMASORU		
			,SIRA									=	@SIRA					
			,KITAPCIKSAYISI							=	@KITAPCIKSAYISI			
			,ID_KADEME3								=	@ID_KADEME3				
			,OVGORSUN								=	@OVGORSUN				
			,ID_UNITETARAMAKITAPCIK			        =	@ID_UNITETARAMAKITAPCIK 
			,ID_SINAVTURU							=	@ID_SINAVTURU			
			,ID_SINAVTURUS							=	@ID_SINAVTURUS			
			,ID_SINIFs								=	@ID_SINIFs				
			,ID_SINAVs								=	@ID_SINAVs				
			,ID_DERSs								=	@ID_DERSs				
			,OGRENCIDONEM							=	@OGRENCIDONEM			
			,ID_ODEVTUR								=	@ID_ODEVTUR				
			,KOD									=	@KOD					
			,ID_SUBELER								=	@ID_SUBELER				
			,ID_SINIFLAR							=	@ID_SINIFLAR			
			,ID_SINIFLIST							=	@ID_SINIFLIST			
			,KODs									=	@KODs					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--BEGIN TRANSACTION [Tran1]
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			DECLARE  @OZELSINAVGOR BIT=0

			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
			BEGIN
				SET @OZELSINAVGOR=1
			END
						
			Declare  @SQL		as varchar(max)=null
					,@Columns	as varchar(max)=null
					,@Columns2	as varchar(max)=null
					,@Columns3	as varchar(max)=null

			IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )
			BEGIN
				IF @ISLEM = 1	--	SINAV TANIMLA
				BEGIN
					DECLARE @INSERTED TABLE(ID INT NOT NULL);  

					INSERT INTO UniteTaramaSinav(AD, DONEM, KYE_TCKIMLIKNO, ID_KADEME3)
					OUTPUT inserted.ID_UNITETARAMASINAV
					INTO @INSERTED
					SELECT @AD, @DONEM, @TCKIMLIKNO, @ID_KADEME3

					DECLARE @cnt INT = 0;

					WHILE @cnt < @KITAPCIKSAYISI
					BEGIN
						INSERT INTO UniteTaramaKitapcik(ID_UNITETARAMASINAV, AD)
						SELECT ID, CHAR(65 + @cnt) FROM @INSERTED
						SET @cnt = @cnt + 1;
					END;
				END	
			
				IF @ISLEM = 2	--	SINAV LİSTELE
				BEGIN
					SELECT
					(
						SELECT	 S.ID_UNITETARAMASINAV
								,S.AD
								,KADEME3		= K3.AD
								,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
								,ADSOYAD		= K.AD + ' ' + K.SOYAD 
								,KITAPCIKSAYISI	= (SELECT COUNT(1) FROM UniteTaramaKitapcik SK WHERE SK.ID_UNITETARAMASINAV = S.ID_UNITETARAMASINAV) 
								,S.OVGORSUN
						FROM UniteTaramaSinav S 
						INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.KYE_TCKIMLIKNO
						INNER JOIN v3Kademe3				 K3 ON K3.ID_KADEME3	= S.ID_KADEME3
						WHERE	S.DONEM		 = @DONEM 
							AND S.ID_KADEME3 = @ID_KADEME3
							AND S.AKTIF		 = 1 
						ORDER BY S.KYE_TARIH DESC 
						FOR JSON PATH
					)
				END

				IF @ISLEM = 3	--	SINAV DUZENLE
				BEGIN
					UPDATE UniteTaramaSinav SET 
						 AD			= @AD
						,ID_KADEME3 = @ID_KADEME3 
					WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					DECLARE @MEVCUTKITAPCIKSAYISI INT = (SELECT COUNT(1) FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV)

					IF @KITAPCIKSAYISI <> @MEVCUTKITAPCIKSAYISI
					BEGIN
						IF @KITAPCIKSAYISI > @MEVCUTKITAPCIKSAYISI
						BEGIN
							DECLARE @cntx INT = @MEVCUTKITAPCIKSAYISI;

							WHILE @cntx < @KITAPCIKSAYISI
							BEGIN
								INSERT INTO UniteTaramaKitapcik(ID_UNITETARAMASINAV, AD)
								SELECT @ID_UNITETARAMASINAV, CHAR(65 + @cntx)

								DECLARE @YENIID_UNITETARAMAKITAPCIK INT = (SELECT ID_UNITETARAMAKITAPCIK FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV AND AD = CHAR(65 + @cntx))

								IF EXISTS (SELECT 1 FROM UniteTaramaSoru WHERE ID_UNITETARAMASINAV= @ID_UNITETARAMASINAV)
								BEGIN
									INSERT INTO UniteTaramaSoruKarsilik(ID_UNITETARAMASORU, ID_UNITETARAMAKITAPCIK, SORUNO)
									SELECT S.ID_UNITETARAMASORU, @YENIID_UNITETARAMAKITAPCIK, S.SORUNO
									FROM UniteTaramaSoru S
								END
							
								SET @cntx = @cntx + 1;
							END;
						END
						ELSE
						BEGIN
							SELECT TOP(@MEVCUTKITAPCIKSAYISI - @KITAPCIKSAYISI) ID_UNITETARAMAKITAPCIK 
							INTO #TEMPKITAPCIK
							FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
							ORDER BY ID_UNITETARAMAKITAPCIK DESC

							DELETE SK FROM UniteTaramaSoruKarsilik SK
							INNER JOIN #TEMPKITAPCIK K ON K.ID_UNITETARAMAKITAPCIK = SK.ID_UNITETARAMAKITAPCIK

							DELETE K FROM UniteTaramaKitapcik K
							INNER JOIN #TEMPKITAPCIK T ON T.ID_UNITETARAMAKITAPCIK = K.ID_UNITETARAMAKITAPCIK
						END
					END
				END

				IF @ISLEM = 4	--	SINAV SİL
				BEGIN
					UPDATE UniteTaramaSinav SET AKTIF = 0 WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				END

				IF @ISLEM = 5	--	SINAV EXCEL YÜKLE
				BEGIN
					IF EXISTS (	
								SELECT TOP 1 1 FROM UniteTaramaOgrenci O 
								INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = O.ID_UNITETARAMASORU
								WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
							)
					BEGIN
						RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
					END
					ELSE
					BEGIN
						DELETE SK FROM UniteTaramaSoruKarsilik SK
						INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = SK.ID_UNITETARAMASORU
						WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				
						DELETE FROM UniteTaramaSoru WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaYorum WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaPuanAralik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaBeceri WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV


						DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  
						INSERT INTO UniteTaramaSoru (ID_UNITETARAMASINAV, ID_DERS,SORUNO, KAZANIMKOD, PUAN)
						OUTPUT inserted.ID_UNITETARAMASORU, inserted.SORUNO
						INTO @INSERTEDSORU
						SELECT @ID_UNITETARAMASINAV, ID_DERS, SORUNO, KAZANIMKOD, PUAN FROM OPENJSON(@SQLJSON)
						WITH (
							PUAN		INT,
							SORUNO		INT,
							ID_DERS		VARCHAR(MAX),
							KAZANIMKOD	VARCHAR(MAX)
						)

						INSERT INTO UniteTaramaSoruKarsilik
						SELECT ID, K.ID_UNITETARAMAKITAPCIK, S.SORUNO FROM @INSERTEDSORU S
						CROSS JOIN UniteTaramaKitapcik K WHERE K.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				
						--INSERT INTO UniteTaramaYorum (ID_UNITETARAMASINAV, DERS, DUZEY, YORUM, ONERI)
						--SELECT @ID_UNITETARAMASINAV, DERS, DUZEY, YORUM, ONERI FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
						--WITH (
						--	DERS VARCHAR(MAX),
						--	DUZEY INT,
						--	YORUM VARCHAR(MAX),
						--	ONERI VARCHAR(MAX)
						--)
				
						--INSERT INTO UniteTaramaPuanAralik(ID_UNITETARAMASINAV, MAXIMUMPUAN, DUZEY)
						--SELECT @ID_UNITETARAMASINAV, MAXIMUMPUAN, DUZEY FROM OPENJSON(@SQLJSON, '$.PUANARALIKLIST')
						--WITH (
						--	MAXIMUMPUAN INT,
						--	DUZEY INT
						--)
				
						--INSERT INTO UniteTaramaBeceri(ID_UNITETARAMASINAV, DERS, BECERI, ACIKLAMA)
						--SELECT @ID_UNITETARAMASINAV, DERS, BECERI, ACIKLAMA FROM OPENJSON(@SQLJSON, '$.BECERILIST')
						--WITH (
						--	DERS VARCHAR(MAX),
						--	BECERI VARCHAR(MAX),
						--	ACIKLAMA VARCHAR(MAX)
						--)
					END
				END

				IF @ISLEM = 6	--	SINAV EXCEL LİSTELE
				BEGIN
					SELECT
					(	SELECT * 
						FROM [Pusulam].[dbo].[UniteTaramaSoru] 
						WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV 				
						FOR JSON PATH--, WITHOUT_ARRAY_WRAPPER
					)
				END

				IF @ISLEM = 7	--	ÖĞRENCİ LİSTELE
				BEGIN
					SELECT
					(
						SELECT	O.OGRNO 
								,O.TCKIMLIKNO
								,K.AD + ' ' + K.SOYAD AS ADSOYAD
								,(	
									SELECT D.DERSAD AS DERS, SUM(CASE WHEN AO.PUAN IS NULL THEN 0 ELSE 1 END) AS CEVAPSAYISI 
									FROM UniteTaramaSoru S INNER JOIN eokul_v2.[dbo].[Ders] D ON D.ID_DERS=S.ID_DERS
									LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
									WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
									GROUP BY S.ID_DERS,D.DERSAD
									FOR JSON PATH
								 ) AS CEVAP
						FROM OkyanusDB.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					
						WHERE O.ID_SINIF = @ID_SINIF AND O.DONEM = @DONEM
						ORDER BY K.AD + ' ' + K.SOYAD
						FOR JSON PATH
					)
				END

				IF @ISLEM = 8	--	ÖĞRENCİ PUAN LİSTELE
				BEGIN
					SELECT
					(
						SELECT S.ID_UNITETARAMASORU, S.SORUNO, VD.AD AS KAZANIM,S.PUAN AS MAXPUAN ,AO.PUAN
						FROM UniteTaramaSoru S
						INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD ON S.ID_DERS=VD.ID_DERS
						AND VD.KOD=S.KAZANIMKOD
						INNER JOIN UniteTaramaSoruKarsilik SK ON SK.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU
						INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=S.ID_DERS
						LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = @O_TCKIMLIKNO AND AO.AKTIF = 1
					
						WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV AND D.DERSAD = @DERS AND (@ID_UNITETARAMAKITAPCIK IS NULL OR SK.ID_UNITETARAMAKITAPCIK = @ID_UNITETARAMAKITAPCIK) 
					
					
						ORDER BY SK.SORUNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END

				IF @ISLEM = 9	--	ÖĞRENCİ PUAN KAYDET
				BEGIN
					UPDATE UniteTaramaOgrenci SET AKTIF = 0 WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND ID_UNITETARAMASORU IN (SELECT ID_UNITETARAMASORU FROM OPENJSON(@SQLJSON) WITH (ID_UNITETARAMASORU INT))

					INSERT INTO UniteTaramaOgrenci (ID_UNITETARAMASORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO, ID_UNITETARAMAKITAPCIK)
					SELECT ID_UNITETARAMASORU, @O_TCKIMLIKNO, PUAN, @TCKIMLIKNO, @ID_UNITETARAMAKITAPCIK FROM OPENJSON(@SQLJSON)
					WITH
					(
						ID_UNITETARAMASORU INT,
						PUAN INT
					)
					WHERE PUAN IS NOT NULL
				END

				IF @ISLEM = 10	--	ÖĞRENCİ DERS PUAN SİL
				BEGIN
					UPDATE AO SET AO.AKTIF = 0 
					FROM UniteTaramaOgrenci AO 
					INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = AO.ID_UNITETARAMASORU
					INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=S.ID_DERS
					WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND D.DERSAD = @DERS AND S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				END

				IF @ISLEM = 17	--	SINAV LİSTELE by OGRENCI
				BEGIN
					SELECT
					(
						SELECT DISTINCT S.ID_UNITETARAMASINAV, S.AD, CONVERT(varchar, S.KYE_TARIH, 104) AS TARIH, K.AD + ' ' + K.SOYAD AS ADSOYAD,S.KYE_TARIH
						FROM UniteTaramaSinav	S 
						JOIN v3Kullanici		K	ON	K.TCKIMLIKNO			= S.KYE_TCKIMLIKNO
						JOIN UniteTaramaSoru	SO	ON	SO.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
						JOIN UniteTaramaOgrenci	O	ON	O.ID_UNITETARAMASORU	= SO.ID_UNITETARAMASORU
						WHERE	S.DONEM			= @DONEM 
							AND O.TCKIMLIKNO	= @O_TCKIMLIKNO
							AND S.AKTIF			= 1 
							AND S.OVGORSUN		= 1
						ORDER BY S.KYE_TARIH DESC
						FOR JSON PATH
					)
				END

				IF @ISLEM = 18	--	PUAN LİSTESİ GETİR (EXCEL)
				BEGIN
					SELECT D.AD DERS, MAX(SORUNO) AS SORUNO 
					FROM UniteTaramaSinav		S
					INNER JOIN UniteTaramaSoru	SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
					INNER JOIN v3Ders			D	ON	D.ID_DERS				= SS.ID_DERS 
					WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
					GROUP BY D.AD
					ORDER BY DERS

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #DERS

					SELECT 
							SB.AD AS SUBE
							,K3.AD AS GRUP
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,SN.AD AS SINIF
							,SN.ID_SINIF
							,AO.TCKIMLIKNO
							,D.DERSAD AS DERS
							,SORU.SORUNO
							,AO.PUAN
					INTO #TEMP
					FROM UniteTaramaOgrenci AO
					INNER JOIN UniteTaramaSoru SORU ON SORU.ID_UNITETARAMASORU = AO.ID_UNITETARAMASORU
					INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=SORU.ID_DERS
					INNER JOIN UniteTaramaSinav SINAV ON SINAV.ID_UNITETARAMASINAV = SORU.ID_UNITETARAMASINAV
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = AO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = AO.TCKIMLIKNO AND O.DONEM = SINAV.DONEM
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = SN.ID_SATISTURU
					INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = ST.ID_KADEME3
					WHERE	SINAV.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV 
						AND SINAV.DONEM = @DONEM
						AND SINAV.AKTIF = 1 
						AND AO.AKTIF = 1
						AND (@ID_SUBE	IS NULL OR @ID_SUBE		= 0 OR O.ID_SUBE	= @ID_SUBE)
						AND (@ID_SINIF	IS NULL OR @ID_SINIF	= 0 OR O.ID_SINIF	= @ID_SINIF)

					DECLARE 
							@COLS AS NVARCHAR(MAX),
							@QUERY  AS NVARCHAR(MAX)

					SELECT DERS+'-'+CAST(SORUNO AS VARCHAR) AS DERS
					INTO #DERS
					FROM #TEMP
					GROUP BY DERS, SORUNO
					ORDER BY DERS, SORUNO

					SELECT @COLS = STUFF((SELECT ','+QUOTENAME(DERS2)+' VARCHAR(MAX) DEFAULT ''-''' 
										  FROM (
													SELECT
														T.DERS + '-' + CAST(T.SORUNO AS VARCHAR) AS DERS2
													FROM #TEMP T 
													GROUP BY T.DERS, T.SORUNO
												) AS S
											FOR XML PATH(''), TYPE
											).value('.', 'NVARCHAR(MAX)') 
										,1,1,'')

					SET @QUERY = '
						DROP TABLE IF EXISTS #T
						CREATE TABLE #T (SUBE VARCHAR(MAX), GRUP VARCHAR(MAX), ADSOYAD VARCHAR(MAX), SINIF VARCHAR(MAX), TCKIMLIKNO VARCHAR(MAX),' + @COLS + ')

						INSERT INTO #T (SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO)
						SELECT SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO FROM #TEMP

						WHILE EXISTS ( SELECT *  FROM #DERS)
						BEGIN

							DECLARE @DERSAD VARCHAR(100) = (SELECT TOP(1) DERS FROM #DERS ORDER BY DERS)	
							DECLARE @QUERY2 NVARCHAR(MAX)

							SET @QUERY2=	
							''
								UPDATE T
								SET T.[''+@DERSAD+''] = P.PUAN
								FROM #T T
								JOIN #TEMP P ON T.TCKIMLIKNO = P.TCKIMLIKNO AND P.DERS + ''''-'''' +  CAST(P.SORUNO AS VARCHAR) = ''''''+@DERSAD+''''''
							''
							EXEC sp_executesql @QUERY2; 

							DELETE FROM #DERS WHERE DERS = @DERSAD
						END
						SELECT DISTINCT * FROM #T
						DROP TABLE IF EXISTS #T
					'
					PRINT @QUERY
					EXEC sp_executesql @QUERY; 

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #DERS
				END

				IF @ISLEM = 21	--	SINAV KİTAPÇIK LİSTELE
				BEGIN
					SELECT	DISTINCT K.ID_UNITETARAMAKITAPCIK
							,K.AD
							,CASE WHEN EXISTS(	
								SELECT 1 
								FROM UniteTaramaOgrenci O
								INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = O.ID_UNITETARAMASORU
								INNER JOIN eokul_v2.[dbo].[Ders] D ON D.ID_DERS=S.ID_DERS
								WHERE O.ID_UNITETARAMAKITAPCIK = K.ID_UNITETARAMAKITAPCIK  AND O.TCKIMLIKNO = @O_TCKIMLIKNO AND O.AKTIF = 1 
							)
							THEN 1
							ELSE 0 
							END AS SECILI
					INTO #TEMPKITAPCIKSEC
					FROM UniteTaramaKitapcik K
					WHERE K.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					--IF NOT EXISTS (SELECT * FROM #TEMPKITAPCIKSEC WHERE SECILI = 1)
					--BEGIN
					--	UPDATE #TEMPKITAPCIKSEC SET SECILI = 1 WHERE AD = 'A'
					--END

					SELECT
					(
						SELECT * FROM #TEMPKITAPCIKSEC
						ORDER BY AD
						FOR JSON PATH
					)

					DROP TABLE #TEMPKITAPCIKSEC
				END

				IF @ISLEM = 25	--	OVGORSUN DEĞİŞTİR
				BEGIN
					UPDATE UniteTaramaSinav SET OVGORSUN = @OVGORSUN WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					select 1
				END

				IF @ISLEM = 26	--	KAZANIM LİSTELE
				BEGIN
					SELECT
					(
						SELECT DISTINCT D.AD DERSAD, VD.AD AS KAZANIM,S.ID_DERS,S.SORUNO,vd.KOD
						FROM UniteTaramaSoru S
						INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	VD	ON	S.ID_DERS				= VD.ID_DERS			AND VD.KOD=S.KAZANIMKOD
						INNER JOIN UniteTaramaSinav					Sn	on	S.ID_UNITETARAMASINAV	= Sn.ID_UNITETARAMASINAV
						INNER JOIN OkyanusDB.DBO.v3Ders				D	on  D.ID_DERS				= S.ID_DERS
						INNER JOIN UniteTaramaOgrenci				UO	ON	UO.ID_UNITETARAMASORU	= S.ID_UNITETARAMASORU
						INNER JOIN OkyanusDB.dbo.v3OgrenciTUM		O	ON	O.TCKIMLIKNO			= UO.TCKIMLIKNO
						INNER JOIN v3SinifTum						ST	ON	ST.ID_SINIF				= O.ID_SINIF			AND ST.DONEM = O.DONEM
						WHERE	Sn.DONEM				= @DONEM 
							AND Sn.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV 
							AND Sn.ID_KADEME3			= @ID_KADEME3
							AND (O.ID_SUBE	IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
							AND (O.ID_SINIF	IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')				    
						ORDER BY D.AD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					as TblListe
				END

				IF @ISLEM = 27	--	Kazanım öğrenci listesi
				BEGIN
					SELECT
					(
		
							SELECT DISTINCT
								 S.ID_UNITETARAMASINAV AS ID_SINAVBILGI
								,GS.SUBEAD AS [KAMPÜS]
								,GS.SINIF
								,UO.TCKIMLIKNO
								,K.AD + ' '+ K.SOYAD [AD SOYAD]
								,O.ID_SINIF
								,D.DERSAD AS DERS
								,VD.AD AS KAZANIM
								,D.ID_DERS
								--,UO.PUAN
								,[PUAN] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100 AS DECIMAL(8,2))
								,[DOĞRULUK YÜZDESİ] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100 AS DECIMAL(8,2))
							FROM	   [Pusulam].dbo.UniteTaramaSinav		S						
							INNER JOIN [Pusulam].dbo.UniteTaramaSoru		SO WITH (NOLOCK)ON SO.ID_UNITETARAMASINAV=S.ID_UNITETARAMASINAV
							INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD	ON	SO.ID_DERS=VD.ID_DERS AND VD.KOD=SO.KAZANIMKOD 
							INNER JOIN [Pusulam].dbo.UniteTaramaOgrenci		UO	ON	UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
							INNER JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO=UO.TCKIMLIKNO
							INNER JOIN OkyanusDB.[dbo].[v3OgrenciTUM]		O	ON	O.TCKIMLIKNO=UO.TCKIMLIKNO AND O.DONEM = S.DONEM
							INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS	ON	GS.ID_SINIF = O.ID_SINIF
							INNER JOIN eokul_v2.dbo.Ders					D	ON D.ID_DERS=SO.ID_DERS
							INNER JOIN OkyanusDB.dbo.v3Kademe3				K3	ON K3.ID_KADEME3=S.ID_KADEME3
							WHERE		S.AKTIF			= 1
									AND S.DONEM			= @DONEM
									AND D.ID_DERS		= @ID_DERS
									AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
									AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
									AND SO.KAZANIMKOD=@KOD
							--GROUP BY S.ID_UNITETARAMASINAV ,S.AD ,D.DERSAD ,D.ID_DERS,UO.TCKIMLIKNO,O.ID_SINIF,K.AD,K.SOYAD,UO.PUAN,VD.AD
							ORDER BY ID_SINAVBILGI ,[KAMPÜS] ,SINIF ,[AD SOYAD], DERS, KAZANIM
							FOR JSON PATH, INCLUDE_NULL_VALUES
							) as TblListeOgr


	  
		
				END

				IF @ISLEM = 28	--	Kazanım öğrenci listesi
				BEGIN
					SELECT
					(
		
						
							SELECT DISTINCT
								 S.ID_UNITETARAMASINAV AS ID_SINAVBILGI
								,GS.SUBEAD AS [KAMPÜS]
								,GS.SINIF
								,UO.TCKIMLIKNO
								,K.AD + ' '+ K.SOYAD [AD SOYAD]
								,O.ID_SINIF
								,D.DERSAD AS DERS
								,VD.AD AS KAZANIM
								,D.ID_DERS
								,SO.KAZANIMKOD
								--,UO.PUAN
								,[PUAN] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100.00 AS DECIMAL(8,2))
								,[DOĞRULUK YÜZDESİ] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100.00 AS DECIMAL(8,2))
							FROM	   [Pusulam].dbo.UniteTaramaSinav		S						
							INNER JOIN [Pusulam].dbo.UniteTaramaSoru		SO WITH (NOLOCK)ON SO.ID_UNITETARAMASINAV=S.ID_UNITETARAMASINAV
							INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD	ON	SO.ID_DERS=VD.ID_DERS AND VD.KOD=SO.KAZANIMKOD 
							INNER JOIN [Pusulam].dbo.UniteTaramaOgrenci		UO	ON	UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
							INNER JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO=UO.TCKIMLIKNO
							INNER JOIN OkyanusDB.[dbo].[v3OgrenciTUM]		O	ON	O.TCKIMLIKNO=UO.TCKIMLIKNO AND O.DONEM = S.DONEM
							INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS	ON	GS.ID_SINIF = O.ID_SINIF
							INNER JOIN eokul_v2.dbo.Ders					D	ON D.ID_DERS=SO.ID_DERS
							INNER JOIN OkyanusDB.dbo.v3Kademe3				K3	ON K3.ID_KADEME3=S.ID_KADEME3
							WHERE		S.AKTIF			= 1
									--AND S.DONEM			= @DONEM
									AND S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
									--AND D.ID_DERS		= @ID_DERS
									AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
									AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
									AND (SO.KAZANIMKOD	IN (SELECT VALUE FROM OPENJSON(@KODs))			OR @KODs		= '[]')
							--GROUP BY S.ID_UNITETARAMASINAV ,S.AD ,D.DERSAD ,D.ID_DERS,UO.TCKIMLIKNO,O.ID_SINIF,K.AD,K.SOYAD,UO.PUAN,VD.AD
							ORDER BY ID_SINAVBILGI ,[KAMPÜS] ,SINIF ,[AD SOYAD], DERS, KAZANIM
							FOR JSON PATH, INCLUDE_NULL_VALUES
							) as TblListeOgr


	  
		
				END

				IF  @ISLEM= 30	--	SINIF Listesi
				BEGIN
  
					 SELECT distinct D.SUBEAD,DS.SEVIYE AS [KUR SEVİYESİ],D.SINIF,S.TCKIMLIKNO,K.AD + ' '+ K.SOYAD [AD SOYAD] 
					 FROM  OkyanusDB.dbo.vw_SinifOgrenci S 
					 INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay D          ON   S.ID_SINIF=D.ID_SINIF
					 INNER JOIN  v3AktifDonem  AD                         ON   AD.DONEM=d.DONEM 
					 INNER JOIN OkyanusDB.dbo.v3Kullanici			K	  ON   K.TCKIMLIKNO=S.TCKIMLIKNO
					 LEFT JOIN   OkyanusDB.[dbo].[v4SinifOgretmenDers] SD ON   SD.ID_SINIF=D.ID_SINIF 
					 LEFT JOIN    OkyanusDB.[dbo].v4DersSeviye DS         ON   SD.ID_DERS=DS.ID_DERS AND SD.ID_DERSSEVIYE= DS.ID_DERSSEVIYE
					 WHERE AD.AKTIF=1        
					 AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
					 AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
 
					ORDER BY D.SUBEAD ASC,DS.SEVIYE DESC
			   END

				IF  @ISLEM= 31	--	Morpa Kazanım Bul
				BEGIN
					SELECT ISNULL((
						SELECT TOP 1 M.*,D.AD MORPADERS 
						,MATERYALLIST = (SELECT STUFF((SELECT DISTINCT ', ' +  CAST( SM.AD AS VARCHAR) FROM MorpaMateryal SM WHERE SM.ID_MORPADERS = M.ID_MORPADERS AND SM.AKTIF = 1  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
						,ID_MATERYALLIST = (SELECT SM.*
											FROM MorpaMateryal SM 
											WHERE	SM.ID_MORPADERS = M.ID_MORPADERS 
												AND SM.AKTIF		= 1
											FOR JSON PATH)
						FROM OkyanusDB.DBO.v3SinavDersUnite	U
						JOIN MorpaKazanim					M	ON	M.KOD_OKY		= U.KOD
						JOIN MorpaDers						D	ON	D.ID_MORPADERS	= M.ID_MORPADERS
						WHERE	U.KOD	= @KOD
							AND M.AKTIF	= 1
							AND D.AKTIF	= 1
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
			   END

				IF  @ISLEM= 32	--	Sınava Giren Öğrenci Listesi
				BEGIN
					SELECT ISNULL((
					
						SELECT DISTINCT
							 O.SUBEAD
							,O.SINIFAD
							,O.TCKIMLIKNO
							,O.AD
							,O.SOYAD
							,O.ID_SINIF
							,GIRDI  = cast(	IIF(	EXISTS (	SELECT TOP 1 S.ID_UNITETARAMASINAV 
																FROM UniteTaramaSinav	S
																JOIN UniteTaramaSoru	SO	ON	SO.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
																JOIN UniteTaramaOgrenci	U	ON	U.ID_UNITETARAMASORU	= SO.ID_UNITETARAMASORU
																							AND	U.TCKIMLIKNO			= O.TCKIMLIKNO 
																							AND U.AKTIF					= 1
																WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV	
																	AND S.AKTIF					= 1
															)
												,1,0) 
										as bit)
						FROM OkyanusDB.DBO.vw_OgrenciDetayTum	O
						WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLIST))

						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
			   END

		   		IF (@ISLEM = 34 OR @ISLEM = 33)  -- SINIF
				BEGIN
			

				DROP TABLE IF EXISTS #TEMP_SINIF
				DROP TABLE IF EXISTS #SINIF
				DROP TABLE IF EXISTS #SINIF_DYB
				DROP TABLE IF EXISTS ##TblSinif
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #k
				DROP TABLE IF EXISTS #TblOrtalama
				DROP TABLE IF EXISTS #DERSS

			
			
					SELECT DERSAD INTO #DERSS from eokul_v2.dbo.Ders DA
					WHERE ID_DERS IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'
				
			
							SELECT	DISTINCT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD
						   ,O.ID_SUBE,SU.AD SUBEAD,SO.PUAN AS PUAN,SOO.PUAN AS SPUAN										
						   ,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM ,SOO.SORUNO
					
							INTO	#TEMP_SINIF
							FROM	UniteTaramaSinav		S	WITH (NOLOCK)
							JOIN	UniteTaramaSoru			SOO	WITH (NOLOCK)	ON	SOO.ID_UNITETARAMASINAV         = S.ID_UNITETARAMASINAV
							JOIN	UniteTaramaOgrenci		SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASORU			= SOO.ID_UNITETARAMASORU
							JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
							JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
							JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
							JOIN	v3SubeGrupSinifTum		GS	WITH (NOLOCK)	ON	GS.ID_SINIF						= SN.ID_SINIF
							JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SOO.ID_DERS			
							JOIN	#DERSS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD			
							left JOIN	v3SinavDersUnite	U	WITH (NOLOCK)	ON	U.KOD						    = SOO.KAZANIMKOD
							WHERE	S.AKTIF			=	1 		
								AND GS.ID_KADEME3	=	@ID_KADEME3				
								AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')		
							
								AND (S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	
								--IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
					--SELECT * FROM #TEMP_SINIF   	
					DROP TABLE IF EXISTS #SINIF_DYB
					SELECT KOD, KAZANIM, ID_SINIF, SINIFAD, ID_DERS, DERSAD, ID_UNITETARAMASINAV, SINAVAD, SUBEAD, ID_SUBE,COUNT(TCKIMLIKNO) DURUMSAYISI,SUM(PUAN) AS P,SPUAN,				
					CAST(SUM(PUAN) AS FLOAT) / CAST(COUNT(TCKIMLIKNO)AS FLOAT)/CAST(SPUAN AS FLOAT)*CAST(100 AS FLOAT) AS PUAN,0 OGRSAY, SORUNO
					--CAST((SUM(PUAN)/COUNT(DISTINCT(TCKIMLIKNO)))AS FLOAT)/SPUAN*100 AS PUAN, 0 OGRSAY, SORUNO


			
					INTO #SINIF_DYB
					FROM #TEMP_SINIF T
					GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,SUBEAD,ID_SUBE,SORUNO,SPUAN

					UPDATE	S 
					SET		S.OGRSAY=G.OGRSAY
					FROM	#SINIF_DYB	S
					JOIN    (SELECT SORUNO,ID_SINIF,ID_DERS,SUM(DURUMSAYISI) OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO,ID_SINIF, ID_DERS) AS G	ON G.ID_SINIF=S.ID_SINIF  AND S.ID_DERS = G.ID_DERS
			    
					--select * from #SINIF_DYB
						
					SELECT *, CAST(	(	SELECT PUAN
										FROM #SINIF_DYB G 
									WHERE	
											G.PUAN		= S.PUAN 
										AND G.ID_SINIF	= S.ID_SINIF 
										AND G.KOD		= S.KOD 
										AND G.SORUNO	= S.SORUNO 									
								) AS DECIMAL(8,2)) AS YUZDE
					INTO #SINIF
					FROM #SINIF_DYB S
					ORDER BY SORUNO
			
		   
							SELECT ID_SINIF, ID_SUBE ,COUNT(DISTINCT TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
							INTO #OGRSAY
							FROM #TEMP_SINIF
							GROUP BY ID_SINIF,  SUBEAD, SINIFAD, ID_SUBE			
							Select distinct ID_SINIF,SINIFAD, ID_SUBE,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 
		
							Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
							from 
							( Select DISTINCT ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
							ORDER BY SUBEAD,SINIFAD
				
							Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
							from 
							( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
							ORDER BY SUBEAD,COL DESC,SINIFAD

							Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
							from 
							( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
							ORDER BY SUBEAD,COL DESC,SINIFAD
								
			
			
					Set @SQL='	
					Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO,ID_UNITETARAMASINAV,SINAVAD
						,'+@Columns2+' 
					into ##TblSinif
					from (
						Select  *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF 
						UNION ALL 
						Select *,SUBEAD COL from #SINIF  
					) AS S
					PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
					GROUP BY  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO,ID_UNITETARAMASINAV,SINAVAD
					ORDER BY DERSAD
					INSERT INTO ##TblSinif
					SELECT '''',ID_DERS,DERSAD,''SINIF ORTALAMASI'',0,ID_UNITETARAMASINAV,SINAVAD
							, '+@Columns3+'
					FROM ##TblSinif
					GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_DERS,DERSAD
					ORDER BY DERSAD
				'
			
				PRINT @SQL						
				EXEC (@SQL)
			
					SELECT  ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
					INTO #TblOrtalama
					FROM #SINIF				
					GROUP BY ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD
				
					
				UNION ALL				
					SELECT  ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,0 ID_SUBE,'' SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
					FROM #SINIF				
					GROUP BY ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD
					ORDER BY DERSAD			
				--SELECT * FROM ##TblSinif 
				If (OBJECT_ID('tempdb..##TblSinif ') Is Null)			
				BEGIN
			
					SELECT KOD = NULL,ID_DERS= NULL,DERSAD= NULL,KAZANIM= NULL,SORUNO= NULL,ID_UNITETARAMASINAV= NULL,PUAN=NULL,SINAVAD= NULL INTO  ##TblSinif 
					DELETE FROM ##TblSinif 
				END
				BEGIN
					IF @ISLEM = 34  -- DEVEXPRESS
					BEGIN
				
						Select ID_SINIF, SINIFAD, SUBEAD, COL 
						from #k 
						ORDER BY SUBEAD, SINIFAD

						SELECT * FROM ##TblSinif 

						SELECT DISTINCT ID_SINIF,ID_SUBE,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF,OGRSAY

				
						SELECT ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, YUZDE
						FROM #TblOrtalama
						ORDER BY SUBEAD,DERSAD

					END
					ELSE
					BEGIN
						select(
							select * from(
								select 
								(					
									Select ID_SINIF, SINIFAD, SUBEAD, COL 
									from #k 
									ORDER BY SUBEAD, SINIFAD
									FOR JSON AUTO,INCLUDE_NULL_VALUES
								) as TblSinifListesi,					
								(					
									SELECT * FROM ##TblSinif  order by DERSAD,SORUNO 
									FOR JSON AUTO
								) as TblVeri,
								(					
									SELECT DISTINCT ID_SINIF,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF,OGRSAY
									FOR JSON AUTO
								) as TblOgrSay,
								(	
									SELECT ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, YUZDE
									FROM #TblOrtalama
									ORDER BY SUBEAD,DERSAD
									FOR JSON AUTO
								) as TblOrtalama
							) as tablo FOR JSON AUTO
						) as tt				 
					END
				END

			

				DROP TABLE IF EXISTS #k
				DROP TABLE IF EXISTS #TEMP_SINIF
				DROP TABLE IF EXISTS #SINIF
				DROP TABLE IF EXISTS #SINIF_DYB
				DROP TABLE IF EXISTS ##TblSinif
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #TblOrtalama
				DROP TABLE IF EXISTS #DERSSSS



			END

				IF  @ISLEM = 35 --  Ünite Tarama Bildirim Listesi
				BEGIN
					DECLARE @TARIH				VARCHAR(MAX) = '',
							@YAZILIAD			VARCHAR(MAX) = ''

					SELECT 
						 @TARIH		= CONVERT(VARCHAR,KYE_TARIH,104)
						,@YAZILIAD	= AD
					FROM dbo.UniteTaramaSinav WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					SELECT ISNULL((
						SELECT DISTINCT
							 TC_GONDEREN = '14531453'
							,TC_ALAN	 = OV.TCKIMLIKNO
							,MESAJ		 = @YAZILIAD +' Ünite tarama sınav sonucunuzu Okyanus Pusulam sistemimizden inceleyebilirsiniz'
							FROM dbo.UniteTaramaSinav			UT
							JOIN dbo.UniteTaramaSoru			UTS ON UTS.ID_UNITETARAMASINAV = UT.ID_UNITETARAMASINAV	
							JOIN dbo.UniteTaramaOgrenci			UTO ON UTO.ID_UNITETARAMASORU  = UTS.ID_UNITETARAMASORU
							JOIN dbo.v3OgrenciVeli				OV  ON OV.TCKIMLIKNO_OGR = UTO.TCKIMLIKNO
						WHERE UTS.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						FOR JSON AUTO
					),'[]')


				END


			END
		END
		--COMMIT TRANSACTION [Tran1]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [Tran1]
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_UniteTaramaSinavSonucListesi]    Script Date: 23.11.2021 15:37:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_UniteTaramaSinavSonucListesi]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@ID_SUBELIST			VARCHAR(MAX)= NULL,
	@ID_UNITETARAMASINAV	INT			= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SUBELIST			= @ID_SUBELIST					
				,ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	ÖĞRENCİ RAPOR			
			BEGIN				
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMPLIST
				DROP TABLE IF EXISTS #OGRENCILIST
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #SORULIST

				SELECT VALUE ID_SUBE INTO #SUBELIST FROM OPENJSON(@ID_SUBELIST)

				SELECT DISTINCT
					 O.SUBEAD
					,O.SINIFAD
					,O.TCKIMLIKNO
					,O.AD
					,O.SOYAD
				INTO #OGRENCILIST
				FROM OkyanusDB.DBO.vw_OgrenciDetayTum	O
				JOIN #SUBELIST							SL	ON	SL.ID_SUBE		= O.ID_SUBE
				JOIN UniteTaramaSinav					S	ON	S.DONEM			= O.DONEM
															AND S.ID_KADEME3	= O.ID_KADEME3
				WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV
					AND S.AKTIF					= 1

				SELECT	 SS.ID_UNITETARAMASORU
						,SS.SORUNO
						,SK.ID_UNITETARAMAKITAPCIK
						,DERSAD			= D.AD
				INTO #SORULIST
				FROM UniteTaramaSinav		S
				JOIN UniteTaramaKitapcik	SK	ON	SK.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru		SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN OkyanusDB.DBO.v3Ders	D	ON	D.ID_DERS				= SS.ID_DERS
				WHERE SK.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV
				
				;WITH UTOSINAVDETAY AS (
					SELECT 
						 OD.TCKIMLIKNO
						,SL.DERSAD
						,SL.ID_UNITETARAMASORU
						,SL.SORUNO
						,OGRENCIPUAN	= O.PUAN
					FROM #SORULIST				SL
					JOIN UniteTaramaOgrenci		O	ON	O.ID_UNITETARAMASORU	= SL.ID_UNITETARAMASORU
													AND O.ID_UNITETARAMAKITAPCIK= SL.ID_UNITETARAMAKITAPCIK
													AND O.AKTIF					= 1
					JOIN #OGRENCILIST			OD	ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
				)
				SELECT	OL.TCKIMLIKNO
						,ID_UNITETARAMASORU
						,SORUNO
						,OGRENCIPUAN	
						,DERSAD						
						,ADSOYAD		= CONCAT_WS(' ',OL.AD,OL.SOYAD)
						,OL.SUBEAD
						,OL.SINIFAD
				INTO #TEMP
				FROM #OGRENCILIST		OL
				LEFT JOIN UTOSINAVDETAY	SD	ON	SD.TCKIMLIKNO	= OL.TCKIMLIKNO

				--SELECT 
				--	 OD.TCKIMLIKNO
				--	,S.ID_UNITETARAMASINAV
				--	,SS.ID_UNITETARAMASORU
				--	,SS.SORUNO
				--	--,SORUPUAN		= SS.PUAN
				--	,OGRENCIPUAN	= O.PUAN					
				--	,DERSAD			= D.AD
				--	,ADSOYAD		= CONCAT_WS(' ',OD.AD,OD.SOYAD)
				--	,OD.SUBEAD
				--	,OD.SINIFAD
				--INTO #TEMP
				--FROM UniteTaramaSinav		S
				--JOIN UniteTaramaKitapcik	SK	ON	SK.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				--								AND SK.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV
				--JOIN UniteTaramaSoru		SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				--JOIN UniteTaramaOgrenci		O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
				--								AND O.ID_UNITETARAMAKITAPCIK= SK.ID_UNITETARAMAKITAPCIK
				--								AND O.AKTIF					= 1
				--JOIN OkyanusDB.DBO.v3Ders	D	ON	D.ID_DERS				= SS.ID_DERS
				--RIGHT JOIN #OGRENCILIST		OD	ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
				
				DECLARE @TOPLAM INT = ISNULL((SELECT MAX(ID_UNITETARAMASORU) + 1 FROM #SORULIST), 0)

				SELECT TCKIMLIKNO
					,SUBEAD
					,SINIFAD
					,ADSOYAD
					,ID_UNITETARAMASORU
					,SORUNO
					,OGRENCIPUAN
					,DERSAD
				INTO #TEMPLIST
				FROM #TEMP
			UNION				
				SELECT TCKIMLIKNO
					,SUBEAD
					,SINIFAD
					,ADSOYAD
					,ID_UNITETARAMASORU	= @TOPLAM
					,SORUNO				= @TOPLAM
					,OGRENCIPUAN		= SUM(OGRENCIPUAN)
					,DERSAD				= 'TOPLAM'
				FROM #TEMP
				GROUP BY TCKIMLIKNO, SUBEAD, SINIFAD, ADSOYAD
			ORDER BY TCKIMLIKNO, SORUNO


				DECLARE @SQL AS VARCHAR(max) 
				DECLARE @Columns AS VARCHAR(max) 
				DECLARE @Columns2 AS VARCHAR(max) 
			
				SELECT @Columns = COALESCE(@Columns+',', '') + Quotename(ID_UNITETARAMASORU) 
				FROM   (SELECT DISTINCT ID_UNITETARAMASORU FROM #SORULIST UNION SELECT @TOPLAM) AS b 
				ORDER  BY b.ID_UNITETARAMASORU 

				SELECT @Columns2 = COALESCE(@Columns2+',', '') + '[' + DERSAD + SORUNO + '] = MAX('  +  Quotename(ID_UNITETARAMASORU) + ')'
				FROM   (SELECT DISTINCT ID_UNITETARAMASORU, DERSAD , SORUNO = ' - ' + CAST(SORUNO AS varchar) /*IIF( SORUNO = @TOPLAM , '',' - ' +  CAST(SORUNO AS varchar))*/ FROM #SORULIST SL WHERE SL.ID_UNITETARAMASORU IS NOT NULL  UNION SELECT @TOPLAM, 'TOPLAM', '' ) AS b 
				ORDER  BY b.ID_UNITETARAMASORU
			
				SET @SQL = '
					SELECT	 TCKIMLIKNO				
							,SUBEAD
							,SINIFAD
							,ADSOYAD
							,'+@Columns2+'
					FROM #TEMPLIST	T
					PIVOT (MAX(OGRENCIPUAN) FOR ID_UNITETARAMASORU IN('+@Columns+')  ) as P
					GROUP BY TCKIMLIKNO, SUBEAD, SINIFAD, ADSOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				'

				EXEC (@SQL)
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMPLIST
				DROP TABLE IF EXISTS #OGRENCILIST
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #SORULIST

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_UniteTaramaSinifPuanOrtalamalari]    Script Date: 23.11.2021 15:38:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_UniteTaramaSinifPuanOrtalamalari]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@IL						VARCHAR(36)		= NULL,
	@ILCE					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@DONEM					char(4)			= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINAVTURU			INT				= NULL,
	@ID_SINAV				INT				= NULL,
	@ID_UNITETARAMASINAV	INT				= NULL,
	@ID_DERS				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@DOSYAADI				varchar(100)	= NULL,
	@DOSYAGUID				varchar(50)		= NULL,
	@ID_SINAVDOSYA			int				= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@ID_SINAVs				VARCHAR(MAX)	= NULL,
	@ID_SINIFs				VARCHAR(MAX)	= NULL,
	@ID_DERSs				VARCHAR(MAX)	= NULL,
	@PUAN					int				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,TC_OGRENCI					= @TC_OGRENCI			
			,OTURUM						= @OTURUM				
			,IL							= @IL					
			,ILCE						= @ILCE				
			,ID_MENU					= @ID_MENU			
			,DONEM						= @DONEM				
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,ID_SINAV					= @ID_SINAV			
			,ID_UNITETARAMASINAV		= @ID_UNITETARAMASINAV
			,ID_DERS					= @ID_DERS			
			,ID_SUBE					= @ID_SUBE			
			,ID_SINIF					= @ID_SINIF			
			,DOSYAADI					= @DOSYAADI			
			,DOSYAGUID					= @DOSYAGUID			
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA		
			,SQLJSON					= @SQLJSON			
			,ID_SUBEs					= @ID_SUBEs			
			,ID_SINAVs					= @ID_SINAVs			
			,ID_SINIFs					= @ID_SINIFs			
			,ID_DERSs					= @ID_DERSs			
			,PUAN						= @PUAN		        
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='32051057542',@OTURUM='10F4322D-70ED-4AB6-B4C6-0ECC61118DFC',@DONEM='2017',@ID_SINAVTURU=8,@ID_KADEME3=15,@ID_SINAVs='[243,330,286]',@ID_SUBEs='[427,11]',@ID_SINIFS='[107210,107209,108612,107251]',@ID_DERSs='[0,147,150,152,873,962,1119]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
	
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
				
		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11


		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null

		------------------------------------------ DERS NET
		BEGIN
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
				--CAST((SUM(UO.PUAN)/COUNT(DISTINCT(UO.TCKIMLIKNO))/SO.PUAN )AS FLOAT) AS PUAN
				--CONVERT(float, 14.85);
		SELECT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD ,
		--CAST((SUM(UO.PUAN)/COUNT(DISTINCT(UO.TCKIMLIKNO)))AS FLOAT) AS PUAN
		CAST(SUM(UO.PUAN) AS NUMERIC(10,4)) / CAST(COUNT(DISTINCT(UO.TCKIMLIKNO))AS NUMERIC(10,4)) AS PUAN
		--,
				,O.ID_SUBE,SU.AD SUBEAD
		INTO	#Temp
		FROM	UniteTaramaSinav		S	WITH (NOLOCK)
		JOIN	UniteTaramaSoru			SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASINAV= S.ID_UNITETARAMASINAV
		JOIN    UniteTaramaOgrenci      UO  WITH (NOLOCK)	ON  UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= UO.TCKIMLIKNO 
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
	   
		JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SO.ID_DERS
		--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_DERS		= VD.ID_DERS	
		WHERE	
		        --S.DURUM			= 2
			 S.AKTIF			= 1
			 AND UO.AKTIF=1
			--AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND S.ID_UNITETARAMASINAV=@ID_UNITETARAMASINAV	
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			GROUP BY S.ID_UNITETARAMASINAV,S.AD,O.ID_SINIF, SN.AD,VD.ID_DERS,VD.DERSAD,O.ID_SUBE,SU.AD
		--SELECT * FROM #Temp
	 
			SELECT ID_UNITETARAMASINAV,SINAVAD,ID_DERS,DERSAD,(SUM(PUAN)/COUNT(1)) TS, CAST(AVG(PUAN) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			INTO #Net
			FROM #Temp	T
			GROUP BY ID_DERS,ID_UNITETARAMASINAV,SINAVAD,DERSAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD

		--Select * from #Net
			
		--UNION ALL 
		--	SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		--	FROM #Temp	T
		--	GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			
			INSERT INTO #Net			
			SELECT ID_UNITETARAMASINAV,SINAVAD,0,'TOPLAM',(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			FROM #Net	T
			GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		
			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp  ) as b 
			--order by b.SINAVTARIH

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp  ) as b 
			--order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp  ) as b 
			--order by b.SINAVTARIH
				
			
			--Select  SINAVAD, ID_SINAV, SINAVTARIH, ID_DERS, ID_SUBE, SUBEAD, DERSAD, NET into ##pivots from #Net
			--DELETE FROM ##pivots
			--SELECT TOP 1 ID_DERS,DERSAD INTO ##GenelOrt FROM #Net
			--DELETE FROM ##GenelOrt

		

			if not exists (select * from #Net)
			begin
				Select 				
					ID_DERS=null,
					ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					DERSAD=null
				into ##pivots

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt
			end

		

		Set @SQL='	
			
			Select
				ID_DERS,
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				DERSAD,
				999 BOLUMNO,
				'+@Columns2+' 
			into ##pivots
			from (
				Select 
					SINAVAD,
					ID_UNITETARAMASINAV,
					
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					DERSAD,
					-- TS,
					NET
				from #Net
			) AS S
			PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY DERSAD,SUBEAD,ID_SUBE,ID_DERS,ID_SINIF,SINIFAD	
				
			SELECT ID_DERS,DERSAD,999 BOLUMNO,'+@Columns3+'
			INTO ##GenelOrt
			FROM ##pivots 
			GROUP BY ID_DERS,DERSAD		
		'
		PRINT @SQL
		EXEC (@SQL)
		
		SELECT * 
		INTO #PIVOTS
		FROM ##pivots 
		DROP TABLE IF EXISTS ##pivots
		
		SELECT * 
		INTO #GENELORT
		FROM ##GenelOrt 		
		DROP TABLE IF EXISTS ##GenelOrt


		--BEGIN

		--	SELECT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,VD.ID_DERS,VD.DERSAD DERSAD,UO.PUAN,UO.TCKIMLIKNO
		--	INTO	#Temp11
		--	FROM	UniteTaramaSinav					S	WITH (NOLOCK)
		--	JOIN	UniteTaramaSoru			SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASINAV= S.ID_UNITETARAMASINAV	
		--	JOIN    UniteTaramaOgrenci      UO  WITH (NOLOCK)	ON  UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
		--	--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		--	--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
		--	JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SO.ID_DERS
		--	WHERE	
		--	--S.DURUM			= 2
		--		S.AKTIF			= 1
		--		--AND (OZEL=0 OR @OZELSINAVGOR=1)
		--		AND S.ID_UNITETARAMASINAV=@ID_UNITETARAMASINAV

		--	SELECT SINAVAD,DERSAD,CAST(AVG(PUAN) AS decimal(8,2)) AS ORT INTO #ORT  FROM #Temp11 
		--	GROUP BY DERSAD,SINAVAD
		--INSERT INTO #ORT
		--	SELECT SINAVAD,'TOPLAM',CAST(SUM(PUAN)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS ORT  FROM #Temp11
		--	GROUP BY SINAVAD
			

		--	SELECT value SINAVAD INTO #COL FROM string_split(@Columns,',')
		--	WHILE EXISTS (SELECT * FROM #COL)
		--	BEGIN
		--		DECLARE @COL VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL ORDER BY 1 DESC)
		--	SET @SQL = N'
		--			UPDATE P
		--			SET	P.'+@COL+' = O.ORT
		--			FROM #GENELORT P
		--			JOIN #ORT	O ON O.DERSAD = P.DERSAD AND ''[''+ O.SINAVAD +'']'' = '''+@COL+'''
		--		'
		--		PRINT @SQL
		--		EXEC (@SQL)
		--		DELETE FROM #COL WHERE SINAVAD = (SELECT TOP 1 SINAVAD FROM #COL ORDER BY 1 DESC)
		--	END
		--END
		
		--DECLARE @ID_EGITIMTURU VARCHAR(15)=
		--CASE @ID_SINAVTURU 
		--								WHEN  0 THEN 6 
		--								WHEN  2 THEN 7 
		--								WHEN  3 THEN 8 
		--								WHEN  6 THEN 9 
		--								WHEN  5 THEN 10
		--								--YENENLEEKLENEİ 
		--								WHEN  8  THEN 11
		--								WHEN  9 THEN 12
		--								WHEN  7 THEN 13
		--								WHEN  10 THEN 14
										
		--								END

		--	CASE  WHEN @ID_SINAVTURU = 2 THEN 7
		--		  WHEN @ID_SINAVTURU = 3 THEN 8
		--		  WHEN @ID_SINAVTURU = 6 THEN 9
		--		  ELSE @ID_SINAVTURU 
		--		  END 

	
	
			
		SELECT DISTINCT T.ID_UNITETARAMASINAV,T.SINAVAD
		INTO #SinavList
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value
		
	
		--DECLARE @ILK_ID_SINAV INT=(SELECT TOP 1 VALUE FROM OPENJSON(@ID_UNITETARAMASINAV) WHERE VALUE > 0)
	
	

		SELECT		DISTINCT SS.TAKMAAD , SS.TAKMAAD AS DERSAD,SS.BOLUMNO	BOLUM	
		INTO #BOLUMLER		
		FROM		#PIVOTS				G
		JOIN		UniteTaramaSinav				S	ON	S.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
		JOIN		UniteTaramaSoru			SD	ON	SD.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
		JOIN		eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= SD.ID_DERS
		JOIN		SinavDers			SS	ON	SS.ID_DERS	= D.ID_DERS
		ORDER BY BOLUM

		INSERT INTO #BOLUMLER (TAKMAAD,DERSAD,BOLUM)
		SELECT DISTINCT DERSAD,DERSAD,(SELECT MAX(BOLUM) FROM #BOLUMLER)+ ROW_NUMBER() OVER(ORDER BY DERSAD ASC) FROM #PIVOTS  P
	--	WHERE DERSAD !='TOPLAM' AND  DERSAD NOT IN (SELECT DERSAD FROM #BOLUMLER )
		
		


		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS	G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		
		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD
		
		SELECT  distinct P.*,  isnull(K.AD+' '+K.SOYAD,'') ADSOYAD 
		INTO #T1
		FROM #PIVOTS p		
		JOIN eokul_v2.DBO.Ders				D	ON	D.ID_DERS = P.ID_DERS
		--JOIN eokul_v2.DBO.Ders				D2	ON	D2.DERSAD = D.DERSAD
												--AND D2.ID_KADEME3 = D.ID_KADEME3
												AND D.AKTIF = 1
		--left JOIN eokul_v2.DBO.dersOgretmen do	on	do.ID_SINIF=p.ID_SINIF 
												--AND DO.ID_DERS=D2.ID_DERS 
		  left join		[OkyanusDB].[dbo].[v3DersProgram] do on do.ID_SINIF=P.ID_SINIF
		  And do.ID_DERS=d.ID_DERS
		  left JOIN v3Kullanici	K	ON	K.TCKIMLIKNO=DO.TCKIMLIKNO
		
		ORDER BY ID_DERS DESC
		
		--select * from #PIVOTS
		
		
		END
		------------------------------------------ PUAN
		BEGIN

		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
		SELECT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,UO.TCKIMLIKNO
				,SN.ID_SINIF,SN.AD SINIFAD
				,O.ID_SUBE,SU.AD SUBEAD
				--,PT.ID_SINAVPUANTURU,PT.AD PUANTURU
				,UO.PUAN
		INTO	#Temp2
		FROM	UniteTaramaSinav					S	WITH (NOLOCK)
		JOIN	UniteTaramaSoru			SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASINAV= S.ID_UNITETARAMASINAV
		JOIN    UniteTaramaOgrenci      UO  WITH (NOLOCK)	ON  UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
		--JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		--JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
		--													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
		--JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= UO.TCKIMLIKNO
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		WHERE	--S.DURUM			= 2
			 S.AKTIF			= 1
			  AND UO.AKTIF=1
			--AND (OZEL=0 OR @OZELSINAVGOR=1)
			 --S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_UNITETARAMASINAV))
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			--AND PT.ID_SINAVTURU	= @ID_SINAVTURU
			--AND S.ID_KADEME3	= @ID_KADEME3
			AND S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND S.ID_UNITETARAMASINAV=@ID_UNITETARAMASINAV	
		--SELECT * FROM #Temp
		
			
			
		SELECT ID_UNITETARAMASINAV,SINAVAD,CAST(AVG(PUAN) AS DECIMAL(8,2)) PUAN ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		INTO #Net2
		FROM #Temp2	T
		GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD


		SET @SQL 	  =NULL
		SET @Columns  =NULL
		SET @Columns2 =NULL
		SET @Columns3 =NULL

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp2  ) as b 
			--order by b.SINAVTARIH

		--Select @Columns2=Coalesce(@Columns2+',','')+'MAX(CAST(ISNULL(CAST('+QUOTENAME(SINAVAD)+' AS VARCHAR),''-'') AS VARCHAR)) AS ' +QUOTENAME(SINAVAD) from (
			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp2  ) as b 
			--order by b.SINAVTARIH
				
				
			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp2  ) as b 
			--order by b.SINAVTARIH

			

			if not exists (select * from #Net2)
			begin
				Select 				
				ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					ID_SINAVPUANTURU=null,
					PUANTURU=null
				into ##pivots2

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt2
			end
			
		
		Set @SQL='	
			
			Select 				
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				
				
				'+@Columns2+' 
			into ##pivots2
			from (
				Select 
					SINAVAD,
					ID_UNITETARAMASINAV,
					
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					
					-- TS,
					PUAN
				from #Net2
			) AS S
			PIVOT (MAX(PUAN) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY SUBEAD,ID_SUBE,ID_SINIF,SINIFAD

	
			SELECT '+@Columns3+'
			INTO ##GenelOrt2
			FROM ##pivots2 
			
		'
		PRINT @SQL
		EXEC (@SQL)

		SELECT * 
		INTO #PIVOTS2
		FROM ##pivots2 
		DROP TABLE ##pivots2
		
		SELECT * 
		INTO #GENELORT2
		FROM ##GenelOrt2 		
		DROP TABLE ##GenelOrt2




		SELECT DISTINCT T.ID_UNITETARAMASINAV,T.SINAVAD
		INTO #SinavList2
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp2 T ON '['+T.SINAVAD+']'=FN.Value
		--SELECT DISTINCT ID_SUBE,SUBEAD FROM #Temp2
		--SELECT DISTINCT ID_SINAVPUANTURU,PUANTURU FROM #Temp2

		
		END
		------------------------------------------ JSON SEND
		
		 select(
				select * from(
						select 
						(					
							SELECT		*
							FROM		#T1 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							--	AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							ORDER BY	BOLUMNO 
							FOR JSON AUTO
						) as t1,
						
						(					
							SELECT ID_UNITETARAMASINAV,SINAVAD FROM #SinavList
							ORDER BY SINAVAD
							FOR JSON AUTO
						) as t2,
						(					
							SELECT		*
							FROM		#PIVOTS2 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							--	AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							--ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t3,
						(					
							SELECT ID_UNITETARAMASINAV,SINAVAD FROM #SinavList2
							--ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t4,

						(					
							SELECT		*
							FROM		#GENELORT 
							--ORDER BY	ID_DERS DESC
							FOR JSON AUTO
						) as t5,
						(					
							SELECT		*
							FROM		#GENELORT2
							--ORDER BY	ID_SINAVPUANTURU DESC
							FOR JSON AUTO
						) as t6
						
												
					) as tablo FOR JSON AUTO
				) as tt

				--select * from #GENELORT
				--Select * from  #T1

		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
	GO

	USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_UniteTaramaTopluKarne]    Script Date: 23.11.2021 15:38:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_UniteTaramaTopluKarne]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@ID_SINIFLIST			VARCHAR(MAX)= NULL,
	@ID_UNITETARAMASINAV	INT			= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SINIFLIST			= @ID_SINIFLIST					
				,ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	ÖĞRENCİ RAPOR			
			BEGIN
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #OGRENCILIST

				SELECT DISTINCT
					 O.SUBEAD
					,O.SINIFAD
					,O.TCKIMLIKNO
					,O.AD
					,O.SOYAD
					,O.ID_SINIF
				INTO #OGRENCILIST
				FROM OkyanusDB.DBO.vw_OgrenciDetayTum	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLIST))

				SELECT DISTINCT
					 SS.ID_DERS
					,O.TCKIMLIKNO
					,S.ID_UNITETARAMASINAV
					,SINAVAD		= S.AD
					,KITAPCIK		= SK.AD
					,SORUPUAN		= SS.PUAN
					,OGRENCIPUAN	= O.PUAN
					,KAZANIMKOD		= SS.KAZANIMKOD
					,SS.ID_UNITETARAMASORU
					,ADSOYAD	= CONCAT_WS(' ',OD.AD,OD.SOYAD)
					,OD.SUBEAD
					,OD.SINIFAD	
					,OD.ID_SINIF
					,OD.ID_SUBE
					,SS.SORUNO
					,DERSAD			= D.AD
					,KAZANIM		= ISNULL(DU.AD, '')
					,SINIFKATILIM	= NULL
					,OKULKATILIM	= NULL
					,GENELKATILIM	= NULL
				INTO #TEMP
				FROM UniteTaramaSinav						S
				JOIN UniteTaramaKitapcik					SK	ON	SK.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru						SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN UniteTaramaOgrenci						O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
																AND O.ID_UNITETARAMAKITAPCIK= SK.ID_UNITETARAMAKITAPCIK
				JOIN OkyanusDB.DBO.vw_OgrenciDetayTum		OD	ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
																AND OD.DONEM				= S.DONEM
				JOIN OkyanusDB.DBO.v3Ders					D	ON	D.ID_DERS				= SS.ID_DERS
				LEFT JOIN OkyanusDB.DBO.v3SinavDersUnite	DU	ON	DU.KOD					= SS.KAZANIMKOD
				WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV 
					AND (S.OVGORSUN				= 1
						OR EXISTS( SELECT TOP 1 1 FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI NOT IN(3,4) AND TCKIMLIKNO = @TCKIMLIKNO  ))
					AND S.AKTIF					= 1
					AND O.AKTIF					= 1
				ORDER BY O.TCKIMLIKNO

				UPDATE T SET
					 SINIFKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP S WHERE S.ID_SINIF = T.ID_SINIF	)
					,OKULKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP S WHERE S.ID_SUBE  = T.ID_SUBE	)
					,GENELKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP									)
				FROM #TEMP			T
				JOIN #OGRENCILIST	OL	ON	OL.TCKIMLIKNO	= T.TCKIMLIKNO


				;WITH OGR AS (SELECT DISTINCT 
					 T.TCKIMLIKNO
					,T.SUBEAD
					,T.SINIFAD
					,T.ADSOYAD
					,T.SINAVAD
					,T.KITAPCIK
					,T.SINIFKATILIM
					,T.OKULKATILIM
					,T.GENELKATILIM					
				FROM #TEMP						T
				JOIN #OGRENCILIST				OL	ON	OL.TCKIMLIKNO	= T.TCKIMLIKNO			
				) 
				SELECT *
				,FOTOGRAF	= (	SELECT TOP 1 R.FOTOGRAF 
									FROM OkyanusDB.DBO.v3Resim	R	
									WHERE	R.TCKIMLIKNO= OGR.TCKIMLIKNO
										AND R.SIRANO	= 1)
				FROM OGR


				SELECT T.*
					,FOTOGRAF	= R.FOTOGRAF
				FROM #TEMP						T
				JOIN #OGRENCILIST				OL	ON	OL.TCKIMLIKNO	= T.TCKIMLIKNO
				LEFT JOIN OkyanusDB.DBO.v3Resim	R	ON	R.TCKIMLIKNO= T.TCKIMLIKNO
													AND R.SIRANO	= 1
				ORDER BY DERSAD, SORUNO, ID_UNITETARAMASORU

	
				SELECT DISTINCT
					 O.TCKIMLIKNO
					,S.ID_UNITETARAMASINAV
					,SINAVAD		= S.AD
					,YUZDE			= CEILING( CAST(CAST(SUM(O.PUAN) AS FLOAT) / SUM(SS.PUAN) * 100 AS DECIMAL(8,2)))
				FROM UniteTaramaSinav		S
				JOIN UniteTaramaKitapcik	K	ON	K.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru		SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN UniteTaramaOgrenci		O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
												AND O.ID_UNITETARAMAKITAPCIK= K.ID_UNITETARAMAKITAPCIK
				JOIN #OGRENCILIST			OL	ON	OL.TCKIMLIKNO			= O.TCKIMLIKNO
				WHERE(S.OVGORSUN	 = 1
						OR EXISTS( SELECT TOP 1 1 FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI NOT IN(3,4) AND TCKIMLIKNO = @TCKIMLIKNO  ))
					AND S.AKTIF		 = 1
					AND O.AKTIF		 = 1
				GROUP BY O.TCKIMLIKNO, S.ID_UNITETARAMASINAV, S.AD

				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #OGRENCILIST

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpgradeSoru]    Script Date: 23.11.2021 15:38:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_UpgradeSoru]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@ID_TKTYASARALIGI			INT				= NULL,
	@ID_TKTKATEGORI				INT				= NULL,
	@ID_TKTPUAN					INT				= NULL,
	@ID_TKTSORU					INT				= NULL,
	@YASAY						TINYINT			= NULL,
	@ID_SUBE					INT				= NULL,
	@ID_SINAVGRUP				TINYINT			= NULL,
	@ID_SINIF					INT				= NULL,
	@TCKIMLIKNO_OGR				VARCHAR(11)		= NULL,
	@ID_TKTSINAV				INT				= NULL,
	@ID_TKTSINAVORTALAMALIST	VARCHAR(MAX)	= NULL,
	@ID_TKTTEST					INT				= NULL,
	@ID_TKTDONEM				INT				= NULL,
	@ID_TKTDONEMS				NVARCHAR(MAX)	= NULL,
	@ID_SINIFS					NVARCHAR(MAX)	= '[]',
	@ID_SATISTURU				INT				= NULL,
	@SQLJSON					NVARCHAR(MAX)	= NULL,	
	@DONEM						VARCHAR(4)		= NULL,
	@TARIH						VARCHAR(MAX)	= NULL,
	@HESAPTURU					BIT				= NULL,
	@BASLANGIC					VARCHAR(MAX)	= NULL,
	@BITIS						VARCHAR(MAX)	= NULL,
	@HESAPTURUSORU				BIT				= NULL,
	@KAZANIMADEDI				INT				= NULL,
	@ID_SUBES					VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUPS				VARCHAR(MAX)	= NULL,
	@TUR                        VARCHAR(20)     =NULL,
    @SAYI					    int				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM								= @ISLEM					
			,TCKIMLIKNO							= @TCKIMLIKNO				
			,OTURUM								= @OTURUM					
			,ID_MENU							= @ID_MENU				
			,ID_TKTYASARALIGI					= @ID_TKTYASARALIGI		
			,ID_TKTKATEGORI						= @ID_TKTKATEGORI			
			,ID_TKTPUAN							= @ID_TKTPUAN				
			,ID_TKTSORU							= @ID_TKTSORU				
			,YASAY								= @YASAY					
			,ID_SUBE							= @ID_SUBE				
			,ID_SINAVGRUP						= @ID_SINAVGRUP			
			,ID_SINIF							= @ID_SINIF				
			,TCKIMLIKNO_OGR						= @TCKIMLIKNO_OGR			
			,ID_TKTSINAV						= @ID_TKTSINAV			
			,ID_TKTSINAVORTALAMALIST			= @ID_TKTSINAVORTALAMALIST
			,ID_TKTTEST							= @ID_TKTTEST				
			,ID_TKTDONEM						= @ID_TKTDONEM			
			,ID_TKTDONEMS						= @ID_TKTDONEMS			
			,ID_SINIFS							= @ID_SINIFS				
			,ID_SATISTURU						= @ID_SATISTURU			
			,SQLJSON							= @SQLJSON				
			,DONEM								= @DONEM					
			,TARIH								= @TARIH					
			,HESAPTURU							= @HESAPTURU				
			,BASLANGIC							= @BASLANGIC				
			,BITIS								= @BITIS					
			,HESAPTURUSORU						= @HESAPTURUSORU			
			,KAZANIMADEDI						= @KAZANIMADEDI			
			,ID_SUBES							= @ID_SUBES				
			,ID_SINAVGRUPS						= @ID_SINAVGRUPS			
			,TUR								= @TUR                    
			,SAYI								= @SAYI					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		DECLARE @ID_ST			INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	Yaş Aralığı Listele
			BEGIN
				SELECT ID_TKTYASARALIGI, YASAY1, YASAY2
				FROM UpgradeYasAraligi
				WHERE AKTIF=1
			END

			IF @ISLEM = 2	--	Kategori Listele (Puan Tablosunda Yaş Aralığı Bulunan Kategoriler)
			BEGIN
				SELECT ID_TKTKATEGORI, AD FROM [dbo].[UpgradeKategori]
			END

			IF @ISLEM = 3	--	Puan Aralığı Listele (Puan Tablosunda Yaş Aralığı ve Kategoriye Göre)
			BEGIN
				SELECT ID_TKTPUAN, HARF,
					   SEVIYE = (CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END)
				FROM UpgradePuanTek
				WHERE (@ID_TKTKATEGORI IS NULL OR ID_TKTKATEGORI = @ID_TKTKATEGORI)
				ORDER BY HARF
			END

			IF @ISLEM = 4	--	Soru Ekle
			BEGIN
				IF NOT EXISTS (SELECT Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null))
				BEGIN
					RAISERROR ('Dönem seçimi zorunludur!' , -- Message text.
						16, -- Severity.
						1 -- State.
						);
				END
				ELSE
				BEGIN
					INSERT INTO UpgradeSoru(ID_TKTPUAN, KYE_KULLANICI, ID_SATISTURU, KAZANIMADEDI) VALUES(@ID_TKTPUAN, @TCKIMLIKNO, @ID_SATISTURU, @KAZANIMADEDI)
					SET @ID_TKTSORU=@@IDENTITY

					INSERT INTO UPGRADESORUDONEM (ID_TKTSORU,ID_TKTDONEM)
					((SELECT @ID_TKTSORU,Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null) ) )
						
					SELECT @ID_TKTSORU
				END
			END

			IF @ISLEM = 5	--	Soru Listele
			BEGIN
					SELECT	DISTINCT
							 S.[ID_TKTSORU]
							,S.[ID_TKTPUAN]
							,S.[ID_TKTKATEGORI]
							,S.[KATEGORIAD]
							,S.[ID_SATISTURU]
							,S.[HARF]
							,(CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END) as SEVIYE
							,(SELECT CASE WHEN GRUP='Ü.Z İLKOKUL' THEN ACIKLAMA+ ' (ÜSTÜN)' ELSE ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru WHERE ID_SATISTURU=S.ID_SATISTURU) as GRUP
							,S.[DOSYAAD]
							,S.[DOSYAUZANTI]
							,S.[KYE_KULLANICI]
							,S.[KYE_TARIH]
							,S.[KAZANIMADEDI]
							,STUFF((SELECT ',' + DONEM 
								FROM [vw_UpgradeSoru]
								where [ID_TKTSORU]=S.[ID_TKTSORU] and [ID_SATISTURU]=S.[ID_SATISTURU]
								FOR XML PATH('')) ,1,1,'') as DONEM
					FROM [vw_UpgradeSoru]	S
					WHERE	(@ID_TKTKATEGORI IS NULL	OR @ID_TKTKATEGORI = 0		OR ID_TKTKATEGORI=@ID_TKTKATEGORI) AND
							(@ID_SATISTURU IS NULL		OR @ID_SATISTURU = 0		OR ID_SATISTURU=@ID_SATISTURU) AND
							(@ID_TKTPUAN IS NULL		OR @ID_TKTPUAN = 0			OR ID_TKTPUAN=@ID_TKTPUAN) AND
							(@HESAPTURU = 0 
							OR @BASLANGIC IS NULL 
							OR @BITIS IS NULL 
							OR (
								CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
								AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)))
					GROUP BY S.[ID_TKTSORU]
							,S.[ID_TKTPUAN]
							,S.[ID_TKTKATEGORI]
							,S.[KATEGORIAD]
							,S.[ID_SATISTURU]
							,S.[HARF]
							,S.[DOSYAAD]
							,S.[DOSYAUZANTI]
							,S.[KYE_KULLANICI]
							,S.[KYE_TARIH]
							,S.DONEM 
							,S.[KAZANIMADEDI]
  	
			END

			IF @ISLEM = 6	--	Soru Sil
			BEGIN
				BEGIN TRY
					DELETE FROM UpgradeSoruDonem WHERE ID_TKTSORU=@ID_TKTSORU
					DELETE FROM UpgradeSoru WHERE ID_TKTSORU=@ID_TKTSORU
					DECLARE @ID_DOKUMANTEMP INT = (SELECT ID_DOKUMAN FROM DokumanDetay WHERE ID = @ID_TKTSORU)	
					DELETE DD 
					FROM DokumanDetay DD
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE DD.ID = @ID_TKTSORU AND D.ID_DOKUMANTUR=1
					DELETE FROM Dokuman WHERE ID_DOKUMAN = @ID_DOKUMANTEMP AND ID_DOKUMANTUR=1
				END TRY
				BEGIN CATCH
					SELECT 
						@ErrorSeverity	= ERROR_SEVERITY(),
						@ErrorState		= ERROR_STATE()
			
					RAISERROR ('Bu soru öğrenci sınavlarında kullanıldığı için silinemedi.' , -- Message text.
								@ErrorSeverity, -- Severity.
								@ErrorState -- State.
								);
				END CATCH;
			END

			IF @ISLEM = 7	--	Sınav Listele
			BEGIN
				SELECT ID_TKTSINAV, SINAVAD FROM UpgradeSinav WHERE ID_TKTSINAV < @ID_TKTSINAV OR @ID_TKTSINAV IS NULL ORDER BY ID_TKTSINAV ASC
			END

			IF @ISLEM = 8	--	Öğrenci Kategori ve Puan Listele (Puan Girişi Modal)
			BEGIN

				SELECT DISTINCT 
					P.ID_TKTKATEGORI, 
					P.AD,
					PUAN = ISNULL((SELECT PUAN FROM UpgradeOgrenciPuanDetay WHERE ID_TKTKATEGORI=P.ID_TKTKATEGORI AND ID_TKTOGRENCIPUAN=(SELECT ID_TKTOGRENCIPUAN FROM UpgradeOgrenciPuan WHERE TCKIMLIKNO=@TCKIMLIKNO_OGR AND ID_TKTSINAV=@ID_TKTSINAV)),0)
				FROM vw_UpgradePuan P
				WHERE
					 --P.ID_SINAVGRUP=@ID_SINAVGRUP AND 
					  --(@YASYIL BETWEEN P.YASYIL1 AND P.YASYIL2) AND
					  (@YASAY BETWEEN P.YASAY1 AND P.YASAY2)  
				ORDER BY P.ID_TKTKATEGORI ASC

			END

			IF @ISLEM = 9	--	Puan Kaydet
			BEGIN

				--Daha Önce Tanımlandıysa ID Hafızaya Al
				DECLARE @ID_TKTOGRENCIPUAN INT
				SELECT @ID_TKTOGRENCIPUAN=ID_TKTOGRENCIPUAN FROM UpgradeOgrenciPuan WHERE TCKIMLIKNO=@TCKIMLIKNO_OGR AND ID_TKTSINAV=@ID_TKTSINAV
			
				--Önce Sil
				DELETE FROM UpgradeOgrenciPuanDetay WHERE ID_TKTOGRENCIPUAN=@ID_TKTOGRENCIPUAN
				DELETE FROM UpgradeOgrenciPuan WHERE ID_TKTOGRENCIPUAN=@ID_TKTOGRENCIPUAN
			
				--Sonra Ekle
				INSERT INTO UpgradeOgrenciPuan (ID_TKTSINAV, TCKIMLIKNO, KYE_KULLANICI, KYE_TARIH)
				VALUES (@ID_TKTSINAV, @TCKIMLIKNO_OGR, @TCKIMLIKNO, GETDATE())

				SET @ID_TKTOGRENCIPUAN = @@IDENTITY				
				INSERT INTO UpgradeOgrenciPuanDetay (ID_TKTOGRENCIPUAN, ID_TKTKATEGORI, PUAN)
				SELECT @ID_TKTOGRENCIPUAN, ID_TKTKATEGORI, PUAN FROM OPENJSON (@SQLJSON, '$.KATEGORIPUAN_LISTESI')
				WITH  (ID_TKTKATEGORI INT, PUAN int ) 

			END

			IF @ISLEM = 10	--	Tkt Öğrenci Karne Getir
			BEGIN	
				SELECT DISTINCT O.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, SU.AD AS SUBEAD, SAT.ID_SATISTURU, SGS.ID_KADEME3
				INTO #TMP_OGRENCIBILGI
				FROM	   [dbo].[v3OgrenciTum]			O
				INNER JOIN [dbo].[v3Satislar]			SAT	ON SAT.ID_SOZLESME = O.ID_SOZLESME AND SAT.ID_SINIF IS NOT NULL
				INNER JOIN [dbo].[v3SubeGrupSinifTum]	SGS	ON SGS.ID_SINIF = SAT.ID_SINIF
				INNER JOIN [dbo].[v3SatisTuru]			ST	ON ST.ID_SATISTURU = SAT.ID_SATISTURU
				INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.TCKIMLIKNO = O.TCKIMLIKNO AND SY.XBASE=1
				INNER JOIN [dbo].[v3Kullanici]			K	ON k.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN [dbo].[v3Sube]				SU	ON SU.ID_SUBE = SY.ID_SUBE
				WHERE 
					(@TCKIMLIKNO_OGR IS NULL OR @TCKIMLIKNO_OGR = '0' OR O.TCKIMLIKNO = @TCKIMLIKNO_OGR) 
				AND	(@ID_SINIFS IS NULL OR @ID_SINIFS = '[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFS)))
				AND	(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP = 0 OR ST.ID_KADEME3 = @ID_SINAVGRUP) 
				AND (@ID_SUBE IS NULL OR @ID_SUBE = 0 OR O.ID_SUBE = @ID_SUBE) 
				AND O.DONEM = @DONEM
				ORDER BY O.TCKIMLIKNO 
								
				SELECT os.TCKIMLIKNO, OB.ID_KADEME3, s.ID_TKTTEST, s.ID_KATEGORI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE os.SINAVTARIH END) AS SINAV_TARIH, CASE WHEN OB.ID_KADEME3 <> 4 AND OB.ID_KADEME3 <> 5 THEN SUM(CASE WHEN s.ID_TKTTEST = 2 THEN 2 ELSE 1 END) ELSE SUM(1) END AS PUAN
				INTO #TEMP
				FROM dbo.TKTOgrenciCevap AS oc 
				INNER JOIN dbo.TKTSoru AS s ON s.ID_TKTSORU = oc.ID_TKTSORU 
				INNER JOIN TKTOgrenciSinav os ON os.ID_TKTOGRENCISINAV = oc.ID_TKTOGRENCISINAV AND os.ID_TKTTEST = s.ID_TKTTEST
				INNER JOIN #TMP_OGRENCIBILGI OB ON OB.TCKIMLIKNO = os.TCKIMLIKNO
				WHERE (oc.OGRENCICEVAP = 1) AND os.DONEM = @DONEM
				GROUP BY os.TCKIMLIKNO, s.ID_KATEGORI, s.ID_TKTTEST, os.SINAVTARIH, OB.ID_KADEME3

				SELECT ktable.TCKIMLIKNO, ktable.ID_TKTTEST, ktable.ID_KATEGORI, ktable.SINAV_TARIH, ktable.PUAN, se.HARF
				INTO #TEMP2
				FROM #TEMP AS ktable 
				INNER JOIN v3Kullanici AS k ON k.TCKIMLIKNO = ktable.TCKIMLIKNO 
				LEFT JOIN UpgradeYasAraligi AS ya ON ya.YASAY1 <= DATEDIFF(MONTH, k.DOGUMTARIHI, ktable.SINAV_TARIH) - 1 AND ya.YASAY2 >= DATEDIFF(MONTH, k.DOGUMTARIHI, ktable.SINAV_TARIH) - 1 
				INNER JOIN UpgradePuan AS up ON up.ID_TKTKATEGORI = ktable.ID_KATEGORI AND up.ID_KADEME3 = (CASE WHEN ktable.ID_KADEME3 = 4 OR ktable.ID_KADEME3 = 5 THEN ktable.ID_KADEME3 ELSE 0 END) AND ((ktable.ID_KADEME3 = 4 OR ktable.ID_KADEME3 = 5) OR up.ID_TKTYASARALIGI = ya.ID_TKTYASARALIGI) AND up.PUAN1 <= ktable.PUAN AND up.PUAN2 >= ktable.PUAN 
				INNER JOIN TKTSeviye AS se ON se.HARF = up.HARF	

				CREATE TABLE #TOTALRESULTTABLE(ID_TKTSORU INT, TCKIMLIKNO VARCHAR(11), ADSOYAD VARCHAR(200), SUBEAD VARCHAR(200), DOSYAAD VARCHAR(200), DOSYAUZANTI VARCHAR(10), ID_TKTKATEGORI int); 
				DECLARE @TEMPTCKIMLIK VARCHAR(11) 
				--Toplu sınav kağıdıda oluşturulabilmesi için
				WHILE EXISTS(SELECT * FROM #TMP_OGRENCIBILGI)
				BEGIN
					SELECT TOP 1 @TEMPTCKIMLIK = TCKIMLIKNO	From #TMP_OGRENCIBILGI

					--SET @ID_ST = (	
					--						SELECT ST.ID_SATISTURU
					--						FROM OkyanusDB.dbo.v3OgrenciTum O
					--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
					--						WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND O.DONEM = @DONEM
					--					)

					IF EXISTS(	
								--SELECT * FROM UpgradeOgrenciSinav OS
								--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
								--WHERE TCKIMLIKNO=@TEMPTCKIMLIK AND ID_TKTSINAV=@ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
								SELECT * FROM UpgradeOgrenciSinavDonem OSD
								JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
								WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND ID_TKTSINAV = @ID_TKTSINAV AND DONEM = @DONEM
							)
					BEGIN
						--INSERT INTO #TOTALRESULTTABLE 
						--select DISTINCT OS.ID_TKTSORU, OS.TCKIMLIKNO, K.ADSOYAD, K.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI
						--from UpgradeOgrenciSinav OS 
						--WITH (NOLOCK)
						--INNER JOIN #TMP_OGRENCIBILGI K ON K.TCKIMLIKNO=OS.TCKIMLIKNO
						--INNER JOIN vw_UpgradeSoru S	ON S.ID_TKTSORU=OS.ID_TKTSORU 
						--WHERE OS.TCKIMLIKNO=@TEMPTCKIMLIK AND OS.ID_TKTSINAV=@ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST

						INSERT INTO #TOTALRESULTTABLE 
						SELECT DISTINCT OSDS.ID_TKTSORU, OSD.TCKIMLIKNO, K.ADSOYAD, K.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI
						FROM UpgradeOgrenciSinavDonem OSD 
						INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
						INNER JOIN #TMP_OGRENCIBILGI K ON K.TCKIMLIKNO = OSD.TCKIMLIKNO
						INNER JOIN vw_UpgradeSoru S	ON S.ID_TKTSORU = OSDS.ID_TKTSORU 
						WHERE OSD.TCKIMLIKNO = @TEMPTCKIMLIK AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					END
					ELSE
					BEGIN
						SELECT S.ID_TKTSORU, O.TCKIMLIKNO, O.ADSOYAD, O.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI, ID_TKTSINAV = @ID_TKTSINAV, S.AY 
						INTO #TMP_TKTOGRENCISINAV
						FROM vw_UpgradeSoru S
						INNER JOIN #TEMP2						OKP	ON OKP.ID_KATEGORI = S.ID_TKTKATEGORI
						INNER JOIN #TMP_OGRENCIBILGI			O	ON O.TCKIMLIKNO = OKP.TCKIMLIKNO 
						WHERE
						((@ID_TKTTEST < 4  AND OKP.ID_TKTTEST = @ID_TKTTEST) OR (@ID_TKTTEST = 4 AND OKP.ID_TKTTEST = (SELECT MAX(ID_TKTTEST) FROM #TEMP2 T WHERE T.TCKIMLIKNO = OKP.TCKIMLIKNO AND T.ID_KATEGORI = OKP.ID_KATEGORI)))
						AND (OKP.HARF = S.HARF)
						AND (S.ID_SATISTURU=O.ID_SATISTURU)
						AND (S.AY=DATEPART(month, GETDATE()))
						AND OKP.TCKIMLIKNO=@TEMPTCKIMLIK
						AND (
								@HESAPTURUSORU = 0 
								OR @BASLANGIC IS NULL 
								OR @BITIS IS NULL 
								OR (
										CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
										AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)
									)
							)
						ORDER BY OKP.TCKIMLIKNO 

						--SELECT ID_TKTSORU, TCKIMLIKNO, ADSOYAD, SUBEAD, DOSYAAD, DOSYAUZANTI, ID_TKTKATEGORI INTO #TMP_TKTOGRENCISINAV2 FROM #TMP_TKTOGRENCISINAV
						--WITH (NOLOCK) WHERE
						--(ID_TKTSORU NOT IN (SELECT ID_TKTSORU FROM UpgradeOgrenciSinav WHERE TCKIMLIKNO=@TEMPTCKIMLIK)) 
						--and ID_TKTSINAV=@ID_TKTSINAV

						SELECT ID_TKTSORU, TCKIMLIKNO, ADSOYAD, SUBEAD, DOSYAAD, DOSYAUZANTI, ID_TKTKATEGORI 
						INTO #TMP_TKTOGRENCISINAV2 
						FROM #TMP_TKTOGRENCISINAV
						WITH (NOLOCK) WHERE
						(ID_TKTSORU NOT IN (SELECT ID_TKTSORU FROM UpgradeOgrenciSinavDonem OSD JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSD.DONEM = @DONEM)) 
						and ID_TKTSINAV = @ID_TKTSINAV
						--Eskiden sorulmuş sorular sorulmasın 
		
						--KATEGORILER OGRENCI PUANINA GORE SIRALANIYOR
						CREATE TABLE #SIRALAMA (KategoriRow INT, ID_TKTKATEGORI INT)
						IF @ID_TKTTEST = 4 AND @ID_TKTSINAVORTALAMALIST IS NOT NULL
						BEGIN
							INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
							SELECT		ROW_NUMBER() OVER(ORDER BY CAST((CAST(SUM(OSDS.DOGRUKAZANIMADEDI) AS decimal(18, 2)) / CAST(SUM(S.KAZANIMADEDI) AS decimal(18, 2)) * 100.0) AS decimal(18, 2)) asc) AS 'KategoriRow',
										S.ID_TKTKATEGORI
							FROM UpgradeOgrenciSinavDonem OSD
							JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							JOIN vw_UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
							WHERE OSD.TCKIMLIKNO = @TEMPTCKIMLIK AND OSD.DONEM = @DONEM AND OSDS.DOGRUKAZANIMADEDI IS NOT NULL AND S.KAZANIMADEDI IS NOT NULL AND OSD.ID_TKTSINAV IN (SELECT VALUE FROM OPENJSON(@ID_TKTSINAVORTALAMALIST))
							GROUP BY OSD.TCKIMLIKNO, S.ID_TKTKATEGORI, S.KATEGORIAD

							IF (SELECT COUNT(1) FROM #SIRALAMA) = 0 -- ORTALAMA YOK İSE ÖN TESTE GÖRE
							BEGIN
								INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
								SELECT ROW_NUMBER() OVER(ORDER BY PUAN asc) AS 'KategoriRow', ID_KATEGORI AS ID_TKTKATEGORI
								FROM vw_OgrenciKategoriPuan
								WITH (NOLOCK)
								WHERE TCKIMLIKNO=@TEMPTCKIMLIK and ID_TKTTEST = 1 and (@DONEM IS NULL OR DONEM = @DONEM)
							END
						END
						ELSE
						BEGIN
							INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
							SELECT ROW_NUMBER() OVER(ORDER BY PUAN asc) AS 'KategoriRow', ID_KATEGORI AS ID_TKTKATEGORI
							FROM vw_OgrenciKategoriPuan
							WITH (NOLOCK)
							WHERE TCKIMLIKNO=@TEMPTCKIMLIK and ID_TKTTEST = @ID_TKTTEST and (@DONEM IS NULL OR DONEM = @DONEM)
						END						

						--OGRENCININ PUANINA GORE TERS ORANTILI KATEGORIDEN 4,3,2,1 TOPLAM 10 SORU GETIR
						DECLARE @ID_TKTKATEGORIx INT	=	0
						DECLARE @ROWNUMBER		 INT	=	0
						CREATE TABLE #RESULTTABLE(ID_TKTSORU INT, TCKIMLIKNO VARCHAR(11), ADSOYAD VARCHAR(200), SUBEAD VARCHAR(200), DOSYAAD VARCHAR(200), DOSYAUZANTI VARCHAR(10), ID_TKTKATEGORI INT); 
						WHILE EXISTS(SELECT * FROM #SIRALAMA)
						BEGIN
							SELECT TOP 1 @ID_TKTKATEGORIx	=	ID_TKTKATEGORI	FROM #SIRALAMA
							SELECT TOP 1 @ROWNUMBER			=	KategoriRow		FROM #SIRALAMA
							INSERT INTO #RESULTTABLE SELECT TOP (5 - @ROWNUMBER) * FROM #TMP_TKTOGRENCISINAV2 WHERE ID_TKTKATEGORI = @ID_TKTKATEGORIx		
							DELETE #SIRALAMA WHERE ID_TKTKATEGORI = @ID_TKTKATEGORIx
						END
						DROP TABLE #SIRALAMA
		
						--Gelecekte aynı soruyla sınav oluşturmamak için TktOgrenciSinav tablosuna kaydediyoruz
						--INSERT INTO UpgradeOgrenciSinav(TCKIMLIKNO, ID_TKTSORU, ID_TKTSINAV, KYE_KULLANICI, KYE_TARIH)
						--SELECT TS.TCKIMLIKNO, TS.ID_TKTSORU, @ID_TKTSINAV, @TCKIMLIKNO, GETDATE() FROM #RESULTTABLE TS
						--WITH (NOLOCK)
						--WHERE NOT EXISTS (SELECT * FROM UpgradeOgrenciSinav WHERE TCKIMLIKNO=TS.TCKIMLIKNO AND ID_TKTSORU=TS.ID_TKTSORU)
						
						IF (SELECT COUNT(1) FROM #RESULTTABLE) = 0 -- BILGI YOK ISE
						BEGIN
							PRINT 1
						END
						ELSE
						BEGIN
							DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
							WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND ID_TKTSINAV = @ID_TKTSINAV AND DONEM = @DONEM

							DECLARE @IDTABLE TABLE (ID INT)
							INSERT INTO UpgradeOgrenciSinavDonem (TCKIMLIKNO, ID_TKTSINAV, ID_TKTTEST, DONEM, KYE_KULLANICI, KYE_TARIH)
							OUTPUT inserted.ID_UPGRADEOGRENCISINAVDONEM INTO @IDTABLE
							SELECT DISTINCT TCKIMLIKNO, @ID_TKTSINAV, @ID_TKTTEST, @DONEM, @TCKIMLIKNO, GETDATE() 
							FROM #RESULTTABLE R 
							WHERE NOT EXISTS (
												SELECT ID_TKTSORU 
												FROM UpgradeOgrenciSinavDonem OSD 
												JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM 
												WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSDS.ID_TKTSORU = R.ID_TKTSORU AND OSD.DONEM = @DONEM
											)

							DECLARE @ID INT 
							SELECT @ID = ID FROM @IDTABLE

							INSERT INTO UpgradeOgrenciSinavDonemSoru(ID_UPGRADEOGRENCISINAVDONEM, ID_TKTSORU)
							SELECT @ID, R.ID_TKTSORU
							FROM #RESULTTABLE R 
							WHERE NOT EXISTS (
												SELECT ID_TKTSORU 
												FROM UpgradeOgrenciSinavDonem OSD 
												JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM 
												WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSDS.ID_TKTSORU = R.ID_TKTSORU AND OSD.DONEM = @DONEM
											)

							IF @ID_TKTSINAVORTALAMALIST IS NOT NULL
							BEGIN
								INSERT INTO UpgradeOgrenciSinavDonemEtkinlik (ID_UPGRADEOGRENCISINAVDONEM, ID_TKTSINAV)
								SELECT @ID, VALUE FROM OPENJSON(@ID_TKTSINAVORTALAMALIST) WHERE VALUE <> 0
							END
						
							INSERT INTO #TOTALRESULTTABLE SELECT * FROM #RESULTTABLE
						END
				
						DROP TABLE #RESULTTABLE
						DROP TABLE #TMP_TKTOGRENCISINAV2
						DROP TABLE #TMP_TKTOGRENCISINAV
					END				
			
					DELETE #TMP_OGRENCIBILGI WHERE TCKIMLIKNO = @TEMPTCKIMLIK
				END
				SET @SAYI = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TOTALRESULTTABLE)
				IF @SAYI>1
				BEGIN
				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT DISTINCT  @TCKIMLIKNO, TC.TCKIMLIKNO,'TOPLU EKLENDİ',GETDATE() FROM #TOTALRESULTTABLE AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				END
			    IF @SAYI =1
				BEGIN
				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT  DISTINCT  @TCKIMLIKNO, TC.TCKIMLIKNO,'EKLENDİ',GETDATE() FROM #TOTALRESULTTABLE AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				END
				
				DROP TABLE #TMP_OGRENCIBILGI
				
				SELECT t.TCKIMLIKNO, t.ADSOYAD, t.SUBEAD, t.DOSYAAD, t.DOSYAUZANTI ,s.AD SINIF, ROW_NUMBER() OVER(PARTITION BY t.TCKIMLIKNO ORDER BY t.TCKIMLIKNO, t.ID_TKTSORU) AS SIRA
				FROM #TOTALRESULTTABLE t
				JOIN v3OgrenciTum	o ON o.TCKIMLIKNO=t.TCKIMLIKNO
				JOIN v3SinifTum		s ON s.ID_SINIF=o.ID_SINIF
				WHERE o.DONEM = @DONEM
				ORDER BY t.TCKIMLIKNO, t.ID_TKTSORU
			
				DROP TABLE #TOTALRESULTTABLE
				DROP TABLE #TEMP2
				DROP TABLE #TEMP
			END

			IF @ISLEM = 11	--	Tkt Donem Getir
			BEGIN
				SELECT * FROM UpgradeDonem
			END

			IF @ISLEM = 12	--	Tkt Doneme Göre Sınav Getir
			BEGIN
				SELECT	DISTINCT
						 S.[ID_TKTSORU]
						,S.[ID_TKTPUAN]
						,S.[ID_TKTKATEGORI]
						,S.[KATEGORIAD]
						,S.[ID_SATISTURU]
						,S.[HARF]
						,(CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END) as SEVIYE
						,(SELECT CASE WHEN GRUP='Ü.Z İLKOKUL' THEN ACIKLAMA+ ' (ÜSTÜN)' ELSE ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru WHERE ID_SATISTURU=S.ID_SATISTURU) as GRUP
						,S.[DOSYAAD]
						,S.[DOSYAUZANTI]
						,S.[KYE_KULLANICI]
						,S.[KYE_TARIH]
						,STUFF((SELECT ',' + DONEM 
							FROM [vw_UpgradeSoru]
							where [ID_TKTSORU]=S.[ID_TKTSORU] and [ID_SATISTURU]=S.[ID_SATISTURU]
							FOR XML PATH('')) ,1,1,'') as DONEM
				FROM [vw_UpgradeSoru]	S
				JOIN UpgradeSoruDonem	SD	ON SD.ID_TKTSORU=S.ID_TKTSORU
				WHERE 
						(@ID_TKTDONEMS		IS NULL		OR @ID_TKTDONEMS = ''		OR SD.ID_TKTDONEM IN ((SELECT Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null))) ) 
					AND (@ID_TKTKATEGORI	IS NULL		OR @ID_TKTKATEGORI = 0		OR S.ID_TKTKATEGORI=@ID_TKTKATEGORI) 
					AND	(@ID_SATISTURU		IS NULL		OR @ID_SATISTURU = 0		OR S.ID_SATISTURU=@ID_SATISTURU) 
					AND	(@ID_TKTPUAN		IS NULL		OR @ID_TKTPUAN = 0			OR S.ID_TKTPUAN=@ID_TKTPUAN)
				GROUP BY S.[ID_TKTSORU]
						,S.[ID_TKTPUAN]
						,S.[ID_TKTKATEGORI]
						,S.[KATEGORIAD]
						,S.[ID_SATISTURU]
						,S.[HARF]
						,S.[DOSYAAD]
						,S.[DOSYAUZANTI]
						,S.[KYE_KULLANICI]
						,S.[KYE_TARIH]
						,S.DONEM 
			END

			IF @ISLEM = 13	--	Upgrade Grup Getir
			BEGIN
				SELECT DISTINCT st.ID_SATISTURU, CASE WHEN st.GRUP='Ü.Z İLKOKUL' THEN st.ACIKLAMA+ ' (ÜSTÜN)' ELSE st.ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru st
				INNER JOIN v3Kademe k ON k.ID_KADEME=st.ID_KADEME
				WHERE k.ID_KADEME in (2,3)
			END

			IF @ISLEM = 14	--	Upgrade Soru Sayıları getir
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT
							(SELECT AD FROM TKTSeviye ORDER BY ID_TKTSeviye DESC FOR JSON PATH) AS SEVIYE
									
							,(SELECT AD FROM UpgradeKategori FOR JSON PATH) AS KATEGORI

							,(SELECT TS.AD AS SEVIYE, UK.AD AS KATEGORI, COUNT(SD.ID_TKTSORUDONEM) AS SAYI
							FROM TKTSeviye TS
							INNER JOIN UpgradePuanTek UP ON UP.HARF=TS.HARF
							INNER JOIN UpgradeKategori UK ON UK.ID_TKTKATEGORI=UP.ID_TKTKATEGORI
							LEFT JOIN UpgradeSoru S ON S.ID_TKTPUAN=UP.ID_TKTPUAN AND S.ID_SATISTURU = @ID_SATISTURU AND
														(@HESAPTURU = 0 
														OR @BASLANGIC IS NULL 
														OR @BITIS IS NULL 
														OR (
															CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
															AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)))
							LEFT JOIN UpgradeSoruDonem SD ON SD.ID_TKTSORU=S.ID_TKTSORU AND SD.ID_TKTDONEM = @ID_TKTDONEM
							WHERE UK.AKTIF = 1
							GROUP BY TS.AD, UK.AD, TS.ID_TKTSeviye, UK.ID_TKTKATEGORI
							ORDER BY TS.ID_TKTSeviye DESC, UK.ID_TKTKATEGORI
							FOR JSON PATH) AS SONUC					
					) AS SUBTABLE FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 15	--	Sınav Kağıdı Sil
			BEGIN
				--DELETE OS FROM UpgradeOgrenciSinav OS
				--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
				--INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				--WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND ST.ID_KADEME3 = @ID_SINAVGRUP

				DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
				WHERE OSD.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
			
				INSERT INTO EtkinlikKagidiOlusturLog (KIM,KIME,ISLEM,TARIH) VALUES (@TCKIMLIKNO,@TCKIMLIKNO_OGR,@TUR,@TARIH)
				
			END

			IF @ISLEM = 16	--	Sınav Kağıdı Sil Toplu
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, SGS.ID_KADEME3
				INTO #TMP_OGRENCIBILGISIL
				FROM	   [dbo].[v3OgrenciTum]			O
				INNER JOIN [dbo].[v3SubeGrupSinifTum]	SGS	ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN [dbo].[v3Satislar]			SAT	ON SAT.ID_SOZLESME = O.ID_SOZLESME
				INNER JOIN [dbo].[v3SatisTuru]			ST	ON ST.ID_SATISTURU = SAT.ID_SATISTURU
				INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.TCKIMLIKNO = O.TCKIMLIKNO AND SY.XBASE=1
				INNER JOIN [dbo].[v3Kullanici]			K	ON k.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN [dbo].[v3Sube]				SU	ON SU.ID_SUBE = SY.ID_SUBE
				WHERE 
					(@ID_SINIFS IS NULL OR @ID_SINIFS = '[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFS)))
				AND	(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP = 0 OR ST.ID_KADEME3 = @ID_SINAVGRUP) 
				AND (@ID_SUBE IS NULL OR @ID_SUBE = 0 OR O.ID_SUBE = @ID_SUBE) 
				AND O.DONEM = @DONEM

				--DELETE OS FROM UpgradeOgrenciSinav OS
				--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
				--INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				--INNER JOIN #TMP_OGRENCIBILGISIL OBS ON OBS.TCKIMLIKNO = OS.TCKIMLIKNO AND OBS.ID_KADEME3= ST.ID_KADEME3
				--WHERE ID_TKTSINAV = @ID_TKTSINAV

				DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
				JOIN #TMP_OGRENCIBILGISIL O ON O.TCKIMLIKNO = OSD.TCKIMLIKNO
				WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM

				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT  @TCKIMLIKNO, TC.TCKIMLIKNO,@TUR,@TARIH FROM #TMP_OGRENCIBILGISIL AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				DROP TABLE #TMP_OGRENCIBILGISIL
			END

			IF @ISLEM = 17	--	Soru Kazanım Adedi Güncelle
			BEGIN
				UPDATE UpgradeSoru SET KAZANIMADEDI = @KAZANIMADEDI WHERE ID_TKTSORU = @ID_TKTSORU 
			END

			IF @ISLEM = 18	--	Öğrenci Soru Listele
			BEGIN
				--SET @ID_ST = (	
				--						SELECT ST.ID_SATISTURU
				--						FROM OkyanusDB.dbo.v3OgrenciTum O
				--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
				--						WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND O.DONEM = @DONEM
				--					)

				SELECT
				(
					--SELECT ROW_NUMBER() OVER(ORDER BY OS.ID_TKTSORU) AS SORUNO, OS.ID_TKTOGRENCISINAV, K.AD AS KATEGORI, S.KAZANIMADEDI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 0 ELSE 1 END AS ISDISABLED, OS.DOGRUKAZANIMADEDI, P.HARF, 'https://pusulam.okyanuskoleji.k12.tr/Dosyalar/' + D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM
					--FROM UpgradeOgrenciSinav OS
					--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
					--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					--INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					--INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					--WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
					--ORDER BY OS.ID_TKTSORU

					SELECT ROW_NUMBER() OVER(ORDER BY OSDS.ID_TKTSORU) AS SORUNO, OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU, K.AD AS KATEGORI, S.KAZANIMADEDI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 0 ELSE 1 END AS ISDISABLED, OSDS.DOGRUKAZANIMADEDI, P.HARF, 'https://pusulam.okyanuskoleji.k12.tr/Dosyalar/' + D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM
					FROM UpgradeOgrenciSinavDonem OSD
					JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
					INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
					INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					ORDER BY OSDS.ID_TKTSORU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 19	--	Öğrenci Soru Puan Kaydet
			BEGIN
				--UPDATE OS SET OS.DOGRUKAZANIMADEDI = J.DOGRUKAZANIMADEDI 
				--FROM UpgradeOgrenciSinav OS
				--INNER JOIN OPENJSON(@SQLJSON)
				--WITH(
				--	ID_TKTOGRENCISINAV INT,
				--	KAZANIMADEDI INT,
				--	DOGRUKAZANIMADEDI INT
				--) AS J ON J.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV

				UPDATE OSDS SET OSDS.DOGRUKAZANIMADEDI = J.DOGRUKAZANIMADEDI 
				FROM UpgradeOgrenciSinavDonemSoru OSDS
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_UPGRADEOGRENCISINAVDONEMSORU INT,
					KAZANIMADEDI INT,
					DOGRUKAZANIMADEDI INT
				) AS J ON J.ID_UPGRADEOGRENCISINAVDONEMSORU = OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU

				--UPDATE S SET S.KAZANIMADEDI = J.KAZANIMADEDI 
				--FROM UpgradeSoru S
				--INNER JOIN UpgradeOgrenciSinav OS ON OS.ID_TKTSORU = S.ID_TKTSORU
				--INNER JOIN OPENJSON(@SQLJSON)
				--WITH(
				--	ID_TKTOGRENCISINAV INT,
				--	KAZANIMADEDI INT,
				--	DOGRUKAZANIMADEDI INT
				--) AS J ON J.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV
				--WHERE S.KAZANIMADEDI IS NULL

				UPDATE S SET S.KAZANIMADEDI = J.KAZANIMADEDI 
				FROM UpgradeSoru S
				INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_TKTSORU = S.ID_TKTSORU
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_UPGRADEOGRENCISINAVDONEMSORU INT,
					KAZANIMADEDI INT,
					DOGRUKAZANIMADEDI INT
				) AS J ON J.ID_UPGRADEOGRENCISINAVDONEMSORU = OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU
				WHERE S.KAZANIMADEDI IS NULL
			END

			IF @ISLEM = 20	--	Öğrenci Sonuç Listele
			BEGIN
				--SET @ID_ST = (	
				--						SELECT ST.ID_SATISTURU
				--						FROM OkyanusDB.dbo.v3OgrenciTum O
				--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
				--						WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND O.DONEM = @DONEM
				--					)

				SELECT
				(
					--SELECT ROW_NUMBER() OVER(ORDER BY OS.ID_TKTSORU) AS SORUNO, D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM, OS.ID_TKTOGRENCISINAV, K.AD AS KATEGORI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(S.KAZANIMADEDI AS VARCHAR) END AS KAZANIMADEDI, CASE WHEN OS.DOGRUKAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(OS.DOGRUKAZANIMADEDI AS VARCHAR) END AS DOGRUKAZANIMADEDI
					--FROM UpgradeOgrenciSinav OS
					--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
					--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					--INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					--INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					--WHERE OS.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OS.ID_TKTSINAV = @ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
					--ORDER BY OS.ID_TKTSORU

					SELECT ROW_NUMBER() OVER(ORDER BY OSDS.ID_TKTSORU) AS SORUNO, D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM, OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU, K.AD AS KATEGORI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(S.KAZANIMADEDI AS VARCHAR) END AS KAZANIMADEDI, CASE WHEN OSDS.DOGRUKAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(OSDS.DOGRUKAZANIMADEDI AS VARCHAR) END AS DOGRUKAZANIMADEDI
					FROM UpgradeOgrenciSinavDonem OSD
					INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
					INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
					INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE OSD.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					ORDER BY OSDS.ID_TKTSORU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 21	--	Toplu Sonuç Listele
			BEGIN
				SELECT O.TCKIMLIKNO, K.AD, K.SOYAD, SB.AD AS KAMPUS, K3.AD AS GRUP, SNF.AD AS SINIF, SAT.ID_SATISTURU, convert(varchar, K.DOGUMTARIHI, 104) as DOGUMTARIHI
				INTO #OGRENCI
				FROM OkyanusDB.dbo.v3OgrenciTum O
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = SGS.ID_KADEME3
				INNER JOIN OkyanusDB.dbo.v3Sinif SNF ON SNF.ID_SINIF = SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Satislar SAT ON SAT.ID_SOZLESME = O.ID_SOZLESME AND SAT.ID_DONEM = O.ID_DONEM
				WHERE O.DONEM = @DONEM		
					AND (@ID_SUBES		IS NULL OR @ID_SUBES='[]'		OR SGS.ID_SUBE		in (select value from openjson (@ID_SUBES)))
					AND (@ID_SINAVGRUPS IS NULL OR @ID_SINAVGRUPS='[]'	OR SGS.ID_KADEME3	in (select value from openjson (@ID_SINAVGRUPS)))
					AND (@ID_SINIFS		IS NULL OR @ID_SINIFS='[]'		OR SGS.ID_SINIF		in (select value from openjson (@ID_SINIFS)))
				ORDER BY O.TCKIMLIKNO

				SELECT TCKIMLIKNO, AD, SOYAD, KAMPUS, GRUP, SINIF, DOGUMTARIHI,
					MAX([1-DOGRUKAZANIMADEDI]) AS [1-DOGRUKAZANIMADEDI],
					MAX([2-DOGRUKAZANIMADEDI]) AS [2-DOGRUKAZANIMADEDI],
					MAX([3-DOGRUKAZANIMADEDI]) AS [3-DOGRUKAZANIMADEDI],
					MAX([4-DOGRUKAZANIMADEDI]) AS [4-DOGRUKAZANIMADEDI],
					MAX([5-DOGRUKAZANIMADEDI]) AS [5-DOGRUKAZANIMADEDI],
					MAX([6-DOGRUKAZANIMADEDI]) AS [6-DOGRUKAZANIMADEDI],
					MAX([7-DOGRUKAZANIMADEDI]) AS [7-DOGRUKAZANIMADEDI],
					MAX([8-DOGRUKAZANIMADEDI]) AS [8-DOGRUKAZANIMADEDI],
					MAX([9-DOGRUKAZANIMADEDI]) AS [9-DOGRUKAZANIMADEDI],
					MAX([10-DOGRUKAZANIMADEDI]) AS [10-DOGRUKAZANIMADEDI],
					MAX([1-KAZANIMADEDI]) AS [1-KAZANIMADEDI],
					MAX([2-KAZANIMADEDI]) AS [2-KAZANIMADEDI],
					MAX([3-KAZANIMADEDI]) AS [3-KAZANIMADEDI],
					MAX([4-KAZANIMADEDI]) AS [4-KAZANIMADEDI],
					MAX([5-KAZANIMADEDI]) AS [5-KAZANIMADEDI],
					MAX([6-KAZANIMADEDI]) AS [6-KAZANIMADEDI],
					MAX([7-KAZANIMADEDI]) AS [7-KAZANIMADEDI],
					MAX([8-KAZANIMADEDI]) AS [8-KAZANIMADEDI],
					MAX([9-KAZANIMADEDI]) AS [9-KAZANIMADEDI],
					MAX([10-KAZANIMADEDI]) AS [10-KAZANIMADEDI],
					MAX([1-KATEGORI]) AS [1-KATEGORI],
					MAX([2-KATEGORI]) AS [2-KATEGORI],
					MAX([3-KATEGORI]) AS [3-KATEGORI],
					MAX([4-KATEGORI]) AS [4-KATEGORI],
					MAX([5-KATEGORI]) AS [5-KATEGORI],
					MAX([6-KATEGORI]) AS [6-KATEGORI],
					MAX([7-KATEGORI]) AS [7-KATEGORI],
					MAX([8-KATEGORI]) AS [8-KATEGORI],
					MAX([9-KATEGORI]) AS [9-KATEGORI],
					MAX([10-KATEGORI]) AS [10-KATEGORI]
				FROM 
				( 
					SELECT * 
					FROM 
					( 
						SELECT * 
						FROM 
						( 
							--SELECT O.*, K.AD AS KATEGORI, ISNULL(CAST(S.KAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS KAZANIMADEDI, ISNULL(CAST(OS.DOGRUKAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS DOGRUKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-DOGRUKAZANIMADEDI ' AS SORUNODOGRUKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-KAZANIMADEDI ' AS SORUNOKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-KATEGORI ' AS SORUNOKATEGORI 
							--FROM #OGRENCI O
							--INNER JOIN UpgradeOgrenciSinav OS ON OS.TCKIMLIKNO = O.TCKIMLIKNO
							--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU AND S.ID_SATISTURU = O.ID_SATISTURU
							--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
							--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
							--WHERE OS.ID_TKTSINAV = @ID_TKTSINAV

							SELECT O.*, K.AD AS KATEGORI, ISNULL(CAST(S.KAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS KAZANIMADEDI, ISNULL(CAST(OSDS.DOGRUKAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS DOGRUKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-DOGRUKAZANIMADEDI ' AS SORUNODOGRUKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-KAZANIMADEDI ' AS SORUNOKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-KATEGORI ' AS SORUNOKATEGORI 
							FROM #OGRENCI O
							INNER JOIN UpgradeOgrenciSinavDonem OSD ON OSD.TCKIMLIKNO = O.TCKIMLIKNO
							INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU AND S.ID_SATISTURU = O.ID_SATISTURU
							INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
							INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
							WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
						) AS XTABLE 
						PIVOT 
						( 
							MAX(DOGRUKAZANIMADEDI) FOR SORUNODOGRUKAZANIMADEDI IN ([1-DOGRUKAZANIMADEDI],[2-DOGRUKAZANIMADEDI],[3-DOGRUKAZANIMADEDI],[4-DOGRUKAZANIMADEDI],[5-DOGRUKAZANIMADEDI],[6-DOGRUKAZANIMADEDI],[7-DOGRUKAZANIMADEDI],[8-DOGRUKAZANIMADEDI],[9-DOGRUKAZANIMADEDI],[10-DOGRUKAZANIMADEDI]) 
						) AS P_DOGRUKAZANIMADEDI
						)
					AS XTABLE 
					PIVOT 
					( 
						MAX(KAZANIMADEDI) FOR SORUNOKAZANIMADEDI IN ([1-KAZANIMADEDI],[2-KAZANIMADEDI],[3-KAZANIMADEDI],[4-KAZANIMADEDI],[5-KAZANIMADEDI],[6-KAZANIMADEDI],[7-KAZANIMADEDI],[8-KAZANIMADEDI],[9-KAZANIMADEDI],[10-KAZANIMADEDI]) 
					) AS P_KAZANIMADEDI
				)
				AS XTABLE 
				PIVOT 
				( 
					MAX(KATEGORI) FOR SORUNOKATEGORI IN ([1-KATEGORI],[2-KATEGORI],[3-KATEGORI],[4-KATEGORI],[5-KATEGORI],[6-KATEGORI],[7-KATEGORI],[8-KATEGORI],[9-KATEGORI],[10-KATEGORI]) 
				) AS P_KATEGORI
				GROUP BY TCKIMLIKNO, AD, SOYAD, KAMPUS, GRUP, SINIF, DOGUMTARIHI
				ORDER BY KAMPUS, GRUP, SINIF, AD, SOYAD

				DROP TABLE #OGRENCI
			END

			IF @ISLEM = 22	--	SORULARIN ÇÖZÜLME ORANLARI
			BEGIN
				SELECT S.ID_TKTSORU, S.DOSYAAD + '.' + S.DOSYAUZANTI AS DOSYA, (CASE WHEN S.HARF='A' THEN 'Üstün' WHEN S.HARF='B' THEN 'Ortanın Üstü' WHEN S.HARF='C' THEN 'Orta' WHEN S.HARF='D' THEN 'Ortanın Altı' WHEN S.HARF='E' THEN 'Desteklenmeli' END) AS PUANARALIGI, S.KAZANIMADEDI
				INTO #TEMPSORU
				FROM vw_UpgradeSoru S
				JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
				WHERE S.ID_SATISTURU = @ID_SATISTURU AND S.ID_TKTKATEGORI = @ID_TKTKATEGORI
				GROUP BY S.ID_TKTSORU, S.DOSYAAD, S.DOSYAUZANTI, S.KAZANIMADEDI, S.HARF

				SELECT ISNULL(
				(
					SELECT S.ID_TKTSORU, S.DOSYA, S.PUANARALIGI, S.KAZANIMADEDI, COUNT(1) AS OGRENCISAYISI, CONVERT (DECIMAL(5,2), (SUM(OS.DOGRUKAZANIMADEDI) * 100.0) / (S.KAZANIMADEDI * COUNT(1))) AS COZULMEORANI
					FROM #TEMPSORU S
					JOIN UpgradeOgrenciSinavDonemSoru OS ON OS.ID_TKTSORU = S.ID_TKTSORU
					JOIN UpgradeOgrenciSinavDonem O ON O.ID_UPGRADEOGRENCISINAVDONEM = OS.ID_UPGRADEOGRENCISINAVDONEM
					WHERE OS.DOGRUKAZANIMADEDI IS NOT NULL AND O.DONEM = @DONEM
					GROUP BY S.ID_TKTSORU, S.DOSYA, S.PUANARALIGI, S.KAZANIMADEDI
					ORDER BY S.ID_TKTSORU
					FOR JSON PATH
				), '[]')

				DROP TABLE #TEMPSORU
			END			
			
			IF @ISLEM = 23  -- UPGRADE ISLEM RAPOR LOG
			BEGIN
				SELECT KIM, KIME, ISLEM, TARIH = CONVERT(VARCHAR,TARIH, 104) +' '  + CONVERT(VARCHAR,TARIH, 108)
				FROM EtkinlikKagidiOlusturLog
				WHERE KIME = @TCKIMLIKNO_OGR
				ORDER BY TARIH DESC
			END
			
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_UyariSistemleri]    Script Date: 23.11.2021 15:39:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_UyariSistemleri]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_UYARI				INT				= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_UYARI				= @ID_UYARI
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	UYARI EKLE/DÜZENLE	
			BEGIN
				
				SET @ID_UYARI = JSON_VALUE(@SQLJSON, '$.ID_UYARI')

				IF NOT EXISTS (	SELECT TOP 1 1 FROM Uyari U WHERE U.ID_UYARI = @ID_UYARI)
				BEGIN
					DECLARE @INSERTUYARI TABLE (ID INT)
					INSERT INTO Uyari (AD,ACIKLAMA,BASTARIH, BITTARIH ,METIN, KYE_TCKIMLIKNO)
					OUTPUT inserted.ID_UYARI INTO @INSERTUYARI(ID)
					SELECT	 AD
							,ACIKLAMA
							,BASTARIH	= ISNULL(BASTARIH,GETDATE())
							,BITTARIH	= ISNULL(BITTARIH, DATEADD(DAY,1,GETDATE()))
							,METIN
							,@TCKIMLIKNO
					FROM OPENJSON(@SQLJSON)
					WITH(	AD			VARCHAR(MAX),
							ACIKLAMA	VARCHAR(MAX),
							BASTARIH	DATE,
							BITTARIH	DATE,
							METIN		NVARCHAR(MAX)
					)

					INSERT INTO UyariKullaniciTipi (ID_UYARI, ID_KULLANICITIPI)
					SELECT (SELECT TOP 1 ID FROM @INSERTUYARI), J.VALUE
					FROM OPENJSON(@SQLJSON, '$.ID_KULLANICITIPILIST') AS J
				END
				ELSE
				BEGIN

					UPDATE U SET
						AD		 = J.AD,
						ACIKLAMA = J.ACIKLAMA,
						BASTARIH = J.BASTARIH,
						BITTARIH = J.BITTARIH,
						METIN	 = J.METIN
					FROM Uyari	U
					JOIN OPENJSON(@SQLJSON)
					WITH(	ID_UYARI	INT,
							AD			VARCHAR(MAX),
							ACIKLAMA	VARCHAR(MAX),
							BASTARIH	DATE,
							BITTARIH	DATE,
							METIN		NVARCHAR(MAX)
					) AS J			ON J.ID_UYARI	= U.ID_UYARI

					DELETE UyariKullaniciTipi WHERE ID_UYARI = @ID_UYARI

					INSERT INTO UyariKullaniciTipi (ID_UYARI, ID_KULLANICITIPI)
					SELECT @ID_UYARI, J.VALUE
					FROM OPENJSON(@SQLJSON, '$.ID_KULLANICITIPILIST') AS J

				END
				
			END

			IF @ISLEM = 2	--	UYARI DETAY			
			BEGIN

				SELECT ISNULL((
					SELECT	 U.ID_UYARI
							,U.AD
							,U.ACIKLAMA
							,U.METIN
							,U.BASTARIH
							,U.BITTARIH
							,UKT.ID_KULLANICITIPI
					FROM Uyari				U
					JOIN UyariKullaniciTipi	UKT	ON	UKT.ID_UYARI	= U.ID_UYARI
					WHERE U.ID_UYARI = @ID_UYARI
					FOR JSON AUTO
				),'[]')				

			END

			IF @ISLEM = 3	--	UYARI LİSTE			
			BEGIN

				SELECT ISNULL((
					SELECT	 U.ID_UYARI
							,U.AD
							,U.ACIKLAMA
							,BASTARIH = CONVERT(VARCHAR,U.BASTARIH,104)
							,BITTARIH = CONVERT(VARCHAR,U.BITTARIH,104)
							,KYE_TARIH = CONVERT(VARCHAR,U.KYE_TARIH,104)
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,U.AKTIF
							,KT.ID_KULLANICITIPI
							,KT.AD
					FROM Uyari				U
					JOIN UyariKullaniciTipi	UKT	ON	UKT.ID_UYARI		= U.ID_UYARI
					JOIN v3KullaniciTipi	KT	ON	KT.ID_KULLANICITIPI	= UKT.ID_KULLANICITIPI
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO		= U.KYE_TCKIMLIKNO
					--WHERE U.AKTIF	= 1
					ORDER BY U.KYE_TARIH DESC, KT.AD
					FOR JSON AUTO
				),'[]')				

			END

			IF @ISLEM = 4	--	UYARI AKTIF/PASIF	
			BEGIN

				UPDATE U SET
					AKTIF = J.AKTIF
				FROM Uyari	U
				JOIN OPENJSON(@SQLJSON) 
				WITH(	ID_UYARI	INT,
						AKTIF		BIT
				) J ON J.ID_UYARI = U.ID_UYARI

			END

			IF @ISLEM = 5	--	UYARI GOSTER		
			BEGIN

				SELECT ISNULL((
					SELECT U.ID_UYARI, U.METIN
					FROM Uyari								U
					JOIN UyariKullaniciTipi					UKT	ON	UKT.ID_UYARI		= U.ID_UYARI
					JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.ID_KULLANICITIPI	= UKT.ID_KULLANICITIPI
					WHERE	KY.TCKIMLIKNO	= @TCKIMLIKNO
						AND U.AKTIF			= 1
						AND U.BASTARIH		<  CAST(GETDATE() AS date)
						AND U.BITTARIH		>= CAST(GETDATE() AS date)
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 6	--	UYARI KULLANICI ONAY
			BEGIN
				
				IF EXISTS (SELECT TOP 1 1 FROM UyariKullanici WHERE ID_UYARI = @ID_UYARI AND TCKIMLIKNO = @TCKIMLIKNO)
					UPDATE UyariKullanici SET
						ONAY = 1
					WHERE	ID_UYARI	= @ID_UYARI
						AND TCKIMLIKNO	= @TCKIMLIKNO
				ELSE
					INSERT INTO UyariKullanici (ID_UYARI, ONAY, TCKIMLIKNO)
					VALUES (@ID_UYARI, 1, @TCKIMLIKNO )

			END

			IF @ISLEM = 7	--	UYARI RAPOR			
			BEGIN

				IF EXISTS (SELECT TOP 1 1 FROM Uyari U WHERE U.ID_UYARI = @ID_UYARI AND RAPORSON = 0)
				BEGIN

					INSERT INTO UyariKullanici (ID_UYARI, TCKIMLIKNO, ONAY)
					SELECT DISTINCT @ID_UYARI, KY.TCKIMLIKNO, 0
					FROM UyariKullaniciTipi					UKT
					JOIN OkyanusDB.DBO.vw_KullaniciYetki	KY	ON	KY.ID_KULLANICITIPI	= UKT.ID_KULLANICITIPI
					WHERE	NOT EXISTS (SELECT TOP 1 1 FROM UyariKullanici UK WHERE UK.ID_UYARI = UKT.ID_UYARI AND UK.TCKIMLIKNO = KY.TCKIMLIKNO)
						AND	UKT.ID_UYARI = @ID_UYARI						

				END

				SELECT DISTINCT
					 TCKIMLIKNO		= K.TCKIMLIKNO
					,AD				= K.AD
					,SOYAD			= K.SOYAD
					,ONAY_TARIH		= CONVERT(VARCHAR,UK.ONAY_TARIH,104)	
					,ONAY_SAAT		= CONVERT(VARCHAR,UK.ONAY_TARIH,108)
					,ONAY			= IIF(ONAY = 1 ,'Onaylandı' ,'Onaylanmadı')
					,EPOSTA			= (SELECT TOP 1 EPOSTA FROM OkyanusDB..v3KullaniciEposta KE WHERE KE.TCKIMLIKNO = K.TCKIMLIKNO)
					,SUBELIST		= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SB.AD AS VARCHAR) 
														FROM OkyanusDB.DBO.vw_KullaniciYetki KY 
														JOIN v3Sube							 SB ON SB.ID_SUBE = KY.ID_SUBE
														WHERE KY.TCKIMLIKNO = K.TCKIMLIKNO 
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(22)'), 1, 2, '')) 
					,KULLANICITIPI	= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( KT.AD AS VARCHAR) 
														FROM UyariKullaniciTipi				 UKT
														JOIN v3KullaniciTipi				 KT ON	KT.ID_KULLANICITIPI	= UKT.ID_KULLANICITIPI
														JOIN OkyanusDB.DBO.vw_KullaniciYetki KY ON	KY.ID_KULLANICITIPI = KT.ID_KULLANICITIPI
																								AND KY.TCKIMLIKNO		= K.TCKIMLIKNO
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
				FROM Uyari			U
				JOIN UyariKullanici	UK	ON	UK.ID_UYARI	= U.ID_UYARI
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO= UK.TCKIMLIKNO
				WHERE U.ID_UYARI = @ID_UYARI

				SELECT AD
				FROM Uyari 
				WHERE ID_UYARI = @ID_UYARI

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_v2FrekansEtkiListesi]    Script Date: 23.11.2021 15:39:17 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_v2FrekansEtkiListesi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@DONEM					VARCHAR(4)		= NULL,
	@ID_SINAVTURU			INT				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SINAVTURU			= @ID_SINAVTURU			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		
		IF @_ID_LOG > 0
		BEGIN
			
			IF @DONEM IS NULL
				SET @DONEM = (SELECT OkyanusDB.dbo.fn_AktifDonem())
			
			IF @ISLEM = 1	--	FREKANS ETKİ LİSTESİ		
			BEGIN

				DROP TABLE IF EXISTS #ARALIK

				SELECT * 
				INTO #ARALIK
				FROM v2FrekansAralik
				WHERE	DONEM			= @DONEM
					AND ID_SINAVTURU	= @ID_SINAVTURU

				SELECT *
				INTO #OGRETMEN
				FROM v2FrekansAralikOgretmen
				WHERE	DONEM	= @DONEM

				SELECT(
					SELECT (
						SELECT DISTINCT
							 K.AD KADEME3
							,K.SIRA
							,A.DERSAD
							,A.MINIMUM
							,A.MAXIMUM
							,A.ARALIK
							
							,OGRETMENLISTE = (
								SELECT	 OK.TCKIMLIKNO
										,OK.AD
										,OK.SOYAD
										,O.FREKANS
										,ETKI = (
											SELECT	CASE	WHEN	O.FREKANS <= OA.MINIMUM +  OA.ARALIK		THEN 'Etkisiz'
															WHEN	O.FREKANS <= OA.MINIMUM + (OA.ARALIK * 2)	THEN 'Az Etkili'
															WHEN	O.FREKANS <= OA.MINIMUM + (OA.ARALIK * 3)	THEN 'Normal'
															WHEN	O.FREKANS <= OA.MINIMUM + (OA.ARALIK * 4)	THEN 'Etkili'
															WHEN	O.FREKANS <= OA.MAXIMUM 					THEN 'Çok Etkili'
														ELSE '---'
													END
											FROM #ARALIK OA 
											WHERE	OA.ID_KADEME3	= O.ID_KADEME3
												AND OA.ID_SINAVTURU	= O.ID_SINAVTURU
												AND OA.DERSAD		= O.DERSAD
												AND OA.DONEM		= O.DONEM
										)
								FROM #OGRETMEN		O
								JOIN v3Kullanici	OK	ON	OK.TCKIMLIKNO = O.TC_OGRETMEN
								WHERE	O.DONEM			= A.DONEM
									AND O.DERSAD		= A.DERSAD
									AND O.ID_KADEME3	= A.ID_KADEME3
									AND O.ID_SINAVTURU	= A.ID_SINAVTURU
								ORDER BY O.FREKANS, OK.AD, OK.SOYAD
								FOR JSON PATH, INCLUDE_NULL_VALUES		
							)

							,ETKI = (
								SELECT 
									 KADEME  = SA.MINIMUM
									,KADEME1 = SA.MINIMUM +  SA.ARALIK
									,KADEME2 = SA.MINIMUM + (SA.ARALIK*2)
									,KADEME3 = SA.MINIMUM + (SA.ARALIK*3)
									,KADEME4 = SA.MINIMUM + (SA.ARALIK*4)
									,KADEME5 = SA.MAXIMUM
									
									,KADEMEAD  = 'Etkisiz'
									,KADEME1AD = 'Az Etkili'
									,KADEME2AD = 'Normal'
									,KADEME3AD = 'Etkili'
									,KADEME4AD = 'Çok Etkili'
									,SA.DERSAD	DERS
									,K.AD		GRUP
									,ST.AD		SINAVTURU
								FROM #ARALIK	SA
								JOIN SinavTuru	ST	ON	ST.ID_SINAVTURU	= SA.ID_SINAVTURU
								JOIN v3Kademe3	K	ON	K.ID_KADEME3	= SA.ID_KADEME3
								WHERE	SA.DERSAD		= A.DERSAD
									AND	SA.ID_KADEME3	= A.ID_KADEME3
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)
						FROM #ARALIK		A
						JOIN v3Kademe3		K	ON	K.ID_KADEME3	= A.ID_KADEME3
						ORDER BY K.SIRA, A.DERSAD
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS ARALIK,
					(
						SELECT DISTINCT DERSAD
						FROM #ARALIK
						ORDER BY DERSAD
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS ARALIKDERS,
					(
						SELECT DISTINCT K.SIRA, K.ID_KADEME3, K.AD KADEME3
						FROM #ARALIK		a
						JOIN v3Kademe3		K	ON	K.ID_KADEME3	= A.ID_KADEME3
						ORDER BY K.SIRA, K.ID_KADEME3
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS ARALIKKADEME3
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
				
				DROP TABLE IF EXISTS #ARALIK

			END
			
			IF @ISLEM = 2	--	FREKANS DONEM LİSTESİ		
			BEGIN

				SELECT (
					SELECT DISTINCT D.DONEM, D.ACIKLAMA, D.AKTIF
					FROM v2FrekansOgrenciDetay	F
					JOIN v3AktifDonem			D	ON	D.DONEM	= F.DONEM
					ORDER BY DONEM DESC
					FOR JSON PATH
				)

			END
			
			IF @ISLEM = 3	--	FREKANS SINAV TÜRÜ LİSTESİ	
			BEGIN

				SELECT (
					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD
					FROM v2FrekansOgrenciDetay	F
					JOIN SinavTuru				ST	ON	ST.ID_SINAVTURU	= F.ID_SINAVTURU
					ORDER BY ST.AD DESC
					FOR JSON PATH
				)

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_v2FrekansKampus]    Script Date: 23.11.2021 15:39:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_v2FrekansKampus]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,	
	@ID_SUBE			INT				= NULL,	
	@ID_SUBEs			VARCHAR(MAX)	= NULL,	
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,	
	@DERSAD				VARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	DECLARE 
	@_ISLEM				INT				= @ISLEM			,
	@_TCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO		,
	@_TC_OGRENCI		VARCHAR(11)		= @TC_OGRENCI		,
	@_TC_OGRETMEN		VARCHAR(11)		= @TC_OGRETMEN		,
	@_OTURUM			VARCHAR(36)		= @OTURUM			,
	@_ID_MENU			INT				= @ID_MENU			,
	@_DONEM				char(4)			= @DONEM			,
	@_ID_KADEME			INT				= @ID_KADEME		,
	@_ID_KADEMEs		VARCHAR(MAX)	= @ID_KADEMEs		,
	@_ID_KADEME3		VARCHAR(MAX)	= @ID_KADEME3		,
	@_ID_SINAVTURU		VARCHAR(MAX)	= @ID_SINAVTURU		,	
	@_ID_SUBE			INT				= @ID_SUBE			,	
	@_ID_SUBEs			VARCHAR(MAX)	= @ID_SUBEs			,	
	@_DERSLIST			VARCHAR(MAX)	= @DERSLIST			,
	@_ID_SINIF			INT				= @ID_SINIF			,	
	@_DERSAD			VARCHAR(MAX)	= @DERSAD			,
	@_FREKANSKARNE		BIT				= @FREKANSKARNE	
	
	DECLARE @_PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @_LOGJSON VARCHAR(MAX)
	SET @_LOGJSON = (
		SELECT	 ISLEM			= @_ISLEM			
				,TCKIMLIKNO		= @_TCKIMLIKNO		
				,TC_OGRENCI		= @_TC_OGRENCI		
				,TC_OGRETMEN	= @_TC_OGRETMEN	
				,OTURUM			= @_OTURUM			
				,ID_MENU		= @_ID_MENU		
				,DONEM			= @_DONEM			
				,ID_KADEME		= @_ID_KADEME		
				,ID_KADEMEs		= @_ID_KADEMEs
				,ID_KADEME3		= @_ID_KADEME3		
				,ID_SINAVTURU	= @_ID_SINAVTURU	
				,ID_SUBE		= @_ID_SUBE		
				,ID_SUBEs		= @_ID_SUBEs	
				,DERSLIST		= @_DERSLIST		
				,ID_SINIF		= @_ID_SINIF		
				,DERSAD			= @_DERSAD			
				,FREKANSKARNE	= @_FREKANSKARNE	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @_OTURUM, @TCKIMLIKNO = @_TCKIMLIKNO, @ID_MENU = @_ID_MENU, @LOGJSON = @_LOGJSON, @ISLEM = @_ISLEM, @PROSEDURADI = @_PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			BEGIN

				DECLARE @_ID_STGENEL INT=999999 
				--1,2,8
				
				IF @_DONEM='' OR @_DONEM IS NULL
					SET @_DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
				--2,5
						
				BEGIN
						DROP TABLE IF EXISTS #ORTALAMA3
						DROP TABLE IF EXISTS #T2
						DROP TABLE IF EXISTS #T1
						DROP TABLE IF EXISTS #Filtre2
						DROP TABLE IF EXISTS #GenelFiltre2
						DROP TABLE IF EXISTS #FiltreFrekans2
						DROP TABLE IF EXISTS #OgrenciSinifListe2 
						DROP TABLE IF EXISTS #GenelFrekans2
						DROP TABLE IF EXISTS #GenelSira2
						DROP TABLE IF EXISTS #GenelZumreFrekans2
						DROP TABLE IF EXISTS #GenelZumreSira2
						DROP TABLE IF EXISTS #GenelKampusFrekans2
						DROP TABLE IF EXISTS #GenelKampusSira2			
						DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
						DROP TABLE IF EXISTS #GenelZumreKampusSira2				
						DROP TABLE IF EXISTS #T
						DROP TABLE IF EXISTS #Filtre
						DROP TABLE IF EXISTS #FiltreFrekans
						DROP TABLE IF EXISTS #OgrenciSinifListe 
						DROP TABLE IF EXISTS #GenelFrekans
						DROP TABLE IF EXISTS #GenelSira
						DROP TABLE IF EXISTS #GenelZumreFrekans
						DROP TABLE IF EXISTS #GenelZumreSira
						DROP TABLE IF EXISTS #GenelKampusFrekans
						DROP TABLE IF EXISTS #GenelKampusSira
						DROP TABLE IF EXISTS #GenelZumreKampusFrekans
						DROP TABLE IF EXISTS #GenelZumreKampusSira
						DROP TABLE IF EXISTS #GenelFrekansKatki
						DROP TABLE IF EXISTS #ARALIK
						DROP TABLE IF EXISTS #DERSLER
						DROP TABLE IF EXISTS #ETKI
						DROP TABLE IF EXISTS #SINAVTURU
						DROP TABLE IF EXISTS #SUBELER
						DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem
					END

				IF @_ISLEM NOT IN (6, 7, 9)
				BEGIN
				
					DECLARE @_SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
					--INSERT INTO @_SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
					INSERT INTO @_SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
					SELECT * INTO #SINAVTURU FROM @_SINAVTURU	
					--2,3,4,5
										
					SELECT	 T.ID_FREKANSOGRENCIDETAY
							,T.ID_SINAVTURU
							,T.ID_KADEME3
							,T.ID_OGRENCI
							,T.TC_OGRENCI
							,T.TAKMAAD
							,T.ID_SINAV
							,T.NET
							,T.SS
							,T.ILK_ID_SINAV
							,T.ILK_NET
							,T.ILK_SS
							,T.FREKANS
							,T.DONEM
							,T.ID_SINIF
							,T.ID_SUBE
							,T.ID_DERS
							,T.TC_OGRETMEN
							,T.OGRETMENADSOYAD
							,T.DERSAD
							,T.SUBEAD
							,T.SINIFAD
							,T.HBNET
							,KB.ID_KADEME
					into #v2FrekansOgrenciDetayDonem 
					from v2FrekansOgrenciDetay	T
					join v3KademeBilgi			KB	ON	KB.ID_KADEME3	= T.ID_KADEME3
					where	DONEM = @_DONEM 
					--1,2,3,4,5,6,8
				
				END		
				
				IF @_ISLEM IN (1,2)
				BEGIN
				
					DECLARE @ID_FREKANSSORGU	 INT = NULL
					DECLARE @ID_FREKANSSORGUDERS INT = NULL
					
					SET @ID_FREKANSSORGU	= (	SELECT ID_FREKANSSORGU 
												FROM v2FrekansSorgu 
												WHERE	DONEM			= @_DONEM 
													AND ID_SINAVTURULIST= @_ID_SINAVTURU 
													AND ID_KADEME3LIST	= @_ID_KADEME3
													AND DERSLIST		IS NULL
											)				
					IF @ID_FREKANSSORGU IS NULL		
					BEGIN
						DECLARE @TABLEADD TABLE (ID INT)
						INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
						OUTPUT inserted.ID_FREKANSSORGU INTO @TABLEADD(ID)
						VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, NULL)

						SET @ID_FREKANSSORGU = (SELECT TOP 1 ID FROM @TABLEADD)

						INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
						SELECT @ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY
						FROM v2FrekansOgrenciDetay WITH(NOLOCK) 
						WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) )--OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	))
							AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) )--OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	))
							AND DONEM = @_DONEM
						ORDER BY FREKANS

					END

					SET @ID_FREKANSSORGUDERS= (	SELECT ID_FREKANSSORGU 
												FROM v2FrekansSorgu 
												WHERE	DONEM			= @_DONEM 
													AND ID_SINAVTURULIST= @_ID_SINAVTURU 
													AND ID_KADEME3LIST	= @_ID_KADEME3
													AND (DERSLIST		= @_DERSLIST  OR (@_DERSLIST IS NULL AND DERSLIST IS NULL) )
											)
					IF @ID_FREKANSSORGUDERS IS NULL	
					BEGIN
						DELETE FROM @TABLEADD 
						INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
						OUTPUT INSERTED.ID_FREKANSSORGU INTO @TABLEADD(ID)
						VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, @_DERSLIST)

						SET @ID_FREKANSSORGUDERS = (SELECT TOP 1 ID FROM @TABLEADD)

						INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
						SELECT @ID_FREKANSSORGUDERS , S.ID_FREKANSOGRENCIDETAY
						FROM v2FrekansSorguDetay	S
						JOIN v2FrekansOgrenciDetay	T WITH(NOLOCK) 	ON	T.ID_FREKANSOGRENCIDETAY = S.ID_FREKANSOGRENCIDETAY
						WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) )--OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		))
							AND S.ID_FREKANSSORGU	= @ID_FREKANSSORGU
							AND DONEM				= @_DONEM
						ORDER BY FREKANS

					END

				END

			END
			
			IF @_ISLEM = 1	--	İLK LİSTE (FR KAMPUS)		
			BEGIN 
				
				SELECT DISTINCT ID_SUBE INTO #SUBELER FROM v3SubeYetki WHERE TCKIMLIKNO = @_TCKIMLIKNO AND ID_KULLANICITIPI NOT IN (4,5)

				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 DERSAD
						,T.ID_SUBE
						,ID_KADEME
						,T.SUBEAD
				INTO #Filtre
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER						S	ON	S.ID_SUBE	= T.ID_SUBE
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBEs		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBEs		)))
				GROUP BY DERSAD, SUBEAD, T.ID_SUBE, SUBEAD,ID_KADEME

				---- KAMPÜS Genel ve KADEME Genel SIRALAMA
				SELECT ID_SUBE, ID_KADEME, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)),ADET = 0
				INTO #GenelFrekans
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
				GROUP BY ID_SUBE, ID_KADEME
			
				UPDATE GF SET 
					GF.ADET = G.ADET
				FROM #GenelFrekans GF
				JOIN (SELECT COUNT(ID_KADEME) ADET,ID_KADEME FROM #GenelFrekans GROUP BY ID_KADEME) G ON G.ID_KADEME = GF.ID_KADEME

				DECLARE @_GENELADET INT = (SELECT COUNT(1) FROM #GenelFrekans)

				SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC), SNKADEME =  ROW_NUMBER() OVER (PARTITION BY ID_KADEME ORDER BY FREKANS DESC)
				INTO #GenelSira FROM #GenelFrekans
				WHERE FREKANS IS NOT NULL
				-----------


				-- Liste
				DROP TABLE IF EXISTS #T
				SELECT   DISTINCT
						 ID_KADEME		= K.ID_KADEME
						,ID_SUBE		= F.ID_SUBE
						,[SIRA]			= ISNULL(G.SN,@_ID_STGENEL) 		
						,[KAMPÜS]		= F.SUBEAD
						,[KADEME]		= K.AD	
					
						,[FREKANS]		= G.FREKANS--= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')					
						,[KADEME SIRA]	= CASE WHEN (SELECT COUNT(DISTINCT ID_KADEME) FROM #GenelSira) > 1 THEN ISNULL(CAST(G.SNKADEME AS VARCHAR) + ' / ' + CAST(G.ADET AS VARCHAR),'-') ELSE NULL END
						,[GENEL]		= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET AS VARCHAR),'-')
				INTO		#T
				FROM		#Filtre				F
				INNER JOIN	v3Kademe			K	ON	K.ID_KADEME	= F.ID_KADEME
				LEFT  JOIN	#GenelSira			G	ON	G.ID_KADEME	= F.ID_KADEME
													AND G.ID_SUBE	= F.ID_SUBE

				select(
					select * from(
						select 
						(					
							SELECT  
									ID_KADEME		
								   ,ID_SUBE		
								   ,[SIRA]			
						 		   ,[KAMPÜS]		
								   ,[KADEME]						
								   ,[FREKANS]	= ISNULL(CAST(FREKANS AS VARCHAR),'-')	
								   ,[KADEME SIRA]	
								   ,[GENEL]						
							FROM #T t order by t.[FREKANS] desc
							FOR JSON AUTO
						) as t												
					) as tablo FOR JSON AUTO
				) as tt					

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

			END
			IF @_ISLEM = 2	--	GENEL SIRALAMA				
			BEGIN 
		
				BEGIN
		
					SELECT	 ID_SINAVTURU
							,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
					INTO #GenelFiltre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					GROUP BY ID_SINAVTURU


					SELECT	 DERSAD
							,T.ID_SINIF
							,ID_SINAVTURU
							,ID_KADEME3
					INTO #Filtre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
						AND ID_SINIF	= @_ID_SINIF
					GROUP BY  ID_SINIF,DERSAD, ID_SINAVTURU, ID_KADEME3
				
			
					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					INTO #FiltreFrekans2 FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.DERSAD = O.DERSAD AND D.ID_SINIF = O.ID_SINIF AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU		
				UNION ALL			
					SELECT O.ID_SINIF, O.DERSAD,  @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) = 1
					GROUP BY O.ID_SINIF, O.DERSAD
				UNION ALL			
					SELECT O.ID_SINIF, 'GENEL',  @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) > 1
					GROUP BY O.ID_SINIF
			



				-- Frekans Katkı İçin
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					INTO #GenelFrekansKatki 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					GROUP BY ID_SINIF, ID_SINAVTURU, DERSAD
				UNION ALL				
					SELECT ID_SINIF, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					FROM #v2FrekansOgrenciDetayDonem	T
					WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					GROUP BY ID_SINIF, DERSAD


					-- Öğretmen Genel
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SINAVTURU
				UNION ALL				
					SELECT ID_SINIF, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM #v2FrekansOgrenciDetayDonem	T			
					GROUP BY ID_SINIF

					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
					INTO #GenelSira2 FROM #GenelFrekans2 T
					WHERE FREKANS IS NOT NULL
				
					--------------------------------------------------------------------

					-- Öğretmen Zümre Genel
					SELECT ID_SINIF, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD, ID_SINAVTURU
				UNION ALL			
					SELECT ID_SINIF, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD


					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
					INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
					WHERE FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Kampus Genel
					SELECT ID_SINIF, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))					
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE


					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Zümre Kampus Genel
					SELECT ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD

					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------


					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
					INTO #OgrenciSinifListe2 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 														
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU
				UNION ALL 			
					SELECT O.ID_SINIF, O.DERSAD, @_ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD

			

					INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@_ID_STGENEL,'GENEL','GNL',1,2)



					SELECT ID_SINAVTURU
						,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
						,MAX(GF.FREKANS) MAXIMUM
						,MIN(GF.FREKANS) MINIMUM 						
						--,MINIMUM	= IIF(MIN(GF.FREKANS) < 0, 0 , MIN(GF.FREKANS) )
						, DERSAD
					INTO #ARALIK 
					FROM #GenelFrekansKatki	GF
					GROUP BY ID_SINAVTURU, DERSAD


					SELECT ID_SINAVTURU
						,KADEME1 = MINIMUM + ARALIK
						,KADEME2 = MINIMUM + (ARALIK*2)
						,KADEME3 = MINIMUM + (ARALIK*3)
						,KADEME4 = MINIMUM + (ARALIK*4)
						, DERSAD
					INTO #ETKI
					FROM #ARALIK
				

				
					SELECT 
						 [SINAV TÜRÜ]		= S.AD 
						,[STKISAAD]			= S.KISAAD
						,[BRANŞ]			= F.DERSAD
						,[ID_SINAVTURU]		= F.ID_SINAVTURU
						,[FREKANS]			= ISNULL( MAX(F.FREKANS) ,0)
						,[FREKANS KATKI]	= --CASE WHEN AVG(F.FREKANS) < 0 THEN 'NEGATİF EKTİ'
												--ELSE 
													CASE
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME1 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİSİZ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME2 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'AZ ETKİLİ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME3 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'NORMAL'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİLİ'
														WHEN AVG(F.FREKANS) >= (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ÇOK ETKİLİ'
														ELSE '---'
													END
												--END
						,[KAMPÜS ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira2	tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira2	K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU  AND K.DERSAD = F.DERSAD	ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[KAMPÜS GENEL]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU								)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU							ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')					
						,[GENEL ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU	AND K.DERSAD = F.DERSAD						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR),'---')
					INTO	#T1
					FROM #FiltreFrekans2				F
					INNER JOIN #OgrenciSinifListe2	O	ON	O.ID_SINIF		= F.ID_SINIF		
														AND O.ID_SINAVTURU	= F.ID_SINAVTURU		
														AND O.DERSAD		= F.DERSAD		
					INNER JOIN #SINAVTURU			S	ON	S.ID_SINAVTURU	= F.ID_SINAVTURU
					LEFT  JOIN #GenelSira2			G	ON	G.ID_SINIF		= F.ID_SINIF		
														AND G.ID_SINAVTURU	= S.ID_SINAVTURU
					WHERE F.FREKANS IS NOT NULL
					GROUP BY S.AD, F.ID_SINIF, F.ID_SINAVTURU, F.DERSAD, G.SN, S.KISAAD

		
				END


				-------------------------------------------------	(2.2)	2. SAYFA ALT


				print 11
				SELECT	 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,MAX(T.SS) SORUSAYISI
						,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
						,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
						,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
						,TC_OGRETMEN
						,ID_DERS
						,T.ID_SUBE
						,T.ID_SINAVTURU
						,ID_SINIF
						,SINIFAD
						,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
						,AVG(ILK_SS) ILK_SS
				INTO	#ORTALAMA3
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU	= @ID_FREKANSSORGU
					AND ID_SINIF			= @_ID_SINIF
				GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD


				SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
						,[BRANŞ]		= DERSAD
						,[SINAV TÜRÜ]	= ST.AD
						,[KAMPÜS]		= SUBEAD
						,[SINIF]		= ORT.SINIFAD	
						,[H.B. NET ORT.]= ORT.HBNET	
						,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
						,ORT.FREKANS		
						,SD.ID_SINIF
						,TC_OGRETMEN
						,SIRA
						,ORT.ID_SINAVTURU
						--,TC_DANISMAN	= K.TCKIMLIKNO
						,[DANIŞMAN]		= K.AD+' '+K.SOYAD
				INTO	#T2
				FROM	#ORTALAMA3	ORT
				JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
										AND ST.SIRA			<> 2
				JOIN	OkyanusDB.DBO.v3SinifPersonel	SD	ON	SD.ID_SINIF = ORT.ID_SINIF AND SD.ID_KULLANICITIPI = 100
				JOIN	OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= SD.TCKIMLIKNO
				WHERE	ORT.FREKANS IS NOT NULL
				ORDER BY ST.SIRA





					select(
							select * from(
								select 
								(						 
									SELECT * FROM #T1
									ORDER BY BRANŞ,ID_SINAVTURU
									FOR JSON AUTO
								) as t1
								,( 
									SELECT * FROM #T2
									ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
									FOR JSON AUTO
								)as t2							
							) as tablo FOR JSON AUTO
						) as tt


					
					
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 

				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2

				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2

				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2
			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

				DROP TABLE IF EXISTS #GenelFrekansKatki


			END
			IF @_ISLEM = 3	--	SINIF ÖĞRENCİ LİSTESİ		
			BEGIN 

				SELECT	[KAMPÜS]			= SUBEAD,
						[SINIF]				= SINIFAD,
						[BRANŞ]				= TAKMAAD,
						[SINAV TÜRÜ]		= ST.AD,
						[AD SOYAD]			= K.AD+' '+K.SOYAD,
						[SORU SAYISI]		= MAX(T.ILK_SS),
						[H.B NET]			= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
						[NET ORT]			= CAST(AVG(T.NET) AS DECIMAL(8,2)),
						[HEDEFE UZAKLIK]	= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),				
					
						--[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
						[FREKANS]	= CAST(		CASE
										WHEN T.ID_SINAVTURU=0 THEN AVG(NET) 
										WHEN T.ID_SINAVTURU IN (5,6)  THEN (	SELECT FREKANS 
																				FROM #v2FrekansOgrenciDetayDonem DD
																				JOIN (SELECT TOP 1 S.ID_SINAV
																							FROM #v2FrekansOgrenciDetayDonem D 
																							JOIN Sinav						 S	ON	S.ID_SINAV	= D.ID_SINAV
																							WHERE	D.TC_OGRENCI	= T.TC_OGRENCI 
																								AND D.ID_SINAVTURU	= T.ID_SINAVTURU
																								AND D.TC_OGRETMEN	= T.TC_OGRETMEN
																								AND D.DERSAD		= T.DERSAD
																							ORDER BY S.SINAVTARIH DESC, ID_SINAV
																				) AS SD  ON DD.TC_OGRENCI	= T.TC_OGRENCI 
																						AND DD.ID_SINAVTURU	= T.ID_SINAVTURU
																						AND DD.TC_OGRETMEN	= T.TC_OGRETMEN
																						AND DD.DERSAD		= T.DERSAD
																						AND DD.ID_SINAV		= SD.ID_SINAV
																			) 
										ELSE 	AVG(FREKANS) 
									END 
							AS DECIMAL(8,2) ) ,-- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					
								
						[TC_OGRENCI]	    = TC_OGRENCI,		
						[TC_OGRETMEN]	    = TC_OGRETMEN,	
						[ID_SINIF]			= T.ID_SINIF,		
						[ID_SINAVTURU]		= T.ID_SINAVTURU	
				INTO	#v2FrekansOgrenciDetay
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				WHERE 	T.ID_SINIF	= @_ID_SINIF
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND T.DERSAD	= @_DERSAD
					AND FREKANS		IS NOT NULL
					AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
				GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET,T.DERSAD
			
				select(
							select * from(
								select 
								(					
									SELECT		* 
									FROM		#v2FrekansOgrenciDetay
									ORDER BY	[AD SOYAD]
									FOR JSON AUTO
								) as t3
												
							) as tablo FOR JSON AUTO
						) as tt
				DROP TABLE #v2FrekansOgrenciDetay
			END
			IF @_ISLEM = 4	--	ÖĞRENCİ FREKANS SINAV LST	
			BEGIN 

				SELECT	 SUBEAD
						,TAKMAAD
						,ST.AD SINAVTURU
						,CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
							ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
						END SINAVADI
						,CAST(CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (	
															SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
															INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
															WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
															GROUP BY YO.TELAFI
														) 
							ELSE						(	T.FREKANS
														)
						END AS decimal(8,2)) SINAVPUANI
						,K.AD+' '+K.SOYAD ADSOYAD
						,SINIFAD
						,SS 
						,CAST(HBNET AS DECIMAL(8,2)) HBNET
						,ILK_SS HEDEF
						,CAST(NET AS DECIMAL(8,2))	 NET
						,S.SINAVTARIH
						,S.ID_SINAVTURU
				INTO	#OGRENCISINAV
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				LEFT JOIN Sinav			S	ON	S.ID_SINAV		= T.ID_SINAV
				WHERE	TC_OGRENCI		=	@_TC_OGRENCI
					AND TAKMAAD			=	@_DERSAD
					AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
					AND T.FREKANS IS NOT NULL
				GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET,S.SINAVTARIH,S.ID_SINAVTURU


				IF (SELECT COUNT(1) FROM #OGRENCISINAV WHERE ID_SINAVTURU != 6 )>1
				BEGIN
					INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET,SINAVTARIH)
					SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,CAST(AVG(HBNET) AS decimal(8,2)),HEDEF,CAST(AVG(NET) AS DECIMAL(8,2)),GETDATE()
					FROM	#OGRENCISINAV 
					GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HEDEF
				END

				select(
							select * from(
								select 
								(					
									SELECT		[KAMPÜS]		= SUBEAD,
												[SINIF]			= SINIFAD,
												[BRANŞ]			= TAKMAAD,
												[SINAV TÜRÜ]	= SINAVTURU,
												[SINAV]			= SINAVADI,
												[SORU SAYISI]	= SS,
												[H.B. NET ORT.] = HBNET,
												[HEDEFE UZAKLIK]= HEDEF-HBNET,
												[ÖĞR NET]		= NET,
												[PUAN]			= SINAVPUANI,
												[FREKANS]		= SINAVPUANI,
												ADSOYAD
									FROM		#OGRENCISINAV 
									ORDER BY SINAVTARIH
									FOR JSON AUTO
								) as t4
												
							) as tablo FOR JSON AUTO
						) as tt
			
				DROP TABLE IF EXISTS #OGRENCISINAV
			END
			IF @_ISLEM = 5	--	ÖĞRETMEN SINIF GRAFİĞİ		
			BEGIN 
			
					
			

				DECLARE @_SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
				IF (0 IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
				BEGIN
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

						SELECT	ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,'FREKANS' SINAVADI
						INTO	#FREKANSOGRETMEN2
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND FREKANS IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND T.DONEM		= @_DONEM
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

						SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO #PIVOT  FROM #FREKANSOGRETMEN2

						INSERT INTO @_SINAVLAR (SINAVADI) VALUES ('FREKANS')

						select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#PIVOT 
									FOR JSON AUTO
								) as t5,
								(					
									SELECT	SINAVADI
									FROM	@_SINAVLAR
									FOR JSON AUTO
								) as t6
												
							) as tablo FOR JSON AUTO
						) as tt

					
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

				END
				ELSE
				BEGIN
			
						DROP TABLE IF EXISTS #v2FrekansOgretmen
					
						SELECT	ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,CASE 
									WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
									ELSE (SELECT TOP 1 SUBSTRING(K.AD ,1, CHARINDEX('.',K.AD)-1 )+'-'+S.AD FROM Sinav S JOIN v3Kademe3 K ON K.ID_KADEME3 = S.ID_KADEME3 WHERE S.ID_SINAV=T.ID_SINAV) 
								END SINAVADI
						INTO	#v2FrekansOgretmen
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU				ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
						GROUP BY ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

						--TAHSİN--
						INSERT INTO #v2FrekansOgretmen
						SELECT	ID_SINIF,T.ID_SINAVTURU,999999999 as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,ST.KISAAD+' ORT' as SINAVADI
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND ST.ID_SINAVTURU NOT IN (5,6) -- AAYKS VEYA YDS DEĞİLSE
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
						--TAHSİN--
					
						DECLARE @_cols	AS NVARCHAR(MAX),
								@_cols2	AS NVARCHAR(MAX),
								@_cols3	AS NVARCHAR(MAX),
								@_SQL	AS NVARCHAR(MAX);
												
						--TAHSİN--
						SET @_cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
		
						SET @_cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SUM DAN DOLAYI SORUN OLABILIR
						SET @_cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
						--TAHSİN--

						INSERT INTO @_SINAVLAR (SINAVADI)
							SELECT	DISTINCT SINAVADI
							FROM	#v2FrekansOgretmen

						SET @_SQL='
					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1


							SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols2 AS varchar(MAX))+' INTO #PVT1 FROM (
								SELECT * FROM #v2FrekansOgretmen
							)AS TABLO
							PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@_cols AS varchar(MAX))+')) AS P
					

							SELECT		ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols3 AS varchar(MAX))+'
										INTO		#PVT
										FROM		#PVT1 
										group by ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]
					
							select(
								select * from(
									select 
									(					
										SELECT		*
										FROM		#PVT 
										FOR JSON AUTO
									) as t5,
									(					
										SELECT	DISTINCT SINAVADI
										FROM	#v2FrekansOgretmen
										FOR JSON AUTO
									) as t6
												
								) as tablo FOR JSON AUTO
							) as tt

					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1

						'
					
						print @_SQL
						EXECUTE (@_SQL)

						--set @_SQL='
						--	'

						--			execute (@_SQL)
								

				DROP TABLE IF EXISTS #v2FrekansOgretmen
					
				END
			

			
			END
			IF @_ISLEM = 6	--	DERSLER						
			BEGIN 


				SELECT	D.* 
				INTO	#DERSLER 
				FROM	v3SinavDers D
				INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD
				--6
			
				select(
							select * from(
								select 
								(	

									SELECT	DISTINCT D.AD
									FROM	#DERSLER				D
									JOIN	v2FrekansOgrenciDetay	OD	ON	OD.DERSAD=D.AD
									WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 
										AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@_ID_SINAVTURU)) 
										AND OD.DONEM = @_DONEM
									FOR JSON AUTO
								) as t5
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @_ISLEM = 7	--	SINAV TURU					
			BEGIN 
			
			

				select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
				INTO #GrupSinavTuru 
				from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
			union 
				select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
			--union 
			--	select 0,15 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,16 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,17 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,18 , 'YAZILI', 'YAZ'

					INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
					FROM v3Kademe3	K
					JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
					WHERE ID_KADEME3 IN ( 11,12,13,14)


					--INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					--SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
					--FROM v3Kademe3	K
					--WHERE ID_KADEME3 IN ( 11,12,13,14)

					
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 


				drop table #GrupSinavTuru
			END
			IF @_ISLEM = 8	--	İKİNCİ LİSTE (FR SINIF)		
			BEGIN 
				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 
						 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
						,T.ID_SINIF
						,SD.TCKIMLIKNO TC_DANISMAN
				INTO #Filtre8 
				FROM #v2FrekansOgrenciDetayDonem		T
				JOIN [OkyanusDB].DBO.[v3SinifPersonel]	SD	ON	SD.ID_SINIF	= T.ID_SINIF AND SD.ID_KULLANICITIPI = 100
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )))
					AND (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					--AND (ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
					AND (T.ID_SUBE = @_ID_SUBE OR @_ID_SUBE = 0) 
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3,T.ID_SINIF,SD.TCKIMLIKNO

				SELECT	 O.ID_SINIF
						,FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS))
						,HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET))
						,SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
						,D.TC_DANISMAN
				INTO #FiltreFrekans8 
				FROM #Filtre8						O
				JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_DANISMAN		= O.TC_DANISMAN
														AND D.DERSAD		= O.DERSAD 
														AND D.ID_SUBE		= O.ID_SUBE 
														AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
														AND D.ID_KADEME3	= O.ID_KADEME3
				GROUP BY O.ID_SINIF,D.TC_DANISMAN
			

				-- Öğretmen Genel
				SELECT ID_SINIF, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans8 FROM #v2FrekansOgrenciDetayDonem	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )))
					AND (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
				GROUP BY ID_SINIF

				DECLARE @_GENELADET8 INT = (SELECT COUNT(DISTINCT ID_SINIF) FROM #GenelFrekans8)

				SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC)
				INTO #GenelSira8 FROM #GenelFrekans8
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------
			
				-- Öğretmen Kampus Genel
				SELECT ID_SINIF, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans8 FROM #v2FrekansOgrenciDetayDonem	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )))
					AND (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
				GROUP BY ID_SINIF, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans8 G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
				INTO #GenelKampusSira8 FROM #GenelKampusFrekans8	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

			
				-- Liste

				DROP TABLE IF EXISTS #T8
				SELECT   ID_SINIF				= GS.ID_SINIF
						,[SIRA]					= ISNULL(G.SN,@_ID_STGENEL) 		
						,[KAMPÜS]				= GS.SUBEAD
						,[SINIF]				= GS.SINIF	
						,[DANIŞMAN ÖĞRETMEN]	= K.AD + ' ' + K.SOYAD 
						--,[BRANŞ]				= ISNULL( (SELECT STUFF((SELECT '<br>' +  CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM eokul_v2.DBO.DERSOGRETMEN DO WHERE DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =K.TCKIMLIKNO  ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[BRANŞ]				= ( SELECT ISNULL( (SELECT STUFF((SELECT DISTINCT '<br>' +  D.DERSAD  FROM OKYANUSDB.DBO.v3DersProgram DO  JOIN eokul_v2.DBO.Ders D ON D.ID_DERS = DO.ID_DERS WHERE  DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =F.TC_DANISMAN ORDER BY '<br>' +  D.DERSAD  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-') )

						,[TC_DANISMAN]			= F.TC_DANISMAN
						,[FREKANS]				= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')
						,[KAMPÜS GENEL]			= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira8		 tt  WHERE tt.ID_SINIF=k.ID_SINIF)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira8		K WHERE K.ID_SINIF = F.ID_SINIF ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL]				= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET8 AS VARCHAR),'-')					
				INTO		#T8
				FROM		#FiltreFrekans8		F
				INNER JOIN	vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= F.ID_SINIF 
				INNER JOIN	v3Kullanici			K	ON	K.TCKIMLIKNO	= F.TC_DANISMAN
				LEFT  JOIN	#GenelSira8			G	ON	G.ID_SINIF		= F.ID_SINIF

				select(
					select * from(
						select 
						(					
							SELECT * FROM #T8 order by SIRA
							FOR JSON AUTO
						) as t												
					) as tablo FOR JSON AUTO
				) as tt					

			
				DROP TABLE IF EXISTS #T8
				DROP TABLE IF EXISTS #Filtre8
				DROP TABLE IF EXISTS #FiltreFrekans8

				DROP TABLE IF EXISTS #GenelFrekans8
				DROP TABLE IF EXISTS #GenelSira8

				DROP TABLE IF EXISTS #GenelKampusFrekans8
				DROP TABLE IF EXISTS #GenelKampusSira8

			END
			IF @_ISLEM = 9	--	SON FİLTRE GETİR			
			BEGIN 

				--DECLARE @_TC VARCHAR(11) 
				--SET @_TC = @_TCKIMLIKNO


				SELECT ISNULL((
					SELECT TOP 1 PARAMETRELER
					FROM [Log]
					WHERE	TCKIMLIKNO	= @_TCKIMLIKNO
						AND ID_MENU		= 1200
						AND ISLEM		= 1
					ORDER BY KYE_TARIH DESC
				),'[]')
			END
				
			BEGIN

				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 
				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira
				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira
				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #DERSLER
				DROP TABLE IF EXISTS #ETKI
				DROP TABLE IF EXISTS #SINAVTURU
				DROP TABLE IF EXISTS #SUBELER
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_v2FrekansSinif]    Script Date: 23.11.2021 15:39:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_v2FrekansSinif]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,	
	@ID_SUBE			VARCHAR(MAX)	= NULL,	
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,	
	@DERSAD				VARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	DECLARE 
		@_ISLEM				INT				=	@ISLEM			,
		@_TCKIMLIKNO		VARCHAR(11)		=	@TCKIMLIKNO		,
		@_TC_OGRENCI		VARCHAR(11)		=	@TC_OGRENCI		,
		@_TC_OGRETMEN		VARCHAR(11)		=	@TC_OGRETMEN	,
		@_OTURUM			VARCHAR(36)		=	@OTURUM			,
		@_ID_MENU			INT				=	@ID_MENU		,
		@_ID_KADEME			INT				=	@ID_KADEME		,
		@_DONEM				char(4)			=	@DONEM			,
		@_ID_KADEMEs		VARCHAR(MAX)	=	@ID_KADEMEs		,
		@_ID_KADEME3		VARCHAR(MAX)	=	@ID_KADEME3		,
		@_ID_SINAVTURU		VARCHAR(MAX)	=	@ID_SINAVTURU	,
		@_ID_SUBE			VARCHAR(MAX)	=	@ID_SUBE		,
		@_DERSLIST			VARCHAR(MAX)	=	@DERSLIST		,
		@_ID_SINIF			INT				=	@ID_SINIF		,
		@_DERSAD			VARCHAR(MAX)	=	@DERSAD			,
		@_FREKANSKARNE		BIT				=	@FREKANSKARNE




	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @_ISLEM			
				,TCKIMLIKNO		= @_TCKIMLIKNO		
				,TC_OGRENCI		= @_TC_OGRENCI		
				,TC_OGRETMEN	= @_TC_OGRETMEN	
				,OTURUM			= @_OTURUM			
				,ID_MENU		= @_ID_MENU		
				,ID_KADEME		= @_ID_KADEME	
				,ID_KADEMEs		= @_ID_KADEMEs
				,DONEM			= @_DONEM			
				,ID_KADEME3		= @_ID_KADEME3		
				,ID_SINAVTURU	= @_ID_SINAVTURU	
				,ID_SUBE		= @_ID_SUBE		
				,DERSLIST		= @_DERSLIST		
				,ID_SINIF		= @_ID_SINIF		
				,DERSAD			= @_DERSAD			
				,FREKANSKARNE	= @_FREKANSKARNE	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0



	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @_OTURUM, @TCKIMLIKNO = @_TCKIMLIKNO, @ID_MENU = @_ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @_ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		
		IF @ID_LOG > 0
		BEGIN
		
			DECLARE @ID_STGENEL INT=999999

			IF @_DONEM='' OR @_DONEM IS NULL
				SET @_DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)


			BEGIN

				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 
				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira
				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira
				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #DERSLER
				DROP TABLE IF EXISTS #ETKI
				DROP TABLE IF EXISTS #SINAVTURU
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem

			END

			IF @_ISLEM IN (1,2,3,4,5)
			BEGIN
			


				DECLARE @SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				INSERT INTO @SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				INSERT INTO @SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
				SELECT * INTO #SINAVTURU FROM @SINAVTURU
				-- 2,3,4,5
										
				select 
					T.ID_FREKANSOGRENCIDETAY
					,T.ID_SINAVTURU
					,T.ID_KADEME3
					,T.ID_OGRENCI
					,T.TC_OGRENCI
					,T.TAKMAAD
					,T.ID_SINAV
					,T.NET
					,T.SS
					,T.ILK_ID_SINAV
					,T.ILK_NET
					,T.ILK_SS
					,T.FREKANS
					,T.DONEM
					,T.ID_SINIF
					,T.ID_SUBE
					,T.ID_DERS
					,T.TC_OGRETMEN
					,T.OGRETMENADSOYAD
					,T.DERSAD
					,T.SUBEAD
					,T.SINIFAD
					,T.HBNET
					,SD.TCKIMLIKNO TC_DANISMAN
					,S.ID_KADEME
				into #v2FrekansOgrenciDetayDonem 
				from v2FrekansOgrenciDetay T WITH (NOLOCK)
				JOIN [OkyanusDB].[dbo].[vw_SinifDanisman]	SD	ON	SD.ID_SINIF	= T.ID_SINIF
				JOIN [OkyanusDB].[dbo].[vw_v4SinifDetay]	S	ON	S.ID_SINIF	= SD.ID_SINIF
																AND S.DONEM		= T.DONEM
				where	S.DONEM = @_DONEM 
				-- 1,2,3,4,5,6


			END
		
			IF @_ISLEM IN (1,2)
			BEGIN
				
				DECLARE @ID_FREKANSSORGU	 INT = NULL
				DECLARE @ID_FREKANSSORGUDERS INT = NULL
					
				SET @ID_FREKANSSORGU	= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND DERSLIST		IS NULL
										)				
				IF @ID_FREKANSSORGU IS NULL		
				BEGIN
					DECLARE @TABLEADD TABLE (ID INT)
					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT inserted.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, NULL)

					SET @ID_FREKANSSORGU = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY
					FROM v2FrekansOgrenciDetay WITH(NOLOCK) 
					WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) )--OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	))
						AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) )--OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	))
						AND DONEM = @_DONEM
					ORDER BY FREKANS

				END

				SET @ID_FREKANSSORGUDERS= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND (DERSLIST		= @_DERSLIST  OR (@_DERSLIST IS NULL AND DERSLIST IS NULL) )
										)
				IF @ID_FREKANSSORGUDERS IS NULL	
				BEGIN
					DELETE FROM @TABLEADD 
					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT INSERTED.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, @_DERSLIST)

					SET @ID_FREKANSSORGUDERS = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGUDERS , S.ID_FREKANSOGRENCIDETAY
					FROM v2FrekansSorguDetay	S
					JOIN v2FrekansOgrenciDetay	T WITH(NOLOCK) 	ON	T.ID_FREKANSOGRENCIDETAY = S.ID_FREKANSOGRENCIDETAY
					WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) ) --OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		))
						AND S.ID_FREKANSSORGU	= @ID_FREKANSSORGU
						AND DONEM				= @_DONEM
					ORDER BY FREKANS

				END

			END
		
			IF @_ISLEM = 1	--	İLK LİSTE (FR SINIF)		
			BEGIN 
			
				SELECT DISTINCT ID_SUBE INTO #SUBELER FROM v3SubeYetki WHERE TCKIMLIKNO = @_TCKIMLIKNO AND ID_KULLANICITIPI NOT IN (4,5)

				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 
						 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
						,T.ID_SINIF
						,SD.TCKIMLIKNO TC_DANISMAN
				INTO #Filtre 
				FROM v2FrekansSorguDetay				D
				JOIN #v2FrekansOgrenciDetayDonem		T	ON	D.ID_FREKANSOGRENCIDETAY	= T.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER							S	ON	S.ID_SUBE	= T.ID_SUBE
				JOIN [OkyanusDB].DBO.[vw_SinifDanisman]	SD	ON	SD.ID_SINIF	= T.ID_SINIF
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
					--AND (ID_SUBE = @_ID_SUBE OR @_ID_SUBE = 0) 
					AND (@_ID_KADEME IS NULL OR @_ID_KADEME = ID_KADEME OR @_ID_KADEME = 0)
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3,T.ID_SINIF,SD.TCKIMLIKNO

				SELECT	 O.ID_SINIF
						,FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS))
						,HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET))
						,SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
						,D.TC_DANISMAN
				INTO #FiltreFrekans 
				FROM #Filtre						O
				JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_DANISMAN	= O.TC_DANISMAN
														AND D.DERSAD		= O.DERSAD 
														AND D.ID_SUBE		= O.ID_SUBE 
														AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
														AND D.ID_KADEME3	= O.ID_KADEME3
				GROUP BY O.ID_SINIF,D.TC_DANISMAN
			

				-- Öğretmen Genel
				SELECT ID_SINIF, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans 
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
				GROUP BY ID_SINIF

				DECLARE @GENELADET INT = (SELECT COUNT(DISTINCT ID_SINIF) FROM #GenelFrekans)

				SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC)
				INTO #GenelSira FROM #GenelFrekans
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------
			
				-- Öğretmen Kampus Genel
				SELECT ID_SINIF, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
				GROUP BY ID_SINIF, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
				INTO #GenelKampusSira FROM #GenelKampusFrekans	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

			
				-- Liste

				DROP TABLE IF EXISTS #T
				SELECT   ID_SINIF				= GS.ID_SINIF
						,[SIRA]					= ISNULL(G.SN,@ID_STGENEL) 		
						,[KAMPÜS]				= GS.SUBEAD
						,[SINIF]				= GS.SINIF	
						,[DANIŞMAN ÖĞRETMEN]	= K.AD + ' ' + K.SOYAD 
						--,[BRANŞ]				= ISNULL( (SELECT STUFF((SELECT '<br>' +  CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM eokul_v2.DBO.DERSOGRETMEN DO WHERE DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =K.TCKIMLIKNO  ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[BRANŞ]				= ( SELECT ISNULL( (SELECT STUFF((SELECT DISTINCT '<br>' +  D.DERSAD  FROM OKYANUSDB.DBO.v3DersProgram DO  JOIN eokul_v2.DBO.Ders D ON D.ID_DERS = DO.ID_DERS WHERE  DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =F.TC_DANISMAN ORDER BY '<br>' +  D.DERSAD  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-') )

						,[TC_DANISMAN]			= F.TC_DANISMAN
						,[FREKANS]				= ISNULL(CAST(G.FREKANS AS VARCHAR),'-')
						,[KAMPÜS GENEL]			= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira		 tt  WHERE tt.ID_SINIF=k.ID_SINIF)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira		K WHERE K.ID_SINIF = F.ID_SINIF ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL]				= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET AS VARCHAR),'-')					
				INTO		#T
				FROM		#FiltreFrekans		F
				INNER JOIN	[OkyanusDB].[dbo].[vw_v4SinifDetay]	GS	ON	GS.ID_SINIF		= F.ID_SINIF 
				INNER JOIN	v3Kullanici			K	ON	K.TCKIMLIKNO	= F.TC_DANISMAN
				LEFT  JOIN	#GenelSira			G	ON	G.ID_SINIF		= F.ID_SINIF

				select(
					select * from(
						select 
						(					
							SELECT * FROM #T order by SIRA
							FOR JSON AUTO
						) as t												
					) as tablo FOR JSON AUTO
				) as tt					

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

			END
			IF @_ISLEM = 2	--	GENEL SIRALAMA				
			BEGIN 
		
				BEGIN
		
					SELECT	 ID_SINAVTURU
							,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
					INTO #GenelFiltre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
						AND DONEM = @_DONEM
					GROUP BY ID_SINAVTURU


					SELECT	 DERSAD
							,T.ID_SINIF
							,ID_SINAVTURU
							,ID_KADEME3
					INTO #Filtre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU	= @ID_FREKANSSORGUDERS
						AND ID_SINIF			= @_ID_SINIF
					GROUP BY  ID_SINIF,DERSAD, ID_SINAVTURU, ID_KADEME3
				
			
					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					INTO #FiltreFrekans2 FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.DERSAD = O.DERSAD AND D.ID_SINIF = O.ID_SINIF AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU		
				UNION ALL			
					SELECT O.ID_SINIF, O.DERSAD,  @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) = 1
					GROUP BY O.ID_SINIF, O.DERSAD
				UNION ALL			
					SELECT O.ID_SINIF, 'GENEL',  @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) > 1
					GROUP BY O.ID_SINIF
			



				-- Frekans Katkı İçin
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					INTO #GenelFrekansKatki 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					GROUP BY ID_SINIF, ID_SINAVTURU, DERSAD
				UNION ALL				
					SELECT ID_SINIF, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					FROM #v2FrekansOgrenciDetayDonem	T
					WHERE (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					GROUP BY ID_SINIF, DERSAD


					-- Öğretmen Genel
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SINAVTURU
				UNION ALL				
					SELECT ID_SINIF, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM #v2FrekansOgrenciDetayDonem	T			
					GROUP BY ID_SINIF

					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
					INTO #GenelSira2 FROM #GenelFrekans2 T
					WHERE FREKANS IS NOT NULL
				
					--------------------------------------------------------------------

					-- Öğretmen Zümre Genel
					SELECT ID_SINIF, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD, ID_SINAVTURU
				UNION ALL			
					SELECT ID_SINIF, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD


					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
					INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
					WHERE FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Kampus Genel
					SELECT ID_SINIF, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE


					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Zümre Kampus Genel
					SELECT ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD

					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------


					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
					INTO #OgrenciSinifListe2 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 														
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU
				UNION ALL 			
					SELECT O.ID_SINIF, O.DERSAD, @ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD

			

					INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@ID_STGENEL,'GENEL','GNL',1,2)



					SELECT ID_SINAVTURU
						,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
						,MAX(GF.FREKANS) MAXIMUM
						,MIN(GF.FREKANS) MINIMUM 						
						--,MINIMUM	= IIF(MIN(GF.FREKANS) < 0, 0 , MIN(GF.FREKANS) )
						, DERSAD
					INTO #ARALIK 
					FROM #GenelFrekansKatki	GF
					GROUP BY ID_SINAVTURU, DERSAD


					SELECT ID_SINAVTURU
						,KADEME1 = MINIMUM + ARALIK
						,KADEME2 = MINIMUM + (ARALIK*2)
						,KADEME3 = MINIMUM + (ARALIK*3)
						,KADEME4 = MINIMUM + (ARALIK*4)
						, DERSAD
					INTO #ETKI
					FROM #ARALIK
				

				
					SELECT 
						 [SINAV TÜRÜ]		= S.AD 
						,[STKISAAD]			= S.KISAAD
						,[BRANŞ]			= F.DERSAD
						,[ID_SINAVTURU]		= F.ID_SINAVTURU
						,[FREKANS]			= ISNULL( MAX(F.FREKANS) ,0)
						,[FREKANS KATKI]	= --CASE WHEN AVG(F.FREKANS) < 0 THEN 'NEGATİF EKTİ'
												--ELSE 
													CASE
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME1 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİSİZ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME2 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'AZ ETKİLİ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME3 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'NORMAL'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİLİ'
														WHEN AVG(F.FREKANS) >= (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ÇOK ETKİLİ'
														ELSE '---'
													END
												--END
						,[KAMPÜS ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira2	tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira2	K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU  AND K.DERSAD = F.DERSAD	ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[KAMPÜS GENEL]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU								)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU							ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')					
						,[GENEL ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU	AND K.DERSAD = F.DERSAD						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR),'---')
					INTO	#T1
					FROM #FiltreFrekans2				F
					INNER JOIN #OgrenciSinifListe2	O	ON	O.ID_SINIF		= F.ID_SINIF		
														AND O.ID_SINAVTURU	= F.ID_SINAVTURU		
														AND O.DERSAD		= F.DERSAD		
					INNER JOIN #SINAVTURU			S	ON	S.ID_SINAVTURU	= F.ID_SINAVTURU
					LEFT  JOIN #GenelSira2			G	ON	G.ID_SINIF		= F.ID_SINIF		
														AND G.ID_SINAVTURU	= S.ID_SINAVTURU
					WHERE F.FREKANS IS NOT NULL
					GROUP BY S.AD, F.ID_SINIF, F.ID_SINAVTURU, F.DERSAD, G.SN, S.KISAAD

		
				END


				-------------------------------------------------	(2.2)	2. SAYFA ALT


				print 11
				SELECT	 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,MAX(T.SS) SORUSAYISI
						,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
						,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
						,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
						,TC_OGRETMEN
						,ID_DERS
						,T.ID_SUBE
						,T.ID_SINAVTURU
						,ID_SINIF
						,SINIFAD
						,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
						,AVG(ILK_SS) ILK_SS
				INTO	#ORTALAMA3
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND ID_SINIF	= @_ID_SINIF
				GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD


				SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
						,[BRANŞ]		= DERSAD
						,[SINAV TÜRÜ]	= ST.AD
						,[KAMPÜS]		= SUBEAD
						,[SINIF]		= ORT.SINIFAD	
						,[H.B. NET ORT.]= ORT.HBNET	
						,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
						,ORT.FREKANS		
						,SD.ID_SINIF
						,TC_OGRETMEN
						,SIRA
						,ORT.ID_SINAVTURU
						--,TC_DANISMAN	= K.TCKIMLIKNO
						,[DANIŞMAN]		= K.AD+' '+K.SOYAD
				INTO	#T2
				FROM	#ORTALAMA3	ORT
				JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
										AND ST.SIRA			<> 2
				JOIN	OkyanusDB.DBO.vw_SinifDanisman	SD	ON	SD.ID_SINIF = ORT.ID_SINIF
				JOIN	OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= SD.TCKIMLIKNO
				WHERE	ORT.FREKANS IS NOT NULL
				ORDER BY ST.SIRA





					select(
							select * from(
								select 
								(						 
									SELECT * FROM #T1
									ORDER BY BRANŞ,ID_SINAVTURU
									FOR JSON AUTO
								) as t1
								,( 
									SELECT * FROM #T2
									ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
									FOR JSON AUTO
								)as t2							
							) as tablo FOR JSON AUTO
						) as tt


					
					
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 

				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2

				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2

				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2
			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

				DROP TABLE IF EXISTS #GenelFrekansKatki


			END
			IF @_ISLEM = 3	--	SINIF ÖĞRENCİ LİSTESİ		
			BEGIN 

				SELECT	[KAMPÜS]			= SUBEAD,
						[SINIF]				= SINIFAD,
						[BRANŞ]				= TAKMAAD,
						[SINAV TÜRÜ]		= ST.AD,
						[AD SOYAD]			= K.AD+' '+K.SOYAD,
						[SORU SAYISI]		= MAX(T.ILK_SS),
						[H.B NET]			= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
						[NET ORT]			= CAST(AVG(T.NET) AS DECIMAL(8,2)),
						[HEDEFE UZAKLIK]	= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),				
					
						--[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
						[FREKANS]	= CAST(		CASE
										WHEN T.ID_SINAVTURU=0 THEN AVG(NET) 
										WHEN T.ID_SINAVTURU IN (5,6)  THEN (	SELECT FREKANS 
																				FROM #v2FrekansOgrenciDetayDonem DD
																				JOIN (SELECT TOP 1 S.ID_SINAV
																							FROM #v2FrekansOgrenciDetayDonem D 
																							JOIN Sinav						 S	ON	S.ID_SINAV	= D.ID_SINAV
																							WHERE	D.TC_OGRENCI	= T.TC_OGRENCI 
																								AND D.ID_SINAVTURU	= T.ID_SINAVTURU
																								AND D.TC_OGRETMEN	= T.TC_OGRETMEN
																								AND D.DERSAD		= T.DERSAD
																							ORDER BY S.SINAVTARIH DESC, ID_SINAV
																				) AS SD  ON DD.TC_OGRENCI	= T.TC_OGRENCI 
																						AND DD.ID_SINAVTURU	= T.ID_SINAVTURU
																						AND DD.TC_OGRETMEN	= T.TC_OGRETMEN
																						AND DD.DERSAD		= T.DERSAD
																						AND DD.ID_SINAV		= SD.ID_SINAV
																			) 
										ELSE 	AVG(FREKANS) 
									END 
							AS DECIMAL(8,2) ) ,-- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					
								
						[TC_OGRENCI]	    = TC_OGRENCI,		
						[TC_OGRETMEN]	    = TC_OGRETMEN,	
						[ID_SINIF]			= T.ID_SINIF,		
						[ID_SINAVTURU]		= T.ID_SINAVTURU	
				INTO	#v2FrekansOgrenciDetay
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				WHERE 	T.ID_SINIF	= @_ID_SINIF
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND T.DERSAD	= @_DERSAD
					AND FREKANS		IS NOT NULL
					AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
				GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET,T.DERSAD
			
				select(
							select * from(
								select 
								(					
									SELECT		* 
									FROM		#v2FrekansOgrenciDetay
									ORDER BY	[AD SOYAD]
									FOR JSON AUTO
								) as t3
												
							) as tablo FOR JSON AUTO
						) as tt
				DROP TABLE #v2FrekansOgrenciDetay
			END
			IF @_ISLEM = 4	--	ÖĞRENCİ FREKANS SINAV LST	
			BEGIN 

				SELECT	 SUBEAD
						,TAKMAAD
						,ST.AD SINAVTURU
						,CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
							ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
						END SINAVADI
						,CAST(CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (	
															SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
															INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
															WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
															GROUP BY YO.TELAFI
														) 
							ELSE						(	T.FREKANS
														)
						END AS decimal(8,2)) SINAVPUANI
						,K.AD+' '+K.SOYAD ADSOYAD
						,SINIFAD
						,SS 
						,CAST(HBNET AS DECIMAL(8,2)) HBNET
						,ILK_SS HEDEF
						,CAST(NET AS DECIMAL(8,2))	 NET
						,S.SINAVTARIH
						,S.ID_SINAVTURU
				INTO	#OGRENCISINAV
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				LEFT JOIN Sinav			S	ON	S.ID_SINAV		= T.ID_SINAV
				WHERE	TC_OGRENCI		=	@_TC_OGRENCI
					AND TAKMAAD			=	@_DERSAD
					AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
					AND T.FREKANS IS NOT NULL
				GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET,S.SINAVTARIH,S.ID_SINAVTURU


				IF (SELECT COUNT(1) FROM #OGRENCISINAV WHERE ID_SINAVTURU != 6 )>1
				BEGIN
					INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET,SINAVTARIH)
					SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,CAST(AVG(HBNET) AS decimal(8,2)),HEDEF,CAST(AVG(NET) AS DECIMAL(8,2)),GETDATE()
					FROM	#OGRENCISINAV 
					GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HEDEF
				END

				select(
							select * from(
								select 
								(					
									SELECT		[KAMPÜS]		= SUBEAD,
												[SINIF]			= SINIFAD,
												[BRANŞ]			= TAKMAAD,
												[SINAV TÜRÜ]	= SINAVTURU,
												[SINAV]			= SINAVADI,
												[SORU SAYISI]	= SS,
												[H.B. NET ORT.] = HBNET,
												[HEDEFE UZAKLIK]= HEDEF-HBNET,
												[ÖĞR NET]		= NET,
												[PUAN]			= SINAVPUANI,
												[FREKANS]		= SINAVPUANI,
												ADSOYAD
									FROM		#OGRENCISINAV 
									ORDER BY SINAVTARIH
									FOR JSON AUTO
								) as t4
												
							) as tablo FOR JSON AUTO
						) as tt
			
				DROP TABLE IF EXISTS #OGRENCISINAV
			END
			IF @_ISLEM = 5	--	ÖĞRETMEN SINIF GRAFİĞİ		
			BEGIN 
			
					
			

				DECLARE @SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
				IF (0 IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
				BEGIN
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

						SELECT	ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,'FREKANS' SINAVADI
						INTO	#FREKANSOGRETMEN2
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND FREKANS IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND T.DONEM		= @_DONEM
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

						SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO #PIVOT  FROM #FREKANSOGRETMEN2

						INSERT INTO @SINAVLAR (SINAVADI) VALUES ('FREKANS')

						select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#PIVOT 
									FOR JSON AUTO
								) as t5,
								(					
									SELECT	SINAVADI
									FROM	@SINAVLAR
									FOR JSON AUTO
								) as t6
												
							) as tablo FOR JSON AUTO
						) as tt

					
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

				END
				ELSE
				BEGIN
			
						DROP TABLE IF EXISTS #v2FrekansOgretmen
					
						SELECT	ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,CASE 
									WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
									ELSE (SELECT TOP 1 SUBSTRING(K.AD ,1, CHARINDEX('.',K.AD)-1 )+'-'+S.AD FROM Sinav S JOIN v3Kademe3 K ON K.ID_KADEME3 = S.ID_KADEME3 WHERE S.ID_SINAV=T.ID_SINAV) 
								END SINAVADI
						INTO	#v2FrekansOgretmen
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU				ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
						GROUP BY ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

						--TAHSİN--
						INSERT INTO #v2FrekansOgretmen
						SELECT	ID_SINIF,T.ID_SINAVTURU,@ID_STGENEL as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,ST.KISAAD+' ORT' as SINAVADI
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND ST.ID_SINAVTURU NOT IN (5,6) -- AAYKS VEYA YDS DEĞİLSE
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
						--TAHSİN--
					
						DECLARE @cols	AS NVARCHAR(MAX),
								@cols2	AS NVARCHAR(MAX),
								@cols3	AS NVARCHAR(MAX),
								@SQL	AS NVARCHAR(MAX);
												
						--TAHSİN--
						SET @cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
		
						SET @cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SUM DAN DOLAYI SORUN OLABILIR
						SET @cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
						--TAHSİN--

						INSERT INTO @SINAVLAR (SINAVADI)
							SELECT	DISTINCT SINAVADI
							FROM	#v2FrekansOgretmen

						SET @SQL='
					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1


							SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols2 AS varchar(MAX))+' INTO #PVT1 FROM (
								SELECT * FROM #v2FrekansOgretmen
							)AS TABLO
							PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@cols AS varchar(MAX))+')) AS P
					

							SELECT		ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols3 AS varchar(MAX))+'
										INTO		#PVT
										FROM		#PVT1 
										group by ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]
					
							select(
								select * from(
									select 
									(					
										SELECT		*
										FROM		#PVT 
										FOR JSON AUTO
									) as t5,
									(					
										SELECT	DISTINCT SINAVADI
										FROM	#v2FrekansOgretmen
										FOR JSON AUTO
									) as t6
												
								) as tablo FOR JSON AUTO
							) as tt

					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1

						'
					
						print @SQL
						EXECUTE (@SQL)

						--set @SQL='
						--	'

						--			execute (@SQL)
								

				DROP TABLE IF EXISTS #v2FrekansOgretmen
					
				END
			

			
			END
			IF @_ISLEM = 6	--	DERSLER						
			BEGIN 
			
				--	INTO #DERSLER					
				SELECT	D.* 
				INTO	#DERSLER 
				FROM	v3SinavDers D
				INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD

				select(
							select * from(
								select 
								(	

									SELECT	DISTINCT D.AD
									FROM	#DERSLER				D
									JOIN	v2FrekansOgrenciDetay	OD WITH (NOLOCK) 	ON	OD.DERSAD=D.AD
									WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 
										AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@_ID_SINAVTURU)) 
										AND OD.DONEM = @_DONEM
									FOR JSON AUTO
								) as t5
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @_ISLEM = 7	--	SINAV TURU					
			BEGIN 
			
			

				select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
				INTO #GrupSinavTuru 
				from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
			union 
				select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
			--union 
			--	select 0,15 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,16 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,17 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,18 , 'YAZILI', 'YAZ'

					INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
					FROM v3Kademe3	K
					JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
					WHERE ID_KADEME3 IN ( 11,12,13,14)


					--INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					--SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
					--FROM v3Kademe3	K
					--WHERE ID_KADEME3 IN ( 11,12,13,14)

					
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 


				drop table #GrupSinavTuru
			END
			IF @_ISLEM = 8	--	SON FİLTRE GETİR			
			BEGIN
				
				SELECT ISNULL((
					SELECT TOP 1 PARAMETRELER
					FROM [Log]
					WHERE	TCKIMLIKNO	= @_TCKIMLIKNO
						AND ID_MENU		= 1193
						AND ISLEM		= 1
					ORDER BY KYE_TARIH DESC
				),'[]')

			END
				
			BEGIN
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 
				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira
				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira
				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #DERSLER
				DROP TABLE IF EXISTS #ETKI
				DROP TABLE IF EXISTS #SINAVTURU
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity, @STATE = @ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_v2FrekansSistem]    Script Date: 23.11.2021 15:40:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_v2FrekansSistem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,	
	@ID_SUBE			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,		
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	,
	@RAPOR_DONUS_TIP    BIT				= 0,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	DECLARE
	@_ISLEM				INT				= @ISLEM			,
	@_TCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO		,
	@_TC_OGRENCI		VARCHAR(11)		= @TC_OGRENCI		,
	@_TC_OGRETMEN		VARCHAR(11)		= @TC_OGRETMEN		,
	@_OTURUM			VARCHAR(36)		= @OTURUM			,
	@_ID_MENU			INT				= @ID_MENU			,
	@_DONEM				char(4)			= @DONEM			,
	@_ID_KADEMEs		VARCHAR(MAX)	= @ID_KADEMEs		,
	@_ID_KADEME3		VARCHAR(MAX)	= @ID_KADEME3		,
	@_ID_SINAVTURU		VARCHAR(MAX)	= @ID_SINAVTURU		,	
	@_ID_SUBE			VARCHAR(MAX)	= @ID_SUBE			,
	@_ID_SINIF			INT				= @ID_SINIF			,		
	@_DERSLIST			VARCHAR(MAX)	= @DERSLIST			,
	@_DERSAD			VARCHAR(MAX)	= @DERSAD			,
	@_FREKANSKARNE		BIT				= @FREKANSKARNE		,
	@_RAPOR_DONUS_TIP   BIT				= @RAPOR_DONUS_TIP

	DECLARE @_PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @_LOGJSON VARCHAR(MAX)
	SET @_LOGJSON = (
		SELECT	 ISLEM				= @_ISLEM				
				,TCKIMLIKNO			= @_TCKIMLIKNO			
				,TC_OGRENCI			= @_TC_OGRENCI			
				,TC_OGRETMEN		= @_TC_OGRETMEN	
				,OTURUM				= @_OTURUM				
				,ID_MENU			= @_ID_MENU		
				,DONEM				= @_DONEM				
				,ID_KADEMEs			= @_ID_KADEMEs			
				,ID_KADEME3			= @_ID_KADEME3			
				,ID_SINAVTURU		= @_ID_SINAVTURU		
				,ID_SUBE			= @_ID_SUBE		
				,ID_SINIF			= @_ID_SINIF		
				,DERSLIST			= @_DERSLIST		
				,DERSAD				= @_DERSAD			
				,FREKANSKARNE		= @_FREKANSKARNE		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
	
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @_OTURUM, @TCKIMLIKNO = @_TCKIMLIKNO, @ID_MENU = @_ID_MENU, @LOGJSON = @_LOGJSON, @ISLEM = @_ISLEM, @PROSEDURADI = @_PROCNAME,@IP = @IP
		
		IF @_ID_LOG > 0
		BEGIN
			
			DECLARE @_ID_STGENEL INT=999999

			IF @_DONEM='' OR @_DONEM IS NULL			
				SET @_DONEM= (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)			

				
			SELECT DISTINCT ID_SUBE INTO #SUBELER FROM v3SubeYetki WHERE TCKIMLIKNO = @_TCKIMLIKNO AND ID_KULLANICITIPI NOT IN (4,5)

			IF @_ISLEM NOT IN (6,7,8)
			BEGIN
				--	INTO #SINAVTURU
				--DECLARE @_SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				--INSERT INTO @_SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				--INSERT INTO @_SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
				--SELECT * INTO #SINAVTURU FROM @_SINAVTURU

				SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 AS SIRA INTO #SINAVTURU FROM SinavTuru
				SET IDENTITY_INSERT #SINAVTURU ON
				-- 2,3,4,5
					
				
					select	 F.ID_FREKANSOGRENCIDETAY
							,F.DERSAD
							,F.SUBEAD
							,F.OGRETMENADSOYAD
							,F.TC_OGRETMEN
							,F.ID_SUBE
							,F.ID_SINAVTURU
							,F.FREKANS
							,F.HBNET
							,F.ILK_SS
							,F.ID_KADEME3
							,F.TC_OGRENCI
							,F.ID_SINIF
							,F.TAKMAAD
							,F.SINIFAD
							,F.NET
							,F.ID_SINAV
							,F.ILK_NET
							,F.SS
							,F.DONEM
							,F.ID_DERS
							,kb.ID_KADEME 
				into #v2FrekansOgrenciDetayDonem 
				from v2FrekansOgrenciDetay			F
				join OkyanusDB.dbo.v3KademeBilgi	kb	on	kb.ID_KADEME3	= F.ID_KADEME3
				where	DONEM = @_DONEM 
					AND (TC_OGRETMEN IS NOT NULL AND TC_OGRETMEN <> '')
				-- 1,2,3,4,5,6
			END
		
			
			IF @_ISLEM IN (1,2)
			BEGIN
				
				DECLARE @ID_FREKANSSORGU	 INT = NULL
				DECLARE @ID_FREKANSSORGUDERS INT = NULL
					
				SET @ID_FREKANSSORGU	= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND DERSLIST		IS NULL
										)				
				IF @ID_FREKANSSORGU IS NULL		
				BEGIN
					DECLARE @TABLEADD TABLE (ID INT)

					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT inserted.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, NULL)

					SET @ID_FREKANSSORGU = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY
					FROM v2FrekansOgrenciDetay WITH(NOLOCK) 
					WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) )--OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	))
						AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) )--OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	))
						AND DONEM = @_DONEM
					ORDER BY FREKANS

				END

				SET @ID_FREKANSSORGUDERS= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND (DERSLIST		= @_DERSLIST  OR (@_DERSLIST IS NULL AND DERSLIST IS NULL) )
										)
				IF @ID_FREKANSSORGUDERS IS NULL	
				BEGIN
					DELETE FROM @TABLEADD 
					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT INSERTED.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, @_DERSLIST)

					SET @ID_FREKANSSORGUDERS = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGUDERS , S.ID_FREKANSOGRENCIDETAY
					FROM v2FrekansSorguDetay	S
					JOIN v2FrekansOgrenciDetay	T WITH(NOLOCK) 	ON	T.ID_FREKANSOGRENCIDETAY = S.ID_FREKANSOGRENCIDETAY
					WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
						AND S.ID_FREKANSSORGU	= @ID_FREKANSSORGU
						AND DONEM				= @_DONEM
					ORDER BY FREKANS

				END

			END

			
			IF @_ISLEM = 1	--	İLK LİSTE (FR SİSTEM)		
			BEGIN 
		
				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 
						 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
				INTO #Filtre 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER						S	ON	S.ID_SUBE				= T.ID_SUBE
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
				INTO #FiltreFrekans FROM #Filtre	O
				INNER JOIN #v2FrekansOgrenciDetayDonem	D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
				ORDER BY O.OGRETMENADSOYAD


				-- Öğretmen Genel
				SELECT TC_OGRETMEN, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, DERSAD

				DECLARE @_GENELADET INT = (SELECT COUNT(TC_OGRETMEN) FROM #GenelFrekans)

				SELECT *, SN = ROW_NUMBER() OVER (/*PARTITION BY DERSAD*/  ORDER BY FREKANS DESC)
				INTO #GenelSira FROM #GenelFrekans
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Zümre Genel
				SELECT TC_OGRETMEN, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, DERSAD


				SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans G WHERE G.DERSAD = F.DERSAD)
				INTO #GenelZumreSira FROM #GenelZumreFrekans	F
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
				INTO #GenelKampusSira FROM #GenelKampusFrekans	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Zümre Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreKampusFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD), SUBEAD = S.AD
				INTO #GenelZumreKampusSira FROM #GenelZumreKampusFrekans	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------


				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
				INTO #OgrenciSinifListe 
				FROM #Filtre					O
				INNER JOIN #v2FrekansOgrenciDetayDonem	D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

				-- Liste
				SELECT   [SIRA]				= F.FREKANS--ISNULL(G.SN,@_ID_STGENEL) --CASE WHEN @_DERSAD = 'Tümü' THEN ISNULL(G.SN,@_ID_STGENEL) ELSE (SELECT MIN(SN) FROM #GenelZumreSira K WHERE K.TC_OGRETMEN=F.TC_OGRETMEN AND K.DERSAD=@_DERSAD )   END
						,[BRANŞ]			= F.DERSAD 
						,[KAMPÜS]			= ISNULL( (SELECT STUFF((SELECT   '<br>' +CAST(K.SUBEAD AS VARCHAR)	FROM #GenelKampusSira K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[ÖĞRETMEN]			= F.OGRETMENADSOYAD 
						,[SORU SAYISI]		= SORUSAYISI
						,[HB NET]			= F.HBNET
						,[TC_OGRETMEN]		= F.TC_OGRETMEN
						,[FREKANS]			= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')
						,[SINIF SAYISI]		= O.SINIFSAY
						,[ÖĞRENCİ SAYISI]	= O.OGRSAY
						,[KAMPÜS ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN  AND K.DERSAD = tt.DERSAD )>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira	K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[KAMPÜS GENEL]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND K.DERSAD = tt.DERSAD )>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET AS VARCHAR),'-')
					
				INTO		#T
				FROM		#FiltreFrekans		F
				INNER JOIN #OgrenciSinifListe	O ON O.TC_OGRETMEN = F.TC_OGRETMEN AND O.DERSAD = F.DERSAD
				LEFT  JOIN #GenelSira			G ON G.TC_OGRETMEN = F.TC_OGRETMEN AND G.DERSAD = F.DERSAD

				IF @RAPOR_DONUS_TIP=0
				BEGIN 
				select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#T 
									--ORDER BY [GENEL]--[ÖĞRETMEN]	,[GENEL]
									order by SIRA DESC
									FOR JSON AUTO
								) as t												
							) as tablo FOR JSON AUTO
						) as tt
				END
				ELSE
				BEGIN
				SELECT		*
									FROM		#T 
									--ORDER BY [GENEL]--[ÖĞRETMEN]	,[GENEL]
									order by SIRA DESC
				END
		
				
					
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

		


			END
			IF @_ISLEM = 2	--	GENEL SIRALAMA				
			BEGIN 

				SELECT	 [SINAV TÜRÜ]	= SINAVTURU
						,STKISAAD
						,[BRANŞ]		= BRANS
						,TC_OGRETMEN
						,FREKANS
						,[FREKANS KATKI]= FREKANSKATKI
						,[KAMPÜS KADEME ZÜMRE] = KAMPUSKADEMEZUMRE
						,[KAMPÜS ZÜMRE] = KAMPUSZUMRE
						,[KAMPÜS GENEL]	= KAMPUSGENEL
						,[KADEME ZÜMRE] = KADEMEZUMRE
						,[GENEL ZÜMRE]	= GENELZUMRE
						,GENEL
						,ID_SINAVTURU 
				INTO	#T1
				FROM	v2FrekansOgretmen
				WHERE	TC_OGRETMEN	= @_TC_OGRETMEN
					AND DONEM = @_DONEM
				


				-- frekans karne değil ise  veya (ders,sinav türü,sınıf)tümü seçilmemişse Frekansogretmendeki gösterecek
				IF (@_FREKANSKARNE=0 
					OR (	@_DERSAD <>	'Tümü' 					 
						AND -1	NOT IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) 
						AND 0	NOT IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) 					
						)
					)
				BEGIN
		
					SELECT	 ID_SINAVTURU
							,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
					INTO #GenelFiltre2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
						AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
						AND DONEM = @_DONEM
					GROUP BY ID_SINAVTURU


					SELECT	 
								DERSAD
							,SUBEAD
							,OGRETMENADSOYAD
							,TC_OGRETMEN
							,T.ID_SUBE
							,ID_SINAVTURU
							,ID_KADEME3
					INTO #Filtre2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					JOIN #SUBELER						S	ON	S.ID_SUBE	= T.ID_SUBE
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
						AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
						AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
						AND TC_OGRETMEN	= @_TC_OGRETMEN
						AND DONEM = @_DONEM
					GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			
					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					INTO #FiltreFrekans2 FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
				UNION ALL			
					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
				ORDER BY O.OGRETMENADSOYAD



				-- Frekans Katkı İçin
					SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					INTO #GenelFrekansKatki 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
						AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
					GROUP BY TC_OGRETMEN, ID_SINAVTURU, DERSAD
				UNION ALL				
					SELECT TC_OGRETMEN, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					FROM #v2FrekansOgrenciDetayDonem	T
					WHERE  (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 						
					GROUP BY TC_OGRETMEN, DERSAD

					-- Öğretmen Genel
					SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SINAVTURU
				UNION ALL				
					SELECT TC_OGRETMEN, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM #v2FrekansOgrenciDetayDonem	T			
					GROUP BY TC_OGRETMEN

					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
					INTO #GenelSira2 FROM #GenelFrekans2 T
					WHERE FREKANS IS NOT NULL
				
					--------------------------------------------------------------------

					-- Öğretmen Zümre Genel
					SELECT TC_OGRETMEN, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, DERSAD, ID_SINAVTURU
				UNION ALL			
					SELECT TC_OGRETMEN, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, DERSAD


					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
					INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
					WHERE FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Kampus Genel
					SELECT TC_OGRETMEN, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelKampusFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE, ID_SINAVTURU
				UNION ALL
					SELECT TC_OGRETMEN, ID_SUBE, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE


					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Zümre Kampus Genel
					SELECT TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreKampusFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU
				UNION ALL
					SELECT TC_OGRETMEN, ID_SUBE, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------


					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
					INTO #OgrenciSinifListe2 
					FROM #Filtre2				O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
													AND D.DERSAD = O.DERSAD 
													AND D.ID_SUBE = O.ID_SUBE 
													AND D.ID_SINAVTURU = O.ID_SINAVTURU 
													AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
				UNION ALL 			
					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @_ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
					FROM #Filtre2				O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
													AND D.DERSAD = O.DERSAD 
													AND D.ID_SUBE = O.ID_SUBE 
													AND D.ID_SINAVTURU = O.ID_SINAVTURU 
													AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

			
					INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@_ID_STGENEL,'GENEL','GNL',1,2)

					-- Liste
					DELETE FROM #T1


					SELECT ID_SINAVTURU
						,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
						,MAX(GF.FREKANS) MAXIMUM
						,MIN(GF.FREKANS) MINIMUM 
						--,MINIMUM	= IIF(MIN(GF.FREKANS) < 0, 0 , MIN(GF.FREKANS) )
						, DERSAD
					INTO #ARALIK 
					FROM #GenelFrekansKatki	GF
					GROUP BY ID_SINAVTURU, DERSAD

					--INSERT INTO #ARALIK
					--SELECT 
					--	 @_ID_STGENEL
					--	,(MAX(GF.FREKANS)-MIN(GF.FREKANS))/5 ARALIK
					--	,MAX(GF.FREKANS) MAXIMUM
					--	,MIN(GF.FREKANS) MINIMUM 
					--FROM #GenelFiltre2	GF


					SELECT ID_SINAVTURU
						,KADEME1 = MINIMUM + ARALIK
						,KADEME2 = MINIMUM + (ARALIK*2)
						,KADEME3 = MINIMUM + (ARALIK*3)
						,KADEME4 = MINIMUM + (ARALIK*4)
						, DERSAD
					INTO #ETKI
					FROM #ARALIK
				

					INSERT INTO #T1 (
					 [SINAV TÜRÜ]	
					,STKISAAD
					,[BRANŞ]		
					,TC_OGRETMEN
					,FREKANS
					,[FREKANS KATKI]
					,[KAMPÜS ZÜMRE] 
					,[KAMPÜS GENEL]	
					,[GENEL ZÜMRE]	
					,GENEL
					,ID_SINAVTURU 
					)
					SELECT 
						 [SINAV TÜRÜ]		= S.AD 
						,[STKISAAD]			= S.KISAAD
						,[BRANŞ]			= F.DERSAD
						,[TC_OGRETMEN]		= F.TC_OGRETMEN
						,[FREKANS]			= ISNULL( MAX(F.FREKANS) ,0)
						--,[FREKANS KATKI]	= CASE 
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>75	THEN	'ÇOK ETKİLİ'
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>50	THEN	'ETKİLİ'
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>25	THEN	'NORMAL ETKİLİ'
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>-1	THEN	'AZ ETKİLİ'
						--						ELSE 'ETKİSİZ'
						--					END

						,[FREKANS KATKI]	= --CASE WHEN AVG(F.FREKANS) < 0 THEN 'NEGATİF EKTİ'
												--ELSE 
													CASE
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME1 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİSİZ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME2 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'AZ ETKİLİ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME3 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'NORMAL'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİLİ'
														WHEN AVG(F.FREKANS) >= (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ÇOK ETKİLİ'
														ELSE '---'
													END
												--END
						,[KAMPÜS ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira2	tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira2	K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU  AND K.DERSAD = F.DERSAD ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[KAMPÜS GENEL]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2			tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU							)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU							 ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')					
						,[GENEL ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2			tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU AND K.DERSAD = F.DERSAD						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR)
						--,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET2 AS VARCHAR)
						--,[GENEL]			= CASE WHEN G.ID_SINAVTURU=@_ID_STGENEL THEN CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET3 AS VARCHAR) ELSE CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET2 AS VARCHAR) END 
							,F.ID_SINAVTURU
					--INTO	#T1
					FROM #FiltreFrekans2				F
					INNER JOIN #OgrenciSinifListe2	O ON O.TC_OGRETMEN	= F.TC_OGRETMEN		AND O.ID_SINAVTURU = F.ID_SINAVTURU		AND O.DERSAD = F.DERSAD		
					INNER JOIN #SINAVTURU			S ON S.ID_SINAVTURU = F.ID_SINAVTURU
					LEFT  JOIN #GenelSira2			G ON G.TC_OGRETMEN	= F.TC_OGRETMEN		AND G.ID_SINAVTURU = S.ID_SINAVTURU
					GROUP BY S.AD, F.TC_OGRETMEN, F.ID_SINAVTURU, F.DERSAD, G.SN,S.KISAAD

		

				END


				-------------------------------------------------	(2.2)	2. SAYFA ALT


				print 11
				SELECT	 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,MAX(T.SS) SORUSAYISI
						,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
						--,CAST(AVG(FREKANS) AS decimal(8,2)) FREKANS --coalesce(some_column, 0)
						,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
						,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
						,TC_OGRETMEN
						,ID_DERS
						,T.ID_SUBE
						,T.ID_SINAVTURU
						,ID_SINIF
						,SINIFAD
						,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
						,AVG(ILK_SS) ILK_SS
				INTO	#ORTALAMA3
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER						S	ON	S.ID_SUBE	= T.ID_SUBE
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU								
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
					AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND DONEM		= @_DONEM
					
				GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD
			
				SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
						,[BRANŞ]		= DERSAD
						,[SINAV TÜRÜ]	= ST.AD
						,[KAMPÜS]		= SUBEAD
						,[SINIF]		= ORT.SINIFAD	
						,[H.B. NET ORT.]= ORT.HBNET	
						,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
						,ORT.FREKANS		
						,ID_SINIF
						,TC_OGRETMEN
						,SIRA
						,ORT.ID_SINAVTURU
				INTO	#T2
				FROM	#ORTALAMA3	ORT
				JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
										AND ST.SIRA			<> 2
				WHERE	ORT.FREKANS IS NOT NULL
				ORDER BY ST.SIRA


				select(
							select * from(
								select 
								(						 
									SELECT * FROM #T1
									ORDER BY BRANŞ,ID_SINAVTURU
									FOR JSON AUTO
								) as t1
								,( 
									SELECT * FROM #T2
									ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
									FOR JSON AUTO
								)as t2							
							) as tablo FOR JSON AUTO
						) as tt


					
					
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
					DROP TABLE #T1
					DROP TABLE #Filtre2
					DROP TABLE #GenelFiltre2
					DROP TABLE #FiltreFrekans2
					DROP TABLE #OgrenciSinifListe2 

					DROP TABLE #GenelFrekans2
					DROP TABLE #GenelSira2

					DROP TABLE #GenelZumreFrekans2
					DROP TABLE #GenelZumreSira2

					DROP TABLE #GenelKampusFrekans2
					DROP TABLE #GenelKampusSira2

					DROP TABLE #GenelZumreKampusFrekans2
					DROP TABLE #GenelZumreKampusSira2

				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

				DROP TABLE IF EXISTS #GenelFrekansKatki


			END	
			IF @_ISLEM = 3	--	SINIF ÖĞRENCİ LİSTESİ		
			BEGIN 

				SELECT	[KAMPÜS]	= SUBEAD,
						[SINIF]		= SINIFAD,
						[BRANŞ]		= TAKMAAD,
						[SINAV TÜRÜ]= ST.AD,
						[AD SOYAD]	= K.AD+' '+K.SOYAD,
						[SORU SAYISI]=MAX(T.ILK_SS),
						[H.B NET]	= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
						[NET ORT]	= CAST(AVG(T.NET) AS DECIMAL(8,2)),
						[HEDEFE UZAKLIK]= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),
						--[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
						[FREKANS]	= CAST(		CASE
										WHEN T.ID_SINAVTURU = 0		  THEN AVG(NET) 
										WHEN T.ID_SINAVTURU IN (5,6)  THEN (	SELECT TOP 1 FREKANS 
																				FROM #v2FrekansOgrenciDetayDonem DD
																				JOIN (SELECT TOP 1 S.ID_SINAV
																							FROM #v2FrekansOgrenciDetayDonem D 
																							JOIN Sinav						 S	ON	S.ID_SINAV	= D.ID_SINAV
																							WHERE	D.TC_OGRENCI	= T.TC_OGRENCI 
																								AND D.ID_SINAVTURU	= T.ID_SINAVTURU
																								AND D.TC_OGRETMEN	= T.TC_OGRETMEN
																								AND D.DERSAD		= T.DERSAD
																							ORDER BY S.SINAVTARIH DESC, ID_SINAV
																				) AS SD  ON DD.TC_OGRENCI	= T.TC_OGRENCI 
																						AND DD.ID_SINAVTURU	= T.ID_SINAVTURU
																						AND DD.TC_OGRETMEN	= T.TC_OGRETMEN
																						AND DD.DERSAD		= T.DERSAD
																						AND DD.ID_SINAV		= SD.ID_SINAV
																			) 
										ELSE 	AVG(FREKANS) 
									END 
							AS DECIMAL(8,2) ) ,-- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					
					
						[TC_OGRENCI]	    = TC_OGRENCI,		
						[TC_OGRETMEN]	    = TC_OGRETMEN,	
						[ID_SINIF]			= T.ID_SINIF,		
						[ID_SINAVTURU]		= T.ID_SINAVTURU	
				INTO	#v2FrekansOgrenciDetay
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				WHERE 	T.ID_SINIF	= @_ID_SINIF
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND T.DERSAD	= @_DERSAD
					AND FREKANS		IS NOT NULL
					AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
				GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET,T.DERSAD
			
				select(
							select * from(
								select 
								(					
									SELECT		* 
									FROM		#v2FrekansOgrenciDetay
									ORDER BY	[AD SOYAD]
									FOR JSON AUTO
								) as t3
												
							) as tablo FOR JSON AUTO
						) as tt
				DROP TABLE #v2FrekansOgrenciDetay
			END
			IF @_ISLEM = 4	--	ÖĞRENCİ FREKANS SINAV LST	
			BEGIN 

				SELECT	 SUBEAD
						,TAKMAAD
						,ST.AD SINAVTURU
						,CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
							ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
						END SINAVADI
						,CAST(CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (	SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
															INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
															WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
															GROUP BY YO.TELAFI	) 
							ELSE						(	T.FREKANS			)
						END AS decimal(8,2)) SINAVPUANI
						,K.AD+' '+K.SOYAD ADSOYAD
						,SINIFAD
						,SS 
						,CAST(HBNET AS DECIMAL(8,2)) HBNET
						,ILK_SS HEDEF
						,CAST(NET AS DECIMAL(8,2)) NET
						,S.SINAVTARIH
						,S.ID_SINAVTURU
				INTO	#OGRENCISINAV
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				LEFT JOIN Sinav			S	ON	S.ID_SINAV		= T.ID_SINAV
				WHERE	TC_OGRENCI		=	@_TC_OGRENCI
					AND TAKMAAD			=	@_DERSAD
					AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
					AND T.FREKANS IS NOT NULL
				GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET,S.SINAVTARIH,S.ID_SINAVTURU


				IF (SELECT COUNT(1) FROM #OGRENCISINAV WHERE ID_SINAVTURU != 6 )>1
				BEGIN
					INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET,SINAVTARIH)
					SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,CAST(AVG(HBNET) AS decimal(8,2)),HEDEF,CAST(AVG(NET) AS DECIMAL(8,2)),GETDATE()
					FROM	#OGRENCISINAV 
					GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HEDEF
				END

				select(
							select * from(
								select 
								(					
									SELECT		[KAMPÜS]		= SUBEAD,
												[SINIF]			= SINIFAD,
												[BRANŞ]			= TAKMAAD,
												[SINAV TÜRÜ]	= SINAVTURU,
												[SINAV]			= SINAVADI,
												[SORU SAYISI]	= SS,
												[H.B. NET ORT.] = HBNET,
												[HEDEFE UZAKLIK]= HEDEF-HBNET,
												[ÖĞR NET]		= NET,
												[PUAN]			= SINAVPUANI,
												[FREKANS]		= SINAVPUANI,
												ADSOYAD
									FROM		#OGRENCISINAV 
									ORDER BY SINAVTARIH
									FOR JSON AUTO
								) as t4
												
							) as tablo FOR JSON AUTO
						) as tt
			
				DROP TABLE IF EXISTS #OGRENCISINAV
			END
			IF @_ISLEM = 5	--	ÖĞRETMEN SINIF GRAFİĞİ		
			BEGIN 
			
					
			

				DECLARE @_SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
				IF (0 IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
				BEGIN
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

						SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,'FREKANS' SINAVADI
						INTO	#FREKANSOGRETMEN2
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	TC_OGRETMEN	= @_TC_OGRETMEN --'56377383260'
							AND FREKANS IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND T.DONEM		= @_DONEM
						GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

						SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO #PIVOT  FROM #FREKANSOGRETMEN2

						INSERT INTO @_SINAVLAR (SINAVADI) VALUES ('FREKANS')

						select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#PIVOT 
									FOR JSON AUTO
								) as t5,
								(					
									SELECT	SINAVADI
									FROM	@_SINAVLAR
									FOR JSON AUTO
								) as t6
												
							) as tablo FOR JSON AUTO
						) as tt

					
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

				END
				ELSE
				BEGIN
			
						DROP TABLE IF EXISTS #v2FrekansOgretmen


						SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,CASE 
									WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
									ELSE (SELECT TOP 1 SUBSTRING(K.AD ,1, CHARINDEX('.',K.AD)-1 )+'-'+S.AD FROM Sinav S JOIN v3Kademe3 K ON K.ID_KADEME3 = S.ID_KADEME3 WHERE S.ID_SINAV=T.ID_SINAV) 
									--ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 								
								END SINAVADI
						INTO	#v2FrekansOgretmen
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU				ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	TC_OGRETMEN	= @_TC_OGRETMEN --'56377383260'
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
						GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

						--TAHSİN--
						INSERT INTO #v2FrekansOgretmen
						SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,999999999 as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,ST.KISAAD+' ORT' as SINAVADI
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	TC_OGRETMEN	= @_TC_OGRETMEN --'56377383260'
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND ST.ID_SINAVTURU NOT IN (5,6) -- AAYKS VEYA YDS DEĞİLSE
						GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
						--TAHSİN--
					
						DECLARE @_cols	AS NVARCHAR(MAX),
								@_cols2	AS NVARCHAR(MAX),
								@_cols3	AS NVARCHAR(MAX),
								@_SQL	AS NVARCHAR(MAX);

						--SET @_cols = STUFF((SELECT distinct ',' + QUOTENAME(c.SINAVADI) 
						--			FROM #v2FrekansOgretmen c
						--			FOR XML PATH(''), TYPE
						--			).value('.', 'NVARCHAR(MAX)') 
						--		,1,1,'')

						--SET @_cols2 = STUFF((SELECT distinct ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						----',' + QUOTENAME(c.SINAVADI) 
						--			FROM #v2FrekansOgretmen c
						--			FOR XML PATH(''), TYPE
						--			).value('.', 'NVARCHAR(MAX)') 
						--		,1,1,'')

						--		--SUM DAN DOLAYI SORUN OLABILIR
						--SET @_cols3 = STUFF((SELECT distinct ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						----',' + QUOTENAME(c.SINAVADI) 
						--			FROM #v2FrekansOgretmen c
						--			FOR XML PATH(''), TYPE
						--			).value('.', 'NVARCHAR(MAX)') 
						--		,1,1,'')

						--TAHSİN--
						SET @_cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
		
						SET @_cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SUM DAN DOLAYI SORUN OLABILIR
						SET @_cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
						--TAHSİN--

						INSERT INTO @_SINAVLAR (SINAVADI)
							SELECT	DISTINCT SINAVADI
							FROM	#v2FrekansOgretmen

						SET @_SQL='
					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1


							SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols2 AS varchar(MAX))+' INTO #PVT1 FROM (
								SELECT * FROM #v2FrekansOgretmen
							)AS TABLO
							PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@_cols AS varchar(MAX))+')) AS P
					

							SELECT		TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols3 AS varchar(MAX))+'
										INTO		#PVT
										FROM		#PVT1 
										group by TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]
					
							select(
								select * from(
									select 
									(					
										SELECT		*
										FROM		#PVT 
										FOR JSON AUTO
									) as t5,
									(					
										SELECT	DISTINCT SINAVADI
										FROM	#v2FrekansOgretmen
										FOR JSON AUTO
									) as t6
												
								) as tablo FOR JSON AUTO
							) as tt

					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1

						'
					
						print @_SQL
						EXECUTE (@_SQL)

						--set @_SQL='
						--	'

						--			execute (@_SQL)
								

				DROP TABLE IF EXISTS #v2FrekansOgretmen
					
				END
			

			
			END
			IF @_ISLEM = 6	--	DERSLER						
			BEGIN 
			
				--	INTO #DERSLER
				SELECT	D.* 
				INTO	#DERSLER 
				FROM	v3SinavDers D
				INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD

				select(
							select * from(
								select 
								(	

									SELECT	DISTINCT D.AD
									FROM	#DERSLER			D
									JOIN	v2FrekansOgrenciDetay OD	ON	OD.DERSAD=D.AD
									WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 
										AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@_ID_SINAVTURU)) 
										AND OD.DONEM = @_DONEM

									FOR JSON AUTO
								) as t5
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @_ISLEM = 7	--	SINAV TURU					
			BEGIN 
			
			

				select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
				INTO #GrupSinavTuru 
				from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
			union 
				select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
			--union 
			--	select 0,15 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,16 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,17 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,18 , 'YAZILI', 'YAZ'

					INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
					FROM v3Kademe3	K
					JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
					WHERE ID_KADEME3 IN ( 11,12,13,14)


					--INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					--SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
					--FROM v3Kademe3	K
					--WHERE ID_KADEME3 IN ( 11,12,13,14)

					
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 


				drop table #GrupSinavTuru
			END		
			IF @_ISLEM = 8	--	SON FİLTRE GETİR			
			BEGIN 


				SELECT ISNULL((
					SELECT TOP 1 PARAMETRELER
					FROM [Log]
					WHERE	TCKIMLIKNO	= @_TCKIMLIKNO
						AND ID_MENU		= 1099
						AND ISLEM		= 1
					ORDER BY KYE_TARIH DESC
				),'[]')
			END
		
			DROP TABLE IF EXISTS #DERSLER
			DROP TABLE IF EXISTS #SINAVTURU
			DROP TABLE IF EXISTS #ARALIK
			DROP TABLE IF EXISTS #ETKI
			DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem

		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_v2FrekansSistemEksikKazanim]    Script Date: 23.11.2021 15:40:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_v2FrekansSistemEksikKazanim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMKOD			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@EOKUL				INT				=	0,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMKOD					= @DONEMKOD		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON					= @SQLJSON		
			,EOKUL						= @EOKUL			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--select* from OkyanusDB.dbo.v3Kullanici where TCKIMLIKNO= '27296533692'
--	exec sp_FrekansSistemEksikKazanim @ID_MENU=1,@ISLEM=2,@DERSAD='Geometri',@DONEM='2017',@ID_SUBE=309,@ID_KADEME3='[0,15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='27296533692',@TC_OGRENCI='10987583618',@TCKIMLIKNO='27296533692',@OTURUM='E888F3FF-7DC1-4743-B683-4CE6141E16DC',@ID_SINIF=101525

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
	

	IF @DONEM = '' OR @DONEM IS NULL	
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
 
 	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1 or @EOKUL=1
	BEGIN
		drop table if exists #temp4T
		drop table if exists #TEMPORTT
		drop table if exists #t1
		drop table if exists #t3
		drop table if exists #temp
		drop table if exists #temp3
		drop table if exists #temp4
		drop table if exists #TEMPORT
		drop table if exists #TEMPORTS
		drop table if exists #tempY2
		drop table if exists #ttemp
		drop table if exists #ttemp3
		drop table if exists #TTEMPORTS
	
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		--OGRENCI 
		IF @ISLEM = 1
		BEGIN
		--Declare @UNITEDONEMKOD varchar(4)=(select DONEM from OKYANUSDB.DBO.v3AktifDonem WHERE AKTIF=1)
			IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY

				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.AD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempsY
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND YO.TCKIMLIKNO = @TC_OGRENCI AND Y.DONEM = @DONEM AND D.AD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.AD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempY
					  from #tempsY t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempY2
					  from #tempsY t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTY
						from #tempY
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempY2
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivots
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTY WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2
						 from ##pivots p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY
			END
			ELSE	-- SINAVLAR
			BEGIN
			
					SELECT
						 S.ID_SINAV AS ID_SINAVBILGI
						,S.AD AS ACIKLAMA
						,SD.TAKMAAD AS DERSAD
						,SUBSTRING(SA.KOD,1,9) AS KONUKODU
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU						
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)) AS KAZANIM
						,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
						,SUM(1) AS KONUSAYISI
						,D.ID_DERS
						,S.SINAVTARIH
					INTO #temp
					FROM	   [Pusulam].dbo.Sinav					S	 WITH (NOLOCK) 
					INNER JOIN [Pusulam].dbo.SinavOgrenci			SO	 WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
					--INNER JOIN OkyanusDB.dbo.v3OgrenciTum			O	 WITH (NOLOCK) ON O.TCKIMLIKNO=SO.TCKIMLIKNO
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB WITH (NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevap		SOC  WITH (NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
					INNER JOIN [Pusulam].dbo.SinavKitapcik			SK	 WITH (NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
					INNER JOIN [Pusulam].dbo.SinavDers				SD   WITH (NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
					INNER JOIN OkyanusDB.dbo.v3SinavDers			D    WITH (NOLOCK) ON D.ID_DERS=SD.ID_DERS
					INNER JOIN [Pusulam].dbo.SinavAnahtar			SA   WITH (NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
					--INNER JOIN OkyanusDB.dbo.v3Kademe3				K3   WITH (NOLOCK) ON K3.IDNNN_KADEME3=S.ID_KADEME3
					WHERE		S.FREKANSHESAPLA=1
							AND S.AKTIF=1
							AND S.DURUM=2
							--AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
							--AND (O.ID_SINIF=@ID_SINIF)
							AND S.DONEM = @DONEM
							AND (D.AD=@DERSAD)
							AND SO.TCKIMLIKNO = @TC_OGRENCI							
							AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
					GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD, SOC.DURUM,D.ID_DERS,SINAVTARIH
					ORDER BY S.ID_SINAV,SA.KOD

				  Select t2.ID_SINAVBILGI,  
						 t2.ACIKLAMA,
						 t2.ID_DERS,
						 t2.DERSAD,
						 t2.KONUKODU,
						 t2.UNITE,
						 t2.KONU,
						 t2.KONUSAYISI,
						 t2.DOGRUSAYISI,SINAVTARIH,
						(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
					into #temp3
					from #temp t2
				order by t2.ID_SINAVBILGI,t2.KONUKODU

				  Select KONUKODU,
						 ID_DERS,
						 SUM(KONUSAYISI) as KONUSAYISI,
						 SUM(DOGRUSAYISI) as DOGRUSAYISI
					into #TEMPORTS
					from #temp3 
				group by KONUKODU,ID_DERS

				  Select KONUKODU,
						 ID_DERS,
						 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
					into #TEMPORT
					from #TEMPORTS 

					
select KONUKODU,ID_SINAVBILGI,sum(KONUSAYISI) KONUSAYISI, sum(DOGRUSAYISI) DOGRUSAYISI,(Convert(decimal(6,2),(Convert(decimal(7,2),sum(DOGRUSAYISI))/convert(decimal(7,2),sum(KONUSAYISI)))*100))  as YUZDE into #k  from #temp group by KONUKODU,ID_SINAVBILGI

	  
				  Select t3.ID_SINAVBILGI,  
						 t3.ACIKLAMA,
						 t3.ID_DERS,
						 t3.DERSAD,
						 t3.KONUKODU,
						 t3.UNITE,
						 t3.KONU,
						 t3.KONUSAYISI,SINAVTARIH,
						 '('+Cast(k.KONUSAYISI as varchar)+') / '+Cast(k.YUZDE as varchar)+' %' as YUZDE
					into #temp4
					from #temp3 t3
					join #k		k	on k.ID_SINAVBILGI=t3.ID_SINAVBILGI and k.KONUKODU=t3.KONUKODU
				order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

				   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
				  from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI	
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI

				  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA+' (S.S.) / %')
					from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI
		   



		   DROP TABLE IF EXISTS ##pivot
				  Set @SQL='
						  with PivotData as
						  (
							Select 
							 ACIKLAMA,
							 ID_DERS,
							 DERSAD,
							 KONUKODU,
							 UNITE,
							 KONU,
							 YUZDE
							from #temp4
						  )

						  Select 
						   ID_DERS,
						   DERSAD,
						   KONUKODU,
						   ISNULL(UNITE,''-'') UNITE,
						   ISNULL(KONU,''-'') KONU,
						   '+@Columns2+'
						   into ##pivot
						   from PivotData
						   PIVOT
						   (
							MAX(YUZDE)
							FOR ACIKLAMA
							IN('+@Columns+')
						   ) as PivotResult
						   ORDER BY DERSAD,KONUKODU,UNITE
				   '
				   PRINT @SQL
				   PRINT '11'
				   EXEC (@SQL)
				   
--	exec sp_FrekansSistemEksikKazanim @ISLEM=1,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[6]',@TC_OGRETMEN='41318131710',@TC_OGRENCI='13882709862',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'

				   Select (Select Count(DERSAD) from ##pivot pp where pp.DERSAD=p.DERSAD) DERSADET,
						  p.*,
						  '('+Cast((SELECT SUM(KONUSAYISI) FROM #temp3 WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU) as varchar)+') / '+
						  Cast(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORT WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU)) as varchar)
						  +' %' 
						  as 'KAZANIM YÜZDE (T.S.S) / %'
					INTO #t1
					 from ##pivot p


					 select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t1 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
		   END
		END
	
		-- SINIF 
		IF @ISLEM = 2
		BEGIN
		IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT

				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.AD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempOgrtYazili
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OKYANUSDB.DBO.V3DONEM DN ON DN.ID_DONEM = O.ID_DONEM AND DN.KOD = Y.DONEM
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND O.ID_SINIF = @ID_SINIF AND Y.DONEM = @DONEM AND D.AD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.AD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempYO
					  from #tempOgrtYazili t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempPivot
					  from #tempOgrtYazili t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTYOGRT
						from #tempYO
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempPivot
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivotOgrtY
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTYOGRT WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2Y
						 from ##pivotOgrtY p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2Y 
										FOR JSON AUTO
									) as t3											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT


			END
		ELSE	-- SINAVLAR
			BEGIN
				SELECT
					 S.ID_SINAV AS ID_SINAVBILGI
					,S.SINAVTARIH
					,S.AD AS ACIKLAMA
					,SD.TAKMAAD AS DERSAD
					--,SUBSTRING(SA.KOD,1,9) AS KONUKODU				
					,SA.KOD AS KONUKODU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)),'-') AS UNITE
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)),'-') AS KONU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)),'-') AS KAZANIM
					,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
					,SUM(1) AS KONUSAYISI
				INTO #ttemp
				FROM	   [Pusulam].dbo.Sinav S
				INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK)ON SO.ID_SINAV=S.ID_SINAV
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO				
				INNER JOIN OKYANUSDB.DBO.V3DONEM DN ON DN.ID_DONEM = O.ID_DONEM AND DN.KOD = S.DONEM
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
				INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
				INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS=SD.ID_DERS
				INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
				--INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
				WHERE		S.FREKANSHESAPLA=1  
						AND S.AKTIF=1
						AND S.DURUM=2
						--AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
						AND S.DONEM = @DONEM
						AND (D.AD=@DERSAD)
						AND O.ID_SINIF=@ID_SINIF
						AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
				GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,S.SINAVTARIH
				ORDER BY S.ID_SINAV,SA.KOD


			  Select t2.ID_SINAVBILGI,  
					 t2.ACIKLAMA,
					 t2.SINAVTARIH,
					 t2.DERSAD,
					 t2.KONUKODU,
					 t2.UNITE,
					 t2.KONU,
					 t2.KAZANIM,
					 t2.KONUSAYISI,
					 t2.DOGRUSAYISI,
					(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				into #ttemp3
				from #ttemp t2
			order by t2.ID_SINAVBILGI,t2.KONUKODU


			  Select KONUKODU,
					 SUM(KONUSAYISI) as KONUSAYISI,
					 SUM(DOGRUSAYISI) as DOGRUSAYISI
				into #TTEMPORTS
				from #ttemp3 
			group by KONUKODU

			  Select KONUKODU,
					 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
				into #TEMPORTT
				from #TTEMPORTS 


			  Select t3.ID_SINAVBILGI,  
					 t3.ACIKLAMA,
					 t3.DERSAD,
					 t3.SINAVTARIH,
					 t3.KONUKODU,
					 t3.UNITE,
					 t3.KONU,
					 t3.KAZANIM,
					 '('+ cast ( t3.KONUSAYISI as varchar)+') / ' + Cast(t3.YUZDE as varchar)+'%' as YUZDE
				into #temp4T
				from #ttemp3 t3
			order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

	  
		
			   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
			  from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH				   	
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI

			  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
				from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI
		  
		  
		   
		   
			if exists (Select * from #temp4T)
			begin
					drop table if exists ##pivotS
					drop table if exists ##TT
					  Set @SQL='
					  with PivotData as
					  (
						Select 
						 ACIKLAMA,
						 DERSAD,
						 KONUKODU,
						-- UNITE,
						 KONU,
						 KAZANIM,
						 YUZDE
						from #temp4T
					  )

					  Select 
					   DERSAD,
					   KONUKODU,
					  -- UNITE,
					   KONU,
						 KAZANIM,
					   '+@Columns2+'
					   into ##pivotS
					   from PivotData
					   PIVOT
					   (
						MAX(YUZDE)
						FOR ACIKLAMA
						IN('+@Columns+')
					   ) as PivotResult
					   ORDER BY DERSAD,KONUKODU--,UNITE

					   SELECT * 
					   INTO ##TT
					   FROM ##pivotS
					   GROUP BY DERSAD,KONUKODU,KONU,KAZANIM,'+@Columns+'
							--,UNITE
					   '
					   PRINT @SQL
					   PRINT '1'
					   EXECute (@SQL)
					   PRINT '1'
		  
					  Select  p.*,ORTALAMA = '('+ cast( (SELECT sum(KONUSAYISI) FROM #ttemp3 WHERE KONUKODU = p.KONUKODU) as varchar) +') / '+ Cast(   
														CONVERT(DECIMAL(10,2),
																(SELECT ORTALAMA FROM #TEMPORTT WHERE KONUKODU = p.KONUKODU)
															   ) 
														  as varchar(10))+'%'
							  INTO #t3
						 from ##TT p
			 
					   PRINT '2'
				IF @EOKUL=1
				BEGIN 
					SELECT * FROM #t3 
				END
				ELSE
				BEGIN 
			--	drop table if exists ##pivotS
			--	exec sp_FrekansSistemEksikKazanim @ISLEM=2,@DERSAD='Biyoloji',@DONEM='2017',@ID_SINIF=101549,@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'
	
							select(
									select * from(
											select 
											(					
												SELECT		*
												FROM		#t3 
												FOR JSON AUTO
											) as t3											
										) as tablo FOR JSON AUTO
									) as tt
				END
			end
			else 
			begin
			select(
										select * from(
												select 
												(					
													SELECT		null
										
												) as t3											
											) as tablo FOR JSON AUTO
										) as tt
			end
			   --drop table if exists ##pivotS
			   drop table if exists #temp4T
			   drop table if exists #TEMPORTT
			   drop table if exists #t1
			   drop table if exists #t3
			   drop table if exists #temp
			   drop table if exists #temp3
			   drop table if exists #temp4
			   drop table if exists #TEMPORT
			   drop table if exists #TEMPORTS
			   drop table if exists #tempY2
			   drop table if exists #ttemp
			   drop table if exists #ttemp3
			   drop table if exists #TTEMPORTS
		   
			END
		END
		
		-- OGRETMEN
		IF @ISLEM = 3
		BEGIN
		
--	exec sp_FrekansSistemEksikKazanim @ISLEM=3,@DERSAD='Matematik',@DONEM='2017',@ID_SUBE=427,@ID_KADEME3='[15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='45103215326',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'


			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO
		   DROP table IF EXISTS #ID_KADEME3
		   DROP table IF EXISTS #ID_SINAVTURU
		   DROP table IF EXISTS #OGRENCILIST

		   SELECT VALUE AS ID_KADEME3   INTO #ID_KADEME3	FROM OPENJSON (@ID_KADEME3)
		   SELECT VALUE AS ID_SINAVTURU INTO #ID_SINAVTURU	FROM OPENJSON (@ID_SINAVTURU)
		   

		SELECT DISTINCT O.TCKIMLIKNO
		INTO #OGRENCILIST
		FROM v3OgrenciTum	O
		JOIN eokul_v2.dbo.DersOgretmen	DO	ON	DO.ID_SINIF		= O.ID_SINIF
		WHERE O.DONEM			= @DONEM
			AND DO.TC_OGRETMEN	= @TC_OGRETMEN

		SELECT 
			 ID_SINAVBILGI	= S.ID_SINAV
			,ACIKLAMA		= S.AD +'('+CAST(S.ID_SINAV AS varchar(10))+')'
			,DERSAD			= SD.TAKMAAD
			,KONUKODU		= SR.KOD
			,UNITE			= (SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SR.KOD,1,6))
			,KONU			= (SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SR.KOD,1,9))			
			,DOGRUSAYISI	= SUM(CASE WHEN SR.DURUM='D' THEN 1 ELSE 0 END)
			,KONUSAYISI		= COUNT(1)
			,K3.ID_KADEME3
			,K3.AD GRUP
			,S.SINAVTARIH
		INTO #tempO
		FROM Sinav						S
		JOIN #ID_SINAVTURU				IST	ON	IST.ID_SINAVTURU= S.ID_SINAVTURU
		JOIN v3Kademe3					K3	ON	K3.ID_KADEME3	= S.ID_KADEME3
		JOIN #ID_KADEME3				IK	ON	IK.ID_KADEME3	= K3.ID_KADEME3
		JOIN SinavDers					SD	ON	SD.ID_SINAV		= S.ID_SINAV 
		JOIN v3SinavDers				D	ON	D.ID_DERS		= SD.ID_DERS
		JOIN SinavOgrenci				SO	ON	SO.ID_SINAV		= S.ID_SINAV
		JOIN #OGRENCILIST				O	ON	O.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN vw_SinavOgrenciSoru		SR	ON	SR.ID_SINAVDERS = SD.ID_SINAVDERS AND SR.TCKIMLIKNO = O.TCKIMLIKNO
		WHERE	S.DONEM				= @DONEM
			AND S.FREKANSHESAPLA	= 1
			AND S.AKTIF				= 1
			AND S.DURUM				= 2
			AND D.AD				= @DERSAD
		GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SR.KOD,K3.ID_KADEME3,SINAVTARIH,K3.AD 
		ORDER BY S.ID_SINAV,SR.KOD
		--SELECT
		--	 S.ID_SINAV AS ID_SINAVBILGI
		--	,S.AD +'('+CAST(S.ID_SINAV AS varchar(10))+')' AS ACIKLAMA
		--	,SD.TAKMAAD AS DERSAD
		--	,SA.KOD AS KONUKODU
		--	,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
		--	,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU
		--	,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
		--	,SUM(1) AS KONUSAYISI
		--	,K3.ID_KADEME3
		--	,K3.AD GRUP
		--	,S.SINAVTARIH
		--INTO #tempO
		--FROM	   [Pusulam].dbo.Sinav S
		--INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
		--INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
		--INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
		--INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
		--INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
		--INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS=SD.ID_DERS
		--INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
		--INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
		--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
		--INNER JOIN OKYANUSDB.DBO.V3DONEM DN ON DN.ID_DONEM = O.ID_DONEM AND DN.KOD = S.DONEM
		--INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF=O.ID_SINIF	AND DO.DONEMKOD=@DONEM								
		--WHERE		S.FREKANSHESAPLA=1  
		--		AND S.AKTIF=1
		--		AND S.DURUM=2
		--		AND K3.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON (@ID_KADEME3))
		--		AND S.DONEM = @DONEM
		--		AND (D.AD = @DERSAD)
		--		AND DO.TC_OGRETMEN=@TC_OGRETMEN
		--		AND S.AKTIF=1
		--		AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))
		--GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,K3.ID_KADEME3,SINAVTARIH,K3.AD 
		--ORDER BY S.ID_SINAV,SA.KOD


		  Select t2.ID_SINAVBILGI,  
		         t2.ACIKLAMA,
			     t2.DERSAD,
			     t2.KONUKODU,
			     t2.UNITE,
				 t2.KONU,
				 t2.KONUSAYISI,
				 t2.DOGRUSAYISI,SINAVTARIH,
			    (Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				,ID_KADEME3,GRUP
		    into #temp3O
		    from #tempO t2
	    order by t2.ID_SINAVBILGI,t2.KONUKODU


		  Select KONUKODU,
				 SUM(KONUSAYISI) as KONUSAYISI,
		         SUM(DOGRUSAYISI) as DOGRUSAYISI
			into #TEMPORTSO
	        from #temp3O
		group by KONUKODU

		  Select KONUKODU,
		         (Convert(decimal(10,0),(Convert(decimal(10,2),DOGRUSAYISI)/convert(decimal(10,2),KONUSAYISI))*100)) as ORTALAMA
			into #TEMPORTO
	        from #TEMPORTSO

	      Select t3.ID_SINAVBILGI,  
		         t3.ACIKLAMA,
			     t3.DERSAD,
			     t3.KONUKODU,
			     t3.UNITE,
				 t3.KONU,SINAVTARIH,
			     Cast(t3.YUZDE as varchar)+'%' as YUZDE
				 ,ID_KADEME3,GRUP
		    into #temp4O
		    from #temp3O t3
	    order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

		drop table #temp3O


		   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
		  from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
				   	
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI

		  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
		    from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI
--		   exec sp_FrekansSistem @ISLEM=3,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'




print '1'

IF EXISTS(Select *from #temp4O)
BEGIN

		  Set @SQL='
		  

		  Select 
		   DERSAD,
		   KONU2 KONUKODU,
		   UNITE,
		   KONU,ID_KADEME3,GRUP,
		   '+@Columns2+',
		   ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTO TOR WHERE TOR.KONUKODU = KONU2))
		   into ##t4
		   from(
				Select 
				 ACIKLAMA,
				 DERSAD,			 
				KONUKODU KONU2,
				 UNITE,
				 KONU,
				 YUZDE
				 ,ID_KADEME3,GRUP
				from #temp4O) PivotData
		   PIVOT
		   (
				MAX(YUZDE)
				FOR ACIKLAMA
				IN('+@Columns+')
		   ) as PivotResult
		   ORDER BY DERSAD,KONU2,UNITE
		   
		   '
		   PRINT @SQL
		   
print '2'
		   EXEC (@SQL)

		  
					select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		##t4 
										FOR JSON AUTO
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt

							END
							ELSE
							BEGIN 
								select(
							select * from(
									select 
									(					
										SELECT NULL
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt
							END
			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO
		END
	END
	
	drop table if exists #temp4T
	drop table if exists #TEMPORTT
	drop table if exists #t1
	drop table if exists #t3
	drop table if exists #temp
	drop table if exists #temp3
	drop table if exists #temp4
	drop table if exists #TEMPORT
	drop table if exists #TEMPORTS
	drop table if exists #tempY2
	drop table if exists #ttemp
	drop table if exists #ttemp3
	drop table if exists #TTEMPORTS

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_VeliUniteTaramaRaporu]    Script Date: 23.11.2021 15:40:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_VeliUniteTaramaRaporu]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_UNITETARAMASINAV	INT				= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI					
				,ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	ÖĞRENCİ RAPOR			
			BEGIN
				
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMPOGRENCIPUAN

				SELECT DISTINCT
					 SS.ID_DERS
					,O.TCKIMLIKNO
					,S.ID_UNITETARAMASINAV
					,SINAVAD		= S.AD
					,KITAPCIK		= SK.AD
					,SORUPUAN		= SS.PUAN
					,OGRENCIPUAN	= O.PUAN
					,KAZANIMKOD		= SS.KAZANIMKOD
					,SS.ID_UNITETARAMASORU
					,ADSOYAD	= CONCAT_WS(' ',OD.AD,OD.SOYAD)
					,OD.SUBEAD
					,OD.SINIFAD	
					,OD.ID_SINIF
					,OD.ID_SUBE
					,SS.SORUNO
					,DERSAD			= D.AD
					,KAZANIM		= ISNULL(DU.AD, '')
					,SINIFKATILIM	= NULL
					,OKULKATILIM	= NULL
					,GENELKATILIM	= NULL
				INTO #TEMP
				FROM UniteTaramaSinav						S
				JOIN UniteTaramaKitapcik					SK	ON	SK.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru						SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN UniteTaramaOgrenci						O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
																AND O.ID_UNITETARAMAKITAPCIK= SK.ID_UNITETARAMAKITAPCIK
				JOIN OkyanusDB.DBO.vw_OgrenciDetayTum		OD	ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
																AND OD.DONEM				= S.DONEM
				JOIN OkyanusDB.DBO.v3Ders					D	ON	D.ID_DERS				= SS.ID_DERS
				LEFT JOIN OkyanusDB.DBO.v3SinavDersUnite	DU	ON	DU.KOD					= SS.KAZANIMKOD
				WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV 
					AND (S.OVGORSUN				= 1
						OR EXISTS( SELECT TOP 1 1 FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI NOT IN(3,4) AND TCKIMLIKNO = @TCKIMLIKNO  ))
					AND S.AKTIF					= 1
					AND O.AKTIF					= 1
				ORDER BY O.TCKIMLIKNO

				UPDATE T SET
					 SINIFKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP S WHERE S.ID_SINIF = T.ID_SINIF	)
					,OKULKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP S WHERE S.ID_SUBE  = T.ID_SUBE	)
					,GENELKATILIM	= (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP									)
				FROM #TEMP T
				WHERE T.TCKIMLIKNO	= @TC_OGRENCI	

				SELECT T.*
					,FOTOGRAF	= R.FOTOGRAF
				FROM #TEMP T
				LEFT JOIN OkyanusDB.DBO.v3Resim	R	ON	R.TCKIMLIKNO= T.TCKIMLIKNO
													AND R.SIRANO	= 1
				WHERE	T.TCKIMLIKNO= @TC_OGRENCI
				ORDER BY DERSAD, SORUNO, ID_UNITETARAMASORU

				
	
				SELECT DISTINCT
					 O.TCKIMLIKNO
					,S.ID_UNITETARAMASINAV
					,SINAVAD		= S.AD
					,YUZDE			= CEILING( CAST(CAST(SUM(O.PUAN) AS FLOAT) / SUM(SS.PUAN) * 100 AS DECIMAL(8,2)))
				FROM UniteTaramaSinav		S
				JOIN UniteTaramaKitapcik	K	ON	K.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
				JOIN UniteTaramaSoru		SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
				JOIN UniteTaramaOgrenci		O	ON	O.ID_UNITETARAMASORU	= SS.ID_UNITETARAMASORU
												AND O.ID_UNITETARAMAKITAPCIK= K.ID_UNITETARAMAKITAPCIK
				WHERE	O.TCKIMLIKNO = @TC_OGRENCI
					AND (S.OVGORSUN	 = 1
						OR EXISTS( SELECT TOP 1 1 FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI NOT IN(3,4,5) AND TCKIMLIKNO = @TCKIMLIKNO  ))
					AND S.AKTIF		 = 1
					AND O.AKTIF		 = 1
					AND S.DONEM		 = (SELECT DONEM FROM UniteTaramaSinav SUB WHERE SUB.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV)
				GROUP BY O.TCKIMLIKNO, S.ID_UNITETARAMASINAV, S.AD
				
				SELECT TCKIMLIKNO, ID_SUBE, ID_SINIF, UPPER(DERSAD) DERSAD, SUM(OGRENCIPUAN) OGRENCIPUAN 
				INTO #TEMPOGRENCIPUAN
				FROM #TEMP
				GROUP BY TCKIMLIKNO, ID_SUBE, ID_SINIF, DERSAD

				SELECT DISTINCT 
					 O.TCKIMLIKNO
					,O.DERSAD
					,OGRENCI= O.OGRENCIPUAN
					,SINIF	= (SELECT SUM(SNF.OGRENCIPUAN)/COUNT(DISTINCT TCKIMLIKNO)	FROM #TEMPOGRENCIPUAN SNF	WHERE SNF.DERSAD= O.DERSAD	AND SNF.ID_SINIF= O.ID_SINIF)
					,SUBE	= (SELECT SUM( SB.OGRENCIPUAN)/COUNT(DISTINCT TCKIMLIKNO)	FROM #TEMPOGRENCIPUAN SB	WHERE SB.DERSAD	= O.DERSAD	AND SB.ID_SUBE	= O.ID_SUBE	)
					,GENEL	= (SELECT SUM(GNL.OGRENCIPUAN)/COUNT(DISTINCT TCKIMLIKNO)	FROM #TEMPOGRENCIPUAN GNL	WHERE GNL.DERSAD= O.DERSAD								)
				FROM #TEMPOGRENCIPUAN	O
				WHERE O.TCKIMLIKNO = @TC_OGRENCI
				ORDER BY O.TCKIMLIKNO, O.DERSAD
				
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMPOGRENCIPUAN

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_VIU]    Script Date: 23.11.2021 15:41:05 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_VIU]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@RESIM_URL			VARCHAR(MAX)    = NULL,
	@BASTARIH			VARCHAR(MAX)	= NULL,
	@BITTARIH			VARCHAR(MAX)	= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@TCOGRETMENLIST		VARCHAR(MAX)	= NULL,
	@ID_ARAMADURUMLIST	VARCHAR(MAX)	= NULL,
	@ID_ARAMASEBEPLIST	VARCHAR(MAX)	= NULL,
	@JSON				BIT				= NULL,
	@ID_SUBELER		    VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@DEVICE_ID			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
									
				,BASTARIH			= @BASTARIH
				,BITTARIH			= @BITTARIH
				,ID_SUBELIST		= @ID_SUBELIST
				,TCOGRETMENLIST		= @TCOGRETMENLIST
				,ID_ARAMADURUMLIST	= @ID_ARAMADURUMLIST
				,ID_ARAMASEBEPLIST	= @ID_ARAMASEBEPLIST
				,[JSON]				= @JSON
				,ID_SUBELER		    = @ID_SUBELER
				,ID_SINIFLAR        = @ID_SINIFLAR
				,SQLJSON			= @SQLJSON
				,TC_OGRETMEN		= @TC_OGRETMEN
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		
		IF @ID_LOG > 0
		BEGIN	
			IF @ISLEM = 1	--	VIU Rapor Mesaj
			BEGIN			
				SELECT
					 ACIKLAMA	=	B.AD + IIF(D.ID_DOKUMAN IS NOT NULL ,'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/'+ D.GUID ,'')
					,KYE_TARIH	=	CONVERT(VARCHAR(10), B.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), B.KYE_TARIH, 108)
					,GONDERENTC	=	KYE.TCKIMLIKNO
					,GONDEREN	=	KYE.AD  +' '+ KYE.SOYAD
					,KIME		=	KIME.AD +' '+ KIME.SOYAD
					,KIMICIN	=	KYI.AD  +' '+ KYI.SOYAD
					
					,GONDERENSUBE	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,GONDERENTIP	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMESUBE		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMETIP		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,RENK = IIF( IPTAL = 1 , 'Red' , 'Black' )
				FROM OkyanusIletisim.dbo.BilgiNot					B
				INNER JOIN OkyanusIletisim.dbo.BilgiNotKullanici	N		ON	N.ID_BILGINOT	= B.ID_BILGINOT
				LEFT  JOIN OkyanusIletisim.dbo.Dokuman				D		ON	D.ID_DOKUMAN	= B.ID_DOKUMAN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYE		ON	KYE.TCKIMLIKNO	= B.KYE_TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYI		ON	KYI.TCKIMLIKNO	= N.TCKIMLIKNO_KIMICIN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KIME	ON	KIME.TCKIMLIKNO	= N.TCKIMLIKNO_KIME
				WHERE CAST(B.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO AND SB.ID_SUBE	IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
					)		
				ORDER BY B.KYE_TARIH DESC
			END
	
			IF @ISLEM = 2	--	VIU Rapor VIÜ Kullanmayanlar
			BEGIN				
				
				SELECT DISTINCT
					 K.TCKIMLIKNO,
					 K.AD,
					 K.SOYAD,
					 ISNULL((SELECT M.AD FROM OkyanusIletisim..Menu M WHERE M.ID_MENU = (SELECT TOP 1 ID_MENU FROM OkyanusIletisim..VeliMenuLog VM where VM.TCKIMLIKNO_VELI = K.TCKIMLIKNO ORDER BY VM.KYE_TARIH DESC)), '') AS MENU,
					 ISNULL((SELECT TOP 1 CONVERT(VARCHAR(10), VM.KYE_TARIH, 104) + ' '  + CONVERT(VARCHAR(8), VM.KYE_TARIH, 14) AS TARIH FROM OkyanusIletisim..VeliMenuLog VM where VM.TCKIMLIKNO_VELI = K.TCKIMLIKNO ORDER BY VM.KYE_TARIH DESC), '') AS TARIH
					FROM OkyanusDB..v3Kullanici K
					LEFT JOIN OkyanusDB..v3SubeYetki SY ON K.TCKIMLIKNO = SY.TCKIMLIKNO
					JOIN OkyanusDB..v3OgrenciVeli OV ON K.TCKIMLIKNO = OV.TCKIMLIKNO
					WHERE SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON (@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = 5 AND OV.AKTIF = 1 AND K.AD != ''
					ORDER BY K.AD, K.SOYAD 

			END
			
			IF @ISLEM = 3	--	Arama Sebep Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMASEBEP, S.AD + ' (' + K.AD + ')' AS AD
					FROM [OkyanusIletisim].[dbo].[AramaSebep] S
					JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = S.ID_KADEME
					ORDER BY S.ID_KADEME, S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 4	--	Arama Durum Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMADURUM, S.AD
					FROM [OkyanusIletisim].[dbo].[AramaDurum] S
					ORDER BY S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 5	--	Arama Rapor
			BEGIN
				IF @JSON = 1
				BEGIN
					SELECT 
					ISNULL (
					(
						SELECT	 GUID			=	A.GUID
								,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
								,ARAYANTC		=	A.TC_ARAYAN
								,ARAYAN			=	K.AD  +' '+ K.SOYAD
								,KIME			=	A.ADSOYAD_ARANAN
								,ARAMASEBEP		=	S.AD 
								,ARAMADURUM		=	D.AD 
								,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
								,GRUP			=	K3.AD
								,SINIF			=	SNF.AD
								,ARAYANSUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
															FOR XML PATH('')
													), 1, 1, '')
								--,ARAYANTIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
								--				FOR XML PATH('')
								--				), 1, 1, '')
								,KIMESUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
															FOR XML PATH('')
													), 1, 1, '')
								--,KIMETIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
								--				FOR XML PATH('')
								--				), 1, 1, '') 
						FROM OkyanusIletisim.dbo.Arama		A	WITH (NOLOCK)
						JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO	= A.TC_ARAYAN
						JOIN OkyanusDB.dbo.v3Kullanici		KYI ON	KYI.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
						JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
						JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
						JOIN OkyanusIletisim.dbo.AramaSebep S	ON	S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
						JOIN OkyanusIletisim.dbo.AramaDurum D	ON	D.ID_ARAMADURUM = A.ID_ARAMADURUM
						WHERE	CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
						AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
						AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
						AND (
									(	EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST)))
							OR		(NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (	SELECT DISTINCT  SY.TCKIMLIKNO
														FROM OkyanusDB.dbo.v3SubeYetki	SY
														INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
														WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
									)	
								)
							)	
						AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
						ORDER BY A.KYE_TARIH DESC
						FOR JSON PATH
					), '[]')
				END
				ELSE
				BEGIN
					SELECT	 GUID			=	A.GUID
							,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
							,ARAYANTC		=	A.TC_ARAYAN
							,ARAYAN			=	K.AD  +' '+ K.SOYAD
							,KIME			=	A.ADSOYAD_ARANAN
							,ARAMASEBEP		=	S.AD 
							,ARAMADURUM		=	D.AD 
							,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
							,GRUP			=	K3.AD
							,SINIF			=	SNF.AD
							,ARAYANSUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
											FOR XML PATH('')
											), 1, 1, '')
							--,ARAYANTIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
							--				FOR XML PATH('')
							--				), 1, 1, '')
							,KIMESUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
											FOR XML PATH('')
											), 1, 1, '')
							--,KIMETIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
							--				FOR XML PATH('')
							--				), 1, 1, '') 
					FROM OkyanusIletisim.dbo.Arama A	WITH (NOLOCK)
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = A.TC_ARAYAN
					JOIN OkyanusDB.dbo.v3Kullanici KYI ON KYI.TCKIMLIKNO = A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
					JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
					JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
					JOIN OkyanusIletisim.dbo.AramaSebep S ON S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
					JOIN OkyanusIletisim.dbo.AramaDurum D ON D.ID_ARAMADURUM = A.ID_ARAMADURUM
					WHERE CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
					AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
						)	
					AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
					ORDER BY A.KYE_TARIH DESC
				END
			END

			IF @ISLEM = 6   --  Yoklama Rapor
			BEGIN
				--SELECT distinct 
				--	 D.SUBEAD
				--	,D.SINIF
				--	,K.AD + ' '+ K.SOYAD [AD SOYAD]
				--	,CONVERT(VARCHAR(10), Y.TARIH, 105)AS TARIH
				--	,K.TCKIMLIKNO
				--	,D.ID_SINIF
				--	,Y.ID_YOKLAMA
				--	,YK.GELDI
				--	,Y.TARIH AS tarih
				--	,CASE
				--			WHEN GELDI>0 THEN 'GELDİ'
				--			WHEN GELDI<1 THEN 'GELMEDİ'
				--		END AS DURUM
				--FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				--INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				--INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				--INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				--INNER JOIN  [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF	= D.ID_SINIF	AND	S.ID_SINIF		= Y.ID_SINIF
				--INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici] YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA  AND YK.TCKIMLIKNO	= K.TCKIMLIKNO
				--WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				--AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				--AND CAST(TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
				--ORDER BY  D.SUBEAD ASC,D.SINIF ASC,[AD SOYAD] ASC ,tarih DESC

				SELECT DERSNO, AD = BASSAAT + ' - ' + BITSAAT
				INTO #DERSSAAT
				FROM Pusulam.dbo.OnlineDersSaat   
				WHERE	BASSAAT != '00:00'
					AND BITSAAT != '00:00'

				SELECT CAST(DATEADD(DAY, number, @BASTARIH) AS DATE) [Date]
				INTO #DATES
				FROM master..spt_values
				WHERE type = 'P'
				AND DATEADD(DAY, number, @BASTARIH) <= @BITTARIH

				SELECT distinct 
					 SD.SUBEAD
					,SD.SINIF
					,K.AD + ' '+ K.SOYAD [AD SOYAD]
					,K.TCKIMLIKNO
					,S.ID_SINIF
				INTO #KULLANICI
				FROM		OkyanusDB.dbo.vw_SinifOgrenci				S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				SD	ON S.ID_SINIF	= SD.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= SD.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				WHERE AD.AKTIF=1        
				AND ( ( SD.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( SD.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  

				SELECT K.*, D.Date AS TARIH, CONVERT(VARCHAR(MAX), D.Date, 104) AS STRTARIH
				INTO #KULLANICITARIH
				FROM #KULLANICI K
				CROSS APPLY #DATES D

				SELECT K.TCKIMLIKNO, K.TARIH, DP.DERSSAAT, CASE WHEN YK.GELDI = 1 THEN 'GELDİ' ELSE 'GELMEDİ' END AS DURUM
				INTO #KULLANICIDURUM
				FROM #KULLANICITARIH K
				INNER JOIN [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF = K.ID_SINIF AND Y.TARIH = K.TARIH
				INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici]	YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA AND YK.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN  OkyanusDB.dbo.v3DersProgram DP					ON DP.ID_DERSPROGRAM = Y.ID_DERSPROGRAM


				DECLARE @INDEX INT = 1
				DECLARE @COLUMN VARCHAR(MAX) = ''
				DECLARE @DERSNO VARCHAR(MAX) = ''

				WHILE @INDEX <= (SELECT MAX(DERSNO) FROM #DERSSAAT WHERE AD != ' - ')
				BEGIN
					SELECT @COLUMN = AD, @DERSNO = DERSNO FROM #DERSSAAT WHERE DERSNO = @INDEX

					EXECUTE('
					ALTER TABLE #KULLANICITARIH
					ADD [' + @COLUMN + '] VARCHAR(MAX)
					')
		
					EXECUTE ('UPDATE K SET K.[' + @COLUMN + '] = ISNULL((
																			SELECT DURUM
																			FROM #KULLANICIDURUM KD
																			WHERE KD.TARIH = K.TARIH AND KD.TCKIMLIKNO = K.TCKIMLIKNO AND KD.DERSSAAT = ' + @DERSNO + '
																), ''-'') FROM #KULLANICITARIH K')


					SET @INDEX = @INDEX + 1
				END

				SELECT *
				FROM #KULLANICITARIH
				ORDER BY SUBEAD ASC,SINIF ASC, [AD SOYAD] ASC, TARIH

				DROP TABLE #KULLANICI
				DROP TABLE #DERSSAAT
				DROP TABLE #DATES
				DROP TABLE #KULLANICITARIH
				DROP TABLE #KULLANICIDURUM
			END

			IF @ISLEM = 7   --  Viu Yetki Listesi
			BEGIN
			
				SELECT 
				(
					SELECT	Distinct K.AD + ' '+ K.SOYAD AS ADSOYAD ,K.TCKIMLIKNO
							
							,(	
							   
								SELECT distinct D.SUBEAD AS SUBEAD,D.ID_SUBE, 
								SECILI = (SELECT COUNT(1) FROM  ViuAramaKullaniciSube S where D.ID_SUBE=S.ID_SUBE and S.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.SUBEAD,D.ID_SUBE
								ORDER BY D.SUBEAD,D.ID_SUBE
								FOR JSON PATH
							 ) AS SUBE
							 ,(
							 SELECT distinct D.KADEME3 AS GRUP,D.ID_KADEME3, 
							 SECILI = (SELECT COUNT(1) FROM  ViuAramaKullaniciKademe K where K.ID_KADEME3=D.ID_KADEME3 and K.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.KADEME3,D.ID_KADEME3
								ORDER BY D.ID_KADEME3
								FOR JSON PATH
							 )
							 AS GRUP
					FROM OkyanusDB.dbo.v3Kullanici	K
					INNER JOIN OkyanusDB.[dbo].[v4KullaniciSubeTurKademe] TK  ON   TK.TCKIMLIKNO=K.TCKIMLIKNO 
					WHERE K.TCKIMLIKNO =@TC_OGRETMEN
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8   --  Viu Yetki Kaydet
			BEGIN
		   
				DELETE FROM ViuAramaKullanici WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciSube WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciKademe WHERE TCKIMLIKNO = @TC_OGRETMEN
				
				MERGE INTO ViuAramaKullanici AS A 
                USING ( 
						SELECT *
                        FROM OPENJSON(@SQLJSON) WITH ( TCKIMLIKNO VARCHAR(MAX) )) B
                ON (A.TCKIMLIKNO = B.TCKIMLIKNO) 
                WHEN MATCHED THEN 
                UPDATE  SET A.TCKIMLIKNO =B.TCKIMLIKNO                  
                WHEN NOT MATCHED THEN 
                INSERT  (TCKIMLIKNO)
				VALUES (B.TCKIMLIKNO);

					

				SELECT DISTINCT TCKIMLIKNO
                FROM OPENJSON(@SQLJSON)
                WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
		                ,SUBE		NVARCHAR(MAX) AS JSON 
		                ,GRUP		NVARCHAR(MAX) AS JSON
                ) AS J
					
                     
				INSERT INTO ViuAramaKullaniciSube(TCKIMLIKNO, ID_SUBE)
				SELECT DISTINCT TCKIMLIKNO, ID_SUBE 
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.SUBE)
				WITH(	 ID_SUBE	INT
						,SECILI		BIT	
				) AS S
				WHERE S.SECILI = 1

				INSERT INTO ViuAramaKullaniciKademe(TCKIMLIKNO,ID_KADEME3)
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME3  
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.GRUP)
				WITH (	 ID_KADEME3	INT
						,SECILI		BIT	
				) AS G
				WHERE G.SECILI = 1








        END 

			IF @ISLEM = 9	--	Kullanıcı Tipine Göre Kullanıcı Listele
			BEGIN
		
				SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
				FROM [dbo].[v3Kullanici]			KL	
				JOIN OkyanusDB.[dbo].[v3SubeYetki]	TK  ON   TK.TCKIMLIKNO=KL.TCKIMLIKNO 
				WHERE	TK.ID_KULLANICITIPI=101
				order by ADSOYAD 

			END

			IF @ISLEM = 10  --  Viu Toplu Mesaj Kaydet
			BEGIN				
				DROP TABLE IF EXISTS #MESAJLIST

				SELECT *, RN = ROW_NUMBER() OVER(ORDER BY TC_GONDEREN)
				INTO #MESAJLIST
				FROM OPENJSON(@SQLJSON)
				WITH (
					TC_GONDEREN	VARCHAR(MAX),
					TC_ALAN		VARCHAR(MAX),
					MESAJ		VARCHAR(MAX),
					LINK_ETIKET	VARCHAR(MAX),
					LINK		VARCHAR(MAX)					
				)	ML
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= ML.TC_ALAN
				
				DECLARE @TOPLUMESAJ INT = NULL
				DECLARE @INSERT10 TABLE (ID INT)
				
				INSERT INTO OkyanusIletisim.dbo.TopluMesaj (KYE_TARIH,KYE_TCKIMLIKNO) 
					OUTPUT inserted.ID_TOPLUMESAJ INTO @INSERT10(ID) 
				VALUES(GETDATE(),@TCKIMLIKNO)

				SET @TOPLUMESAJ =(SELECT TOP 1 ID FROM @INSERT10)



				WHILE EXISTS ( SELECT TOP 1 1 FROM #MESAJLIST )
				BEGIN
		
					DECLARE @TC_GONDEREN	VARCHAR(MAX),
							@TC_ALAN		VARCHAR(MAX),
							@MESAJ			VARCHAR(MAX),
							@LINK_ETIKET	VARCHAR(MAX),
							@LINK			VARCHAR(MAX),
							@RN				INT
							
					SELECT TOP 1 
						 @TC_GONDEREN	= ML.TC_GONDEREN
						,@TC_ALAN		= ML.TC_ALAN
						,@MESAJ			= ML.MESAJ	
						,@LINK_ETIKET	= ML.LINK_ETIKET
						,@LINK			= ML.LINK
						,@RN			= ML.RN
						
					FROM #MESAJLIST		ML
					ORDER BY RN

					IF NOT EXISTS (
						SELECT TOP 1 1
						FROM v3Kullanici K
						WHERE K.TCKIMLIKNO	= @TC_GONDEREN
							AND K.AKTIF		= 1
					)
						SET  @TC_GONDEREN = '14531453000'	-- OKYANUS KOLEJLERİ
	
					
					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TC_GONDEREN
						,@HEADER			= 'Yeni Mesaj'
						,@MESAJ				= @MESAJ
						,@LINK				= @LINK
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @MESAJ
						,@LINK_ETIKET		= @LINK_ETIKET
						,@TOPLUMESAJ		= @TOPLUMESAJ
						,@RESIM_URL			= @RESIM_URL

					DELETE FROM #MESAJLIST WHERE RN = @RN

				END

				DROP TABLE IF EXISTS #MESAJLIST

			END

			IF @ISLEM = 11 --Kullanıcı Cihaz Listesi
			BEGIN
				SELECT ISNULL((
					SELECT DISTINCT
						K.TCKIMLIKNO, 
						ADSOYAD = K.AD + ' ' + K.SOYAD, 
						LL.DEVICE_ID
					FROM OkyanusIletisim.dbo.LoginLog LL WITH (NOLOCK)
					JOIN v3Kullanici K WITH (NOLOCK) ON K.TCKIMLIKNO = LL.KYE_TCKIMLIKNO
					WHERE DEVICE_ID != 'Pusulam'
						AND (KYE_TCKIMLIKNO = @TC_OGRETMEN OR DEVICE_ID = @DEVICE_ID)
				FOR JSON PATH
				),'[]')
			END
			
			IF @ISLEM = 12 --Kullanıcı Cihaz Raporu
			BEGIN				
				SELECT DISTINCT
					[TC KİMLİK NO] = K.TCKIMLIKNO, 
					[AD SOYAD] = K.AD + ' ' + K.SOYAD, 
					[CİHAZ ID] = LL.DEVICE_ID
				FROM OkyanusIletisim.dbo.LoginLog LL WITH (NOLOCK)
				JOIN v3Kullanici K WITH (NOLOCK) ON K.TCKIMLIKNO = LL.KYE_TCKIMLIKNO
				WHERE DEVICE_ID != 'Pusulam'
					AND (KYE_TCKIMLIKNO = @TC_OGRETMEN OR DEVICE_ID = @DEVICE_ID)				
			END
		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_ViuBildirimRapor]    Script Date: 23.11.2021 15:41:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_ViuBildirimRapor]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@BASTARIH				VARCHAR(MAX)	= NULL,
	@BITTARIH				VARCHAR(MAX)    = NULL,
	@TC_KULLANICI			VARCHAR(11)		= NULL,
	@DATATABLE				BIT				= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
/*

	Oluşturan		: Burhan Akyüz
	Oluşturma Tarih	: 10.11.2020
	
	--	sp Create 
		--	ISLEM = 1 ADD
	--	Viu Bildirim raporları

*/	


	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON
				,BASTARIH				= @BASTARIH
				,BITTARIH				= @BITTARIH
				,TC_KULLANIC			= @TC_KULLANICI
				,DATATABLE				= @DATATABLE
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN

			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN
				DROP TABLE IF EXISTS #TEMP_BILDIRIM_RAPORU
				CREATE TABLE #TEMP_BILDIRIM_RAPORU
				(
				ID_BILDIRIM INT,
				KYE_TCKIMLIKNO VARCHAR(MAX),
				KYE_TARIH DATE,
				MESAJ VARCHAR(MAX),
				TCKIMLIKNO_KIME VARCHAR(MAX),
				HEADER VARCHAR(MAX),
				LINK VARCHAR(MAX),
				ID_UYGULAMA INT ,
				RESIM_URL VARCHAR(MAX),
				GONDERILDI BIT,
				MESAJTAM VARCHAR(MAX),
				LINK_ETIKET VARCHAR(MAX),
				UYGULAMA VARCHAR(MAX)
				)

				INSERT INTO #TEMP_BILDIRIM_RAPORU
				SELECT   [ID_BILDIRIM]
						,[KYE_TCKIMLIKNO]
						,[KYE_TARIH]
						,[MESAJ]
						,[TCKIMLIKNO_KIME]
						,[HEADER]
						,[LINK]
						,B.[ID_UYGULAMA]
						,[RESIM_URL]
						,[GONDERILDI]
						,[MESAJTAM]
						,[LINK_ETIKET]
						,U.AD AS UYGULAMA 
				FROM OkyanusIletisim.dbo.Bildirim		B
				LEFT JOIN OkyanusIletisim.dbo.Uygulama	U	ON	B.ID_UYGULAMA	= U.ID_UYGULAMA
				WHERE
						B.KYE_TARIH >= CAST(@BASTARIH AS DATE)
				AND		B.KYE_TARIH <= CAST(@BITTARIH AS DATE)
				AND		B.TCKIMLIKNO_KIME = @TC_KULLANICI
				AND		B.GONDERILDI=1
				ORDER BY B.KYE_TARIH DESC

				IF ISNULL(@DATATABLE ,0 ) = 0
					SELECT (
						SELECT(
							SELECT * 
							FROM #TEMP_BILDIRIM_RAPORU 
							ORDER BY KYE_TARIH DESC 
							FOR JSON PATH
						)AS BILDIRIMRAPORU
					)
				ELSE
					SELECT	 [TARİH]		= CONVERT(VARCHAR,KYE_TARIH,104)
							,[TC KIMLIK NO]	= TCKIMLIKNO_KIME
							,UYGULAMA		= UYGULAMA
							,[BAŞLIK]		= HEADER
							,MESAJ			= MESAJ
							,[MESAJ TAM]	= MESAJTAM
					FROM #TEMP_BILDIRIM_RAPORU
					


			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_ViuRandevuTakip]    Script Date: 23.11.2021 15:41:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_ViuRandevuTakip]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_IDARECI				VARCHAR(11)		= NULL,
	@ID_SUBELIST			VARCHAR(MAX)	= NULL,
	@TCLIST					VARCHAR(MAX)	= NULL,
	@BASTARIH				VARCHAR(MAX)	= NULL,
	@BITTARIH				VARCHAR(MAX)	= NULL,
	@RANDEVUDURUM			INT				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,TC_IDARECI		= @TC_IDARECI
				,ID_SUBELIST	= @ID_SUBELIST
				,BASTARIH		= @BASTARIH
				,BITTARIH		= @BITTARIH
				,TCLIST			= @TCLIST
				,RANDEVUDURUM	= @RANDEVUDURUM
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	RANDEVU LİSTESİ			
			BEGIN
			
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #TCLIST
				DROP TABLE IF EXISTS #IDARECILER
				DROP TABLE IF EXISTS #TEMP1

				SELECT VALUE AS ID_SUBE		INTO #SUBELIST	FROM OPENJSON(@ID_SUBELIST)
				SELECT VALUE AS TCKIMLIKNO	INTO #TCLIST	FROM OPENJSON(@TCLIST)

				SELECT DISTINCT 
					 SY.TCKIMLIKNO
					,SY.ID_SUBE
					,SB.AD AS SUBEAD
					,K.AD
					,K.SOYAD
					,RANDEVUSAYISI			= 0
					,GELENRANDEVUSAYISI		= 0
					,GELMEYENRANDEVUSAYISI	= 0
					,BELIRSIZRANDEVUSAYISI	= 0
				INTO #TEMP1
				FROM v3SubeYetki				SY
				JOIN #TCLIST					T	ON	T.TCKIMLIKNO	= SY.TCKIMLIKNO
				JOIN #SUBELIST					S	ON	S.ID_SUBE		= SY.ID_SUBE
				JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= SY.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Sube		SB	ON	SB.ID_SUBE		= SY.ID_SUBE
				
				;WITH SAYILAR AS(
					SELECT 
						 T.TCKIMLIKNO
						,RANDEVUSAYISI			= COUNT(DISTINCT RK.ID_RANDEVU)
						,GELENRANDEVUSAYISI		= ISNULL(SUM(IIF(RK.GELDI = 1, 1, 0))	   ,0)
						,GELMEYENRANDEVUSAYISI	= ISNULL(SUM(IIF(RK.GELDI = 0, 1, 0))	   ,0)
						,BELIRSIZRANDEVUSAYISI	= ISNULL(SUM(IIF(RK.GELDI IS NULL , 1 , 0)),0)
					FROM #TEMP1		T
					JOIN OkyanusIletisim.dbo.RandevuKullanici	RK	ON	RK.TCKIMLIKNO_KIME	= T.TCKIMLIKNO
					JOIN OkyanusIletisim.dbo.Randevu			R	ON	RK.ID_RANDEVU		= R.ID_RANDEVU
																	AND	R.TARIH				>= CAST(@BASTARIH AS date)
																	AND R.TARIH				<= CAST(@BITTARIH AS date)
					GROUP BY T.TCKIMLIKNO
				)
				UPDATE T SET 
					RANDEVUSAYISI			= S.RANDEVUSAYISI			
					,GELENRANDEVUSAYISI		= S.GELENRANDEVUSAYISI	
					,GELMEYENRANDEVUSAYISI	= S.GELMEYENRANDEVUSAYISI	
					,BELIRSIZRANDEVUSAYISI	= S.BELIRSIZRANDEVUSAYISI	
				FROM #TEMP1		T
				JOIN SAYILAR	S	ON	S.TCKIMLIKNO = T.TCKIMLIKNO


				SELECT (
					SELECT *
						,KADEMELIST	= (	SELECT DISTINCT 
											SKD.AD KADEME
										FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY
										JOIN OkyanusDB.dbo.v3Kademe				SKD	ON	SKD.ID_KADEME= SKY.ID_KADEME
										WHERE SKY.TCKIMLIKNO = T.TCKIMLIKNO
										FOR JSON PATH, INCLUDE_NULL_VALUES
									)
					FROM #TEMP1 T
					FOR JSON PATH, INCLUDE_NULL_VALUES				
				)

				
				DROP TABLE IF EXISTS #IDARECILER
				DROP TABLE IF EXISTS #SUBELIST
				DROP TABLE IF EXISTS #TCLIST
				DROP TABLE IF EXISTS #TEMP1

			END

			IF @ISLEM = 2	--	RANDEVU LİSTE DETAY		
			BEGIN

				SELECT (
					SELECT DISTINCT 
						 TCKIMLIKNO		= OK.TCKIMLIKNO
						,IDARECI		= CONCAT_WS(' ', IK.AD, IK.SOYAD)
						,ADSOYAD		= CONCAT_WS(' ', OK.AD, OK.SOYAD)
						,SUBEAD			= SB.AD
						,VELILIST		= (	SELECT CONCAT_WS(' ', VK.AD, VK.SOYAD) AS ADSOYAD
											FROM OkyanusDB.dbo.v3OgrenciVeli	V
											JOIN OkyanusDB.dbo.v3Kullanici		VK	ON	VK.TCKIMLIKNO	= V.TCKIMLIKNO
											WHERE 	V.TCKIMLIKNO_OGR = O.TCKIMLIKNO
											FOR JSON PATH, INCLUDE_NULL_VALUES
										  )
						,ID_RANDEVU		= R.ID_RANDEVU
						,RANDEVUAD		= R.AD
						,RANDEVUDURUM	= CASE  WHEN RK.GELDI = 1	THEN 'Geldi'
												WHEN RK.GELDI = 0	THEN 'Gelmedi'
																	ELSE 'Belirsiz'
										  END
					FROM OkyanusIletisim.dbo.Randevu			R
					JOIN OkyanusIletisim.dbo.RandevuKullanici	RK	ON	RK.ID_RANDEVU	= R.ID_RANDEVU
					JOIN OkyanusDB.dbo.v3Ogrenci				O	ON	O.TCKIMLIKNO	= RK.TCKIMLIKNO_KIMICIN
					JOIN OkyanusDB.dbo.v3Sube					SB	ON	SB.ID_SUBE		= O.ID_SUBE
					JOIN OkyanusDB.dbo.v3Kullanici				OK	ON	OK.TCKIMLIKNO	= O.TCKIMLIKNO
					JOIN OkyanusDB.dbo.v3Kullanici				IK	ON	IK.TCKIMLIKNO	= RK.TCKIMLIKNO_KIME
					WHERE	RK.TCKIMLIKNO_KIME					= @TC_IDARECI
						AND ISNULL(CAST(RK.GELDI AS INT), -1)	= @RANDEVUDURUM
						AND	R.TARIH								>= CAST(@BASTARIH AS date)
						AND R.TARIH								<= CAST(@BITTARIH AS date)
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YaziliYoklama]    Script Date: 23.11.2021 15:41:56 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YaziliYoklama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@ID_KADEME2				VARCHAR(MAX)	= NULL,
	@ID_DERSLER				VARCHAR(MAX)	= NULL,
	@SINIFLAR				VARCHAR(MAX)	= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_YAZILI				INT				= NULL,
	@DONEM					char(4)			= NULL,
	@YARIYIL				TINYINT			= NULL,
	@PASIF					BIT				= NULL,
	@TAKMAAD				VARCHAR(MAX)	= NULL,
	@ID_DERS				INT				= NULL,
	@ID_SINIF				INT				= NULL,	
	@SQLJSON		 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCI 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCICEVAP	NVARCHAR(MAX)	= NULL,
	@OVGORSUN				BIT				= NULL,
	@AKTIF					BIT				= NULL,
	@KARNEDEGORUNSUN		BIT				= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM				
			,TCKIMLIKNO						= @TCKIMLIKNO			
			,TC_OGRENCI						= @TC_OGRENCI			
			,OTURUM							= @OTURUM				
			,ID_MENU						= @ID_MENU			
			,ID_KADEME2						= @ID_KADEME2			
			,ID_DERSLER						= @ID_DERSLER			
			,SINIFLAR						= @SINIFLAR			
			,ID_KADEME3						= @ID_KADEME3			
			,ID_YAZILI						= @ID_YAZILI			
			,DONEM							= @DONEM				
			,YARIYIL						= @YARIYIL			
			,PASIF							= @PASIF				
			,TAKMAAD						= @TAKMAAD			
			,ID_DERS						= @ID_DERS			
			,ID_SINIF						= @ID_SINIF			
			,SQLJSON		 				= @SQLJSON		 	
			,SQLJSONOGRENCI 				= @SQLJSONOGRENCI 	
			,SQLJSONOGRENCICEVAP			= @SQLJSONOGRENCICEVAP
			,OVGORSUN						= @OVGORSUN			
			,AKTIF							= @AKTIF				
			,KARNEDEGORUNSUN				= @KARNEDEGORUNSUN	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	KADEME 3 Listele
			BEGIN
				SELECT
				(
					SELECT DISTINCT st.ID_KADEME3, k.AD
					FROM		  [dbo].[v3Sinif]			s
					INNER JOIN	  [dbo].[v3Donem]			d		ON d.ID_DONEM		=	s.ID_DONEM
					INNER JOIN	  [dbo].[v3AktifDonem]		ad		ON ad.DONEM			=	d.KOD			and ad.AKTIF=1
					INNER JOIN	  [dbo].[v3SatisTuru]		st		ON st.ID_SATISTURU	=	s.ID_SATISTURU
					INNER JOIN	  [dbo].[v3Kademe3]			k		ON k.ID_KADEME3		=	st.ID_KADEME3
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 2	--	KADEME 2 LİSTELE
			BEGIN
				SELECT
				(
					SELECT KB.ID_KADEME2, K2.AD FROM OkyanusDB.dbo.v3KademeBilgi KB
					INNER JOIN OkyanusDB.dbo.v3Kademe2 K2 ON K2.ID_KADEME2=KB.ID_KADEME2
					where ID_KADEME3 = @ID_KADEME3
					FOR JSON PATH
				) AS J
			END	

			IF @ISLEM = 3	--	EKLE
			BEGIN
				----------
				--YAZILI--
				----------
				DECLARE @ID_YAZILILIST TABLE (ID_YAZILI INT)
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI INTO @ID_YAZILILIST(ID_YAZILI)
				select		[AD] ,[KOD] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM], YARIYIL, [ID_KADEME3], ID_DERS, convert(datetime, [YAZILITARIH], 103), @TCKIMLIKNO, [ID_YAZILITURU]
				from OPENJSON(@SQLJSON)
				with
				(
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) AS J

				-----------------
				--YAZILIKADEME2--
				-----------------
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select (select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')
									
				-----------
				--SORULAR--
				-----------
				INSERT INTO [dbo].[YaziliSoru]
						   ([ID_YAZILI]
						   ,[SORUNO]
						   ,[PUAN]
						   ,[KOD]
						   ,[ID_BILGI]
						   ,[ID_BILISSELSUREC])
				SELECT
					(select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI]
					,JSON_Value (s.value, '$.SORUNO') as SORUNO
					,ISNULL(CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.')), 0) as PUAN
					,JSON_Value (s.value, '$.KOD') as KOD
					,CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END AS ID_BILGI
					,CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END AS ID_BILISSELSUREC
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
			
				select ID_YAZILI from @ID_YAZILILIST	
			END

			IF @ISLEM = 4	--	GÜNCELLE
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILI
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILI TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				UPDATE	 SORU SET SORU.PUAN = CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.'))
						,SORU.KOD = JSON_Value (s.value, '$.KOD')
						,SORU.ID_BILGI = CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END
						,SORU.ID_BILISSELSUREC = CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
				INNER JOIN YaziliSoru SORU ON SORU.ID_YAZILI = @ID_YAZILI AND SORU.SORUNO = JSON_Value (s.value, '$.SORUNO')
				
				DROP TABLE #TEMPYAZILI
				select @ID_YAZILI	
			END

			IF @ISLEM = 5	--	BİLGİ GETİR
			BEGIN
				SELECT 
				(
					SELECT * FROM
					(
						Select (
							Select  
								s.AD as AD, 
								s.KOD, 
								ID_KADEME3, 
								Convert(varchar, YAZILITARIH, 103) as YAZILITARIH,
								s.ID_DERS,
								(SELECT COUNT(*) FROM YaziliSoru YS WHERE YS.ID_YAZILI=s.ID_YAZILI) as SORUSAYISI,
								SORULIST.SORUNO as SORUNO,
								SORULIST.KOD,
								UNITE = ISNULL(SD.AD, ''), 
								SORULIST.PUAN,
								s.YARIYIL,
								s.ID_YAZILITURU,
								ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
								ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC
							from	   Yazili			s
							LEFT join YaziliSoru		SORULIST		on	SORULIST.ID_YAZILI		= s.ID_YAZILI 
							LEFT JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
							where s.ID_YAZILI = @ID_YAZILI
						for json auto) as T1
						,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON AUTO) AS T2
					) AS XTABLE
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 6	--	LISTELE
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_YAZILI
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, YAZILITARIH, 104) AS YAZILITARIH
							,AKTIF 
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM YaziliOgrenci WHERE ID_YAZILI = S.ID_YAZILI GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,OVGORSUN
							,KARNEDEGORUNSUN,
							ID_YAZILITURU
						FROM Yazili S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN YaziliKademe2 K2 ON K2.ID_YAZILI = S.ID_YAZILI
						WHERE	DONEM = @DONEM 
						AND		(@YARIYIL = 0 OR YARIYIL = @YARIYIL)
						AND		(@ID_KADEME3 = 0 OR S.ID_KADEME3 = @ID_KADEME3)
						AND		(@ID_KADEME2 = '[]' OR K2.ID_KADEME2 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME2)) or 0 in (SELECT VALUE FROM OPENJSON(@ID_KADEME2)))
						AND		(S.AKTIF = 1 OR @PASIF = 1)
						AND		(@ID_DERS = 0 OR S.ID_DERS = @ID_DERS)
					)XTABLE
					ORDER BY Convert(datetime, YAZILITARIH, 104) DESC
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 7	--	AKTİF PASİF
			BEGIN
				DECLARE @DURUM BIT = (SELECT CASE WHEN AKTIF = 1 THEN 0 ELSE 1 END FROM Yazili WHERE ID_YAZILI = @ID_YAZILI)
				UPDATE Yazili SET AKTIF = @DURUM, GUN_TCKIMLIKNO = @TCKIMLIKNO, GUN_TARIH = GETDATE() WHERE ID_YAZILI = @ID_YAZILI
				SELECT @DURUM
			END

			IF @ISLEM = 8	--	ÖĞRENCİ LİSTELE
			BEGIN
				--DECLARE @KUR BIT = (
				--			SELECT D.KUR FROM Yazili Y
				--			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--			WHERE ID_YAZILI = @ID_YAZILI
				--		)

				SELECT X.TCKIMLIKNO, X.AD, X.SOYAD, YOC.ID_YAZILIOGRENCI, X.ID_YAZILI, X.ID_YAZILISORU, X.SORUNO, X.PUAN AS MAXPUAN, ISNULL(YOC.PUAN, 0) AS PUAN, ISNULL(YO.KATILMADI, 0) AS KATILMADI, YO.TELAFI
				INTO #TEMP
				FROM
				(
					SELECT * FROM
					(
						SELECT Y.ID_YAZILI, YS.ID_YAZILISORU, YS.SORUNO, YS.PUAN 
						FROM Yazili Y
						INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
						WHERE Y.ID_YAZILI = @ID_YAZILI
					) AS T1
					CROSS JOIN 
					(
						SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDb.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
						WHERE S.ID_SINIF = @ID_SINIF --AND @KUR = 0
					UNION 
						SELECT DISTINCT K.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDB.dbo.v4SinifOgrenci SO 
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= SO.TC_OGRENCI
						WHERE SO.ID_SINIF = @ID_SINIF AND SO.AKTIF = 1
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM OkyanusDb.dbo.v3OgrenciTumKur O
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					--	INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
					--	WHERE S.ID_SINIF = @ID_SINIF AND @KUR = 1
					--UNION 
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM eokul_v2.dbo.KurOgrenci			KO
					--	INNER JOIN OkyanusDB.dbo.v3OgrenciTum		O	ON	O.ID_OGRENCI	= KO.ID_OGRENCI
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
					--	WHERE KO.ID_KUR = @ID_SINIF
					) AS T2
				) AS X
				LEFT JOIN YaziliOgrenci YO ON YO.ID_YAZILI = X.ID_YAZILI AND YO.TCKIMLIKNO = X.TCKIMLIKNO AND AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = X.ID_YAZILISORU

				SELECT
				(
					SELECT
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILISORU, SORUNO, PUAN, MAXPUAN FROM #TEMP					
						ORDER BY TCKIMLIKNO, SORUNO
						FOR JSON PATH
					) AS T1,
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI, COUNT(DISTINCT ID_YAZILISORU) AS SORUSAYISI 
						FROM #TEMP
						GROUP BY TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI
						ORDER BY TCKIMLIKNO
						FOR JSON PATH
					) AS T2
					FOR JSON PATH
				) AS J

				DROP TABLE #TEMP
			END

			IF @ISLEM = 9	--	KOPYALA
			BEGIN
				DECLARE @ID_YAZILILISTX TABLE (ID_YAZILI INT)
				INSERT INTO Yazili ([AD],[KOD],[DONEM],[YARIYIL],[ID_YAZILITURU],[ID_KADEME3],[ID_DERS],[YAZILITARIH],[KYE_TCKIMLIKNO],[KYE_TARIH],[AKTIF],[GUN_TARIH],[GUN_TCKIMLIKNO])
				OUTPUT inserted.ID_YAZILI INTO @ID_YAZILILISTX
				SELECT [AD]
					  ,[KOD]
					  ,[DONEM]
					  ,[YARIYIL]
					  ,[ID_YAZILITURU]
					  ,[ID_KADEME3]
					  ,[ID_DERS]
					  ,[YAZILITARIH]
					  ,@TCKIMLIKNO
					  ,GETDATE()
					  ,1
					  ,GETDATE()
					  ,'' 
				FROM Yazili 
				WHERE ID_YAZILI = @ID_YAZILI

				DECLARE @ID_YAZILIX INT = (SELECT ID_YAZILI FROM @ID_YAZILILISTX)  

				INSERT INTO YaziliKademe2 ([ID_YAZILI],[ID_KADEME2])
				SELECT @ID_YAZILIX
					  ,[ID_KADEME2] 
				FROM YaziliKademe2 
				WHERE ID_YAZILI = @ID_YAZILI
			
				INSERT INTO YaziliSoru ([ID_YAZILI],[SORUNO],[PUAN],[KOD])
				SELECT (SELECT ID_YAZILI FROM @ID_YAZILILISTX) AS ID_YAZILI
					  ,[SORUNO]
					  ,[PUAN]
					  ,[KOD] 
				FROM YaziliSoru YS
				WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 10	--	BİLGİ GETİR LİSTE
			BEGIN
				SELECT
				(
					SELECT DONEM
							,ID_KADEME3
							,ID_DERS
							,YARIYIL
							,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON PATH) AS ID_KADEME2 
					FROM Yazili 
					WHERE ID_YAZILI = @ID_YAZILI
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 11	--	LİSTELE SELECT
			BEGIN
				SELECT
				(
					SELECT Y.ID_YAZILI, Y.AD, Y.KOD 
					FROM Yazili			Y
					JOIN YaziliKademe2	K2	ON	K2.ID_YAZILI	= Y.ID_YAZILI
					WHERE	ID_KADEME3	= @ID_KADEME3 
						AND DONEM		= @DONEM 
						AND YARIYIL		= @YARIYIL 
						AND AKTIF		= 1 					
						AND (	
							ID_KADEME2 IN (SELECT ID_KADEME2 FROM OkyanusDB.dbo.v4Sinif S
									INNER JOIN OkyanusDB.dbo.v3KademeBilgi K ON K.ID_KADEME3 = S.ID_KADEME3
									WHERE S.ID_SINIF = @ID_SINIF) 
							OR  ID_KADEME2	= (SELECT ST.ID_KADEME2 FROM OkyanusDB.dbo.v3Sinif S INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU WHERE ID_SINIF = @ID_SINIF))
					GROUP BY Y.ID_YAZILI, Y.AD, Y.KOD
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 12	--	ÖĞRENCİ KAYDET
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
			
				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0

				UPDATE YO SET AKTIF = 0
				FROM YaziliOgrenci YO
				JOIN #TEMPOGRENCI T ON T.ID_YAZILI = YO.ID_YAZILI AND T.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE YO.AKTIF = 1

				DECLARE @ID_YAZILIOGRENCILIST TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST
				SELECT * FROM #TEMPOGRENCI T

				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT ID_YAZILISORU 
						--(	SELECT ID_YAZILIOGRENCI 
						--	FROM YaziliOgrenci 
						--	WHERE ID_YAZILI = 
						--			(	SELECT ID_YAZILI 
						--				FROM YaziliSoru 
						--				WHERE ID_YAZILISORU = OG.ID_YAZILISORU) 
						--		AND TCKIMLIKNO = OG.TCKIMLIKNO 
						--		AND AKTIF = 1 
						--		AND ISNULL(TELAFI, 0) = 0)
						, L.ID_YAZILIOGRENCI
						, PUAN 
						FROM OPENJSON(@SQLJSONOGRENCICEVAP) 
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG	
					JOIN @ID_YAZILIOGRENCILIST L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  		

				DROP TABLE #TEMPOGRENCI
			END

			IF @ISLEM = 13	--	ÖĞRENCİ SİL
			BEGIN
				SELECT ID_YAZILI, OG.TCKIMLIKNO, TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI2
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI INT,
					KATILMADI BIT
				) OG
				UPDATE Y SET AKTIF = 0, SIL_TCKIMLIKNO = @TCKIMLIKNO, SIL_TARIH = GETDATE()
				FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI2 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.AKTIF=1

				DROP TABLE #TEMPOGRENCI2
			END

			IF @ISLEM = 14	--	ÖĞRENCİ KAYDET TOPLU
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI3
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI3 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO

				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0
			
				DECLARE @ID_YAZILIOGRENCILIST2 TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST2
				SELECT * FROM #TEMPOGRENCI3			
			
				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT DISTINCT ID_YAZILISORU
						--, (SELECT ID_YAZILIOGRENCI FROM YaziliOgrenci WHERE ID_YAZILI = (SELECT ID_YAZILI FROM YaziliSoru WHERE ID_YAZILISORU = OG.ID_YAZILISORU) AND TCKIMLIKNO = OG.TCKIMLIKNO AND AKTIF = 1)
						, L.ID_YAZILIOGRENCI
						, PUAN FROM OPENJSON(@SQLJSONOGRENCICEVAP)
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG		
					JOIN @ID_YAZILIOGRENCILIST2 L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  	


				DROP TABLE #TEMPOGRENCI3
			END

			IF @ISLEM = 15	--	Yazılı Listele by Sınıf
			BEGIN
				DECLARE  @ID_DERSLER2	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEM2		VARCHAR(MAX)=@DONEM
						,@YARIYIL2		INT			=@YARIYIL
						,@SINIFLAR2		VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TC
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TC
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLAR2))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (@ID_DERSLER2 IS NULL OR @ID_DERSLER2='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER2)))
						AND (@YARIYIL2 IS NULL OR @YARIYIL2=0 OR sr.YARIYIL = @YARIYIL2)
						and sr.DONEM=@DONEM2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TC
			END 

			IF @ISLEM = 16	--	YAZILI EKLE EXCEL
			BEGIN
				SELECT 
						 AD = JSON_Value (J.value, '$.AD') 
						,KOD = JSON_Value (J.value, '$.KOD')
						,ID_KADEME3 = K3.ID_KADEME3
						,ID_DERS = JSON_Value (J.value, '$.DERS')
						,ID_KADEME2 = K2.value
						,TARIH = JSON_Value (J.value, '$.TARIH')
						,YARIYIL = JSON_Value (J.value, '$.YARIYIL')
						,SORUNO = JSON_Value (S.value, '$.SORUNO')
						,UNITEKOD = JSON_Value (S.value, '$.KOD')
						,PUAN = JSON_Value (S.value, '$.PUAN')
						,ID_YAZILITURU = JSON_Value (J.value, '$.ID_YAZILITURU')
						,ID_BILGI = JSON_Value (S.value, '$.ID_BILGI')
						,ID_BILISSELSUREC = JSON_Value (S.value, '$.ID_BILISSELSUREC')
				INTO #YAZILI
				FROM OPENJSON(@SQLJSON) AS J
				CROSS APPLY OPENJSON (J.value, '$.OKULTUR') as K2
				CROSS APPLY OPENJSON (J.value, '$.SORULIST') as S
				INNER JOIN OkyanusDb.dbo.v3Kademe3 K3 ON K3.AD = JSON_Value (J.value, '$.GRUP')

				DECLARE @ID_YAZILIAD TABLE (ID_YAZILI INT, AD VARCHAR(50))
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI, INSERTED.AD INTO @ID_YAZILIAD(ID_YAZILI, AD)
				SELECT DISTINCT AD, KOD, (select DONEM from [dbo].[v3AktifDonem] where AKTIF=1), YARIYIL, ID_KADEME3, ID_DERS, TARIH, @TCKIMLIKNO, ID_YAZILITURU FROM #YAZILI Y

				INSERT INTO [dbo].[YaziliKademe2]([ID_YAZILI] ,[ID_KADEME2])
				SELECT DISTINCT YA.ID_YAZILI, ID_KADEME2 
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 

				INSERT INTO [dbo].[YaziliSoru]([ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC])
				SELECT DISTINCT YA.ID_YAZILI, Y.SORUNO, ISNULL(Y.PUAN, 0) AS PUAN, Y.UNITEKOD, Y.ID_BILGI, Y.ID_BILISSELSUREC
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 
			
				SELECT MAX(ID_YAZILI) FROM @ID_YAZILIAD

				DROP TABLE #YAZILI
			END

			IF @ISLEM = 17	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET OVGORSUN = @OVGORSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 18	--	AKTIF DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET AKTIF = @AKTIF WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 19	--	YAZILI TÜRÜ LİSTELE
			BEGIN
				SELECT
				(
					SELECT * 
					FROM YaziliTuru
					WHERE AKTIF = 1
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 20	--	YAZILI BİLGİLERİNİ GÜNCELLE (SORULAR HARİÇ)
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILIGUNCELLE
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILIGUNCELLE TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				DROP TABLE #TEMPYAZILIGUNCELLE
				SELECT @ID_YAZILI
			END

			IF @ISLEM = 21	--	Yazılı Listele by Sınıf - KOS
			BEGIN
				DECLARE  @ID_DERSLERKOS	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEMKOS		VARCHAR(MAX)=@DONEM
						,@YARIYILKOS	INT			=@YARIYIL
						,@SINIFLARKOS	VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TCKOS
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TCKOS
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLARKOS))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (@ID_DERSLERKOS IS NULL OR @ID_DERSLERKOS='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLERKOS)))
						AND (@YARIYILKOS IS NULL OR @YARIYILKOS=0 OR sr.YARIYIL = @YARIYILKOS)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TCKOS
			END 

			IF @ISLEM = 22	--	KARNEDEGORUNSUN
			BEGIN
				UPDATE Yazili SET KARNEDEGORUNSUN = @KARNEDEGORUNSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 23	--	YY İşlemleri Excelden Toplu sonuç Yükleme Kayıt Kontrol
			BEGIN
				DECLARE @SINAV_DONEM23 INT=0
				DECLARE @SINAV_GRUP23 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM23 = DONEM , @SINAV_GRUP23 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI

					--Hatalı kayıtları listelemek için hata table'ı oluşturuldu.
				DROP TABLE IF EXISTS #HATALI_DATA
				DROP TABLE IF EXISTS #TEMP_EXCEL_OGRENCI_SONUC
				CREATE TABLE #HATALI_DATA(TCKIMLIKNO VARCHAR(11),HATA VARCHAR(100))

				--Jsondan gelen data örneği
				--SET @SQLJSONOGRENCICEVAP ='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'				

			--JSON'dan GELEN DATA TEMP TABLE'A ATILIYOR
				SELECT TCKIMLIKNO,ID_YAZILI,SORU1,SORU2,SORU3,SORU4,SORU5,SORU6,SORU7,SORU8,SORU9,SORU10,SORU11,SORU12,SORU13,SORU14,SORU15,SORU16,SORU17,SORU18,SORU19,SORU20,TELAFI
				INTO #TEMP_EXCEL_OGRENCI_SONUC
				FROM OPENJSON(@SQLJSONOGRENCICEVAP) WITH(TCKIMLIKNO VARCHAR(11),ID_YAZILI INT,SORU1 INT,SORU2 INT,SORU3 INT,SORU4 INT,SORU5 INT,SORU6 INT,SORU7 INT,SORU8 INT,SORU9 INT,SORU10 INT,SORU11 INT,SORU12 INT,SORU13 INT,SORU14 INT,SORU15 INT,SORU16 INT,SORU17 INT,SORU18 INT,SORU19 INT,SORU20 INT,TELAFI INT)

			--TC KONTROL ve Öğrenci tablosunda olmayan kayıtlar Hata tablosuna ekleniyor. 
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Kayıtlı öğrenci değil'
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
				WHERE NOT EXISTS(SELECT TOP 1 1 FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O WHERE O.TCKIMLIKNO = T.TCKIMLIKNO)
			--TC'si Ogrenci tablosunda olmayan Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--Yazılı Donem Kontrolü - Hatalı döneme sahip öğrenciler Hata tablosuna kayıt ediliyor
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Öğrencinin dönemi hatalı' AS HATA
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T
				WHERE NOT EXISTS(	SELECT TOP 1 1 
									FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
									WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
										AND DONEM		= @SINAV_DONEM23
								)
			--Dönemi Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--GRUP Kontrol
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Öğrencinin grubu hatalı'
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
				WHERE NOT EXISTS(	SELECT TOP 1 1 
									FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
									WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
										AND ID_KADEME3	= @SINAV_GRUP23
								)
			--Grubu Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--MÜKERRER Kayıtlar Belirleniyor 
				INSERT INTO #HATALI_DATA 
				SELECT DISTINCT TCKIMLIKNO, 'Mükerrer Kayıt' 
				FROM #TEMP_EXCEL_OGRENCI_SONUC 
				GROUP BY TCKIMLIKNO 
				HAVING COUNT (TCKIMLIKNO) > 1

			--Mükkerer Kayıtlar TEMP_EXCEL_OGRENCI_SONUC tablosundan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO
			--Hatalı data tablosu geri JSON olarak dönülüyor
				SELECT * FROM #HATALI_DATA FOR JSON AUTO;

			--Temp table'lar silinyor.
				DROP TABLE #HATALI_DATA
 
			END

			IF @ISLEM = 24	--	EXCEL YÜKLEME
			BEGIN
				--@SQLJSONOGRENCICEVAP doğru olarak gelen datalar için CRUD işlemleri yapılıyor
--				DECLARE @SQLJSONOGRENCICEVAP NVARCHAR(MAX)='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":9,"SORU3":8,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'
--DECLARE @ID_YAZILI		INT = 1973
--DECLARE @SINAV_DONEM	INT = 0
--DECLARE @SINAV_GRUP		INT = 0
--DECLARE @TCKIMLIKNO		VARCHAR(MAX) = '32051057542'

				DECLARE @SINAV_DONEM24 INT=0
				DECLARE @SINAV_GRUP24 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM24 = DONEM , @SINAV_GRUP24 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI
				
				DROP TABLE IF EXISTS #EXCEL
				CREATE TABLE #EXCEL (
				TCKIMLIKNO	VARCHAR(MAX),
				SORU1		VARCHAR(MAX),
				SORU2		VARCHAR(MAX),
				SORU3		VARCHAR(MAX),
				SORU4		VARCHAR(MAX),
				SORU5		VARCHAR(MAX),
				SORU6		VARCHAR(MAX),
				SORU7		VARCHAR(MAX),
				SORU8		VARCHAR(MAX),
				SORU9		VARCHAR(MAX),
				SORU10		VARCHAR(MAX),
				SORU11		VARCHAR(MAX),
				SORU12		VARCHAR(MAX),
				SORU13		VARCHAR(MAX),
				SORU14		VARCHAR(MAX),
				SORU15		VARCHAR(MAX),
				SORU16		VARCHAR(MAX),
				SORU17		VARCHAR(MAX),
				SORU18		VARCHAR(MAX),
				SORU19		VARCHAR(MAX),
				SORU20		VARCHAR(MAX),
				TELAFI		VARCHAR(MAX),
				ID_YAZILIOGRENCI INT
				)
				​
				INSERT INTO #EXCEL (TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI) 
				SELECT TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI
				FROM OPENJSON (@SQLJSONOGRENCICEVAP)
				WITH (
					TCKIMLIKNO	VARCHAR(MAX),
					SORU1		VARCHAR(MAX),
					SORU2		VARCHAR(MAX),
					SORU3		VARCHAR(MAX),
					SORU4		VARCHAR(MAX),
					SORU5		VARCHAR(MAX),
					SORU6		VARCHAR(MAX),
					SORU7		VARCHAR(MAX),
					SORU8		VARCHAR(MAX),
					SORU9		VARCHAR(MAX),
					SORU10		VARCHAR(MAX),
					SORU11		VARCHAR(MAX),
					SORU12		VARCHAR(MAX),
					SORU13		VARCHAR(MAX),
					SORU14		VARCHAR(MAX),
					SORU15		VARCHAR(MAX),
					SORU16		VARCHAR(MAX),
					SORU17		VARCHAR(MAX),
					SORU18		VARCHAR(MAX),
					SORU19		VARCHAR(MAX),
					SORU20		VARCHAR(MAX),
					TELAFI		VARCHAR(MAX)
				)

				--SELECT * FROM #EXCEL

				DROP TABLE IF EXISTS #YAZILISORU
				SELECT * INTO #YAZILISORU FROM YaziliSoru WHERE ID_YAZILI = @ID_YAZILI

				--TCKIMLIKNO ve ID_YAZILI ile daha önce eklenen kayıt var ise durumu pasif'e çekiliyor.
				UPDATE Y SET 
					AKTIF = 0 
				FROM YaziliOgrenci Y 
				INNER JOIN #EXCEL O ON O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.ID_YAZILI=@ID_YAZILI
						
				DELETE C
				FROM YaziliOgrenci YO
				JOIN YaziliOgrenciCevap C on C.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF=0

				-- Tüm öğrencilerde dönemi ve grubu olanları al.
				DROP TABLE IF EXISTS #TUM_OGRENCILER
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TUM_OGRENCILER 
				FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] 
				WHERE	ID_KADEME3	= @SINAV_GRUP24
					AND DONEM		= @SINAV_DONEM24
					
				--SELECT * FROM #TUM_OGRENCILER
				DECLARE @INSERTTABLO TABLE (ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(11))
				INSERT INTO YaziliOgrenci(ID_YAZILI,TCKIMLIKNO,KYE_TCKIMLIKNO,KATILMADI,TELAFI)
				OUTPUT inserted.ID_YAZILIOGRENCI,inserted.TCKIMLIKNO INTO @INSERTTABLO(ID_YAZILIOGRENCI,TCKIMLIKNO)
				SELECT	 @ID_YAZILI
						,OT.TCKIMLIKNO
						,@TCKIMLIKNO
						,KATILMADI	= CASE WHEN EXISTS (SELECT TOP 1 1 FROM #EXCEL AS E WHERE E.TCKIMLIKNO = OT.TCKIMLIKNO)
											THEN 0 
											ELSE 1	
										END
						,TELAFI		= (SELECT TOP 1 ISNULL(E.TELAFI,NULL) FROM #EXCEL AS E WHERE OT.TCKIMLIKNO=E.TCKIMLIKNO)
				FROM #TUM_OGRENCILER AS OT

				UPDATE E SET
						E.ID_YAZILIOGRENCI = I.ID_YAZILIOGRENCI
				FROM #EXCEL E
				JOIN  @INSERTTABLO I ON I.TCKIMLIKNO = E.TCKIMLIKNO
 
				DECLARE @sqlCommand varchar(1000)	
				DROP TABLE IF EXISTS #WHILE
				SELECT * INTO #WHILE FROM #YAZILISORU

				WHILE EXISTS( SELECT TOP 1 1 FROM #WHILE)
				BEGIN
					DECLARE @SORUNO VARCHAR(2) = (SELECT TOP 1 CAST(SORUNO AS varchar) FROM #WHILE ORDER BY SORUNO)
					--SET @sqlCommand	= 'SELECT SORU'+ @SORUNO  +' FROM #EXCEL ' 
	
					SET @sqlCommand = 
					'	INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
						SELECT (SELECT TOP 1 ID_YAZILISORU FROM #YAZILISORU YS WHERE YS.SORUNO = '+@SORUNO+') AS ID_YAZILISORU, ID_YAZILIOGRENCI, ISNULL(SORU'+@SORUNO+' ,0) FROM #EXCEL'
					EXEC (@sqlCommand)
				​
					DELETE FROM #WHILE WHERE SORUNO = @SORUNO
				END
 
				DROP TABLE #TUM_OGRENCILER					
			END

			IF @ISLEM = 25	--	YAZILI ÖZELLİKLERİ RAPOR
			BEGIN

				SET @ID_DERS = (SELECT TOP 1 ID_DERS FROM Yazili WHERE ID_YAZILI = @ID_YAZILI)

				CREATE TABLE #UNITE (ID_DERS INT, KOD VARCHAR(50), AD VARCHAR(MAX), SECILEBILIR BIT)

				INSERT INTO #UNITE
				EXEC sp_DersUniteGetir @ID_DERS = @ID_DERS

				SELECT	 [Yazılı Ad]		= Y.AD
						,[Yazılı Kod]		= Y.KOD
						,[Soru No]			= S.SORUNO
						,[Puan]				= S.PUAN
						,[Ünite]			= U.AD
						,[Konu]				= KO.AD
						,[Kazanım]			= KA.AD
						,[Bilgi]			= B.AD
						,[Bilişsel Süreç]	= BS.AD
				FROM Yazili					Y
				JOIN YaziliSoru				S	ON	S.ID_YAZILI			= Y.ID_YAZILI
				LEFT JOIN #UNITE			KA	ON	KA.KOD				= S.KOD AND LEN(S.KOD) = 12
				LEFT JOIN #UNITE			KO	ON	KO.KOD				= SUBSTRING(S.KOD,1,9)
				LEFT JOIN #UNITE			U	ON	U.KOD				= SUBSTRING(S.KOD,1,6)
				LEFT JOIN BilisselSurec		BS	ON	BS.ID_BILISSELSUREC	= S.ID_BILISSELSUREC
				LEFT JOIN Bilgi				B	ON	B.ID_BILGI			= S.ID_BILGI
				WHERE Y.ID_YAZILI = @ID_YAZILI

				DROP TABLE IF EXISTS #UNITE

				
			END

			IF @ISLEM = 26	--	YAZILI BİLDİRİM GÖNDERİLECEK LİSTESİ
			BEGIN
				DECLARE @TARIH				VARCHAR(MAX) = '',
						@YAZILIAD			VARCHAR(MAX) = ''

				SELECT 
					 @TARIH		= CONVERT(VARCHAR,GUN_TARIH,104)
					,@YAZILIAD	= AD
				FROM dbo.Yazili WHERE ID_YAZILI=@ID_YAZILI

				SELECT ISNULL((
					SELECT  
						 TC_GONDEREN		= '14531453'
						,TC_ALAN			= OV.TCKIMLIKNO
						,MESAJ				= @YAZILIAD +' sınav sonucunuzu Okyanus Pusulam sistemimizden inceleyebilirsiniz'
					FROM  dbo.YaziliOgrenci		YO
					JOIN dbo.v3OgrenciVeli		OV	ON	OV.TCKIMLIKNO_OGR	= YO.TCKIMLIKNO
					WHERE ID_YAZILI		= @ID_YAZILI 
						AND KATILMADI	= 0 
						AND OV.AKTIF	= 1
						AND YO.AKTIF	= 1
					ORDER BY OV.TCKIMLIKNO_OGR
					FOR JSON AUTO
				),'[]')
					


			END

		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YaziliYoklamaSonuclari]    Script Date: 23.11.2021 15:42:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YaziliYoklamaSonuclari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAVRAPOR		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_DERSLER			VARCHAR(MAX)	= NULL,
	@YARIYIL			VARCHAR(10)		= NULL,
	@ID_SUBE			INT				= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@SUBELER			VARCHAR(MAX)	= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAVRAPOR				= @ID_SINAVRAPOR	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_DERSLER					= @ID_DERSLER		
			,YARIYIL					= @YARIYIL		
			,ID_SUBE					= @ID_SUBE		
			,SINIFLAR					= @SINIFLAR		
			,SUBELER					= @SUBELER		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE
			 @XISLEM			INT				= @ISLEM			
			,@XTCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO	
			,@XTC_OGRENCI		VARCHAR(11)		= @TC_OGRENCI	
			,@XOTURUM			VARCHAR(36)		= @OTURUM		
			,@XIL				VARCHAR(36)		= @IL			
			,@XILCE				VARCHAR(36)		= @ILCE			
			,@XID_MENU			INT				= @ID_MENU		
			,@XDONEM			char(4)			= @DONEM			
			,@XID_KADEME3		INT				= @ID_KADEME3	
			,@XID_SINAVTURU		INT				= @ID_SINAVTURU	
			,@XID_SINAVRAPOR	INT				= @ID_SINAVRAPOR	
			,@XID_SINAV			INT				= @ID_SINAV		
			,@XID_DERS			INT				= @ID_DERS		
			,@XID_DERSLER		VARCHAR(MAX)	= @ID_DERSLER	
			,@XYARIYIL			VARCHAR(10)		= @YARIYIL		
			,@XID_SUBE			INT				= @ID_SUBE		
			,@XSINIFLAR			VARCHAR(MAX)	= @SINIFLAR		
			,@XSUBELER			VARCHAR(MAX)	= @SUBELER		
			,@XDOSYAADI			varchar(100)	= @DOSYAADI		
			,@XDOSYAGUID		varchar(50)		= @DOSYAGUID		
			,@XID_SINAVDOSYA	int				= @ID_SINAVDOSYA	
			,@XSQLJSON			NVARCHAR(MAX)	= @SQLJSON	


		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1)	--	YaziliYoklamaSonuclari						
		BEGIN
			SELECT   Y.ID_YAZILI							AS ID_SINAVRAPOR	
					,K.AD + ' ' + K.SOYAD					AS ADSOYAD	
					,D.DERSAD								AS DERSAD
					,Y.AD									AS SINAVADI
					,Y.YAZILITARIH							AS SINAVTARIH
					,YS.SORUNO
					,CASE WHEN YO.KATILMADI = 1 THEN ISNULL(YOC.PUAN,'-') else ISNULL(CAST(YOC.PUAN AS VARCHAR(10)),'VERİLMEDİ') end AS PUAN
					,DETAYMI = 1
					,ISNULL(SDU.AD, '')						AS KAZANIM
					,YO.KATILMADI
					,ISNULL(YS.PUAN, 0) as PUANDEGERI
					,(SELECT COUNT(1) FROM YaziliSoru SUBYS WHERE SUBYS.ID_YAZILI = Y.ID_YAZILI) AS SORUSAYISI
					,O.TCKIMLIKNO
					,O.ID_SINIF
					,O.ID_SUBE
					,Y.ID_YAZILITURU
					,KB.ID_KADEME
			INTO #GENEL
			FROM Yazili Y 
			INNER JOIN YaziliSoru						YS	ON	YS.ID_YAZILI			= Y.ID_YAZILI
			INNER JOIN YaziliOgrenci					YO	ON	YO.ID_YAZILI			= Y.ID_YAZILI
			LEFT JOIN  YaziliOgrenciCevap				YOC ON	YOC.ID_YAZILIOGRENCI	= YO.ID_YAZILIOGRENCI 
															AND YOC.ID_YAZILISORU		= YS.ID_YAZILISORU
			INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.TCKIMLIKNO			= YO.TCKIMLIKNO
			INNER JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS				= Y.ID_DERS
			LEFT JOIN  OkyanusDB.dbo.v3SinavDersUnite	SDU ON	SDU.KOD					= YS.KOD
			INNER JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO			= YO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3KademeBilgi		KB	ON	KB.ID_KADEME3			= Y.ID_KADEME3
			WHERE	YOC.PUAN	IS NOT NULL
				AND Y.AKTIF		= 1 
				AND YO.AKTIF	= 1
				AND Y.ID_YAZILI	= @XID_SINAVRAPOR
			GROUP BY Y.ID_YAZILI, D.DERSAD, Y.AD, Y.YAZILITARIH, YS.SORUNO, YOC.PUAN, YO.KATILMADI, YS.PUAN, K.AD, K.SOYAD, SDU.AD, O.TCKIMLIKNO, O.ID_SUBE, O.ID_SINIF, Y.ID_YAZILITURU, KB.ID_KADEME

			SELECT TCKIMLIKNO, ID_SUBE, ID_SINIF, CONVERT(DECIMAL(18,2), SUM(PUAN)) AS TOPLAMPUAN INTO #OGRENCITOPLAM FROM #GENEL GROUP BY TCKIMLIKNO, ID_SUBE, ID_SINIF

			SELECT	 TCKIMLIKNO
					,TOPLAMPUAN
					,GENELSIRA		= DENSE_RANK() OVER(						ORDER BY TOPLAMPUAN DESC)
					,SUBESIRA		= DENSE_RANK() OVER(PARTITION BY ID_SUBE	ORDER BY TOPLAMPUAN DESC)
					,SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINIF	ORDER BY TOPLAMPUAN DESC) 
			INTO #OGRENCISIRA
			FROM #OGRENCITOPLAM

			DECLARE @GENELORTALAMA DECIMAL(18,2)
			SELECT	@GENELORTALAMA = CONVERT(DECIMAL(18,2), AVG(TOPLAMPUAN))
			FROM #OGRENCITOPLAM

			SELECT ID_SUBE, ORTALAMA = CONVERT(DECIMAL(18,2), AVG(TOPLAMPUAN))
			INTO #SUBEORTALAMA
			FROM #OGRENCITOPLAM
			GROUP BY ID_SUBE

			SELECT ID_SINIF, ORTALAMA = CONVERT(DECIMAL(18,2), AVG(TOPLAMPUAN))
			INTO #SINIFORTALAMA
			FROM #OGRENCITOPLAM
			GROUP BY ID_SINIF

			SELECT   G.*
					,S.GENELSIRA
					,S.SUBESIRA
					,S.SINIFSIRA
					,GENELORTALAMA	= @GENELORTALAMA 
					,SUBEORTALAMA	= SBO.ORTALAMA
					,SINIFORTALAMA	= SNO.ORTALAMA
			INTO #T1
			FROM #GENEL G
			INNER JOIN #OGRENCISIRA S ON S.TCKIMLIKNO = G.TCKIMLIKNO
			INNER JOIN #SUBEORTALAMA SBO ON SBO.ID_SUBE = G.ID_SUBE
			INNER JOIN #SINIFORTALAMA SNO ON SNO.ID_SINIF = G.ID_SINIF
			WHERE G.TCKIMLIKNO = @XTC_OGRENCI

			DROP TABLE #GENEL
			DROP TABLE #OGRENCITOPLAM
			DROP TABLE #OGRENCISIRA
			DROP TABLE #SUBEORTALAMA
			DROP TABLE #SINIFORTALAMA

			select(
				select * from(
					select 
					(						 
						SELECT * FROM #T1
						ORDER BY SORUNO , DETAYMI
						FOR JSON AUTO
					) as t1							
				) as tablo FOR JSON AUTO
			) as tt

			DROP TABLE #T1
		END

		IF (@ISLEM = 2)	--	ÖĞRENCİ SINAV LİSTE							
		BEGIN
			SELECT  Y.ID_YAZILI								AS ID_SINAV	
					,Y.AD		
					,CONVERT(VARCHAR, Y.YAZILITARIH, 104)	AS SINAVTARIH
					,Y.DONEM
					,ISNULL(YO.TELAFI, SUM(YOC.PUAN))		AS PUAN
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			WHERE	YO.TCKIMLIKNO = @TC_OGRENCI AND Y.DONEM = @DONEM AND YO.AKTIF = 1 AND (Y.OVGORSUN = 1 OR @OV = 0) AND Y.ID_YAZILITURU = 1 AND Y.AKTIF = 1
			GROUP BY Y.ID_YAZILI, Y.AD, Y.YAZILITARIH, Y.DONEM, YO.TELAFI
		END

		IF (@ISLEM = 3)	--	GENEL YAZILI YOKLAMA SONUÇLARI				
		BEGIN
			--SELECT	o.ID_OGRENCI,
			--		og.OgrNo,
			--		o.ID_SINIF,
			--		sn.AD AS SINIF,
			--		isnull(k.Ad+' '+k.Soyad,'') AS ADSOYAD,
			--		o.SORUNO,
			--		o.PUAN,
			--		s.PUANDEGERI,
			--		isnull(s.KAZANIM,'') AS KONUKODU,
			--		sb.AD AS SUBE
			--	INTO #OGRENCILER
			--   FROM EOKUL_V2.DBO.OgrenciNot		o
		 --INNER JOIN EOKUL_V2.DBO.SinavRaporDetay s	ON s.ID_SINAVRAPOR=o.ID_SINAVRAPOR and s.SORUNO=o.SORUNO 
		 --INNER JOIN v3Ogrenci								og	ON og.ID_OGRENCI=o.ID_OGRENCI
		 --INNER JOIN v3Kullanici								k	ON k.TCKIMLIKNO=og.TCKIMLIKNO
		 --INNER JOIN v3Sinif									sn	ON sn.ID_SINIF=o.ID_SINIF
		 --INNER JOIN v3Sube									sb	ON sb.ID_SUBE=og.ID_SUBE
			--  WHERE o.ID_SINAVRAPOR=@ID_SINAV
			--	AND o.KATILMADI=0
			--	AND (og.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) or @SUBELER='[]' or @SUBELER is null)
			--	AND ((o.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)) or @SINIFLAR='[]' or @SINIFLAR is null))
			--	AND s.SILINDI=0
			SELECT  O.ID_OGRENCI
					,O.OGRNO
					,O.ID_SINIF
					,S.AD AS SINIF
					,K.AD + ' ' + K.SOYAD AS ADSOYAD
					,YS.SORUNO
					,YOC.PUAN
					,YS.PUAN AS PUANDEGERI
					,ISNULL(SDU.AD, '') AS KONUKODU
					,SB.AD AS SUBE
			INTO #OGRENCILER
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
			LEFT JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
			LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			WHERE	Y.ID_YAZILI = @ID_SINAV
				AND YO.KATILMADI = 0
				AND (O.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) or @SUBELER='[]' or @SUBELER is null)
				AND ((O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)) or @SINIFLAR='[]' or @SINIFLAR is null))
				AND YO.AKTIF = 1
		   SELECT
		   (
			   SELECT 
			   (
				   SELECT ID_OGRENCI, OgrNo, ID_SINIF, SINIF, ADSOYAD, SORUNO, PUAN, SUBE FROM #OGRENCILER ORDER BY SUBE,ID_SINIF,OgrNo,SORUNO FOR JSON AUTO
			   ) AS ROWS,
			   (
				   SELECT SORUNO, KONUKODU, PUANDEGERI FROM #OGRENCILER GROUP BY SORUNO, KONUKODU, PUANDEGERI ORDER BY SORUNO FOR JSON AUTO
			   ) AS COLS
			   FOR JSON PATH
		   ) AS J
		   DROP TABLE #OGRENCILER
		END

		IF (@ISLEM = 4)	--	GENEL YAZILI YOKLAMA SINAVLARI				
		BEGIN
			--SELECT DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
			--FROM	EOKUL_V2.DBO.OgrenciNot		O			
			--JOIN	EOKUL_V2.DBO.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
			--JOIN	v3Ogrenci								VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
			--JOIN	v3Kullanici								VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
			--WHERE	SR.DONEMKOD=@DONEM
			--	AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
			--	AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			--	AND (@ID_DERS IS NULL OR sr.ID_DERS=@ID_DERS)
			--	AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
			--	AND sr.isActive=1
			SELECT DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
			FROM	EOKUL_V2.DBO.OgrenciNot		O			
			JOIN	EOKUL_V2.DBO.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
			JOIN	v3Ogrenci								VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
			JOIN	v3Kullanici								VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
			WHERE	SR.DONEMKOD=@DONEM
				AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
				AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
				AND (@ID_DERS IS NULL OR sr.ID_DERS=@ID_DERS)
				AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				AND sr.isActive=1
		END

		IF (@ISLEM = 5 OR @ISLEM = 7)	--	ISLEM 3 YENİ SİSTEM			
		BEGIN
			SELECT DISTINCT O.ID_OGRENCI
					,O.OGRNO
					,O.ID_SINIF
					,S.AD AS SINIF
					,K.AD + ' ' +K.SOYAD AS ADSOYAD
					,YS.SORUNO
					,YOC.PUAN
					,YS.PUAN AS PUANDEGERI
					,ISNULL(SDU.AD, '') AS KONUKODU
					,SB.AD AS SUBE
			INTO #YENIOGRENCILER
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
			WHERE Y.ID_YAZILI = @ID_SINAV AND YO.KATILMADI = 0 AND YO.AKTIF = 1
				AND (O.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) or @SUBELER='[]' or @SUBELER is null)
				AND ((O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)) or @SINIFLAR='[]' or @SINIFLAR is null))
			--ORDER BY OGRNO, SORUNO

			IF @ISLEM = 5
			BEGIN
				SELECT
				(
					SELECT 
					(
					SELECT ID_OGRENCI, OgrNo, ID_SINIF, SINIF, ADSOYAD, SORUNO, PUAN, SUBE FROM #YENIOGRENCILER ORDER BY SUBE,ID_SINIF,OgrNo,SORUNO FOR JSON AUTO
					) AS ROWS,
					(
					SELECT SORUNO, KONUKODU, PUANDEGERI FROM #YENIOGRENCILER GROUP BY SORUNO, KONUKODU, PUANDEGERI ORDER BY SORUNO FOR JSON AUTO
					) AS COLS
					FOR JSON PATH
				) AS J
			END
			ELSE
			BEGIN
				SELECT ID_OGRENCI, OgrNo, ID_SINIF, SINIF, ADSOYAD, SORUNO, PUAN, SUBE FROM #YENIOGRENCILER ORDER BY SUBE,ID_SINIF,OgrNo,SORUNO
				SELECT SORUNO, KONUKODU, PUANDEGERI FROM #YENIOGRENCILER GROUP BY SORUNO, KONUKODU, PUANDEGERI ORDER BY SORUNO
			END
			DROP TABLE #YENIOGRENCILER
		END

		IF (@ISLEM = 6)	--	GENEL YAZILI YOKLAMA SINAVLARI YENİ SİSTEM	
		BEGIN
			SELECT DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
			FROM	EOKUL_V2.DBO.OgrenciNot		O			
			JOIN	EOKUL_V2.DBO.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
			JOIN	v3Ogrenci								VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
			JOIN	v3Kullanici								VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
			WHERE	SR.DONEMKOD=@DONEM
				AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
				AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
				AND (@ID_DERS IS NULL OR sr.ID_DERS=@ID_DERS)
				AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				AND sr.isActive=1
		END

		IF (@ISLEM = 8)	--	KOS RAPORU									
		BEGIN
			DECLARE @YAZILIDONEM VARCHAR(4) = (SELECT DONEM FROM Yazili WHERE ID_YAZILI = @XID_SINAVRAPOR)

			SELECT YS.*
			INTO #YAZILISORU
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			WHERE Y.ID_YAZILI = @XID_SINAVRAPOR

			SELECT   YO.TCKIMLIKNO
					,YS.SORUNO
					,SDU.AD AS KAZANIM
					,YOC.PUAN
					,YS.PUAN AS PUANSORU
					,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
			INTO #YAZILISORUOGRENCI
			FROM #YAZILISORU YS 
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = YS.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			WHERE	YO.ID_YAZILI = @XID_SINAVRAPOR
				AND YO.AKTIF = 1			
				AND YO.KATILMADI = 0
				AND (@XSUBELER IS NULL OR @XSUBELER='[]' OR @XSUBELER='' OR O.ID_SUBE IN (SELECT value FROM OPENJSON(@XSUBELER)))
				AND (@XSINIFLAR IS NULL OR @XSINIFLAR='[]' OR @XSUBELER='' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@XSINIFLAR)))
				AND (@XTC_OGRENCI IS NULL OR @XTC_OGRENCI = '' OR YO.TCKIMLIKNO = @XTC_OGRENCI)

			SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
			INTO #YAZILIOGRENCITOPLAMPUAN
			FROM #YAZILISORUOGRENCI YOS
			GROUP BY YOS.TCKIMLIKNO

			SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
			FROM #YAZILIOGRENCITOPLAMPUAN YOP
			INNER JOIN KosYorum KY ON KY.BASPUAN <= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM = @YAZILIDONEM
			INNER JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
			ORDER BY ADSOYAD

			SELECT	 TCKIMLIKNO
					,SORUNO
					,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
					,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
							WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
							WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
							WHEN PUANORAN < 40						THEN '1'
					 END AS DURUM
			FROM #YAZILISORUOGRENCI

			DROP TABLE #YAZILIOGRENCITOPLAMPUAN
			DROP TABLE #YAZILISORUOGRENCI
			DROP TABLE #YAZILISORU
		END

		IF (@ISLEM = 9)	--	ÖĞRENCİ KOS LİSTE							
		BEGIN
			SELECT
			(
				SELECT DISTINCT Y.ID_YAZILI, Y.AD
				FROM Yazili Y 
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				WHERE YO.TCKIMLIKNO = @TC_OGRENCI AND Y.AKTIF = 1 AND Y.OVGORSUN = 1 AND Y.ID_YAZILITURU = 2 AND YO.AKTIF = 1 AND Y.DONEM = @DONEM
				FOR JSON AUTO
			) AS J
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YetenekGelisim]    Script Date: 23.11.2021 15:42:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YetenekGelisim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_KATEGORIOGRENCI	INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_KATEGORITAVSIYE	INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,	
	@ACIKLAMA			VARCHAR(MAX)	= NULL,	
	@OGRENCIYILDIZLIST	VARCHAR(MAX)	= NULL,	
	@SQLJSON			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_SINIF					= @ID_SINIF			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_KATEGORIOGRENCI			= @ID_KATEGORIOGRENCI	
			,ID_KATEGORI				= @ID_KATEGORI		
			,ID_KATEGORITAVSIYE			= @ID_KATEGORITAVSIYE	
			,TC_OGRENCI					= @TC_OGRENCI			
			,DONEM						= @DONEM				
			,ID_SINIFs					= @ID_SINIFs			
			,ACIKLAMA					= @ACIKLAMA			
			,OGRENCIYILDIZLIST			= @OGRENCIYILDIZLIST	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	KATEGORİ LİSTESİ			
		BEGIN
			SELECT (
				SELECT K.ID_KATEGORI	'ID_KATEGORI'
					,K.AD				'KATEGORI'
					,Y.ID_KATEGORI		'Y.ID_ALTKATEGORI'
					,Y.ID_USTKATEGORI	'Y.ID_USTKATEGORI'
					,Y.AD				'Y.KATEGORI'
				FROM YG_Kategori K
				LEFT JOIN YG_Kategori Y ON Y.ID_USTKATEGORI = K.ID_KATEGORI
				WHERE	K.ID_USTKATEGORI IS NULL		
				FOR JSON AUTO
			)
		END

		IF @ISLEM = 2	--	OGRENCI 1. SINIF KATEGORI	
		BEGIN

			SELECT @ID_KADEME3= ID_KADEME3 FROM vw_SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF

			IF @ID_KADEME3 = 7	--	1. SINIF
			BEGIN
				select(
						select * from(
							select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.ID_SINIF
										,O.DONEM

										,YK.ID_KATEGORI
										,YK.AD KATEGORI

										,KOY.PUAN

								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON K.TCKIMLIKNO				= O.TCKIMLIKNO
								CROSS JOIN	YG_Kategori				YK	
								LEFT JOIN	YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO			= O.TCKIMLIKNO
																		AND KO.DONEM				= O.DONEM
								LEFT JOIN	YG_KategoriOgrenciYorum	KOY	ON	KOY.ID_KATEGORI			= YK.ID_KATEGORI
																		AND KOY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI										
								WHERE	O.ID_SINIF = @ID_SINIF
									AND YK.ID_USTKATEGORI IS NULL AND YK.ID_KATEGORI NOT IN (13,20)
								ORDER BY ADSOYAD,ID_KATEGORI
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE,
							(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL AND ID_KATEGORI NOT IN (13,20)
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
						) as tablo FOR JSON AUTO
					) as tt
			END	
			ELSE IF @ID_KADEME3 > 7
			BEGIN
				select(
					select * from(
						select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
								FROM v3OgrenciTum				O
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci	KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
																AND KO.DONEM		= O.DONEM
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE						
						) as tablo FOR JSON AUTO
					) as tt

			END
					
		END

		IF @ISLEM = 3	--	YORUM PUAN KAYDET			
		BEGIN
			
					
			SELECT	
				 TCKIMLIKNO	
				,ADSOYAD		
				,ID_SINIF	
				,DONEM		
				,YK.ID_KATEGORI
				,YK.PUAN
				,0 ID_KATEGORIOGRENCI
			INTO #KAYIT
			FROM OPENJSON (@SQLJSON)
			WITH ( 
				TCKIMLIKNO	VARCHAR(11)		'$.TCKIMLIKNO',
				ADSOYAD		VARCHAR(100)	'$.ADSOYAD',
				ID_SINIF	INT				'$.ID_SINIF',
				DONEM		VARCHAR(4)		'$.DONEM',
				YK			NVARCHAR(MAX)	'$.YK' AS JSON
			) AS J
			CROSS APPLY OPENJSON (YK) 
			WITH(
				ID_KATEGORI VARCHAR(11) '$.ID_KATEGORI',
				PUAN		INT			'$.KOY[0].PUAN'
			) AS YK
			WHERE PUAN IS NOT NULL
			

			
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #OGRLIST FROM #KAYIT K JOIN YG_KategoriOgrenci O ON O.TCKIMLIKNO = K.TCKIMLIKNO AND O.DONEM = K.DONEM 
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #EKSIKOGRLIST FROM #KAYIT K WHERE K.TCKIMLIKNO NOT IN (SELECT DISTINCT TCKIMLIKNO FROM #OGRLIST) 
			

			INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,ID_KADEME3,DONEM,TC_OGRETMEN)
			SELECT E.TCKIMLIKNO,S.ID_KADEME3,E.DONEM,@TCKIMLIKNO 
			FROM #EKSIKOGRLIST		 E
			JOIN vw_SubeGrupSinifTum S	ON	S.ID_SINIF	= E.ID_SINIF 
										AND S.ID_KADEME3= 7					--	1. SINIFLAR SADECE 

			UPDATE K SET
				K.ID_KATEGORIOGRENCI = O.ID_KATEGORIOGRENCI
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO
										AND O.DONEM			= K.DONEM


			DELETE Y 
			FROM YG_KategoriOgrenciYorum	Y 
			JOIN #KAYIT						K	ON	K.ID_KATEGORIOGRENCI = Y.ID_KATEGORIOGRENCI
			
			INSERT INTO YG_KategoriOgrenciYorum	 (ID_KATEGORIOGRENCI,ID_KATEGORI,PUAN)
			SELECT K.ID_KATEGORIOGRENCI,K.ID_KATEGORI,K.PUAN 
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci O ON O.ID_KATEGORIOGRENCI = K.ID_KATEGORIOGRENCI

			SELECT 1 

			DROP TABLE #EKSIKOGRLIST
			DROP TABLE #OGRLIST
			DROP TABLE #KAYIT

			


		END

		IF @ISLEM = 4	--	OGRENCI ESKI GELISIMLERI	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
										,KO.DONEM
										,KO.ID_KADEME3 
										,KO.ID_KATEGORITAVSIYE
										,ILKSINIF	= (SELECT   ID_KATEGORI= OY.ID_KATEGORI
																,KATEGORI	= YK.AD
																,PUAN		= OY.PUAN
																,DERECE		= Y.DERECE
														FROM YG_KategoriOgrenciYorum	OY
														JOIN YG_Kategori				YK	ON	YK.ID_KATEGORI	= OY.ID_KATEGORI
														JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI	= OY.ID_KATEGORI
																							AND Y.MIN_YORUM		< OY.PUAN
																							AND Y.MAX_YORUM		> OY.PUAN
														WHERE OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
														ORDER BY ID_KATEGORI
														FOR JSON PATH,INCLUDE_NULL_VALUES
													)
										,DIGER		= (	SELECT	 ID_KATEGORI	= PK.ID_KATEGORI
																,KATEGORI		= PK.AD
																,ID_KATEGORIPUAN= KP.ID_KATEGORIPUAN
																,KATEGORIPUAN	= KP.AD
																,PUAN			= P.PUAN
														FROM YG_KategoriPuan				KP		
														LEFT JOIN YG_KategoriOgrenciPuan	P	ON	KP.ID_KATEGORIPUAN	= P.ID_KATEGORIPUAN
																								AND P.ID_KATEGORIOGRENCI= KO.ID_KATEGORIOGRENCI
														LEFT JOIN YG_Kategori				PK	ON	PK.ID_KATEGORI		= KO.ID_KATEGORI
														ORDER BY ID_KATEGORIPUAN
														FOR JSON AUTO,INCLUDE_NULL_VALUES
													)			
										,OK.AD+' ' + OK.SOYAD OGRETMENADSOYAD
										,KADEME3	= K3.AD
								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN v3Kullanici				OK	ON	OK.TCKIMLIKNO	= KO.TC_OGRETMEN
								LEFT JOIN v3Kademe3					K3	ON	K3.ID_KADEME3	= KO.ID_KADEME3
								WHERE O.TCKIMLIKNO	= @TC_OGRENCI 
									AND ID_SINIF	= @ID_SINIF
								ORDER BY ADSOYAD,KO.DONEM
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS  OGRENCIGECMIS
							,(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL		
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
							,(
								SELECT	 K.ID_KATEGORIPUAN	'ID_KATEGORIPUAN'
										,K.AD				'KATEGORIPUAN'
										,PUAN	=0
								FROM YG_KategoriPuan K								
								ORDER BY ID_KATEGORIPUAN
								FOR JSON PATH
							) AS  KATEGORIPUAN
							,(								
								SELECT *
								FROM YG_Kategori		K
								LEFT JOIN (
									SELECT *
									FROM YG_Kategori
									WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
								)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
								WHERE K.ID_USTKATEGORI IS NULL
								ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
								FOR JSON AUTO
							) AS YETENEKDERSLIST
							,(								
								SELECT * FROM YG_KateroriTavsiye 
								ORDER BY ID_KATEGORITAVSIYE
								FOR JSON AUTO
							) AS KATEGORITAVSIYELIST
							,(								
								SELECT @DONEM AKTIFDONEM
								FOR JSON PATH
							) AS AKTIFDONEM
						) as tablo FOR JSON AUTO
					) as tt

		END

		IF @ISLEM = 5	--	KARNE						
		BEGIN
			
			SELECT @ID_KADEME3 = ID_KADEME3
			FROM YG_KategoriOgrenci
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI 

			SELECT 
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,OGRETMENADSOYAD= ORT.AD+' '+ORT.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= CASE WHEN @ID_KADEME3 = 7 THEN 'MY TALENT JOURNEY' ELSE ISNULL(K.AD,'') END
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN v3Kullanici			ORT ON	ORT.TCKIMLIKNO	= KO.TC_OGRETMEN
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	KO.ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
					AND K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
													AND KO.ID_KATEGORIOGRENCI	= @ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END


		END

		IF @ISLEM = 6	--	PUAN KAYDET					
		BEGIN
		
			SET @ID_KADEME3	= (SELECT ID_KADEME3 FROM v3Ogrenci O JOIN vw_SubeGrupSinif GS ON GS.ID_SINIF = O.ID_SINIF WHERE TCKIMLIKNO = @TC_OGRENCI)
			IF @ID_KADEME3 IS NOT NULL
			BEGIN
				SET @ID_KATEGORIOGRENCI = (SELECT ID_KATEGORIOGRENCI FROM YG_KategoriOgrenci KO WHERE KO.TCKIMLIKNO = @TC_OGRENCI AND KO.DONEM = @DONEM)

				DELETE OP 
				FROM YG_KategoriOgrenciPuan OP
				WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

				IF @ID_KATEGORIOGRENCI IS NULL
				BEGIN
					DECLARE @IDTABLE TABLE (ID INT)

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,DONEM,ID_KADEME3,ID_KATEGORI,TC_OGRETMEN,ID_KATEGORITAVSIYE)
					OUTPUT (inserted.ID_KATEGORIOGRENCI) INTO @IDTABLE
					VALUES (@TC_OGRENCI,@DONEM,@ID_KADEME3,@ID_KATEGORI,@TCKIMLIKNO,@ID_KATEGORITAVSIYE)

					SET @ID_KATEGORIOGRENCI = (SELECT TOP 1 ID FROM @IDTABLE)
				END
				ELSE
				BEGIN
					UPDATE YG_KategoriOgrenci SET
						ID_KATEGORI = @ID_KATEGORI,
						TC_OGRETMEN = @TCKIMLIKNO,
						ID_KATEGORITAVSIYE = @ID_KATEGORITAVSIYE
					WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
				END

			
				INSERT INTO YG_KategoriOgrenciPuan 
						(ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN)			
				SELECT	@ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN  
				FROM OPENJSON(@OGRENCIYILDIZLIST)
				WITH (
					ID_KATEGORIPUAN INT,
					PUAN			INT
				)

				SELECT 1 			
			END
			ELSE
				SELECT 0

		END
		
		IF @ISLEM = 7	--	TOPLU KARNE					
		BEGIN
			
			SELECT YO.ID_KATEGORIOGRENCI, ID_KADEME3
			INTO #OGRECILIST7
			FROM YG_KategoriOgrenci	YO
			JOIN v3OgrenciTum		OT	ON	OT.TCKIMLIKNO	= YO.TCKIMLIKNO
										AND OT.DONEM		= YO.DONEM
			WHERE OT.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			
			SELECT TOP 1 @ID_KADEME3 = ID_KADEME3
			FROM #OGRECILIST7

			SELECT DISTINCT
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= ISNULL(K.AD,'')
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN #OGRECILIST7			OL	ON	OL.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END

			DROP TABLE IF EXISTS #OGRECILIST7

		END

		IF @ISLEM = 8	--	YETENEK GELİŞİM KATEGORILER	
		BEGIN
			SELECT ISNULL((	SELECT *
							FROM YG_Kategori		K
							LEFT JOIN (
								SELECT *
								FROM YG_Kategori
								WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
							)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
							WHERE K.ID_USTKATEGORI IS NULL
							ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
							FOR JSON AUTO
						),'[]' )AS YETENEKDERSLIST
		END

		IF @ISLEM = 9	--	YG DERS ACIKLAMA EKLE		
		BEGIN
			UPDATE YG_Kategori SET 
				ACIKLAMA = CASE WHEN @ACIKLAMA = '' THEN NULL ELSE @ACIKLAMA END 
			WHERE ID_KATEGORI = @ID_KATEGORI
		END

		IF @ISLEM = 10	--	YG DERS ACIKLAMA GETİR		
		BEGIN
			SELECT ISNULL((
				SELECT	 ID_KATEGORI
						,ISNULL(ACIKLAMA,'') AS ACIKLAMA 
				FROM YG_Kategori  
				WHERE ID_KATEGORI = @ID_KATEGORI 
				FOR JSON AUTO, INCLUDE_NULL_VALUES
			),'[]' )
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_Karne]    Script Date: 23.11.2021 15:42:42 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_Karne]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINIF					= @ID_SINIF	
			,TC_OGRENCI					= @TC_OGRENCI	
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	OGRENCI LIST
		BEGIN
			select 
			(		
				SELECT	 O.TCKIMLIKNO
						,O.ID_SINIF
						,O.DONEM
						,ADSOYAD			= K.AD+' ' + K.SOYAD
						,ID_KATEGORIOGRENCI	= ISNULL(KO.ID_KATEGORIOGRENCI,0)
						,SINIFAD			= GS.SINIF
						,GS.SUBEAD
						,GS.ID_KADEME3
				FROM v3OgrenciTum					O
				JOIN v3Kullanici					K	ON K.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN vw_SubeGrupSinifTum			GS	ON	GS.ID_SINIF		= O.ID_SINIF
				LEFT JOIN	YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
														AND KO.DONEM		= O.DONEM
														AND (	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciYorum	Y WHERE Y.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
															OR	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciPuan	P WHERE P.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
															)															
				WHERE	O.ID_SINIF = @ID_SINIF						
				ORDER BY ADSOYAD
				FOR JSON PATH,INCLUDE_NULL_VALUES
			) AS OGRENCILISTE
		END

		IF @ISLEM = 2	--	OGRENCI KARNE LIST
		BEGIN
			SELECT 
			(		
				SELECT	 O.TCKIMLIKNO
						,O.ID_SINIF
						,O.DONEM
						,ADSOYAD			= K.AD+' ' + K.SOYAD 
						,ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
						,SINIFAD			= GS.SINIF
						,GS.SUBEAD
						,GS.ID_KADEME3
				FROM v3OgrenciTum			O
				JOIN v3Kullanici			K	ON K.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
				JOIN YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
												AND KO.DONEM		= O.DONEM
				WHERE	O.TCKIMLIKNO = @TC_OGRENCI
					AND (	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciYorum	Y WHERE Y.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
						OR	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciPuan	P WHERE P.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
						)
				ORDER BY DONEM DESC
				FOR JSON PATH,INCLUDE_NULL_VALUES
			) AS OGRENCILISTE
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_KotaBelirle]    Script Date: 23.11.2021 15:42:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_KotaBelirle]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@KOTALISTE				VARCHAR(MAX)= NULL,
	@DONEM					VARCHAR(MAX)= NULL,
	@ID_SUBELIST			VARCHAR(MAX)= NULL,
	@ID_KADEME3				INT			= NULL,
	@ID_SUBE				INT			= NULL,
	@ID_KATEGORI			INT			= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,ID_KATEGORI	= @ID_KATEGORI				
				,DONEM			= @DONEM						
				,KOTALISTE		= @KOTALISTE					
				,ID_KADEME3		= @ID_KADEME3			
				,ID_SUBE		= @ID_SUBE					
				,ID_SUBELIST	= @ID_SUBELIST				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT * FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	KOTA LISTELE	
			BEGIN

				--DECLARE @ID_KATEGORI INT = 6
				--DECLARE @DONEM VARCHAR(4)='2018'

				DROP TABLE IF EXISTS #SADECEILKSINIF
				DROP TABLE IF EXISTS #BUTUNSINIFLAR
				DROP TABLE IF EXISTS #BIRHARIC
				DROP TABLE IF EXISTS #YETENEKDERSLIST
				DROP TABLE IF EXISTS #KADEMELIST
				DROP TABLE IF EXISTS #SINIFLIST
				DROP TABLE IF EXISTS #SINIFYAZ


				SELECT K.*,SINIFLAR = CAST(1 AS INT)
				INTO #SADECEILKSINIF
				FROM YG_Kategori K
				WHERE	ID_USTKATEGORI IS NULL
					AND EXISTS (SELECT * FROM YG_Kategori G WHERE G.ID_USTKATEGORI = K.ID_KATEGORI)

				-- BÜTÜN HEPSİ
				SELECT K.*,SINIFLAR = CAST(0 AS INT)
				INTO #BUTUNSINIFLAR
				FROM YG_Kategori K
				WHERE	ID_USTKATEGORI IS NULL
					AND	NOT	EXISTS (SELECT * FROM #SADECEILKSINIF G WHERE G.ID_KATEGORI = K.ID_KATEGORI)

				-- BİR HARİÇ
				SELECT K.*,SINIFLAR = CAST(-1 AS INT)
				INTO #BIRHARIC
				FROM YG_Kategori K
				WHERE	NOT	EXISTS (SELECT * FROM #SADECEILKSINIF G WHERE G.ID_KATEGORI = K.ID_KATEGORI)
					AND NOT	EXISTS (SELECT * FROM #BUTUNSINIFLAR  G WHERE G.ID_KATEGORI = K.ID_KATEGORI)


					SELECT * INTO #YETENEKDERSLIST FROM #SADECEILKSINIF
				UNION 
					SELECT * FROM #BUTUNSINIFLAR
				UNION 
					SELECT * FROM #BIRHARIC
				ORDER BY ID_KATEGORI


				SELECT DISTINCT ID_KADEME3 
				INTO #KADEMELIST
				FROM v3KademeBilgi KB
				WHERE ID_KADEME IN (3,4,5)


				SELECT YK.ID_KATEGORI, K.ID_KADEME3, K.AD KADEME3, SB.AD SUBEAD, SB.ID_SUBE, ISNULL(KK.KOTA,0) KOTA
				INTO #SINIFLIST
				FROM YG_Kategori	YK
				JOIN #YETENEKDERSLIST		DL	ON	DL.ID_KATEGORI	= YK.ID_KATEGORI
				CROSS APPLY #KADEMELIST		KL 
				JOIN v3Kademe3				K	ON	K.ID_KADEME3	= KL.ID_KADEME3
				CROSS APPLY v3Sube			SB	
				LEFT JOIN YG_KategoriKota	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3
												AND KK.ID_SUBE		= SB.ID_SUBE
												AND KK.ID_KATEGORI	= YK.ID_KATEGORI
												AND KK.DONEM		= @DONEM
												AND KK.AKTIF		= 1
				WHERE	YK.ID_KATEGORI	= @ID_KATEGORI
					AND (	(DL.SINIFLAR	= 1		AND	K.ID_KADEME3	= 7)		-- 7  =>	1. SINIF
						OR	(DL.SINIFLAR	= -1	AND	K.ID_KADEME3	NOT IN (7))
						OR	(DL.SINIFLAR	= 0		AND	K.ID_KADEME3	NOT IN (7))
						)


				SELECT DISTINCT K.SIRA, SL.KADEME3, SL.ID_KADEME3 INTO #SINIFYAZ FROM #SINIFLIST SL JOIN v3Kademe3 K ON K.ID_KADEME3 = SL.ID_KADEME3 ORDER BY K.SIRA

				
				SELECT	KADEME3, 
						SUBEAD, 
						KOTA, 
						ID_KADEME3, 
						ID_SUBE,  
						OGRENCISAYISI = (
								SELECT COUNT(*) 
								FROM YG_KategoriOgrenci YO 
								JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = YO.DONEM
								WHERE YO.ID_KADEME3 = S.ID_KADEME3 AND YO.ID_KATEGORI = S.ID_KATEGORI AND O.ID_SUBE = S.ID_SUBE AND YO.DONEM = @DONEM
								),

						TOPLAMKOTA = (
								SELECT ISNULL(SUM(KOTA),0)
								FROM YG_KategoriKota	K
								WHERE	K.ID_KADEME3	= S.ID_KADEME3
									AND K.ID_SUBE		= S.ID_SUBE
									AND K.DONEM			= @DONEM
									AND K.AKTIF			= 1
						),
						SECIMYAPANOGRENCISAYISI = (											
								SELECT COUNT(*) 
								FROM YG_KategoriOgrenci YO 
								JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = YO.DONEM
								WHERE	YO.ID_KADEME3	= S.ID_KADEME3 
									AND O.ID_SUBE		= S.ID_SUBE 
									AND YO.DONEM		= @DONEM
						),
						TOPLAMOGRENCISAYISI = (	
								SELECT COUNT(*)
								FROM OkyanusDB.DBO.v3Ogrenci		O
								JOIN OkyanusDB.DBO.vw_SubeGrupSinif	GS	ON	GS.ID_SINIF	= O.ID_SINIF
								WHERE	O.ID_SUBE		= S.ID_SUBE
									AND GS.ID_KADEME3	= S.ID_KADEME3
						)
				INTO #LIST
				FROM #SINIFLIST S	

				SELECT (
					SELECT * FROM (
						SELECT (						
							SELECT * 
								,SECIMYAPMAYANOGRENCISAYISI = TOPLAMOGRENCISAYISI - SECIMYAPANOGRENCISAYISI
							FROM #LIST 
							WHERE ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
							FOR JSON AUTO
						) AS KOTALISTE,
						(
							SELECT DISTINCT KADEME3, ID_KADEME3 FROM #SINIFYAZ ORDER BY ID_KADEME3
							FOR JSON AUTO
						) AS KADEME3LISTE,
						(
							SELECT DISTINCT SUBEAD, ID_SUBE FROM #SINIFLIST
							WHERE ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) 
							ORDER BY SUBEAD
							FOR JSON AUTO
						) AS SUBELISTE
					)AS J
					FOR JSON PATH
				)AS JS

			
				DROP TABLE IF EXISTS #SADECEILKSINIF
				DROP TABLE IF EXISTS #BUTUNSINIFLAR
				DROP TABLE IF EXISTS #BIRHARIC
				DROP TABLE IF EXISTS #YETENEKDERSLIST
				DROP TABLE IF EXISTS #KADEMELIST
				DROP TABLE IF EXISTS #SINIFLIST
				DROP TABLE IF EXISTS #SINIFYAZ
				DROP TABLE IF EXISTS #LIST


				/*

				SET @ID_KATEGORI = 6

				DECLARE @cols VARCHAR(MAX)
				SET @cols = STUFF((	SELECT ',' +  QUOTENAME( C.KADEME3)  FROM #SINIFYAZ AS c ORDER BY SIRA FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

				SELECT @cols

				SELECT * FROM (
					SELECT KADEME3, SUBEAD, KOTA FROM #SINIFLIST
				)AS D
				PIVOT (SUM(KOTA) FOR KADEME3 IN ([2. Sınıf],[3. Sınıf],[4. Sınıf],[5. Sınıf],[6. Sınıf],[7. Sınıf],[8. Sınıf],[9. Sınıf],[10. Sınıf],[11. Sınıf],[12. Sınıf]) ) AS P

				*/
			END

			IF @ISLEM = 2	--	KOTA BELİRLE	
			BEGIN
				DROP TABLE IF EXISTS #KOTALISTE

				SELECT * 
				INTO #KOTALISTE
				FROM OPENJSON (@KOTALISTE)
				WITH(	ID_KADEME3	INT,
						ID_SUBE		INT,
						KOTA		INT
					)
				ORDER BY ID_SUBE


				UPDATE K SET
					AKTIF = 0
				FROM YG_KategoriKota	K				
				WHERE	ID_KATEGORI	= @ID_KATEGORI					
					AND DONEM		= @DONEM
					AND ID_SUBE		IN (SELECT ID_SUBE FROM #KOTALISTE L )

				INSERT INTO YG_KategoriKota (DONEM, ID_KATEGORI, ID_KADEME3, ID_SUBE, KOTA, KYE_TCKIMLIKNO)
				SELECT @DONEM, @ID_KATEGORI, ID_KADEME3, ID_SUBE, KOTA, @TCKIMLIKNO FROM #KOTALISTE
				WHERE KOTA IS NOT NULL AND KOTA > 0

				DROP TABLE IF EXISTS #KOTALISTE
			END
			
			IF @ISLEM = 3	--	ÖĞRENCİ BOŞALT
			BEGIN
				
				DELETE KO
				FROM YG_KategoriOgrenci			KO
				JOIN OkyanusDB.DBO.v3OgrenciTum	O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
													AND O.DONEM			= KO.DONEM
				WHERE	ID_KATEGORI	= @ID_KATEGORI
					AND KO.DONEM	= @DONEM
					AND ID_KADEME3	= @ID_KADEME3
					AND O.ID_SUBE	= @ID_SUBE
					
			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO





USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_MevcutDagilim]    Script Date: 23.11.2021 15:43:16 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_MevcutDagilim]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
				--DECLARE @DONEM VARCHAR(4) = '2018'

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #TEMP_TBL

				SELECT	 GS.ID_SUBE
						,SUBEAD		= UPPER(GS.SUBEAD)
						,GS.ID_KADEME3
						,KADEME3	= UPPER(GS.KADEME3)
						,K.ID_KATEGORI
						,KATEGORI	= UPPER(K.AD)
						,OGRSAY		= COUNT(DISTINCT YO.TCKIMLIKNO) 
				INTO #TEMP
				FROM YG_KategoriOgrenci				YO
				LEFT JOIN YG_KategoriOgrenciYorum	Y	ON	Y.ID_KATEGORIOGRENCI = YO.ID_KATEGORIOGRENCI
				LEFT JOIN YG_Kategori				K	ON	K.ID_KATEGORI	= YO.ID_KATEGORI
														OR	K.ID_KATEGORI	= Y.ID_KATEGORI
				JOIN v3OgrenciTum					O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
														AND O.DONEM			= YO.DONEM
				JOIN vw_SubeGrupSinifTum			GS	ON	GS.ID_SINIF		= O.ID_SINIF
														AND GS.ID_KADEME3	= YO.ID_KADEME3
				WHERE	YO.DONEM = @DONEM
				GROUP BY GS.ID_SUBE, GS.ID_KADEME3, K.ID_KATEGORI, GS.KADEME3, K.AD, GS.SUBEAD
				ORDER BY ID_SUBE, ID_KADEME3,KATEGORI


				DECLARE @SQL VARCHAR(MAX)
				DECLARE @SQL2 VARCHAR(MAX) = ''
				DECLARE @colsKademe3 VARCHAR(MAX)
				--DECLARE @colsKademe3AD VARCHAR(MAX)

				SET @colsKademe3	= STUFF((	SELECT ',' +  QUOTENAME( C.KADEME3)		FROM (SELECT DISTINCT ID_KADEME3, KADEME3	FROM #TEMP)	c ORDER BY ID_KADEME3	FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
				--SET @colsKademe3AD	= STUFF((	SELECT ',' +  QUOTENAME( C.KADEME3)		FROM (SELECT DISTINCT ID_KADEME3, KADEME3	FROM #TEMP)	c ORDER BY ID_KADEME3	FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')


				DROP TABLE IF EXISTS #TEMP_TBL
				CREATE TABLE #TEMP_TBL( [KAMPÜS]	VARCHAR(MAX),
										[KATEGORI]	VARCHAR(MAX))
						
				SELECT DISTINCT T.KADEME3, T.ID_KADEME3 INTO #DONGU FROM #TEMP T
				WHILE EXISTS(SELECT * FROM #DONGU)
				BEGIN
					DECLARE @KADEME3 VARCHAR(MAX) 
					DECLARE @ID_KADEME3 INT 

					SELECT TOP 1 @KADEME3 = KADEME3, @ID_KADEME3 = ID_KADEME3 FROM #DONGU ORDER BY ID_KADEME3

					SET @SQL2  = @SQL2 + ' ALTER TABLE #TEMP_TBL ADD ['+CAST(@KADEME3 AS varchar)+'] DECIMAL(8,2) '

					DELETE FROM #DONGU WHERE ID_KADEME3 = @ID_KADEME3
				END

				PRINT @SQL2
				EXEC(@SQL2)

				SET @SQL = '
							INSERT INTO #TEMP_TBL ([KAMPÜS], KATEGORI,'+@colsKademe3+')
							SELECT SUBEAD, KATEGORI,'+@colsKademe3+' FROM (
								SELECT 
									SUBEAD
									,KADEME3
									--,ID_KATEGORI
									,KATEGORI	
									,OGRSAY		
								FROM #TEMP
							) AS D
							PIVOT (MAX(OGRSAY) FOR KADEME3 IN ('+@colsKademe3+')) AS P
						'

				PRINT @SQL
				EXEC (@SQL)

				
				IF @ISLEM = 1	--	JSON
				BEGIN				
					
					SELECT ISNULL((
						SELECT T.KATEGORI, K.* FROM #TEMP_TBL T
						JOIN #TEMP_TBL K ON K.KATEGORI = T.KATEGORI AND K.[KAMPÜS] = T.[KAMPÜS]
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					),'[]')

				END

				IF @ISLEM = 2	--	DATASET
				BEGIN
				
					SELECT * FROM #TEMP_TBL

					SELECT DISTINCT KATEGORI FROM #TEMP ORDER BY KATEGORI

				END


				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #TEMP_TBL

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_OgrenciSecimRaporu]    Script Date: 23.11.2021 15:44:07 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_OgrenciSecimRaporu]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@ID_SUBEs				VARCHAR(MAX)= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
				,ID_SUBEs		= @ID_SUBEs
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME,@IP=@IP
		
		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	Rapor
			BEGIN
				SELECT SB.AD AS KAMPUS, S.AD AS SINIF, K.AD + ' ' + K.SOYAD AS ADSOYAD, KG.AD AS KULUP
				FROM YG_KategoriOgrenci YO
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = YO.DONEM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN YG_Kategori KG ON KG.ID_KATEGORI = YO.ID_KATEGORI
				WHERE  YO.DONEM = @DONEM
				AND ((@ID_SUBEs = '[]' AND O.ID_SUBE IN (SELECT ID_SUBE FROM OkyanusDB.dbo.v3SubeYetki SY WHERE SY.TCKIMLIKNO = @TCKIMLIKNO)) OR O.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs)))
				AND YO.ID_KADEME3 <> 7
				ORDER BY YO.ID_KADEME3, KAMPUS, SINIF, ADSOYAD				
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_Secim]    Script Date: 23.11.2021 15:44:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_Secim]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@TC_OGRENCI				VARCHAR(MAX)= NULL,
	@ID_KATEGORI			INT			= NULL,
	@TARIH_KONTROL			BIT			= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	

	DECLARE 
		@SUB_DONEM					VARCHAR(MAX)= @DONEM		,
		@SUB_TC_OGRENCI				VARCHAR(MAX)= @TC_OGRENCI	,
		@SUB_ID_KATEGORI			INT			= @ID_KATEGORI
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @SUB_DONEM
				,TC_OGRENCI		= @SUB_TC_OGRENCI
				,ID_KATEGORI	= @SUB_ID_KATEGORI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		
		IF @_ID_LOG > 0
		BEGIN
		
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @SUB_DONEM)
				SET @SUB_DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	SEÇİLEBİLECEK YETENEK DERS LİSTESİ	
			BEGIN
				
				SET @SUB_DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
				DROP TABLE IF EXISTS #KOTAOGRENCI1
					DROP TABLE IF EXISTS #TEMP1
					CREATE TABLE #KOTAOGRENCI1(KOTA INT,DONEM VARCHAR(4),ID_KADEME3 INT,ID_KATEGORI INT,ID_SUBE INT,OGRSAY INT)

				IF @TARIH_KONTROL  = 1 
				BEGIN
					INSERT INTO #KOTAOGRENCI1 (KOTA,DONEM,ID_KADEME3,ID_KATEGORI,ID_SUBE,OGRSAY)
					SELECT	KK.KOTA,
						KK.DONEM,
						KK.ID_KADEME3,
						KK.ID_KATEGORI,
						KK.ID_SUBE,
						OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
											FROM YG_KategoriOgrenci YO	
											JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																			AND KK.ID_SUBE		= O.ID_SUBE		
											WHERE	KK.DONEM		= YO.DONEM
												AND KK.ID_KADEME3	= YO.ID_KADEME3		
												AND YO.ID_KATEGORI	= KK.ID_KATEGORI
										),0)
				
				FROM YG_KategoriKota		KK
				JOIN YG_KategoriSecimTarih	ST	ON	ST.DONEM	= KK.DONEM				
				WHERE	KK.DONEM	= @SUB_DONEM
					AND KK.AKTIF	= 1
					AND ST.AKTIF	= 1
					

				END
				ELSE 
				BEGIN 
					INSERT INTO #KOTAOGRENCI1 (KOTA,DONEM,ID_KADEME3,ID_KATEGORI,ID_SUBE,OGRSAY)
					SELECT	KK.KOTA,
						KK.DONEM,
						KK.ID_KADEME3,
						KK.ID_KATEGORI,
						KK.ID_SUBE,
						OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
											FROM YG_KategoriOgrenci YO	
											JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																			AND KK.ID_SUBE		= O.ID_SUBE		
											WHERE	KK.DONEM		= YO.DONEM
												AND KK.ID_KADEME3	= YO.ID_KADEME3		
												AND YO.ID_KATEGORI	= KK.ID_KATEGORI
										),0)				
				FROM YG_KategoriKota		KK
				JOIN YG_KategoriSecimTarih	ST	ON	ST.DONEM	= KK.DONEM
				--JOIN OkyanusDB.DBO.vw_SinifOgrenci	SO	ON	SO.TCKIMLIKNO	= @SUB_TC_OGRENCI
				--JOIN OkyanusDB.DBO.vw_v4SinifDetay	SD	ON	SD.ID_SINIF	= SO.ID_SINIF
				--										AND SD.ID_SUBE	= KK.ID_SUBE
				--										AND SD.ID_KADEME3= KK.ID_KADEME3
				WHERE	KK.DONEM	= @SUB_DONEM
					AND KK.AKTIF	= 1
					AND ST.AKTIF	= 1
					AND (	(	EXISTS		(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							AND ST.ESKI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.ESKI_BIT_TARIH >= CAST(GETDATE() AS date)
							)
						OR	(	
							
								ST.YENI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.YENI_BIT_TARIH >= CAST(GETDATE() AS date)
							)				
						)
				END
				

				DECLARE @SECILECEKDERSYOK BIT = 0
				IF NOT EXISTS (SELECT TOP 1 1 FROM #KOTAOGRENCI1)
				BEGIN
					
					SET @SECILECEKDERSYOK  = 1

					INSERT INTO #KOTAOGRENCI1
					SELECT	KK.KOTA,
							KK.DONEM,
							KK.ID_KADEME3,
							KK.ID_KATEGORI,
							KK.ID_SUBE,
							OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
												FROM YG_KategoriOgrenci YO	
												JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																				AND KK.ID_SUBE		= O.ID_SUBE		
												WHERE	KK.DONEM		= YO.DONEM
													AND KK.ID_KADEME3	= YO.ID_KADEME3		
													AND YO.ID_KATEGORI	= KK.ID_KATEGORI
											),0)


					FROM YG_KategoriOgrenci		KO
					JOIN YG_Kategori			K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
					JOIN YG_KategoriKota		KK	ON	KK.ID_KATEGORI	= K.ID_KATEGORI
													AND KK.DONEM		= KO.DONEM
					WHERE	KO.DONEM	= @SUB_DONEM
						AND TCKIMLIKNO	= @SUB_TC_OGRENCI
						AND KK.AKTIF	= 1
				END
					
					
				SELECT	 KO.DONEM
						,KO.ID_KADEME3
						,KO.ID_KATEGORI
						,KO.ID_SUBE
						,KO.KOTA
						,KO.OGRSAY
						,KALANKONTEJAN	= KO.KOTA - KO.OGRSAY 
						,K.AD
						,K.ACIKLAMA
						,K.ID_USTKATEGORI
						,SECILI = CASE WHEN SO.ID_KATEGORI IS NULL THEN 0 ELSE 1 END
				INTO #TEMP1
				FROM #KOTAOGRENCI1		KO
				JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
				JOIN v3Ogrenci			O	ON	O.ID_SUBE		= KO.ID_SUBE
				JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= O.ID_SINIF
											AND GS.ID_KADEME3	= KO.ID_KADEME3	
				LEFT JOIN YG_KategoriOgrenci SO	ON	SO.DONEM		= KO.DONEM
												AND SO.ID_KATEGORI	= KO.ID_KATEGORI
												AND SO.ID_KADEME3	= KO.ID_KADEME3
												AND SO.TCKIMLIKNO	= @SUB_TC_OGRENCI
				WHERE	O.TCKIMLIKNO	= @SUB_TC_OGRENCI
					AND	((SO.ID_KATEGORI IS NULL AND KO.KOTA	> KO.OGRSAY) OR SO.ID_KATEGORI IS NOT NULL)
				
				DECLARE @YETENEKDERS VARCHAR(MAX) = (SELECT TOP 1 K.AD
													FROM YG_KategoriOgrenci	KO
													JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
													WHERE	DONEM		= @SUB_DONEM
														AND TCKIMLIKNO	= @SUB_TC_OGRENCI)

				DECLARE @SECIMTARIH BIT = 0
				IF EXISTS (	SELECT TOP 1 1
							FROM YG_KategoriSecimTarih 
							WHERE	DONEM = @SUB_DONEM
								AND AKTIF = 1
								AND	(	CAST(GETDATE() AS date) BETWEEN ESKI_BAS_TARIH AND ESKI_BIT_TARIH
									OR	CAST(GETDATE() AS date) BETWEEN YENI_BAS_TARIH AND YENI_BIT_TARIH)
						)
					SET @SECIMTARIH = 1

				
				SELECT(
						SELECT (
								SELECT ISNULL(( SELECT *
									FROM #TEMP1
									ORDER BY SECILI DESC, AD
									FOR JSON AUTO, INCLUDE_NULL_VALUES
								),'[]')					
						)AS LIST,
						(
							SELECT @SECIMTARIH SECIMTARIH, @YETENEKDERS YETENEKDERS,@SECILECEKDERSYOK SECILECEKDERSYOK 
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS SECIM
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)


				--SELECT ISNULL(( SELECT *
				--				FROM #TEMP1
				--				ORDER BY SECILI DESC, AD
				--				FOR JSON AUTO
				--			),'[]')

				
				DROP TABLE IF EXISTS #KOTAOGRENCI1
				DROP TABLE IF EXISTS #TEMP1



			END

			IF @ISLEM = 2	--	YETENEK DERSİ SEÇ					
			BEGIN
			
				DROP TABLE IF EXISTS #KOTAOGRENCI2
				DROP TABLE IF EXISTS #TEMP2
				SET @SUB_DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				CREATE TABLE #KOTAOGRENCI2(KOTA INT,DONEM VARCHAR(4),ID_KADEME3 INT,ID_KATEGORI INT,ID_SUBE INT,OGRSAY INT)

				IF @TARIH_KONTROL = 1
				BEGIN
					INSERT INTO #KOTAOGRENCI2 (KOTA,DONEM,ID_KADEME3,ID_KATEGORI,ID_SUBE,OGRSAY)
					SELECT	
						KK.KOTA,
						KK.DONEM,
						KK.ID_KADEME3,
						KK.ID_KATEGORI,
						KK.ID_SUBE,
						OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
											FROM YG_KategoriOgrenci		YO	
											JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																			AND O.ID_SUBE		= KK.ID_SUBE		
											WHERE	YO.DONEM		= KK.DONEM
												AND YO.ID_KADEME3	= KK.ID_KADEME3	
												AND YO.ID_KATEGORI	= KK.ID_KATEGORI	
										),0)
				
					FROM YG_KategoriKota		KK
					JOIN YG_KategoriSecimTarih	ST	ON	ST.DONEM	= KK.DONEM
					WHERE	KK.DONEM	= @SUB_DONEM
						AND KK.AKTIF	= 1
						AND ST.AKTIF	= 1
					
				END
				BEGIN
				    INSERT INTO #KOTAOGRENCI2 (KOTA,DONEM,ID_KADEME3,ID_KATEGORI,ID_SUBE,OGRSAY)
					SELECT	KK.KOTA,
						KK.DONEM,
						KK.ID_KADEME3,
						KK.ID_KATEGORI,
						KK.ID_SUBE,
						OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
											FROM YG_KategoriOgrenci		YO	
											JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																			AND O.ID_SUBE		= KK.ID_SUBE		
											WHERE	YO.DONEM		= KK.DONEM
												AND YO.ID_KADEME3	= KK.ID_KADEME3	
												AND YO.ID_KATEGORI	= KK.ID_KATEGORI	
										),0)
				FROM YG_KategoriKota		KK
				JOIN YG_KategoriSecimTarih	ST	ON	ST.DONEM	= KK.DONEM
				WHERE	KK.DONEM	= @SUB_DONEM
					AND KK.AKTIF	= 1
					AND ST.AKTIF	= 1
					AND (	(	EXISTS		(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							AND ST.ESKI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.ESKI_BIT_TARIH >= CAST(GETDATE() AS date)
							)
						OR	(	
							--	NOT EXISTS	(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							--AND 
								ST.YENI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.YENI_BIT_TARIH >= CAST(GETDATE() AS date)
							)				
						)
				END
				
										
				SELECT	 KO.DONEM
						,KO.ID_KADEME3
						,KO.ID_KATEGORI
						,KO.ID_SUBE
						,KO.KOTA
						,KO.OGRSAY
						,KO.KOTA - KO.OGRSAY AS KALANKONTEJAN
						,K.AD
						,K.ACIKLAMA
				INTO #TEMP2
				FROM #KOTAOGRENCI2		KO
				JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
				JOIN v3Ogrenci			O	ON	O.ID_SUBE		= KO.ID_SUBE
				JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= O.ID_SINIF
											AND GS.ID_KADEME3	= KO.ID_KADEME3			
				WHERE	O.TCKIMLIKNO	= @SUB_TC_OGRENCI
					AND KO.ID_KATEGORI	= @SUB_ID_KATEGORI
					AND	KO.KOTA			> KO.OGRSAY
					
				IF ( SELECT TOP 1 KALANKONTEJAN FROM #TEMP2 ) > 0
				BEGIN

					DELETE YG_KategoriOgrenci WHERE TCKIMLIKNO = @SUB_TC_OGRENCI AND DONEM = @SUB_DONEM

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO, DONEM, ID_KADEME3, ID_KATEGORI)
					SELECT TOP 1 TCKIMLIKNO, @SUB_DONEM, GS.ID_KADEME3, @SUB_ID_KATEGORI FROM v3Ogrenci O JOIN vw_SubeGrupSinif GS ON GS.ID_SINIF = O.ID_SINIF WHERE TCKIMLIKNO = @SUB_TC_OGRENCI
					
				END
				ELSE 
				BEGIN
					
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Seçmek İstediğiniz Yetenek Dersinin Kontejanı Dolmuştur. Farklı Bir Yetenek Dersini Seçiniz.', @SEVERITY = 16, @STATE = 1, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 3

				END

				DROP TABLE IF EXISTS #KOTAOGRENCI2				
				DROP TABLE IF EXISTS #TEMP2
			END
			IF @ISLEM = 3	--	YETENEK DERSİ KALDIR	
			BEGIN
				SET @SUB_DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				DELETE YG_KategoriOgrenci WHERE TCKIMLIKNO = @SUB_TC_OGRENCI AND DONEM = @SUB_DONEM
			END
			IF @ISLEM = 4 --	8 VE 11 SINIFLAR KLÜBE KAYITLIYSA SEÇİM YAPAMAZ	
			BEGIN
				CREATE TABLE #RESULT( TC VARCHAR(11), SONUC BIT)

				IF EXISTS(SELECT KK.ID_KADEME3 FROM OkyanusDB..v3KullaniciKademe3 KK WHERE KK.TCKIMLIKNO = @SUB_TC_OGRENCI AND KK.ID_KADEME3 IN (SELECT K.ID_KADEME3 FROM OkyanusDB..v3Kademe3 K WHERE K.DUZEY IN ('8', '11')))
				BEGIN
					DECLARE @KulupPeriyotId INT= (
					SELECT TOP 1 KP.ID_KULUPPERIYOT
					FROM KulupPeriyot KP 
					WHERE KP.BAS_TARIH <= CAST(GETDATE() AS DATE) AND KP.BIT_TARIH >= CAST(GETDATE() AS DATE)
					);	

					IF EXISTS(SELECT K.ID_KULUPOGRENCI FROM KulupOgrenci K WHERE K.TCKIMLIKNO = @SUB_TC_OGRENCI AND ID_KULUPPERIYOT = @KulupPeriyotId)
					BEGIN
						INSERT #RESULT(TC, SONUC) VALUES (@SUB_TC_OGRENCI, 0)
					END
					ELSE 
					BEGIN
						INSERT #RESULT(TC, SONUC) VALUES (@SUB_TC_OGRENCI, 1)
					END
				END
				ELSE
				BEGIN
						INSERT #RESULT(TC, SONUC) VALUES (@SUB_TC_OGRENCI, 1)
				END
				
				
				SELECT TOP 1 TC, SONUC FROM #RESULT FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
				DROP TABLE #RESULT
			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_SecimAyar]    Script Date: 23.11.2021 15:44:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_SecimAyar]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@ESKI_BAS_TARIH			VARCHAR(MAX)= NULL,
	@ESKI_BIT_TARIH			VARCHAR(MAX)= NULL,
	@YENI_BAS_TARIH			VARCHAR(MAX)= NULL,
	@YENI_BIT_TARIH			VARCHAR(MAX)= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
				,ESKI_BAS_TARIH	= @ESKI_BAS_TARIH
				,ESKI_BIT_TARIH	= @ESKI_BIT_TARIH
				,YENI_BAS_TARIH	= @YENI_BAS_TARIH
				,YENI_BIT_TARIH	= @YENI_BIT_TARIH
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	SECİM TARİHİ BELİRLE
			BEGIN
				
				UPDATE YG_KategoriSecimTarih SET 
					AKTIF = 0
				WHERE DONEM = @DONEM

				INSERT INTO YG_KategoriSecimTarih (DONEM, ESKI_BAS_TARIH, ESKI_BIT_TARIH, YENI_BAS_TARIH, YENI_BIT_TARIH, KYE_TCKIMLIKNO)
				VALUES (@DONEM, @ESKI_BAS_TARIH, @ESKI_BIT_TARIH, @YENI_BAS_TARIH, @YENI_BIT_TARIH, @TCKIMLIKNO)

			END

			IF @ISLEM = 2	--	AKTAR
			BEGIN
								
				IF EXISTS (	SELECT TOP 1 1 
							FROM YG_KategoriOgrenci	O
							WHERE DONEM = @DONEM
								AND (	EXISTS (SELECT * FROM YG_KategoriOgrenciPuan	P	WHERE	P.ID_KATEGORIOGRENCI	= O.ID_KATEGORIOGRENCI)
									OR	EXISTS (SELECT * FROM YG_KategoriOgrenciYorum	y	WHERE	y.ID_KATEGORIOGRENCI	= O.ID_KATEGORIOGRENCI))
							)
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Seçili Döneme Ait Puan Girişi Yapıldığından Dolayı Aktarım Gerçekleştiremezsiniz. ', @SEVERITY = 16, @STATE = 1, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 3
				END
				ELSE 
				BEGIN

					DELETE FROM YG_KategoriOgrenci WHERE DONEM= @DONEM

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO, DONEM, ID_KADEME3, ID_KATEGORITAVSIYE, ID_KATEGORI, TC_OGRETMEN)
					SELECT TCKIMLIKNO, @DONEM, ID_KADEME3 + 1, ID_KATEGORITAVSIYE, ID_KATEGORI, TC_OGRETMEN 
					FROM YG_KategoriOgrenci 
					WHERE	DONEM = CAST( (CAST(@DONEM AS INT)-1) AS varchar) 
						AND ID_KADEME3 NOT IN (7,18)	
						--	7   => 1.  Sınıf
						--	18  => 12. Sınıf


						--AND ID_KATEGORI NOT IN (SELECT DISTINCT K.ID_KATEGORI
						--						FROM YG_Kategori K
						--						WHERE	ID_USTKATEGORI IS NULL
						--							AND EXISTS (SELECT * FROM YG_Kategori G WHERE G.ID_USTKATEGORI = K.ID_KATEGORI)
						--						) -- SADECE 1. SINIFLARIN SEÇEBİLECEĞİ YETENEKLER
					ORDER BY ID_KATEGORIOGRENCI
	
				END


			END
			
			IF @ISLEM = 3	--	TARİH GETİR
			BEGIN
				SELECT ISNULL((
					SELECT DONEM, ESKI_BAS_TARIH, ESKI_BIT_TARIH, YENI_BAS_TARIH, YENI_BIT_TARIH FROM YG_KategoriSecimTarih
					WHERE	DONEM = @DONEM
						AND AKTIF = 1
					FOR JSON AUTO
				),'[]')

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_SecimYapmayanlar]    Script Date: 23.11.2021 15:44:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_SecimYapmayanlar]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@DONEM					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_SUBELIST			= @ID_SUBELIST				
				,DONEM					= @DONEM	
				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	TERCİH LİSTESİ			
			BEGIN
				SELECT ISNULL((
					SELECT OD.*
					FROM v3OgrenciTum						O
					JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.TCKIMLIKNO	= O.TCKIMLIKNO
																AND OD.ID_SINIF		= O.ID_SINIF
					JOIN OkyanusDB.DBO.v3Kademe3			K3	ON	K3.ID_KADEME3	= OD.ID_KADEME3	AND K3.ID_KADEME3 NOT IN(3,4,5,6,7)
					JOIN OPENJSON(@ID_SUBELIST)				SL	ON	SL.VALUE		= O.ID_SUBE
					WHERE	O.DONEM	= @DONEM
						AND NOT EXISTS (	SELECT TCKIMLIKNO
											FROM YG_KategoriOgrenci	KO
											WHERE	KO.TCKIMLIKNO	= O.TCKIMLIKNO
												AND KO.DONEM		= O.DONEM
										)
					ORDER BY SUBEAD, KADEME3SIRA, SINIFAD, AD, SOYAD
					FOR JSON AUTO
				),'[]')
			END
			
			IF @ISLEM = 2	--	TERCİH LİSTESİ RAPOR		
			BEGIN

					SELECT	 [KAMPÜS]	= OD.SUBEAD
                            ,GRUP		= OD.KADEME3
                            ,SINIF		= OD.SINIFAD
                            ,TCKIMLIKNO	= OD.TCKIMLIKNO
                            ,AD			= OD.AD
                            ,SOYAD		= OD.SOYAD
							,KADEME3SIRA
					FROM v3OgrenciTum						O
					JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.TCKIMLIKNO	= O.TCKIMLIKNO
																AND OD.ID_SINIF		= O.ID_SINIF
					JOIN OkyanusDB.DBO.v3Kademe3			K3	ON	K3.ID_KADEME3	= OD.ID_KADEME3	AND K3.ID_KADEME3 NOT IN(3,4,5,6,7)
					JOIN OPENJSON(@ID_SUBELIST)				SL	ON	SL.VALUE		= O.ID_SUBE
					WHERE	O.DONEM	= @DONEM
						AND NOT EXISTS (	SELECT TCKIMLIKNO
											FROM YG_KategoriOgrenci	KO
											WHERE	KO.TCKIMLIKNO	= O.TCKIMLIKNO
												AND KO.DONEM		= O.DONEM
										)										

			END



		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_YetenekGelisim]    Script Date: 23.11.2021 15:45:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_YetenekGelisim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_KATEGORIOGRENCI	INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_KATEGORITAVSIYE	INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,	
	@ACIKLAMA			VARCHAR(MAX)	= NULL,	
	@OGRENCIYILDIZLIST	VARCHAR(MAX)	= NULL,	
	@SQLJSON			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_SINIF					= @ID_SINIF			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_KATEGORIOGRENCI			= @ID_KATEGORIOGRENCI	
			,ID_KATEGORI				= @ID_KATEGORI		
			,ID_KATEGORITAVSIYE			= @ID_KATEGORITAVSIYE	
			,TC_OGRENCI					= @TC_OGRENCI			
			,DONEM						= @DONEM				
			,ID_SINIFs					= @ID_SINIFs			
			,ACIKLAMA					= @ACIKLAMA			
			,OGRENCIYILDIZLIST			= @OGRENCIYILDIZLIST	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	KATEGORİ LİSTESİ			
		BEGIN
			SELECT (
				SELECT K.ID_KATEGORI	'ID_KATEGORI'
					,K.AD				'KATEGORI'
					,Y.ID_KATEGORI		'Y.ID_ALTKATEGORI'
					,Y.ID_USTKATEGORI	'Y.ID_USTKATEGORI'
					,Y.AD				'Y.KATEGORI'
				FROM YG_Kategori K
				LEFT JOIN YG_Kategori Y ON Y.ID_USTKATEGORI = K.ID_KATEGORI
				WHERE	K.ID_USTKATEGORI IS NULL		
				FOR JSON AUTO
			)
		END

		IF @ISLEM = 2	--	OGRENCI 1. SINIF KATEGORI	
		BEGIN

			SELECT @ID_KADEME3= ID_KADEME3 FROM vw_SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF

			IF @ID_KADEME3 = 7	--	1. SINIF
			BEGIN
				select(
						select * from(
							select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.ID_SINIF
										,O.DONEM

										,YK.ID_KATEGORI
										,YK.AD KATEGORI

										,KOY.PUAN

								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON K.TCKIMLIKNO				= O.TCKIMLIKNO
								CROSS JOIN	YG_Kategori				YK	
								LEFT JOIN	YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO			= O.TCKIMLIKNO
																		AND KO.DONEM				= O.DONEM
								LEFT JOIN	YG_KategoriOgrenciYorum	KOY	ON	KOY.ID_KATEGORI			= YK.ID_KATEGORI
																		AND KOY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI										
								WHERE	O.ID_SINIF = @ID_SINIF
									AND YK.ID_USTKATEGORI IS NULL AND YK.ID_KATEGORI NOT IN (13,20)
								ORDER BY ADSOYAD,ID_KATEGORI
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE,
							(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL AND ID_KATEGORI NOT IN (13,20)
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
						) as tablo FOR JSON AUTO
					) as tt
			END	
			ELSE IF @ID_KADEME3 > 7
			BEGIN
				select(
					select * from(
						select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
								FROM v3OgrenciTum				O
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci	KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
																AND KO.DONEM		= O.DONEM
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE						
						) as tablo FOR JSON AUTO
					) as tt

			END
					
		END

		IF @ISLEM = 3	--	YORUM PUAN KAYDET			
		BEGIN
			
					
			SELECT	
				 TCKIMLIKNO	
				,ADSOYAD		
				,ID_SINIF	
				,DONEM		
				,YK.ID_KATEGORI
				,YK.PUAN
				,0 ID_KATEGORIOGRENCI
			INTO #KAYIT
			FROM OPENJSON (@SQLJSON)
			WITH ( 
				TCKIMLIKNO	VARCHAR(11)		'$.TCKIMLIKNO',
				ADSOYAD		VARCHAR(100)	'$.ADSOYAD',
				ID_SINIF	INT				'$.ID_SINIF',
				DONEM		VARCHAR(4)		'$.DONEM',
				YK			NVARCHAR(MAX)	'$.YK' AS JSON
			) AS J
			CROSS APPLY OPENJSON (YK) 
			WITH(
				ID_KATEGORI VARCHAR(11) '$.ID_KATEGORI',
				PUAN		INT			'$.KOY[0].PUAN'
			) AS YK
			WHERE PUAN IS NOT NULL
			

			
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #OGRLIST FROM #KAYIT K JOIN YG_KategoriOgrenci O ON O.TCKIMLIKNO = K.TCKIMLIKNO AND O.DONEM = K.DONEM 
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #EKSIKOGRLIST FROM #KAYIT K WHERE K.TCKIMLIKNO NOT IN (SELECT DISTINCT TCKIMLIKNO FROM #OGRLIST) 
			

			INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,ID_KADEME3,DONEM,TC_OGRETMEN)
			SELECT E.TCKIMLIKNO,S.ID_KADEME3,E.DONEM,@TCKIMLIKNO 
			FROM #EKSIKOGRLIST		 E
			JOIN vw_SubeGrupSinifTum S	ON	S.ID_SINIF	= E.ID_SINIF 
										AND S.ID_KADEME3= 7					--	1. SINIFLAR SADECE 

			UPDATE K SET
				K.ID_KATEGORIOGRENCI = O.ID_KATEGORIOGRENCI
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO
										AND O.DONEM			= K.DONEM


			DELETE Y 
			FROM YG_KategoriOgrenciYorum	Y 
			JOIN #KAYIT						K	ON	K.ID_KATEGORIOGRENCI = Y.ID_KATEGORIOGRENCI
			
			INSERT INTO YG_KategoriOgrenciYorum	 (ID_KATEGORIOGRENCI,ID_KATEGORI,PUAN)
			SELECT K.ID_KATEGORIOGRENCI,K.ID_KATEGORI,K.PUAN 
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci O ON O.ID_KATEGORIOGRENCI = K.ID_KATEGORIOGRENCI

			SELECT 1 

			DROP TABLE #EKSIKOGRLIST
			DROP TABLE #OGRLIST
			DROP TABLE #KAYIT

			


		END

		IF @ISLEM = 4	--	OGRENCI ESKI GELISIMLERI	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
										,KO.DONEM
										,KO.ID_KADEME3 
										,KO.ID_KATEGORITAVSIYE
										,ILKSINIF	= (SELECT   ID_KATEGORI= OY.ID_KATEGORI
																,KATEGORI	= YK.AD
																,PUAN		= OY.PUAN
																,DERECE		= Y.DERECE
														FROM YG_KategoriOgrenciYorum	OY
														JOIN YG_Kategori				YK	ON	YK.ID_KATEGORI	= OY.ID_KATEGORI
														JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI	= OY.ID_KATEGORI
																							AND Y.MIN_YORUM		< OY.PUAN
																							AND Y.MAX_YORUM		> OY.PUAN
														WHERE OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
														ORDER BY ID_KATEGORI
														FOR JSON PATH,INCLUDE_NULL_VALUES
													)
										,DIGER		= (	SELECT	 ID_KATEGORI	= PK.ID_KATEGORI
																,KATEGORI		= PK.AD
																,ID_KATEGORIPUAN= KP.ID_KATEGORIPUAN
																,KATEGORIPUAN	= KP.AD
																,PUAN			= P.PUAN
														FROM YG_KategoriPuan				KP		
														LEFT JOIN YG_KategoriOgrenciPuan	P	ON	KP.ID_KATEGORIPUAN	= P.ID_KATEGORIPUAN
																								AND P.ID_KATEGORIOGRENCI= KO.ID_KATEGORIOGRENCI
														LEFT JOIN YG_Kategori				PK	ON	PK.ID_KATEGORI		= KO.ID_KATEGORI
														ORDER BY ID_KATEGORIPUAN
														FOR JSON AUTO,INCLUDE_NULL_VALUES
													)			
										,OK.AD+' ' + OK.SOYAD OGRETMENADSOYAD
										,KADEME3	= K3.AD
								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN v3Kullanici				OK	ON	OK.TCKIMLIKNO	= KO.TC_OGRETMEN
								LEFT JOIN v3Kademe3					K3	ON	K3.ID_KADEME3	= KO.ID_KADEME3
								WHERE O.TCKIMLIKNO	= @TC_OGRENCI 
									AND ID_SINIF	= @ID_SINIF
								ORDER BY ADSOYAD,KO.DONEM
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS  OGRENCIGECMIS
							,(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL		
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
							,(
								SELECT	 K.ID_KATEGORIPUAN	'ID_KATEGORIPUAN'
										,K.AD				'KATEGORIPUAN'
										,PUAN	=0
								FROM YG_KategoriPuan K								
								ORDER BY ID_KATEGORIPUAN
								FOR JSON PATH
							) AS  KATEGORIPUAN
							,(								
								SELECT *
								FROM YG_Kategori		K
								LEFT JOIN (
									SELECT *
									FROM YG_Kategori
									WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
								)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
								WHERE K.ID_USTKATEGORI IS NULL
								ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
								FOR JSON AUTO
							) AS YETENEKDERSLIST
							,(								
								SELECT * FROM YG_KateroriTavsiye 
								ORDER BY ID_KATEGORITAVSIYE
								FOR JSON AUTO
							) AS KATEGORITAVSIYELIST
							,(								
								SELECT @DONEM AKTIFDONEM
								FOR JSON PATH
							) AS AKTIFDONEM
						) as tablo FOR JSON AUTO
					) as tt

		END

		IF @ISLEM = 5	--	KARNE						
		BEGIN
			
			SELECT @ID_KADEME3 = ID_KADEME3
			FROM YG_KategoriOgrenci
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI 

			SELECT 
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,OGRETMENADSOYAD= ORT.AD+' '+ORT.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= CASE WHEN @ID_KADEME3 = 7 THEN 'MY TALENT JOURNEY' ELSE ISNULL(K.AD,'') END
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN v3Kullanici			ORT ON	ORT.TCKIMLIKNO	= KO.TC_OGRETMEN
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	KO.ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
					AND K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
													AND KO.ID_KATEGORIOGRENCI	= @ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END


		END

		IF @ISLEM = 6	--	PUAN KAYDET					
		BEGIN
		
			SET @ID_KADEME3	= (SELECT ID_KADEME3 FROM v3Ogrenci O JOIN vw_SubeGrupSinif GS ON GS.ID_SINIF = O.ID_SINIF WHERE TCKIMLIKNO = @TC_OGRENCI)
			IF @ID_KADEME3 IS NOT NULL
			BEGIN
				SET @ID_KATEGORIOGRENCI = (SELECT ID_KATEGORIOGRENCI FROM YG_KategoriOgrenci KO WHERE KO.TCKIMLIKNO = @TC_OGRENCI AND KO.DONEM = @DONEM)

				DELETE OP 
				FROM YG_KategoriOgrenciPuan OP
				WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

				IF @ID_KATEGORIOGRENCI IS NULL
				BEGIN
					DECLARE @IDTABLE TABLE (ID INT)

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,DONEM,ID_KADEME3,ID_KATEGORI,TC_OGRETMEN,ID_KATEGORITAVSIYE)
					OUTPUT (inserted.ID_KATEGORIOGRENCI) INTO @IDTABLE
					VALUES (@TC_OGRENCI,@DONEM,@ID_KADEME3,@ID_KATEGORI,@TCKIMLIKNO,@ID_KATEGORITAVSIYE)

					SET @ID_KATEGORIOGRENCI = (SELECT TOP 1 ID FROM @IDTABLE)
				END
				ELSE
				BEGIN
					UPDATE YG_KategoriOgrenci SET
						ID_KATEGORI = @ID_KATEGORI,
						TC_OGRETMEN = @TCKIMLIKNO,
						ID_KATEGORITAVSIYE = @ID_KATEGORITAVSIYE
					WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
				END

			
				INSERT INTO YG_KategoriOgrenciPuan 
						(ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN)			
				SELECT	@ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN  
				FROM OPENJSON(@OGRENCIYILDIZLIST)
				WITH (
					ID_KATEGORIPUAN INT,
					PUAN			INT
				)

				SELECT 1 			
			END
			ELSE
				SELECT 0

		END
		
		IF @ISLEM = 7	--	TOPLU KARNE					
		BEGIN
			
			SELECT YO.ID_KATEGORIOGRENCI, ID_KADEME3
			INTO #OGRECILIST7
			FROM YG_KategoriOgrenci	YO
			JOIN v3OgrenciTum		OT	ON	OT.TCKIMLIKNO	= YO.TCKIMLIKNO
										AND OT.DONEM		= YO.DONEM
			WHERE OT.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			
			SELECT TOP 1 @ID_KADEME3 = ID_KADEME3
			FROM #OGRECILIST7

			SELECT DISTINCT
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= ISNULL(K.AD,'')
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN #OGRECILIST7			OL	ON	OL.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END

			DROP TABLE IF EXISTS #OGRECILIST7

		END

		IF @ISLEM = 8	--	YETENEK GELİŞİM KATEGORILER	
		BEGIN
			SELECT ISNULL((	SELECT *
							FROM YG_Kategori		K
							LEFT JOIN (
								SELECT *
								FROM YG_Kategori
								WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
							)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
							WHERE K.ID_USTKATEGORI IS NULL
							ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
							FOR JSON AUTO
						),'[]' )AS YETENEKDERSLIST
		END

		IF @ISLEM = 9	--	YG DERS ACIKLAMA EKLE		
		BEGIN
			UPDATE YG_Kategori SET 
				ACIKLAMA = CASE WHEN @ACIKLAMA = '' THEN NULL ELSE @ACIKLAMA END 
			WHERE ID_KATEGORI = @ID_KATEGORI
		END

		IF @ISLEM = 10	--	YG DERS ACIKLAMA GETİR		
		BEGIN
			SELECT ISNULL((
				SELECT	 ID_KATEGORI
						,ISNULL(ACIKLAMA,'') AS ACIKLAMA 
				FROM YG_Kategori  
				WHERE ID_KATEGORI = @ID_KATEGORI 
				FOR JSON AUTO, INCLUDE_NULL_VALUES
			),'[]' )
		END

		IF @ISLEM = 11	--	YG DERS LİSTE GETİR			
		BEGIN
			SELECT ISNULL((
				SELECT *
				FROM YG_Kategori		K
				LEFT JOIN (
					SELECT *
					FROM YG_Kategori
					WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
				)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
				WHERE K.ID_USTKATEGORI IS NULL
				ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
				FOR JSON AUTO
			),'[]' )
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YG_YorumEkle]    Script Date: 23.11.2021 15:45:16 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_YG_YorumEkle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_KATEGORIOGRENCI	INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_KATEGORITAVSIYE	INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@OGRENCIYILDIZLIST	VARCHAR(MAX)	= NULL,	
	@SQLJSON			VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_SINIF					= @ID_SINIF			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_KATEGORIOGRENCI			= @ID_KATEGORIOGRENCI	
			,ID_KATEGORI				= @ID_KATEGORI		
			,ID_KATEGORITAVSIYE			= @ID_KATEGORITAVSIYE	
			,TC_OGRENCI					= @TC_OGRENCI			
			,DONEM						= @DONEM				
			,OGRENCIYILDIZLIST			= @OGRENCIYILDIZLIST	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	KATEGORİ YORUM LİSTESİ
		BEGIN
			SELECT (				
				SELECT DISTINCT Y.ID_KATEGORI
					,KATEGORIAD = K.AD
					,SY.ID_KATEGORIYORUM
					,SY.MIN_YORUM
					,SY.MAX_YORUM
					,SY.DERECE
					,SY.YORUM
				FROM YG_KategoriYorum	Y
				JOIN YG_KategoriYorum	SY	ON	SY.ID_KATEGORI	= Y.ID_KATEGORI
				JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= Y.ID_KATEGORI
				FOR JSON AUTO
			) AS S
		END

		IF @ISLEM = 2	--	KATEGORI YORUM UPDATE
		BEGIN			

			SELECT SY.* 
			INTO #TEMP
			FROM OPENJSON (@SQLJSON)
			WITH( 
				ID_KATEGORI INT,
				SY			NVARCHAR(MAX)	'$.K[0].SY' AS JSON
			) AS J
			CROSS APPLY OPENJSON (J.SY)
			WITH (
				ID_KATEGORIYORUM	INT
				,MIN_YORUM			INT
				,MAX_YORUM			INT
				,DERECE				INT
				,YORUM				VARCHAR(MAX)
			) AS SY

			UPDATE Y SET
				 Y.DERECE		= T.DERECE
				,Y.MIN_YORUM	= T.MIN_YORUM
				,Y.MAX_YORUM	= T.MAX_YORUM
				,Y.YORUM		= T.YORUM
			FROM YG_KategoriYorum	Y
			JOIN #TEMP				T	ON	T.ID_KATEGORIYORUM = Y.ID_KATEGORIYORUM

			DROP TABLE IF EXISTS #TEMP

			SELECT 1

		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Yillik]    Script Date: 23.11.2021 15:45:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Yillik]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN
			
			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

			IF @ISLEM = 1	--	Ögrenci Listesi					
			BEGIN
			
				DROP TABLE IF EXISTS #TEMPOGRENCI

				SELECT DT.SUBEAD, DT.KADEME3, DT.SINIFAD, DT.TCKIMLIKNO, DT.AD, DT.SOYAD, ISNULL(MAX(Y.ID_YILLIK), 0) ID_YILLIK
				INTO #TEMPOGRENCI
				FROM OkyanusDB.dbo.vw_OgrenciDetayTum	DT
				JOIN OkyanusDB.dbo.vw_SubeGrupSinif		GS	ON	GS.ID_KADEME3		= DT.ID_KADEME3
															AND GS.ID_SUBE			= DT.ID_SUBE
				JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.ID_SINIF			= GS.ID_SINIF
				LEFT JOIN eokul_v2.dbo.Yillik			Y	ON	Y.TC_YAZAN			= O.TCKIMLIKNO
															AND Y.TC_YILLIKSAHIBI	= DT.TCKIMLIKNO
															AND Y.DONEM				= DT.DONEM
															AND SILINDI				= 0
				WHERE	O.TCKIMLIKNO	= @TC_OGRENCI
					AND DT.DONEM		= @AKTIFDONEM
					AND DT.TCKIMLIKNO	!= O.TCKIMLIKNO
				GROUP BY DT.SUBEAD, DT.KADEME3, DT.SINIFAD, DT.TCKIMLIKNO, DT.AD, DT.SOYAD

				SELECT ISNULL((				
					SELECT T.*, ISNULL(Y.YAZI,'') AS YAZI, ISNULL(R.FOTOGRAF,'') AS FOTOGRAF
					FROM #TEMPOGRENCI				T
					LEFT JOIN OkyanusDB.dbo.v3Resim	R	ON	R.TCKIMLIKNO	= T.TCKIMLIKNO
														AND R.SIRANO		= 1		
					LEFT JOIN eokul_v2.dbo.Yillik	Y	ON	Y.ID_YILLIK		= T.ID_YILLIK
					ORDER BY SINIFAD, AD, SOYAD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')

				
				DROP TABLE IF EXISTS #TEMPOGRENCI
				
			END

			IF @ISLEM = 2	--	Yıllık Yazı Kaydet / Düzenle	
			BEGIN

				IF EXISTS( SELECT TOP 1 1 FROM OPENJSON (@SQLJSON) WITH(ID_YILLIK	INT) AS J JOIN eokul_v2.dbo.Yillik Y ON Y.ID_YILLIK = J.ID_YILLIK )
				BEGIN

					UPDATE Y SET
						 ID_DEGISTIREN		= K.ID_KULLANICI
						,DEGISTIRMETARIHI	= GETDATE()
						,YAZI				= J.YAZI
					FROM OPENJSON (@SQLJSON)
					WITH(					
						YAZI		VARCHAR(MAX),
						ID_YILLIK	INT
					) AS J					
					JOIN v3Kullanici			K	ON	K.TCKIMLIKNO	= @TCKIMLIKNO
					JOIN eokul_v2.dbo.Yillik	Y	ON	Y.ID_YILLIK		= J.ID_YILLIK

				END 
				ELSE
				BEGIN

					INSERT INTO eokul_v2.dbo.Yillik(YAZI,ID_YILLIKSAHIBI,ID_YAZAN,SILINDI,TARIH,DONEM,TC_YAZAN,TC_YILLIKSAHIBI)
					SELECT YAZI, YK.ID_KULLANICI ID_YILLIKSAHIBI, K.ID_KULLANICI ID_YAZAN, 0 SILINDI, GETDATE() TARIH, @AKTIFDONEM DONEM, @TCKIMLIKNO TC_YAZAN, J.TCKIMLIKNO TC_YILLIKSAHIBI
					FROM OPENJSON (@SQLJSON)
					WITH(
						TCKIMLIKNO	VARCHAR(MAX),
						YAZI		VARCHAR(MAX),
						ID_YILLIK	INT
					) AS J
					JOIN v3Kullanici	YK	ON	YK.TCKIMLIKNO	= J.TCKIMLIKNO
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= @TCKIMLIKNO

				END
			END

			IF @ISLEM = 3	--	Yıllık Yazı Sil					
			BEGIN

				UPDATE Y SET
					 ID_SILEN		= K.ID_KULLANICI
					,SILINME_TARIHI	= GETDATE()					
					,SILINDI		= 1						
				FROM OPENJSON (@SQLJSON)
				WITH(
					ID_YILLIK	INT
				) AS J					
				JOIN v3Kullanici			K	ON	K.TCKIMLIKNO	= @TCKIMLIKNO
				JOIN eokul_v2.dbo.Yillik	Y	ON	Y.ID_YILLIK		= J.ID_YILLIK

			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_YYS]    Script Date: 23.11.2021 15:45:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER procedure [dbo].[sp_YYS]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,

	@ID_YYSSINAV			INT				= NULL,
	@ID_YYSSINAVDOSYA		INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@DOSYAADI				VARCHAR(MAX)	= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@DOSYAGUID				VARCHAR(MAX)	= NULL,
	@ID_YYSSINAVDOSYALIST	VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
		@IP					VARCHAR(50)	= NULL


AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				
				,ID_YYSSINAV			= @ID_YYSSINAV	
				,ID_YYSSINAVDOSYA		= @ID_YYSSINAVDOSYA	
				,ID_SUBE				= @ID_SUBE		
				,DONEM					= @DONEM				
				,DOSYAADI				= @DOSYAADI			
				,AD						= @AD					
				,DOSYAGUID				= @DOSYAGUID			
				,SQLJSON				= @SQLJSON				
				,ID_YYSSINAVDOSYALIST	= @ID_YYSSINAVDOSYALIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		

		IF @_ID_LOG > 0
		BEGIN

			IF @ISLEM = 1	--	SINAV TANIMLA		
			BEGIN

				INSERT INTO YYSSinav(AD, DONEM, KYE_TCKIMLIKNO)
				SELECT @AD, @DONEM, @TCKIMLIKNO
				
			END

			IF @ISLEM = 2	--	SINAV LİSTELE		
			BEGIN
				SELECT
				(
					SELECT	 S.ID_YYSSINAV
							,S.AD
							,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
							,ADSOYAD		= K.AD + ' ' + K.SOYAD
					FROM YYSSinav		S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					WHERE	S.DONEM		 = @DONEM
						AND S.AKTIF		 = 1 
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 3	--	SINAV DUZENLE		
			BEGIN
				UPDATE YYSSinav SET 
					 AD			= @AD
				WHERE ID_YYSSINAV = @ID_YYSSINAV
			END

			IF @ISLEM = 4	--	SINAV SİL			
			BEGIN
				UPDATE YYSSinav SET AKTIF = 0 WHERE ID_YYSSINAV = @ID_YYSSINAV

				UPDATE YYSSinavDosya SET AKTIF = 0 WHERE ID_YYSSINAV = @ID_YYSSINAV

				UPDATE YYSOgrenci SET ID_YYSSINAV = @ID_YYSSINAV
			END

			IF @ISLEM = 5	--	SINAV EXCEL YÜKLE	
			BEGIN

				IF EXISTS (	
							SELECT 1 
							FROM YYSOgrenciCevap	O 
							JOIN YYSSoru	S	ON	S.ID_YYSSORU	= O.ID_YYSSORU
							JOIN YYSDers	D	ON	D.ID_YYSDERS	= S.ID_YYSDERS
							WHERE D.ID_YYSSINAV = @ID_YYSSINAV
						)
				BEGIN
					RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
				END
				ELSE
				BEGIN
					
					DROP TABLE IF EXISTS #TEMP2
					DROP TABLE IF EXISTS #TEMP
					
					DELETE FROM YYSDers		WHERE ID_YYSSINAV = @ID_YYSSINAV	--	CASCADE 
					DELETE FROM YYSOptik	WHERE ID_YYSSINAV = @ID_YYSSINAV

					SELECT	 DERSNO
							,DERSAD
							,SORUNO
							,SORU
							,CEVAP
							,DUZEY
							,ACIKLAMA
					INTO #TEMP
					FROM OPENJSON (@SQLJSON , '$.DERSLIST') WITH(
						DERSNO		INT,
						DERSAD		VARCHAR(MAX),
						SORULIST	NVARCHAR(MAX) AS JSON,
						DUZEYLIST	NVARCHAR(MAX) AS JSON
					) AS J
					CROSS APPLY OPENJSON( J.SORULIST) WITH(
						SORUNO		INT,
						SORU		VARCHAR(MAX),
						CEVAP		VARCHAR(MAX)
					) AS S	
					CROSS APPLY OPENJSON( J.DUZEYLIST) WITH(
						DUZEY		INT,
						ACIKLAMA	VARCHAR(MAX)
					) AS D	

					INSERT INTO YYSDers (DERSNO, AD, ID_YYSSINAV)
					SELECT DISTINCT 
						 T.DERSNO 
						,T.DERSAD
						,@ID_YYSSINAV 
					FROM #TEMP	T

					INSERT INTO YYSSoru	(ID_YYSDERS, SORUNO, SORU, CEVAP )
					SELECT DISTINCT	 
						 D.ID_YYSDERS
						,T.SORUNO
						,T.SORU
						,T.CEVAP
					FROM #TEMP		T
					JOIN YYSDers	D	ON	D.DERSNO	= T.DERSNO
					WHERE D.ID_YYSSINAV = @ID_YYSSINAV

					INSERT INTO YYSDuzey (ID_YYSDERS, DUZEY, ACIKLAMA)
					SELECT DISTINCT
						 D.ID_YYSDERS	 
						,T.DUZEY
						,T.ACIKLAMA
					FROM #TEMP		T
					JOIN YYSDers	D	ON	D.DERSNO	= T.DERSNO
					WHERE D.ID_YYSSINAV = @ID_YYSSINAV
					
					
					INSERT INTO YYSOptik (ID_YYSSINAV, AD, BASLANGIC, KARAKTERSAYISI, SABIT)
					SELECT	 ID_YYSSINAV	= @ID_YYSSINAV
							,AD
							,BASLANGIC
							,KARAKTERSAYISI
							,SABIT			= 1
					FROM OPENJSON (@SQLJSON , '$.OPTIK.OPTIKSABIT') WITH(
						AD				VARCHAR(MAX),
						BASLANGIC		INT,
						KARAKTERSAYISI	INT
					) AS J
				UNION
					SELECT	 @ID_YYSSINAV
							,AD
							,BASLANGIC
							,KARAKTERSAYISI
							,SABIT			= 0
					FROM OPENJSON (@SQLJSON , '$.OPTIK.OPTIKDERS') WITH(
						AD				VARCHAR(MAX) '$.DERSAD',
						BASLANGIC		INT,
						KARAKTERSAYISI	INT
					) AS J
					ORDER BY BASLANGIC
										
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #TEMP2
				END
			END

			IF @ISLEM = 6	--	SINAV EXCEL LİSTELE	
			BEGIN
				
				
				SELECT ISNULL((
					SELECT (
						SELECT	 DERSNO
								,AD AS DERSAD
								,SORULIST = (
									SELECT	 SORUNO
											,SORU
											,CEVAP
									FROM YYSSoru	S
									WHERE S.ID_YYSDERS = D.ID_YYSDERS
									FOR JSON PATH
								)
								,DUZEYLIST = (
									SELECT	 DUZEY
											,ACIKLAMA
									FROM YYSDuzey	DZ
									WHERE DZ.ID_YYSDERS = D.ID_YYSDERS
									FOR JSON PATH
								)
						FROM YYSDers	D
						WHERE ID_YYSSINAV = @ID_YYSSINAV
						FOR JSON PATH
					) AS DERSLIST
					,(
						SELECT (							
							SELECT AD, BASLANGIC, KARAKTERSAYISI
							FROM  YYSOptik
							WHERE ID_YYSSINAV	= @ID_YYSSINAV
								AND SABIT		= 1
							ORDER BY BASLANGIC
							FOR JSON PATH
						) AS OPTIKSABIT					
						,(
							SELECT AD AS DERSAD, BASLANGIC, KARAKTERSAYISI
							FROM  YYSOptik
							WHERE ID_YYSSINAV	= @ID_YYSSINAV
								AND SABIT		= 0
							ORDER BY BASLANGIC
							FOR JSON PATH
						) AS OPTIKDERS
						FOR JSON PATH
					) AS OPTIK
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 7	--	OPTİK YÜKLE			
			BEGIN

				IF EXISTS (SELECT TOP 1 1 FROM YYSSinavDosya WHERE ID_YYSSINAV=@ID_YYSSINAV AND ID_SUBE = @ID_SUBE AND AD=@DOSYAADI AND AKTIF=1)
				BEGIN
					DECLARE @MSG VARCHAR(MAX) = 'DAHA ÖNCE AYNI İSİMLİ DOSYA KAYDETTİNİZ. KONTROL EDİNİZ!'
					RAISERROR (@MSG ,16, 1);
				END
				ELSE
				BEGIN

					DECLARE @ID_YYSSINAVDOSYAx TABLE (ID_YYSSINAVDOSYA int)
					INSERT INTO [dbo].[YYSSinavDosya]
								([ID_YYSSINAV]
								,[ID_SUBE]
								,[AD]
								,[GUID]
								,[KYE_TCKIMLIKNO])
					OUTPUT INSERTED.ID_YYSSINAVDOSYA into @ID_YYSSINAVDOSYAx
					VALUES (@ID_YYSSINAV,@ID_SUBE,@DOSYAADI,@DOSYAGUID,@TCKIMLIKNO)

					DECLARE @IDX int=(SELECT TOP 1 ID_YYSSINAVDOSYA FROM @ID_YYSSINAVDOSYAx)

					DECLARE @SQLDOSYA		VARCHAR(max)	= NULL
					DECLARE @YOLDOSYA		VARCHAR(max)	= NULL
					DECLARE @GUIDDOSYA		VARCHAR(max)	= NULL
				
					DROP TABLE IF EXISTS #tmp
					DROP TABLE IF EXISTS #TEMP7
					DROP TABLE IF EXISTS #TEMPSORU
					DROP TABLE IF EXISTS #INSERT

					BEGIN 

						SET @GUIDDOSYA = (SELECT GUID FROM YYSSinavDosya where ID_YYSSINAVDOSYA=@IDX)
						CREATE TABLE #tmp (
							LINE nvarchar(max)
						);
						BEGIN TRY  
							SET @YOLDOSYA = '\\172.18.194.207\$SinavOptik\YYS\'+@GUIDDOSYA+'.txt'
							SET @SQLDOSYA=	'BULK INSERT #tmp 
											FROM '''+@YOLDOSYA+'''
											WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
							PRINT @SQLDOSYA
							EXEC(@SQLDOSYA) 
						END TRY  
						BEGIN CATCH  
							SET @YOLDOSYA = '\\172.18.194.207\$SinavOptik\YYS\'+@GUIDDOSYA+'.dat'
							SET @SQLDOSYA=	'BULK INSERT #tmp
											FROM '''+@YOLDOSYA+'''
											WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
							EXEC(@SQLDOSYA) 
						END CATCH 				
					END	
				
					;WITH TEMP AS (
						SELECT LINE, ROW_NUMBER () OVER(ORDER BY LINE) ID
						FROM #tmp
					)
					SELECT T.ID, SUBSTRING(T.LINE, BASLANGIC, KARAKTERSAYISI) DEGER, O.AD
					INTO #TEMP7
					FROM TEMP		T
					CROSS APPLY YYSOptik	O	
					WHERE O.ID_YYSSINAV = @ID_YYSSINAV
				
					DECLARE @INSERT TABLE (ID_YYSOGRENCI INT, ID INT)
					MERGE INTO YYSOgrenci 
					USING 
					(
						SELECT	 ID_YYSSINAV	= @ID_YYSSINAV
								,ID_YYSSINAVDOSYA = @IDX
								,A.ID
								,AD				= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'AD')
								,SOYAD			= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'SOYAD')
								,DOGUMTARIHI	= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'DOGUMTARIHI')
								,SINIF			= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'SINIF')
						FROM #TEMP7 A
						GROUP BY ID
					)
					AS TEMP ON 1 = 0
					WHEN NOT MATCHED THEN
						INSERT (ID_YYSSINAV, ID_YYSSINAVDOSYA, AD, SOYAD, DOGUMTARIHI, SINIF)
						VALUES (TEMP.ID_YYSSINAV, TEMP.ID_YYSSINAVDOSYA, TEMP.AD, TEMP.SOYAD, TEMP.DOGUMTARIHI, TEMP.SINIF)
						OUTPUT TEMP.ID, inserted.ID_YYSOGRENCI
						INTO @INSERT (ID, ID_YYSOGRENCI);

					SELECT * 
					INTO #INSERT
					FROM @INSERT
				
					SELECT	 
						 A.DEGER
						,ID_YYSDERS
						,ID_YYSOGRENCI
						,SORUSAYISI = (SELECT COUNT(1) FROM YYSSoru S WHERE S.ID_YYSDERS = D.ID_YYSDERS)
						,RN			= ROW_NUMBER() OVER(ORDER BY A.ID)
					INTO #TEMPSORU
					FROM #TEMP7 A
					JOIN YYSOptik	O	ON	O.AD			= A.AD
					JOIN YYSDers	D	ON	D.AD			= O.AD
										AND D.ID_YYSSINAV	= O.ID_YYSSINAV
					JOIN #INSERT	I	ON	I.ID			= A.ID
					WHERE	O.SABIT			= 0
						AND D.ID_YYSSINAV	= @ID_YYSSINAV				

					WHILE EXISTS (SELECT TOP 1 1 FROM #TEMPSORU)
					BEGIN
						DECLARE @RN INT, @SORUSAYISI INT, @COUNTSORU INT = 1
						SELECT TOP 1 
							 @RN		= RN
							,@SORUSAYISI= SORUSAYISI
						FROM #TEMPSORU 
						ORDER BY RN

						WHILE @COUNTSORU < @SORUSAYISI + 1 
						BEGIN
						
							INSERT INTO YYSOgrenciCevap (ID_YYSOGRENCI, ID_YYSSORU, CEVAP, DURUM)
							SELECT DISTINCT
								 T.ID_YYSOGRENCI
								,S.ID_YYSSORU
								,ISNULL(SUBSTRING(DEGER, @COUNTSORU, 1), '---') CEVAP
								,CASE WHEN ISNULL(SUBSTRING(DEGER, @COUNTSORU, 1), '---') = S.CEVAP THEN 1 ELSE 0 END
							FROM #TEMPSORU	T
							JOIN YYSSoru	S	ON	S.ID_YYSDERS = T.ID_YYSDERS
							WHERE	RN		= @RN
								AND S.SORUNO= @COUNTSORU

							SET @COUNTSORU = @COUNTSORU + 1

						END
					
						DELETE FROM #TEMPSORU WHERE RN = @RN
					END
								
					INSERT INTO YYSOgrenciSonuc (ID_YYSOGRENCI, ID_YYSDERS, PUAN)
					SELECT DISTINCT YO.ID_YYSOGRENCI, S.ID_YYSDERS, SUM(CAST(DURUM AS INT)) AS PUAN
					FROM YYSOgrenci			YO
					JOIN YYSOgrenciCevap	YOC	ON	YOC.ID_YYSOGRENCI	= YO.ID_YYSOGRENCI
					JOIN YYSSoru			S	ON	S.ID_YYSSORU		= YOC.ID_YYSSORU
					WHERE YO.ID_YYSSINAVDOSYA = @IDX
					GROUP BY YO.ID_YYSOGRENCI, S.ID_YYSDERS

					DROP TABLE IF EXISTS #tmp
					DROP TABLE IF EXISTS #TEMP7
					DROP TABLE IF EXISTS #TEMPSORU
					DROP TABLE IF EXISTS #INSERT

				END

			END

			IF @ISLEM = 8	--	SINAV DOSYA LİSTELE	
			BEGIN
				SELECT
				(
					SELECT	 ID_YYSSINAV		= S.ID_YYSSINAV
							,ID_YYSSINAVDOSYA	= S.ID_YYSSINAVDOSYA
							,DOSYAAD			= S.AD
							,ADSOYAD			= CONCAT_WS(' ', K.AD, K.SOYAD)
							,OGRENCISAYISI		= ISNULL((SELECT COUNT(1) FROM YYSOgrenci SO WHERE SO.ID_YYSSINAVDOSYA = S.ID_YYSSINAVDOSYA),0)
					FROM YYSSinavDosya	S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					WHERE	S.ID_YYSSINAV	= @ID_YYSSINAV
						AND S.ID_SUBE		= @ID_SUBE
						AND S.AKTIF			= 1
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 9	--	SINAV KARNE			
			BEGIN
			
				DROP TABLE IF EXISTS #TEMP9

				SELECT DISTINCT 
					 ID_YYSOGRENCI	= O.ID_YYSOGRENCI
					,AD				= O.AD
					,SOYAD			= O.SOYAD
					,DOGUMTARIHI	= CONVERT(VARCHAR, O.DOGUMTARIHI, 104)
					,SINIF			= O.SINIF
					,SINAVTARIHI	= CONVERT(VARCHAR, SD.KYE_TARIH, 104)
					,ID_YYSDERS		= OS.ID_YYSDERS
					,PUAN			= OS.PUAN
					,DERSNO			= ROW_NUMBER() OVER(PARTITION BY O.ID_YYSOGRENCI ORDER BY D.DERSNO)
					,DERSAD			= D.AD
					,DUZEY			= CASE WHEN DU.DUZEY IS NOT NULL THEN CAST(DU.DUZEY AS varchar) + '. DÜZEY' ELSE '' END
					,ACIKLAMA		= ISNULL(DU.ACIKLAMA, '')
				INTO #TEMP9
				FROM YYSSinav			S
				JOIN YYSSinavDosya		SD	ON	SD.ID_YYSSINAV		= S.ID_YYSSINAV
				JOIN YYSOgrenci			O	ON	O.ID_YYSSINAVDOSYA	= SD.ID_YYSSINAVDOSYA
				JOIN YYSOgrenciSonuc	OS	ON	OS.ID_YYSOGRENCI	= O.ID_YYSOGRENCI
				JOIN YYSDers			D	ON	D.ID_YYSDERS		= OS.ID_YYSDERS
				LEFT JOIN YYSDuzey		DU	ON	DU.ID_YYSDERS		= D.ID_YYSDERS
											AND DU.DUZEY			= OS.PUAN
				WHERE SD.ID_YYSSINAVDOSYA IN (SELECT VALUE FROM OPENJSON(@ID_YYSSINAVDOSYALIST))
				ORDER BY AD, SOYAD, ID_YYSDERS

				SELECT DISTINCT ID_YYSOGRENCI, AD, SOYAD, DOGUMTARIHI, SINIF = SINIF + ' Sınıf', SINAVTARIHI FROM #TEMP9

				--SELECT DISTINCT ID_YYSDERS, DERSAD FROM #TEMP9

				SELECT	 ID_YYSOGRENCI
						,ID_YYSDERS
						,PUAN
						,DERSNO
						,DERSAD
						,DUZEY
						,ACIKLAMA
				FROM #TEMP9
				
				DROP TABLE IF EXISTS #TEMP9
			END

			IF @ISLEM = 10	--	SINAV DOSYA SİL		
			BEGIN

				UPDATE YYSSinavDosya SET
					SIL_TCKIMLIKNO	= @TCKIMLIKNO,
					SIL_TARIH		= GETDATE(),
					AKTIF			= 0
				WHERE ID_YYSSINAVDOSYA = @ID_YYSSINAVDOSYA

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_ZekaTest]    Script Date: 23.11.2021 15:45:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_ZekaTest]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@TCKIMLIKNO_OGR				VARCHAR(11)		= NULL,
	@ID_ZEKATEST				INT				= NULL,
	@SQLJSON_SORU				VARCHAR(MAX)	= NULL,
	@SQLJSON_OGRENCI			VARCHAR(MAX)	= NULL,
	@DOSYAAD					VARCHAR(MAX)	= NULL,
	@DOSYAGUID					VARCHAR(MAX)	= NULL,
	@DOSYATIP					VARCHAR(MAX)	= NULL,
	@ID_ZEKATESTOGRENCIDOSYA	INT				= NULL,
	@LISTELEMETIPI				BIT				= NULL,
	@ID_ZEKATESTOGRENCIZEKATEST	INT				= NULL,
	@SQLJSON					VARCHAR(MAX)	= '',
	@TESTTARIHI1				VARCHAR(MAX)	= '',
	@TESTTARIHI2				VARCHAR(MAX)	= '',
	@SEARCH						VARCHAR(MAX)	= '',
	@ORDERCOLEXCEL				VARCHAR(MAX)	= '',
	@ORDERDIREXCEL				VARCHAR(MAX)	= '',
	@DURUM						INT				= 1,
	@ID_ZEKATESTOGRENCIDOSYATUR	INT				= 1,
		@IP					VARCHAR(50)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM								= @ISLEM						
			,TCKIMLIKNO							= @TCKIMLIKNO					
			,OTURUM								= @OTURUM						
			,ID_MENU							= @ID_MENU					
			,TCKIMLIKNO_OGR						= @TCKIMLIKNO_OGR				
			,ID_ZEKATEST						= @ID_ZEKATEST				
			,SQLJSON_SORU						= @SQLJSON_SORU				
			,SQLJSON_OGRENCI					= @SQLJSON_OGRENCI			
			,DOSYAAD							= @DOSYAAD					
			,DOSYAGUID							= @DOSYAGUID					
			,DOSYATIP							= @DOSYATIP					
			,ID_ZEKATESTOGRENCIDOSYA			= @ID_ZEKATESTOGRENCIDOSYA	
			,LISTELEMETIPI						= @LISTELEMETIPI				
			,ID_ZEKATESTOGRENCIZEKATEST			= @ID_ZEKATESTOGRENCIZEKATEST
			,SQLJSON							= @SQLJSON					
			,TESTTARIHI1						= @TESTTARIHI1				
			,TESTTARIHI2						= @TESTTARIHI2				
			,SEARCH								= @SEARCH						
			,ORDERCOLEXCEL						= @ORDERCOLEXCEL				
			,ORDERDIREXCEL						= @ORDERDIREXCEL				
			,DURUM								= @DURUM						
			,ID_ZEKATESTOGRENCIDOSYATUR			= @ID_ZEKATESTOGRENCIDOSYATUR
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	ZEKA TEST LİSTELE
			BEGIN
				SELECT
				(
					SELECT *
					FROM ZekaTest
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 2	--	ÖĞRENCİ ARA
			BEGIN
				SELECT DISTINCT
						 O.ID_ZEKATESTOGRENCI
						,O.TCKIMLIKNO
						,O.AD
						,O.SOYAD
						,DATEPART(YEAR, O.DOGUMTARIHI) AS DOGUMYIL
						,DATEPART(MONTH, O.DOGUMTARIHI) AS DOGUMAY
						,DATEPART(DAY, O.DOGUMTARIHI) AS DOGUMGUN
				INTO #ZEKAOGRENCI
				FROM ZekaTestOgrenci O
				WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR	

				IF EXISTS (SELECT 1 FROM #ZEKAOGRENCI)
				BEGIN
					SELECT
					(
						SELECT * FROM #ZEKAOGRENCI
						FOR JSON PATH
					)
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT	 0 AS ID_ZEKATESTOGRENCI
								,O.TCKIMLIKNO
								,K.AD
								,K.SOYAD
								,DATEPART(YEAR, K.DOGUMTARIHI) AS DOGUMYIL
								,DATEPART(MONTH, K.DOGUMTARIHI) AS DOGUMAY
								,DATEPART(DAY, K.DOGUMTARIHI) AS DOGUMGUN
						FROM OkyanusDb.dbo.v3Ogrenci O 
						INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
						WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR
						FOR JSON PATH
					)
				END

				DROP TABLE #ZEKAOGRENCI
			END

			IF @ISLEM = 3	--	SORU LİSTELE
			BEGIN
				SELECT
				(
					SELECT 
					(
						SELECT ZTK.AD AS KATEGORI, (SELECT ZTS.ID_ZEKATESTSORU, ZTS.SORU, ZTS.KALIN, '' as PUAN FROM ZekaTestSoru ZTS WHERE ZTS.ID_ZEKATESTKATEGORI = ZTK.ID_ZEKATESTKATEGORI FOR JSON PATH, INCLUDE_NULL_VALUES) AS SORULIST
						FROM ZekaTest ZT
						INNER JOIN ZekaTestKategori ZTK ON ZTK.ID_ZEKATEST = ZT.ID_ZEKATEST
						WHERE ZT.ID_ZEKATEST = @ID_ZEKATEST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS KATEGORILIST,
					null AS DOSYA FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				)
			END

			IF @ISLEM = 4	--	KAYDET
			BEGIN
				DECLARE @ID_ZEKATESTOGRENCI INT,
						@TC VARCHAR(11),
						@AD VARCHAR(MAX),
						@SOYAD VARCHAR(MAX),
						@DOGUMTARIHI VARCHAR(MAX),
						@TESTTARIHI VARCHAR(MAX)

				SELECT	 @ID_ZEKATESTOGRENCI = ID_ZEKATESTOGRENCI 
						,@TC = TCKIMLIKNO
						,@AD = AD
						,@SOYAD = SOYAD
						,@DOGUMTARIHI = DOGUMTARIHI
						,@TESTTARIHI = ISNULL(TESTTARIHI, CONVERT(VARCHAR, GETDATE(), 104))
				FROM OPENJSON(@SQLJSON_OGRENCI)
				WITH(
					ID_ZEKATESTOGRENCI INT,
					TCKIMLIKNO VARCHAR(11),
					AD VARCHAR(MAX),
					SOYAD VARCHAR(MAX),
					DOGUMTARIHI VARCHAR(MAX),
					TESTTARIHI VARCHAR(MAX)
				)

				SET @ID_ZEKATESTOGRENCI = (SELECT ID_ZEKATESTOGRENCI FROM ZekaTestOgrenci WHERE TCKIMLIKNO = @TC)

				IF NOT EXISTS(SELECT TOP 1 1 FROM ZekaTestOgrenci WHERE TCKIMLIKNO = @TC)
				BEGIN
					DECLARE @INSERTED TABLE (ID_ZEKATESTOGRENCI INT)

					INSERT INTO ZekaTestOgrenci (TCKIMLIKNO, AD, SOYAD, DOGUMTARIHI)
					OUTPUT inserted.ID_ZEKATESTOGRENCI INTO @INSERTED
					SELECT @TCKIMLIKNO_OGR, @AD, @SOYAD, @DOGUMTARIHI

					SET @ID_ZEKATESTOGRENCI = (SELECT ID_ZEKATESTOGRENCI FROM @INSERTED)
				END

				DECLARE @INSERTEDID_ZEKATESTOGRENCIZEKATEST TABLE (ID_ZEKATESTOGRENCIZEKATEST INT)
				INSERT INTO ZekaTestOgrenciZekaTest (ID_ZEKATESTOGRENCI, ID_ZEKATEST, TESTTARIHI, KYE_KULLANICI)
				OUTPUT inserted.ID_ZEKATESTOGRENCIZEKATEST INTO @INSERTEDID_ZEKATESTOGRENCIZEKATEST
				SELECT @ID_ZEKATESTOGRENCI, @ID_ZEKATEST, @TESTTARIHI, @TCKIMLIKNO

				SET @ID_ZEKATESTOGRENCIZEKATEST = (SELECT ID_ZEKATESTOGRENCIZEKATEST FROM @INSERTEDID_ZEKATESTOGRENCIZEKATEST)

				INSERT INTO ZekaTestOgrenciPuan (ID_ZEKATESTOGRENCIZEKATEST, ID_ZEKATESTSORU, PUAN)
				SELECT	@ID_ZEKATESTOGRENCIZEKATEST,
						JSON_Value (S.value, '$.ID_ZEKATESTSORU') as ID_ZEKATESTSORU,
						JSON_Value (S.value, '$.PUAN') as PUAN
				FROM OPENJSON(@SQLJSON_SORU, '$.KATEGORILIST') AS K
				CROSS APPLY OPENJSON (K.value, '$.SORULIST') as S
				WHERE JSON_Value (S.value, '$.PUAN') <> ''

				SELECT @ID_ZEKATESTOGRENCIZEKATEST
			END

			IF @ISLEM = 5	--	ÖĞRENCİ PUAN SİL
			BEGIN
				DELETE P 
				FROM ZekaTestOgrenciPuan P
				INNER JOIN ZekaTestSoru S ON S.ID_ZEKATESTSORU = P.ID_ZEKATESTSORU
				INNER JOIN ZekaTestKategori K ON K.ID_ZEKATESTKATEGORI = S.ID_ZEKATESTKATEGORI
				INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCIZEKATEST = P.ID_ZEKATESTOGRENCIZEKATEST
				INNER JOIN ZekaTestOgrenci O ON O.ID_ZEKATESTOGRENCI = OZT.ID_ZEKATESTOGRENCI
				WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND K.ID_ZEKATEST = @ID_ZEKATEST
			END

			IF @ISLEM = 6	--	DOSYA KAYDET
			BEGIN
				DELETE FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST AND ID_ZEKATESTOGRENCIDOSYATUR = @ID_ZEKATESTOGRENCIDOSYATUR

				INSERT INTO ZekaTestOgrenciDosya (AD, GUID, TIP, ID_ZEKATESTOGRENCIZEKATEST, ID_ZEKATESTOGRENCIDOSYATUR)
				SELECT @DOSYAAD, @DOSYAGUID, @DOSYATIP, @ID_ZEKATESTOGRENCIZEKATEST, @ID_ZEKATESTOGRENCIDOSYATUR
			END

			IF @ISLEM = 7	--	DOSYA SİL
			BEGIN
				DELETE FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIDOSYA = @ID_ZEKATESTOGRENCIDOSYA
			END

			IF @ISLEM = 8	--	SONUÇ LİSTELE
			BEGIN
				DECLARE @CONTROL BIT = 0

				IF EXISTS (SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE ID_KULLANICITIPI IN (1, 91) AND TCKIMLIKNO = @TCKIMLIKNO)
				BEGIN
					SET @CONTROL = 1
				END

				DECLARE @ORDERCOL INT,
						@ORDERDIR VARCHAR(4) 

				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				DECLARE @orderByClause VARCHAR(MAX) = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'AD'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 3 THEN 'SOYAD'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 4 THEN 'convert(DATE, DOGUMTARIHI, 104)'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 5 THEN 'convert(DATE, TESTTARIHI, 104)'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 6 THEN 'KYE_ADSOYAD'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 7 THEN 'YAS'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 8 THEN 'TEST'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 9 THEN 'TOPLAMPUAN'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 10 THEN 'ID'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 11 THEN 'DOSYA'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				DECLARE @whereClause VARCHAR(MAX) = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				DECLARE @displayStart INT = (SELECT start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)) 
				DECLARE @displayLength INT = (SELECT length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF @whereClause <> ''
				BEGIN
					DECLARE @COLUMNS VARCHAR(max) = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR AD LIKE ''%' + @whereClause + '%'' OR SOYAD LIKE ''%' + @whereClause + '%'' OR DOGUMTARIHI LIKE ''%' + @whereClause + '%'' OR TESTTARIHI LIKE ''%' + @whereClause + '%'' OR KYE_KULLANICI LIKE ''%' + @whereClause + '%'' OR YAS LIKE ''%' + @whereClause + '%'' OR TEST LIKE ''%' + @whereClause + '%'' OR TOPLAMPUAN LIKE ''%' + @whereClause + '%'' OR DOSYA LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE (KYE_KULLANICI = ''' + @TCKIMLIKNO + ''' OR ' + CAST(@CONTROL AS VARCHAR) + ' = 1)'
									+ ' AND ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
									+ ' AND ' + @COLUMNS
				END
				ELSE
				BEGIN
					SET @whereClause='WHERE (KYE_KULLANICI = ''' + @TCKIMLIKNO + ''' OR ' + CAST(@CONTROL AS VARCHAR) + ' = 1)'
									+ ' AND ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
				END

				Declare @query varchar(MAX)
				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT	O.TCKIMLIKNO
												,ISNULL(OK.AD, O.AD) AS AD
												,ISNULL(OK.SOYAD, O.SOYAD) AS SOYAD
												,ISNULL(CONVERT(VARCHAR, OK.DOGUMTARIHI, 104)
												,CONVERT(VARCHAR, O.DOGUMTARIHI, 104)) AS DOGUMTARIHI
												,CONVERT(VARCHAR, OZT.TESTTARIHI, 104) AS TESTTARIHI
												,KK.AD + '' '' + KK.SOYAD AS KYE_ADSOYAD
												,dbo.fn_DateDiffasYAG(ISNULL(OK.DOGUMTARIHI, O.DOGUMTARIHI), OZT.TESTTARIHI) AS YAS
												,Z.AD AS TEST
												,ISNULL((SELECT CAST(P.PUAN AS VARCHAR) FROM ZekaTestOgrenciPuan P WHERE P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND P.ID_ZEKATESTSORU = CASE WHEN Z.ID_ZEKATEST = 1 THEN 5 WHEN Z.ID_ZEKATEST = 2 THEN 20 ELSE 21 END), ''-'') AS TOPLAMPUAN
												,D.GUID + ''.'' + D.TIP AS DOSYA
												,DUZMAN.GUID + ''.'' + DUZMAN.TIP AS DOSYAUZMAN
												,OZT.KYE_KULLANICI
												,OZT.ID_ZEKATESTOGRENCIZEKATEST AS ID
										FROM ZekaTestOgrenci O
										INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI
										LEFT JOIN OkyanusDB.dbo.v3Kullanici OK ON OK.TCKIMLIKNO = O.TCKIMLIKNO
										INNER JOIN OkyanusDB.dbo.v3Kullanici KK ON KK.TCKIMLIKNO = OZT.KYE_KULLANICI
										INNER JOIN ZekaTest Z ON Z.ID_ZEKATEST = OZT.ID_ZEKATEST
										LEFT JOIN ZekaTestOgrenciDosya D ON D.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND D.ID_ZEKATESTOGRENCIDOSYATUR = 1
										LEFT JOIN ZekaTestOgrenciDosya DUZMAN ON DUZMAN.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND DUZMAN.ID_ZEKATESTOGRENCIDOSYATUR = 2
										WHERE OZT.AKTIF = 1
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM ZekaTestOgrenciZekaTest WHERE AKTIF = 1) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
			END

			IF @ISLEM = 9	--	SORU LİSTELE - LİSTE SAYFASI
			BEGIN
				SET @ID_ZEKATEST = (SELECT ID_ZEKATEST FROM ZekaTestOgrenciZekaTest WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST)

				SELECT O.ID_ZEKATESTOGRENCI, S.ID_ZEKATESTSORU, P.PUAN, OZT.KYE_KULLANICI
				INTO #OGRENCI
				FROM ZekaTestOgrenci O
				INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI 
				INNER JOIN ZekaTestOgrenciPuan P ON P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST 
				INNER JOIN ZekaTestSoru S ON S.ID_ZEKATESTSORU = P.ID_ZEKATESTSORU
				INNER JOIN ZekaTestKategori K ON K.ID_ZEKATESTKATEGORI = S.ID_ZEKATESTKATEGORI
				WHERE OZT.ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST

				SELECT
				(
					SELECT 
					(
						SELECT ZTK.AD AS KATEGORI, (SELECT ZTS.ID_ZEKATESTSORU, ZTS.SORU, ZTS.KALIN, ISNULL(CAST(O.PUAN AS VARCHAR), '') AS PUAN FROM ZekaTestSoru ZTS LEFT JOIN #OGRENCI O ON O.ID_ZEKATESTSORU = ZTS.ID_ZEKATESTSORU WHERE ZTS.ID_ZEKATESTKATEGORI = ZTK.ID_ZEKATESTKATEGORI FOR JSON PATH, INCLUDE_NULL_VALUES) AS SORULIST
						FROM ZekaTest ZT
						INNER JOIN ZekaTestKategori ZTK ON ZTK.ID_ZEKATEST = ZT.ID_ZEKATEST
						WHERE ZT.ID_ZEKATEST = @ID_ZEKATEST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS KATEGORILIST
					FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				)		

				DROP TABLE #OGRENCI
			END

			IF @ISLEM = 10	--	SONUÇ LİSTELE - EXCEL
			BEGIN
				DECLARE @CONTROLEXCEL BIT = 0

				IF EXISTS (SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE ID_KULLANICITIPI IN (1, 59, 91) AND TCKIMLIKNO = @TCKIMLIKNO)
				BEGIN
					SET @CONTROLEXCEL = 1
				END	

				DECLARE @orderByClauseEXCEL VARCHAR(MAX) = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 2 THEN 'AD'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 3 THEN 'SOYAD'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 4 THEN 'convert(DATE, DOGUMTARIHI, 104)'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 5 THEN 'convert(DATE, TESTTARIHI, 104)'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 6 THEN 'KYE_ADSOYAD'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 7 THEN 'YAS'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 8 THEN 'TEST'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 9 THEN 'TOPLAMPUAN'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 10 THEN 'ID'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 11 THEN 'DOSYA'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 11 THEN 'DOSYAUZMAN'
							END
						+ ' ' + CAST(@ORDERDIREXCEL AS VARCHAR)

				DECLARE @whereClauseEXCEL VARCHAR(MAX) = ''
		
				DECLARE @COLUMNSEXCEL VARCHAR(max) = ''
				SET @COLUMNSEXCEL='(TCKIMLIKNO LIKE ''%' + @SEARCH + '%'' OR AD LIKE ''%' + @SEARCH + '%'' OR SOYAD LIKE ''%' + @SEARCH + '%'' OR DOGUMTARIHI LIKE ''%' + @SEARCH + '%'' OR TESTTARIHI LIKE ''%' + @SEARCH + '%'' OR KYE_KULLANICI LIKE ''%' + @SEARCH + '%'' OR YAS LIKE ''%' + @SEARCH + '%'' OR TEST LIKE ''%' + @SEARCH + '%'' OR TOPLAMPUAN LIKE ''%' + @SEARCH + '%'')'

				SET @whereClauseEXCEL='WHERE (KYE_KULLANICI = ''' + @TCKIMLIKNO + ''' OR ' + CAST(@CONTROLEXCEL AS VARCHAR) + ' = 1)'
								+ ' AND ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
								+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
								+ ' AND ' + @COLUMNSEXCEL
								+ CASE @DURUM WHEN 0 THEN '' WHEN 1 THEN 'AND 1 = AKTIF' WHEN 2 THEN 'AND 0 = AKTIF' END

				Declare @queryEXCEL varchar(MAX)
				set @queryEXCEL='
								SELECT TCKIMLIKNO, AD, SOYAD, DOGUMTARIHI AS ''DOĞUM TARİHİ'', TESTTARIHI AS ''TEST TARİHİ'', KYE_ADSOYAD AS ''KAYIT EDEN'', YAS AS ''KRONOLOJİK YAŞ'', TEST, TOPLAMPUAN AS ''TOPLAM PUAN'', ''pusulam.okyanuskoleji.k12.tr/Dosyalar/ZekaTest/'' + DOSYA AS DOSYA, ''pusulam.okyanuskoleji.k12.tr/Dosyalar/ZekaTest/'' + DOSYAUZMAN AS DOSYAUZMAN FROM
								(
									SELECT	O.TCKIMLIKNO
											,ISNULL(OK.AD, O.AD) AS AD
											,ISNULL(OK.SOYAD, O.SOYAD) AS SOYAD
											,ISNULL(CONVERT(VARCHAR, OK.DOGUMTARIHI, 104)
											,CONVERT(VARCHAR, O.DOGUMTARIHI, 104)) AS DOGUMTARIHI
											,CONVERT(VARCHAR, OZT.TESTTARIHI, 104) AS TESTTARIHI
											,KK.AD + '' '' + KK.SOYAD AS KYE_ADSOYAD
											,dbo.fn_DateDiffasYAG(ISNULL(OK.DOGUMTARIHI, O.DOGUMTARIHI), OZT.TESTTARIHI) AS YAS
											,Z.AD AS TEST
											,ISNULL((SELECT CAST(P.PUAN AS VARCHAR) FROM ZekaTestOgrenciPuan P WHERE P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND P.ID_ZEKATESTSORU = CASE WHEN Z.ID_ZEKATEST = 1 THEN 5 WHEN Z.ID_ZEKATEST = 2 THEN 20 ELSE 21 END), ''-'') AS TOPLAMPUAN
											,D.GUID + ''.'' + D.TIP AS DOSYA
											,DUZMAN.GUID + ''.'' + DUZMAN.TIP AS DOSYAUZMAN
											,OZT.KYE_KULLANICI
											,OZT.AKTIF
									FROM ZekaTestOgrenci O
									INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI
									LEFT JOIN OkyanusDB.dbo.v3Kullanici OK ON OK.TCKIMLIKNO = O.TCKIMLIKNO
									INNER JOIN OkyanusDB.dbo.v3Kullanici KK ON KK.TCKIMLIKNO = OZT.KYE_KULLANICI
									INNER JOIN ZekaTest Z ON Z.ID_ZEKATEST = OZT.ID_ZEKATEST
									LEFT JOIN ZekaTestOgrenciDosya D ON D.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND D.ID_ZEKATESTOGRENCIDOSYATUR = 1
									LEFT JOIN ZekaTestOgrenciDosya DUZMAN ON DUZMAN.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND DUZMAN.ID_ZEKATESTOGRENCIDOSYATUR = 2
								) AS XTABLE
								'+@whereClauseEXCEL+'
								'+@orderByClauseEXCEL+'
				'

				execute (@queryEXCEL)
			END

			IF @ISLEM = 11	--	SONUÇ LİSTELE
			BEGIN
				DECLARE @ORDERCOLABB INT,
						@ORDERDIRABB VARCHAR(4) 

				SELECT @ORDERCOLABB = JSON_Value (value, '$.column'), @ORDERDIRABB = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				DECLARE @orderByClauseABB VARCHAR(MAX) = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOLABB AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 2 THEN 'AD'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 3 THEN 'SOYAD'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 4 THEN 'convert(DATE, DOGUMTARIHI, 104)'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 5 THEN 'convert(DATE, TESTTARIHI, 104)'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 6 THEN 'KYE_ADSOYAD'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 7 THEN 'YAS'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 8 THEN 'TEST'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 9 THEN 'TOPLAMPUAN'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 10 THEN 'ID'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 11 THEN 'DOSYA'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 12 THEN 'DOSYAUZMAN'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 13 THEN 'AKTIF'
							END
						+ ' ' + CAST(@ORDERDIRABB AS VARCHAR)
		

				DECLARE @whereClauseABB VARCHAR(MAX) = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				DECLARE @displayStartABB INT = (SELECT start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)) 
				DECLARE @displayLengthABB INT = (SELECT length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF @whereClauseABB <> ''
				BEGIN
					DECLARE @COLUMNSABB VARCHAR(max) = ''
					SET @COLUMNSABB='(TCKIMLIKNO LIKE ''%' + @whereClauseABB + '%'' OR AD LIKE ''%' + @whereClauseABB + '%'' OR SOYAD LIKE ''%' + @whereClauseABB + '%'' OR DOGUMTARIHI LIKE ''%' + @whereClauseABB + '%'' OR TESTTARIHI LIKE ''%' + @whereClauseABB + '%'' OR KYE_KULLANICI LIKE ''%' + @whereClauseABB + '%'' OR YAS LIKE ''%' + @whereClauseABB + '%'' OR TEST LIKE ''%' + @whereClauseABB + '%'' OR TOPLAMPUAN LIKE ''%' + @whereClauseABB + '%'' OR DOSYA LIKE ''%' + @whereClauseABB + '%'')'

					SET @whereClauseABB='WHERE ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
									+ CASE @DURUM WHEN 0 THEN '' WHEN 1 THEN 'AND 1 = AKTIF' WHEN 2 THEN 'AND 0 = AKTIF' END
									+ ' AND ' + @COLUMNSABB
				END
				ELSE
				BEGIN
					SET @whereClauseABB='WHERE ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
									+ CASE @DURUM WHEN 0 THEN '' WHEN 1 THEN 'AND 1 = AKTIF' WHEN 2 THEN 'AND 0 = AKTIF' END
				END

				Declare @queryABB varchar(MAX)
				set @queryABB='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClauseABB+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT	O.TCKIMLIKNO
												,ISNULL(OK.AD, O.AD) AS AD
												,ISNULL(OK.SOYAD, O.SOYAD) AS SOYAD
												,ISNULL(CONVERT(VARCHAR, OK.DOGUMTARIHI, 104)
												,CONVERT(VARCHAR, O.DOGUMTARIHI, 104)) AS DOGUMTARIHI
												,CONVERT(VARCHAR, OZT.TESTTARIHI, 104) AS TESTTARIHI
												,KK.AD + '' '' + KK.SOYAD AS KYE_ADSOYAD
												,dbo.fn_DateDiffasYAG(ISNULL(OK.DOGUMTARIHI, O.DOGUMTARIHI), OZT.TESTTARIHI) AS YAS
												,Z.AD AS TEST
												,ISNULL((SELECT CAST(P.PUAN AS VARCHAR) FROM ZekaTestOgrenciPuan P WHERE P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND P.ID_ZEKATESTSORU = CASE WHEN Z.ID_ZEKATEST = 1 THEN 5 WHEN Z.ID_ZEKATEST = 2 THEN 20 ELSE 21 END), ''-'') AS TOPLAMPUAN
												,D.GUID + ''.'' + D.TIP AS DOSYA
												,DUZMAN.GUID + ''.'' + DUZMAN.TIP AS DOSYAUZMAN
												,OZT.KYE_KULLANICI
												,OZT.ID_ZEKATESTOGRENCIZEKATEST AS ID
												,OZT.AKTIF AS AKTIF
										FROM ZekaTestOgrenci O
										INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI
										LEFT JOIN OkyanusDB.dbo.v3Kullanici OK ON OK.TCKIMLIKNO = O.TCKIMLIKNO
										INNER JOIN OkyanusDB.dbo.v3Kullanici KK ON KK.TCKIMLIKNO = OZT.KYE_KULLANICI
										INNER JOIN ZekaTest Z ON Z.ID_ZEKATEST = OZT.ID_ZEKATEST
										LEFT JOIN ZekaTestOgrenciDosya D ON D.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND D.ID_ZEKATESTOGRENCIDOSYATUR = 1
										LEFT JOIN ZekaTestOgrenciDosya DUZMAN ON DUZMAN.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND DUZMAN.ID_ZEKATESTOGRENCIDOSYATUR = 2
									) AS XTABLE
									'+@whereClauseABB+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStartABB)+' AND '+CONVERT(VARCHAR(MAX),(@displayStartABB+@displayLengthABB))+ ' FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM ZekaTestOgrenciZekaTest) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@queryABB)
			END

			IF @ISLEM = 12	--	PASİF YAP
			BEGIN
				UPDATE ZekaTestOgrenciZekaTest SET AKTIF = 0 WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST
			END

			IF @ISLEM = 13	--	AKTİF YAP
			BEGIN
				UPDATE ZekaTestOgrenciZekaTest SET AKTIF = 1 WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST
			END

			IF @ISLEM = 14	--	SORU LİSTELE - GÜNCELLEME
			BEGIN
				SET @ID_ZEKATEST = (SELECT ID_ZEKATEST FROM ZekaTestOgrenciZekaTest WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST)

				SELECT O.ID_ZEKATESTOGRENCI, S.ID_ZEKATESTSORU, P.PUAN, OZT.KYE_KULLANICI
				INTO #OGRENCIGUNCELLEME
				FROM ZekaTestOgrenci O
				INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI 
				INNER JOIN ZekaTestOgrenciPuan P ON P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST 
				INNER JOIN ZekaTestSoru S ON S.ID_ZEKATESTSORU = P.ID_ZEKATESTSORU
				INNER JOIN ZekaTestKategori K ON K.ID_ZEKATESTKATEGORI = S.ID_ZEKATESTKATEGORI
				WHERE OZT.ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST

				SELECT
				(
					SELECT 
					@ID_ZEKATEST AS ID_ZEKATEST,
					(
						SELECT ZTK.AD AS KATEGORI, (SELECT ZTS.ID_ZEKATESTSORU, ZTS.SORU, ZTS.KALIN, ISNULL(CAST(O.PUAN AS VARCHAR), '') AS PUAN FROM ZekaTestSoru ZTS LEFT JOIN #OGRENCIGUNCELLEME O ON O.ID_ZEKATESTSORU = ZTS.ID_ZEKATESTSORU WHERE ZTS.ID_ZEKATESTKATEGORI = ZTK.ID_ZEKATESTKATEGORI FOR JSON PATH, INCLUDE_NULL_VALUES) AS SORULIST
						FROM ZekaTest ZT
						INNER JOIN ZekaTestKategori ZTK ON ZTK.ID_ZEKATEST = ZT.ID_ZEKATEST
						WHERE ZT.ID_ZEKATEST = @ID_ZEKATEST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS KATEGORILIST,
					(SELECT ID_ZEKATESTOGRENCIDOSYA, GUID + '.' + TIP AS URL FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST AND ID_ZEKATESTOGRENCIDOSYATUR = 1 FOR JSON PATH) AS DOSYA,
					(SELECT ID_ZEKATESTOGRENCIDOSYA, GUID + '.' + TIP AS URL FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST AND ID_ZEKATESTOGRENCIDOSYATUR = 2 FOR JSON PATH) AS DOSYAUZMAN FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				)		

				DROP TABLE #OGRENCIGUNCELLEME
			END

			IF @ISLEM = 15	--	GÜNCELLE
			BEGIN
				DELETE P FROM ZekaTestOgrenciPuan P 
				WHERE P.ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST		

				INSERT INTO ZekaTestOgrenciPuan (ID_ZEKATESTOGRENCIZEKATEST, ID_ZEKATESTSORU, PUAN)
				SELECT	@ID_ZEKATESTOGRENCIZEKATEST,
						JSON_Value (S.value, '$.ID_ZEKATESTSORU') as ID_ZEKATESTSORU,
						JSON_Value (S.value, '$.PUAN') as ID_ZEKATESTSORU
				FROM OPENJSON(@SQLJSON_SORU, '$.KATEGORILIST') AS K
				CROSS APPLY OPENJSON (K.value, '$.SORULIST') as S
				WHERE JSON_Value (S.value, '$.PUAN') <> ''

				SELECT @ID_ZEKATESTOGRENCIZEKATEST
			END
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_ZumreCalisma]    Script Date: 23.11.2021 15:46:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_ZumreCalisma]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,

	@SQLJSON					VARCHAR(MAX)	= NULL,
	@ID_ZUMRECALISMA			INT				= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@ID_SUBE					INT				= NULL,
	@ID_ZUMRECALISMAKATILIMCI	INT				= NULL,

	@ID_KULLANICITIPILIST		VARCHAR(MAX)	= NULL,
	@BRANSLIST					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@TCKIMLIKNO_KULLANICI		VARCHAR(11)		= NULL,
	@ONAY						BIT				= NULL,
	@DURUM						INT				= NULL,
	@BROWSER					VARCHAR(MAX)	= NULL,
	@IP							VARCHAR(MAX)	= NULL,
	@TC_KIMLIK_LIST				VARCHAR(MAX)	= NULL

AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU
											
				,SQLJSON					= @SQLJSON
				,ID_ZUMRECALISMA			= @ID_ZUMRECALISMA
				,DONEM						= @DONEM
				,ID_SUBE					= @ID_SUBE
				,ID_ZUMRECALISMAKATILIMCI	= @ID_ZUMRECALISMAKATILIMCI
				,ID_KULLANICITIPILIST		= @ID_KULLANICITIPILIST
				,BRANSLIST					= @BRANSLIST
				,ID_SUBELIST				= @ID_SUBELIST
				,TCKIMLIKNO_KULLANICI		= @TCKIMLIKNO_KULLANICI
				,ONAY						= @ONAY
				,DURUM						= @DURUM
				,IP							= @IP
				,YOKLAMABROWSER				= @BROWSER
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME, @IP = @IP
		
		IF @ID_LOG > 0
		BEGIN			
			DECLARE @ORDERCOL INT,
					@ORDERDIR VARCHAR(4),
					@orderByClause VARCHAR(MAX),
					@whereClause VARCHAR(MAX),
					@displayStart INT,
					@displayLength INT,
					@query varchar(MAX),
					@COLUMNS VARCHAR(max) = ''

			IF @ISLEM IN (2, 3, 6, /*8,*/ 13, 14, 15)
			BEGIN
				DECLARE @ID_ZUMRECALISMATEMP INT

				IF @ID_ZUMRECALISMA IS NULL 
				BEGIN
					SELECT @ID_ZUMRECALISMATEMP = ID_ZUMRECALISMA FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE 
				BEGIN
					SET @ID_ZUMRECALISMATEMP = @ID_ZUMRECALISMA
				END

				IF NOT EXISTS (SELECT TOP 1 1 FROM ZumreCalisma ZC WHERE ZC.ID_ZUMRECALISMA = @ID_ZUMRECALISMATEMP AND CAST(CAST(TARIH AS varchar(MAX)) + ' ' + CAST(SAAT AS varchar(MAX)) AS datetime2) > GETDATE())				
				BEGIN   /*, atama, */ 
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Zümre çalışma başladıktan sonra düzenleme, silme, onaylama gibi işlemler yapılamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 1	--	EKLE
			BEGIN	
				IF NOT EXISTS (SELECT TOP 1 1  FROM OPENJSON(@SQLJSON) WITH (DONEM VARCHAR(4), ID_SUBE INT, TARIH VARCHAR(MAX), SAAT VARCHAR(MAX)) J JOIN [dbo].[ZumreCalisma] ZC ON ZC.DONEM = J.DONEM AND ZC.ID_SUBE = J.ID_SUBE AND ZC.TARIH = J.TARIH AND ZC.SAAT = J.SAAT)
				BEGIN
					INSERT INTO [dbo].[ZumreCalisma] ([DONEM],[AD],[EGITIMCI],[ID_SUBE],[MEKAN],[TARIH],[SAAT],[KOTA],[ONAY],[YAZILILINK],[DETAY],[KYE_KULLANICI])
					SELECT [DONEM],[AD],[EGITIMCI],[ID_SUBE],[MEKAN],[TARIH],[SAAT],[KOTA],[ONAY],[YAZILILINK],[DETAY],@TCKIMLIKNO
					FROM OPENJSON(@SQLJSON)
					WITH (
						DONEM VARCHAR(4),
						AD VARCHAR(MAX),
						EGITIMCI VARCHAR(MAX),
						ID_SUBE INT,
						MEKAN VARCHAR(MAX),
						TARIH VARCHAR(MAX),
						SAAT VARCHAR(MAX),
						KOTA INT,
						ONAY BIT,
						YAZILILINK VARCHAR(MAX),
						DETAY VARCHAR(MAX)
					)
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Bir şubede aynı gün ve saatte birden fazla zümre çalışması yapılamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 2	--	GÜNCELLE
			BEGIN	
				IF NOT EXISTS (SELECT TOP 1 1  FROM OPENJSON(@SQLJSON) WITH (ID_ZUMRECALISMA INT, DONEM VARCHAR(4), ID_SUBE INT, TARIH VARCHAR(MAX), SAAT VARCHAR(MAX)) J JOIN [dbo].[ZumreCalisma] ZC ON ZC.ID_ZUMRECALISMA <> J.ID_ZUMRECALISMA AND ZC.DONEM = J.DONEM AND ZC.ID_SUBE = J.ID_SUBE AND ZC.TARIH = J.TARIH AND ZC.SAAT = J.SAAT AND ZC.AKTIF = 1)
				BEGIN
					IF (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1) <= (SELECT KOTA FROM OPENJSON(@SQLJSON) WITH (KOTA INT))
					BEGIN
						UPDATE ZC SET	 ZC.[DONEM]			= J.[DONEM]
										,ZC.[AD]			= J.[AD]
										,ZC.[EGITIMCI]		= J.[EGITIMCI]
										,ZC.[ID_SUBE]		= J.[ID_SUBE]
										,ZC.[MEKAN]			= J.[MEKAN]
										,ZC.[TARIH]			= J.[TARIH]
										,ZC.[SAAT]			= J.[SAAT]
										,ZC.[KOTA]			= J.[KOTA]
										,ZC.[ONAY]			= J.[ONAY]
										,ZC.[YAZILILINK]	= J.[YAZILILINK]
										,ZC.[DETAY]			= J.[DETAY]
										,ZC.[KYE_KULLANICI] = @TCKIMLIKNO
						FROM [dbo].[ZumreCalisma] ZC
						JOIN OPENJSON(@SQLJSON)
						WITH (
							ID_ZUMRECALISMA INT,
							DONEM VARCHAR(4),
							AD VARCHAR(MAX),
							EGITIMCI VARCHAR(MAX),
							ID_SUBE INT,
							MEKAN VARCHAR(MAX),
							TARIH VARCHAR(MAX),
							SAAT VARCHAR(MAX),
							KOTA INT,
							ONAY BIT,
							YAZILILINK VARCHAR(MAX),
							DETAY VARCHAR(MAX)
						) J ON J.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA
					END
					ELSE
					BEGIN
						EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Kota mevcut katılımcı sayısından küçük olamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
					END
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Bir şubede aynı gün ve saatte birden fazla zümre çalışması yapılamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 3	--	SİL
			BEGIN	
				UPDATE ZC SET	ZC.AKTIF = 0
				FROM [dbo].[ZumreCalisma] ZC
				WHERE ZC.ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 4	--	LİSTELE
			BEGIN
				SELECT 
				ISNULL (
				(
					SELECT	 ID_ZUMRECALISMA	= ZC.ID_ZUMRECALISMA
							,DONEM				= ZC.DONEM
							,AD					= ZC.AD
							,EGITIMCI			= ZC.EGITIMCI
							,ID_SUBE			= ZC.ID_SUBE
							,SUBE				= SB.AD 
							,MEKAN				= ZC.MEKAN
							,TARIH				= CONVERT(VARCHAR(MAX),[TARIH],104)
							,SAAT				= ZC.SAAT
							,KOTA				= ZC.KOTA
							,ONAY				= ZC.ONAY
							,YAZILILINK			= ZC.YAZILILINK
							,DETAY				= ZC.DETAY
							,KYE_KULLANICI		= ZC.KYE_KULLANICI
							,YOKLAMA_DURUM		= ZC.YOKLAMA_DURUM
							,YAZILI_DURUM		= ZC.YAZILI_DURUM
							,KATILIM_DURUM		= IIF (EXISTS(SELECT TOP 1 K.ID_ZUMRECALISMA FROM ZumreCalismaKatilimci K WHERE K.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA AND K.YOKLAMA_DURUM = 1),1,0)
					FROM ZumreCalisma			ZC
					JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE	= ZC.ID_SUBE
					WHERE	DONEM	= @DONEM 
						AND (	@ID_SUBE IS NULL 
							OR	ZC.ID_SUBE = @ID_SUBE 
							OR (	@ID_SUBE = 0 
								AND ZC.ID_SUBE IN (SELECT ID_SUBE FROM OkyanusDB.dbo.v3SubeYetki SY WHERE SY.TCKIMLIKNO = @TCKIMLIKNO)
								)
							) 
						AND AKTIF = 1
					FOR JSON PATH, INCLUDE_NULL_VALUES
				), '[]')
			END

			IF @ISLEM = 5	--	KATILIMCI LİSTELE
			BEGIN
				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				SET @orderByClause = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'ADSOYAD'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				SELECT @whereClause = value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX))
				SELECT @displayStart = start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)
				SELECT @displayLength = length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT)

				IF @whereClause <> ''
				BEGIN
					SET @COLUMNS = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR ADSOYAD LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE ' + @COLUMNS
				END

				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT	 ZCK.ID_ZUMRECALISMAKATILIMCI
												,ZCK.TCKIMLIKNO
												,TRIM(K.AD + '' '' + K.SOYAD) AS ADSOYAD
										FROM ZumreCalismaKatilimci ZCK
										JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
										--LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = ZCK.TCKIMLIKNO
										WHERE ZCK.ID_ZUMRECALISMA = '+CAST(@ID_ZUMRECALISMA AS varchar)+' AND ZCK.ONAY = 1
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' 
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = ' + CAST(@ID_ZUMRECALISMA AS varchar) + ' AND ONAY = 1) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
			END

			IF @ISLEM = 6	--	KATILIMCI SİL
			BEGIN
				DELETE FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
			END

			IF @ISLEM = 7	--	FİLTRE KULLANICI LİSTELE
			BEGIN
				SELECT	 SY.TCKIMLIKNO
						,TRIM(K.AD + ' ' + K.SOYAD) AS ADSOYAD
				INTO #TEMPTOTAL
				FROM OkyanusDB.dbo.v3SubeYetki SY
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = SY.TCKIMLIKNO-- AND O.TCKIMLIKNO <> '11111111111'
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SY.TCKIMLIKNO
				WHERE	(SY.ID_KULLANICITIPI IN (SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)) OR @ID_KULLANICITIPILIST = '[]')
				AND		(SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) OR @ID_SUBELIST = '[]')
				AND		(O.BRANS IN (SELECT VALUE FROM OPENJSON(@BRANSLIST)) OR @BRANSLIST = '[]')
				AND		(SY.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM ZumreCalismaKatilimci ZCK WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA))
				GROUP BY SY.TCKIMLIKNO, K.AD, K.SOYAD

				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				SET @orderByClause = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'ADSOYAD'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				SELECT @whereClause = value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX))
				SELECT @displayStart = start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)
				SELECT @displayLength = length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT)

				IF @whereClause <> ''
				BEGIN
					SET @COLUMNS = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR ADSOYAD LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE ' + @COLUMNS
				END

				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT * FROM #TEMPTOTAL
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' 
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM #TEMPTOTAL) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
				DROP TABLE #TEMPTOTAL
			END

			IF @ISLEM = 8	--	KATILIMCI ATA
			BEGIN
				IF NOT EXISTS (SELECT TOP 1 1 FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND TCKIMLIKNO = @TCKIMLIKNO_KULLANICI)
				BEGIN
					IF (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1) < (SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA)
					BEGIN
						INSERT INTO ZumreCalismaKatilimci(ID_ZUMRECALISMA, TCKIMLIKNO, KYE_KULLANICI)
						SELECT @ID_ZUMRECALISMA, @TCKIMLIKNO_KULLANICI, @TCKIMLIKNO
					END
					ELSE
					BEGIN
						EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Belirlenen katılımcı kotası dolu!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
					END
				END
			END

			IF @ISLEM = 9	--	KATILIMCI EXCEL
			BEGIN
				SELECT	 ZCK.TCKIMLIKNO
						,UPPER(TRIM(K.AD + ' ' + K.SOYAD)) AS ADSOYAD
						,eokul_v2.dbo.Fn_SubeYetkiGetir(K.TCKIMLIKNO) AS SUBEYETKI
						,ISNULL(O.BRANS, '') AS BRANS
						,UPPER(TRIM(K2.AD + ' ' + K2.SOYAD)) AS EKLEYENADSOYAD
				FROM ZumreCalismaKatilimci ZCK
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = ZCK.KYE_KULLANICI
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ZCK.ONAY = 1
				ORDER BY ADSOYAD
			END

			IF @ISLEM = 10	--	ZÜMRE ÇALIŞMA LİSTE
			BEGIN
				SELECT 
				ISNULL (
				(
					SELECT [ID_ZUMRECALISMA], [AD]
					FROM [dbo].[ZumreCalisma]
					WHERE DONEM = @DONEM AND (@ID_SUBE IS NULL OR ID_SUBE = @ID_SUBE) AND AKTIF = 1
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 11	--	ONAY ZÜMRE ÇALIŞMA LİSTE
			BEGIN
				SELECT 
				ISNULL (
				(
					SELECT [ID_ZUMRECALISMA], [AD]
					FROM [dbo].[ZumreCalisma]
					WHERE DONEM = @DONEM AND (@ID_SUBE IS NULL OR ID_SUBE = @ID_SUBE) AND AKTIF = 1 AND ONAY = 1 --AND CAST(CAST(TARIH AS varchar(MAX)) + ' ' + CAST(SAAT AS varchar(MAX)) AS datetime2) > GETDATE()
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 12	--	FİLTRE KULLANICI LİSTELE - ONAY
			BEGIN
				SELECT	 SY.TCKIMLIKNO
						,TRIM(K.AD + ' ' + K.SOYAD) AS ADSOYAD
						,ZCK.ID_ZUMRECALISMAKATILIMCI
				INTO #TEMPTOTAL12
				FROM OkyanusDB.dbo.v3SubeYetki SY
				JOIN ZumreCalismaKatilimci ZCK ON ZCK.TCKIMLIKNO = SY.TCKIMLIKNO AND ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = @ONAY
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SY.TCKIMLIKNO
				AND		(SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) OR @ID_SUBELIST = '[]')
				GROUP BY SY.TCKIMLIKNO, K.AD, K.SOYAD, ZCK.ID_ZUMRECALISMAKATILIMCI

				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				SET @orderByClause = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'ADSOYAD'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				SELECT @whereClause = value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX))
				SELECT @displayStart = start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)
				SELECT @displayLength = length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT)

				IF @whereClause <> ''
				BEGIN
					SET @COLUMNS = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR ADSOYAD LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE ' + @COLUMNS
				END

				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT * FROM #TEMPTOTAL12
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' 
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM #TEMPTOTAL12) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
				DROP TABLE #TEMPTOTAL12
			END

			IF @ISLEM = 13	--	KATILIMCI ONAY
			BEGIN	
				DECLARE @ID_ZUMRECALISMA13 INT
				SELECT @ID_ZUMRECALISMA13 = ID_ZUMRECALISMA FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				IF (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA13 AND ONAY = 1) < (SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA13) OR @ONAY = 0
				BEGIN
					UPDATE ZumreCalismaKatilimci SET ONAY = @ONAY, ONAY_KULLANICI = @TCKIMLIKNO, ONAY_TARIH = GETDATE() WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Belirlenen katılımcı kotası dolu!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END	
			END

			IF @ISLEM = 14	--	KATILIMCI ATA TOPLU
			BEGIN
				SELECT	 SY.TCKIMLIKNO
						,TRIM(K.AD + ' ' + K.SOYAD) AS ADSOYAD
				INTO #TEMPTOTAL14
				FROM OkyanusDB.dbo.v3SubeYetki SY
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = SY.TCKIMLIKNO-- AND O.TCKIMLIKNO <> '11111111111'
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SY.TCKIMLIKNO
				WHERE	(SY.ID_KULLANICITIPI IN (SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)) OR @ID_KULLANICITIPILIST = '[]')
				AND		(SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) OR @ID_SUBELIST = '[]')
				AND		(O.BRANS IN (SELECT VALUE FROM OPENJSON(@BRANSLIST)) OR @BRANSLIST = '[]')
				AND		(SY.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM ZumreCalismaKatilimci ZCK WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA))
				GROUP BY SY.TCKIMLIKNO, K.AD, K.SOYAD

				IF (SELECT COUNT(1) FROM #TEMPTOTAL14) + (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1) <= (SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA)
				BEGIN
					INSERT INTO ZumreCalismaKatilimci (ID_ZUMRECALISMA, TCKIMLIKNO, KYE_KULLANICI)
					SELECT @ID_ZUMRECALISMA, TCKIMLIKNO, @TCKIMLIKNO FROM #TEMPTOTAL14
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Tümünü ekleyebilmek için yeterli kota yok!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END

				DROP TABLE #TEMPTOTAL14
			END

			IF @ISLEM = 15	--	KATILIMCI SİL TOPLU
			BEGIN
				DELETE FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1
			END

			IF @ISLEM = 16	--	YOKLAMA DURUM GÜNCELLE
			BEGIN
				UPDATE ZumreCalisma SET YOKLAMA_DURUM = @DURUM WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 17	--	YOKLAMA EXCEL
			BEGIN
				SELECT	 ZCK.TCKIMLIKNO
						,UPPER(TRIM(K.AD + ' ' + K.SOYAD)) AS ADSOYAD
						,eokul_v2.dbo.Fn_SubeYetkiGetir(K.TCKIMLIKNO) AS SUBEYETKI
						,ISNULL(O.BRANS, '') AS BRANS
						,UPPER(TRIM(K2.AD + ' ' + K2.SOYAD)) AS EKLEYENADSOYAD
						,CASE WHEN ZCK.YOKLAMA_DURUM = 1 THEN 'X' ELSE '' END AS YOKLAMA_DURUM
				FROM ZumreCalismaKatilimci ZCK
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = ZCK.KYE_KULLANICI
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ZCK.ONAY = 1
				ORDER BY ADSOYAD
			END

			IF @ISLEM = 18	--	YOKLAMA LİSTELE
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT ZCK.ID_ZUMRECALISMAKATILIMCI, ZCK.YOKLAMA_DURUM, ZC.AD, ZC.EGITIMCI, ZC.MEKAN, CONVERT(VARCHAR(MAX),[TARIH],104) AS TARIH, CAST(ZC.SAAT AS VARCHAR(5)) AS SAAT
					FROM ZumreCalismaKatilimci ZCK 
					JOIN ZumreCalisma ZC ON ZC.ID_ZUMRECALISMA = ZCK.ID_ZUMRECALISMA
					WHERE ZCK.TCKIMLIKNO = @TCKIMLIKNO AND ZC.AKTIF = 1 AND ZC.YOKLAMA_DURUM = 1 AND ZCK.ONAY = 1
					FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 19	--	YOKLAMA GİRİŞ GÜNCELLE
			BEGIN
				IF 1 = (SELECT ZC.YOKLAMA_DURUM FROM ZumreCalisma ZC JOIN ZumreCalismaKatilimci ZCK ON ZCK.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA WHERE ZCK.ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI)
				BEGIN
					UPDATE ZumreCalismaKatilimci SET YOKLAMA_DURUM = @DURUM, YOKLAMA_TARIH = GETDATE(), YOKLAMA_IP = @IP, YOKLAMA_BROWSER = @BROWSER WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE 
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Zümre çalışma için yoklama işlemi sonra erdiğinden kayıt işlemi gerçekleşmedi!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 20	--	YAZILI DURUM GÜNCELLE
			BEGIN
				UPDATE ZumreCalisma SET YAZILI_DURUM = @DURUM WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 21	--	YAZILI EXCEL
			BEGIN
				SELECT	 ZCK.TCKIMLIKNO
						,UPPER(TRIM(K.AD + ' ' + K.SOYAD)) AS ADSOYAD
						,eokul_v2.dbo.Fn_SubeYetkiGetir(K.TCKIMLIKNO) AS SUBEYETKI
						,ISNULL(O.BRANS, '') AS BRANS
						,UPPER(TRIM(K2.AD + ' ' + K2.SOYAD)) AS EKLEYENADSOYAD
						,CASE WHEN ZCK.YAZILI_DURUM = 1 THEN 'X' ELSE '' END AS YAZILI_DURUM
				FROM ZumreCalismaKatilimci ZCK
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = ZCK.KYE_KULLANICI
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ZCK.ONAY = 1
				ORDER BY ADSOYAD
			END

			IF @ISLEM = 22	--	YAZILI VAR MI?
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT ZCK.ID_ZUMRECALISMAKATILIMCI, ZCK.YAZILI_DURUM, ZC.AD, ZC.EGITIMCI, ZC.MEKAN, CONVERT(VARCHAR(MAX),[TARIH],104) AS TARIH, CAST(ZC.SAAT AS VARCHAR(5)) AS SAAT, ZC.YAZILILINK
					FROM ZumreCalismaKatilimci ZCK 
					JOIN ZumreCalisma ZC ON ZC.ID_ZUMRECALISMA = ZCK.ID_ZUMRECALISMA
					WHERE ZCK.TCKIMLIKNO = @TCKIMLIKNO AND ZC.AKTIF = 1 AND ZC.YAZILI_DURUM = 1 AND ZCK.ONAY = 1
					FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 23	--	YAZILI GİRİŞ GÜNCELLE
			BEGIN
				IF 1 = (SELECT ZC.YAZILI_DURUM FROM ZumreCalisma ZC JOIN ZumreCalismaKatilimci ZCK ON ZCK.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA WHERE ZCK.ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI)
				BEGIN
					UPDATE ZumreCalismaKatilimci SET YAZILI_DURUM = @DURUM, YAZILI_TARIH = GETDATE(), YAZILI_IP = @IP, YAZILI_BROWSER = @BROWSER WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE 
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Zümre çalışma için yazılı işlemi sonra erdiğinden kayıt işlemi gerçekleşmedi!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 24	--	YAZILI NOT VAR MI
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT TCKIMLIKNO, YAZILI_NOT 
					FROM ZumreCalismaKatilimci 
					WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND YAZILI_NOT IS NOT NULL
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 25	--	YAZILI NOT YUKLE
			BEGIN
				UPDATE ZumreCalismaKatilimci SET YAZILI_NOT = NULL WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA

				UPDATE ZCK SET ZCK.YAZILI_NOT = J.YAZILI_NOT, ZCK.YAZILI_NOT_KULLANICI = @TCKIMLIKNO, ZCK.YAZILI_NOT_TARIH = GETDATE()
				FROM ZumreCalismaKatilimci ZCK
				JOIN OPENJSON(@SQLJSON)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					YAZILI_NOT INT
				) J ON J.TCKIMLIKNO = ZCK.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 26	--	ÇALIŞMALARIM
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT	 ZC.ID_ZUMRECALISMA
							,ZC.AD
							,ZC.MEKAN
							,ZC.EGITIMCI
							,CONVERT(VARCHAR(MAX), ZC.TARIH, 104) + ' ' + CAST(ZC.SAAT AS VARCHAR(5)) AS TARIH
							,ZCK.YOKLAMA_DURUM
							,ISNULL(CAST(ZCK.YAZILI_NOT AS VARCHAR), 'GİRİLMEDİ') AS YAZILI
							,ZCK.ID_ZUMRECALISMAKATILIMCI
					FROM ZumreCalismaKatilimci ZCK
					JOIN ZumreCalisma ZC ON ZC.ID_ZUMRECALISMA = ZCK.ID_ZUMRECALISMA
					WHERE ZC.AKTIF = 1 AND ZCK.TCKIMLIKNO = @TCKIMLIKNO AND ZCK.ONAY = 1
					ORDER BY ZC.ID_ZUMRECALISMA DESC
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 27	--	KATILIM BELGESİ
			BEGIN

				SELECT	 ZC.EGITIMCI
						,CONVERT(VARCHAR(MAX), ZC.TARIH, 104) + ' ' + CAST(ZC.SAAT AS VARCHAR(5)) AS TARIH
						,ADSOYAD = CONCAT_WS(' ',K.AD,K.SOYAD)
						,KONU = ZC.AD
				FROM ZumreCalismaKatilimci	ZCK
				JOIN ZumreCalisma			ZC	ON	ZC.ID_ZUMRECALISMA	= ZCK.ID_ZUMRECALISMA
				JOIN v3Kullanici			K	ON	K.TCKIMLIKNO		= ZCK.TCKIMLIKNO
				WHERE	ZC.AKTIF			= 1
					AND ZCK.ONAY			= 1
					AND ZCK.YOKLAMA_DURUM	= 1
					AND (	ZCK.ID_ZUMRECALISMA			= @ID_ZUMRECALISMA	
						OR	ZCK.ID_ZUMRECALISMAKATILIMCI= @ID_ZUMRECALISMAKATILIMCI
						)
				ORDER BY ADSOYAD
				
			END

			IF @ISLEM=28 --EXCEL TOPLU KATILIM SUBE,KULLANICITIP,BRANS ve DAHA ONCE EKLENMISMI KONTROL
			BEGIN
				DROP TABLE IF EXISTS #HATALI_LIST
				CREATE TABLE #HATALI_LIST(TCKIMLIKNO  VARCHAR(11),ADSOYAD NVARCHAR(300),ERR_CODE INT,ERR_MESSAGE VARCHAR(500))

				DROP TABLE IF EXISTS #EXCEL_TC_LIST
				SELECT * INTO #EXCEL_TC_LIST FROM (
													SELECT K.ID_KULLANICI,K.TCKIMLIKNO,K.AD,K.SOYAD,O.BRANS,SY.ID_KULLANICITIPI,KT.AD AS KULLANICITIP_AD,S.ID_SUBE,S.AD AS SUBEAD FROM v3Kullanici AS K
													JOIN v3Ogretmen AS O
													ON O.TCKIMLIKNO=K.TCKIMLIKNO
													JOIN v3SubeYetki AS SY
													ON SY.TCKIMLIKNO=K.TCKIMLIKNO
													JOIN v3KullaniciTipi AS KT
													ON KT.ID_KULLANICITIPI=SY.ID_KULLANICITIPI
													JOIN v3Sube AS S
													ON S.ID_SUBE=SY.ID_SUBE
													WHERE K.TCKIMLIKNO IN(SELECT VALUE FROM OPENJSON(@TC_KIMLIK_LIST))
													) as TCLIST

				DROP TABLE IF EXISTS #SECILI_SUBE_LIST
				SELECT *
				INTO #SECILI_SUBE_LIST
				FROM(
					SELECT ID_SUBE,SUBENO,AD,ILCE FROM v3Sube WHERE ID_SUBE IN(SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
					) as tmp

				--SUBEID 'si seçili filtrele içinde yoksa hatalı dataya ekleniyor.
				INSERT INTO #HATALI_LIST(TCKIMLIKNO ,ADSOYAD,ERR_CODE,ERR_MESSAGE)
				SELECT TCKIMLIKNO AS TCKIMLIKNO,TCL.AD+' '+SOYAD AS ADSOYAD,1 AS ERR_CODE,'Filtrede Seçilen Şubede Yetkisi Yok' AS ERR_MESSAGE
				FROM  #EXCEL_TC_LIST TCL
				LEFT JOIN #SECILI_SUBE_LIST AS SL
				ON TCL.ID_SUBE=SL.ID_SUBE
				WHERE SL.ID_SUBE IS NULL

				DELETE FROM #EXCEL_TC_LIST WHERE TCKIMLIKNO IN(SELECT TCKIMLIKNO FROM #HATALI_LIST)

				DROP TABLE IF EXISTS #SECILI_KULLANICITIP_LIST
				SELECT *
				INTO #SECILI_KULLANICITIP_LIST
				FROM(
					SELECT ID_KULLANICITIPI,AD FROM v3KullaniciTipi WHERE ID_KULLANICITIPI IN(SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST))
					) as KTIP

				--KULLANICITIPI seçili filtrele içinde yoksa hatalı dataya ekleniyor.
				INSERT INTO #HATALI_LIST(TCKIMLIKNO ,ADSOYAD,ERR_CODE,ERR_MESSAGE)
				SELECT TCKIMLIKNO AS TCKIMLIKNO,TCL.AD+' '+SOYAD AS ADSOYAD,1 AS ERR_CODE,'Filtrede Seçilen Kullanıcı Tipi ile Uyuşmuyor' AS ERR_MESSAGE
				FROM  #EXCEL_TC_LIST TCL
				LEFT JOIN #SECILI_KULLANICITIP_LIST AS KTL
				ON TCL.ID_KULLANICITIPI=KTL.ID_KULLANICITIPI
				WHERE KTL.ID_KULLANICITIPI IS NULL

				DELETE FROM #EXCEL_TC_LIST WHERE TCKIMLIKNO IN(SELECT TCKIMLIKNO FROM #HATALI_LIST)

				DROP TABLE IF EXISTS #SECILI_BRANS_LIST
				SELECT *
				INTO #SECILI_BRANS_LIST
				FROM(
					SELECT * FROM v3Ogretmen WHERE BRANS IN(SELECT VALUE FROM OPENJSON(@BRANSLIST))
					) as tmp

				--BRANS seçili filtrele içinde yoksa hatalı dataya ekleniyor.
				INSERT INTO #HATALI_LIST(TCKIMLIKNO ,ADSOYAD,ERR_CODE,ERR_MESSAGE)
				SELECT TCL.TCKIMLIKNO AS TCKIMLIKNO,TCL.AD+' '+SOYAD AS ADSOYAD,1 AS ERR_CODE,'Filtrede Seçilen Branş ile Uyuşmuyor' AS ERR_MESSAGE
				FROM  #EXCEL_TC_LIST TCL
				LEFT JOIN #SECILI_BRANS_LIST AS BL
				ON TCL.BRANS=BL.BRANS
				WHERE BL.BRANS IS NULL

				DELETE FROM #EXCEL_TC_LIST WHERE TCKIMLIKNO IN(SELECT TCKIMLIKNO FROM #HATALI_LIST)

				--KATILIMCI daha önce eklenmiş ise hatalı dataya ekleniyor.
				INSERT INTO #HATALI_LIST(TCKIMLIKNO,ADSOYAD,ERR_CODE,ERR_MESSAGE)
				SELECT TCL.TCKIMLIKNO AS TCKIMLIKNO,TCL.AD+' '+SOYAD AS ADSOYAD,1 AS ERR_CODE,'Bu katılımcı daha önce eklenmiş' AS ERR_MESSAGE
				FROM  #EXCEL_TC_LIST TCL
				LEFT JOIN  ZumreCalismaKatilimci ZC
				ON TCL.TCKIMLIKNO=ZC.TCKIMLIKNO
				WHERE ZC.ID_ZUMRECALISMA=@ID_ZUMRECALISMA AND ZC.TCKIMLIKNO IS NOT NULL

				DELETE FROM #EXCEL_TC_LIST WHERE TCKIMLIKNO IN(SELECT TCKIMLIKNO FROM #HATALI_LIST)
				
				--HATALI DATA ve HATASIZ DATA birleştirilerek geri dönülecek tablo oluşturuluyor
				DECLARE @RETURN_DATA NVARCHAR(MAX)=''
				DROP TABLE IF EXISTS #RETURN_TABLE
				SELECT * INTO #RETURN_TABLE FROM(
				SELECT TCKIMLIKNO AS TCKIMLIKNO,AD+' '+SOYAD AS ADSOYAD,0 AS ERR_CODE,'' AS ERR_MESSAGE FROM #EXCEL_TC_LIST
				UNION
				SELECT TCKIMLIKNO,ADSOYAD,ERR_CODE,ERR_MESSAGE FROM #HATALI_LIST
				) AS A

				SET @RETURN_DATA= (SELECT  DISTINCT(TCKIMLIKNO),*,(SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA) AS KOTA FROM #RETURN_TABLE ORDER BY ERR_CODE FOR JSON AUTO)

				SELECT @RETURN_DATA

			END

			IF @ISLEM=29
			BEGIN
				DECLARE @LASTINSERTID INT =0
				
 				SELECT * INTO #EXCEL_INSERT_TC_LIST FROM (SELECT TCKIMLIKNO FROM v3Kullanici WHERE TCKIMLIKNO IN(SELECT VALUE FROM OPENJSON(@TC_KIMLIK_LIST))) as TCLIST
 				INSERT INTO ZumreCalismaKatilimci(ID_ZUMRECALISMA, TCKIMLIKNO, KYE_KULLANICI) 
				SELECT @ID_ZUMRECALISMA,TCKIMLIKNO,@TCKIMLIKNO FROM #EXCEL_INSERT_TC_LIST
				 
				DECLARE @RESULT_INSERT INT=(SELECT SCOPE_IDENTITY())
				SELECT @RESULT_INSERT

				

			END
		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END


