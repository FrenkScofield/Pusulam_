
GO
CREATE TABLE [dbo].[EOgrenmeLog] (
    [ID_EOgrenmeLog] INT          IDENTITY (1, 1) NOT NULL,
    [ID_EOgrenmeTur] INT          NOT NULL,
    [SECILI]         BIT          NOT NULL,
    [TCKIMLIKNO]     VARCHAR (11) NOT NULL,
    [DONEM]          VARCHAR (4)  NOT NULL,
    CONSTRAINT [PK_EOgrenmeLog] PRIMARY KEY CLUSTERED ([ID_EOgrenmeLog] ASC)
);


GO
PRINT N'Altering Procedure [dbo].[sp_Duyuru]...';


GO
ALTER procedure [dbo].[sp_Duyuru]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_DUYURU				INT				= NULL,
	@ID_KULLANICITIPILIST	VARCHAR(MAX)	= NULL,
	@ID_SUBELIST			VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@GUID					VARCHAR(MAX)	= NULL,
	@MOBIL_BANNER			BIT				= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,ID_DUYURU				= @ID_DUYURU	
				,ID_KULLANICITIPILIST	= @ID_KULLANICITIPILIST
				,ID_SUBELIST			= @ID_SUBELIST
				,SQLJSON				= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @ID_LOG > 0
		BEGIN
			IF @ISLEM = 1	--	DUYURU EKLE				
			BEGIN
				
				SELECT TOP 1 * 
				INTO #DUYURU
				FROM OPENJSON(@SQLJSON)
				WITH(	ID_DUYURU				INT,
						BANNER					BIT,
						TCKIMLIKNO				NVARCHAR(MAX),
						OTURUM					NVARCHAR(MAX),
						ID_KULLANICITIPILIST	NVARCHAR(MAX),
						ID_SUBELIST				NVARCHAR(MAX),
						BASLIK					NVARCHAR(MAX),
						ICERIK					NVARCHAR(MAX),
						BAS_TARIH				NVARCHAR(MAX),
						BIT_TARIH				NVARCHAR(MAX),
						ID_KADEMELIST			NVARCHAR(MAX),
						ID_KADEME3LIST			NVARCHAR(MAX),
						ID_SINIFLIST			NVARCHAR(MAX),
						FOTOGRAF				NVARCHAR(MAX),
						FOTOGRAF_MOBIL			NVARCHAR(MAX),
						DOSYALIST				NVARCHAR(MAX))


				DECLARE @ID TABLE (ID INT)
				INSERT INTO Duyuru (BASLIK,ICERIK,BANNER,FOTOGRAF,FOTOGRAF_MOBIL,BAS_TARIH,BIT_TARIH,KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_DUYURU INTO @ID(ID)
				SELECT TOP 1 BASLIK,ICERIK,BANNER,FOTOGRAF,FOTOGRAF_MOBIL,BAS_TARIH,BIT_TARIH,@TCKIMLIKNO AS KYE_TCKIMLIKNO FROM #DUYURU
				SET @ID_DUYURU = (SELECT TOP 1 ID FROM @ID)

				SELECT VALUE AS ID_KULLANICITIPI INTO #ID_KULLANICITIPILIST FROM OPENJSON(( SELECT TOP 1 ID_KULLANICITIPILIST	FROM #DUYURU))
				SELECT VALUE AS ID_SUBE			 INTO #ID_SUBELIST			FROM OPENJSON(( SELECT TOP 1 ID_SUBELIST			FROM #DUYURU))
				SELECT VALUE AS ID_KADEME		 INTO #ID_KADEMELIST		FROM OPENJSON(( SELECT TOP 1 ID_KADEMELIST			FROM #DUYURU))
				SELECT VALUE AS ID_KADEME3		 INTO #ID_KADEME3LIST		FROM OPENJSON(( SELECT TOP 1 ID_KADEME3LIST			FROM #DUYURU))
				SELECT VALUE AS ID_SINIF		 INTO #ID_SINIFLIST			FROM OPENJSON(( SELECT TOP 1 ID_SINIFLIST			FROM #DUYURU))
				SELECT VALUE AS DOSYA			 INTO #DOSYALIST			FROM OPENJSON(( SELECT TOP 1 DOSYALIST				FROM #DUYURU))


				IF EXISTS(SELECT * FROM #ID_KULLANICITIPILIST WHERE ID_KULLANICITIPI IN (4,5)) -- ÖĞRENCİ VEYA VELİ İSE
				BEGIN

					IF EXISTS(SELECT * FROM #ID_SINIFLIST)
					BEGIN

						SELECT GS.ID_SINIF, GS.ID_KADEME, GS.ID_KADEME3, GS.ID_SUBE
						INTO #SINIFLIST
						FROM #ID_SINIFLIST	SN
						JOIN Pusulam.DBO.vw_SubeSinifGrupKademeTum	GS	ON	GS.ID_SINIF		= SN.ID_SINIF

						INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
						SELECT @ID_DUYURU, ID_KULLANICITIPI, SNL.ID_SUBE, SNL.ID_KADEME, SNL.ID_KADEME3, SNL.ID_SINIF 
						FROM #ID_KULLANICITIPILIST	KL
						CROSS APPLY #SINIFLIST		SNL	
						WHERE KL.ID_KULLANICITIPI IN (4,5)

						DROP TABLE #SINIFLIST

					END
					ELSE
					BEGIN

						INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
						SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, NULL
						FROM #ID_KULLANICITIPILIST	KL
						OUTER APPLY #ID_SUBELIST	SL
						OUTER APPLY #ID_KADEMELIST	KDL
						OUTER APPLY #ID_KADEME3LIST	K3L
						WHERE KL.ID_KULLANICITIPI IN (4,5)

					END
				END

				INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI,ID_SUBE)
				SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE
				FROM #ID_KULLANICITIPILIST	KTL
				OUTER APPLY #ID_SUBELIST	SL
				WHERE ID_KULLANICITIPI NOT IN (4,5)

				INSERT INTO DuyuruDosya (ID_DUYURU, DOSYAYOL)
				SELECT @ID_DUYURU, DOSYA FROM #DOSYALIST

				SELECT @ID_DUYURU ID_DUYURU
				
				DROP TABLE IF EXISTS #DUYURU
				DROP TABLE IF EXISTS #ID_KULLANICITIPILIST 
				DROP TABLE IF EXISTS #ID_SUBELIST			
				DROP TABLE IF EXISTS #ID_KADEMELIST		
				DROP TABLE IF EXISTS #ID_KADEME3LIST		
				DROP TABLE IF EXISTS #ID_SINIFLIST			
				DROP TABLE IF EXISTS #DOSYALIST	
			END

			IF @ISLEM = 2	--	DUYURU LİSTE			
			BEGIN

				SELECT ISNULL((
					SELECT	DISTINCT
							 D.ID_DUYURU
							,D.FOTOGRAF
							,D.FOTOGRAF_MOBIL
							,ADSOYAD	= K.AD + ' ' + K.SOYAD
							,BAS_TARIH	= CONVERT(VARCHAR,D.BAS_TARIH,104)
							,BIT_TARIH	= CONVERT(VARCHAR,D.BIT_TARIH,104)
							,YAYINTARIHI= CONVERT(VARCHAR, D.BAS_TARIH, 104) +' - ' + CONVERT(VARCHAR, D.BIT_TARIH, 104)
							,D.BASLIK
							,D.AKTIF
							,ISLEM = NULL
							,CEKLER = NULL
					FROM Duyuru					D
					JOIN DuyuruYetki			Y	ON	Y.ID_DUYURU		= D.ID_DUYURU
					JOIN OkyanusDB.DBO.V3Kullanici	K	ON	K.TCKIMLIKNO	= D.KYE_TCKIMLIKNO
					WHERE	(@ID_KULLANICITIPILIST	IS NULL OR	Y.ID_KULLANICITIPI	IN (SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)))
						AND	(@ID_SUBELIST			IS NULL OR	Y.ID_SUBE			IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)))
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 3	--	DUYURU AKTIF / PASIF	
			BEGIN
				
				UPDATE D SET 
					D.AKTIF = CASE WHEN D.AKTIF = 1 THEN 0 ELSE 1 END 
				FROM Duyuru	D
				WHERE D.ID_DUYURU = @ID_DUYURU

			END

			IF @ISLEM = 4	--	DUYURU DETAY			
			BEGIN
				
				SELECT ISNULL((
					SELECT DISTINCT 
							 D.ID_DUYURU
							,D.FOTOGRAF
							,D.FOTOGRAF_MOBIL
							,ADSOYAD	= K.AD + ' ' + K.SOYAD
							,D.BAS_TARIH
							,D.BIT_TARIH
							,D.BASLIK
							,D.ICERIK
							,D.BANNER
							,ID_SUBELIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_SUBE AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_SUBE	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_KULLANICITIPILIST	=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_KULLANICITIPI AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_KULLANICITIPI	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_KADEMELIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_KADEME AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_KADEME	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_KADEME3LIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_KADEME3 AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_KADEME3	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,ID_SINIFLIST			=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT ', ' +  CAST( ID_SINIF AS VARCHAR) 
																							FROM DuyuruYetki	SY 
																							WHERE	SY.ID_DUYURU = D.ID_DUYURU
																								AND SY.ID_SINIF	IS NOT NULL
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + ']' )
															),'[]')
							,DOSYALIST				=ISNULL((	(SELECT '['+ STUFF((	SELECT DISTINCT '", "' + DD.DOSYAYOL 
																							FROM DuyuruDosya	DD
																							WHERE	DD.ID_DUYURU = D.ID_DUYURU
																							FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '') + '"]' )
															),'[]')

							--,ID_SUBELIST			=ISNULL((	SELECT DISTINCT ID_SUBE
							--									FROM DuyuruYetki	SY
							--									WHERE	SY.ID_DUYURU = D.ID_DUYURU
							--										AND SY.ID_SUBE	IS NOT NULL
							--									FOR JSON PATH, INCLUDE_NULL_VALUES
							--								),'[]')

					FROM Duyuru					D
					JOIN OkyanusDB.DBO.V3Kullanici	K	ON	K.TCKIMLIKNO	= D.KYE_TCKIMLIKNO
					WHERE	D.ID_DUYURU = @ID_DUYURU
					FOR JSON PATH
				),'[]')

			END 
			
			IF @ISLEM = 5	--	DUYURU GUNCELLE			
			BEGIN
				
				IF EXISTS ( SELECT * FROM Duyuru WHERE ID_DUYURU = @ID_DUYURU )
				BEGIN

					SELECT TOP 1 * 
					INTO #DUYURU5
					FROM OPENJSON(@SQLJSON)
					WITH(	ID_DUYURU				INT,
							BANNER					BIT,
							TCKIMLIKNO				NVARCHAR(MAX),
							OTURUM					NVARCHAR(MAX),
							ID_KULLANICITIPILIST	NVARCHAR(MAX),
							ID_SUBELIST				NVARCHAR(MAX),
							BASLIK					NVARCHAR(MAX),
							ICERIK					NVARCHAR(MAX),
							BAS_TARIH				NVARCHAR(MAX),
							BIT_TARIH				NVARCHAR(MAX),
							ID_KADEMELIST			NVARCHAR(MAX),
							ID_KADEME3LIST			NVARCHAR(MAX),
							ID_SINIFLIST			NVARCHAR(MAX),
							FOTOGRAF				NVARCHAR(MAX),
							FOTOGRAF_MOBIL			NVARCHAR(MAX),
							DOSYALIST				NVARCHAR(MAX))

					UPDATE D SET
						 D.BASLIK			= K.BASLIK
						,D.ICERIK			= K.ICERIK
						,D.BANNER			= K.BANNER						
						,D.BAS_TARIH		= K.BAS_TARIH
						,D.BIT_TARIH		= K.BIT_TARIH
						,D.KYG_TCKIMLIKNO	= @TCKIMLIKNO
						,D.KYG_TARIH		= GETDATE()
					FROM Duyuru D
					JOIN #DUYURU5	K ON 1 = 1
					WHERE D.ID_DUYURU = @ID_DUYURU

					DELETE FROM DuyuruYetki WHERE ID_DUYURU = @ID_DUYURU
					DELETE FROM DuyuruDosya WHERE ID_DUYURU = @ID_DUYURU

					SELECT VALUE AS ID_KULLANICITIPI INTO #ID_KULLANICITIPILIST5	FROM OPENJSON(( SELECT TOP 1 ID_KULLANICITIPILIST	FROM #DUYURU5))
					SELECT VALUE AS ID_SUBE			 INTO #ID_SUBELIST5				FROM OPENJSON(( SELECT TOP 1 ID_SUBELIST			FROM #DUYURU5))
					SELECT VALUE AS ID_KADEME		 INTO #ID_KADEMELIST5			FROM OPENJSON(( SELECT TOP 1 ID_KADEMELIST			FROM #DUYURU5))
					SELECT VALUE AS ID_KADEME3		 INTO #ID_KADEME3LIST5			FROM OPENJSON(( SELECT TOP 1 ID_KADEME3LIST			FROM #DUYURU5))
					SELECT VALUE AS ID_SINIF		 INTO #ID_SINIFLIST5			FROM OPENJSON(( SELECT TOP 1 ID_SINIFLIST			FROM #DUYURU5))
					SELECT VALUE AS DOSYA			 INTO #DOSYALIST5				FROM OPENJSON(( SELECT TOP 1 DOSYALIST				FROM #DUYURU5))


					IF EXISTS(SELECT * FROM #ID_KULLANICITIPILIST5 WHERE ID_KULLANICITIPI IN (4,5)) -- ÖĞRENCİ VEYA VELİ İSE
					BEGIN

						IF EXISTS(SELECT * FROM #ID_SINIFLIST5)
						BEGIN

							SELECT GS.ID_SINIF, GS.ID_KADEME, GS.ID_KADEME3, GS.ID_SUBE
							INTO #SINIFLIST5
							FROM #ID_SINIFLIST5	SN
							JOIN Pusulam.DBO.vw_SubeSinifGrupKademeTum	GS	ON	GS.ID_SINIF	= SN.ID_SINIF

							INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
							SELECT @ID_DUYURU, ID_KULLANICITIPI, SNL.ID_SUBE, SNL.ID_KADEME, SNL.ID_KADEME3, SNL.ID_SINIF 
							FROM #ID_KULLANICITIPILIST5	KL
							CROSS APPLY #SINIFLIST5		SNL	
							WHERE KL.ID_KULLANICITIPI IN (4,5)

							DROP TABLE #SINIFLIST5

						END
						ELSE
						BEGIN

							INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, ID_SINIF)
							SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE, ID_KADEME, ID_KADEME3, NULL 
							FROM #ID_KULLANICITIPILIST5		KL
							OUTER APPLY #ID_SUBELIST5		SL
							OUTER APPLY #ID_KADEMELIST5		KDL
							OUTER APPLY #ID_KADEME3LIST5	K3L
							WHERE KL.ID_KULLANICITIPI IN (4,5)

						END						
					END

					INSERT INTO DuyuruYetki	(ID_DUYURU, ID_KULLANICITIPI,ID_SUBE)
					SELECT @ID_DUYURU, ID_KULLANICITIPI, ID_SUBE
					FROM #ID_KULLANICITIPILIST5	KTL
					OUTER APPLY #ID_SUBELIST5	SL
					WHERE ID_KULLANICITIPI NOT IN (4,5)

					INSERT INTO DuyuruDosya (ID_DUYURU, DOSYAYOL)
					SELECT @ID_DUYURU, DOSYA FROM #DOSYALIST5

					SELECT @ID_DUYURU ID_DUYURU
				
					DROP TABLE IF EXISTS #DUYURU5
					DROP TABLE IF EXISTS #ID_KULLANICITIPILIST5
					DROP TABLE IF EXISTS #ID_SUBELIST5			
					DROP TABLE IF EXISTS #ID_KADEMELIST5		
					DROP TABLE IF EXISTS #ID_KADEME3LIST5		
					DROP TABLE IF EXISTS #ID_SINIFLIST5			
					DROP TABLE IF EXISTS #DOSYALIST5	

				END

			END
			
			IF @ISLEM = 6	--	DUYURULAR				
			BEGIN

				SELECT ID_DUYURU
				INTO #DUYURULIST6
				FROM Duyuru TD
				WHERE	TD.BAS_TARIH <= CAST(GETDATE() AS DATE)
					AND TD.BIT_TARIH >= CAST(GETDATE() AS DATE)
					AND AKTIF = 1

		
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME, ID_KADEME3, ID_SUBE
				INTO #TEMP6
				FROM OkyanusDB.dbo.v3KullaniciSubeKademe3 
				WHERE TCKIMLIKNO	= @TCKIMLIKNO

				SELECT ISNULL((
					SELECT DISTINCT
						 RN = ROW_NUMBER() OVER(ORDER BY TD.BIT_TARIH DESC,TD.ID_DUYURU DESC)
						,TD.ID_DUYURU
						,TD.BASLIK
						,TD.ICERIK
						,TD.BANNER
						,BAS_TARIH		= CONVERT(VARCHAR, TD.BAS_TARIH, 104)
						,BIT_TARIH		= CONVERT(VARCHAR, TD.BIT_TARIH, 104)
						,YAYINTARIHI	= CONVERT(VARCHAR, TD.BAS_TARIH, 104) +' - ' + CONVERT(VARCHAR, TD.BIT_TARIH, 104)
						,FOTOGRAF		= ISNULL(TD.FOTOGRAF,'') 
						,FOTOGRAF_MOBIL	= ISNULL(TD.FOTOGRAF_MOBIL,'') 
						,DOSYALIST	= ISNULL((	SELECT DISTINCT DOSYAYOL AS DOSYA
												FROM DuyuruDosya DD
												WHERE DD.ID_DUYURU = TD.ID_DUYURU
												FOR JSON PATH, INCLUDE_NULL_VALUES
											),'[]')
					FROM Duyuru	TD
					JOIN (	SELECT D.ID_DUYURU
							FROM #DUYURULIST6				D
							JOIN DuyuruYetki			DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN OkyanusDB.dbo.v3SubeYetki	SY	ON	SY.ID_KULLANICITIPI	= DY.ID_KULLANICITIPI
																AND SY.ID_SUBE			= DY.ID_SUBE
							WHERE	DY.ID_KULLANICITIPI	NOT IN (4,5)
								AND SY.TCKIMLIKNO	= @TCKIMLIKNO
						UNION
							SELECT D.ID_DUYURU
							FROM #DUYURULIST6							D
							JOIN DuyuruYetki						DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN OkyanusDB.dbo.v3KullaniciSinif			KS	ON	KS.ID_SINIF			= DY.ID_SINIF
							JOIN OkyanusDB.DBO.v3OgrenciVeli			OV	ON	OV.TCKIMLIKNO		= KS.TCKIMLIKNO
																			OR	OV.TCKIMLIKNO_OGR	= KS.TCKIMLIKNO
							WHERE	DY.ID_KULLANICITIPI	IN (4,5)
								AND KS.TCKIMLIKNO	= @TCKIMLIKNO
						UNION
							SELECT D.ID_DUYURU
							FROM #DUYURULIST6					D
							JOIN DuyuruYetki				DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN #TEMP6						KS	ON	KS.ID_SUBE			= DY.ID_SUBE
																	AND (	KS.ID_KADEME	= DY.ID_KADEME
																		OR	KS.ID_KADEME3	= DY.ID_KADEME3)
							JOIN OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO		= KS.TCKIMLIKNO
																	OR	OV.TCKIMLIKNO_OGR	= KS.TCKIMLIKNO
							WHERE	DY.ID_KULLANICITIPI	IN (4,5)
								AND KS.TCKIMLIKNO	= @TCKIMLIKNO
					) SD ON SD.ID_DUYURU = TD.ID_DUYURU
					ORDER BY RN
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

				DROP TABLE #TEMP6
				DROP TABLE #DUYURULIST6

			END

			IF @ISLEM = 7	-- DUYURU WEB BANNER 
			BEGIN
				IF @MOBIL_BANNER = 0
				BEGIN
					UPDATE DUYURU SET FOTOGRAF = @GUID , BANNER=1 WHERE ID_DUYURU = @ID_DUYURU
				END
				ELSE
				BEGIN
					UPDATE DUYURU SET FOTOGRAF_MOBIL = @GUID , BANNER=1 WHERE ID_DUYURU = @ID_DUYURU
				END
			END

			IF @ISLEM = 8  -- DUYURU DOSYA
			BEGIN
				INSERT INTO DuyuruDosya (ID_DUYURU, DOSYAYOL) VALUES (@ID_DUYURU,@GUID)
			END

		END 


	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState 		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering Procedure [dbo].[sp_OgrenciBilgiSistemi]...';


GO
ALTER procedure [dbo].[sp_OgrenciBilgiSistemi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@TARIH					VARCHAR(MAX)	= NULL,
	@SINIF_LIST				VARCHAR(MAX)    = NULL,
	@DOSYA_GUID				VARCHAR(MAX)	= NULL,
	@ID_OGRENCIBILGI		INT			    = NULL,
	@ID_SINIF				INT				= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI
				,SQLJSON				= @SQLJSON
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			
			DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

			IF @ISLEM = 1	--	Dokuman Listesi
			BEGIN
			
				
				SELECT SO.ID_SUBE, S.ID_SINIF, S.ID_KADEME3 
				INTO #OGRENCISUBESINIF
				FROM OkyanusDB.dbo.v3Ogrenci SO
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif S ON S.ID_SINIF = SO.ID_SINIF
				WHERE TCKIMLIKNO = @TC_OGRENCI
				UNION
				SELECT S.ID_SUBE, S.ID_SINIF, S.ID_KADEME3 FROM OkyanusDB.dbo.v4SinifOgrenci SO
				INNER JOIN OkyanusDB.dbo.v4Sinif S ON S.ID_SINIF = SO.ID_SINIF AND S.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3AktifDonem D ON D.DONEM = S.DONEM AND D.AKTIF = 1
				WHERE TC_OGRENCI = @TC_OGRENCI AND SO.AKTIF = 1

				SELECT
					ISNULL(
				(
					SELECT 
						TARIH = B.TARIH
					   ,DERS  = B.DERS
					   ,B.ACIKLAMA
					   ,EKLEYEN = K.AD + ' ' + K.SOYAD
					   ,B.DOSYA_GUID
					   ,B.LINK
					   ,B.BASLIK		
					FROM OgrenciBilgi						B
					JOIN OkyanusDB.dbo.v3Kullanici			K  ON K.TCKIMLIKNO = B.KYE_TCKIMLIKNO
					JOIN OgrenciBilgiSinif					BS ON BS.ID_OGRENCIBILGI = B.ID_OGRENCIBILGI 
					WHERE DONEM = @AKTIFDONEM AND
					(BS.ID_SINIF IN (SELECT O.ID_SINIF FROM #OGRENCISUBESINIF O) OR BS.ID_SINIF = 0)
					ORDER BY B.TARIH DESC
					FOR JSON PATH
				 ), '[]')


				--SELECT ISNULL((				
				--	SELECT DISTINCT
				--		 D.ID_DOKUMHAN
				--		,D.ACIKLAMA
				--		,D.DOSYA
				--		,ICERIK		= D.ICERIK
				--		,TARIH		= CONVERT(VARCHAR,d.SILINMETARIHI,104) 
				--		,DOSYALAR	= (	SELECT DISTINCT DOSYA, DOKUMAN_GUID
				--						FROM eokul_v2.dbo.DokumanDosya	DD	
				--						WHERE	DD.ID_DOKUMAN	= D.ID_DOKUMHAN
				--							AND	DD.SILINDI		= 0
				--						FOR JSON PATH, INCLUDE_NULL_VALUES
				--					)
				--		,LINK		= D.LINK
				--		,DERS		= D.DERS
				--		,EKLEYEN	= CONCAT_WS(' ',K.AD,K.SOYAD)	
				--		,D.SILINMETARIHI
				--	FROM eokul_v2.dbo.Dokumhan				D
				--	JOIN eokul_v2.dbo.DokumhanYetki			DY	ON	DY.ID_DOKUMHAN	= D.ID_DOKUMHAN
				--	JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO	= D.TC_KULLANICI
				--	JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.ID_SINIF		= DY.ID_SINIF
				--	WHERE	KY.TCKIMLIKNO	= @TCKIMLIKNO
				--		AND D.DONEM			= @AKTIFDONEM
				--		AND D.MODUL			= 'OBS'
				--		AND D.IPTAL			= 0
				--	ORDER BY D.SILINMETARIHI DESC , D.ID_DOKUMHAN desc
				--	FOR JSON PATH, INCLUDE_NULL_VALUES
				--),'[]')

				
				
			END

			IF @ISLEM = 2   -- Bilgi Ekle
			BEGIN
				
				CREATE TABLE #BILGI(ID_OGRENCIBILGI INT)

				INSERT INTO OgrenciBilgi(DERS,BASLIK,LINK,ACIKLAMA,TARIH,KYE_TCKIMLIKNO,KYE_TARIH,AKTIF,DONEM)
				OUTPUT INSERTED.ID_OGRENCIBILGI INTO #BILGI(ID_OGRENCIBILGI)
				SELECT Ders,Baslik,Link,Aciklama,@TARIH,@TCKIMLIKNO,GETDATE(),1,@AKTIFDONEM
				FROM OPENJSON(@SQLJSON)
				WITH
				(
				  Ders			 VARCHAR(MAX),
				  Baslik		 VARCHAR(MAX),
				  Link			 VARCHAR(MAX),
				  Aciklama		 VARCHAR(MAX)
				)

				INSERT INTO OgrenciBilgiSinif(ID_OGRENCIBILGI,ID_SINIF)
				SELECT (SELECT ID_OGRENCIBILGI FROM #BILGI),S.VALUE
				FROM OPENJSON(@SINIF_LIST)		S WHERE S.VALUE > 0

				SELECT ID_OGRENCIBILGI FROM #BILGI
			END


			IF @ISLEM = 3   -- Bilgi Dosya Kaydet
			BEGIN
				UPDATE OgrenciBilgi SET DOSYA_GUID = @DOSYA_GUID WHERE ID_OGRENCIBILGI = @ID_OGRENCIBILGI
			END

			IF @ISLEM = 4   -- Bilgi Listele
			BEGIN
				
				SELECT ISNULL((
						SELECT DISTINCT
							 B.ID_OGRENCIBILGI
							,DERS
							,BASLIK
							,TARIH = (FORMAT(TARIH,'dd.MM.yyyy')) 
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM OgrenciBilgi			B
						JOIN v3Kullanici			K	ON K.TCKIMLIKNO			= B.KYE_TCKIMLIKNO
						JOIN OgrenciBilgiSinif		OBS ON OBS.ID_OGRENCIBILGI  = B.ID_OGRENCIBILGI
						WHERE OBS.ID_SINIF = ID_SINIF AND B.DONEM = @AKTIFDONEM AND B.AKTIF = 1
						ORDER BY TARIH
						FOR JSON PATH
				),'[]')
				
				
			END

			IF @ISLEM = 5   -- Bilgi Sil
			BEGIN
				UPDATE OgrenciBilgi SET AKTIF = 0 WHERE ID_OGRENCIBILGI = @ID_OGRENCIBILGI
				
				SELECT ISNULL((
						SELECT DISTINCT
							 B.ID_OGRENCIBILGI
							,DERS
							,BASLIK
							,TARIH = (FORMAT(TARIH,'dd.MM.yyyy')) 
							,ACIKLAMA
							,DOSYA_GUID
							,K.AD + ' ' +K.SOYAD AS EKLEYEN
							,B.LINK
						FROM OgrenciBilgi			B
						JOIN v3Kullanici			K	ON K.TCKIMLIKNO			= B.KYE_TCKIMLIKNO
						JOIN OgrenciBilgiSinif		OBS ON OBS.ID_OGRENCIBILGI  = B.ID_OGRENCIBILGI
						WHERE OBS.ID_SINIF = ID_SINIF AND B.DONEM = @AKTIFDONEM AND B.AKTIF = 1
						ORDER BY TARIH
						FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 6   -- Bilgi Getir 
			BEGIN
				SELECT ISNULL((
					SELECT 
						DERS
					   ,BASLIK
					   ,LINK
					   ,ACIKLAMA
					   ,TARIH				   
					FROM OgrenciBilgi 
					WHERE ID_OGRENCIBILGI = @ID_OGRENCIBILGI 
					FOR JSON PATH
				),'{}')				
			END

			IF @ISLEM = 7  -- Bilgi Düzenle
			BEGIN				
				UPDATE B 
				SET B.DERS = J.Ders,B.BASLIK = J.Baslik, B.LINK = J.Link,B.ACIKLAMA = J.Aciklama,  B.TARIH = @TARIH
				FROM OgrenciBilgi as B
				JOIN OPENJSON(@SQLJSON)
				WITH (
				  ID_OGRENCIBILGI		 INT,
				  Ders			 VARCHAR(MAX),
				  Baslik		 VARCHAR(MAX),
				  Link			 VARCHAR(MAX),
				  Aciklama		 VARCHAR(MAX)
				) AS J ON J.ID_OGRENCIBILGI = B.ID_OGRENCIBILGI WHERE B.ID_OGRENCIBILGI = @ID_OGRENCIBILGI

				SELECT @ID_OGRENCIBILGI
			END			
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering Procedure [dbo].[sp_Zumre]...';


GO
ALTER PROC [dbo].[sp_Zumre]
	@ISLEM							INT				= NULL,
	@TCKIMLIKNO						VARCHAR(11)		= NULL,
	@OTURUM							VARCHAR(36)		= NULL,
	@ID_MENU						INT				= NULL,
	@SQLJSON						VARCHAR(MAX)	= NULL,
	@DONEM							VARCHAR(4)		= NULL,
	@ID_KADEME3						INT				= NULL,
	@ID_DERS						INT				= NULL,
	@BAS_TARIH						VARCHAR(MAX)    = NULL,
	@BIT_TARIH						VARCHAR(MAX)	= NULL,
	@DOSYALIST						VARCHAR(MAX)	= NULL,
	@ID_ZUMRE_OZELLIK				INT				= NULL,
	@HAFTANIN_KAZANIMI				VARCHAR(MAX)    = NULL,
	@ID_ZUMRE						INT				= NULL,
	@ID_HAFTANIN_KAZANIMI			INT				= NULL,
	@ID_DOSYA						INT				= NULL,
	@ID_ZUMREOZELLIKDOSYA			INT				= NULL,
	@ODEV							VARCHAR(MAX)	= NULL,
	@ID_ZUMRE_OZELLIK_ODEV			VARCHAR(15)		= NULL,
	@ID_ZUMRE_TUR					INT				= NULL
	
	
AS
BEGIN
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		DECLARE @_ID_LOG INT = 0
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
		DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)

		IF @return_variable = 1
		BEGIN
			IF @ISLEM = 1  --Kullanıcı Tip Getir
			BEGIN
			    SELECT ISNULL((
					SELECT DISTINCT
					    OGRETMEN = ISNULL((SELECT TOP 1 1 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 3),0)
					   ,BASKAN	 = ISNULL((SELECT TOP 1 1 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI IN(27,59) ),0)
					 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO
					FOR JSON AUTO
				),'[]')
			END
			
			IF @ISLEM = 2  --Kazanım Getir
			BEGIN
			
				SELECT ISNULL((
					SELECT	 D1.ID_DERS
							,D1.ID_DERSUNITE
							,D1.KOD
							,D1.AD
							,LINKLIST = ISNULL((SELECT LINK
												FROM OKYANUSDB.DBO.v3SinavDersUniteLink L
												WHERE	L.KOD	= D1.KOD
													AND L.AKTIF = 1
												FOR JSON PATH, INCLUDE_NULL_VALUES
											),'[{"LINK":""}]')
							,DOSYASAYISI = (SELECT COUNT(1) FROM KazanimDosya KD WHERE KD.KOD = D1.KOD AND KD.AKTIF = 1)
							,SECILI = IIF(EXISTS(SELECT TOP 1 1 
												 FROM ZumreKazanim ZK 
												 JOIN ZumreBilgi   ZB ON ZB.ID_ZUMRE = ZK.ID_ZUMRE
												 WHERE ZK.ID_KAZANIM = D1.ID_DERSUNITE AND ZB.BAS_TARIH = @BAS_TARIH AND ZB.BIT_TARIH = @BIT_TARIH) ,1,0)
							,ID_ZUMRE_KAZANIM = ISNULL((SELECT 
													Z.ID_ZUMRE_KAZANIM 
												FROM ZumreKazanim Z 
												JOIN ZumreBilgi ZZB ON ZZB.ID_ZUMRE = Z.ID_ZUMRE
												WHERE Z.ID_KAZANIM =D1.ID_DERSUNITE AND Z.SECILI = 1 AND ZZB.ID_KADEME3 = @ID_KADEME3 AND ZZB.ID_DERS = @ID_DERS AND ZZB.BAS_TARIH = @BAS_TARIH AND ZZB.BIT_TARIH = @BIT_TARIH FOR JSON PATH),0)
							,KAZANIM = ISNULL((
											SELECT  DISTINCT
												ZO.ID_ZUMRETUR
											   ,ZO.ID_ZUMREBILGILERI
											   ,ZO.ID_ZUMREOZELLIK
											   ,ICERIK = ISNULL(ZO.ICERIK,'')
											   ,DOSYA = ISNULL((SELECT ZOD.DOSYA_GUID , ZOD.AD FROM ZumreOzellikDosya ZOD WHERE ZOD.ID_ZUMREOZELLIK = ZO.ID_ZUMREOZELLIK 
																		FOR JSON PATH, INCLUDE_NULL_VALUES
																	),'[]')
											FROM ZumreBilgi					ZB
											JOIN ZumreOzellik				ZO ON ZO.ID_ZUMREBILGILERI = ZB.ID_ZUMRE
											WHERE ZB.ID_KADEME3 = @ID_KADEME3 AND ZB.ID_DERS = @ID_DERS AND ZB.BAS_TARIH = @BAS_TARIH AND ZB.BIT_TARIH = @BIT_TARIH
											ORDER BY ZO.ID_ZUMRETUR
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[]')
					FROM v3SinavDersUnite		D1
					inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
					WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
					ORDER BY d1.KOD
					FOR JSON PATH
					), '[]')
			END

			IF @ISLEM = 3  -- Zümre Kaydet
			BEGIN
				DECLARE @ID_ZUMRELIST TABLE (ID_ZUMRE INT)
				DECLARE @KAZANIM_LIST TABLE (ID_KAZANIM INT)


				DECLARE @KAZANIM_ANALIZ	INT = NULL, @OGRETIM_YONTEM INT = NULL,@KAYNAK_KITAP INT = NULL,@ATASOZ_DEYIM INT= NULL,@OKUMA_KITAP INT=NULL, @DEGERELEN_BILINC INT = NULL,
				 @HAFTANIN_ARASTIRMASI INT = NULL, @BELIRLI_GUN INT= NULL, @HAFTANIN_ODEVI INT = NULL

				CREATE TABLE #ODEV(ICERIK1 INT, ICERIK2 INT, ICERIK3 INT, ICERIK4 INT, ICERIK5 INT, ICERIK6 INT, ICERIK7 INT, ICERIK8 INT, ICERIK9 INT, ICERIK10 INT, ICERIK11 INT, ICERIK12 INT, ICERIK13 INT, ICERIK14 INT, ICERIK15 INT)

				 INSERT INTO ZumreBilgi (ID_KADEME3, ID_DERS,BAS_TARIH,BIT_TARIH,KYE_TCKIMLIKNO)
				 OUTPUT INSERTED.ID_ZUMRE INTO @ID_ZUMRELIST(ID_ZUMRE)
				 VALUES(@ID_KADEME3,@ID_DERS,@BAS_TARIH,@BIT_TARIH,@TCKIMLIKNO)			

				 SET @ID_ZUMRE = (select TOP 1 ID_ZUMRE from @ID_ZUMRELIST)

				 INSERT INTO  ZumreKazanim(ID_ZUMRE,ID_KAZANIM,SECILI)
				 SELECT @ID_ZUMRE,ID_DERSUNITE,SECILI
				 FROM OPENJSON(@HAFTANIN_KAZANIMI)
				 WITH
				 (
					SECILI BIT,
					ID_DERSUNITE INT
				 ) AS J WHERE J.SECILI = 1

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK1)
				 SELECT @ID_ZUMRE, 10,ICERIK1
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK1 VARCHAR(MAX)
				 ) AS J WHERE ICERIK1 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK2)
				 SELECT @ID_ZUMRE, 10,ICERIK2
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK2 VARCHAR(MAX)
				 ) AS J WHERE ICERIK2 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK3)
				 SELECT @ID_ZUMRE, 10,ICERIK3
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK3 VARCHAR(MAX)
				 ) AS J WHERE ICERIK3 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK4)
				 SELECT @ID_ZUMRE, 10,ICERIK4
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK4 VARCHAR(MAX)
				 ) AS J WHERE ICERIK4 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK5)
				 SELECT @ID_ZUMRE, 10,ICERIK5
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK5 VARCHAR(MAX)
				 ) AS J WHERE ICERIK5 != ''

				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK6)
				 SELECT @ID_ZUMRE, 10,ICERIK6
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK6 VARCHAR(MAX)
				 ) AS J WHERE ICERIK6 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK7)
				 SELECT @ID_ZUMRE, 10,ICERIK7
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK7 VARCHAR(MAX)
				 ) AS J WHERE ICERIK7 != ''

				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK8)
				 SELECT @ID_ZUMRE, 10,ICERIK8
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK8 VARCHAR(MAX)
				 ) AS J WHERE ICERIK8 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK9)
				 SELECT @ID_ZUMRE, 10,ICERIK9
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK9 VARCHAR(MAX)
				 ) AS J WHERE ICERIK9 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK10)
				 SELECT @ID_ZUMRE, 10,ICERIK10
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK10 VARCHAR(MAX)
				 ) AS J WHERE ICERIK10 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK11)
				 SELECT @ID_ZUMRE, 10,ICERIK11
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK11 VARCHAR(MAX)
				 ) AS J WHERE ICERIK11 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK12)
				 SELECT @ID_ZUMRE, 10,ICERIK12
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK12 VARCHAR(MAX)
				 ) AS J WHERE ICERIK12 != ''
				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK13)
				 SELECT @ID_ZUMRE, 10,ICERIK13
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK13 VARCHAR(MAX)
				 ) AS J WHERE ICERIK13 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK14)
				 SELECT @ID_ZUMRE, 10,ICERIK14
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK14 VARCHAR(MAX)
				 ) AS J WHERE ICERIK14 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK15)
				 SELECT @ID_ZUMRE, 10,ICERIK15
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK15 VARCHAR(MAX)
				 ) AS J WHERE ICERIK15 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR KAZIM ANALİZ
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,2 ,[KAZANIM_ANALIZ]  
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[KAZANIM_ANALIZ] [varchar](MAX)
				 
				 ) AS J 


				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR OGRETIM YONTEM 
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,3 ,[OGRETIM_YONTEM] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[OGRETIM_YONTEM] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR KAYNAK_KITAP
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,4 ,[KAYNAK_KITAP] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[KAYNAK_KITAP] [varchar](MAX)
				 
				 ) AS J

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR ATASOZ_DEYIM
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,5 ,[ATASOZ_DEYIM] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[ATASOZ_DEYIM] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR OKUMA_KITAP
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,6 ,[OKUMA_KITAP] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[OKUMA_KITAP] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR DEGERELEN_BILINC
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,7 ,[DEGERELEN_BILINC] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[DEGERELEN_BILINC] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR HAFTANIN_ARASTIRMASI
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,8 ,[HAFTANIN_ARASTIRMASI] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[HAFTANIN_ARASTIRMASI] [varchar](MAX)
				 
				 ) AS J 

				  INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR BELIRLI_GUN
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,9 ,[BELIRLI_GUN] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[BELIRLI_GUN] [varchar](MAX)
				 
				 ) AS J 

				  SELECT ISNULL((
					SELECT DISTINCT
					    ID_ZUMREOZELLIK
					   ,ICERIK
					   ,ID_ZUMRETUR
					   ,ODEV = (SELECT ISNULL((SELECT * FROM #ODEV FOR JSON AUTO),'[]' ))
				     FROM ZumreOzellik WHERE ID_ZUMREBILGILERI = @ID_ZUMRE
					FOR JSON AUTO
				),'[]')		

			END

			IF @ISLEM = 4  -- Zumre Dosya Kaydet 
			BEGIN
					
					

				
				
					INSERT INTO ZumreOzellikDosya (ID_ZUMREOZELLIK,DOSYA_GUID,AD)
					SELECT @ID_ZUMRE_OZELLIK, GUID,AD
					FROM OPENJSON(@DOSYALIST,'$.DOSYA')
					WITH(
						GUID	VARCHAR(MAX),
						AD		VARCHAR(MAX)
					) 
				
				SELECT ISNULL((
					SELECT  
						ZO.ICERIK	
					FROM ZumreBilgi				ZB
					JOIN ZumreOzellik			ZO	ON ZO.ID_ZUMREBILGILERI = ZB.ID_ZUMRE
					JOIN ZumreOzellikDosya		ZOD ON ZOD.ID_ZUMREOZELLIK  = ZO.ID_ZUMREOZELLIK
					WHERE ZO.ID_ZUMREOZELLIK = @ID_ZUMRE_OZELLIK
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END
		    
			IF @ISLEM = 5  -- Zumre Güncelle
			BEGIN 
			

				 UPDATE ZumreBilgi SET ID_KADEME3 = @ID_KADEME3, ID_DERS = @ID_DERS,BAS_TARIH = @BAS_TARIH,BIT_TARIH = @BIT_TARIH,KYE_TCKIMLIKNO=@TCKIMLIKNO
				 WHERE ID_ZUMRE = @ID_ZUMRE
				 
				 CREATE TABLE #ODEV1(ICERIK1 INT, ICERIK2 INT, ICERIK3 INT, ICERIK4 INT, ICERIK5 INT, ICERIK6 INT, ICERIK7 INT, ICERIK8 INT, ICERIK9 INT, ICERIK10 INT, ICERIK11 INT, ICERIK12 INT, ICERIK13 INT, ICERIK14 INT, ICERIK15 INT)
				 INSERT INTO #ODEV1(ICERIK1,ICERIK2,ICERIK3,ICERIK4,ICERIK5,ICERIK6,ICERIK7,ICERIK8,ICERIK9,ICERIK10,ICERIK11,ICERIK12,ICERIK13,ICERIK14,ICERIK15)
				 SELECT ID_ICERIK1,ID_ICERIK2,ID_ICERIK3,ID_ICERIK4,ID_ICERIK5,ID_ICERIK6,ID_ICERIK7,ID_ICERIK8,ID_ICERIK9,ID_ICERIK10,ID_ICERIK11,ID_ICERIK12,ID_ICERIK13,ID_ICERIK14,ID_ICERIK15
				 FROM OPENJSON(@ODEV)
				 WITH(
				  ID_ICERIK1	 INT,
				  ID_ICERIK2	 INT,
				  ID_ICERIK3	 INT,
				  ID_ICERIK4	 INT,
				  ID_ICERIK5	 INT,
				  ID_ICERIK6	 INT,
				  ID_ICERIK7	 INT,
				  ID_ICERIK8	 INT,
				  ID_ICERIK9	 INT,
				  ID_ICERIK10	 INT,
				  ID_ICERIK11	 INT,
				  ID_ICERIK12	 INT,
				  ID_ICERIK13	 INT,
				  ID_ICERIK14	 INT,
				  ID_ICERIK15	 INT
				 ) AS J

				

				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK1
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK1 INT,
				 ICERIK1 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK1 = U.ID_ZUMREOZELLIK

				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK2
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK2 INT,
				 ICERIK2 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK2 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK3
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK3 INT,
				 ICERIK3 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK3 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK4
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK4 INT,
				 ICERIK4 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK4 = U.ID_ZUMREOZELLIK

				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK5
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK5 INT,
				 ICERIK5 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK5 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK6
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK6 INT,
				 ICERIK6 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK6 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK7
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK7 INT,
				 ICERIK7 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK7 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK8
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK8 INT,
				 ICERIK8 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK8 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK9
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK9 INT,
				 ICERIK9 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK9 = U.ID_ZUMREOZELLIK
				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK10
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK10 INT,
				 ICERIK10 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK10 = U.ID_ZUMREOZELLIK
				  UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK11
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK11 INT,
				 ICERIK11 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK11 = U.ID_ZUMREOZELLIK
				  UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK12
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK12 INT,
				 ICERIK12 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK12 = U.ID_ZUMREOZELLIK
				  UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK13
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK13 INT,
				 ICERIK13 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK13 = U.ID_ZUMREOZELLIK
				  UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK14
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK14 INT,
				 ICERIK14 [varchar](MAX)
				 ) AS J ON J.ID_ICERIK14 = U.ID_ZUMREOZELLIK
				  UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.ICERIK15
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@ODEV)
				 WITH (
				 ID_ICERIK15 INT,
				 ICERIK15[varchar](MAX)
				 ) AS J ON J.ID_ICERIK15 = U.ID_ZUMREOZELLIK

				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.KAZANIM_ANALIZ
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_KAZANIM_ANALIZ INT,
				 [KAZANIM_ANALIZ] [varchar](MAX)
				 ) AS J ON J.ID_KAZANIM_ANALIZ = U.ID_ZUMREOZELLIK

				  UPDATE U									-- ZÜMRE TÜR OGRETIM_YONTEM
				 SET U.ICERIK = J.OGRETIM_YONTEM
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_OGRETIM_YONTEM INT,
				 [OGRETIM_YONTEM] [varchar](MAX)
				 ) AS J ON J.ID_OGRETIM_YONTEM = U.ID_ZUMREOZELLIK

				 UPDATE U									--  ZÜMRE TÜR KAYNAK_KITAP
				 SET U.ICERIK = J.KAYNAK_KITAP
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_KAYNAK_KITAP INT,
				 [KAYNAK_KITAP] [varchar](MAX)
				 ) AS J ON J.ID_KAYNAK_KITAP = U.ID_ZUMREOZELLIK

				  UPDATE U									-- ZÜMRE TÜR ATASOZ_DEYIM
				 SET U.ICERIK = J.ATASOZ_DEYIM
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_ATASOZ_DEYIM INT,
				 [ATASOZ_DEYIM] [varchar](MAX)
				 ) AS J ON J.ID_ATASOZ_DEYIM = U.ID_ZUMREOZELLIK

				   UPDATE U											-- ZÜMRE TÜR OKUMA_KITAP
				 SET U.ICERIK = J.OKUMA_KITAP
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_OKUMA_KITAP INT,
				 [OKUMA_KITAP] [varchar](MAX)
				 ) AS J ON J.ID_OKUMA_KITAP = U.ID_ZUMREOZELLIK

				 UPDATE U										  -- ZÜMRE TÜR DEGERELEN_BILINC
				 SET U.ICERIK = J.DEGERELEN_BILINC
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_DEGERELEN_BILINC INT,
				 [DEGERELEN_BILINC] [varchar](MAX)
				 ) AS J ON J.ID_DEGERELEN_BILINC = U.ID_ZUMREOZELLIK

				 UPDATE U										 -- ZÜMRE TÜR HAFTANIN_ARASTIRMASI
				 SET U.ICERIK = J.HAFTANIN_ARASTIRMASI
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_HAFTANIN_ARASTIRMASI INT,
				 [HAFTANIN_ARASTIRMASI] [varchar](MAX)
				 ) AS J ON J.ID_HAFTANIN_ARASTIRMASI = U.ID_ZUMREOZELLIK

				 UPDATE U												-- ZÜMRE TÜR BELIRLI_GUN
				 SET U.ICERIK = J.BELIRLI_GUN
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_BELIRLI_GUN INT,
				 [BELIRLI_GUN] [varchar](MAX)
				 ) AS J ON J.ID_BELIRLI_GUN = U.ID_ZUMREOZELLIK
					
				--UPDATE U 
				--SET U.ID_KAZANIM = J.ID_DERSUNITE, U.SECILI = J.SECILI
				--FROM ZumreKazanim AS U
				--JOIN OPENJSON(@HAFTANIN_KAZANIMI)
				--WITH
				--(
				--	SECILI BIT,
				--	ID_DERSUNITE INT
				--) AS J ON J.SECILI = 0 AND J.ID_DERSUNITE = U.ID_KAZANIM AND U.ID_ZUMRE_KAZANIM = @ID_HAFTANIN_KAZANIMI
				
				CREATE TABLE #ZumreKazanim (ID_ZUMRE_KAZANIM INT)
				
				INSERT INTO #ZumreKazanim (ID_ZUMRE_KAZANIM)
				SELECT ID_ZUMRE_KAZANIM
				FROM OPENJSON(@HAFTANIN_KAZANIMI)
				WITH
				(
					ID_ZUMRE_KAZANIM INT,
					SECILI BIT
				) AS J WHERE J.SECILI = 0 

				DELETE FROM ZumreKazanim WHERE ID_ZUMRE_KAZANIM IN (SELECT ID_ZUMRE_KAZANIM FROM #ZumreKazanim)				


				 INSERT INTO  ZumreKazanim(ID_ZUMRE,ID_KAZANIM,SECILI)
				 SELECT @ID_ZUMRE,ID_DERSUNITE,SECILI
				 FROM OPENJSON(@HAFTANIN_KAZANIMI)
				 WITH
				 (
					SECILI BIT,
					ID_DERSUNITE INT,
					ID_ZUMRE_KAZANIM INT
				 ) AS J WHERE J.SECILI = 1 AND J.ID_ZUMRE_KAZANIM < 1

				  SELECT ISNULL((
					SELECT DISTINCT
					    ID_ZUMREOZELLIK
					   ,ICERIK
					   ,ID_ZUMRETUR
					   ,ODEV = (SELECT ISNULL((SELECT * FROM #ODEV1 FOR JSON AUTO),'[]' ))
				     FROM ZumreOzellik WHERE ID_ZUMREBILGILERI = @ID_ZUMRE
					FOR JSON AUTO
				),'[]')		
			
			END

			IF @ISLEM = 6  -- DOSYA DETAY GÖR
			BEGIN
				SELECT ISNULL((
					SELECT 
						 DOSYA_GUID
						,AD
						,ID_ZUMREOZELLIKDOSYA
					FROM ZumreOzellikDosya			ZOD
					WHERE ZOD.ID_ZUMREOZELLIK = @ID_DOSYA
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 7  -- DOSYA SİL
			BEGIN
				SELECT @ID_DOSYA = ID_ZUMREOZELLIK  FROM ZumreOzellikDosya WHERE ID_ZUMREOZELLIKDOSYA = @ID_ZUMREOZELLIKDOSYA
				DELETE FROM ZumreOzellikDosya WHERE ID_ZUMREOZELLIKDOSYA = @ID_ZUMREOZELLIKDOSYA

				SELECT ISNULL((
					SELECT 
						 DOSYA_GUID
						,AD
						,ID_ZUMREOZELLIKDOSYA
					FROM ZumreOzellikDosya			ZOD
					WHERE ZOD.ID_ZUMREOZELLIK = @ID_DOSYA
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 8  -- Log Kaydet
			BEGIN
				INSERT INTO ZumreLog (ID_ZUMRE_TUR,SECILI,TCKIMLIKNO,BAS_TARIH,BIT_TARIH) VALUES (@ID_ZUMRE_TUR, 1,@TCKIMLIKNO,@BAS_TARIH,@BIT_TARIH)
			END
			
			IF @ISLEM = 9  -- Log Listele
			BEGIN
				SELECT ISNULL ((
							SELECT 
								 HAFTANIN_KAZANIMI	= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 1 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,KAZANIM_ANALIZ		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 2 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,OGRETIM_YONTEM		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 3 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,KAYNAK_KITAP			= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 4 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,HAFTANIN_ATASOZU		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 5 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,OKUMA_KITABI			= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 6 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,DERGERLER_BILINCI	= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 7 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,HAFTANIN_ARASTIRMASI	= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 8 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,BELIRLI_GUN			= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 9 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,HAFTANIN_ODEVI		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 10 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,TCKIMLIKNO=ZL.TCKIMLIKNO
								,AD=K.AD + ' ' + K.SOYAD
							FROM ZumreLog			ZL
							JOIN v3Kullanici		K  ON K.TCKIMLIKNO   = ZL.TCKIMLIKNO  
							WHERE ZL.BAS_TARIH = @BAS_TARIH AND ZL.BIT_TARIH = @BIT_TARIH
							GROUP BY ZL.TCKIMLIKNO,K.AD,K.SOYAD
							FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END

			IF @ISLEM = 10 --  Sınıf
			BEGIN
				select distinct 					   
					   SGS.ID_KADEME3					  
					   ,AD = SGS.KADEME3
				  from eokul_v2.dbo.DersOgretmen do
			 left join OkyanusDB.dbo.v3Kullanici pb on pb.TCKIMLIKNO=do.TC_OGRETMEN
			 inner join eokul_v2.dbo.Ders   d on d.ID_DERS=do.ID_DERS
			 INNER JOIN OkyanusDB.dbo.v3Ogretmen O ON O.ID_OGRETMEN = do.ID_OGRETMEN
			 left join OKYANUSDB.DBO.V3EgitimTuru e on e.ID_EGITIMTURU=do.ID_EGITIMTURU
			 JOIN OkyanusDB.dbo.vw_SubeGrupSinif SGS ON SGS.ID_SINIF = DO.ID_SINIF
	   			 WHERE 	DONEMKOD= @AKTIFDONEM
				 --pb.TCKIMLIKNO = @TCKIMLIKNO
				   AND d.AKTIF=1
				   AND SGS.ID_KADEME3 IN (7,8,9,10) AND SGS.SINIF NOT LIKE 'ÜZİ%'
				ORDER BY AD
			END	

			IF @ISLEM = 11 -- Öğretmen Ders Getir
			BEGIN 
				DECLARE @BASKAN  BIT = 0, @OGRETMEN BIT = 0

					SELECT DISTINCT
					    @OGRETMEN = ISNULL((SELECT TOP 1 1 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 3),0)
					   ,@BASKAN	 = ISNULL((SELECT TOP 1 1  FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND (ID_KULLANICITIPI = 27 OR ID_KULLANICITIPI = 59)),0)
					 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO



					 IF @BASKAN = 1 
					 BEGIN
						SELECT d.ID_DERS, d.AD FROM [dbo].[v3SinavDers] d where d.ID_KADEME3=@ID_KADEME3 
					 END 

					IF @OGRETMEN = 1 
					BEGIN
						select distinct 
							 do.ID_DERS,
							 AD=d.DERSAD
					   from eokul_v2.dbo.DersOgretmen do
					   left join OkyanusDB.dbo.v3Kullanici pb on pb.TCKIMLIKNO=do.TC_OGRETMEN
					   inner join eokul_v2.dbo.Ders d on d.ID_DERS=do.ID_DERS
					   INNER JOIN OkyanusDB.dbo.v3Ogretmen O ON O.ID_OGRETMEN = do.ID_OGRETMEN
					   left join OKYANUSDB.DBO.V3EgitimTuru e on e.ID_EGITIMTURU=do.ID_EGITIMTURU
					   JOIN OkyanusDB.dbo.vw_SubeGrupSinif SGS ON SGS.ID_SINIF = DO.ID_SINIF
	   				   	 WHERE 	DONEMKOD= (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
					   	 AND pb.TCKIMLIKNO = @TCKIMLIKNO
					   	   AND d.AKTIF=1
					   	   AND SGS.ID_KADEME3 = @ID_KADEME3 AND SGS.SINIF NOT LIKE 'ÜZİ%'
					    order by d.DERSAD
					END
				
			END

		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Reenabling DDL triggers...'
GO
ENABLE TRIGGER [CaptureStoredProcedureChanges] ON DATABASE
GO
PRINT N'Update complete.';


GO


USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_VIU]    Script Date: 27.07.2021 10:01:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_VIU]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	
	@BASTARIH			VARCHAR(MAX)	= NULL,
	@BITTARIH			VARCHAR(MAX)	= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@TCOGRETMENLIST		VARCHAR(MAX)	= NULL,
	@ID_ARAMADURUMLIST	VARCHAR(MAX)	= NULL,
	@ID_ARAMASEBEPLIST	VARCHAR(MAX)	= NULL,
	@JSON				BIT				= NULL,
	@ID_SUBELER		    VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@RESIM_URL			VARCHAR(MAX)	= NULL
AS
BEGIN
	
	SET @RESIM_URL		= ISNULL(@RESIM_URL		, '')
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
									
				,BASTARIH			= @BASTARIH
				,BITTARIH			= @BITTARIH
				,ID_SUBELIST		= @ID_SUBELIST
				,TCOGRETMENLIST		= @TCOGRETMENLIST
				,ID_ARAMADURUMLIST	= @ID_ARAMADURUMLIST
				,ID_ARAMASEBEPLIST	= @ID_ARAMASEBEPLIST
				,[JSON]				= @JSON
				,ID_SUBELER		    = @ID_SUBELER
				,ID_SINIFLAR        = @ID_SINIFLAR
				,SQLJSON			= @SQLJSON
				,TC_OGRETMEN		= @TC_OGRETMEN
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @ID_LOG > 0
		BEGIN	
			IF @ISLEM = 1	--	VIU Rapor Mesaj
			BEGIN			
				SELECT
					 ACIKLAMA	=	B.AD + IIF(D.ID_DOKUMAN IS NOT NULL ,'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/'+ D.GUID ,'')
					,KYE_TARIH	=	CONVERT(VARCHAR(10), B.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), B.KYE_TARIH, 108)
					,GONDERENTC	=	KYE.TCKIMLIKNO
					,GONDEREN	=	KYE.AD  +' '+ KYE.SOYAD
					,KIME		=	KIME.AD +' '+ KIME.SOYAD
					,KIMICIN	=	KYI.AD  +' '+ KYI.SOYAD
					
					,GONDERENSUBE	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,GONDERENTIP	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMESUBE		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMETIP		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,RENK = IIF( IPTAL = 1 , 'Red' , 'Black' )
				FROM OkyanusIletisim.dbo.BilgiNot					B
				INNER JOIN OkyanusIletisim.dbo.BilgiNotKullanici	N		ON	N.ID_BILGINOT	= B.ID_BILGINOT
				LEFT  JOIN OkyanusIletisim.dbo.Dokuman				D		ON	D.ID_DOKUMAN	= B.ID_DOKUMAN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYE		ON	KYE.TCKIMLIKNO	= B.KYE_TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYI		ON	KYI.TCKIMLIKNO	= N.TCKIMLIKNO_KIMICIN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KIME	ON	KIME.TCKIMLIKNO	= N.TCKIMLIKNO_KIME
				WHERE CAST(B.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO AND SB.ID_SUBE	IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
					)		
				ORDER BY B.KYE_TARIH DESC
			END
	
			IF @ISLEM = 2	--	VIU Rapor VIÜ Kullanmayanlar
			BEGIN				
				
				DECLARE @DONEM NVARCHAR(MAX)

				SELECT TOP 1 @DONEM = '01.09.' + DONEM 
				FROM OkyanusDB.dbo.v3AktifDonem
				WHERE AKTIF = 1


				--SELECT DISTINCT
				--	 SUBE			= SB.AD
				--	,TCKIMLIKNO		= K.TCKIMLIKNO
				--	,AD				= K.AD
				--	,SOYAD			= K.SOYAD
				--	,KULLANICIAD	= K.KULLANICIAD
				--	,SIFRE			= K.SIFRE
				--	,SINIF			= SN.AD
				--	,KADEME			= K3.AD
				--	,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
				--	,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				--INTO #KULLANICILIST
				--FROM		OkyanusDB.dbo.v3Kullanici	K
				--INNER JOIN	OkyanusDB.dbo.v3SubeYetki	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO 
				--INNER JOIN	OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO	= K.TCKIMLIKNO
				--INNER JOIN	OkyanusDB.dbo.v3Ogrenci		OG	ON	OG.TCKIMLIKNO	= OV.TCKIMLIKNO_OGR
				--INNER JOIN	OkyanusDB.dbo.v3Sinif		SN	ON	SN.ID_SINIF		= OG.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3Satislar	SL	ON	SL.ID_SINIF		= SN.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= SL.ID_SATISTURU
				--INNER JOIN	OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3 
				--INNER JOIN	OkyanusDB.dbo.v3Sube		SB	ON	SB.ID_SUBE		= SY.ID_SUBE
				--LEFT JOIN	OkyanusIletisim.dbo.LoginLog L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
				--											AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				--WHERE	K.AKTIF = 1 
				--	AND SY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				--	AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
				--GROUP BY SB.AD, K.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, SN.AD, K3.AD, L.KYE_TCKIMLIKNO
				
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST

				SELECT VALUE ID_SUBE INTO #SUBELIST FROM OPENJSON(@ID_SUBELIST)

				SELECT DISTINCT 
					 SUBE			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SB.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE = SKY.ID_SUBE
														WHERE	SKY.TCKIMLIKNO	= KY.TCKIMLIKNO													
															AND SKY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 													
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,TCKIMLIKNO		= KY.TCKIMLIKNO
					,AD				= K.AD
					,SOYAD			= K.SOYAD
					,KULLANICIAD	= K.KULLANICIAD
					,SIFRE			= K.SIFRE
					,KULLANICITIPI	= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( KT.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3KullaniciTipi		KT	ON	KT.ID_KULLANICITIPI	= SKY.ID_KULLANICITIPI
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	 IN (5, 3, 53, 54, 26)
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,SINIF			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SN.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3Sinif				SN	ON	SN.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,KADEME			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SGS.KADEME3 AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.vw_SubeGrupSinif		SGS	ON	SGS.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
					,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				INTO #KULLANICILIST
				FROM OkyanusDB.dbo.vw_KullaniciYetki	KY
				JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= KY.TCKIMLIKNO
				JOIN #SUBELIST							SL	ON	SL.ID_SUBE		= KY.ID_SUBE
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
															AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				WHERE	KY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				GROUP BY KY.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, L.KYE_TCKIMLIKNO--, SN.AD, K3.AD, SB.AD




				SELECT KL.*
					,LOGINTARIH		= CONVERT(VARCHAR(10), L.KYE_TARIH, 104) + ' ' + CONVERT(VARCHAR(8), L.KYE_TARIH, 108) 
					,LOGINOTURUM	= SUBSTRING(CAST(L.OTURUM AS VARCHAR(MAX)),1,LEN(CAST(L.OTURUM AS VARCHAR(MAX)))-5)+ '*****'
				FROM #KULLANICILIST						KL
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	L.ID_LOGINLOG	= KL.ID_LOGINLOG
				ORDER BY SUBE, AD, SOYAD
								
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST


			END
			
			IF @ISLEM = 3	--	Arama Sebep Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMASEBEP, S.AD + ' (' + K.AD + ')' AS AD
					FROM [OkyanusIletisim].[dbo].[AramaSebep] S
					JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = S.ID_KADEME
					ORDER BY S.ID_KADEME, S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 4	--	Arama Durum Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMADURUM, S.AD
					FROM [OkyanusIletisim].[dbo].[AramaDurum] S
					ORDER BY S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 5	--	Arama Rapor
			BEGIN
				IF @JSON = 1
				BEGIN
					SELECT 
					ISNULL (
					(
						SELECT	 GUID			=	A.GUID
								,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
								,ARAYANTC		=	A.TC_ARAYAN
								,ARAYAN			=	K.AD  +' '+ K.SOYAD
								,KIME			=	A.ADSOYAD_ARANAN
								,ARAMASEBEP		=	S.AD 
								,ARAMADURUM		=	D.AD 
								,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
								,GRUP			=	K3.AD
								,SINIF			=	SNF.AD
								,ARAYANSUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
															FOR XML PATH('')
													), 1, 1, '')
								--,ARAYANTIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
								--				FOR XML PATH('')
								--				), 1, 1, '')
								,KIMESUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
															FOR XML PATH('')
													), 1, 1, '')
								--,KIMETIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
								--				FOR XML PATH('')
								--				), 1, 1, '') 
						FROM OkyanusIletisim.dbo.Arama		A	WITH (NOLOCK)
						JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO	= A.TC_ARAYAN
						JOIN OkyanusDB.dbo.v3Kullanici		KYI ON	KYI.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
						JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
						JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
						JOIN OkyanusIletisim.dbo.AramaSebep S	ON	S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
						JOIN OkyanusIletisim.dbo.AramaDurum D	ON	D.ID_ARAMADURUM = A.ID_ARAMADURUM
						WHERE	CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
						AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
						AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
						AND (
									(	EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST)))
							OR		(NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (	SELECT DISTINCT  SY.TCKIMLIKNO
														FROM OkyanusDB.dbo.v3SubeYetki	SY
														INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
														WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
									)	
								)
							)	
						AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
						ORDER BY A.KYE_TARIH DESC
						FOR JSON PATH
					), '[]')
				END
				ELSE
				BEGIN
					SELECT	 GUID			=	A.GUID
							,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
							,ARAYANTC		=	A.TC_ARAYAN
							,ARAYAN			=	K.AD  +' '+ K.SOYAD
							,KIME			=	A.ADSOYAD_ARANAN
							,ARAMASEBEP		=	S.AD 
							,ARAMADURUM		=	D.AD 
							,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
							,GRUP			=	K3.AD
							,SINIF			=	SNF.AD
							,ARAYANSUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
											FOR XML PATH('')
											), 1, 1, '')
							--,ARAYANTIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
							--				FOR XML PATH('')
							--				), 1, 1, '')
							,KIMESUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
											FOR XML PATH('')
											), 1, 1, '')
							--,KIMETIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
							--				FOR XML PATH('')
							--				), 1, 1, '') 
					FROM OkyanusIletisim.dbo.Arama A	WITH (NOLOCK)
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = A.TC_ARAYAN
					JOIN OkyanusDB.dbo.v3Kullanici KYI ON KYI.TCKIMLIKNO = A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
					JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
					JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
					JOIN OkyanusIletisim.dbo.AramaSebep S ON S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
					JOIN OkyanusIletisim.dbo.AramaDurum D ON D.ID_ARAMADURUM = A.ID_ARAMADURUM
					WHERE CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
					AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
						)	
					AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
					ORDER BY A.KYE_TARIH DESC
				END
			END

			IF @ISLEM = 6   --  Yoklama Rapor
			BEGIN
				--SELECT distinct 
				--	 D.SUBEAD
				--	,D.SINIF
				--	,K.AD + ' '+ K.SOYAD [AD SOYAD]
				--	,CONVERT(VARCHAR(10), Y.TARIH, 105)AS TARIH
				--	,K.TCKIMLIKNO
				--	,D.ID_SINIF
				--	,Y.ID_YOKLAMA
				--	,YK.GELDI
				--	,Y.TARIH AS tarih
				--	,CASE
				--			WHEN GELDI>0 THEN 'GELDİ'
				--			WHEN GELDI<1 THEN 'GELMEDİ'
				--		END AS DURUM
				--FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				--INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				--INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				--INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				--INNER JOIN  [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF	= D.ID_SINIF	AND	S.ID_SINIF		= Y.ID_SINIF
				--INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici] YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA  AND YK.TCKIMLIKNO	= K.TCKIMLIKNO
				--WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				--AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				--AND CAST(TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
				--ORDER BY  D.SUBEAD ASC,D.SINIF ASC,[AD SOYAD] ASC ,tarih DESC

				SELECT DERSNO, AD = BASSAAT + ' - ' + BITSAAT
				INTO #DERSSAAT
				FROM Pusulam.dbo.OnlineDersSaat   
				WHERE	BASSAAT != '00:00'
					AND BITSAAT != '00:00'

				SELECT CAST(DATEADD(DAY, number, @BASTARIH) AS DATE) [Date]
				INTO #DATES
				FROM master..spt_values
				WHERE type = 'P'
				AND DATEADD(DAY, number, @BASTARIH) <= @BITTARIH

				SELECT distinct 
					 SD.SUBEAD
					,SD.SINIF
					,K.AD + ' '+ K.SOYAD [AD SOYAD]
					,K.TCKIMLIKNO
					,S.ID_SINIF
				INTO #KULLANICI
				FROM		OkyanusDB.dbo.vw_SinifOgrenci				S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				SD	ON S.ID_SINIF	= SD.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= SD.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				WHERE AD.AKTIF=1        
				AND ( ( SD.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( SD.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  

				SELECT K.*, D.Date AS TARIH, CONVERT(VARCHAR(MAX), D.Date, 104) AS STRTARIH
				INTO #KULLANICITARIH
				FROM #KULLANICI K
				CROSS APPLY #DATES D

				SELECT K.TCKIMLIKNO, K.TARIH, DP.DERSSAAT, CASE WHEN YK.GELDI = 1 THEN 'GELDİ' ELSE 'GELMEDİ' END AS DURUM
				INTO #KULLANICIDURUM
				FROM #KULLANICITARIH K
				INNER JOIN [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF = K.ID_SINIF AND Y.TARIH = K.TARIH
				INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici]	YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA AND YK.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN  OkyanusDB.dbo.v3DersProgram DP					ON DP.ID_DERSPROGRAM = Y.ID_DERSPROGRAM


				DECLARE @INDEX INT = 1
				DECLARE @COLUMN VARCHAR(MAX) = ''
				DECLARE @DERSNO VARCHAR(MAX) = ''

				WHILE @INDEX <= (SELECT MAX(DERSNO) FROM #DERSSAAT WHERE AD != ' - ')
				BEGIN
					SELECT @COLUMN = AD, @DERSNO = DERSNO FROM #DERSSAAT WHERE DERSNO = @INDEX

					EXECUTE('
					ALTER TABLE #KULLANICITARIH
					ADD [' + @COLUMN + '] VARCHAR(MAX)
					')
		
					EXECUTE ('UPDATE K SET K.[' + @COLUMN + '] = ISNULL((
																			SELECT DURUM
																			FROM #KULLANICIDURUM KD
																			WHERE KD.TARIH = K.TARIH AND KD.TCKIMLIKNO = K.TCKIMLIKNO AND KD.DERSSAAT = ' + @DERSNO + '
																), ''-'') FROM #KULLANICITARIH K')


					SET @INDEX = @INDEX + 1
				END

				SELECT *
				FROM #KULLANICITARIH
				ORDER BY SUBEAD ASC,SINIF ASC, [AD SOYAD] ASC, TARIH

				DROP TABLE #KULLANICI
				DROP TABLE #DERSSAAT
				DROP TABLE #DATES
				DROP TABLE #KULLANICITARIH
				DROP TABLE #KULLANICIDURUM
			END

			IF @ISLEM = 7   --  Viu Yetki Listesi
			BEGIN
			
				SELECT 
				(
					SELECT	Distinct K.AD + ' '+ K.SOYAD AS ADSOYAD ,K.TCKIMLIKNO
							
							,(	
							   
								SELECT distinct D.SUBEAD AS SUBEAD,D.ID_SUBE, 
								SECILI = (SELECT COUNT(1) FROM  ViuAramaKullaniciSube S where D.ID_SUBE=S.ID_SUBE and S.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.SUBEAD,D.ID_SUBE
								ORDER BY D.SUBEAD,D.ID_SUBE
								FOR JSON PATH
							 ) AS SUBE
							 ,(
							 SELECT distinct D.KADEME3 AS GRUP,D.ID_KADEME3, 
							 SECILI = (SELECT COUNT(1) FROM  ViuAramaKullaniciKademe K where K.ID_KADEME3=D.ID_KADEME3 and K.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.KADEME3,D.ID_KADEME3
								ORDER BY D.ID_KADEME3
								FOR JSON PATH
							 )
							 AS GRUP
					FROM OkyanusDB.dbo.v3Kullanici	K
					INNER JOIN OkyanusDB.[dbo].[v4KullaniciSubeTurKademe] TK  ON   TK.TCKIMLIKNO=K.TCKIMLIKNO 
					WHERE K.TCKIMLIKNO =@TC_OGRETMEN
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8   --  Viu Yetki Kaydet
			BEGIN
		   
				DELETE FROM ViuAramaKullanici WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciSube WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciKademe WHERE TCKIMLIKNO = @TC_OGRETMEN
				
				MERGE INTO ViuAramaKullanici AS A 
                USING ( 
						SELECT *
                        FROM OPENJSON(@SQLJSON) WITH ( TCKIMLIKNO VARCHAR(MAX) )) B
                ON (A.TCKIMLIKNO = B.TCKIMLIKNO) 
                WHEN MATCHED THEN 
                UPDATE  SET A.TCKIMLIKNO =B.TCKIMLIKNO                  
                WHEN NOT MATCHED THEN 
                INSERT  (TCKIMLIKNO)
				VALUES (B.TCKIMLIKNO);

					

				SELECT DISTINCT TCKIMLIKNO
                FROM OPENJSON(@SQLJSON)
                WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
		                ,SUBE		NVARCHAR(MAX) AS JSON 
		                ,GRUP		NVARCHAR(MAX) AS JSON
                ) AS J
					
                     
				INSERT INTO ViuAramaKullaniciSube(TCKIMLIKNO, ID_SUBE)
				SELECT DISTINCT TCKIMLIKNO, ID_SUBE 
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.SUBE)
				WITH(	 ID_SUBE	INT
						,SECILI		BIT	
				) AS S
				WHERE S.SECILI = 1

				INSERT INTO ViuAramaKullaniciKademe(TCKIMLIKNO,ID_KADEME3)
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME3  
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.GRUP)
				WITH (	 ID_KADEME3	INT
						,SECILI		BIT	
				) AS G
				WHERE G.SECILI = 1








        END 

			IF @ISLEM = 9	--	Kullanıcı Tipine Göre Kullanıcı Listele
			BEGIN
		
				SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
				FROM [dbo].[v3Kullanici]			KL	
				JOIN OkyanusDB.[dbo].[v3SubeYetki]	TK  ON   TK.TCKIMLIKNO=KL.TCKIMLIKNO 
				WHERE	TK.ID_KULLANICITIPI=101
				order by ADSOYAD 

			END

			IF @ISLEM = 10  --  Viu Toplu Mesaj Kaydet
			BEGIN				
				DROP TABLE IF EXISTS #MESAJLIST

				SELECT *, RN = ROW_NUMBER() OVER(ORDER BY TC_GONDEREN)
				INTO #MESAJLIST
				FROM OPENJSON(@SQLJSON)
				WITH (
					TC_GONDEREN	VARCHAR(MAX),
					TC_ALAN		VARCHAR(MAX),
					MESAJ		VARCHAR(MAX),
					LINK_ETIKET	VARCHAR(MAX),
					LINK		VARCHAR(MAX)
				)	ML
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= ML.TC_ALAN
				
				DECLARE @TOPLUMESAJ INT = NULL
				DECLARE @INSERT10 TABLE (ID INT)
				
				INSERT INTO OkyanusIletisim.dbo.TopluMesaj (KYE_TARIH,KYE_TCKIMLIKNO) 
					OUTPUT inserted.ID_TOPLUMESAJ INTO @INSERT10(ID) 
				VALUES(GETDATE(),@TCKIMLIKNO)

				SET @TOPLUMESAJ =(SELECT TOP 1 ID FROM @INSERT10)



				WHILE EXISTS ( SELECT TOP 1 1 FROM #MESAJLIST )
				BEGIN
		
					DECLARE @TC_GONDEREN	VARCHAR(MAX),
							@TC_ALAN		VARCHAR(MAX),
							@MESAJ			VARCHAR(MAX),
							@LINK_ETIKET	VARCHAR(MAX),
							@LINK			VARCHAR(MAX),
							@RN				INT
					SELECT TOP 1 
						 @TC_GONDEREN	= ML.TC_GONDEREN
						,@TC_ALAN		= ML.TC_ALAN
						,@MESAJ			= ML.MESAJ	
						,@LINK_ETIKET	= ML.LINK_ETIKET
						,@LINK			= ML.LINK
						,@RN			= ML.RN
					FROM #MESAJLIST		ML
					ORDER BY RN

					IF NOT EXISTS (
						SELECT TOP 1 1
						FROM v3Kullanici K
						WHERE K.TCKIMLIKNO	= @TC_GONDEREN
							AND K.AKTIF		= 1
					)
						SET  @TC_GONDEREN = '14531453000'	-- OKYANUS KOLEJLERİ
	
					
					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TC_GONDEREN
						,@HEADER			= 'Yeni Mesaj'
						,@MESAJ				= @MESAJ
						,@LINK				= @LINK
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @MESAJ
						,@LINK_ETIKET		= @LINK_ETIKET
						,@TOPLUMESAJ		= @TOPLUMESAJ
						,@RESIM_URL         = @RESIM_URL
					DELETE FROM #MESAJLIST WHERE RN = @RN

				END

				DROP TABLE IF EXISTS #MESAJLIST

			END
			

		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END


GO

USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Zumre]    Script Date: 28.07.2021 10:06:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_Zumre]
	@ISLEM							INT				= NULL,
	@TCKIMLIKNO						VARCHAR(11)		= NULL,
	@OTURUM							VARCHAR(36)		= NULL,
	@ID_MENU						INT				= NULL,
	@SQLJSON						VARCHAR(MAX)	= NULL,
	@DONEM							VARCHAR(4)		= NULL,
	@ID_KADEME3						INT				= NULL,
	@ID_DERS						INT				= NULL,
	@BAS_TARIH						VARCHAR(MAX)    = NULL,
	@BIT_TARIH						VARCHAR(MAX)	= NULL,
	@DOSYALIST						VARCHAR(MAX)	= NULL,
	@ID_ZUMRE_OZELLIK				INT				= NULL,
	@HAFTANIN_KAZANIMI				VARCHAR(MAX)    = NULL,
	@ID_ZUMRE						INT				= NULL,
	@ID_HAFTANIN_KAZANIMI			INT				= NULL,
	@ID_DOSYA						INT				= NULL,
	@ID_ZUMREOZELLIKDOSYA			INT				= NULL,
	@ODEV							VARCHAR(MAX)	= NULL,
	@ID_ZUMRE_OZELLIK_ODEV			VARCHAR(15)		= NULL,
	@ID_ZUMRE_TUR					INT				= NULL
	
	
AS
BEGIN
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		DECLARE @_ID_LOG INT = 0
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
		DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)

		IF @return_variable = 1
		BEGIN
			IF @ISLEM = 1  --Kullanıcı Tip Getir
			BEGIN
			    SELECT ISNULL((
					SELECT DISTINCT
					    OGRETMEN = ISNULL((SELECT TOP 1 1 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 3),0)
					   ,BASKAN	 = ISNULL((SELECT TOP 1 1 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI IN(27,59) ),0)
					 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO
					FOR JSON AUTO
				),'[]')
			END
			
			IF @ISLEM = 2  --Kazanım Getir
			BEGIN
			
				SELECT ISNULL((
					SELECT	 D1.ID_DERS
							,D1.ID_DERSUNITE
							,D1.KOD
							,D1.AD
							,LINKLIST = ISNULL((SELECT LINK
												FROM OKYANUSDB.DBO.v3SinavDersUniteLink L
												WHERE	L.KOD	= D1.KOD
													AND L.AKTIF = 1
												FOR JSON PATH, INCLUDE_NULL_VALUES
											),'[{"LINK":""}]')
							,DOSYASAYISI = (SELECT COUNT(1) FROM KazanimDosya KD WHERE KD.KOD = D1.KOD AND KD.AKTIF = 1)
							,SECILI = IIF(EXISTS(SELECT TOP 1 1 
												 FROM ZumreKazanim ZK 
												 JOIN ZumreBilgi   ZB ON ZB.ID_ZUMRE = ZK.ID_ZUMRE
												 WHERE ZK.ID_KAZANIM = D1.ID_DERSUNITE AND ZB.BAS_TARIH = @BAS_TARIH AND ZB.BIT_TARIH = @BIT_TARIH) ,1,0)
							,ID_ZUMRE_KAZANIM = ISNULL((SELECT 
													Z.ID_ZUMRE_KAZANIM 
												FROM ZumreKazanim Z 
												JOIN ZumreBilgi ZZB ON ZZB.ID_ZUMRE = Z.ID_ZUMRE
												WHERE Z.ID_KAZANIM =D1.ID_DERSUNITE AND Z.SECILI = 1 AND ZZB.ID_KADEME3 = @ID_KADEME3 AND ZZB.ID_DERS = @ID_DERS AND ZZB.BAS_TARIH = @BAS_TARIH AND ZZB.BIT_TARIH = @BIT_TARIH FOR JSON PATH),0)
							,KAZANIM = ISNULL((
											SELECT  DISTINCT
												ZO.ID_ZUMRETUR
											   ,ZO.ID_ZUMREBILGILERI
											   ,ZO.ID_ZUMREOZELLIK
											   ,ICERIK = ISNULL(ZO.ICERIK,'')
											   ,DOSYA = ISNULL((SELECT ZOD.DOSYA_GUID , ZOD.AD FROM ZumreOzellikDosya ZOD WHERE ZOD.ID_ZUMREOZELLIK = ZO.ID_ZUMREOZELLIK 
																		FOR JSON PATH, INCLUDE_NULL_VALUES
																	),'[]')
											FROM ZumreBilgi					ZB
											JOIN ZumreOzellik				ZO ON ZO.ID_ZUMREBILGILERI = ZB.ID_ZUMRE
											WHERE ZB.ID_KADEME3 = @ID_KADEME3 AND ZB.ID_DERS = @ID_DERS AND ZB.BAS_TARIH = @BAS_TARIH AND ZB.BIT_TARIH = @BIT_TARIH
											ORDER BY ZO.ID_ZUMRETUR
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[]')
					FROM v3SinavDersUnite		D1
					inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
					WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
					ORDER BY d1.KOD
					FOR JSON PATH
					), '[]')
			END

			IF @ISLEM = 3  -- Zümre Kaydet
			BEGIN
				DECLARE @ID_ZUMRELIST TABLE (ID_ZUMRE INT)
				DECLARE @KAZANIM_LIST TABLE (ID_KAZANIM INT)


				DECLARE @KAZANIM_ANALIZ	INT = NULL, @OGRETIM_YONTEM INT = NULL,@KAYNAK_KITAP INT = NULL,@ATASOZ_DEYIM INT= NULL,@OKUMA_KITAP INT=NULL, @DEGERELEN_BILINC INT = NULL,
				 @HAFTANIN_ARASTIRMASI INT = NULL, @BELIRLI_GUN INT= NULL, @HAFTANIN_ODEVI INT = NULL

				CREATE TABLE #ODEV(ICERIK1 INT, ICERIK2 INT, ICERIK3 INT, ICERIK4 INT, ICERIK5 INT, ICERIK6 INT, ICERIK7 INT, ICERIK8 INT, ICERIK9 INT, ICERIK10 INT, ICERIK11 INT, ICERIK12 INT, ICERIK13 INT, ICERIK14 INT, ICERIK15 INT)

				 INSERT INTO ZumreBilgi (ID_KADEME3, ID_DERS,BAS_TARIH,BIT_TARIH,KYE_TCKIMLIKNO)
				 OUTPUT INSERTED.ID_ZUMRE INTO @ID_ZUMRELIST(ID_ZUMRE)
				 VALUES(@ID_KADEME3,@ID_DERS,@BAS_TARIH,@BIT_TARIH,@TCKIMLIKNO)			

				 SET @ID_ZUMRE = (select TOP 1 ID_ZUMRE from @ID_ZUMRELIST)

				 INSERT INTO  ZumreKazanim(ID_ZUMRE,ID_KAZANIM,SECILI)
				 SELECT @ID_ZUMRE,ID_DERSUNITE,SECILI
				 FROM OPENJSON(@HAFTANIN_KAZANIMI)
				 WITH
				 (
					SECILI BIT,
					ID_DERSUNITE INT
				 ) AS J WHERE J.SECILI = 1

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK1)
				 SELECT @ID_ZUMRE, 10,ICERIK1
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK1 VARCHAR(MAX)
				 ) AS J WHERE ICERIK1 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK2)
				 SELECT @ID_ZUMRE, 10,ICERIK2
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK2 VARCHAR(MAX)
				 ) AS J WHERE ICERIK2 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK3)
				 SELECT @ID_ZUMRE, 10,ICERIK3
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK3 VARCHAR(MAX)
				 ) AS J WHERE ICERIK3 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK4)
				 SELECT @ID_ZUMRE, 10,ICERIK4
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK4 VARCHAR(MAX)
				 ) AS J WHERE ICERIK4 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK5)
				 SELECT @ID_ZUMRE, 10,ICERIK5
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK5 VARCHAR(MAX)
				 ) AS J WHERE ICERIK5 != ''

				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK6)
				 SELECT @ID_ZUMRE, 10,ICERIK6
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK6 VARCHAR(MAX)
				 ) AS J WHERE ICERIK6 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK7)
				 SELECT @ID_ZUMRE, 10,ICERIK7
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK7 VARCHAR(MAX)
				 ) AS J WHERE ICERIK7 != ''

				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK8)
				 SELECT @ID_ZUMRE, 10,ICERIK8
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK8 VARCHAR(MAX)
				 ) AS J WHERE ICERIK8 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK9)
				 SELECT @ID_ZUMRE, 10,ICERIK9
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK9 VARCHAR(MAX)
				 ) AS J WHERE ICERIK9 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK10)
				 SELECT @ID_ZUMRE, 10,ICERIK10
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK10 VARCHAR(MAX)
				 ) AS J WHERE ICERIK10 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK11)
				 SELECT @ID_ZUMRE, 10,ICERIK11
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK11 VARCHAR(MAX)
				 ) AS J WHERE ICERIK11 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK12)
				 SELECT @ID_ZUMRE, 10,ICERIK12
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK12 VARCHAR(MAX)
				 ) AS J WHERE ICERIK12 != ''
				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK13)
				 SELECT @ID_ZUMRE, 10,ICERIK13
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK13 VARCHAR(MAX)
				 ) AS J WHERE ICERIK13 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK14)
				 SELECT @ID_ZUMRE, 10,ICERIK14
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK14 VARCHAR(MAX)
				 ) AS J WHERE ICERIK14 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV(ICERIK15)
				 SELECT @ID_ZUMRE, 10,ICERIK15
				 FROM OPENJSON(@ODEV)
				 WITH
				 (
				 ICERIK15 VARCHAR(MAX)
				 ) AS J WHERE ICERIK15 != ''

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR KAZIM ANALİZ
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,2 ,[KAZANIM_ANALIZ]  
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[KAZANIM_ANALIZ] [varchar](MAX)
				 
				 ) AS J 


				 
				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR OGRETIM YONTEM 
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,3 ,[OGRETIM_YONTEM] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[OGRETIM_YONTEM] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR KAYNAK_KITAP
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,4 ,[KAYNAK_KITAP] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[KAYNAK_KITAP] [varchar](MAX)
				 
				 ) AS J

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR ATASOZ_DEYIM
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,5 ,[ATASOZ_DEYIM] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[ATASOZ_DEYIM] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR OKUMA_KITAP
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,6 ,[OKUMA_KITAP] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[OKUMA_KITAP] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR DEGERELEN_BILINC
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,7 ,[DEGERELEN_BILINC] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[DEGERELEN_BILINC] [varchar](MAX)
				 
				 ) AS J 

				 INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR HAFTANIN_ARASTIRMASI
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,8 ,[HAFTANIN_ARASTIRMASI] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[HAFTANIN_ARASTIRMASI] [varchar](MAX)
				 
				 ) AS J 

				  INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)	-- ZÜMRE TÜR BELIRLI_GUN
				 OUTPUT INSERTED.ID_ZUMREOZELLIK INTO @KAZANIM_LIST(ID_KAZANIM)
				 select		@ID_ZUMRE ,9 ,[BELIRLI_GUN] 
				 from OPENJSON(@SQLJSON)
				 with
				 (					
				 	[BELIRLI_GUN] [varchar](MAX)
				 
				 ) AS J 

				  SELECT ISNULL((
					SELECT DISTINCT
					    ID_ZUMREOZELLIK
					   ,ICERIK
					   ,ID_ZUMRETUR
					   ,ODEV = (SELECT ISNULL((SELECT * FROM #ODEV FOR JSON AUTO),'[]' ))
				     FROM ZumreOzellik WHERE ID_ZUMREBILGILERI = @ID_ZUMRE
					FOR JSON AUTO
				),'[]')		

			END

			IF @ISLEM = 4  -- Zumre Dosya Kaydet 
			BEGIN
					
					INSERT INTO ZumreOzellikDosya (ID_ZUMREOZELLIK,DOSYA_GUID,AD)
					SELECT @ID_ZUMRE_OZELLIK, GUID,AD
					FROM OPENJSON(@DOSYALIST,'$.DOSYA')
					WITH(
						GUID	VARCHAR(MAX),
						AD		VARCHAR(MAX)
					) 
				
				SELECT ISNULL((
					SELECT  
						ZO.ICERIK	
					FROM ZumreBilgi				ZB
					JOIN ZumreOzellik			ZO	ON ZO.ID_ZUMREBILGILERI = ZB.ID_ZUMRE
					JOIN ZumreOzellikDosya		ZOD ON ZOD.ID_ZUMREOZELLIK  = ZO.ID_ZUMREOZELLIK
					WHERE ZO.ID_ZUMREOZELLIK = @ID_ZUMRE_OZELLIK
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END
		    
			IF @ISLEM = 5  -- Zumre Güncelle
			BEGIN 
			

				 UPDATE ZumreBilgi SET ID_KADEME3 = @ID_KADEME3, ID_DERS = @ID_DERS,BAS_TARIH = @BAS_TARIH,BIT_TARIH = @BIT_TARIH,KYE_TCKIMLIKNO=@TCKIMLIKNO
				 WHERE ID_ZUMRE = @ID_ZUMRE
				 
				 CREATE TABLE #ODEV1(ICERIK1 INT, ICERIK2 INT, ICERIK3 INT, ICERIK4 INT, ICERIK5 INT, ICERIK6 INT, ICERIK7 INT, ICERIK8 INT, ICERIK9 INT, ICERIK10 INT, ICERIK11 INT, ICERIK12 INT, ICERIK13 INT, ICERIK14 INT, ICERIK15 INT)
				 INSERT INTO #ODEV1(ICERIK1,ICERIK2,ICERIK3,ICERIK4,ICERIK5,ICERIK6,ICERIK7,ICERIK8,ICERIK9,ICERIK10,ICERIK11,ICERIK12,ICERIK13,ICERIK14,ICERIK15)
				 SELECT ID_ICERIK1,ID_ICERIK2,ID_ICERIK3,ID_ICERIK4,ID_ICERIK5,ID_ICERIK6,ID_ICERIK7,ID_ICERIK8,ID_ICERIK9,ID_ICERIK10,ID_ICERIK11,ID_ICERIK12,ID_ICERIK13,ID_ICERIK14,ID_ICERIK15
				 FROM OPENJSON(@ODEV)
				 WITH(
				  ID_ICERIK1	 INT,
				  ID_ICERIK2	 INT,
				  ID_ICERIK3	 INT,
				  ID_ICERIK4	 INT,
				  ID_ICERIK5	 INT,
				  ID_ICERIK6	 INT,
				  ID_ICERIK7	 INT,
				  ID_ICERIK8	 INT,
				  ID_ICERIK9	 INT,
				  ID_ICERIK10	 INT,
				  ID_ICERIK11	 INT,
				  ID_ICERIK12	 INT,
				  ID_ICERIK13	 INT,
				  ID_ICERIK14	 INT,
				  ID_ICERIK15	 INT
				 ) AS J

				IF EXISTS (SELECT ID_ICERIK1 FROM OPENJSON (@ODEV) WITH(ID_ICERIK1 INT) WHERE ID_ICERIK1 >0)
				BEGIN
					 UPDATE U									-- ZÜMRE TÜR ÖDEV
					 SET U.ICERIK = J.ICERIK1
					 FROM ZumreOzellik AS U
					 JOIN OPENJSON(@ODEV)
					 WITH (
					 ID_ICERIK1 INT,
					 ICERIK1 [varchar](MAX)
					 ) AS J ON J.ID_ICERIK1 = U.ID_ZUMREOZELLIK
				END
				ELSE
				BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK1)
					SELECT @ID_ZUMRE, 10,ICERIK1
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK1 VARCHAR(MAX)
					) AS J WHERE ICERIK1 != ''
				END

				
				 IF EXISTS (SELECT ID_ICERIK2 FROM OPENJSON (@ODEV) WITH(ID_ICERIK2 INT) WHERE ID_ICERIK2 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK2
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK2 INT,
					ICERIK2 [varchar](MAX)
					) AS J ON J.ID_ICERIK2 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK2)
					SELECT @ID_ZUMRE, 10,ICERIK2
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK2 VARCHAR(MAX)
					) AS J WHERE ICERIK2 != ''
				 END

				 IF EXISTS (SELECT ID_ICERIK3 FROM OPENJSON (@ODEV) WITH(ID_ICERIK3 INT) WHERE ID_ICERIK3 >0)
				BEGIN
					 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					 SET U.ICERIK = J.ICERIK3
					 FROM ZumreOzellik AS U
					 JOIN OPENJSON(@ODEV)
					 WITH (
					 ID_ICERIK3 INT,
					 ICERIK3 [varchar](MAX)
					 ) AS J ON J.ID_ICERIK3 = U.ID_ZUMREOZELLIK
				END
				ELSE
				BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK3)
					SELECT @ID_ZUMRE, 10,ICERIK3
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK3 VARCHAR(MAX)
					) AS J WHERE ICERIK3 != ''
				END
				 
				 IF EXISTS (SELECT ID_ICERIK4 FROM OPENJSON (@ODEV) WITH(ID_ICERIK4 INT) WHERE ID_ICERIK4 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK4
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK4 INT,
					ICERIK4 [varchar](MAX)
					) AS J ON J.ID_ICERIK4 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK4)
					SELECT @ID_ZUMRE, 10,ICERIK4
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK4 VARCHAR(MAX)
					) AS J WHERE ICERIK4 != ''
				 END

				 IF EXISTS (SELECT ID_ICERIK5 FROM OPENJSON (@ODEV) WITH(ID_ICERIK5 INT) WHERE ID_ICERIK5 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK5
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK5 INT,
					ICERIK5 [varchar](MAX)
					) AS J ON J.ID_ICERIK5 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK5)
					SELECT @ID_ZUMRE, 10,ICERIK5
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK5 VARCHAR(MAX)
					) AS J WHERE ICERIK5 != ''
				 END
				 
				 IF EXISTS (SELECT ID_ICERIK6 FROM OPENJSON (@ODEV) WITH(ID_ICERIK6 INT) WHERE ID_ICERIK6 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK6
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK6 INT,
					ICERIK6 [varchar](MAX)
					) AS J ON J.ID_ICERIK6 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK6)
					SELECT @ID_ZUMRE, 10,ICERIK6
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK6 VARCHAR(MAX)
					) AS J WHERE ICERIK6 != ''
				 END
				 
				 IF EXISTS (SELECT ID_ICERIK7 FROM OPENJSON (@ODEV) WITH(ID_ICERIK7 INT) WHERE ID_ICERIK7 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK7
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK7 INT,
					ICERIK7 [varchar](MAX)
					) AS J ON J.ID_ICERIK7 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK7)
					SELECT @ID_ZUMRE, 10,ICERIK7
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK7 VARCHAR(MAX)
					) AS J WHERE ICERIK7 != ''
				 END

				IF EXISTS (SELECT ID_ICERIK8 FROM OPENJSON (@ODEV) WITH(ID_ICERIK8 INT) WHERE ID_ICERIK8 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK8
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK8 INT,
					ICERIK8 [varchar](MAX)
					) AS J ON J.ID_ICERIK8 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK8)
					SELECT @ID_ZUMRE, 10,ICERIK8
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK8 VARCHAR(MAX)
					) AS J WHERE ICERIK8 != ''
				 END

				IF EXISTS (SELECT ID_ICERIK9 FROM OPENJSON (@ODEV) WITH(ID_ICERIK9 INT) WHERE ID_ICERIK9 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK9
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK9 INT,
					ICERIK9 [varchar](MAX)
					) AS J ON J.ID_ICERIK9 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK9)
					SELECT @ID_ZUMRE, 10,ICERIK9
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK9 VARCHAR(MAX)
					) AS J WHERE ICERIK9 != ''
				 END

				 IF EXISTS (SELECT ID_ICERIK10 FROM OPENJSON (@ODEV) WITH(ID_ICERIK10 INT) WHERE ID_ICERIK10 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK10
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK10 INT,
					ICERIK10 [varchar](MAX)
					) AS J ON J.ID_ICERIK10 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK10)
					SELECT @ID_ZUMRE, 10,ICERIK10
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK10 VARCHAR(MAX)
					) AS J WHERE ICERIK10 != ''
				 END

				  IF EXISTS (SELECT ID_ICERIK11 FROM OPENJSON (@ODEV) WITH(ID_ICERIK11 INT) WHERE ID_ICERIK11 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK11
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK11 INT,
					ICERIK11 [varchar](MAX)
					) AS J ON J.ID_ICERIK11 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK11)
					SELECT @ID_ZUMRE, 10,ICERIK11
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK11 VARCHAR(MAX)
					) AS J WHERE ICERIK11 != ''
				 END

				 IF EXISTS (SELECT ID_ICERIK12 FROM OPENJSON (@ODEV) WITH(ID_ICERIK12 INT) WHERE ID_ICERIK12 >0)
				 BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK12
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK12 INT,
					ICERIK12 [varchar](MAX)
					) AS J ON J.ID_ICERIK12 = U.ID_ZUMREOZELLIK
				 END
				 ELSE
				 BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK12)
					SELECT @ID_ZUMRE, 10,ICERIK12
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK12 VARCHAR(MAX)
					) AS J WHERE ICERIK12 != ''
				 END

				  IF EXISTS (SELECT ID_ICERIK13 FROM OPENJSON (@ODEV) WITH(ID_ICERIK13 INT) WHERE ID_ICERIK13 >0)
				  BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK13
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK13 INT,
					ICERIK13 [varchar](MAX)
					) AS J ON J.ID_ICERIK13 = U.ID_ZUMREOZELLIK
				  END
				  ELSE
				  BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK13)
					SELECT @ID_ZUMRE, 10,ICERIK13
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK13 VARCHAR(MAX)
					) AS J WHERE ICERIK13 != ''
				  END

				  IF EXISTS (SELECT ID_ICERIK14 FROM OPENJSON (@ODEV) WITH(ID_ICERIK14 INT) WHERE ID_ICERIK14 >0)
				  BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK14
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK14 INT,
					ICERIK14 [varchar](MAX)
					) AS J ON J.ID_ICERIK14 = U.ID_ZUMREOZELLIK
				  END
				  ELSE
				  BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK14)
					SELECT @ID_ZUMRE, 10,ICERIK14
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK14 VARCHAR(MAX)
					) AS J WHERE ICERIK14 != ''
				  END

				  IF EXISTS (SELECT ID_ICERIK15 FROM OPENJSON (@ODEV) WITH(ID_ICERIK15 INT) WHERE ID_ICERIK15 >0)
				  BEGIN
					UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
					SET U.ICERIK = J.ICERIK15
					FROM ZumreOzellik AS U
					JOIN OPENJSON(@ODEV)
					WITH (
					ID_ICERIK15 INT,
					ICERIK15 [varchar](MAX)
					) AS J ON J.ID_ICERIK15 = U.ID_ZUMREOZELLIK
				  END
				  ELSE
				  BEGIN
					INSERT INTO ZumreOzellik (ID_ZUMREBILGILERI,ID_ZUMRETUR,ICERIK)
					OUTPUT INSERTED.ID_ZUMREOZELLIK INTO #ODEV1(ICERIK15)
					SELECT @ID_ZUMRE, 10,ICERIK15
					FROM OPENJSON(@ODEV)
					WITH
					(
					ICERIK15 VARCHAR(MAX)
					) AS J WHERE ICERIK15 != ''
				  END

				 UPDATE U									-- ZÜMRE TÜR KAZANIM ANALİZ
				 SET U.ICERIK = J.KAZANIM_ANALIZ
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_KAZANIM_ANALIZ INT,
				 [KAZANIM_ANALIZ] [varchar](MAX)
				 ) AS J ON J.ID_KAZANIM_ANALIZ = U.ID_ZUMREOZELLIK

				  UPDATE U									-- ZÜMRE TÜR OGRETIM_YONTEM
				 SET U.ICERIK = J.OGRETIM_YONTEM
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_OGRETIM_YONTEM INT,
				 [OGRETIM_YONTEM] [varchar](MAX)
				 ) AS J ON J.ID_OGRETIM_YONTEM = U.ID_ZUMREOZELLIK

				 UPDATE U									--  ZÜMRE TÜR KAYNAK_KITAP
				 SET U.ICERIK = J.KAYNAK_KITAP
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_KAYNAK_KITAP INT,
				 [KAYNAK_KITAP] [varchar](MAX)
				 ) AS J ON J.ID_KAYNAK_KITAP = U.ID_ZUMREOZELLIK

				  UPDATE U									-- ZÜMRE TÜR ATASOZ_DEYIM
				 SET U.ICERIK = J.ATASOZ_DEYIM
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_ATASOZ_DEYIM INT,
				 [ATASOZ_DEYIM] [varchar](MAX)
				 ) AS J ON J.ID_ATASOZ_DEYIM = U.ID_ZUMREOZELLIK

				   UPDATE U											-- ZÜMRE TÜR OKUMA_KITAP
				 SET U.ICERIK = J.OKUMA_KITAP
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_OKUMA_KITAP INT,
				 [OKUMA_KITAP] [varchar](MAX)
				 ) AS J ON J.ID_OKUMA_KITAP = U.ID_ZUMREOZELLIK

				 UPDATE U										  -- ZÜMRE TÜR DEGERELEN_BILINC
				 SET U.ICERIK = J.DEGERELEN_BILINC
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_DEGERELEN_BILINC INT,
				 [DEGERELEN_BILINC] [varchar](MAX)
				 ) AS J ON J.ID_DEGERELEN_BILINC = U.ID_ZUMREOZELLIK

				 UPDATE U										 -- ZÜMRE TÜR HAFTANIN_ARASTIRMASI
				 SET U.ICERIK = J.HAFTANIN_ARASTIRMASI
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_HAFTANIN_ARASTIRMASI INT,
				 [HAFTANIN_ARASTIRMASI] [varchar](MAX)
				 ) AS J ON J.ID_HAFTANIN_ARASTIRMASI = U.ID_ZUMREOZELLIK

				 UPDATE U												-- ZÜMRE TÜR BELIRLI_GUN
				 SET U.ICERIK = J.BELIRLI_GUN
				 FROM ZumreOzellik AS U
				 JOIN OPENJSON(@SQLJSON)
				 WITH (
				 ID_BELIRLI_GUN INT,
				 [BELIRLI_GUN] [varchar](MAX)
				 ) AS J ON J.ID_BELIRLI_GUN = U.ID_ZUMREOZELLIK
					
				--UPDATE U 
				--SET U.ID_KAZANIM = J.ID_DERSUNITE, U.SECILI = J.SECILI
				--FROM ZumreKazanim AS U
				--JOIN OPENJSON(@HAFTANIN_KAZANIMI)
				--WITH
				--(
				--	SECILI BIT,
				--	ID_DERSUNITE INT
				--) AS J ON J.SECILI = 0 AND J.ID_DERSUNITE = U.ID_KAZANIM AND U.ID_ZUMRE_KAZANIM = @ID_HAFTANIN_KAZANIMI
				
				CREATE TABLE #ZumreKazanim (ID_ZUMRE_KAZANIM INT)
				
				INSERT INTO #ZumreKazanim (ID_ZUMRE_KAZANIM)
				SELECT ID_ZUMRE_KAZANIM
				FROM OPENJSON(@HAFTANIN_KAZANIMI)
				WITH
				(
					ID_ZUMRE_KAZANIM INT,
					SECILI BIT
				) AS J WHERE J.SECILI = 0 

				DELETE FROM ZumreKazanim WHERE ID_ZUMRE_KAZANIM IN (SELECT ID_ZUMRE_KAZANIM FROM #ZumreKazanim)				


				 INSERT INTO  ZumreKazanim(ID_ZUMRE,ID_KAZANIM,SECILI)
				 SELECT @ID_ZUMRE,ID_DERSUNITE,SECILI
				 FROM OPENJSON(@HAFTANIN_KAZANIMI)
				 WITH
				 (
					SECILI BIT,
					ID_DERSUNITE INT,
					ID_ZUMRE_KAZANIM INT
				 ) AS J WHERE J.SECILI = 1 AND J.ID_ZUMRE_KAZANIM < 1

				  SELECT ISNULL((
					SELECT DISTINCT
					    ID_ZUMREOZELLIK
					   ,ICERIK
					   ,ID_ZUMRETUR
					   ,ODEV = (SELECT ISNULL((SELECT * FROM #ODEV1 FOR JSON AUTO),'[]' ))
				     FROM ZumreOzellik WHERE ID_ZUMREBILGILERI = @ID_ZUMRE
					FOR JSON AUTO
				),'[]')		
			
			END

			IF @ISLEM = 6  -- DOSYA DETAY GÖR
			BEGIN
				SELECT ISNULL((
					SELECT 
						 DOSYA_GUID
						,AD
						,ID_ZUMREOZELLIKDOSYA
					FROM ZumreOzellikDosya			ZOD
					WHERE ZOD.ID_ZUMREOZELLIK = @ID_DOSYA
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 7  -- DOSYA SİL
			BEGIN
				SELECT @ID_DOSYA = ID_ZUMREOZELLIK  FROM ZumreOzellikDosya WHERE ID_ZUMREOZELLIKDOSYA = @ID_ZUMREOZELLIKDOSYA
				DELETE FROM ZumreOzellikDosya WHERE ID_ZUMREOZELLIKDOSYA = @ID_ZUMREOZELLIKDOSYA

				SELECT ISNULL((
					SELECT 
						 DOSYA_GUID
						,AD
						,ID_ZUMREOZELLIKDOSYA
					FROM ZumreOzellikDosya			ZOD
					WHERE ZOD.ID_ZUMREOZELLIK = @ID_DOSYA
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 8  -- Log Kaydet
			BEGIN
				INSERT INTO ZumreLog (ID_ZUMRE_TUR,SECILI,TCKIMLIKNO,BAS_TARIH,BIT_TARIH) VALUES (@ID_ZUMRE_TUR, 1,@TCKIMLIKNO,@BAS_TARIH,@BIT_TARIH)
			END
			
			IF @ISLEM = 9  -- Log Listele
			BEGIN
				SELECT ISNULL ((
							SELECT 
								 HAFTANIN_KAZANIMI	= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 1 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,KAZANIM_ANALIZ		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 2 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,OGRETIM_YONTEM		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 3 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,KAYNAK_KITAP			= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 4 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,HAFTANIN_ATASOZU		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 5 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,OKUMA_KITABI			= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 6 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,DERGERLER_BILINCI	= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 7 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,HAFTANIN_ARASTIRMASI	= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 8 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,BELIRLI_GUN			= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 9 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,HAFTANIN_ODEVI		= (SELECT  ISNULL(SUM(ZZ.SECILI),0) FROM ZumreLog ZZ WHERE ZZ.ID_ZUMRE_TUR = 10 AND ZZ.BAS_TARIH = @BAS_TARIH AND ZZ.BIT_TARIH = @BIT_TARIH)
								,TCKIMLIKNO=ZL.TCKIMLIKNO
								,AD=K.AD + ' ' + K.SOYAD
							FROM ZumreLog			ZL
							JOIN v3Kullanici		K  ON K.TCKIMLIKNO   = ZL.TCKIMLIKNO  
							WHERE ZL.BAS_TARIH = @BAS_TARIH AND ZL.BIT_TARIH = @BIT_TARIH
							GROUP BY ZL.TCKIMLIKNO,K.AD,K.SOYAD
							FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END

			IF @ISLEM = 10 --  Sınıf
			BEGIN
				select distinct 					   
					   SGS.ID_KADEME3					  
					   ,AD = SGS.KADEME3
				  from eokul_v2.dbo.DersOgretmen do
			 left join OkyanusDB.dbo.v3Kullanici pb on pb.TCKIMLIKNO=do.TC_OGRETMEN
			 inner join eokul_v2.dbo.Ders   d on d.ID_DERS=do.ID_DERS
			 INNER JOIN OkyanusDB.dbo.v3Ogretmen O ON O.ID_OGRETMEN = do.ID_OGRETMEN
			 left join OKYANUSDB.DBO.V3EgitimTuru e on e.ID_EGITIMTURU=do.ID_EGITIMTURU
			 JOIN OkyanusDB.dbo.vw_SubeGrupSinif SGS ON SGS.ID_SINIF = DO.ID_SINIF
	   			 WHERE 	DONEMKOD= @AKTIFDONEM
				 --pb.TCKIMLIKNO = @TCKIMLIKNO
				   AND d.AKTIF=1
				   AND SGS.ID_KADEME3 IN (7,8,9,10) AND SGS.SINIF NOT LIKE 'ÜZİ%'
				ORDER BY AD
			END	

			IF @ISLEM = 11 -- Öğretmen Ders Getir
			BEGIN 
				DECLARE @BASKAN  BIT = 0, @OGRETMEN BIT = 0

					SELECT DISTINCT
					    @OGRETMEN = ISNULL((SELECT TOP 1 1 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 3),0)
					   ,@BASKAN	 = ISNULL((SELECT TOP 1 1  FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND (ID_KULLANICITIPI = 27 OR ID_KULLANICITIPI = 59)),0)
					 FROM OkyanusDB.dbo.vw_KullaniciYetki WHERE TCKIMLIKNO = @TCKIMLIKNO



					 IF @BASKAN = 1 
					 BEGIN
						SELECT d.ID_DERS, d.AD FROM [dbo].[v3SinavDers] d where d.ID_KADEME3=@ID_KADEME3 
					 END 

					IF @OGRETMEN = 1 
					BEGIN
						select distinct 
							 do.ID_DERS,
							 AD=d.DERSAD
					   from eokul_v2.dbo.DersOgretmen do
					   left join OkyanusDB.dbo.v3Kullanici pb on pb.TCKIMLIKNO=do.TC_OGRETMEN
					   inner join eokul_v2.dbo.Ders d on d.ID_DERS=do.ID_DERS
					   INNER JOIN OkyanusDB.dbo.v3Ogretmen O ON O.ID_OGRETMEN = do.ID_OGRETMEN
					   left join OKYANUSDB.DBO.V3EgitimTuru e on e.ID_EGITIMTURU=do.ID_EGITIMTURU
					   JOIN OkyanusDB.dbo.vw_SubeGrupSinif SGS ON SGS.ID_SINIF = DO.ID_SINIF
	   				   	 WHERE 	DONEMKOD= (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
					   	 AND pb.TCKIMLIKNO = @TCKIMLIKNO
					   	   AND d.AKTIF=1
					   	   AND SGS.ID_KADEME3 = @ID_KADEME3 AND SGS.SINIF NOT LIKE 'ÜZİ%'
					    order by d.DERSAD
					END
				
			END

		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

