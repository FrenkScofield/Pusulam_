/*
Deployment script for Pusulam

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Pusulam"
:setvar DefaultFilePrefix "Pusulam"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Disabling all DDL triggers...'
GO
DISABLE TRIGGER ALL ON DATABASE
GO
PRINT N'Dropping [dbo].[DF_DisOgrenci_AKTIF]...';


GO
ALTER TABLE [dbo].[DisOgrenci] DROP CONSTRAINT [DF_DisOgrenci_AKTIF];


GO
PRINT N'Dropping [dbo].[DF_DisOgrenci_SIFRE]...';


GO
ALTER TABLE [dbo].[DisOgrenci] DROP CONSTRAINT [DF_DisOgrenci_SIFRE];


GO
PRINT N'Dropping [dbo].[DF_Table_1_GRUPID]...';


GO
ALTER TABLE [dbo].[DisOgrenci] DROP CONSTRAINT [DF_Table_1_GRUPID];


GO
PRINT N'Dropping [dbo].[DF_Table_1_ID_DONEM]...';


GO
ALTER TABLE [dbo].[DisOgrenci] DROP CONSTRAINT [DF_Table_1_ID_DONEM];


GO
PRINT N'Dropping [dbo].[DF_Tbl_OnlineSinavOgrenciOturum_KYE_TARIH]...';


GO
ALTER TABLE [dbo].[Tbl_OnlineSinavOgrenciOturum] DROP CONSTRAINT [DF_Tbl_OnlineSinavOgrenciOturum_KYE_TARIH];


GO
PRINT N'Starting rebuilding table [dbo].[DisOgrenci]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_DisOgrenci] (
    [ID_DIS_OGRENCI] INT            IDENTITY (1, 1) NOT NULL,
    [TCKIMLIKNO]     VARCHAR (11)   NOT NULL,
    [AD]             VARCHAR (200)  NOT NULL,
    [SOYAD]          VARCHAR (200)  NOT NULL,
    [ID_KADEME3]     INT            CONSTRAINT [DF_Table_1_GRUPID] DEFAULT ((0)) NOT NULL,
    [DONEM]          INT            CONSTRAINT [DF_Table_1_ID_DONEM] DEFAULT ((0)) NOT NULL,
    [EPOSTA]         NVARCHAR (320) NULL,
    [VELI_AD_SOYAD]  VARCHAR (300)  NULL,
    [VELI_TELEFON]   VARCHAR (15)   NULL,
    [SIFRE]          VARCHAR (7)    CONSTRAINT [DF_DisOgrenci_SIFRE] DEFAULT ('okyanus') NOT NULL,
    [KYE_TCKIMLIKNO] VARCHAR (11)   NULL,
    [SUBE_NO]        INT            NULL,
    [AKTIF]          BIT            CONSTRAINT [DF_DisOgrenci_AKTIF] DEFAULT ((1)) NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_DisOgrenci1] PRIMARY KEY CLUSTERED ([ID_DIS_OGRENCI] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[DisOgrenci])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_DisOgrenci] ON;
        INSERT INTO [dbo].[tmp_ms_xx_DisOgrenci] ([ID_DIS_OGRENCI], [TCKIMLIKNO], [AD], [SOYAD], [ID_KADEME3], [DONEM], [EPOSTA], [VELI_AD_SOYAD], [VELI_TELEFON], [SIFRE], [KYE_TCKIMLIKNO], [AKTIF])
        SELECT   [ID_DIS_OGRENCI],
                 [TCKIMLIKNO],
                 [AD],
                 [SOYAD],
                 [ID_KADEME3],
                 [DONEM],
                 [EPOSTA],
                 [VELI_AD_SOYAD],
                 [VELI_TELEFON],
                 [SIFRE],
                 [KYE_TCKIMLIKNO],
                 [AKTIF]
        FROM     [dbo].[DisOgrenci]
        ORDER BY [ID_DIS_OGRENCI] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_DisOgrenci] OFF;
    END

DROP TABLE [dbo].[DisOgrenci];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_DisOgrenci]', N'DisOgrenci';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_DisOgrenci1]', N'PK_DisOgrenci', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Altering [dbo].[Tbl_OnlineSinavOgrenciOturum]...';


GO
ALTER TABLE [dbo].[Tbl_OnlineSinavOgrenciOturum] ALTER COLUMN [BASTARIH] DATETIME NULL;


GO
PRINT N'Creating [dbo].[DF_Tbl_OnlineSinavOgrenciOturum_KYE_TARIH]...';


GO
ALTER TABLE [dbo].[Tbl_OnlineSinavOgrenciOturum]
    ADD CONSTRAINT [DF_Tbl_OnlineSinavOgrenciOturum_KYE_TARIH] DEFAULT (getdate()) FOR [BASTARIH];


GO
PRINT N'Altering [dbo].[sp_OnlineSinav]...';


GO
ALTER PROC [dbo].[sp_OnlineSinav]
	@ISLEM							INT				= NULL,
	@TCKIMLIKNO						VARCHAR(11)		= NULL,
	@OTURUM							VARCHAR(36)		= NULL,
	@ID_MENU						INT				= NULL,

	@ID_SORU						INT				= NULL,
	@ID_SINAV						INT				= NULL,
	@ID_DERS						INT				= NULL,
	@ID_SINAVTURU					INT				= NULL,
	@ID_SINAVANAHTAR				INT				= NULL,
	@ID_CEVAP						INT				= NULL,
	@ID_ONLINESINAVOGRENCI			INT				= NULL,
	@SINAVOTURUM					INT				= NULL,
	@ID_ONLINESINAVOGRENCIOTURUM	INT				= NULL,
	@CEVAPANAHTARI					BIT				= NULL,
	@KYE_TARIH						DATETIME		= NULL,
	@TC_EKLEYEN						VARCHAR(MAX)	= NULL,
	@TC_OGRENCI						VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST					VARCHAR(MAX)	= NULL,
	@TC_OGRENCILIST					VARCHAR(MAX)	= NULL,
	@JSON							VARCHAR(MAX)	= NULL,
	@SQLJSON						VARCHAR(MAX)	= NULL,
	@DIS_OGRENCI					BIT				=0
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM	
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU
								
				,ID_SORU					= @ID_SORU
				,TC_EKLEYEN					= @TC_EKLEYEN
				,KYE_TARIH					= @KYE_TARIH
				,ID_SINAV					= @ID_SINAV
				,ID_DERS					= @ID_DERS
				,ID_SINAVTURU				= @ID_SINAVTURU
				,ID_ONLINESINAVOGRENCI		= @ID_ONLINESINAVOGRENCI
				,ID_ONLINESINAVOGRENCIOTURUM= @ID_ONLINESINAVOGRENCIOTURUM
				,SINAVOTURUM				= @SINAVOTURUM
				,CEVAPANAHTARI				= @CEVAPANAHTARI
				,[JSON]						= @JSON
				,SQLJSON					= @SQLJSON
				,ID_SINIFLIST				= @ID_SINIFLIST
				,TC_OGRENCILIST				= @TC_OGRENCILIST
				,TC_OGRENCI					= @TC_OGRENCI
				,ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
				,ID_CEVAP					= @ID_CEVAP
				,ID_SUBELIST				= @ID_SUBELIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	
	
	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT

		IF @ISLEM IN (12,13,14)
		BEGIN
			SET @_ID_LOG = 1
		END
		IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
		BEGIN
			SET @_ID_LOG=1
		END
		ELSE
			EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @_ID_LOG > 0
		BEGIN
		
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 
						FROM OkyanusDB.DBO.v3SubeYetki 
						WHERE	TCKIMLIKNO		 = @TCKIMLIKNO 
							AND ID_KULLANICITIPI IN (1,60)
			) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK			
				SET @OZELSINAVGOR=1
			
			DECLARE @QUERY NVARCHAR(MAX) = NULL

			IF @ISLEM = 1	--	Sınav Listele
			BEGIN
				SELECT
				(
					SELECT *, CONVERT(decimal(4,2), (CONVERT(decimal(4,2), XTABLE.DOGRU)/CONVERT(decimal(4,2), (XTABLE.DOGRU + XTABLE.BOS + XTABLE.YANLIS))*100.0)) AS PERFORMANS  
					FROM
					(
						SELECT 
							SOA.ID_SINAV
							,ISNULL(OSO.ID_ONLINESINAVOGRENCI,0) AS ID_ONLINESINAVOGRENCI
							,(
								SELECT DISTINCT AD + ', ' AS [text()] 
								FROM v3Sinavders 
								WHERE ID_DERS IN 
									(
										SELECT SUBSD.ID_DERS 
										FROM		SoruBankasi.dbo.SoruDetay	SUBSD 
										INNER JOIN	SoruBankasi.dbo.SinavSoru	SUBSS	ON SUBSS.ID_SORU = SUBSD.ID_SORU
										WHERE SUBSS.ID_SINAV=SOA.ID_SINAV
									) 
								For XML PATH ('')
							) AS DERS
							,V.AD AS SINAVTURU
							,S.AD AS ADI
							,ISNULL(OSO.GIRIS_SAYISI, 0) AS GIRIS
							,ISNULL(CONVERT(VARCHAR, OSO.BAS_TARIH, 104), '-') AS SONGIRIS
							,cast(ISNULL(OSO.DURUM, 0) as int) AS DURUM
							,CAST(DATEPART(HOUR,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR)+':'+CAST(DATEPART(MINUTE,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR)+':'+CAST(DATEPART(SECOND,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR) AS SURE
							,COUNT(C.DEGER) AS DOGRU
							,(SELECT COUNT(*) - COUNT(C.DEGER) FROM OnlineSinavOgrenciCevap SUBOC WHERE SUBOC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI) AS YANLIS
							,(
								SELECT COUNT(*) - (COUNT(C.DEGER) + (SELECT COUNT(*) - COUNT(C.DEGER) FROM OnlineSinavOgrenciCevap SUBOC WHERE SUBOC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI))
								FROM SoruBankasi.dbo.Soru SUBS
								INNER JOIN SoruBankasi.dbo.SinavSoru SUBSS ON SUBSS.ID_SORU=SUBS.ID_SORU
								INNER JOIN SoruBankasi.dbo.Cevap	 SUBC  ON SUBC.ID_SORU=SUBS.ID_SORU
								WHERE SUBSS.ID_SINAV=SOA.ID_SINAV AND SUBSS.KITAPCIK='A' AND (
																(SUBS.ID_SORUTUR=2)						--	AÇIK UÇLU
															OR (SUBS.ID_SORUTUR=3)						--	DOĞRU YANLIŞ
															OR (SUBS.ID_SORUTUR=4 AND SUBC.DEGER='1')	--	TEST
															OR (SUBS.ID_SORUTUR=5 AND SUBC.DEGER<>'')	--	EŞLEŞTİRME
															OR (SUBS.ID_SORUTUR=6)						--	BOŞLUK DOLDURMA
															)
							) AS BOS,
							CASE WHEN (S.BAS_TARIH<=CAST(GETDATE() AS DATE) AND S.BAS_SAAT<=convert(varchar(10), GETDATE(), 108))
								  AND ((S.BIT_TARIH=CAST(GETDATE() AS DATE) AND S.BIT_SAAT>=convert(varchar(10), GETDATE(), 108))
										OR 
										(S.BIT_TARIH>CAST(GETDATE() AS DATE))
									)
							THEN 1 ELSE 0 END AS DEVAM
						FROM		SoruBankasi.dbo.SinavOgrenciAtama	SOA
						INNER JOIN	SoruBankasi.dbo.Sinav				S	ON S.ID_SINAV=SOA.ID_SINAV 
						INNER JOIN	SoruBankasi.dbo.Varlik				V	ON V.ID_VARLIK=S.ID_SINAVTUR
						INNER JOIN	SoruBankasi.dbo.SinavSoru			SS	ON SS.ID_SINAV=S.ID_SINAV AND SS.KITAPCIK='A'
						INNER JOIN	SoruBankasi.dbo.Soru				SOR	ON SOR.ID_SORU=SS.ID_SORU 
						INNER JOIN	SoruBankasi.dbo.SoruDetay			SD	ON SD.ID_SORU=SS.ID_SORU 
						LEFT  JOIN	OnlineSinavOgrenci					OSO ON OSO.TCKIMLIKNO=SOA.TCKIMLIKNO AND OSO.ID_ONLINESINAV=SOA.ID_SINAV
						LEFT  JOIN	OnlineSinavOgrenciCevap				OC	ON OC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI AND OC.ID_SORU=SOR.ID_SORU
						LEFT  JOIN	SoruBankasi.dbo.Cevap				C	ON C.ID_SORU=SOR.ID_SORU AND (
																												(SOR.ID_SORUTUR=2 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	AÇIK UÇLU
																											OR (SOR.ID_SORUTUR=3 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	DOĞRU YANLIŞ
																											OR (SOR.ID_SORUTUR=4 AND C.DEGER='1' AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.CEVAPNO AS VARCHAR))				--	TEST
																											OR (SOR.ID_SORUTUR=5 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	EŞLEŞTİRME
																											OR (SOR.ID_SORUTUR=6 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	BOŞLUK DOLDURMA
																											)
						WHERE	(@ID_SINAV IS NULL OR SOA.ID_SINAV=@ID_SINAV) 
							
							AND ID_SORUTUR<>1 
							AND ID_USTSORU IS NULL 
							AND SOA.TCKIMLIKNO=@TCKIMLIKNO
							AND (@ID_SINAVTURU IS NULL OR @ID_SINAVTURU = 0 OR S.ID_SINAVTUR=@ID_SINAVTURU) 
							AND (@ID_DERS IS NULL OR @ID_DERS = 0 OR SD.ID_DERS=@ID_DERS) --@TCKIMLIKNO AND 
						GROUP BY SOA.ID_SINAV, S.BAS_TARIH, S.BAS_SAAT, S.BIT_TARIH, S.BIT_SAAT, OSO.ID_ONLINESINAVOGRENCI, V.AD, S.AD, OSO.DURUM, OSO.GIRIS_SAYISI, OSO.BAS_TARIH, OSO.BIT_TARIH
					) XTABLE
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS JSON
			END

			IF @ISLEM = 2	--	Soru Listesi Getir 
			BEGIN
				SELECT
				(
					SELECT 
						S.ID_SORU
						,S.ID_SORUTUR
						,S.ID_USTSORU
						,SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
						,(SELECT
							(
								SELECT
									SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
									,(
										 SELECT 
											 ID_SORU=ISNULL(ID_SORU,0)
											,ID_USTSORU=ISNULL(ID_USTSORU,0)
											,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
											,SUBV.AD AS SORUTUR
											,KOD=ISNULL(KOD,0)
											,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
											,ID_DERS=ISNULL(ID_DERS,0)
											,UNITE=ISNULL(UNITE,0)
											,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
										 FROM SoruBankasi.dbo.SoruDetay SUBSD 
										 INNER JOIN SoruBankasi.dbo.Varlik SUBV ON SUBV.ID_VARLIK=SUBS.ID_SORUTUR
										 Where ID_SORU=SUBS.ID_SORU 
										 FOR JSON PATH
									 ) AS Soru,
									(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
									(	
										SELECT C.*
										FROM SoruBankasi.dbo.Cevap C
										Where C.ID_SORU=SUBS.ID_SORU ORDER BY ID_CEVAP,C.CEVAPNO,LEN(DEGER) DESC FOR JSON PATH
									)AS CevapListesi,
									(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS CozumListesi
								FROM SoruBankasi.dbo.Soru SUBS 
								WHERE SUBS.ID_SORU = S.ID_SORU OR SUBS.ID_USTSORU = S.ID_SORU
								FOR JSON AUTO, INCLUDE_NULL_VALUES 
							) AS SoruPaketList
						)AS SoruPaketList
					FROM SoruBankasi.dbo.Soru S
					INNER JOIN SoruBankasi.dbo.SinavSoru SS ON SS.ID_SORU=S.ID_SORU
					WHERE ID_SINAV=@ID_SINAV AND SS.KITAPCIK='A' AND ID_SORUTUR<>1 AND ID_USTSORU IS NULL
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 3	--	Soru Getir
			BEGIN
				SELECT
				(
					SELECT 
						 SORUNO = ROW_NUMBER() OVER(ORDER BY ID_SORU ASC)
						,(
							 SELECT 
								 ID_SORU=ISNULL(ID_SORU,0)
								,ID_USTSORU=ISNULL(ID_USTSORU,0)
								,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
								,KOD=ISNULL(KOD,0)
								,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
								,ID_DERS=ISNULL(ID_DERS,0)
								,UNITE=ISNULL(UNITE,0)
								,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
							 FROM SoruBankasi.dbo.SoruDetay Where ID_SORU=S.ID_SORU 
							 FOR JSON PATH
						 ) AS Soru,
						(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=S.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
						(SELECT * FROM SoruBankasi.dbo.Cevap	 Where ID_SORU=S.ID_SORU ORDER BY  LEN(DEGER) DESC, CEVAPNO ASC FOR JSON PATH)AS CevapListesi,
						(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=S.ID_SORU FOR JSON PATH)AS CozumListesi
					FROM SoruBankasi.dbo.Soru S 
					WHERE S.ID_SORU = @ID_SORU OR S.ID_USTSORU = @ID_SORU
					FOR JSON AUTO, INCLUDE_NULL_VALUES 
				) AS SoruPaketList
			END

			IF @ISLEM = 4	--	Sınav Türü Getir
			BEGIN
				SELECT
				(
					SELECT ID_VARLIK, AD FROM SoruBankasi.dbo.Varlik V
					WHERE ID_VARLIKTUR=5
					FOR JSON PATH
				) J
			END

			IF @ISLEM = 5	--	Giriş Ekle
			BEGIN
				IF NOT EXISTS(SELECT ID_ONLINESINAVOGRENCI FROM [OnlineSinavOgrenci] WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV)
				BEGIN
					declare @ID table(ID int)
					INSERT INTO [dbo].[OnlineSinavOgrenci]
							   ([TCKIMLIKNO]
							   ,[ID_ONLINESINAV]
							   ,[DURUM]
							   ,[GIRIS_SAYISI]
							   ,[BAS_TARIH]
							   ,[BIT_TARIH])
						OUTPUT inserted.ID_ONLINESINAVOGRENCI into @ID 
						 VALUES
								(@TCKIMLIKNO
								,@ID_SINAV
								,0
								,1
								,GETDATE()
								,NULL)
					select ID from @ID
				END
				ELSE
				BEGIN
					UPDATE [dbo].[OnlineSinavOgrenci] SET [GIRIS_SAYISI]=[GIRIS_SAYISI]+1, [BAS_TARIH]=GETDATE(), [BIT_TARIH]=NULL WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV
					SELECT ID_ONLINESINAVOGRENCI FROM [OnlineSinavOgrenci] WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV
				END

			END

			IF @ISLEM = 6	--	Sınavı Bitir
			BEGIN
				DELETE FROM [dbo].[OnlineSinavOgrenciCevap] WHERE ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
			
				INSERT INTO [dbo].[OnlineSinavOgrenciCevap]
						   ([ID_SORU]
						   ,[ID_ONLINESINAVOGRENCI]
						   ,[CEVAPNO]
						   ,[CEVAP])
				SELECT ID_SORU, @ID_ONLINESINAVOGRENCI, CEVAPNO, CEVAP FROM OPENJSON(@JSON)
				WITH(
					 ID_SORU	INT				'$.ID_SORU' 
					,CEVAPNO	INT				'$.CEVAPNO' 
					,CEVAP		VARCHAR(MAX)	'$.CEVAP' 
				)

				UPDATE OnlineSinavOgrenci SET DURUM=1, BIT_TARIH=GETDATE() WHERE ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
			END

			IF @ISLEM = 7	--	Soru Listesi Getir Cevaplı
			BEGIN
				SELECT
				(
					SELECT 
						S.ID_SORU
						,S.ID_SORUTUR
						,S.ID_USTSORU
						,SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
						,(SELECT
							(
								SELECT
									SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
									,(
										 SELECT 
											 ID_SORU=ISNULL(ID_SORU,0)
											,ID_USTSORU=ISNULL(ID_USTSORU,0)
											,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
											,SUBV.AD AS SORUTUR
											,KOD=ISNULL(KOD,0)
											,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
											,ID_DERS=ISNULL(ID_DERS,0)
											,UNITE=ISNULL(UNITE,0)
											,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
										 FROM SoruBankasi.dbo.SoruDetay SUBSD 
										 INNER JOIN SoruBankasi.dbo.Varlik SUBV ON SUBV.ID_VARLIK=SUBS.ID_SORUTUR
										 Where ID_SORU=SUBS.ID_SORU 
										 FOR JSON PATH
									 ) AS Soru,
									(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
									(	
										SELECT C.*, OC.CEVAP, SECILI = CASE WHEN SUBS.ID_SORUTUR=4 THEN (CASE WHEN C.ID_CEVAP=(SELECT ID_CEVAP FROM SoruBankasi.dbo.Cevap WHERE ID_SORU=C.ID_SORU AND CEVAPNO=OC.CEVAP) THEN 1 ELSE 0 END) ELSE 0 END
										FROM SoruBankasi.dbo.Cevap C
										LEFT JOIN OnlineSinavOgrenciCevap OC ON OC.ID_SORU=C.ID_SORU AND (SUBS.ID_SORUTUR=4 OR (SUBS.ID_SORUTUR<>4 AND OC.CEVAPNO=C.CEVAPNO)) AND OC.ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
										Where C.ID_SORU=SUBS.ID_SORU ORDER BY ID_CEVAP,C.CEVAPNO,LEN(DEGER) DESC FOR JSON PATH
									)AS CevapListesi,
									(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS CozumListesi
								FROM SoruBankasi.dbo.Soru SUBS 
								WHERE SUBS.ID_SORU = S.ID_SORU OR SUBS.ID_USTSORU = S.ID_SORU
								FOR JSON AUTO, INCLUDE_NULL_VALUES 
							) AS SoruPaketList
						)AS SoruPaketList
					FROM SoruBankasi.dbo.Soru S
					INNER JOIN SoruBankasi.dbo.SinavSoru SS ON SS.ID_SORU=S.ID_SORU
					WHERE ID_SINAV=@ID_SINAV AND SS.KITAPCIK='A' AND ID_SORUTUR<>1 AND ID_USTSORU IS NULL
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			-- YENİ ONLINE SINAV

			IF @ISLEM = 8	--	ONLINE SINAV DETAY						
			BEGIN

				SELECT ISNULL((
					SELECT DISTINCT 
						 S.ID_SINAV
						,CEVAPGOR		= ISNULL(OSD.CEVAPGOR,0)
						,ACIKLANMATARIH	= CONVERT(varchar,ISNULL(OSD.ACIKLANMATARIH,DATEADD(WEEK,2,GETDATE())),104)
						,ACIKLANMASAAT	= CONVERT(char(5),ISNULL(OSD.ACIKLANMATARIH,DATEADD(WEEK,2,GETDATE())),108)
						,OSDO.ID_ONLINESINAVDETAYOTURUM
						,OTURUM			= ISNULL(SOD.OTURUM,1)
						,BASTARIH		= CONVERT(varchar,ISNULL(OSDO.BASTARIH,GETDATE()),104)
						,BASSAAT		= CONVERT(char(5),ISNULL(OSDO.BASTARIH,DATEADD(HOUR,ISNULL(SOD.OTURUM,1),GETDATE())),108)
						,BITTARIH		= CONVERT(varchar,ISNULL(OSDO.BITTARIH,DATEADD(WEEK,1,GETDATE())),104)
						,BITSAAT		= CONVERT(char(5),ISNULL(OSDO.BITTARIH,DATEADD(WEEK,1,DATEADD(HOUR,ISNULL(SOD.OTURUM,1),GETDATE()))),108)
						,SURE			= ISNULL(OSDO.SURE,100)
					FROM Sinav								S	 WITH(NOLOCK) 
					LEFT JOIN Tbl_OnlineSinavDetay			OSD	 WITH(NOLOCK) ON	OSD.ID_SINAV			= S.ID_SINAV
																			  AND	OSD.AKTIF				= 1 
					LEFT JOIN SinavDers						SD	 WITH(NOLOCK) ON	SD.ID_SINAV				= S.ID_SINAV
					LEFT JOIN SinavOptikDers				SOD	 WITH(NOLOCK) ON	SOD.ID_SINAVDERS		= SD.ID_SINAVDERS
					LEFT JOIN Tbl_OnlineSinavDetayOturum	OSDO WITH(NOLOCK) ON	OSDO.ID_ONLINESINAVDETAY= OSD.ID_ONLINESINAVDETAY
																			  AND	OSDO.OTURUM				= ISNULL(SOD.OTURUM,1)
					WHERE	S.ID_SINAV	= @ID_SINAV
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 9	--	ONLINE SINAV DETAY KAYDET				
			BEGIN

				UPDATE Tbl_OnlineSinavDetay SET
					AKTIF = 0
				WHERE	ID_SINAV = JSON_VALUE (@SQLJSON, '$.ID_SINAV') 
					AND AKTIF	 = 1

				
				DROP TABLE IF EXISTS #TEMP9

				SELECT	 ID_SINAV
						,BASTARIH		= CAST(CAST(BASTARIH		+ ' ' +BASSAAT		+':00' AS datetime2) AS smalldatetime)
						,BITTARIH		= CAST(CAST(BITTARIH		+ ' ' +BITSAAT		+':00' AS datetime2) AS smalldatetime)
						,ACIKLANMATARIH = CAST(CAST(ACIKLANMATARIH	+ ' ' +ACIKLANMASAAT+':00' AS datetime2) AS smalldatetime)
						,SURE
						,CEVAPGOR
						,OTURUM
				INTO #TEMP9
				FROM OPENJSON(@SQLJSON)
				WITH(
					ID_SINAV		INT,
					CEVAPGOR		BIT,
					ACIKLANMATARIH	VARCHAR(MAX),
					ACIKLANMASAAT	VARCHAR(MAX),
					OSDO			NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.OSDO)
				WITH(
					OTURUM		INT,
					BASTARIH	VARCHAR(MAX),
					BASSAAT		VARCHAR(MAX),
					BITTARIH	VARCHAR(MAX),
					BITSAAT		VARCHAR(MAX),
					SURE		INT		
				)

				DECLARE @INSTABLE9 TABLE (ID INT)

				DECLARE @ACIKLANMATARIH smalldatetime = (
					SELECT IIF(MAX(ACIKLANMATARIH) > MAX(BITTARIH), MAX(ACIKLANMATARIH), MAX(BITTARIH) )
					FROM #TEMP9
				)
				
				INSERT INTO Tbl_OnlineSinavDetay (ID_SINAV, ACIKLANMATARIH, CEVAPGOR, KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_ONLINESINAVDETAY  INTO @INSTABLE9 (ID)
				SELECT TOP 1 ID_SINAV, @ACIKLANMATARIH, CEVAPGOR, @TCKIMLIKNO FROM #TEMP9
				
				DECLARE @ID_ONLINESINAVDETAY INT = (SELECT TOP 1 ID FROM @INSTABLE9)
				
				INSERT INTO Tbl_OnlineSinavDetayOturum (ID_ONLINESINAVDETAY, OTURUM, BASTARIH, BITTARIH, SURE)
				SELECT @ID_ONLINESINAVDETAY, OTURUM, BASTARIH, BITTARIH, SURE FROM #TEMP9

				DROP TABLE IF EXISTS #TEMP9

			END

			IF @ISLEM = 10	--	OGRENCI ATAMA							
			BEGIN

				IF EXISTS (SELECT TOP 1 1 FROM OPENJSON(@TC_OGRENCILIST))
				BEGIN
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV, VALUE AS TCKIMLIKNO, @TCKIMLIKNO FROM OPENJSON(@TC_OGRENCILIST) J
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND OS.TCKIMLIKNO = J.VALUE)
				END
				ELSE
				BEGIN
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV, SO.TCKIMLIKNO, @TCKIMLIKNO
					FROM OPENJSON(@ID_SINIFLIST)		S
					JOIN OkyanusDB.dbo.vw_SinifOgrenci	SO  WITH(NOLOCK)	ON	SO.ID_SINIF	= S.VALUE
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND OS.TCKIMLIKNO = SO.TCKIMLIKNO)
				END

			END

			IF @ISLEM = 11	--	OGRENCI ATAMA LİSTE						
			BEGIN

			IF(@DIS_OGRENCI=1)
			BEGIN
					SELECT ISNULL((
					SELECT DISTINCT 
						 K.TCKIMLIKNO
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,TARIH			= CONVERT(VARCHAR, OSO.KYE_TARIH, 104 )
						,OGRENCISAYISI	= COUNT(1)
						,OGRENCILIST	= ISNULL((
							SELECT DISTINCT 
								 DO.TCKIMLIKNO
								,ADSOYAD	= DO.AD + ' ' + DO.SOYAD
								,'' AS SUBEAD
								,'' AS SINIFAD
							FROM Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)
							JOIN DisOgrenci	DO	WITH(NOLOCK)	ON	DO.TCKIMLIKNO	= SO.TCKIMLIKNO
							WHERE	SO.KYE_TCKIMLIKNO	= K.TCKIMLIKNO
								AND SO.KYE_TARIH		= OSO.KYE_TARIH
								AND	SO.AKTIF			= 1
 								AND DO.DONEM			= (SELECT OkyanusDB.dbo.fn_AktifDonem())
							FOR JSON PATH
						),'[]')
						,OSO.KYE_TARIH
					FROM Tbl_OnlineSinavOgrenci	OSO	WITH(NOLOCK)	
					JOIN v3Kullanici			K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= OSO.KYE_TCKIMLIKNO
					WHERE	OSO.ID_SINAV	= @ID_SINAV
						AND OSO.AKTIF		= 1
						AND K.AKTIF			= 1
					GROUP BY OSO.KYE_TARIH, K.TCKIMLIKNO, K.AD, K.SOYAD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END

			ELSE
			BEGIN
				SELECT ISNULL((
					SELECT DISTINCT 
						 K.TCKIMLIKNO
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,TARIH			= CONVERT(VARCHAR, OSO.KYE_TARIH, 104 )
						,OGRENCISAYISI	= COUNT(1)
						,OGRENCILIST	= ISNULL((
							SELECT DISTINCT 
								 SK.TCKIMLIKNO
								,ADSOYAD	= SK.AD + ' ' + SK.SOYAD
								,SK.SUBEAD
								,SK.SINIFAD
							FROM Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)
							JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	SK	WITH(NOLOCK)	ON	SK.TCKIMLIKNO	= SO.TCKIMLIKNO
							WHERE	SO.KYE_TCKIMLIKNO	= K.TCKIMLIKNO
								AND SO.KYE_TARIH		= OSO.KYE_TARIH
								AND	SO.AKTIF			= 1
								AND SK.ID_SINIF			> 0
								AND SK.DONEM			= (SELECT OkyanusDB.dbo.fn_AktifDonem())
							FOR JSON PATH
						),'[]')
						,OSO.KYE_TARIH
					FROM Tbl_OnlineSinavOgrenci	OSO	WITH(NOLOCK)	
					JOIN v3Kullanici			K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= OSO.KYE_TCKIMLIKNO
					WHERE	OSO.ID_SINAV	= @ID_SINAV
						AND OSO.AKTIF		= 1
						AND K.AKTIF			= 1
					GROUP BY OSO.KYE_TARIH, K.TCKIMLIKNO, K.AD, K.SOYAD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END

			

			END

			IF @ISLEM = 12	--	ÖĞRENCİ YENİ ONLINE SINAV LİSTESİ		
			BEGIN
			
				CREATE TABLE #TEMP12SINAV (ID_SINAV INT)

				SET @QUERY = (	SELECT DEGER 
								FROM Parametre		P 	WITH(NOLOCK)	
								JOIN ParametreDeger PD	WITH(NOLOCK)	ON	PD.ID_PARAMETREDEGER = P.ID_PARAMETREDEGER 
								WHERE P.ID_PARAMETRE = 1) -- Öğrenci Online Sınav Listesi

				INSERT INTO #TEMP12SINAV
				EXEC (@QUERY)
				
				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,SINAVTURU	= ST.AD
						,SINAVAD	= S.AD
						,OTURUM		= IIF((GETDATE() > SD.ACIKLANMATARIH AND S.DURUM = 2),  0, SDO.OTURUM)--SDO.OTURUM
						,ACIKLANDI	= CAST(IIF( (GETDATE() > SD.ACIKLANMATARIH AND S.DURUM = 2), 1 , 0) AS bit )
						,DEVAM		= CAST(CASE WHEN	GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH 
													AND GETDATE() < DATEADD(MINUTE, SDO.SURE, ISNULL(SOO.BASTARIH,GETDATE())) THEN 1 
												ELSE 0 
											END 
										AS BIT)
						,COZULDU	= CAST( IIF(C.ID_ONLINESINAVOGRENCI IS NULL, 0 , 1) AS bit)
						,PERFORMANS	= CASE 
										WHEN GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH	THEN '--' 
										WHEN GETDATE() < SDO.BASTARIH							THEN 'Sınav Henüz Başlamadı' 
										WHEN GETDATE() > SD.ACIKLANMATARIH  AND S.DURUM != 2	THEN 'Açıklanması Bekleniyor' 
										ELSE CAST((	SELECT CAST(CAST(sum(SOT.TN) AS decimal(8,2)) / CAST(sum(SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
													FROM SinavOgrenciToplam SOT	WITH(NOLOCK)
													WHERE	SOT.TCKIMLIKNO	= SO.TCKIMLIKNO
														AND	SOT.ID_SINAV	= S.ID_SINAV
											 	) AS VARCHAR)
									END
						,Convert(varchar,SDO.BITTARIH , 120) AS BITTARIH					
						,Convert(varchar,SDO.BASTARIH , 120) AS BASTARIH
						,SDO.SURE
						,CONVERT(VARCHAR,S.SINAVTARIH , 104) AS SINAVTARIH
					FROM Sinav								S	WITH(NOLOCK)	
					JOIN #TEMP12SINAV						TS					ON	TS.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetay				SD	WITH(NOLOCK)	ON	SD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			SDO	WITH(NOLOCK)	ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
																				AND SDO.OTURUM				= IIF((GETDATE() > SD.ACIKLANMATARIH   AND S.DURUM = 2),  1, SDO.OTURUM)
					JOIN SinavTuru							ST	WITH(NOLOCK)	ON	ST.ID_SINAVTURU			= S.ID_SINAVTURU
					JOIN Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)	ON	SO.ID_SINAV				= SD.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	SOO	WITH(NOLOCK)	ON	SOO.TCKIMLIKNO			= SO.TCKIMLIKNO
																				AND SOO.ID_SINAV			= S.ID_SINAV
																				AND SOO.OTURUM				= SDO.OTURUM

					LEFT JOIN Tbl_OnlineSinavOgrenciCevap	C	WITH(NOLOCK)	ON	C.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
																				AND C.AKTIF					= 1
																				AND EXISTS (SELECT TOP 1 1 
																							FROM SinavAnahtar	GSA
																							JOIN SinavDers		GSD ON GSD.ID_SINAVDERS = GSA.ID_SINAVDERS
																							JOIN SinavOptikDers GSO ON GSO.ID_SINAVDERS = GSD.ID_SINAVDERS
																							WHERE	GSO.OTURUM		= SDO.OTURUM
																								AND GSD.ID_SINAV	= SO.ID_SINAV
																								AND C.ID_SINAVANAHTAR = GSA.ID_SINAVANAHTAR
																				)
					WHERE	SO.TCKIMLIKNO	= @TCKIMLIKNO
						AND SD.AKTIF		= 1
						AND SO.AKTIF		= 1
						AND S.ONLINESINAV	= 1
					ORDER BY Convert(varchar,SDO.BITTARIH , 120)  DESC
					FOR JSON PATH
				),'[]')
				DROP TABLE IF EXISTS #TEMP12SINAV

			END

			IF @ISLEM = 13	--	ÖĞRENCİ YENİ ONLINE SINAV DETAY			
			BEGIN

				IF @SINAVOTURUM IS NULL 
					SET @SINAVOTURUM = 0

				UPDATE OO SET
					BASTARIH = GETDATE()
				FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
					AND O.AKTIF			= 1
					AND OO.ID_SINAV		= @ID_SINAV
					AND OO.OTURUM		= @SINAVOTURUM
					AND OO.BASTARIH		IS NULL

				IF	@SINAVOTURUM > 0
					AND NOT EXISTS (SELECT TOP 1 1 
									FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
									JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO	= O.TCKIMLIKNO
									WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
										AND O.AKTIF			= 1
										AND OO.ID_SINAV		= @ID_SINAV
										AND OO.OTURUM		= @SINAVOTURUM
									)
					AND EXISTS (SELECT TOP 1 1
								FROM Tbl_OnlineSinavDetay		D	WITH(NOLOCK)	
								JOIN Tbl_OnlineSinavDetayOturum	DO	WITH(NOLOCK)	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
								WHERE	D.ID_SINAV	= @ID_SINAV
									AND D.AKTIF		= 1
									AND DO.OTURUM	= @SINAVOTURUM
									AND GETDATE() BETWEEN DO.BASTARIH AND DO.BITTARIH
								)
				BEGIN
					INSERT INTO  Tbl_OnlineSinavOgrenciOturum (TCKIMLIKNO, ID_SINAV, OTURUM )
					VALUES (@TCKIMLIKNO, @ID_SINAV, @SINAVOTURUM)
				END
							
																

				DECLARE @BASLAMA_TARIHI DATETIME;
				DECLARE @BITIS_TARIHI DATETIME;
				DECLARE @GIRIS_TARIHI DATETIME;

				DECLARE @SINAV_SONLANMA_SAATI DATETIME;
				DECLARE @SURE INT = 0;
				DECLARE @SINAV_BITISE_KALAN INT =0;
				DECLARE @KALAN VARCHAR(MAX) =NULL;
				SELECT @BASLAMA_TARIHI = OSDO.BASTARIH,@BITIS_TARIHI=OSDO.BITTARIH,@GIRIS_TARIHI=OSOO.BASTARIH,@SURE=OSDO.SURE
				FROM Sinav								S		WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
				JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
																				AND (	OSDO.OTURUM				= @SINAVOTURUM
																					OR	0						= @SINAVOTURUM)
				JOIN Tbl_OnlineSinavOgrenci				OSO		WITH(NOLOCK)	ON	OSO.ID_SINAV				= S.ID_SINAV
				LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OSOO	WITH(NOLOCK)	ON	OSOO.TCKIMLIKNO				= OSO.TCKIMLIKNO
																				AND OSOO.ID_SINAV				= S.ID_SINAV
																				AND OSOO.OTURUM					= OSDO.OTURUM
				WHERE	S.ID_SINAV		= @ID_SINAV
					AND OSO.TCKIMLIKNO	= @TCKIMLIKNO
					AND OSD.AKTIF		= 1
					AND OSO.AKTIF		= 1
					AND S.AKTIF			= 1
					AND S.OZEL			= 0
						
				SET @SINAV_SONLANMA_SAATI	= DATEADD(MINUTE,@SURE,@GIRIS_TARIHI)
				SET @SINAV_BITISE_KALAN		= DATEDIFF(MINUTE,GETDATE(),@BITIS_TARIHI)
				
				IF @SINAV_SONLANMA_SAATI < @BITIS_TARIHI
					SET @SINAV_BITISE_KALAN = DATEDIFF(MINUTE,GETDATE(),@SINAV_SONLANMA_SAATI)

				IF  @SINAV_BITISE_KALAN >= @SURE  
				BEGIN
					SET @SINAV_SONLANMA_SAATI	= DATEADD(MINUTE,@SURE ,@GIRIS_TARIHI)
					SET @SINAV_BITISE_KALAN		= DATEDIFF(MINUTE,GETDATE(),@SINAV_SONLANMA_SAATI)
				END
				SET @KALAN	= CAST(CAST( @SINAV_BITISE_KALAN AS VARCHAR ) 
							+ ':' 
							+ IIF(@SINAV_BITISE_KALAN > -1
									,CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, @SINAV_BITISE_KALAN, @BITIS_TARIHI)) % 60) AS varchar)
									,'00')
								AS varchar)

				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,DEVAM			= CAST(CASE WHEN GETDATE() BETWEEN OSDO.BASTARIH AND OSDO.BITTARIH AND GETDATE() < DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH) THEN 1 ELSE 0 END AS bit )
						,ACIKLANDI		= CAST(CASE WHEN GETDATE() > OSD.ACIKLANMATARIH AND S.DURUM = 2 THEN 1 ELSE 0 END AS bit )
					--KALANSURE		= CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH)) / 60) AS varchar) + ':' + CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH)) % 60) AS varchar)
						,KALANSURE      = @KALAN	
						,ID_SINAVDERS	= SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,TAKMAAD		= SD.TAKMAAD
						,SORUNO			= SA.SORUNO
						,ID_SINAVANAHTAR= SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END
						,OGRENCICEVAP	= ISNULL(OSOC.ID_CEVAP, NULL)
						,COZUMLIST		= JSON_QUERY(
											IIF(GETDATE() < OSD.ACIKLANMATARIH, 
												NULL,
												(SELECT	 SC.ID_COZUM
														,COZUMHTML	= CASE WHEN SC.COZUMHTML  IS NULL THEN '' ELSE 'SoruBankasi/'+ SC.COZUMHTML  END
												FROM SoruBankasi.dbo.SoruCozum SC WITH(NOLOCK)	
												WHERE SC.ID_SORU = SBSH.ID_SORU
												ORDER BY SC.SIRA
												FOR JSON PATH)
											))
						,CEVAPNO		= SBC.CEVAPNO
						,ID_CEVAP		= SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
						,OGRENCICEVAP	= CAST(IIF( OSOC.ID_CEVAP = SBC.ID_CEVAP , 1, 0) AS bit)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
																					AND (	OSDO.OTURUM				= @SINAVOTURUM
																						OR	0						= @SINAVOTURUM)
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
					JOIN Tbl_OnlineSinavOgrenci				OSO		WITH(NOLOCK)	ON	OSO.ID_SINAV				= S.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OSOO	WITH(NOLOCK)	ON	OSOO.TCKIMLIKNO				= OSO.TCKIMLIKNO
																					AND OSOO.ID_SINAV				= S.ID_SINAV
																					AND OSOO.OTURUM					= OSDO.OTURUM
					LEFT JOIN Tbl_OnlineSinavOgrenciCevap	OSOC	WITH(NOLOCK)	ON	OSOC.ID_ONLINESINAVOGRENCI	= OSO.ID_ONLINESINAVOGRENCI
																					AND OSOC.ID_SINAVANAHTAR		= SA.ID_SINAVANAHTAR
																					AND OSOC.AKTIF					= 1
					WHERE	S.ID_SINAV		= @ID_SINAV
						AND OSO.TCKIMLIKNO	= @TCKIMLIKNO
						AND OSD.AKTIF		= 1
						AND OSO.AKTIF		= 1
						AND SK.AD			= 'A'
						AND S.AKTIF			= 1
						AND S.OZEL			= 0
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 14	--	ÖĞRENCİ YENİ ONLINE SINAV SORU İŞARETLE	
			BEGIN

				IF NOT EXISTS(SELECT TOP 1 1 FROM SinavAnahtar WHERE ID_SINAVANAHTAR = @ID_SINAVANAHTAR)
				BEGIN
					RAISERROR('Sınav güncellendiği için cevabınızı kaydedemiyoruz. Lüten sınavı yeniden açınız !!!',16,1)
					RETURN
				END
				ELSE
				BEGIN

					SET @ID_ONLINESINAVOGRENCI = ISNULL((
						SELECT TOP 1 ID_ONLINESINAVOGRENCI
						FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
						JOIN Tbl_OnlineSinavDetay			D	WITH(NOLOCK)	ON	D.ID_SINAV				= O.ID_SINAV
						JOIN Tbl_OnlineSinavDetayOturum		DO	WITH(NOLOCK)	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
						JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO			= O.TCKIMLIKNO
																				AND OO.ID_SINAV				= O.ID_SINAV
																				AND OO.OTURUM				= DO.OTURUM
						WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
							AND O.ID_SINAV		= @ID_SINAV
							AND DO.OTURUM		= @SINAVOTURUM
							AND O.AKTIF			= 1
							AND D.AKTIF			= 1
							AND GETDATE() BETWEEN DO.BASTARIH AND DO.BITTARIH
							AND GETDATE() < DATEADD(MINUTE, DO.SURE, OO.BASTARIH)
					),0)

					IF @ID_ONLINESINAVOGRENCI > 0
					BEGIN

						UPDATE Tbl_OnlineSinavOgrenciCevap SET
							AKTIF = 0
						WHERE	ID_ONLINESINAVOGRENCI	= @ID_ONLINESINAVOGRENCI
							AND	ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
							AND AKTIF					= 1

						IF @ID_CEVAP IS NOT NULL
							INSERT INTO Tbl_OnlineSinavOgrenciCevap (ID_ONLINESINAVOGRENCI, ID_SINAVANAHTAR, ID_CEVAP)  
							VALUES (@ID_ONLINESINAVOGRENCI, @ID_SINAVANAHTAR, @ID_CEVAP)

					END

					SELECT ISNULL(@ID_ONLINESINAVOGRENCI,0)

				END

			END

			IF @ISLEM = 15	--	ÖĞRENCİ YENİ ONLINE SINAV PERFORMANS	
			BEGIN
			
				DECLARE @TABLE TABLE(RESULT VARCHAR(MAX))

				INSERT INTO @TABLE
				EXEC sp_OnlineSinav @TCKIMLIKNO = @TCKIMLIKNO, @OTURUM = @OTURUM, @ID_SINAV = @ID_SINAV, @ISLEM = 13
								
				SELECT (
					SELECT ISNULL((
						SELECT DISTINCT
							 SINAVTURU		= ST.AD
							,SINAVAD		= S.AD
							,SONGIRIS		= (	SELECT TOP 1 CONVERT(varchar, OSOC.KYE_TARIH, 104) + ' ' + CONVERT(varchar, OSOC.KYE_TARIH, 108)
												FROM Tbl_OnlineSinavOgrenci			OSO  WITH(NOLOCK) 
												JOIN Tbl_OnlineSinavOgrenciCevap	OSOC WITH(NOLOCK) ON	OSOC.ID_ONLINESINAVOGRENCI = OSO.ID_ONLINESINAVOGRENCI
												WHERE	OSO.AKTIF	= 1
													AND OSOC.AKTIF	= 1
												ORDER BY OSOC.ID_ONLINESINAVOGRENCICEVAP DESC
												)
							,DOGRU			= SOT.TD
							,YANLIS			= SOT.TY
							,BOS			= SOT.TB
							,NET			= SOT.TN
							,NETPERFORMANS	= CAST(CAST(SOT.TN AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,DOGRUPERFORMANS	= CAST(CAST(SOT.TD AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,YANLISPERFORMANS	= CAST(CAST(SOT.TY AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,BOSPERFORMANS	= CAST(CAST(SOT.TB AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							,DERSPERFORMANS	= JSON_QUERY(
													ISNULL((	SELECT	 SD.BOLUMNO
																	,SD.TAKMAAD
																	,YUZDENET
															FROM SinavDers				SD	 WITH(NOLOCK) 
															JOIN vw_SinavOgrenciBolum	SOB	 WITH(NOLOCK)	ON	SOB.ID_SINAVDERS	= SD.ID_SINAVDERS
																											AND SOB.TCKIMLIKNO		= SOT.TCKIMLIKNO
															WHERE SD.ID_SINAV = S.ID_SINAV
															ORDER BY BOLUMNO
															FOR JSON PATH
													),'[]')
												)
						FROM Tbl_OnlineSinavDetay		OSD	 WITH(NOLOCK) 
						JOIN Tbl_OnlineSinavDetayOturum	DO	 WITH(NOLOCK) ON	DO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
						JOIN SinavOgrenciToplam			SOT	 WITH(NOLOCK) ON	SOT.ID_SINAV	= OSD.ID_SINAV
						JOIN Sinav						S	 WITH(NOLOCK) ON	S.ID_SINAV		= SOT.ID_SINAV
						JOIN SinavTuru					ST	 WITH(NOLOCK) ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
						WHERE	SOT.ID_SINAV		= @ID_SINAV
							AND SOT.TCKIMLIKNO		= @TCKIMLIKNO
							AND OSD.AKTIF			= 1
							AND S.AKTIF				= 1
							AND S.OZEL				= 0
							AND DO.BITTARIH			< GETDATE()
							AND OSD.ACIKLANMATARIH	< GETDATE()
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]') AS PERFORMANS,
					JSON_QUERY((	
						SELECT RESULT 
						FROM @TABLE
					))  AS SINAV
					FOR JSON PATH
				)

			END

			IF @ISLEM = 16	--	ÖĞRENCİ ATAMA KALDIRMA					
			BEGIN

				UPDATE O SET
					AKTIF = 0
				FROM Tbl_OnlineSinavOgrenci	O  WITH(NOLOCK) 
				WHERE	ID_SINAV		= @ID_SINAV
					AND	KYE_TCKIMLIKNO	= @TC_EKLEYEN
					AND KYE_TARIH		= @KYE_TARIH
					AND NOT EXISTS (SELECT TOP 1 1 
									FROM Tbl_OnlineSinavOgrenciCevap C  WITH(NOLOCK) 
									WHERE	C.ID_ONLINESINAVOGRENCI = O.ID_ONLINESINAVOGRENCI 
										AND C.AKTIF					= 1)

				SELECT COUNT(DISTINCT TCKIMLIKNO)
				FROM Tbl_OnlineSinavOgrenci			O  WITH(NOLOCK) 
				JOIN Tbl_OnlineSinavOgrenciCevap	C  WITH(NOLOCK) ON	C.ID_ONLINESINAVOGRENCI = O.ID_ONLINESINAVOGRENCI					
				WHERE	O.ID_SINAV		= @ID_SINAV
					AND	O.KYE_TCKIMLIKNO= @TC_EKLEYEN
					AND O.KYE_TARIH		= @KYE_TARIH
					AND O.AKTIF			= 1
					AND C.AKTIF			= 1

			END

			IF @ISLEM = 17	--	SINAV DETAY RAPOR						
			BEGIN
			
				DECLARE @OGRENCI17 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY  WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
					IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
					BEGIN
						SET @OGRENCI17=1
					END												

				IF @OGRENCI17 = 1
					SET @CEVAPANAHTARI = 1
				ELSE IF NOT EXISTS(	SELECT TOP 1 1 
									FROM v3SubeYetki	SY  WITH(NOLOCK) 
									WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
										AND SY.ID_KULLANICITIPI = 1				--	ADMİN
									)
				BEGIN
					RETURN
					SET @CEVAPANAHTARI = 0
				END

				DROP TABLE IF EXISTS #TEMP17

				SELECT DISTINCT
					 S.ID_SINAV
					,SINAVAD		= S.AD						
					,SD.ID_SINAVDERS
					,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
					,TAKMAAD		= UPPER(SD.TAKMAAD)
					,SA.SORUNO
					,SA.ID_SINAVANAHTAR
					,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
					,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
					,SBC.CEVAPNO
					,CEVAPAD		= CASE	WHEN SBC.CEVAPNO = 1 THEN 'A'
											WHEN SBC.CEVAPNO = 2 THEN 'B'
											WHEN SBC.CEVAPNO = 3 THEN 'C'
											WHEN SBC.CEVAPNO = 4 THEN 'D'
											WHEN SBC.CEVAPNO = 5 THEN 'E'
											ELSE ''
										END
					,SBC.ID_CEVAP
					,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
					,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH 
											or EXISTS(	SELECT TOP 1 1 
														FROM v3SubeYetki	SY  WITH(NOLOCK) 
														WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
															AND SY.ID_KULLANICITIPI = 1				--	ADMİN
											), SBC.DEGER, NULL) AS BIT)
				INTO #TEMP17
				FROM Sinav								S		WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
				JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
				JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																				AND SK.AD						= 'A'
				JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
				JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																				AND SOD.OTURUM					= OSDO.OTURUM
				JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																				AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
				JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
				JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
				JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																				AND SBDC.DEGER					= '1'
				WHERE	S.ID_SINAV			= @ID_SINAV
					AND OSD.AKTIF			= 1
					AND SK.AD				= 'A'
					AND S.AKTIF				= 1
					AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
					AND (@OGRENCI17					= 0
						OR	(	@OGRENCI17			= 1
							AND S.DURUM				= 2
							AND OSD.ACIKLANMATARIH	< GETDATE()						
						))
				ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO


				SELECT DISTINCT
					 ID_SINAV
					,SINAVAD
				FROM #TEMP17
					
				SELECT DISTINCT
					 ID_SINAVDERS
					,BOLUMNO
					,TAKMAAD
					,SORUNO
					,ID_SINAVANAHTAR
					,SORUHTML
					,CEVAPNO
					,CEVAPAD
					,CEVAPHTML
				FROM #TEMP17
					
				SELECT DISTINCT
					 ID_SINAVDERS
					,BOLUMNO
					,TAKMAAD
					,SORUNO
					,CEVAP	= CASE	WHEN CEVAPNO = 1 THEN 'A'
									WHEN CEVAPNO = 2 THEN 'B'
									WHEN CEVAPNO = 3 THEN 'C'
									WHEN CEVAPNO = 4 THEN 'D'
									WHEN CEVAPNO = 5 THEN 'E'
									ELSE ''
								END
				FROM #TEMP17
				WHERE	DEGER			= 1
					AND @CEVAPANAHTARI	= 1

				DROP TABLE IF EXISTS #TEMP17


			END

			IF @ISLEM = 18	--	ONLINE SINAV ONIZLEME					
			BEGIN

				DECLARE @OGRENCI18 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY  WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
				IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
					BEGIN
						SET @OGRENCI18=1
					END					

				
				IF @OGRENCI18 = 0 AND NOT EXISTS(	SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 1				--	ADMİN
													)
				BEGIN
					SELECT '[]'
				END
				


				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,S.AD						
						,SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,SD.TAKMAAD
						,SA.SORUNO
						,SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
						,SBC.CEVAPNO
						,SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
					WHERE	S.ID_SINAV					= @ID_SINAV
						AND OSD.AKTIF					= 1
						AND SK.AD						= 'A'
						AND S.AKTIF						= 1
						AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
						AND (@OGRENCI18					= 0
							OR	(	@OGRENCI18			= 1
								AND S.DURUM				= 2
								AND OSD.ACIKLANMATARIH	< GETDATE()						
							))
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				

			END

			IF @ISLEM = 19	--	ONLINE SINAV ÖĞR OTURUM	SIFIRLAMA LİSTE	
			BEGIN

				SELECT ISNULL((
					SELECT	 TCKIMLIKNO	= OD.TCKIMLIKNO
							,AD			= OD.AD
							,SOYAD		= OD.SOYAD
							,SUBEAD		= OD.SUBEAD
							,SINIFAD	= OD.SINIFAD
							,OTURUMLIST.ID_ONLINESINAVOGRENCIOTURUM
							,BASTARIH	= CONVERT(VARCHAR, OTURUMLIST.BASTARIH,104) + ' ' + CONVERT(VARCHAR, OTURUMLIST.BASTARIH,108)
							,OTURUM		= ISNULL(SDO.OTURUM,0)
					FROM Tbl_OnlineSinavDetay				SD			WITH(NOLOCK) 
					JOIN Tbl_OnlineSinavDetayOturum			SDO			WITH(NOLOCK) ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
					JOIN Tbl_OnlineSinavOgrenci				SO			WITH(NOLOCK) ON	SO.ID_SINAV				= SD.ID_SINAV
					JOIN OkyanusDB..v3Ogrenci				O			WITH(NOLOCK) ON	O.TCKIMLIKNO			= SO.TCKIMLIKNO
					JOIN OkyanusDB..vw_OgrenciDetayTum		OD			WITH(NOLOCK) ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
																					 AND OD.ID_SINIF			= O.ID_SINIF
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OTURUMLIST	WITH(NOLOCK) ON	OTURUMLIST.TCKIMLIKNO	= SO.TCKIMLIKNO
																					 AND OTURUMLIST.ID_SINAV	= SO.ID_SINAV
																					 AND OTURUMLIST.OTURUM		= SDO.OTURUM
																					 AND GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH
					WHERE	SD.ID_SINAV	= @ID_SINAV
						AND	SO.AKTIF	= 1
						AND SD.AKTIF	= 1
					ORDER BY SUBEAD, SINIFAD, AD, SOYAD, TCKIMLIKNO, SDO.OTURUM
					FOR JSON AUTO, INCLUDE_NULL_VALUES, ROOT('OGRENCILIST')
				),'{OGRENCILIST:[]}')
				

			END

			IF @ISLEM = 20	--	ONLINE SINAV ÖĞR OTURUM	SIFIRLAMA 		
			BEGIN

				--UPDATE SOC SET
				--	SOC.AKTIF = 0
				DELETE SOC
				FROM Tbl_OnlineSinavOgrenciOturum	OO  WITH(NOLOCK) 
				JOIN Tbl_OnlineSinavOgrenci			SO  WITH(NOLOCK) 	ON	SO.ID_SINAV					= OO.ID_SINAV 
																		AND SO.TCKIMLIKNO				= OO.TCKIMLIKNO
				JOIN Tbl_OnlineSinavOgrenciCevap	SOC WITH(NOLOCK) 	ON	SOC.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
				JOIN vw_SinavDersOturum				SDO WITH(NOLOCK) 	ON	SDO.ID_SINAV				= SO.ID_SINAV
																		AND SDO.OTURUM					= OO.OTURUM
				JOIN SinavAnahtar					SA  WITH(NOLOCK) 	ON	SA.ID_SINAVDERS				= SDO.ID_SINAVDERS
																		AND SA.ID_SINAVANAHTAR			= SOC.ID_SINAVANAHTAR
				WHERE	ID_ONLINESINAVOGRENCIOTURUM	= @ID_ONLINESINAVOGRENCIOTURUM
					AND	SO.AKTIF					= 1
					AND	SOC.AKTIF					= 1

				DELETE FROM Tbl_OnlineSinavOgrenciOturum
				WHERE ID_ONLINESINAVOGRENCIOTURUM = @ID_ONLINESINAVOGRENCIOTURUM				

			END

			IF @ISLEM = 21	--	ONLINE SINAV ÇIKTI						
			BEGIN
					
				DECLARE @OGRENCI21 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
				IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
					BEGIN
						SET @OGRENCI21=1
					END					
				
				IF @OGRENCI21 = 0 AND NOT EXISTS(	SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 1				--	ADMİN
													)
				BEGIN
					SELECT '[]'
				END
				


				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,S.AD						
						,SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,SD.TAKMAAD
						,SA.SORUNO
						,SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
						,CEVAP			= CASE	WHEN SBDC.CEVAPNO = 1 THEN 'A'
												WHEN SBDC.CEVAPNO = 2 THEN 'B'
												WHEN SBDC.CEVAPNO = 3 THEN 'C'
												WHEN SBDC.CEVAPNO = 4 THEN 'D'
												WHEN SBDC.CEVAPNO = 5 THEN 'E'
												ELSE ''
										END
						,SBC.CEVAPNO
						,SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					LEFT JOIN SoruBankasi.dbo.Cevap			SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
																					AND (GETDATE()					> OSD.ACIKLANMATARIH
																						OR EXISTS(	SELECT TOP 1 1 
																									FROM v3SubeYetki	SY WITH(NOLOCK) 
																									WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
																										AND SY.ID_KULLANICITIPI = 1				--	ADMİN
																									)																						
																						)
																					AND @CEVAPANAHTARI				= 1

					WHERE	S.ID_SINAV					= @ID_SINAV
						AND OSD.AKTIF					= 1
						AND SK.AD						= 'A'
						AND S.AKTIF						= 1
						AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
						AND (@OGRENCI21					= 0
							OR(	@OGRENCI21				= 1
							AND	EXISTS (SELECT TOP 1 1
										FROM Tbl_OnlineSinavOgrenci	SO WITH(NOLOCK) 
										WHERE TCKIMLIKNO	= @TCKIMLIKNO
											AND SO.ID_SINAV	= S.ID_SINAV
											AND SO.AKTIF	= 1
							)
						))
						AND (@OGRENCI21					= 0
							OR	(	@OGRENCI21			= 1
								AND S.DURUM				= 2
								AND OSD.ACIKLANMATARIH	< GETDATE()						
							))
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				

			END

			IF @ISLEM = 22	--	ONLINE SINAV OTURUM OGRENCI LISTE		
			BEGIN
				SELECT ISNULL((
					SELECT SO.TCKIMLIKNO
						,K.AD
						,K.SOYAD
						,SOO.OTURUM
						,SUBE	= SB.AD
						,SINIF	= S.AD
						,TARIH	=  CONVERT(VARCHAR(MAX), SOO.BASTARIH, 104) + ' ' + CONVERT(VARCHAR(MAX), SOO.BASTARIH, 108)
					FROM Sinav							SNV WITH(NOLOCK)
					JOIN Tbl_OnlineSinavOgrenci			SO	WITH(NOLOCK)	ON	SO.ID_SINAV		= SNV.ID_SINAV 
																			AND SO.AKTIF		= 1
					JOIN Tbl_OnlineSinavOgrenciOturum	SOO WITH(NOLOCK)	ON	SOO.TCKIMLIKNO	= SO.TCKIMLIKNO 
																			AND SOO.ID_SINAV	= SO.ID_SINAV
					JOIN OkyanusDB.dbo.v3Kullanici		K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= SOO.TCKIMLIKNO
					JOIN OkyanusDB.dbo.v3OgrenciTum		O	WITH(NOLOCK)	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO 
																			AND O.DONEM			= SNV.DONEM
					JOIN OkyanusDB.dbo.v3Sube			SB	WITH(NOLOCK)	ON	SB.ID_SUBE		= O.ID_SUBE
					JOIN OkyanusDB.dbo.v3SinifTum		S	WITH(NOLOCK)	ON	S.ID_SINIF		= O.ID_SINIF 
																			AND S.DONEM			= SNV.DONEM
					WHERE	SNV.AKTIF = 1 
						AND SNV.ID_SINAV = @ID_SINAV
						AND (	(O.ID_SUBE	IN (select value from openjson (@ID_SUBELIST)))
							OR	(0			IN (select value from openjson (@ID_SUBELIST))) 
							OR	@ID_SUBELIST='[]'
							)
					ORDER BY SB.AD, S.AD, K.AD, K.SOYAD, SOO.OTURUM
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 23  -- ONLINE SINAV OTURUM SIFIRLAMA
			BEGIN			
				UPDATE Tbl_OnlineSinavOgrenciOturum SET
					BASTARIH = NULL
				WHERE ID_ONLINESINAVOGRENCIOTURUM = @ID_ONLINESINAVOGRENCIOTURUM
			END
		END

	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Login]...';


GO

ALTER procedure [dbo].[sp_Login]
	@TCKIMLIKNO			VARCHAR(11) = NULL,
	@OTURUM				VARCHAR(50) = NULL
AS

BEGIN


BEGIN TRY    
	    DECLARE @MSG			VARCHAR(4000)
	    DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		IF	(NOT EXISTS(SELECT TCKIMLIKNO FROM [dbo].[v3Kullanici] WHERE TCKIMLIKNO = @TCKIMLIKNO AND OTURUM = @OTURUM AND AKTIF = 1) 
			AND 
			NOT EXISTS (SELECT TOP 1 1 FROM OkyanusIletisim.dbo.LoginLog WHERE KYE_TCKIMLIKNO = @TCKIMLIKNO AND OTURUM = @OTURUM AND LOGOUT = 0))
			AND 
			NOT EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
			
		BEGIN		
			
			SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()

			SELECT @MSG = 'Hatalı Kullanıcı Adı ya da Şifre'

			RAISERROR (@MSG,		-- Message text.
					   16,			-- Severity.
					   @ErrorState	-- State.
					   );
			
		END
		ELSE
		BEGIN
			DECLARE @OV BIT=0
			IF EXISTS(SELECT TOP 1 1 FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_KULLANICITIPI IN (4))
			BEGIN
				SET @OV=1
			END

			--Login olan kullanıcı sadece veli yada sadece öğrenci olma durum kontrolü
			DECLARE @OVT BIT=0

			DROP TABLE IF EXISTS #TEMPID_KULLANICITIPI
			SELECT DISTINCT ID_KULLANICITIPI INTO #TEMPID_KULLANICITIPI FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO


			IF NOT EXISTS (SELECT TOP 1 1 FROM #TEMPID_KULLANICITIPI WHERE ID_KULLANICITIPI NOT IN (4,5))
			BEGIN
				SET @OVT=1
			END
			DROP TABLE IF EXISTS #TEMPID_KULLANICITIPI
			
			INSERT INTO OkyanusIletisim.dbo.LoginLog(KYE_TCKIMLIKNO, OTURUM, ID_UYGULAMA, DEVICE_ID, FCM_TOKEN)VALUES(@TCKIMLIKNO, @OTURUM, 4, 'Pusulam', '')

			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
				BEGIN
					SELECT 
						AD,
						SOYAD,
						TCKIMLIKNO,
						0 AS CINSIYET,
						GETDATE() AS DOGUMTARIHI,
						@OTURUM AS OTURUM,
						0 KADEME,
						1 AS OV,
						0 AS OVT,
						1 AS DISOGRENCI
					FROM DisOgrenci
					WHERE TCKIMLIKNO=@TCKIMLIKNO
				END
		ELSE		
		BEGIN
			-- Login Bilgileri
			SELECT
				K.AD, 
				K.SOYAD, 
				K.TCKIMLIKNO,
				K.CINSIYET,
				K.DOGUMTARIHI,
				K.OTURUM,
				--kk.ID_KADEME as KADEME,
				0 KADEME,
				@OV AS OV,
				@OVT AS OVT,
				0 AS DISOGRENCI
			FROM		[dbo].v3Kullanici				K
			--INNER JOIN	OkyanusDB.dbo.v4KullaniciKademe	kk	on	kk.TCKIMLIKNO = k.TCKIMLIKNO	
			WHERE K.TCKIMLIKNO = @TCKIMLIKNO AND K.AKTIF = 1
			END			
		END
		
END TRY
		BEGIN CATCH
			
			SELECT 
				@ErrorSeverity	= ERROR_SEVERITY(),
				@ErrorState		= ERROR_STATE()
							
			SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
			RAISERROR (@MSG , -- Message text.
					   @ErrorSeverity, -- Severity.
					   @ErrorState -- State.
					   );
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Sinav]...';


GO
ALTER procedure [dbo].[sp_Sinav]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@SINAVSORUISLEM		BIT				= 0,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAVTURUS		VARCHAR(MAX)	= NULL,
	@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@TAKMAAD			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SUBES			NVARCHAR(MAX)	= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SINAVOTURUM		tinyint			= NULL,
	@UNITEKOD			VARCHAR(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@TCLIST				VARCHAR(MAX)	= NULL,
	@ID_SINAVDERSLIST	VARCHAR(MAX)	= NULL,
	@DURUM				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@DURUMDEGER			BIT				= NULL,
	@ESKIDONEMSINIF		BIT				= 0,
	@ID_TYTSECIMTUR		INT				= NULL,
	@BARAJ				VARCHAR(MAX)	= NULL,
	@ID_SORUBANKASI		int				= NULL,
	@KOD				VARCHAR(MAX)	= NULL,
	@MAIL				BIT				= 0

AS
BEGIN
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
		IF @return_variable = 1
		BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 29.09.2020
	
	--	sp UPDATE
	--	ISLEM 48 ADD 

*/
			--IF (SELECT COUNT(*) FROM SinavDegerlendir WHERE AKTIF = 1 AND ID_SINAV = @ID_SINAV) > 0
			--BEGIN
			--	RAISERROR ('Sınav değerlendirme işlemi yapılıyor daha sonra tekrar deneyiniz.' , -- Message text.
			--		16, -- Severity.
			--		1 -- State.
			--		);
			--END
			--ELSE
			--BEGIN

			DECLARE @ONLINESINAV BIT = NULL			
			DECLARE @cols2		NVARCHAR(MAX)
			DECLARE @query		NVARCHAR(MAX)

			BEGIN
				SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
				DECLARE @AKTIFDONEM VARCHAR(4)=(	SELECT  DONEM FROM v3AktifDonem WHERE AKTIF=1)

				DECLARE  @OZELSINAVGOR BIT=0
				IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) )
				BEGIN
					SET @OZELSINAVGOR=1
				END
			
				DECLARE @ID_KADEME3ESKI INT  = @ID_KADEME3

					IF @DONEM IS NULL OR @DONEM=''
					BEGIN
						SELECT @DONEM= DONEM FROM v3AktifDonem WHERE AKTIF=1
					END

					IF NOT EXISTS ( SELECT * FROM v3AktifDonem WHERE DONEM = @OGRENCIDONEM)
					BEGIN
						SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
					END 

					DECLARE @DONEMFARKI INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
					IF  (@DONEMFARKI<>0) AND (SELECT @ESKIDONEMSINIF ) = 0
					BEGIN
						DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
						SELECT @ID_KADEME3ESKI=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
					END
			END

				IF @ISLEM = 0	--	Dönem Listele
				BEGIN
					SELECT * FROM [dbo].[v3AktifDonem] order by DONEM desc
				END
				IF @ISLEM = 1	--	Sınav Türü Listele
				BEGIN
					IF 4 IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)	--	ÖĞRENCİ İSE YALNIZCA GİRDİĞİ SINAV TÜRLERİ
					BEGIN	
						SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD FROM SinavOgrenci SO
						INNER JOIN Sinav S ON S.ID_SINAV=SO.ID_SINAV
						INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
						WHERE SO.TCKIMLIKNO = @TCKIMLIKNO
					END
					ELSE
					BEGIN
						SELECT ID_SINAVTURU, AD, KISAAD FROM SinavTuru where AKTIF=1
					END
				END
				IF @ISLEM = 2	--	Sınav Grup Listele
				BEGIN
					select distinct st.ID_KADEME3, k.AD
					from		  [dbo].[vw_SubeGrupSinif]	sgs
					Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
					Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
					Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
					Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
					Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
					where	(@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson( @ID_SUBES)))  AND
							(@ID_SUBE IS NULL OR @ID_SUBE=0 OR @ID_SUBE=sgs.ID_SUBE) AND
							((@KADEME IS NULL AND st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) OR (@KADEME IS NOT NULL AND st.ID_KADEME=@KADEME))
					--ORDER BY k.SIRA

				END
				IF @ISLEM = 3	--	Sınav Ders Listele
				BEGIN
					SELECT (
						SELECT 
						KADEME		AS 'id',
						KADEME		AS 'text', 
						(
							SELECT 
							ID_DERS AS 'id', 
							AD		AS 'text'
							FROM [dbo].[v3SinavDers] sd 
							WHERE sd.ID_KADEME3=xTable.ID_KADEME3 
							ORDER BY sd.AD
							FOR JSON PATH
						) AS 'children'
						from
						(
							SELECT k3.AD AS 'KADEME', k3.ID_KADEME3 AS 'ID_KADEME3'
							FROM		[dbo].[v3SinavDers]		sd
							INNER JOIN	[dbo].[v3Kademe3]		k3	ON	k3.ID_KADEME3 = sd.ID_KADEME3
							GROUP BY k3.AD, k3.ID_KADEME3
						) AS xTable
						ORDER BY ID_KADEME3
						FOR JSON PATH
					) AS 'JSON'
				END
				IF @ISLEM = 4	--	Sınav Ekle
				BEGIN
					BEGIN TRANSACTION [Tran4]
					BEGIN TRY    
						---------
						--SINAV--
						---------
						DECLARE @ID_SINAVLIST TABLE (ID_SINAV INT)
						INSERT INTO [dbo].[Sinav]
								   ([ID_SINAVTURU] ,[AD] ,[KOD] ,[RAPORBASLIK] ,[DONEM] ,[ID_KADEME3] ,[SINAVTARIH] ,[OZEL] ,[FREKANSHESAPLA] ,[PUANGIZLE] ,[YUKLEMEKAPAT] ,[CEVAPANAHTARIYUKLEMEKAPAT],ONLINESINAV,[YANLISSAYISI], [OLCEKSINAVI], [KYE_TCKIMLIKNO])
						OUTPUT INSERTED.ID_SINAV INTO @ID_SINAVLIST(ID_SINAV)
						select		[ID_SINAVTURU] ,[AD] ,[KOD] ,[RAPORBASLIK] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM],[ID_KADEME3] ,convert(datetime, [SINAVTARIH], 103) ,[OZEL] ,[FREKANSHESAPLA] ,CASE WHEN (SELECT COUNT(*) FROM SinavPuanTuru WHERE ID_SINAVTURU=J.[ID_SINAVTURU])>0 THEN [PUANGIZLE] ELSE 1 END ,[YUKLEMEKAPAT] ,[CEVAPANAHTARIYUKLEMEKAPAT],ONLINESINAV ,[YANLISSAYISI] ,[OLCEKSINAVI] ,@TCKIMLIKNO 
						from OPENJSON(@SQLJSON)
						with
						(
							[ID_SINAVTURU] [int],
							[AD] [varchar](50),
							[KOD] [varchar](50),
							[RAPORBASLIK] [varchar](MAX),
							[ID_KADEME3] [nchar](10),
							[SINAVTARIH] [varchar](50),
							[OZEL] [bit],
							[FREKANSHESAPLA] [bit],
							[PUANGIZLE] [bit],
							[YUKLEMEKAPAT] [bit],
							[CEVAPANAHTARIYUKLEMEKAPAT] [bit],
							[ONLINESINAV] [bit],
							[YANLISSAYISI] [tinyint],
							[OLCEKSINAVI] [bit]
						) AS J

						SET @ID_SINAV = (select TOP 1 ID_SINAV from @ID_SINAVLIST)
						
						--SET @ONLINESINAV = IIF (EXISTS((SELECT TOP 1 1 FROM Sinav S WHERE ID_SINAV = (select ID_SINAV from @ID_SINAVLIST) AND S.ONLINESINAV = 1)),1, 0 )
						-------------
						--SINAVDERS--
						-------------
						DECLARE @SINAVDERS TABLE (ID_SINAVDERS INT,ID_DERS varchar(20), BOLUMNO int)
						INSERT INTO [dbo].[SinavDers]
								   ([ID_SINAV]
								   ,[BOLUMNO]
								   ,[ID_DERS]
								   ,[TAKMAAD])
						output INSERTED.ID_SINAVDERS, inserted.ID_DERS, inserted.BOLUMNO into @SINAVDERS(ID_SINAVDERS, ID_DERS, BOLUMNO)
						select @ID_SINAV as [ID_SINAV], SIRA as [BOLUMNO], ID_DERS=id, CASE WHEN TAKMAAD='' THEN text ELSE TAKMAAD END as TAKMAAD from OPENJSON(@SQLJSON,'$.JSONDERS')
						with
						(
							id varchar(20),
							SIRA int,
							text varchar(max),
							TAKMAAD varchar(max)
						)
						------------
						--KITAPCIK--
						------------
						DECLARE @KITAPCIKSAYISI int = (select KITAPCIKSAYISI from OPENJSON(@SQLJSON)with(KITAPCIKSAYISI int))

						--IF @ONLINESINAV = 1
						--	SET @KITAPCIKSAYISI = 1



						CREATE TABLE #HARFLER (AD char(1))
						DECLARE @asciiCode INT= 65 WHILE @asciiCode <= 90 BEGIN
							INSERT  #HARFLER (AD) SELECT  CHAR(@asciiCode)
							SELECT  @asciiCode = @asciiCode + 1
						END

						DECLARE @ID_SINAVKITAPCIK TABLE (ID_SINAVKITAPCIK INT, AD CHAR(1))
						INSERT INTO [dbo].[SinavKitapcik]
								   ([ID_SINAV]
								   ,[AD])
						output INSERTED.ID_SINAVKITAPCIK, INSERTED.AD into @ID_SINAVKITAPCIK(ID_SINAVKITAPCIK, AD)
						select top(@KITAPCIKSAYISI)@ID_SINAV as [ID_SINAV], AD from #HARFLER ORDER BY AD
						drop table #HARFLER
						------------------
						--SINAVANAHTAR A--
						------------------
						INSERT INTO [dbo].[SinavAnahtar]
								   ([ID_SINAVKITAPCIK]
								   ,[ID_SINAVDERS]
								   ,[ID_SINAVSORUTURU]
								   ,[SORUNO_A]
								   ,[CEVAP]
								   ,[OPTIKKARAKTERSAYISI]
								   ,[KOD]
								   ,[KATSAYI]
								   ,[SORUNO]
								   ,[ID_BILGI]
								   ,[ID_BILISSELSUREC]
								   ,ID_SORUBANKASI)
						SELECT
							(select ID_SINAVKITAPCIK from @ID_SINAVKITAPCIK WHERE AD='A'),
							sd.ID_SINAVDERS as ID_SINAVDERS,
							JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
							JSON_Value (s.value, '$.SORUNO') as SORUNOA, 
							CEVAP = CASE	WHEN SBC.ID_CEVAP	IS NULL THEN JSON_Value (s.value, '$.ACEVAP')
											WHEN SBC.CEVAPNO = 1		THEN 'A'
											WHEN SBC.CEVAPNO = 2		THEN 'B'
											WHEN SBC.CEVAPNO = 3		THEN 'C'
											WHEN SBC.CEVAPNO = 4		THEN 'D'
											WHEN SBC.CEVAPNO = 5		THEN 'E'
										END,
							--JSON_Value (s.value, '$.ACEVAP') as CEVAP,
							JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (s.value, '$.KOD') as KOD,
							CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
							JSON_Value (s.value, '$.SORUNO') as SORUNO ,
							JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI ,
							JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
							SSD.ID_SORU
						FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
						CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
						INNER JOIN @SINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')						
						LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
						LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV
						LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
						LEFT JOIN SoruBankasi.dbo.Cevap		SBC	ON	SBC.ID_SORU	= SSD.ID_SORU AND DEGER = '1'


						DELETE from @ID_SINAVKITAPCIK where ID_SINAVKITAPCIK=(select ID_SINAVKITAPCIK from @ID_SINAVKITAPCIK WHERE AD='A')--A kitapçığı siliniyor

						----------------------
						--SINAVANAHTAR DIGER--
						----------------------
						declare @ID int=(select min(ID_SINAVKITAPCIK) from @ID_SINAVKITAPCIK)
						while @ID is not null
						begin
							INSERT INTO [dbo].[SinavAnahtar]
									   ([ID_SINAVKITAPCIK]
									   ,[ID_SINAVDERS]
									   ,[ID_SINAVSORUTURU]
									   ,[SORUNO_A]
									   ,[CEVAP]
									   ,[OPTIKKARAKTERSAYISI]
									   ,[KOD]
									   ,[KATSAYI]
									   ,[SORUNO]
									   ,[ID_BILGI]
									   ,[ID_BILISSELSUREC]
									   ,ID_SORUBANKASI)
							select 
								ID_SINAVKITAPCIK = @ID,
								sd.ID_SINAVDERS as ID_SINAVDERS,
								JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
								JSON_Value (s.value, '$.SORUNO') as SORUNOA,
								JSON_Value (s.value, '$.ACEVAP') as CEVAP,
								JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
								JSON_Value (s.value, '$.KOD') as KOD,
								CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
								JSON_Value (k.value, '$.SIRA') as SORUNO,  
								JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI ,
								JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
								SSD.ID_SORU
							FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
							CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
							CROSS APPLY OPENJSON (s.value, '$.KARSILIKLIST') as k
							INNER JOIN @SINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
							LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
							LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
							LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
							where JSON_Value (k.value, '$.KITAPCIK')=(select AD from SinavKitapcik where ID_SINAVKITAPCIK = @ID)

							select @ID = min(ID_SINAVKITAPCIK) from @ID_SINAVKITAPCIK where ID_SINAVKITAPCIK > @ID
						end
						select ID_SINAV = @ID_SINAV
						COMMIT TRANSACTION [Tran4]
					END TRY
					BEGIN CATCH
						ROLLBACK TRANSACTION [Tran4]

						SELECT 
							@ErrorSeverity	= ERROR_SEVERITY(),
							@ErrorState		= ERROR_STATE()
							
						SELECT @MSG = 'Kayıt işlemi sırasında sistemsel bir hata meydana geldi! Lütfen daha sonra tekrar deneyiniz...'
			
						RAISERROR (@MSG , -- Message text.
									@ErrorSeverity, -- Severity.
									@ErrorState -- State.
									);
					END CATCH;
				END
				IF @ISLEM = 5	--	Sınav Listele
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,S.RAPORBASLIK
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.CEVAPANAHTARIYUKLEMEKAPAT AS CEVAPANAHTARIYUKLEMEKAPAT
							,S.ONLINESINAV
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3ESKI and S.AKTIF = 1
						AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 6	--	Sınav Bilgi Getir
				BEGIN

					--SELECT SD.ID_DERS, A.KOD, A.AD
					--INTO #SinavDers FROM SinavDers	SD
					----CROSS APPLY [dbo].[fn_DersUniteListe](SD.ID_DERS, NULL)	DU
					--INNER JOIN v3SinavDersUnite		A	ON A.ID_DERS = SD.ID_DERS
					--WHERE SD.ID_SINAV = @ID_SINAV

					DECLARE @ID_SINAVKITAPCIKX INT = (select  top 1  ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD='A')

					Select (
						Select 
							ID_SINAVTURU, 
							s.AD as AD, 
							(select count(*) from SinavKitapcik where ID_SINAV=@ID_SINAV) as KITAPCIKSAYISI, 
							s.KOD, 
							s.RAPORBASLIK,
							ID_KADEME3, 
							Convert(varchar, SINAVTARIH, 103) as SINAVTARIH,
							OZEL,
							FREKANSHESAPLA,
							PUANGIZLE,
							YUKLEMEKAPAT,
							CEVAPANAHTARIYUKLEMEKAPAT,
							ONLINESINAV,
							YANLISSAYISI,
							OLCEKSINAVI,
							JSONDERS.ID_DERS as id,
							JSONDERS.ID_SINAVDERS as id_sinavders,
							JSONDERS.TAKMAAD as text,
							(select count(*)/(select count(*) from SinavKitapcik where ID_SINAV=@ID_SINAV) from SinavAnahtar sa where ID_SINAVDERS=JSONDERS.ID_SINAVDERS) as SORUSAYISI,
							JSONDERS.BOLUMNO as SIRA,
							SORULIST.SORUNO_A as SORUNO,
							SORULIST.ID_SINAVSORUTURU as SORUTURU,
							SORULIST.CEVAP as ACEVAP,
							SORULIST.KOD,
							ISNULL(CAST(SORULIST.ID_SORUBANKASI AS VARCHAR), '') AS ID_SORUBANKASI,
							ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
							ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC, 
							UNITE = ISNULL(SD.AD, ''), 
							SORULIST.OPTIKKARAKTERSAYISI as KARAKTERSAYISI,
							SORULIST.KATSAYI,
							(select (select AD from SinavKitapcik where ID_SINAVKITAPCIK=ssa.ID_SINAVKITAPCIK) as KITAPCIK
								, SORUNO as SIRA 
							from SinavAnahtar ssa 
							where ID_SINAVKITAPCIK in (	select ID_SINAVKITAPCIK 
														from SinavKitapcik 
														where	ID_SINAV=@ID_SINAV 
															and AD<>'A') 
								and SORUNO_A=SORULIST.SORUNO 
								and ID_SINAVDERS=JSONDERS.ID_SINAVDERS 
							for json path) AS KARSILIKLIST
							,s.DONEM
						from	   Sinav			s
						inner join SinavDers		JSONDERS		on	JSONDERS.ID_SINAV		= s.ID_SINAV 
						LEFT  join SinavAnahtar		SORULIST		on	SORULIST.ID_SINAVDERS	= JSONDERS.ID_SINAVDERS and SORULIST.ID_SINAVKITAPCIK=@ID_SINAVKITAPCIKX
						LEFT  JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
						where s.ID_SINAV = @ID_SINAV
						order by BOLUMNO,SORULIST.SORUNO_A
					for json auto) as J

					--DROP TABLE #SinavDers

				END
				IF @ISLEM = 7	--	Sınav Güncelle
				BEGIN					
					BEGIN TRANSACTION [Tran7]
					BEGIN TRY    
						---------
						--SINAV--
						---------
						UPDATE S
							
						SET
							 [ID_SINAVTURU] = J.ID_SINAVTURU
							,[AD] = J.AD
							,[KOD] = J.KOD
							,[RAPORBASLIK] = J.RAPORBASLIK
							,[ID_KADEME3] = IIF(J.ID_KADEME3 = 0 , S.ID_KADEME3, J.ID_KADEME3)
							,[SINAVTARIH] = convert(datetime, J.SINAVTARIH, 103)
							,[OZEL] = J.OZEL
							,[FREKANSHESAPLA] = J.FREKANSHESAPLA
							,[PUANGIZLE] = CASE WHEN (SELECT COUNT(*) FROM SinavPuanTuru WHERE ID_SINAVTURU=J.ID_SINAVTURU)>0 THEN J.[PUANGIZLE] ELSE 1 END
							,[YUKLEMEKAPAT] = J.YUKLEMEKAPAT
							,[CEVAPANAHTARIYUKLEMEKAPAT]  = J.CEVAPANAHTARIYUKLEMEKAPAT
							,[ONLINESINAV] = J.[ONLINESINAV]
							,[YANLISSAYISI] = J.YANLISSAYISI
							,[OLCEKSINAVI] = J.OLCEKSINAVI
							,[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							,[GUN_TARIH] = GETDATE()
						FROM [dbo].[Sinav] S
						JOIN OPENJSON(@SQLJSON)
							with
							(
								[ID_SINAVTURU] [int],
								[AD] [varchar](50),
								[KOD] [varchar](50),
								[RAPORBASLIK] [varchar](MAX),
								[ID_KADEME3] int,
								[SINAVTARIH] [varchar](50),
								[OZEL] [bit],
								[FREKANSHESAPLA] [bit],
								[PUANGIZLE] [bit],
								[YUKLEMEKAPAT] [bit],
								[CEVAPANAHTARIYUKLEMEKAPAT]  [bit],
								[ONLINESINAV]  [bit],
								[YANLISSAYISI] [tinyint],
								[OLCEKSINAVI] [bit]
							) as J ON 1 = 1
						WHERE S.ID_SINAV = @ID_SINAV
							
						SET @ONLINESINAV = (SELECT TOP 1 ONLINESINAV FROM Sinav S WHERE ID_SINAV = @ID_SINAV )
						---------------
						--SORUBANKASI--
						---------------
						SELECT SI.ID_SORUILISKI, SD.ID_SINAV, SD.ID_DERS, SORUNO_A
						INTO #TEMPSORUILISKI
						FROM SinavAnahtar SA
						INNER JOIN SinavKitapcik SK ON SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK
						INNER JOIN SinavDers SD ON SD.ID_SINAVDERS = SA.ID_SINAVDERS
						INNER JOIN SoruBankasi.dbo.SoruIliski SI ON SI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						WHERE SK.ID_SINAV = @ID_SINAV AND SK.AD = 'A'

						IF @ONLINESINAV = 1
							SELECT	 SA.ID_SINAVANAHTAR
									,OS.ID_ONLINESINAVOGRENCICEVAP
									,SA.SORUNO_A
									,SD.BOLUMNO
									,OS.ID_CEVAP
							INTO #SINAVANAHTAR
							FROM SinavDers						SD
							JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
							JOIN Tbl_OnlineSinavOgrenciCevap	OS	ON	OS.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
							WHERE SD.ID_SINAV	= @ID_SINAV

						---------
						--Silme--
						---------
						DELETE sa
						FROM SinavAnahtar sa
						INNER JOIN SinavKitapcik sk
							ON sk.ID_SINAVKITAPCIK=sa.ID_SINAVKITAPCIK
						WHERE sk.ID_SINAV=@ID_SINAV

						DELETE sk
						FROM SinavKitapcik sk
						WHERE sk.ID_SINAV=@ID_SINAV

						--SINAV KRİTER
						SELECT SNK.*, SNKD.ID_SINAVDERS, SD.TAKMAAD, SD.ID_DERS
						INTO #TempSinavNetKriterDers
						FROM [Pusulam].[dbo].[SinavNetKriter] SNK
						JOIN [Pusulam].[dbo].[SinavNetKriterDers] SNKD ON SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
						JOIN [Pusulam].[dbo].[SinavDers] SD ON SD.ID_SINAVDERS = SNKD.ID_SINAVDERS
						WHERE SD.ID_SINAV = @ID_SINAV

						SELECT DISTINCT ID_SINAVNETKRITER, NET, ID_SINAVPUANTURU
						INTO #TempSinavNetKriter
						FROM #TempSinavNetKriterDers

						SELECT *
						INTO #TempSinavTYTSecimTurKriter
						FROM [Pusulam].[dbo].[SinavTYTSecimTurKriter]
						WHERE ID_SINAV = @ID_SINAV

						--TempSinavOptikDers
						SELECT sd.ID_SINAV,sd.ID_DERS,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM,TAKMAAD INTO #TempSinavOptikDers 
						FROM SinavOptikDers sod
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV						

						DELETE sod
						FROM SinavOptikDers sod
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						--TempSinavKatsayi
						SELECT sd.ID_SINAV,sd.TAKMAAD,ID_SINAVPUANTURU,KATSAYI INTO #TempSinavKatsayi
						FROM SinavKatsayi sk
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sk.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE sk
						FROM SinavKatsayi sk
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sk.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE sd
						FROM SinavDers sd
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE soc
						FROM SinavOgrenciCevap soc
						INNER JOIN SinavOgrenciCevapBolum socb on socb.ID_SINAVOGRENCICEVAPBOLUM=soc.ID_SINAVOGRENCICEVAPBOLUM
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=socb.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE socb
						FROM SinavOgrenciCevapBolum socb
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=socb.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE sos
						FROM SinavOgrenciSonuc sos
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=sos.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE sop
						FROM SinavOgrenciPuan sop					
						WHERE sop.ID_SINAV=@ID_SINAV

						DELETE sot
						FROM SinavOgrenciToplam sot
						WHERE sot.ID_SINAV=@ID_SINAV

						DELETE so
						FROM SinavOgrenci so
						WHERE so.ID_SINAV=@ID_SINAV

						-------------
						--SINAVDERS--
						-------------
						DECLARE @USINAVDERS TABLE (ID_SINAVDERS INT,ID_DERS varchar(20), BOLUMNO int)
						INSERT INTO [dbo].[SinavDers]
									([ID_SINAV]
									,[BOLUMNO]
									,[ID_DERS]
									,[TAKMAAD])
						output INSERTED.ID_SINAVDERS, inserted.ID_DERS, inserted.BOLUMNO into @USINAVDERS(ID_SINAVDERS, ID_DERS, BOLUMNO)
						select @ID_SINAV as [ID_SINAV], SIRA as [BOLUMNO], ID_DERS=id, CASE WHEN TAKMAAD='' THEN text ELSE TAKMAAD END as TAKMAAD 
						from OPENJSON(@SQLJSON,'$.JSONDERS')
						with
						(
							id varchar(20),
							SIRA int,
							text varchar(max),
							TAKMAAD varchar(max)
						)

						--------------------------------------------
						--EŞLEŞEN OPTİK VE KATSAYILARI GERİ KAYDET--
						--------------------------------------------
						INSERT INTO [dbo].[SinavOptikDers]
									([ID_SINAVDERS]
									,[BASLANGIC]
									,[OPTIKKARAKTERSAYISI]
									,[OTURUM])
								SELECT SD.ID_SINAVDERS, TSOD.BASLANGIC, TSOD.OPTIKKARAKTERSAYISI,OTURUM FROM #TempSinavOptikDers TSOD
								INNER JOIN SinavDers SD ON SD.ID_SINAV=TSOD.ID_SINAV AND SD.ID_DERS=TSOD.ID_DERS AND SD.TAKMAAD=TSOD.TAKMAAD
						DROP TABLE #TempSinavOptikDers

						INSERT INTO [dbo].[SinavKatsayi]
									([ID_SINAV]
									,[ID_SINAVPUANTURU]
									,[ID_SINAVDERS]
									,[KATSAYI])
								SELECT TSK.ID_SINAV, TSK.ID_SINAVPUANTURU, SD.ID_SINAVDERS, TSK.KATSAYI FROM #TempSinavKatsayi TSK
								INNER JOIN SinavDers SD ON SD.ID_SINAV=TSK.ID_SINAV AND SD.TAKMAAD=TSK.TAKMAAD
						DROP TABLE #TempSinavKatsayi

						--------------------------------------------
						--EŞLEŞEN KRİTERLERİ GERİ KAYDET--
						--------------------------------------------
						DECLARE @ID_SINAVNETKRITERTABLE7 TABLE (ID_SINAVNETKRITER INT, ID_SINAVNETKRITERESKI INT)
						MERGE INTO SinavNetKriter 
						USING #TempSinavNetKriter AS TEMP ON 1 = 0
						WHEN NOT MATCHED THEN
						INSERT ([NET] ,[ID_SINAVPUANTURU])
						VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
						OUTPUT TEMP.ID_SINAVNETKRITER, inserted.ID_SINAVNETKRITER
						INTO @ID_SINAVNETKRITERTABLE7 (ID_SINAVNETKRITERESKI, ID_SINAVNETKRITER);

						INSERT INTO SinavNetKriterDers (ID_SINAVNETKRITER, ID_SINAVDERS)
						SELECT DISTINCT ID_SNK.ID_SINAVNETKRITER, SD.ID_SINAVDERS
						FROM @ID_SINAVNETKRITERTABLE7 ID_SNK
						JOIN #TempSinavNetKriterDers SNKD ON SNKD.ID_SINAVNETKRITER = ID_SNK.ID_SINAVNETKRITERESKI
						JOIN SinavDers SD ON SD.ID_SINAV = @ID_SINAV AND SD.ID_DERS = SNKD.ID_DERS AND SD.TAKMAAD = SNKD.TAKMAAD

						INSERT INTO SinavTYTSecimTurKriter (ID_SINAV, ID_TYTSECIMTUR, PUAN)
						SELECT DISTINCT ID_SINAV, ID_TYTSECIMTUR, PUAN
						FROM #TempSinavTYTSecimTurKriter
						
						DROP TABLE #TempSinavNetKriter
						DROP TABLE #TempSinavNetKriterDers
						DROP TABLE #TempSinavTYTSecimTurKriter

						------------
						--KITAPCIK--
						------------
						DECLARE @UKITAPCIKSAYISI int = (select KITAPCIKSAYISI from OPENJSON(@SQLJSON)with(KITAPCIKSAYISI int))
												
						--IF @ONLINESINAV = 1
						--	SET @UKITAPCIKSAYISI = 1

						CREATE TABLE #UHARFLER (AD char(1))
						DECLARE @UasciiCode INT= 65 WHILE @UasciiCode <= 90 BEGIN
							INSERT  #UHARFLER (AD) SELECT  CHAR(@UasciiCode)
							SELECT  @UasciiCode = @UasciiCode + 1
						END

						DECLARE @UID_SINAVKITAPCIK TABLE (ID_SINAVKITAPCIK INT, AD CHAR(1))
						INSERT INTO [dbo].[SinavKitapcik]
									([ID_SINAV]
									,[AD])
						output INSERTED.ID_SINAVKITAPCIK, inserted.AD into @UID_SINAVKITAPCIK(ID_SINAVKITAPCIK, AD)
						select top(@UKITAPCIKSAYISI)@ID_SINAV as [ID_SINAV], AD from #UHARFLER ORDER BY AD
						drop table #UHARFLER

						------------------
						--SINAVANAHTAR A--
						------------------
						INSERT INTO [dbo].[SinavAnahtar]
									([ID_SINAVKITAPCIK]
									,[ID_SINAVDERS]
									,[ID_SINAVSORUTURU]
									,[SORUNO_A]
									,[CEVAP]
									,[OPTIKKARAKTERSAYISI]
									,[KOD]
									,[KATSAYI]
									,[SORUNO]
									,[ID_BILGI]
									,[ID_BILISSELSUREC]
									,[ID_SORUBANKASI])
						SELECT
							(select ID_SINAVKITAPCIK from @UID_SINAVKITAPCIK WHERE AD = 'A'),
							sd.ID_SINAVDERS as ID_SINAVDERS,
							JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
							JSON_Value (s.value, '$.SORUNO') as SORUNOA, 
							
							CEVAP = CASE	WHEN SBC.ID_CEVAP	IS NULL THEN JSON_Value (s.value, '$.ACEVAP')
											WHEN SBC.CEVAPNO = 1		THEN 'A'
											WHEN SBC.CEVAPNO = 2		THEN 'B'
											WHEN SBC.CEVAPNO = 3		THEN 'C'
											WHEN SBC.CEVAPNO = 4		THEN 'D'
											WHEN SBC.CEVAPNO = 5		THEN 'E'
										END,
							--JSON_Value (s.value, '$.ACEVAP') as CEVAP,
							JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (s.value, '$.KOD') as KOD,
							CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
							JSON_Value (s.value, '$.SORUNO') as SORUNO,  
							JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI,
							JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
							SSD.ID_SORU
						FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
						CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
						INNER JOIN @USINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
						LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
						LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
						LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
						LEFT JOIN SoruBankasi.dbo.Cevap		SBC	ON	SBC.ID_SORU	= SSD.ID_SORU AND DEGER = '1'
						
						DELETE from @UID_SINAVKITAPCIK where ID_SINAVKITAPCIK=(select ID_SINAVKITAPCIK from @UID_SINAVKITAPCIK WHERE AD = 'A')--A kitapçığı siliniyor

						----------------------
						--SINAVANAHTAR DIGER--
						----------------------
						declare @UID int=(select min(ID_SINAVKITAPCIK) from @UID_SINAVKITAPCIK)
						while @UID is not null
						begin
							INSERT INTO [dbo].[SinavAnahtar]
										([ID_SINAVKITAPCIK]
										,[ID_SINAVDERS]
										,[ID_SINAVSORUTURU]
										,[SORUNO_A]
										,[CEVAP]
										,[OPTIKKARAKTERSAYISI]
										,[KOD]
										,[KATSAYI]
										,[SORUNO]
										,[ID_BILGI]
										,[ID_BILISSELSUREC]
										,[ID_SORUBANKASI])
							select 
								ID_SINAVKITAPCIK = @UID,
								sd.ID_SINAVDERS as ID_SINAVDERS,
								JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
								JSON_Value (s.value, '$.SORUNO') as SORUNOA,
								JSON_Value (s.value, '$.ACEVAP') as CEVAP,
								JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
								JSON_Value (s.value, '$.KOD') as KOD,
								CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
								JSON_Value (k.value, '$.SIRA') as SORUNO,  
								JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI,
								JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
								SSD.ID_SORU
							FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
							CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
							CROSS APPLY OPENJSON (s.value, '$.KARSILIKLIST') as k
							INNER JOIN @USINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
							LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
							LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
							LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD') AND SSD.SILINDI = 0
							where JSON_Value (k.value, '$.KITAPCIK')=(select AD from SinavKitapcik where ID_SINAVKITAPCIK = @UID)

							select @UID = min(ID_SINAVKITAPCIK) from @UID_SINAVKITAPCIK where ID_SINAVKITAPCIK > @UID
						END
						
						IF @ONLINESINAV = 1
						BEGIN
							UPDATE OS SET
								OS.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
							FROM SinavDers						SD
							JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
							JOIN #SINAVANAHTAR					T	ON	T.BOLUMNO						= SD.BOLUMNO
																	AND T.SORUNO_A						= SA.SORUNO_A
							JOIN SoruBankasi.dbo.SoruDetay		SBD	ON	SBD.ID_SORU						= SA.ID_SORUBANKASI
							JOIN SoruBankasi.dbo.Cevap			C	ON	C.ID_CEVAP						= T.ID_CEVAP
																	AND C.ID_SORU						= SBD.ID_SORU
							JOIN Tbl_OnlineSinavOgrenciCevap	OS	ON	OS.ID_ONLINESINAVOGRENCICEVAP	= T.ID_ONLINESINAVOGRENCICEVAP
																	AND OS.ID_SINAVANAHTAR				= T.ID_SINAVANAHTAR
							WHERE SD.ID_SINAV = @ID_SINAV
						END
			
						DELETE FROM Tbl_OnlineSinavOgrenciCevap
						WHERE ID_ONLINESINAVOGRENCICEVAP NOT IN ( 
							SELECT OC.ID_ONLINESINAVOGRENCICEVAP
							FROM SinavAnahtar					SA
							JOIN SoruBankasi.dbo.Cevap			C	ON	C.ID_SORU			= SA.ID_SORUBANKASI
							JOIN Tbl_OnlineSinavOgrenciCevap	OC	ON	OC.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
																	AND OC.ID_CEVAP			= C.ID_CEVAP
							)

						UPDATE Sinav SET DURUM = 0 WHERE ID_SINAV = @ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR

						---------------
						--SORUBANKASI--
						---------------
						UPDATE SI SET SI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						FROM SoruBankasi.dbo.SoruIliski SI
						INNER JOIN #TEMPSORUILISKI T ON T.ID_SORUILISKI = SI.ID_SORUILISKI
						INNER JOIN SinavDers SD ON SD.ID_SINAV = T.ID_SINAV AND SD.ID_DERS = T.ID_DERS
						INNER JOIN SinavKitapcik SK ON SK.ID_SINAV = T.ID_SINAV AND SK.AD = 'A'
						INNER JOIN SinavAnahtar SA ON SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK AND SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.SORUNO_A = T.SORUNO_A

						DROP TABLE IF EXISTS #TEMPSORUILISKI
						COMMIT TRANSACTION [Tran7]
					END TRY
					BEGIN CATCH
						ROLLBACK TRANSACTION [Tran7]

						SELECT 
							@ErrorSeverity	= ERROR_SEVERITY(),
							@ErrorState		= ERROR_STATE()
							
						SELECT @MSG = 'Güncelleme işlemi sırasında sistemsel bir hata meydana geldi! Lütfen daha sonra tekrar deneyiniz...'
			
						RAISERROR (@MSG , -- Message text.
									@ErrorSeverity, -- Severity.
									@ErrorState -- State.
									);
					END CATCH;
				END
				IF @ISLEM = 8	--	Sınav Ders Konu Listele
				BEGIN
				
					EXEC [dbo].[sp_DersUniteGetir] @ID_DERS = @ID_DERS

					--SELECT ID_DERS, KOD, AD, SECILEBILIR FROM [dbo].[fn_DersUniteListe](@ID_DERS, NULL)			
				
				END
				IF @ISLEM = 9	--	Sınav Katsayı Listele
				BEGIN
					SELECT
					(
						SELECT	 ID_SINAV = @ID_SINAV
								,SPT.ID_SINAVPUANTURU
								,PUANTURU = SPT.AD
								,KATSAYILIST = ISNULL(
								(
									SELECT	 SK.ID_SINAVKATSAYI
											,S.ID_SINAV
											,SPT.ID_SINAVPUANTURU
											,SD.ID_SINAVDERS
											,DERS = SD.TAKMAAD
											,ISNULL(CONVERT(DECIMAL(18,10 ), SK.KATSAYI), 0) AS KATSAYI 
									FROM SinavDers SD
									INNER JOIN Sinav S on S.ID_SINAV = SD.ID_SINAV
									LEFT JOIN SinavKatsayi SK on SK.ID_SINAV = S.ID_SINAV AND SK.ID_SINAVDERS = SD.ID_SINAVDERS
									WHERE s.ID_SINAV = @ID_SINAV AND (sk.ID_SINAVPUANTURU IS NULL OR SK.ID_SINAVPUANTURU=SPT.ID_SINAVPUANTURU) 
									ORDER BY SD.BOLUMNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								), '[]')
								,KRITERLIST = ISNULL(
								(
									SELECT	 ID_SINAVPUANTURU	= SPT.ID_SINAVPUANTURU
											,NET				= SNK.NET
											,ID_SINAVDERSLIST	= dbo.ufnToRawJsonArray((SELECT ID_SINAVDERS FROM SinavNetKriterDers SNKD WHERE SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER FOR JSON PATH), 'ID_SINAVDERS')
									FROM SinavNetKriter SNK
									WHERE SNK.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU
									AND SNK.ID_SINAVNETKRITER IN (SELECT ID_SINAVNETKRITER FROM SinavNetKriterDers WHERE ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV))
									FOR JSON PATH
								), '[]')
								,SINAVDERSLIST = ISNULL(
								(
									SELECT	ID_SINAVDERS, AD = TAKMAAD
									FROM SinavDers
									WHERE ID_SINAV = @ID_SINAV
									FOR JSON PATH
								), '[]')
								,STP.ID_SINAVTABANPUAN AS ID_SINAVTABANPUAN
								,ISNULL(STP.TABANPUAN, 0) AS TABANPUAN
						FROM SinavPuanTuru SPT
						LEFT JOIN SinavTabanPuan STP ON STP.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU AND STP.ID_SINAV = @ID_SINAV
						WHERE ID_SINAVTURU = (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV)
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS RESULT
				END
				IF @ISLEM = 10	--	Sınav Katsayı - Taban Puan Keydet
				BEGIN
					--TABAN PUAN INSERT
					DELETE FROM SinavTabanPuan WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavTabanPuan]
								([ID_SINAV]
								,[ID_SINAVPUANTURU]
								,[TABANPUAN])
					SELECT
							JSON_Value (j.value, '$.ID_SINAV') as ID_SINAV,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU, 
							ISNULL(JSON_Value (j.value, '$.TABANPUAN'),0) as TABANPUAN
					FROM OPENJSON (@SQLJSON) as j
					--WHERE JSON_Value (j.value, '$.ID_SINAVTABANPUAN') is null

					--TABAN PUAN UPDATE
					--UPDATE [dbo].[SinavTabanPuan]
					--SET	[TABANPUAN] = JSON_Value (j.value, '$.TABANPUAN')
					--FROM
					--	[dbo].[SinavTabanPuan] stp
					--	INNER JOIN OPENJSON (@SQLJSON) j
					--		ON JSON_Value (j.value, '$.ID_SINAVTABANPUAN') = stp.ID_SINAVTABANPUAN
					--WHERE
					--	JSON_Value (j.value, '$.ID_SINAVTABANPUAN') IS NOT NULL

					--KATSAYI INSERT
				

					DELETE FROM [SinavKatsayi] WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavKatsayi]
								([ID_SINAV]
								,[ID_SINAVPUANTURU]
								,[ID_SINAVDERS]
								,[KATSAYI])
					SELECT	DISTINCT
							JSON_Value (j.value, '$.ID_SINAV') as ID_SINAV,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU, 
							JSON_Value (j.value, '$.ID_SINAVDERS') as ID_SINAVDERS,
							ISNULL(REPLACE(JSON_Value (j.value, '$.KATSAYI'),',','.'),0.0) as KATSAYI
					FROM OPENJSON(@SQLJSON) as parent
					CROSS APPLY OPENJSON (parent.value, '$.KATSAYILIST') as j
					--WHERE JSON_Value (j.value, '$.KATSAYI') IS NOT NULL


					--KRİTER--
					DECLARE @ID_SINAVNETKRITERTABLE TABLE (ID_SINAVNETKRITER INT, GUID VARCHAR(MAX))

					DELETE SNK 
					FROM [SinavNetKriter] SNK
					JOIN SinavNetKriterDers SNKD ON SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
					WHERE SNKD.ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV)

					SELECT	DISTINCT
							ISNULL(REPLACE(JSON_Value (j.value, '$.NET'),',','.'),0.0) as NET,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU,
							JSON_Value (j.value, '$.GUID') as GUID
					INTO #SINAVNETKRITER
					FROM OPENJSON(@SQLJSON) as parent
					CROSS APPLY OPENJSON (parent.value, '$.KRITERLIST') as j

					SELECT	 GUID = JSON_Value (KRITERLIST.value, '$.GUID')
							,ID_SINAVDERS = ID_SINAVDERSLIST.value
					INTO #SINAVNETKRITERDERS
					FROM OPENJSON(@SQLJSON) J
					CROSS APPLY OPENJSON (J.value, '$.KRITERLIST') as KRITERLIST
					CROSS APPLY OPENJSON (KRITERLIST.value, '$.ID_SINAVDERSLIST') as ID_SINAVDERSLIST

					MERGE INTO SinavNetKriter 
					USING #SINAVNETKRITER AS TEMP ON 1 = 0
					WHEN NOT MATCHED THEN
					INSERT ([NET] ,[ID_SINAVPUANTURU])
					VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
					OUTPUT TEMP.GUID, inserted.ID_SINAVNETKRITER
					INTO @ID_SINAVNETKRITERTABLE (GUID, ID_SINAVNETKRITER);

					INSERT INTO SinavNetKriterDers (ID_SINAVNETKRITER, ID_SINAVDERS)
					SELECT ID_SINAVNETKRITER, SNKD.ID_SINAVDERS
					FROM @ID_SINAVNETKRITERTABLE ID_SNK
					JOIN #SINAVNETKRITERDERS SNKD ON SNKD.GUID = ID_SNK.GUID

					DROP TABLE IF EXISTS #SINAVNETKRITER
					DROP TABLE IF EXISTS #SINAVNETKRITERDERS
					--KRİTER--

					--KATSAYI UPDATE
					--UPDATE [dbo].[SinavKatsayi]
					--SET [KATSAYI] = k.KATSAYI
					--FROM
					--	[dbo].[SinavKatsayi] sk
					--	INNER JOIN (SELECT JSON_Value (j.value, '$.ID_SINAVKATSAYI') as ID_SINAVKATSAYI, REPLACE(JSON_Value (j.value, '$.KATSAYI'),',','.') as KATSAYI FROM OPENJSON(@SQLJSON) as parent CROSS APPLY OPENJSON (parent.value, '$.KATSAYILIST') as j) k on k.ID_SINAVKATSAYI=sk.ID_SINAVKATSAYI
					--WHERE k.ID_SINAVKATSAYI IS NOT NULL and k.KATSAYI IS NOT NULL
				END
				IF @ISLEM = 11	--	Sınav Optik Listele
				BEGIN
					SELECT [ID_SINAVOPTIKSABIT] as ID	
						  ,ILISKI=so.ID_SINAVOPTIK
						  ,[BASLANGIC]
						  ,[OPTIKKARAKTERSAYISI] as KARAKTERSAYISI
						  ,TUR=1
						  ,AD=so.AD
						  ,OTURUM=1
						  ,BOLUMNO=0
					  INTO #TEMPOPTIK
					  FROM [SinavOptik]				so
					  LEFT JOIN [SinavOptikSabit]	sos on sos.ID_SINAVOPTIK=so.ID_SINAVOPTIK and sos.ID_SINAV=@ID_SINAV
					  ORDER BY sos.ID_SINAVOPTIKSABIT
			
					SELECT [ID_SINAVOPTIKDERS] as ID
						  ,sd.[ID_SINAVDERS] as ILISKI
						  ,[BASLANGIC]
						  ,[OPTIKKARAKTERSAYISI] as KARAKTERSAYISI
						  ,TUR=2
						  ,AD=sd.TAKMAAD
						  ,ISNULL(sod.OTURUM,1) AS OTURUM
						  ,sd.BOLUMNO
					  INTO #TEMPOPTIK2
					  FROM [SinavDers]				sd
					  LEFT JOIN [SinavOptikDers]	sod on sod.ID_SINAVDERS=sd.ID_SINAVDERS
					  WHERE sd.ID_SINAV=@ID_SINAV

					 SELECT *  FROM #TEMPOPTIK
					 UNION
					 SELECT * FROM #TEMPOPTIK2
					 ORDER BY BOLUMNO
			 
					 DROP TABLE IF EXISTS #TEMPOPTIK
					 DROP TABLE IF EXISTS #TEMPOPTIK2
				END
				IF @ISLEM = 12	--	Sınav Optik Kaydet
				BEGIN
					--OPTIK SABIT INSERT
					DELETE FROM [SinavOptikSabit] WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavOptikSabit]
							   ([ID_SINAV]
							   ,[ID_SINAVOPTIK]
							   ,[BASLANGIC]
							   ,[OPTIKKARAKTERSAYISI])
					SELECT
							@ID_SINAV as ID_SINAV,
							JSON_Value (j.value, '$.ILISKI') as ID_SINAVOPTIK, 
							JSON_Value (j.value, '$.BASLANGIC') as BASLANGIC, 
							JSON_Value (j.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI
					FROM OPENJSON (@SQLJSON) as j
					WHERE JSON_Value (j.value, '$.TUR') = 1 --and (JSON_Value (j.value, '$.ID') IS NULL or JSON_Value (j.value, '$.ID') = 0)

					--OPTIK SABIT UPDATE
					--UPDATE [dbo].[SinavOptikSabit]
					--SET	[BASLANGIC] = JSON_Value (j.value, '$.BASLANGIC'), [OPTIKKARAKTERSAYISI] = JSON_Value (j.value, '$.KARAKTERSAYISI')
					--FROM OPENJSON (@SQLJSON) as j
					--WHERE
					--	JSON_Value (j.value, '$.TUR') = 1 
					--	and (JSON_Value (j.value, '$.ID') IS NOT NULL 
					--	and JSON_Value (j.value, '$.ID') > 0)
					--	and ID_SINAVOPTIKSABIT=JSON_Value (j.value, '$.ID')

					--OPTIK DERS INSERT
					DELETE SOD FROM [SinavOptikDers] SOD INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOD.ID_SINAVDERS WHERE SD.ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavOptikDers]
							   ([ID_SINAVDERS]
							   ,[BASLANGIC]
							   ,[OPTIKKARAKTERSAYISI]
							   ,[OTURUM])
					SELECT
							JSON_Value (j.value, '$.ILISKI') as ID_SINAVDERS, 
							JSON_Value (j.value, '$.BASLANGIC') as BASLANGIC, 
							JSON_Value (j.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (j.value, '$.OTURUM') as OTURUM
					FROM OPENJSON (@SQLJSON) as j
					WHERE JSON_Value (j.value, '$.TUR') = 2 --and (JSON_Value (j.value, '$.ID') IS NULL or JSON_Value (j.value, '$.ID') = 0)

					--OPTIK DERS UPDATE
					--UPDATE [dbo].[SinavOptikDers]
					--SET	[BASLANGIC] = JSON_Value (j.value, '$.BASLANGIC'), [OPTIKKARAKTERSAYISI] = JSON_Value (j.value, '$.KARAKTERSAYISI'),
					--	[OTURUM] = JSON_Value (j.value, '$.OTURUM')
					--FROM OPENJSON (@SQLJSON) as j
					--WHERE
					--	JSON_Value (j.value, '$.TUR') = 2 
					--	and (JSON_Value (j.value, '$.ID') IS NOT NULL 
					--	and JSON_Value (j.value, '$.ID') > 0)
					--	and ID_SINAVOPTIKDERS=JSON_Value (j.value, '$.ID')
				END
				IF @ISLEM = 13	--	Sınav Dosya Listele
				BEGIN
					SELECT 
						 sd.ID_SINAVDOSYA
						,sd.AD
						,k.AD AS KAD
						,k.SOYAD AS KSOYAD
						,sd.KYE_TARIH 
						,ISNULL(s.AD,'') SUBEAD
						,sn.ONLINESINAV
						,GUID = sd.GUID + IIF (CHARINDEX('.', SD.AD) > 0 , SUBSTRING( SD.AD , LEN(SD.AD) - CHARINDEX('.', REVERSE(SD.AD)) + 1 , CHARINDEX('.', REVERSE(SD.AD)) ) , '')
						,KATILIM	= IIF(SN.ONLINESINAV = 1 AND  SD.AD = 'ONLINE'
										,(	SELECT COUNT(DISTINCT TCKIMLIKNO) 
											FROM Tbl_OnlineSinavOgrenci		 OS 
											JOIN Tbl_OnlineSinavOgrenciCevap C	ON	C.ID_ONLINESINAVOGRENCI = OS.ID_ONLINESINAVOGRENCI 
																				AND C.AKTIF					= 1 
											WHERE	OS.ID_SINAV = SN.ID_SINAV 
												AND OS.AKTIF	= 1)
										,(SELECT COUNT(t.LINE) FROM SinavOptikTemp t WHERE t.ID_SINAVDOSYA=sd.ID_SINAVDOSYA)
										)
						,(SELECT COUNT(1) FROM [dbo].[fn_TcEslesmeGetir](sn.ID_KADEME3,SD.ID_SINAVDOSYA,sn.ID_SINAV,cast(@SINAVOTURUM as int),0)) SORUNLUTC
						--,(SELECT COUNT(1) FROM [dbo].[fn_TcEslesmeGetir](sn.ID_KADEME3,SD.ID_SINAVDOSYA,sn.ID_SINAV,@SINAVOTURUM,1))TEKRARLAYANTC
						,sn.DURUM
						,sn.YUKLEMEKAPAT
					FROM		SinavDosya		sd
					INNER JOIN	Sinav			sn	on sn.ID_SINAV	= sd.ID_SINAV 
					INNER JOIN	v3Kullanici		k	on k.TCKIMLIKNO	= sd.KYE_TCKIMLIKNO
					LEFT  JOIN	v3Sube			s	on s.ID_SUBE	= sd.ID_SUBE
					where sd.ID_SINAV=@ID_SINAV AND sd.AKTIF=1 AND (@ID_SUBE=0 OR sd.ID_SUBE=@ID_SUBE) AND (@SINAVOTURUM = 0 OR sd.OTURUM = @SINAVOTURUM)
				END
				IF @ISLEM = 14	--	Sınav Dosya Kaydet
				BEGIN

					 IF EXISTS (SELECT * FROM SinavDosya WHERE ID_SINAV=@ID_SINAV AND AD=@DOSYAADI AND AKTIF=1)
					 BEGIN
						SELECT @MSG = 'DAHA ÖNCE AYNI İSİMLİ DOSYA KAYDETTİNİZ. KONTROL EDİNİZ!'
			
						RAISERROR (@MSG , -- Message text.
							16, -- Severity.
							1-- State.
							);					
					 END
					 ELSE
					 BEGIN
						DECLARE @ID_SINAVDOSYAx TABLE (ID_SINAVDOSYA int)
						INSERT INTO [dbo].[SinavDosya]
									([ID_SINAV]
									,[ID_SUBE]
									,[AD]
									,[GUID]
									,[KYE_TCKIMLIKNO]
									,[OTURUM])
									OUTPUT INSERTED.ID_SINAVDOSYA into @ID_SINAVDOSYAx
								VALUES
									(@ID_SINAV,@ID_SUBE,@DOSYAADI,@DOSYAGUID,@TCKIMLIKNO,@SINAVOTURUM)
						DECLARE @IDX int=(select top 1 ID_SINAVDOSYA from @ID_SINAVDOSYAx)
						DECLARE	@return_value int
			
						--UPDATE Sinav SET DURUM=3 WHERE ID_SINAV=@ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR
			
						--EXEC	@return_value = [dbo].[sp_OptikIslemleri]
						--		@ID_SINAV = @ID_SINAV,
						--		@ID_SINAVDOSYA = @IDX,
						--		@ID_SUBE=@ID_SUBE,
						--		@ISLEM = 0

						--UPDATE Sinav SET DURUM=0 WHERE ID_SINAV=@ID_SINAV

						DECLARE @SQLDOSYA		VARCHAR(max)	= NULL
						DECLARE @YOLDOSYA		VARCHAR(max)	= NULL
						DECLARE @GUIDDOSYA		VARCHAR(max)	= NULL

						IF @IDX IS NOT NULL AND NOT EXISTS(SELECT * FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@IDX)
						BEGIN
				
							PRINT '2: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

							DECLARE @PAYLASIMYOL VARCHAR(MAX) = '\\172.18.194.207\$SinavOptik\'

							IF HOST_NAME() = 'KDCENGIZPC'	-- LOCALDEN İSE KENDİ SINAVDOSYA YA 
								SET @PAYLASIMYOL = '\\100.100.15.144\$SinavOptik\'
								

							SET @GUIDDOSYA = (SELECT GUID FROM SinavDosya where ID_SINAVDOSYA=@IDX)
							create table #tmp (
								line nvarchar(max)
							);
							BEGIN TRY  
								SET @YOLDOSYA = @PAYLASIMYOL+@GUIDDOSYA+'.txt'
								SET @SQLDOSYA=
								'BULK INSERT #tmp
								FROM '''+@YOLDOSYA+'''
								WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
								EXEC(@SQLDOSYA) 
							END TRY  
							BEGIN CATCH  
								SET @YOLDOSYA = @PAYLASIMYOL+@GUIDDOSYA+'.dat'
								SET @SQLDOSYA=
								'BULK INSERT #tmp
								FROM '''+@YOLDOSYA+'''
								WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
								EXEC(@SQLDOSYA) 
							END CATCH 
				
							INSERT INTO SinavOptikTemp (LINE,ID_SINAVDOSYA)
							SELECT line, @IDX FROM #tmp
							WHERE line IS NOT NULL
							DROP TABLE IF EXISTS #tmp

							PRINT '3: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						END	

						SELECT DISTINCT OTURUM INTO #OTURUMLARDOSYAYUKLE FROM SinavDosya WHERE ID_SINAV  = @ID_SINAV
						DECLARE @HATALIDOSYAYUKLE BIT=0
						WHILE (SELECT COUNT(1) FROM #OTURUMLARDOSYAYUKLE)>0
						BEGIN 
							DECLARE @SUB_OTURUMDOSYAYUKLE INT = (SELECT TOP 1 OTURUM FROM #OTURUMLARDOSYAYUKLE)
				
							IF  ((SELECT COUNT(*) TE_TC FROM [dbo].[fn_TcEslesmeGetir](NULL,NULL,@ID_SINAV,@SUB_OTURUMDOSYAYUKLE,1)) > 0)
							BEGIN
								--SELECT @MSG = 'TEKRARLANAN TC OLDUĞUNDAN DEĞERLENDİRME YAPILAMAZ KONTROL EDİNİZ!'
			
								--RAISERROR (@MSG , -- Message text.
								--	16, -- Severity.
								--	1-- State.
								--	);
								SET @HATALIDOSYAYUKLE = 1
							END
				
							DELETE FROM #OTURUMLARDOSYAYUKLE WHERE OTURUM = @SUB_OTURUMDOSYAYUKLE
						END

						IF @HATALIDOSYAYUKLE = 0
						BEGIN
							UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 0 where ID_SINAV = @ID_SINAV -- SIRAYA ALINDI
			
							INSERT INTO [dbo].[SinavDegerlendir]
									([ID_SINAV]
									,[KYE_TCKIMLIKNO])
								VALUES
									(@ID_SINAV
									,@TCKIMLIKNO)
						END

						SELECT @IDX
					END
				END
				IF @ISLEM = 15	--	Sınav Dosya Sil
				BEGIN
					UPDATE SinavDosya set AKTIF=0, SIL_TCKIMLIKNO=@TCKIMLIKNO, SIL_TARIH=getdate() where ID_SINAVDOSYA=@ID_SINAVDOSYA
					DELETE FROM SinavOgrenci WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA
					DELETE FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA
				END
				IF @ISLEM = 16	--	Optik Girildi Mi
				BEGIN
					IF((select count(*) from SinavOptikDers sod inner join SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS where sd.ID_SINAV=@ID_SINAV)
					+(select count(*) from SinavOptikSabit where ID_SINAV=@ID_SINAV)
					=(select count(*) from SinavOptik)+(select count(*) from SinavDers where ID_SINAV=@ID_SINAV))
					BEGIN
						select 1
					END
					ELSE
					BEGIN
						select 0
					END 
				END
				IF @ISLEM = 17	--	Sınav Değerlendir
				BEGIN
					SELECT DISTINCT OTURUM INTO #OTURUMLAR FROM SiNAVDOSYA WHERE ID_SINAV=@ID_SINAV
					DECLARE @HATALI BIT=0
					WHILE (SELECT COUNT(1) FROM #OTURUMLAR)>0
					BEGIN 
				
						DECLARE @SUB_OTURUM INT =(SELECT TOP 1 OTURUM FROM #OTURUMLAR)
				
						IF  ((SELECT COUNT(*) TE_TC FROM [dbo].[fn_TcEslesmeGetir](NULL,NULL,@ID_SINAV,@SUB_OTURUM,1))>0)
						BEGIN
							SELECT @MSG = 'TEKRARLANAN TC OLDUĞUNDAN DEĞERLENDİRME YAPILAMAZ KONTROL EDİNİZ!'
			
							RAISERROR (@MSG , -- Message text.
								16, -- Severity.
								1-- State.
								);
							SET @HATALI=1

						END
				
						DELETE FROM #OTURUMLAR WHERE OTURUM=@SUB_OTURUM
					END





					IF  (@HATALI=0)			
					BEGIN

					
						IF	 EXISTS(SELECT TOP 1 1 FROM Sinav WHERE ID_SINAV = @ID_SINAV AND ONLINESINAV = 1) 
						 AND NOT EXISTS(SELECT TOP 1 1 FROM SinavDosya WHERE ID_SINAV = @ID_SINAV)
						BEGIN
								INSERT INTO SinavDosya (AD, GUID, ID_SINAV, ID_SUBE, KYE_TCKIMLIKNO)
								VALUES ('ONLINE', '', @ID_SINAV, 0, @TCKIMLIKNO)
						END

						UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 0 where ID_SINAV = @ID_SINAV -- SIRAYA ALINDI
			
						INSERT INTO [dbo].[SinavDegerlendir]
								   ([ID_SINAV]
								   ,[KYE_TCKIMLIKNO])
							 VALUES
								   (@ID_SINAV
								   ,@TCKIMLIKNO)
					END
				END
				IF @ISLEM = 18	--	Sınav Puan Türü (@ID_SINAVTURU)
				BEGIN
					--SELECT		S.ID_SINAV, KOD, S.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 103) as SINAVTARIH, DURUM 
					--FROM		Sinav			S
					--INNER JOIN	SinavOgrenci	SO	ON SO.ID_SINAV=S.ID_SINAV
					--WHERE		SO.TCKIMLIKNO	= @TC_OGRENCI	AND S.DONEM	= @DONEM
					--ORDER BY	S.SINAVTARIH

					SELECT		DISTINCT PT.ID_SINAVPUANTURU,PT.AD,PT.KOD
					FROM		SinavPuanTuru	PT
					INNER JOIN	Sinav			S	ON PT.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE		S.ID_SINAVTURU=@ID_SINAVTURU
					ORDER BY	PT.ID_SINAVPUANTURU 


				END
				IF @ISLEM = 19	--	Sınav Listele by Ogrenci
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	and (@TC_OGRENCI IS NULL OR TCKIMLIKNO=@TC_OGRENCI)
						where s.AKTIF=1 and s.DURUM=2  
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (cast(@ID_SINAVTURU as int)=0 or s.ID_SINAVTURU=cast(@ID_SINAVTURU as int))
					) as XTABLE
					order by cast(SINAVTARIH as datetime) desc
				END
				IF @ISLEM = 20	--	Ünite Ara
				BEGIN			
					--select AD from dbo.[fn_DersUniteListe](@ID_DERS,@UNITEKOD)

					SELECT AD FROM v3SinavDersUnite
					WHERE KOD = @UNITEKOD

				END
				IF @ISLEM = 21  --  SINAV AKTIF PASIF
				BEGIN
					UPDATE Sinav 
					SET AKTIF=CASE WHEN AKTIF=1 THEN 0 ELSE 1 END
					WHERE ID_SINAV=@ID_SINAV
					select AKTIF from Sinav WHERE ID_SINAV=@ID_SINAV
				END 
				IF @ISLEM = 22  --  Sınav Dosya İçerik
				BEGIN

					declare @SQL varchar(max),@cols varchar(max)--,@ID_SINAVDOSYA int=196,@ID_SINAV int=43
					
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS ##T1
					
					select @ID_SINAV=ID_SINAV FROM SinavDosya WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA

					SELECT 
						 DEGER	= CAST( RTRIM(SUBSTRING(LINE,BASLANGIC , OPTIKKARAKTERSAYISI )) AS varchar(MAX))
						,SO.KOLONADI
						,ID_SINAVOPTIKTEMP
						,SIRA = SO.ID_SINAVOPTIK 
					INTO #TEMP
					FROM SinavOptikTemp		SOT
					JOIN SinavOptikSabit	SOS ON	SOS.ID_SINAV=@ID_SINAV and SOS.OPTIKKARAKTERSAYISI>0
					JOIN SinavOptik			SO	ON	SO.ID_SINAVOPTIK=SOS.ID_SINAVOPTIK
					where ID_SINAVDOSYA=@ID_SINAVDOSYA
					UNION ALL
					select			
						 RTRIM(SUBSTRING(LINE, sod.BASLANGIC, sod.OPTIKKARAKTERSAYISI)) DEGER
						,sd.TAKMAAD KOLONADI
						,ID_SINAVOPTIKTEMP	
						,SIRA = 100 + CAST(SD.BOLUMNO AS INT)
					from SinavOptikTemp			sot
					inner join	SinavDers		sd	on	sd.ID_SINAV=@ID_SINAV
					inner join	SinavOptikDers	sod	on	sod.ID_SINAVDERS=sd.ID_SINAVDERS
					where ID_SINAVDOSYA=@ID_SINAVDOSYA


					SET @cols = STUFF((SELECT DISTINCT ',' + QUOTENAME(c.KOLONADI) 
											FROM #TEMP c
											FOR XML PATH(''), TYPE
											).value('.', 'NVARCHAR(MAX)') 
										,1,1,'')

					SET @SQL='  SELECT * INTO ##T1  FROM ( SELECT DEGER,KOLONADI,ID_SINAVOPTIKTEMP FROM #TEMP ) AS x 
								PIVOT  (MAX(DEGER) FOR KOLONADI IN ('+@cols+')) AS p'
					EXECUTE(@SQL)

					select(
						select * from(
							select 
							(
								select * from ##T1
								FOR JSON AUTO
							) as t1	
							,(
								SELECT KOLONADI FROM #TEMP GROUP BY KOLONADI,SIRA ORDER BY SIRA
								FOR JSON AUTO
							) as t2					
						) as tablo FOR JSON AUTO
					) as tt

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS ##T1


				END 
				IF @ISLEM = 23  --  Sınav Dosya İçerik Düzenle
				BEGIN
					--DECLARE @SQLJSON VARCHAR(MAX)='[{"ID_SINAVOPTIKTEMP":37314,"KOLONADI":"AD","DEGER":"ZİLAN     KARAYİĞİTAS"},{"ID_SINAVOPTIKTEMP":37326,"KOLONADI":"KITAPCIK","DEGER":"A"},{"ID_SINAVOPTIKTEMP":37315,"KOLONADI":"KITAPCIK","DEGER":"A"}]'
					DROP TABLE IF EXISTS #TEMP2
					SELECT
						JSON_Value (j.value, '$.ID_SINAVOPTIKTEMP') as ID_SINAVOPTIKTEMP,
						JSON_Value (j.value, '$.KOLONADI') as KOLONADI, 
						JSON_Value (j.value, '$.DEGER') as DEGER
					INTO #TEMP2
					FROM OPENJSON (@SQLJSON) as j
			
					SELECT @ID_SINAVDOSYA=ID_SINAVDOSYA,@ID_SINAV=ID_SINAV  FROM SinavDosya WHERE ID_SINAVDOSYA =(SELECT ID_SINAVDOSYA FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=(SELECT TOP 1 ID_SINAVOPTIKTEMP FROM #TEMP2))
			
					WHILE ((SELECT COUNT(DISTINCT KOLONADI) FROM #TEMP2)>0)
					BEGIN
						UPDATE	SOT
						SET		
								sot.LINE = STUFF(LINE,SOS.BASLANGIC,SOS.OPTIKKARAKTERSAYISI,LEFT( upper(DEGER)+SPACE(SOS.OPTIKKARAKTERSAYISI),SOS.OPTIKKARAKTERSAYISI))
						FROM	SinavOptikTemp		SOT
						JOIN	#TEMP2				T	ON	T.ID_SINAVOPTIKTEMP	= SOT.ID_SINAVOPTIKTEMP
						JOIN	SinavOptik			SO	ON	SO.KOLONADI			= T.KOLONADI
						JOIN	SinavDosya			SD	ON	SD.ID_SINAVDOSYA	= SOT.ID_SINAVDOSYA
						JOIN	SinavOptikSabit		SOS	ON	SOS.ID_SINAVOPTIK	= SO.ID_SINAVOPTIK
														AND SOS.ID_SINAV		= SD.ID_SINAV
						WHERE	T.KOLONADI=(SELECT TOP 1 KOLONADI FROM #TEMP2 ORDER BY KOLONADI)

						DELETE FROM #TEMP2 WHERE KOLONADI=(SELECT TOP 1 KOLONADI FROM #TEMP2 ORDER BY KOLONADI)
					END
			
					DROP TABLE IF EXISTS #TEMP2			

					UPDATE Sinav SET DURUM=0 WHERE ID_SINAV=@ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR
			
					--EXEC	@return_value = [dbo].[sp_OptikIslemleri]
					--		@ID_SINAV = @ID_SINAV,
					--		@ID_SINAVDOSYA = @ID_SINAVDOSYA,
					--		@ISLEM = 0
			
					select 1
				END 
				IF @ISLEM = 24  --  Öğrenci Listele by ID_SINAV
				BEGIN
					DROP TABLE IF EXISTS #T1

					SELECT	DISTINCT SO.TCKIMLIKNO
							,ISNULL(VK.AD,SO.AD) AD
							,ISNULL(VK.SOYAD,SO.SOYAD) SOYAD
							,ISNULL(VS.SUBEAD,'') SUBEAD
							,ISNULL(VS.SINIF,'') SINIF
					 INTO #T1
					 FROM SinavOgrenci		SO
				LEFT JOIN V3OGRENCi			VO	ON	SO.TCKIMLIKNO	= VO.TCKIMLIKNO
				LEFT JOIN V3Kullanici		VK	ON	VK.TCKIMLIKNO	= SO.TCKIMLIKNO
												AND VK.AKTIF		= 1
				LEFT JOIN vw_SubeGrupSinif	VS	ON	VS.ID_SINIF		= VO.ID_SINIF
					WHERE							SO.ID_SINAV		= @ID_SINAV

					select(
						select * from(
							select 
							(
								select DISTINCT TCKIMLIKNO,AD,SOYAD,SUBEAD,SINIF from #T1
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
			
						DROP TABLE IF EXISTS #T1
				END 
				IF @ISLEM = 25  --  Sınav Özellikleri
				BEGIN
						SELECT 
							 SD.TAKMAAD 
							,SA.SORUNO_A
							,SA.CEVAP
							,SA.SORUNO
							,SA.KOD
							,BILGI = ISNULL(B.AD, '')
							,BILISSELSUREC = ISNULL(BS.AD, '')
							,SA.ID_SORUBANKASI

							,KAZANIM= CASE WHEN LEN(SA.KOD) >0 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SA.KOD								) ELSE '' END
							,UNITE	= CASE WHEN LEN(SA.KOD) >3 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SUBSTRING(SA.KOD ,1,LEN(SA.KOD)-3)	) ELSE '' END
							,KONU	= CASE WHEN LEN(SA.KOD) >6 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SUBSTRING(SA.KOD ,1,LEN(SA.KOD)-6)	) ELSE '' END
					
							,SD.ID_SINAVDERS
							,S.ID_SINAV
							,ISNULL(SOD.OTURUM,1) OTURUM
							,VD.ACIKLAMA DONEM
							,VK.AD GRUP
							,S.AD SINAVAD
							,convert(varchar(15), S.SINAVTARIH, 104) SINAVTARIH
						FROM	Sinav				S
						JOIN	SinavKitapcik		SK	ON	SK.ID_SINAV			= S.ID_SINAV
														AND SK.AD				= IIF (S.ONLINESINAV = 1 ,'A','B')
						JOIN	SinavAnahtar		SA	ON	SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
						JOIN	SinavDers			SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
					LEFT JOIN	SinavOptikDers		SOD	ON	SOD.ID_SINAVDERS	= SD.ID_SINAVDERS
						JOIN	V3AKTiFDONEM		VD	ON	VD.DONEM			= S.DONEM
						JOIN	V3Kademe3			VK	ON	VK.ID_KADEME3		= S.ID_KADEME3		
					LEFT JOIN	Bilgi				B	ON	B.ID_BILGI			= SA.ID_BILGI
					LEFT JOIN	BilisselSurec		BS	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC
						WHERE S.ID_SINAV=@ID_SINAV
						ORDER BY OTURUM,SORUNO_A,SD.BOLUMNO
				END 
				IF @ISLEM = 26  --  Sınav Derslerini Listele
				BEGIN	
					select(
						select * from(
							select 
							(
								SELECT	DISTINCT SD.ID_SINAVDERS, SD.ID_DERS,SD.TAKMAAD DERSAD,BOLUMNO
								FROM	SinavDers	SD	
								WHERE 	SD.ID_SINAV=@ID_SINAV
								ORDER BY BOLUMNO
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END 
				IF @ISLEM = 27  --  Sınav Dersler Sorularını Listele
				BEGIN
					--SELECT	SORUNO,SORUNO_A,CEVAP,SK.AD
					--FROM	SinavDers		SD	
					--JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
					--JOIN	SinavKitapcik	SK	ON	SK.ID_SINAV		= S.ID_SINAV
					--						AND SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
					--WHERE	SD.ID_SINAVDERS = @ID_SINAVDERS		

						DROP TABLE IF EXISTS ##TEMP

						SET @cols2 = STUFF((SELECT distinct ',' + QUOTENAME(SK.AD) 
									FROM SinavDers		SD	
									JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
									JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
									WHERE	SD.ID_SINAVDERS = @ID_SINAVDERS
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SORUNO_A,CEVAP,A,B
								--@SINAVSORUISLEM =1 ise soru işlem tablosuna eklenenler listelenmeyecek 
						set @query = 'SELECT * INTO ##TEMP FROM
						(
							SELECT	SORUNO,SORUNO_A,CEVAP,SK.AD
							FROM	SinavDers		SD	
							JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
							JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
							WHERE	SD.ID_SINAVDERS = '+CAST(@ID_SINAVDERS AS varchar(MAX))+'
							and ('+CAST(@SINAVSORUISLEM AS varchar(MAX))+'=0 OR SA.ID_SINAVANAHTAR not in (select distinct ID_SINAVANAHTAR from SinavSoruIslem))
						) AS xTablo
						PIVOT( MAX(SORUNO) FOR AD IN (' + @cols2 + '))AS p'

						execute(@query)

						select(
							select * from(
								select 
								(
									select * from ##TEMP
									ORDER BY SORUNO_A
									FOR JSON AUTO
								) as t1	,	
								(
									SELECT	DISTINCT SK.AD
									FROM	SinavDers		SD	
									JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
									WHERE	SD.ID_SINAVDERS		=	@ID_SINAVDERS
									FOR JSON AUTO
								) as t2							
							) as tablo FOR JSON AUTO
						) as tt


						DROP TABLE IF EXISTS ##TEMP

				END 
				IF @ISLEM = 28	--	Sınav Listele Pasif Dahil
				BEGIN
					SELECT DISTINCT 
						S.ID_SINAV
						,KOD
						,S.AD
						,K3.AD AS GRUP
						,S.ID_KADEME3
						,Convert(varchar, SINAVTARIH, 103) AS SINAVTARIH
						,DURUM
						,AKTIF 
						,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
						,S.OZEL AS OZEL
						,S.FREKANSHESAPLA AS FREKANSHESAPLA
						,S.PUANGIZLE AS PUANGIZLE
						,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
						,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
						,S.[ONLINESINAV]  AS [ONLINESINAV] 
						,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = S.ID_SINAV) AS HARICIOGRSAY
					FROM Sinav S
					INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
					LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
					WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3
				END
				IF @ISLEM = 29	--	Öğrenci Sil
				BEGIN
					SELECT SO.ID_SINAVOGRENCI, SOT.ID_SINAVOPTIKTEMP 
					INTO #OGRENCIDELETE
					FROM SinavOgrenci SO
					INNER JOIN SinavOptikTemp SOT ON SOT.ID_SINAVOPTIKTEMP = SO.ID_SINAVOPTIKTEMP
					WHERE SO.ID_SINAV = @ID_SINAV AND SO.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON(@TCLIST))
			
					DELETE FROM SinavOgrenci WHERE ID_SINAVOGRENCI IN (SELECT ID_SINAVOGRENCI FROM #OGRENCIDELETE)
					DELETE FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP IN (SELECT ID_SINAVOPTIKTEMP FROM #OGRENCIDELETE)

					DROP TABLE #OGRENCIDELETE

					SELECT 1
				END
				IF @ISLEM = 30	--	Öğrenci Sil
				BEGIN
					UPDATE SinavDers SET TAKMAAD=@TAKMAAD WHERE ID_SINAVDERS=@ID_SINAVDERS
					SELECT 1
				END			
				IF @ISLEM = 31  --  SınavTürü Derslerini Listele
				BEGIN	
					select(
						select * from(
							select 
							(
								SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
								FROM	SinavDers			SD	
								JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV
								JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS 
																AND D.ID_KADEME3= S.ID_KADEME3
								WHERE	S.ID_SINAVTURU	= @ID_SINAVTURU 
									AND S.ID_KADEME3	= @ID_KADEME3ESKI		
									AND (S.DONEM		= @DONEM		OR @DONEM = '' )
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END 
				IF @ISLEM = 32	--	Sınav Listele Değerlendirilmiş
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
							,S.[ONLINESINAV]  AS [ONLINESINAV] 
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3 and S.AKTIF = 1 and S.DURUM=2
							and (OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 33	--	Sınav Türü Listele Gruba Göre
				BEGIN
					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD FROM  Sinav S 
					INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE S.ID_KADEME3 = @ID_KADEME3ESKI AND S.AKTIF=1 AND S.DURUM=2
							and (OZEL=0 OR @OZELSINAVGOR=1)
				END
				IF @ISLEM = 34	--	Sınav Türü Listele Gruba Göre
				BEGIN
					IF (@ID_KADEME3ESKI IS NULL OR @ID_KADEME3ESKI='') AND (@TC_OGRENCI IS NOT NULL AND @TC_OGRENCI != '')
					BEGIN
						SELECT @ID_KADEME3ESKI=S.ID_KADEME3
						FROM OkyanusDB.DBO.v3Ogrenci		O
						JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF=O.ID_SINIF 
						WHERE TCKIMLIKNO=@TC_OGRENCI
					END

					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
					FROM  Sinav S 
					INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE S.ID_KADEME3 = @ID_KADEME3ESKI AND S.AKTIF=1 AND S.DURUM=2 AND S.DONEM=@DONEM
							and (OZEL=0 OR @OZELSINAVGOR=1)
				END
				IF @ISLEM = 35	--	Sınav Listele by Grup
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV
						where s.AKTIF=1 and s.DURUM=2 and s.ID_KADEME3=@ID_KADEME3ESKI
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (cast(@ID_SINAVTURU as int)=0 or s.ID_SINAVTURU=cast(@ID_SINAVTURU as int))
					) as XTABLE
					order by cast(SINAVTARIH as date) desc
				END
				IF @ISLEM = 36	--	Sınav Listele by Grup - ÇOKLU
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV
						where s.AKTIF=1 and s.DURUM=2 and s.ID_KADEME3=@ID_KADEME3ESKI
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
					) as XTABLE
					order by TUR, cast(SINAVTARIH as date) desc
				END
				IF @ISLEM = 37	--	Sınav Özellik Güncelle
				BEGIN
					DECLARE @SQL37 VARCHAR(MAX) ='
						UPDATE Sinav
						SET '+@DURUM+'='+CAST(@DURUMDEGER AS varchar)+'
						WHERE ID_SINAV='+CAST(@ID_SINAV AS varchar)+'
					'
					PRINT (@SQL37)
					EXEC (@SQL37)

					SELECT 1
					
				
				END
				IF @ISLEM = 38	--	Sınav Listele KADEME DONEM
				BEGIN

					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.CEVAPANAHTARIYUKLEMEKAPAT AS CEVAPANAHTARIYUKLEMEKAPAT
							,S.ONLINESINAV AS ONLINESINAV
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = S.ID_SINAV) AS HARICIOGRSAY
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3 and S.AKTIF = 1
						AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 39	--	sınav ders liste
				BEGIN
					SELECT   SD.*
							,SA.SORUNO
							,SA.CEVAP
							,SA.KOD
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'B' ) B_KARSILIK	
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'C' ) C_KARSILIK	
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'D' ) D_KARSILIK		
							,SA.ID_BILGI
							,SA.ID_BILISSELSUREC
							,SA.ID_SORUBANKASI
					FROM Sinav							S
					JOIN SinavDers						SD	ON	SD.ID_SINAV			= S.ID_SINAV
					JOIN OPENJSON (@ID_SINAVDERSLIST)	DL	ON	DL.VALUE			= SD.ID_SINAVDERS
					JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS 
					JOIN SinavKitapcik					SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
															AND	SK.AD				= 'A'
					WHERE	S.ID_SINAV	= @ID_SINAV
					GROUP BY SD.ID_SINAVDERS,BOLUMNO,ID_DERS,TAKMAAD,SD.ID_SINAV,SA.CEVAP,SA.KOD,SA.SORUNO,SA.ID_BILGI,SA.ID_BILISSELSUREC	,SA.ID_SORUBANKASI	
					ORDER BY BOLUMNO,SORUNO
				END
				IF @ISLEM = 40	--	CEVAP ANAHTARI EXCEL YUKLE
				BEGIN
					--declare @SQLJSON varchar(max)= '[{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"1","CEVAP":"B","B_KARSILIK":"20","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"2","CEVAP":"E","B_KARSILIK":"19","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"3","CEVAP":"E","B_KARSILIK":"18","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"4","CEVAP":"A","B_KARSILIK":"17","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001007"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"5","CEVAP":"C","B_KARSILIK":"16","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"6","CEVAP":"D","B_KARSILIK":"15","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL103001019"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"7","CEVAP":"A","B_KARSILIK":"14","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"8","CEVAP":"B","B_KARSILIK":"13","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001005"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"9","CEVAP":"D","B_KARSILIK":"12","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110002001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"10","CEVAP":"D","B_KARSILIK":"11","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL103001008"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"11","CEVAP":"C","B_KARSILIK":"10","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107002011"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"12","CEVAP":"E","B_KARSILIK":"9","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"13","CEVAP":"D","B_KARSILIK":"8","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"14","CEVAP":"A","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"15","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL112001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"16","CEVAP":"B","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL112001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"17","CEVAP":"B","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107002011"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"18","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL105009001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"19","CEVAP":"A","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL105001007"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"20","CEVAP":"C","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001007"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"1","CEVAP":"E","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK316003006"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"2","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK316003003"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"3","CEVAP":"E","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK315002010"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"4","CEVAP":"A","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK314003001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"5","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK317003001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"6","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK313004001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"7","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK315005001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"1","CEVAP":"D","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"2","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ401002001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"3","CEVAP":"B","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ416005001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"4","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"5","CEVAP":"A","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"6","CEVAP":"E","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ406002001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"7","CEVAP":"A","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ406002001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"1","CEVAP":"C","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN804001002"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"2","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN804004004"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"3","CEVAP":"D","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN806006001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"4","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN806008002"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"5","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN805004001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"6","CEVAP":"E","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN502002001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"1","CEVAP":"D","B_KARSILIK":"20","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"2","CEVAP":"B","B_KARSILIK":"19","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"3","CEVAP":"C","B_KARSILIK":"18","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"4","CEVAP":"E","B_KARSILIK":"17","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"5","CEVAP":"D","B_KARSILIK":"16","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201006004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"6","CEVAP":"D","B_KARSILIK":"15","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201006003"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"7","CEVAP":"E","B_KARSILIK":"14","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT203002005"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"8","CEVAP":"E","B_KARSILIK":"13","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT206001001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"9","CEVAP":"C","B_KARSILIK":"12","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001005"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"10","CEVAP":"A","B_KARSILIK":"11","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"11","CEVAP":"E","B_KARSILIK":"10","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"12","CEVAP":"A","B_KARSILIK":"9","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT206001002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"13","CEVAP":"B","B_KARSILIK":"8","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"14","CEVAP":"B","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006007"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"15","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"16","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202003004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"17","CEVAP":"B","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201010001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"18","CEVAP":"B","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"19","CEVAP":"C","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"20","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"1","CEVAP":"C","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607011006"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"2","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ603003001"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"3","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ606002003"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"4","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ608002003"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"5","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607004001"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"6","CEVAP":"B","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ604001002"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"7","CEVAP":"B","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607011006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"1","CEVAP":"A","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM701003005"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"2","CEVAP":"D","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703003001"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"3","CEVAP":"E","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703005006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"4","CEVAP":"B","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM702003004"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"5","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM705008002"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"6","CEVAP":"A","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703005006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"7","CEVAP":"E","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM701006001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"1","CEVAP":"D","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY806001001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"2","CEVAP":"C","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY806001005"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"3","CEVAP":"A","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY807002001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"4","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY804002005"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"5","CEVAP":"E","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY810001001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"6","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY810001004"}]'
				
					DROP TABLE IF EXISTS #SQLJSON
					DROP TABLE IF EXISTS #BKONTROL
					DROP TABLE IF EXISTS #CKONTROL
					DROP TABLE IF EXISTS #DKONTROL


					SELECT ID_SINAVDERS, TAKMAAD, SORUNO, CEVAP, B_KARSILIK,C_KARSILIK,D_KARSILIK, KOD, ID_BILGI, ID_BILISSELSUREC, ID_SORUBANKASI
					INTO #SQLJSON 
					FROM OPENJSON(@SQLJSON)
					with
					(
						ID_SINAVDERS [int],
						TAKMAAD [varchar](MAX),
						SORUNO [int],
						CEVAP [varchar](MAX),
						B_KARSILIK [int],
						C_KARSILIK [int],
						D_KARSILIK [int],
						KOD [varchar](MAX),
						ID_BILGI INT,
						ID_BILISSELSUREC INT,
						ID_SORUBANKASI INT
					) AS J
				
					DECLARE @RESULT BIT = 0
				
					--SELECT SA.CEVAP,SA.SORUNO_A,SA.KOD, '' AS SS, J.SORUNO,J.CEVAP,J.KOD,J.B_KARSILIK,J.C_KARSILIK,J.D_KARSILIK
				
					IF NOT EXISTS (SELECT * FROM #SQLJSON WHERE CEVAP NOT IN ('A','B','C','D','E','F'))
					BEGIN

						UPDATE  SA
						SET
							 SA.CEVAP				= J.CEVAP
							,SA.KOD					= J.KOD
							,SA.ID_BILGI			= J.ID_BILGI 
							,SA.ID_BILISSELSUREC	= J.ID_BILISSELSUREC 
							,SA.ID_SORUBANKASI		= SSD.ID_SORU --J.ID_SORUBANKASI
						FROM SinavDers					SD	
						JOIN #SQLJSON					J	ON	J.ID_SINAVDERS		= SD.ID_SINAVDERS
						JOIN SinavAnahtar				SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
															AND SA.SORUNO_A			= J.SORUNO 
						JOIN SinavKitapcik				SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK 
															AND	SK.AD				= 'A'
					LEFT JOIN SoruBankasi.dbo.Soru		SS	ON	SS.ID_SORU			= J.ID_SORUBANKASI
					LEFT JOIN Sinav						JS	ON	JS.ID_SINAV			= SD.ID_SINAV
					LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON	SSD.ID_SORU			= SS.ID_SORU
															AND JS.ID_KADEME3		= SSD.ID_SINAVGRUP
															AND SSD.SILINDI			= 0
															AND SSD.UNITE			= J.KOD
						WHERE SD.ID_SINAV = @ID_SINAV

						BEGIN	-- KITAPÇIK YANLIŞ KONTROL
					
							SELECT 
									S.SORUNO,
									G.B_KARSILIK,
									G.ID_SINAVDERS,
									COUNT(G.B_KARSILIK) SAY
							INTO #BKONTROL
							FROM #SQLJSON S
					   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.B_KARSILIK 
											AND S.ID_SINAVDERS	= G.ID_SINAVDERS
							GROUP BY 
									S.SORUNO,
									G.B_KARSILIK,
									G.ID_SINAVDERS
							HAVING COUNT(G.B_KARSILIK)=0

				
							SELECT 
									S.SORUNO,
									G.C_KARSILIK,
									G.ID_SINAVDERS,
									COUNT(G.C_KARSILIK) SAY
							INTO #CKONTROL
							FROM #SQLJSON S
					   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.C_KARSILIK 
											AND S.ID_SINAVDERS	= G.ID_SINAVDERS
							GROUP BY 
									S.SORUNO,
									G.C_KARSILIK,
									G.ID_SINAVDERS
							HAVING COUNT(G.C_KARSILIK)=0

				
							SELECT 
								S.SORUNO,
								G.D_KARSILIK,
								G.ID_SINAVDERS,
								COUNT(G.D_KARSILIK) SAY
						INTO #DKONTROL
						FROM #SQLJSON S
				   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.D_KARSILIK 
										AND S.ID_SINAVDERS	= G.ID_SINAVDERS
						GROUP BY 
								S.SORUNO,
								G.D_KARSILIK,
								G.ID_SINAVDERS
						HAVING COUNT(G.D_KARSILIK)=0

						END
					
						IF NOT EXISTS (SELECT * FROM #BKONTROL)
						BEGIN
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.B_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.B_KARSILIK
							FROM	SinavAnahtar		SA
							JOIN	SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'B' 
							JOIN	#SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
															AND J.SORUNO			= SA.SORUNO_A

						END		
					
						IF NOT EXISTS (SELECT * FROM #CKONTROL)
						BEGIN
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.C_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.C_KARSILIK
							FROM SinavAnahtar		SA
							JOIN SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'C' 
							JOIN #SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
														AND J.SORUNO			= SA.SORUNO_A

						END		
					
						IF NOT EXISTS (SELECT * FROM #DKONTROL)
						BEGIN
							
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.D_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.D_KARSILIK
							FROM SinavAnahtar		SA
							JOIN SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'D' 
							JOIN #SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
														AND J.SORUNO			= SA.SORUNO_A
						END

					SET @RESULT = 1

				END
				

					SELECT @RESULT


					DROP TABLE IF EXISTS #SQLJSON
					DROP TABLE IF EXISTS #BKONTROL
					DROP TABLE IF EXISTS #CKONTROL
					DROP TABLE IF EXISTS #DKONTROL


				END
				IF @ISLEM = 41	--	Sınav/Yazılı Listele Tarihe Göre
				BEGIN

						SELECT ID_SINAV,S.AD,K.ID_KADEME3, K.AD KADEME3, S.ID_SINAVTURU, ST.KISAAD SINAVTURU
						INTO #SINAVLISTESI
						FROM Sinav		S
						JOIN v3Kademe3	K	ON	K.ID_KADEME3	= S.ID_KADEME3
						JOIN SinavTuru	ST	ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
						WHERE	S.SINAVTARIH	= @TARIH
							AND S.DONEM			= @DONEM
							AND (K.ID_KADEME3	= @ID_KADEME3 OR @ID_KADEME3 = 0 OR @ID_KADEME3 IS NULL )
							AND	S.AKTIF			= 1
					UNION ALL
						SELECT ID_YAZILI,Y.AD,K.ID_KADEME3, K.AD KADEME3, 0 ID_SINAVTURU,'YZL' SINAVTURU
						FROM Yazili		Y
						JOIN v3Kademe3	K	ON	K.ID_KADEME3	= Y.ID_KADEME3
						WHERE	Y.YAZILITARIH	= @TARIH
							AND Y.DONEM			= @DONEM
							AND (K.ID_KADEME3	= @ID_KADEME3 OR @ID_KADEME3 = 0 OR @ID_KADEME3 IS NULL )
							AND	Y.AKTIF			= 1
					ORDER BY ID_KADEME3 

					SELECT (
						SELECT *
						FROM #SINAVLISTESI
						for json path, INCLUDE_NULL_VALUES 
					)AS SINAVLISTESI

					DROP TABLE #SINAVLISTESI					

				END
				IF @ISLEM = 42	--	Bursluluk Dosya Liste
				BEGIN

					SELECT ISNULL(
						(	SELECT *
							FROM BurslulukDosya
							WHERE (DONEM = @DONEM OR ((@DONEM IS NULL OR @DONEM = '') AND (@DONEM =@AKTIFDONEM )))
								AND AKTIF = 1
							for json auto
						)
					,'[]')AS DOSYALISTESI

				END
				IF @ISLEM = 43	--	Sınav Listele Multi Sınav Turu
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
							,S.ONLINESINAV  AS ONLINESINAV 
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM 
						and S.ID_KADEME3 = @ID_KADEME3ESKI 
						and (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
						and S.AKTIF = 1 
						and S.DURUM = 2
						and (OZEL = 0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 44	--	AYT için TYT Seçim Türü
				BEGIN
					SELECT 
					(
						SELECT DISTINCT TST.ID_TYTSECIMTUR, TST.AD, CASE WHEN STST.ID_SINAV IS NULL THEN 0 ELSE 1 END SELECTED, ISNULL(STST.PUAN, 0) AS PUAN
						FROM TYTSecimTur TST
						LEFT JOIN SinavTYTSecimTurKriter STST ON STST.ID_TYTSECIMTUR = TST.ID_TYTSECIMTUR AND STST.ID_SINAV = @ID_SINAV
						FOR JSON PATH
					)
				END
				IF @ISLEM = 45	--	AYT için TYT Seçim Kriter Kaydet
				BEGIN
					DELETE FROM SinavTYTSecimTurKriter WHERE ID_SINAV = @ID_SINAV

					INSERT INTO SinavTYTSecimTurKriter (ID_SINAV, ID_TYTSECIMTUR, PUAN)
					VALUES (@ID_SINAV, @ID_TYTSECIMTUR, ISNULL(REPLACE(@BARAJ,',','.'),0.0))
				END
				IF @ISLEM = 46	--	SORU BANKASI SORU LISTESI
				BEGIN
					DECLARE		@DISPLAYLENGTH		INT				= 0,
								@DISPLAYSTART		INT				= 0,
								@WHERECLAUSE		VARCHAR(MAX)	= '',
								@ORDERBYCLAUSE		VARCHAR(MAX)	= '',
								@FILTER				VARCHAR(MAX)	= '',
								@TABLENAME			VARCHAR(MAX)	= 'vw_Soru',
								@COLUMNNAME			VARCHAR(MAX)	= '',
								@COLUMNS			VARCHAR(MAX)	= ''	

					SET @COLUMNNAME		= (SELECT COLUMN_NAME FROM SoruBankasi.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = @TABLENAME AND TABLE_SCHEMA='dbo' AND ORDINAL_POSITION = (SELECT CASE WHEN JSON_Value (VALUE, '$.column') = '0' THEN '1' ELSE JSON_Value (VALUE, '$.column') END FROM OPENJSON(@SQLJSON,'$.order')))

					SET @ORDERBYCLAUSE	= (SELECT ' ORDER BY '+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
					SET @WHERECLAUSE	= (SELECT value FROM OPENJSON(@SQLJSON, '$.search') WITH (value VARCHAR(MAX)))
					SET @DISPLAYSTART	= (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT)) + 1
					SET @DISPLAYLENGTH	= (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT)) - 1

					IF	@WHERECLAUSE=''
					BEGIN
						SET @WHERECLAUSE = '
							WHERE	SILINDI			= 0  
								AND ID_HAREKETDURUM	= 13 
								AND ID_SORUTUR		= 4								
								AND (SNV.ID_SINAV	= ' + CAST(@ID_SINAV AS VARCHAR) + ' OR ' + CAST(@ID_SINAV AS VARCHAR) + ' = 0)
								AND (	(	(''' + @KOD + ''' IS NULL OR ''' + @KOD + ''' = '''') 
										AND X.ID_DERS	= ' + CAST(@ID_DERS AS VARCHAR) + '
										)
									OR ((''' + @KOD + ''' IS not NULL and ''' + @KOD + ''' != '''') and (X.UNITE LIKE ''%' + @KOD + '%''))
								)'								
								--AND SNV.ID_SINAV	= ' + CAST(@ID_SINAV AS VARCHAR) + '
								--AND UNITE			= ''' + @KOD +''''
					END
					ELSE
					BEGIN
						SET @COLUMNS = ''
				
						SET @COLUMNS = '(U.AD LIKE ''%' + @WHERECLAUSE + '%'' OR ' + (SELECT ' X.' + COLUMN_NAME + ' LIKE ''%' + @WHERECLAUSE + '%'' OR' AS [text()] 
											FROM SoruBankasi.INFORMATION_SCHEMA.COLUMNS 
											WHERE	TABLE_NAME		= @TABLENAME 
												AND TABLE_SCHEMA	= 'dbo'
											FOR XML PATH ('')) + ')'

						SET @COLUMNS = SUBSTRING(@COLUMNS, 1, LEN(@COLUMNS)-3) + ') '
						SET @WHERECLAUSE = 'WHERE ' + @COLUMNS

						SET @WHERECLAUSE = @WHERECLAUSE + '	
								AND	X.SILINDI			= 0  
								AND X.ID_HAREKETDURUM	= 13 
								AND X.ID_SORUTUR		= 4
								AND SNV.ID_SINAV		= ' + CAST(@ID_SINAV AS VARCHAR) + ' 
								AND (''' + @KOD + ''' IS NULL OR ''' + @KOD + ''' = '''' OR X.UNITE LIKE ''%' + @KOD + '%'') '
					END

					DECLARE @LINK VARCHAR(MAX)=  'SoruBankasi/'
					SET @QUERY='
								SELECT * INTO #TEMP FROM   
								(
									SELECT ROW_NUMBER() OVER(' + @ORDERBYCLAUSE + ') AS RowNumber, * 
									FROM(
										SELECT DISTINCT X.*,UNITEKOD = U.KOD, UNITEAD = U.AD
										FROM ' + @TABLENAME + ' X
										JOIN Sinav				SNV	ON	SNV.ID_KADEME3	= X.ID_SINAVGRUP
										JOIN OkyanusDB.dbo.v3SinavDersUnite U ON U.KOD	= X.UNITE
										' + @WHERECLAUSE + '
									) 
								RawResults) DATA 


								DECLARE @DATA VARCHAR(MAX)=(
										SELECT	RowNumber
												,ID_SORU
												,UNITEKOD
												,UNITEAD
												,	''Soru Türü: '' + ISNULL(SORUTUR, '''') + ''<br />'' +
													''Grup: '' + ISNULL(SINAVGRUP, '''') + ''<br />'' +
													''Ders: '' + ISNULL(DERSAD, '''') + ''<br />'' +
													''Zorluk: '' + ISNULL(ZORLUKTUR, '''') + ''<br />'' +
													''Durum: '' + ISNULL(HAREKETDURUM, '''') + ''<br />'' +
													''Yazar: '' + ISNULL(KULLANICIAD, '''') + ''<br />'' +
													''Tarih: '' + CONVERT(VARCHAR, KYE_TARIH, 104)+ ''<br />'' +
													''Kod: '' + ISNULL(UNITEKOD, '''')  AS SORUBILGILERI 
												,SORUHTML	= (SELECT '''+ @LINK +''' + SORUHTML FROM SoruBankasi.dbo.SoruHtml WHERE ID_SORU = S.ID_SORU AND ID_TASLAKTUR=20) 
												,CEVAP		= (SELECT CEVAPNO,'''+ @LINK +''' + CEVAPHTML AS CEVAPHTML, DEGER FROM SoruBankasi.dbo.CEVAP WHERE ID_SORU = S.ID_SORU ORDER BY ID_CEVAP FOR JSON PATH, INCLUDE_NULL_VALUES) 
												,ID_SORUTUR
												,USTSORUHTML= CASE	WHEN ID_USTSORU IS NOT NULL THEN (SELECT SORUHTML FROM SoruBankasi.dbo.SoruHtml WHERE ID_SORU = S.ID_USTSORU AND ID_TASLAKTUR=20) 
																	ELSE '''' 
																END 
												,COZUM		= (SELECT COZUMHTML, ID_COZUMTUR FROM SoruBankasi.dbo.SoruCozum WHERE ID_SORU = S.ID_SORU ORDER BY SIRA FOR JSON PATH, INCLUDE_NULL_VALUES)
												,KULLANIM	= (	SELECT SN.AD, CONVERT(VARCHAR, SN.KYE_TARIH, 104) AS KYE_TARIH, SS.KITAPCIK, SS.SORUNO FROM SoruBankasi.dbo.SinavSoru SS
																	INNER JOIN SoruBankasi.dbo.Sinav SN ON SN.ID_SINAV = SS.ID_SINAV
																	WHERE SN.SILINDI = 0 AND SS.ID_SORU = S.ID_SORU 
																	ORDER BY SS.KITAPCIK
																	FOR JSON PATH, INCLUDE_NULL_VALUES)
												,ID_HAREKETDURUM
												,ALTSORU = (SELECT SUBS.ID_SORU, SORUTUR, DERSAD, ZORLUKTUR FROM '+@TABLENAME+' SUBS
															WHERE SUBS.ID_USTSORU = S.ID_SORU
															FOR JSON PATH, INCLUDE_NULL_VALUES)
												,SORUTUR, DERSAD, ZORLUKTUR
												,SORUGECMIS = ISNULL((
													SELECT DISTINCT SN.ID_SINAV, SN.DONEM, SN.AD SINAVAD, ST.KISAAD SINAVTURU, SN.SINAVTARIH
													FROM Pusulam.dbo.Sinav			SN
													JOIN Pusulam.dbo.SinavTuru		ST	ON	ST.ID_SINAVTURU	= SN.ID_SINAVTURU
													JOIN Pusulam.dbo.SinavDers		SD	ON	SD.ID_SINAV		= SN.ID_SINAV
													JOIN Pusulam.dbo.SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
													WHERE SA.ID_SORUBANKASI = S.ID_SORU
													ORDER BY SN.DONEM DESC, SN.SINAVTARIH
													FOR JSON PATH										
												),''[]'')
												,ID_SORUDUZEY
										FROM #TEMP S
										WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX), @DISPLAYSTART)+' AND '+CONVERT(VARCHAR(MAX), (@DISPLAYSTART + @DISPLAYLENGTH))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
								)

								SELECT(
									SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
									(SELECT COUNT(*) FROM ' + @TABLENAME + ') AS recordsTotal, 
									(SELECT COUNT(*) FROM #TEMP) AS recordsFiltered, 
									@DATA AS data FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS JSONDATA

								DROP TABLE #TEMP
					'
					print @QUERY
					EXECUTE (@QUERY)
				

				END
				IF @ISLEM = 47	--	SORU BANKASI ID KONTROL
				BEGIN
					SELECT ISNULL((
							SELECT S.ID_SORU, UNITEKOD = U.KOD, UNITEAD = U.AD, S.ID_SORUDUZEY, CEVAP = (SELECT CASE CEVAPNO WHEN 1 THEN 'A' WHEN 2 THEN 'B' WHEN 3 THEN 'C' WHEN 4 THEN 'D' WHEN 5 THEN 'E' ELSE '' END FROM SoruBankasi.dbo.CEVAP WHERE ID_SORU = S.ID_SORU AND DEGER = 1)
												,SORUGECMIS = ISNULL((
													SELECT DISTINCT SN.ID_SINAV, SN.DONEM, SN.AD SINAVAD, ST.KISAAD SINAVTURU, SN.SINAVTARIH
													FROM Pusulam.dbo.Sinav			SN
													JOIN Pusulam.dbo.SinavTuru		ST	ON	ST.ID_SINAVTURU	= SN.ID_SINAVTURU
													JOIN Pusulam.dbo.SinavDers		SD	ON	SD.ID_SINAV		= SN.ID_SINAV
													JOIN Pusulam.dbo.SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
													WHERE SA.ID_SORUBANKASI = S.ID_SORU
													ORDER BY SN.DONEM DESC, SN.SINAVTARIH
													FOR JSON PATH										
												),'[]')
							FROM vw_Soru						S 
							JOIN Sinav							SNV	ON	SNV.ID_KADEME3	= S.ID_SINAVGRUP
							JOIN OkyanusDB.dbo.v3SinavDersUnite	U	ON	U.KOD			= S.UNITE
							WHERE	S.ID_SORU		= @ID_SORUBANKASI
								AND	S.SILINDI		= 0
								AND SNV.ID_SINAV	= @ID_SINAV
								AND S.ID_SORUTUR	= 4
								AND	(@UNITEKOD	IS NULL OR @UNITEKOD ='' OR S.UNITE = @UNITEKOD)
							FOR JSON PATH
					),'[]')
				END
				IF @ISLEM = 48	--	ONLINE SINAV OPTIK HAZIRLAMA
				BEGIN
					
					DROP TABLE IF EXISTS #SinavOptikSabit
					DROP TABLE IF EXISTS #SinavOptikDers
					DROP TABLE IF EXISTS #OGRENCILIST
					DROP TABLE IF EXISTS #LINE

					SELECT	 SOS.ID_SINAVOPTIK
							,SOS.BASLANGIC
							,SOS.OPTIKKARAKTERSAYISI
					INTO #SinavOptikSabit
					FROM Sinav				S
					JOIN SinavOptikSabit	SOS	ON	SOS.ID_SINAV	= S.ID_SINAV
					WHERE S.ID_SINAV = @ID_SINAV


					SELECT	 SD.BOLUMNO
							,SD.ID_SINAVDERS
							,SOD.OTURUM
							,SOD.BASLANGIC
							,SOD.OPTIKKARAKTERSAYISI
					INTO #SinavOptikDers
					FROM Sinav			S
					JOIN SinavDers		SD	ON	SD.ID_SINAV		= S.ID_SINAV
					JOIN SinavOptikDers	SOD	ON	SOD.ID_SINAVDERS= SD.ID_SINAVDERS
					WHERE	S.ID_SINAV	= @ID_SINAV
						--AND SOD.OTURUM	= @SINAVOTURUM
					ORDER BY BASLANGIC


					SELECT DISTINCT SO.TCKIMLIKNO
					INTO #OGRENCILIST
					FROM Tbl_OnlineSinavOgrenci			SO
					JOIN Tbl_OnlineSinavOgrenciCevap	SOC	ON	SOC.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
					WHERE	SO.ID_SINAV = @ID_SINAV
						AND SO.AKTIF	= 1
						AND SOC.AKTIF	= 1


					--DECLARE @BOSLUKSAYISI	INT	= (SELECT TOP 1 BASLANGIC + OPTIKKARAKTERSAYISI FROM #SinavOptikSabit ORDER BY BASLANGIC DESC)
					DECLARE @BOSLUKSAYISI	INT	= (SELECT TOP 1 BASLANGIC FROM #SinavOptikDers ORDER BY BASLANGIC)
					DECLARE @TCSIRASI		INT	= (SELECT BASLANGIC FROM #SinavOptikSabit WHERE ID_SINAVOPTIK = 1)
					DECLARE @KITAPCIKSIRASI	INT	= (SELECT BASLANGIC FROM #SinavOptikSabit WHERE ID_SINAVOPTIK = 4)

					SELECT LINE = STUFF(dbo.fn_BoslukBirak(@TCSIRASI - 1) + SO.TCKIMLIKNO + dbo.fn_BoslukBirak(@BOSLUKSAYISI - (@TCSIRASI + 11)), @KITAPCIKSIRASI, 1, 'A')
						,SOD.BASLANGIC
						,TEST = IIF( SOD.OTURUM = @SINAVOTURUM, (ISNULL(REPLACE(STUFF((		
									SELECT IIF( C.CEVAPNO IS NOT NULL
												,  CASE WHEN C.CEVAPNO = 1 THEN 'A'
														WHEN C.CEVAPNO = 2 THEN 'B'
														WHEN C.CEVAPNO = 3 THEN 'C'
														WHEN C.CEVAPNO = 4 THEN 'D'
														WHEN C.CEVAPNO = 5 THEN 'E'
														ELSE '-'
													END
												, '-')
									FROM SinavAnahtar						SA	
									LEFT JOIN Tbl_OnlineSinavOgrenciCevap	OC	ON	OC.ID_ONLINESINAVOGRENCI= SO.ID_ONLINESINAVOGRENCI
																				AND SA.ID_SINAVANAHTAR		= OC.ID_SINAVANAHTAR
																				AND OC.AKTIF				= 1
									LEFT JOIN SoruBankasi..Cevap			C	ON	C.ID_SORU				= SA.ID_SORUBANKASI
																				AND C.ID_CEVAP				= OC.ID_CEVAP				
									WHERE	SA.ID_SINAVDERS	= SOD.ID_SINAVDERS
									ORDER BY SA.SORUNO_A
									FOR XML PATH('')
							), 1, 0, ''), '-', ' '), dbo.fn_BoslukBirak(SOD.OPTIKKARAKTERSAYISI)))
						,dbo.fn_BoslukBirak(SOD.OPTIKKARAKTERSAYISI))
					INTO #LINE
					FROM Tbl_OnlineSinavOgrenci	SO
					JOIN #OGRENCILIST			OL	ON	OL.TCKIMLIKNO	= SO.TCKIMLIKNO
					JOIN SinavDers				SD	ON	SD.ID_SINAV		= SO.ID_SINAV
					JOIN #SinavOptikDers		SOD	ON	SOD.BOLUMNO		= SD.BOLUMNO
					WHERE	SO.ID_SINAV = @ID_SINAV
						AND SO.AKTIF	= 1
	
					DECLARE @cols48 NVARCHAR(MAX) = NULL
					DECLARE @sels48 NVARCHAR(MAX) = NULL
					DECLARE @sql48 NVARCHAR(MAX) = NULL

					SET @cols48 = STUFF((	SELECT ',' +  QUOTENAME( C.BASLANGIC)  FROM #SinavOptikDers c ORDER BY C.BASLANGIC FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
					SET @sels48 = STUFF((	SELECT '+' +  QUOTENAME( C.BASLANGIC)  FROM #SinavOptikDers c ORDER BY C.BASLANGIC FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')	
					--SET @sql48 = '
					--	SELECT LINE = LINE + '+@sels48+'
					--	FROM #LINE
					--	PIVOT ( MAX(TEST) FOR BASLANGIC IN(' + @cols48 + ') ) P
					--	ORDER BY LINE
					--'

					
					SET @sql48 = '
						DROP TABLE IF EXISTS #TEMP
						SELECT LINE = LINE + '+@sels48+' , RN = ROW_NUMBER() OVER(ORDER BY LINE)
						INTO #TEMP
						FROM #LINE
						PIVOT ( MAX(TEST) FOR BASLANGIC IN(' + @cols48 + ') ) P
						ORDER BY LINE

						DECLARE @TEKSATIR NVARCHAR(MAX) = ''''
						IF '+CAST(@MAIL AS VARCHAR)+' = CAST(1 AS BIT)
						BEGIN
							SELECT REPLACE(LINE,'' '',''&nbsp;''),RN FROM #TEMP ORDER BY RN
						END
						ELSE
						BEGIN
							WHILE EXISTS(SELECT TOP 1 1 FROM #TEMP)
							BEGIN
								DECLARE @RN INT = (SELECT TOP 1 RN FROM #TEMP ORDER BY RN)
								SET @TEKSATIR += (SELECT LINE + IIF(EXISTS(SELECT TOP 1 1 FROM #TEMP WHERE RN != @RN) , CHAR(13) + CHAR(10), '''') FROM #TEMP WHERE RN = @RN) 
								DELETE FROM #TEMP WHERE RN = @RN
							END
							SELECT @TEKSATIR
						END
					'

					EXEC (@sql48)

					
					DROP TABLE IF EXISTS #SinavOptikSabit
					DROP TABLE IF EXISTS #SinavOptikDers
					DROP TABLE IF EXISTS #OGRENCILIST
					DROP TABLE IF EXISTS #LINE

				END
				IF @ISLEM = 49  --  SINAV DÜZENLE YETKİ KONTROL 
				BEGIN

					-- BUNU SINAV DÜZENLEMEYE KOPYALA
					--EXEC sp_Sinav @TCKIMLIKNO = @TCKIMLIKNO , @OTURUM = @OTURUM, @ID_MENU = @ID_MENU, @ISLEM = 49, @ID_SINAV = @ID_SINAV


					--'YETKİNİZ YOK'	0
					--'SINAV BAŞLAMADI' 1
					--'SINAV BAŞLADI'	2
					DECLARE @SONUC INT = 1
					IF EXISTS (SELECT TOP 1 1 FROM Sinav WHERE ID_SINAV = @ID_SINAV AND ONLINESINAV = 1)
					BEGIN
						IF	EXISTS( SELECT VALUE FROM fn_Split((SELECT DEGER FROM ParametreDeger WHERE ID_PARAMETREDEGER = 4), ',', NULL ) WHERE VALUE = @TCKIMLIKNO)
						BEGIN					
					
							-- sınav başladı
							-- tc yetkisi var mı 

							IF EXISTS (	SELECT TOP 1 1 
										FROM Sinav S 
										JOIN Tbl_OnlineSinavDetay		D	ON	D.ID_SINAV				= S.ID_SINAV 
																			AND D.AKTIF					= 1
										JOIN Tbl_OnlineSinavDetayOturum	DO	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
										WHERE	S.ID_SINAV		= @ID_SINAV 
											AND S.ONLINESINAV	= 1 
											AND DO.BASTARIH		< GETDATE()
										)
							BEGIN
								SET @SONUC = 2
							END
						END
						ELSE
						BEGIN
							SET @SONUC = 0
						END
					END

					SELECT @SONUC
				END

				-- GENEL 
				DROP TABLE IF EXISTS #KADEMELER
				DROP TABLE IF EXISTS #OTURUMLAR
			--END

			
		END
	
		--COMMIT TRANSACTION [Tran1]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [Tran1]
		IF @ISLEM IN (14, 17)	--	DOSYA YÜKLEME
		BEGIN
			UPDATE Sinav			SET DURUM = 0, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV
		END

		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YaziliYoklama]...';


GO
ALTER procedure [dbo].[sp_YaziliYoklama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@ID_KADEME2				VARCHAR(MAX)	= NULL,
	@ID_DERSLER				VARCHAR(MAX)	= NULL,
	@SINIFLAR				VARCHAR(MAX)	= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_YAZILI				INT				= NULL,
	@DONEM					char(4)			= NULL,
	@YARIYIL				TINYINT			= NULL,
	@PASIF					BIT				= NULL,
	@TAKMAAD				VARCHAR(MAX)	= NULL,
	@ID_DERS				INT				= NULL,
	@ID_SINIF				INT				= NULL,	
	@SQLJSON		 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCI 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCICEVAP	NVARCHAR(MAX)	= NULL,
	@OVGORSUN				BIT				= NULL,
	@AKTIF					BIT				= NULL,
	@KARNEDEGORUNSUN		BIT				= NULL
AS
BEGIN
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
		IF @return_variable = 1
		BEGIN

			IF @ISLEM = 1	--	KADEME 3 Listele
			BEGIN
				SELECT
				(
					SELECT DISTINCT st.ID_KADEME3, k.AD
					FROM		  [dbo].[v3Sinif]			s
					INNER JOIN	  [dbo].[v3Donem]			d		ON d.ID_DONEM		=	s.ID_DONEM
					INNER JOIN	  [dbo].[v3AktifDonem]		ad		ON ad.DONEM			=	d.KOD			and ad.AKTIF=1
					INNER JOIN	  [dbo].[v3SatisTuru]		st		ON st.ID_SATISTURU	=	s.ID_SATISTURU
					INNER JOIN	  [dbo].[v3Kademe3]			k		ON k.ID_KADEME3		=	st.ID_KADEME3
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 2	--	KADEME 2 LİSTELE
			BEGIN
				SELECT
				(
					SELECT KB.ID_KADEME2, K2.AD FROM OkyanusDB.dbo.v3KademeBilgi KB
					INNER JOIN OkyanusDB.dbo.v3Kademe2 K2 ON K2.ID_KADEME2=KB.ID_KADEME2
					where ID_KADEME3 = @ID_KADEME3
					FOR JSON PATH
				) AS J
			END	

			IF @ISLEM = 3	--	EKLE
			BEGIN
				----------
				--YAZILI--
				----------
				DECLARE @ID_YAZILILIST TABLE (ID_YAZILI INT)
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI INTO @ID_YAZILILIST(ID_YAZILI)
				select		[AD] ,[KOD] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM], YARIYIL, [ID_KADEME3], ID_DERS, convert(datetime, [YAZILITARIH], 103), @TCKIMLIKNO, [ID_YAZILITURU]
				from OPENJSON(@SQLJSON)
				with
				(
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) AS J

				-----------------
				--YAZILIKADEME2--
				-----------------
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select (select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')
									
				-----------
				--SORULAR--
				-----------
				INSERT INTO [dbo].[YaziliSoru]
						   ([ID_YAZILI]
						   ,[SORUNO]
						   ,[PUAN]
						   ,[KOD]
						   ,[ID_BILGI]
						   ,[ID_BILISSELSUREC])
				SELECT
					(select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI]
					,JSON_Value (s.value, '$.SORUNO') as SORUNO
					,ISNULL(CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.')), 0) as PUAN
					,JSON_Value (s.value, '$.KOD') as KOD
					,CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END AS ID_BILGI
					,CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END AS ID_BILISSELSUREC
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
			
				select ID_YAZILI from @ID_YAZILILIST	
			END

			IF @ISLEM = 4	--	GÜNCELLE
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILI
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILI TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				UPDATE	 SORU SET SORU.PUAN = CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.'))
						,SORU.KOD = JSON_Value (s.value, '$.KOD')
						,SORU.ID_BILGI = CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END
						,SORU.ID_BILISSELSUREC = CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
				INNER JOIN YaziliSoru SORU ON SORU.ID_YAZILI = @ID_YAZILI AND SORU.SORUNO = JSON_Value (s.value, '$.SORUNO')
				
				DROP TABLE #TEMPYAZILI
				select @ID_YAZILI	
			END

			IF @ISLEM = 5	--	BİLGİ GETİR
			BEGIN
				SELECT 
				(
					SELECT * FROM
					(
						Select (
							Select  
								s.AD as AD, 
								s.KOD, 
								ID_KADEME3, 
								Convert(varchar, YAZILITARIH, 103) as YAZILITARIH,
								s.ID_DERS,
								(SELECT COUNT(*) FROM YaziliSoru YS WHERE YS.ID_YAZILI=s.ID_YAZILI) as SORUSAYISI,
								SORULIST.SORUNO as SORUNO,
								SORULIST.KOD,
								UNITE = ISNULL(SD.AD, ''), 
								SORULIST.PUAN,
								s.YARIYIL,
								s.ID_YAZILITURU,
								ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
								ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC
							from	   Yazili			s
							LEFT join YaziliSoru		SORULIST		on	SORULIST.ID_YAZILI		= s.ID_YAZILI 
							LEFT JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
							where s.ID_YAZILI = @ID_YAZILI
						for json auto) as T1
						,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON AUTO) AS T2
					) AS XTABLE
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 6	--	LISTELE
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_YAZILI
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, YAZILITARIH, 104) AS YAZILITARIH
							,AKTIF 
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM YaziliOgrenci WHERE ID_YAZILI = S.ID_YAZILI GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,OVGORSUN
							,KARNEDEGORUNSUN,
							ID_YAZILITURU
						FROM Yazili S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN YaziliKademe2 K2 ON K2.ID_YAZILI = S.ID_YAZILI
						WHERE	DONEM = @DONEM 
						AND		(@YARIYIL = 0 OR YARIYIL = @YARIYIL)
						AND		(@ID_KADEME3 = 0 OR S.ID_KADEME3 = @ID_KADEME3)
						AND		(@ID_KADEME2 = '[]' OR K2.ID_KADEME2 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME2)) or 0 in (SELECT VALUE FROM OPENJSON(@ID_KADEME2)))
						AND		(S.AKTIF = 1 OR @PASIF = 1)
						AND		(@ID_DERS = 0 OR S.ID_DERS = @ID_DERS)
					)XTABLE
					ORDER BY Convert(datetime, YAZILITARIH, 104) DESC
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 7	--	AKTİF PASİF
			BEGIN
				DECLARE @DURUM BIT = (SELECT CASE WHEN AKTIF = 1 THEN 0 ELSE 1 END FROM Yazili WHERE ID_YAZILI = @ID_YAZILI)
				UPDATE Yazili SET AKTIF = @DURUM, GUN_TCKIMLIKNO = @TCKIMLIKNO, GUN_TARIH = GETDATE() WHERE ID_YAZILI = @ID_YAZILI
				SELECT @DURUM
			END

			IF @ISLEM = 8	--	ÖĞRENCİ LİSTELE
			BEGIN
				--DECLARE @KUR BIT = (
				--			SELECT D.KUR FROM Yazili Y
				--			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--			WHERE ID_YAZILI = @ID_YAZILI
				--		)

				SELECT X.TCKIMLIKNO, X.AD, X.SOYAD, YOC.ID_YAZILIOGRENCI, X.ID_YAZILI, X.ID_YAZILISORU, X.SORUNO, X.PUAN AS MAXPUAN, ISNULL(YOC.PUAN, 0) AS PUAN, ISNULL(YO.KATILMADI, 0) AS KATILMADI, YO.TELAFI
				INTO #TEMP
				FROM
				(
					SELECT * FROM
					(
						SELECT Y.ID_YAZILI, YS.ID_YAZILISORU, YS.SORUNO, YS.PUAN 
						FROM Yazili Y
						INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
						WHERE Y.ID_YAZILI = @ID_YAZILI
					) AS T1
					CROSS JOIN 
					(
						SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDb.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
						WHERE S.ID_SINIF = @ID_SINIF --AND @KUR = 0
					UNION 
						SELECT DISTINCT K.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDB.dbo.v4SinifOgrenci SO 
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= SO.TC_OGRENCI
						WHERE SO.ID_SINIF = @ID_SINIF AND SO.AKTIF = 1
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM OkyanusDb.dbo.v3OgrenciTumKur O
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					--	INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
					--	WHERE S.ID_SINIF = @ID_SINIF AND @KUR = 1
					--UNION 
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM eokul_v2.dbo.KurOgrenci			KO
					--	INNER JOIN OkyanusDB.dbo.v3OgrenciTum		O	ON	O.ID_OGRENCI	= KO.ID_OGRENCI
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
					--	WHERE KO.ID_KUR = @ID_SINIF
					) AS T2
				) AS X
				LEFT JOIN YaziliOgrenci YO ON YO.ID_YAZILI = X.ID_YAZILI AND YO.TCKIMLIKNO = X.TCKIMLIKNO AND AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = X.ID_YAZILISORU

				SELECT
				(
					SELECT
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILISORU, SORUNO, PUAN, MAXPUAN FROM #TEMP					
						ORDER BY TCKIMLIKNO, SORUNO
						FOR JSON PATH
					) AS T1,
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI, COUNT(DISTINCT ID_YAZILISORU) AS SORUSAYISI 
						FROM #TEMP
						GROUP BY TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI
						ORDER BY TCKIMLIKNO
						FOR JSON PATH
					) AS T2
					FOR JSON PATH
				) AS J

				DROP TABLE #TEMP
			END

			IF @ISLEM = 9	--	KOPYALA
			BEGIN
				DECLARE @ID_YAZILILISTX TABLE (ID_YAZILI INT)
				INSERT INTO Yazili ([AD],[KOD],[DONEM],[YARIYIL],[ID_YAZILITURU],[ID_KADEME3],[ID_DERS],[YAZILITARIH],[KYE_TCKIMLIKNO],[KYE_TARIH],[AKTIF],[GUN_TARIH],[GUN_TCKIMLIKNO])
				OUTPUT inserted.ID_YAZILI INTO @ID_YAZILILISTX
				SELECT [AD]
					  ,[KOD]
					  ,[DONEM]
					  ,[YARIYIL]
					  ,[ID_YAZILITURU]
					  ,[ID_KADEME3]
					  ,[ID_DERS]
					  ,[YAZILITARIH]
					  ,@TCKIMLIKNO
					  ,GETDATE()
					  ,1
					  ,GETDATE()
					  ,'' 
				FROM Yazili 
				WHERE ID_YAZILI = @ID_YAZILI

				DECLARE @ID_YAZILIX INT = (SELECT ID_YAZILI FROM @ID_YAZILILISTX)  

				INSERT INTO YaziliKademe2 ([ID_YAZILI],[ID_KADEME2])
				SELECT @ID_YAZILIX
					  ,[ID_KADEME2] 
				FROM YaziliKademe2 
				WHERE ID_YAZILI = @ID_YAZILI
			
				INSERT INTO YaziliSoru ([ID_YAZILI],[SORUNO],[PUAN],[KOD])
				SELECT (SELECT ID_YAZILI FROM @ID_YAZILILISTX) AS ID_YAZILI
					  ,[SORUNO]
					  ,[PUAN]
					  ,[KOD] 
				FROM YaziliSoru YS
				WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 10	--	BİLGİ GETİR LİSTE
			BEGIN
				SELECT
				(
					SELECT DONEM
							,ID_KADEME3
							,ID_DERS
							,YARIYIL
							,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON PATH) AS ID_KADEME2 
					FROM Yazili 
					WHERE ID_YAZILI = @ID_YAZILI
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 11	--	LİSTELE SELECT
			BEGIN
				SELECT
				(
					SELECT Y.ID_YAZILI, Y.AD, Y.KOD 
					FROM Yazili			Y
					JOIN YaziliKademe2	K2	ON	K2.ID_YAZILI	= Y.ID_YAZILI
					WHERE	ID_KADEME3	= @ID_KADEME3 
						AND DONEM		= @DONEM 
						AND YARIYIL		= @YARIYIL 
						AND AKTIF		= 1 					
						AND (	
							ID_KADEME2 IN (SELECT ID_KADEME2 FROM OkyanusDB.dbo.v4Sinif S
									INNER JOIN OkyanusDB.dbo.v3KademeBilgi K ON K.ID_KADEME3 = S.ID_KADEME3
									WHERE S.ID_SINIF = @ID_SINIF) 
							OR  ID_KADEME2	= (SELECT ST.ID_KADEME2 FROM OkyanusDB.dbo.v3Sinif S INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU WHERE ID_SINIF = @ID_SINIF))
					GROUP BY Y.ID_YAZILI, Y.AD, Y.KOD
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 12	--	ÖĞRENCİ KAYDET
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
			
				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0

				UPDATE YO SET AKTIF = 0
				FROM YaziliOgrenci YO
				JOIN #TEMPOGRENCI T ON T.ID_YAZILI = YO.ID_YAZILI AND T.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE YO.AKTIF = 1

				DECLARE @ID_YAZILIOGRENCILIST TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST
				SELECT * FROM #TEMPOGRENCI T

				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT ID_YAZILISORU 
						--(	SELECT ID_YAZILIOGRENCI 
						--	FROM YaziliOgrenci 
						--	WHERE ID_YAZILI = 
						--			(	SELECT ID_YAZILI 
						--				FROM YaziliSoru 
						--				WHERE ID_YAZILISORU = OG.ID_YAZILISORU) 
						--		AND TCKIMLIKNO = OG.TCKIMLIKNO 
						--		AND AKTIF = 1 
						--		AND ISNULL(TELAFI, 0) = 0)
						, L.ID_YAZILIOGRENCI
						, PUAN 
						FROM OPENJSON(@SQLJSONOGRENCICEVAP) 
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG	
					JOIN @ID_YAZILIOGRENCILIST L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  		

				DROP TABLE #TEMPOGRENCI
			END

			IF @ISLEM = 13	--	ÖĞRENCİ SİL
			BEGIN
				SELECT ID_YAZILI, OG.TCKIMLIKNO, TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI2
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI INT,
					KATILMADI BIT
				) OG
				UPDATE Y SET AKTIF = 0, SIL_TCKIMLIKNO = @TCKIMLIKNO, SIL_TARIH = GETDATE()
				FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI2 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.AKTIF=1

				DROP TABLE #TEMPOGRENCI2
			END

			IF @ISLEM = 14	--	ÖĞRENCİ KAYDET TOPLU
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI3
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI3 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO

				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0
			
				DECLARE @ID_YAZILIOGRENCILIST2 TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST2
				SELECT * FROM #TEMPOGRENCI3			
			
				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT DISTINCT ID_YAZILISORU
						--, (SELECT ID_YAZILIOGRENCI FROM YaziliOgrenci WHERE ID_YAZILI = (SELECT ID_YAZILI FROM YaziliSoru WHERE ID_YAZILISORU = OG.ID_YAZILISORU) AND TCKIMLIKNO = OG.TCKIMLIKNO AND AKTIF = 1)
						, L.ID_YAZILIOGRENCI
						, PUAN FROM OPENJSON(@SQLJSONOGRENCICEVAP)
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG		
					JOIN @ID_YAZILIOGRENCILIST2 L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  	


				DROP TABLE #TEMPOGRENCI3
			END

			IF @ISLEM = 15	--	Yazılı Listele by Sınıf
			BEGIN
				DECLARE  @ID_DERSLER2	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEM2		VARCHAR(MAX)=@DONEM
						,@YARIYIL2		INT			=@YARIYIL
						,@SINIFLAR2		VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TC
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TC
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLAR2))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (@ID_DERSLER2 IS NULL OR @ID_DERSLER2='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER2)))
						AND (@YARIYIL2 IS NULL OR @YARIYIL2=0 OR sr.YARIYIL = @YARIYIL2)
						and sr.DONEM=@DONEM2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TC
			END 

			IF @ISLEM = 16	--	YAZILI EKLE EXCEL
			BEGIN
				SELECT 
						 AD = JSON_Value (J.value, '$.AD') 
						,KOD = JSON_Value (J.value, '$.KOD')
						,ID_KADEME3 = K3.ID_KADEME3
						,ID_DERS = JSON_Value (J.value, '$.DERS')
						,ID_KADEME2 = K2.value
						,TARIH = JSON_Value (J.value, '$.TARIH')
						,YARIYIL = JSON_Value (J.value, '$.YARIYIL')
						,SORUNO = JSON_Value (S.value, '$.SORUNO')
						,UNITEKOD = JSON_Value (S.value, '$.KOD')
						,PUAN = JSON_Value (S.value, '$.PUAN')
						,ID_YAZILITURU = JSON_Value (J.value, '$.ID_YAZILITURU')
						,ID_BILGI = JSON_Value (S.value, '$.ID_BILGI')
						,ID_BILISSELSUREC = JSON_Value (S.value, '$.ID_BILISSELSUREC')
				INTO #YAZILI
				FROM OPENJSON(@SQLJSON) AS J
				CROSS APPLY OPENJSON (J.value, '$.OKULTUR') as K2
				CROSS APPLY OPENJSON (J.value, '$.SORULIST') as S
				INNER JOIN OkyanusDb.dbo.v3Kademe3 K3 ON K3.AD = JSON_Value (J.value, '$.GRUP')

				DECLARE @ID_YAZILIAD TABLE (ID_YAZILI INT, AD VARCHAR(50))
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI, INSERTED.AD INTO @ID_YAZILIAD(ID_YAZILI, AD)
				SELECT DISTINCT AD, KOD, (select DONEM from [dbo].[v3AktifDonem] where AKTIF=1), YARIYIL, ID_KADEME3, ID_DERS, TARIH, @TCKIMLIKNO, ID_YAZILITURU FROM #YAZILI Y

				INSERT INTO [dbo].[YaziliKademe2]([ID_YAZILI] ,[ID_KADEME2])
				SELECT DISTINCT YA.ID_YAZILI, ID_KADEME2 
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 

				INSERT INTO [dbo].[YaziliSoru]([ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC])
				SELECT DISTINCT YA.ID_YAZILI, Y.SORUNO, ISNULL(Y.PUAN, 0) AS PUAN, Y.UNITEKOD, Y.ID_BILGI, Y.ID_BILISSELSUREC
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 
			
				SELECT MAX(ID_YAZILI) FROM @ID_YAZILIAD

				DROP TABLE #YAZILI
			END

			IF @ISLEM = 17	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET OVGORSUN = @OVGORSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 18	--	AKTIF DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET AKTIF = @AKTIF WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 19	--	YAZILI TÜRÜ LİSTELE
			BEGIN
				SELECT
				(
					SELECT * 
					FROM YaziliTuru
					WHERE AKTIF = 1
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 20	--	YAZILI BİLGİLERİNİ GÜNCELLE (SORULAR HARİÇ)
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILIGUNCELLE
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILIGUNCELLE TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				DROP TABLE #TEMPYAZILIGUNCELLE
				SELECT @ID_YAZILI
			END

			IF @ISLEM = 21	--	Yazılı Listele by Sınıf - KOS
			BEGIN
				DECLARE  @ID_DERSLERKOS	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEMKOS		VARCHAR(MAX)=@DONEM
						,@YARIYILKOS	INT			=@YARIYIL
						,@SINIFLARKOS	VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TCKOS
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TCKOS
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLARKOS))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (@ID_DERSLERKOS IS NULL OR @ID_DERSLERKOS='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLERKOS)))
						AND (@YARIYILKOS IS NULL OR @YARIYILKOS=0 OR sr.YARIYIL = @YARIYILKOS)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TCKOS
			END 

			IF @ISLEM = 22	--	KARNEDEGORUNSUN
			BEGIN
				UPDATE Yazili SET KARNEDEGORUNSUN = @KARNEDEGORUNSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM=23 -- YY İşlemleri Excelden Toplu sonuç Yükleme Kayıt Kontrol
			BEGIN
				DECLARE @SINAV_DONEM23 INT=0
				DECLARE @SINAV_GRUP23 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM23 = DONEM , @SINAV_GRUP23 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI

					--Hatalı kayıtları listelemek için hata table'ı oluşturuldu.
					DROP TABLE IF EXISTS #HATALI_DATA
					DROP TABLE IF EXISTS #TEMP_EXCEL_OGRENCI_SONUC
					CREATE TABLE #HATALI_DATA(TCKIMLIKNO VARCHAR(11),HATA VARCHAR(100))

					--Jsondan gelen data örneği
					--SET @SQLJSONOGRENCICEVAP ='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'				

									--JSON'dan GELEN DATA TEMP TABLE'A ATILIYOR
						SELECT TCKIMLIKNO,ID_YAZILI,SORU1,SORU2,SORU3,SORU4,SORU5,SORU6,SORU7,SORU8,SORU9,SORU10,SORU11,SORU12,SORU13,SORU14,SORU15,SORU16,SORU17,SORU18,SORU19,SORU20,TELAFI
						INTO #TEMP_EXCEL_OGRENCI_SONUC
						FROM OPENJSON(@SQLJSONOGRENCICEVAP) WITH(TCKIMLIKNO VARCHAR(11),ID_YAZILI INT,SORU1 INT,SORU2 INT,SORU3 INT,SORU4 INT,SORU5 INT,SORU6 INT,SORU7 INT,SORU8 INT,SORU9 INT,SORU10 INT,SORU11 INT,SORU12 INT,SORU13 INT,SORU14 INT,SORU15 INT,SORU16 INT,SORU17 INT,SORU18 INT,SORU19 INT,SORU20 INT,TELAFI INT)

					--TC KONTROL ve Öğrenci tablosunda olmayan kayıtlar Hata tablosuna ekleniyor. 
						INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
						SELECT T.TCKIMLIKNO,'Kayıtlı öğrenci değil'
						FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
						WHERE NOT EXISTS(SELECT TOP 1 1 FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O WHERE O.TCKIMLIKNO = T.TCKIMLIKNO)
						--LEFT JOIN [OkyanusDB].[dbo].[vw_OgrenciDetayTum] AS O ON O.TCKIMLIKNO=T.TCKIMLIKNO 
						--WHERE O.TCKIMLIKNO IS NULL


					--TC'si Ogrenci tablosunda olmayan Hatalı datalar temp tabledan siliniyor
						DELETE FROM #TEMP_EXCEL_OGRENCI_SONUC WHERE TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #HATALI_DATA)

					--Yazılı Donem Kontrolü - Hatalı döneme sahip öğrenciler Hata tablosuna kayıt ediliyor
						INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
						SELECT T.TCKIMLIKNO,'Öğrencinin dönemi hatalı' AS HATA
						FROM #TEMP_EXCEL_OGRENCI_SONUC AS T
						WHERE NOT EXISTS(	SELECT TOP 1 1 
											FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
											WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
												AND DONEM		= @SINAV_DONEM23
										)
						--LEFT JOIN (SELECT TCKIMLIKNO FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] WHERE DONEM=@SINAV_DONEM) AS O
						--ON O.TCKIMLIKNO=T.TCKIMLIKNO WHERE O.TCKIMLIKNO IS NULL


					--Dönemi Hatalı datalar temp tabledan siliniyor
						DELETE FROM #TEMP_EXCEL_OGRENCI_SONUC WHERE TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #HATALI_DATA)

					--GRUP Kontrol
						INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
						SELECT T.TCKIMLIKNO,'Öğrencinin grubu hatalı'
						FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
						WHERE NOT EXISTS(	SELECT TOP 1 1 
											FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
											WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
												AND ID_KADEME3	= @SINAV_GRUP23
										)
								--LEFT JOIN (SELECT * FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] WHERE ID_KADEME3=(SELECT  ID_KADEME3 FROM Yazili WHERE --ID_YAZILI = @ID_YAZILI)) AS O
								--ON O.TCKIMLIKNO=T.TCKIMLIKNO WHERE O.TCKIMLIKNO IS NULL

						

					--Grubu Hatalı datalar temp tabledan siliniyor
						DELETE FROM #TEMP_EXCEL_OGRENCI_SONUC WHERE TCKIMLIKNO IN(SELECT TCKIMLIKNO FROM #HATALI_DATA)

					--Hatalı data tablosu geri JSON olarak dönülüyor
						SELECT * FROM #HATALI_DATA FOR JSON AUTO;

					--Temp table'lar silinyor.
						DROP TABLE #HATALI_DATA
 
			END

			IF @ISLEM=24
			BEGIN
				--@SQLJSONOGRENCICEVAP doğru olarak gelen datalar için CRUD işlemleri yapılıyor
--				DECLARE @SQLJSONOGRENCICEVAP NVARCHAR(MAX)='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":9,"SORU3":8,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'
--DECLARE @ID_YAZILI		INT = 1973
--DECLARE @SINAV_DONEM	INT = 0
--DECLARE @SINAV_GRUP		INT = 0
--DECLARE @TCKIMLIKNO		VARCHAR(MAX) = '32051057542'

				DECLARE @SINAV_DONEM24 INT=0
				DECLARE @SINAV_GRUP24 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM24 = DONEM , @SINAV_GRUP24 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI
				
						DROP TABLE IF EXISTS #EXCEL
						CREATE TABLE #EXCEL (
						TCKIMLIKNO	VARCHAR(MAX),
						SORU1		VARCHAR(MAX),
						SORU2		VARCHAR(MAX),
						SORU3		VARCHAR(MAX),
						SORU4		VARCHAR(MAX),
						SORU5		VARCHAR(MAX),
						SORU6		VARCHAR(MAX),
						SORU7		VARCHAR(MAX),
						SORU8		VARCHAR(MAX),
						SORU9		VARCHAR(MAX),
						SORU10		VARCHAR(MAX),
						SORU11		VARCHAR(MAX),
						SORU12		VARCHAR(MAX),
						SORU13		VARCHAR(MAX),
						SORU14		VARCHAR(MAX),
						SORU15		VARCHAR(MAX),
						SORU16		VARCHAR(MAX),
						SORU17		VARCHAR(MAX),
						SORU18		VARCHAR(MAX),
						SORU19		VARCHAR(MAX),
						SORU20		VARCHAR(MAX),
						TELAFI		VARCHAR(MAX),
						ID_YAZILIOGRENCI INT
						)
						​
						INSERT INTO #EXCEL (TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI) 
						SELECT TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI
						FROM OPENJSON (@SQLJSONOGRENCICEVAP)
						WITH (
							TCKIMLIKNO	VARCHAR(MAX),
							SORU1		VARCHAR(MAX),
							SORU2		VARCHAR(MAX),
							SORU3		VARCHAR(MAX),
							SORU4		VARCHAR(MAX),
							SORU5		VARCHAR(MAX),
							SORU6		VARCHAR(MAX),
							SORU7		VARCHAR(MAX),
							SORU8		VARCHAR(MAX),
							SORU9		VARCHAR(MAX),
							SORU10		VARCHAR(MAX),
							SORU11		VARCHAR(MAX),
							SORU12		VARCHAR(MAX),
							SORU13		VARCHAR(MAX),
							SORU14		VARCHAR(MAX),
							SORU15		VARCHAR(MAX),
							SORU16		VARCHAR(MAX),
							SORU17		VARCHAR(MAX),
							SORU18		VARCHAR(MAX),
							SORU19		VARCHAR(MAX),
							SORU20		VARCHAR(MAX),
							TELAFI		VARCHAR(MAX)
						)

						--SELECT * FROM #EXCEL

						DROP TABLE IF EXISTS #YAZILISORU
						SELECT * INTO #YAZILISORU FROM YaziliSoru WHERE ID_YAZILI = @ID_YAZILI

						--TCKIMLIKNO ve ID_YAZILI ile daha önce eklenen kayıt var ise durumu pasif'e çekiliyor.
						UPDATE Y SET 
							AKTIF = 0 
						FROM YaziliOgrenci Y 
						INNER JOIN #EXCEL O ON O.TCKIMLIKNO = Y.TCKIMLIKNO
						WHERE Y.ID_YAZILI=@ID_YAZILI
						
						DELETE C
						FROM YaziliOgrenci YO
						JOIN YaziliOgrenciCevap C on C.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
						WHERE YO.AKTIF=0

						-- Tüm öğrencilerde dönemi ve grubu olanları al.
						DROP TABLE IF EXISTS #TUM_OGRENCILER
						SELECT DISTINCT TCKIMLIKNO 
						INTO #TUM_OGRENCILER 
						FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] 
						WHERE	ID_KADEME3	= @SINAV_GRUP24
							AND DONEM		= @SINAV_DONEM24
					
					--SELECT * FROM #TUM_OGRENCILER
					DECLARE @INSERTTABLO TABLE (ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(11))
					INSERT INTO YaziliOgrenci(ID_YAZILI,TCKIMLIKNO,KYE_TCKIMLIKNO,KATILMADI,TELAFI)
					OUTPUT inserted.ID_YAZILIOGRENCI,inserted.TCKIMLIKNO INTO @INSERTTABLO(ID_YAZILIOGRENCI,TCKIMLIKNO)
					SELECT	 @ID_YAZILI
							,OT.TCKIMLIKNO
							,@TCKIMLIKNO
							,KATILMADI	= CASE WHEN EXISTS (SELECT TOP 1 1 FROM #EXCEL AS E WHERE E.TCKIMLIKNO = OT.TCKIMLIKNO)
												THEN 0 
												ELSE 1	
											END
							,TELAFI		= (SELECT ISNULL(E.TELAFI,NULL) FROM #EXCEL AS E WHERE OT.TCKIMLIKNO=E.TCKIMLIKNO)
					FROM #TUM_OGRENCILER AS OT

					UPDATE E SET
							E.ID_YAZILIOGRENCI = I.ID_YAZILIOGRENCI
					FROM #EXCEL E
					JOIN  @INSERTTABLO I ON I.TCKIMLIKNO = E.TCKIMLIKNO
 
					DECLARE @sqlCommand varchar(1000)	
						DROP TABLE IF EXISTS #WHILE
						SELECT * INTO #WHILE FROM #YAZILISORU
						WHILE EXISTS( SELECT TOP 1 1 FROM #WHILE)
						BEGIN
							DECLARE @SORUNO VARCHAR(2) = (SELECT TOP 1 CAST(SORUNO AS varchar) FROM #WHILE ORDER BY SORUNO)
							SET @sqlCommand	= 'SELECT SORU'+ @SORUNO  +' FROM #EXCEL ' 
	
							SET @sqlCommand = 
							'	INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
								SELECT (SELECT TOP 1 ID_YAZILISORU FROM #YAZILISORU YS WHERE YS.SORUNO = '+@SORUNO+') AS ID_YAZILISORU, ID_YAZILIOGRENCI, SORU'+@SORUNO+' FROM #EXCEL'
							EXEC (@sqlCommand)
						​
							DELETE FROM #WHILE WHERE SORUNO = @SORUNO
						END
 
						DROP TABLE #TUM_OGRENCILER					
			END
		END
	END TRY
	BEGIN CATCH
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Parametre]...';


GO
ALTER procedure [dbo].[sp_Parametre]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@ID_PARAMETREDEGER		INT				= NULL,
	@ID_PARAMETRE			INT				= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL

AS
BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 16.09.20202
	
	--	sp CREATE 
		--	
	--	PARAMETRE 

*/
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU
				
				,ID_PARAMETREDEGER		= @ID_PARAMETREDEGER
				,ID_PARAMETRE			= @ID_PARAMETRE
				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	PARAMETRE LİST		
			BEGIN
				
				SELECT ISNULL((
					SELECT	 PG.ID_PARAMETREGRUP
							,PG.AD
							,PARAMETREDEGERLIST = (
								SELECT	 SPD.ID_PARAMETREDEGER
										,SPD.AD
										,SPD.DEGER
								FROM ParametreDeger	SPD
								WHERE SPD.ID_PARAMETREGRUP	= PG.ID_PARAMETREGRUP
								FOR JSON PATH
							)
							,PARAMETRELIST.ID_PARAMETRE
							,PARAMETRELIST.ID_PARAMETREDEGER
							,PARAMETRELIST.AD			
					FROM ParametreGrup			PG
					JOIN Parametre				PARAMETRELIST	ON	PARAMETRELIST.ID_PARAMETREGRUP	= PG.ID_PARAMETREGRUP
					LEFT JOIN ParametreDeger	PD				ON	PD.ID_PARAMETREDEGER			= PARAMETRELIST.ID_PARAMETREDEGER
					FOR JSON AUTO, INCLUDE_NULL_VALUES, ROOT('ParametreList')
				),'{"ParametreList":[]}')
				
			END
			
			IF @ISLEM = 2	--	PARAMETRE SET		
			BEGIN
				
				;WITH TABLE1 AS (
				SELECT ID_PARAMETREDEGER,AD,DEGER
				FROM OPENJSON(@SQLJSON)
				WITH(
					PARAMETREDEGERLIST NVARCHAR(MAX) AS JSON	
				) AS J
				CROSS APPLY OPENJSON(J.PARAMETREDEGERLIST)
				WITH(
					 ID_PARAMETREDEGER	INT
					,AD					VARCHAR(MAX)
					,DEGER				VARCHAR(MAX)
				) AS PD
				
				
				)
				UPDATE P SET
				P.DEGER	= T.DEGER
				FROM ParametreDeger	P
				JOIN TABLE1		T	ON	T.ID_PARAMETREDEGER = P.ID_PARAMETREDEGER

				;WITH TABLE2 AS (
					SELECT PL.ID_PARAMETRE, PL.ID_PARAMETREDEGER
					FROM OPENJSON (@SQLJSON) 
					WITH (
						PARAMETRELIST	NVARCHAR(MAX) AS JSON
					)
					AS J
					CROSS APPLY OPENJSON(J.PARAMETRELIST)
					WITH(
						ID_PARAMETRE		INT,
						ID_PARAMETREDEGER	INT
					) AS PL
				)
				
				UPDATE P SET
					P.ID_PARAMETREDEGER	= T.ID_PARAMETREDEGER
				FROM Parametre	P
				JOIN TABLE2		T	ON	T.ID_PARAMETRE = P.ID_PARAMETRE
				
			END

		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Creating [dbo].[sp_SifremiDegistir]...';


GO

CREATE PROCEDURE sp_SifremiDegistir 
@ISLEM			INT,
@OLDPASS		VARCHAR(50),
@NEWPASS		VARCHAR(50),
@TCKIMLIKNO		VARCHAR(11)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		IF @ISLEM=1
			BEGIN
			DECLARE @ERRCODE VARCHAR(2),@ERRMESSAGE VARCHAR(300)
			DROP TABLE IF EXISTS #UPDATE_TABLE
				CREATE TABLE #UPDATE_TABLE
				(
					ERRCODE		INT,
					ERRMESSAGE  varchar(200), 
				)

				DECLARE @TABLE_OLDPASS VARCHAR(50)=(SELECT SIFRE FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO)

				IF @TABLE_OLDPASS=@OLDPASS
					BEGIN
						UPDATE OkyanusDB.dbo.v3Kullanici 
					    SET SIFRE = @NEWPASS,
						   SIFREHASH=eokul_v2.dbo.clr_Crypto_HashPass(@NEWPASS) 
						WHERE AKTIF=1 
					    AND TCKIMLIKNO=@TCKIMLIKNO

						SET @ERRCODE=0
						SET @ERRMESSAGE='Şifreniz başarıyla güncellendi!'
						INSERT INTO #UPDATE_TABLE (ERRCODE,ERRMESSAGE) VALUES(@ERRCODE,@ERRMESSAGE)
						SELECT * FROM #UPDATE_TABLE FOR JSON AUTO
					END
				ELSE
					BEGIN
						SET @ERRCODE=1
						SET @ERRMESSAGE='Eski şifrenizi yanlış girdiniz!'

						INSERT INTO #UPDATE_TABLE (ERRCODE,ERRMESSAGE) VALUES(@ERRCODE,@ERRMESSAGE)
						SELECT * FROM #UPDATE_TABLE FOR JSON AUTO
					END
			END
    -- Insert statements for procedure here
	SET NOCOUNT OFF;
END
GO
PRINT N'Altering [dbo].[sp_OptikIslemleri]...';


GO
ALTER procedure [dbo].[sp_OptikIslemleri]
	@ISLEM				INT				= 0,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVDOSYA		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBE			INT				= NULL	
AS

--SET XACT_ABORT ON

BEGIN

BEGIN TRY    

/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 11.09.20202
	
	--	sp Alter 
		--	
	--	ONLINE SINAV DA OPTIK ÇOKLU KITAPCIK

*/
	--		EXEC sp_SinavDegerlendir
	--BEGIN TRAN
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
	DECLARE @ID				INT				= NULL
	DECLARE @SINAVOTURUM	TINYINT			= NULL
	DECLARE @SQL			VARCHAR(max)	= NULL
	DECLARE @DOSYAYOL		VARCHAR(max)	= NULL
	DECLARE @DOSYAGUID		VARCHAR(50)		= NULL
	DECLARE @ID_KADEME		INT				= NULL
	DECLARE @ONLINESINAV	BIT				= NULL

	SET @ONLINESINAV = (SELECT ONLINESINAV FROM Sinav WHERE ID_SINAV = @ID_SINAV)

	IF	(	@ONLINESINAV = 1 
		AND NOT EXISTS(SELECT TOP 1 1 FROM SinavDosya WHERE ID_SINAV = @ID_SINAV AND OTURUM = 1 AND AKTIF = 1 AND AD = 'ONLINE' ))
			INSERT INTO SinavDosya (AD, GUID, ID_SINAV, ID_SUBE, KYE_TCKIMLIKNO)
			VALUES ('ONLINE', '', @ID_SINAV, 0, '32051057542')
	IF	(	@ONLINESINAV = 1 
		AND EXISTS (SELECT TOP 1 1 FROM SinavDers SD JOIN SinavOptikDers OD ON OD.ID_SINAVDERS = SD.ID_SINAVDERS WHERE SD.ID_SINAV = @ID_SINAV AND OD.OTURUM = 2)
		AND NOT EXISTS(SELECT TOP 1 1 FROM SinavDosya WHERE ID_SINAV = @ID_SINAV AND OTURUM = 2 AND AKTIF = 1 AND AD = 'ONLINE' ))
			INSERT INTO SinavDosya (AD, GUID, ID_SINAV, OTURUM, ID_SUBE, KYE_TCKIMLIKNO)
			VALUES ('ONLINE', '', @ID_SINAV, 2, 0, '32051057542')

		
	SET @ID_KADEME=(SELECT DISTINCT ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = (SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV))
	IF @ISLEM = 0	--	Sınav Dosya İşleme
	BEGIN

		UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 1 where ID_SINAV = @ID_SINAV


		DECLARE @BASLANGIC1 INT, @BASLANGIC2 INT, @BASLANGIC3 INT, @BASLANGIC4 INT, @BASLANGIC5 INT, @BASLANGIC6 INT
		DECLARE @OPTIKKARAKTERSAYISI1 INT, @OPTIKKARAKTERSAYISI2 INT, @OPTIKKARAKTERSAYISI3 INT, @OPTIKKARAKTERSAYISI4 INT, @OPTIKKARAKTERSAYISI5 INT, @OPTIKKARAKTERSAYISI6 INT

		SET @BASLANGIC1 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
		SET @BASLANGIC2 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 2)
		SET @BASLANGIC3 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 3)
		SET @BASLANGIC4 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 4)
		SET @BASLANGIC5 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 5)
		SET @BASLANGIC6 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 6)

		SET @OPTIKKARAKTERSAYISI1 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
		SET @OPTIKKARAKTERSAYISI2 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 2)
		SET @OPTIKKARAKTERSAYISI3 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 3)
		SET @OPTIKKARAKTERSAYISI4 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 4)
		SET @OPTIKKARAKTERSAYISI5 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 5)
		SET @OPTIKKARAKTERSAYISI6 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 6)

		DECLARE @YANLISSAYISI DECIMAL(18, 2)
		SET @YANLISSAYISI = (SELECT ISNULL(YANLISSAYISI, 0) FROM Sinav	WHERE ID_SINAV = @ID_SINAV)


		DROP TABLE IF EXISTS #SinavDers

		SELECT	 SD.ID_SINAV
				,SD.ID_SINAVDERS
				,OD.BASLANGIC
				,OD.OPTIKKARAKTERSAYISI
				,OD.OTURUM
		INTO #SinavDers 
		FROM SinavDers		SD
		JOIN SinavOptikDers	OD	ON	OD.ID_SINAVDERS	= SD.ID_SINAVDERS
		WHERE SD.ID_SINAV = @ID_SINAV

		PRINT '1: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


		--IF @ONLINESINAV = 0
		BEGIN
			IF (SELECT COUNT(1) FROM SinavKitapcik WHERE ID_SINAV = @ID_SINAV) = 1 
			BEGIN
				
				PRINT '5: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				UPDATE SOT SET LINE=ISNULL(STUFF(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4,'A'),'') 
				FROM SinavOptikTemp SOT 
				INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA=SOT.ID_SINAVDOSYA 
				WHERE SD.ID_SINAV = @ID_SINAV

				PRINT '6: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE
			BEGIN
				
				PRINT '7: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DROP TABLE IF EXISTS #KITAPCIKSIZLAR

				SELECT 
				ID_SINAVOPTIKTEMP, LINE, RN = ROW_NUMBER() OVER (ORDER BY ID_SINAVOPTIKTEMP) 
				INTO #KITAPCIKSIZLAR
				FROM SinavOptikTemp	  SOT
				INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA=SOT.ID_SINAVDOSYA
				WHERE 
						SD.ID_SINAV = @ID_SINAV
					AND SUBSTRING(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4)=' '
		

				PRINT '8: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				IF (SELECT COUNT(*) FROM #KITAPCIKSIZLAR)>0
				BEGIN
					
					PRINT '9: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
					
					DROP TABLE IF EXISTS #KITAPCIKLAR

					SELECT ROW_NUMBER() OVER (ORDER BY AD) AS RN, SK.ID_SINAVKITAPCIK, AD, SD.ID_SINAVDERS, SOD.BASLANGIC, SOD.OPTIKKARAKTERSAYISI, STUFF((SELECT ''+CEVAP FROM SinavAnahtar WHERE ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND ID_SINAVDERS=SD.ID_SINAVDERS ORDER BY SORUNO FOR XML PATH('')),1,0,'') CEVAPLAR
					INTO #KITAPCIKLAR 
					FROM SinavKitapcik			SK
					INNER JOIN SinavDers		SD ON SD.ID_SINAV=SK.ID_SINAV
					INNER JOIN SinavOptikDers	SOD ON SOD.ID_SINAVDERS=SD.ID_SINAVDERS
					WHERE SK.ID_SINAV=@ID_SINAV

					PRINT '10: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

					DECLARE @COUNTER INT = 1
					DECLARE @COUNTKITAPCIKSIZLAR INT=(SELECT COUNT(*) FROM #KITAPCIKSIZLAR)
					WHILE @COUNTER <= @COUNTKITAPCIKSIZLAR
					BEGIN
						
						PRINT '11: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						DECLARE @KSIZLINE VARCHAR(MAX)
						DECLARE @KSIZID_SINAVOPTIKTEMP INT
						SELECT @KSIZID_SINAVOPTIKTEMP=ID_SINAVOPTIKTEMP ,@KSIZLINE=LINE FROM #KITAPCIKSIZLAR WHERE RN=@COUNTER

						DECLARE @KITAPCIKDOGRUSAYISI TABLE (KITAPCIK VARCHAR(1), DOGRUSAYISI INT)
												
						DECLARE @COUNTER2 INT = 1
						DECLARE @COUNTKITAPCIKLAR INT=(SELECT COUNT(*) FROM #KITAPCIKLAR)
						WHILE @COUNTER2 <= @COUNTKITAPCIKLAR
						BEGIN
							
							PRINT '12: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

							INSERT INTO @KITAPCIKDOGRUSAYISI(KITAPCIK, DOGRUSAYISI)
							VALUES 
							(
								(SELECT AD FROM #KITAPCIKLAR WHERE RN=@COUNTER2)
								,(
									SELECT SUM(DS) FROM (SELECT dbo.fn_SayiBul2(
												 RTRIM(SUBSTRING(@KSIZLINE,K.BASLANGIC,K.OPTIKKARAKTERSAYISI))
												,K.CEVAPLAR
											) AS DS
										FROM #KITAPCIKLAR K WHERE RN=@COUNTER2) XTABLE
								)
							)
							SET @COUNTER2 += 1
						END
						
						PRINT '13: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						DECLARE @KITAPCIK CHAR
						DECLARE @DOGRUSAYISI INT 
		
						SELECT TOP 1 @KITAPCIK = KITAPCIK, @DOGRUSAYISI=SUM(DOGRUSAYISI) FROM @KITAPCIKDOGRUSAYISI GROUP BY KITAPCIK ORDER BY SUM(DOGRUSAYISI) DESC
						UPDATE SinavOptikTemp SET LINE = ISNULL(STUFF(LINE,@BASLANGIC4,@OPTIKKARAKTERSAYISI4,@KITAPCIK),'') WHERE ID_SINAVOPTIKTEMP=@KSIZID_SINAVOPTIKTEMP

						DELETE FROM @KITAPCIKDOGRUSAYISI
						SET @COUNTER += 1

						PRINT '14: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

					END
					DROP TABLE IF EXISTS #KITAPCIKLAR

					PRINT '15: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				END

				DROP TABLE IF EXISTS #KITAPCIKSIZLAR

				PRINT '16: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
		END
		

			PRINT '17: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #SinavOgrenci

			CREATE TABLE #SinavOgrenci(
				 ID_SINAVOGRENCI int NOT NULL IDENTITY(1,1)
				,[ID_SINAV] INT
				,[TCKIMLIKNO] VARCHAR(MAX)
				,[AD] VARCHAR(MAX)
				,[SOYAD] VARCHAR(MAX)
				,[KITAPCIK] VARCHAR(MAX)
				,[SUBENO] VARCHAR(MAX)
				,[SINIF] VARCHAR(MAX)
				,[ID_SINAVDOSYA] INT
				,[ID_SINAVOPTIKTEMP] INT
				,[ONLINESINAV] BIT
				)
				
			DECLARE @GUID NVARCHAR(MAX) = NEWID()

			DECLARE @TBL_OGRENCI TABLE(ID_SINAVOGRENCI INT, ID_SINAVOPTIKTEMP INT, ID_SINAV INT, ID_SINAVDOSYA INT, TCKIMLIKNO VARCHAR(MAX), ONLINESINAV BIT)

			--IF @ONLINESINAV = 0
			BEGIN
				INSERT INTO #SinavOgrenci
					([ID_SINAV]
					,[TCKIMLIKNO]
					,[AD]
					,[SOYAD]
					,[KITAPCIK]
					,[SUBENO]
					,[SINIF]
					,[ID_SINAVDOSYA]
					,[ID_SINAVOPTIKTEMP]
					,[ONLINESINAV])
				OUTPUT INSERTED.ID_SINAVOGRENCI, INSERTED.ID_SINAVOPTIKTEMP, INSERTED.ID_SINAV, INSERTED.ID_SINAVDOSYA, INSERTED.TCKIMLIKNO,0 INTO @TBL_OGRENCI
				SELECT 
				 @ID_SINAV
				,RTRIM(SUBSTRING(LINE, @BASLANGIC1, @OPTIKKARAKTERSAYISI1))
				,RTRIM(SUBSTRING(LINE, @BASLANGIC2, @OPTIKKARAKTERSAYISI2))
				,RTRIM(SUBSTRING(LINE, @BASLANGIC3, @OPTIKKARAKTERSAYISI3))
				,RTRIM(SUBSTRING(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4))
				,RTRIM(SUBSTRING(LINE, @BASLANGIC5, @OPTIKKARAKTERSAYISI5))
				,RTRIM(SUBSTRING(LINE, @BASLANGIC6, @OPTIKKARAKTERSAYISI6))
				,SD.ID_SINAVDOSYA 
				,S.ID_SINAVOPTIKTEMP
				,ONLINESINAV = 0
				FROM SinavOptikTemp	S
				JOIN SinavDosya		SD	ON	SD.ID_SINAVDOSYA = S.ID_SINAVDOSYA 
				WHERE	SD.ID_SINAV = @ID_SINAV 
					AND SD.AKTIF	= 1
					AND SD.AD		!= 'ONLINE'
			--END
			--ELSE
			--BEGIN

				INSERT INTO #SinavOgrenci
					([ID_SINAV]
					,[TCKIMLIKNO]
					,[AD]
					,[SOYAD]
					,[KITAPCIK]
					,[SUBENO]
					,[SINIF]
					,[ID_SINAVDOSYA]
					,[ID_SINAVOPTIKTEMP]
					,[ONLINESINAV])
				OUTPUT INSERTED.ID_SINAVOGRENCI, INSERTED.ID_SINAVOPTIKTEMP, INSERTED.ID_SINAV, INSERTED.ID_SINAVDOSYA, INSERTED.TCKIMLIKNO,1 INTO @TBL_OGRENCI
				SELECT 
					 @ID_SINAV
					,SO.TCKIMLIKNO
					,K.AD
					,K.SOYAD
					,'A'
					,SB.SUBENO
					,''
					,SD.ID_SINAVDOSYA
					,0
					,ONLINESINAV = 1
				FROM Tbl_OnlineSinavOgrenci SO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= SO.TCKIMLIKNO
				JOIN v3Sube					SB	ON	SB.ID_SUBE		= O.ID_SUBE
				JOIN v3Kullanici			K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				JOIN SinavDosya				SD	ON	SD.ID_SINAV		= SO.ID_SINAV
				WHERE	SO.AKTIF	= 1
					AND SD.AKTIF	= 1
					AND SO.ID_SINAV = @ID_SINAV
					AND SD.AD		= 'ONLINE'
					AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_OGRENCI T WHERE T.TCKIMLIKNO = O.TCKIMLIKNO)					
					AND EXISTS (SELECT TOP 1 1 
								FROM Tbl_OnlineSinavOgrenciCevap SC 
								WHERE	SC.ID_ONLINESINAVOGRENCI= SO.ID_ONLINESINAVOGRENCI
									AND SC.AKTIF = 1
								)
								PRINT 1
				INSERT INTO #SinavOgrenci
					([ID_SINAV]
					,[TCKIMLIKNO]
					,[AD]
					,[SOYAD]
					,[KITAPCIK]
					,[SUBENO]
					,[SINIF]
					,[ID_SINAVDOSYA]
					,[ID_SINAVOPTIKTEMP]
					,[ONLINESINAV])
				OUTPUT INSERTED.ID_SINAVOGRENCI, INSERTED.ID_SINAVOPTIKTEMP, INSERTED.ID_SINAV, INSERTED.ID_SINAVDOSYA, INSERTED.TCKIMLIKNO,1 INTO @TBL_OGRENCI
				SELECT 
					 @ID_SINAV
					,SO.TCKIMLIKNO
					,O.AD
					,O.SOYAD
					,'A'
					,O.SUBE_NO
					,''
					,SD.ID_SINAVDOSYA
					,0
					,ONLINESINAV = 1
				FROM Tbl_OnlineSinavOgrenci SO
				JOIN DisOgrenci				O	ON	O.TCKIMLIKNO	= SO.TCKIMLIKNO
				JOIN SinavDosya				SD	ON	SD.ID_SINAV		= SO.ID_SINAV
				WHERE	SO.AKTIF	= 1
					AND SD.AKTIF	= 1
					AND SO.ID_SINAV = @ID_SINAV
					AND SD.AD		= 'ONLINE'
					AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_OGRENCI T WHERE T.TCKIMLIKNO = O.TCKIMLIKNO)					
					AND EXISTS (SELECT TOP 1 1 
								FROM Tbl_OnlineSinavOgrenciCevap SC 
								WHERE	SC.ID_ONLINESINAVOGRENCI= SO.ID_ONLINESINAVOGRENCI
									AND SC.AKTIF = 1
								)
								PRINT 2



			END

			
			PRINT '18: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--------------------------------------------------------------------------------------------------

			DROP TABLE IF EXISTS #SinavOgrenciCevapBolum

			CREATE TABLE #SinavOgrenciCevapBolum(
				ID_SINAVOGRENCICEVAPBOLUM INT NOT NULL IDENTITY(1, 1)
					,[ID_SINAVOGRENCI] INT
					,[ID_SINAVDERS] INT
					,[CEVAPLAR] VARCHAR(MAX)
					,[DOGRU] INT
					,[YANLIS] INT
					,[BOS] INT
					,[NET] DECIMAL(18, 2)
					,[YUZDEDOGRU] DECIMAL(18, 2)
					,[YUZDENET] DECIMAL(18, 2)
					,[PUAN] DECIMAL(18, 3)
					,TCKIMLIKNO VARCHAR(MAX)
					)

			--IF @ONLINESINAV = 0
			BEGIN
				INSERT INTO #SinavOgrenciCevapBolum
						([ID_SINAVOGRENCI]
						,[ID_SINAVDERS]
						,[CEVAPLAR]
						,[DOGRU]
						,[YANLIS]
						,[BOS]
						,[NET]
						,[YUZDEDOGRU]
						,[YUZDENET]
						,[PUAN]
						,TCKIMLIKNO)
				SELECT	 TEMP.ID_SINAVOGRENCI
						,SD.ID_SINAVDERS
						,SUBSTRING(SOT.LINE,SDT.BASLANGIC,SDT.OPTIKKARAKTERSAYISI) as CEVAPLAR
						,0,0,0,0,0,0,0, TEMP.TCKIMLIKNO
				FROM @TBL_OGRENCI TEMP
				INNER JOIN SinavOptikTemp	SOT		WITH (NOLOCK) on SOT.ID_SINAVOPTIKTEMP = TEMP.ID_SINAVOPTIKTEMP
				INNER JOIN SinavDosya		SDO		WITH (NOLOCK) on SDO.ID_SINAVDOSYA = TEMP.ID_SINAVDOSYA
				INNER JOIN SinavDers		SD		WITH (NOLOCK) on SD.ID_SINAV = TEMP.ID_SINAV
				INNER JOIN #SinavDers		SDT					  on SDT.ID_SINAVDERS = SD.ID_SINAVDERS and SDT.OTURUM=SDO.OTURUM
				WHERE TEMP.ONLINESINAV = 0
			--END
			--ELSE
			--BEGIN
				INSERT INTO #SinavOgrenciCevapBolum
						([ID_SINAVOGRENCI]
						,[ID_SINAVDERS]
						,[CEVAPLAR]
						,[DOGRU]
						,[YANLIS]
						,[BOS]
						,[NET]
						,[YUZDEDOGRU]
						,[YUZDENET]
						,[PUAN]
						,TCKIMLIKNO)
				SELECT	 TEMP.ID_SINAVOGRENCI
						,SD.ID_SINAVDERS
						,'' as CEVAPLAR
						,0,0,0,0,0,0,0, TEMP.TCKIMLIKNO
				FROM @TBL_OGRENCI		TEMP
				JOIN SinavDosya		SDO	WITH (NOLOCK)	ON	SDO.ID_SINAVDOSYA	= TEMP.ID_SINAVDOSYA
				JOIN SinavDers		SD	WITH (NOLOCK)	ON	SD.ID_SINAV			= TEMP.ID_SINAV
				JOIN #SinavDers		SDT					ON	SDT.ID_SINAVDERS	= SD.ID_SINAVDERS 
														AND	SDT.OTURUM			= SDO.OTURUM
				WHERE TEMP.ONLINESINAV = 1
			END


			PRINT '19: ' + CONVERT( VARCHAR(24), GETDATE(), 121)	
-----------------------------------------------------------------------------------------


			---------------------------
			--SinavOgrenciCevapInsert--
			---------------------------
			DECLARE @SORUDOGRU	INT=1,
					@SORUBOS	INT=2,
					@SORUxDOGRU	INT=3,
					@SORUIPTAL	INT=4
			
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Temp2


			DROP TABLE IF EXISTS #SinavSoruIslem

			SELECT DISTINCT SS.ID_SINAVANAHTAR, SS.ID_SORUISLEM 
			INTO #SinavSoruIslem FROM SinavSoruIslem	SS
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVANAHTAR	= SS.ID_SINAVANAHTAR
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
			WHERE SK.ID_SINAV = @ID_SINAV
			
			DROP TABLE IF EXISTS #ASSISLEM

			SELECT I.* 
			INTO #ASSISLEM
			FROM SinavDers SD
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= SD.ID_SINAV
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
			JOIN SinavSoruIslem  I	ON	I.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
			WHERE	SD.ID_SINAV		= @ID_SINAV
				AND SK.AD			= 'A'
				AND I.ID_SORUISLEM	= 3

			IF EXISTS(SELECT TOP 1 1 FROM #ASSISLEM)
			BEGIN
				DELETE FROM I
				FROM SinavDers SD
				JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= SD.ID_SINAV
				JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
										AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
				JOIN SinavSoruIslem  I	ON	I.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
				WHERE	SD.ID_SINAV		= @ID_SINAV
					AND I.ID_SORUISLEM	= 3
		
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) 					
					SELECT A.ID_SINAVANAHTAR						
						,I.ID_SORUISLEM
						,I.OGRENCICEVAP 
					FROM #ASSISLEM			I
					JOIN SinavAnahtar		SA	ON	I.ID_SINAVANAHTAR =SA.ID_SINAVANAHTAR
					JOIN SinavDers			SD	ON	SD.ID_SINAVDERS = SA.ID_SINAVDERS
					JOIN SinavAnahtar		A	ON	A.ID_SINAVDERS	= SD.ID_SINAVDERS AND A.SORUNO_A = SA.SORUNO_A
			END
			 
			DROP TABLE IF EXISTS #ASSISLEM

			SELECT	 SO.ID_SINAVOGRENCI
					,CB.ID_SINAVOGRENCICEVAPBOLUM
					,CB.ID_SINAVDERS
					,CB.CEVAPLAR
					,SK.AD
					,SA.SORUNO
					,SA.OPTIKKARAKTERSAYISI
					,ANAHTAR	= SA.CEVAP
					,SS.ID_SORUISLEM
					,SA.ID_SINAVANAHTAR
			INTO #Temp 
			FROM #SinavOgrenciCevapBolum	CB  WITH (NOLOCK) 
			INNER JOIN #SinavOgrenci		SO	WITH (NOLOCK) ON SO.ID_SINAVOGRENCI		= CB.ID_SINAVOGRENCI
			INNER JOIN SinavKitapcik		SK	WITH (NOLOCK) ON SK.AD					= SO.KITAPCIK
			INNER JOIN SinavAnahtar			SA	WITH (NOLOCK) ON SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK	AND SA.ID_SINAVDERS = CB.ID_SINAVDERS
			LEFT  JOIN #SinavSoruIslem		SS	WITH (NOLOCK) ON SS.ID_SINAVANAHTAR		= SA.ID_SINAVANAHTAR
			WHERE SO.ID_SINAV = @ID_SINAV
			--ORDER BY SO.ID_SINAVOGRENCI, CB.ID_SINAVDERS, SA.SORUNO

			PRINT '20: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			SELECT ID_SINAVOGRENCI, ID_SINAVOGRENCICEVAPBOLUM, ID_SINAVDERS, CEVAPLAR, AD, SORUNO, OPTIKKARAKTERSAYISI, ANAHTAR ,ID_SORUISLEM, ID_SINAVANAHTAR
				,BASLANGIC_OPTIKSIRA = 
					ISNULL((	
						SELECT  SUM(TSUB.OPTIKKARAKTERSAYISI) 
						FROM #Temp TSUB 
						WHERE TSUB.ID_SINAVOGRENCICEVAPBOLUM = T.ID_SINAVOGRENCICEVAPBOLUM AND TSUB.ID_SINAVDERS = T.ID_SINAVDERS AND TSUB.SORUNO < T.SORUNO
					), 0) + 1
			INTO #Temp2 FROM #Temp	T
			--ORDER BY T.ID_SINAVOGRENCI, T.ID_SINAVDERS, T.SORUNO

			PRINT '21: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #K

			SELECT DISTINCT SS.ID_SINAVANAHTAR, SS.ID_SORUISLEM, SI.OGRENCICEVAP 
			INTO #K FROM #SinavSoruIslem SS
			JOIN SinavSoruIslem SI	ON	SI.ID_SINAVANAHTAR = SS.ID_SINAVANAHTAR
			WHERE SS.ID_SORUISLEM = @SORUxDOGRU

			PRINT '22: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #SinavOgrenciCevap

			CREATE TABLE #SinavOgrenciCevap
			(
				 [ID_SINAVOGRENCICEVAPBOLUM]	INT
				,[SORUNO]						INT
				,[CEVAP]				VARCHAR(MAX)
				,[DURUM]				VARCHAR(MAX)
				,ANAHTAR				VARCHAR(MAX)
				,ID_SORUISLEM					INT
				,ID_SINAVANAHTAR				INT
			)

			--IF @ONLINESINAV = 0
			BEGIN
				INSERT INTO #SinavOgrenciCevap
								([ID_SINAVOGRENCICEVAPBOLUM]
								,[SORUNO]
								,[CEVAP]
								,[DURUM]
								,ANAHTAR
								,ID_SORUISLEM
								,ID_SINAVANAHTAR)
				SELECT	 T.ID_SINAVOGRENCICEVAPBOLUM
						,SORUNO
						,CEVAP			= SUBSTRING(CEVAPLAR, BASLANGIC_OPTIKSIRA, OPTIKKARAKTERSAYISI)
						,DURUM			= ''
						,ANAHTAR		= ANAHTAR
						,ID_SORUISLEM	= T.ID_SORUISLEM
						,ID_SINAVANAHTAR= T.ID_SINAVANAHTAR
				FROM #Temp2			T
				JOIN #SinavOgrenci	SO	ON	SO.ID_SINAVOGRENCI		= T.ID_SINAVOGRENCI
										AND SO.ONLINESINAV			= 0
			--END
			--ELSE
			--BEGIN

				
				INSERT INTO #SinavOgrenciCevap
								([ID_SINAVOGRENCICEVAPBOLUM]
								,[SORUNO]
								,[CEVAP]
								,[DURUM]
								,ANAHTAR
								,ID_SORUISLEM
								,ID_SINAVANAHTAR)
				SELECT	 T.ID_SINAVOGRENCICEVAPBOLUM
						,SORUNO
						,CEVAP = CASE	WHEN C.CEVAPNO	= 1 THEN 'A'
										WHEN C.CEVAPNO	= 2 THEN 'B'
										WHEN C.CEVAPNO	= 3 THEN 'C'
										WHEN C.CEVAPNO	= 4 THEN 'D'
										WHEN C.CEVAPNO	= 5 THEN 'E'
								ELSE ''
								END
						,DURUM			= ''
						,ANAHTAR		= ANAHTAR
						,ID_SORUISLEM	= T.ID_SORUISLEM
						,ID_SINAVANAHTAR= T.ID_SINAVANAHTAR
				FROM #Temp2								T
				JOIN #SinavOgrenci						SO	ON	SO.ID_SINAVOGRENCI		= T.ID_SINAVOGRENCI
															AND SO.ONLINESINAV			= 1
				JOIN Tbl_OnlineSinavOgrenci				O	ON	O.ID_SINAV				= @ID_SINAV
															AND O.TCKIMLIKNO			= SO.TCKIMLIKNO
															AND O.AKTIF					= 1
				LEFT JOIN Tbl_OnlineSinavOgrenciCevap	OC	ON	OC.ID_ONLINESINAVOGRENCI= O.ID_ONLINESINAVOGRENCI
															AND OC.ID_SINAVANAHTAR		= T.ID_SINAVANAHTAR
															AND OC.AKTIF				= 1
				LEFT JOIN SoruBankasi.dbo.Cevap			C	ON	C.ID_CEVAP				= OC.ID_CEVAP 



			END







				UPDATE #SinavOgrenciCevap SET DURUM = CASE 
														WHEN CEVAP = ''						THEN 'B'
														WHEN CEVAP = ANAHTAR				THEN 'D'
														WHEN CEVAP = '*' AND @ID_KADEME=  4	THEN 'B' --5,6,7,8 DE * GELİRSE BOŞ SAYILACAK (ÇİFT CEVAP)
													ELSE 'Y' END


				UPDATE SO SET DURUM = CASE
									WHEN SO.ID_SORUISLEM	= @SORUDOGRU	THEN 'D' 
									WHEN SO.ID_SORUISLEM	= @SORUBOS		THEN 'B'
									WHEN SO.ID_SORUISLEM	= @SORUIPTAL	THEN 'I'
									WHEN SO.ID_SORUISLEM	= @SORUxDOGRU	THEN 
										CASE WHEN  SO.CEVAP IN (SELECT OGRENCICEVAP FROM #K WHERE #K.ID_SINAVANAHTAR = SO.ID_SINAVANAHTAR)	THEN 'D'
											 ELSE  DURUM
										END
								ELSE DURUM
							END
				FROM #SinavOgrenciCevap	SO
				WHERE SO.ID_SORUISLEM IS NOT NULL

				
			PRINT '23: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


			;WITH t2( ID_SINAVOGRENCICEVAPBOLUM, DOGRU, YANLIS, BOS, PUAN) AS
			(
					SELECT 
							 OC.ID_SINAVOGRENCICEVAPBOLUM
							,DOGRU		= SUM(CASE WHEN OC.DURUM = 'D' THEN 1 ELSE 0 END) 
							,YANLIS		= SUM(CASE WHEN OC.DURUM = 'Y' THEN 1 ELSE 0 END) 
							,BOS		= SUM(CASE WHEN OC.DURUM = 'B' THEN 1 ELSE 0 END)
							,PUAN		= SUM(CASE WHEN OC.DURUM = 'D' THEN ISNULL(SA.KATSAYI, 0) ELSE 0 END)
					FROM #SinavOgrenciCevapBolum	CB  WITH (NOLOCK) 
					JOIN #SinavOgrenciCevap			OC	WITH (NOLOCK) ON OC.ID_SINAVOGRENCICEVAPBOLUM	= CB.ID_SINAVOGRENCICEVAPBOLUM
					JOIN #SinavOgrenci				OG	WITH (NOLOCK) ON OG.ID_SINAVOGRENCI				= CB.ID_SINAVOGRENCI
					JOIN SinavKitapcik				SK	WITH (NOLOCK) ON SK.AD							= OG.KITAPCIK
					JOIN SinavAnahtar				SA	WITH (NOLOCK) ON SK.ID_SINAVKITAPCIK			= SA.ID_SINAVKITAPCIK AND SA.ID_SINAVDERS = CB.ID_SINAVDERS AND SA.SORUNO = OC.SORUNO
					WHERE OG.ID_SINAV = @ID_SINAV
					GROUP BY OC.ID_SINAVOGRENCICEVAPBOLUM
			)
			UPDATE   CB 
			SET		 DOGRU		= t2.DOGRU
					,YANLIS		= t2.YANLIS
					,BOS		= t2.BOS
					,PUAN		= t2.PUAN
					,NET		= (CASE @YANLISSAYISI WHEN 0 THEN t2.DOGRU ELSE t2.DOGRU - t2.YANLIS / @YANLISSAYISI END)
					,YUZDEDOGRU	= CAST(t2.DOGRU AS FLOAT) / (t2.DOGRU + t2.YANLIS + t2.BOS) * 100.0
					,YUZDENET	= CAST((CASE @YANLISSAYISI WHEN 0 THEN t2.DOGRU ELSE t2.DOGRU - t2.YANLIS / @YANLISSAYISI END) AS FLOAT) / (t2.DOGRU + t2.YANLIS + t2.BOS) * 100.0
			FROM #SinavOgrenciCevapBolum CB WITH (NOLOCK)
			INNER JOIN t2 ON t2.ID_SINAVOGRENCICEVAPBOLUM = CB.ID_SINAVOGRENCICEVAPBOLUM

			PRINT '24: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #K

			
			---------------
			--PUAN KRİTER--
			---------------
			DROP TABLE IF EXISTS #KRITERLIST
			SELECT DISTINCT  SNK.ID_SINAVPUANTURU
							,SNK.ID_SINAVNETKRITER
							,SNK.NET
							,ID_DERSLIST = (
								SELECT ID_SINAVDERS
								FROM SinavNetKriterDers SNKD
								WHERE SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
								FOR JSON PATH
							) 
			INTO #KRITERLIST
			FROM SinavNetKriterDers SNKD
			JOIN SinavNetKriter SNK ON SNK.ID_SINAVNETKRITER = SNKD.ID_SINAVNETKRITER
			WHERE SNKD.ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV)

			
			DROP TABLE IF EXISTS #OGRENCISINAVPUANKRITER
			SELECT	 SO.TCKIMLIKNO
					,SPT.ID_SINAVPUANTURU
					,HESAPDURUM =	CASE 
									WHEN NOT EXISTS (SELECT 1 FROM #KRITERLIST K WHERE K.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU) THEN 1 -- PUAN TÜRÜNDE KRİTER YOK İSE
									WHEN ( 
											SELECT CASE WHEN EXISTS -- PUAN TÜRÜNDE KRİTER SAĞLANMAYAN BİR DURUM VAR İSE
											(
												SELECT 1 
												FROM (	
													SELECT /*SOCB.ID_SINAVOGRENCI, K.ID_SINAVNETKRITER, */CASE WHEN SUM(SOCB.NET) < K.NET THEN 0 ELSE 1 END AS DURUM													
													FROM vw_SinavOgrenciBolum SOCB 
													JOIN #KRITERLIST			K	ON K.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU 
																					AND SOCB.ID_SINAVDERS IN (SELECT JSON_Value (value, '$.ID_SINAVDERS') FROM OPENJSON(K.ID_DERSLIST))
													WHERE	SOCB.ID_SINAV	= SO.ID_SINAV
														AND SOCB.TCKIMLIKNO = SO.TCKIMLIKNO
													GROUP BY SOCB.ID_SINAVOGRENCI, K.ID_SINAVNETKRITER, K.NET
												) X WHERE X.DURUM = 1
											) 
											THEN 1
											ELSE 0 
											END
										) = 0 THEN 0
									ELSE 1 -- PUAN TÜRÜNDE BÜTÜN KRİTERLER SAĞLANIYOR İSE
									END
			INTO #OGRENCISINAVPUANKRITER
			FROM Sinav S
			JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU = S.ID_SINAVTURU
			JOIN #SinavOgrenci SO ON SO.ID_SINAV = S.ID_SINAV
			WHERE S.ID_SINAV = @ID_SINAV
			ORDER BY SO.TCKIMLIKNO

			DROP TABLE #KRITERLIST
			---------------
			--PUAN KRİTER--
			---------------
			
			-------------------------------
			--SinavOgrenciSonucPuanInsert--
			-------------------------------
			DECLARE @ID_SINAVTURU INT, @ID_SINAVTYT INT, @ID_SINAVDEGERLENDIR INT
			SELECT @ID_SINAVTURU = ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV
			
			DROP TABLE IF EXISTS #SinavOgrenciPuan
			CREATE TABLE #SinavOgrenciPuan(
							 TCKIMLIKNO VARCHAR(MAX)
							,[ID_SINAVPUANTURU] INT
							,[PUAN] DECIMAL(18, 3)
							,GENELSIRA INT
							,ILSIRA INT
							,ILCESIRA INT
							,OKULSIRA INT
							,SINIFSIRA INT
							)


			DROP TABLE IF EXISTS #SinavSonTyt
			CREATE TABLE #SinavSonTyt(TCKIMLIKNO VARCHAR(MAX), ID_SINAV INT, TYTPUAN DECIMAL(18, 3))

			IF @ID_SINAVTURU = 3 or @ID_SINAVTURU = 4	--	YKS
			BEGIN
				DECLARE @ID_TYTSECIMTUR INT, @TYTBARAJ DECIMAL(18, 3)
				SELECT @ID_TYTSECIMTUR = ISNULL(ID_TYTSECIMTUR, 1), @TYTBARAJ = ISNULL(PUAN, -999) FROM SinavTYTSecimTurKriter WHERE ID_SINAV = @ID_SINAV
				
				PRINT '25: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DECLARE @SINAVTARIHI DATE = (SELECT SINAVTARIH FROM Sinav WHERE ID_SINAV = @ID_SINAV)

				IF @ID_TYTSECIMTUR = 1 ------ Önceki Son Tyt Sınavının TYT Puanı
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, ID_SINAV = MAX(S.ID_SINAV), TYTPUAN = (SELECT PUAN FROM SinavOgrenciPuan WHERE ID_SINAV = MAX(S.ID_SINAV) AND TCKIMLIKNO = SP.TCKIMLIKNO)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					GROUP BY SP.TCKIMLIKNO
				END
				ELSE IF @ID_TYTSECIMTUR = 2 ------ Önceki Son Tyt Sınavının TYT Puanı (0 DAN BÜYÜK OLAN)
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, ID_SINAV = MAX(S.ID_SINAV), TYTPUAN = (SELECT PUAN FROM SinavOgrenciPuan WHERE ID_SINAV = MAX(S.ID_SINAV) AND TCKIMLIKNO = SP.TCKIMLIKNO)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					AND SP.PUAN				> 0
					GROUP BY SP.TCKIMLIKNO
				END
				ELSE IF @ID_TYTSECIMTUR = 3 ------ Önceki Tüm Tyt Sınavının TYT Puan Ortalamaları
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, 0, TYTPUAN = AVG(SP.PUAN)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					GROUP BY SP.TCKIMLIKNO
				END
				
				PRINT '28: ' + CONVERT( VARCHAR(24), GETDATE(), 121)			
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT 
							yTABLE.TCKIMLIKNO
							,yTABLE.ID_SINAVPUANTURU
							,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = yTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = yTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
									THEN 0
									ELSE (
											CASE 
												WHEN yTABLE.TYTPUAN IS NULL 
												THEN (yTABLE.TABANPUAN+yTABLE.SKATSAYI)
												ELSE (
														CASE
														WHEN @TYTBARAJ > yTABLE.TYTPUAN
														THEN 0
														ELSE ((yTABLE.TABANPUAN+yTABLE.SKATSAYI)*0.6)+(yTABLE.TYTPUAN*0.4)
														END
													)
											END
										)
							 END
							 AS PUAN
				FROM
				(
					SELECT xTABLE.TCKIMLIKNO
							,ID_SINAVPUANTURU
							,xTABLE.TABANPUAN
							,SUM(xTABLE.NET*xTABLE.KATSAYI) as SKATSAYI
							,TYT.TYTPUAN
					FROM
					(
						SELECT so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, s.SINAVTARIH 
						FROM #SinavOgrenci					so		WITH (NOLOCK)
						INNER JOIN #SinavOgrenciCevapBolum	socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
						INNER JOIN Sinav					s		WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
						INNER JOIN SinavPuanTuru			spt		WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
						INNER JOIN SinavTabanPuan			stp		WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
						INNER JOIN SinavDers				sd		WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
						INNER JOIN SinavKatsayi				SK		WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND SK.ID_SINAV=S.ID_SINAV
						WHERE so.ID_SINAV=@ID_SINAV
					) xTABLE
					LEFT JOIN #SinavSonTyt TYT ON TYT.TCKIMLIKNO = xTABLE.TCKIMLIKNO
					GROUP BY xTABLE.TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN, TYT.TYTPUAN
					
				) yTABLE


				PRINT '29: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU = 6	--	ADIM ADIM YKS
			BEGIN
				
				PRINT '30: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
				
				
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT xTABLE.TCKIMLIKNO, xTABLE.ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI))) 
						 END AS PUAN 
				FROM
				(
					SELECT so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS 
					FROM #SinavOgrenci so WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN

				UPDATE SOS SET SOS.PUAN = SOS.PUAN * 0.6 + (SELECT SUBSOS.PUAN FROM #SinavOgrenciPuan SUBSOS WITH (NOLOCK) WHERE SUBSOS.TCKIMLIKNO = SOS.TCKIMLIKNO AND SUBSOS.ID_SINAVPUANTURU = 9) * 0.4
				FROM #SinavOgrenciPuan SOS WITH (NOLOCK)
				WHERE SOS.ID_SINAVPUANTURU IN (11, 12, 13)


				

				PRINT '32: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU = 2	--	TYT
			BEGIN
				
				PRINT '33: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN


				PRINT '34: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU IN(8, 9)
			BEGIN

				PRINT '35: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
				
				SELECT SD.BOLUMNO, STANDARTSAPMA = STDEV(CB.NET) 
				INTO #StandartSapma 
				FROM #SinavOgrenciCevapBolum	CB WITH (NOLOCK)
				INNER JOIN SinavDers			SD WITH (NOLOCK)	ON SD.ID_SINAVDERS = CB.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				GROUP BY SD.BOLUMNO
				ORDER BY SD.BOLUMNO

				SELECT SD.BOLUMNO, NET = AVG(CAST(CB.NET as FLOAT)) 
				INTO #OrtalamaNet 
				FROM #SinavOgrenciCevapBolum	CB WITH (NOLOCK)
				INNER JOIN SinavDers			SD WITH (NOLOCK)	ON SD.ID_SINAVDERS = CB.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				GROUP BY SD.BOLUMNO
				ORDER BY SD.BOLUMNO

				SELECT SD.ID_SINAV, SO.TCKIMLIKNO, SD.BOLUMNO, CB.KATSAYI, TASP = CASE WHEN ST.STANDARTSAPMA = 0 THEN 0 ELSE (CB.KATSAYI * (OG.NET - OT.NET) / CAST(ST.STANDARTSAPMA AS FLOAT) * 10) + 50 END
				INTO #Tasp FROM SinavKatsayi		CB	WITH (NOLOCK)
				INNER JOIN SinavDers				SD	WITH (NOLOCK)	ON SD.ID_SINAVDERS		= CB.ID_SINAVDERS
				INNER JOIN #OrtalamaNet				OT	WITH (NOLOCK)	ON OT.BOLUMNO			= SD.BOLUMNO
				INNER JOIN #StandartSapma			ST	WITH (NOLOCK)	ON ST.BOLUMNO			= SD.BOLUMNO
				INNER JOIN #SinavOgrenci			SO	WITH (NOLOCK)	ON SO.ID_SINAV			= SD.ID_SINAV
				INNER JOIN #SinavOgrenciCevapBolum	OG	WITH (NOLOCK)	ON OG.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI	AND OG.ID_SINAVDERS = SD.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				ORDER BY SO.TCKIMLIKNO, SD.BOLUMNO

				IF @ID_SINAVTURU = 8 
				BEGIN
				
					DROP TABLE IF EXISTS #MAX_TASP
					DROP TABLE IF EXISTS #MUAF_TASP
					DROP TABLE IF EXISTS #OGRTOPLAMTASP
					DROP TABLE IF EXISTS #OgrenciDersMuaf

					SELECT	 DM.TCKIMLIKNO
							,DM.DIN_MUAF
							,DM.INGILIZCE_MUAF 
					INTO #OgrenciDersMuaf
					FROM OgrenciDersMuaf	DM
					JOIN #SinavOgrenci		SO	ON	SO.TCKIMLIKNO = DM.TCKIMLIKNO 

					IF EXISTS (SELECT TOP 1 * FROM #OgrenciDersMuaf)
					BEGIN
						SELECT BOLUMNO, MAX(TASP) MAX_TASP
						INTO #MAX_TASP
						FROM #Tasp 
						GROUP BY BOLUMNO

						DECLARE	 @DIN INT = 0
								,@ING INT = 0

						SELECT @DIN = SD.BOLUMNO 
						FROM SinavDers			SD					
						JOIN eokul_v2.dbo.Ders	ED	ON	ED.ID_DERS = SD.ID_DERS 
						WHERE	SD.ID_SINAV = @ID_SINAV
							AND ED.DERSAD LIKE '%Din Kült. Ve A. B.%'
						
						SELECT @ING = SD.BOLUMNO 
						FROM SinavDers			SD					
						JOIN eokul_v2.dbo.Ders	ED	ON	ED.ID_DERS = SD.ID_DERS 
						WHERE	SD.ID_SINAV = @ID_SINAV
							AND ED.DERSAD LIKE '%İngilizce%'

						DECLARE @DI_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @DIN AND ST.BOLUMNO != @ING	)
								,@D_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @DIN							)
								,@I_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @ING							)
								,@D_MAX_TASP	FLOAT = (SELECT MAX(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO =  @DIN							)
								,@I_MAX_TASP	FLOAT = (SELECT MAX(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO =  @ING							)

						SELECT	DISTINCT
								DI_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @DIN AND ST.BOLUMNO != @ING AND ST.TCKIMLIKNO = T.TCKIMLIKNO	)
								,D_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @DIN AND ST.TCKIMLIKNO = T.TCKIMLIKNO							)
								,I_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @ING AND ST.TCKIMLIKNO = T.TCKIMLIKNO							)
								,TCKIMLIKNO	= T.TCKIMLIKNO
								,MUAF		=  CASE	WHEN M.INGILIZCE_MUAF	= 1 AND M.DIN_MUAF = 1	THEN 1
													WHEN M.INGILIZCE_MUAF	= 1						THEN 2
													WHEN M.DIN_MUAF			= 1						THEN 3
																									ELSE 0
												END 
						INTO #OGRTOPLAMTASP
						FROM #Tasp				T
						JOIN #OgrenciDersMuaf	M	ON	M.TCKIMLIKNO = T.TCKIMLIKNO 
					
						SELECT	 ING = CASE	WHEN M.MUAF = 1 THEN (M.DI_OGR_TASP/@DI_T_TASP) * @I_MAX_TASP
											WHEN M.MUAF = 2 THEN (M.I_OGR_TASP / @I_T_TASP) * @I_MAX_TASP
											ELSE NULL
									   END 
								,DIN = CASE	WHEN M.MUAF = 1 THEN (M.DI_OGR_TASP/@DI_T_TASP) * @D_MAX_TASP
											WHEN M.MUAF = 3 THEN (M.D_OGR_TASP / @D_T_TASP) * @D_MAX_TASP
											ELSE NULL
									   END 
								,M.MUAF
								,T.TCKIMLIKNO
						INTO #MUAF_TASP
						FROM #Tasp			T
						JOIN #OGRTOPLAMTASP	M	ON	M.TCKIMLIKNO = T.TCKIMLIKNO 
					
						UPDATE T
						SET T.TASP = MT.DIN
						FROM #Tasp		T
						JOIN #MUAF_TASP	MT	ON	MT.TCKIMLIKNO	= T.TCKIMLIKNO
						WHERE	T.BOLUMNO = @DIN
							AND MT.DIN	IS NOT NULL

						UPDATE T
						SET T.TASP = MT.ING
						FROM #Tasp		T
						JOIN #MUAF_TASP	MT	ON	MT.TCKIMLIKNO	= T.TCKIMLIKNO
						WHERE	T.BOLUMNO = @ING
							AND MT.ING	IS NOT NULL

					END


					DROP TABLE IF EXISTS #MAX_TASP
					DROP TABLE IF EXISTS #MUAF_TASP
					DROP TABLE IF EXISTS #OGRTOPLAMTASP
					DROP TABLE IF EXISTS #OgrenciDersMuaf

				END


				
				--DECLARE @MIN_TASP FLOAT, @MAX_TASP FLOAT
				--SELECT @MIN_TASP = MIN(TASP), @MAX_TASP = MAX(TASP) FROM #Tasp
				DECLARE @MIN_TASP FLOAT, @MAX_TASP FLOAT
				SELECT SUM(TASP) AS TASP, TCKIMLIKNO INTO #TASPOGRENCI FROM #Tasp GROUP BY TCKIMLIKNO
				SELECT @MIN_TASP = MIN(TASP), @MAX_TASP = MAX(TASP) FROM #TASPOGRENCI

				
								
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT SO.TCKIMLIKNO, PT.ID_SINAVPUANTURU
						,PUAN = CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = PT.ID_SINAVPUANTURU AND TCKIMLIKNO = SO.TCKIMLIKNO AND HESAPDURUM = 0)
										THEN 0
										ELSE (SP.TABANPUAN + 400 * ((SELECT SUM(Z.TASP) FROM #TASP Z WHERE Z.TCKIMLIKNO=SO.TCKIMLIKNO) - @MIN_TASP) / (CASE (@MAX_TASP - @MIN_TASP) WHEN 0 THEN 1 ELSE (@MAX_TASP - @MIN_TASP) END))
								END
				FROM SinavTabanPuan			SP WITH (NOLOCK)
				INNER JOIN Sinav			SN WITH (NOLOCK)	ON SN.ID_SINAV		= SP.ID_SINAV
				INNER JOIN SinavPuanTuru	PT WITH (NOLOCK)	ON PT.ID_SINAVTURU	= SN.ID_SINAVTURU
				INNER JOIN #SinavOgrenci	SO WITH (NOLOCK)	ON SO.ID_SINAV		= SN.ID_SINAV
				where SN.ID_SINAV=@ID_SINAV


				PRINT '36: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DROP TABLE IF EXISTS #OrtalamaNet
				DROP TABLE IF EXISTS #StandartSapma
				DROP TABLE IF EXISTS #Tasp
				DROP TABLE IF EXISTS #TASPOGRENCI

			END
			ELSE IF	@ID_SINAVTURU = 12	--	BURSLULUK
					AND EXISTS (SELECT TOP 1 ID_SINAV FROM Sinav WHERE ID_SINAV = @ID_SINAV AND OLCEKSINAVI = 1)
			BEGIN
				
				PRINT '37: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),SUM(xTABLE.PUAN)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, socb.ID_SINAVDERS,socb.PUAN
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					--INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					--INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					--INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU


				PRINT '38: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
			END
			ELSE	-- STANDART
			BEGIN
				
				PRINT '37: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN


				PRINT '38: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
			END


			PRINT '39: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		IF @ID_SINAVTURU = 12 -- BURSLULUK İSE 
		BEGIN
			UPDATE SO SET 				
					 AD		= SUBSTRING(OGRENCI_ADSOYAD,0,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+1) 
					,SOYAD	= SUBSTRING(OGRENCI_ADSOYAD,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+2,LEN(OGRENCI_ADSOYAD)) 
					,SUBENO	= RIGHT('000' + SB.SUBENO, 3)
			FROM #SinavOgrenci						SO  WITH (NOLOCK) 
			INNER JOIN BurslulukSinavOgrenci		BS  WITH (NOLOCK)	ON	BS.ID_SINAV		= SO.ID_SINAV
																		AND BS.TCKIMLIKNO	= SO.TCKIMLIKNO
			INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
			LEFT  JOIN OKYANUSDB.DBO.v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= BS.ID_SUBE
		END

		UPDATE SO SET 
				 AD		= KL.AD
				,SOYAD	= KL.SOYAD
				,SINIF	= SN.AD
				,SUBENO	= RIGHT('000' + SB.SUBENO, 3)
		FROM #SinavOgrenci						SO  WITH (NOLOCK) 
		INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
		INNER JOIN OKYANUSDB.DBO.v3Kullanici	KL	WITH (NOLOCK) ON	KL.TCKIMLIKNO	= SO.TCKIMLIKNO
		INNER JOIN OKYANUSDB.DBO.v3OgrenciTum	KS	WITH (NOLOCK) ON	KS.TCKIMLIKNO	= KL.TCKIMLIKNO AND KS.DONEM = SV.DONEM
		INNER JOIN OKYANUSDB.DBO.v3SinifTum		SN	WITH (NOLOCK) ON	SN.ID_SINIF		= KS.ID_SINIF
		INNER JOIN OKYANUSDB.DBO.v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= KS.ID_SUBE
		

		PRINT '40: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
		
		select distinct SO.TCKIMLIKNO 
		into #OKY_OGRENCI
		FROM #SinavOgrenci						SO	WITH (NOLOCK) 
		INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
		INNER JOIN OKYANUSDB.DBO.v3OgrenciTum	KS	WITH (NOLOCK) ON	KS.TCKIMLIKNO	= SO.TCKIMLIKNO AND KS.DONEM = SV.DONEM
		

		PRINT '41: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		UPDATE SO SET 
				 SUBENO	= RIGHT('000' + ISNULL( SB.SUBENO,SO.SUBENO), 3)
				,SINIF	= 'OKY-'+ SO.SINIF						
		FROM #SinavOgrenci			SO	WITH (NOLOCK) 
		INNER JOIN SinavDosya		SD	WITH (NOLOCK) ON	SD.ID_SINAVDOSYA= SO.ID_SINAVDOSYA	
		LEFT  JOIN v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= SD.ID_SUBE
		WHERE SO.TCKIMLIKNO  NOT IN (SELECT DISTINCT TCKIMLIKNO	   FROM #OKY_OGRENCI)

		
		PRINT '42: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		
		

		DROP TABLE IF EXISTS #OKY_OGRENCI
		DROP TABLE IF EXISTS #SinavDers

		PRINT '57: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
	

	END

	BEGIN		
				

		PRINT '59: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
	

		----- TOPLAMLAR
		SELECT 
				SO.TCKIMLIKNO
			,SO.ID_SINAV
			,TD = SUM(CB.DOGRU)
			,TY = SUM(CB.YANLIS)
			,TB = SUM(CB.BOS)
			,TN = (CASE @YANLISSAYISI WHEN 0 THEN SUM(CB.DOGRU) ELSE SUM(CB.DOGRU) - (SUM(CB.YANLIS) / @YANLISSAYISI) END)
			,ID_SUBE		= ISNULL(SB.ID_SUBE , 0)
			,ID_SINIF		= ISNULL(OG.ID_SINIF, 0)
			,IL				= ISNULL(SB.IL, '')
			,ILCE			= ISNULL(SB.ILCE, '')
			,SINIF			= SO.SINIF
		INTO #SinavOgrenciToplam 
		FROM #SinavOgrenci						SO
		INNER JOIN Sinav						SV	ON	SV.ID_SINAV				= SO.ID_SINAV
		INNER JOIN #SinavOgrenciCevapBolum		CB	ON	CB.ID_SINAVOGRENCI		= SO.ID_SINAVOGRENCI
		LEFT  JOIN OkyanusDB.dbo.V3Sube			SB	ON	CASt(SB.SUBENO AS INT)	= CASt(SO.SUBENO AS INT)
		LEFT  JOIN OkyanusDB.dbo.V3OgrenciTum	OG	ON	OG.TCKIMLIKNO			= SO.TCKIMLIKNO		AND OG.DONEM = SV.DONEM
		GROUP BY SO.TCKIMLIKNO, SO.ID_SINAV, SB.ID_SUBE, OG.ID_SINIF, SB.IL, SB.ILCE, SO.SINIF
		----------------------------------------------------------------------------------------------------		


	--BEGIN TRAN T_SINAV;

	BEGIN
		DELETE FROM SinavOgrenci 
		WHERE ID_SINAV = @ID_SINAV


		DELETE FROM SinavOgrenciToplam
		WHERE ID_SINAV = @ID_SINAV

		DELETE FROM SinavOgrenciPuan
		WHERE ID_SINAV = @ID_SINAV
				
		DELETE FROM BurslulukSinavOgrenciSonuc
		WHERE ID_SINAV = @ID_SINAV

	END

	PRINT '60: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	INSERT INTO [dbo].[SinavOgrenci]
				([ID_SINAV]
				,[TCKIMLIKNO]
				,[AD]
				,[SOYAD]
				,[KITAPCIK]
				,[SUBENO]
				,[SINIF]
				,[ID_SINAVDOSYA]
				,[ID_SINAVOPTIKTEMP]
				,TEMP_ID_SINAVOGRENCI
				,TEMP_GUID)
			SELECT
				 SO.[ID_SINAV]
				,SO.[TCKIMLIKNO]
				,SO.[AD]
				,SO.[SOYAD]
				,SO.[KITAPCIK]
				,SO.[SUBENO]
				,SO.[SINIF]
				,SO.[ID_SINAVDOSYA]
				,SO.[ID_SINAVOPTIKTEMP]
				,SO.ID_SINAVOGRENCI
				,@GUID
			FROM #SinavOgrenci				SO


	PRINT '61: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	UPDATE CB SET CB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
	FROM #SinavOgrenciCevapBolum	CB
	JOIN SinavOgrenci				SO	ON	SO.TEMP_ID_SINAVOGRENCI = CB.ID_SINAVOGRENCI AND SO.TEMP_GUID = @GUID AND SO.ID_SINAV = @ID_SINAV

	PRINT '62: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

	

			--	PUANLAR
			INSERT INTO SinavOgrenciPuan(ID_SINAV, TCKIMLIKNO, ID_SINAVPUANTURU, PUAN, GENELSIRA, ILSIRA, ILCESIRA, OKULSIRA, SINIFSIRA)
			SELECT DISTINCT
			 @ID_SINAV
			,TCKIMLIKNO
			,ID_SINAVPUANTURU
			,PUAN
			,GENELSIRA
			,ILSIRA
			,ILCESIRA
			,OKULSIRA
			,SINIFSIRA
			FROM #SinavOgrenciPuan

		
		
			SELECT DISTINCT
				 SO.TCKIMLIKNO
				,SO.ID_SINAV
				,SC.ID_SINAVPUANTURU
				,SC.PUAN
				,ID_SUBE		= ISNULL(ST.ID_SUBE , 0)
				,ID_SINIF		= ISNULL(ST.ID_SINIF, 0)
				,IL				= ISNULL(ST.IL, '')
				,ILCE			= ISNULL(ST.ILCE, '')
				,SINIF			= SO.SINIF
			INTO #SinavOgrenciPuanSiraPuan
			FROM SinavOgrenci						SO
			INNER JOIN Sinav						SV	ON	SV.ID_SINAV	= SO.ID_SINAV
			INNER JOIN SinavOgrenciPuan				SC	ON	SC.ID_SINAV	= SV.ID_SINAV	AND SC.TCKIMLIKNO	= SO.TCKIMLIKNO	
			LEFT JOIN  #SinavOgrenciToplam			ST  ON  ST.ID_SINAV	= SV.ID_SINAV	AND ST.TCKIMLIKNO	= SO.TCKIMLIKNO
			--LEFT  JOIN OkyanusDB.dbo.V3Sube			SB	ON	CASt(SB.SUBENO AS INT)	= CASt(SO.SUBENO AS INT)
			--LEFT  JOIN OkyanusDB.dbo.v3OgrenciTum	OG	ON	OG.TCKIMLIKNO			= SO.TCKIMLIKNO AND OG.DONEM = SV.DONEM
			WHERE SV.ID_SINAV = @ID_SINAV	

			SELECT	 *
					,GENELSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU								ORDER BY PUAN DESC)
					,ILSIRA			= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, IL							ORDER BY PUAN DESC)
					,ILCESIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, IL, ILCE					ORDER BY PUAN DESC) 
					,OKULSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, ID_SUBE					ORDER BY PUAN DESC)
					,SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, ID_SUBE, ID_SINIF, SINIF	ORDER BY PUAN DESC)
			INTO #SinavOgrenciPuanSira
			FROM #SinavOgrenciPuanSiraPuan

			UPDATE SC	set 
					 GENELSIRA		= OG.GENELSIRA	
					,ILSIRA			= OG.ILSIRA		
					,ILCESIRA		= OG.ILCESIRA	
					,OKULSIRA		= OG.OKULSIRA	
					,SINIFSIRA		= OG.SINIFSIRA	
			FROM SinavOgrenciPuan				SC
			INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO = SC.TCKIMLIKNO
			INNER JOIN #SinavOgrenciPuanSira	OG	ON	OG.TCKIMLIKNO = SO.TCKIMLIKNO AND OG.ID_SINAV = SO.ID_SINAV AND OG.ID_SINAVPUANTURU = SC.ID_SINAVPUANTURU
			WHERE SC.ID_SINAV = @ID_SINAV

			DROP TABLE #SinavOgrenciPuanSiraPuan
			DROP TABLE #SinavOgrenciPuanSira 



			INSERT INTO [dbo].[SinavOgrenciSonuc]
							([ID_SINAVOGRENCI]
							,[ID_SINAVPUANTURU]
							,[PUAN]
							,GENELSIRA
							,ILSIRA
							,ILCESIRA
							,OKULSIRA
							,SINIFSIRA)

		SELECT 
							 SO.ID_SINAVOGRENCI
							,SP.ID_SINAVPUANTURU
							,SP.PUAN
							,SP.GENELSIRA
							,SP.ILSIRA
							,SP.ILCESIRA
							,SP.OKULSIRA
							,SP.SINIFSIRA
		FROM SinavOgrenci				SO
		INNER JOIN SinavOgrenciPuan		SP	ON	SP.TCKIMLIKNO = SO.TCKIMLIKNO AND SP.ID_SINAV = SO.ID_SINAV
		WHERE SP.ID_SINAV = @ID_SINAV
			--------------------------------------------------------------------


		PRINT '64: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		SELECT 
				 SO.[ID_SINAVOGRENCI]
				,SO.[ID_SINAVDERS]
				,SO.[CEVAPLAR]
				,SO.[DOGRU]
				,SO.[YANLIS]
				,SO.[BOS]
				,SO.[NET]
				,SO.[YUZDEDOGRU]
				,SO.[YUZDENET]
				,SO.[PUAN]
				,SO.ID_SINAVOGRENCICEVAPBOLUM
				,GUID = @GUID
				,PUAN_GENELSIRA		= 0
				,PUAN_ILSIRA		= 0
				,PUAN_ILCESIRA		= 0
				,PUAN_OKULSIRA		= 0
				,PUAN_SINIFSIRA		= 0
				,ST.IL
				,ST.ILCE
				,ST.ID_SUBE
				,ST.ID_SINIF
				,ST.SINIF
		INTO #SinavOgrenciCevapBolumSira
		FROM #SinavOgrenciCevapBolum	SO
		JOIN #SinavOgrenciToplam		ST	ON	ST.TCKIMLIKNO = SO.TCKIMLIKNO


		INSERT INTO [dbo].[SinavOgrenciCevapBolum]
					([ID_SINAVOGRENCI]
					,[ID_SINAVDERS]
					,[CEVAPLAR]
					,[DOGRU]
					,[YANLIS]
					,[BOS]
					,[NET]
					,[YUZDEDOGRU]
					,[YUZDENET]
					,[PUAN]
					,TEMP_ID_SINAVOGRENCICEVAPBOLUM
					,TEMP_GUID
					,PUAN_GENELSIRA
					,PUAN_ILSIRA
					,PUAN_ILCESIRA
					,PUAN_OKULSIRA
					,PUAN_SINIFSIRA

					,NET_GENELSIRA
					,NET_ILSIRA
					,NET_ILCESIRA
					,NET_OKULSIRA
					,NET_SINIFSIRA

					,DOGRU_GENELSIRA
					,DOGRU_ILSIRA
					,DOGRU_ILCESIRA
					,DOGRU_OKULSIRA
					,DOGRU_SINIFSIRA
					
					
					
					)
		SELECT 
					 SO.[ID_SINAVOGRENCI]
					,SO.[ID_SINAVDERS]
					,SO.[CEVAPLAR]
					,SO.[DOGRU]
					,SO.[YANLIS]
					,SO.[BOS]
					,SO.[NET]
					,SO.[YUZDEDOGRU]
					,SO.[YUZDENET]
					,SO.[PUAN]
					,SO.ID_SINAVOGRENCICEVAPBOLUM
					,@GUID
					,PUAN_GENELSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.PUAN DESC)
					,PUAN_ILSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.PUAN DESC)
					,PUAN_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.PUAN DESC)
					,PUAN_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.PUAN DESC)
					,PUAN_SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.PUAN DESC)
					
					,NET_GENELSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.NET DESC)
					,NET_ILSIRA			= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.NET DESC)
					,NET_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.NET DESC)
					,NET_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.NET DESC)
					,NET_SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.NET DESC)
					
					,DOGRU_GENELSIRA	= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.DOGRU DESC)
					,DOGRU_ILSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.DOGRU DESC)
					,DOGRU_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.DOGRU DESC)
					,DOGRU_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.DOGRU DESC)
					,DOGRU_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.DOGRU DESC)
			FROM #SinavOgrenciCevapBolumSira	SO


			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #GENELORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,IL
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #ILORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,IL

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,IL
				,ILCE
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #ILCEORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,IL,ILCE

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,ID_SUBE
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #OKULORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,ID_SUBE

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,ST.ID_SUBE
				,ST.ID_SINIF
				,ST.SINIF
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #SINIFORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS, ST.ID_SUBE, ST.ID_SINIF, ST.SINIF
			


			UPDATE CB SET
				 CB.NET_GENELORT		=  G.NET_ORT
				,CB.NET_ILORT			=  I.NET_ORT
				,CB.NET_ILCEORT			= IC.NET_ORT
				,CB.NET_OKULORT			=  O.NET_ORT
				,CB.NET_SINIFORT		=  S.NET_ORT
								
				,CB.DOGRU_GENELORT		=  G.DOGRU_ORT
				,CB.DOGRU_ILORT			=  I.DOGRU_ORT
				,CB.DOGRU_ILCEORT		= IC.DOGRU_ORT
				,CB.DOGRU_OKULORT		=  O.DOGRU_ORT
				,CB.DOGRU_SINIFORT		=  S.DOGRU_ORT
				
				,CB.YUZDENET_GENELORT	=  G.YUZDENET_ORT
				,CB.YUZDENET_ILORT		=  I.YUZDENET_ORT
				,CB.YUZDENET_ILCEORT	= IC.YUZDENET_ORT
				,CB.YUZDENET_OKULORT	=  O.YUZDENET_ORT
				,CB.YUZDENET_SINIFORT	=  S.YUZDENET_ORT

			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN  #SinavOgrenciToplam	ST	ON	ST.ID_SINAV			= SO.ID_SINAV		AND ST.TCKIMLIKNO   = SO.TCKIMLIKNO
			LEFT JOIN  #GENELORT			G	ON	 G.ID_SINAVDERS		= CB.ID_SINAVDERS 
			LEFT JOIN  #ILORT				I	ON	 I.ID_SINAVDERS		= CB.ID_SINAVDERS	AND I.IL		= ST.IL
			LEFT JOIN  #ILCEORT				IC	ON	IC.ID_SINAVDERS		= CB.ID_SINAVDERS	AND IC.IL		= ST.IL			AND IC.ILCE = ST.ILCE
			LEFT JOIN  #OKULORT				O	ON	 O.ID_SINAVDERS		= CB.ID_SINAVDERS	AND O.ID_SUBE	= ST.ID_SUBE
			LEFT JOIN  #SINIFORT			S	ON	 S.ID_SINAVDERS		= CB.ID_SINAVDERS	AND S.ID_SUBE	= ST.ID_SUBE	AND S.ID_SINIF	= ST.ID_SINIF	AND S.SINIF	= ST.SINIF
			WHERE SO.ID_SINAV = @ID_SINAV




			DROP TABLE #GENELORT
			DROP TABLE #ILCEORT
			DROP TABLE #ILORT
			DROP TABLE #OKULORT
			DROP TABLE #SINIFORT

			DROP TABLE #SinavOgrenciCevapBolumSira

			
		
		PRINT '65: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		UPDATE CB SET CB.ID_SINAVOGRENCICEVAPBOLUM = SO.ID_SINAVOGRENCICEVAPBOLUM
		FROM #SinavOgrenciCevap			CB
		JOIN SinavOgrenciCevapBolum		SO	ON	SO.TEMP_ID_SINAVOGRENCICEVAPBOLUM = CB.ID_SINAVOGRENCICEVAPBOLUM AND SO.TEMP_GUID = @GUID
		JOIN SinavDers					SD	ON	SD.ID_SINAVDERS	= SO.ID_SINAVDERS	AND SD.ID_SINAV = @ID_SINAV


		PRINT '66: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


		INSERT INTO SinavOgrenciCevap
							([ID_SINAVOGRENCICEVAPBOLUM]
							,[SORUNO]
							,[CEVAP]
							,[DURUM])
		SELECT
							 [ID_SINAVOGRENCICEVAPBOLUM]
							,[SORUNO]
							,[CEVAP]
							,[DURUM]
			FROM #SinavOgrenciCevap

	
	
		INSERT INTO [dbo].[SinavOgrenciToplam]
           ([TCKIMLIKNO]
           ,[ID_SINAV]
           ,[TD]
           ,[TY]
           ,[TB]
           ,[TN]
           ,[TD_GENELSIRA]
           ,[TD_ILSIRA]
           ,[TD_ILCESIRA]
           ,[TD_OKULSIRA]
           ,[TD_SINIFSIRA]
           ,[TN_GENELSIRA]
           ,[TN_ILSIRA]
           ,[TN_ILCESIRA]
           ,[TN_OKULSIRA]
           ,[TN_SINIFSIRA]
		   ,KATILIM_GENEL
		   ,KATILIM_IL
		   ,KATILIM_ILCE
		   ,KATILIM_OKUL
		   ,KATILIM_SINIF)

		SELECT 
			 TCKIMLIKNO
			,ID_SINAV
			,TD
			,TY
			,TB
			,TN
			,TD_GENELSIRA	= DENSE_RANK() OVER(										ORDER BY TD DESC)
			,TD_ILSIRA		= DENSE_RANK() OVER(PARTITION BY IL							ORDER BY TD DESC)
			,TD_ILCESIRA	= DENSE_RANK() OVER(PARTITION BY ILCE						ORDER BY TD DESC)
			,TD_OKULSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE					ORDER BY TD DESC)
			,TD_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE, ID_SINIF, SINIF	ORDER BY TD DESC)
			,TN_GENELSIRA	= DENSE_RANK() OVER(										ORDER BY TN DESC)
			,TN_ILSIRA		= DENSE_RANK() OVER(PARTITION BY IL							ORDER BY TN DESC)
			,TN_ILCESIRA	= DENSE_RANK() OVER(PARTITION BY ILCE						ORDER BY TN DESC)
			,TN_OKULSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE					ORDER BY TN DESC)
			,TN_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE, ID_SINIF, SINIF	ORDER BY TN DESC) 
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.IL = SO.IL)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.IL = SO.IL AND SUB.ILCE = SO.ILCE)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.ID_SUBE	= SO.ID_SUBE)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.ID_SUBE	= SO.ID_SUBE	AND SUB.ID_SINIF = SO.ID_SINIF	AND SUB.SINIF = SO.SINIF)
		FROM #SinavOgrenciToplam	SO

	PRINT '67: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	IF (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV) = 12 -- BURSLULUK İSE
	BEGIN
	
			
		DROP TABLE IF EXISTS #W_BURS
		DROP TABLE IF EXISTS #TEMP_BURS
		DROP TABLE IF EXISTS #BURSPUAN
		DROP TABLE IF EXISTS #BURSDERS

	
			BEGIN	--	PUAN

				SELECT TCKIMLIKNO,PUAN,BO.*,ROW_NUMBER () OVER(PARTITION BY ID_BURSORAN ORDER BY PUAN DESC) RN
				INTO #BURSPUAN
				FROM vw_SinavOgrenciPuan		SP
				JOIN BurslulukSinavBursOrani	BO	ON	BO.BURSTUR		= 1	-- PUAN
													AND BO.MIN_DEGER	<= SP.PUAN
				WHERE SP.ID_SINAV = @ID_SINAV 

				CREATE TABLE #TEMP_BURS (TCKIMLIKNO VARCHAR(11),BURSORANI INT,ID_SINAV INT ,ID_SINAVDERS INT ,BURSTUR INT)

				SELECT MIN_DEGER,BURSORANI,OGRENCISAYISI,ROW_NUMBER () OVER(ORDER BY BURSORANI DESC) RN INTO #W_BURS FROM BurslulukSinavBursOrani WHERE ID_SINAV = @ID_SINAV AND BURSTUR = 1

				DECLARE	 @COUNT_BURS	INT = (SELECT COUNT(1) FROM #W_BURS)
						,@I_BURS		INT = 1
						,@MIN_DEGER		INT
						,@BURSORANI		INT
						,@OGRENCISAYISI INT

				WHILE (@I_BURS <= @COUNT_BURS)
				BEGIN
					SELECT @MIN_DEGER=MIN_DEGER,@BURSORANI=BURSORANI,@OGRENCISAYISI=OGRENCISAYISI FROM #W_BURS WHERE RN = @I_BURS

					INSERT INTO #TEMP_BURS  (TCKIMLIKNO,BURSORANI,ID_SINAV,BURSTUR)
					SELECT TOP (@OGRENCISAYISI) TCKIMLIKNO,@BURSORANI,ID_SINAV,BURSTUR
					FROM #BURSPUAN BP				
					WHERE	PUAN >= @MIN_DEGER
						AND TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #TEMP_BURS)

					SET @I_BURS = @I_BURS +1 
				END
			
				INSERT INTO BurslulukSinavOgrenciSonuc (TCKIMLIKNO,BURSORANI,ID_SINAV,BURSTUR)
				SELECT TCKIMLIKNO,BURSORANI,@ID_SINAV,1 FROM #TEMP_BURS 

			END


			BEGIN	--	DERS
				SELECT TCKIMLIKNO,YUZDENET,BO.*
				INTO #BURSDERS
				FROM vw_SinavOgrenciBolum		SB
				JOIN BurslulukSinavBursOrani	BO	ON	BO.ID_SINAVDERS	= SB.ID_SINAVDERS
													AND	BO.BURSTUR		= 2	-- PUAN
													AND BO.MAX_DEGER	>= SB.YUZDENET
													AND BO.MIN_DEGER	<= SB.YUZDENET
				WHERE SB.ID_SINAV = @ID_SINAV

				INSERT INTO BurslulukSinavOgrenciSonuc (TCKIMLIKNO,BURSORANI,ID_SINAV,ID_SINAVDERS,BURSTUR)
				SELECT TCKIMLIKNO,BURSORANI,ID_SINAV,ID_SINAVDERS,BURSTUR
				FROM #BURSDERS
				ORDER BY BURSORANI DESC
			END

			
		DROP TABLE IF EXISTS #W_BURS
		DROP TABLE IF EXISTS #TEMP_BURS
		DROP TABLE IF EXISTS #BURSPUAN
		DROP TABLE IF EXISTS #BURSDERS

	END

	--COMMIT TRAN T_SINAV

	
	
	UPDATE Sinav	SET DURUM = 2, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV	


	IF EXISTS (SELECT TOP 1 TCKIMLIKNO FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV)
		EXEC [dbo].[sp_SinavHariciPuanSira] @ISLEM = 3, @DOGRULAMA = '693M161f1Sv595Y', @ID_SINAV = @ID_SINAV	-- PUAN VE SIRALAMA BILGILERINI DEĞİŞTİRİYOR


	DROP TABLE IF EXISTS #SinavOgrenci
	DROP TABLE IF EXISTS #SinavOgrenciCevap
	DROP TABLE IF EXISTS #SinavOgrenciCevapBolum
	DROP TABLE IF EXISTS #SinavSonTyt
	DROP TABLE IF EXISTS #SinavOgrenciToplam

	DROP TABLE IF EXISTS #SinavSoruIslem
	DROP TABLE IF EXISTS #Temp
	DROP TABLE IF EXISTS #Temp2
	DROP TABLE IF EXISTS #OGRENCISINAVPUANKRITER

	END
	
	END TRY
	BEGIN CATCH
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = 'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' + ERROR_MESSAGE() + ', ID_SINAV: ' + CAST(@ID_SINAV AS VARCHAR)

		EXEC sp_HataMailiGonder @MSG,
								@ErrorSeverity,@ErrorState,'sp_OptikIslemleri'

		
		UPDATE SinavDegerlendir SET AKTIF = 0							WHERE ID_SINAV	= @ID_SINAV
		UPDATE Sinav			SET DURUM = 0, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV
		
		--IF(@@TRANCOUNT > 0)
		--	ROLLBACK TRAN T_SINAV
		
		--IF (XACT_STATE()) = -1
		--  BEGIN
		--	 ROLLBACK TRAN T_SINAV;
		--  END;
	  	
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_DisOgrenci]...';


GO
-- =============================================
-- Author:		<Gökhan Kahraman>
-- Create date: <24-12-2020>
-- Description:	<dbo.DisOgrenci>
-- =============================================
ALTER PROCEDURE [dbo].[sp_DisOgrenci] 
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					=NULL,
	@SQLJSON			varchar(MAX)		='',
	@ID_SINAV			INT					=NULL,
	@TCKIMLIKNO			VARCHAR(11)			=NULL,
	@OTURUM				VARCHAR(36)			= NULL

AS
BEGIN
SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU

		IF @return_variable = 1
		BEGIN
			IF @ISLEM=1 --DisOgrenci Listele
			BEGIN

			SELECT 
				DO.ID_DIS_OGRENCI
				,DO.TCKIMLIKNO
				,DO.AD
				,DO.SOYAD
				,DO.ID_KADEME3
				,K.AD
				,DO.DONEM
				,D.ACIKLAMA AS DONEM_ACIKLAMA
				,DO.EPOSTA
				,DO.VELI_AD_SOYAD
				,DO.SIFRE
				,DO.KYE_TCKIMLIKNO
				,DO.AKTIF  
				FROM DisOgrenci AS DO
		 JOIN OkyanusDB.dbo.v3AktifDonem AS D ON DO.DONEM=D.DONEM
		 JOIN OkyanusDB.dbo.v3Kademe3 AS K ON DO.ID_KADEME3=K.ID_KADEME3 FOR JSON AUTO			
			END

		IF @ISLEM=2 -- DisOgrenci EXCEL YUKLE
			BEGIN
			--JSON kontrolü
			If (ISJSON(@SQLJSON)=1)
				BEGIN
					 --TempTable Json ile dolduruluyor			
						SELECT TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBENO
						INTO #TMP_DisOgrenci
						FROM OPENJSON(@SQLJSON)
						WITH(TCKIMLIKNO VARCHAR(11),AD VARCHAR(200),SOYAD VARCHAR(200),ID_KADEME3 INT,DONEM INT,EPOSTA NVARCHAR(320),VELI_AD_SOYAD VARCHAR(300),KYE_TCKIMLIKNO VARCHAR(11),SUBENO INT)

					IF (SELECT COUNT(*) FROM #TMP_DisOgrenci)>0
					BEGIN
					--TC kimlik numarası daha önce eklenmemiş DisOgrenci tablosuna yazılıyor

					SELECT TCESKI = K.TCKIMLIKNO, TCYENI = CONVERT(varchar(11),CONVERT(bigint, K.TCKIMLIKNO) + 1 )
					INTO #KUL
					FROM v3Kullanici K 
					JOIN v3SubeYetki SY ON K.TCKIMLIKNO = SY.TCKIMLIKNO
					
					SELECT TCESKI = TCKIMLIKNO, TCYENI = CONVERT(varchar(11),CONVERT(bigint, K.TCKIMLIKNO) + 1 )
					INTO #ONL
					FROM Tbl_OnlineSinavOgrenci K 
					
					
					 INSERT INTO DisOgrenci 
								(TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBE_NO)
								SELECT TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBENO
								FROM #TMP_DisOgrenci T
								WHERE	NOT EXISTS (SELECT TOP 1 1 FROM DisOgrenci D WHERE D.TCKIMLIKNO = T.TCKIMLIKNO)
									AND NOT EXISTS (SELECT TOP 1 1 FROM #KUL K WHERE K.TCYENI = T.TCKIMLIKNO)
									--AND NOT EXISTS (SELECT TOP 1 1 FROM v3Kullanici K JOIN v3SubeYetki SY ON K.TCKIMLIKNO = SY.TCKIMLIKNO WHERE  CONVERT(varchar(11),CONVERT(bigint, K.TCKIMLIKNO)) = T.TCKIMLIKNO) --  CAST((CAST(K.TCKIMLIKNO  AS bigint) + 1) AS varchar(MAX)) = T.TCKIMLIKNO )
								 -- AND TCKIMLIKNO NOT IN(SELECT CAST((CAST(K.TCKIMLIKNO  AS bigint) + 1) AS varchar) FROM v3Kullanici AS K JOIN v3SubeYetki AS SY ON K.TCKIMLIKNO=SY.TCKIMLIKNO)
								 
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV AS ID_SINAV, J.TCKIMLIKNO , @TCKIMLIKNO FROM OPENJSON(@SQLJSON) WITH (TCKIMLIKNO VARCHAR(MAX)) J
					WHERE 
						NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND CAST((CAST(OS.TCKIMLIKNO  AS bigint) + 1) AS varchar(MAX)) = J.TCKIMLIKNO)
						--AND JSON_VALUE(VALUE,'$.TCKIMLIKNO') NOT IN(SELECT TCKIMLIKNO FROM v3Kullanici)
						AND NOT EXISTS (SELECT TOP 1 1 FROM #KUL K WHERE K.TCYENI = J.TCKIMLIKNO)
					
					
					CREATE TABLE #TMP_KurumIci(TCKIMLIKNO VARCHAR(50),AD VARCHAR(200),SOYAD VARCHAR(200))
					INSERT INTO #TMP_KurumIci (TCKIMLIKNO,AD,SOYAD)
					SELECT JSON_VALUE(VALUE,'$.TCKIMLIKNO'),JSON_VALUE(VALUE,'$.AD'),JSON_VALUE(VALUE,'$.SOYAD') FROM OPENJSON(@SQLJSON) J
					WHERE JSON_VALUE(VALUE,'$.TCKIMLIKNO') IN(SELECT TCKIMLIKNO FROM v3Kullanici)
					SELECT ISNULL((
					SELECT TCKIMLIKNO,AD,SOYAD FROM #TMP_KurumIci
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')					
					
					END
					--Temp table siliniyor
					DROP TABLE #TMP_DisOgrenci;
				END
			END

		END

	END TRY

	BEGIN CATCH
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH
 
END
GO
PRINT N'Refreshing [dbo].[sp_OturumKontrol]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OturumKontrol]';


GO
PRINT N'Refreshing [dbo].[sp_SinavSonuclari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavSonuclari]';


GO
PRINT N'Refreshing [dbo].[sp_Sube]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Sube]';


GO
PRINT N'Refreshing [dbo].[sp_Grup]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Grup]';


GO
PRINT N'Refreshing [dbo].[sp_Sinif]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Sinif]';


GO
PRINT N'Refreshing [dbo].[sp_Ogrenci]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Ogrenci]';


GO
PRINT N'Refreshing [dbo].[sp_Sinav2]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Sinav2]';


GO
PRINT N'Refreshing [dbo].[sp_Abide]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Abide]';


GO
PRINT N'Refreshing [dbo].[sp_AraKarne]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AraKarne]';


GO
PRINT N'Refreshing [dbo].[sp_AraKarneCoklu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AraKarneCoklu]';


GO
PRINT N'Refreshing [dbo].[sp_AraKarneCokluEski]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AraKarneCokluEski]';


GO
PRINT N'Refreshing [dbo].[sp_AraKarneEski]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AraKarneEski]';


GO
PRINT N'Refreshing [dbo].[sp_BirimYetki]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_BirimYetki]';


GO
PRINT N'Refreshing [dbo].[sp_BurslulukBursOraniBelirle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_BurslulukBursOraniBelirle]';


GO
PRINT N'Refreshing [dbo].[sp_BurslulukOgrenciIslemleri]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_BurslulukOgrenciIslemleri]';


GO
PRINT N'Refreshing [dbo].[sp_CevapAnahtariDuzenle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_CevapAnahtariDuzenle]';


GO
PRINT N'Refreshing [dbo].[sp_CevapAnahtariKullaniciYetki]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_CevapAnahtariKullaniciYetki]';


GO
PRINT N'Refreshing [dbo].[sp_Degerlendirme]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Degerlendirme]';


GO
PRINT N'Refreshing [dbo].[sp_DemoOgrenci]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_DemoOgrenci]';


GO
PRINT N'Refreshing [dbo].[sp_DenemeSinavRaporlari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_DenemeSinavRaporlari]';


GO
PRINT N'Refreshing [dbo].[sp_DersCalismaProgrami]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_DersCalismaProgrami]';


GO
PRINT N'Refreshing [dbo].[sp_DersUnite]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_DersUnite]';


GO
PRINT N'Refreshing [dbo].[sp_Dokuman]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Dokuman]';


GO
PRINT N'Refreshing [dbo].[sp_Donem]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Donem]';


GO
PRINT N'Refreshing [dbo].[sp_DSNetPuanOrtalamalariOS]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_DSNetPuanOrtalamalariOS]';


GO
PRINT N'Refreshing [dbo].[sp_Etut]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Etut]';


GO
PRINT N'Refreshing [dbo].[sp_EtutOgretmenRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutOgretmenRapor]';


GO
PRINT N'Refreshing [dbo].[sp_EtutProgramiOV]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutProgramiOV]';


GO
PRINT N'Refreshing [dbo].[sp_EtutSabitOlustur]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutSabitOlustur]';


GO
PRINT N'Refreshing [dbo].[sp_EtutSinifRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutSinifRapor]';


GO
PRINT N'Refreshing [dbo].[sp_EtutTakvimi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutTakvimi]';


GO
PRINT N'Refreshing [dbo].[sp_FrekansSistem]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_FrekansSistem]';


GO
PRINT N'Refreshing [dbo].[sp_FrekansSistemEksikKazanim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_FrekansSistemEksikKazanim]';


GO
PRINT N'Refreshing [dbo].[sp_GelisimRaporu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GelisimRaporu]';


GO
PRINT N'Refreshing [dbo].[sp_GelisimRaporuLS]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GelisimRaporuLS]';


GO
PRINT N'Refreshing [dbo].[sp_GelisimRaporuOgrenciBelge]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GelisimRaporuOgrenciBelge]';


GO
PRINT N'Refreshing [dbo].[sp_GelisimRaporuOO]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GelisimRaporuOO]';


GO
PRINT N'Refreshing [dbo].[sp_GenelKazanimAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GenelKazanimAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_GenelListeler]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GenelListeler]';


GO
PRINT N'Refreshing [dbo].[sp_GenelSinavRaporu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GenelSinavRaporu]';


GO
PRINT N'Refreshing [dbo].[sp_GenelSoruAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GenelSoruAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_HataLog]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_HataLog]';


GO
PRINT N'Refreshing [dbo].[sp_HedefBelirlemeRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_HedefBelirlemeRapor]';


GO
PRINT N'Refreshing [dbo].[sp_KarmaListe]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KarmaListe]';


GO
PRINT N'Refreshing [dbo].[sp_KarmaListe3]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KarmaListe3]';


GO
PRINT N'Refreshing [dbo].[sp_KazanimAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KazanimAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_KazanimAnaliziOO]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KazanimAnaliziOO]';


GO
PRINT N'Refreshing [dbo].[sp_KonuAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KonuAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_KonuAnaliziCoklu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KonuAnaliziCoklu]';


GO
PRINT N'Refreshing [dbo].[sp_KullaniciYetki]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KullaniciYetki]';


GO
PRINT N'Refreshing [dbo].[sp_LUSRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_LUSRapor]';


GO
PRINT N'Refreshing [dbo].[sp_MaddeFrekansAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_MaddeFrekansAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_OdevTakibi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OdevTakibi]';


GO
PRINT N'Refreshing [dbo].[sp_OdulListesi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OdulListesi]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciDersMuaf]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciDersMuaf]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciFrekansMuaf]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciFrekansMuaf]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciHedef]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciHedef]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciHedefOO]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciHedefOO]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciIzleme]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciIzleme]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciMaddeAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciMaddeAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciRaporlari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciRaporlari]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciTakvim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciTakvim]';


GO
PRINT N'Refreshing [dbo].[sp_OkulNetPuanOrtalamalari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OkulNetPuanOrtalamalari]';


GO
PRINT N'Refreshing [dbo].[sp_OkulRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OkulRapor]';


GO
PRINT N'Refreshing [dbo].[sp_OkulRaporEski]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OkulRaporEski]';


GO
PRINT N'Refreshing [dbo].[sp_OptikYukle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OptikYukle]';


GO
PRINT N'Refreshing [dbo].[sp_OrtalamaListesi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OrtalamaListesi]';


GO
PRINT N'Refreshing [dbo].[sp_OSYM]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OSYM]';


GO
PRINT N'Refreshing [dbo].[sp_ProjeDonem]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_ProjeDonem]';


GO
PRINT N'Refreshing [dbo].[sp_ProjeDonemRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_ProjeDonemRapor]';


GO
PRINT N'Refreshing [dbo].[sp_PuanaGoreYaziliSonuclari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_PuanaGoreYaziliSonuclari]';


GO
PRINT N'Refreshing [dbo].[sp_RehberlikEnvanter]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_RehberlikEnvanter]';


GO
PRINT N'Refreshing [dbo].[sp_RehberlikEnvanterTanimlama]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_RehberlikEnvanterTanimlama]';


GO
PRINT N'Refreshing [dbo].[sp_SinavaKatilmayanOgrenciler]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavaKatilmayanOgrenciler]';


GO
PRINT N'Refreshing [dbo].[sp_SinavAnaliz]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavAnaliz]';


GO
PRINT N'Refreshing [dbo].[sp_SinavHariciPuanSira]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavHariciPuanSira]';


GO
PRINT N'Refreshing [dbo].[sp_SinavIstatistik]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavIstatistik]';


GO
PRINT N'Refreshing [dbo].[sp_SinavKatilim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavKatilim]';


GO
PRINT N'Refreshing [dbo].[sp_SinavKonuAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavKonuAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_SinavListele]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavListele]';


GO
PRINT N'Refreshing [dbo].[sp_SinifBazindaKazanimAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifBazindaKazanimAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_SinifDersAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifDersAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_SinifMaddeAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifMaddeAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_SinifNetPuanOrtalamalari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifNetPuanOrtalamalari]';


GO
PRINT N'Refreshing [dbo].[sp_SoruMaddeAnaliziOS]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SoruMaddeAnaliziOS]';


GO
PRINT N'Refreshing [dbo].[sp_Takvim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Takvim]';


GO
PRINT N'Refreshing [dbo].[sp_TestMaddeAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_TestMaddeAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_TKTTest]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_TKTTest]';


GO
PRINT N'Refreshing [dbo].[sp_TopluSinavSonuclari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_TopluSinavSonuclari]';


GO
PRINT N'Refreshing [dbo].[sp_TopluYaziliYoklamaSonuclari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_TopluYaziliYoklamaSonuclari]';


GO
PRINT N'Refreshing [dbo].[sp_UniteTarama]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_UniteTarama]';


GO
PRINT N'Refreshing [dbo].[sp_UniteTaramaSinifPuanOrtalamalari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_UniteTaramaSinifPuanOrtalamalari]';


GO
PRINT N'Refreshing [dbo].[sp_UpgradeSoru]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_UpgradeSoru]';


GO
PRINT N'Refreshing [dbo].[sp_v2FrekansSistemEksikKazanim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_v2FrekansSistemEksikKazanim]';


GO
PRINT N'Refreshing [dbo].[sp_Yardim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Yardim]';


GO
PRINT N'Refreshing [dbo].[sp_YaziliYoklamaSonuclari]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YaziliYoklamaSonuclari]';


GO
PRINT N'Refreshing [dbo].[sp_YetenekGelisim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YetenekGelisim]';


GO
PRINT N'Refreshing [dbo].[sp_YG_Karne]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YG_Karne]';


GO
PRINT N'Refreshing [dbo].[sp_YG_YetenekGelisim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YG_YetenekGelisim]';


GO
PRINT N'Refreshing [dbo].[sp_YG_YorumEkle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YG_YorumEkle]';


GO
PRINT N'Refreshing [dbo].[sp_ZekaTest]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_ZekaTest]';


GO
PRINT N'Refreshing [dbo].[sp_OnlineSinavMailYolla]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OnlineSinavMailYolla]';


GO
PRINT N'Refreshing [dbo].[sp_OptikIslemleriOnline]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OptikIslemleriOnline]';


GO
PRINT N'Refreshing [dbo].[sp_OptikIslemleriEski]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OptikIslemleriEski]';


GO
PRINT N'Refreshing [dbo].[sp_Menu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Menu]';


GO
PRINT N'Refreshing [dbo].[sp_Kullanici]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Kullanici]';


GO
PRINT N'Refreshing [dbo].[sp_SinavDegerlendir]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavDegerlendir]';


GO
PRINT N'Refreshing [dbo].[sp_SinavDegerlendirTumSinavlar]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavDegerlendirTumSinavlar]';


GO
PRINT N'Reenabling DDL triggers...'
GO
ENABLE TRIGGER [CaptureStoredProcedureChanges] ON DATABASE
GO
PRINT N'Update complete.';


GO
