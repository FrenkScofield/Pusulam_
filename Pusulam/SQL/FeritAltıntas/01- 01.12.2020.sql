USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Takvim]    Script Date: 8.12.2020 17:10:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Takvim]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TAKVIM					VARCHAR(MAX)	= NULL,
	@RENK					VARCHAR(7)		= NULL,
	@ID_TAKVIM				INT				= NULL,
	@ID_KULLANICITIPI		INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@JSONKULLANICITIPI		VARCHAR(MAX)	= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ACIKLAMA				VARCHAR(MAX)	= NULL,
	@BAS_TARIH				VARCHAR(MAX)	= NULL,
	@BIT_TARIH				VARCHAR(MAX)	= NULL,
	@ID_TAKVIMETKINLIK		INT				= NULL,
	@ID_TAKVIMS				VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL
AS
BEGIN

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU

		IF @return_variable = 1
		BEGIN
			SET LANGUAGE Turkish;

			IF @ISLEM = 1	--	Takvim Listele
			BEGIN
				SELECT
				(
					SELECT T.ID_TAKVIM, T.AD, CAST(COUNT(TE.ID_TAKVIMETKINLIK) AS VARCHAR) + ' adet etkinlik var' AS ETKINLIKSAYISI, T.RENK
					FROM [dbo].[Takvim] T
					LEFT JOIN TakvimEtkinlik TE ON TE.ID_TAKVIM=T.ID_TAKVIM AND (TE.AKTIF IS NULL OR TE.AKTIF=1)
					WHERE T.AKTIF=1
					GROUP BY T.ID_TAKVIM, T.AD, T.RENK
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 2	--	Takvim Ekle
			BEGIN
				INSERT INTO [dbo].[Takvim]
						   ([AD]
						   ,[RENK]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@TAKVIM
						   ,@RENK
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 3	--	Takvim Sil
			BEGIN
				UPDATE Takvim SET AKTIF = 0, SIL_TARIH=GETDATE(), SIL_TCKIMLIKNO=@TCKIMLIKNO WHERE ID_TAKVIM = @ID_TAKVIM
			END

			IF @ISLEM = 4	--	Kullanıcı Tipi Listele
			BEGIN
				SELECT
				(
					SELECT KT.ID_KULLANICITIPI, AD, CASE WHEN TY.ID_KULLANICITIPI IS NULL THEN 0 ELSE 1 END AS SELECTED FROM OkyanusDB.dbo.v3KullaniciTipi KT
					LEFT JOIN TakvimYetki TY ON TY.ID_KULLANICITIPI=KT.ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					GROUP BY KT.ID_KULLANICITIPI, AD, TY.ID_KULLANICITIPI
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 5	--	Kademe3 Listele
			BEGIN
				SELECT
				(
					SELECT K3.ID_KADEME3, AD, CASE WHEN TY.ID_KADEME3 IS NULL THEN 0 ELSE 1 END SELECTED FROM OkyanusDB.dbo.v3Kademe3 K3
					LEFT JOIN TakvimYetki TY ON TY.ID_KADEME3=K3.ID_KADEME3 AND TY.ID_KULLANICITIPI=@ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 6	--	Takvim Yetki Ekle
			BEGIN
				DELETE FROM TakvimYetki WHERE ID_TAKVIM = @ID_TAKVIM

				INSERT INTO [dbo].[TakvimYetki]
						   ([ID_TAKVIM]
						   ,[ID_KULLANICITIPI]
						   ,[ID_KADEME3]
						   ,[KYE_TCKIMLIKNO])
				SELECT @ID_TAKVIM, ID_KULLANICITIPI, ID_KADEME3, @TCKIMLIKNO
				FROM OPENJSON(@JSONKULLANICITIPI)
				WITH(ID_KULLANICITIPI INT, ID_KADEME3 INT, SELECTED BIT)
				WHERE SELECTED = 1
			END

			IF @ISLEM = 7	--	Takvim Etkinlik Listele
			BEGIN
				SELECT
				(
					SELECT	ID_TAKVIMETKINLIK
							,AD
							,ACIKLAMA
							,CONVERT(VARCHAR, BAS_TARIH, 104) AS BAS_TARIH
							,CONVERT(VARCHAR, BIT_TARIH, 104) AS BIT_TARIH 
					FROM TakvimEtkinlik 
					WHERE ID_TAKVIM=@ID_TAKVIM AND AKTIF=1 
					ORDER BY ID_TAKVIMETKINLIK DESC
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 8	--	Takvim Etkinlik Ekle
			BEGIN
				INSERT INTO [dbo].[TakvimEtkinlik]
						   ([ID_TAKVIM]
						   ,[AD]
						   ,[ACIKLAMA]
						   ,[BAS_TARIH]
						   ,[BIT_TARIH]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@ID_TAKVIM
						   ,@AD
						   ,@ACIKLAMA
						   ,CONVERT(date,@BAS_TARIH,104)
						   ,CONVERT(date,@BIT_TARIH,104)
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 9	--	Takvim Etkinlik Sil
			BEGIN
				UPDATE TakvimEtkinlik SET AKTIF = 0, SIL_TARIH = GETDATE(), SIL_TCKIMLIKNO = @TCKIMLIKNO WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 10	--	Takvim Etkinlik Güncelle
			BEGIN
				UPDATE TakvimEtkinlik SET AD = @AD, ACIKLAMA = @ACIKLAMA, BAS_TARIH = CONVERT(date,@BAS_TARIH,104), BIT_TARIH = CONVERT(date,@BIT_TARIH,104) WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 11	--	Duyuru Listele
			BEGIN
				CREATE TABLE #DUYURULAR (ID_DUYURUV2 INT, BASLIK VARCHAR(MAX), ICERIK VARCHAR(MAX), FOTOGRAF VARCHAR(MAX), TARIH VARCHAR(MAX), BANNER VARCHAR(MAX), EKDOSYA VARCHAR(MAX), FOTOGRAF_MOBIL VARCHAR(MAX))

				DECLARE @ID_KULLANICI INT = (SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);
				--DECLARE @OTURUM2 VARCHAR(MAX) = (SELECT OTURUM FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);

				INSERT INTO #DUYURULAR
				EXEC eokul_v2.dbo.spDuyuruAnasayfa @ID_KULLANICI= @ID_KULLANICI, @OTURUM=@OTURUM

				SELECT
				(
					SELECT * FROM #DUYURULAR
					FOR JSON PATH
				) AS J

				DROP TABLE #DUYURULAR
			END

			IF @ISLEM = 12	--	Takvim Getir
			BEGIN
				DECLARE @DATE DATE = CONVERT(DATE, @BAS_TARIH, 104), @FIRSTDAY DATE, @LASTDAY DATE, @FIRSTWEEKDAY INT, @LASTWEEKDAY INT, @STARTDATE DATETIME, @ENDDATE DATETIME

				SELECT @FIRSTDAY = DATEADD(MONTH, DATEDIFF(MONTH, 0, @DATE), 0)
				SELECT @LASTDAY  = DATEADD(S, -1, DATEADD(MM, DATEDIFF(M, 0, @DATE) + 1, 0))

				SELECT @FIRSTWEEKDAY = DATEPART(DW, @FIRSTDAY)
				SELECT @LASTWEEKDAY  = DATEPART(DW, @LASTDAY)


				SELECT @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, @FIRSTWEEKDAY - 1	, @FIRSTDAY), 0)
				SELECT @ENDDATE	  = DATEADD(DAY, DATEDIFF(DAY, -(7 - @LASTWEEKDAY)	, @LASTDAY ), 0)

				;WITH DateList
				AS
				(
				SELECT @STARTDATE [Date]
				UNION ALL
				SELECT [Date] + 1 FROM DateList WHERE [Date] < @ENDDATE
				)
				SELECT [Date] = CAST([Date] AS DATE) INTO #DateList FROM DateList option (maxrecursion 0);
				
				IF @ID_KULLANICITIPI NOT IN (4,5) AND (4 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO) AND 5 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO))
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								 SELECT DISTINCT TE.AD						AS 'AD'
								,TE.ACIKLAMA								AS 'ACIKLAMA'
								,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
								,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
								,T.RENK										AS 'RENK'
								,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
								,TE.ID_TAKVIM								AS 'ID_TAKVIM'
								,ISNULL((SELECT STUFF((SELECT   ', ' + CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
												LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
													AND  ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')),
										(SELECT STUFF((SELECT   ', ' + KT.AD
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))) 
								AS 'YETKI'

								--,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								--INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								--INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								--LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
								--LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									--AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									
									--AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,D.DERSAD + ' - (' + O.BASLIK + ')' AS AD
										,'#0000FF' AS RENK
										,'0' AS TC_OGRENCI
								FROM		OdevSinifOgrenci	OSO
								INNER JOIN	OdevSinif			OS	ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev				O	ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders	D	ON D.ID_DERS = O.ID_DERS
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF = 1
								AND O.KYE_KULLANICI = @TCKIMLIKNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,D.DERSAD + ' - (' + E.ETUT + ')' AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E					
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= E.TC_OGRETMEN
								WHERE	E.TC_OGRETMEN	= @TCKIMLIKNO
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								SELECT DISTINCT 
										 TE.AD										AS 'AD'
										,TE.ACIKLAMA								AS 'ACIKLAMA'
										,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
										,T.RENK										AS 'RENK'
										,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
										,TE.ID_TAKVIM								AS 'ID_TAKVIM'
										,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = TY.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									AND ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
									AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + O.BASLIK + ')' ELSE D.DERSAD + ' - (' + O.BASLIK + ')' END AS AD
										,'#0000FF' AS RENK
										,CASE WHEN O.ID_ODEVTUR = 5 THEN OSO.TCKIMLIKNO ELSE '0' END AS TC_OGRENCI
								FROM OdevSinifOgrenci					OSO
								INNER JOIN	OdevSinif					OS		ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev						O		ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders			D		ON D.ID_DERS = O.ID_DERS
								INNER JOIN	OkyanusDB.dbo.v3Kullanici	K		ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci		OG		ON OG.TCKIMLIKNO = @TCKIMLIKNO
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF=1
								AND (OSO.TCKIMLIKNO = @TCKIMLIKNO OR OSO.TCKIMLIKNO IN (SELECT TCKIMLIKNO_OGR FROM OkyanusDB.dbo.v3OgrenciVeli WHERE TCKIMLIKNO = @TCKIMLIKNO))
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + E.ETUT + ')' 
										ELSE D.DERSAD + ' - (' + E.ETUT + ')' 
									END AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E
								INNER JOIN	EtutOgrenci				EO	ON	EO.ID_ETUT		= E.ID_ETUT
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= EO.TC_OGRENCI
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci	OG	ON	OG.TCKIMLIKNO	= @TCKIMLIKNO
								WHERE	EO.TC_OGRENCI	= @TCKIMLIKNO
									AND EO.AKTIF		= 1
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				DROP TABLE #DateList
			END		

			IF @ISLEM = 13	--	TAKVİM ETKİNLİK EKLE EXCEL
			BEGIN
				INSERT INTO TakvimEtkinlik (ID_TAKVIM, AD, ACIKLAMA, BAS_TARIH, BIT_TARIH, KYE_TCKIMLIKNO)
				SELECT @ID_TAKVIM, AD, ACIKLAMA, BASLANGIC, BITIS, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
				WITH(
					AD VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					BASLANGIC VARCHAR(MAX),
					BITIS VARCHAR(MAX)
				)
			END	
			IF @ISLEM = 14 -- TATİL LİSTELE
			BEGIN
			SELECT ADI,CONVERT(VARCHAR, BASLANGIC_TARIH, 104) AS BASLANGIC_TARIH,CONVERT(VARCHAR, BITIS_TARIH, 104) AS BITIS_TARIH FROM Tatil 			
			END 
			IF @ISLEM = 15 --TATİL EKLE
			BEGIN
			INSERT INTO Tatil (ADI,BASLANGIC_TARIH,BITIS_TARIH) VALUES(@AD,@BAS_TARIH,@BIT_TARIH)
			END
		END
	END TRY
	BEGIN CATCH			
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = ERROR_MESSAGE()
			
		RAISERROR (	
					@MSG, 
					@ErrorSeverity, 
					@ErrorState
				  );
	END CATCH;	
END


------------------------------LİSE HTML RAPOR
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GelisimRaporuLS]    Script Date: 9.12.2020 14:37:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GelisimRaporuLS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL 
AS
BEGIN


BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT


		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @return_variable = 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT * FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(*) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(*) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
			INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	
	IF (@ISLEM=4)
		BEGIN
		
		 --DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

		    INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ID_DERS INT,
				 SINAVADI VARCHAR(MAX),
				 ID_SINAVRAPOR INT,
				 PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
		    SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
				 DOGRU DECIMAL(8,2),
				 YANLIS DECIMAL(8,2),
				 BOS DECIMAL(8,2),
				 YUZDE DECIMAL(8,2),
				 TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(*) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
				    INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(*) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
	SELECT (
				SELECT 						
					--ÖĞRENCİ
					OGRENCI							= (	SELECT * 
														FROM #TEMP_OGRENCI 
														FOR JSON PATH)					
					--DERS ÖĞRETMEN
					,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
														FROM #TEMP_DERS_OGRETMEN 
														ORDER BY DERSAD, ADSOYAD
														FOR JSON PATH)
					--YOKLAMA DERS
					,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
														ORDER BY DERSAD FOR JSON PATH)
					-- YAZILI YOKLAMA SONUÇLARI
					,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
														, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
														WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
															OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
														ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
														FOR JSON PATH)  
					--DENEME SINAVI DERSLERI
					,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
															 ST.ID_SINAVTURU
															,SINAVTURU	= ST.AD
															,DERSAD		= T.DERSAD 
															,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
															,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
														FROM	#TEMP_DENEME_SONUCLARI_T	T
														JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
														--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
														ORDER BY ST.AD, BOLUMNO, T.DERSAD
														FOR JSON AUTO)
					--DENEME SINAVI DERSLERI
					,DENEMESINAVILISTESI			= (
															SELECT	 DISTINCT 
																 ST.ID_SINAVTURU
																,SINAVTURU	= ST.AD
																,SINAVAD
																,ID_SINAV
																,SINAVTARIH
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
															ORDER BY ST.AD, T.SINAVTARIH
															FOR JSON AUTO
														)
					-- DENEME SINAVI SONUCLARI
					,DENEMESINAVISONUCLARI			=  (
															SELECT	 ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= TT.DERSAD 
																	,TT.ID_SINAV
																	,TT.OLCEKSINAVI
																	,TD = ISNULL(T2.TD,0)
																	,TY = ISNULL(T2.TY,0)
																	,TB = ISNULL(T2.TB,0)
																	,TN = ISNULL(T2.TN,0)
																	,TT.SINAVAD																	
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																	,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
															JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																									AND SD.ID_SINAV			= T.ID_SINAV
															JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																									AND TT.DERSAD			= T.DERSAD
															JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																									AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
															ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
															FOR JSON AUTO
														)
						-- GELİŞİM ANALİZİ DERSLERİ
						,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
															[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
															[SINAVADI] = SINAVAD, 
															[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
															[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
															[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
															NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
															,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD		= G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
														JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
														ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
						--GELİŞİM ANAZILIZI SONUC
						,GELISIMANALIZISONUC		= (	SELECT	
															 G.TCKIMLIKNO
															,G.STKISAAD + ' TOPLAM' AS STKISAAD
															,G.ID_SINAVTURU
															--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
															,SINAVLIST.ID_SINAV
															,[SINAVADI]		= SINAVAD
															,[DOGRU]		= SUM(DOGRU) 
															,[YANLIS]		= SUM(YANLIS) 
															,[BOS]			= SUM(BOS) 
															,NET			= SUM(NET) 
															,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															--,G.STKISAAD + ' TOPLAM' AS STKISAAD
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD = G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
														WHERE SINAVAD <> 'ORTALAMA'
														GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
														ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
						--GELİŞİM ANALİZİ PUAN
						,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
															 G.TCKIMLIKNO
															,G.ID_SINAVPUANTURU
															,G.PUANTURU
															,S.SINAVAD
															,S.PUAN
															,S.BASARI	
															,S.BASARI as NET
														FROM #TEMP_PUAN G 
														JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																		  AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
														FOR JSON AUTO)
						--NET ORTALAMA KARŞ
						,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
														FROM #TEMP_OO OO
														INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
														INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
														INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
														INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
														ORDER BY STKISAAD, BOLUMNO, DERSAD 
														FOR JSON PATH)
						--KONU ANALIZ
						,KONUANALIZ					= (	SELECT * 
														FROM #TEMP_KONUANALIZ TT 
														ORDER BY TT.DERSAD, TT.KOD 
														FOR JSON PATH)
						--ÖDEV RAPORU
						,ODEVRAPORU					= ( SELECT * 
														FROM #TEMP_ODEV_RAPORU 
														FOR JSON PATH)
						--ÖĞRETMEN DEĞERLENDİRME
						,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																,K.AD + ' ' + K.SOYAD AS ADSOYAD
																,DY.YORUM
																,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																,CASE DY.TUR WHEN 0 THEN STUFF ((
																	SELECT DISTINCT ', ' + UPPER(D.AD)
																	FROM EOKUL_V2.DBO.dersogretmen DO
																	INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																	WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																	FOR XML PATH('')), 1, 2, '') 
																 WHEN 1 THEN 'REHBERLİK'
																 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
														FROM DegerlendirmeYorum				DY
														INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
														INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
														INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
														INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
														WHERE	DY.YORUM <> '' 
															AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
														ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
														FOR JSON PATH)
						-- ETÜT RAPORU
						,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
														FROM #TEMP_ETUT_RAPORU
														ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
						,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																,SINAV
																,DERS
																,DUZEY
																,MAXDUZEY
														FROM #TEMP_NEREDEYIM_GRAFIGI
														ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
						--LUS RAPORU
						,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
															OPT, 
															CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
															CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
															YAZOGRETMEN, 
															CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
															CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
															YAZOGRENCI, 
															CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
															CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
															TOPLAM
														FROM #TEMP_RESULT
														WHERE TOPLAM != '-' FOR JSON PATH)
						,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
														JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
														JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
														JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
														JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
														GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														ORDER BY ADSOYAD FOR JSON PATH)
						,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																,SORUNO
																,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																		WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																		WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																		WHEN PUANORAN < 40						THEN '1'
																	END AS DURUM
														FROM #TEMP_YAZILISORUOGRENCI
														ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
				FOR JSON PATH
			)
		END
	END

END TRY
		BEGIN CATCH
			SELECT 
				@ErrorSeverity	= ERROR_SEVERITY(),
				@ErrorState		= ERROR_STATE()
							
			SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
			RAISERROR (@MSG , -- Message text.
						@ErrorSeverity, -- Severity.
						@ErrorState -- State.
						);
		END CATCH;	
END


-----------------------HTML ORTAOKUL RAPOR-----------------------------
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_GelisimRaporuOO]    Script Date: 9.12.2020 14:37:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_GelisimRaporuOO]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL 
AS
BEGIN


BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT

	

	  
		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @return_variable = 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT * FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(*) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1 AND E.DONEM = @DONEM
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(*) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.ID_KULLANICITIPI = 4
				AND		DS.DONEM = @DONEMX
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	

		IF (@ISLEM=4)
		BEGIN
		
		 --DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

		    INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ID_DERS INT,
				 SINAVADI VARCHAR(MAX),
				 ID_SINAVRAPOR INT,
				 PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
		    SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
				 DOGRU DECIMAL(8,2),
				 YANLIS DECIMAL(8,2),
				 BOS DECIMAL(8,2),
				 YUZDE DECIMAL(8,2),
				 TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(*) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
				    INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(*) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
			SELECT (
				SELECT 						
					--ÖĞRENCİ
					OGRENCI							= (	SELECT * 
														FROM #TEMP_OGRENCI 
														FOR JSON PATH)					
					--DERS ÖĞRETMEN
					,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
														FROM #TEMP_DERS_OGRETMEN 
														ORDER BY DERSAD, ADSOYAD
														FOR JSON PATH)
					--YOKLAMA DERS
					,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
														ORDER BY DERSAD FOR JSON PATH)
					-- YAZILI YOKLAMA SONUÇLARI
					,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
														, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
														WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
															OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
														ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
														FOR JSON PATH)  
					--DENEME SINAVI DERSLERI
					,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
															 ST.ID_SINAVTURU
															,SINAVTURU	= ST.AD
															,DERSAD		= T.DERSAD 
															,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
															,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
														FROM	#TEMP_DENEME_SONUCLARI_T	T
														JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
														--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
														ORDER BY ST.AD, BOLUMNO, T.DERSAD
														FOR JSON AUTO)
					--DENEME SINAVI DERSLERI
					,DENEMESINAVILISTESI			= (
															SELECT	 DISTINCT 
																 ST.ID_SINAVTURU
																,SINAVTURU	= ST.AD
																,SINAVAD
																,ID_SINAV
																,SINAVTARIH
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
															ORDER BY ST.AD, T.SINAVTARIH
															FOR JSON AUTO
														)
					-- DENEME SINAVI SONUCLARI
					,DENEMESINAVISONUCLARI			=  (
															SELECT	 ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= TT.DERSAD 
																	,TT.ID_SINAV
																	,TT.OLCEKSINAVI
																	,TD = ISNULL(T2.TD,0)
																	,TY = ISNULL(T2.TY,0)
																	,TB = ISNULL(T2.TB,0)
																	,TN = ISNULL(T2.TN,0)
																	,TT.SINAVAD																	
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																	,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
															JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																									AND SD.ID_SINAV			= T.ID_SINAV
															JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																									AND TT.DERSAD			= T.DERSAD
															JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																									AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
															ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
															FOR JSON AUTO
														)
						-- GELİŞİM ANALİZİ DERSLERİ
						,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
															[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
															[SINAVADI] = SINAVAD, 
															[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
															[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
															[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
															NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
															,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD		= G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
														JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
														ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
						--GELİŞİM ANAZILIZI SONUC
						,GELISIMANALIZISONUC		= (	SELECT	
															 G.TCKIMLIKNO
															,G.STKISAAD + ' TOPLAM' AS STKISAAD
															,G.ID_SINAVTURU
															--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
															,SINAVLIST.ID_SINAV
															,[SINAVADI]		= SINAVAD
															,[DOGRU]		= SUM(DOGRU) 
															,[YANLIS]		= SUM(YANLIS) 
															,[BOS]			= SUM(BOS) 
															,NET			= SUM(NET) 
															,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															--,G.STKISAAD + ' TOPLAM' AS STKISAAD
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD = G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
														WHERE SINAVAD <> 'ORTALAMA'
														GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
														ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
						--GELİŞİM ANALİZİ PUAN
						,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
															 G.TCKIMLIKNO
															,G.ID_SINAVPUANTURU
															,G.PUANTURU
															,S.SINAVAD
															,S.PUAN
															,S.BASARI	
															,S.BASARI as NET
														FROM #TEMP_PUAN G 
														JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																		  AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
														FOR JSON AUTO)
						--NET ORTALAMA KARŞ
						,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
														FROM #TEMP_OO OO
														INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
														INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
														INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
														INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
														ORDER BY STKISAAD, BOLUMNO, DERSAD 
														FOR JSON PATH)
						--KONU ANALIZ
						,KONUANALIZ					= (	SELECT * 
														FROM #TEMP_KONUANALIZ TT 
														ORDER BY TT.DERSAD, TT.KOD 
														FOR JSON PATH)
						--ÖDEV RAPORU
						,ODEVRAPORU					= ( SELECT * 
														FROM #TEMP_ODEV_RAPORU 
														FOR JSON PATH)
						--ÖĞRETMEN DEĞERLENDİRME
						,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																,K.AD + ' ' + K.SOYAD AS ADSOYAD
																,DY.YORUM
																,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																,CASE DY.TUR WHEN 0 THEN STUFF ((
																	SELECT DISTINCT ', ' + UPPER(D.AD)
																	FROM EOKUL_V2.DBO.dersogretmen DO
																	INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																	WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																	FOR XML PATH('')), 1, 2, '') 
																 WHEN 1 THEN 'REHBERLİK'
																 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
														FROM DegerlendirmeYorum				DY
														INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
														INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
														INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
														INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
														WHERE	DY.YORUM <> '' 
															AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
														ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
														FOR JSON PATH)
						-- ETÜT RAPORU
						,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
														FROM #TEMP_ETUT_RAPORU
														ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
						,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																,SINAV
																,DERS
																,DUZEY
																,MAXDUZEY
														FROM #TEMP_NEREDEYIM_GRAFIGI
														ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
						--LUS RAPORU
						,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
															OPT, 
															CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
															CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
															YAZOGRETMEN, 
															CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
															CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
															YAZOGRENCI, 
															CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
															CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
															TOPLAM
														FROM #TEMP_RESULT
														WHERE TOPLAM != '-' FOR JSON PATH)
						,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
														JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
														JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
														JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
														JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
														GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														ORDER BY ADSOYAD FOR JSON PATH)
						,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																,SORUNO
																,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																		WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																		WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																		WHEN PUANORAN < 40						THEN '1'
																	END AS DURUM
														FROM #TEMP_YAZILISORUOGRENCI
														ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
				FOR JSON PATH
			)

		END
	END

END TRY
		BEGIN CATCH
			SELECT 
				@ErrorSeverity	= ERROR_SEVERITY(),
				@ErrorState		= ERROR_STATE()
							
			SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
			RAISERROR (@MSG , -- Message text.
						@ErrorSeverity, -- Severity.
						@ErrorState -- State.
						);
		END CATCH;	
END


-----------------------
USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Odev]    Script Date: 10.12.2020 12:22:50 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Odev]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,

	@ID_KADEME					INT				= NULL,
	@ID_ODEVTUR					INT				= NULL,
	@DURUM						BIT				= NULL,
	@ID_ODEV					INT				= NULL,
	@ID_SINIF					INT				= NULL,
	@TC_ODEVVEREN				VARCHAR(11)		= NULL,
	@SQLJSON					VARCHAR(MAX)	= NULL,

	@TC_OGRENCI					VARCHAR(11)		= NULL,
	@BASLANGIC_TARIHI			VARCHAR(MAX)	= NULL,
	@BITIS_TARIHI				VARCHAR(MAX)	= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@ID_DERS					INT				= NULL,

	@ID_DERSLIST				VARCHAR(MAX)	= NULL,
	@ID_KADEME3LIST				VARCHAR(MAX)	= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@TC_OGRETMENLIST			VARCHAR(MAX)	= NULL,
	@TUR						INT				= NULL,
	@TC_OGRETMEN				VARCHAR(11)		= NULL,
	@RAPORMU					BIT				= 0,
	@APIKEY						VARCHAR(MAX)	= NULL,
	@GUNCELLEME					BIT				= NULL,
	@ID_ODEVSINIFOGRENCIDOSYA	INT				= NULL,
	@TAMAMLANDIDURUM			INT				= NULL,
	@OGRETMENODEVAD				VARCHAR(30)		= NULL,
	@OGRETMENODEVGUID			NVARCHAR (MAX)	= NULL,
	@OGRETMENUZANTI				NVARCHAR (10)	= NULL
AS
BEGIN

/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 23.10.2020
	
	Öğrenci Ödev Dosya İşlemleri

	--	sp Alter
	--	ISLEM 6  UPDATE
	--	ISLEM 9  UPDATE
	--	ISLEM 10 UPDATE
	--	ISLEM 24 ADD
	--	ISLEM 24 ADD

*/

	DECLARE @ODEVKONTROLSURESI INT = -16
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU

				,ID_KADEME					= @ID_KADEME			
				,ID_ODEVTUR					= @ID_ODEVTUR			
				,DURUM						= @DURUM				
				,ID_ODEV					= @ID_ODEV			
				,ID_SINIF					= @ID_SINIF			
				,TC_ODEVVEREN				= @TC_ODEVVEREN		
				,SQLJSON					= @SQLJSON			
											 
				,TC_OGRENCI					= @TC_OGRENCI			
				,BASLANGIC_TARIHI			= @BASLANGIC_TARIHI	
				,BITIS_TARIHI				= @BITIS_TARIHI		
				,DONEM						= @DONEM				
				,ID_DERS					= @ID_DERS			
											
				,ID_DERSLIST				= @ID_DERSLIST		
				,ID_KADEME3LIST				= @ID_KADEME3LIST		
				,ID_SUBELIST				= @ID_SUBELIST		
				,TC_OGRETMENLIST			= @TC_OGRETMENLIST	
				,TUR						= @TUR				
				,TC_OGRETMEN				= @TC_OGRETMEN		
				,RAPORMU					= @RAPORMU			
				,APIKEY						= @APIKEY
				,GUNCELLEME					= @GUNCELLEME
				,ID_ODEVSINIFOGRENCIDOSYA	= @ID_ODEVSINIFOGRENCIDOSYA
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	DECLARE @ID_ODEVSINIFOGRENCI	INT 

	--BEGIN TRANSACTION [TranOdev]
	BEGIN TRY   
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		IF @ID_LOG > 0
		BEGIN
			IF @ISLEM = 1 -- KADEME ÖDEV TÜR LİSTELE
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT OT.ID_ODEVTUR, OT.AD, CASE WHEN OTK.ID_KADEME IS NULL THEN 0 ELSE 1 END AS DURUM, @ID_KADEME AS ID_KADEME
					FROM OdevTur OT WITH(NOLOCK)
					LEFT JOIN OdevTurKademe OTK WITH(NOLOCK) ON OTK.ID_ODEVTUR = OT.ID_ODEVTUR AND OTK.ID_KADEME = @ID_KADEME
					ORDER BY OT.ID_ODEVTUR
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 2 -- KADEME ÖDEV TÜR DURUM EKLE/GÜNCELLE
			BEGIN
				IF @DURUM = 0
				BEGIN
					DELETE FROM OdevTurKademe WHERE ID_ODEVTUR = @ID_ODEVTUR AND ID_KADEME = @ID_KADEME
				END

				IF @DURUM = 1 AND NOT EXISTS (SELECT * FROM OdevTurKademe WITH(NOLOCK) WHERE ID_ODEVTUR = @ID_ODEVTUR AND ID_KADEME = @ID_KADEME)
				BEGIN
					INSERT INTO OdevTurKademe(ID_ODEVTUR, ID_KADEME, KYE_KULLANICI)
					VALUES (@ID_ODEVTUR, @ID_KADEME, @TCKIMLIKNO)
				END
			END	
			
			IF @ISLEM = 3 -- ÖDEV KAYDET
			BEGIN
				DECLARE @AKTIFDONEM VARCHAR(4) 
				SELECT @AKTIFDONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1

				DECLARE @ID_ODEVTABLE TABLE (ID_ODEV INT)
				DECLARE @ID_ODEV3 INT
				

				INSERT INTO Odev (DONEM, ID_KADEME3, ID_DERS, ID_MORPADERS, ID_ODEVTUR, BASLIK, ACIKLAMA, VERILIS_TARIHI, TESLIM_TARIHI, KYE_KULLANICI)
				OUTPUT inserted.ID_ODEV INTO @ID_ODEVTABLE
				SELECT @AKTIFDONEM, ID_KADEME3, ID_DERS, ID_MORPADERS, ID_ODEVTUR, BASLIK, ACIKLAMA, VERILIS_TARIHI, TESLIM_TARIHI, @TCKIMLIKNO 
				FROM OPENJSON (@SQLJSON)
				WITH(
					ID_SUBE			INT,
					ID_KADEME		INT,
					ID_KADEME3		INT,
					ID_ODEVTUR		INT,
					ID_DERS			INT,
					ID_MORPADERS	INT,
					VERILIS_TARIHI	VARCHAR(MAX),
					TESLIM_TARIHI	VARCHAR(MAX),
					BASLIK			VARCHAR(MAX),
					ACIKLAMA		VARCHAR(MAX)
				)

				SELECT @ID_ODEV3 = ID_ODEV FROM @ID_ODEVTABLE

				SELECT DISTINCT ID_SINIF = SO.ID_SINIF, VALUE = JO.VALUE
				INTO #OGRENCISINIF
				FROM OPENJSON (@SQLJSON, '$.TC_OGRENCILIST') JO
				INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci SO ON SO.TCKIMLIKNO = JO.VALUE

				INSERT INTO OdevSinif (ID_ODEV, ID_SINIF)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_SINIFLIST')
				WHERE VALUE <> '0' AND VALUE IN (SELECT ID_SINIF FROM #OGRENCISINIF)

				INSERT INTO OdevSinifOgrenci (ID_ODEVSINIF, TCKIMLIKNO)
				SELECT DISTINCT OS.ID_ODEVSINIF, SO.VALUE
				FROM #OGRENCISINIF SO
				INNER JOIN OdevSinif OS ON OS.ID_SINIF = SO.ID_SINIF AND OS.ID_ODEV = @ID_ODEV3
				WHERE SO.VALUE <> '0'

				DROP TABLE IF EXISTS #OGRENCISINIF

				INSERT INTO OdevLink (ID_ODEV, AD, LINK)
				SELECT @ID_ODEV3, AD, LINK
				FROM OPENJSON (@SQLJSON, '$.LINKLIST')
				WITH(
					AD VARCHAR(MAX),
					LINK VARCHAR(MAX)
				)
				WHERE LINK <> ''

				INSERT INTO OdevDosya (ID_ODEV, AD, GUID, UZANTI) VALUES(@ID_ODEV3,@OGRETMENODEVAD,@OGRETMENODEVGUID,@OGRETMENUZANTI)
				

				INSERT INTO OdevMorpaKazanim (ID_ODEV, ID_MORPAKAZANIM)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_MORPAKAZANIMLIST')
				WHERE VALUE <> 0

				INSERT INTO OdevMorpaMateryal(ID_ODEV, ID_MORPAMATERYAL)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_MORPAMATERYALLIST')
				WHERE VALUE <> 0

				SET @ISLEM		= 19
				SET @ID_ODEV	= @ID_ODEV3
				SET @GUNCELLEME	= 0
				GOTO Branch_Islem19;
			END	

			IF @ISLEM = 4 -- SINIF ÖDEV LİSTELE
			BEGIN
				SELECT
				ISNULL((
					SELECT	 O.ID_ODEV
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR, O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR, O.TESLIM_TARIHI, 104)
							,DURUM =	CASE 
										WHEN O.KONTROL = 1 AND EXISTS (SELECT 1 FROM OdevSinifOgrenci OSO WHERE OSO.ID_ODEVSINIF = S.ID_ODEVSINIF AND OSO.ID_ODEVDURUM IS NOT NULL) THEN 1
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
										END
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif S WITH(NOLOCK) ON S.ID_ODEV = O.ID_ODEV
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					WHERE O.AKTIF = 1 
					AND KYE_KULLANICI = @TCKIMLIKNO
					AND S.ID_SINIF = @ID_SINIF
					ORDER BY O.VERILIS_TARIHI DESC
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 5 -- ÖDEV SİL
			BEGIN
				UPDATE Odev SET AKTIF = 0 WHERE ID_ODEV = @ID_ODEV
			END

			IF @ISLEM = 6 -- ÖDEV ÖĞRENCİ LİSTELE
			BEGIN
				SELECT ISNULL((
					SELECT OSO.ID_ODEVSINIFOGRENCI
						,ADSOYAD			=  K.AD + ' ' + K.SOYAD
						,ID_ODEVDURUM		= ISNULL(CAST(OSO.ID_ODEVDURUM AS VARCHAR), '')
						,ACIKLAMA			= ISNULL(OSO.ACIKLAMA, '')
						,OGRENCIDOSYALIST	= ISNULL((	SELECT OD.GUID
														FROM OdevSinifOgrenciDosya OD
														WHERE OD.ID_ODEVSINIFOGRENCI	= OSO.ID_ODEVSINIFOGRENCI
															AND OD.AKTIF				= 1
														FOR JSON PATH
												),'[]')
					FROM OdevSinifOgrenci					OSO WITH(NOLOCK)
					INNER JOIN OdevSinif					OS	WITH(NOLOCK) ON	 OS.ID_ODEVSINIF		= OSO.ID_ODEVSINIF
					INNER JOIN Odev							O	WITH(NOLOCK) ON	 O.ID_ODEV				= OS.ID_ODEV
					INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON	 K.TCKIMLIKNO			= OSO.TCKIMLIKNO
					WHERE	O.AKTIF		= 1
						AND O.ID_ODEV	= @ID_ODEV
						AND OS.ID_SINIF = @ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 7 -- DANIŞMAN MI
			BEGIN
				IF EXISTS (SELECT * FROM OkyanusDB.dbo.v3SinifPersonel WITH(NOLOCK) WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 100)
				BEGIN
					SELECT CAST(1 AS BIT)
				END
				ELSE
				BEGIN
					SELECT CAST(0 AS BIT)
				END
			END
			
			IF @ISLEM = 8 -- SINIF ÖDEV VEREN LİSTESİ
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT DISTINCT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
					WHERE OS.ID_SINIF = @ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				)
				, '[]')
			END

			IF @ISLEM = 9 -- ÖDEV VEREN ÖDEV LİSTELE
			BEGIN
				SELECT
				ISNULL((
					SELECT   O.ID_ODEV
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR, O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR, O.TESLIM_TARIHI, 104)
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,DURUM =	CASE 
										WHEN O.KONTROL = 1 AND EXISTS (SELECT 1 FROM OdevSinifOgrenci OSO WHERE OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF AND OSO.ID_ODEVDURUM IS NOT NULL) THEN 1
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
										END
							,DOSYASAYISI = (SELECT COUNT(OD.GUID) 
											FROM OdevSinifOgrenci		OSO
											JOIN OdevSinifOgrenciDosya	OD	ON	OD.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI
											WHERE OSO.ID_ODEVSINIF	= OS.ID_ODEVSINIF
												AND OD.AKTIF		= 1
												AND EXISTS (SELECT TOP 1 1  FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI = 4 AND SY.TCKIMLIKNO = @TCKIMLIKNO )
											)
					FROM Odev								O	WITH(NOLOCK)
					INNER JOIN OdevSinif					OS	WITH(NOLOCK) ON OS.ID_ODEV		= O.ID_ODEV
					LEFT  JOIN eokul_v2.dbo.Ders			D	WITH(NOLOCK) ON D.ID_DERS		= O.ID_DERS
					INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON K.TCKIMLIKNO	= O.KYE_KULLANICI
					WHERE	O.AKTIF = 1
						AND OS.ID_SINIF = @ID_SINIF
						AND (@TC_ODEVVEREN IS NULL OR @TC_ODEVVEREN = '' OR O.KYE_KULLANICI = @TC_ODEVVEREN)
						AND	(
								(ISNULL(@TAMAMLANDIDURUM, 0) = 0 AND NOT EXISTS (SELECT 1 FROM OdevTamamlandi OT WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO))
								OR
								(ISNULL(@TAMAMLANDIDURUM, 0) = 1 AND EXISTS (SELECT 1 FROM OdevTamamlandi OT WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO))
							)
					ORDER BY O.TESLIM_TARIHI DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				), '[]')
			END

			IF @ISLEM = 10 -- ÖDEV DETAY GETİR
			BEGIN
				SELECT 
				ISNULL((
					SELECT	 O.ID_ODEV
							,O.ID_MORPADERS
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,O.ACIKLAMA
							,LINKLIST = ISNULL((SELECT OL.AD, OL.LINK FROM OdevLink OL WITH(NOLOCK) WHERE OL.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,DOSYALIST = ISNULL((SELECT OD.AD , OD.GUID, OD.UZANTI FROM OdevDosya OD WITH(NOLOCK) WHERE OD.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,ID_MORPAKAZANIMLIST = ISNULL((SELECT OMK.ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK WITH(NOLOCK) WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,ID_MORPAMATERYALLIST = ISNULL((SELECT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM WITH(NOLOCK) WHERE OMM.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,VERILIS_TARIHI = O.VERILIS_TARIHI
							,TESLIM_TARIHI = O.TESLIM_TARIHI
							,OGRENCIDOSYALIST	= ISNULL((	SELECT DISTINCT OD.ID_ODEVSINIFOGRENCIDOSYA, OD.GUID
															FROM OdevSinif				OS
															JOIN OdevSinifOgrenci		OSO	ON	OSO.ID_ODEVSINIF		= OS.ID_ODEVSINIF
															JOIN OdevSinifOgrenciDosya	OD	ON	OD.ID_ODEVSINIFOGRENCI	= OSO.ID_ODEVSINIFOGRENCI
															WHERE	OS.ID_ODEV		= O.ID_ODEV
																AND OD.AKTIF		= 1
																AND OSO.TCKIMLIKNO	= @TCKIMLIKNO
																AND EXISTS (SELECT TOP 1 1  FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI = 4 AND SY.TCKIMLIKNO = @TCKIMLIKNO )
															FOR JSON PATH
													),'[]')
					FROM Odev					O WITH(NOLOCK)
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					WHERE	O.AKTIF		= 1
						AND O.ID_ODEV	= @ID_ODEV
					FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				), '{}')
			END

			IF @ISLEM = 11 -- ÖDEV KONTROL KAYDET
			BEGIN
				UPDATE OSO SET OSO.ID_ODEVDURUM = J.ID_ODEVDURUM, OSO.ACIKLAMA = J.ACIKLAMA
				FROM OdevSinifOgrenci OSO
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEVSINIFOGRENCI INT,
					ID_ODEVDURUM INT,
					ACIKLAMA VARCHAR(MAX)				
				) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI

				UPDATE Odev SET KONTROL = 1 WHERE ID_ODEV = (SELECT TOP 1 ID_ODEV FROM OdevSinif OS WITH(NOLOCK) JOIN OdevSinifOgrenci OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF JOIN OPENJSON(@SQLJSON) WITH(ID_ODEVSINIFOGRENCI INT) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI)

				--BİLDİRİM--
				SELECT	OV.TCKIMLIKNO, 
						OV.TCKIMLIKNO_OGR, SUBSTRING(K.AD + ' ' + K.SOYAD + ' ' + ISNULL(D.DERSAD + ' - ', '') + O.BASLIK + ' ' + 'ödevi yapılmamıştır.', 0, 249) AS ACIKLAMA
				INTO #VELILIST
				FROM OdevSinifOgrenci OSO
				JOIN OdevSinif OS ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN Odev O ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = O.ID_DERS
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3OgrenciVeli OV ON OV.TCKIMLIKNO_OGR = OSO.TCKIMLIKNO
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEVSINIFOGRENCI INT,
					ID_ODEVDURUM INT,
					ACIKLAMA VARCHAR(MAX)				
				) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI 
				WHERE J.ID_ODEVDURUM = 3

				DECLARE @VELITCTEMP VARCHAR(11) = '', @OGRENCITCTEMP VARCHAR(11) = ''
				DECLARE @BILDIRIM11 VARCHAR(250)		= ''
				DECLARE @BILDIRIMTAM11 VARCHAR(MAX)	= ''

				WHILE EXISTS (SELECT 1 FROM #VELILIST)
				BEGIN
					SELECT TOP 1 @VELITCTEMP = TCKIMLIKNO, 
								 @OGRENCITCTEMP = TCKIMLIKNO_OGR,
								 @BILDIRIM11 = ACIKLAMA,
								 @BILDIRIMTAM11 = ACIKLAMA
					FROM #VELILIST

					DECLARE @LINK11 VARCHAR(MAX) = '', @LINK_ETIKET11 VARCHAR(MAX) = ''
					SET @LINK11			='https://pusulam.okyanuskoleji.k12.tr/AnaSayfaOutSide.html#OutSide/OSOdevListesi?TC_OGRENCI='+@OGRENCITCTEMP+'&TCKIMLIKNO='+@VELITCTEMP
					SET @LINK_ETIKET11	= 'Ödeve Git'

					SELECT @VELITCTEMP, 
						   @OGRENCITCTEMP,
						   @BILDIRIM11,
						   @BILDIRIMTAM11

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Ödev'
						,@MESAJ				= @BILDIRIM11
						,@LINK				= @LINK11
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @VELITCTEMP
						,@ID_UYGULAMA		= 2
						,@MESAJTAM			= @BILDIRIMTAM11
						,@LINK_ETIKET		= @LINK_ETIKET11

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Ödev'
						,@MESAJ				= @BILDIRIM11
						,@LINK				= @LINK11
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @VELITCTEMP
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @BILDIRIMTAM11
						,@LINK_ETIKET		= @LINK_ETIKET11

					DELETE FROM #VELILIST WHERE TCKIMLIKNO = @VELITCTEMP
				END

				DROP TABLE #VELILIST
			END

			IF @ISLEM = 12 -- ÖDEV GÜNCELLE
			BEGIN
				DECLARE @ID_ODEV12 INT
				SELECT @ID_ODEV12 = ID_ODEV
				FROM OPENJSON(@SQLJSON)
				WITH(ID_ODEV INT)

				UPDATE O SET O.BASLIK = J.BASLIK, O.ACIKLAMA = J.ACIKLAMA, O.VERILIS_TARIHI = J.VERILIS_TARIHI, O.TESLIM_TARIHI = J.TESLIM_TARIHI
				FROM Odev O
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEV INT,
					BASLIK VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					VERILIS_TARIHI VARCHAR(MAX),
					TESLIM_TARIHI VARCHAR(MAX)
				) J ON J.ID_ODEV = O.ID_ODEV

				DELETE FROM OdevDosya 
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevDosya (ID_ODEV, AD, GUID, UZANTI)
				SELECT @ID_ODEV12, AD, GUID, UZANTI
				FROM OPENJSON(@SQLJSON, '$.DOSYALIST')
				WITH (
					AD VARCHAR(MAX),
					GUID VARCHAR(MAX),
					UZANTI VARCHAR(MAX)
				)

				DELETE FROM OdevLink 
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevLink (ID_ODEV, AD, LINK)
				SELECT @ID_ODEV12, AD, LINK
				FROM OPENJSON(@SQLJSON, '$.LINKLIST')
				WITH (
					AD VARCHAR(MAX),
					LINK VARCHAR(MAX)
				) WHERE LINK <> ''

				DELETE FROM OdevMorpaKazanim
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevMorpaKazanim (ID_ODEV, ID_MORPAKAZANIM)
				SELECT @ID_ODEV12, VALUE
				FROM OPENJSON(@SQLJSON, '$.ID_MORPAKAZANIMLIST')
				WHERE VALUE <> 0

				DELETE FROM OdevMorpaMateryal
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevMorpaMateryal (ID_ODEV, ID_MORPAMATERYAL)
				SELECT @ID_ODEV12, VALUE
				FROM OPENJSON(@SQLJSON, '$.ID_MORPAMATERYALLIST')
				WHERE VALUE <> 0

				EXEC Pusulam.dbo.sp_Odev
								 @TCKIMLIKNO		= @TCKIMLIKNO
								,@OTURUM			= @OTURUM
								,@ID_ODEV			= @ID_ODEV12
								,@ID_MENU			= @ID_MENU
								,@GUNCELLEME		= 1
								,@ISLEM				= 19
			END

			IF @ISLEM = 13 -- ÖDEV RAPOR
			BEGIN
				SELECT	 TCKIMLIKNO = SO.TCKIMLIKNO
						,ADSOYAD = K.AD + ' ' + K.SOYAD
						,KAMPUS = SD.SUBEAD
						,SINIF = SD.SINIF
						,OGRENCINO = OT.OGRNO
						,FOTOGRAF = ISNULL(R.FOTOGRAF,'')
				INTO #OGRENCI13
				FROM OkyanusDB.dbo.vw_SinifOgrenci SO WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = SO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay SD WITH(NOLOCK) ON SD.ID_SINIF = SO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Ogrenci OT WITH(NOLOCK) ON OT.TCKIMLIKNO = SO.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3Resim R WITH(NOLOCK) ON R.TCKIMLIKNO = SO.TCKIMLIKNO AND R.SIRANO = 1
				WHERE SO.ID_SINIF = @ID_SINIF AND SO.TCKIMLIKNO = @TC_OGRENCI

				SELECT	 DONEM = DO.ACIKLAMA
						,TARIH = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
						,DERS = ISNULL(D.DERSAD, '') 
						,DEGERLENDIRME = OD.AD
						,O.BASLIK
						,OSO.ID_ODEVDURUM
						,O.VERILIS_TARIHI
				INTO #OGRENCIODEV13
				FROM OdevSinifOgrenci OSO WITH(NOLOCK)
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3AktifDonem DO WITH(NOLOCK) ON DO.DONEM = O.DONEM
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND OS.ID_SINIF = @ID_SINIF
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND O.VERILIS_TARIHI BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI

				SELECT * FROM #OGRENCI13

				SELECT	 O.ID_ODEVDURUM
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI		
				FROM	#OGRENCIODEV13 O
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = O.ID_ODEVDURUM
				GROUP BY O.ID_ODEVDURUM, OD.AD

				SELECT * FROM #OGRENCIODEV13 ORDER BY VERILIS_TARIHI DESC

				DROP TABLE #OGRENCI13
				DROP TABLE #OGRENCIODEV13
			END

			IF @ISLEM = 14 -- ÖĞRENCİ ÖDEV LİSTESİ
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 O.ID_ODEV
							,ISNULL(D.DERSAD, '') AS DERSAD
							,CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104) AS VERILIS_TARIHI
							,CONVERT(VARCHAR(MAX), O.TESLIM_TARIHI, 104) AS TESLIM_TARIHI
							,ISNULL(OD.AD, 'Kontrol Edilmedi') AS DURUM
							,O.BASLIK
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,O.ID_ODEVTUR							
							,DOSYASAYISI = (SELECT COUNT(SOD.GUID) 
											FROM OdevSinifOgrenci		SSO
											JOIN OdevSinifOgrenciDosya	SOD	ON	SOD.ID_ODEVSINIFOGRENCI = SSO.ID_ODEVSINIFOGRENCI
											WHERE SSO.ID_ODEVSINIF	= OS.ID_ODEVSINIF
												AND SSO.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI
												AND SOD.AKTIF		= 1												
												AND EXISTS (SELECT TOP 1 1  FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI = 4 AND SY.TCKIMLIKNO = @TCKIMLIKNO )
											)
					FROM OdevSinifOgrenci OSO WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
					INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
					LEFT JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
					WHERE O.AKTIF = 1 AND O.DONEM = @DONEM AND OSO.TCKIMLIKNO = @TC_OGRENCI AND (O.ID_DERS = @ID_DERS OR @ID_DERS = 0 OR @ID_DERS IS NULL)
					AND	(
								(ISNULL(@TAMAMLANDIDURUM, 0) = 0 AND NOT EXISTS (SELECT 1 FROM OdevTamamlandi OT WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO))
								OR
								(ISNULL(@TAMAMLANDIDURUM, 0) = 1 AND EXISTS (SELECT 1 FROM OdevTamamlandi OT WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO))
							)
					ORDER BY O.TESLIM_TARIHI DESC
					FOR JSON PATH
				)
				, '[]')
			END

			IF @ISLEM = 15 -- VELİ ÖDEV RAPOR
			BEGIN
				SELECT	 TCKIMLIKNO = O.TCKIMLIKNO
						,ADSOYAD = K.AD + ' ' + K.SOYAD
						,KAMPUS = SB.AD
						,SINIF = S.AD
						,OGRENCINO = O.OGRNO
						,FOTOGRAF = ISNULL(R.FOTOGRAF,'')
				INTO #OGRENCI15
				FROM OkyanusDB.dbo.v3OgrenciTum O WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3SinifTum S WITH(NOLOCK) ON S.ID_SINIF = O.ID_SINIF AND S.DONEM = O.DONEM
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS WITH(NOLOCK) ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube SB WITH(NOLOCK) ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3Resim R WITH(NOLOCK) ON R.TCKIMLIKNO = K.TCKIMLIKNO AND R.SIRANO = 1
				WHERE O.TCKIMLIKNO = @TC_OGRENCI AND O.DONEM = @DONEM

				SELECT	 DONEM = O.DONEM
						,TARIH = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
						,DERS = ISNULL(D.DERSAD, '') 
						,DEGERLENDIRME = OD.AD
						,O.BASLIK
						,OSO.ID_ODEVDURUM
						,O.VERILIS_TARIHI
				INTO #OGRENCIODEV15
				FROM OdevSinifOgrenci OSO WITH(NOLOCK)
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND (O.ID_DERS = @ID_DERS OR @ID_DERS = 0 OR @ID_DERS IS NULL)
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND O.DONEM = @DONEM
				AND ((@ID_DERS > 0 AND O.ID_ODEVTUR <> 5) OR (@ID_DERS = 0 OR @ID_DERS IS NULL))

				SELECT * FROM #OGRENCI15

				SELECT	 O.ID_ODEVDURUM
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI		
				FROM	#OGRENCIODEV15 O
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = O.ID_ODEVDURUM
				GROUP BY O.ID_ODEVDURUM, OD.AD

				SELECT * FROM #OGRENCIODEV15 
				ORDER BY VERILIS_TARIHI DESC

				IF @ID_DERS > 0
				BEGIN
					SELECT DERSAD + ' Ödev Durumu' AS TITLE
					FROM eokul_v2.dbo.Ders WITH(NOLOCK)
					WHERE ID_DERS= @ID_DERS
				END
				ELSE
				BEGIN
					SELECT 'Genel Ödev Durumu' AS TITLE
				END

				DROP TABLE #OGRENCI15
				DROP TABLE #OGRENCIODEV15
			END

			IF @ISLEM = 16 -- ÖĞRETMEN ÖDEV RAPORU
			BEGIN
				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(*) AS SAYI
				INTO #TUMODEVLER
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))	
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(*) AS SAYI
				INTO #KONTROLEDILENODEVLER
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 1
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(*) AS SAYI
				INTO #KONTROLTARIHIGECMEYEN
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 0
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(*) AS SAYI
				INTO #KONTROLTARIHIGECEN
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 0
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				IF @RAPORMU = 0
				BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 T.ID_SINIF
							,T.ID_DERS
							,T.TCKIMLIKNO
							,T.ADSOYAD
							,T.SUBEAD
							,T.SINIFAD
							,T.DERSAD
							,T.SAYI AS VERILEN
							,ISNULL(K.SAYI, 0) AS KONTROLEDILEN
							,ISNULL(KG.SAYI, 0) AS KONTROLEDILMEYEN
							,ISNULL(KGM.SAYI, 0) AS KONTROLSURESIDOLMAYAN
					FROM #TUMODEVLER T
					LEFT JOIN #KONTROLEDILENODEVLER K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND K.ID_SINIF = T.ID_SINIF AND K.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECEN KG ON KG.TCKIMLIKNO = T.TCKIMLIKNO AND KG.ID_SINIF = T.ID_SINIF AND KG.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECMEYEN KGM ON KGM.TCKIMLIKNO = T.TCKIMLIKNO AND KGM.ID_SINIF = T.ID_SINIF AND KGM.ID_DERS = T.ID_DERS
					ORDER BY T.TCKIMLIKNO, T.ADSOYAD, T.SINIFAD, T.DERSAD
					FOR JSON PATH
				)
				, '[]')
				END
				ELSE 
				BEGIN
					SELECT	 T.ID_SINIF
							,T.ID_DERS
							,T.TCKIMLIKNO
							,T.ADSOYAD
							,T.SUBEAD
							,T.SINIFAD
							,T.DERSAD
							,T.SAYI AS VERILEN
							,ISNULL(K.SAYI, 0) AS KONTROLEDILEN
							,ISNULL(KG.SAYI, 0) AS KONTROLEDILMEYEN
							,ISNULL(KGM.SAYI, 0) AS KONTROLSURESIDOLMAYAN
					FROM #TUMODEVLER T
					LEFT JOIN #KONTROLEDILENODEVLER K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND K.ID_SINIF = T.ID_SINIF AND K.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECEN KG ON KG.TCKIMLIKNO = T.TCKIMLIKNO AND KG.ID_SINIF = T.ID_SINIF AND KG.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECMEYEN KGM ON KGM.TCKIMLIKNO = T.TCKIMLIKNO AND KGM.ID_SINIF = T.ID_SINIF AND KGM.ID_DERS = T.ID_DERS
					ORDER BY T.TCKIMLIKNO, T.ADSOYAD, T.SINIFAD, T.DERSAD
				END

				DROP TABLE #TUMODEVLER
				DROP TABLE #KONTROLEDILENODEVLER
				DROP TABLE #KONTROLTARIHIGECMEYEN
				DROP TABLE #KONTROLTARIHIGECEN
			END

			IF @ISLEM = 17 -- ÖĞRETMEN ÖDEV RAPOR DETAY
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 O.ID_ODEV
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), O.TESLIM_TARIHI, 104)
							,DURUM = CASE 
									WHEN O.KONTROL = 1 THEN 1
									WHEN O.KONTROL = 0 and DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
									WHEN O.KONTROL = 0 and DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
									END
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
					WHERE O.KYE_KULLANICI = @TC_OGRETMEN
					AND (@ID_DERS IS NULL OR @ID_DERS = 0 OR O.ID_DERS = @ID_DERS)
					AND O.ID_ODEVTUR = @ID_ODEVTUR
					AND OS.ID_SINIF = @ID_SINIF
					AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
					AND (
						@TUR = 1
						OR (@TUR = 2 AND O.KONTROL = 1)
						OR (@TUR = 3 AND O.KONTROL = 0 AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI)
						OR (@TUR = 4 AND O.KONTROL = 0 AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI)
					)
					FOR JSON PATH
				)
				, '[]')
			END	

			IF @ISLEM = 18 -- MORPA API
			BEGIN
				IF @APIKEY = 'D16EB1CA-062F-4CF8-8E3B-8700E44A06A0'
				BEGIN
					SELECT 
					(
						SELECT SUCCESS = 1,
							   DESCRIPTION = 'Başarılı!',
							   LIST = (
											ISNULL((
												SELECT	 O.ID_ODEV
														,O.ID_MORPADERS	
														,OS.ID_ODEVSINIF
														,SINIF = K3.DUZEY
														,SINIFAD = S.AD
														,BASLIK
														,ACIKLAMA
														,VERILIS_TARIHI
														,TESLIM_TARIHI
														--,KYE_KULLANICI
														,KYE_KULLANICI = (CASE WHEN O.ID_KADEME3 IN (7, 8, 9, 10) THEN (SELECT TOP 1 TCKIMLIKNO FROM OkyanusDB.dbo.v3SinifPersonel P WHERE P.ID_SINIF = OS.ID_SINIF AND P.ID_KULLANICITIPI = 100) ELSE O.KYE_KULLANICI END)
														,KYE_TARIH
														,MATERYALLIST = (SELECT DISTINCT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM JOIN MorpaMateryal MM ON MM.ID_MORPAMATERYAL = OMM.ID_MORPAMATERYAL AND MM.ID_MORPADERS = O.ID_MORPADERS WHERE OMM.ID_ODEV = O.ID_ODEV AND MM.AKTIF = 1 FOR JSON PATH)
														,KAZANIMLIST = (SELECT DISTINCT MK.KOD as ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK JOIN MorpaKazanim MK ON MK.ID_MORPAKAZANIM = OMK.ID_MORPAKAZANIM AND MK.AKTIF = 1 WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH)
														,OGRENCILIST = (
																			SELECT DISTINCT TCKIMLIKNO
																			FROM OdevSinifOgrenci OSO 
																			WHERE OS.ID_ODEV = O.ID_ODEV AND OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF FOR JSON PATH
																		)
												FROM Odev O WITH(NOLOCK)
												INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 WITH(NOLOCK) ON K3.ID_KADEME3 = O.ID_KADEME3
												INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
												INNER JOIN OkyanusDB.dbo.v3Sinif S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
												WHERE O.AKTIF = 1
												AND O.ID_ODEVTUR = 5
												AND O.VERILIS_TARIHI BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
												ORDER BY O.ID_ODEV
												FOR JSON PATH
											), '[]')
								)
						FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
					)
				END
				ELSE
				BEGIN
					SELECT 
					(
						SELECT SUCCESS = 0,
							   DESCRIPTION = 'Gönderilen apikey hatalı!',
							   LIST = '[]'
						FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
					)
				END
			END

			Branch_Islem19:

			IF @ISLEM = 19 -- ÖDEV BİLDİRİM - MAİL GÖNDER
			BEGIN
				DECLARE	@TC_ALAN VARCHAR(11)

				--DECLARE @MAIL VARCHAR(MAX)
				--DECLARE @MAILKONU VARCHAR(150)
				--DECLARE @ALANMAIL VARCHAR(MAX)
				DECLARE @DERSAD VARCHAR(100)
				DECLARE @ADSOYAD VARCHAR(150)
				DECLARE @BASLIK VARCHAR(150)
				DECLARE @ACIKLAMA VARCHAR(500)
				DECLARE @VERILISTARIHI VARCHAR(50)
				DECLARE @TESLIMTARIHI VARCHAR(50)
	   
				SELECT	 @DERSAD           = ISNULL(D.DERSAD, '')
						,@ADSOYAD          = ISNULL(K.AD + ' ' + K.SOYAD, '')
						,@BASLIK           = OD.BASLIK
						,@ACIKLAMA         = OD.ACIKLAMA
						,@VERILISTARIHI    = CONVERT(VARCHAR(MAX), OD.VERILIS_TARIHI, 104)
						,@TESLIMTARIHI     = CONVERT(VARCHAR(MAX), OD.TESLIM_TARIHI, 104)
				FROM Odev OD WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders				D WITH(NOLOCK) ON OD.ID_DERS = D.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K WITH(NOLOCK) ON K.TCKIMLIKNO = OD.KYE_KULLANICI
				WHERE OD.ID_ODEV = @ID_ODEV 
		

				--SET @MAIL = '<html><head>
				--<style>body{font-family:verdana;}.baslik{background-color:rgb(176, 229, 231);width:150px;}table{width:100%;}td {border:1px solid #e3e3e3;}</style>
				--</head><body><table><tr>
				--<td class="baslik">Öğretmen Ad</td>
				--<td>' + @ADSOYAD + '</td>
				--<td class="baslik">Ders</td>
				--<td>' + @DERSAD + '</td>
				--</tr><tr>
				--<td class="baslik">Konu</td>
				--<td>' + @BASLIK + '</td>
				--<td class="baslik">Veriliş-Teslim Tarihleri</td>
				--<td>' + @VERILISTARIHI + '-' + @TESLIMTARIHI+'</td>
				--</tr><tr>
				--<td colspan="4"><br>' + @ACIKLAMA + '<br></td>
				--</tr><tr>
				--<td colspan="4"><a href="http://interaktif.okyanuskoleji.k12.tr/" target="_blank">Giriş yapmak için tıklayın...</a></td>
				--</tr></table></body></html>'

				--SET @MAILKONU = (SELECT 'Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN 'Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK)

				SELECT DISTINCT OSO.TCKIMLIKNO
				INTO #OGRENCILIST
				FROM Odev O WITH(NOLOCK)
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OdevSinifOgrenci OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF
				WHERE O.ID_ODEV = @ID_ODEV
				
				/*
				IF @MAIL IS NOT NULL
				BEGIN
					SELECT DISTINCT
						KO.EMAIL,
						K.TCKIMLIKNO
					INTO #MAILLIST
					FROM #OGRENCILIST O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3KullaniciBilgi KO WITH(NOLOCK) ON KO.TCKIMLIKNO = K.TCKIMLIKNO
					WHERE KO.EMAIL LIKE '%_@_%_.__%' AND K.AKTIF=1
					UNION 
					SELECT  
						KB.EMAIL,
						K.TCKIMLIKNO
					FROM #OGRENCILIST O
					INNER JOIN OkyanusDB.dbo.v3OgrenciVeli OV WITH(NOLOCK) ON OV.TCKIMLIKNO_OGR = O.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = OV.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3KullaniciBilgi KB WITH(NOLOCK) ON KB.TCKIMLIKNO = K.TCKIMLIKNO
					WHERE KB.EMAIL LIKE '%_@_%_.__%' AND K.AKTIF=1

					WHILE EXISTS (SELECT TOP 1 * FROM #MAILLIST)
					BEGIN	
						SELECT TOP 1 
							 @TC_ALAN	= TCKIMLIKNO
							,@ALANMAIL	= EMAIL
						FROM #MAILLIST ORDER BY TCKIMLIKNO 


						EXEC OkyanusIletisim.dbo.sp_SendPushMail
								 @TCKIMLIKNO		= @TCKIMLIKNO
								,@HEADER			= @MAILKONU
								,@MESAJ				= @MAIL
								,@MAILADRES			= @ALANMAIL
								,@LINK				= ''
								,@TCKIMLIKNO_KIME	= @TC_ALAN
								,@ID_UYGULAMA		= 2

						DELETE FROM #MAILLIST WHERE TCKIMLIKNO = @TC_ALAN
					END
				END
				*/
				DECLARE @BILDIRIM VARCHAR(250)		= (SELECT SUBSTRING('Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN ' Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK, 0, 249))
				DECLARE @BILDIRIMTAM VARCHAR(MAX)	= (SELECT			'Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN ' Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK)

				SELECT DISTINCT
					O.TCKIMLIKNO , O.TCKIMLIKNO AS TC_OGRENICI
				INTO #BILDIRIMLIST
				FROM #OGRENCILIST O
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
				WHERE K.AKTIF=1
				UNION 
				SELECT DISTINCT
					K.TCKIMLIKNO, OV.TCKIMLIKNO_OGR AS TC_OGRENICI
				FROM #OGRENCILIST O
				INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	OV WITH(NOLOCK)	ON OV.TCKIMLIKNO_OGR = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K WITH(NOLOCK)	ON K.TCKIMLIKNO = ov.TCKIMLIKNO
				WHERE K.AKTIF = 1

				WHILE EXISTS (SELECT TOP 1 * FROM #BILDIRIMLIST)
				BEGIN
					SELECT TOP 1 
						@TC_ALAN	= TCKIMLIKNO,
						@TC_OGRENCI	= TC_OGRENICI
					FROM #BILDIRIMLIST 
					ORDER BY TCKIMLIKNO 

			
					DECLARE @LINK VARCHAR(MAX) = '', @LINK_ETIKET VARCHAR(MAX) = ''

					IF @TC_ALAN <> @TC_OGRENCI
					BEGIN
						SET @LINK			='https://pusulam.okyanuskoleji.k12.tr/AnaSayfaOutSide.html#OutSide/OSOdevListesi?TC_OGRENCI='+@TC_OGRENCI+'&TCKIMLIKNO='+@TC_ALAN
						SET @LINK_ETIKET	= 'Ödeve Git'
					END

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
							 @TCKIMLIKNO		= @TCKIMLIKNO
							,@HEADER			= 'Interaktif Ödev'
							,@MESAJ				= @BILDIRIM
							,@LINK				= @LINK
							,@MENU				= '000'
							,@TCKIMLIKNO_KIME	= @TC_ALAN
							,@ID_UYGULAMA		= 2
							,@MESAJTAM			= @BILDIRIMTAM
							,@LINK_ETIKET		= @LINK_ETIKET

						EXEC OkyanusIletisim.dbo.sp_SendPushMessage
							 @TCKIMLIKNO		= @TCKIMLIKNO
							,@HEADER			= 'Interaktif Ödev'
							,@MESAJ				= @BILDIRIM
							,@LINK				= @LINK
							,@MENU				= '000'
							,@TCKIMLIKNO_KIME	= @TC_ALAN
							,@ID_UYGULAMA		= 1
							,@MESAJTAM			= @BILDIRIMTAM
							,@LINK_ETIKET		= @LINK_ETIKET

					DELETE FROM #BILDIRIMLIST WHERE TCKIMLIKNO = @TC_ALAN
				END
	
				DROP TABLE IF EXISTS #BILDIRIMLIST
				--DROP TABLE IF EXISTS #MAILLIST
				DROP TABLE IF EXISTS #OGRENCILIST
			END

			IF @ISLEM = 20 -- MORPA API -- METE KONTROL
			BEGIN
				SELECT	 O.ID_ODEV
						,O.ID_MORPADERS	
						,OS.ID_ODEVSINIF
						,SINIF = K3.DUZEY
						,SINIFAD = S.AD
						,BASLIK
						,ACIKLAMA
						,VERILIS_TARIHI
						,TESLIM_TARIHI
						--,KYE_KULLANICI
						,KYE_KULLANICI = (CASE WHEN O.ID_KADEME3 IN (7, 8, 9, 10) THEN (SELECT TOP 1 TCKIMLIKNO FROM OkyanusDB.dbo.v3SinifPersonel P WITH(NOLOCK) WHERE P.ID_SINIF = OS.ID_SINIF AND P.ID_KULLANICITIPI = 100) ELSE O.KYE_KULLANICI END)
						,KYE_TARIH
						,MATERYALLIST = (SELECT DISTINCT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM WITH(NOLOCK) JOIN MorpaMateryal MM WITH(NOLOCK) ON MM.ID_MORPAMATERYAL = OMM.ID_MORPAMATERYAL AND MM.ID_MORPADERS = O.ID_MORPADERS WHERE OMM.ID_ODEV = O.ID_ODEV AND MM.AKTIF = 1 FOR JSON PATH)
						,KAZANIMLIST = (SELECT DISTINCT MK.KOD as ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK WITH(NOLOCK) JOIN MorpaKazanim MK WITH(NOLOCK) ON MK.ID_MORPAKAZANIM = OMK.ID_MORPAKAZANIM AND MK.AKTIF = 1 WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH)
						,OGRENCILIST = (
											SELECT DISTINCT TCKIMLIKNO
											FROM OdevSinifOgrenci OSO  WITH(NOLOCK)
											WHERE OS.ID_ODEV = O.ID_ODEV AND OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF FOR JSON PATH
										)
				FROM Odev O WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 WITH(NOLOCK) ON K3.ID_KADEME3 = O.ID_KADEME3
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.v3Sinif S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				WHERE O.AKTIF = 1
				AND O.ID_ODEVTUR = 5
				AND O.VERILIS_TARIHI >= CAST(DATEADD(DAY, -7, GETDATE()) AS DATE)
				ORDER BY O.ID_ODEV
			END

			IF @ISLEM = 21 -- ÖDEV TAMAMLA
			BEGIN
				INSERT INTO OdevTamamlandi(ID_ODEV,TCKIMLIKNO)
				SELECT @ID_ODEV, @TCKIMLIKNO
			END

			IF @ISLEM = 23 -- ÖĞRENCİ ÖDEV DOSYA EKLE
			BEGIN

				DECLARE @GUID_DOSYA VARCHAR(36) = NEWID()
				WHILE EXISTS(SELECT TOP 1 1 FROM OdevSinifOgrenciDosya D WHERE D.GUID = @GUID_DOSYA)
				BEGIN
					SET @GUID_DOSYA = NEWID()
				END

				SET @ID_ODEVSINIFOGRENCI = (SELECT OSO.ID_ODEVSINIFOGRENCI
											FROM Odev				O
											JOIN OdevSinif			OS	ON	OS.ID_ODEV		= O.ID_ODEV
											JOIN OdevSinifOgrenci	OSO	ON	OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
											WHERE	O.ID_ODEV	= @ID_ODEV
												AND TCKIMLIKNO	= @TCKIMLIKNO)

				DECLARE @INSERT23 TABLE(ID INT)
				INSERT INTO OdevSinifOgrenciDosya (ID_ODEVSINIFOGRENCI, GUID) 
				OUTPUT inserted.ID_ODEVSINIFOGRENCIDOSYA INTO @INSERT23
				VALUES (@ID_ODEVSINIFOGRENCI, @GUID_DOSYA)

				SELECT	 GUID						= @GUID_DOSYA
						,ID_ODEVSINIFOGRENCIDOSYA	= (SELECT TOP 1 ID FROM @INSERT23)
				FOR JSON PATH

			END

			IF @ISLEM = 24 -- ÖĞRENCİ ÖDEV DOSYA SİL
			BEGIN

				UPDATE OdevSinifOgrenciDosya SET
					AKTIF		= 0,
					KYI_TARIH	= GETDATE()
				WHERE ID_ODEVSINIFOGRENCIDOSYA = @ID_ODEVSINIFOGRENCIDOSYA

			END

		END
	
	--COMMIT TRANSACTION [TranOdev]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [TranOdev]
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END

-----------------

USE [OkyanusIletisim]
GO
/****** Object:  StoredProcedure [dbo].[sp_SendPushMessage]    Script Date: 10.12.2020 10:21:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

------------PUSULAM-------------
ALTER procedure [dbo].[sp_VIU]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	
	@BASTARIH			VARCHAR(MAX)	= NULL,
	@BITTARIH			VARCHAR(MAX)	= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@TCOGRETMENLIST		VARCHAR(MAX)	= NULL,
	@ID_ARAMADURUMLIST	VARCHAR(MAX)	= NULL,
	@ID_ARAMASEBEPLIST	VARCHAR(MAX)	= NULL,
	@JSON				BIT				= NULL,
	@ID_SUBELER		    VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
									
				,BASTARIH			= @BASTARIH
				,BITTARIH			= @BITTARIH
				,ID_SUBELIST		= @ID_SUBELIST
				,TCOGRETMENLIST		= @TCOGRETMENLIST
				,ID_ARAMADURUMLIST	= @ID_ARAMADURUMLIST
				,ID_ARAMASEBEPLIST	= @ID_ARAMASEBEPLIST
				,[JSON]				= @JSON
				,ID_SUBELER		    = @ID_SUBELER
				,ID_SINIFLAR        = @ID_SINIFLAR
				,SQLJSON			= @SQLJSON
				,TC_OGRETMEN		= @TC_OGRETMEN
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @ID_LOG > 0
		BEGIN	
			IF @ISLEM = 1	--	VIU Rapor Mesaj
			BEGIN			
				SELECT
					 ACIKLAMA	=	B.AD + IIF(D.ID_DOKUMAN IS NOT NULL ,'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/'+ D.GUID ,'')
					,KYE_TARIH	=	CONVERT(VARCHAR(10), B.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), B.KYE_TARIH, 108)
					,GONDERENTC	=	KYE.TCKIMLIKNO
					,GONDEREN	=	KYE.AD  +' '+ KYE.SOYAD
					,KIME		=	KIME.AD +' '+ KIME.SOYAD
					,KIMICIN	=	KYI.AD  +' '+ KYI.SOYAD
					
					,GONDERENSUBE	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,GONDERENTIP	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMESUBE		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMETIP		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,RENK = IIF( IPTAL = 1 , 'Red' , 'Black' )
				FROM OkyanusIletisim.dbo.BilgiNot					B
				INNER JOIN OkyanusIletisim.dbo.BilgiNotKullanici	N		ON	N.ID_BILGINOT	= B.ID_BILGINOT
				LEFT  JOIN OkyanusIletisim.dbo.Dokuman				D		ON	D.ID_DOKUMAN	= B.ID_DOKUMAN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYE		ON	KYE.TCKIMLIKNO	= B.KYE_TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYI		ON	KYI.TCKIMLIKNO	= N.TCKIMLIKNO_KIMICIN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KIME	ON	KIME.TCKIMLIKNO	= N.TCKIMLIKNO_KIME
				WHERE CAST(B.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO AND SB.ID_SUBE	IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
					)		
				ORDER BY B.KYE_TARIH DESC
			END
	
			IF @ISLEM = 2	--	VIU Rapor VIÜ Kullanmayanlar
			BEGIN				
				
				DECLARE @DONEM NVARCHAR(MAX)

				SELECT TOP 1 @DONEM = '01.09.' + DONEM 
				FROM OkyanusDB.dbo.v3AktifDonem
				WHERE AKTIF = 1


				--SELECT DISTINCT
				--	 SUBE			= SB.AD
				--	,TCKIMLIKNO		= K.TCKIMLIKNO
				--	,AD				= K.AD
				--	,SOYAD			= K.SOYAD
				--	,KULLANICIAD	= K.KULLANICIAD
				--	,SIFRE			= K.SIFRE
				--	,SINIF			= SN.AD
				--	,KADEME			= K3.AD
				--	,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
				--	,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				--INTO #KULLANICILIST
				--FROM		OkyanusDB.dbo.v3Kullanici	K
				--INNER JOIN	OkyanusDB.dbo.v3SubeYetki	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO 
				--INNER JOIN	OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO	= K.TCKIMLIKNO
				--INNER JOIN	OkyanusDB.dbo.v3Ogrenci		OG	ON	OG.TCKIMLIKNO	= OV.TCKIMLIKNO_OGR
				--INNER JOIN	OkyanusDB.dbo.v3Sinif		SN	ON	SN.ID_SINIF		= OG.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3Satislar	SL	ON	SL.ID_SINIF		= SN.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= SL.ID_SATISTURU
				--INNER JOIN	OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3 
				--INNER JOIN	OkyanusDB.dbo.v3Sube		SB	ON	SB.ID_SUBE		= SY.ID_SUBE
				--LEFT JOIN	OkyanusIletisim.dbo.LoginLog L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
				--											AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				--WHERE	K.AKTIF = 1 
				--	AND SY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				--	AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
				--GROUP BY SB.AD, K.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, SN.AD, K3.AD, L.KYE_TCKIMLIKNO
				
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST

				SELECT VALUE ID_SUBE INTO #SUBELIST FROM OPENJSON(@ID_SUBELIST)

				SELECT DISTINCT 
					 SUBE			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SB.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE = SKY.ID_SUBE
														WHERE	SKY.TCKIMLIKNO	= KY.TCKIMLIKNO													
															AND SKY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 													
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,TCKIMLIKNO		= KY.TCKIMLIKNO
					,AD				= K.AD
					,SOYAD			= K.SOYAD
					,KULLANICIAD	= K.KULLANICIAD
					,SIFRE			= K.SIFRE
					,KULLANICITIPI	= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( KT.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3KullaniciTipi		KT	ON	KT.ID_KULLANICITIPI	= SKY.ID_KULLANICITIPI
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	 IN (5, 3, 53, 54, 26)
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,SINIF			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SN.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3Sinif				SN	ON	SN.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,KADEME			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SGS.KADEME3 AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.vw_SubeGrupSinif		SGS	ON	SGS.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
					,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				INTO #KULLANICILIST
				FROM OkyanusDB.dbo.vw_KullaniciYetki	KY
				JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= KY.TCKIMLIKNO
				JOIN #SUBELIST							SL	ON	SL.ID_SUBE		= KY.ID_SUBE
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
															AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				WHERE	KY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				GROUP BY KY.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, L.KYE_TCKIMLIKNO--, SN.AD, K3.AD, SB.AD




				SELECT KL.*
					,LOGINTARIH		= CONVERT(VARCHAR(10), L.KYE_TARIH, 104) + ' ' + CONVERT(VARCHAR(8), L.KYE_TARIH, 108) 
					,LOGINOTURUM	= SUBSTRING(CAST(L.OTURUM AS VARCHAR(MAX)),1,LEN(CAST(L.OTURUM AS VARCHAR(MAX)))-5)+ '*****'
				FROM #KULLANICILIST						KL
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	L.ID_LOGINLOG	= KL.ID_LOGINLOG
				ORDER BY SUBE, AD, SOYAD
								
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST


			END
			
			IF @ISLEM = 3	--	Arama Sebep Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMASEBEP, S.AD + ' (' + K.AD + ')' AS AD
					FROM [OkyanusIletisim].[dbo].[AramaSebep] S
					JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = S.ID_KADEME
					ORDER BY S.ID_KADEME, S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 4	--	Arama Durum Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMADURUM, S.AD
					FROM [OkyanusIletisim].[dbo].[AramaDurum] S
					ORDER BY S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 5	--	Arama Rapor
			BEGIN
				IF @JSON = 1
				BEGIN
					SELECT 
					ISNULL (
					(
						SELECT	 GUID			=	A.GUID
								,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
								,ARAYANTC		=	A.TC_ARAYAN
								,ARAYAN			=	K.AD  +' '+ K.SOYAD
								,KIME			=	A.ADSOYAD_ARANAN
								,ARAMASEBEP		=	S.AD 
								,ARAMADURUM		=	D.AD 
								,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
								,GRUP			=	K3.AD
								,SINIF			=	SNF.AD
								,ARAYANSUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
															FOR XML PATH('')
													), 1, 1, '')
								--,ARAYANTIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
								--				FOR XML PATH('')
								--				), 1, 1, '')
								,KIMESUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
															FOR XML PATH('')
													), 1, 1, '')
								--,KIMETIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
								--				FOR XML PATH('')
								--				), 1, 1, '') 
						FROM OkyanusIletisim.dbo.Arama		A	WITH (NOLOCK)
						JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO	= A.TC_ARAYAN
						JOIN OkyanusDB.dbo.v3Kullanici		KYI ON	KYI.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
						JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
						JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
						JOIN OkyanusIletisim.dbo.AramaSebep S	ON	S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
						JOIN OkyanusIletisim.dbo.AramaDurum D	ON	D.ID_ARAMADURUM = A.ID_ARAMADURUM
						WHERE	CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
						AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
						AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
						AND (
									(	EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST)))
							OR		(NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (	SELECT DISTINCT  SY.TCKIMLIKNO
														FROM OkyanusDB.dbo.v3SubeYetki	SY
														INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
														WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
									)	
								)
							)	
						AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
						ORDER BY A.KYE_TARIH DESC
						FOR JSON PATH
					), '[]')
				END
				ELSE
				BEGIN
					SELECT	 GUID			=	A.GUID
							,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
							,ARAYANTC		=	A.TC_ARAYAN
							,ARAYAN			=	K.AD  +' '+ K.SOYAD
							,KIME			=	A.ADSOYAD_ARANAN
							,ARAMASEBEP		=	S.AD 
							,ARAMADURUM		=	D.AD 
							,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
							,GRUP			=	K3.AD
							,SINIF			=	SNF.AD
							,ARAYANSUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
											FOR XML PATH('')
											), 1, 1, '')
							--,ARAYANTIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
							--				FOR XML PATH('')
							--				), 1, 1, '')
							,KIMESUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
											FOR XML PATH('')
											), 1, 1, '')
							--,KIMETIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
							--				FOR XML PATH('')
							--				), 1, 1, '') 
					FROM OkyanusIletisim.dbo.Arama A	WITH (NOLOCK)
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = A.TC_ARAYAN
					JOIN OkyanusDB.dbo.v3Kullanici KYI ON KYI.TCKIMLIKNO = A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
					JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
					JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
					JOIN OkyanusIletisim.dbo.AramaSebep S ON S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
					JOIN OkyanusIletisim.dbo.AramaDurum D ON D.ID_ARAMADURUM = A.ID_ARAMADURUM
					WHERE CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
					AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
						)	
					AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
					ORDER BY A.KYE_TARIH DESC
				END
			END

			IF @ISLEM = 6   --  Yoklama Rapor
			BEGIN
				--SELECT distinct 
				--	 D.SUBEAD
				--	,D.SINIF
				--	,K.AD + ' '+ K.SOYAD [AD SOYAD]
				--	,CONVERT(VARCHAR(10), Y.TARIH, 105)AS TARIH
				--	,K.TCKIMLIKNO
				--	,D.ID_SINIF
				--	,Y.ID_YOKLAMA
				--	,YK.GELDI
				--	,Y.TARIH AS tarih
				--	,CASE
				--			WHEN GELDI>0 THEN 'GELDİ'
				--			WHEN GELDI<1 THEN 'GELMEDİ'
				--		END AS DURUM
				--FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				--INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				--INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				--INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				--INNER JOIN  [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF	= D.ID_SINIF	AND	S.ID_SINIF		= Y.ID_SINIF
				--INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici] YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA  AND YK.TCKIMLIKNO	= K.TCKIMLIKNO
				--WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				--AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				--AND CAST(TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
				--ORDER BY  D.SUBEAD ASC,D.SINIF ASC,[AD SOYAD] ASC ,tarih DESC

				SELECT DERSNO, AD = BASSAAT + ' - ' + BITSAAT
				INTO #DERSSAAT
				FROM Pusulam.dbo.OnlineDersSaat   

				SELECT CAST(DATEADD(DAY, number, @BASTARIH) AS DATE) [Date]
				INTO #DATES
				FROM master..spt_values
				WHERE type = 'P'
				AND DATEADD(DAY, number, @BASTARIH) <= @BITTARIH

				SELECT distinct 
					 SD.SUBEAD
					,SD.SINIF
					,K.AD + ' '+ K.SOYAD [AD SOYAD]
					,K.TCKIMLIKNO
					,S.ID_SINIF
				INTO #KULLANICI
				FROM		OkyanusDB.dbo.vw_SinifOgrenci				S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				SD	ON S.ID_SINIF	= SD.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= SD.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				WHERE AD.AKTIF=1        
				AND ( ( SD.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( SD.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  

				SELECT K.*, D.Date AS TARIH, CONVERT(VARCHAR(MAX), D.Date, 104) AS STRTARIH
				INTO #KULLANICITARIH
				FROM #KULLANICI K
				CROSS APPLY #DATES D

				SELECT K.TCKIMLIKNO, K.TARIH, DP.DERSSAAT, CASE WHEN YK.GELDI = 1 THEN 'GELDİ' ELSE 'GELMEDİ' END AS DURUM
				INTO #KULLANICIDURUM
				FROM #KULLANICITARIH K
				INNER JOIN [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF = K.ID_SINIF AND Y.TARIH = K.TARIH
				INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici]	YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA AND YK.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN  OkyanusDB.dbo.v3DersProgram DP					ON DP.ID_DERSPROGRAM = Y.ID_DERSPROGRAM


				DECLARE @INDEX INT = 1
				DECLARE @COLUMN VARCHAR(MAX) = ''
				DECLARE @DERSNO VARCHAR(MAX) = ''

				WHILE @INDEX <= (SELECT MAX(DERSNO) FROM #DERSSAAT WHERE AD != ' - ')
				BEGIN
					SELECT @COLUMN = AD, @DERSNO = DERSNO FROM #DERSSAAT WHERE DERSNO = @INDEX

					EXECUTE('
					ALTER TABLE #KULLANICITARIH
					ADD [' + @COLUMN + '] VARCHAR(MAX)
					')
		
					EXECUTE ('UPDATE K SET K.[' + @COLUMN + '] = ISNULL((
																			SELECT DURUM
																			FROM #KULLANICIDURUM KD
																			WHERE KD.TARIH = K.TARIH AND KD.TCKIMLIKNO = K.TCKIMLIKNO AND KD.DERSSAAT = ' + @DERSNO + '
																), ''-'') FROM #KULLANICITARIH K')


					SET @INDEX = @INDEX + 1
				END

				SELECT *
				FROM #KULLANICITARIH
				ORDER BY SUBEAD ASC,SINIF ASC, [AD SOYAD] ASC, TARIH

				DROP TABLE #KULLANICI
				DROP TABLE #DERSSAAT
				DROP TABLE #DATES
				DROP TABLE #KULLANICITARIH
				DROP TABLE #KULLANICIDURUM
			END

			IF @ISLEM = 7   --  Viu Yetki Listesi
			BEGIN
			
				SELECT 
				(
					SELECT	Distinct K.AD + ' '+ K.SOYAD AS ADSOYAD ,K.TCKIMLIKNO
							
							,(	
							   
								SELECT distinct D.SUBEAD AS SUBEAD,D.ID_SUBE, 
								SECILI = (SELECT COUNT(*) FROM  ViuAramaKullaniciSube S where D.ID_SUBE=S.ID_SUBE and S.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.SUBEAD,D.ID_SUBE
								ORDER BY D.SUBEAD,D.ID_SUBE
								FOR JSON PATH
							 ) AS SUBE
							 ,(
							 SELECT distinct D.KADEME3 AS GRUP,D.ID_KADEME3, 
							 SECILI = (SELECT COUNT(*) FROM  ViuAramaKullaniciKademe K where K.ID_KADEME3=D.ID_KADEME3 and K.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.KADEME3,D.ID_KADEME3
								ORDER BY D.ID_KADEME3
								FOR JSON PATH
							 )
							 AS GRUP
					FROM OkyanusDB.dbo.v3Kullanici	K
					INNER JOIN OkyanusDB.[dbo].[v4KullaniciSubeTurKademe] TK  ON   TK.TCKIMLIKNO=K.TCKIMLIKNO 
					WHERE K.TCKIMLIKNO =@TC_OGRETMEN
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8   --  Viu Yetki Kaydet
			BEGIN
		   
				DELETE FROM ViuAramaKullanici WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciSube WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciKademe WHERE TCKIMLIKNO = @TC_OGRETMEN
				
				MERGE INTO ViuAramaKullanici AS A 
                USING ( 
						SELECT *
                        FROM OPENJSON(@SQLJSON) WITH ( TCKIMLIKNO VARCHAR(MAX) )) B
                ON (A.TCKIMLIKNO = B.TCKIMLIKNO) 
                WHEN MATCHED THEN 
                UPDATE  SET A.TCKIMLIKNO =B.TCKIMLIKNO                  
                WHEN NOT MATCHED THEN 
                INSERT  (TCKIMLIKNO)
				VALUES (B.TCKIMLIKNO);

					

				SELECT DISTINCT TCKIMLIKNO
                FROM OPENJSON(@SQLJSON)
                WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
		                ,SUBE		NVARCHAR(MAX) AS JSON 
		                ,GRUP		NVARCHAR(MAX) AS JSON
                ) AS J
					
                     
				INSERT INTO ViuAramaKullaniciSube(TCKIMLIKNO, ID_SUBE)
				SELECT DISTINCT TCKIMLIKNO, ID_SUBE 
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.SUBE)
				WITH(	 ID_SUBE	INT
						,SECILI		BIT	
				) AS S
				WHERE S.SECILI = 1

				INSERT INTO ViuAramaKullaniciKademe(TCKIMLIKNO,ID_KADEME3)
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME3  
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.GRUP)
				WITH (	 ID_KADEME3	INT
						,SECILI		BIT	
				) AS G
				WHERE G.SECILI = 1








        END 

			IF @ISLEM = 9	--	Kullanıcı Tipine Göre Kullanıcı Listele
			BEGIN
		
				SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
				FROM [dbo].[v3Kullanici]			KL	
				JOIN OkyanusDB.[dbo].[v3SubeYetki]	TK  ON   TK.TCKIMLIKNO=KL.TCKIMLIKNO 
				WHERE	TK.ID_KULLANICITIPI=101
				order by ADSOYAD 

			END

			IF @ISLEM = 10  --  Viu Toplu Mesaj Kaydet
			BEGIN				
				DROP TABLE IF EXISTS #MESAJLIST

				SELECT *, RN = ROW_NUMBER() OVER(ORDER BY TC_GONDEREN)
				INTO #MESAJLIST
				FROM OPENJSON(@SQLJSON)
				WITH (
					TC_GONDEREN	VARCHAR(MAX),
					TC_ALAN		VARCHAR(MAX),
					MESAJ		VARCHAR(MAX),
					LINK_ETIKET	VARCHAR(MAX),
					LINK		VARCHAR(MAX)
				)	ML
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= ML.TC_ALAN
				
				DECLARE @TOPLUMESAJ INT = NULL
				INSERT INTO OkyanusIletisim.dbo.TopluMesaj (KYE_TARIH,KYE_TCKIMLIKNO) VALUES(GETDATE(),@TCKIMLIKNO)
				SET @TOPLUMESAJ =(SELECT SCOPE_IDENTITY())
				WHILE EXISTS ( SELECT TOP 1 1 FROM #MESAJLIST )
				BEGIN
		
					DECLARE @TC_GONDEREN	VARCHAR(MAX),
							@TC_ALAN		VARCHAR(MAX),
							@MESAJ			VARCHAR(MAX),
							@LINK_ETIKET	VARCHAR(MAX),
							@LINK			VARCHAR(MAX),
							@RN				INT
					SELECT TOP 1 
						 @TC_GONDEREN	= ML.TC_GONDEREN
						,@TC_ALAN		= ML.TC_ALAN
						,@MESAJ			= ML.MESAJ	
						,@LINK_ETIKET	= ML.LINK_ETIKET
						,@LINK			= ML.LINK
						,@RN			= ML.RN
					FROM #MESAJLIST		ML
					ORDER BY RN

					IF NOT EXISTS (
						SELECT TOP 1 1
						FROM v3Kullanici K
						WHERE K.TCKIMLIKNO	= @TC_GONDEREN
							AND K.AKTIF		= 1
					)
						SET  @TC_GONDEREN = '14531453000'	-- OKYANUS KOLEJLERİ
	
					
					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TC_GONDEREN
						,@HEADER			= 'Yeni Mesaj'
						,@MESAJ				= @MESAJ
						,@LINK				= @LINK
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @MESAJ
						,@LINK_ETIKET		= @LINK_ETIKET
						,@TOPLUMESAJ		= @TOPLUMESAJ

					DELETE FROM #MESAJLIST WHERE RN = @RN

				END

				DROP TABLE IF EXISTS #MESAJLIST

			END
			

		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END



