


GO
PRINT N'Altering [dbo].[EtutSabit]...';


GO
ALTER TABLE [dbo].[EtutSabit]
    ADD [LINK]  VARCHAR (MAX) NULL,
        [SIFRE] VARCHAR (MAX) NULL;


GO
PRINT N'Altering [dbo].[sp_EtutSabitOlustur]...';


GO
ALTER procedure [dbo].[sp_EtutSabitOlustur]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@ETUTLIST			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0


AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,TC_OGRETMEN				= @TC_OGRETMEN
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,ETUTLIST					= @ETUTLIST	
			,ID_ETUT					= @ID_ETUT	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
 
	IF @ID_LOG > 1
	BEGIN
		
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		END

		IF @ISLEM = 1	--	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										 K.AD+' '+K.SOYAD ADSOYAD
										,D.DERSAD
										,k.TCKIMLIKNO
										,D.ID_DERS
								FROM eokul_v2.dbo.DersOgretmen	DO
								JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS	= DO.ID_DERS
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE DO.ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
		IF @ISLEM = 2
		BEGIN
			delete from EtutSabit
			where ID_SINIF = @ID_SINIF

			INSERT INTO EtutSabit (TC_OGRETMEN,ID_DERS,ID_GUN,DERSSAAT,LINK,SIFRE,ID_SINIF,KYE_TCKIMLIKNO)
			SELECT
				 TC_OGRETMEN= JSON_VALUE(J.VALUE,'$.NESNE.TCKIMLIKNO')		
				,ID_DERS	= JSON_VALUE(J.VALUE,'$.NESNE.ID_DERS')	
				,GUN		= JSON_VALUE(J.VALUE,'$.NESNE.GUN')		
				,DERSSAAT	= JSON_VALUE(J.VALUE,'$.NESNE.DERSSAAT')	
				,LINK		= JSON_VALUE(J.VALUE,'$.NESNE.LINK')
				,SIFRE		= JSON_VALUE(J.VALUE,'$.NESNE.SIFRE')
				,ID_SINIF	= @ID_SINIF 
				,TCKIMLIKNO	= @TCKIMLIKNO
				FROM OPENJSON (@ETUTLIST) AS J
			WHERE JSON_VALUE(J.VALUE,'$.NESNE.ID_DERS')>0

							
				
			 			 
			SELECT 1 
		END
		IF @ISLEM = 3	--	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										  TC_OGRETMEN	
										 ,D.ID_DERS	
										 ,ID_GUN		
										 ,DERSSAAT	
										 ,ID_SINIF	
										 ,KYE_TCKIMLIKNO
										 ,ADSOYAD		= K.AD+' '+K.SOYAD
										 ,D.DERSAD
										,LINK			= ISNULL(ES.LINK,'') 
										,SIFRE		= ISNULL(ES.SIFRE,'')
								FROM EtutSabit			ES
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = ES.TC_OGRETMEN
								JOIN eokul_v2.DBO.Ders	D	ON	D.ID_DERS	 = ES.ID_DERS
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ID_GUN,DERSSAAT
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
		
			
		
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Abide]...';


GO
ALTER procedure [dbo].[sp_Abide]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@AD					VARCHAR(MAX)	= NULL,
	@ID_ABIDESINAV		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@O_TCKIMLIKNO		VARCHAR(11)		= NULL,
	@DERS				VARCHAR(MAX)	= NULL,
	@ID_ABIDERESIM		INT				= NULL,
	@ID_ABIDESAYFATUR	INT				= NULL,
	@SIRA				INT				= NULL,
	@KITAPCIKSAYISI		INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@OVGORSUN			BIT				= NULL,
	@ID_ABIDEKITAPCIK	INT				= NULL		
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
				,DONEM				= @DONEM
				,AD					= @AD
				,ID_ABIDESINAV		= @ID_ABIDESINAV
				,SQLJSON			= @SQLJSON
				,ID_SINIF			= @ID_SINIF
				,ID_SUBE			= @ID_SUBE
				,O_TCKIMLIKNO		= @O_TCKIMLIKNO
				,DERS				= @DERS
				,ID_ABIDERESIM		= @ID_ABIDERESIM
				,ID_ABIDESAYFATUR	= @ID_ABIDESAYFATUR
				,SIRA				= @SIRA
				,KITAPCIKSAYISI		= @KITAPCIKSAYISI
				,ID_KADEME3			= @ID_KADEME3
				,OVGORSUN			= @OVGORSUN
				,ID_ABIDEKITAPCIK	= @ID_ABIDEKITAPCIK
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    

		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		DECLARE @_ID_ABIDESINAV INT			= @ID_ABIDESINAV
		DECLARE @_ID_SINIF		INT			= @ID_SINIF
		DECLARE @_DONEM			VARCHAR(4)	= ISNULL(@DONEM, OkyanusDB.dbo.fn_AktifDonem() )

		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	SINAV TANIMLA
			BEGIN
				DECLARE @INSERTED TABLE(ID INT NOT NULL);  

				INSERT INTO AbideSinav(AD, DONEM, KYE_TCKIMLIKNO, ID_KADEME3)
				OUTPUT inserted.ID_ABIDESINAV
				INTO @INSERTED
				SELECT @AD, @DONEM, @TCKIMLIKNO, @ID_KADEME3

				DECLARE @cnt INT = 0;

				WHILE @cnt < @KITAPCIKSAYISI
				BEGIN
					INSERT INTO AbideKitapcik(ID_ABIDESINAV, AD)
					SELECT ID, CHAR(65 + @cnt) FROM @INSERTED
					SET @cnt = @cnt + 1;
				END;
			END

			IF @ISLEM = 2	--	SINAV LİSTELE
			BEGIN
				SELECT
				(
					SELECT	 S.ID_ABIDESINAV
							,S.AD
							,KADEME3		= K3.AD
							,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
							,ADSOYAD		= K.AD + ' ' + K.SOYAD 
							,KITAPCIKSAYISI	= (SELECT COUNT(*) FROM AbideKitapcik SK WHERE SK.ID_ABIDESINAV = S.ID_ABIDESINAV) 
							,S.OVGORSUN
					FROM AbideSinav S 
					INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.KYE_TCKIMLIKNO
					INNER JOIN v3Kademe3				 K3 ON K3.ID_KADEME3	= S.ID_KADEME3
					WHERE	S.DONEM		 = @DONEM 
						AND S.ID_KADEME3 = @ID_KADEME3
						AND S.AKTIF		 = 1 
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 3	--	SINAV DUZENLE
			BEGIN
				UPDATE AbideSinav SET 
					 AD			= @AD
					,ID_KADEME3 = @ID_KADEME3 
				WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				DECLARE @MEVCUTKITAPCIKSAYISI INT = (SELECT COUNT(*) FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV)

				IF @KITAPCIKSAYISI <> @MEVCUTKITAPCIKSAYISI
				BEGIN
					IF @KITAPCIKSAYISI > @MEVCUTKITAPCIKSAYISI
					BEGIN
						DECLARE @cntx INT = @MEVCUTKITAPCIKSAYISI;

						WHILE @cntx < @KITAPCIKSAYISI
						BEGIN
							INSERT INTO AbideKitapcik(ID_ABIDESINAV, AD)
							SELECT @ID_ABIDESINAV, CHAR(65 + @cntx)

							DECLARE @YENIID_ABIDEKITAPCIK INT = (SELECT ID_ABIDEKITAPCIK FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV AND AD = CHAR(65 + @cntx))

							IF EXISTS (SELECT * FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
							BEGIN
								INSERT INTO AbideSoruKarsilik(ID_ABIDESORU, ID_ABIDEKITAPCIK, SORUNO)
								SELECT S.ID_ABIDESORU, @YENIID_ABIDEKITAPCIK, S.SORUNO
								FROM AbideSoru S
							END
							
							SET @cntx = @cntx + 1;
						END;
					END
					ELSE
					BEGIN
						SELECT TOP(@MEVCUTKITAPCIKSAYISI - @KITAPCIKSAYISI) ID_ABIDEKITAPCIK 
						INTO #TEMPKITAPCIK
						FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV
						ORDER BY ID_ABIDEKITAPCIK DESC

						DELETE SK FROM AbideSoruKarsilik SK
						INNER JOIN #TEMPKITAPCIK K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK

						DELETE K FROM AbideKitapcik K
						INNER JOIN #TEMPKITAPCIK T ON T.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK
					END
				END
			END

			IF @ISLEM = 4	--	SINAV SİL
			BEGIN
				UPDATE AbideSinav SET AKTIF = 0 WHERE ID_ABIDESINAV = @ID_ABIDESINAV
			END

			IF @ISLEM = 5	--	SINAV EXCEL YÜKLE
			BEGIN
				IF EXISTS (	
							SELECT * FROM AbideOgrenci O 
							INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
							WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
						)
				BEGIN
					RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
				END
				ELSE
				BEGIN
					DELETE SK 
					FROM AbideSoruKarsilik	SK
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU	= SK.ID_ABIDESORU 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
				
					DELETE FROM AbideSoru		WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbideYorum		WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbidePuanAralik WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbideBeceri		WHERE ID_ABIDESINAV = @ID_ABIDESINAV

					DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  

					INSERT INTO AbideSoru (ID_ABIDESINAV, DERS, SORUNO, KAZANIM, BECERI, PUAN, ID_BILGI, ID_BILISSELSUREC)
					OUTPUT inserted.ID_ABIDESORU, inserted.SORUNO
					INTO @INSERTEDSORU
					SELECT @ID_ABIDESINAV, DERS, SORUNO, KAZANIM, BECERI, PUAN, ID_BILGI, ID_BILISSELSUREC 
					FROM OPENJSON(@SQLJSON, '$.SORULIST')
					WITH (
						DERS				VARCHAR(MAX),
						SORUNO				INT,
						KAZANIM				VARCHAR(MAX),
						BECERI				VARCHAR(MAX),
						PUAN				INT,
						ID_BILGI			INT,
						ID_BILISSELSUREC	INT
					)

					INSERT INTO AbideSoruKarsilik
					SELECT ID, K.ID_ABIDEKITAPCIK, S.SORUNO FROM @INSERTEDSORU S
					CROSS JOIN AbideKitapcik K WHERE K.ID_ABIDESINAV = @ID_ABIDESINAV
				
					INSERT INTO AbideYorum (ID_ABIDESINAV, DERS, DUZEY, YORUM, ONERI)
					SELECT @ID_ABIDESINAV, DERS, DUZEY, YORUM, ONERI FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
					WITH (
						DERS  VARCHAR(MAX),
						DUZEY VARCHAR(MAX),
						YORUM VARCHAR(MAX),
						ONERI VARCHAR(MAX)
					)
				
					INSERT INTO AbidePuanAralik(ID_ABIDESINAV, MAXIMUMPUAN, DUZEY)
					SELECT @ID_ABIDESINAV, MAXIMUMPUAN, DUZEY FROM OPENJSON(@SQLJSON, '$.PUANARALIKLIST')
					WITH (
						MAXIMUMPUAN INT,
						DUZEY		VARCHAR(MAX)
					)
				
					INSERT INTO AbideBeceri(ID_ABIDESINAV, DERS, BECERI, ACIKLAMA)
					SELECT @ID_ABIDESINAV, DERS, BECERI, ACIKLAMA FROM OPENJSON(@SQLJSON, '$.BECERILIST')
					WITH (
						DERS		VARCHAR(MAX),
						BECERI		VARCHAR(MAX),
						ACIKLAMA	VARCHAR(MAX)
					)
				END
			END

			IF @ISLEM = 6	--	SINAV EXCEL LİSTELE
			BEGIN
				SELECT
				(
					SELECT
					(SELECT [ID_ABIDESORU] ,[ID_ABIDESINAV] ,[DERS] ,[SORUNO] ,[KAZANIM] ,[BECERI] ,[PUAN] ,ID_BILGI = ISNULL([ID_BILGI], 0) ,ID_BILISSELSUREC = ISNULL([ID_BILISSELSUREC], 0) FROM [Pusulam].[dbo].[AbideSoru] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS SORULIST,
					(SELECT * FROM [Pusulam].[dbo].[AbideYorum] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS YORUMLIST,
					(SELECT * FROM [Pusulam].[dbo].[AbidePuanAralik] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS PUANARALIKLIST,
					(SELECT * FROM [Pusulam].[dbo].[AbideBeceri] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS BECERILIST
					FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
				)
			END

			IF @ISLEM = 7	--	ÖĞRENCİ LİSTELE
			BEGIN
			

				SELECT
				(
					SELECT	O.OGRNO 
							,O.TCKIMLIKNO
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT S.DERS, SUM(CASE WHEN AO.PUAN IS NULL THEN 0 ELSE 1 END) AS CEVAPSAYISI 
								FROM AbideSoru S
								LEFT JOIN AbideOgrenci AO ON AO.ID_ABIDESORU = S.ID_ABIDESORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
								WHERE S.ID_ABIDESINAV = @_ID_ABIDESINAV
								GROUP BY S.DERS
								FOR JSON PATH
							 ) AS CEVAP
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					WHERE O.ID_SINIF = @_ID_SINIF AND O.DONEM = @_DONEM
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8	--	ÖĞRENCİ PUAN LİSTELE
			BEGIN
				SELECT
				(
					SELECT S.ID_ABIDESORU, SK.SORUNO, S.KAZANIM, S.BECERI, S.PUAN AS MAXPUAN, AO.PUAN
					FROM AbideSoru S
					INNER JOIN AbideSoruKarsilik SK ON SK.ID_ABIDESORU = S.ID_ABIDESORU
					LEFT JOIN AbideOgrenci AO ON AO.ID_ABIDESORU = S.ID_ABIDESORU AND AO.TCKIMLIKNO = @O_TCKIMLIKNO AND AO.AKTIF = 1
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV AND S.DERS = @DERS AND (@ID_ABIDEKITAPCIK IS NULL OR SK.ID_ABIDEKITAPCIK = @ID_ABIDEKITAPCIK)
					ORDER BY SK.SORUNO
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 9	--	ÖĞRENCİ PUAN KAYDET
			BEGIN
				UPDATE AbideOgrenci SET AKTIF = 0 WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND ID_ABIDESORU IN (SELECT ID_ABIDESORU FROM OPENJSON(@SQLJSON) WITH (ID_ABIDESORU INT))

				INSERT INTO AbideOgrenci (ID_ABIDESORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO, ID_ABIDEKITAPCIK)
				SELECT ID_ABIDESORU, @O_TCKIMLIKNO, PUAN, @TCKIMLIKNO, @ID_ABIDEKITAPCIK FROM OPENJSON(@SQLJSON)
				WITH
				(
					ID_ABIDESORU INT,
					PUAN INT
				)
				WHERE PUAN IS NOT NULL
			END

			IF @ISLEM = 10	--	ÖĞRENCİ DERS PUAN SİL
			BEGIN
				UPDATE AO SET AO.AKTIF = 0 
				FROM AbideOgrenci AO 
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = AO.ID_ABIDESORU
				WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND S.DERS = @DERS AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			END

			IF @ISLEM = 11	--	RAPOR SAYFA TUR LİSTELE
			BEGIN
				
				DROP TABLE IF EXISTS #BOLUMNO11
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO11
				FROM AB

				SELECT * FROM (
					SELECT(
						SELECT
						(
							SELECT ST.ID_ABIDESAYFATUR
								,ST.AD
								,SIRA		= ISNULL(RD.SIRA, '')
								,RESIMGOR	= ISNULL(RD.RESIMGOR,0)
								,RD.AKTIF
								,ST.RESIMMI
								,RESIMLER	= (	SELECT	 R.ID_ABIDERESIM
														,R.SIRA
														,R.AD
														,R.ID_ABIDESAYFATUR 
														,R.DERS
												FROM AbideResim R 
												WHERE	R.ID_ABIDESAYFATUR	= ST.ID_ABIDESAYFATUR 
													AND R.ID_ABIDESINAV		= @ID_ABIDESINAV 
												ORDER BY SIRA 
												FOR JSON PATH, INCLUDE_NULL_VALUES
											)
							FROM AbideSayfaTur			ST
							LEFT JOIN AbideRaporDuzen	RD	ON	RD.ID_ABIDESAYFATUR = ST.ID_ABIDESAYFATUR 
															AND RD.ID_ABIDESINAV	= @ID_ABIDESINAV 
															AND RD.AKTIF			= 1
							ORDER BY ISNULL(CASE WHEN RD.SIRA = 0 THEN 999 ELSE RD.SIRA END, ST.ID_ABIDESAYFATUR)
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS LIST
						,(
							SELECT BOLUMNO, DERS, ID_ABIDESINAV
							FROM #BOLUMNO11
							ORDER BY BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS DERSLIST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)AS LIST
				)AS J
								
				DROP TABLE IF EXISTS #BOLUMNO11

			END

			IF @ISLEM = 12	--	RAPOR SAYFA SIRA KAYDET
			BEGIN
				UPDATE AbideRaporDuzen SET AKTIF = 0 WHERE ID_ABIDESINAV = @ID_ABIDESINAV
				DELETE AbideResim WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

				INSERT INTO AbideRaporDuzen(ID_ABIDESAYFATUR, ID_ABIDESINAV, SIRA, RESIMGOR)
				SELECT ID_ABIDESAYFATUR, @ID_ABIDESINAV, SIRA, RESIMGOR FROM OPENJSON(@SQLJSON)
				WITH
				(
					ID_ABIDESAYFATUR INT,
					RESIMGOR INT,
					SIRA INT
				)

				INSERT INTO AbideResim(ID_ABIDESINAV, ID_ABIDESAYFATUR, AD ,SIRA, DERS)
				SELECT	@ID_ABIDESINAV
						,JSON_Value (S.value, '$.ID_ABIDESAYFATUR') AS ID_ABIDESAYFATUR 
						,JSON_Value (S.value, '$.AD') AS AD 
						,JSON_Value (S.value, '$.SIRA') AS SIRA 
						,JSON_Value (S.value, '$.DERS') AS DERS 
				FROM OPENJSON (@SQLJSON) AS D
				CROSS APPLY OPENJSON (D.value, '$.RESIMLER') AS S
			END

			IF @ISLEM = 13	--	RESİM SİL
			BEGIN
				SELECT
				(
					SELECT AD, ID_ABIDESAYFATUR, ID_ABIDESINAV FROM AbideResim WHERE ID_ABIDERESIM = @ID_ABIDERESIM FOR JSON PATH, WITHOUT_ARRAY_WRAPPER 
				)
				DELETE FROM AbideResim WHERE ID_ABIDERESIM = @ID_ABIDERESIM
			END

			IF @ISLEM = 14	--	RESİM EKLE
			BEGIN
				INSERT INTO AbideResim(ID_ABIDESINAV, ID_ABIDESAYFATUR, AD ,SIRA,DERS)
				SELECT @ID_ABIDESINAV, @ID_ABIDESAYFATUR, @AD, @SIRA, @DERS
			END

			IF @ISLEM = 15	--	ÖĞRENCİ LİSTELE (RAPOR)
			BEGIN
				
				--DECLARE @ID_ABIDESINAV15	INT = @ID_ABIDESINAV
				--DECLARE @ID_SINIF15			INT = @ID_SINIF

				SELECT
				(
					SELECT	O.OGRNO 
							,O.TCKIMLIKNO
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT COUNT(1) 
								FROM AbideSoru S
								WHERE S.ID_ABIDESINAV = @_ID_ABIDESINAV 
								AND S.ID_ABIDESORU NOT IN (SELECT AO.ID_ABIDESORU FROM AbideOgrenci AO WHERE AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1)
							) AS GIRILMEYENCEVAPSAYISI
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					WHERE O.ID_SINIF = @_ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 16	--	RAPOR
			BEGIN

				DROP TABLE IF EXISTS #BOLUMNO
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO
				FROM AB


				DECLARE @SORUSAYISI INT = (SELECT COUNT(1) FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)



				
				SELECT	 K.TCKIMLIKNO
						,O.ID_SINIF
						,AD		= K.AD + ' ' + K.SOYAD
						,SUBE	= SB.AD 
						,SINIF	= S.AD
						,KADEME3= UPPER(K3.AD)
						,ID_KADEME
						,YARIYIL= IIF ( EXISTS (SELECT 1 FROM AbideSinav A WHERE A.ID_ABIDESINAV = @ID_ABIDESINAV AND MONTH(A.KYE_TARIH) IN (9,10,11,12,1)) , '1. DÖNEM' , '2. DÖNEM')
				INTO #OGRENCI
				FROM OkyanusDB.dbo.v3Kullanici			K
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO 
				INNER JOIN OkyanusDB.dbo.v3SinifTum		S	ON	S.ID_SINIF		= O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON	SB.ID_SUBE		= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= S.ID_SATISTURU
				INNER JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
				INNER JOIN OkyanusDB.dbo.v3Donem		D	ON	D.ID_DONEM		= O.ID_DONEM
															AND D.KOD			= O.DONEM
				WHERE	O.DONEM = @DONEM
					AND (@ID_SUBE		IS NULL OR @ID_SUBE			= 0  OR O.ID_SUBE	= @ID_SUBE		)
					AND (@ID_SINIF		IS NULL OR @ID_SINIF		= 0  OR O.ID_SINIF	= @ID_SINIF		)
					AND (@O_TCKIMLIKNO	IS NULL OR @O_TCKIMLIKNO	= '' OR K.TCKIMLIKNO= @O_TCKIMLIKNO	)

				SELECT * FROM #OGRENCI

				SELECT ST.ID_ABIDESAYFATUR
						,ST.AD
						,ST.RESIMMI
						,RD.SIRA
						,RD.RESIMGOR
				INTO #DUZEN
				FROM AbideRaporDuzen RD
				INNER JOIN AbideSayfaTur ST ON ST.ID_ABIDESAYFATUR = RD.ID_ABIDESAYFATUR
				WHERE RD.AKTIF = 1 AND RD.SIRA > 0 AND RD.ID_ABIDESINAV = @ID_ABIDESINAV
				
				SELECT * FROM #DUZEN ORDER BY SIRA

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 1)	--	Kapak Sayfa
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 1 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 2)	--	Önsöz
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 2 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 3)	--	Rapor Neyi İçerir
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 3 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 4)	--	Arka Kapak
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 4 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 5)	--	Beceri Adı ve Açıklama
				BEGIN

				
				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

					DECLARE @RESIMGOR INT = (SELECT TOP 1 ISNULL(RESIMGOR,0) FROM #DUZEN WHERE ID_ABIDESAYFATUR = 5)
									   
					SELECT T.*,B.BOLUMNO, @RESIMGOR AS RESIMGOR
					FROM AbideBeceri	T
					JOIN #BOLUMNO		B	ON	B.DERS	= T.DERS
					WHERE T.ID_ABIDESINAV = @ID_ABIDESINAV
					ORDER BY DERS, ID_ABIDEBECERI
										
					SELECT R.AD, R.DERS, B.BOLUMNO
					FROM AbideResim R 
					JOIN #BOLUMNO	B	ON	B.DERS	= R.DERS
					WHERE	R.ID_ABIDESINAV		= @ID_ABIDESINAV 
						AND R.ID_ABIDESAYFATUR	= 5
				END
				ELSE
				BEGIN
					SELECT 1
					
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 6)	--	Kazanım ve Alt Becerileri
				BEGIN
					SELECT *
					INTO #TEMP6
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 
	
					SELECT T.TCKIMLIKNO
							,CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END AS SORUNO
							,T.DERS
							,B.BOLUMNO
							,T.KAZANIM
							,T.BECERI
							,ISNULL((CASE	WHEN T.PUAN = AO.PUAN THEN ':)'
									WHEN AO.PUAN > 0 AND T.PUAN > AO.PUAN THEN ':|'
									WHEN AO.PUAN = 0 THEN ':(' 
								END), '') AS DURUM
					FROM #TEMP6				T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					LEFT JOIN AbideOgrenci	AO	ON	AO.TCKIMLIKNO = T.TCKIMLIKNO AND AO.ID_ABIDESORU = T.ID_ABIDESORU AND AO.AKTIF = 1
					ORDER BY TCKIMLIKNO, DERS, SORUNO

					DROP TABLE #TEMP6
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 7)	--	Soruların Çözülme Oranı
				BEGIN
					SELECT *
					INTO #TEMP7
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 	

					SELECT	 T.DERS
							,B.BOLUMNO
							,CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END AS SORUNO
							,T.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,AO.PUAN AS PUAN
							,T.PUAN AS MAXPUAN
							,T.ID_ABIDESORU
					INTO #OP
					FROM #TEMP7	T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = T.TCKIMLIKNO AND OO.DONEM = @DONEM
					LEFT JOIN AbideOgrenci AO ON AO.TCKIMLIKNO = T.TCKIMLIKNO AND AO.ID_ABIDESORU = T.ID_ABIDESORU AND AO.AKTIF = 1	

					SELECT   S.DERS
							,B.BOLUMNO
							,SK.SORUNO
							,O.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,O.PUAN
							,S.PUAN AS MAXPUAN
							,S.ID_ABIDESORU
					INTO #OPGENEL
					FROM AbideOgrenci O
					INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
					JOIN #BOLUMNO			B	ON	B.DERS	= S.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = @DONEM
					INNER JOIN AbideSoruKarsilik SK ON SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = O.ID_ABIDESORU
					WHERE O.AKTIF = 1 AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			
					SELECT	OP.TCKIMLIKNO
							,DERS
							,BOLUMNO
							,SORUNO
							,ID_ABIDESORU
							,OP.ID_SINIF
							,CASE WHEN PUAN IS NULL THEN '-' ELSE CAST(CONVERT(decimal(5,0), CAST(PUAN AS FLOAT) / CAST(MAXPUAN AS FLOAT) * 100.0) AS varchar) END AS OGRENCI 
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.ID_SINIF = OP.ID_SINIF AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS SINIF
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.ID_SUBE = OP.ID_SUBE AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS OKUL
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS GENEL
					FROM #OP AS OP
					INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = OP.TCKIMLIKNO
					ORDER BY OP.TCKIMLIKNO, DERS, SORUNO

					DROP TABLE #OP
					DROP TABLE #OPGENEL
					DROP TABLE #TEMP7
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 8)	--	Öğrenci Performansı
				BEGIN
					SELECT *
					INTO #TEMP8
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

					SELECT	T.TCKIMLIKNO
							,T.DERS
							,B.BOLUMNO
							,T.ID_ABIDESINAV
							,SUM(O.PUAN) AS PUAN
							,DUZEY	=	CASE	WHEN SUM(O.PUAN) IS NULL				THEN NULL 
												WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), '1') AS VARCHAR)												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					INTO #DERSPUAN
					FROM #TEMP8 T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					LEFT JOIN AbideOgrenci O ON O.TCKIMLIKNO = T.TCKIMLIKNO AND O.ID_ABIDESORU = T.ID_ABIDESORU AND O.AKTIF = 1
					GROUP BY T.TCKIMLIKNO, T.DERS, T.ID_ABIDESINAV,B.BOLUMNO, B.DERS

					SELECT	 DP.TCKIMLIKNO
							,DP.DERS
							,DP.BOLUMNO
							,ISNULL(DP.DUZEY + '. Düzey', '-') AS DUZEY
							,ISNULL(Y.YORUM, '-') AS YORUM
							,ISNULL(Y.ONERI, '-') AS ONERI
					FROM #DERSPUAN DP
					LEFT JOIN AbideYorum Y ON Y.DERS = DP.DERS AND Y.DUZEY = DP.DUZEY AND Y.ID_ABIDESINAV = DP.ID_ABIDESINAV
					ORDER BY DP.TCKIMLIKNO, DP.DERS					
					
					
					SELECT B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI, SUM(T.PUAN) MAXPUAN, SUM(O.PUAN) OGRPUAN, CAST( SUM(O.PUAN) / CAST(SUM(T.PUAN) AS float) * 100.0  AS decimal(8,2)) ORT
					FROM #TEMP8			T
					JOIN #BOLUMNO		B	ON	B.DERS			= T.DERS
					JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
											AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
											AND O.AKTIF			= 1
					GROUP BY B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI

					DROP TABLE #DERSPUAN
					DROP TABLE #TEMP8
				END
				ELSE
				BEGIN
					SELECT *
					FROM #BOLUMNO
					
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 9)	--	Grafiksel Gösterim (Her bir ders ayrı)
				BEGIN


--*********************************************************************************
					SELECT	O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)
							--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
							
							,DUZEY	=	CASE	WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') AS VARCHAR) 												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					FROM AbideOgrenci O
					INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO			B	ON	B.DERS	= S.DERS
					INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
					WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 10)	--	Grafiksel Gösterim (Tek grafikte tüm dersler)
				BEGIN
					SELECT	O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)
							
							,DUZEY	=	CASE WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1')
											 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') 
										END 
							--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
							,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
					FROM AbideOgrenci		O
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU	 = O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO		B	ON	B.DERS			 = S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV = S.ID_ABIDESINAV
					WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END
				ELSE
				BEGIN
					SELECT 1
				END

				SELECT   S.DERS
						,S.SORUNO
						,B.BOLUMNO
				FROM AbideSoru	S				
				JOIN #BOLUMNO	B	ON	B.DERS	= S.DERS
				WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

				DROP TABLE #DUZEN
				DROP TABLE #OGRENCI
				DROP TABLE #BOLUMNO

			END
						
			IF @ISLEM = 17	--	SINAV LİSTELE by OGRENCI
			BEGIN
				SELECT
				(
					SELECT DISTINCT S.ID_ABIDESINAV, S.AD, CONVERT(varchar, S.KYE_TARIH, 104) AS TARIH, K.AD + ' ' + K.SOYAD AS ADSOYAD,S.KYE_TARIH
					FROM AbideSinav		S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					JOIN AbideSoru		SO	ON	SO.ID_ABIDESINAV= S.ID_ABIDESINAV
					JOIN AbideOgrenci	O	ON	O.ID_ABIDESORU	= SO.ID_ABIDESORU
					WHERE	S.DONEM			= @DONEM 
						AND O.TCKIMLIKNO	= @O_TCKIMLIKNO
						AND S.AKTIF			= 1 
						AND S.OVGORSUN		= 1
					ORDER BY S.KYE_TARIH DESC
					FOR JSON PATH
				)
			END

			IF @ISLEM = 18	--	PUAN LİSTESİ GETİR (EXCEL)
			BEGIN
				SELECT DERS, MAX(SORUNO) AS SORUNO 
				FROM AbideSinav S
				INNER JOIN AbideSoru SS ON SS.ID_ABIDESINAV = S.ID_ABIDESINAV 
				WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
				GROUP BY DERS ORDER BY DERS

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DERS

				SELECT 
						SB.AD AS SUBE
						,K3.AD AS GRUP
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,SN.AD AS SINIF
						,SN.ID_SINIF
						,AO.TCKIMLIKNO
						,SORU.DERS
						,SORU.SORUNO
						,AO.PUAN
				INTO #TEMP
				FROM AbideOgrenci AO
				INNER JOIN AbideSoru SORU ON SORU.ID_ABIDESORU = AO.ID_ABIDESORU
				INNER JOIN AbideSinav SINAV ON SINAV.ID_ABIDESINAV = SORU.ID_ABIDESINAV
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = AO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = AO.TCKIMLIKNO AND O.DONEM = SINAV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = SN.ID_SATISTURU
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = ST.ID_KADEME3
				WHERE	SINAV.ID_ABIDESINAV = @ID_ABIDESINAV 
					AND SINAV.DONEM = @DONEM
					AND SINAV.AKTIF = 1 
					AND AO.AKTIF = 1
					AND (@ID_SUBE	IS NULL OR @ID_SUBE		= 0 OR O.ID_SUBE	= @ID_SUBE)
					AND (@ID_SINIF	IS NULL OR @ID_SINIF	= 0 OR O.ID_SINIF	= @ID_SINIF)

				DECLARE 
						@COLS AS NVARCHAR(MAX),
						@QUERY  AS NVARCHAR(MAX)

				SELECT DERS+'-'+CAST(SORUNO AS VARCHAR) AS DERS
				INTO #DERS
				FROM #TEMP
				GROUP BY DERS, SORUNO
				ORDER BY DERS, SORUNO

				SELECT @COLS = STUFF((SELECT ','+QUOTENAME(DERS2)+' VARCHAR(MAX) DEFAULT ''-''' 
									  FROM (
												SELECT
													T.DERS + '-' + CAST(T.SORUNO AS VARCHAR) AS DERS2
												FROM #TEMP T 
												GROUP BY T.DERS, T.SORUNO
											) AS S
										FOR XML PATH(''), TYPE
										).value('.', 'NVARCHAR(MAX)') 
									,1,1,'')

				SET @QUERY = '
					DROP TABLE IF EXISTS #T
					CREATE TABLE #T (SUBE VARCHAR(MAX), GRUP VARCHAR(MAX), ADSOYAD VARCHAR(MAX), SINIF VARCHAR(MAX), TCKIMLIKNO VARCHAR(MAX),' + @COLS + ')

					INSERT INTO #T (SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO)
					SELECT SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO FROM #TEMP

					WHILE EXISTS ( SELECT *  FROM #DERS)
					BEGIN

						DECLARE @DERSAD VARCHAR(100) = (SELECT TOP(1) DERS FROM #DERS ORDER BY DERS)	
						DECLARE @QUERY2 NVARCHAR(MAX)

						SET @QUERY2=	
						''
							UPDATE T
							SET T.[''+@DERSAD+''] = P.PUAN
							FROM #T T
							JOIN #TEMP P ON T.TCKIMLIKNO = P.TCKIMLIKNO AND P.DERS + ''''-'''' +  CAST(P.SORUNO AS VARCHAR) = ''''''+@DERSAD+''''''
						''
						EXEC sp_executesql @QUERY2; 

						DELETE FROM #DERS WHERE DERS = @DERSAD
					END
					SELECT DISTINCT * FROM #T
					DROP TABLE IF EXISTS #T
				'
				PRINT @QUERY
				EXEC sp_executesql @QUERY; 

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DERS
			END

			IF @ISLEM = 19	--	SINAV KARŞILIK YÜKLE
			BEGIN
				SELECT   ID_ABIDESINAV = JSON_Value (D.value, '$.ID_ABIDESINAV')
						,ID_ABIDESORU = JSON_Value (D.value, '$.ID_ABIDESORU')
						,ID_ABIDEKITAPCIK = JSON_Value (s.value, '$.ID_ABIDEKITAPCIK')
						,KITAPCIK = JSON_Value (s.value, '$.KITAPCIK')
						,SORUNO = JSON_Value (s.value, '$.SORUNO')
				INTO #TEMPKARSILIK
				FROM OPENJSON(@SQLJSON) d
				CROSS APPLY OPENJSON (d.value, '$.KARSILIKLIST') as s

				DELETE SK FROM AbideSoruKarsilik SK
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = SK.ID_ABIDESORU
				INNER JOIN AbideKitapcik K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK
				WHERE S.ID_ABIDESINAV = (SELECT TOP 1 ID_ABIDESINAV FROM #TEMPKARSILIK) AND K.AD <> 'A'

				--DELETE FROM AbideKitapcik WHERE ID_ABIDESINAV = (SELECT TOP 1 ID_ABIDESINAV FROM #TEMPKARSILIK) AND AD <> 'A'

				--DECLARE @INSERTEDKITAPCIK TABLE(ID_ABIDEKITAPCIK INT NOT NULL, KITAPCIK CHAR(1) NOT NULL);  

				--INSERT INTO AbideKitapcik (ID_ABIDESINAV, AD)
				--OUTPUT inserted.ID_ABIDEKITAPCIK, inserted.ad
				--INTO @INSERTEDKITAPCIK
				--SELECT DISTINCT ID_ABIDESINAV, KITAPCIK
				--FROM #TEMPKARSILIK

				INSERT INTO AbideSoruKarsilik(ID_ABIDESORU, ID_ABIDEKITAPCIK, SORUNO)
				SELECT T.ID_ABIDESORU, T.ID_ABIDEKITAPCIK, T.SORUNO
				FROM #TEMPKARSILIK T

				DROP TABLE #TEMPKARSILIK
			END

			IF @ISLEM = 20	--	SINAV KARŞILIK LİSTELE
			BEGIN
				SELECT
				(	
					SELECT  S.ID_ABIDESINAV, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.KAZANIM, S.BECERI, S.PUAN, 
							(
								SELECT K.ID_ABIDEKITAPCIK, SK.SORUNO, K.AD AS KITAPCIK FROM AbideSoruKarsilik SK
								INNER JOIN AbideKitapcik K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK AND K.ID_ABIDESINAV = S.ID_ABIDESINAV
								WHERE SK.ID_ABIDESORU = S.ID_ABIDESORU AND K.AD <> 'A'
								FOR JSON PATH
							) AS KARSILIKLIST
					FROM AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH
				)
			END

			IF @ISLEM = 21	--	SINAV KİTAPÇIK LİSTELE
			BEGIN
				SELECT	DISTINCT K.ID_ABIDEKITAPCIK
						,K.AD
						,CASE WHEN EXISTS(	
							SELECT 1 
							FROM AbideOgrenci O 
							INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
							WHERE O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND S.DERS = @DERS AND O.TCKIMLIKNO = @O_TCKIMLIKNO AND O.AKTIF = 1
						)
						THEN 1
						ELSE 0 
						END AS SECILI
				INTO #TEMPKITAPCIKSEC
				FROM AbideKitapcik K
				WHERE K.ID_ABIDESINAV = @ID_ABIDESINAV

				--IF NOT EXISTS (SELECT * FROM #TEMPKITAPCIKSEC WHERE SECILI = 1)
				--BEGIN
				--	UPDATE #TEMPKITAPCIKSEC SET SECILI = 1 WHERE AD = 'A'
				--END

				SELECT
				(
					SELECT * FROM #TEMPKITAPCIKSEC
					ORDER BY AD
					FOR JSON PATH
				)

				DROP TABLE #TEMPKITAPCIKSEC
			END

			IF @ISLEM = 22	--	PUANA GÖRE SIRALI GENEL SONUÇ LİSTELERİ
			BEGIN
				SELECT SNV.ID_ABIDESINAV, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, K.AD AS KITAPCIK, SK.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN AbideSoruKarsilik			SK	ON SK.ID_ABIDESORU = S.ID_ABIDESORU AND SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SNV.ID_ABIDESINAV = @ID_ABIDESINAV AND (@ID_KADEME3 = 0 OR SGS.ID_KADEME3 = @ID_KADEME3)

				SELECT * 
				FROM #OGRENCISORULIST
				ORDER BY KAMPUS, SINIF, TCKIMLIKNO, DERS, SORUNO

				SELECT 
					 TCKIMLIKNO
					,DERS
					,SUM(PUAN) AS TOPLAMPUAN
					,SUM(MAXPUAN) AS TOPLAMMAXPUAN
					,MAX(SORUNO) AS SORUSAYISI
					--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), 1) AS DUZEY					
					,DUZEY	=	CASE WHEN O.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') 
										THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), '1')  
									 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV),'1') 
								END 
				INTO #OGRENCILIST
				FROM #OGRENCISORULIST O
				GROUP BY TCKIMLIKNO, DERS, ID_ABIDESINAV


				SELECT   TCKIMLIKNO
						,DERS
						,TOPLAMPUAN
						,DUZEY 
						,SORUSAYISI
						,TOPLAMMAXPUAN
				FROM #OGRENCILIST ORDER BY DERS, TCKIMLIKNO DESC

				SELECT DERS, SORUSAYISI, TOPLAMMAXPUAN FROM #OGRENCILIST GROUP BY DERS, SORUSAYISI, TOPLAMMAXPUAN ORDER BY DERS

				DROP TABLE #OGRENCISORULIST
				DROP TABLE #OGRENCILIST
			END

			IF @ISLEM = 23	--	SINIFLARA GÖRE SORULARIN ÇÖZÜLME ORANLARI
			BEGIN
				SELECT SNV.ID_ABIDESINAV, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST2
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SNV.ID_ABIDESINAV = @ID_ABIDESINAV AND (@ID_KADEME3 = 0 OR SGS.ID_KADEME3 = @ID_KADEME3)

				SELECT OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, OS.KAMPUS, OS.SINIF, CONVERT(decimal(18,2), (CAST(SUM(OS.PUAN) AS FLOAT) / CAST(SUM(OS.MAXPUAN) AS FLOAT) * 100.0)) AS ORAN
				FROM #OGRENCISORULIST2 OS
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = OS.ID_ABIDESORU
				GROUP BY OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, OS.KAMPUS, OS.SINIF
				
				SELECT OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, 'GENEL', 'GENEL', CONVERT(decimal(18,2), (CAST(SUM(OS.PUAN) AS FLOAT) / CAST(SUM(OS.MAXPUAN) AS FLOAT) * 100.0)) AS ORAN
				FROM #OGRENCISORULIST2 OS
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = OS.ID_ABIDESORU
				GROUP BY OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM
				ORDER BY DERS, SORUNO
				
				SELECT KAMPUS, SINIF FROM #OGRENCISORULIST2 GROUP BY KAMPUS, SINIF ORDER BY KAMPUS, SINIF
				SELECT DERS, MAX(SORUNO) AS SORUSAYISI FROM #OGRENCISORULIST2 GROUP BY DERS ORDER BY DERS

				DROP TABLE #OGRENCISORULIST2
			END

			IF @ISLEM = 24	--	Yeterlilik Düzeylerine Göre Kampüs Öğrenci Sayıları
			BEGIN
			
				DECLARE @ID_KADEME3_ INT = @ID_KADEME3
				DECLARE @ID_ABIDESINAV_ INT = @ID_ABIDESINAV
				DECLARE @DONEM_ VARCHAR(4) = @DONEM

				SELECT SNV.ID_ABIDESINAV, SNV.AD AS SINAVAD, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST3
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SGS.ID_KADEME3 = @ID_KADEME3 AND (@ID_ABIDESINAV = 0 OR SNV.ID_ABIDESINAV = @ID_ABIDESINAV) AND SNV.DONEM = @DONEM

				SELECT 
					 SINAVAD
					,DERS
					,KAMPUS
					,TCKIMLIKNO					
					,DUZEY	=	CASE WHEN O.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') 
										THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), '1')  
								  	 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV),'1') 
								END 
				INTO #OGRENCILIST3
				FROM #OGRENCISORULIST3 O
				GROUP BY KAMPUS, TCKIMLIKNO, DERS, ID_ABIDESINAV, SINAVAD
				ORDER BY SINAVAD, DERS, KAMPUS, TCKIMLIKNO

				--DÜZEY ÖĞRENCİ SAYILARI KAMPÜS--
				SELECT DERS, SINAVAD, KAMPUS, DUZEY, COUNT(1) AS DUZEYOGRENCISAYISI
				INTO #KAMPUSDUZEYOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, SINAVAD, KAMPUS, DUZEY
				ORDER BY DERS, SINAVAD, KAMPUS, DUZEY

				--TOPLAM ÖĞRENCİ SAYILARI KAMPÜS--
				SELECT DERS, KAMPUS, COUNT(1) AS TOPLAMOGRENCISAYISI
				INTO #KAMPUSTOPLAMOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, KAMPUS
				ORDER BY DERS, KAMPUS

				--DÜZEY ÖĞRENCİ SAYILARI--
				SELECT DERS, SINAVAD, DUZEY, COUNT(1) AS DUZEYOGRENCISAYISI
				INTO #DUZEYOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, SINAVAD, DUZEY
				ORDER BY DERS, SINAVAD, DUZEY

				--TOPLAM ÖĞRENCİ SAYILARI--
				SELECT DERS, COUNT(1) AS TOPLAMOGRENCISAYISI
				INTO #TOPLAMOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS
				ORDER BY DERS

				--SONUÇ--
				SELECT 1 AS TUR, TOS.DERS, TOS.KAMPUS, TOS.TOPLAMOGRENCISAYISI, DOS.DUZEY, DOS.SINAVAD, DOS.DUZEYOGRENCISAYISI, CONVERT(DECIMAL(18,2), (CAST(DOS.DUZEYOGRENCISAYISI AS FLOAT) / CAST(TOS.TOPLAMOGRENCISAYISI AS FLOAT) * 100.0)) AS ORAN
				FROM #KAMPUSDUZEYOGRENCISAYILIST DOS
				INNER JOIN #KAMPUSTOPLAMOGRENCISAYILIST TOS ON TOS.KAMPUS = DOS.KAMPUS AND TOS.DERS = DOS.DERS
				UNION
				SELECT 2 AS TUR, TOS.DERS, 'TOPLAM', TOS.TOPLAMOGRENCISAYISI, DOS.DUZEY, DOS.SINAVAD, DOS.DUZEYOGRENCISAYISI, CONVERT(DECIMAL(18,2), (CAST(DOS.DUZEYOGRENCISAYISI AS FLOAT) / CAST(TOS.TOPLAMOGRENCISAYISI AS FLOAT) * 100.0)) AS ORAN
				FROM #DUZEYOGRENCISAYILIST DOS
				INNER JOIN #TOPLAMOGRENCISAYILIST TOS ON TOS.DERS = DOS.DERS
				ORDER BY DERS, TUR, KAMPUS, SINAVAD, DUZEY

				SELECT DUZEY FROM #DUZEYOGRENCISAYILIST GROUP BY DUZEY ORDER BY DUZEY
				SELECT KAMPUS FROM #KAMPUSDUZEYOGRENCISAYILIST GROUP BY KAMPUS ORDER BY KAMPUS
				SELECT SINAVAD FROM #DUZEYOGRENCISAYILIST GROUP BY SINAVAD ORDER BY SINAVAD
				SELECT DERS FROM #DUZEYOGRENCISAYILIST GROUP BY DERS ORDER BY DERS

				DROP TABLE #OGRENCISORULIST3
				DROP TABLE #OGRENCILIST3
				DROP TABLE #KAMPUSDUZEYOGRENCISAYILIST
				DROP TABLE #KAMPUSTOPLAMOGRENCISAYILIST
				DROP TABLE #DUZEYOGRENCISAYILIST
				DROP TABLE #TOPLAMOGRENCISAYILIST
			END
						
			IF @ISLEM = 25	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE AbideSinav SET OVGORSUN = @OVGORSUN WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				select 1
			END

			IF @ISLEM = 26	--	RAPOR ÖĞRENCİ HTML(JSON)
			BEGIN
				DROP TABLE IF EXISTS #BOLUMNO26
				DROP TABLE IF EXISTS #DUZEN26
				DROP TABLE IF EXISTS #OGRENCI26
				DROP TABLE IF EXISTS #TEMP5_1_26
				DROP TABLE IF EXISTS #TEMP5_2_26
				DROP TABLE IF EXISTS #TEMP6_26
				DROP TABLE IF EXISTS #TEMP7_26
				DROP TABLE IF EXISTS #TEMP8_1_26
				DROP TABLE IF EXISTS #TEMP8_2_26
				DROP TABLE IF EXISTS #TEMP9_26
				DROP TABLE IF EXISTS #TEMP10_26
				--DROP TABLE IF EXISTS #TEMP_SON_26
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO26
				FROM AB
				ORDER BY BOLUMNO

				--DECLARE @SORUSAYISI INT = (SELECT COUNT(1) FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
				
				SELECT DISTINCT
					 TCKIMLIKNO	= OD.TCKIMLIKNO
					,ID_SINIF	= OD.ID_SINIF
					,AD			= OD.AD + ' ' + OD.SOYAD
					,SUBE		= OD.SUBEAD
					,SINIF		= OD.SINIFAD
					,KADEME3	= UPPER(OD.KADEME3)
					,ID_KADEME	= KB.ID_KADEME
					,YARIYIL	= IIF ( EXISTS (SELECT TOP 1 1 FROM AbideSinav A WHERE A.ID_ABIDESINAV = @ID_ABIDESINAV AND MONTH(A.KYE_TARIH) IN (9,10,11,12,1)) , '1. DÖNEM' , '2. DÖNEM')
				INTO #OGRENCI26
				FROM OkyanusDB..vw_OgrenciDetayTum	OD
				JOIN OkyanusDB..v3KademeBilgi		KB	ON	KB.ID_KADEME3	= OD.ID_KADEME3
				WHERE	OD.DONEM = @_DONEM
					AND (@ID_SUBE		IS NULL OR @ID_SUBE			= 0  OR OD.ID_SUBE		= @ID_SUBE		)
					AND (@ID_SINIF		IS NULL OR @ID_SINIF		= 0  OR OD.ID_SINIF		= @ID_SINIF		)
					AND (@O_TCKIMLIKNO	IS NULL OR @O_TCKIMLIKNO	= '' OR OD.TCKIMLIKNO	= @O_TCKIMLIKNO	)
	
				SELECT	 ST.ID_ABIDESAYFATUR
						,ST.AD
						,ST.RESIMMI
						,RD.SIRA
						,RD.RESIMGOR
				INTO #DUZEN26
				FROM AbideRaporDuzen	RD
				JOIN AbideSayfaTur		ST	ON	ST.ID_ABIDESAYFATUR	= RD.ID_ABIDESAYFATUR
				WHERE	RD.AKTIF		= 1 
					AND RD.SIRA			> 0 
					AND RD.ID_ABIDESINAV= @ID_ABIDESINAV
					AND ST.ID_ABIDESAYFATUR NOT IN (1,2,3,4)

				
				-- CREATE TEMP TABLE
				BEGIN
				CREATE TABLE #TEMP5_1_26 
				(	
					 ID_ABIDEBECERI	INT
					,ID_ABIDESINAV	INT
					,DERS			VARCHAR(MAX)
					,BECERI			VARCHAR(MAX)
					,ACIKLAMA		VARCHAR(MAX)
					,BOLUMNO		INT
					,RESIMGOR		INT
				)

				CREATE TABLE #TEMP5_2_26 (
					AD	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT
				)
				END
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 5)	--	Beceri Adı ve Açıklama							
				BEGIN

				
				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

					DECLARE @RESIMGOR_26 INT = (SELECT TOP 1 ISNULL(RESIMGOR,0) FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 5)
									   
					INSERT INTO #TEMP5_1_26
					SELECT	 T.ID_ABIDEBECERI
							,T.ID_ABIDESINAV
							,T.DERS
							,T.BECERI
							,T.ACIKLAMA
							,B.BOLUMNO
							,RESIMGOR	= @RESIMGOR_26
					FROM AbideBeceri	T
					JOIN #BOLUMNO26		B	ON	B.DERS	= T.DERS
					WHERE T.ID_ABIDESINAV = @ID_ABIDESINAV
					ORDER BY DERS, ID_ABIDEBECERI
										
					INSERT INTO #TEMP5_2_26
					SELECT R.AD, R.DERS, B.BOLUMNO
					FROM AbideResim R 
					JOIN #BOLUMNO26	B	ON	B.DERS	= R.DERS
					WHERE	R.ID_ABIDESINAV		= @ID_ABIDESINAV 
						AND R.ID_ABIDESAYFATUR	= 5
				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP6_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SORUNO		INT,
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					KAZANIM		VARCHAR(MAX),
					BECERI		VARCHAR(MAX),
					DURUM		VARCHAR(2),
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 6)	--	Kazanım ve Alt Becerileri						
				BEGIN

	
					;WITH TEMP6 AS(
						SELECT O.TCKIMLIKNO, S.SORUNO, S.DERS, S.KAZANIM, S.BECERI, S.PUAN, S.ID_ABIDESORU		
						FROM #OGRENCI26		 O
						CROSS JOIN AbideSoru S 
						WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 
					)
					INSERT INTO #TEMP6_26
					SELECT   T.TCKIMLIKNO
							,SORUNO	= CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END 
							,T.DERS
							,B.BOLUMNO
							,T.KAZANIM
							,T.BECERI
							,DURUM	= ISNULL((CASE	WHEN T.PUAN = AO.PUAN THEN ':)'
													WHEN AO.PUAN > 0 AND T.PUAN > AO.PUAN THEN ':|'
													WHEN AO.PUAN = 0 THEN ':(' 
												END), '')
					FROM TEMP6				T
					JOIN #BOLUMNO26			B	ON	B.DERS			= T.DERS
					LEFT JOIN AbideOgrenci	AO	ON	AO.TCKIMLIKNO	= T.TCKIMLIKNO 
												AND AO.ID_ABIDESORU = T.ID_ABIDESORU 
												AND AO.AKTIF		= 1
					ORDER BY TCKIMLIKNO, DERS, SORUNO

				END


				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP7_26 (
					TCKIMLIKNO		VARCHAR(MAX),
					DERS			VARCHAR(MAX),
					BOLUMNO			INT,
					SORUNO			INT,
					ID_ABIDESORU	INT,
					ID_SINIF		INT,
					OGRENCI			VARCHAR(MAX),
					SINIF			decimal(5,0),
					OKUL			decimal(5,0),
					GENEL			decimal(5,0)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 7)	--	Soruların Çözülme Oranı							
				BEGIN
	
					WITH TEMP7 AS (
						SELECT O.TCKIMLIKNO, S.DERS, S.SORUNO, S.PUAN, S.ID_ABIDESORU	
						FROM #OGRENCI26 O
						CROSS JOIN AbideSoru S 
						WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 	
					)
					SELECT	 T.DERS
							,B.BOLUMNO
							,SORUNO	= CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END
							,T.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,AO.PUAN
							,MAXPUAN	= T.PUAN 
							,T.ID_ABIDESORU
					INTO #OP26
					FROM TEMP7	T
					JOIN #BOLUMNO26							B	ON	B.DERS			= T.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON	OO.TCKIMLIKNO	= T.TCKIMLIKNO 
																AND OO.DONEM		= @_DONEM
					LEFT JOIN AbideOgrenci					AO	ON	AO.TCKIMLIKNO	= T.TCKIMLIKNO 
																AND AO.ID_ABIDESORU = T.ID_ABIDESORU 
																AND AO.AKTIF		= 1	

					SELECT   S.DERS
							,B.BOLUMNO
							,SK.SORUNO
							,O.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,O.PUAN
							,MAXPUAN	= S.PUAN 
							,S.ID_ABIDESORU
					INTO #OPGENEL26
					FROM AbideOgrenci						O
					INNER JOIN AbideSoru					S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					JOIN #BOLUMNO26							B	ON	B.DERS				= S.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON	OO.TCKIMLIKNO		= O.TCKIMLIKNO 
																AND OO.DONEM			= @_DONEM
					INNER JOIN AbideSoruKarsilik			SK	ON	SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK 
																AND SK.ID_ABIDESORU		= O.ID_ABIDESORU
					WHERE	O.AKTIF			= 1 
						AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			
					INSERT INTO #TEMP7_26
					SELECT	OP.TCKIMLIKNO
							,DERS
							,BOLUMNO
							,SORUNO
							,ID_ABIDESORU
							,OP.ID_SINIF
							,OGRENCI= CASE WHEN PUAN IS NULL THEN '-' ELSE CAST(CONVERT(decimal(5,0), CAST(PUAN AS FLOAT) / CAST(MAXPUAN AS FLOAT) * 100.0) AS varchar) END 
							,SINIF	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.ID_SINIF = OP.ID_SINIF AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
							,OKUL	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.ID_SUBE = OP.ID_SUBE AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
							,GENEL	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
					FROM #OP26			OP
					INNER JOIN #OGRENCI26 O	ON	O.TCKIMLIKNO	= OP.TCKIMLIKNO
					ORDER BY OP.TCKIMLIKNO, DERS, SORUNO

					DROP TABLE IF EXISTS #OP26
					DROP TABLE IF EXISTS #OPGENEL26
				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP8_1_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX),
					YORUM		VARCHAR(MAX),
					ONERI		VARCHAR(MAX)
				)
				CREATE TABLE #TEMP8_2_26 (
					BOLUMNO		INT,
					TCKIMLIKNO	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BECERI		VARCHAR(MAX),
					MAXPUAN		INT,
					OGRPUAN		INT,
					ORT			decimal(8,2)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 8)	--	Öğrenci Performansı								
				BEGIN
					SELECT O.TCKIMLIKNO, S.DERS, S.ID_ABIDESINAV, S.ID_ABIDESORU, S.BECERI, S.PUAN
					INTO #TEMP8_26
					FROM #OGRENCI26 O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

					SELECT	T.TCKIMLIKNO
							,T.DERS
							,B.BOLUMNO
							,T.ID_ABIDESINAV
							,SUM(O.PUAN) AS PUAN
							,DUZEY	=	CASE	WHEN SUM(O.PUAN) IS NULL				THEN NULL 
												WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), '1') AS VARCHAR)												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					INTO #DERSPUAN26
					FROM #TEMP8_26			T
					JOIN #BOLUMNO26			B	ON	B.DERS			= T.DERS
					LEFT JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
												AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
												AND O.AKTIF			= 1
					GROUP BY T.TCKIMLIKNO, T.DERS, T.ID_ABIDESINAV,B.BOLUMNO, B.DERS

					INSERT INTO #TEMP8_1_26
					SELECT	 DP.TCKIMLIKNO
							,DP.DERS
							,DP.BOLUMNO
							,DUZEY	= ISNULL(DP.DUZEY + '. Düzey', '-')
							,YORUM	= REPLACE( ISNULL(Y.YORUM, '-'),N'*','<br>*') 
							,ONERI	= REPLACE( ISNULL(Y.ONERI, '-'),N'*','<br>*')
					FROM #DERSPUAN26 DP
					LEFT JOIN AbideYorum Y ON Y.DERS = DP.DERS AND Y.DUZEY = DP.DUZEY AND Y.ID_ABIDESINAV = DP.ID_ABIDESINAV
					ORDER BY DP.TCKIMLIKNO, DP.DERS					
					
					
					INSERT INTO #TEMP8_2_26
					SELECT	 B.BOLUMNO
							,T.TCKIMLIKNO
							, T.DERS
							, T.BECERI
							, SUM(T.PUAN) MAXPUAN
							, SUM(O.PUAN) OGRPUAN
							, CAST( SUM(O.PUAN) / CAST(SUM(T.PUAN) AS float) * 100.0  AS decimal(8,2)) ORT
					FROM #TEMP8_26		T
					JOIN #BOLUMNO26		B	ON	B.DERS			= T.DERS
					JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
											AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
											AND O.AKTIF			= 1
					GROUP BY B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI

					DROP TABLE IF EXISTS #DERSPUAN26
					DROP TABLE IF EXISTS #TEMP8_26
				END		

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP9_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SINAV		VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 9)	--	Grafiksel Gösterim (Her bir ders ayrı)			
				BEGIN

					INSERT INTO #TEMP9_26
					SELECT	 O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)							
							,DUZEY	=	CASE	WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN 
													CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') AS VARCHAR) 												
												ELSE 
													CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 	
					FROM AbideOgrenci		O
					INNER JOIN #OGRENCI26		SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO26		B	ON	B.DERS				= S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV	= S.ID_ABIDESINAV
					WHERE	O.AKTIF = 1 
						AND SN.AKTIF = 1
						--AND EXISTS (SELECT TOP 1 1 FROM #OGRENCI26 SO WHERE SO.TCKIMLIKNO = O.TCKIMLIKNO) 
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC

				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP10_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SINAV		VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX),
					MAXDUZEY	VARCHAR(MAX)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 10)--	Grafiksel Gösterim (Tek grafikte tüm dersler)	
				BEGIN
					INSERT INTO #TEMP10_26
					SELECT	 O.TCKIMLIKNO
							,SINAV		= SN.AD
							,S.DERS
							,BOLUMNO	= ISNULL(B.BOLUMNO, 999)
							
							,DUZEY		=	CASE WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN 
													 ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1')
												ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') 
											END 
							,MAXDUZEY	= (SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV)
					FROM AbideOgrenci		O
					INNER JOIN #OGRENCI26		SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO26		B	ON	B.DERS				= S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV	= S.ID_ABIDESINAV
					WHERE	O.AKTIF		= 1 
						AND SN.AKTIF	= 1
						--O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI26) AND 
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END

				--SELECT   S.DERS
				--		,S.SORUNO
				--		,B.BOLUMNO
				--INTO #TEMP_SON_26
				--FROM AbideSoru	S				
				--JOIN #BOLUMNO26	B	ON	B.DERS	= S.DERS
				--WHERE S.ID_ABIDESINAV	= @ID_ABIDESINAV

				SELECT (
					SELECT (	SELECT *, SINAVAD = (SELECT AD FROM AbideSinav WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
								FROM #OGRENCI26
								FOR JSON PATH
							) OGRENCI,
							(	SELECT * FROM #DUZEN26 --ORDER BY SIRA
								FOR JSON PATH
							) DUZEN,
							(SELECT	 DERS
									,BOLUMNO
									,BECERI				= JSON_QUERY(IIF (NOT EXISTS(SELECT TOP 1 1 FROM #TEMP5_1_26),
																NULL,
																(SELECT 
																	(	SELECT *
																		FROM #TEMP5_1_26	T
																		WHERE T.BOLUMNO = B.BOLUMNO
																		FOR JSON PATH
																	  ) AS BECERI,
																	  (	SELECT *
																		FROM #TEMP5_2_26	T
																		WHERE T.BOLUMNO = B.BOLUMNO
																		FOR JSON PATH
																	  ) AS RESIM
																	FOR JSON PATH
																)
															))
									,KAZANIMALTBECERI	= (	SELECT *
															FROM #TEMP6_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,SORUCOZULMEORANI	= (	SELECT *
															FROM #TEMP7_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,OGRENCIPERFORMANS	= JSON_QUERY(IIF (NOT EXISTS(SELECT TOP 1 1 FROM #TEMP8_1_26),NULL,
														(SELECT 
															(	SELECT *
																FROM #TEMP8_1_26	T
																WHERE T.BOLUMNO = B.BOLUMNO
																FOR JSON PATH
															  ) AS ONERI,
															  (	SELECT *
																FROM #TEMP8_2_26	T
																WHERE T.BOLUMNO = B.BOLUMNO
																FOR JSON PATH
															  ) AS PUAN
															FOR JSON PATH
															)))
									,GRAFIK				= (	SELECT *
															FROM #TEMP9_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,TEKGRAFIK			= (	SELECT *
															FROM #TEMP10_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									--,SORULIST			= (	SELECT *
									--						FROM #TEMP_SON_26	T
									--						WHERE T.BOLUMNO = B.BOLUMNO
									--						FOR JSON PATH
									--					  )
								FROM #BOLUMNO26	B
								FOR JSON PATH
								) DERS
					FOR JSON PATH
				)

				DROP TABLE IF EXISTS #BOLUMNO26
				DROP TABLE IF EXISTS #DUZEN26
				DROP TABLE IF EXISTS #OGRENCI26
				DROP TABLE IF EXISTS #TEMP5_1_26
				DROP TABLE IF EXISTS #TEMP5_2_26
				DROP TABLE IF EXISTS #TEMP6_26
				DROP TABLE IF EXISTS #TEMP7_26
				DROP TABLE IF EXISTS #TEMP8_1_26
				DROP TABLE IF EXISTS #TEMP8_2_26
				DROP TABLE IF EXISTS #TEMP9_26
				DROP TABLE IF EXISTS #TEMP10_26
				--DROP TABLE IF EXISTS #TEMP_SON_26

			END

			IF @ISLEM = 27  -- Abide Bildirim Listele
			BEGIN
				SELECT ISNULL((
		        	 SELECT 
		        		 TC_GONDEREN		= @TCKIMLIKNO
		        		,TC_ALAN			= OV.TCKIMLIKNO
		        		,MESAJ				= CONVERT(VARCHAR,S.KYE_TARIH,104)  + ' tarihinde uygulanan ' + S.AD +' Abide sınav sonucunuzu Okyanus Pusulam sistemimizden inceleyebilirsiniz'
		        	 FROM dbo.AbideSinav			S
		        	 JOIN dbo.AbideSoru				SS ON SS.ID_ABIDESINAV		= S.ID_ABIDESINAV
		        	 JOIN dbo.AbideOgrenci			AO ON AO.ID_ABIDESORU	    = SS.ID_ABIDESORU
		        	 JOIN dbo.v3OgrenciVeli			OV ON OV.TCKIMLIKNO_OGR     = AO.TCKIMLIKNO
		        	 WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
		        	 FOR JSON AUTO
		        ),'[]')
			END
		END
	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_UniteTarama]...';


GO
ALTER procedure [dbo].[sp_UniteTarama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ID_UNITESINAV			INT				= NULL,
	@ID_UNITETARAMASINAV	INT			= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@O_TCKIMLIKNO			VARCHAR(11)		= NULL,
	@DERS					VARCHAR(MAX)	= NULL,
	@DERS_ID				INT             = NULL,
	@ID_DERS				INT             = NULL,
	@ID_UNITETARAMASORU		INT				= NULL,			
	@SIRA					INT				= NULL,
	@KITAPCIKSAYISI			INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@OVGORSUN				BIT				= NULL,
	@ID_UNITETARAMAKITAPCIK INT         =NULL,
	@ID_SINAVTURU			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURUS			VARCHAR(MAX)	= NULL,
	@ID_SINIFs				VARCHAR(MAX)	= NULL,
	@ID_SINAVs				VARCHAR(MAX)	= NULL,
	@ID_DERSs				VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM			char(4)			= '',
	@ID_ODEVTUR				INT				= NULL,
	@KOD					VARCHAR(MAX)	= NULL ,
	@ID_SUBELER				VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST			VARCHAR(MAX)	= NULL,
	@KODs					VARCHAR(MAX)	= NULL
	
AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM									=	@ISLEM					
			,TCKIMLIKNO								=	@TCKIMLIKNO				
			,OTURUM									=	@OTURUM					
			,ID_MENU								=	@ID_MENU				
			,DONEM									=	@DONEM					
			,AD										=	@AD						
			,ID_UNITESINAV							=	@ID_UNITESINAV			
			,ID_UNITETARAMASINAV					=	@ID_UNITETARAMASINAV	
			,SQLJSON								=	@SQLJSON				
			,ID_SINIF								=	@ID_SINIF				
			,ID_SUBE								=	@ID_SUBE				
			,ID_SUBEs								=	@ID_SUBEs				
			,O_TCKIMLIKNO							=	@O_TCKIMLIKNO			
			,DERS									=	@DERS					
			,DERS_ID							    =	@DERS_ID				
			,ID_DERS							    =	@ID_DERS				
			,ID_UNITETARAMASORU						=	@ID_UNITETARAMASORU		
			,SIRA									=	@SIRA					
			,KITAPCIKSAYISI							=	@KITAPCIKSAYISI			
			,ID_KADEME3								=	@ID_KADEME3				
			,OVGORSUN								=	@OVGORSUN				
			,ID_UNITETARAMAKITAPCIK			        =	@ID_UNITETARAMAKITAPCIK 
			,ID_SINAVTURU							=	@ID_SINAVTURU			
			,ID_SINAVTURUS							=	@ID_SINAVTURUS			
			,ID_SINIFs								=	@ID_SINIFs				
			,ID_SINAVs								=	@ID_SINAVs				
			,ID_DERSs								=	@ID_DERSs				
			,OGRENCIDONEM							=	@OGRENCIDONEM			
			,ID_ODEVTUR								=	@ID_ODEVTUR				
			,KOD									=	@KOD					
			,ID_SUBELER								=	@ID_SUBELER				
			,ID_SINIFLAR							=	@ID_SINIFLAR			
			,ID_SINIFLIST							=	@ID_SINIFLIST			
			,KODs									=	@KODs					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--BEGIN TRANSACTION [Tran1]
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			DECLARE  @OZELSINAVGOR BIT=0

			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
			BEGIN
				SET @OZELSINAVGOR=1
			END
						
			Declare  @SQL		as varchar(max)=null
					,@Columns	as varchar(max)=null
					,@Columns2	as varchar(max)=null
					,@Columns3	as varchar(max)=null

			IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )
			BEGIN
				IF @ISLEM = 1	--	SINAV TANIMLA
				BEGIN
					DECLARE @INSERTED TABLE(ID INT NOT NULL);  

					INSERT INTO UniteTaramaSinav(AD, DONEM, KYE_TCKIMLIKNO, ID_KADEME3)
					OUTPUT inserted.ID_UNITETARAMASINAV
					INTO @INSERTED
					SELECT @AD, @DONEM, @TCKIMLIKNO, @ID_KADEME3

					DECLARE @cnt INT = 0;

					WHILE @cnt < @KITAPCIKSAYISI
					BEGIN
						INSERT INTO UniteTaramaKitapcik(ID_UNITETARAMASINAV, AD)
						SELECT ID, CHAR(65 + @cnt) FROM @INSERTED
						SET @cnt = @cnt + 1;
					END;
				END	
			
				IF @ISLEM = 2	--	SINAV LİSTELE
				BEGIN
					SELECT
					(
						SELECT	 S.ID_UNITETARAMASINAV
								,S.AD
								,KADEME3		= K3.AD
								,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
								,ADSOYAD		= K.AD + ' ' + K.SOYAD 
								,KITAPCIKSAYISI	= (SELECT COUNT(1) FROM UniteTaramaKitapcik SK WHERE SK.ID_UNITETARAMASINAV = S.ID_UNITETARAMASINAV) 
								,S.OVGORSUN
						FROM UniteTaramaSinav S 
						INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.KYE_TCKIMLIKNO
						INNER JOIN v3Kademe3				 K3 ON K3.ID_KADEME3	= S.ID_KADEME3
						WHERE	S.DONEM		 = @DONEM 
							AND S.ID_KADEME3 = @ID_KADEME3
							AND S.AKTIF		 = 1 
						ORDER BY S.KYE_TARIH DESC 
						FOR JSON PATH
					)
				END

				IF @ISLEM = 3	--	SINAV DUZENLE
				BEGIN
					UPDATE UniteTaramaSinav SET 
						 AD			= @AD
						,ID_KADEME3 = @ID_KADEME3 
					WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					DECLARE @MEVCUTKITAPCIKSAYISI INT = (SELECT COUNT(1) FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV)

					IF @KITAPCIKSAYISI <> @MEVCUTKITAPCIKSAYISI
					BEGIN
						IF @KITAPCIKSAYISI > @MEVCUTKITAPCIKSAYISI
						BEGIN
							DECLARE @cntx INT = @MEVCUTKITAPCIKSAYISI;

							WHILE @cntx < @KITAPCIKSAYISI
							BEGIN
								INSERT INTO UniteTaramaKitapcik(ID_UNITETARAMASINAV, AD)
								SELECT @ID_UNITETARAMASINAV, CHAR(65 + @cntx)

								DECLARE @YENIID_UNITETARAMAKITAPCIK INT = (SELECT ID_UNITETARAMAKITAPCIK FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV AND AD = CHAR(65 + @cntx))

								IF EXISTS (SELECT 1 FROM UniteTaramaSoru WHERE ID_UNITETARAMASINAV= @ID_UNITETARAMASINAV)
								BEGIN
									INSERT INTO UniteTaramaSoruKarsilik(ID_UNITETARAMASORU, ID_UNITETARAMAKITAPCIK, SORUNO)
									SELECT S.ID_UNITETARAMASORU, @YENIID_UNITETARAMAKITAPCIK, S.SORUNO
									FROM UniteTaramaSoru S
								END
							
								SET @cntx = @cntx + 1;
							END;
						END
						ELSE
						BEGIN
							SELECT TOP(@MEVCUTKITAPCIKSAYISI - @KITAPCIKSAYISI) ID_UNITETARAMAKITAPCIK 
							INTO #TEMPKITAPCIK
							FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
							ORDER BY ID_UNITETARAMAKITAPCIK DESC

							DELETE SK FROM UniteTaramaSoruKarsilik SK
							INNER JOIN #TEMPKITAPCIK K ON K.ID_UNITETARAMAKITAPCIK = SK.ID_UNITETARAMAKITAPCIK

							DELETE K FROM UniteTaramaKitapcik K
							INNER JOIN #TEMPKITAPCIK T ON T.ID_UNITETARAMAKITAPCIK = K.ID_UNITETARAMAKITAPCIK
						END
					END
				END

				IF @ISLEM = 4	--	SINAV SİL
				BEGIN
					UPDATE UniteTaramaSinav SET AKTIF = 0 WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				END

				IF @ISLEM = 5	--	SINAV EXCEL YÜKLE
				BEGIN
					IF EXISTS (	
								SELECT TOP 1 1 FROM UniteTaramaOgrenci O 
								INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = O.ID_UNITETARAMASORU
								WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
							)
					BEGIN
						RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
					END
					ELSE
					BEGIN
						DELETE SK FROM UniteTaramaSoruKarsilik SK
						INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = SK.ID_UNITETARAMASORU
						WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				
						DELETE FROM UniteTaramaSoru WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaYorum WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaPuanAralik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaBeceri WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV


						DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  
						INSERT INTO UniteTaramaSoru (ID_UNITETARAMASINAV, ID_DERS,SORUNO, KAZANIMKOD, PUAN)
						OUTPUT inserted.ID_UNITETARAMASORU, inserted.SORUNO
						INTO @INSERTEDSORU
						SELECT @ID_UNITETARAMASINAV, ID_DERS, SORUNO, KAZANIMKOD, PUAN FROM OPENJSON(@SQLJSON)
						WITH (
							PUAN		INT,
							SORUNO		INT,
							ID_DERS		VARCHAR(MAX),
							KAZANIMKOD	VARCHAR(MAX)
						)

						INSERT INTO UniteTaramaSoruKarsilik
						SELECT ID, K.ID_UNITETARAMAKITAPCIK, S.SORUNO FROM @INSERTEDSORU S
						CROSS JOIN UniteTaramaKitapcik K WHERE K.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				
						--INSERT INTO UniteTaramaYorum (ID_UNITETARAMASINAV, DERS, DUZEY, YORUM, ONERI)
						--SELECT @ID_UNITETARAMASINAV, DERS, DUZEY, YORUM, ONERI FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
						--WITH (
						--	DERS VARCHAR(MAX),
						--	DUZEY INT,
						--	YORUM VARCHAR(MAX),
						--	ONERI VARCHAR(MAX)
						--)
				
						--INSERT INTO UniteTaramaPuanAralik(ID_UNITETARAMASINAV, MAXIMUMPUAN, DUZEY)
						--SELECT @ID_UNITETARAMASINAV, MAXIMUMPUAN, DUZEY FROM OPENJSON(@SQLJSON, '$.PUANARALIKLIST')
						--WITH (
						--	MAXIMUMPUAN INT,
						--	DUZEY INT
						--)
				
						--INSERT INTO UniteTaramaBeceri(ID_UNITETARAMASINAV, DERS, BECERI, ACIKLAMA)
						--SELECT @ID_UNITETARAMASINAV, DERS, BECERI, ACIKLAMA FROM OPENJSON(@SQLJSON, '$.BECERILIST')
						--WITH (
						--	DERS VARCHAR(MAX),
						--	BECERI VARCHAR(MAX),
						--	ACIKLAMA VARCHAR(MAX)
						--)
					END
				END

				IF @ISLEM = 6	--	SINAV EXCEL LİSTELE
				BEGIN
					SELECT
					(	SELECT * 
						FROM [Pusulam].[dbo].[UniteTaramaSoru] 
						WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV 				
						FOR JSON PATH--, WITHOUT_ARRAY_WRAPPER
					)
				END

				IF @ISLEM = 7	--	ÖĞRENCİ LİSTELE
				BEGIN
					SELECT
					(
						SELECT	O.OGRNO 
								,O.TCKIMLIKNO
								,K.AD + ' ' + K.SOYAD AS ADSOYAD
								,(	
									SELECT D.DERSAD AS DERS, SUM(CASE WHEN AO.PUAN IS NULL THEN 0 ELSE 1 END) AS CEVAPSAYISI 
									FROM UniteTaramaSoru S INNER JOIN eokul_v2.[dbo].[Ders] D ON D.ID_DERS=S.ID_DERS
									LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
									WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
									GROUP BY S.ID_DERS,D.DERSAD
									FOR JSON PATH
								 ) AS CEVAP
						FROM OkyanusDB.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					
						WHERE O.ID_SINIF = @ID_SINIF AND O.DONEM = @DONEM
						ORDER BY K.AD + ' ' + K.SOYAD
						FOR JSON PATH
					)
				END

				IF @ISLEM = 8	--	ÖĞRENCİ PUAN LİSTELE
				BEGIN
					SELECT
					(
						SELECT S.ID_UNITETARAMASORU, S.SORUNO, VD.AD AS KAZANIM,S.PUAN AS MAXPUAN ,AO.PUAN
						FROM UniteTaramaSoru S
						INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD ON S.ID_DERS=VD.ID_DERS
						AND VD.KOD=S.KAZANIMKOD
						INNER JOIN UniteTaramaSoruKarsilik SK ON SK.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU
						INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=S.ID_DERS
						LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = @O_TCKIMLIKNO AND AO.AKTIF = 1
					
						WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV AND D.DERSAD = @DERS AND (@ID_UNITETARAMAKITAPCIK IS NULL OR SK.ID_UNITETARAMAKITAPCIK = @ID_UNITETARAMAKITAPCIK) 
					
					
						ORDER BY SK.SORUNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END

				IF @ISLEM = 9	--	ÖĞRENCİ PUAN KAYDET
				BEGIN
					UPDATE UniteTaramaOgrenci SET AKTIF = 0 WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND ID_UNITETARAMASORU IN (SELECT ID_UNITETARAMASORU FROM OPENJSON(@SQLJSON) WITH (ID_UNITETARAMASORU INT))

					INSERT INTO UniteTaramaOgrenci (ID_UNITETARAMASORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO, ID_UNITETARAMAKITAPCIK)
					SELECT ID_UNITETARAMASORU, @O_TCKIMLIKNO, PUAN, @TCKIMLIKNO, @ID_UNITETARAMAKITAPCIK FROM OPENJSON(@SQLJSON)
					WITH
					(
						ID_UNITETARAMASORU INT,
						PUAN INT
					)
					WHERE PUAN IS NOT NULL
				END

				IF @ISLEM = 10	--	ÖĞRENCİ DERS PUAN SİL
				BEGIN
					UPDATE AO SET AO.AKTIF = 0 
					FROM UniteTaramaOgrenci AO 
					INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = AO.ID_UNITETARAMASORU
					INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=S.ID_DERS
					WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND D.DERSAD = @DERS AND S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				END

				IF @ISLEM = 17	--	SINAV LİSTELE by OGRENCI
				BEGIN
					SELECT
					(
						SELECT DISTINCT S.ID_UNITETARAMASINAV, S.AD, CONVERT(varchar, S.KYE_TARIH, 104) AS TARIH, K.AD + ' ' + K.SOYAD AS ADSOYAD,S.KYE_TARIH
						FROM UniteTaramaSinav	S 
						JOIN v3Kullanici		K	ON	K.TCKIMLIKNO			= S.KYE_TCKIMLIKNO
						JOIN UniteTaramaSoru	SO	ON	SO.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
						JOIN UniteTaramaOgrenci	O	ON	O.ID_UNITETARAMASORU	= SO.ID_UNITETARAMASORU
						WHERE	S.DONEM			= @DONEM 
							AND O.TCKIMLIKNO	= @O_TCKIMLIKNO
							AND S.AKTIF			= 1 
							AND S.OVGORSUN		= 1
						ORDER BY S.KYE_TARIH DESC
						FOR JSON PATH
					)
				END

				IF @ISLEM = 18	--	PUAN LİSTESİ GETİR (EXCEL)
				BEGIN
					SELECT D.AD DERS, MAX(SORUNO) AS SORUNO 
					FROM UniteTaramaSinav		S
					INNER JOIN UniteTaramaSoru	SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
					INNER JOIN v3Ders			D	ON	D.ID_DERS				= SS.ID_DERS 
					WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
					GROUP BY D.AD
					ORDER BY DERS

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #DERS

					SELECT 
							SB.AD AS SUBE
							,K3.AD AS GRUP
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,SN.AD AS SINIF
							,SN.ID_SINIF
							,AO.TCKIMLIKNO
							,D.DERSAD AS DERS
							,SORU.SORUNO
							,AO.PUAN
					INTO #TEMP
					FROM UniteTaramaOgrenci AO
					INNER JOIN UniteTaramaSoru SORU ON SORU.ID_UNITETARAMASORU = AO.ID_UNITETARAMASORU
					INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=SORU.ID_DERS
					INNER JOIN UniteTaramaSinav SINAV ON SINAV.ID_UNITETARAMASINAV = SORU.ID_UNITETARAMASINAV
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = AO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = AO.TCKIMLIKNO AND O.DONEM = SINAV.DONEM
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = SN.ID_SATISTURU
					INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = ST.ID_KADEME3
					WHERE	SINAV.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV 
						AND SINAV.DONEM = @DONEM
						AND SINAV.AKTIF = 1 
						AND AO.AKTIF = 1
						AND (@ID_SUBE	IS NULL OR @ID_SUBE		= 0 OR O.ID_SUBE	= @ID_SUBE)
						AND (@ID_SINIF	IS NULL OR @ID_SINIF	= 0 OR O.ID_SINIF	= @ID_SINIF)

					DECLARE 
							@COLS AS NVARCHAR(MAX),
							@QUERY  AS NVARCHAR(MAX)

					SELECT DERS+'-'+CAST(SORUNO AS VARCHAR) AS DERS
					INTO #DERS
					FROM #TEMP
					GROUP BY DERS, SORUNO
					ORDER BY DERS, SORUNO

					SELECT @COLS = STUFF((SELECT ','+QUOTENAME(DERS2)+' VARCHAR(MAX) DEFAULT ''-''' 
										  FROM (
													SELECT
														T.DERS + '-' + CAST(T.SORUNO AS VARCHAR) AS DERS2
													FROM #TEMP T 
													GROUP BY T.DERS, T.SORUNO
												) AS S
											FOR XML PATH(''), TYPE
											).value('.', 'NVARCHAR(MAX)') 
										,1,1,'')

					SET @QUERY = '
						DROP TABLE IF EXISTS #T
						CREATE TABLE #T (SUBE VARCHAR(MAX), GRUP VARCHAR(MAX), ADSOYAD VARCHAR(MAX), SINIF VARCHAR(MAX), TCKIMLIKNO VARCHAR(MAX),' + @COLS + ')

						INSERT INTO #T (SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO)
						SELECT SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO FROM #TEMP

						WHILE EXISTS ( SELECT *  FROM #DERS)
						BEGIN

							DECLARE @DERSAD VARCHAR(100) = (SELECT TOP(1) DERS FROM #DERS ORDER BY DERS)	
							DECLARE @QUERY2 NVARCHAR(MAX)

							SET @QUERY2=	
							''
								UPDATE T
								SET T.[''+@DERSAD+''] = P.PUAN
								FROM #T T
								JOIN #TEMP P ON T.TCKIMLIKNO = P.TCKIMLIKNO AND P.DERS + ''''-'''' +  CAST(P.SORUNO AS VARCHAR) = ''''''+@DERSAD+''''''
							''
							EXEC sp_executesql @QUERY2; 

							DELETE FROM #DERS WHERE DERS = @DERSAD
						END
						SELECT DISTINCT * FROM #T
						DROP TABLE IF EXISTS #T
					'
					PRINT @QUERY
					EXEC sp_executesql @QUERY; 

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #DERS
				END

				IF @ISLEM = 21	--	SINAV KİTAPÇIK LİSTELE
				BEGIN
					SELECT	DISTINCT K.ID_UNITETARAMAKITAPCIK
							,K.AD
							,CASE WHEN EXISTS(	
								SELECT 1 
								FROM UniteTaramaOgrenci O
								INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = O.ID_UNITETARAMASORU
								INNER JOIN eokul_v2.[dbo].[Ders] D ON D.ID_DERS=S.ID_DERS
								WHERE O.ID_UNITETARAMAKITAPCIK = K.ID_UNITETARAMAKITAPCIK  AND O.TCKIMLIKNO = @O_TCKIMLIKNO AND O.AKTIF = 1 
							)
							THEN 1
							ELSE 0 
							END AS SECILI
					INTO #TEMPKITAPCIKSEC
					FROM UniteTaramaKitapcik K
					WHERE K.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					--IF NOT EXISTS (SELECT * FROM #TEMPKITAPCIKSEC WHERE SECILI = 1)
					--BEGIN
					--	UPDATE #TEMPKITAPCIKSEC SET SECILI = 1 WHERE AD = 'A'
					--END

					SELECT
					(
						SELECT * FROM #TEMPKITAPCIKSEC
						ORDER BY AD
						FOR JSON PATH
					)

					DROP TABLE #TEMPKITAPCIKSEC
				END

				IF @ISLEM = 25	--	OVGORSUN DEĞİŞTİR
				BEGIN
					UPDATE UniteTaramaSinav SET OVGORSUN = @OVGORSUN WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					select 1
				END

				IF @ISLEM = 26	--	KAZANIM LİSTELE
				BEGIN
					SELECT
					(
						SELECT DISTINCT D.AD DERSAD, VD.AD AS KAZANIM,S.ID_DERS,S.SORUNO,vd.KOD
						FROM UniteTaramaSoru S
						INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	VD	ON	S.ID_DERS				= VD.ID_DERS			AND VD.KOD=S.KAZANIMKOD
						INNER JOIN UniteTaramaSinav					Sn	on	S.ID_UNITETARAMASINAV	= Sn.ID_UNITETARAMASINAV
						INNER JOIN OkyanusDB.DBO.v3Ders				D	on  D.ID_DERS				= S.ID_DERS
						INNER JOIN UniteTaramaOgrenci				UO	ON	UO.ID_UNITETARAMASORU	= S.ID_UNITETARAMASORU
						INNER JOIN OkyanusDB.dbo.v3OgrenciTUM		O	ON	O.TCKIMLIKNO			= UO.TCKIMLIKNO
						INNER JOIN v3SinifTum						ST	ON	ST.ID_SINIF				= O.ID_SINIF			AND ST.DONEM = O.DONEM
						WHERE	Sn.DONEM				= @DONEM 
							AND Sn.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV 
							AND Sn.ID_KADEME3			= @ID_KADEME3
							AND (O.ID_SUBE	IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
							AND (O.ID_SINIF	IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')				    
						ORDER BY D.AD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					as TblListe
				END

				IF @ISLEM = 27	--	Kazanım öğrenci listesi
				BEGIN
					SELECT
					(
		
							SELECT DISTINCT
								 S.ID_UNITETARAMASINAV AS ID_SINAVBILGI
								,GS.SUBEAD AS [KAMPÜS]
								,GS.SINIF
								,UO.TCKIMLIKNO
								,K.AD + ' '+ K.SOYAD [AD SOYAD]
								,O.ID_SINIF
								,D.DERSAD AS DERS
								,VD.AD AS KAZANIM
								,D.ID_DERS
								--,UO.PUAN
								,[PUAN] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100 AS DECIMAL(8,2))
								,[DOĞRULUK YÜZDESİ] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100 AS DECIMAL(8,2))
							FROM	   [Pusulam].dbo.UniteTaramaSinav		S						
							INNER JOIN [Pusulam].dbo.UniteTaramaSoru		SO WITH (NOLOCK)ON SO.ID_UNITETARAMASINAV=S.ID_UNITETARAMASINAV
							INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD	ON	SO.ID_DERS=VD.ID_DERS AND VD.KOD=SO.KAZANIMKOD 
							INNER JOIN [Pusulam].dbo.UniteTaramaOgrenci		UO	ON	UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
							INNER JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO=UO.TCKIMLIKNO
							INNER JOIN OkyanusDB.[dbo].[v3OgrenciTUM]		O	ON	O.TCKIMLIKNO=UO.TCKIMLIKNO AND O.DONEM = S.DONEM
							INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS	ON	GS.ID_SINIF = O.ID_SINIF
							INNER JOIN eokul_v2.dbo.Ders					D	ON D.ID_DERS=SO.ID_DERS
							INNER JOIN OkyanusDB.dbo.v3Kademe3				K3	ON K3.ID_KADEME3=S.ID_KADEME3
							WHERE		S.AKTIF			= 1
									AND S.DONEM			= @DONEM
									AND D.ID_DERS		= @ID_DERS
									AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
									AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
									AND SO.KAZANIMKOD=@KOD
							--GROUP BY S.ID_UNITETARAMASINAV ,S.AD ,D.DERSAD ,D.ID_DERS,UO.TCKIMLIKNO,O.ID_SINIF,K.AD,K.SOYAD,UO.PUAN,VD.AD
							ORDER BY ID_SINAVBILGI ,[KAMPÜS] ,SINIF ,[AD SOYAD], DERS, KAZANIM
							FOR JSON PATH, INCLUDE_NULL_VALUES
							) as TblListeOgr


	  
		
				END

				IF @ISLEM = 28	--	Kazanım öğrenci listesi
				BEGIN
					SELECT
					(
		
						
							SELECT DISTINCT
								 S.ID_UNITETARAMASINAV AS ID_SINAVBILGI
								,GS.SUBEAD AS [KAMPÜS]
								,GS.SINIF
								,UO.TCKIMLIKNO
								,K.AD + ' '+ K.SOYAD [AD SOYAD]
								,O.ID_SINIF
								,D.DERSAD AS DERS
								,VD.AD AS KAZANIM
								,D.ID_DERS
								,SO.KAZANIMKOD
								--,UO.PUAN
								,[PUAN] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100.00 AS DECIMAL(8,2))
								,[DOĞRULUK YÜZDESİ] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100.00 AS DECIMAL(8,2))
							FROM	   [Pusulam].dbo.UniteTaramaSinav		S						
							INNER JOIN [Pusulam].dbo.UniteTaramaSoru		SO WITH (NOLOCK)ON SO.ID_UNITETARAMASINAV=S.ID_UNITETARAMASINAV
							INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD	ON	SO.ID_DERS=VD.ID_DERS AND VD.KOD=SO.KAZANIMKOD 
							INNER JOIN [Pusulam].dbo.UniteTaramaOgrenci		UO	ON	UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
							INNER JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO=UO.TCKIMLIKNO
							INNER JOIN OkyanusDB.[dbo].[v3OgrenciTUM]		O	ON	O.TCKIMLIKNO=UO.TCKIMLIKNO AND O.DONEM = S.DONEM
							INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS	ON	GS.ID_SINIF = O.ID_SINIF
							INNER JOIN eokul_v2.dbo.Ders					D	ON D.ID_DERS=SO.ID_DERS
							INNER JOIN OkyanusDB.dbo.v3Kademe3				K3	ON K3.ID_KADEME3=S.ID_KADEME3
							WHERE		S.AKTIF			= 1
									--AND S.DONEM			= @DONEM
									AND S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
									--AND D.ID_DERS		= @ID_DERS
									AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
									AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
									AND (SO.KAZANIMKOD	IN (SELECT VALUE FROM OPENJSON(@KODs))			OR @KODs		= '[]')
							--GROUP BY S.ID_UNITETARAMASINAV ,S.AD ,D.DERSAD ,D.ID_DERS,UO.TCKIMLIKNO,O.ID_SINIF,K.AD,K.SOYAD,UO.PUAN,VD.AD
							ORDER BY ID_SINAVBILGI ,[KAMPÜS] ,SINIF ,[AD SOYAD], DERS, KAZANIM
							FOR JSON PATH, INCLUDE_NULL_VALUES
							) as TblListeOgr


	  
		
				END

				IF  @ISLEM= 30	--	SINIF Listesi
				BEGIN
  
					 SELECT distinct D.SUBEAD,DS.SEVIYE AS [KUR SEVİYESİ],D.SINIF,S.TCKIMLIKNO,K.AD + ' '+ K.SOYAD [AD SOYAD] 
					 FROM  OkyanusDB.dbo.vw_SinifOgrenci S 
					 INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay D          ON   S.ID_SINIF=D.ID_SINIF
					 INNER JOIN  v3AktifDonem  AD                         ON   AD.DONEM=d.DONEM 
					 INNER JOIN OkyanusDB.dbo.v3Kullanici			K	  ON   K.TCKIMLIKNO=S.TCKIMLIKNO
					 LEFT JOIN   OkyanusDB.[dbo].[v4SinifOgretmenDers] SD ON   SD.ID_SINIF=D.ID_SINIF 
					 LEFT JOIN    OkyanusDB.[dbo].v4DersSeviye DS         ON   SD.ID_DERS=DS.ID_DERS AND SD.ID_DERSSEVIYE= DS.ID_DERSSEVIYE
					 WHERE AD.AKTIF=1        
					 AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
					 AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
 
					ORDER BY D.SUBEAD ASC,DS.SEVIYE DESC
			   END

				IF  @ISLEM= 31	--	Morpa Kazanım Bul
				BEGIN
					SELECT ISNULL((
						SELECT TOP 1 M.*,D.AD MORPADERS 
						,MATERYALLIST = (SELECT STUFF((SELECT DISTINCT ', ' +  CAST( SM.AD AS VARCHAR) FROM MorpaMateryal SM WHERE SM.ID_MORPADERS = M.ID_MORPADERS AND SM.AKTIF = 1  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
						,ID_MATERYALLIST = (SELECT SM.*
											FROM MorpaMateryal SM 
											WHERE	SM.ID_MORPADERS = M.ID_MORPADERS 
												AND SM.AKTIF		= 1
											FOR JSON PATH)
						FROM OkyanusDB.DBO.v3SinavDersUnite	U
						JOIN MorpaKazanim					M	ON	M.KOD_OKY		= U.KOD
						JOIN MorpaDers						D	ON	D.ID_MORPADERS	= M.ID_MORPADERS
						WHERE	U.KOD	= @KOD
							AND M.AKTIF	= 1
							AND D.AKTIF	= 1
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
			   END

				IF  @ISLEM= 32	--	Sınava Giren Öğrenci Listesi
				BEGIN
					SELECT ISNULL((
					
						SELECT DISTINCT
							 O.SUBEAD
							,O.SINIFAD
							,O.TCKIMLIKNO
							,O.AD
							,O.SOYAD
							,O.ID_SINIF
							,GIRDI  = cast(	IIF(	EXISTS (	SELECT TOP 1 S.ID_UNITETARAMASINAV 
																FROM UniteTaramaSinav	S
																JOIN UniteTaramaSoru	SO	ON	SO.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
																JOIN UniteTaramaOgrenci	U	ON	U.ID_UNITETARAMASORU	= SO.ID_UNITETARAMASORU
																							AND	U.TCKIMLIKNO			= O.TCKIMLIKNO 
																							AND U.AKTIF					= 1
																WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV	
																	AND S.AKTIF					= 1
															)
												,1,0) 
										as bit)
						FROM OkyanusDB.DBO.vw_OgrenciDetayTum	O
						WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLIST))

						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
			   END

		   		IF (@ISLEM = 34 OR @ISLEM = 33)  -- SINIF
				BEGIN
			

				DROP TABLE IF EXISTS #TEMP_SINIF
				DROP TABLE IF EXISTS #SINIF
				DROP TABLE IF EXISTS #SINIF_DYB
				DROP TABLE IF EXISTS ##TblSinif
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #k
				DROP TABLE IF EXISTS #TblOrtalama
				DROP TABLE IF EXISTS #DERSS

			
			
					SELECT DERSAD INTO #DERSS from eokul_v2.dbo.Ders DA
					WHERE ID_DERS IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'
				
			
							SELECT	DISTINCT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD
						   ,O.ID_SUBE,SU.AD SUBEAD,SO.PUAN AS PUAN,SOO.PUAN AS SPUAN										
						   ,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM ,SOO.SORUNO
					
							INTO	#TEMP_SINIF
							FROM	UniteTaramaSinav		S	WITH (NOLOCK)
							JOIN	UniteTaramaSoru			SOO	WITH (NOLOCK)	ON	SOO.ID_UNITETARAMASINAV         = S.ID_UNITETARAMASINAV
							JOIN	UniteTaramaOgrenci		SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASORU			= SOO.ID_UNITETARAMASORU
							JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
							JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
							JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
							JOIN	v3SubeGrupSinifTum		GS	WITH (NOLOCK)	ON	GS.ID_SINIF						= SN.ID_SINIF
							JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SOO.ID_DERS			
							JOIN	#DERSS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD			
							left JOIN	v3SinavDersUnite	U	WITH (NOLOCK)	ON	U.KOD						    = SOO.KAZANIMKOD
							WHERE	S.AKTIF			=	1 		
								AND GS.ID_KADEME3	=	@ID_KADEME3				
								AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')		
							
								AND (S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	
								--IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
					--SELECT * FROM #TEMP_SINIF   	
					DROP TABLE IF EXISTS #SINIF_DYB
					SELECT KOD, KAZANIM, ID_SINIF, SINIFAD, ID_DERS, DERSAD, ID_UNITETARAMASINAV, SINAVAD, SUBEAD, ID_SUBE,COUNT(TCKIMLIKNO) DURUMSAYISI,SUM(PUAN) AS P,SPUAN,				
					CAST(SUM(PUAN) AS FLOAT) / CAST(COUNT(TCKIMLIKNO)AS FLOAT)/CAST(SPUAN AS FLOAT)*CAST(100 AS FLOAT) AS PUAN,0 OGRSAY, SORUNO
					--CAST((SUM(PUAN)/COUNT(DISTINCT(TCKIMLIKNO)))AS FLOAT)/SPUAN*100 AS PUAN, 0 OGRSAY, SORUNO


			
					INTO #SINIF_DYB
					FROM #TEMP_SINIF T
					GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,SUBEAD,ID_SUBE,SORUNO,SPUAN

					UPDATE	S 
					SET		S.OGRSAY=G.OGRSAY
					FROM	#SINIF_DYB	S
					JOIN    (SELECT SORUNO,ID_SINIF,ID_DERS,SUM(DURUMSAYISI) OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO,ID_SINIF, ID_DERS) AS G	ON G.ID_SINIF=S.ID_SINIF  AND S.ID_DERS = G.ID_DERS
			    
					--select * from #SINIF_DYB
						
					SELECT *, CAST(	(	SELECT PUAN
										FROM #SINIF_DYB G 
									WHERE	
											G.PUAN		= S.PUAN 
										AND G.ID_SINIF	= S.ID_SINIF 
										AND G.KOD		= S.KOD 
										AND G.SORUNO	= S.SORUNO 									
								) AS DECIMAL(8,2)) AS YUZDE
					INTO #SINIF
					FROM #SINIF_DYB S
					ORDER BY SORUNO
			
		   
							SELECT ID_SINIF, ID_SUBE ,COUNT(DISTINCT TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
							INTO #OGRSAY
							FROM #TEMP_SINIF
							GROUP BY ID_SINIF,  SUBEAD, SINIFAD, ID_SUBE			
							Select distinct ID_SINIF,SINIFAD, ID_SUBE,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 
		
							Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
							from 
							( Select DISTINCT ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
							ORDER BY SUBEAD,SINIFAD
				
							Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
							from 
							( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
							ORDER BY SUBEAD,COL DESC,SINIFAD

							Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
							from 
							( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
							ORDER BY SUBEAD,COL DESC,SINIFAD
								
			
			
					Set @SQL='	
					Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO,ID_UNITETARAMASINAV,SINAVAD
						,'+@Columns2+' 
					into ##TblSinif
					from (
						Select  *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF 
						UNION ALL 
						Select *,SUBEAD COL from #SINIF  
					) AS S
					PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
					GROUP BY  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO,ID_UNITETARAMASINAV,SINAVAD
					ORDER BY DERSAD
					INSERT INTO ##TblSinif
					SELECT '''',ID_DERS,DERSAD,''SINIF ORTALAMASI'',0,ID_UNITETARAMASINAV,SINAVAD
							, '+@Columns3+'
					FROM ##TblSinif
					GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_DERS,DERSAD
					ORDER BY DERSAD
				'
			
				PRINT @SQL						
				EXEC (@SQL)
			
					SELECT  ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
					INTO #TblOrtalama
					FROM #SINIF				
					GROUP BY ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD
				
					
				UNION ALL				
					SELECT  ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,0 ID_SUBE,'' SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
					FROM #SINIF				
					GROUP BY ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD
					ORDER BY DERSAD			
				--SELECT * FROM ##TblSinif 
				If (OBJECT_ID('tempdb..##TblSinif ') Is Null)			
				BEGIN
			
					SELECT KOD = NULL,ID_DERS= NULL,DERSAD= NULL,KAZANIM= NULL,SORUNO= NULL,ID_UNITETARAMASINAV= NULL,PUAN=NULL,SINAVAD= NULL INTO  ##TblSinif 
					DELETE FROM ##TblSinif 
				END
				BEGIN
					IF @ISLEM = 34  -- DEVEXPRESS
					BEGIN
				
						Select ID_SINIF, SINIFAD, SUBEAD, COL 
						from #k 
						ORDER BY SUBEAD, SINIFAD

						SELECT * FROM ##TblSinif 

						SELECT DISTINCT ID_SINIF,ID_SUBE,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF,OGRSAY

				
						SELECT ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, YUZDE
						FROM #TblOrtalama
						ORDER BY SUBEAD,DERSAD

					END
					ELSE
					BEGIN
						select(
							select * from(
								select 
								(					
									Select ID_SINIF, SINIFAD, SUBEAD, COL 
									from #k 
									ORDER BY SUBEAD, SINIFAD
									FOR JSON AUTO,INCLUDE_NULL_VALUES
								) as TblSinifListesi,					
								(					
									SELECT * FROM ##TblSinif  order by DERSAD,SORUNO 
									FOR JSON AUTO
								) as TblVeri,
								(					
									SELECT DISTINCT ID_SINIF,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF,OGRSAY
									FOR JSON AUTO
								) as TblOgrSay,
								(	
									SELECT ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, YUZDE
									FROM #TblOrtalama
									ORDER BY SUBEAD,DERSAD
									FOR JSON AUTO
								) as TblOrtalama
							) as tablo FOR JSON AUTO
						) as tt				 
					END
				END

			

				DROP TABLE IF EXISTS #k
				DROP TABLE IF EXISTS #TEMP_SINIF
				DROP TABLE IF EXISTS #SINIF
				DROP TABLE IF EXISTS #SINIF_DYB
				DROP TABLE IF EXISTS ##TblSinif
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #TblOrtalama
				DROP TABLE IF EXISTS #DERSSSS



			END

				IF  @ISLEM = 35 --  Ünite Tarama Bildirim Listesi
				BEGIN
					DECLARE @TARIH				VARCHAR(MAX) = '',
							@YAZILIAD			VARCHAR(MAX) = ''

					SELECT 
						 @TARIH		= CONVERT(VARCHAR,KYE_TARIH,104)
						,@YAZILIAD	= AD
					FROM dbo.UniteTaramaSinav WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					SELECT ISNULL((
						SELECT DISTINCT
							 TC_GONDEREN = @TCKIMLIKNO
							,TC_ALAN	 = OV.TCKIMLIKNO
							,MESAJ		 = @TARIH  + ' tarihinde uygulanan ' + @YAZILIAD +' Ünite tarama sınav sonucunuzu Okyanus Pusulam sistemimizden inceleyebilirsiniz'
							FROM dbo.UniteTaramaSinav			UT
							JOIN dbo.UniteTaramaSoru			UTS ON UTS.ID_UNITETARAMASINAV = UT.ID_UNITETARAMASINAV	
							JOIN dbo.UniteTaramaOgrenci			UTO ON UTO.ID_UNITETARAMASORU  = UTS.ID_UNITETARAMASORU
							JOIN dbo.v3OgrenciVeli				OV  ON OV.TCKIMLIKNO_OGR = UTO.TCKIMLIKNO
						WHERE UTS.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						FOR JSON AUTO
					),'[]')


				END


			END
		END
		--COMMIT TRANSACTION [Tran1]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [Tran1]
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YaziliYoklama]...';


GO
ALTER procedure [dbo].[sp_YaziliYoklama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@ID_KADEME2				VARCHAR(MAX)	= NULL,
	@ID_DERSLER				VARCHAR(MAX)	= NULL,
	@SINIFLAR				VARCHAR(MAX)	= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_YAZILI				INT				= NULL,
	@DONEM					char(4)			= NULL,
	@YARIYIL				TINYINT			= NULL,
	@PASIF					BIT				= NULL,
	@TAKMAAD				VARCHAR(MAX)	= NULL,
	@ID_DERS				INT				= NULL,
	@ID_SINIF				INT				= NULL,	
	@SQLJSON		 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCI 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCICEVAP	NVARCHAR(MAX)	= NULL,
	@OVGORSUN				BIT				= NULL,
	@AKTIF					BIT				= NULL,
	@KARNEDEGORUNSUN		BIT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM				
			,TCKIMLIKNO						= @TCKIMLIKNO			
			,TC_OGRENCI						= @TC_OGRENCI			
			,OTURUM							= @OTURUM				
			,ID_MENU						= @ID_MENU			
			,ID_KADEME2						= @ID_KADEME2			
			,ID_DERSLER						= @ID_DERSLER			
			,SINIFLAR						= @SINIFLAR			
			,ID_KADEME3						= @ID_KADEME3			
			,ID_YAZILI						= @ID_YAZILI			
			,DONEM							= @DONEM				
			,YARIYIL						= @YARIYIL			
			,PASIF							= @PASIF				
			,TAKMAAD						= @TAKMAAD			
			,ID_DERS						= @ID_DERS			
			,ID_SINIF						= @ID_SINIF			
			,SQLJSON		 				= @SQLJSON		 	
			,SQLJSONOGRENCI 				= @SQLJSONOGRENCI 	
			,SQLJSONOGRENCICEVAP			= @SQLJSONOGRENCICEVAP
			,OVGORSUN						= @OVGORSUN			
			,AKTIF							= @AKTIF				
			,KARNEDEGORUNSUN				= @KARNEDEGORUNSUN	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	KADEME 3 Listele
			BEGIN
				SELECT
				(
					SELECT DISTINCT st.ID_KADEME3, k.AD
					FROM		  [dbo].[v3Sinif]			s
					INNER JOIN	  [dbo].[v3Donem]			d		ON d.ID_DONEM		=	s.ID_DONEM
					INNER JOIN	  [dbo].[v3AktifDonem]		ad		ON ad.DONEM			=	d.KOD			and ad.AKTIF=1
					INNER JOIN	  [dbo].[v3SatisTuru]		st		ON st.ID_SATISTURU	=	s.ID_SATISTURU
					INNER JOIN	  [dbo].[v3Kademe3]			k		ON k.ID_KADEME3		=	st.ID_KADEME3
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 2	--	KADEME 2 LİSTELE
			BEGIN
				SELECT
				(
					SELECT KB.ID_KADEME2, K2.AD FROM OkyanusDB.dbo.v3KademeBilgi KB
					INNER JOIN OkyanusDB.dbo.v3Kademe2 K2 ON K2.ID_KADEME2=KB.ID_KADEME2
					where ID_KADEME3 = @ID_KADEME3
					FOR JSON PATH
				) AS J
			END	

			IF @ISLEM = 3	--	EKLE
			BEGIN
				----------
				--YAZILI--
				----------
				DECLARE @ID_YAZILILIST TABLE (ID_YAZILI INT)
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI INTO @ID_YAZILILIST(ID_YAZILI)
				select		[AD] ,[KOD] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM], YARIYIL, [ID_KADEME3], ID_DERS, convert(datetime, [YAZILITARIH], 103), @TCKIMLIKNO, [ID_YAZILITURU]
				from OPENJSON(@SQLJSON)
				with
				(
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) AS J

				-----------------
				--YAZILIKADEME2--
				-----------------
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select (select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')
									
				-----------
				--SORULAR--
				-----------
				INSERT INTO [dbo].[YaziliSoru]
						   ([ID_YAZILI]
						   ,[SORUNO]
						   ,[PUAN]
						   ,[KOD]
						   ,[ID_BILGI]
						   ,[ID_BILISSELSUREC])
				SELECT
					(select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI]
					,JSON_Value (s.value, '$.SORUNO') as SORUNO
					,ISNULL(CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.')), 0) as PUAN
					,JSON_Value (s.value, '$.KOD') as KOD
					,CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END AS ID_BILGI
					,CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END AS ID_BILISSELSUREC
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
			
				select ID_YAZILI from @ID_YAZILILIST	
			END

			IF @ISLEM = 4	--	GÜNCELLE
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILI
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILI TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				UPDATE	 SORU SET SORU.PUAN = CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.'))
						,SORU.KOD = JSON_Value (s.value, '$.KOD')
						,SORU.ID_BILGI = CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END
						,SORU.ID_BILISSELSUREC = CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
				INNER JOIN YaziliSoru SORU ON SORU.ID_YAZILI = @ID_YAZILI AND SORU.SORUNO = JSON_Value (s.value, '$.SORUNO')
				
				DROP TABLE #TEMPYAZILI
				select @ID_YAZILI	
			END

			IF @ISLEM = 5	--	BİLGİ GETİR
			BEGIN
				SELECT 
				(
					SELECT * FROM
					(
						Select (
							Select  
								s.AD as AD, 
								s.KOD, 
								ID_KADEME3, 
								Convert(varchar, YAZILITARIH, 103) as YAZILITARIH,
								s.ID_DERS,
								(SELECT COUNT(*) FROM YaziliSoru YS WHERE YS.ID_YAZILI=s.ID_YAZILI) as SORUSAYISI,
								SORULIST.SORUNO as SORUNO,
								SORULIST.KOD,
								UNITE = ISNULL(SD.AD, ''), 
								SORULIST.PUAN,
								s.YARIYIL,
								s.ID_YAZILITURU,
								ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
								ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC
							from	   Yazili			s
							LEFT join YaziliSoru		SORULIST		on	SORULIST.ID_YAZILI		= s.ID_YAZILI 
							LEFT JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
							where s.ID_YAZILI = @ID_YAZILI
						for json auto) as T1
						,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON AUTO) AS T2
					) AS XTABLE
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 6	--	LISTELE
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_YAZILI
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, YAZILITARIH, 104) AS YAZILITARIH
							,AKTIF 
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM YaziliOgrenci WHERE ID_YAZILI = S.ID_YAZILI GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,OVGORSUN
							,KARNEDEGORUNSUN,
							ID_YAZILITURU
						FROM Yazili S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN YaziliKademe2 K2 ON K2.ID_YAZILI = S.ID_YAZILI
						WHERE	DONEM = @DONEM 
						AND		(@YARIYIL = 0 OR YARIYIL = @YARIYIL)
						AND		(@ID_KADEME3 = 0 OR S.ID_KADEME3 = @ID_KADEME3)
						AND		(@ID_KADEME2 = '[]' OR K2.ID_KADEME2 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME2)) or 0 in (SELECT VALUE FROM OPENJSON(@ID_KADEME2)))
						AND		(S.AKTIF = 1 OR @PASIF = 1)
						AND		(@ID_DERS = 0 OR S.ID_DERS = @ID_DERS)
					)XTABLE
					ORDER BY Convert(datetime, YAZILITARIH, 104) DESC
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 7	--	AKTİF PASİF
			BEGIN
				DECLARE @DURUM BIT = (SELECT CASE WHEN AKTIF = 1 THEN 0 ELSE 1 END FROM Yazili WHERE ID_YAZILI = @ID_YAZILI)
				UPDATE Yazili SET AKTIF = @DURUM, GUN_TCKIMLIKNO = @TCKIMLIKNO, GUN_TARIH = GETDATE() WHERE ID_YAZILI = @ID_YAZILI
				SELECT @DURUM
			END

			IF @ISLEM = 8	--	ÖĞRENCİ LİSTELE
			BEGIN
				--DECLARE @KUR BIT = (
				--			SELECT D.KUR FROM Yazili Y
				--			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--			WHERE ID_YAZILI = @ID_YAZILI
				--		)

				SELECT X.TCKIMLIKNO, X.AD, X.SOYAD, YOC.ID_YAZILIOGRENCI, X.ID_YAZILI, X.ID_YAZILISORU, X.SORUNO, X.PUAN AS MAXPUAN, ISNULL(YOC.PUAN, 0) AS PUAN, ISNULL(YO.KATILMADI, 0) AS KATILMADI, YO.TELAFI
				INTO #TEMP
				FROM
				(
					SELECT * FROM
					(
						SELECT Y.ID_YAZILI, YS.ID_YAZILISORU, YS.SORUNO, YS.PUAN 
						FROM Yazili Y
						INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
						WHERE Y.ID_YAZILI = @ID_YAZILI
					) AS T1
					CROSS JOIN 
					(
						SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDb.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
						WHERE S.ID_SINIF = @ID_SINIF --AND @KUR = 0
					UNION 
						SELECT DISTINCT K.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDB.dbo.v4SinifOgrenci SO 
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= SO.TC_OGRENCI
						WHERE SO.ID_SINIF = @ID_SINIF AND SO.AKTIF = 1
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM OkyanusDb.dbo.v3OgrenciTumKur O
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					--	INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
					--	WHERE S.ID_SINIF = @ID_SINIF AND @KUR = 1
					--UNION 
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM eokul_v2.dbo.KurOgrenci			KO
					--	INNER JOIN OkyanusDB.dbo.v3OgrenciTum		O	ON	O.ID_OGRENCI	= KO.ID_OGRENCI
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
					--	WHERE KO.ID_KUR = @ID_SINIF
					) AS T2
				) AS X
				LEFT JOIN YaziliOgrenci YO ON YO.ID_YAZILI = X.ID_YAZILI AND YO.TCKIMLIKNO = X.TCKIMLIKNO AND AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = X.ID_YAZILISORU

				SELECT
				(
					SELECT
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILISORU, SORUNO, PUAN, MAXPUAN FROM #TEMP					
						ORDER BY TCKIMLIKNO, SORUNO
						FOR JSON PATH
					) AS T1,
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI, COUNT(DISTINCT ID_YAZILISORU) AS SORUSAYISI 
						FROM #TEMP
						GROUP BY TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI
						ORDER BY TCKIMLIKNO
						FOR JSON PATH
					) AS T2
					FOR JSON PATH
				) AS J

				DROP TABLE #TEMP
			END

			IF @ISLEM = 9	--	KOPYALA
			BEGIN
				DECLARE @ID_YAZILILISTX TABLE (ID_YAZILI INT)
				INSERT INTO Yazili ([AD],[KOD],[DONEM],[YARIYIL],[ID_YAZILITURU],[ID_KADEME3],[ID_DERS],[YAZILITARIH],[KYE_TCKIMLIKNO],[KYE_TARIH],[AKTIF],[GUN_TARIH],[GUN_TCKIMLIKNO])
				OUTPUT inserted.ID_YAZILI INTO @ID_YAZILILISTX
				SELECT [AD]
					  ,[KOD]
					  ,[DONEM]
					  ,[YARIYIL]
					  ,[ID_YAZILITURU]
					  ,[ID_KADEME3]
					  ,[ID_DERS]
					  ,[YAZILITARIH]
					  ,@TCKIMLIKNO
					  ,GETDATE()
					  ,1
					  ,GETDATE()
					  ,'' 
				FROM Yazili 
				WHERE ID_YAZILI = @ID_YAZILI

				DECLARE @ID_YAZILIX INT = (SELECT ID_YAZILI FROM @ID_YAZILILISTX)  

				INSERT INTO YaziliKademe2 ([ID_YAZILI],[ID_KADEME2])
				SELECT @ID_YAZILIX
					  ,[ID_KADEME2] 
				FROM YaziliKademe2 
				WHERE ID_YAZILI = @ID_YAZILI
			
				INSERT INTO YaziliSoru ([ID_YAZILI],[SORUNO],[PUAN],[KOD])
				SELECT (SELECT ID_YAZILI FROM @ID_YAZILILISTX) AS ID_YAZILI
					  ,[SORUNO]
					  ,[PUAN]
					  ,[KOD] 
				FROM YaziliSoru YS
				WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 10	--	BİLGİ GETİR LİSTE
			BEGIN
				SELECT
				(
					SELECT DONEM
							,ID_KADEME3
							,ID_DERS
							,YARIYIL
							,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON PATH) AS ID_KADEME2 
					FROM Yazili 
					WHERE ID_YAZILI = @ID_YAZILI
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 11	--	LİSTELE SELECT
			BEGIN
				SELECT
				(
					SELECT Y.ID_YAZILI, Y.AD, Y.KOD 
					FROM Yazili			Y
					JOIN YaziliKademe2	K2	ON	K2.ID_YAZILI	= Y.ID_YAZILI
					WHERE	ID_KADEME3	= @ID_KADEME3 
						AND DONEM		= @DONEM 
						AND YARIYIL		= @YARIYIL 
						AND AKTIF		= 1 					
						AND (	
							ID_KADEME2 IN (SELECT ID_KADEME2 FROM OkyanusDB.dbo.v4Sinif S
									INNER JOIN OkyanusDB.dbo.v3KademeBilgi K ON K.ID_KADEME3 = S.ID_KADEME3
									WHERE S.ID_SINIF = @ID_SINIF) 
							OR  ID_KADEME2	= (SELECT ST.ID_KADEME2 FROM OkyanusDB.dbo.v3Sinif S INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU WHERE ID_SINIF = @ID_SINIF))
					GROUP BY Y.ID_YAZILI, Y.AD, Y.KOD
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 12	--	ÖĞRENCİ KAYDET
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
			
				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0

				UPDATE YO SET AKTIF = 0
				FROM YaziliOgrenci YO
				JOIN #TEMPOGRENCI T ON T.ID_YAZILI = YO.ID_YAZILI AND T.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE YO.AKTIF = 1

				DECLARE @ID_YAZILIOGRENCILIST TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST
				SELECT * FROM #TEMPOGRENCI T

				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT ID_YAZILISORU 
						--(	SELECT ID_YAZILIOGRENCI 
						--	FROM YaziliOgrenci 
						--	WHERE ID_YAZILI = 
						--			(	SELECT ID_YAZILI 
						--				FROM YaziliSoru 
						--				WHERE ID_YAZILISORU = OG.ID_YAZILISORU) 
						--		AND TCKIMLIKNO = OG.TCKIMLIKNO 
						--		AND AKTIF = 1 
						--		AND ISNULL(TELAFI, 0) = 0)
						, L.ID_YAZILIOGRENCI
						, PUAN 
						FROM OPENJSON(@SQLJSONOGRENCICEVAP) 
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG	
					JOIN @ID_YAZILIOGRENCILIST L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  		

				DROP TABLE #TEMPOGRENCI
			END

			IF @ISLEM = 13	--	ÖĞRENCİ SİL
			BEGIN
				SELECT ID_YAZILI, OG.TCKIMLIKNO, TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI2
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI INT,
					KATILMADI BIT
				) OG
				UPDATE Y SET AKTIF = 0, SIL_TCKIMLIKNO = @TCKIMLIKNO, SIL_TARIH = GETDATE()
				FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI2 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.AKTIF=1

				DROP TABLE #TEMPOGRENCI2
			END

			IF @ISLEM = 14	--	ÖĞRENCİ KAYDET TOPLU
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI3
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI3 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO

				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0
			
				DECLARE @ID_YAZILIOGRENCILIST2 TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST2
				SELECT * FROM #TEMPOGRENCI3			
			
				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT DISTINCT ID_YAZILISORU
						--, (SELECT ID_YAZILIOGRENCI FROM YaziliOgrenci WHERE ID_YAZILI = (SELECT ID_YAZILI FROM YaziliSoru WHERE ID_YAZILISORU = OG.ID_YAZILISORU) AND TCKIMLIKNO = OG.TCKIMLIKNO AND AKTIF = 1)
						, L.ID_YAZILIOGRENCI
						, PUAN FROM OPENJSON(@SQLJSONOGRENCICEVAP)
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG		
					JOIN @ID_YAZILIOGRENCILIST2 L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  	


				DROP TABLE #TEMPOGRENCI3
			END

			IF @ISLEM = 15	--	Yazılı Listele by Sınıf
			BEGIN
				DECLARE  @ID_DERSLER2	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEM2		VARCHAR(MAX)=@DONEM
						,@YARIYIL2		INT			=@YARIYIL
						,@SINIFLAR2		VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TC
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TC
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLAR2))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (@ID_DERSLER2 IS NULL OR @ID_DERSLER2='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER2)))
						AND (@YARIYIL2 IS NULL OR @YARIYIL2=0 OR sr.YARIYIL = @YARIYIL2)
						and sr.DONEM=@DONEM2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TC
			END 

			IF @ISLEM = 16	--	YAZILI EKLE EXCEL
			BEGIN
				SELECT 
						 AD = JSON_Value (J.value, '$.AD') 
						,KOD = JSON_Value (J.value, '$.KOD')
						,ID_KADEME3 = K3.ID_KADEME3
						,ID_DERS = JSON_Value (J.value, '$.DERS')
						,ID_KADEME2 = K2.value
						,TARIH = JSON_Value (J.value, '$.TARIH')
						,YARIYIL = JSON_Value (J.value, '$.YARIYIL')
						,SORUNO = JSON_Value (S.value, '$.SORUNO')
						,UNITEKOD = JSON_Value (S.value, '$.KOD')
						,PUAN = JSON_Value (S.value, '$.PUAN')
						,ID_YAZILITURU = JSON_Value (J.value, '$.ID_YAZILITURU')
						,ID_BILGI = JSON_Value (S.value, '$.ID_BILGI')
						,ID_BILISSELSUREC = JSON_Value (S.value, '$.ID_BILISSELSUREC')
				INTO #YAZILI
				FROM OPENJSON(@SQLJSON) AS J
				CROSS APPLY OPENJSON (J.value, '$.OKULTUR') as K2
				CROSS APPLY OPENJSON (J.value, '$.SORULIST') as S
				INNER JOIN OkyanusDb.dbo.v3Kademe3 K3 ON K3.AD = JSON_Value (J.value, '$.GRUP')

				DECLARE @ID_YAZILIAD TABLE (ID_YAZILI INT, AD VARCHAR(50))
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI, INSERTED.AD INTO @ID_YAZILIAD(ID_YAZILI, AD)
				SELECT DISTINCT AD, KOD, (select DONEM from [dbo].[v3AktifDonem] where AKTIF=1), YARIYIL, ID_KADEME3, ID_DERS, TARIH, @TCKIMLIKNO, ID_YAZILITURU FROM #YAZILI Y

				INSERT INTO [dbo].[YaziliKademe2]([ID_YAZILI] ,[ID_KADEME2])
				SELECT DISTINCT YA.ID_YAZILI, ID_KADEME2 
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 

				INSERT INTO [dbo].[YaziliSoru]([ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC])
				SELECT DISTINCT YA.ID_YAZILI, Y.SORUNO, ISNULL(Y.PUAN, 0) AS PUAN, Y.UNITEKOD, Y.ID_BILGI, Y.ID_BILISSELSUREC
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 
			
				SELECT MAX(ID_YAZILI) FROM @ID_YAZILIAD

				DROP TABLE #YAZILI
			END

			IF @ISLEM = 17	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET OVGORSUN = @OVGORSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 18	--	AKTIF DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET AKTIF = @AKTIF WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 19	--	YAZILI TÜRÜ LİSTELE
			BEGIN
				SELECT
				(
					SELECT * 
					FROM YaziliTuru
					WHERE AKTIF = 1
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 20	--	YAZILI BİLGİLERİNİ GÜNCELLE (SORULAR HARİÇ)
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILIGUNCELLE
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILIGUNCELLE TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				DROP TABLE #TEMPYAZILIGUNCELLE
				SELECT @ID_YAZILI
			END

			IF @ISLEM = 21	--	Yazılı Listele by Sınıf - KOS
			BEGIN
				DECLARE  @ID_DERSLERKOS	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEMKOS		VARCHAR(MAX)=@DONEM
						,@YARIYILKOS	INT			=@YARIYIL
						,@SINIFLARKOS	VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TCKOS
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TCKOS
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLARKOS))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (@ID_DERSLERKOS IS NULL OR @ID_DERSLERKOS='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLERKOS)))
						AND (@YARIYILKOS IS NULL OR @YARIYILKOS=0 OR sr.YARIYIL = @YARIYILKOS)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TCKOS
			END 

			IF @ISLEM = 22	--	KARNEDEGORUNSUN
			BEGIN
				UPDATE Yazili SET KARNEDEGORUNSUN = @KARNEDEGORUNSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 23	--	YY İşlemleri Excelden Toplu sonuç Yükleme Kayıt Kontrol
			BEGIN
				DECLARE @SINAV_DONEM23 INT=0
				DECLARE @SINAV_GRUP23 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM23 = DONEM , @SINAV_GRUP23 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI

					--Hatalı kayıtları listelemek için hata table'ı oluşturuldu.
				DROP TABLE IF EXISTS #HATALI_DATA
				DROP TABLE IF EXISTS #TEMP_EXCEL_OGRENCI_SONUC
				CREATE TABLE #HATALI_DATA(TCKIMLIKNO VARCHAR(11),HATA VARCHAR(100))

				--Jsondan gelen data örneği
				--SET @SQLJSONOGRENCICEVAP ='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'				

			--JSON'dan GELEN DATA TEMP TABLE'A ATILIYOR
				SELECT TCKIMLIKNO,ID_YAZILI,SORU1,SORU2,SORU3,SORU4,SORU5,SORU6,SORU7,SORU8,SORU9,SORU10,SORU11,SORU12,SORU13,SORU14,SORU15,SORU16,SORU17,SORU18,SORU19,SORU20,TELAFI
				INTO #TEMP_EXCEL_OGRENCI_SONUC
				FROM OPENJSON(@SQLJSONOGRENCICEVAP) WITH(TCKIMLIKNO VARCHAR(11),ID_YAZILI INT,SORU1 INT,SORU2 INT,SORU3 INT,SORU4 INT,SORU5 INT,SORU6 INT,SORU7 INT,SORU8 INT,SORU9 INT,SORU10 INT,SORU11 INT,SORU12 INT,SORU13 INT,SORU14 INT,SORU15 INT,SORU16 INT,SORU17 INT,SORU18 INT,SORU19 INT,SORU20 INT,TELAFI INT)

			--TC KONTROL ve Öğrenci tablosunda olmayan kayıtlar Hata tablosuna ekleniyor. 
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Kayıtlı öğrenci değil'
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
				WHERE NOT EXISTS(SELECT TOP 1 1 FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O WHERE O.TCKIMLIKNO = T.TCKIMLIKNO)
			--TC'si Ogrenci tablosunda olmayan Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--Yazılı Donem Kontrolü - Hatalı döneme sahip öğrenciler Hata tablosuna kayıt ediliyor
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Öğrencinin dönemi hatalı' AS HATA
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T
				WHERE NOT EXISTS(	SELECT TOP 1 1 
									FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
									WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
										AND DONEM		= @SINAV_DONEM23
								)
			--Dönemi Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--GRUP Kontrol
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Öğrencinin grubu hatalı'
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
				WHERE NOT EXISTS(	SELECT TOP 1 1 
									FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
									WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
										AND ID_KADEME3	= @SINAV_GRUP23
								)
			--Grubu Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--MÜKERRER Kayıtlar Belirleniyor 
				INSERT INTO #HATALI_DATA 
				SELECT DISTINCT TCKIMLIKNO, 'Mükerrer Kayıt' 
				FROM #TEMP_EXCEL_OGRENCI_SONUC 
				GROUP BY TCKIMLIKNO 
				HAVING COUNT (TCKIMLIKNO) > 1

			--Mükkerer Kayıtlar TEMP_EXCEL_OGRENCI_SONUC tablosundan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO
			--Hatalı data tablosu geri JSON olarak dönülüyor
				SELECT * FROM #HATALI_DATA FOR JSON AUTO;

			--Temp table'lar silinyor.
				DROP TABLE #HATALI_DATA
 
			END

			IF @ISLEM = 24	--	EXCEL YÜKLEME
			BEGIN
				--@SQLJSONOGRENCICEVAP doğru olarak gelen datalar için CRUD işlemleri yapılıyor
--				DECLARE @SQLJSONOGRENCICEVAP NVARCHAR(MAX)='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":9,"SORU3":8,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'
--DECLARE @ID_YAZILI		INT = 1973
--DECLARE @SINAV_DONEM	INT = 0
--DECLARE @SINAV_GRUP		INT = 0
--DECLARE @TCKIMLIKNO		VARCHAR(MAX) = '32051057542'

				DECLARE @SINAV_DONEM24 INT=0
				DECLARE @SINAV_GRUP24 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM24 = DONEM , @SINAV_GRUP24 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI
				
				DROP TABLE IF EXISTS #EXCEL
				CREATE TABLE #EXCEL (
				TCKIMLIKNO	VARCHAR(MAX),
				SORU1		VARCHAR(MAX),
				SORU2		VARCHAR(MAX),
				SORU3		VARCHAR(MAX),
				SORU4		VARCHAR(MAX),
				SORU5		VARCHAR(MAX),
				SORU6		VARCHAR(MAX),
				SORU7		VARCHAR(MAX),
				SORU8		VARCHAR(MAX),
				SORU9		VARCHAR(MAX),
				SORU10		VARCHAR(MAX),
				SORU11		VARCHAR(MAX),
				SORU12		VARCHAR(MAX),
				SORU13		VARCHAR(MAX),
				SORU14		VARCHAR(MAX),
				SORU15		VARCHAR(MAX),
				SORU16		VARCHAR(MAX),
				SORU17		VARCHAR(MAX),
				SORU18		VARCHAR(MAX),
				SORU19		VARCHAR(MAX),
				SORU20		VARCHAR(MAX),
				TELAFI		VARCHAR(MAX),
				ID_YAZILIOGRENCI INT
				)
				​
				INSERT INTO #EXCEL (TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI) 
				SELECT TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI
				FROM OPENJSON (@SQLJSONOGRENCICEVAP)
				WITH (
					TCKIMLIKNO	VARCHAR(MAX),
					SORU1		VARCHAR(MAX),
					SORU2		VARCHAR(MAX),
					SORU3		VARCHAR(MAX),
					SORU4		VARCHAR(MAX),
					SORU5		VARCHAR(MAX),
					SORU6		VARCHAR(MAX),
					SORU7		VARCHAR(MAX),
					SORU8		VARCHAR(MAX),
					SORU9		VARCHAR(MAX),
					SORU10		VARCHAR(MAX),
					SORU11		VARCHAR(MAX),
					SORU12		VARCHAR(MAX),
					SORU13		VARCHAR(MAX),
					SORU14		VARCHAR(MAX),
					SORU15		VARCHAR(MAX),
					SORU16		VARCHAR(MAX),
					SORU17		VARCHAR(MAX),
					SORU18		VARCHAR(MAX),
					SORU19		VARCHAR(MAX),
					SORU20		VARCHAR(MAX),
					TELAFI		VARCHAR(MAX)
				)

				--SELECT * FROM #EXCEL

				DROP TABLE IF EXISTS #YAZILISORU
				SELECT * INTO #YAZILISORU FROM YaziliSoru WHERE ID_YAZILI = @ID_YAZILI

				--TCKIMLIKNO ve ID_YAZILI ile daha önce eklenen kayıt var ise durumu pasif'e çekiliyor.
				UPDATE Y SET 
					AKTIF = 0 
				FROM YaziliOgrenci Y 
				INNER JOIN #EXCEL O ON O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.ID_YAZILI=@ID_YAZILI
						
				DELETE C
				FROM YaziliOgrenci YO
				JOIN YaziliOgrenciCevap C on C.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF=0

				-- Tüm öğrencilerde dönemi ve grubu olanları al.
				DROP TABLE IF EXISTS #TUM_OGRENCILER
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TUM_OGRENCILER 
				FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] 
				WHERE	ID_KADEME3	= @SINAV_GRUP24
					AND DONEM		= @SINAV_DONEM24
					
				--SELECT * FROM #TUM_OGRENCILER
				DECLARE @INSERTTABLO TABLE (ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(11))
				INSERT INTO YaziliOgrenci(ID_YAZILI,TCKIMLIKNO,KYE_TCKIMLIKNO,KATILMADI,TELAFI)
				OUTPUT inserted.ID_YAZILIOGRENCI,inserted.TCKIMLIKNO INTO @INSERTTABLO(ID_YAZILIOGRENCI,TCKIMLIKNO)
				SELECT	 @ID_YAZILI
						,OT.TCKIMLIKNO
						,@TCKIMLIKNO
						,KATILMADI	= CASE WHEN EXISTS (SELECT TOP 1 1 FROM #EXCEL AS E WHERE E.TCKIMLIKNO = OT.TCKIMLIKNO)
											THEN 0 
											ELSE 1	
										END
						,TELAFI		= (SELECT TOP 1 ISNULL(E.TELAFI,NULL) FROM #EXCEL AS E WHERE OT.TCKIMLIKNO=E.TCKIMLIKNO)
				FROM #TUM_OGRENCILER AS OT

				UPDATE E SET
						E.ID_YAZILIOGRENCI = I.ID_YAZILIOGRENCI
				FROM #EXCEL E
				JOIN  @INSERTTABLO I ON I.TCKIMLIKNO = E.TCKIMLIKNO
 
				DECLARE @sqlCommand varchar(1000)	
				DROP TABLE IF EXISTS #WHILE
				SELECT * INTO #WHILE FROM #YAZILISORU

				WHILE EXISTS( SELECT TOP 1 1 FROM #WHILE)
				BEGIN
					DECLARE @SORUNO VARCHAR(2) = (SELECT TOP 1 CAST(SORUNO AS varchar) FROM #WHILE ORDER BY SORUNO)
					SET @sqlCommand	= 'SELECT SORU'+ @SORUNO  +' FROM #EXCEL ' 
	
					SET @sqlCommand = 
					'	INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
						SELECT (SELECT TOP 1 ID_YAZILISORU FROM #YAZILISORU YS WHERE YS.SORUNO = '+@SORUNO+') AS ID_YAZILISORU, ID_YAZILIOGRENCI, SORU'+@SORUNO+' FROM #EXCEL'
					EXEC (@sqlCommand)
				​
					DELETE FROM #WHILE WHERE SORUNO = @SORUNO
				END
 
				DROP TABLE #TUM_OGRENCILER					
			END

			IF @ISLEM = 25	--	YAZILI ÖZELLİKLERİ RAPOR
			BEGIN

				SET @ID_DERS = (SELECT TOP 1 ID_DERS FROM Yazili WHERE ID_YAZILI = @ID_YAZILI)

				CREATE TABLE #UNITE (ID_DERS INT, KOD VARCHAR(50), AD VARCHAR(MAX), SECILEBILIR BIT)

				INSERT INTO #UNITE
				EXEC sp_DersUniteGetir @ID_DERS = @ID_DERS

				SELECT	 [Yazılı Ad]		= Y.AD
						,[Yazılı Kod]		= Y.KOD
						,[Soru No]			= S.SORUNO
						,[Puan]				= S.PUAN
						,[Ünite]			= U.AD
						,[Konu]				= KO.AD
						,[Kazanım]			= KA.AD
						,[Bilgi]			= B.AD
						,[Bilişsel Süreç]	= BS.AD
				FROM Yazili					Y
				JOIN YaziliSoru				S	ON	S.ID_YAZILI			= Y.ID_YAZILI
				LEFT JOIN #UNITE			KA	ON	KA.KOD				= S.KOD AND LEN(S.KOD) = 12
				LEFT JOIN #UNITE			KO	ON	KO.KOD				= SUBSTRING(S.KOD,1,9)
				LEFT JOIN #UNITE			U	ON	U.KOD				= SUBSTRING(S.KOD,1,6)
				LEFT JOIN BilisselSurec		BS	ON	BS.ID_BILISSELSUREC	= S.ID_BILISSELSUREC
				LEFT JOIN Bilgi				B	ON	B.ID_BILGI			= S.ID_BILGI
				WHERE Y.ID_YAZILI = @ID_YAZILI

				DROP TABLE IF EXISTS #UNITE

				
			END

			IF @ISLEM = 26	--	YAZILI BİLDİRİM GÖNDERİLECEK LİSTESİ
			BEGIN
				DECLARE @TARIH				VARCHAR(MAX) = '',
						@YAZILIAD			VARCHAR(MAX) = ''

				SELECT 
					 @TARIH		= CONVERT(VARCHAR,GUN_TARIH,104)
					,@YAZILIAD	= AD
				FROM dbo.Yazili WHERE ID_YAZILI=@ID_YAZILI

				SELECT ISNULL((
					SELECT  
						 TC_GONDEREN		= @TCKIMLIKNO
						,TC_ALAN			= OV.TCKIMLIKNO
						,MESAJ				= @TARIH  + ' tarihinde uygulanan ' + @YAZILIAD +' sınav sonucunuzu Okyanus Pusulam sistemimizden inceleyebilirsiniz'
					FROM  dbo.YaziliOgrenci		YO
					JOIN dbo.v3OgrenciVeli		OV	ON	OV.TCKIMLIKNO_OGR	= YO.TCKIMLIKNO
					WHERE ID_YAZILI		= @ID_YAZILI 
						AND KATILMADI	= 0 
						AND OV.AKTIF	= 1
						AND YO.AKTIF	= 1
					ORDER BY OV.TCKIMLIKNO_OGR
					FOR JSON AUTO
				),'[]')
					


			END

		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Refreshing [dbo].[sp_EtutProgramiOV]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutProgramiOV]';


GO
PRINT N'Refreshing [dbo].[sp_EtutTakvimi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_EtutTakvimi]';


GO
PRINT N'Reenabling DDL triggers...'
GO
ENABLE TRIGGER [CaptureStoredProcedureChanges] ON DATABASE
GO
PRINT N'Update complete.';


GO
