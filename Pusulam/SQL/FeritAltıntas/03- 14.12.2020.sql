
GO
PRINT N'Disabling all DDL triggers...'
GO
DISABLE TRIGGER ALL ON DATABASE
GO
PRINT N'Creating [dbo].[EtkinlikKagidiOlusturLog]...';


GO
CREATE TABLE [dbo].[EtkinlikKagidiOlusturLog] (
    [ID]    INT        IDENTITY (1, 1) NOT NULL,
    [KIM]   NCHAR (11) NOT NULL,
    [KIME]  NCHAR (11) NOT NULL,
    [ISLEM] NCHAR (25) NOT NULL,
    [TARIH] DATETIME   NOT NULL,
    CONSTRAINT [PK_EtkinlikKagidiOlusturLog] PRIMARY KEY CLUSTERED ([ID] ASC)
);


GO
PRINT N'Creating [dbo].[Tatil]...';


GO
CREATE TABLE [dbo].[Tatil] (
    [ID]              INT           IDENTITY (1, 1) NOT NULL,
    [ADI]             VARCHAR (MAX) NOT NULL,
    [BASLANGIC_TARIH] DATE          NOT NULL,
    [BITIS_TARIH]     DATE          NOT NULL,
    CONSTRAINT [PK_Tatil] PRIMARY KEY CLUSTERED ([ID] ASC)
);


GO
PRINT N'Altering [dbo].[sp_GelisimRaporuLS]...';


GO
ALTER procedure [dbo].[sp_GelisimRaporuLS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL 
AS
BEGIN


BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT


		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @return_variable = 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT * FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(*) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(*) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
			INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	

		IF (@ISLEM=4)
		BEGIN
		
			--DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

			INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
					TCKIMLIKNO	 VARCHAR(MAX),
					DERSAD VARCHAR(MAX),
					ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
					TCKIMLIKNO	 VARCHAR(MAX),
					DERSAD VARCHAR(MAX),
					ID_DERS INT,
					SINAVADI VARCHAR(MAX),
					ID_SINAVRAPOR INT,
					PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
			SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
					DOGRU DECIMAL(8,2),
					YANLIS DECIMAL(8,2),
					BOS DECIMAL(8,2),
					YUZDE DECIMAL(8,2),
					TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(*) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(*) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
					INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(*) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
			SELECT (
						SELECT 						
							--ÖĞRENCİ
							OGRENCI							= (	SELECT * 
																FROM #TEMP_OGRENCI 
																FOR JSON PATH)					
							--DERS ÖĞRETMEN
							,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
																FROM #TEMP_DERS_OGRETMEN 
																ORDER BY DERSAD, ADSOYAD
																FOR JSON PATH)
							--YOKLAMA DERS
							,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
																FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
																ORDER BY DERSAD FOR JSON PATH)
							-- YAZILI YOKLAMA SONUÇLARI
							,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
																, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
																FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
																JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
																JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
																WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
																	OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
																ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
																FOR JSON PATH)  
							--DENEME SINAVI DERSLERI
							,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
																		ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= T.DERSAD 
																	,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
																	,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
																FROM	#TEMP_DENEME_SONUCLARI_T	T
																JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
																--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
																ORDER BY ST.AD, BOLUMNO, T.DERSAD
																FOR JSON AUTO)
							--DENEME SINAVI DERSLERI
							,DENEMESINAVILISTESI			= (
																	SELECT	 DISTINCT 
																			ST.ID_SINAVTURU
																		,SINAVTURU	= ST.AD
																		,SINAVAD
																		,ID_SINAV
																		,SINAVTARIH
																	FROM	#TEMP_DENEME_SONUCLARI_T	T
																	JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
																	ORDER BY ST.AD, T.SINAVTARIH
																	FOR JSON AUTO
																)
							-- DENEME SINAVI SONUCLARI
							,DENEMESINAVISONUCLARI			=  (
																	SELECT	 ST.ID_SINAVTURU
																			,SINAVTURU	= ST.AD
																			,DERSAD		= TT.DERSAD 
																			,TT.ID_SINAV
																			,TT.OLCEKSINAVI
																			,TD = ISNULL(T2.TD,0)
																			,TY = ISNULL(T2.TY,0)
																			,TB = ISNULL(T2.TB,0)
																			,TN = ISNULL(T2.TN,0)
																			,TT.SINAVAD																	
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																			,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
																	FROM	#TEMP_DENEME_SONUCLARI_T	T
																	JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
																	JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																											AND SD.ID_SINAV			= T.ID_SINAV
																	JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																											AND TT.DERSAD			= T.DERSAD
																	JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																											AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
																	ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
																	FOR JSON AUTO
																)
								-- GELİŞİM ANALİZİ DERSLERİ
								,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
																	[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
																	[SINAVADI] = SINAVAD, 
																	[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
																	[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
																	[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
																	NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
																	,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
																FROM	#TEMP_GELISIM_RAPORU_2 	G	
																JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																												AND SINAVLIST.DERSAD		= G.DERSAD
																												AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
																JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
																ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
								--GELİŞİM ANAZILIZI SONUC
								,GELISIMANALIZISONUC		= (	SELECT	
																		G.TCKIMLIKNO
																	,G.STKISAAD + ' TOPLAM' AS STKISAAD
																	,G.ID_SINAVTURU
																	--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
																	,SINAVLIST.ID_SINAV
																	,[SINAVADI]		= SINAVAD
																	,[DOGRU]		= SUM(DOGRU) 
																	,[YANLIS]		= SUM(YANLIS) 
																	,[BOS]			= SUM(BOS) 
																	,NET			= SUM(NET) 
																	,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
																	,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
																	--,G.STKISAAD + ' TOPLAM' AS STKISAAD
																FROM	#TEMP_GELISIM_RAPORU_2 	G	
																JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																												AND SINAVLIST.DERSAD = G.DERSAD
																												AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
																WHERE SINAVAD <> 'ORTALAMA'
																GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
																ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
								--GELİŞİM ANALİZİ PUAN
								,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
																		G.TCKIMLIKNO
																	,G.ID_SINAVPUANTURU
																	,G.PUANTURU
																	,S.SINAVAD
																	,S.PUAN
																	,S.BASARI	
																	,S.BASARI as NET
																FROM #TEMP_PUAN G 
																JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																					AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
																FOR JSON AUTO)
								--NET ORTALAMA KARŞ
								,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
																FROM #TEMP_OO OO
																INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
																INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
																INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
																INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
																ORDER BY STKISAAD, BOLUMNO, DERSAD 
																FOR JSON PATH)
								--KONU ANALIZ
								,KONUANALIZ					= (	SELECT * 
																FROM #TEMP_KONUANALIZ TT 
																ORDER BY TT.DERSAD, TT.KOD 
																FOR JSON PATH)
								--ÖDEV RAPORU
								,ODEVRAPORU					= ( SELECT * 
																FROM #TEMP_ODEV_RAPORU 
																FOR JSON PATH)
								--ÖĞRETMEN DEĞERLENDİRME
								,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
																FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
																ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
																FOR JSON PATH)
								,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																		,K.AD + ' ' + K.SOYAD AS ADSOYAD
																		,DY.YORUM
																		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																		,CASE DY.TUR WHEN 0 THEN STUFF ((
																			SELECT DISTINCT ', ' + UPPER(D.AD)
																			FROM EOKUL_V2.DBO.dersogretmen DO
																			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																			FOR XML PATH('')), 1, 2, '') 
																			WHEN 1 THEN 'REHBERLİK'
																			WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
																FROM DegerlendirmeYorum				DY
																INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
																INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
																INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
																INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
																WHERE	DY.YORUM <> '' 
																	AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
																ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
																FOR JSON PATH)
								-- ETÜT RAPORU
								,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
																FROM #TEMP_ETUT_RAPORU
																ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
								,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																		,SINAV
																		,DERS
																		,DUZEY
																		,MAXDUZEY
																FROM #TEMP_NEREDEYIM_GRAFIGI
																ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
								--LUS RAPORU
								,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
																	OPT, 
																	CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
																	CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
																	YAZOGRETMEN, 
																	CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
																	CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
																	YAZOGRENCI, 
																	CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
																	CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
																	TOPLAM
																FROM #TEMP_RESULT
																WHERE TOPLAM != '-' FOR JSON PATH)
								,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
																FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
																JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
																JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
																JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
																JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
																GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
																ORDER BY ADSOYAD FOR JSON PATH)
								,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																		,SORUNO
																		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																				WHEN PUANORAN < 40						THEN '1'
																			END AS DURUM
																FROM #TEMP_YAZILISORUOGRENCI
																ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
								,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
																FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
																ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
																FOR JSON PATH)
						FOR JSON PATH
					)
		END
	END

END TRY
		BEGIN CATCH
			SELECT 
				@ErrorSeverity	= ERROR_SEVERITY(),
				@ErrorState		= ERROR_STATE()
							
			SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
			RAISERROR (@MSG , -- Message text.
						@ErrorSeverity, -- Severity.
						@ErrorState -- State.
						);
		END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_OnlineSinav]...';


GO
ALTER PROC [dbo].[sp_OnlineSinav]
	@ISLEM							INT				= NULL,
	@TCKIMLIKNO						VARCHAR(11)		= NULL,
	@OTURUM							VARCHAR(36)		= NULL,
	@ID_MENU						INT				= NULL,

	@ID_SORU						INT				= NULL,
	@ID_SINAV						INT				= NULL,
	@ID_DERS						INT				= NULL,
	@ID_SINAVTURU					INT				= NULL,
	@ID_SINAVANAHTAR				INT				= NULL,
	@ID_CEVAP						INT				= NULL,
	@ID_ONLINESINAVOGRENCI			INT				= NULL,
	@SINAVOTURUM					INT				= NULL,
	@ID_ONLINESINAVOGRENCIOTURUM	INT				= NULL,
	@CEVAPANAHTARI					BIT				= NULL,
	@KYE_TARIH						DATETIME		= NULL,
	@TC_EKLEYEN						VARCHAR(MAX)	= NULL,
	@TC_OGRENCI						VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST					VARCHAR(MAX)	= NULL,
	@TC_OGRENCILIST					VARCHAR(MAX)	= NULL,
	@JSON							VARCHAR(MAX)	= NULL,
	@SQLJSON						VARCHAR(MAX)	= NULL
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM	
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU
								
				,ID_SORU					= @ID_SORU
				,TC_EKLEYEN					= @TC_EKLEYEN
				,KYE_TARIH					= @KYE_TARIH
				,ID_SINAV					= @ID_SINAV
				,ID_DERS					= @ID_DERS
				,ID_SINAVTURU				= @ID_SINAVTURU
				,ID_ONLINESINAVOGRENCI		= @ID_ONLINESINAVOGRENCI
				,ID_ONLINESINAVOGRENCIOTURUM= @ID_ONLINESINAVOGRENCIOTURUM
				,SINAVOTURUM				= @SINAVOTURUM
				,CEVAPANAHTARI				= @CEVAPANAHTARI
				,[JSON]						= @JSON
				,SQLJSON					= @SQLJSON
				,ID_SINIFLIST				= @ID_SINIFLIST
				,TC_OGRENCILIST				= @TC_OGRENCILIST
				,TC_OGRENCI					= @TC_OGRENCI
				,ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
				,ID_CEVAP					= @ID_CEVAP
				,ID_SUBELIST				= @ID_SUBELIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	
	
	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT

		IF @ISLEM IN (12,13,14)
			SET @_ID_LOG = 1
		ELSE
			EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
		
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 
						FROM OkyanusDB.DBO.v3SubeYetki 
						WHERE	TCKIMLIKNO		 = @TCKIMLIKNO 
							AND ID_KULLANICITIPI IN (1,60)
			) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK			
				SET @OZELSINAVGOR=1
			
			DECLARE @QUERY NVARCHAR(MAX) = NULL

			IF @ISLEM = 1	--	Sınav Listele
			BEGIN
				SELECT
				(
					SELECT *, CONVERT(decimal(4,2), (CONVERT(decimal(4,2), XTABLE.DOGRU)/CONVERT(decimal(4,2), (XTABLE.DOGRU + XTABLE.BOS + XTABLE.YANLIS))*100.0)) AS PERFORMANS  
					FROM
					(
						SELECT 
							SOA.ID_SINAV
							,ISNULL(OSO.ID_ONLINESINAVOGRENCI,0) AS ID_ONLINESINAVOGRENCI
							,(
								SELECT DISTINCT AD + ', ' AS [text()] 
								FROM v3Sinavders 
								WHERE ID_DERS IN 
									(
										SELECT SUBSD.ID_DERS 
										FROM		SoruBankasi.dbo.SoruDetay	SUBSD 
										INNER JOIN	SoruBankasi.dbo.SinavSoru	SUBSS	ON SUBSS.ID_SORU = SUBSD.ID_SORU
										WHERE SUBSS.ID_SINAV=SOA.ID_SINAV
									) 
								For XML PATH ('')
							) AS DERS
							,V.AD AS SINAVTURU
							,S.AD AS ADI
							,ISNULL(OSO.GIRIS_SAYISI, 0) AS GIRIS
							,ISNULL(CONVERT(VARCHAR, OSO.BAS_TARIH, 104), '-') AS SONGIRIS
							,cast(ISNULL(OSO.DURUM, 0) as int) AS DURUM
							,CAST(DATEPART(HOUR,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR)+':'+CAST(DATEPART(MINUTE,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR)+':'+CAST(DATEPART(SECOND,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR) AS SURE
							,COUNT(C.DEGER) AS DOGRU
							,(SELECT COUNT(*) - COUNT(C.DEGER) FROM OnlineSinavOgrenciCevap SUBOC WHERE SUBOC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI) AS YANLIS
							,(
								SELECT COUNT(*) - (COUNT(C.DEGER) + (SELECT COUNT(*) - COUNT(C.DEGER) FROM OnlineSinavOgrenciCevap SUBOC WHERE SUBOC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI))
								FROM SoruBankasi.dbo.Soru SUBS
								INNER JOIN SoruBankasi.dbo.SinavSoru SUBSS ON SUBSS.ID_SORU=SUBS.ID_SORU
								INNER JOIN SoruBankasi.dbo.Cevap	 SUBC  ON SUBC.ID_SORU=SUBS.ID_SORU
								WHERE SUBSS.ID_SINAV=SOA.ID_SINAV AND SUBSS.KITAPCIK='A' AND (
																(SUBS.ID_SORUTUR=2)						--	AÇIK UÇLU
															OR (SUBS.ID_SORUTUR=3)						--	DOĞRU YANLIŞ
															OR (SUBS.ID_SORUTUR=4 AND SUBC.DEGER='1')	--	TEST
															OR (SUBS.ID_SORUTUR=5 AND SUBC.DEGER<>'')	--	EŞLEŞTİRME
															OR (SUBS.ID_SORUTUR=6)						--	BOŞLUK DOLDURMA
															)
							) AS BOS,
							CASE WHEN (S.BAS_TARIH<=CAST(GETDATE() AS DATE) AND S.BAS_SAAT<=convert(varchar(10), GETDATE(), 108))
								  AND ((S.BIT_TARIH=CAST(GETDATE() AS DATE) AND S.BIT_SAAT>=convert(varchar(10), GETDATE(), 108))
										OR 
										(S.BIT_TARIH>CAST(GETDATE() AS DATE))
									)
							THEN 1 ELSE 0 END AS DEVAM
						FROM		SoruBankasi.dbo.SinavOgrenciAtama	SOA
						INNER JOIN	SoruBankasi.dbo.Sinav				S	ON S.ID_SINAV=SOA.ID_SINAV 
						INNER JOIN	SoruBankasi.dbo.Varlik				V	ON V.ID_VARLIK=S.ID_SINAVTUR
						INNER JOIN	SoruBankasi.dbo.SinavSoru			SS	ON SS.ID_SINAV=S.ID_SINAV AND SS.KITAPCIK='A'
						INNER JOIN	SoruBankasi.dbo.Soru				SOR	ON SOR.ID_SORU=SS.ID_SORU 
						INNER JOIN	SoruBankasi.dbo.SoruDetay			SD	ON SD.ID_SORU=SS.ID_SORU 
						LEFT  JOIN	OnlineSinavOgrenci					OSO ON OSO.TCKIMLIKNO=SOA.TCKIMLIKNO AND OSO.ID_ONLINESINAV=SOA.ID_SINAV
						LEFT  JOIN	OnlineSinavOgrenciCevap				OC	ON OC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI AND OC.ID_SORU=SOR.ID_SORU
						LEFT  JOIN	SoruBankasi.dbo.Cevap				C	ON C.ID_SORU=SOR.ID_SORU AND (
																												(SOR.ID_SORUTUR=2 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	AÇIK UÇLU
																											OR (SOR.ID_SORUTUR=3 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	DOĞRU YANLIŞ
																											OR (SOR.ID_SORUTUR=4 AND C.DEGER='1' AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.CEVAPNO AS VARCHAR))				--	TEST
																											OR (SOR.ID_SORUTUR=5 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	EŞLEŞTİRME
																											OR (SOR.ID_SORUTUR=6 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	BOŞLUK DOLDURMA
																											)
						WHERE	(@ID_SINAV IS NULL OR SOA.ID_SINAV=@ID_SINAV) 
							
							AND ID_SORUTUR<>1 
							AND ID_USTSORU IS NULL 
							AND SOA.TCKIMLIKNO=@TCKIMLIKNO
							AND (@ID_SINAVTURU IS NULL OR @ID_SINAVTURU = 0 OR S.ID_SINAVTUR=@ID_SINAVTURU) 
							AND (@ID_DERS IS NULL OR @ID_DERS = 0 OR SD.ID_DERS=@ID_DERS) --@TCKIMLIKNO AND 
						GROUP BY SOA.ID_SINAV, S.BAS_TARIH, S.BAS_SAAT, S.BIT_TARIH, S.BIT_SAAT, OSO.ID_ONLINESINAVOGRENCI, V.AD, S.AD, OSO.DURUM, OSO.GIRIS_SAYISI, OSO.BAS_TARIH, OSO.BIT_TARIH
					) XTABLE
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS JSON
			END

			IF @ISLEM = 2	--	Soru Listesi Getir 
			BEGIN
				SELECT
				(
					SELECT 
						S.ID_SORU
						,S.ID_SORUTUR
						,S.ID_USTSORU
						,SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
						,(SELECT
							(
								SELECT
									SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
									,(
										 SELECT 
											 ID_SORU=ISNULL(ID_SORU,0)
											,ID_USTSORU=ISNULL(ID_USTSORU,0)
											,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
											,SUBV.AD AS SORUTUR
											,KOD=ISNULL(KOD,0)
											,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
											,ID_DERS=ISNULL(ID_DERS,0)
											,UNITE=ISNULL(UNITE,0)
											,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
										 FROM SoruBankasi.dbo.SoruDetay SUBSD 
										 INNER JOIN SoruBankasi.dbo.Varlik SUBV ON SUBV.ID_VARLIK=SUBS.ID_SORUTUR
										 Where ID_SORU=SUBS.ID_SORU 
										 FOR JSON PATH
									 ) AS Soru,
									(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
									(	
										SELECT C.*
										FROM SoruBankasi.dbo.Cevap C
										Where C.ID_SORU=SUBS.ID_SORU ORDER BY ID_CEVAP,C.CEVAPNO,LEN(DEGER) DESC FOR JSON PATH
									)AS CevapListesi,
									(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS CozumListesi
								FROM SoruBankasi.dbo.Soru SUBS 
								WHERE SUBS.ID_SORU = S.ID_SORU OR SUBS.ID_USTSORU = S.ID_SORU
								FOR JSON AUTO, INCLUDE_NULL_VALUES 
							) AS SoruPaketList
						)AS SoruPaketList
					FROM SoruBankasi.dbo.Soru S
					INNER JOIN SoruBankasi.dbo.SinavSoru SS ON SS.ID_SORU=S.ID_SORU
					WHERE ID_SINAV=@ID_SINAV AND SS.KITAPCIK='A' AND ID_SORUTUR<>1 AND ID_USTSORU IS NULL
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 3	--	Soru Getir
			BEGIN
				SELECT
				(
					SELECT 
						 SORUNO = ROW_NUMBER() OVER(ORDER BY ID_SORU ASC)
						,(
							 SELECT 
								 ID_SORU=ISNULL(ID_SORU,0)
								,ID_USTSORU=ISNULL(ID_USTSORU,0)
								,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
								,KOD=ISNULL(KOD,0)
								,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
								,ID_DERS=ISNULL(ID_DERS,0)
								,UNITE=ISNULL(UNITE,0)
								,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
							 FROM SoruBankasi.dbo.SoruDetay Where ID_SORU=S.ID_SORU 
							 FOR JSON PATH
						 ) AS Soru,
						(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=S.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
						(SELECT * FROM SoruBankasi.dbo.Cevap	 Where ID_SORU=S.ID_SORU ORDER BY  LEN(DEGER) DESC, CEVAPNO ASC FOR JSON PATH)AS CevapListesi,
						(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=S.ID_SORU FOR JSON PATH)AS CozumListesi
					FROM SoruBankasi.dbo.Soru S 
					WHERE S.ID_SORU = @ID_SORU OR S.ID_USTSORU = @ID_SORU
					FOR JSON AUTO, INCLUDE_NULL_VALUES 
				) AS SoruPaketList
			END

			IF @ISLEM = 4	--	Sınav Türü Getir
			BEGIN
				SELECT
				(
					SELECT ID_VARLIK, AD FROM SoruBankasi.dbo.Varlik V
					WHERE ID_VARLIKTUR=5
					FOR JSON PATH
				) J
			END

			IF @ISLEM = 5	--	Giriş Ekle
			BEGIN
				IF NOT EXISTS(SELECT ID_ONLINESINAVOGRENCI FROM [OnlineSinavOgrenci] WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV)
				BEGIN
					declare @ID table(ID int)
					INSERT INTO [dbo].[OnlineSinavOgrenci]
							   ([TCKIMLIKNO]
							   ,[ID_ONLINESINAV]
							   ,[DURUM]
							   ,[GIRIS_SAYISI]
							   ,[BAS_TARIH]
							   ,[BIT_TARIH])
						OUTPUT inserted.ID_ONLINESINAVOGRENCI into @ID 
						 VALUES
								(@TCKIMLIKNO
								,@ID_SINAV
								,0
								,1
								,GETDATE()
								,NULL)
					select ID from @ID
				END
				ELSE
				BEGIN
					UPDATE [dbo].[OnlineSinavOgrenci] SET [GIRIS_SAYISI]=[GIRIS_SAYISI]+1, [BAS_TARIH]=GETDATE(), [BIT_TARIH]=NULL WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV
					SELECT ID_ONLINESINAVOGRENCI FROM [OnlineSinavOgrenci] WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV
				END

			END

			IF @ISLEM = 6	--	Sınavı Bitir
			BEGIN
				DELETE FROM [dbo].[OnlineSinavOgrenciCevap] WHERE ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
			
				INSERT INTO [dbo].[OnlineSinavOgrenciCevap]
						   ([ID_SORU]
						   ,[ID_ONLINESINAVOGRENCI]
						   ,[CEVAPNO]
						   ,[CEVAP])
				SELECT ID_SORU, @ID_ONLINESINAVOGRENCI, CEVAPNO, CEVAP FROM OPENJSON(@JSON)
				WITH(
					 ID_SORU	INT				'$.ID_SORU' 
					,CEVAPNO	INT				'$.CEVAPNO' 
					,CEVAP		VARCHAR(MAX)	'$.CEVAP' 
				)

				UPDATE OnlineSinavOgrenci SET DURUM=1, BIT_TARIH=GETDATE() WHERE ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
			END

			IF @ISLEM = 7	--	Soru Listesi Getir Cevaplı
			BEGIN
				SELECT
				(
					SELECT 
						S.ID_SORU
						,S.ID_SORUTUR
						,S.ID_USTSORU
						,SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
						,(SELECT
							(
								SELECT
									SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
									,(
										 SELECT 
											 ID_SORU=ISNULL(ID_SORU,0)
											,ID_USTSORU=ISNULL(ID_USTSORU,0)
											,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
											,SUBV.AD AS SORUTUR
											,KOD=ISNULL(KOD,0)
											,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
											,ID_DERS=ISNULL(ID_DERS,0)
											,UNITE=ISNULL(UNITE,0)
											,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
										 FROM SoruBankasi.dbo.SoruDetay SUBSD 
										 INNER JOIN SoruBankasi.dbo.Varlik SUBV ON SUBV.ID_VARLIK=SUBS.ID_SORUTUR
										 Where ID_SORU=SUBS.ID_SORU 
										 FOR JSON PATH
									 ) AS Soru,
									(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
									(	
										SELECT C.*, OC.CEVAP, SECILI = CASE WHEN SUBS.ID_SORUTUR=4 THEN (CASE WHEN C.ID_CEVAP=(SELECT ID_CEVAP FROM SoruBankasi.dbo.Cevap WHERE ID_SORU=C.ID_SORU AND CEVAPNO=OC.CEVAP) THEN 1 ELSE 0 END) ELSE 0 END
										FROM SoruBankasi.dbo.Cevap C
										LEFT JOIN OnlineSinavOgrenciCevap OC ON OC.ID_SORU=C.ID_SORU AND (SUBS.ID_SORUTUR=4 OR (SUBS.ID_SORUTUR<>4 AND OC.CEVAPNO=C.CEVAPNO)) AND OC.ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
										Where C.ID_SORU=SUBS.ID_SORU ORDER BY ID_CEVAP,C.CEVAPNO,LEN(DEGER) DESC FOR JSON PATH
									)AS CevapListesi,
									(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS CozumListesi
								FROM SoruBankasi.dbo.Soru SUBS 
								WHERE SUBS.ID_SORU = S.ID_SORU OR SUBS.ID_USTSORU = S.ID_SORU
								FOR JSON AUTO, INCLUDE_NULL_VALUES 
							) AS SoruPaketList
						)AS SoruPaketList
					FROM SoruBankasi.dbo.Soru S
					INNER JOIN SoruBankasi.dbo.SinavSoru SS ON SS.ID_SORU=S.ID_SORU
					WHERE ID_SINAV=@ID_SINAV AND SS.KITAPCIK='A' AND ID_SORUTUR<>1 AND ID_USTSORU IS NULL
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			-- YENİ ONLINE SINAV

			IF @ISLEM = 8	--	ONLINE SINAV DETAY						
			BEGIN

				SELECT ISNULL((
					SELECT DISTINCT 
						 S.ID_SINAV
						,CEVAPGOR		= ISNULL(OSD.CEVAPGOR,0)
						,ACIKLANMATARIH	= CONVERT(varchar,ISNULL(OSD.ACIKLANMATARIH,DATEADD(WEEK,2,GETDATE())),104)
						,ACIKLANMASAAT	= CONVERT(char(5),ISNULL(OSD.ACIKLANMATARIH,DATEADD(WEEK,2,GETDATE())),108)
						,OSDO.ID_ONLINESINAVDETAYOTURUM
						,OTURUM			= ISNULL(SOD.OTURUM,1)
						,BASTARIH		= CONVERT(varchar,ISNULL(OSDO.BASTARIH,GETDATE()),104)
						,BASSAAT		= CONVERT(char(5),ISNULL(OSDO.BASTARIH,DATEADD(HOUR,ISNULL(SOD.OTURUM,1),GETDATE())),108)
						,BITTARIH		= CONVERT(varchar,ISNULL(OSDO.BITTARIH,DATEADD(WEEK,1,GETDATE())),104)
						,BITSAAT		= CONVERT(char(5),ISNULL(OSDO.BITTARIH,DATEADD(WEEK,1,DATEADD(HOUR,ISNULL(SOD.OTURUM,1),GETDATE()))),108)
						,SURE			= ISNULL(OSDO.SURE,100)
					FROM Sinav								S	 WITH(NOLOCK) 
					LEFT JOIN Tbl_OnlineSinavDetay			OSD	 WITH(NOLOCK) ON	OSD.ID_SINAV			= S.ID_SINAV
																			  AND	OSD.AKTIF				= 1 
					LEFT JOIN SinavDers						SD	 WITH(NOLOCK) ON	SD.ID_SINAV				= S.ID_SINAV
					LEFT JOIN SinavOptikDers				SOD	 WITH(NOLOCK) ON	SOD.ID_SINAVDERS		= SD.ID_SINAVDERS
					LEFT JOIN Tbl_OnlineSinavDetayOturum	OSDO WITH(NOLOCK) ON	OSDO.ID_ONLINESINAVDETAY= OSD.ID_ONLINESINAVDETAY
																			  AND	OSDO.OTURUM				= ISNULL(SOD.OTURUM,1)
					WHERE	S.ID_SINAV	= @ID_SINAV
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 9	--	ONLINE SINAV DETAY KAYDET				
			BEGIN

				UPDATE Tbl_OnlineSinavDetay SET
					AKTIF = 0
				WHERE	ID_SINAV = JSON_VALUE (@SQLJSON, '$.ID_SINAV') 
					AND AKTIF	 = 1

				
				DROP TABLE IF EXISTS #TEMP9

				SELECT	 ID_SINAV
						,BASTARIH		= CAST(CAST(BASTARIH		+ ' ' +BASSAAT		+':00' AS datetime2) AS smalldatetime)
						,BITTARIH		= CAST(CAST(BITTARIH		+ ' ' +BITSAAT		+':00' AS datetime2) AS smalldatetime)
						,ACIKLANMATARIH = CAST(CAST(ACIKLANMATARIH	+ ' ' +ACIKLANMASAAT+':00' AS datetime2) AS smalldatetime)
						,SURE
						,CEVAPGOR
						,OTURUM
				INTO #TEMP9
				FROM OPENJSON(@SQLJSON)
				WITH(
					ID_SINAV		INT,
					CEVAPGOR		BIT,
					ACIKLANMATARIH	VARCHAR(MAX),
					ACIKLANMASAAT	VARCHAR(MAX),
					OSDO			NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.OSDO)
				WITH(
					OTURUM		INT,
					BASTARIH	VARCHAR(MAX),
					BASSAAT		VARCHAR(MAX),
					BITTARIH	VARCHAR(MAX),
					BITSAAT		VARCHAR(MAX),
					SURE		INT		
				)

				DECLARE @INSTABLE9 TABLE (ID INT)

				DECLARE @ACIKLANMATARIH smalldatetime = (
					SELECT IIF(MAX(ACIKLANMATARIH) > MAX(BITTARIH), MAX(ACIKLANMATARIH), MAX(BITTARIH) )
					FROM #TEMP9
				)
				
				INSERT INTO Tbl_OnlineSinavDetay (ID_SINAV, ACIKLANMATARIH, CEVAPGOR, KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_ONLINESINAVDETAY  INTO @INSTABLE9 (ID)
				SELECT TOP 1 ID_SINAV, @ACIKLANMATARIH, CEVAPGOR, @TCKIMLIKNO FROM #TEMP9
				
				DECLARE @ID_ONLINESINAVDETAY INT = (SELECT TOP 1 ID FROM @INSTABLE9)
				
				INSERT INTO Tbl_OnlineSinavDetayOturum (ID_ONLINESINAVDETAY, OTURUM, BASTARIH, BITTARIH, SURE)
				SELECT @ID_ONLINESINAVDETAY, OTURUM, BASTARIH, BITTARIH, SURE FROM #TEMP9

				DROP TABLE IF EXISTS #TEMP9

			END

			IF @ISLEM = 10	--	OGRENCI ATAMA							
			BEGIN

				IF EXISTS (SELECT TOP 1 1 FROM OPENJSON(@TC_OGRENCILIST))
				BEGIN
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV, VALUE AS TCKIMLIKNO, @TCKIMLIKNO FROM OPENJSON(@TC_OGRENCILIST) J
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND OS.TCKIMLIKNO = J.VALUE)
				END
				ELSE
				BEGIN
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV, SO.TCKIMLIKNO, @TCKIMLIKNO
					FROM OPENJSON(@ID_SINIFLIST)		S
					JOIN OkyanusDB.dbo.vw_SinifOgrenci	SO  WITH(NOLOCK)	ON	SO.ID_SINIF	= S.VALUE
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND OS.TCKIMLIKNO = SO.TCKIMLIKNO)
				END

			END

			IF @ISLEM = 11	--	OGRENCI ATAMA LİSTE						
			BEGIN

				SELECT ISNULL((
					SELECT DISTINCT 
						 K.TCKIMLIKNO
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,TARIH			= CONVERT(VARCHAR, OSO.KYE_TARIH, 104 )
						,OGRENCISAYISI	= COUNT(1)
						,OGRENCILIST	= ISNULL((
							SELECT DISTINCT 
								 SK.TCKIMLIKNO
								,ADSOYAD	= SK.AD + ' ' + SK.SOYAD
								,SK.SUBEAD
								,SK.SINIFAD
							FROM Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)
							JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	SK	WITH(NOLOCK)	ON	SK.TCKIMLIKNO	= SO.TCKIMLIKNO
							WHERE	SO.KYE_TCKIMLIKNO	= K.TCKIMLIKNO
								AND SO.KYE_TARIH		= OSO.KYE_TARIH
								AND	SO.AKTIF			= 1
								AND SK.ID_SINIF			> 0
								AND SK.DONEM			= (SELECT OkyanusDB.dbo.fn_AktifDonem())
							FOR JSON PATH
						),'[]')
						,OSO.KYE_TARIH
					FROM Tbl_OnlineSinavOgrenci	OSO	WITH(NOLOCK)	
					JOIN v3Kullanici			K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= OSO.KYE_TCKIMLIKNO
					WHERE	OSO.ID_SINAV	= @ID_SINAV
						AND OSO.AKTIF		= 1
						AND K.AKTIF			= 1
					GROUP BY OSO.KYE_TARIH, K.TCKIMLIKNO, K.AD, K.SOYAD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 12	--	ÖĞRENCİ YENİ ONLINE SINAV LİSTESİ		
			BEGIN

				CREATE TABLE #TEMP12SINAV (ID_SINAV INT)

				SET @QUERY = (	SELECT DEGER 
								FROM Parametre		P 	WITH(NOLOCK)	
								JOIN ParametreDeger PD	WITH(NOLOCK)	ON	PD.ID_PARAMETREDEGER = P.ID_PARAMETREDEGER 
								WHERE P.ID_PARAMETRE = 1) -- Öğrenci Online Sınav Listesi

				INSERT INTO #TEMP12SINAV
				EXEC (@QUERY)

				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,SINAVTURU	= ST.AD
						,SINAVAD	= S.AD
						,OTURUM		= IIF((GETDATE() > SD.ACIKLANMATARIH AND S.DURUM = 2),  0, SDO.OTURUM)--SDO.OTURUM
						,ACIKLANDI	= CAST(IIF( (GETDATE() > SD.ACIKLANMATARIH AND S.DURUM = 2), 1 , 0) AS bit )
						,DEVAM		= CAST(CASE WHEN	GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH 
													AND GETDATE() < DATEADD(MINUTE, SDO.SURE, ISNULL(SOO.BASTARIH,GETDATE())) THEN 1 
												ELSE 0 
											END 
										AS BIT)
						,COZULDU	= CAST( IIF(C.ID_ONLINESINAVOGRENCI IS NULL, 0 , 1) AS bit)
						,PERFORMANS	= CASE 
										WHEN GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH	THEN '--' 
										WHEN GETDATE() < SDO.BASTARIH							THEN 'Sınav Henüz Başlamadı' 
										WHEN GETDATE() > SD.ACIKLANMATARIH  AND S.DURUM != 2	THEN 'Açıklanması Bekleniyor' 
										ELSE CAST((	SELECT CAST(CAST(sum(SOT.TN) AS decimal(8,2)) / CAST(sum(SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
													FROM SinavOgrenciToplam SOT	WITH(NOLOCK)
													WHERE	SOT.TCKIMLIKNO	= SO.TCKIMLIKNO
														AND	SOT.ID_SINAV	= S.ID_SINAV
											 	) AS VARCHAR)
									END
						,SDO.BITTARIH
					FROM Sinav								S	WITH(NOLOCK)	
					JOIN #TEMP12SINAV						TS					ON	TS.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetay				SD	WITH(NOLOCK)	ON	SD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			SDO	WITH(NOLOCK)	ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
																				AND SDO.OTURUM				= IIF((GETDATE() > SD.ACIKLANMATARIH   AND S.DURUM = 2),  1, SDO.OTURUM)
					JOIN SinavTuru							ST	WITH(NOLOCK)	ON	ST.ID_SINAVTURU			= S.ID_SINAVTURU
					JOIN Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)	ON	SO.ID_SINAV				= SD.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	SOO	WITH(NOLOCK)	ON	SOO.TCKIMLIKNO			= SO.TCKIMLIKNO
																				AND SOO.ID_SINAV			= S.ID_SINAV
																				AND SOO.OTURUM				= SDO.OTURUM

					LEFT JOIN Tbl_OnlineSinavOgrenciCevap	C	WITH(NOLOCK)	ON	C.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
																				AND C.AKTIF					= 1
																				AND EXISTS (SELECT TOP 1 1 
																							FROM SinavAnahtar	GSA
																							JOIN SinavDers		GSD ON GSD.ID_SINAVDERS = GSA.ID_SINAVDERS
																							JOIN SinavOptikDers GSO ON GSO.ID_SINAVDERS = GSD.ID_SINAVDERS
																							WHERE	GSO.OTURUM		= SDO.OTURUM
																								AND GSD.ID_SINAV	= SO.ID_SINAV
																								AND C.ID_SINAVANAHTAR = GSA.ID_SINAVANAHTAR
																				)
					WHERE	SO.TCKIMLIKNO	= @TCKIMLIKNO
						AND SD.AKTIF		= 1
						AND SO.AKTIF		= 1
						AND S.ONLINESINAV	= 1
					ORDER BY SDO.BITTARIH DESC
					FOR JSON PATH
				),'[]')

				DROP TABLE IF EXISTS #TEMP12SINAV

			END

			IF @ISLEM = 13	--	ÖĞRENCİ YENİ ONLINE SINAV DETAY			
			BEGIN

				IF @SINAVOTURUM IS NULL 
					SET @SINAVOTURUM = 0

				IF	@SINAVOTURUM > 0
					AND NOT EXISTS (SELECT TOP 1 1 
									FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
									JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO	= O.TCKIMLIKNO
									WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
										AND O.AKTIF			= 1
										AND OO.ID_SINAV		= @ID_SINAV
										AND OO.OTURUM		= @SINAVOTURUM
									)
					AND EXISTS (SELECT TOP 1 1
								FROM Tbl_OnlineSinavDetay		D	WITH(NOLOCK)	
								JOIN Tbl_OnlineSinavDetayOturum	DO	WITH(NOLOCK)	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
								WHERE	D.ID_SINAV	= @ID_SINAV
									AND D.AKTIF		= 1
									AND DO.OTURUM	= @SINAVOTURUM
									AND GETDATE() BETWEEN DO.BASTARIH AND DO.BITTARIH
								)
				BEGIN
					INSERT INTO  Tbl_OnlineSinavOgrenciOturum (TCKIMLIKNO, ID_SINAV, OTURUM )
					VALUES (@TCKIMLIKNO, @ID_SINAV, @SINAVOTURUM)
				END 
							
																

						DECLARE @BASLAMA_TARIHI DATETIME;
		DECLARE @BITIS_TARIHI DATETIME;
		DECLARE @GIRIS_TARIHI DATETIME;

		DECLARE @SINAV_SONLANMA_SAATI DATETIME;
		DECLARE @SURE INT = 0;
		DECLARE @SINAV_BITISE_KALAN INT =0;
		DECLARE @KALAN VARCHAR(MAX) =NULL;
				SELECT @BASLAMA_TARIHI = OSDO.BASTARIH,@BITIS_TARIHI=OSDO.BITTARIH,@GIRIS_TARIHI=OSOO.BASTARIH,@SURE=OSDO.SURE
				  FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
																					AND (	OSDO.OTURUM				= @OTURUM
																						OR	0						= @OTURUM)
					JOIN Tbl_OnlineSinavOgrenci				OSO		WITH(NOLOCK)	ON	OSO.ID_SINAV				= S.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OSOO	WITH(NOLOCK)	ON	OSOO.TCKIMLIKNO				= OSO.TCKIMLIKNO
																					AND OSOO.ID_SINAV				= S.ID_SINAV
																					AND OSOO.OTURUM					= OSDO.OTURUM
				WHERE	S.ID_SINAV		= @ID_SINAV
					AND OSO.TCKIMLIKNO	= @TC_OGRENCI
					AND OSD.AKTIF		= 1
					AND OSO.AKTIF		= 1
					AND S.AKTIF			= 1
					AND S.OZEL			= 0
						
				SET @SINAV_BITISE_KALAN		= DATEDIFF(MINUTE,GETDATE(),@BITIS_TARIHI)
				SET @SINAV_SONLANMA_SAATI	= DATEADD(MINUTE,@SURE,@GIRIS_TARIHI)

				IF  @SINAV_BITISE_KALAN >= @SURE  
				BEGIN
					SET @SINAV_SONLANMA_SAATI	= DATEADD(MINUTE,@SURE ,@GIRIS_TARIHI)
					SET @SINAV_BITISE_KALAN		= DATEDIFF(MINUTE,GETDATE(),@SINAV_SONLANMA_SAATI)
				END
				SET @KALAN						=	  CAST(CAST( @SINAV_BITISE_KALAN AS VARCHAR ) 
													+ ':' 
													+ CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, @SINAV_BITISE_KALAN, @BASLAMA_TARIHI)) % 60) AS varchar)AS varchar) 
  
						
  				

				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,DEVAM			= CAST(CASE WHEN GETDATE() BETWEEN OSDO.BASTARIH AND OSDO.BITTARIH AND GETDATE() < DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH) THEN 1 ELSE 0 END AS bit )
						,ACIKLANDI		= CAST(CASE WHEN GETDATE() > OSD.ACIKLANMATARIH AND S.DURUM = 2 THEN 1 ELSE 0 END AS bit )
					--KALANSURE		= CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH)) / 60) AS varchar) + ':' + CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH)) % 60) AS varchar)
						,KALANSURE      = @KALAN	
						,ID_SINAVDERS	= SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,TAKMAAD		= SD.TAKMAAD
						,SORUNO			= SA.SORUNO
						,ID_SINAVANAHTAR= SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END
						,OGRENCICEVAP	= ISNULL(OSOC.ID_CEVAP, NULL)
						,COZUMLIST		= JSON_QUERY(
											IIF(GETDATE() < OSD.ACIKLANMATARIH, 
												NULL,
												(SELECT	 SC.ID_COZUM
														,COZUMHTML	= CASE WHEN SC.COZUMHTML  IS NULL THEN '' ELSE 'SoruBankasi/'+ SC.COZUMHTML  END
												FROM SoruBankasi.dbo.SoruCozum SC WITH(NOLOCK)	
												WHERE SC.ID_SORU = SBSH.ID_SORU
												ORDER BY SC.SIRA
												FOR JSON PATH)
											))
						,CEVAPNO		= SBC.CEVAPNO
						,ID_CEVAP		= SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
						,OGRENCICEVAP	= CAST(IIF( OSOC.ID_CEVAP = SBC.ID_CEVAP , 1, 0) AS bit)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
																					AND (	OSDO.OTURUM				= @SINAVOTURUM
																						OR	0						= @SINAVOTURUM)
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
					JOIN Tbl_OnlineSinavOgrenci				OSO		WITH(NOLOCK)	ON	OSO.ID_SINAV				= S.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OSOO	WITH(NOLOCK)	ON	OSOO.TCKIMLIKNO				= OSO.TCKIMLIKNO
																					AND OSOO.ID_SINAV				= S.ID_SINAV
																					AND OSOO.OTURUM					= OSDO.OTURUM
					LEFT JOIN Tbl_OnlineSinavOgrenciCevap	OSOC	WITH(NOLOCK)	ON	OSOC.ID_ONLINESINAVOGRENCI	= OSO.ID_ONLINESINAVOGRENCI
																					AND OSOC.ID_SINAVANAHTAR		= SA.ID_SINAVANAHTAR
																					AND OSOC.AKTIF					= 1
					WHERE	S.ID_SINAV		= @ID_SINAV
						AND OSO.TCKIMLIKNO	= @TCKIMLIKNO
						AND OSD.AKTIF		= 1
						AND OSO.AKTIF		= 1
						AND SK.AD			= 'A'
						AND S.AKTIF			= 1
						AND S.OZEL			= 0
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 14	--	ÖĞRENCİ YENİ ONLINE SINAV SORU İŞARETLE	
			BEGIN

				SET @ID_ONLINESINAVOGRENCI = ISNULL((
					SELECT TOP 1 ID_ONLINESINAVOGRENCI
					FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay			D	WITH(NOLOCK)	ON	D.ID_SINAV				= O.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum		DO	WITH(NOLOCK)	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
					JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO			= O.TCKIMLIKNO
																			AND OO.ID_SINAV				= O.ID_SINAV
																			AND OO.OTURUM				= DO.OTURUM
					WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
						AND O.ID_SINAV		= @ID_SINAV
						AND DO.OTURUM		= @SINAVOTURUM
						AND O.AKTIF			= 1
						AND D.AKTIF			= 1
						AND GETDATE() BETWEEN DO.BASTARIH AND DO.BITTARIH
						AND GETDATE() < DATEADD(MINUTE, DO.SURE, OO.BASTARIH)
				),0)

				IF @ID_ONLINESINAVOGRENCI > 0
				BEGIN

					UPDATE Tbl_OnlineSinavOgrenciCevap SET
						AKTIF = 0
					WHERE	ID_ONLINESINAVOGRENCI	= @ID_ONLINESINAVOGRENCI
						AND	ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
						AND AKTIF					= 1

					IF @ID_CEVAP IS NOT NULL
						INSERT INTO Tbl_OnlineSinavOgrenciCevap (ID_ONLINESINAVOGRENCI, ID_SINAVANAHTAR, ID_CEVAP)  
						VALUES (@ID_ONLINESINAVOGRENCI, @ID_SINAVANAHTAR, @ID_CEVAP)

				END

				SELECT ISNULL(@ID_ONLINESINAVOGRENCI,0)

			END

			IF @ISLEM = 15	--	ÖĞRENCİ YENİ ONLINE SINAV PERFORMANS	
			BEGIN
			
				DECLARE @TABLE TABLE(RESULT VARCHAR(MAX))

				INSERT INTO @TABLE
				EXEC sp_OnlineSinav @TCKIMLIKNO = @TCKIMLIKNO, @OTURUM = @OTURUM, @ID_SINAV = @ID_SINAV, @ISLEM = 13
								
				SELECT (
					SELECT ISNULL((
						SELECT DISTINCT
							 SINAVTURU		= ST.AD
							,SINAVAD		= S.AD
							,SONGIRIS		= (	SELECT TOP 1 CONVERT(varchar, OSOC.KYE_TARIH, 104) + ' ' + CONVERT(varchar, OSOC.KYE_TARIH, 108)
												FROM Tbl_OnlineSinavOgrenci			OSO  WITH(NOLOCK) 
												JOIN Tbl_OnlineSinavOgrenciCevap	OSOC WITH(NOLOCK) ON	OSOC.ID_ONLINESINAVOGRENCI = OSO.ID_ONLINESINAVOGRENCI
												WHERE	OSO.AKTIF	= 1
													AND OSOC.AKTIF	= 1
												ORDER BY OSOC.ID_ONLINESINAVOGRENCICEVAP DESC
												)
							,DOGRU			= SOT.TD
							,YANLIS			= SOT.TY
							,BOS			= SOT.TB
							,NET			= SOT.TN
							,NETPERFORMANS	= CAST(CAST(SOT.TN AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,DOGRUPERFORMANS	= CAST(CAST(SOT.TD AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,YANLISPERFORMANS	= CAST(CAST(SOT.TY AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,BOSPERFORMANS	= CAST(CAST(SOT.TB AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							,DERSPERFORMANS	= JSON_QUERY(
													ISNULL((	SELECT	 SD.BOLUMNO
																	,SD.TAKMAAD
																	,YUZDENET
															FROM SinavDers				SD	 WITH(NOLOCK) 
															JOIN vw_SinavOgrenciBolum	SOB	 WITH(NOLOCK)	ON	SOB.ID_SINAVDERS	= SD.ID_SINAVDERS
																											AND SOB.TCKIMLIKNO		= SOT.TCKIMLIKNO
															WHERE SD.ID_SINAV = S.ID_SINAV
															ORDER BY BOLUMNO
															FOR JSON PATH
													),'[]')
												)
						FROM Tbl_OnlineSinavDetay		OSD	 WITH(NOLOCK) 
						JOIN Tbl_OnlineSinavDetayOturum	DO	 WITH(NOLOCK) ON	DO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
						JOIN SinavOgrenciToplam			SOT	 WITH(NOLOCK) ON	SOT.ID_SINAV	= OSD.ID_SINAV
						JOIN Sinav						S	 WITH(NOLOCK) ON	S.ID_SINAV		= SOT.ID_SINAV
						JOIN SinavTuru					ST	 WITH(NOLOCK) ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
						WHERE	SOT.ID_SINAV		= @ID_SINAV
							AND SOT.TCKIMLIKNO		= @TCKIMLIKNO
							AND OSD.AKTIF			= 1
							AND S.AKTIF				= 1
							AND S.OZEL				= 0
							AND DO.BITTARIH			< GETDATE()
							AND OSD.ACIKLANMATARIH	< GETDATE()
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]') AS PERFORMANS,
					JSON_QUERY((	
						SELECT RESULT 
						FROM @TABLE
					))  AS SINAV
					FOR JSON PATH
				)

			END

			IF @ISLEM = 16	--	ÖĞRENCİ ATAMA KALDIRMA					
			BEGIN

				UPDATE O SET
					AKTIF = 0
				FROM Tbl_OnlineSinavOgrenci	O  WITH(NOLOCK) 
				WHERE	ID_SINAV		= @ID_SINAV
					AND	KYE_TCKIMLIKNO	= @TC_EKLEYEN
					AND KYE_TARIH		= @KYE_TARIH
					AND NOT EXISTS (SELECT TOP 1 1 
									FROM Tbl_OnlineSinavOgrenciCevap C  WITH(NOLOCK) 
									WHERE	C.ID_ONLINESINAVOGRENCI = O.ID_ONLINESINAVOGRENCI 
										AND C.AKTIF					= 1)

				SELECT COUNT(DISTINCT TCKIMLIKNO)
				FROM Tbl_OnlineSinavOgrenci			O  WITH(NOLOCK) 
				JOIN Tbl_OnlineSinavOgrenciCevap	C  WITH(NOLOCK) ON	C.ID_ONLINESINAVOGRENCI = O.ID_ONLINESINAVOGRENCI					
				WHERE	O.ID_SINAV		= @ID_SINAV
					AND	O.KYE_TCKIMLIKNO= @TC_EKLEYEN
					AND O.KYE_TARIH		= @KYE_TARIH
					AND O.AKTIF			= 1
					AND C.AKTIF			= 1

			END

			IF @ISLEM = 17	--	SINAV DETAY RAPOR						
			BEGIN
			
				DECLARE @OGRENCI17 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY  WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
				
				IF @OGRENCI17 = 1
					SET @CEVAPANAHTARI = 1
				ELSE IF NOT EXISTS(	SELECT TOP 1 1 
									FROM v3SubeYetki	SY  WITH(NOLOCK) 
									WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
										AND SY.ID_KULLANICITIPI = 1				--	ADMİN
									)
				BEGIN
					RETURN
					SET @CEVAPANAHTARI = 0
				END

				DROP TABLE IF EXISTS #TEMP17

				SELECT DISTINCT
					 S.ID_SINAV
					,SINAVAD		= S.AD						
					,SD.ID_SINAVDERS
					,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
					,TAKMAAD		= UPPER(SD.TAKMAAD)
					,SA.SORUNO
					,SA.ID_SINAVANAHTAR
					,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
					,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
					,SBC.CEVAPNO
					,CEVAPAD		= CASE	WHEN SBC.CEVAPNO = 1 THEN 'A'
											WHEN SBC.CEVAPNO = 2 THEN 'B'
											WHEN SBC.CEVAPNO = 3 THEN 'C'
											WHEN SBC.CEVAPNO = 4 THEN 'D'
											WHEN SBC.CEVAPNO = 5 THEN 'E'
											ELSE ''
										END
					,SBC.ID_CEVAP
					,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
					,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH 
											or EXISTS(	SELECT TOP 1 1 
														FROM v3SubeYetki	SY  WITH(NOLOCK) 
														WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
															AND SY.ID_KULLANICITIPI = 1				--	ADMİN
											), SBC.DEGER, NULL) AS BIT)
				INTO #TEMP17
				FROM Sinav								S		WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
				JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
				JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																				AND SK.AD						= 'A'
				JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
				JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																				AND SOD.OTURUM					= OSDO.OTURUM
				JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																				AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
				JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
				JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
				JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																				AND SBDC.DEGER					= '1'
				WHERE	S.ID_SINAV			= @ID_SINAV
					AND OSD.AKTIF			= 1
					AND SK.AD				= 'A'
					AND S.AKTIF				= 1
					AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
					AND (@OGRENCI17					= 0
						OR	(	@OGRENCI17			= 1
							AND S.DURUM				= 2
							AND OSD.ACIKLANMATARIH	< GETDATE()						
						))
				ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO


				SELECT DISTINCT
					 ID_SINAV
					,SINAVAD
				FROM #TEMP17
					
				SELECT DISTINCT
					 ID_SINAVDERS
					,BOLUMNO
					,TAKMAAD
					,SORUNO
					,ID_SINAVANAHTAR
					,SORUHTML
					,CEVAPNO
					,CEVAPAD
					,CEVAPHTML
				FROM #TEMP17
					
				SELECT DISTINCT
					 ID_SINAVDERS
					,BOLUMNO
					,TAKMAAD
					,SORUNO
					,CEVAP	= CASE	WHEN CEVAPNO = 1 THEN 'A'
									WHEN CEVAPNO = 2 THEN 'B'
									WHEN CEVAPNO = 3 THEN 'C'
									WHEN CEVAPNO = 4 THEN 'D'
									WHEN CEVAPNO = 5 THEN 'E'
									ELSE ''
								END
				FROM #TEMP17
				WHERE	DEGER			= 1
					AND @CEVAPANAHTARI	= 1

				DROP TABLE IF EXISTS #TEMP17


			END

			IF @ISLEM = 18	--	ONLINE SINAV ONIZLEME					
			BEGIN

				DECLARE @OGRENCI18 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY  WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 

				
				IF @OGRENCI18 = 0 AND NOT EXISTS(	SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 1				--	ADMİN
													)
				BEGIN
					SELECT '[]'
				END
				


				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,S.AD						
						,SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,SD.TAKMAAD
						,SA.SORUNO
						,SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
						,SBC.CEVAPNO
						,SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
					WHERE	S.ID_SINAV					= @ID_SINAV
						AND OSD.AKTIF					= 1
						AND SK.AD						= 'A'
						AND S.AKTIF						= 1
						AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
						AND (@OGRENCI18					= 0
							OR	(	@OGRENCI18			= 1
								AND S.DURUM				= 2
								AND OSD.ACIKLANMATARIH	< GETDATE()						
							))
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				

			END

			IF @ISLEM = 19	--	ONLINE SINAV ÖĞR OTURUM	SIFIRLAMA LİSTE	
			BEGIN

				SELECT ISNULL((
					SELECT	 TCKIMLIKNO	= OD.TCKIMLIKNO
							,AD			= OD.AD
							,SOYAD		= OD.SOYAD
							,SUBEAD		= OD.SUBEAD
							,SINIFAD	= OD.SINIFAD
							,OTURUMLIST.ID_ONLINESINAVOGRENCIOTURUM
							,BASTARIH	= CONVERT(VARCHAR, OTURUMLIST.BASTARIH,104) + ' ' + CONVERT(VARCHAR, OTURUMLIST.BASTARIH,108)
							,OTURUM		= ISNULL(SDO.OTURUM,0)
					FROM Tbl_OnlineSinavDetay				SD			WITH(NOLOCK) 
					JOIN Tbl_OnlineSinavDetayOturum			SDO			WITH(NOLOCK) ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
					JOIN Tbl_OnlineSinavOgrenci				SO			WITH(NOLOCK) ON	SO.ID_SINAV				= SD.ID_SINAV
					JOIN OkyanusDB..v3Ogrenci				O			WITH(NOLOCK) ON	O.TCKIMLIKNO			= SO.TCKIMLIKNO
					JOIN OkyanusDB..vw_OgrenciDetayTum		OD			WITH(NOLOCK) ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
																					 AND OD.ID_SINIF			= O.ID_SINIF
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OTURUMLIST	WITH(NOLOCK) ON	OTURUMLIST.TCKIMLIKNO	= SO.TCKIMLIKNO
																					 AND OTURUMLIST.ID_SINAV	= SO.ID_SINAV
																					 AND OTURUMLIST.OTURUM		= SDO.OTURUM
																					 AND GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH
					WHERE	SD.ID_SINAV	= @ID_SINAV
						AND	SO.AKTIF	= 1
						AND SD.AKTIF	= 1
					ORDER BY SUBEAD, SINIFAD, AD, SOYAD, TCKIMLIKNO, SDO.OTURUM
					FOR JSON AUTO, INCLUDE_NULL_VALUES, ROOT('OGRENCILIST')
				),'{OGRENCILIST:[]}')
				

			END

			IF @ISLEM = 20	--	ONLINE SINAV ÖĞR OTURUM	SIFIRLAMA 		
			BEGIN

				--UPDATE SOC SET
				--	SOC.AKTIF = 0
				DELETE SOC
				FROM Tbl_OnlineSinavOgrenciOturum	OO  WITH(NOLOCK) 
				JOIN Tbl_OnlineSinavOgrenci			SO  WITH(NOLOCK) 	ON	SO.ID_SINAV					= OO.ID_SINAV 
																		AND SO.TCKIMLIKNO				= OO.TCKIMLIKNO
				JOIN Tbl_OnlineSinavOgrenciCevap	SOC WITH(NOLOCK) 	ON	SOC.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
				JOIN vw_SinavDersOturum				SDO WITH(NOLOCK) 	ON	SDO.ID_SINAV				= SO.ID_SINAV
																		AND SDO.OTURUM					= OO.OTURUM
				JOIN SinavAnahtar					SA  WITH(NOLOCK) 	ON	SA.ID_SINAVDERS				= SDO.ID_SINAVDERS
				WHERE	ID_ONLINESINAVOGRENCIOTURUM	= @ID_ONLINESINAVOGRENCIOTURUM
					AND	SO.AKTIF					= 1
					AND	SOC.AKTIF					= 1

				DELETE FROM Tbl_OnlineSinavOgrenciOturum
				WHERE ID_ONLINESINAVOGRENCIOTURUM = @ID_ONLINESINAVOGRENCIOTURUM				

			END

			IF @ISLEM = 21	--	ONLINE SINAV ÇIKTI						
			BEGIN
					
				DECLARE @OGRENCI21 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 

				
				IF @OGRENCI21 = 0 AND NOT EXISTS(	SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 1				--	ADMİN
													)
				BEGIN
					SELECT '[]'
				END
				


				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,S.AD						
						,SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,SD.TAKMAAD
						,SA.SORUNO
						,SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
						,CEVAP			= CASE	WHEN SBDC.CEVAPNO = 1 THEN 'A'
												WHEN SBDC.CEVAPNO = 2 THEN 'B'
												WHEN SBDC.CEVAPNO = 3 THEN 'C'
												WHEN SBDC.CEVAPNO = 4 THEN 'D'
												WHEN SBDC.CEVAPNO = 5 THEN 'E'
												ELSE ''
										END
						,SBC.CEVAPNO
						,SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					LEFT JOIN SoruBankasi.dbo.Cevap			SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
																					AND (GETDATE()					> OSD.ACIKLANMATARIH
																						OR EXISTS(	SELECT TOP 1 1 
																									FROM v3SubeYetki	SY WITH(NOLOCK) 
																									WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
																										AND SY.ID_KULLANICITIPI = 1				--	ADMİN
																									)																						
																						)
																					AND @CEVAPANAHTARI				= 1

					WHERE	S.ID_SINAV					= @ID_SINAV
						AND OSD.AKTIF					= 1
						AND SK.AD						= 'A'
						AND S.AKTIF						= 1
						AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
						AND (@OGRENCI21					= 0
							OR(	@OGRENCI21				= 1
							AND	EXISTS (SELECT TOP 1 1
										FROM Tbl_OnlineSinavOgrenci	SO WITH(NOLOCK) 
										WHERE TCKIMLIKNO	= @TCKIMLIKNO
											AND SO.ID_SINAV	= S.ID_SINAV
											AND SO.AKTIF	= 1
							)
						))
						AND (@OGRENCI21					= 0
							OR	(	@OGRENCI21			= 1
								AND S.DURUM				= 2
								AND OSD.ACIKLANMATARIH	< GETDATE()						
							))
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				

			END

			IF @ISLEM = 22	--	ONLINE SINAV OTURUM OGRENCI LISTE		
			BEGIN
				SELECT ISNULL((
					SELECT SO.TCKIMLIKNO
						,K.AD
						,K.SOYAD
						,SOO.OTURUM
						,SUBE	= SB.AD
						,SINIF	= S.AD
						,TARIH	=  CONVERT(VARCHAR(MAX), SOO.BASTARIH, 104) + ' ' + CONVERT(VARCHAR(MAX), SOO.BASTARIH, 108)
					FROM Sinav							SNV WITH(NOLOCK)
					JOIN Tbl_OnlineSinavOgrenci			SO	WITH(NOLOCK)	ON	SO.ID_SINAV		= SNV.ID_SINAV 
																			AND SO.AKTIF		= 1
					JOIN Tbl_OnlineSinavOgrenciOturum	SOO WITH(NOLOCK)	ON	SOO.TCKIMLIKNO	= SO.TCKIMLIKNO 
																			AND SOO.ID_SINAV	= SO.ID_SINAV
					JOIN OkyanusDB.dbo.v3Kullanici		K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= SOO.TCKIMLIKNO
					JOIN OkyanusDB.dbo.v3OgrenciTum		O	WITH(NOLOCK)	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO 
																			AND O.DONEM			= SNV.DONEM
					JOIN OkyanusDB.dbo.v3Sube			SB	WITH(NOLOCK)	ON	SB.ID_SUBE		= O.ID_SUBE
					JOIN OkyanusDB.dbo.v3SinifTum		S	WITH(NOLOCK)	ON	S.ID_SINIF		= O.ID_SINIF 
																			AND S.DONEM			= SNV.DONEM
					WHERE	SNV.AKTIF = 1 
						AND SNV.ID_SINAV = @ID_SINAV
						AND (	(O.ID_SUBE	IN (select value from openjson (@ID_SUBELIST)))
							OR	(0			IN (select value from openjson (@ID_SUBELIST))) 
							OR	@ID_SUBELIST='[]'
							)
					ORDER BY SB.AD, S.AD, K.AD, K.SOYAD, SOO.OTURUM
					FOR JSON PATH
				), '[]')
			END
		END

	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Takvim]...';


GO
ALTER procedure [dbo].[sp_Takvim]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TAKVIM					VARCHAR(MAX)	= NULL,
	@RENK					VARCHAR(7)		= NULL,
	@ID_TAKVIM				INT				= NULL,
	@ID_KULLANICITIPI		INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@JSONKULLANICITIPI		VARCHAR(MAX)	= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ACIKLAMA				VARCHAR(MAX)	= NULL,
	@BAS_TARIH				VARCHAR(MAX)	= NULL,
	@BIT_TARIH				VARCHAR(MAX)	= NULL,
	@ID_TAKVIMETKINLIK		INT				= NULL,
	@ID_TAKVIMS				VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL
AS
BEGIN

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU

		IF @return_variable = 1
		BEGIN
			SET LANGUAGE Turkish;

			IF @ISLEM = 1	--	Takvim Listele
			BEGIN
				SELECT
				(
					SELECT T.ID_TAKVIM, T.AD, CAST(COUNT(TE.ID_TAKVIMETKINLIK) AS VARCHAR) + ' adet etkinlik var' AS ETKINLIKSAYISI, T.RENK
					FROM [dbo].[Takvim] T
					LEFT JOIN TakvimEtkinlik TE ON TE.ID_TAKVIM=T.ID_TAKVIM AND (TE.AKTIF IS NULL OR TE.AKTIF=1)
					WHERE T.AKTIF=1
					GROUP BY T.ID_TAKVIM, T.AD, T.RENK
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 2	--	Takvim Ekle
			BEGIN
				INSERT INTO [dbo].[Takvim]
						   ([AD]
						   ,[RENK]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@TAKVIM
						   ,@RENK
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 3	--	Takvim Sil
			BEGIN
				UPDATE Takvim SET AKTIF = 0, SIL_TARIH=GETDATE(), SIL_TCKIMLIKNO=@TCKIMLIKNO WHERE ID_TAKVIM = @ID_TAKVIM
			END

			IF @ISLEM = 4	--	Kullanıcı Tipi Listele
			BEGIN
				SELECT
				(
					SELECT KT.ID_KULLANICITIPI, AD, CASE WHEN TY.ID_KULLANICITIPI IS NULL THEN 0 ELSE 1 END AS SELECTED FROM OkyanusDB.dbo.v3KullaniciTipi KT
					LEFT JOIN TakvimYetki TY ON TY.ID_KULLANICITIPI=KT.ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					GROUP BY KT.ID_KULLANICITIPI, AD, TY.ID_KULLANICITIPI
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 5	--	Kademe3 Listele
			BEGIN
				SELECT
				(
					SELECT K3.ID_KADEME3, AD, CASE WHEN TY.ID_KADEME3 IS NULL THEN 0 ELSE 1 END SELECTED FROM OkyanusDB.dbo.v3Kademe3 K3
					LEFT JOIN TakvimYetki TY ON TY.ID_KADEME3=K3.ID_KADEME3 AND TY.ID_KULLANICITIPI=@ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 6	--	Takvim Yetki Ekle
			BEGIN
				DELETE FROM TakvimYetki WHERE ID_TAKVIM = @ID_TAKVIM

				INSERT INTO [dbo].[TakvimYetki]
						   ([ID_TAKVIM]
						   ,[ID_KULLANICITIPI]
						   ,[ID_KADEME3]
						   ,[KYE_TCKIMLIKNO])
				SELECT @ID_TAKVIM, ID_KULLANICITIPI, ID_KADEME3, @TCKIMLIKNO
				FROM OPENJSON(@JSONKULLANICITIPI)
				WITH(ID_KULLANICITIPI INT, ID_KADEME3 INT, SELECTED BIT)
				WHERE SELECTED = 1
			END

			IF @ISLEM = 7	--	Takvim Etkinlik Listele
			BEGIN
				SELECT
				(
					SELECT	ID_TAKVIMETKINLIK
							,AD
							,ACIKLAMA
							,CONVERT(VARCHAR, BAS_TARIH, 104) AS BAS_TARIH
							,CONVERT(VARCHAR, BIT_TARIH, 104) AS BIT_TARIH 
					FROM TakvimEtkinlik 
					WHERE ID_TAKVIM=@ID_TAKVIM AND AKTIF=1 
					ORDER BY ID_TAKVIMETKINLIK DESC
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 8	--	Takvim Etkinlik Ekle
			BEGIN
				INSERT INTO [dbo].[TakvimEtkinlik]
						   ([ID_TAKVIM]
						   ,[AD]
						   ,[ACIKLAMA]
						   ,[BAS_TARIH]
						   ,[BIT_TARIH]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@ID_TAKVIM
						   ,@AD
						   ,@ACIKLAMA
						   ,CONVERT(date,@BAS_TARIH,104)
						   ,CONVERT(date,@BIT_TARIH,104)
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 9	--	Takvim Etkinlik Sil
			BEGIN
				UPDATE TakvimEtkinlik SET AKTIF = 0, SIL_TARIH = GETDATE(), SIL_TCKIMLIKNO = @TCKIMLIKNO WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 10	--	Takvim Etkinlik Güncelle
			BEGIN
				UPDATE TakvimEtkinlik SET AD = @AD, ACIKLAMA = @ACIKLAMA, BAS_TARIH = CONVERT(date,@BAS_TARIH,104), BIT_TARIH = CONVERT(date,@BIT_TARIH,104) WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 11	--	Duyuru Listele
			BEGIN
				CREATE TABLE #DUYURULAR (ID_DUYURUV2 INT, BASLIK VARCHAR(MAX), ICERIK VARCHAR(MAX), FOTOGRAF VARCHAR(MAX), TARIH VARCHAR(MAX), BANNER VARCHAR(MAX), EKDOSYA VARCHAR(MAX), FOTOGRAF_MOBIL VARCHAR(MAX))

				DECLARE @ID_KULLANICI INT = (SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);
				--DECLARE @OTURUM2 VARCHAR(MAX) = (SELECT OTURUM FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);

				INSERT INTO #DUYURULAR
				EXEC eokul_v2.dbo.spDuyuruAnasayfa @ID_KULLANICI= @ID_KULLANICI, @OTURUM=@OTURUM

				SELECT
				(
					SELECT * FROM #DUYURULAR
					FOR JSON PATH
				) AS J

				DROP TABLE #DUYURULAR
			END

			IF @ISLEM = 12	--	Takvim Getir
			BEGIN
				DECLARE @DATE DATE = CONVERT(DATE, @BAS_TARIH, 104), @FIRSTDAY DATE, @LASTDAY DATE, @FIRSTWEEKDAY INT, @LASTWEEKDAY INT, @STARTDATE DATETIME, @ENDDATE DATETIME

				SELECT @FIRSTDAY = DATEADD(MONTH, DATEDIFF(MONTH, 0, @DATE), 0)
				SELECT @LASTDAY  = DATEADD(S, -1, DATEADD(MM, DATEDIFF(M, 0, @DATE) + 1, 0))

				SELECT @FIRSTWEEKDAY = DATEPART(DW, @FIRSTDAY)
				SELECT @LASTWEEKDAY  = DATEPART(DW, @LASTDAY)


				SELECT @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, @FIRSTWEEKDAY - 1	, @FIRSTDAY), 0)
				SELECT @ENDDATE	  = DATEADD(DAY, DATEDIFF(DAY, -(7 - @LASTWEEKDAY)	, @LASTDAY ), 0)

				;WITH DateList
				AS
				(
				SELECT @STARTDATE [Date]
				UNION ALL
				SELECT [Date] + 1 FROM DateList WHERE [Date] < @ENDDATE
				)
				SELECT [Date] = CAST([Date] AS DATE) INTO #DateList FROM DateList option (maxrecursion 0);
				
				IF @ID_KULLANICITIPI NOT IN (4,5) AND (4 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO) AND 5 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO))
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								 SELECT DISTINCT TE.AD						AS 'AD'
								,TE.ACIKLAMA								AS 'ACIKLAMA'
								,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
								,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
								,T.RENK										AS 'RENK'
								,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
								,TE.ID_TAKVIM								AS 'ID_TAKVIM'
								,ISNULL((SELECT STUFF((SELECT   ', ' + CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
												LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
													AND  ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')),
										(SELECT STUFF((SELECT   ', ' + KT.AD
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))) 
								AS 'YETKI'

								--,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								--INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								--INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								--LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
								--LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									--AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									
									--AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,D.DERSAD + ' - (' + O.BASLIK + ')' AS AD
										,'#0000FF' AS RENK
										,'0' AS TC_OGRENCI
								FROM		OdevSinifOgrenci	OSO
								INNER JOIN	OdevSinif			OS	ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev				O	ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders	D	ON D.ID_DERS = O.ID_DERS
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF = 1
								AND O.KYE_KULLANICI = @TCKIMLIKNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,D.DERSAD + ' - (' + E.ETUT + ')' AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E					
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= E.TC_OGRETMEN
								WHERE	E.TC_OGRETMEN	= @TCKIMLIKNO
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								SELECT DISTINCT 
										 TE.AD										AS 'AD'
										,TE.ACIKLAMA								AS 'ACIKLAMA'
										,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
										,T.RENK										AS 'RENK'
										,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
										,TE.ID_TAKVIM								AS 'ID_TAKVIM'
										,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = TY.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									AND ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
									AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + O.BASLIK + ')' ELSE D.DERSAD + ' - (' + O.BASLIK + ')' END AS AD
										,'#0000FF' AS RENK
										,CASE WHEN O.ID_ODEVTUR = 5 THEN OSO.TCKIMLIKNO ELSE '0' END AS TC_OGRENCI
								FROM OdevSinifOgrenci					OSO
								INNER JOIN	OdevSinif					OS		ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev						O		ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders			D		ON D.ID_DERS = O.ID_DERS
								INNER JOIN	OkyanusDB.dbo.v3Kullanici	K		ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci		OG		ON OG.TCKIMLIKNO = @TCKIMLIKNO
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF=1
								AND (OSO.TCKIMLIKNO = @TCKIMLIKNO OR OSO.TCKIMLIKNO IN (SELECT TCKIMLIKNO_OGR FROM OkyanusDB.dbo.v3OgrenciVeli WHERE TCKIMLIKNO = @TCKIMLIKNO))
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + E.ETUT + ')' 
										ELSE D.DERSAD + ' - (' + E.ETUT + ')' 
									END AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E
								INNER JOIN	EtutOgrenci				EO	ON	EO.ID_ETUT		= E.ID_ETUT
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= EO.TC_OGRENCI
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci	OG	ON	OG.TCKIMLIKNO	= @TCKIMLIKNO
								WHERE	EO.TC_OGRENCI	= @TCKIMLIKNO
									AND EO.AKTIF		= 1
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				DROP TABLE #DateList
			END		

			IF @ISLEM = 13	--	TAKVİM ETKİNLİK EKLE EXCEL
			BEGIN
				INSERT INTO TakvimEtkinlik (ID_TAKVIM, AD, ACIKLAMA, BAS_TARIH, BIT_TARIH, KYE_TCKIMLIKNO)
				SELECT @ID_TAKVIM, AD, ACIKLAMA, BASLANGIC, BITIS, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
				WITH(
					AD VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					BASLANGIC VARCHAR(MAX),
					BITIS VARCHAR(MAX)
				)
			END	
			IF @ISLEM = 14 -- TATİL LİSTELE
			BEGIN
				SELECT 
					 ADI
					,CONVERT(VARCHAR, BASLANGIC_TARIH, 104)	AS BASLANGIC_TARIH
					,CONVERT(VARCHAR, BITIS_TARIH, 104)		AS BITIS_TARIH 
				FROM Tatil 
				ORDER BY BASLANGIC_TARIH 			
			END 
			IF @ISLEM = 15 --TATİL EKLE
			BEGIN
				INSERT INTO Tatil (ADI,BASLANGIC_TARIH,BITIS_TARIH) 
				VALUES(@AD,@BAS_TARIH,@BIT_TARIH)
			END
		END
	END TRY
	BEGIN CATCH			
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = ERROR_MESSAGE()
			
		RAISERROR (	
					@MSG, 
					@ErrorSeverity, 
					@ErrorState
				  );
	END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_UpgradeSoru]...';


GO
ALTER procedure [dbo].[sp_UpgradeSoru]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@ID_TKTYASARALIGI			INT				= NULL,
	@ID_TKTKATEGORI				INT				= NULL,
	@ID_TKTPUAN					INT				= NULL,
	@ID_TKTSORU					INT				= NULL,
	@YASAY						TINYINT			= NULL,
	@ID_SUBE					INT				= NULL,
	@ID_SINAVGRUP				TINYINT			= NULL,
	@ID_SINIF					INT				= NULL,
	@TCKIMLIKNO_OGR				VARCHAR(11)		= NULL,
	@ID_TKTSINAV				INT				= NULL,
	@ID_TKTSINAVORTALAMALIST	VARCHAR(MAX)	= NULL,
	@ID_TKTTEST					INT				= NULL,
	@ID_TKTDONEM				INT				= NULL,
	@ID_TKTDONEMS				NVARCHAR(MAX)	= NULL,
	@ID_SINIFS					NVARCHAR(MAX)	= '[]',
	@ID_SATISTURU				INT				= NULL,
	@SQLJSON					NVARCHAR(MAX)	= NULL,	
	@DONEM						VARCHAR(4)		= NULL,
	@TARIH						VARCHAR(MAX)	= NULL,
	@HESAPTURU					BIT				= NULL,
	@BASLANGIC					VARCHAR(MAX)	= NULL,
	@BITIS						VARCHAR(MAX)	= NULL,
	@HESAPTURUSORU				BIT				= NULL,
	@KAZANIMADEDI				INT				= NULL,
	@ID_SUBES					VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUPS				VARCHAR(MAX)	= NULL,
	@TUR                        VARCHAR(20)     =NULL,
    @SAYI					    int			= NULL
AS
BEGIN

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		DECLARE @ID_ST			INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
		IF @return_variable = 1
		BEGIN
			IF @ISLEM = 1	--	Yaş Aralığı Listele
			BEGIN
				SELECT ID_TKTYASARALIGI, YASAY1, YASAY2
				FROM UpgradeYasAraligi
				WHERE AKTIF=1
			END

			IF @ISLEM = 2	--	Kategori Listele (Puan Tablosunda Yaş Aralığı Bulunan Kategoriler)
			BEGIN
				SELECT ID_TKTKATEGORI, AD FROM [dbo].[UpgradeKategori]
			END

			IF @ISLEM = 3	--	Puan Aralığı Listele (Puan Tablosunda Yaş Aralığı ve Kategoriye Göre)
			BEGIN
				SELECT ID_TKTPUAN, HARF,
					   SEVIYE = (CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END)
				FROM UpgradePuanTek
				WHERE (@ID_TKTKATEGORI IS NULL OR ID_TKTKATEGORI = @ID_TKTKATEGORI)
				ORDER BY HARF
			END

			IF @ISLEM = 4	--	Soru Ekle
			BEGIN
				IF NOT EXISTS (SELECT Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null))
				BEGIN
					RAISERROR ('Dönem seçimi zorunludur!' , -- Message text.
						16, -- Severity.
						1 -- State.
						);
				END
				ELSE
				BEGIN
					INSERT INTO UpgradeSoru(ID_TKTPUAN, KYE_KULLANICI, ID_SATISTURU, KAZANIMADEDI) VALUES(@ID_TKTPUAN, @TCKIMLIKNO, @ID_SATISTURU, @KAZANIMADEDI)
					SET @ID_TKTSORU=@@IDENTITY

					INSERT INTO UPGRADESORUDONEM (ID_TKTSORU,ID_TKTDONEM)
					((SELECT @ID_TKTSORU,Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null) ) )
						
					SELECT @ID_TKTSORU
				END
			END

			IF @ISLEM = 5	--	Soru Listele
			BEGIN
					SELECT	DISTINCT
							 S.[ID_TKTSORU]
							,S.[ID_TKTPUAN]
							,S.[ID_TKTKATEGORI]
							,S.[KATEGORIAD]
							,S.[ID_SATISTURU]
							,S.[HARF]
							,(CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END) as SEVIYE
							,(SELECT CASE WHEN GRUP='Ü.Z İLKOKUL' THEN ACIKLAMA+ ' (ÜSTÜN)' ELSE ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru WHERE ID_SATISTURU=S.ID_SATISTURU) as GRUP
							,S.[DOSYAAD]
							,S.[DOSYAUZANTI]
							,S.[KYE_KULLANICI]
							,S.[KYE_TARIH]
							,S.[KAZANIMADEDI]
							,STUFF((SELECT ',' + DONEM 
								FROM [vw_UpgradeSoru]
								where [ID_TKTSORU]=S.[ID_TKTSORU] and [ID_SATISTURU]=S.[ID_SATISTURU]
								FOR XML PATH('')) ,1,1,'') as DONEM
					FROM [vw_UpgradeSoru]	S
					WHERE	(@ID_TKTKATEGORI IS NULL	OR @ID_TKTKATEGORI = 0		OR ID_TKTKATEGORI=@ID_TKTKATEGORI) AND
							(@ID_SATISTURU IS NULL		OR @ID_SATISTURU = 0		OR ID_SATISTURU=@ID_SATISTURU) AND
							(@ID_TKTPUAN IS NULL		OR @ID_TKTPUAN = 0			OR ID_TKTPUAN=@ID_TKTPUAN) AND
							(@HESAPTURU = 0 
							OR @BASLANGIC IS NULL 
							OR @BITIS IS NULL 
							OR (
								CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
								AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)))
					GROUP BY S.[ID_TKTSORU]
							,S.[ID_TKTPUAN]
							,S.[ID_TKTKATEGORI]
							,S.[KATEGORIAD]
							,S.[ID_SATISTURU]
							,S.[HARF]
							,S.[DOSYAAD]
							,S.[DOSYAUZANTI]
							,S.[KYE_KULLANICI]
							,S.[KYE_TARIH]
							,S.DONEM 
							,S.[KAZANIMADEDI]
  	
			END

			IF @ISLEM = 6	--	Soru Sil
			BEGIN
				BEGIN TRY
					DELETE FROM UpgradeSoruDonem WHERE ID_TKTSORU=@ID_TKTSORU
					DELETE FROM UpgradeSoru WHERE ID_TKTSORU=@ID_TKTSORU
					DECLARE @ID_DOKUMANTEMP INT = (SELECT ID_DOKUMAN FROM DokumanDetay WHERE ID = @ID_TKTSORU)	
					DELETE DD 
					FROM DokumanDetay DD
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE DD.ID = @ID_TKTSORU AND D.ID_DOKUMANTUR=1
					DELETE FROM Dokuman WHERE ID_DOKUMAN = @ID_DOKUMANTEMP AND ID_DOKUMANTUR=1
				END TRY
				BEGIN CATCH
					SELECT 
						@ErrorSeverity	= ERROR_SEVERITY(),
						@ErrorState		= ERROR_STATE()
			
					RAISERROR ('Bu soru öğrenci sınavlarında kullanıldığı için silinemedi.' , -- Message text.
								@ErrorSeverity, -- Severity.
								@ErrorState -- State.
								);
				END CATCH;
			END

			IF @ISLEM = 7	--	Sınav Listele
			BEGIN
				SELECT ID_TKTSINAV, SINAVAD FROM UpgradeSinav WHERE ID_TKTSINAV < @ID_TKTSINAV OR @ID_TKTSINAV IS NULL ORDER BY ID_TKTSINAV ASC
			END

			IF @ISLEM = 8	--	Öğrenci Kategori ve Puan Listele (Puan Girişi Modal)
			BEGIN

				SELECT DISTINCT 
					P.ID_TKTKATEGORI, 
					P.AD,
					PUAN = ISNULL((SELECT PUAN FROM UpgradeOgrenciPuanDetay WHERE ID_TKTKATEGORI=P.ID_TKTKATEGORI AND ID_TKTOGRENCIPUAN=(SELECT ID_TKTOGRENCIPUAN FROM UpgradeOgrenciPuan WHERE TCKIMLIKNO=@TCKIMLIKNO_OGR AND ID_TKTSINAV=@ID_TKTSINAV)),0)
				FROM vw_UpgradePuan P
				WHERE
					 --P.ID_SINAVGRUP=@ID_SINAVGRUP AND 
					  --(@YASYIL BETWEEN P.YASYIL1 AND P.YASYIL2) AND
					  (@YASAY BETWEEN P.YASAY1 AND P.YASAY2)  
				ORDER BY P.ID_TKTKATEGORI ASC

			END

			IF @ISLEM = 9	--	Puan Kaydet
			BEGIN

				--Daha Önce Tanımlandıysa ID Hafızaya Al
				DECLARE @ID_TKTOGRENCIPUAN INT
				SELECT @ID_TKTOGRENCIPUAN=ID_TKTOGRENCIPUAN FROM UpgradeOgrenciPuan WHERE TCKIMLIKNO=@TCKIMLIKNO_OGR AND ID_TKTSINAV=@ID_TKTSINAV
			
				--Önce Sil
				DELETE FROM UpgradeOgrenciPuanDetay WHERE ID_TKTOGRENCIPUAN=@ID_TKTOGRENCIPUAN
				DELETE FROM UpgradeOgrenciPuan WHERE ID_TKTOGRENCIPUAN=@ID_TKTOGRENCIPUAN
			
				--Sonra Ekle
				INSERT INTO UpgradeOgrenciPuan (ID_TKTSINAV, TCKIMLIKNO, KYE_KULLANICI, KYE_TARIH)
				VALUES (@ID_TKTSINAV, @TCKIMLIKNO_OGR, @TCKIMLIKNO, GETDATE())

				SET @ID_TKTOGRENCIPUAN = @@IDENTITY				
				INSERT INTO UpgradeOgrenciPuanDetay (ID_TKTOGRENCIPUAN, ID_TKTKATEGORI, PUAN)
				SELECT @ID_TKTOGRENCIPUAN, ID_TKTKATEGORI, PUAN FROM OPENJSON (@SQLJSON, '$.KATEGORIPUAN_LISTESI')
				WITH  (ID_TKTKATEGORI INT, PUAN int ) 

			END

			IF @ISLEM = 10	--	Tkt Öğrenci Karne Getir
			BEGIN	
				SELECT DISTINCT O.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, SU.AD AS SUBEAD, SAT.ID_SATISTURU, SGS.ID_KADEME3
				INTO #TMP_OGRENCIBILGI
				FROM	   [dbo].[v3OgrenciTum]			O
				INNER JOIN [dbo].[v3Satislar]			SAT	ON SAT.ID_SOZLESME = O.ID_SOZLESME AND SAT.ID_SINIF IS NOT NULL
				INNER JOIN [dbo].[v3SubeGrupSinifTum]	SGS	ON SGS.ID_SINIF = SAT.ID_SINIF
				INNER JOIN [dbo].[v3SatisTuru]			ST	ON ST.ID_SATISTURU = SAT.ID_SATISTURU
				INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.TCKIMLIKNO = O.TCKIMLIKNO AND SY.XBASE=1
				INNER JOIN [dbo].[v3Kullanici]			K	ON k.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN [dbo].[v3Sube]				SU	ON SU.ID_SUBE = SY.ID_SUBE
				WHERE 
					(@TCKIMLIKNO_OGR IS NULL OR @TCKIMLIKNO_OGR = '0' OR O.TCKIMLIKNO = @TCKIMLIKNO_OGR) 
				AND	(@ID_SINIFS IS NULL OR @ID_SINIFS = '[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFS)))
				AND	(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP = 0 OR ST.ID_KADEME3 = @ID_SINAVGRUP) 
				AND (@ID_SUBE IS NULL OR @ID_SUBE = 0 OR O.ID_SUBE = @ID_SUBE) 
				AND O.DONEM = @DONEM
				ORDER BY O.TCKIMLIKNO 
								
				SELECT os.TCKIMLIKNO, OB.ID_KADEME3, s.ID_TKTTEST, s.ID_KATEGORI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE os.SINAVTARIH END) AS SINAV_TARIH, CASE WHEN OB.ID_KADEME3 <> 4 AND OB.ID_KADEME3 <> 5 THEN SUM(CASE WHEN s.ID_TKTTEST = 2 THEN 2 ELSE 1 END) ELSE SUM(1) END AS PUAN
				INTO #TEMP
				FROM dbo.TKTOgrenciCevap AS oc 
				INNER JOIN dbo.TKTSoru AS s ON s.ID_TKTSORU = oc.ID_TKTSORU 
				INNER JOIN TKTOgrenciSinav os ON os.ID_TKTOGRENCISINAV = oc.ID_TKTOGRENCISINAV AND os.ID_TKTTEST = s.ID_TKTTEST
				INNER JOIN #TMP_OGRENCIBILGI OB ON OB.TCKIMLIKNO = os.TCKIMLIKNO
				WHERE (oc.OGRENCICEVAP = 1) AND os.DONEM = @DONEM
				GROUP BY os.TCKIMLIKNO, s.ID_KATEGORI, s.ID_TKTTEST, os.SINAVTARIH, OB.ID_KADEME3

				SELECT ktable.TCKIMLIKNO, ktable.ID_TKTTEST, ktable.ID_KATEGORI, ktable.SINAV_TARIH, ktable.PUAN, se.HARF
				INTO #TEMP2
				FROM #TEMP AS ktable 
				INNER JOIN v3Kullanici AS k ON k.TCKIMLIKNO = ktable.TCKIMLIKNO 
				LEFT JOIN UpgradeYasAraligi AS ya ON ya.YASAY1 <= DATEDIFF(MONTH, k.DOGUMTARIHI, ktable.SINAV_TARIH) - 1 AND ya.YASAY2 >= DATEDIFF(MONTH, k.DOGUMTARIHI, ktable.SINAV_TARIH) - 1 
				INNER JOIN UpgradePuan AS up ON up.ID_TKTKATEGORI = ktable.ID_KATEGORI AND up.ID_KADEME3 = (CASE WHEN ktable.ID_KADEME3 = 4 OR ktable.ID_KADEME3 = 5 THEN ktable.ID_KADEME3 ELSE 0 END) AND ((ktable.ID_KADEME3 = 4 OR ktable.ID_KADEME3 = 5) OR up.ID_TKTYASARALIGI = ya.ID_TKTYASARALIGI) AND up.PUAN1 <= ktable.PUAN AND up.PUAN2 >= ktable.PUAN 
				INNER JOIN TKTSeviye AS se ON se.HARF = up.HARF	

				CREATE TABLE #TOTALRESULTTABLE(ID_TKTSORU INT, TCKIMLIKNO VARCHAR(11), ADSOYAD VARCHAR(200), SUBEAD VARCHAR(200), DOSYAAD VARCHAR(200), DOSYAUZANTI VARCHAR(10), ID_TKTKATEGORI int); 
				DECLARE @TEMPTCKIMLIK VARCHAR(11) 
				--Toplu sınav kağıdıda oluşturulabilmesi için
				WHILE EXISTS(SELECT * FROM #TMP_OGRENCIBILGI)
				BEGIN
					SELECT TOP 1 @TEMPTCKIMLIK = TCKIMLIKNO	From #TMP_OGRENCIBILGI

					--SET @ID_ST = (	
					--						SELECT ST.ID_SATISTURU
					--						FROM OkyanusDB.dbo.v3OgrenciTum O
					--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
					--						WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND O.DONEM = @DONEM
					--					)

					IF EXISTS(	
								--SELECT * FROM UpgradeOgrenciSinav OS
								--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
								--WHERE TCKIMLIKNO=@TEMPTCKIMLIK AND ID_TKTSINAV=@ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
								SELECT * FROM UpgradeOgrenciSinavDonem OSD
								JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
								WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND ID_TKTSINAV = @ID_TKTSINAV AND DONEM = @DONEM
							)
					BEGIN
						--INSERT INTO #TOTALRESULTTABLE 
						--select DISTINCT OS.ID_TKTSORU, OS.TCKIMLIKNO, K.ADSOYAD, K.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI
						--from UpgradeOgrenciSinav OS 
						--WITH (NOLOCK)
						--INNER JOIN #TMP_OGRENCIBILGI K ON K.TCKIMLIKNO=OS.TCKIMLIKNO
						--INNER JOIN vw_UpgradeSoru S	ON S.ID_TKTSORU=OS.ID_TKTSORU 
						--WHERE OS.TCKIMLIKNO=@TEMPTCKIMLIK AND OS.ID_TKTSINAV=@ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST

						INSERT INTO #TOTALRESULTTABLE 
						SELECT DISTINCT OSDS.ID_TKTSORU, OSD.TCKIMLIKNO, K.ADSOYAD, K.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI
						FROM UpgradeOgrenciSinavDonem OSD 
						INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
						INNER JOIN #TMP_OGRENCIBILGI K ON K.TCKIMLIKNO = OSD.TCKIMLIKNO
						INNER JOIN vw_UpgradeSoru S	ON S.ID_TKTSORU = OSDS.ID_TKTSORU 
						WHERE OSD.TCKIMLIKNO = @TEMPTCKIMLIK AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					END
					ELSE
					BEGIN
						SELECT S.ID_TKTSORU, O.TCKIMLIKNO, O.ADSOYAD, O.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI, ID_TKTSINAV = @ID_TKTSINAV, S.AY 
						INTO #TMP_TKTOGRENCISINAV
						FROM vw_UpgradeSoru S
						INNER JOIN #TEMP2						OKP	ON OKP.ID_KATEGORI = S.ID_TKTKATEGORI
						INNER JOIN #TMP_OGRENCIBILGI			O	ON O.TCKIMLIKNO = OKP.TCKIMLIKNO 
						WHERE
						((@ID_TKTTEST < 4  AND OKP.ID_TKTTEST = @ID_TKTTEST) OR (@ID_TKTTEST = 4 AND OKP.ID_TKTTEST = (SELECT MAX(ID_TKTTEST) FROM #TEMP2 T WHERE T.TCKIMLIKNO = OKP.TCKIMLIKNO AND T.ID_KATEGORI = OKP.ID_KATEGORI)))
						AND (OKP.HARF = S.HARF)
						AND (S.ID_SATISTURU=O.ID_SATISTURU)
						AND (S.AY=DATEPART(month, GETDATE()))
						AND OKP.TCKIMLIKNO=@TEMPTCKIMLIK
						AND (
								@HESAPTURUSORU = 0 
								OR @BASLANGIC IS NULL 
								OR @BITIS IS NULL 
								OR (
										CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
										AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)
									)
							)
						ORDER BY OKP.TCKIMLIKNO 

						--SELECT ID_TKTSORU, TCKIMLIKNO, ADSOYAD, SUBEAD, DOSYAAD, DOSYAUZANTI, ID_TKTKATEGORI INTO #TMP_TKTOGRENCISINAV2 FROM #TMP_TKTOGRENCISINAV
						--WITH (NOLOCK) WHERE
						--(ID_TKTSORU NOT IN (SELECT ID_TKTSORU FROM UpgradeOgrenciSinav WHERE TCKIMLIKNO=@TEMPTCKIMLIK)) 
						--and ID_TKTSINAV=@ID_TKTSINAV

						SELECT ID_TKTSORU, TCKIMLIKNO, ADSOYAD, SUBEAD, DOSYAAD, DOSYAUZANTI, ID_TKTKATEGORI 
						INTO #TMP_TKTOGRENCISINAV2 
						FROM #TMP_TKTOGRENCISINAV
						WITH (NOLOCK) WHERE
						(ID_TKTSORU NOT IN (SELECT ID_TKTSORU FROM UpgradeOgrenciSinavDonem OSD JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSD.DONEM = @DONEM)) 
						and ID_TKTSINAV = @ID_TKTSINAV
						--Eskiden sorulmuş sorular sorulmasın 
		
						--KATEGORILER OGRENCI PUANINA GORE SIRALANIYOR
						CREATE TABLE #SIRALAMA (KategoriRow INT, ID_TKTKATEGORI INT)
						IF @ID_TKTTEST = 4 AND @ID_TKTSINAVORTALAMALIST IS NOT NULL
						BEGIN
							INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
							SELECT		ROW_NUMBER() OVER(ORDER BY CAST((CAST(SUM(OSDS.DOGRUKAZANIMADEDI) AS decimal(18, 2)) / CAST(SUM(S.KAZANIMADEDI) AS decimal(18, 2)) * 100.0) AS decimal(18, 2)) asc) AS 'KategoriRow',
										S.ID_TKTKATEGORI
							FROM UpgradeOgrenciSinavDonem OSD
							JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							JOIN vw_UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
							WHERE OSD.TCKIMLIKNO = @TEMPTCKIMLIK AND OSD.DONEM = @DONEM AND OSDS.DOGRUKAZANIMADEDI IS NOT NULL AND S.KAZANIMADEDI IS NOT NULL AND OSD.ID_TKTSINAV IN (SELECT VALUE FROM OPENJSON(@ID_TKTSINAVORTALAMALIST))
							GROUP BY OSD.TCKIMLIKNO, S.ID_TKTKATEGORI, S.KATEGORIAD

							IF (SELECT COUNT(*) FROM #SIRALAMA) = 0 -- ORTALAMA YOK İSE ÖN TESTE GÖRE
							BEGIN
								INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
								SELECT ROW_NUMBER() OVER(ORDER BY PUAN asc) AS 'KategoriRow', ID_KATEGORI AS ID_TKTKATEGORI
								FROM vw_OgrenciKategoriPuan
								WITH (NOLOCK)
								WHERE TCKIMLIKNO=@TEMPTCKIMLIK and ID_TKTTEST = 1 and (@DONEM IS NULL OR DONEM = @DONEM)
							END
						END
						ELSE
						BEGIN
							INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
							SELECT ROW_NUMBER() OVER(ORDER BY PUAN asc) AS 'KategoriRow', ID_KATEGORI AS ID_TKTKATEGORI
							FROM vw_OgrenciKategoriPuan
							WITH (NOLOCK)
							WHERE TCKIMLIKNO=@TEMPTCKIMLIK and ID_TKTTEST = @ID_TKTTEST and (@DONEM IS NULL OR DONEM = @DONEM)
						END						

						--OGRENCININ PUANINA GORE TERS ORANTILI KATEGORIDEN 4,3,2,1 TOPLAM 10 SORU GETIR
						DECLARE @ID_TKTKATEGORIx INT	=	0
						DECLARE @ROWNUMBER		 INT	=	0
						CREATE TABLE #RESULTTABLE(ID_TKTSORU INT, TCKIMLIKNO VARCHAR(11), ADSOYAD VARCHAR(200), SUBEAD VARCHAR(200), DOSYAAD VARCHAR(200), DOSYAUZANTI VARCHAR(10), ID_TKTKATEGORI INT); 
						WHILE EXISTS(SELECT * FROM #SIRALAMA)
						BEGIN
							SELECT TOP 1 @ID_TKTKATEGORIx	=	ID_TKTKATEGORI	FROM #SIRALAMA
							SELECT TOP 1 @ROWNUMBER			=	KategoriRow		FROM #SIRALAMA
							INSERT INTO #RESULTTABLE SELECT TOP (5 - @ROWNUMBER) * FROM #TMP_TKTOGRENCISINAV2 WHERE ID_TKTKATEGORI = @ID_TKTKATEGORIx		
							DELETE #SIRALAMA WHERE ID_TKTKATEGORI = @ID_TKTKATEGORIx
						END
						DROP TABLE #SIRALAMA
		
						--Gelecekte aynı soruyla sınav oluşturmamak için TktOgrenciSinav tablosuna kaydediyoruz
						--INSERT INTO UpgradeOgrenciSinav(TCKIMLIKNO, ID_TKTSORU, ID_TKTSINAV, KYE_KULLANICI, KYE_TARIH)
						--SELECT TS.TCKIMLIKNO, TS.ID_TKTSORU, @ID_TKTSINAV, @TCKIMLIKNO, GETDATE() FROM #RESULTTABLE TS
						--WITH (NOLOCK)
						--WHERE NOT EXISTS (SELECT * FROM UpgradeOgrenciSinav WHERE TCKIMLIKNO=TS.TCKIMLIKNO AND ID_TKTSORU=TS.ID_TKTSORU)
						
						IF (SELECT COUNT(*) FROM #RESULTTABLE) = 0 -- BILGI YOK ISE
						BEGIN
							PRINT 1
						END
						ELSE
						BEGIN
							DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
							WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND ID_TKTSINAV = @ID_TKTSINAV AND DONEM = @DONEM

							DECLARE @IDTABLE TABLE (ID INT)
							INSERT INTO UpgradeOgrenciSinavDonem (TCKIMLIKNO, ID_TKTSINAV, ID_TKTTEST, DONEM, KYE_KULLANICI, KYE_TARIH)
							OUTPUT inserted.ID_UPGRADEOGRENCISINAVDONEM INTO @IDTABLE
							SELECT DISTINCT TCKIMLIKNO, @ID_TKTSINAV, @ID_TKTTEST, @DONEM, @TCKIMLIKNO, GETDATE() 
							FROM #RESULTTABLE R 
							WHERE NOT EXISTS (
												SELECT ID_TKTSORU 
												FROM UpgradeOgrenciSinavDonem OSD 
												JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM 
												WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSDS.ID_TKTSORU = R.ID_TKTSORU AND OSD.DONEM = @DONEM
											)

							DECLARE @ID INT 
							SELECT @ID = ID FROM @IDTABLE

							INSERT INTO UpgradeOgrenciSinavDonemSoru(ID_UPGRADEOGRENCISINAVDONEM, ID_TKTSORU)
							SELECT @ID, R.ID_TKTSORU
							FROM #RESULTTABLE R 
							WHERE NOT EXISTS (
												SELECT ID_TKTSORU 
												FROM UpgradeOgrenciSinavDonem OSD 
												JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM 
												WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSDS.ID_TKTSORU = R.ID_TKTSORU AND OSD.DONEM = @DONEM
											)

							IF @ID_TKTSINAVORTALAMALIST IS NOT NULL
							BEGIN
								INSERT INTO UpgradeOgrenciSinavDonemEtkinlik (ID_UPGRADEOGRENCISINAVDONEM, ID_TKTSINAV)
								SELECT @ID, VALUE FROM OPENJSON(@ID_TKTSINAVORTALAMALIST) WHERE VALUE <> 0
							END
						
							INSERT INTO #TOTALRESULTTABLE SELECT * FROM #RESULTTABLE
						END
				
						DROP TABLE #RESULTTABLE
						DROP TABLE #TMP_TKTOGRENCISINAV2
						DROP TABLE #TMP_TKTOGRENCISINAV
					END				
			
					DELETE #TMP_OGRENCIBILGI WHERE TCKIMLIKNO = @TEMPTCKIMLIK
				END
				SET @SAYI = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TOTALRESULTTABLE)
				IF @SAYI>1
				BEGIN
				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT DISTINCT  @TCKIMLIKNO, TC.TCKIMLIKNO,'TOPLU EKLENDİ',GETDATE() FROM #TOTALRESULTTABLE AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				END
			    IF @SAYI =1
				BEGIN
				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT  DISTINCT  @TCKIMLIKNO, TC.TCKIMLIKNO,'EKLENDİ',GETDATE() FROM #TOTALRESULTTABLE AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				END
				
				DROP TABLE #TMP_OGRENCIBILGI
				
				SELECT t.TCKIMLIKNO, t.ADSOYAD, t.SUBEAD, t.DOSYAAD, t.DOSYAUZANTI ,s.AD SINIF, ROW_NUMBER() OVER(PARTITION BY t.TCKIMLIKNO ORDER BY t.TCKIMLIKNO, t.ID_TKTSORU) AS SIRA
				FROM #TOTALRESULTTABLE t
				JOIN v3OgrenciTum	o ON o.TCKIMLIKNO=t.TCKIMLIKNO
				JOIN v3SinifTum		s ON s.ID_SINIF=o.ID_SINIF
				WHERE o.DONEM = @DONEM
				ORDER BY t.TCKIMLIKNO, t.ID_TKTSORU
			
				DROP TABLE #TOTALRESULTTABLE
				DROP TABLE #TEMP2
				DROP TABLE #TEMP
			END

			IF @ISLEM = 11	--	Tkt Donem Getir
			BEGIN
				SELECT * FROM UpgradeDonem
			END

			IF @ISLEM = 12	--	Tkt Doneme Göre Sınav Getir
			BEGIN
				SELECT	DISTINCT
						 S.[ID_TKTSORU]
						,S.[ID_TKTPUAN]
						,S.[ID_TKTKATEGORI]
						,S.[KATEGORIAD]
						,S.[ID_SATISTURU]
						,S.[HARF]
						,(CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END) as SEVIYE
						,(SELECT CASE WHEN GRUP='Ü.Z İLKOKUL' THEN ACIKLAMA+ ' (ÜSTÜN)' ELSE ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru WHERE ID_SATISTURU=S.ID_SATISTURU) as GRUP
						,S.[DOSYAAD]
						,S.[DOSYAUZANTI]
						,S.[KYE_KULLANICI]
						,S.[KYE_TARIH]
						,STUFF((SELECT ',' + DONEM 
							FROM [vw_UpgradeSoru]
							where [ID_TKTSORU]=S.[ID_TKTSORU] and [ID_SATISTURU]=S.[ID_SATISTURU]
							FOR XML PATH('')) ,1,1,'') as DONEM
				FROM [vw_UpgradeSoru]	S
				JOIN UpgradeSoruDonem	SD	ON SD.ID_TKTSORU=S.ID_TKTSORU
				WHERE 
						(@ID_TKTDONEMS		IS NULL		OR @ID_TKTDONEMS = ''		OR SD.ID_TKTDONEM IN ((SELECT Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null))) ) 
					AND (@ID_TKTKATEGORI	IS NULL		OR @ID_TKTKATEGORI = 0		OR S.ID_TKTKATEGORI=@ID_TKTKATEGORI) 
					AND	(@ID_SATISTURU		IS NULL		OR @ID_SATISTURU = 0		OR S.ID_SATISTURU=@ID_SATISTURU) 
					AND	(@ID_TKTPUAN		IS NULL		OR @ID_TKTPUAN = 0			OR S.ID_TKTPUAN=@ID_TKTPUAN)
				GROUP BY S.[ID_TKTSORU]
						,S.[ID_TKTPUAN]
						,S.[ID_TKTKATEGORI]
						,S.[KATEGORIAD]
						,S.[ID_SATISTURU]
						,S.[HARF]
						,S.[DOSYAAD]
						,S.[DOSYAUZANTI]
						,S.[KYE_KULLANICI]
						,S.[KYE_TARIH]
						,S.DONEM 
			END

			IF @ISLEM = 13	--	Upgrade Grup Getir
			BEGIN
				SELECT DISTINCT st.ID_SATISTURU, CASE WHEN st.GRUP='Ü.Z İLKOKUL' THEN st.ACIKLAMA+ ' (ÜSTÜN)' ELSE st.ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru st
				INNER JOIN v3Kademe k ON k.ID_KADEME=st.ID_KADEME
				WHERE k.ID_KADEME in (2,3)
			END

			IF @ISLEM = 14	--	Upgrade Soru Sayıları getir
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT
							(SELECT AD FROM TKTSeviye ORDER BY ID_TKTSeviye DESC FOR JSON PATH) AS SEVIYE
									
							,(SELECT AD FROM UpgradeKategori FOR JSON PATH) AS KATEGORI

							,(SELECT TS.AD AS SEVIYE, UK.AD AS KATEGORI, COUNT(SD.ID_TKTSORUDONEM) AS SAYI
							FROM TKTSeviye TS
							INNER JOIN UpgradePuanTek UP ON UP.HARF=TS.HARF
							INNER JOIN UpgradeKategori UK ON UK.ID_TKTKATEGORI=UP.ID_TKTKATEGORI
							LEFT JOIN UpgradeSoru S ON S.ID_TKTPUAN=UP.ID_TKTPUAN AND S.ID_SATISTURU = @ID_SATISTURU AND
														(@HESAPTURU = 0 
														OR @BASLANGIC IS NULL 
														OR @BITIS IS NULL 
														OR (
															CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
															AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)))
							LEFT JOIN UpgradeSoruDonem SD ON SD.ID_TKTSORU=S.ID_TKTSORU AND SD.ID_TKTDONEM = @ID_TKTDONEM
							WHERE UK.AKTIF = 1
							GROUP BY TS.AD, UK.AD, TS.ID_TKTSeviye, UK.ID_TKTKATEGORI
							ORDER BY TS.ID_TKTSeviye DESC, UK.ID_TKTKATEGORI
							FOR JSON PATH) AS SONUC					
					) AS SUBTABLE FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 15	--	Sınav Kağıdı Sil
			BEGIN
				--DELETE OS FROM UpgradeOgrenciSinav OS
				--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
				--INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				--WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND ST.ID_KADEME3 = @ID_SINAVGRUP

				DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
				WHERE OSD.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
			
				INSERT INTO EtkinlikKagidiOlusturLog (KIM,KIME,ISLEM,TARIH) VALUES (@TCKIMLIKNO,@TCKIMLIKNO_OGR,@TUR,@TARIH)
				
			END

			IF @ISLEM = 16	--	Sınav Kağıdı Sil Toplu
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, SGS.ID_KADEME3
				INTO #TMP_OGRENCIBILGISIL
				FROM	   [dbo].[v3OgrenciTum]			O
				INNER JOIN [dbo].[v3SubeGrupSinifTum]	SGS	ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN [dbo].[v3Satislar]			SAT	ON SAT.ID_SOZLESME = O.ID_SOZLESME
				INNER JOIN [dbo].[v3SatisTuru]			ST	ON ST.ID_SATISTURU = SAT.ID_SATISTURU
				INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.TCKIMLIKNO = O.TCKIMLIKNO AND SY.XBASE=1
				INNER JOIN [dbo].[v3Kullanici]			K	ON k.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN [dbo].[v3Sube]				SU	ON SU.ID_SUBE = SY.ID_SUBE
				WHERE 
					(@ID_SINIFS IS NULL OR @ID_SINIFS = '[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFS)))
				AND	(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP = 0 OR ST.ID_KADEME3 = @ID_SINAVGRUP) 
				AND (@ID_SUBE IS NULL OR @ID_SUBE = 0 OR O.ID_SUBE = @ID_SUBE) 
				AND O.DONEM = @DONEM

				--DELETE OS FROM UpgradeOgrenciSinav OS
				--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
				--INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				--INNER JOIN #TMP_OGRENCIBILGISIL OBS ON OBS.TCKIMLIKNO = OS.TCKIMLIKNO AND OBS.ID_KADEME3= ST.ID_KADEME3
				--WHERE ID_TKTSINAV = @ID_TKTSINAV

				DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
				JOIN #TMP_OGRENCIBILGISIL O ON O.TCKIMLIKNO = OSD.TCKIMLIKNO
				WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM

				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT  @TCKIMLIKNO, TC.TCKIMLIKNO,@TUR,@TARIH FROM #TMP_OGRENCIBILGISIL AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				DROP TABLE #TMP_OGRENCIBILGISIL
			END

			IF @ISLEM = 17	--	Soru Kazanım Adedi Güncelle
			BEGIN
				UPDATE UpgradeSoru SET KAZANIMADEDI = @KAZANIMADEDI WHERE ID_TKTSORU = @ID_TKTSORU 
			END

			IF @ISLEM = 18	--	Öğrenci Soru Listele
			BEGIN
				--SET @ID_ST = (	
				--						SELECT ST.ID_SATISTURU
				--						FROM OkyanusDB.dbo.v3OgrenciTum O
				--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
				--						WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND O.DONEM = @DONEM
				--					)

				SELECT
				(
					--SELECT ROW_NUMBER() OVER(ORDER BY OS.ID_TKTSORU) AS SORUNO, OS.ID_TKTOGRENCISINAV, K.AD AS KATEGORI, S.KAZANIMADEDI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 0 ELSE 1 END AS ISDISABLED, OS.DOGRUKAZANIMADEDI, P.HARF, 'https://pusulam.okyanuskoleji.k12.tr/Dosyalar/' + D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM
					--FROM UpgradeOgrenciSinav OS
					--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
					--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					--INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					--INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					--WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
					--ORDER BY OS.ID_TKTSORU

					SELECT ROW_NUMBER() OVER(ORDER BY OSDS.ID_TKTSORU) AS SORUNO, OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU, K.AD AS KATEGORI, S.KAZANIMADEDI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 0 ELSE 1 END AS ISDISABLED, OSDS.DOGRUKAZANIMADEDI, P.HARF, 'https://pusulam.okyanuskoleji.k12.tr/Dosyalar/' + D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM
					FROM UpgradeOgrenciSinavDonem OSD
					JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
					INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
					INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					ORDER BY OSDS.ID_TKTSORU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 19	--	Öğrenci Soru Puan Kaydet
			BEGIN
				--UPDATE OS SET OS.DOGRUKAZANIMADEDI = J.DOGRUKAZANIMADEDI 
				--FROM UpgradeOgrenciSinav OS
				--INNER JOIN OPENJSON(@SQLJSON)
				--WITH(
				--	ID_TKTOGRENCISINAV INT,
				--	KAZANIMADEDI INT,
				--	DOGRUKAZANIMADEDI INT
				--) AS J ON J.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV

				UPDATE OSDS SET OSDS.DOGRUKAZANIMADEDI = J.DOGRUKAZANIMADEDI 
				FROM UpgradeOgrenciSinavDonemSoru OSDS
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_UPGRADEOGRENCISINAVDONEMSORU INT,
					KAZANIMADEDI INT,
					DOGRUKAZANIMADEDI INT
				) AS J ON J.ID_UPGRADEOGRENCISINAVDONEMSORU = OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU

				--UPDATE S SET S.KAZANIMADEDI = J.KAZANIMADEDI 
				--FROM UpgradeSoru S
				--INNER JOIN UpgradeOgrenciSinav OS ON OS.ID_TKTSORU = S.ID_TKTSORU
				--INNER JOIN OPENJSON(@SQLJSON)
				--WITH(
				--	ID_TKTOGRENCISINAV INT,
				--	KAZANIMADEDI INT,
				--	DOGRUKAZANIMADEDI INT
				--) AS J ON J.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV
				--WHERE S.KAZANIMADEDI IS NULL

				UPDATE S SET S.KAZANIMADEDI = J.KAZANIMADEDI 
				FROM UpgradeSoru S
				INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_TKTSORU = S.ID_TKTSORU
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_UPGRADEOGRENCISINAVDONEMSORU INT,
					KAZANIMADEDI INT,
					DOGRUKAZANIMADEDI INT
				) AS J ON J.ID_UPGRADEOGRENCISINAVDONEMSORU = OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU
				WHERE S.KAZANIMADEDI IS NULL
			END

			IF @ISLEM = 20	--	Öğrenci Sonuç Listele
			BEGIN
				--SET @ID_ST = (	
				--						SELECT ST.ID_SATISTURU
				--						FROM OkyanusDB.dbo.v3OgrenciTum O
				--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
				--						WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND O.DONEM = @DONEM
				--					)

				SELECT
				(
					--SELECT ROW_NUMBER() OVER(ORDER BY OS.ID_TKTSORU) AS SORUNO, D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM, OS.ID_TKTOGRENCISINAV, K.AD AS KATEGORI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(S.KAZANIMADEDI AS VARCHAR) END AS KAZANIMADEDI, CASE WHEN OS.DOGRUKAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(OS.DOGRUKAZANIMADEDI AS VARCHAR) END AS DOGRUKAZANIMADEDI
					--FROM UpgradeOgrenciSinav OS
					--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
					--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					--INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					--INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					--WHERE OS.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OS.ID_TKTSINAV = @ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
					--ORDER BY OS.ID_TKTSORU

					SELECT ROW_NUMBER() OVER(ORDER BY OSDS.ID_TKTSORU) AS SORUNO, D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM, OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU, K.AD AS KATEGORI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(S.KAZANIMADEDI AS VARCHAR) END AS KAZANIMADEDI, CASE WHEN OSDS.DOGRUKAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(OSDS.DOGRUKAZANIMADEDI AS VARCHAR) END AS DOGRUKAZANIMADEDI
					FROM UpgradeOgrenciSinavDonem OSD
					INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
					INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
					INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE OSD.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					ORDER BY OSDS.ID_TKTSORU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 21	--	Toplu Sonuç Listele
			BEGIN
				SELECT O.TCKIMLIKNO, K.AD, K.SOYAD, SB.AD AS KAMPUS, K3.AD AS GRUP, SNF.AD AS SINIF, SAT.ID_SATISTURU, convert(varchar, K.DOGUMTARIHI, 104) as DOGUMTARIHI
				INTO #OGRENCI
				FROM OkyanusDB.dbo.v3OgrenciTum O
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = SGS.ID_KADEME3
				INNER JOIN OkyanusDB.dbo.v3Sinif SNF ON SNF.ID_SINIF = SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Satislar SAT ON SAT.ID_SOZLESME = O.ID_SOZLESME AND SAT.ID_DONEM = O.ID_DONEM
				WHERE O.DONEM = @DONEM		
					AND (@ID_SUBES		IS NULL OR @ID_SUBES='[]'		OR SGS.ID_SUBE		in (select value from openjson (@ID_SUBES)))
					AND (@ID_SINAVGRUPS IS NULL OR @ID_SINAVGRUPS='[]'	OR SGS.ID_KADEME3	in (select value from openjson (@ID_SINAVGRUPS)))
					AND (@ID_SINIFS		IS NULL OR @ID_SINIFS='[]'		OR SGS.ID_SINIF		in (select value from openjson (@ID_SINIFS)))
				ORDER BY O.TCKIMLIKNO

				SELECT TCKIMLIKNO, AD, SOYAD, KAMPUS, GRUP, SINIF, DOGUMTARIHI,
					MAX([1-DOGRUKAZANIMADEDI]) AS [1-DOGRUKAZANIMADEDI],
					MAX([2-DOGRUKAZANIMADEDI]) AS [2-DOGRUKAZANIMADEDI],
					MAX([3-DOGRUKAZANIMADEDI]) AS [3-DOGRUKAZANIMADEDI],
					MAX([4-DOGRUKAZANIMADEDI]) AS [4-DOGRUKAZANIMADEDI],
					MAX([5-DOGRUKAZANIMADEDI]) AS [5-DOGRUKAZANIMADEDI],
					MAX([6-DOGRUKAZANIMADEDI]) AS [6-DOGRUKAZANIMADEDI],
					MAX([7-DOGRUKAZANIMADEDI]) AS [7-DOGRUKAZANIMADEDI],
					MAX([8-DOGRUKAZANIMADEDI]) AS [8-DOGRUKAZANIMADEDI],
					MAX([9-DOGRUKAZANIMADEDI]) AS [9-DOGRUKAZANIMADEDI],
					MAX([10-DOGRUKAZANIMADEDI]) AS [10-DOGRUKAZANIMADEDI],
					MAX([1-KAZANIMADEDI]) AS [1-KAZANIMADEDI],
					MAX([2-KAZANIMADEDI]) AS [2-KAZANIMADEDI],
					MAX([3-KAZANIMADEDI]) AS [3-KAZANIMADEDI],
					MAX([4-KAZANIMADEDI]) AS [4-KAZANIMADEDI],
					MAX([5-KAZANIMADEDI]) AS [5-KAZANIMADEDI],
					MAX([6-KAZANIMADEDI]) AS [6-KAZANIMADEDI],
					MAX([7-KAZANIMADEDI]) AS [7-KAZANIMADEDI],
					MAX([8-KAZANIMADEDI]) AS [8-KAZANIMADEDI],
					MAX([9-KAZANIMADEDI]) AS [9-KAZANIMADEDI],
					MAX([10-KAZANIMADEDI]) AS [10-KAZANIMADEDI],
					MAX([1-KATEGORI]) AS [1-KATEGORI],
					MAX([2-KATEGORI]) AS [2-KATEGORI],
					MAX([3-KATEGORI]) AS [3-KATEGORI],
					MAX([4-KATEGORI]) AS [4-KATEGORI],
					MAX([5-KATEGORI]) AS [5-KATEGORI],
					MAX([6-KATEGORI]) AS [6-KATEGORI],
					MAX([7-KATEGORI]) AS [7-KATEGORI],
					MAX([8-KATEGORI]) AS [8-KATEGORI],
					MAX([9-KATEGORI]) AS [9-KATEGORI],
					MAX([10-KATEGORI]) AS [10-KATEGORI]
				FROM 
				( 
					SELECT * 
					FROM 
					( 
						SELECT * 
						FROM 
						( 
							--SELECT O.*, K.AD AS KATEGORI, ISNULL(CAST(S.KAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS KAZANIMADEDI, ISNULL(CAST(OS.DOGRUKAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS DOGRUKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-DOGRUKAZANIMADEDI ' AS SORUNODOGRUKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-KAZANIMADEDI ' AS SORUNOKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-KATEGORI ' AS SORUNOKATEGORI 
							--FROM #OGRENCI O
							--INNER JOIN UpgradeOgrenciSinav OS ON OS.TCKIMLIKNO = O.TCKIMLIKNO
							--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU AND S.ID_SATISTURU = O.ID_SATISTURU
							--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
							--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
							--WHERE OS.ID_TKTSINAV = @ID_TKTSINAV

							SELECT O.*, K.AD AS KATEGORI, ISNULL(CAST(S.KAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS KAZANIMADEDI, ISNULL(CAST(OSDS.DOGRUKAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS DOGRUKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-DOGRUKAZANIMADEDI ' AS SORUNODOGRUKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-KAZANIMADEDI ' AS SORUNOKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-KATEGORI ' AS SORUNOKATEGORI 
							FROM #OGRENCI O
							INNER JOIN UpgradeOgrenciSinavDonem OSD ON OSD.TCKIMLIKNO = O.TCKIMLIKNO
							INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU AND S.ID_SATISTURU = O.ID_SATISTURU
							INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
							INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
							WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
						) AS XTABLE 
						PIVOT 
						( 
							MAX(DOGRUKAZANIMADEDI) FOR SORUNODOGRUKAZANIMADEDI IN ([1-DOGRUKAZANIMADEDI],[2-DOGRUKAZANIMADEDI],[3-DOGRUKAZANIMADEDI],[4-DOGRUKAZANIMADEDI],[5-DOGRUKAZANIMADEDI],[6-DOGRUKAZANIMADEDI],[7-DOGRUKAZANIMADEDI],[8-DOGRUKAZANIMADEDI],[9-DOGRUKAZANIMADEDI],[10-DOGRUKAZANIMADEDI]) 
						) AS P_DOGRUKAZANIMADEDI
						)
					AS XTABLE 
					PIVOT 
					( 
						MAX(KAZANIMADEDI) FOR SORUNOKAZANIMADEDI IN ([1-KAZANIMADEDI],[2-KAZANIMADEDI],[3-KAZANIMADEDI],[4-KAZANIMADEDI],[5-KAZANIMADEDI],[6-KAZANIMADEDI],[7-KAZANIMADEDI],[8-KAZANIMADEDI],[9-KAZANIMADEDI],[10-KAZANIMADEDI]) 
					) AS P_KAZANIMADEDI
				)
				AS XTABLE 
				PIVOT 
				( 
					MAX(KATEGORI) FOR SORUNOKATEGORI IN ([1-KATEGORI],[2-KATEGORI],[3-KATEGORI],[4-KATEGORI],[5-KATEGORI],[6-KATEGORI],[7-KATEGORI],[8-KATEGORI],[9-KATEGORI],[10-KATEGORI]) 
				) AS P_KATEGORI
				GROUP BY TCKIMLIKNO, AD, SOYAD, KAMPUS, GRUP, SINIF, DOGUMTARIHI
				ORDER BY KAMPUS, GRUP, SINIF, AD, SOYAD

				DROP TABLE #OGRENCI
			END

			IF @ISLEM = 22	--	SORULARIN ÇÖZÜLME ORANLARI
			BEGIN
				SELECT S.ID_TKTSORU, S.DOSYAAD + '.' + S.DOSYAUZANTI AS DOSYA, (CASE WHEN S.HARF='A' THEN 'Üstün' WHEN S.HARF='B' THEN 'Ortanın Üstü' WHEN S.HARF='C' THEN 'Orta' WHEN S.HARF='D' THEN 'Ortanın Altı' WHEN S.HARF='E' THEN 'Desteklenmeli' END) AS PUANARALIGI, S.KAZANIMADEDI
				INTO #TEMPSORU
				FROM vw_UpgradeSoru S
				JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
				WHERE S.ID_SATISTURU = @ID_SATISTURU AND S.ID_TKTKATEGORI = @ID_TKTKATEGORI
				GROUP BY S.ID_TKTSORU, S.DOSYAAD, S.DOSYAUZANTI, S.KAZANIMADEDI, S.HARF

				SELECT ISNULL(
				(
					SELECT S.ID_TKTSORU, S.DOSYA, S.PUANARALIGI, S.KAZANIMADEDI, COUNT(*) AS OGRENCISAYISI, CONVERT (DECIMAL(5,2), (SUM(OS.DOGRUKAZANIMADEDI) * 100.0) / (S.KAZANIMADEDI * COUNT(*))) AS COZULMEORANI
					FROM #TEMPSORU S
					JOIN UpgradeOgrenciSinavDonemSoru OS ON OS.ID_TKTSORU = S.ID_TKTSORU
					JOIN UpgradeOgrenciSinavDonem O ON O.ID_UPGRADEOGRENCISINAVDONEM = OS.ID_UPGRADEOGRENCISINAVDONEM
					WHERE OS.DOGRUKAZANIMADEDI IS NOT NULL AND O.DONEM = @DONEM
					GROUP BY S.ID_TKTSORU, S.DOSYA, S.PUANARALIGI, S.KAZANIMADEDI
					ORDER BY S.ID_TKTSORU
					FOR JSON PATH
				), '[]')

				DROP TABLE #TEMPSORU
			END			
			
			IF @ISLEM = 23  -- UPGRADE ISLEM RAPOR LOG
			BEGIN
				SELECT KIM, KIME, ISLEM, TARIH = CONVERT(VARCHAR,TARIH, 104) +' '  + CONVERT(VARCHAR,TARIH, 108)
				FROM EtkinlikKagidiOlusturLog
				WHERE KIME = @TCKIMLIKNO_OGR
				ORDER BY TARIH DESC
			END
			
		END
	END TRY
	BEGIN CATCH			
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_VIU]...';


GO
ALTER procedure [dbo].[sp_VIU]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	
	@BASTARIH			VARCHAR(MAX)	= NULL,
	@BITTARIH			VARCHAR(MAX)	= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@TCOGRETMENLIST		VARCHAR(MAX)	= NULL,
	@ID_ARAMADURUMLIST	VARCHAR(MAX)	= NULL,
	@ID_ARAMASEBEPLIST	VARCHAR(MAX)	= NULL,
	@JSON				BIT				= NULL,
	@ID_SUBELER		    VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
									
				,BASTARIH			= @BASTARIH
				,BITTARIH			= @BITTARIH
				,ID_SUBELIST		= @ID_SUBELIST
				,TCOGRETMENLIST		= @TCOGRETMENLIST
				,ID_ARAMADURUMLIST	= @ID_ARAMADURUMLIST
				,ID_ARAMASEBEPLIST	= @ID_ARAMASEBEPLIST
				,[JSON]				= @JSON
				,ID_SUBELER		    = @ID_SUBELER
				,ID_SINIFLAR        = @ID_SINIFLAR
				,SQLJSON			= @SQLJSON
				,TC_OGRETMEN		= @TC_OGRETMEN
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @ID_LOG > 0
		BEGIN	
			IF @ISLEM = 1	--	VIU Rapor Mesaj
			BEGIN			
				SELECT
					 ACIKLAMA	=	B.AD + IIF(D.ID_DOKUMAN IS NOT NULL ,'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/'+ D.GUID ,'')
					,KYE_TARIH	=	CONVERT(VARCHAR(10), B.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), B.KYE_TARIH, 108)
					,GONDERENTC	=	KYE.TCKIMLIKNO
					,GONDEREN	=	KYE.AD  +' '+ KYE.SOYAD
					,KIME		=	KIME.AD +' '+ KIME.SOYAD
					,KIMICIN	=	KYI.AD  +' '+ KYI.SOYAD
					
					,GONDERENSUBE	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,GONDERENTIP	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMESUBE		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMETIP		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,RENK = IIF( IPTAL = 1 , 'Red' , 'Black' )
				FROM OkyanusIletisim.dbo.BilgiNot					B
				INNER JOIN OkyanusIletisim.dbo.BilgiNotKullanici	N		ON	N.ID_BILGINOT	= B.ID_BILGINOT
				LEFT  JOIN OkyanusIletisim.dbo.Dokuman				D		ON	D.ID_DOKUMAN	= B.ID_DOKUMAN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYE		ON	KYE.TCKIMLIKNO	= B.KYE_TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYI		ON	KYI.TCKIMLIKNO	= N.TCKIMLIKNO_KIMICIN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KIME	ON	KIME.TCKIMLIKNO	= N.TCKIMLIKNO_KIME
				WHERE CAST(B.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO AND SB.ID_SUBE	IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
					)		
				ORDER BY B.KYE_TARIH DESC
			END
	
			IF @ISLEM = 2	--	VIU Rapor VIÜ Kullanmayanlar
			BEGIN				
				
				DECLARE @DONEM NVARCHAR(MAX)

				SELECT TOP 1 @DONEM = '01.09.' + DONEM 
				FROM OkyanusDB.dbo.v3AktifDonem
				WHERE AKTIF = 1


				--SELECT DISTINCT
				--	 SUBE			= SB.AD
				--	,TCKIMLIKNO		= K.TCKIMLIKNO
				--	,AD				= K.AD
				--	,SOYAD			= K.SOYAD
				--	,KULLANICIAD	= K.KULLANICIAD
				--	,SIFRE			= K.SIFRE
				--	,SINIF			= SN.AD
				--	,KADEME			= K3.AD
				--	,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
				--	,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				--INTO #KULLANICILIST
				--FROM		OkyanusDB.dbo.v3Kullanici	K
				--INNER JOIN	OkyanusDB.dbo.v3SubeYetki	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO 
				--INNER JOIN	OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO	= K.TCKIMLIKNO
				--INNER JOIN	OkyanusDB.dbo.v3Ogrenci		OG	ON	OG.TCKIMLIKNO	= OV.TCKIMLIKNO_OGR
				--INNER JOIN	OkyanusDB.dbo.v3Sinif		SN	ON	SN.ID_SINIF		= OG.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3Satislar	SL	ON	SL.ID_SINIF		= SN.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= SL.ID_SATISTURU
				--INNER JOIN	OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3 
				--INNER JOIN	OkyanusDB.dbo.v3Sube		SB	ON	SB.ID_SUBE		= SY.ID_SUBE
				--LEFT JOIN	OkyanusIletisim.dbo.LoginLog L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
				--											AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				--WHERE	K.AKTIF = 1 
				--	AND SY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				--	AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
				--GROUP BY SB.AD, K.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, SN.AD, K3.AD, L.KYE_TCKIMLIKNO
				
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST

				SELECT VALUE ID_SUBE INTO #SUBELIST FROM OPENJSON(@ID_SUBELIST)

				SELECT DISTINCT 
					 SUBE			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SB.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE = SKY.ID_SUBE
														WHERE	SKY.TCKIMLIKNO	= KY.TCKIMLIKNO													
															AND SKY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 													
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,TCKIMLIKNO		= KY.TCKIMLIKNO
					,AD				= K.AD
					,SOYAD			= K.SOYAD
					,KULLANICIAD	= K.KULLANICIAD
					,SIFRE			= K.SIFRE
					,KULLANICITIPI	= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( KT.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3KullaniciTipi		KT	ON	KT.ID_KULLANICITIPI	= SKY.ID_KULLANICITIPI
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	 IN (5, 3, 53, 54, 26)
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,SINIF			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SN.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3Sinif				SN	ON	SN.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,KADEME			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SGS.KADEME3 AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.vw_SubeGrupSinif		SGS	ON	SGS.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
					,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				INTO #KULLANICILIST
				FROM OkyanusDB.dbo.vw_KullaniciYetki	KY
				JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= KY.TCKIMLIKNO
				JOIN #SUBELIST							SL	ON	SL.ID_SUBE		= KY.ID_SUBE
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
															AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				WHERE	KY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				GROUP BY KY.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, L.KYE_TCKIMLIKNO--, SN.AD, K3.AD, SB.AD




				SELECT KL.*
					,LOGINTARIH		= CONVERT(VARCHAR(10), L.KYE_TARIH, 104) + ' ' + CONVERT(VARCHAR(8), L.KYE_TARIH, 108) 
					,LOGINOTURUM	= SUBSTRING(CAST(L.OTURUM AS VARCHAR(MAX)),1,LEN(CAST(L.OTURUM AS VARCHAR(MAX)))-5)+ '*****'
				FROM #KULLANICILIST						KL
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	L.ID_LOGINLOG	= KL.ID_LOGINLOG
				ORDER BY SUBE, AD, SOYAD
								
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST


			END
			
			IF @ISLEM = 3	--	Arama Sebep Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMASEBEP, S.AD + ' (' + K.AD + ')' AS AD
					FROM [OkyanusIletisim].[dbo].[AramaSebep] S
					JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = S.ID_KADEME
					ORDER BY S.ID_KADEME, S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 4	--	Arama Durum Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMADURUM, S.AD
					FROM [OkyanusIletisim].[dbo].[AramaDurum] S
					ORDER BY S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 5	--	Arama Rapor
			BEGIN
				IF @JSON = 1
				BEGIN
					SELECT 
					ISNULL (
					(
						SELECT	 GUID			=	A.GUID
								,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
								,ARAYANTC		=	A.TC_ARAYAN
								,ARAYAN			=	K.AD  +' '+ K.SOYAD
								,KIME			=	A.ADSOYAD_ARANAN
								,ARAMASEBEP		=	S.AD 
								,ARAMADURUM		=	D.AD 
								,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
								,GRUP			=	K3.AD
								,SINIF			=	SNF.AD
								,ARAYANSUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
															FOR XML PATH('')
													), 1, 1, '')
								--,ARAYANTIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
								--				FOR XML PATH('')
								--				), 1, 1, '')
								,KIMESUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
															FOR XML PATH('')
													), 1, 1, '')
								--,KIMETIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
								--				FOR XML PATH('')
								--				), 1, 1, '') 
						FROM OkyanusIletisim.dbo.Arama		A	WITH (NOLOCK)
						JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO	= A.TC_ARAYAN
						JOIN OkyanusDB.dbo.v3Kullanici		KYI ON	KYI.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
						JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
						JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
						JOIN OkyanusIletisim.dbo.AramaSebep S	ON	S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
						JOIN OkyanusIletisim.dbo.AramaDurum D	ON	D.ID_ARAMADURUM = A.ID_ARAMADURUM
						WHERE	CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
						AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
						AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
						AND (
									(	EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST)))
							OR		(NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (	SELECT DISTINCT  SY.TCKIMLIKNO
														FROM OkyanusDB.dbo.v3SubeYetki	SY
														INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
														WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
									)	
								)
							)	
						AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
						ORDER BY A.KYE_TARIH DESC
						FOR JSON PATH
					), '[]')
				END
				ELSE
				BEGIN
					SELECT	 GUID			=	A.GUID
							,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
							,ARAYANTC		=	A.TC_ARAYAN
							,ARAYAN			=	K.AD  +' '+ K.SOYAD
							,KIME			=	A.ADSOYAD_ARANAN
							,ARAMASEBEP		=	S.AD 
							,ARAMADURUM		=	D.AD 
							,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
							,GRUP			=	K3.AD
							,SINIF			=	SNF.AD
							,ARAYANSUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
											FOR XML PATH('')
											), 1, 1, '')
							--,ARAYANTIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
							--				FOR XML PATH('')
							--				), 1, 1, '')
							,KIMESUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
											FOR XML PATH('')
											), 1, 1, '')
							--,KIMETIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
							--				FOR XML PATH('')
							--				), 1, 1, '') 
					FROM OkyanusIletisim.dbo.Arama A	WITH (NOLOCK)
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = A.TC_ARAYAN
					JOIN OkyanusDB.dbo.v3Kullanici KYI ON KYI.TCKIMLIKNO = A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
					JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
					JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
					JOIN OkyanusIletisim.dbo.AramaSebep S ON S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
					JOIN OkyanusIletisim.dbo.AramaDurum D ON D.ID_ARAMADURUM = A.ID_ARAMADURUM
					WHERE CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
					AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
						)	
					AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
					ORDER BY A.KYE_TARIH DESC
				END
			END

			IF @ISLEM = 6   --  Yoklama Rapor
			BEGIN
				--SELECT distinct 
				--	 D.SUBEAD
				--	,D.SINIF
				--	,K.AD + ' '+ K.SOYAD [AD SOYAD]
				--	,CONVERT(VARCHAR(10), Y.TARIH, 105)AS TARIH
				--	,K.TCKIMLIKNO
				--	,D.ID_SINIF
				--	,Y.ID_YOKLAMA
				--	,YK.GELDI
				--	,Y.TARIH AS tarih
				--	,CASE
				--			WHEN GELDI>0 THEN 'GELDİ'
				--			WHEN GELDI<1 THEN 'GELMEDİ'
				--		END AS DURUM
				--FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				--INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				--INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				--INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				--INNER JOIN  [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF	= D.ID_SINIF	AND	S.ID_SINIF		= Y.ID_SINIF
				--INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici] YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA  AND YK.TCKIMLIKNO	= K.TCKIMLIKNO
				--WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				--AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				--AND CAST(TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
				--ORDER BY  D.SUBEAD ASC,D.SINIF ASC,[AD SOYAD] ASC ,tarih DESC

				SELECT DERSNO, AD = BASSAAT + ' - ' + BITSAAT
				INTO #DERSSAAT
				FROM Pusulam.dbo.OnlineDersSaat   

				SELECT CAST(DATEADD(DAY, number, @BASTARIH) AS DATE) [Date]
				INTO #DATES
				FROM master..spt_values
				WHERE type = 'P'
				AND DATEADD(DAY, number, @BASTARIH) <= @BITTARIH

				SELECT distinct 
					 SD.SUBEAD
					,SD.SINIF
					,K.AD + ' '+ K.SOYAD [AD SOYAD]
					,K.TCKIMLIKNO
					,S.ID_SINIF
				INTO #KULLANICI
				FROM		OkyanusDB.dbo.vw_SinifOgrenci				S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				SD	ON S.ID_SINIF	= SD.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= SD.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				WHERE AD.AKTIF=1        
				AND ( ( SD.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( SD.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  

				SELECT K.*, D.Date AS TARIH, CONVERT(VARCHAR(MAX), D.Date, 104) AS STRTARIH
				INTO #KULLANICITARIH
				FROM #KULLANICI K
				CROSS APPLY #DATES D

				SELECT K.TCKIMLIKNO, K.TARIH, DP.DERSSAAT, CASE WHEN YK.GELDI = 1 THEN 'GELDİ' ELSE 'GELMEDİ' END AS DURUM
				INTO #KULLANICIDURUM
				FROM #KULLANICITARIH K
				INNER JOIN [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF = K.ID_SINIF AND Y.TARIH = K.TARIH
				INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici]	YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA AND YK.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN  OkyanusDB.dbo.v3DersProgram DP					ON DP.ID_DERSPROGRAM = Y.ID_DERSPROGRAM


				DECLARE @INDEX INT = 1
				DECLARE @COLUMN VARCHAR(MAX) = ''
				DECLARE @DERSNO VARCHAR(MAX) = ''

				WHILE @INDEX <= (SELECT MAX(DERSNO) FROM #DERSSAAT WHERE AD != ' - ')
				BEGIN
					SELECT @COLUMN = AD, @DERSNO = DERSNO FROM #DERSSAAT WHERE DERSNO = @INDEX

					EXECUTE('
					ALTER TABLE #KULLANICITARIH
					ADD [' + @COLUMN + '] VARCHAR(MAX)
					')
		
					EXECUTE ('UPDATE K SET K.[' + @COLUMN + '] = ISNULL((
																			SELECT DURUM
																			FROM #KULLANICIDURUM KD
																			WHERE KD.TARIH = K.TARIH AND KD.TCKIMLIKNO = K.TCKIMLIKNO AND KD.DERSSAAT = ' + @DERSNO + '
																), ''-'') FROM #KULLANICITARIH K')


					SET @INDEX = @INDEX + 1
				END

				SELECT *
				FROM #KULLANICITARIH
				ORDER BY SUBEAD ASC,SINIF ASC, [AD SOYAD] ASC, TARIH

				DROP TABLE #KULLANICI
				DROP TABLE #DERSSAAT
				DROP TABLE #DATES
				DROP TABLE #KULLANICITARIH
				DROP TABLE #KULLANICIDURUM
			END

			IF @ISLEM = 7   --  Viu Yetki Listesi
			BEGIN
			
				SELECT 
				(
					SELECT	Distinct K.AD + ' '+ K.SOYAD AS ADSOYAD ,K.TCKIMLIKNO
							
							,(	
							   
								SELECT distinct D.SUBEAD AS SUBEAD,D.ID_SUBE, 
								SECILI = (SELECT COUNT(*) FROM  ViuAramaKullaniciSube S where D.ID_SUBE=S.ID_SUBE and S.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.SUBEAD,D.ID_SUBE
								ORDER BY D.SUBEAD,D.ID_SUBE
								FOR JSON PATH
							 ) AS SUBE
							 ,(
							 SELECT distinct D.KADEME3 AS GRUP,D.ID_KADEME3, 
							 SECILI = (SELECT COUNT(*) FROM  ViuAramaKullaniciKademe K where K.ID_KADEME3=D.ID_KADEME3 and K.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.KADEME3,D.ID_KADEME3
								ORDER BY D.ID_KADEME3
								FOR JSON PATH
							 )
							 AS GRUP
					FROM OkyanusDB.dbo.v3Kullanici	K
					INNER JOIN OkyanusDB.[dbo].[v4KullaniciSubeTurKademe] TK  ON   TK.TCKIMLIKNO=K.TCKIMLIKNO 
					WHERE K.TCKIMLIKNO =@TC_OGRETMEN
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8   --  Viu Yetki Kaydet
			BEGIN
		   
				DELETE FROM ViuAramaKullanici WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciSube WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciKademe WHERE TCKIMLIKNO = @TC_OGRETMEN
				
				MERGE INTO ViuAramaKullanici AS A 
                USING ( 
						SELECT *
                        FROM OPENJSON(@SQLJSON) WITH ( TCKIMLIKNO VARCHAR(MAX) )) B
                ON (A.TCKIMLIKNO = B.TCKIMLIKNO) 
                WHEN MATCHED THEN 
                UPDATE  SET A.TCKIMLIKNO =B.TCKIMLIKNO                  
                WHEN NOT MATCHED THEN 
                INSERT  (TCKIMLIKNO)
				VALUES (B.TCKIMLIKNO);

					

				SELECT DISTINCT TCKIMLIKNO
                FROM OPENJSON(@SQLJSON)
                WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
		                ,SUBE		NVARCHAR(MAX) AS JSON 
		                ,GRUP		NVARCHAR(MAX) AS JSON
                ) AS J
					
                     
				INSERT INTO ViuAramaKullaniciSube(TCKIMLIKNO, ID_SUBE)
				SELECT DISTINCT TCKIMLIKNO, ID_SUBE 
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.SUBE)
				WITH(	 ID_SUBE	INT
						,SECILI		BIT	
				) AS S
				WHERE S.SECILI = 1

				INSERT INTO ViuAramaKullaniciKademe(TCKIMLIKNO,ID_KADEME3)
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME3  
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.GRUP)
				WITH (	 ID_KADEME3	INT
						,SECILI		BIT	
				) AS G
				WHERE G.SECILI = 1








        END 

			IF @ISLEM = 9	--	Kullanıcı Tipine Göre Kullanıcı Listele
			BEGIN
		
				SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
				FROM [dbo].[v3Kullanici]			KL	
				JOIN OkyanusDB.[dbo].[v3SubeYetki]	TK  ON   TK.TCKIMLIKNO=KL.TCKIMLIKNO 
				WHERE	TK.ID_KULLANICITIPI=101
				order by ADSOYAD 

			END

			IF @ISLEM = 10  --  Viu Toplu Mesaj Kaydet
			BEGIN				
				DROP TABLE IF EXISTS #MESAJLIST

				SELECT *, RN = ROW_NUMBER() OVER(ORDER BY TC_GONDEREN)
				INTO #MESAJLIST
				FROM OPENJSON(@SQLJSON)
				WITH (
					TC_GONDEREN	VARCHAR(MAX),
					TC_ALAN		VARCHAR(MAX),
					MESAJ		VARCHAR(MAX),
					LINK_ETIKET	VARCHAR(MAX),
					LINK		VARCHAR(MAX)
				)	ML
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= ML.TC_ALAN
				
				DECLARE @TOPLUMESAJ INT = NULL
				DECLARE @INSERT10 TABLE (ID INT)
				
				INSERT INTO OkyanusIletisim.dbo.TopluMesaj (KYE_TARIH,KYE_TCKIMLIKNO) 
					OUTPUT inserted.ID_TOPLUMESAJ INTO @INSERT10(ID) 
				VALUES(GETDATE(),@TCKIMLIKNO)

				SET @TOPLUMESAJ =(SELECT TOP 1 ID FROM @INSERT10)



				WHILE EXISTS ( SELECT TOP 1 1 FROM #MESAJLIST )
				BEGIN
		
					DECLARE @TC_GONDEREN	VARCHAR(MAX),
							@TC_ALAN		VARCHAR(MAX),
							@MESAJ			VARCHAR(MAX),
							@LINK_ETIKET	VARCHAR(MAX),
							@LINK			VARCHAR(MAX),
							@RN				INT
					SELECT TOP 1 
						 @TC_GONDEREN	= ML.TC_GONDEREN
						,@TC_ALAN		= ML.TC_ALAN
						,@MESAJ			= ML.MESAJ	
						,@LINK_ETIKET	= ML.LINK_ETIKET
						,@LINK			= ML.LINK
						,@RN			= ML.RN
					FROM #MESAJLIST		ML
					ORDER BY RN

					IF NOT EXISTS (
						SELECT TOP 1 1
						FROM v3Kullanici K
						WHERE K.TCKIMLIKNO	= @TC_GONDEREN
							AND K.AKTIF		= 1
					)
						SET  @TC_GONDEREN = '14531453000'	-- OKYANUS KOLEJLERİ
	
					
					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TC_GONDEREN
						,@HEADER			= 'Yeni Mesaj'
						,@MESAJ				= @MESAJ
						,@LINK				= @LINK
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @MESAJ
						,@LINK_ETIKET		= @LINK_ETIKET
						,@TOPLUMESAJ		= @TOPLUMESAJ

					DELETE FROM #MESAJLIST WHERE RN = @RN

				END

				DROP TABLE IF EXISTS #MESAJLIST

			END
			

		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Reenabling DDL triggers...'
GO
ENABLE TRIGGER [CaptureStoredProcedureChanges] ON DATABASE
GO
PRINT N'Update complete.';


GO



USE oKYANUSIletisim


GO
PRINT N'Creating [dbo].[BildirimTopluMesaj]...';


GO
CREATE TABLE [dbo].[BildirimTopluMesaj] (
    [ID_BILDIRIMTOPLUMESAJ] INT IDENTITY (1, 1) NOT NULL,
    [ID_TOPLUMESAJ]         INT NOT NULL,
    [ID_BILDIRIM]           INT NOT NULL,
    CONSTRAINT [PK_BildirimTopluMesaj] PRIMARY KEY CLUSTERED ([ID_BILDIRIMTOPLUMESAJ] ASC)
);


GO
PRINT N'Creating [dbo].[TopluMesaj]...';


GO
CREATE TABLE [dbo].[TopluMesaj] (
    [ID_TOPLUMESAJ]  INT        IDENTITY (1, 1) NOT NULL,
    [KYE_TARIH]      DATETIME   NOT NULL,
    [KYE_TCKIMLIKNO] NCHAR (11) NOT NULL,
    CONSTRAINT [PK_TopluMesaj] PRIMARY KEY CLUSTERED ([ID_TOPLUMESAJ] ASC)
);


GO
PRINT N'Altering [dbo].[sp_SendPushMessage]...';


GO


ALTER proc [dbo].[sp_SendPushMessage]

	@TCKIMLIKNO			NVARCHAR(MAX)	= NULL,
	@HEADER				NVARCHAR(MAX)	= NULL,
	@MESAJ				NVARCHAR(MAX)	= NULL,
	@LINK				NVARCHAR(MAX)	= NULL,
	@MENU				NVARCHAR(MAX)	= NULL,
	@LINK_ETIKET		NVARCHAR(MAX)	= NULL,
	@TCKIMLIKNO_KIME	NVARCHAR(MAX)	= NULL,
	@ID_UYGULAMA		INT				= NULL,
	@RESIM_URL			NVARCHAR(MAX)	= NULL,
	@GONDERILDI			BIT				= NULL,
	@MESAJTAM			NVARCHAR(MAX)	= NULL,
	@TOPLUMESAJ			INT             = NULL,
	@ID_BILDIRIM        INT				=0	
AS
BEGIN
		BEGIN		
		
			SET @RESIM_URL		= ISNULL(@RESIM_URL		, '')
			SET @GONDERILDI		= ISNULL(@GONDERILDI	,  1)
			SET @LINK			= ISNULL(@LINK			, '')
			SET @MENU			= ISNULL(@MENU			, '')
			SET @LINK_ETIKET	= ISNULL(@LINK_ETIKET	, '')
			SET @MESAJTAM		= ISNULL(@MESAJTAM		, '')

			DECLARE @ISERTBILDIRIM TABLE (ID INT)

			INSERT INTO Bildirim(KYE_TCKIMLIKNO, MESAJ, TCKIMLIKNO_KIME, HEADER, LINK, ID_UYGULAMA, RESIM_URL, GONDERILDI, MESAJTAM, LINK_ETIKET)
			OUTPUT inserted.ID_BILDIRIM INTO @ISERTBILDIRIM(ID)
			SELECT 
					 @TCKIMLIKNO
					,@MESAJ
					,@TCKIMLIKNO_KIME
					,@HEADER
					,@LINK
					,@ID_UYGULAMA
					,@RESIM_URL
					,@GONDERILDI
					,@MESAJTAM
					,@LINK_ETIKET

			SET @ID_BILDIRIM = (SELECT TOP 1 ID FROM @ISERTBILDIRIM)

			IF @GONDERILDI = 1
			BEGIN

				IF @TOPLUMESAJ IS NOT NULL
				BEGIN
					INSERT INTO BildirimTopluMesaj (ID_TOPLUMESAJ,ID_BILDIRIM) VALUES(@TOPLUMESAJ,@ID_BILDIRIM)
				END

				SET @MESAJ	= REPLACE(REPLACE(REPLACE(REPLACE(@MESAJ	, '"', ' '), '''', ' '), '’', ''), '&', '')
				SET @HEADER = REPLACE(REPLACE(REPLACE(REPLACE(@HEADER	, '"', ' '), '''', ' '), '’', ''), '&', '')
				SET @LINK	= REPLACE(REPLACE(REPLACE(REPLACE(@LINK		, '"', ' '), '''', ' '), '’', ''), '&', '')

				DECLARE  @JSONDATA NVARCHAR(MAX), @URL NVARCHAR(MAX)

				/* LOOP */
				SELECT FCM_TOKEN, RN = ROW_NUMBER() OVER(ORDER BY FCM_TOKEN)
				INTO #Loop
				FROM LoginLog WITH(NOLOCK) 
				WHERE FCM_TOKEN IS NOT NULL AND FCM_TOKEN <> '' AND LOGOUT = 0 AND KYE_TCKIMLIKNO = @TCKIMLIKNO_KIME AND ID_UYGULAMA = @ID_UYGULAMA

				DECLARE @I INT = 1, @COUNT INT = 0, @FCM_TOKEN NVARCHAR(MAX) = ''
				SELECT @COUNT = COUNT(1) FROM #Loop				

				WHILE @I <= @COUNT
				BEGIN
	
					SELECT
						@FCM_TOKEN = FCM_TOKEN
					FROM #Loop
					WHERE RN = @I

					SELECT @JSONDATA = 
						ISNULL((
							SELECT
								 TCKIMLIKNO_KIME	= @TCKIMLIKNO_KIME
								,MESAJ				= @MESAJ
								,HEADER				= @HEADER
								,LINKMSG			= @LINK
								,MENU				= @MENU
								,ANAHTAR			= dbo.Fn_GetBildirimAnahtar(@ID_UYGULAMA)
								,TOKEN				= @FCM_TOKEN
							FOR JSON PATH
						), '{ "JSONDATA" : [] }')


					Declare @Object as Int;
					Declare @ResponseText as Varchar(8000);
		
					SET @URL = 'http://okyanusiletisim.okyanuskoleji.k12.tr/OkyanusApi/PushMessage/SendPushMessage?jsonData={"JSONDATA": "'+@JSONDATA+'"}'
		

					Exec sp_OACreate 'WinHttp.WinHttpRequest.5.1', @Object OUT;				
					Exec sp_OAMethod @Object, 'open', NULL, 'POST', @URL, 'false'
					Exec sp_OAMethod @Object, 'send'
					Exec sp_OAMethod @Object, 'responseText', @ResponseText OUTPUT
					Exec sp_OADestroy @Object
		
					SET @I = @I + 1
				
				END
				
				DROP TABLE #Loop

			END
		
		END
END
GO
PRINT N'Refreshing [dbo].[sp_OtomatikBildirimEtkinlik]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OtomatikBildirimEtkinlik]';


GO
PRINT N'Refreshing [dbo].[sp_Yoklama]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Yoklama]';


GO
PRINT N'Refreshing [dbo].[sp_Arama]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Arama]';


GO
PRINT N'Refreshing [dbo].[sp_Bildirim]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Bildirim]';


GO
PRINT N'Refreshing [dbo].[sp_BilgiNot]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_BilgiNot]';


GO
PRINT N'Refreshing [dbo].[sp_Dokuman]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Dokuman]';


GO
PRINT N'Refreshing [dbo].[sp_Etkinlik]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Etkinlik]';


GO
PRINT N'Refreshing [dbo].[sp_Ilac]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Ilac]';


GO
PRINT N'Refreshing [dbo].[sp_KantinDusukBakiyeBildirimYolla]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_KantinDusukBakiyeBildirimYolla]';


GO
PRINT N'Refreshing [dbo].[sp_OtomatikBildirimIlac]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OtomatikBildirimIlac]';


GO
PRINT N'Refreshing [dbo].[sp_OtomatikBildirimRandevu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OtomatikBildirimRandevu]';


GO
PRINT N'Refreshing [dbo].[sp_Randevu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Randevu]';


GO
PRINT N'Update complete.';


GO
