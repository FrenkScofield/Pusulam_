USE [Pusulam]
GO
/****** Object:  StoredProcedure [dbo].[sp_Ogrenci]    Script Date: 5.11.2020 14:13:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[sp_Ogrenci]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUP		INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINIFS			VARCHAR(MAX)	= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_TKTZEKATURUS	VARCHAR(MAX)	= NULL,
	@ID_TKTSINAV		INT				= NULL,
	@ID_TKTTEST			INT				= NULL,
	@TARIH				Date			= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ISJSON				BIT				= NULL
AS
BEGIN

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
		IF @return_variable = 1
		BEGIN
	
			SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
			IF @ISLEM = 1	--	Upgrade Öğrenci Listele 
			BEGIN
				SELECT DISTINCT o.ID_OGRENCI, o.TCKIMLIKNO, st.ID_SATISTURU 
				INTO #OGRENCILIST
				FROM [dbo].[v3OgrenciTum] o
				inner join [dbo].[v3SubeYetki]	sy		on sy.TCKIMLIKNO	=	o.TCKIMLIKNO 
				inner join [dbo].[v3SinifTum]	s		on s.ID_SINIF		=	o.ID_SINIF AND s.DONEM = o.DONEM
				inner join [dbo].[v3SatisTuru]	st		on st.ID_SATISTURU	=	s.ID_SATISTURU 
				WHERE 
				o.DONEM = @DONEM AND
				(@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  AND
				(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  AND
				(@ID_SINIFS IS NULL OR @ID_SINIFS='[]' OR s.ID_SINIF in (select value from openjson( @ID_SINIFS)) ) AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))

				SELECT O.ID_OGRENCI, OS.KYE_KULLANICI, CONVERT(VARCHAR, MAX(OS.KYE_TARIH),104) AS TARIH, SUM(OS.SAY) AS SORUSAYISI, OS.ID_TKTTEST, OS.ID_UPGRADEOGRENCISINAVDONEM
				INTO #OGRENCILIST2
				FROM #OGRENCILIST O
				LEFT JOIN (
							--SELECT OS.TCKIMLIKNO, S.ID_SATISTURU, OS.KYE_KULLANICI, OS.KYE_TARIH, 1 AS SAY
							--FROM UpgradeOgrenciSinav OS
							--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
							--WHERE OS.ID_TKTSINAV = @ID_TKTSINAV

							SELECT OSD.TCKIMLIKNO, S.ID_SATISTURU, OSD.KYE_KULLANICI, OSD.KYE_TARIH, 1 AS SAY, OSD.ID_TKTTEST, OSD.ID_UPGRADEOGRENCISINAVDONEM
							FROM UpgradeOgrenciSinavDonem OSD
							INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
							WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
						) OS ON OS.TCKIMLIKNO = O.TCKIMLIKNO AND OS.ID_SATISTURU = O.ID_SATISTURU
				GROUP BY O.ID_OGRENCI, OS.KYE_KULLANICI, OS.ID_TKTTEST, OS.ID_UPGRADEOGRENCISINAVDONEM


				SELECT 
					 o.ID_OGRENCI
					,k.AD
					,k.SOYAD
					,DOGUMTARIHI = CONVERT(VARCHAR, k.DOGUMTARIHI, 103)
					,o.TCKIMLIKNO 
					,PUANGIRISI = case when @ID_TKTTEST = 4 then 1 else (	
									SELECT COUNT(*) FROM TktOgrenciCevap oc
									Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
									INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
									WHERE s.ID_TKTTEST=@ID_TKTTEST AND os.TCKIMLIKNO=o.TCKIMLIKNO
									AND (os.DONEM = @DONEM OR @DONEM IS NULL)
									) end
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, GETDATE())-1
					,s.AD SINIF
					,K2.AD + ' ' + K2.SOYAD AS KYE_ADSOYAD 
					,OL.TARIH
					,OL.SORUSAYISI
					,CASE WHEN OL.ID_TKTTEST = 4 THEN 'Ortalamaya Göre;' + STUFF((SELECT '<br/>' + US.SINAVAD FROM UpgradeOgrenciSinavDonemEtkinlik OSDE JOIN UpgradeSinav US ON US.ID_TKTSINAV = OSDE.ID_TKTSINAV WHERE OSDE.ID_UPGRADEOGRENCISINAVDONEM = OL.ID_UPGRADEOGRENCISINAVDONEM FOR XML PATH, TYPE).value(N'.[1]', N'nvarchar(max)'),1, 0, N'') WHEN  OL.ID_TKTTEST IS NULL THEN '' ELSE (SELECT AD FROM TKTTest WHERE ID_TKTTEST = OL.ID_TKTTEST) END AS OLUSTURMASEKLI
				FROM		[dbo].[v3OgrenciTum]	o
				Inner Join	[dbo].[v3Kullanici]		k	on k.TCKIMLIKNO		=	o.TCKIMLIKNO
				inner join	[dbo].[v3SinifTum]		s	on s.ID_SINIF		=	o.ID_SINIF AND s.DONEM = o.DONEM
				INNER JOIN #OGRENCILIST2			OL	ON OL.ID_OGRENCI	=	o.ID_OGRENCI
				LEFT JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO	=	OL.KYE_KULLANICI 
				WHERE 
				o.DONEM = @DONEM
				ORDER BY k.AD, k.SOYAD

				DROP TABLE #OGRENCILIST2
				DROP TABLE #OGRENCILIST
			END

			IF @ISLEM = 2	--	TKT Öğrenci Listele 
			BEGIN
				SELECT distinct
					 O.ID_OGRENCI
					,REPLACE(UPPER(k.AD),'UNDEFİNED','') as AD
					,UPPER(k.SOYAD) as SOYAD
					,DOGUMTARIHI = CONVERT(VARCHAR, k.DOGUMTARIHI, 103)
					,O.TCKIMLIKNO 
					,PUANGIRISI1 = (
						SELECT COUNT(*) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=1 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI2 = (
						SELECT COUNT(*) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=2 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI3 = (
						SELECT COUNT(*) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=3 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI4 = (
						SELECT COUNT(*) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=4 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1
					,DURUM		= case when (DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1)<=(select max(YASAY2) from UpgradeYasAraligi) and (DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1)>=(select min(YASAY1) from UpgradeYasAraligi) then 1 else 0 end
				FROM	   [dbo].[v3OgrenciTum]		O
				Inner Join [dbo].[v3Kullanici]		k	on	k.TCKIMLIKNO	=	o.TCKIMLIKNO
				inner join [dbo].[v3SubeYetki]		sy	on	sy.TCKIMLIKNO	=	o.TCKIMLIKNO
				inner join [dbo].[v3SinifTum]		s	on	s.ID_SINIF		=	o.ID_SINIF 
				inner join [dbo].[v3SatisTuru]		st	on	st.ID_SATISTURU	=	s.ID_SATISTURU  
				where O.DONEM = @DONEM AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  AND
					(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  AND
					(@ID_SINIF IS NULL OR @ID_SINIF=0 OR s.ID_SINIF=@ID_SINIF)  AND
					(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))
			END

			IF @ISLEM = 4	--	Öğrenci Listele 
			BEGIN
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM v3OgrenciTum		O
				JOIN v3Kullanici	K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE ID_SINIF=@ID_SINIF
				ORDER BY K.AD, K.SOYAD
			END

			IF @ISLEM = 5	--	Öğrenci Listele by Veli
			BEGIN

				IF @ID_KADEME IS NULL
					SET @ID_KADEME = 0

				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO,ID_KADEME
				FROM V3KULLANici			K	
				JOIN V3OgrenciVeli			V	ON	V.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO		= K.TCKIMLIKNO
				JOIN vw_SubeSinifGrupKademe	GS	ON	GS.ID_SINIF			= O.ID_SINIF
				WHERE V.TCKIMLIKNO=@TCKIMLIKNO
					AND (@ID_KADEME = 0 OR GS.ID_KADEME = @ID_KADEME )
			END

			IF @ISLEM = 6	--	Öğrenci Listele MultiSinif
			BEGIN
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM V3OGRENCi		O
				JOIN V3KULLANici	K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE (@SINIFLAR='[]' or ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			END

			IF @ISLEM = 7	--	Demo Öğrenci Listele 
			BEGIN
				SELECT	 [FOTOĞRAF]		= ISNULL(R.FOTOGRAF,'')
						,[AD SOYAD]		= K.AD +' '+ K.SOYAD
						,[ÖĞRENCİ NO]	= O.OGRNO
						,[SINIF]		= SN.AD
						,[TCKIMLIKNO]	= O.TCKIMLIKNO
						,[İŞLEM]		= '<input style="float:right;margin: 10px;" type="button" class="btn btn-success" v-on:click="DemoLogin('+O.TCKIMLIKNO+')" value="Giriş Yap">'
				INTO #DemoOgrenciList
				FROM v3Ogrenci						O
				JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF		= O.ID_SINIF
				JOIN v3Sinif						SN	ON	SN.ID_SINIF		= O.ID_SINIF
				JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.DBO.v3Resim		R	ON	R.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	(O.ID_SUBE	= @ID_SUBE			OR @ID_SUBE		= 0 )
					AND (O.ID_SINIF = @ID_SINIF			OR @ID_SINIF	= 0 )
					AND (ID_KADEME3 = @ID_KADEME3		OR @ID_KADEME3	= 0 )
					--AND (K.AD		LIKE '%'+@AD+'%'	OR @AD			= '')
					--AND (K.SOYAD	LIKE '%'+@SOYAD+'%'	OR @SOYAD		= '')
				ORDER BY [AD SOYAD],[ÖĞRENCİ NO]
				
				select(
						select * from(
							select 
							(						 
								SELECT * FROM #DemoOgrenciList
								ORDER BY [AD SOYAD],[ÖĞRENCİ NO]
								FOR JSON AUTO
							) as DemoOgrenciList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #DemoOgrenciList

			END

			IF @ISLEM = 8	--	ÖĞRENCİ KADEME GETİR
			BEGIN
				SELECT DISTINCT ST.ID_KADEME
				FROM OkyanusDB.dbo.v3Ogrenci O
				JOIN OkyanusDB.dbo.v3Satislar S ON S.ID_SOZLESME = O.ID_SOZLESME
				JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				WHERE TCKIMLIKNO = @TC_OGRENCI
			END

			IF @ISLEM = 9	--	ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				SELECT
				ISNULL
				(
					(
						SELECT  ID_SINAV	= S.ID_SINAV, 
								TCKIMLIKNO	= FO.TC_OGRENCI, 
								TUR			= ST.KISAAD, 
								TARIH		= CONVERT(varchar(MAX), S.SINAVTARIH, 104), 
								AD			= S.AD, 
								FREKANS		= ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
						FROM v2FrekansOgrenciDetay FO
						JOIN Sinav S ON S.ID_SINAV = FO.ID_SINAV
						JOIN SinavTuru ST ON ST.ID_SINAVTURU = S.ID_SINAVTURU
						WHERE TC_OGRENCI = @TC_OGRENCI AND S.DONEM = @DONEM
						GROUP BY S.ID_SINAV, FO.TC_OGRENCI, ST.KISAAD, S.SINAVTARIH, S.AD
						ORDER BY S.SINAVTARIH DESC
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 10	--	ÖĞRENCİ FREKANS DETAY LİSTESİ
			BEGIN
				SELECT
				ISNULL
				(
					(						
						SELECT DISTINCT FO.TAKMAAD, ISNULL(CAST(FO.FREKANS AS VARCHAR(MAX)) + '%', 'HESAPLANMADI') AS FREKANS
						FROM v2FrekansOgrenciDetay FO
						JOIN Sinav S ON S.ID_SINAV = FO.ID_SINAV
						WHERE TC_OGRENCI = @TC_OGRENCI AND S.ID_SINAV = @ID_SINAV
						ORDER BY FO.TAKMAAD
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 11	--	ŞUBE SINAV ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				IF @ISJSON = 1
				BEGIN
					SELECT
					ISNULL
					(
						(						
							SELECT	 K.TCKIMLIKNO
									,FOD.SUBEAD
									,FOD.SINIFAD
									,ADSOYAD = K.AD + ' ' + K.SOYAD
									,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')									
									--,DERSLIST = ISNULL((SELECT DERSAD,NET,SS,FREKANS
									--					FROM v2FrekansOgrenciDetay L
									--					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI
														
									--					WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND L.ID_SINAV = @ID_SINAV  AND L.TC_OGRENCI=FOD.TC_OGRENCI		
														
									--					FOR JSON PATH, INCLUDE_NULL_VALUES
									--				),'[]')
 							  
							FROM v2FrekansOgrenciDetay FOD
							JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
							WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
							GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI
							ORDER BY SUBEAD, SINIFAD, ADSOYAD
							FOR JSON PATH
						),'[]')	

				END
				ELSE
				BEGIN
					SELECT	 K.TCKIMLIKNO
							,FOD.SUBEAD
							,FOD.SINIFAD
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
					FROM v2FrekansOgrenciDetay FOD
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
					GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				END
			END
			
			IF @ISLEM = 12	--	ŞUBE SINAV ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				IF @ISJSON = 1

				BEGIN
				
		
					SELECT  ID_SINAV,AD,ID_SINAVTURU,DONEM 
					INTO #TEMPSINAV 
					FROM Sinav  
					WHERE	ID_SINAVTURU	= @ID_SINAVTURU 
						AND DONEM			= @DONEM  
						AND FREKANSHESAPLA	= 1

					SELECT DISTINCT TAKMAAD INTO #DERSLER FROM SinavDers Where ID_SINAV in(Select ID_SINAV FROM Sinav  where ID_SINAVTURU=@ID_SINAVTURU AND DONEM=@DONEM  AND FREKANSHESAPLA=1 )
			
					SELECT	 K.TCKIMLIKNO
									,FOD.SUBEAD
									,FOD.SINIFAD
									,FOD.ID_SINIF
									,ADSOYAD = K.AD + ' ' + K.SOYAD
									,SINAVAD=S.AD
									,DERSAD=FOD.DERSAD
									,FREKANS=FOD.FREKANS
									,NET=FOD.NET
									,SORUSAYISI=FOD.SS
									--,DERSLIST = ((SELECT DISTINCT S.ID_SINAV, DERSAD,L.NET,L.SS,L.FREKANS,K.AD,K.SOYAD
									--						FROM v2FrekansOgrenciDetay L
									--						JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI				
									--						--JOIN Sinav S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU 
									--						JOIN #TEMPSINAV S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU
									--							WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  AND L.TC_OGRENCI=K.TCKIMLIKNO	And L.TC_OGRENCI=FOD.TC_OGRENCI 
									--							AND L.ID_SINAVTURU=@ID_SINAVTURU	AND S.DONEM=@DONEM	--AND SS.AD=S.AD  --AND L.TC_OGRENCI=OS.TCKIMLIKNO --AND L.TC_OGRENCI=T.TCKIMLIKNO
									--						    GROUP BY K.TCKIMLIKNO,K.AD,K.SOYAD,L.DERSAD,S.ID_SINAV,L.NET,L.FREKANS,L.SS												
									--							FOR JSON PATH, INCLUDE_NULL_VALUES
									--					))
							INTO #OGRFREKANS
							FROM v2FrekansOgrenciDetay FOD
							JOIN #TEMPSINAV S ON S.ID_SINAV=FOD.ID_SINAV AND S.ID_SINAVTURU=FOD.ID_SINAVTURU
							--JOIN #DERSLER D ON S.ID_SINAV=FOD.ID_SINAV --AND D.ID_SINAVTURU=FOD.ID_SINAVTURU
							JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
							WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAVTURU = @ID_SINAVTURU
							GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI,S.AD,FOD.DERSAD,FOD.FREKANS,FOD.NET,FOD.SS,FOD.ID_SINIF
							ORDER BY SUBEAD, SINIFAD, ADSOYAD
					
					select(
						select * from(
								select 
								(					
									SELECT		*
									FROM		#TEMPSINAV 
							
									FOR JSON AUTO
								) as t1,
								(					
									SELECT * FROM #DERSLER							
									FOR JSON AUTO
								) as t2,
								(					
									SELECT * FROM #OGRFREKANS	
									GROUP BY TCKIMLIKNO,SINAVAD,DERSAD,SUBEAD,SINIFAD,ADSOYAD,FREKANS,NET,SORUSAYISI,ID_SINIF
									FOR JSON AUTO
								) as t3	
							) as tablo FOR JSON AUTO
						) as tt


			
	
					--		SELECT 
					--      ( 
					--	SELECT		
					--			DISTINCT T.TCKIMLIKNO, SINAVLAR = (
					--				SELECT 	SINAVAD = SS.AD, 
					--				        SINAVFREKANS=ISNULL(CAST(CAST(AVG(OS.FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI'),
					--						SORUSAYISI=OS.SS,
					--						SINAVNET=OS.NET,
					--						TCKIMLIKNO=OS.TCKIMLIKNO,									
					--						DERSLIST = ISNULL((SELECT DISTINCT S.ID_SINAV, DERSAD,L.NET,L.SS,L.FREKANS,K.AD,K.SOYAD
					--										FROM v2FrekansOgrenciDetay L
					--										JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI				
					--										JOIN Sinav S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU 													
					--											WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  AND L.TC_OGRENCI=K.TCKIMLIKNO	And L.TC_OGRENCI=FOD.TC_OGRENCI 
					--											AND L.ID_SINAVTURU=@ID_SINAVTURU	AND S.DONEM=@DONEM	AND SS.AD=S.AD  --AND L.TC_OGRENCI=OS.TCKIMLIKNO --AND L.TC_OGRENCI=T.TCKIMLIKNO
					--										    GROUP BY K.TCKIMLIKNO,K.AD,K.SOYAD,L.DERSAD,S.ID_SINAV,L.NET,L.FREKANS,L.SS												
					--											FOR JSON PATH, INCLUDE_NULL_VALUES
					--									),'[]')
						  
					--			FROM v2FrekansOgrenciDetay FOD
					--			JOIN Sinav SS ON SS.ID_SINAV=FOD.ID_SINAV AND SS.ID_SINAVTURU=FOD.ID_SINAVTURU 					
					--			JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					--			JOIN v2FrekansOgrenciSinav OS ON SS.ID_SINAV=OS.ID_SINAV AND K.TCKIMLIKNO=OS.TCKIMLIKNO AND OS.ID_SINAVTURU=SS.ID_SINAVTURU
					--			WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  And FOD.TC_OGRENCI=T.TCKIMLIKNO 
					--			AND SS.ID_SINAVTURU=@ID_SINAVTURU AND SS.DONEM=@DONEM AND OS.TCKIMLIKNO=K.TCKIMLIKNO AND K.TCKIMLIKNO=FOD.TC_OGRENCI AND FOD.TC_OGRENCI=OS.TCKIMLIKNO AND OS.ID_SINAVTURU=@ID_SINAVTURU
					--			GROUP BY FOD.SUBEAD, FOD.SINIFAD,SS.AD,FOD.TC_OGRENCI, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI,OS.FREKANS,OS.SS,OS.NET,OS.TCKIMLIKNO
					--			ORDER BY SUBEAD, SINIFAD
					--				FOR JSON PATH
					--			) 
					--	 FROM v2FrekansOgrenciSinav T
					--	 inner join v2FrekansOgrenciDetay FD ON  FD.ID_SINAV=T.ID_SINAV
					--	 JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND T.TCKIMLIKNO=FD.TC_OGRENCI
					--	 WHERE 
					--	 FD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND K.TCKIMLIKNO=FD.TC_OGRENCI AND K.TCKIMLIKNO=T.TCKIMLIKNO AND T.DONEM=@DONEM AND T.ID_SINAVTURU=@ID_SINAVTURU
					
					--	GROUP BY FD.SUBEAD, FD.SINIFAD,FD.TC_OGRENCI,T.TCKIMLIKNO,T.ID_SINAV
					--	FOR JSON PATH
					--) AS J 
			

				END
				ELSE
				BEGIN
					SELECT	 K.TCKIMLIKNO
							,FOD.SUBEAD
							,FOD.SINIFAD
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
					FROM v2FrekansOgrenciDetay FOD
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
					GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				END
			END

			IF @ISLEM = 13	--	ÖĞRENCİ DÖNEM DETAY			
			BEGIN
			
				IF @DONEM IS NULL
					SET @DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)

				SELECT ISNULL((				
					SELECT	 D.TCKIMLIKNO
							,ADSOYAD	= CONCAT_WS(' ', D.AD, D.SOYAD)
							,KADEME3
							,SUBEAD
							,SINIFAD
							,ID_SUBE
							,ID_SINIF
							,FOTOGRAF	= ISNULL(R.FOTOGRAF,'')
					FROM OkyanusDB.dbo.vw_OgrenciDetayTum	D
					LEFT JOIN OkyanusDB.dbo.v3Resim			R	ON	R.TCKIMLIKNO	= D.TCKIMLIKNO
																AND R.SIRANO		= 1
					WHERE	D.DONEM			= @DONEM
						AND D.TCKIMLIKNO	= @TC_OGRENCI
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END

			IF @ISLEM = 14	--	Öğrenci Listele by Veli Sınav
			BEGIN

				IF @ID_KADEME IS NULL
					SET @ID_KADEME = 0

				SELECT DISTINCT K.AD ,K.SOYAD ,K.TCKIMLIKNO,ID_KADEME
				FROM V3KULLANici			K	
				JOIN V3OgrenciVeli			V	ON	V.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO		= K.TCKIMLIKNO
				JOIN SinavOgrenci			SO  ON  SO.TCKIMLIKNO       = O.TCKIMLIKNO --SINAV ÖĞRENCİ
				JOIN Sinav					S   ON	S.ID_SINAV			= SO.ID_SINAV
												AND S.DONEM				= OkyanusDB.dbo.fn_AktifDonem()
				JOIN vw_SubeSinifGrupKademe	GS	ON	GS.ID_SINIF			= O.ID_SINIF
				WHERE V.TCKIMLIKNO=@TCKIMLIKNO
					AND (@ID_KADEME = 0 OR GS.ID_KADEME = @ID_KADEME )
			END
		
			DROP TABLE IF EXISTS #KADEMELER
		END

	END TRY
	BEGIN CATCH
			
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
	
END





