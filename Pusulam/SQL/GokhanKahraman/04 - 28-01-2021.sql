
PRINT N'Disabling all DDL triggers...'
GO
DISABLE TRIGGER ALL ON DATABASE
GO
PRINT N'Dropping [dbo].[sp_AraKarneCokluEski]...';


GO
DROP PROCEDURE [dbo].[sp_AraKarneCokluEski];


GO
PRINT N'Dropping [dbo].[sp_AraKarneEski]...';


GO
DROP PROCEDURE [dbo].[sp_AraKarneEski];


GO
PRINT N'Dropping [dbo].[sp_OkulRaporEski]...';


GO
DROP PROCEDURE [dbo].[sp_OkulRaporEski];


GO
PRINT N'Altering [dbo].[Sinav]...';


GO
ALTER TABLE [dbo].[Sinav]
    ADD [YONERGE_GUID] VARCHAR (MAX) NULL;


GO
PRINT N'Altering [dbo].[Tbl_OnlineSinavDetay]...';


GO
ALTER TABLE [dbo].[Tbl_OnlineSinavDetay]
    ADD [BITACIKLANMATARIH] SMALLDATETIME CONSTRAINT [DF_Tbl_OnlineSinavDetay_BITACIKLANMATARIH] DEFAULT (getdate()) NOT NULL;


GO
PRINT N'Altering [dbo].[Tbl_OnlineSinavOgrenci]...';


GO
ALTER TABLE [dbo].[Tbl_OnlineSinavOgrenci]
    ADD [YONERGE] BIT NULL;


GO
PRINT N'Creating [dbo].[SorunBildir]...';


GO
CREATE TABLE [dbo].[SorunBildir] (
    [ID_SORUN]            INT           IDENTITY (1, 1) NOT NULL,
    [ID_KURUMDISIOGRENCI] INT           NOT NULL,
    [SORUN]               VARCHAR (MAX) NOT NULL,
    [FILEGUID]            VARCHAR (MAX) NOT NULL,
    [MAIL]                VARCHAR (300) NULL,
    CONSTRAINT [PK_SorunBildir] PRIMARY KEY CLUSTERED ([ID_SORUN] ASC)
);


GO
PRINT N'Refreshing [dbo].[vw_SinavDersOturum]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vw_SinavDersOturum]';


GO
PRINT N'Refreshing [dbo].[vw_SinavOgrenciBolum]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vw_SinavOgrenciBolum]';


GO
PRINT N'Refreshing [dbo].[vw_SinavOgrenciSoru]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[vw_SinavOgrenciSoru]';


GO
PRINT N'Altering [dbo].[sp_Sinav]...';


GO
ALTER procedure [dbo].[sp_Sinav]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@SINAVSORUISLEM		BIT				= 0,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAVTURUS		VARCHAR(MAX)	= NULL,
	@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@TAKMAAD			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SUBES			NVARCHAR(MAX)	= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SINAVOTURUM		tinyint			= NULL,
	@UNITEKOD			VARCHAR(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@TCLIST				VARCHAR(MAX)	= NULL,
	@ID_SINAVDERSLIST	VARCHAR(MAX)	= NULL,
	@DURUM				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@DURUMDEGER			BIT				= NULL,
	@ESKIDONEMSINIF		BIT				= 0,
	@ID_TYTSECIMTUR		INT				= NULL,
	@BARAJ				VARCHAR(MAX)	= NULL,
	@ID_SORUBANKASI		int				= NULL,
	@KOD				VARCHAR(MAX)	= NULL,
	@MAIL				BIT				= 0,
	@GUID				VARCHAR(MAX)    = NULL

AS
BEGIN
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		DECLARE @return_variable INT
		EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
		IF @return_variable = 1
		BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 29.09.2020
	
	--	sp UPDATE
	--	ISLEM 48 ADD 

*/
			--IF (SELECT COUNT(*) FROM SinavDegerlendir WHERE AKTIF = 1 AND ID_SINAV = @ID_SINAV) > 0
			--BEGIN
			--	RAISERROR ('Sınav değerlendirme işlemi yapılıyor daha sonra tekrar deneyiniz.' , -- Message text.
			--		16, -- Severity.
			--		1 -- State.
			--		);
			--END
			--ELSE
			--BEGIN

			DECLARE @ONLINESINAV BIT = NULL			
			DECLARE @cols2		NVARCHAR(MAX)
			DECLARE @query		NVARCHAR(MAX)

			BEGIN
				SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
				DECLARE @AKTIFDONEM VARCHAR(4)=(	SELECT  DONEM FROM v3AktifDonem WHERE AKTIF=1)

				DECLARE  @OZELSINAVGOR BIT=0
				IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) )
				BEGIN
					SET @OZELSINAVGOR=1
				END
			
				DECLARE @ID_KADEME3ESKI INT  = @ID_KADEME3

					IF @DONEM IS NULL OR @DONEM=''
					BEGIN
						SELECT @DONEM= DONEM FROM v3AktifDonem WHERE AKTIF=1
					END

					IF NOT EXISTS ( SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @OGRENCIDONEM)
					BEGIN
						SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
					END 

					DECLARE @DONEMFARKI INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
					IF  (@DONEMFARKI<>0) AND (SELECT @ESKIDONEMSINIF ) = 0
					BEGIN
						DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
						SELECT @ID_KADEME3ESKI=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
					END
			END

				IF @ISLEM = 0	--	Dönem Listele
				BEGIN
					SELECT * FROM [dbo].[v3AktifDonem] order by DONEM desc
				END
				IF @ISLEM = 1	--	Sınav Türü Listele
				BEGIN
					IF 4 IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)	--	ÖĞRENCİ İSE YALNIZCA GİRDİĞİ SINAV TÜRLERİ
					BEGIN	
						SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD FROM SinavOgrenci SO
						INNER JOIN Sinav S ON S.ID_SINAV=SO.ID_SINAV
						INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
						WHERE SO.TCKIMLIKNO = @TCKIMLIKNO
					END
					ELSE
					BEGIN
						SELECT ID_SINAVTURU, AD, KISAAD FROM SinavTuru where AKTIF=1
					END
				END
				IF @ISLEM = 2	--	Sınav Grup Listele
				BEGIN
					select distinct st.ID_KADEME3, k.AD
					from		  [dbo].[vw_SubeGrupSinif]	sgs
					Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
					Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
					Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
					Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
					Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
					where	(@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson( @ID_SUBES)))  AND
							(@ID_SUBE IS NULL OR @ID_SUBE=0 OR @ID_SUBE=sgs.ID_SUBE) AND
							((@KADEME IS NULL AND st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) OR (@KADEME IS NOT NULL AND st.ID_KADEME=@KADEME))
					--ORDER BY k.SIRA

				END
				IF @ISLEM = 3	--	Sınav Ders Listele
				BEGIN
					SELECT (
						SELECT 
						KADEME		AS 'id',
						KADEME		AS 'text', 
						(
							SELECT 
							ID_DERS AS 'id', 
							AD		AS 'text'
							FROM [dbo].[v3SinavDers] sd 
							WHERE sd.ID_KADEME3=xTable.ID_KADEME3 
							ORDER BY sd.AD
							FOR JSON PATH
						) AS 'children'
						from
						(
							SELECT k3.AD AS 'KADEME', k3.ID_KADEME3 AS 'ID_KADEME3'
							FROM		[dbo].[v3SinavDers]		sd
							INNER JOIN	[dbo].[v3Kademe3]		k3	ON	k3.ID_KADEME3 = sd.ID_KADEME3
							GROUP BY k3.AD, k3.ID_KADEME3
						) AS xTable
						ORDER BY ID_KADEME3
						FOR JSON PATH
					) AS 'JSON'
				END
				IF @ISLEM = 4	--	Sınav Ekle
				BEGIN
					BEGIN TRANSACTION [Tran4]
					BEGIN TRY    
						---------
						--SINAV--
						---------
						DECLARE @ID_SINAVLIST TABLE (ID_SINAV INT)
						INSERT INTO [dbo].[Sinav]
								   ([ID_SINAVTURU] ,[AD] ,[KOD] ,[RAPORBASLIK] ,[DONEM] ,[ID_KADEME3] ,[SINAVTARIH] ,[OZEL] ,[FREKANSHESAPLA] ,[PUANGIZLE] ,[YUKLEMEKAPAT] ,[CEVAPANAHTARIYUKLEMEKAPAT],ONLINESINAV,[YANLISSAYISI], [OLCEKSINAVI], [KYE_TCKIMLIKNO],YONERGE_GUID)
						OUTPUT INSERTED.ID_SINAV INTO @ID_SINAVLIST(ID_SINAV)
						select		[ID_SINAVTURU] ,[AD] ,[KOD] ,[RAPORBASLIK] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM],[ID_KADEME3] ,convert(datetime, [SINAVTARIH], 103) ,[OZEL] ,[FREKANSHESAPLA] ,CASE WHEN (SELECT COUNT(1) FROM SinavPuanTuru WHERE ID_SINAVTURU=J.[ID_SINAVTURU])>0 THEN [PUANGIZLE] ELSE 1 END ,[YUKLEMEKAPAT] ,[CEVAPANAHTARIYUKLEMEKAPAT],ONLINESINAV ,[YANLISSAYISI] ,[OLCEKSINAVI] ,@TCKIMLIKNO ,@GUID
						from OPENJSON(@SQLJSON)
						with
						(
							[ID_SINAVTURU] [int],
							[AD] [varchar](50),
							[KOD] [varchar](50),
							[RAPORBASLIK] [varchar](MAX),
							[ID_KADEME3] [nchar](10),
							[SINAVTARIH] [varchar](50),
							[OZEL] [bit],
							[FREKANSHESAPLA] [bit],
							[PUANGIZLE] [bit],
							[YUKLEMEKAPAT] [bit],
							[CEVAPANAHTARIYUKLEMEKAPAT] [bit],
							[ONLINESINAV] [bit],
							[YANLISSAYISI] [tinyint],
							[OLCEKSINAVI] [bit]
						) AS J

						SET @ID_SINAV = (select TOP 1 ID_SINAV from @ID_SINAVLIST)
						
						--SET @ONLINESINAV = IIF (EXISTS((SELECT TOP 1 1 FROM Sinav S WHERE ID_SINAV = (select ID_SINAV from @ID_SINAVLIST) AND S.ONLINESINAV = 1)),1, 0 )
						-------------
						--SINAVDERS--
						-------------
						DECLARE @SINAVDERS TABLE (ID_SINAVDERS INT,ID_DERS varchar(20), BOLUMNO int)
						INSERT INTO [dbo].[SinavDers]
								   ([ID_SINAV]
								   ,[BOLUMNO]
								   ,[ID_DERS]
								   ,[TAKMAAD])
						output INSERTED.ID_SINAVDERS, inserted.ID_DERS, inserted.BOLUMNO into @SINAVDERS(ID_SINAVDERS, ID_DERS, BOLUMNO)
						select @ID_SINAV as [ID_SINAV], SIRA as [BOLUMNO], ID_DERS=id, CASE WHEN TAKMAAD='' THEN text ELSE TAKMAAD END as TAKMAAD from OPENJSON(@SQLJSON,'$.JSONDERS')
						with
						(
							id varchar(20),
							SIRA int,
							text varchar(max),
							TAKMAAD varchar(max)
						)
						------------
						--KITAPCIK--
						------------
						DECLARE @KITAPCIKSAYISI int = (select KITAPCIKSAYISI from OPENJSON(@SQLJSON)with(KITAPCIKSAYISI int))

						--IF @ONLINESINAV = 1
						--	SET @KITAPCIKSAYISI = 1



						CREATE TABLE #HARFLER (AD char(1))
						DECLARE @asciiCode INT= 65 WHILE @asciiCode <= 90 BEGIN
							INSERT  #HARFLER (AD) SELECT  CHAR(@asciiCode)
							SELECT  @asciiCode = @asciiCode + 1
						END

						DECLARE @ID_SINAVKITAPCIK TABLE (ID_SINAVKITAPCIK INT, AD CHAR(1))
						INSERT INTO [dbo].[SinavKitapcik]
								   ([ID_SINAV]
								   ,[AD])
						output INSERTED.ID_SINAVKITAPCIK, INSERTED.AD into @ID_SINAVKITAPCIK(ID_SINAVKITAPCIK, AD)
						select top(@KITAPCIKSAYISI)@ID_SINAV as [ID_SINAV], AD from #HARFLER ORDER BY AD
						drop table #HARFLER
						------------------
						--SINAVANAHTAR A--
						------------------
						INSERT INTO [dbo].[SinavAnahtar]
								   ([ID_SINAVKITAPCIK]
								   ,[ID_SINAVDERS]
								   ,[ID_SINAVSORUTURU]
								   ,[SORUNO_A]
								   ,[CEVAP]
								   ,[OPTIKKARAKTERSAYISI]
								   ,[KOD]
								   ,[KATSAYI]
								   ,[SORUNO]
								   ,[ID_BILGI]
								   ,[ID_BILISSELSUREC]
								   ,ID_SORUBANKASI)
						SELECT
							(select ID_SINAVKITAPCIK from @ID_SINAVKITAPCIK WHERE AD='A'),
							sd.ID_SINAVDERS as ID_SINAVDERS,
							JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
							JSON_Value (s.value, '$.SORUNO') as SORUNOA, 
							CEVAP = CASE	WHEN SBC.ID_CEVAP	IS NULL THEN JSON_Value (s.value, '$.ACEVAP')
											WHEN SBC.CEVAPNO = 1		THEN 'A'
											WHEN SBC.CEVAPNO = 2		THEN 'B'
											WHEN SBC.CEVAPNO = 3		THEN 'C'
											WHEN SBC.CEVAPNO = 4		THEN 'D'
											WHEN SBC.CEVAPNO = 5		THEN 'E'
										END,
							--JSON_Value (s.value, '$.ACEVAP') as CEVAP,
							JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (s.value, '$.KOD') as KOD,
							CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
							JSON_Value (s.value, '$.SORUNO') as SORUNO ,
							JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI ,
							JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
							SSD.ID_SORU
						FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
						CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
						INNER JOIN @SINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')						
						LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
						LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV
						LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
						LEFT JOIN SoruBankasi.dbo.Cevap		SBC	ON	SBC.ID_SORU	= SSD.ID_SORU AND DEGER = '1'


						DELETE from @ID_SINAVKITAPCIK where ID_SINAVKITAPCIK=(select ID_SINAVKITAPCIK from @ID_SINAVKITAPCIK WHERE AD='A')--A kitapçığı siliniyor

						----------------------
						--SINAVANAHTAR DIGER--
						----------------------
						declare @ID int=(select min(ID_SINAVKITAPCIK) from @ID_SINAVKITAPCIK)
						while @ID is not null
						begin
							INSERT INTO [dbo].[SinavAnahtar]
									   ([ID_SINAVKITAPCIK]
									   ,[ID_SINAVDERS]
									   ,[ID_SINAVSORUTURU]
									   ,[SORUNO_A]
									   ,[CEVAP]
									   ,[OPTIKKARAKTERSAYISI]
									   ,[KOD]
									   ,[KATSAYI]
									   ,[SORUNO]
									   ,[ID_BILGI]
									   ,[ID_BILISSELSUREC]
									   ,ID_SORUBANKASI)
							select 
								ID_SINAVKITAPCIK = @ID,
								sd.ID_SINAVDERS as ID_SINAVDERS,
								JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
								JSON_Value (s.value, '$.SORUNO') as SORUNOA,
								JSON_Value (s.value, '$.ACEVAP') as CEVAP,
								JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
								JSON_Value (s.value, '$.KOD') as KOD,
								CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
								JSON_Value (k.value, '$.SIRA') as SORUNO,  
								JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI ,
								JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
								SSD.ID_SORU
							FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
							CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
							CROSS APPLY OPENJSON (s.value, '$.KARSILIKLIST') as k
							INNER JOIN @SINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
							LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
							LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
							LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
							where JSON_Value (k.value, '$.KITAPCIK')=(select AD from SinavKitapcik where ID_SINAVKITAPCIK = @ID)

							select @ID = min(ID_SINAVKITAPCIK) from @ID_SINAVKITAPCIK where ID_SINAVKITAPCIK > @ID
						end
						select ID_SINAV = @ID_SINAV
						COMMIT TRANSACTION [Tran4]
					END TRY
					BEGIN CATCH
						ROLLBACK TRANSACTION [Tran4]

						SELECT 
							@ErrorSeverity	= ERROR_SEVERITY(),
							@ErrorState		= ERROR_STATE()
							
						SELECT @MSG = 'Kayıt işlemi sırasında sistemsel bir hata meydana geldi! Lütfen daha sonra tekrar deneyiniz...'
			
						RAISERROR (@MSG , -- Message text.
									@ErrorSeverity, -- Severity.
									@ErrorState -- State.
									);
					END CATCH;
				END
				IF @ISLEM = 5	--	Sınav Listele
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,S.RAPORBASLIK
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.CEVAPANAHTARIYUKLEMEKAPAT AS CEVAPANAHTARIYUKLEMEKAPAT
							,S.ONLINESINAV
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3ESKI and S.AKTIF = 1
						AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 6	--	Sınav Bilgi Getir
				BEGIN

					--SELECT SD.ID_DERS, A.KOD, A.AD
					--INTO #SinavDers FROM SinavDers	SD
					----CROSS APPLY [dbo].[fn_DersUniteListe](SD.ID_DERS, NULL)	DU
					--INNER JOIN v3SinavDersUnite		A	ON A.ID_DERS = SD.ID_DERS
					--WHERE SD.ID_SINAV = @ID_SINAV

					DECLARE @ID_SINAVKITAPCIKX INT = (select  top 1  ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD='A')

					Select (
						Select 
							ID_SINAVTURU, 
							s.AD as AD, 
							(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) as KITAPCIKSAYISI, 
							s.KOD, 
							s.RAPORBASLIK,
							ID_KADEME3, 
							Convert(varchar, SINAVTARIH, 103) as SINAVTARIH,
							OZEL,
							FREKANSHESAPLA,
							PUANGIZLE,
							YUKLEMEKAPAT,
							CEVAPANAHTARIYUKLEMEKAPAT,
							ONLINESINAV,
							YANLISSAYISI,
							OLCEKSINAVI,
							s.YONERGE_GUID as YONERGE,
							JSONDERS.ID_DERS as id,
							JSONDERS.ID_SINAVDERS as id_sinavders,
							JSONDERS.TAKMAAD as text,
							(select count(1)/(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) from SinavAnahtar sa where ID_SINAVDERS=JSONDERS.ID_SINAVDERS) as SORUSAYISI,
							JSONDERS.BOLUMNO as SIRA,
							SORULIST.SORUNO_A as SORUNO,
							SORULIST.ID_SINAVSORUTURU as SORUTURU,
							SORULIST.CEVAP as ACEVAP,
							SORULIST.KOD,
							ISNULL(CAST(SORULIST.ID_SORUBANKASI AS VARCHAR), '') AS ID_SORUBANKASI,
							ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
							ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC, 
							UNITE = ISNULL(SD.AD, ''), 
							SORULIST.OPTIKKARAKTERSAYISI as KARAKTERSAYISI,
							SORULIST.KATSAYI,
							(select (select AD from SinavKitapcik where ID_SINAVKITAPCIK=ssa.ID_SINAVKITAPCIK) as KITAPCIK
								, SORUNO as SIRA 
							from SinavAnahtar ssa 
							where ID_SINAVKITAPCIK in (	select ID_SINAVKITAPCIK 
														from SinavKitapcik 
														where	ID_SINAV=@ID_SINAV 
															and AD<>'A') 
								and SORUNO_A=SORULIST.SORUNO 
								and ID_SINAVDERS=JSONDERS.ID_SINAVDERS 
							for json path) AS KARSILIKLIST
							,s.DONEM
						from	   Sinav			s
						inner join SinavDers		JSONDERS		on	JSONDERS.ID_SINAV		= s.ID_SINAV 
						LEFT  join SinavAnahtar		SORULIST		on	SORULIST.ID_SINAVDERS	= JSONDERS.ID_SINAVDERS and SORULIST.ID_SINAVKITAPCIK=@ID_SINAVKITAPCIKX
						LEFT  JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
						where s.ID_SINAV = @ID_SINAV
						order by BOLUMNO,SORULIST.SORUNO_A
					for json auto) as J

					--DROP TABLE #SinavDers

				END
				IF @ISLEM = 7	--	Sınav Güncelle
				BEGIN					
					BEGIN TRANSACTION [Tran7]
					BEGIN TRY    
						---------
						--SINAV--
						---------
						UPDATE S
							
						SET
							 [ID_SINAVTURU] = J.ID_SINAVTURU
							,[AD] = J.AD
							,[KOD] = J.KOD
							,[RAPORBASLIK] = J.RAPORBASLIK
							,[ID_KADEME3] = IIF(J.ID_KADEME3 = 0 , S.ID_KADEME3, J.ID_KADEME3)
							,[SINAVTARIH] = convert(datetime, J.SINAVTARIH, 103)
							,[OZEL] = J.OZEL
							,[FREKANSHESAPLA] = J.FREKANSHESAPLA
							,[PUANGIZLE] = CASE WHEN (SELECT COUNT(1) FROM SinavPuanTuru WHERE ID_SINAVTURU=J.ID_SINAVTURU)>0 THEN J.[PUANGIZLE] ELSE 1 END
							,[YUKLEMEKAPAT] = J.YUKLEMEKAPAT
							,[CEVAPANAHTARIYUKLEMEKAPAT]  = J.CEVAPANAHTARIYUKLEMEKAPAT
							,[ONLINESINAV] = J.[ONLINESINAV]
							,[YANLISSAYISI] = J.YANLISSAYISI
							,[OLCEKSINAVI] = J.OLCEKSINAVI
							,[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							,[GUN_TARIH] = GETDATE()
							,[YONERGE_GUID] = @GUID
						FROM [dbo].[Sinav] S
						JOIN OPENJSON(@SQLJSON)
							with
							(
								[ID_SINAVTURU] [int],
								[AD] [varchar](50),
								[KOD] [varchar](50),
								[RAPORBASLIK] [varchar](MAX),
								[ID_KADEME3] int,
								[SINAVTARIH] [varchar](50),
								[OZEL] [bit],
								[FREKANSHESAPLA] [bit],
								[PUANGIZLE] [bit],
								[YUKLEMEKAPAT] [bit],
								[CEVAPANAHTARIYUKLEMEKAPAT]  [bit],
								[ONLINESINAV]  [bit],
								[YANLISSAYISI] [tinyint],
								[OLCEKSINAVI] [bit]
							) as J ON 1 = 1
						WHERE S.ID_SINAV = @ID_SINAV
							
						SET @ONLINESINAV = (SELECT TOP 1 ONLINESINAV FROM Sinav S WHERE ID_SINAV = @ID_SINAV )
						---------------
						--SORUBANKASI--
						---------------
						SELECT SI.ID_SORUILISKI, SD.ID_SINAV, SD.ID_DERS, SORUNO_A
						INTO #TEMPSORUILISKI
						FROM SinavAnahtar SA
						INNER JOIN SinavKitapcik SK ON SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK
						INNER JOIN SinavDers SD ON SD.ID_SINAVDERS = SA.ID_SINAVDERS
						INNER JOIN SoruBankasi.dbo.SoruIliski SI ON SI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						WHERE SK.ID_SINAV = @ID_SINAV AND SK.AD = 'A'

						IF @ONLINESINAV = 1
							SELECT	 SA.ID_SINAVANAHTAR
									,OS.ID_ONLINESINAVOGRENCICEVAP
									,SA.SORUNO_A
									,SD.BOLUMNO
									,OS.ID_CEVAP
							INTO #SINAVANAHTAR
							FROM SinavDers						SD
							JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
							JOIN Tbl_OnlineSinavOgrenciCevap	OS	ON	OS.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
							WHERE SD.ID_SINAV	= @ID_SINAV

						---------
						--Silme--
						---------
						DELETE sa
						FROM SinavAnahtar sa
						INNER JOIN SinavKitapcik sk
							ON sk.ID_SINAVKITAPCIK=sa.ID_SINAVKITAPCIK
						WHERE sk.ID_SINAV=@ID_SINAV

						DELETE sk
						FROM SinavKitapcik sk
						WHERE sk.ID_SINAV=@ID_SINAV

						--SINAV KRİTER
						SELECT SNK.*, SNKD.ID_SINAVDERS, SD.TAKMAAD, SD.ID_DERS
						INTO #TempSinavNetKriterDers
						FROM [Pusulam].[dbo].[SinavNetKriter] SNK
						JOIN [Pusulam].[dbo].[SinavNetKriterDers] SNKD ON SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
						JOIN [Pusulam].[dbo].[SinavDers] SD ON SD.ID_SINAVDERS = SNKD.ID_SINAVDERS
						WHERE SD.ID_SINAV = @ID_SINAV

						SELECT DISTINCT ID_SINAVNETKRITER, NET, ID_SINAVPUANTURU
						INTO #TempSinavNetKriter
						FROM #TempSinavNetKriterDers

						SELECT *
						INTO #TempSinavTYTSecimTurKriter
						FROM [Pusulam].[dbo].[SinavTYTSecimTurKriter]
						WHERE ID_SINAV = @ID_SINAV

						--TempSinavOptikDers
						SELECT sd.ID_SINAV,sd.ID_DERS,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM,TAKMAAD INTO #TempSinavOptikDers 
						FROM SinavOptikDers sod
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV						

						DELETE sod
						FROM SinavOptikDers sod
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						--TempSinavKatsayi
						SELECT sd.ID_SINAV,sd.TAKMAAD,ID_SINAVPUANTURU,KATSAYI INTO #TempSinavKatsayi
						FROM SinavKatsayi sk
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sk.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE sk
						FROM SinavKatsayi sk
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sk.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE sd
						FROM SinavDers sd
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE soc
						FROM SinavOgrenciCevap soc
						INNER JOIN SinavOgrenciCevapBolum socb on socb.ID_SINAVOGRENCICEVAPBOLUM=soc.ID_SINAVOGRENCICEVAPBOLUM
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=socb.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE socb
						FROM SinavOgrenciCevapBolum socb
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=socb.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE sos
						FROM SinavOgrenciSonuc sos
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=sos.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE sop
						FROM SinavOgrenciPuan sop					
						WHERE sop.ID_SINAV=@ID_SINAV

						DELETE sot
						FROM SinavOgrenciToplam sot
						WHERE sot.ID_SINAV=@ID_SINAV

						DELETE so
						FROM SinavOgrenci so
						WHERE so.ID_SINAV=@ID_SINAV

						-------------
						--SINAVDERS--
						-------------
						DECLARE @USINAVDERS TABLE (ID_SINAVDERS INT,ID_DERS varchar(20), BOLUMNO int)
						INSERT INTO [dbo].[SinavDers]
									([ID_SINAV]
									,[BOLUMNO]
									,[ID_DERS]
									,[TAKMAAD])
						output INSERTED.ID_SINAVDERS, inserted.ID_DERS, inserted.BOLUMNO into @USINAVDERS(ID_SINAVDERS, ID_DERS, BOLUMNO)
						select @ID_SINAV as [ID_SINAV], SIRA as [BOLUMNO], ID_DERS=id, CASE WHEN TAKMAAD='' THEN text ELSE TAKMAAD END as TAKMAAD 
						from OPENJSON(@SQLJSON,'$.JSONDERS')
						with
						(
							id varchar(20),
							SIRA int,
							text varchar(max),
							TAKMAAD varchar(max)
						)

						--------------------------------------------
						--EŞLEŞEN OPTİK VE KATSAYILARI GERİ KAYDET--
						--------------------------------------------
						INSERT INTO [dbo].[SinavOptikDers]
									([ID_SINAVDERS]
									,[BASLANGIC]
									,[OPTIKKARAKTERSAYISI]
									,[OTURUM])
								SELECT SD.ID_SINAVDERS, TSOD.BASLANGIC, TSOD.OPTIKKARAKTERSAYISI,OTURUM FROM #TempSinavOptikDers TSOD
								INNER JOIN SinavDers SD ON SD.ID_SINAV=TSOD.ID_SINAV AND SD.ID_DERS=TSOD.ID_DERS AND SD.TAKMAAD=TSOD.TAKMAAD
						DROP TABLE #TempSinavOptikDers

						INSERT INTO [dbo].[SinavKatsayi]
									([ID_SINAV]
									,[ID_SINAVPUANTURU]
									,[ID_SINAVDERS]
									,[KATSAYI])
								SELECT TSK.ID_SINAV, TSK.ID_SINAVPUANTURU, SD.ID_SINAVDERS, TSK.KATSAYI FROM #TempSinavKatsayi TSK
								INNER JOIN SinavDers SD ON SD.ID_SINAV=TSK.ID_SINAV AND SD.TAKMAAD=TSK.TAKMAAD
						DROP TABLE #TempSinavKatsayi

						--------------------------------------------
						--EŞLEŞEN KRİTERLERİ GERİ KAYDET--
						--------------------------------------------
						DECLARE @ID_SINAVNETKRITERTABLE7 TABLE (ID_SINAVNETKRITER INT, ID_SINAVNETKRITERESKI INT)
						MERGE INTO SinavNetKriter 
						USING #TempSinavNetKriter AS TEMP ON 1 = 0
						WHEN NOT MATCHED THEN
						INSERT ([NET] ,[ID_SINAVPUANTURU])
						VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
						OUTPUT TEMP.ID_SINAVNETKRITER, inserted.ID_SINAVNETKRITER
						INTO @ID_SINAVNETKRITERTABLE7 (ID_SINAVNETKRITERESKI, ID_SINAVNETKRITER);

						INSERT INTO SinavNetKriterDers (ID_SINAVNETKRITER, ID_SINAVDERS)
						SELECT DISTINCT ID_SNK.ID_SINAVNETKRITER, SD.ID_SINAVDERS
						FROM @ID_SINAVNETKRITERTABLE7 ID_SNK
						JOIN #TempSinavNetKriterDers SNKD ON SNKD.ID_SINAVNETKRITER = ID_SNK.ID_SINAVNETKRITERESKI
						JOIN SinavDers SD ON SD.ID_SINAV = @ID_SINAV AND SD.ID_DERS = SNKD.ID_DERS AND SD.TAKMAAD = SNKD.TAKMAAD

						INSERT INTO SinavTYTSecimTurKriter (ID_SINAV, ID_TYTSECIMTUR, PUAN)
						SELECT DISTINCT ID_SINAV, ID_TYTSECIMTUR, PUAN
						FROM #TempSinavTYTSecimTurKriter
						
						DROP TABLE #TempSinavNetKriter
						DROP TABLE #TempSinavNetKriterDers
						DROP TABLE #TempSinavTYTSecimTurKriter

						------------
						--KITAPCIK--
						------------
						DECLARE @UKITAPCIKSAYISI int = (select KITAPCIKSAYISI from OPENJSON(@SQLJSON)with(KITAPCIKSAYISI int))
												
						--IF @ONLINESINAV = 1
						--	SET @UKITAPCIKSAYISI = 1

						CREATE TABLE #UHARFLER (AD char(1))
						DECLARE @UasciiCode INT= 65 WHILE @UasciiCode <= 90 BEGIN
							INSERT  #UHARFLER (AD) SELECT  CHAR(@UasciiCode)
							SELECT  @UasciiCode = @UasciiCode + 1
						END

						DECLARE @UID_SINAVKITAPCIK TABLE (ID_SINAVKITAPCIK INT, AD CHAR(1))
						INSERT INTO [dbo].[SinavKitapcik]
									([ID_SINAV]
									,[AD])
						output INSERTED.ID_SINAVKITAPCIK, inserted.AD into @UID_SINAVKITAPCIK(ID_SINAVKITAPCIK, AD)
						select top(@UKITAPCIKSAYISI)@ID_SINAV as [ID_SINAV], AD from #UHARFLER ORDER BY AD
						drop table #UHARFLER

						------------------
						--SINAVANAHTAR A--
						------------------
						INSERT INTO [dbo].[SinavAnahtar]
									([ID_SINAVKITAPCIK]
									,[ID_SINAVDERS]
									,[ID_SINAVSORUTURU]
									,[SORUNO_A]
									,[CEVAP]
									,[OPTIKKARAKTERSAYISI]
									,[KOD]
									,[KATSAYI]
									,[SORUNO]
									,[ID_BILGI]
									,[ID_BILISSELSUREC]
									,[ID_SORUBANKASI])
						SELECT
							(select ID_SINAVKITAPCIK from @UID_SINAVKITAPCIK WHERE AD = 'A'),
							sd.ID_SINAVDERS as ID_SINAVDERS,
							JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
							JSON_Value (s.value, '$.SORUNO') as SORUNOA, 
							
							CEVAP = CASE	WHEN SBC.ID_CEVAP	IS NULL THEN JSON_Value (s.value, '$.ACEVAP')
											WHEN SBC.CEVAPNO = 1		THEN 'A'
											WHEN SBC.CEVAPNO = 2		THEN 'B'
											WHEN SBC.CEVAPNO = 3		THEN 'C'
											WHEN SBC.CEVAPNO = 4		THEN 'D'
											WHEN SBC.CEVAPNO = 5		THEN 'E'
										END,
							--JSON_Value (s.value, '$.ACEVAP') as CEVAP,
							JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (s.value, '$.KOD') as KOD,
							CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
							JSON_Value (s.value, '$.SORUNO') as SORUNO,  
							JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI,
							JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
							SSD.ID_SORU
						FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
						CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
						INNER JOIN @USINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
						LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
						LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
						LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
						LEFT JOIN SoruBankasi.dbo.Cevap		SBC	ON	SBC.ID_SORU	= SSD.ID_SORU AND DEGER = '1'
						
						DELETE from @UID_SINAVKITAPCIK where ID_SINAVKITAPCIK=(select ID_SINAVKITAPCIK from @UID_SINAVKITAPCIK WHERE AD = 'A')--A kitapçığı siliniyor

						----------------------
						--SINAVANAHTAR DIGER--
						----------------------
						declare @UID int=(select min(ID_SINAVKITAPCIK) from @UID_SINAVKITAPCIK)
						while @UID is not null
						begin
							INSERT INTO [dbo].[SinavAnahtar]
										([ID_SINAVKITAPCIK]
										,[ID_SINAVDERS]
										,[ID_SINAVSORUTURU]
										,[SORUNO_A]
										,[CEVAP]
										,[OPTIKKARAKTERSAYISI]
										,[KOD]
										,[KATSAYI]
										,[SORUNO]
										,[ID_BILGI]
										,[ID_BILISSELSUREC]
										,[ID_SORUBANKASI])
							select 
								ID_SINAVKITAPCIK = @UID,
								sd.ID_SINAVDERS as ID_SINAVDERS,
								JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
								JSON_Value (s.value, '$.SORUNO') as SORUNOA,
								JSON_Value (s.value, '$.ACEVAP') as CEVAP,
								JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
								JSON_Value (s.value, '$.KOD') as KOD,
								CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
								JSON_Value (k.value, '$.SIRA') as SORUNO,  
								JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI,
								JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
								SSD.ID_SORU
							FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
							CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
							CROSS APPLY OPENJSON (s.value, '$.KARSILIKLIST') as k
							INNER JOIN @USINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
							LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
							LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
							LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD') AND SSD.SILINDI = 0
							where JSON_Value (k.value, '$.KITAPCIK')=(select AD from SinavKitapcik where ID_SINAVKITAPCIK = @UID)

							select @UID = min(ID_SINAVKITAPCIK) from @UID_SINAVKITAPCIK where ID_SINAVKITAPCIK > @UID
						END
						
						IF @ONLINESINAV = 1
						BEGIN
							UPDATE OS SET
								OS.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
							FROM SinavDers						SD
							JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
							JOIN #SINAVANAHTAR					T	ON	T.BOLUMNO						= SD.BOLUMNO
																	AND T.SORUNO_A						= SA.SORUNO_A
							JOIN SoruBankasi.dbo.SoruDetay		SBD	ON	SBD.ID_SORU						= SA.ID_SORUBANKASI
							JOIN SoruBankasi.dbo.Cevap			C	ON	C.ID_CEVAP						= T.ID_CEVAP
																	AND C.ID_SORU						= SBD.ID_SORU
							JOIN Tbl_OnlineSinavOgrenciCevap	OS	ON	OS.ID_ONLINESINAVOGRENCICEVAP	= T.ID_ONLINESINAVOGRENCICEVAP
																	AND OS.ID_SINAVANAHTAR				= T.ID_SINAVANAHTAR
							WHERE SD.ID_SINAV = @ID_SINAV
						END
			
						DELETE FROM Tbl_OnlineSinavOgrenciCevap
						WHERE ID_ONLINESINAVOGRENCICEVAP NOT IN ( 
							SELECT OC.ID_ONLINESINAVOGRENCICEVAP
							FROM SinavAnahtar					SA
							JOIN SoruBankasi.dbo.Cevap			C	ON	C.ID_SORU			= SA.ID_SORUBANKASI
							JOIN Tbl_OnlineSinavOgrenciCevap	OC	ON	OC.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
																	AND OC.ID_CEVAP			= C.ID_CEVAP
							)

						UPDATE Sinav SET DURUM = 0 WHERE ID_SINAV = @ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR

						---------------
						--SORUBANKASI--
						---------------
						UPDATE SI SET SI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						FROM SoruBankasi.dbo.SoruIliski SI
						INNER JOIN #TEMPSORUILISKI T ON T.ID_SORUILISKI = SI.ID_SORUILISKI
						INNER JOIN SinavDers SD ON SD.ID_SINAV = T.ID_SINAV AND SD.ID_DERS = T.ID_DERS
						INNER JOIN SinavKitapcik SK ON SK.ID_SINAV = T.ID_SINAV AND SK.AD = 'A'
						INNER JOIN SinavAnahtar SA ON SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK AND SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.SORUNO_A = T.SORUNO_A

						DROP TABLE IF EXISTS #TEMPSORUILISKI
						COMMIT TRANSACTION [Tran7]
					END TRY
					BEGIN CATCH
						ROLLBACK TRANSACTION [Tran7]

						SELECT 
							@ErrorSeverity	= ERROR_SEVERITY(),
							@ErrorState		= ERROR_STATE()
							
						SELECT @MSG = 'Güncelleme işlemi sırasında sistemsel bir hata meydana geldi! Lütfen daha sonra tekrar deneyiniz...'
			
						RAISERROR (@MSG , -- Message text.
									@ErrorSeverity, -- Severity.
									@ErrorState -- State.
									);
					END CATCH;
				END
				IF @ISLEM = 8	--	Sınav Ders Konu Listele
				BEGIN
				
					EXEC [dbo].[sp_DersUniteGetir] @ID_DERS = @ID_DERS

					--SELECT ID_DERS, KOD, AD, SECILEBILIR FROM [dbo].[fn_DersUniteListe](@ID_DERS, NULL)			
				
				END
				IF @ISLEM = 9	--	Sınav Katsayı Listele
				BEGIN
					SELECT
					(
						SELECT	 ID_SINAV = @ID_SINAV
								,SPT.ID_SINAVPUANTURU
								,PUANTURU = SPT.AD
								,KATSAYILIST = ISNULL(
								(
									SELECT	 SK.ID_SINAVKATSAYI
											,S.ID_SINAV
											,SPT.ID_SINAVPUANTURU
											,SD.ID_SINAVDERS
											,DERS = SD.TAKMAAD
											,ISNULL(CONVERT(DECIMAL(18,10 ), SK.KATSAYI), 0) AS KATSAYI 
									FROM SinavDers SD
									INNER JOIN Sinav S on S.ID_SINAV = SD.ID_SINAV
									LEFT JOIN SinavKatsayi SK on SK.ID_SINAV = S.ID_SINAV AND SK.ID_SINAVDERS = SD.ID_SINAVDERS
									WHERE s.ID_SINAV = @ID_SINAV AND (sk.ID_SINAVPUANTURU IS NULL OR SK.ID_SINAVPUANTURU=SPT.ID_SINAVPUANTURU) 
									ORDER BY SD.BOLUMNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								), '[]')
								,KRITERLIST = ISNULL(
								(
									SELECT	 ID_SINAVPUANTURU	= SPT.ID_SINAVPUANTURU
											,NET				= SNK.NET
											,ID_SINAVDERSLIST	= dbo.ufnToRawJsonArray((SELECT ID_SINAVDERS FROM SinavNetKriterDers SNKD WHERE SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER FOR JSON PATH), 'ID_SINAVDERS')
									FROM SinavNetKriter SNK
									WHERE SNK.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU
									AND SNK.ID_SINAVNETKRITER IN (SELECT ID_SINAVNETKRITER FROM SinavNetKriterDers WHERE ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV))
									FOR JSON PATH
								), '[]')
								,SINAVDERSLIST = ISNULL(
								(
									SELECT	ID_SINAVDERS, AD = TAKMAAD
									FROM SinavDers
									WHERE ID_SINAV = @ID_SINAV
									FOR JSON PATH
								), '[]')
								,STP.ID_SINAVTABANPUAN AS ID_SINAVTABANPUAN
								,ISNULL(STP.TABANPUAN, 0) AS TABANPUAN
						FROM SinavPuanTuru SPT
						LEFT JOIN SinavTabanPuan STP ON STP.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU AND STP.ID_SINAV = @ID_SINAV
						WHERE ID_SINAVTURU = (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV)
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS RESULT
				END
				IF @ISLEM = 10	--	Sınav Katsayı - Taban Puan Keydet
				BEGIN
					--TABAN PUAN INSERT
					DELETE FROM SinavTabanPuan WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavTabanPuan]
								([ID_SINAV]
								,[ID_SINAVPUANTURU]
								,[TABANPUAN])
					SELECT
							JSON_Value (j.value, '$.ID_SINAV') as ID_SINAV,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU, 
							ISNULL(JSON_Value (j.value, '$.TABANPUAN'),0) as TABANPUAN
					FROM OPENJSON (@SQLJSON) as j
					--WHERE JSON_Value (j.value, '$.ID_SINAVTABANPUAN') is null

					--TABAN PUAN UPDATE
					--UPDATE [dbo].[SinavTabanPuan]
					--SET	[TABANPUAN] = JSON_Value (j.value, '$.TABANPUAN')
					--FROM
					--	[dbo].[SinavTabanPuan] stp
					--	INNER JOIN OPENJSON (@SQLJSON) j
					--		ON JSON_Value (j.value, '$.ID_SINAVTABANPUAN') = stp.ID_SINAVTABANPUAN
					--WHERE
					--	JSON_Value (j.value, '$.ID_SINAVTABANPUAN') IS NOT NULL

					--KATSAYI INSERT
				

					DELETE FROM [SinavKatsayi] WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavKatsayi]
								([ID_SINAV]
								,[ID_SINAVPUANTURU]
								,[ID_SINAVDERS]
								,[KATSAYI])
					SELECT	DISTINCT
							JSON_Value (j.value, '$.ID_SINAV') as ID_SINAV,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU, 
							JSON_Value (j.value, '$.ID_SINAVDERS') as ID_SINAVDERS,
							ISNULL(REPLACE(JSON_Value (j.value, '$.KATSAYI'),',','.'),0.0) as KATSAYI
					FROM OPENJSON(@SQLJSON) as parent
					CROSS APPLY OPENJSON (parent.value, '$.KATSAYILIST') as j
					--WHERE JSON_Value (j.value, '$.KATSAYI') IS NOT NULL


					--KRİTER--
					DECLARE @ID_SINAVNETKRITERTABLE TABLE (ID_SINAVNETKRITER INT, GUID VARCHAR(MAX))

					DELETE SNK 
					FROM [SinavNetKriter] SNK
					JOIN SinavNetKriterDers SNKD ON SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
					WHERE SNKD.ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV)

					SELECT	DISTINCT
							ISNULL(REPLACE(JSON_Value (j.value, '$.NET'),',','.'),0.0) as NET,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU,
							JSON_Value (j.value, '$.GUID') as GUID
					INTO #SINAVNETKRITER
					FROM OPENJSON(@SQLJSON) as parent
					CROSS APPLY OPENJSON (parent.value, '$.KRITERLIST') as j

					SELECT	 GUID = JSON_Value (KRITERLIST.value, '$.GUID')
							,ID_SINAVDERS = ID_SINAVDERSLIST.value
					INTO #SINAVNETKRITERDERS
					FROM OPENJSON(@SQLJSON) J
					CROSS APPLY OPENJSON (J.value, '$.KRITERLIST') as KRITERLIST
					CROSS APPLY OPENJSON (KRITERLIST.value, '$.ID_SINAVDERSLIST') as ID_SINAVDERSLIST

					MERGE INTO SinavNetKriter 
					USING #SINAVNETKRITER AS TEMP ON 1 = 0
					WHEN NOT MATCHED THEN
					INSERT ([NET] ,[ID_SINAVPUANTURU])
					VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
					OUTPUT TEMP.GUID, inserted.ID_SINAVNETKRITER
					INTO @ID_SINAVNETKRITERTABLE (GUID, ID_SINAVNETKRITER);

					INSERT INTO SinavNetKriterDers (ID_SINAVNETKRITER, ID_SINAVDERS)
					SELECT ID_SINAVNETKRITER, SNKD.ID_SINAVDERS
					FROM @ID_SINAVNETKRITERTABLE ID_SNK
					JOIN #SINAVNETKRITERDERS SNKD ON SNKD.GUID = ID_SNK.GUID

					DROP TABLE IF EXISTS #SINAVNETKRITER
					DROP TABLE IF EXISTS #SINAVNETKRITERDERS
					--KRİTER--

					--KATSAYI UPDATE
					--UPDATE [dbo].[SinavKatsayi]
					--SET [KATSAYI] = k.KATSAYI
					--FROM
					--	[dbo].[SinavKatsayi] sk
					--	INNER JOIN (SELECT JSON_Value (j.value, '$.ID_SINAVKATSAYI') as ID_SINAVKATSAYI, REPLACE(JSON_Value (j.value, '$.KATSAYI'),',','.') as KATSAYI FROM OPENJSON(@SQLJSON) as parent CROSS APPLY OPENJSON (parent.value, '$.KATSAYILIST') as j) k on k.ID_SINAVKATSAYI=sk.ID_SINAVKATSAYI
					--WHERE k.ID_SINAVKATSAYI IS NOT NULL and k.KATSAYI IS NOT NULL
				END
				IF @ISLEM = 11	--	Sınav Optik Listele
				BEGIN
					SELECT [ID_SINAVOPTIKSABIT] as ID	
						  ,ILISKI=so.ID_SINAVOPTIK
						  ,[BASLANGIC]
						  ,[OPTIKKARAKTERSAYISI] as KARAKTERSAYISI
						  ,TUR=1
						  ,AD=so.AD
						  ,OTURUM=1
						  ,BOLUMNO=0
					  INTO #TEMPOPTIK
					  FROM [SinavOptik]				so
					  LEFT JOIN [SinavOptikSabit]	sos on sos.ID_SINAVOPTIK=so.ID_SINAVOPTIK and sos.ID_SINAV=@ID_SINAV
					  ORDER BY sos.ID_SINAVOPTIKSABIT
			
					SELECT [ID_SINAVOPTIKDERS] as ID
						  ,sd.[ID_SINAVDERS] as ILISKI
						  ,[BASLANGIC]
						  ,[OPTIKKARAKTERSAYISI] as KARAKTERSAYISI
						  ,TUR=2
						  ,AD=sd.TAKMAAD
						  ,ISNULL(sod.OTURUM,1) AS OTURUM
						  ,sd.BOLUMNO
					  INTO #TEMPOPTIK2
					  FROM [SinavDers]				sd
					  LEFT JOIN [SinavOptikDers]	sod on sod.ID_SINAVDERS=sd.ID_SINAVDERS
					  WHERE sd.ID_SINAV=@ID_SINAV

					 SELECT *  FROM #TEMPOPTIK
					 UNION
					 SELECT * FROM #TEMPOPTIK2
					 ORDER BY BOLUMNO
			 
					 DROP TABLE IF EXISTS #TEMPOPTIK
					 DROP TABLE IF EXISTS #TEMPOPTIK2
				END
				IF @ISLEM = 12	--	Sınav Optik Kaydet
				BEGIN
					--OPTIK SABIT INSERT
					DELETE FROM [SinavOptikSabit] WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavOptikSabit]
							   ([ID_SINAV]
							   ,[ID_SINAVOPTIK]
							   ,[BASLANGIC]
							   ,[OPTIKKARAKTERSAYISI])
					SELECT
							@ID_SINAV as ID_SINAV,
							JSON_Value (j.value, '$.ILISKI') as ID_SINAVOPTIK, 
							JSON_Value (j.value, '$.BASLANGIC') as BASLANGIC, 
							JSON_Value (j.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI
					FROM OPENJSON (@SQLJSON) as j
					WHERE JSON_Value (j.value, '$.TUR') = 1 --and (JSON_Value (j.value, '$.ID') IS NULL or JSON_Value (j.value, '$.ID') = 0)

					--OPTIK SABIT UPDATE
					--UPDATE [dbo].[SinavOptikSabit]
					--SET	[BASLANGIC] = JSON_Value (j.value, '$.BASLANGIC'), [OPTIKKARAKTERSAYISI] = JSON_Value (j.value, '$.KARAKTERSAYISI')
					--FROM OPENJSON (@SQLJSON) as j
					--WHERE
					--	JSON_Value (j.value, '$.TUR') = 1 
					--	and (JSON_Value (j.value, '$.ID') IS NOT NULL 
					--	and JSON_Value (j.value, '$.ID') > 0)
					--	and ID_SINAVOPTIKSABIT=JSON_Value (j.value, '$.ID')

					--OPTIK DERS INSERT
					DELETE SOD FROM [SinavOptikDers] SOD INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOD.ID_SINAVDERS WHERE SD.ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavOptikDers]
							   ([ID_SINAVDERS]
							   ,[BASLANGIC]
							   ,[OPTIKKARAKTERSAYISI]
							   ,[OTURUM])
					SELECT
							JSON_Value (j.value, '$.ILISKI') as ID_SINAVDERS, 
							JSON_Value (j.value, '$.BASLANGIC') as BASLANGIC, 
							JSON_Value (j.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (j.value, '$.OTURUM') as OTURUM
					FROM OPENJSON (@SQLJSON) as j
					WHERE JSON_Value (j.value, '$.TUR') = 2 --and (JSON_Value (j.value, '$.ID') IS NULL or JSON_Value (j.value, '$.ID') = 0)

					--OPTIK DERS UPDATE
					--UPDATE [dbo].[SinavOptikDers]
					--SET	[BASLANGIC] = JSON_Value (j.value, '$.BASLANGIC'), [OPTIKKARAKTERSAYISI] = JSON_Value (j.value, '$.KARAKTERSAYISI'),
					--	[OTURUM] = JSON_Value (j.value, '$.OTURUM')
					--FROM OPENJSON (@SQLJSON) as j
					--WHERE
					--	JSON_Value (j.value, '$.TUR') = 2 
					--	and (JSON_Value (j.value, '$.ID') IS NOT NULL 
					--	and JSON_Value (j.value, '$.ID') > 0)
					--	and ID_SINAVOPTIKDERS=JSON_Value (j.value, '$.ID')
				END
				IF @ISLEM = 13	--	Sınav Dosya Listele
				BEGIN
					SELECT 
						 sd.ID_SINAVDOSYA
						,sd.AD
						,k.AD AS KAD
						,k.SOYAD AS KSOYAD
						,sd.KYE_TARIH 
						,ISNULL(s.AD,'') SUBEAD
						,sn.ONLINESINAV
						,GUID = sd.GUID + IIF (CHARINDEX('.', SD.AD) > 0 , SUBSTRING( SD.AD , LEN(SD.AD) - CHARINDEX('.', REVERSE(SD.AD)) + 1 , CHARINDEX('.', REVERSE(SD.AD)) ) , '')
						,KATILIM	= IIF(SN.ONLINESINAV = 1 AND  SD.AD = 'ONLINE'
										,(	SELECT COUNT(DISTINCT TCKIMLIKNO) 
											FROM Tbl_OnlineSinavOgrenci		 OS 
											JOIN Tbl_OnlineSinavOgrenciCevap C	ON	C.ID_ONLINESINAVOGRENCI = OS.ID_ONLINESINAVOGRENCI 
																				AND C.AKTIF					= 1 
											WHERE	OS.ID_SINAV = SN.ID_SINAV 
												AND OS.AKTIF	= 1)
										,(SELECT COUNT(t.LINE) FROM SinavOptikTemp t WHERE t.ID_SINAVDOSYA=sd.ID_SINAVDOSYA)
										)
						,(SELECT COUNT(1) FROM [dbo].[fn_TcEslesmeGetir](sn.ID_KADEME3,SD.ID_SINAVDOSYA,sn.ID_SINAV,cast(@SINAVOTURUM as int),0)) SORUNLUTC
						--,(SELECT COUNT(1) FROM [dbo].[fn_TcEslesmeGetir](sn.ID_KADEME3,SD.ID_SINAVDOSYA,sn.ID_SINAV,@SINAVOTURUM,1))TEKRARLAYANTC
						,sn.DURUM
						,sn.YUKLEMEKAPAT
					FROM		SinavDosya		sd
					INNER JOIN	Sinav			sn	on sn.ID_SINAV	= sd.ID_SINAV 
					INNER JOIN	v3Kullanici		k	on k.TCKIMLIKNO	= sd.KYE_TCKIMLIKNO
					LEFT  JOIN	v3Sube			s	on s.ID_SUBE	= sd.ID_SUBE
					where sd.ID_SINAV=@ID_SINAV AND sd.AKTIF=1 AND (@ID_SUBE=0 OR sd.ID_SUBE=@ID_SUBE) AND (@SINAVOTURUM = 0 OR sd.OTURUM = @SINAVOTURUM)
				END
				IF @ISLEM = 14	--	Sınav Dosya Kaydet
				BEGIN

					 IF EXISTS (SELECT TOP 1 1 FROM SinavDosya WHERE ID_SINAV=@ID_SINAV AND AD=@DOSYAADI AND AKTIF=1)
					 BEGIN
						SELECT @MSG = 'DAHA ÖNCE AYNI İSİMLİ DOSYA KAYDETTİNİZ. KONTROL EDİNİZ!'
			
						RAISERROR (@MSG , -- Message text.
							16, -- Severity.
							1-- State.
							);					
					 END
					 ELSE
					 BEGIN
						DECLARE @ID_SINAVDOSYAx TABLE (ID_SINAVDOSYA int)
						INSERT INTO [dbo].[SinavDosya]
									([ID_SINAV]
									,[ID_SUBE]
									,[AD]
									,[GUID]
									,[KYE_TCKIMLIKNO]
									,[OTURUM])
									OUTPUT INSERTED.ID_SINAVDOSYA into @ID_SINAVDOSYAx
								VALUES
									(@ID_SINAV,@ID_SUBE,@DOSYAADI,@DOSYAGUID,@TCKIMLIKNO,@SINAVOTURUM)
						DECLARE @IDX int=(select top 1 ID_SINAVDOSYA from @ID_SINAVDOSYAx)
						DECLARE	@return_value int
			
						--UPDATE Sinav SET DURUM=3 WHERE ID_SINAV=@ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR
			
						--EXEC	@return_value = [dbo].[sp_OptikIslemleri]
						--		@ID_SINAV = @ID_SINAV,
						--		@ID_SINAVDOSYA = @IDX,
						--		@ID_SUBE=@ID_SUBE,
						--		@ISLEM = 0

						--UPDATE Sinav SET DURUM=0 WHERE ID_SINAV=@ID_SINAV

						DECLARE @SQLDOSYA		VARCHAR(max)	= NULL
						DECLARE @YOLDOSYA		VARCHAR(max)	= NULL
						DECLARE @GUIDDOSYA		VARCHAR(max)	= NULL

						IF @IDX IS NOT NULL AND NOT EXISTS(SELECT TOP 1 1 FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@IDX)
						BEGIN
				
							PRINT '2: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

							DECLARE @PAYLASIMYOL VARCHAR(MAX) = '\\172.18.194.207\$SinavOptik\'

							IF HOST_NAME() = 'KDCENGIZPC'	-- LOCALDEN İSE KENDİ SINAVDOSYA YA 
								SET @PAYLASIMYOL = '\\100.100.15.144\$SinavOptik\'
								

							SET @GUIDDOSYA = (SELECT GUID FROM SinavDosya where ID_SINAVDOSYA=@IDX)
							create table #tmp (
								line nvarchar(max)
							);
							BEGIN TRY  
								SET @YOLDOSYA = @PAYLASIMYOL+@GUIDDOSYA+'.txt'
								SET @SQLDOSYA=
								'BULK INSERT #tmp
								FROM '''+@YOLDOSYA+'''
								WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
								EXEC(@SQLDOSYA) 
							END TRY  
							BEGIN CATCH  
								SET @YOLDOSYA = @PAYLASIMYOL+@GUIDDOSYA+'.dat'
								SET @SQLDOSYA=
								'BULK INSERT #tmp
								FROM '''+@YOLDOSYA+'''
								WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
								EXEC(@SQLDOSYA) 
							END CATCH 
				
							INSERT INTO SinavOptikTemp (LINE,ID_SINAVDOSYA)
							SELECT line, @IDX FROM #tmp
							WHERE line IS NOT NULL
							DROP TABLE IF EXISTS #tmp

							PRINT '3: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						END	

						SELECT DISTINCT OTURUM INTO #OTURUMLARDOSYAYUKLE FROM SinavDosya WHERE ID_SINAV  = @ID_SINAV
						DECLARE @HATALIDOSYAYUKLE BIT=0
						WHILE (SELECT COUNT(1) FROM #OTURUMLARDOSYAYUKLE)>0
						BEGIN 
							DECLARE @SUB_OTURUMDOSYAYUKLE INT = (SELECT TOP 1 OTURUM FROM #OTURUMLARDOSYAYUKLE)
				
							IF  ((SELECT COUNT(1) TE_TC FROM [dbo].[fn_TcEslesmeGetir](NULL,NULL,@ID_SINAV,@SUB_OTURUMDOSYAYUKLE,1)) > 0)
							BEGIN
								--SELECT @MSG = 'TEKRARLANAN TC OLDUĞUNDAN DEĞERLENDİRME YAPILAMAZ KONTROL EDİNİZ!'
			
								--RAISERROR (@MSG , -- Message text.
								--	16, -- Severity.
								--	1-- State.
								--	);
								SET @HATALIDOSYAYUKLE = 1
							END
				
							DELETE FROM #OTURUMLARDOSYAYUKLE WHERE OTURUM = @SUB_OTURUMDOSYAYUKLE
						END

						IF @HATALIDOSYAYUKLE = 0
						BEGIN
							UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 0 where ID_SINAV = @ID_SINAV -- SIRAYA ALINDI
			
							INSERT INTO [dbo].[SinavDegerlendir]
									([ID_SINAV]
									,[KYE_TCKIMLIKNO])
								VALUES
									(@ID_SINAV
									,@TCKIMLIKNO)
						END

						SELECT @IDX
					END
				END
				IF @ISLEM = 15	--	Sınav Dosya Sil
				BEGIN
					UPDATE SinavDosya set AKTIF=0, SIL_TCKIMLIKNO=@TCKIMLIKNO, SIL_TARIH=getdate() where ID_SINAVDOSYA=@ID_SINAVDOSYA
					DELETE FROM SinavOgrenci WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA
					DELETE FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA
				END
				IF @ISLEM = 16	--	Optik Girildi Mi
				BEGIN
					IF((select count(1) from SinavOptikDers sod inner join SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS where sd.ID_SINAV=@ID_SINAV)
					+(select count(1) from SinavOptikSabit where ID_SINAV=@ID_SINAV)
					=(select count(1) from SinavOptik)+(select count(1) from SinavDers where ID_SINAV=@ID_SINAV))
					BEGIN
						select 1
					END
					ELSE
					BEGIN
						select 0
					END 
				END
				IF @ISLEM = 17	--	Sınav Değerlendir
				BEGIN
					SELECT DISTINCT OTURUM INTO #OTURUMLAR FROM SiNAVDOSYA WHERE ID_SINAV=@ID_SINAV
					DECLARE @HATALI BIT=0
					WHILE (SELECT COUNT(1) FROM #OTURUMLAR)>0
					BEGIN 
				
						DECLARE @SUB_OTURUM INT =(SELECT TOP 1 OTURUM FROM #OTURUMLAR)
				
						IF  ((SELECT COUNT(1) TE_TC FROM [dbo].[fn_TcEslesmeGetir](NULL,NULL,@ID_SINAV,@SUB_OTURUM,1))>0)
						BEGIN
							SELECT @MSG = 'TEKRARLANAN TC OLDUĞUNDAN DEĞERLENDİRME YAPILAMAZ KONTROL EDİNİZ!'
			
							RAISERROR (@MSG , -- Message text.
								16, -- Severity.
								1-- State.
								);
							SET @HATALI=1

						END
				
						DELETE FROM #OTURUMLAR WHERE OTURUM=@SUB_OTURUM
					END





					IF  (@HATALI=0)			
					BEGIN

					
						IF	 EXISTS(SELECT TOP 1 1 FROM Sinav WHERE ID_SINAV = @ID_SINAV AND ONLINESINAV = 1) 
						 AND NOT EXISTS(SELECT TOP 1 1 FROM SinavDosya WHERE ID_SINAV = @ID_SINAV)
						BEGIN
								INSERT INTO SinavDosya (AD, GUID, ID_SINAV, ID_SUBE, KYE_TCKIMLIKNO)
								VALUES ('ONLINE', '', @ID_SINAV, 0, @TCKIMLIKNO)
						END

						UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 0 where ID_SINAV = @ID_SINAV -- SIRAYA ALINDI
			
						INSERT INTO [dbo].[SinavDegerlendir]
								   ([ID_SINAV]
								   ,[KYE_TCKIMLIKNO])
							 VALUES
								   (@ID_SINAV
								   ,@TCKIMLIKNO)
					END
				END
				IF @ISLEM = 18	--	Sınav Puan Türü (@ID_SINAVTURU)
				BEGIN
					--SELECT		S.ID_SINAV, KOD, S.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 103) as SINAVTARIH, DURUM 
					--FROM		Sinav			S
					--INNER JOIN	SinavOgrenci	SO	ON SO.ID_SINAV=S.ID_SINAV
					--WHERE		SO.TCKIMLIKNO	= @TC_OGRENCI	AND S.DONEM	= @DONEM
					--ORDER BY	S.SINAVTARIH

					SELECT		DISTINCT PT.ID_SINAVPUANTURU,PT.AD,PT.KOD
					FROM		SinavPuanTuru	PT
					INNER JOIN	Sinav			S	ON PT.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE		S.ID_SINAVTURU=@ID_SINAVTURU
					ORDER BY	PT.ID_SINAVPUANTURU 


				END
				IF @ISLEM = 19	--	Sınav Listele by Ogrenci
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	and (@TC_OGRENCI IS NULL OR TCKIMLIKNO=@TC_OGRENCI)
						where s.AKTIF=1 and s.DURUM=2  
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (cast(@ID_SINAVTURU as int)=0 or s.ID_SINAVTURU=cast(@ID_SINAVTURU as int))
					) as XTABLE
					order by cast(SINAVTARIH as datetime) desc
				END
				IF @ISLEM = 20	--	Ünite Ara
				BEGIN			
					--select AD from dbo.[fn_DersUniteListe](@ID_DERS,@UNITEKOD)

					SELECT AD FROM v3SinavDersUnite
					WHERE KOD = @UNITEKOD

				END
				IF @ISLEM = 21  --  SINAV AKTIF PASIF
				BEGIN
					UPDATE Sinav 
					SET AKTIF=CASE WHEN AKTIF=1 THEN 0 ELSE 1 END
					WHERE ID_SINAV=@ID_SINAV
					select AKTIF from Sinav WHERE ID_SINAV=@ID_SINAV
				END 
				IF @ISLEM = 22  --  Sınav Dosya İçerik
				BEGIN

					declare @SQL varchar(max),@cols varchar(max)--,@ID_SINAVDOSYA int=196,@ID_SINAV int=43
					
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS ##T1
					
					select @ID_SINAV=ID_SINAV FROM SinavDosya WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA

					SELECT 
						 DEGER	= CAST( RTRIM(SUBSTRING(LINE,BASLANGIC , OPTIKKARAKTERSAYISI )) AS varchar(MAX))
						,SO.KOLONADI
						,ID_SINAVOPTIKTEMP
						,SIRA = SO.ID_SINAVOPTIK 
					INTO #TEMP
					FROM SinavOptikTemp		SOT
					JOIN SinavOptikSabit	SOS ON	SOS.ID_SINAV=@ID_SINAV and SOS.OPTIKKARAKTERSAYISI>0
					JOIN SinavOptik			SO	ON	SO.ID_SINAVOPTIK=SOS.ID_SINAVOPTIK
					where ID_SINAVDOSYA=@ID_SINAVDOSYA
					UNION ALL
					select			
						 RTRIM(SUBSTRING(LINE, sod.BASLANGIC, sod.OPTIKKARAKTERSAYISI)) DEGER
						,sd.TAKMAAD KOLONADI
						,ID_SINAVOPTIKTEMP	
						,SIRA = 100 + CAST(SD.BOLUMNO AS INT)
					from SinavOptikTemp			sot
					inner join	SinavDers		sd	on	sd.ID_SINAV=@ID_SINAV
					inner join	SinavOptikDers	sod	on	sod.ID_SINAVDERS=sd.ID_SINAVDERS
					where ID_SINAVDOSYA=@ID_SINAVDOSYA


					SET @cols = STUFF((SELECT DISTINCT ',' + QUOTENAME(c.KOLONADI) 
											FROM #TEMP c
											FOR XML PATH(''), TYPE
											).value('.', 'NVARCHAR(MAX)') 
										,1,1,'')

					SET @SQL='  SELECT * INTO ##T1  FROM ( SELECT DEGER,KOLONADI,ID_SINAVOPTIKTEMP FROM #TEMP ) AS x 
								PIVOT  (MAX(DEGER) FOR KOLONADI IN ('+@cols+')) AS p'
					EXECUTE(@SQL)

					select(
						select * from(
							select 
							(
								select * from ##T1
								FOR JSON AUTO
							) as t1	
							,(
								SELECT KOLONADI FROM #TEMP GROUP BY KOLONADI,SIRA ORDER BY SIRA
								FOR JSON AUTO
							) as t2					
						) as tablo FOR JSON AUTO
					) as tt

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS ##T1


				END 
				IF @ISLEM = 23  --  Sınav Dosya İçerik Düzenle
				BEGIN
					--DECLARE @SQLJSON VARCHAR(MAX)='[{"ID_SINAVOPTIKTEMP":37314,"KOLONADI":"AD","DEGER":"ZİLAN     KARAYİĞİTAS"},{"ID_SINAVOPTIKTEMP":37326,"KOLONADI":"KITAPCIK","DEGER":"A"},{"ID_SINAVOPTIKTEMP":37315,"KOLONADI":"KITAPCIK","DEGER":"A"}]'
					DROP TABLE IF EXISTS #TEMP2
					SELECT
						JSON_Value (j.value, '$.ID_SINAVOPTIKTEMP') as ID_SINAVOPTIKTEMP,
						JSON_Value (j.value, '$.KOLONADI') as KOLONADI, 
						JSON_Value (j.value, '$.DEGER') as DEGER
					INTO #TEMP2
					FROM OPENJSON (@SQLJSON) as j
			
					SELECT @ID_SINAVDOSYA=ID_SINAVDOSYA,@ID_SINAV=ID_SINAV  FROM SinavDosya WHERE ID_SINAVDOSYA =(SELECT ID_SINAVDOSYA FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=(SELECT TOP 1 ID_SINAVOPTIKTEMP FROM #TEMP2))
			
					WHILE ((SELECT COUNT(DISTINCT KOLONADI) FROM #TEMP2)>0)
					BEGIN
						UPDATE	SOT
						SET		
								sot.LINE = STUFF(LINE,SOS.BASLANGIC,SOS.OPTIKKARAKTERSAYISI,LEFT( upper(DEGER)+SPACE(SOS.OPTIKKARAKTERSAYISI),SOS.OPTIKKARAKTERSAYISI))
						FROM	SinavOptikTemp		SOT
						JOIN	#TEMP2				T	ON	T.ID_SINAVOPTIKTEMP	= SOT.ID_SINAVOPTIKTEMP
						JOIN	SinavOptik			SO	ON	SO.KOLONADI			= T.KOLONADI
						JOIN	SinavDosya			SD	ON	SD.ID_SINAVDOSYA	= SOT.ID_SINAVDOSYA
						JOIN	SinavOptikSabit		SOS	ON	SOS.ID_SINAVOPTIK	= SO.ID_SINAVOPTIK
														AND SOS.ID_SINAV		= SD.ID_SINAV
						WHERE	T.KOLONADI=(SELECT TOP 1 KOLONADI FROM #TEMP2 ORDER BY KOLONADI)

						DELETE FROM #TEMP2 WHERE KOLONADI=(SELECT TOP 1 KOLONADI FROM #TEMP2 ORDER BY KOLONADI)
					END
			
					DROP TABLE IF EXISTS #TEMP2			

					UPDATE Sinav SET DURUM=0 WHERE ID_SINAV=@ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR
			
					--EXEC	@return_value = [dbo].[sp_OptikIslemleri]
					--		@ID_SINAV = @ID_SINAV,
					--		@ID_SINAVDOSYA = @ID_SINAVDOSYA,
					--		@ISLEM = 0
			
					select 1
				END 
				IF @ISLEM = 24  --  Öğrenci Listele by ID_SINAV
				BEGIN
					DROP TABLE IF EXISTS #T1

					SELECT	DISTINCT SO.TCKIMLIKNO
							,ISNULL(VK.AD,SO.AD) AD
							,ISNULL(VK.SOYAD,SO.SOYAD) SOYAD
							,ISNULL(VS.SUBEAD,'') SUBEAD
							,ISNULL(VS.SINIF,'') SINIF
					 INTO #T1
					 FROM SinavOgrenci		SO
				LEFT JOIN V3OGRENCi			VO	ON	SO.TCKIMLIKNO	= VO.TCKIMLIKNO
				LEFT JOIN V3Kullanici		VK	ON	VK.TCKIMLIKNO	= SO.TCKIMLIKNO
												AND VK.AKTIF		= 1
				LEFT JOIN vw_SubeGrupSinif	VS	ON	VS.ID_SINIF		= VO.ID_SINIF
					WHERE							SO.ID_SINAV		= @ID_SINAV

					select(
						select * from(
							select 
							(
								select DISTINCT TCKIMLIKNO,AD,SOYAD,SUBEAD,SINIF from #T1
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
			
						DROP TABLE IF EXISTS #T1
				END 
				IF @ISLEM = 25  --  Sınav Özellikleri
				BEGIN
						SELECT 
							 SD.TAKMAAD 
							,SA.SORUNO_A
							,SA.CEVAP
							,SA.SORUNO
							,SA.KOD
							,BILGI = ISNULL(B.AD, '')
							,BILISSELSUREC = ISNULL(BS.AD, '')
							,SA.ID_SORUBANKASI

							,KAZANIM= CASE WHEN LEN(SA.KOD) >0 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SA.KOD								) ELSE '' END
							,UNITE	= CASE WHEN LEN(SA.KOD) >3 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SUBSTRING(SA.KOD ,1,LEN(SA.KOD)-3)	) ELSE '' END
							,KONU	= CASE WHEN LEN(SA.KOD) >6 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SUBSTRING(SA.KOD ,1,LEN(SA.KOD)-6)	) ELSE '' END
					
							,SD.ID_SINAVDERS
							,S.ID_SINAV
							,ISNULL(SOD.OTURUM,1) OTURUM
							,VD.ACIKLAMA DONEM
							,VK.AD GRUP
							,S.AD SINAVAD
							,convert(varchar(15), S.SINAVTARIH, 104) SINAVTARIH
						FROM	Sinav				S
						JOIN	SinavKitapcik		SK	ON	SK.ID_SINAV			= S.ID_SINAV
														AND SK.AD				= IIF (S.ONLINESINAV = 1 ,'A','B')
						JOIN	SinavAnahtar		SA	ON	SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
						JOIN	SinavDers			SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
					LEFT JOIN	SinavOptikDers		SOD	ON	SOD.ID_SINAVDERS	= SD.ID_SINAVDERS
						JOIN	V3AKTiFDONEM		VD	ON	VD.DONEM			= S.DONEM
						JOIN	V3Kademe3			VK	ON	VK.ID_KADEME3		= S.ID_KADEME3		
					LEFT JOIN	Bilgi				B	ON	B.ID_BILGI			= SA.ID_BILGI
					LEFT JOIN	BilisselSurec		BS	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC
						WHERE S.ID_SINAV=@ID_SINAV
						ORDER BY OTURUM,SORUNO_A,SD.BOLUMNO
				END 
				IF @ISLEM = 26  --  Sınav Derslerini Listele
				BEGIN	
					select(
						select * from(
							select 
							(
								SELECT	DISTINCT SD.ID_SINAVDERS, SD.ID_DERS,SD.TAKMAAD DERSAD,BOLUMNO
								FROM	SinavDers	SD	
								WHERE 	SD.ID_SINAV=@ID_SINAV
								ORDER BY BOLUMNO
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END 
				IF @ISLEM = 27  --  Sınav Dersler Sorularını Listele
				BEGIN
					--SELECT	SORUNO,SORUNO_A,CEVAP,SK.AD
					--FROM	SinavDers		SD	
					--JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
					--JOIN	SinavKitapcik	SK	ON	SK.ID_SINAV		= S.ID_SINAV
					--						AND SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
					--WHERE	SD.ID_SINAVDERS = @ID_SINAVDERS		

						DROP TABLE IF EXISTS ##TEMP

						SET @cols2 = STUFF((SELECT distinct ',' + QUOTENAME(SK.AD) 
									FROM SinavDers		SD	
									JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
									JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
									WHERE	SD.ID_SINAVDERS = @ID_SINAVDERS
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SORUNO_A,CEVAP,A,B
								--@SINAVSORUISLEM =1 ise soru işlem tablosuna eklenenler listelenmeyecek 
						set @query = 'SELECT * INTO ##TEMP FROM
						(
							SELECT	SORUNO,SORUNO_A,CEVAP,SK.AD
							FROM	SinavDers		SD	
							JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
							JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
							WHERE	SD.ID_SINAVDERS = '+CAST(@ID_SINAVDERS AS varchar(MAX))+'
							and ('+CAST(@SINAVSORUISLEM AS varchar(MAX))+'=0 OR SA.ID_SINAVANAHTAR not in (select distinct ID_SINAVANAHTAR from SinavSoruIslem))
						) AS xTablo
						PIVOT( MAX(SORUNO) FOR AD IN (' + @cols2 + '))AS p'

						execute(@query)

						select(
							select * from(
								select 
								(
									select * from ##TEMP
									ORDER BY SORUNO_A
									FOR JSON AUTO
								) as t1	,	
								(
									SELECT	DISTINCT SK.AD
									FROM	SinavDers		SD	
									JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
									WHERE	SD.ID_SINAVDERS		=	@ID_SINAVDERS
									FOR JSON AUTO
								) as t2							
							) as tablo FOR JSON AUTO
						) as tt


						DROP TABLE IF EXISTS ##TEMP

				END 
				IF @ISLEM = 28	--	Sınav Listele Pasif Dahil
				BEGIN
					SELECT DISTINCT 
						S.ID_SINAV
						,KOD
						,S.AD
						,K3.AD AS GRUP
						,S.ID_KADEME3
						,Convert(varchar, SINAVTARIH, 103) AS SINAVTARIH
						,DURUM
						,AKTIF 
						,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
						,S.OZEL AS OZEL
						,S.FREKANSHESAPLA AS FREKANSHESAPLA
						,S.PUANGIZLE AS PUANGIZLE
						,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
						,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
						,S.[ONLINESINAV]  AS [ONLINESINAV] 
						,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = S.ID_SINAV) AS HARICIOGRSAY
					FROM Sinav S
					INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
					LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
					WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3
				END
				IF @ISLEM = 29	--	Öğrenci Sil
				BEGIN
					SELECT SO.ID_SINAVOGRENCI, SOT.ID_SINAVOPTIKTEMP 
					INTO #OGRENCIDELETE
					FROM SinavOgrenci SO
					INNER JOIN SinavOptikTemp SOT ON SOT.ID_SINAVOPTIKTEMP = SO.ID_SINAVOPTIKTEMP
					WHERE SO.ID_SINAV = @ID_SINAV AND SO.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON(@TCLIST))
			
					DELETE FROM SinavOgrenci WHERE ID_SINAVOGRENCI IN (SELECT ID_SINAVOGRENCI FROM #OGRENCIDELETE)
					DELETE FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP IN (SELECT ID_SINAVOPTIKTEMP FROM #OGRENCIDELETE)

					DROP TABLE #OGRENCIDELETE

					SELECT 1
				END
				IF @ISLEM = 30	--	Öğrenci Sil
				BEGIN
					UPDATE SinavDers SET TAKMAAD=@TAKMAAD WHERE ID_SINAVDERS=@ID_SINAVDERS
					SELECT 1
				END			
				IF @ISLEM = 31  --  SınavTürü Derslerini Listele
				BEGIN	
					select(
						select * from(
							select 
							(
								SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
								FROM	SinavDers			SD	
								JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV
								JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS 
																AND D.ID_KADEME3= S.ID_KADEME3
								WHERE	S.ID_SINAVTURU	= @ID_SINAVTURU 
									AND S.ID_KADEME3	= @ID_KADEME3ESKI		
									AND (S.DONEM		= @DONEM		OR @DONEM = '' )
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END 
				IF @ISLEM = 32	--	Sınav Listele Değerlendirilmiş
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
							,S.[ONLINESINAV]  AS [ONLINESINAV] 
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3 and S.AKTIF = 1 and S.DURUM=2
							and (OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 33	--	Sınav Türü Listele Gruba Göre
				BEGIN
					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD FROM  Sinav S 
					INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE S.ID_KADEME3 = @ID_KADEME3ESKI AND S.AKTIF=1 AND S.DURUM=2
							and (OZEL=0 OR @OZELSINAVGOR=1)
				END
				IF @ISLEM = 34	--	Sınav Türü Listele Gruba Göre
				BEGIN
					IF (@ID_KADEME3ESKI IS NULL OR @ID_KADEME3ESKI='') AND (@TC_OGRENCI IS NOT NULL AND @TC_OGRENCI != '')
					BEGIN
						SELECT @ID_KADEME3ESKI=S.ID_KADEME3
						FROM OkyanusDB.DBO.v3Ogrenci		O
						JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF=O.ID_SINIF 
						WHERE TCKIMLIKNO=@TC_OGRENCI
					END

					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
					FROM  Sinav S 
					INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE S.ID_KADEME3 = @ID_KADEME3ESKI AND S.AKTIF=1 AND S.DURUM=2 AND S.DONEM=@DONEM
							and (OZEL=0 OR @OZELSINAVGOR=1)
				END
				IF @ISLEM = 35	--	Sınav Listele by Grup
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV
						where s.AKTIF=1 and s.DURUM=2 and s.ID_KADEME3=@ID_KADEME3ESKI
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (cast(@ID_SINAVTURU as int)=0 or s.ID_SINAVTURU=cast(@ID_SINAVTURU as int))
					) as XTABLE
					order by cast(SINAVTARIH as date) desc
				END
				IF @ISLEM = 36	--	Sınav Listele by Grup - ÇOKLU
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV
						where s.AKTIF=1 and s.DURUM=2 and s.ID_KADEME3=@ID_KADEME3ESKI
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
					) as XTABLE
					order by TUR, cast(SINAVTARIH as date) desc
				END
				IF @ISLEM = 37	--	Sınav Özellik Güncelle
				BEGIN
					DECLARE @SQL37 VARCHAR(MAX) ='
						UPDATE Sinav
						SET '+@DURUM+'='+CAST(@DURUMDEGER AS varchar)+'
						WHERE ID_SINAV='+CAST(@ID_SINAV AS varchar)+'
					'
					PRINT (@SQL37)
					EXEC (@SQL37)

					SELECT 1
					
				
				END
				IF @ISLEM = 38	--	Sınav Listele KADEME DONEM
				BEGIN

					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.CEVAPANAHTARIYUKLEMEKAPAT AS CEVAPANAHTARIYUKLEMEKAPAT
							,S.ONLINESINAV AS ONLINESINAV
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = S.ID_SINAV) AS HARICIOGRSAY
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3 and S.AKTIF = 1
						AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 39	--	sınav ders liste
				BEGIN
					SELECT   SD.*
							,SA.SORUNO
							,SA.CEVAP
							,SA.KOD
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'B' ) B_KARSILIK	
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'C' ) C_KARSILIK	
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'D' ) D_KARSILIK		
							,SA.ID_BILGI
							,SA.ID_BILISSELSUREC
							,SA.ID_SORUBANKASI
					FROM Sinav							S
					JOIN SinavDers						SD	ON	SD.ID_SINAV			= S.ID_SINAV
					JOIN OPENJSON (@ID_SINAVDERSLIST)	DL	ON	DL.VALUE			= SD.ID_SINAVDERS
					JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS 
					JOIN SinavKitapcik					SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
															AND	SK.AD				= 'A'
					WHERE	S.ID_SINAV	= @ID_SINAV
					GROUP BY SD.ID_SINAVDERS,BOLUMNO,ID_DERS,TAKMAAD,SD.ID_SINAV,SA.CEVAP,SA.KOD,SA.SORUNO,SA.ID_BILGI,SA.ID_BILISSELSUREC	,SA.ID_SORUBANKASI	
					ORDER BY BOLUMNO,SORUNO
				END
				IF @ISLEM = 40	--	CEVAP ANAHTARI EXCEL YUKLE
				BEGIN
					--declare @SQLJSON varchar(max)= '[{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"1","CEVAP":"B","B_KARSILIK":"20","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"2","CEVAP":"E","B_KARSILIK":"19","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"3","CEVAP":"E","B_KARSILIK":"18","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"4","CEVAP":"A","B_KARSILIK":"17","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001007"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"5","CEVAP":"C","B_KARSILIK":"16","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"6","CEVAP":"D","B_KARSILIK":"15","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL103001019"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"7","CEVAP":"A","B_KARSILIK":"14","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"8","CEVAP":"B","B_KARSILIK":"13","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001005"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"9","CEVAP":"D","B_KARSILIK":"12","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110002001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"10","CEVAP":"D","B_KARSILIK":"11","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL103001008"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"11","CEVAP":"C","B_KARSILIK":"10","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107002011"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"12","CEVAP":"E","B_KARSILIK":"9","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"13","CEVAP":"D","B_KARSILIK":"8","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"14","CEVAP":"A","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"15","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL112001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"16","CEVAP":"B","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL112001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"17","CEVAP":"B","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107002011"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"18","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL105009001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"19","CEVAP":"A","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL105001007"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"20","CEVAP":"C","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001007"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"1","CEVAP":"E","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK316003006"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"2","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK316003003"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"3","CEVAP":"E","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK315002010"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"4","CEVAP":"A","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK314003001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"5","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK317003001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"6","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK313004001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"7","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK315005001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"1","CEVAP":"D","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"2","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ401002001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"3","CEVAP":"B","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ416005001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"4","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"5","CEVAP":"A","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"6","CEVAP":"E","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ406002001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"7","CEVAP":"A","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ406002001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"1","CEVAP":"C","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN804001002"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"2","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN804004004"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"3","CEVAP":"D","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN806006001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"4","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN806008002"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"5","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN805004001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"6","CEVAP":"E","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN502002001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"1","CEVAP":"D","B_KARSILIK":"20","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"2","CEVAP":"B","B_KARSILIK":"19","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"3","CEVAP":"C","B_KARSILIK":"18","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"4","CEVAP":"E","B_KARSILIK":"17","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"5","CEVAP":"D","B_KARSILIK":"16","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201006004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"6","CEVAP":"D","B_KARSILIK":"15","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201006003"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"7","CEVAP":"E","B_KARSILIK":"14","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT203002005"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"8","CEVAP":"E","B_KARSILIK":"13","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT206001001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"9","CEVAP":"C","B_KARSILIK":"12","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001005"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"10","CEVAP":"A","B_KARSILIK":"11","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"11","CEVAP":"E","B_KARSILIK":"10","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"12","CEVAP":"A","B_KARSILIK":"9","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT206001002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"13","CEVAP":"B","B_KARSILIK":"8","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"14","CEVAP":"B","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006007"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"15","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"16","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202003004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"17","CEVAP":"B","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201010001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"18","CEVAP":"B","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"19","CEVAP":"C","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"20","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"1","CEVAP":"C","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607011006"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"2","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ603003001"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"3","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ606002003"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"4","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ608002003"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"5","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607004001"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"6","CEVAP":"B","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ604001002"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"7","CEVAP":"B","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607011006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"1","CEVAP":"A","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM701003005"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"2","CEVAP":"D","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703003001"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"3","CEVAP":"E","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703005006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"4","CEVAP":"B","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM702003004"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"5","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM705008002"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"6","CEVAP":"A","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703005006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"7","CEVAP":"E","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM701006001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"1","CEVAP":"D","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY806001001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"2","CEVAP":"C","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY806001005"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"3","CEVAP":"A","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY807002001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"4","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY804002005"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"5","CEVAP":"E","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY810001001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"6","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY810001004"}]'
				
					DROP TABLE IF EXISTS #SQLJSON
					DROP TABLE IF EXISTS #BKONTROL
					DROP TABLE IF EXISTS #CKONTROL
					DROP TABLE IF EXISTS #DKONTROL


					SELECT ID_SINAVDERS, TAKMAAD, SORUNO, CEVAP, B_KARSILIK,C_KARSILIK,D_KARSILIK, KOD, ID_BILGI, ID_BILISSELSUREC, ID_SORUBANKASI
					INTO #SQLJSON 
					FROM OPENJSON(@SQLJSON)
					with
					(
						ID_SINAVDERS [int],
						TAKMAAD [varchar](MAX),
						SORUNO [int],
						CEVAP [varchar](MAX),
						B_KARSILIK [int],
						C_KARSILIK [int],
						D_KARSILIK [int],
						KOD [varchar](MAX),
						ID_BILGI INT,
						ID_BILISSELSUREC INT,
						ID_SORUBANKASI INT
					) AS J
				
					DECLARE @RESULT BIT = 0
				
					--SELECT SA.CEVAP,SA.SORUNO_A,SA.KOD, '' AS SS, J.SORUNO,J.CEVAP,J.KOD,J.B_KARSILIK,J.C_KARSILIK,J.D_KARSILIK
				
					IF NOT EXISTS (SELECT TOP 1 1 FROM #SQLJSON WHERE CEVAP NOT IN ('A','B','C','D','E','F'))
					BEGIN

						UPDATE  SA
						SET
							 SA.CEVAP				= J.CEVAP
							,SA.KOD					= J.KOD
							,SA.ID_BILGI			= J.ID_BILGI 
							,SA.ID_BILISSELSUREC	= J.ID_BILISSELSUREC 
							,SA.ID_SORUBANKASI		= SSD.ID_SORU --J.ID_SORUBANKASI
						FROM SinavDers					SD	
						JOIN #SQLJSON					J	ON	J.ID_SINAVDERS		= SD.ID_SINAVDERS
						JOIN SinavAnahtar				SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
															AND SA.SORUNO_A			= J.SORUNO 
						JOIN SinavKitapcik				SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK 
															AND	SK.AD				= 'A'
					LEFT JOIN SoruBankasi.dbo.Soru		SS	ON	SS.ID_SORU			= J.ID_SORUBANKASI
					LEFT JOIN Sinav						JS	ON	JS.ID_SINAV			= SD.ID_SINAV
					LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON	SSD.ID_SORU			= SS.ID_SORU
															AND JS.ID_KADEME3		= SSD.ID_SINAVGRUP
															AND SSD.SILINDI			= 0
															AND SSD.UNITE			= J.KOD
						WHERE SD.ID_SINAV = @ID_SINAV

						BEGIN	-- KITAPÇIK YANLIŞ KONTROL
					
							SELECT 
									S.SORUNO,
									G.B_KARSILIK,
									G.ID_SINAVDERS,
									COUNT(G.B_KARSILIK) SAY
							INTO #BKONTROL
							FROM #SQLJSON S
					   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.B_KARSILIK 
											AND S.ID_SINAVDERS	= G.ID_SINAVDERS
							GROUP BY 
									S.SORUNO,
									G.B_KARSILIK,
									G.ID_SINAVDERS
							HAVING COUNT(G.B_KARSILIK)=0

				
							SELECT 
									S.SORUNO,
									G.C_KARSILIK,
									G.ID_SINAVDERS,
									COUNT(G.C_KARSILIK) SAY
							INTO #CKONTROL
							FROM #SQLJSON S
					   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.C_KARSILIK 
											AND S.ID_SINAVDERS	= G.ID_SINAVDERS
							GROUP BY 
									S.SORUNO,
									G.C_KARSILIK,
									G.ID_SINAVDERS
							HAVING COUNT(G.C_KARSILIK)=0

				
							SELECT 
								S.SORUNO,
								G.D_KARSILIK,
								G.ID_SINAVDERS,
								COUNT(G.D_KARSILIK) SAY
						INTO #DKONTROL
						FROM #SQLJSON S
				   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.D_KARSILIK 
										AND S.ID_SINAVDERS	= G.ID_SINAVDERS
						GROUP BY 
								S.SORUNO,
								G.D_KARSILIK,
								G.ID_SINAVDERS
						HAVING COUNT(G.D_KARSILIK)=0

						END
					
						IF NOT EXISTS (SELECT * FROM #BKONTROL)
						BEGIN
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.B_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.B_KARSILIK
							FROM	SinavAnahtar		SA
							JOIN	SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'B' 
							JOIN	#SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
															AND J.SORUNO			= SA.SORUNO_A

						END		
					
						IF NOT EXISTS (SELECT * FROM #CKONTROL)
						BEGIN
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.C_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.C_KARSILIK
							FROM SinavAnahtar		SA
							JOIN SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'C' 
							JOIN #SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
														AND J.SORUNO			= SA.SORUNO_A

						END		
					
						IF NOT EXISTS (SELECT * FROM #DKONTROL)
						BEGIN
							
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.D_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.D_KARSILIK
							FROM SinavAnahtar		SA
							JOIN SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'D' 
							JOIN #SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
														AND J.SORUNO			= SA.SORUNO_A
						END

					SET @RESULT = 1

				END
				

					SELECT @RESULT


					DROP TABLE IF EXISTS #SQLJSON
					DROP TABLE IF EXISTS #BKONTROL
					DROP TABLE IF EXISTS #CKONTROL
					DROP TABLE IF EXISTS #DKONTROL


				END
				IF @ISLEM = 41	--	Sınav/Yazılı Listele Tarihe Göre
				BEGIN

						SELECT ID_SINAV,S.AD,K.ID_KADEME3, K.AD KADEME3, S.ID_SINAVTURU, ST.KISAAD SINAVTURU
						INTO #SINAVLISTESI
						FROM Sinav		S
						JOIN v3Kademe3	K	ON	K.ID_KADEME3	= S.ID_KADEME3
						JOIN SinavTuru	ST	ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
						WHERE	S.SINAVTARIH	= @TARIH
							AND S.DONEM			= @DONEM
							AND (K.ID_KADEME3	= @ID_KADEME3 OR @ID_KADEME3 = 0 OR @ID_KADEME3 IS NULL )
							AND	S.AKTIF			= 1
					UNION ALL
						SELECT ID_YAZILI,Y.AD,K.ID_KADEME3, K.AD KADEME3, 0 ID_SINAVTURU,'YZL' SINAVTURU
						FROM Yazili		Y
						JOIN v3Kademe3	K	ON	K.ID_KADEME3	= Y.ID_KADEME3
						WHERE	Y.YAZILITARIH	= @TARIH
							AND Y.DONEM			= @DONEM
							AND (K.ID_KADEME3	= @ID_KADEME3 OR @ID_KADEME3 = 0 OR @ID_KADEME3 IS NULL )
							AND	Y.AKTIF			= 1
					ORDER BY ID_KADEME3 

					SELECT (
						SELECT *
						FROM #SINAVLISTESI
						for json path, INCLUDE_NULL_VALUES 
					)AS SINAVLISTESI

					DROP TABLE #SINAVLISTESI					

				END
				IF @ISLEM = 42	--	Bursluluk Dosya Liste
				BEGIN

					SELECT ISNULL(
						(	SELECT *
							FROM BurslulukDosya
							WHERE (DONEM = @DONEM OR ((@DONEM IS NULL OR @DONEM = '') AND (@DONEM =@AKTIFDONEM )))
								AND AKTIF = 1
							for json auto
						)
					,'[]')AS DOSYALISTESI

				END
				IF @ISLEM = 43	--	Sınav Listele Multi Sınav Turu
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
							,S.ONLINESINAV  AS ONLINESINAV 
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM 
						and S.ID_KADEME3 = @ID_KADEME3ESKI 
						and (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
						and S.AKTIF = 1 
						and S.DURUM = 2
						and (OZEL = 0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 44	--	AYT için TYT Seçim Türü
				BEGIN
					SELECT 
					(
						SELECT DISTINCT TST.ID_TYTSECIMTUR, TST.AD, CASE WHEN STST.ID_SINAV IS NULL THEN 0 ELSE 1 END SELECTED, ISNULL(STST.PUAN, 0) AS PUAN
						FROM TYTSecimTur TST
						LEFT JOIN SinavTYTSecimTurKriter STST ON STST.ID_TYTSECIMTUR = TST.ID_TYTSECIMTUR AND STST.ID_SINAV = @ID_SINAV
						FOR JSON PATH
					)
				END
				IF @ISLEM = 45	--	AYT için TYT Seçim Kriter Kaydet
				BEGIN
					DELETE FROM SinavTYTSecimTurKriter WHERE ID_SINAV = @ID_SINAV

					INSERT INTO SinavTYTSecimTurKriter (ID_SINAV, ID_TYTSECIMTUR, PUAN)
					VALUES (@ID_SINAV, @ID_TYTSECIMTUR, ISNULL(REPLACE(@BARAJ,',','.'),0.0))
				END
				IF @ISLEM = 46	--	SORU BANKASI SORU LISTESI
				BEGIN
					DECLARE		@DISPLAYLENGTH		INT				= 0,
								@DISPLAYSTART		INT				= 0,
								@WHERECLAUSE		VARCHAR(MAX)	= '',
								@ORDERBYCLAUSE		VARCHAR(MAX)	= '',
								@FILTER				VARCHAR(MAX)	= '',
								@TABLENAME			VARCHAR(MAX)	= 'vw_Soru',
								@COLUMNNAME			VARCHAR(MAX)	= '',
								@COLUMNS			VARCHAR(MAX)	= ''	

					SET @COLUMNNAME		= (SELECT COLUMN_NAME FROM SoruBankasi.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = @TABLENAME AND TABLE_SCHEMA='dbo' AND ORDINAL_POSITION = (SELECT CASE WHEN JSON_Value (VALUE, '$.column') = '0' THEN '1' ELSE JSON_Value (VALUE, '$.column') END FROM OPENJSON(@SQLJSON,'$.order')))

					SET @ORDERBYCLAUSE	= (SELECT ' ORDER BY '+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
					SET @WHERECLAUSE	= (SELECT value FROM OPENJSON(@SQLJSON, '$.search') WITH (value VARCHAR(MAX)))
					SET @DISPLAYSTART	= (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT)) + 1
					SET @DISPLAYLENGTH	= (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT)) - 1

					IF	@WHERECLAUSE=''
					BEGIN
						SET @WHERECLAUSE = '
							WHERE	SILINDI			= 0  
								AND ID_HAREKETDURUM	= 13 
								AND ID_SORUTUR		= 4								
								AND (SNV.ID_SINAV	= ' + CAST(@ID_SINAV AS VARCHAR) + ' OR ' + CAST(@ID_SINAV AS VARCHAR) + ' = 0)
								AND (	(	(''' + @KOD + ''' IS NULL OR ''' + @KOD + ''' = '''') 
										AND X.ID_DERS	= ' + CAST(@ID_DERS AS VARCHAR) + '
										)
									OR ((''' + @KOD + ''' IS not NULL and ''' + @KOD + ''' != '''') and (X.UNITE LIKE ''%' + @KOD + '%''))
								)'								
								--AND SNV.ID_SINAV	= ' + CAST(@ID_SINAV AS VARCHAR) + '
								--AND UNITE			= ''' + @KOD +''''
					END
					ELSE
					BEGIN
						SET @COLUMNS = ''
				
						SET @COLUMNS = '(U.AD LIKE ''%' + @WHERECLAUSE + '%'' OR ' + (SELECT ' X.' + COLUMN_NAME + ' LIKE ''%' + @WHERECLAUSE + '%'' OR' AS [text()] 
											FROM SoruBankasi.INFORMATION_SCHEMA.COLUMNS 
											WHERE	TABLE_NAME		= @TABLENAME 
												AND TABLE_SCHEMA	= 'dbo'
											FOR XML PATH ('')) + ')'

						SET @COLUMNS = SUBSTRING(@COLUMNS, 1, LEN(@COLUMNS)-3) + ') '
						SET @WHERECLAUSE = 'WHERE ' + @COLUMNS

						SET @WHERECLAUSE = @WHERECLAUSE + '	
								AND	X.SILINDI			= 0  
								AND X.ID_HAREKETDURUM	= 13 
								AND X.ID_SORUTUR		= 4
								AND SNV.ID_SINAV		= ' + CAST(@ID_SINAV AS VARCHAR) + ' 
								AND (''' + @KOD + ''' IS NULL OR ''' + @KOD + ''' = '''' OR X.UNITE LIKE ''%' + @KOD + '%'') '
					END

					DECLARE @LINK VARCHAR(MAX)=  'SoruBankasi/'
					SET @QUERY='
								SELECT * INTO #TEMP FROM   
								(
									SELECT ROW_NUMBER() OVER(' + @ORDERBYCLAUSE + ') AS RowNumber, * 
									FROM(
										SELECT DISTINCT X.*,UNITEKOD = U.KOD, UNITEAD = U.AD
										FROM ' + @TABLENAME + ' X
										JOIN Sinav				SNV	ON	SNV.ID_KADEME3	= X.ID_SINAVGRUP
										JOIN OkyanusDB.dbo.v3SinavDersUnite U ON U.KOD	= X.UNITE
										' + @WHERECLAUSE + '
									) 
								RawResults) DATA 


								DECLARE @DATA VARCHAR(MAX)=(
										SELECT	RowNumber
												,ID_SORU
												,UNITEKOD
												,UNITEAD
												,	''Soru Türü: '' + ISNULL(SORUTUR, '''') + ''<br />'' +
													''Grup: '' + ISNULL(SINAVGRUP, '''') + ''<br />'' +
													''Ders: '' + ISNULL(DERSAD, '''') + ''<br />'' +
													''Zorluk: '' + ISNULL(ZORLUKTUR, '''') + ''<br />'' +
													''Durum: '' + ISNULL(HAREKETDURUM, '''') + ''<br />'' +
													''Yazar: '' + ISNULL(KULLANICIAD, '''') + ''<br />'' +
													''Tarih: '' + CONVERT(VARCHAR, KYE_TARIH, 104)+ ''<br />'' +
													''Kod: '' + ISNULL(UNITEKOD, '''')  AS SORUBILGILERI 
												,SORUHTML	= (SELECT '''+ @LINK +''' + SORUHTML FROM SoruBankasi.dbo.SoruHtml WHERE ID_SORU = S.ID_SORU AND ID_TASLAKTUR=20) 
												,CEVAP		= (SELECT CEVAPNO,'''+ @LINK +''' + CEVAPHTML AS CEVAPHTML, DEGER FROM SoruBankasi.dbo.CEVAP WHERE ID_SORU = S.ID_SORU ORDER BY ID_CEVAP FOR JSON PATH, INCLUDE_NULL_VALUES) 
												,ID_SORUTUR
												,USTSORUHTML= CASE	WHEN ID_USTSORU IS NOT NULL THEN (SELECT SORUHTML FROM SoruBankasi.dbo.SoruHtml WHERE ID_SORU = S.ID_USTSORU AND ID_TASLAKTUR=20) 
																	ELSE '''' 
																END 
												,COZUM		= (SELECT COZUMHTML, ID_COZUMTUR FROM SoruBankasi.dbo.SoruCozum WHERE ID_SORU = S.ID_SORU ORDER BY SIRA FOR JSON PATH, INCLUDE_NULL_VALUES)
												,KULLANIM	= (	SELECT SN.AD, CONVERT(VARCHAR, SN.KYE_TARIH, 104) AS KYE_TARIH, SS.KITAPCIK, SS.SORUNO FROM SoruBankasi.dbo.SinavSoru SS
																	INNER JOIN SoruBankasi.dbo.Sinav SN ON SN.ID_SINAV = SS.ID_SINAV
																	WHERE SN.SILINDI = 0 AND SS.ID_SORU = S.ID_SORU 
																	ORDER BY SS.KITAPCIK
																	FOR JSON PATH, INCLUDE_NULL_VALUES)
												,ID_HAREKETDURUM
												,ALTSORU = (SELECT SUBS.ID_SORU, SORUTUR, DERSAD, ZORLUKTUR FROM '+@TABLENAME+' SUBS
															WHERE SUBS.ID_USTSORU = S.ID_SORU
															FOR JSON PATH, INCLUDE_NULL_VALUES)
												,SORUTUR, DERSAD, ZORLUKTUR
												,SORUGECMIS = ISNULL((
													SELECT DISTINCT SN.ID_SINAV, SN.DONEM, SN.AD SINAVAD, ST.KISAAD SINAVTURU, SN.SINAVTARIH
													FROM Pusulam.dbo.Sinav			SN
													JOIN Pusulam.dbo.SinavTuru		ST	ON	ST.ID_SINAVTURU	= SN.ID_SINAVTURU
													JOIN Pusulam.dbo.SinavDers		SD	ON	SD.ID_SINAV		= SN.ID_SINAV
													JOIN Pusulam.dbo.SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
													WHERE SA.ID_SORUBANKASI = S.ID_SORU
													ORDER BY SN.DONEM DESC, SN.SINAVTARIH
													FOR JSON PATH										
												),''[]'')
												,ID_SORUDUZEY
										FROM #TEMP S
										WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX), @DISPLAYSTART)+' AND '+CONVERT(VARCHAR(MAX), (@DISPLAYSTART + @DISPLAYLENGTH))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
								)

								SELECT(
									SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
									(SELECT COUNT(1) FROM ' + @TABLENAME + ') AS recordsTotal, 
									(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
									@DATA AS data FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS JSONDATA

								DROP TABLE #TEMP
					'
					print @QUERY
					EXECUTE (@QUERY)
				

				END
				IF @ISLEM = 47	--	SORU BANKASI ID KONTROL
				BEGIN
					SELECT ISNULL((
							SELECT S.ID_SORU, UNITEKOD = U.KOD, UNITEAD = U.AD, S.ID_SORUDUZEY, CEVAP = (SELECT CASE CEVAPNO WHEN 1 THEN 'A' WHEN 2 THEN 'B' WHEN 3 THEN 'C' WHEN 4 THEN 'D' WHEN 5 THEN 'E' ELSE '' END FROM SoruBankasi.dbo.CEVAP WHERE ID_SORU = S.ID_SORU AND DEGER = 1)
												,SORUGECMIS = ISNULL((
													SELECT DISTINCT SN.ID_SINAV, SN.DONEM, SN.AD SINAVAD, ST.KISAAD SINAVTURU, SN.SINAVTARIH
													FROM Pusulam.dbo.Sinav			SN
													JOIN Pusulam.dbo.SinavTuru		ST	ON	ST.ID_SINAVTURU	= SN.ID_SINAVTURU
													JOIN Pusulam.dbo.SinavDers		SD	ON	SD.ID_SINAV		= SN.ID_SINAV
													JOIN Pusulam.dbo.SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
													WHERE SA.ID_SORUBANKASI = S.ID_SORU
													ORDER BY SN.DONEM DESC, SN.SINAVTARIH
													FOR JSON PATH										
												),'[]')
							FROM vw_Soru						S 
							JOIN Sinav							SNV	ON	SNV.ID_KADEME3	= S.ID_SINAVGRUP
							JOIN OkyanusDB.dbo.v3SinavDersUnite	U	ON	U.KOD			= S.UNITE
							WHERE	S.ID_SORU		= @ID_SORUBANKASI
								AND	S.SILINDI		= 0
								AND SNV.ID_SINAV	= @ID_SINAV
								AND S.ID_SORUTUR	= 4
								AND	(@UNITEKOD	IS NULL OR @UNITEKOD ='' OR S.UNITE = @UNITEKOD)
							FOR JSON PATH
					),'[]')
				END
				IF @ISLEM = 48	--	ONLINE SINAV OPTIK HAZIRLAMA
				BEGIN
					
					DROP TABLE IF EXISTS #SinavOptikSabit
					DROP TABLE IF EXISTS #SinavOptikDers
					DROP TABLE IF EXISTS #OGRENCILIST
					DROP TABLE IF EXISTS #LINE

					SELECT	 SOS.ID_SINAVOPTIK
							,SOS.BASLANGIC
							,SOS.OPTIKKARAKTERSAYISI
					INTO #SinavOptikSabit
					FROM Sinav				S
					JOIN SinavOptikSabit	SOS	ON	SOS.ID_SINAV	= S.ID_SINAV
					WHERE S.ID_SINAV = @ID_SINAV


					SELECT	 SD.BOLUMNO
							,SD.ID_SINAVDERS
							,SOD.OTURUM
							,SOD.BASLANGIC
							,SOD.OPTIKKARAKTERSAYISI
					INTO #SinavOptikDers
					FROM Sinav			S
					JOIN SinavDers		SD	ON	SD.ID_SINAV		= S.ID_SINAV
					JOIN SinavOptikDers	SOD	ON	SOD.ID_SINAVDERS= SD.ID_SINAVDERS
					WHERE	S.ID_SINAV	= @ID_SINAV
						--AND SOD.OTURUM	= @SINAVOTURUM
					ORDER BY BASLANGIC


					SELECT DISTINCT SO.TCKIMLIKNO
					INTO #OGRENCILIST
					FROM Tbl_OnlineSinavOgrenci			SO
					JOIN Tbl_OnlineSinavOgrenciCevap	SOC	ON	SOC.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
					WHERE	SO.ID_SINAV = @ID_SINAV
						AND SO.AKTIF	= 1
						AND SOC.AKTIF	= 1


					--DECLARE @BOSLUKSAYISI	INT	= (SELECT TOP 1 BASLANGIC + OPTIKKARAKTERSAYISI FROM #SinavOptikSabit ORDER BY BASLANGIC DESC)
					DECLARE @BOSLUKSAYISI	INT	= (SELECT TOP 1 BASLANGIC FROM #SinavOptikDers ORDER BY BASLANGIC)
					DECLARE @TCSIRASI		INT	= (SELECT BASLANGIC FROM #SinavOptikSabit WHERE ID_SINAVOPTIK = 1)
					DECLARE @KITAPCIKSIRASI	INT	= (SELECT BASLANGIC FROM #SinavOptikSabit WHERE ID_SINAVOPTIK = 4)

					SELECT LINE = STUFF(dbo.fn_BoslukBirak(@TCSIRASI - 1) + SO.TCKIMLIKNO + dbo.fn_BoslukBirak(@BOSLUKSAYISI - (@TCSIRASI + 11)), @KITAPCIKSIRASI, 1, 'A')
						,SOD.BASLANGIC
						,TEST = IIF( SOD.OTURUM = @SINAVOTURUM, (ISNULL(REPLACE(STUFF((		
									SELECT IIF( C.CEVAPNO IS NOT NULL
												,  CASE WHEN C.CEVAPNO = 1 THEN 'A'
														WHEN C.CEVAPNO = 2 THEN 'B'
														WHEN C.CEVAPNO = 3 THEN 'C'
														WHEN C.CEVAPNO = 4 THEN 'D'
														WHEN C.CEVAPNO = 5 THEN 'E'
														ELSE '-'
													END
												, '-')
									FROM SinavAnahtar						SA	
									LEFT JOIN Tbl_OnlineSinavOgrenciCevap	OC	ON	OC.ID_ONLINESINAVOGRENCI= SO.ID_ONLINESINAVOGRENCI
																				AND SA.ID_SINAVANAHTAR		= OC.ID_SINAVANAHTAR
																				AND OC.AKTIF				= 1
									LEFT JOIN SoruBankasi..Cevap			C	ON	C.ID_SORU				= SA.ID_SORUBANKASI
																				AND C.ID_CEVAP				= OC.ID_CEVAP				
									WHERE	SA.ID_SINAVDERS	= SOD.ID_SINAVDERS
									ORDER BY SA.SORUNO_A
									FOR XML PATH('')
							), 1, 0, ''), '-', ' '), dbo.fn_BoslukBirak(SOD.OPTIKKARAKTERSAYISI)))
						,dbo.fn_BoslukBirak(SOD.OPTIKKARAKTERSAYISI))
					INTO #LINE
					FROM Tbl_OnlineSinavOgrenci	SO
					JOIN #OGRENCILIST			OL	ON	OL.TCKIMLIKNO	= SO.TCKIMLIKNO
					JOIN SinavDers				SD	ON	SD.ID_SINAV		= SO.ID_SINAV
					JOIN #SinavOptikDers		SOD	ON	SOD.BOLUMNO		= SD.BOLUMNO
					WHERE	SO.ID_SINAV = @ID_SINAV
						AND SO.AKTIF	= 1
	
					DECLARE @cols48 NVARCHAR(MAX) = NULL
					DECLARE @sels48 NVARCHAR(MAX) = NULL
					DECLARE @sql48 NVARCHAR(MAX) = NULL

					SET @cols48 = STUFF((	SELECT ',' +  QUOTENAME( C.BASLANGIC)  FROM #SinavOptikDers c ORDER BY C.BASLANGIC FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
					SET @sels48 = STUFF((	SELECT '+' +  QUOTENAME( C.BASLANGIC)  FROM #SinavOptikDers c ORDER BY C.BASLANGIC FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')	
					--SET @sql48 = '
					--	SELECT LINE = LINE + '+@sels48+'
					--	FROM #LINE
					--	PIVOT ( MAX(TEST) FOR BASLANGIC IN(' + @cols48 + ') ) P
					--	ORDER BY LINE
					--'

					
					SET @sql48 = '
						DROP TABLE IF EXISTS #TEMP
						SELECT LINE = LINE + '+@sels48+' , RN = ROW_NUMBER() OVER(ORDER BY LINE)
						INTO #TEMP
						FROM #LINE
						PIVOT ( MAX(TEST) FOR BASLANGIC IN(' + @cols48 + ') ) P
						ORDER BY LINE

						DECLARE @TEKSATIR NVARCHAR(MAX) = ''''
						IF '+CAST(@MAIL AS VARCHAR)+' = CAST(1 AS BIT)
						BEGIN
							SELECT REPLACE(LINE,'' '',''&nbsp;''),RN FROM #TEMP ORDER BY RN
						END
						ELSE
						BEGIN
							WHILE EXISTS(SELECT TOP 1 1 FROM #TEMP)
							BEGIN
								DECLARE @RN INT = (SELECT TOP 1 RN FROM #TEMP ORDER BY RN)
								SET @TEKSATIR += (SELECT LINE + IIF(EXISTS(SELECT TOP 1 1 FROM #TEMP WHERE RN != @RN) , CHAR(13) + CHAR(10), '''') FROM #TEMP WHERE RN = @RN) 
								DELETE FROM #TEMP WHERE RN = @RN
							END
							SELECT @TEKSATIR
						END
					'

					EXEC (@sql48)

					
					DROP TABLE IF EXISTS #SinavOptikSabit
					DROP TABLE IF EXISTS #SinavOptikDers
					DROP TABLE IF EXISTS #OGRENCILIST
					DROP TABLE IF EXISTS #LINE

				END
				IF @ISLEM = 49  --  SINAV DÜZENLE YETKİ KONTROL 
				BEGIN

					-- BUNU SINAV DÜZENLEMEYE KOPYALA
					--EXEC sp_Sinav @TCKIMLIKNO = @TCKIMLIKNO , @OTURUM = @OTURUM, @ID_MENU = @ID_MENU, @ISLEM = 49, @ID_SINAV = @ID_SINAV


					--'YETKİNİZ YOK'	0
					--'SINAV BAŞLAMADI' 1
					--'SINAV BAŞLADI'	2
					DECLARE @SONUC INT = 1
					IF EXISTS (SELECT TOP 1 1 FROM Sinav WHERE ID_SINAV = @ID_SINAV AND ONLINESINAV = 1)
					BEGIN
						IF	EXISTS( SELECT VALUE FROM fn_Split((SELECT DEGER FROM ParametreDeger WHERE ID_PARAMETREDEGER = 4), ',', NULL ) WHERE VALUE = @TCKIMLIKNO)
						BEGIN					
					
							-- sınav başladı
							-- tc yetkisi var mı 

							IF EXISTS (	SELECT TOP 1 1 
										FROM Sinav S 
										JOIN Tbl_OnlineSinavDetay		D	ON	D.ID_SINAV				= S.ID_SINAV 
																			AND D.AKTIF					= 1
										JOIN Tbl_OnlineSinavDetayOturum	DO	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
										WHERE	S.ID_SINAV		= @ID_SINAV 
											AND S.ONLINESINAV	= 1 
											AND DO.BASTARIH		< GETDATE()
										)
							BEGIN
								SET @SONUC = 2
							END
						END
						ELSE
						BEGIN
							SET @SONUC = 0
						END
					END

					SELECT @SONUC
				END

				IF @ISLEM = 50  -- YÖNERGE SİL
				BEGIN
					UPDATE Sinav SET YONERGE_GUID =NULL WHERE ID_SINAV=@ID_SINAV
				END	

				-- GENEL 
				DROP TABLE IF EXISTS #KADEMELER
				DROP TABLE IF EXISTS #OTURUMLAR
			--END

			
		END
	
		--COMMIT TRANSACTION [Tran1]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [Tran1]
		IF @ISLEM IN (14, 17)	--	DOSYA YÜKLEME
		BEGIN
			UPDATE Sinav			SET DURUM = 0, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV
		END

		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_GenelSinavRaporu]...';


GO
ALTER procedure [dbo].[sp_GenelSinavRaporu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= 0,
	@ID_SINAVTURU		INT				= 0,
	@ID_SINAV			INT				= 0,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SIRALAMA			int				= NULL,
	@ID_SINIFS			NVARCHAR(MAX)	= NULL,
	@ID_SUBES			NVARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	

--	exec [sp_GenelSinavRaporu] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='68A20E79-813A-4653-9645-70586853CA77', @ID_MENU= 1029,@ID_SINIFS='[101928,101929,101930,101931,101881]',@ID_SUBES ='[236]',@ID_SINAV =243

	IF @return_variable = 1
	BEGIN
		IF @ISLEM = 1 or @ISLEM=2 or @ISLEM=3	--	
		BEGIN
			
		
			BEGIN

			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #BOLUMSIRALA
			DROP TABLE IF EXISTS #OGRENCILIST
			DROP TABLE IF EXISTS #ALINANBURS
			DROP TABLE IF EXISTS #BURSOGRENCI
			DROP TABLE IF EXISTS #OGRENCIBURS
			DROP TABLE IF EXISTS #BurslulukSinavOgrenci

			SELECT	OB.TCKIMLIKNO
					,OB.PUAN
					,OB.ID_SINAVDERS
					,SINIFSIRA  = OB.PUAN_SINIFSIRA  
					,OKULSIRA	= OB.PUAN_OKULSIRA 
					,ILCESIRA	= OB.PUAN_ILCESIRA 
					,ILSIRA		= OB.PUAN_ILSIRA 
					,GENELSIRA	= OB.PUAN_GENELSIRA								 
			INTO	#BOLUMSIRALA
			FROM vw_SinavOgrenciBolum	OB
			WHERE OB.ID_SINAV = @ID_SINAV
			ORDER BY TCKIMLIKNO,ID_SINAVDERS
			
			---------------------------------------------------

			SELECT DISTINCT O.TCKIMLIKNO 
			INTO #OGRENCILIST
			FROM v3OgrenciTum O
			INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
			WHERE SO.ID_SINAV=@ID_SINAV
				AND	(	O.ID_SUBE	IN (select value from openjson (@ID_SUBES))		OR	(O.ID_SUBE IN (SELECT ID_SUBE FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO) and (0 IN (select value from openjson (@ID_SUBES)))))
				AND (	O.ID_SINIF	IN (select value from openjson (@ID_SINIFS))	OR	(0 IN (select value from openjson (@ID_SINIFS))) OR @ID_SINIFS='[]')
		
		SELECT TCKIMLIKNO,BURSORANI,ID_SINAVDERS,BURSTUR,ROW_NUMBER () OVER(ORDER BY BURSORANI DESC ,BURSTUR) RN
		INTO #BURSOGRENCI
		FROM BurslulukSinavOgrenciSonuc
		WHERE ID_SINAV = @ID_SINAV

		SELECT TCKIMLIKNO,MIN(RN) RN
		INTO #ALINANBURS
		FROM #BURSOGRENCI
		GROUP BY TCKIMLIKNO

		SELECT TCKIMLIKNO,MAX(ID_BURSOGRENCI) ID_BURSOGRENCI
		INTO #BurslulukSinavOgrenci
		FROM BurslulukSinavOgrenci 
		WHERE ID_SINAV	= @ID_SINAV
		GROUP BY TCKIMLIKNO
		
		SELECT BO.TCKIMLIKNO
			,BO.BURSORANI
			,BURSTUR
			,BURS_IDSINAVDERS	= ISNULL(SD.ID_SINAVDERS,0)
			,BURS_BOLUMNO		= ISNULL(SD.BOLUMNO,0)
		INTO #OGRENCIBURS
		FROM #BURSOGRENCI	BO
		JOIN #ALINANBURS	AB	ON	AB.RN			= BO.RN
		LEFT JOIN SinavDers	SD	ON	SD.ID_SINAVDERS = BO.ID_SINAVDERS


			PRINT 'TEMP'
		SELECT	DISTINCT 
					 SO.TCKIMLIKNO
					,SU.AD SUBEAD
					,ISNULL(SN.AD,SO.SINIF) SINIFAD
					,SO.AD
					,SO.SOYAD
					,SD.TAKMAAD DERSAD
					,CB.DOGRU
					,CB.YANLIS
					,CB.BOS
					,CB.NET
					,CB.YUZDENET
					,SD.ID_SINAVDERS
					,S.OLCEKSINAVI										
					,PUANGIZLE	= ISNULL(	CASE WHEN	NOT EXISTS (SELECT 1 FROM SinavPuanTuru SPT WHERE SPT.ID_SINAVTURU	= S.ID_SINAVTURU) 												
													OR	NOT EXISTS (SELECT 1 FROM SinavKatsayi  SK  WHERE SK.ID_SINAV		= @ID_SINAV)
													THEN 1 
													ELSE S.PUANGIZLE 
													END 
										,1)
					,(SELECT SUM(DOGRU+YANLIS+BOS) FROM SinavOgrenciCevapBolum B WHERE B.ID_SINAVOGRENCICEVAPBOLUM= CB.ID_SINAVOGRENCICEVAPBOLUM) SORUSAYISI
					,BOLUMNO
					,ISNULL(DDL.ACIKLAMA,'')	KURSEVIYE
					,ISNULL(KSN.AD,'')			KURSINIF
					,ISNULL(O.ID_SINIF, 0) AS ID_SINIF
					,ISNULL(SU.ID_SUBE, 0) AS ID_SUBE
					,S.ID_SINAV
			INTO	#TEMP
			FROM	SinavOgrenciCevapBolum	CB	
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAVOGRENCI		=	CB.ID_SINAVOGRENCI 
												AND CAST(SO.SUBENO AS INT)	IN	(SELECT SUBENO FROM v3Sube WHERE ID_SUBE IN (select value from openjson (@ID_SUBES))	)			
			JOIN	Sinav					S	ON	S.ID_SINAV				=	SO.ID_SINAV
			JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS			=	CB.ID_SINAVDERS
	   LEFT	JOIN	#OGRENCILIST			OL	ON	OL.TCKIMLIKNO			=	SO.TCKIMLIKNO
	   LEFT JOIN	V3SUBE					SU	ON	SU.SUBENO				=	CAST(SO.SUBENO AS INT)
	   LEFT JOIN	v3OgrenciTum			O	ON  O.TCKIMLIKNO			=	OL.TCKIMLIKNO		
												AND O.DONEM					=	S.DONEM
	   LEFT JOIN	V3SinifTum				SN	ON	SN.ID_SINIF				=	O.ID_SINIF		
	   LEFT JOIN	OKYANUSSQL.xBase.[dbo].[OgrIngilizceSeviye] OGR ON	OGR.ID_SOZLESME	= O.ID_SOZLESME
																	AND S.ID_SINAVTURU  = 5					-- KTT (YDS DİL SINAVI)
	   LEFT JOIN	OKYANUSSQL.xBase.[dbo].[OgrenciDdlDoldur]	DDL ON	DDL.ID			= OGR.ID_SEVIYE
																	AND DDL.TABLO		= 7					-- XBASE ING SEVIYE 
	   LEFT JOIN    V3SinifTum									KSN	ON	KSN.ID_SINIF	= OGR.ID_SINIF
			WHERE	S.ID_SINAV	= @ID_SINAV
			--GROUP BY SO.TCKIMLIKNO,SU.AD,SO.SINIF,SO.AD,SO.SOYAD,SD.TAKMAAD,DOGRU,YANLIS,BOS,NET,SD.ID_SINAVDERS,S.OLCEKSINAVI,PUANGIZLE,BOLUMNO,DDL.ACIKLAMA,KSN.AD,S.ID_SINAVTURU,SN.AD,O.ID_SINIF,SU.ID_SUBE,S.ID_SINAV
			ORDER BY BOLUMNO



			-- farklı kitapçıklarda farklı isimlerde giriş yapmışsa düzenlenecek
			update t
			set	 t.AD	 = (select top 1 AD		from #TEMP k where k.TCKIMLIKNO = t.TCKIMLIKNO)
				,t.SOYAD = (select top 1 SOYAD	from #TEMP k where k.TCKIMLIKNO = t.TCKIMLIKNO)
			from #TEMP t
			where SINIFAD LIKE 'OKY-%'
						
			update t
			set SORUSAYISI=k.ss
			from #TEMP  as t
			join (	select MAX(SORUSAYISI) AS SS, ID_SINAVDERS from #TEMP  GROUP BY ID_SINAVDERS) k on k.ID_SINAVDERS=t.ID_SINAVDERS
			
			SELECT DISTINCT	
				T.SUBEAD
				,SINIFAD
				,T.TCKIMLIKNO
				,T.AD
				,T.SOYAD
				,OLCEKSINAVI
				,PUANGIZLE
				,TD= OT.TD
				,TY= OT.TY
				,TB= OT.TB
				,TN= OT.TN		
				,YUZDENET = CAST((TN/NULLIF((SELECT CAST(SUM(TD+TY+TB) AS FLOAT) FROM SinavOgrenciToplam SOT WHERE SOT.TCKIMLIKNO = OT.TCKIMLIKNO AND SOT.ID_SINAV = OT.ID_SINAV),0))*100.0 AS decimal(8,2))
				,TS =(SELECT SUM (TD+TY+TB) FROM SinavOgrenciToplam SOT WHERE SOT.TCKIMLIKNO = OT.TCKIMLIKNO AND SOT.ID_SINAV = OT.ID_SINAV)
				,SINIFSIRA	= OT.TN_SINIFSIRA
				,OKULSIRA	= OT.TN_OKULSIRA
				,ILCESIRA	= OT.TN_ILCESIRA
				,ILSIRA		= OT.TN_ILSIRA
				,GENELSIRA	= OT.TN_GENELSIRA
				,KURSEVIYE
				,KURSINIF
				,T.ID_SUBE
				,T.ID_SINIF
				,BURSTUR			= ISNULL(OB.BURSTUR			,0 )
				,BURS_IDSINAVDERS	= ISNULL(OB.BURS_IDSINAVDERS,0 )
				,BURSORANI			= ISNULL(OB.BURSORANI		,0 )
				,OKULADI			= ISNULL(BSO.OKULADI		,'')
				,VELI_ADSOYAD		= ISNULL(BSO.VELI_ADSOYAD	,'')
				,TELEFON_EV			= ISNULL(BSO.TELEFON_EV		,'')
				,TELEFON_CEP		= ISNULL(BSO.TELEFON_CEP	,'')
				,MAIL				= ISNULL(BSO.MAIL			,'')
				,BURS_BOLUMNO		= ISNULL(BURS_BOLUMNO		,'')
			INTO	#T1
			FROM	#TEMP						T
			JOIN	SinavOgrenciToplam			OT	ON	OT.TCKIMLIKNO		= T.TCKIMLIKNO  
													AND OT.ID_SINAV			= T.ID_SINAV
			LEFT JOIN #OGRENCIBURS				OB	ON	OB.TCKIMLIKNO		= OT.TCKIMLIKNO
			LEFT JOIN #BurslulukSinavOgrenci	BS2	ON	BS2.TCKIMLIKNO		= T.TCKIMLIKNO 
			LEFT JOIN BurslulukSinavOgrenci		BSO	ON	BSO.ID_BURSOGRENCI	= BS2.ID_BURSOGRENCI 



			SELECT		T.TCKIMLIKNO,DERSAD,DOGRU,YANLIS,BOS,NET,YUZDENET,SORUSAYISI,BS.SINIFSIRA,OKULSIRA,ILCESIRA,ILSIRA,GENELSIRA,PUAN,BOLUMNO,T.AD,T.SOYAD,T.ID_SINAVDERS
			INTO		#T2
			FROM		#TEMP				T
			JOIN		#BOLUMSIRALA		BS	ON	BS.TCKIMLIKNO		= T.TCKIMLIKNO 
												AND	BS.ID_SINAVDERS		= T.ID_SINAVDERS		


			SELECT	 T.TCKIMLIKNO
					,CAST (OP.PUAN AS varchar) AS PUAN
					,PT.ID_SINAVPUANTURU
					,ISNULL(PT.AD,'')AD
					,OP.SINIFSIRA
					,OP.OKULSIRA
					,OP.ILCESIRA
					,OP.ILSIRA
					,OP.GENELSIRA
					,T.AD OGRAD
					,T.SOYAD
					,MAX(SO.ID_SINAVOGRENCI)ID_SINAVOGRENCI
			INTO		#T3
			FROM		vw_SinavOgrenciPuan	OP	--SinavOgrenciPuan
			JOIN		SinavOgrenci		SO	ON  SO.TCKIMLIKNO		= OP.TCKIMLIKNO
												AND SO.ID_SINAV			= OP.ID_SINAV
												AND SO.ID_SINAV			= @ID_SINAV
			right JOIN	#TEMP				T	ON  T.TCKIMLIKNO		= SO.TCKIMLIKNO			
												AND T.AD				= SO.AD
												AND T.SOYAD				= SO.SOYAD
			left JOIN	SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU = OP.ID_SINAVPUANTURU 
			GROUP BY	PT.ID_SINAVPUANTURU,T.TCKIMLIKNO,OP.PUAN,PT.AD,SINIFSIRA,OKULSIRA,ILCESIRA,ILSIRA,GENELSIRA,T.AD,T.SOYAD
			

			END

			IF @ISLEM = 1 
			BEGIN
			select(
				select * from(
					select 
					(
						SELECT * FROM #T1 O
						WHERE		
							(	O.ID_SUBE	IN (select value from openjson (@ID_SUBES))		OR	(O.ID_SUBE IN (SELECT ID_SUBE FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)))
						AND (	O.ID_SINIF	IN (select value from openjson (@ID_SINIFS))	OR	(0 IN (select value from openjson (@ID_SINIFS))) OR @ID_SINIFS='[]')				
						ORDER BY GENELSIRA, TN DESC,TCKIMLIKNO,AD,SOYAD,SUBEAD,SINIFAD		
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) as t1					
					,(
						SELECT * FROM #T2		
						ORDER BY BOLUMNO				
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) as t2
					,( 						
						SELECT DISTINCT TCKIMLIKNO,PUAN,ID_SINAVPUANTURU,AD,SINIFSIRA,OKULSIRA,ILCESIRA,ILSIRA,GENELSIRA,OGRAD,SOYAD FROM #T3						
						GROUP BY ID_SINAVPUANTURU,TCKIMLIKNO,PUAN,AD,OGRAD,SOYAD,SINIFSIRA,OKULSIRA,ILCESIRA,ILSIRA,GENELSIRA
						ORDER BY TCKIMLIKNO,ID_SINAVPUANTURU
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					)as t3					
				) as tablo FOR JSON AUTO, INCLUDE_NULL_VALUES
			) as tt
			end


			-- KULLANILMIYOR
			IF @ISLEM=2	--	DataSet
			BEGIN
							SELECT *,AD+' '+SOYAD ADSOYAD FROM #T1
							ORDER BY GENELSIRA, TN DESC,TCKIMLIKNO,AD,SOYAD,SUBEAD,SINIFAD	
						
							select distinct DERSAD,SORUSAYISI,BOLUMNO from #T2

							SELECT * FROM #T2	
							ORDER BY DERSAD	

							SELECT DISTINCT ID_SINAVPUANTURU,AD SINAVPUANTURU FROM #T3 

							SELECT	TCKIMLIKNO
									,PUAN
									,ID_SINAVPUANTURU
									,AD
									,MAX( SINIFSIRA)SINIFSIRA
									,MAX( OKULSIRA)OKULSIRA
									,MAX( ILCESIRA)ILCESIRA
									,MAX( ILSIRA)ILSIRA
									,MAX( GENELSIRA)GENELSIRA
									,OGRAD
									,SOYAD
									,MAX(ID_SINAVOGRENCI) 
							FROM #T3
							GROUP BY ID_SINAVPUANTURU,TCKIMLIKNO,PUAN,AD,OGRAD,SOYAD
							ORDER BY TCKIMLIKNO,ID_SINAVPUANTURU


							SELECT DISTINCT ST.AD SINAVTURU ,S.AD SINAVAD,convert(varchar, S.SINAVTARIH,103) SINAVTARIH 
							FROM SinavTuru		ST
							JOIN Sinav			S	ON	S.ID_SINAVTURU	= ST.ID_SINAVTURU
							JOIN SinavOgrenci	SO	ON	SO.ID_SINAV		= S.ID_SINAV
							WHERE S.ID_SINAV=@ID_SINAV

							SELECT	 DERSAD
									,CAST(AVG(convert(decimal(8,2),DOGRU	)) AS DECIMAL(8,2)) DOGRUORT 
									,CAST(AVG(convert(decimal(8,2),YANLIS	)) AS DECIMAL(8,2)) YANLISORT 
									,CAST(AVG(convert(decimal(8,2),BOS		)) AS DECIMAL(8,2)) BOSORT 
									,CAST(AVG(convert(decimal(8,2),NET		)) AS DECIMAL(8,2)) NETORT 
									,CAST(AVG(convert(decimal(8,2),PUAN		)) AS DECIMAL(8,2)) PUANORT 
							FROM #T2
							GROUP BY DERSAD
						UNION ALL						
							SELECT	 'TOPLAM' DERSAD
									,CAST(AVG(convert(decimal(8,2),TD	)) AS DECIMAL(8,2)) DOGRUORT 
									,CAST(AVG(convert(decimal(8,2),TY	)) AS DECIMAL(8,2)) YANLISORT 
									,CAST(AVG(convert(decimal(8,2),TB	)) AS DECIMAL(8,2)) BOSORT 
									,CAST(AVG(convert(decimal(8,2),TN	)) AS DECIMAL(8,2)) NETORT 
									,CAST(0 AS DECIMAL(8,2)) PUANORT 
							FROM #T1

			end 	

			
			IF @ISLEM=3	--	DataSet
			BEGIN
							SELECT  SUBEAD,
									SINIFAD,
									TCKIMLIKNO,
									AD,
									SOYAD,
									OLCEKSINAVI,
									PUANGIZLE,
									TD,
									TY,
									TB,
									TN,
									YUZDENET,
									TS,
									SINIFSIRA,
									OKULSIRA,
									ILCESIRA,
									ILSIRA,
									GENELSIRA,
									KURSEVIYE,
									KURSINIF,
									ID_SUBE,
									ID_SINIF,
									BURSTUR,
									BURS_IDSINAVDERS,
									BURSORANI,
									OKULADI,
									VELI_ADSOYAD,
									TELEFON_EV,
									TELEFON_CEP,
									MAIL,
									BURS_BOLUMNO,
									AD+' '+SOYAD ADSOYAD 
							FROM #T1 O
							WHERE		
								(	O.ID_SUBE	IN (select value from openjson (@ID_SUBES))		OR	(O.ID_SUBE IN (SELECT ID_SUBE FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)))
							AND (	O.ID_SINIF	IN (select value from openjson (@ID_SINIFS))	OR	(0 IN (select value from openjson (@ID_SINIFS))) OR @ID_SINIFS='[]')		
							ORDER BY GENELSIRA, TN DESC,TCKIMLIKNO,AD,SOYAD,SUBEAD,SINIFAD	
						
							select DERSAD,max(SORUSAYISI) as SORUSAYISI,BOLUMNO from #T2 group by DERSAD,BOLUMNO

							SELECT	TCKIMLIKNO,
									DERSAD,
									DOGRU,
									YANLIS,
									BOS,
									NET,
									YUZDENET,
									SORUSAYISI,
									SINIFSIRA,
									OKULSIRA,
									ILCESIRA,
									ILSIRA,
									GENELSIRA,
									PUAN,
									BOLUMNO,
									AD,
									SOYAD,
									ID_SINAVDERS
							FROM #T2		
							ORDER BY DERSAD	

							SELECT DISTINCT ID_SINAVPUANTURU,AD SINAVPUANTURU FROM #T3 

							SELECT	TCKIMLIKNO
									,PUAN
									,ID_SINAVPUANTURU
									,AD
									,MAX( SINIFSIRA)SINIFSIRA
									,MAX( OKULSIRA)OKULSIRA
									,MAX( ILCESIRA)ILCESIRA
									,MAX( ILSIRA)ILSIRA
									,MAX( GENELSIRA)GENELSIRA
									,OGRAD
									,SOYAD
									,MAX(ID_SINAVOGRENCI) 
							FROM #T3
							GROUP BY ID_SINAVPUANTURU,TCKIMLIKNO,PUAN,AD,OGRAD,SOYAD
							ORDER BY TCKIMLIKNO,ID_SINAVPUANTURU


							SELECT DISTINCT ST.AD SINAVTURU ,S.AD SINAVAD,convert(varchar, S.SINAVTARIH,103) SINAVTARIH
							FROM SinavTuru		ST
							JOIN Sinav			S	ON	S.ID_SINAVTURU	= ST.ID_SINAVTURU
							JOIN SinavOgrenci	SO	ON	SO.ID_SINAV		= S.ID_SINAV
							WHERE S.ID_SINAV=@ID_SINAV
							
---------------------------------------- GENEL ORT
						SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS,SO.TCKIMLIKNO,BOLUMNO,PUAN,YUZDENET
						INTO	#Temp11
						FROM	Sinav					S	WITH (NOLOCK)
						JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV		
						JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
						JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
						JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
						WHERE	S.DURUM		= 2
							AND S.AKTIF		= 1
							AND S.ID_SINAV	= @ID_SINAV
			
						SELECT SINAVAD,DERSAD,BOLUMNO
						,DOGRUORT	= CAST(AVG(DOGRU) AS decimal(8,2))
						,YANLISORT	= CAST(AVG(YANLIS) AS decimal(8,2))
						,BOSORT		= CAST(AVG(BOS) AS decimal(8,2))
						,NETORT		= CAST(AVG(NET) AS decimal(8,2))
						,YUZDENETORT= CAST(AVG(YUZDENET) AS decimal(8,2))
						,PUANORT	= CAST(AVG(PUAN) AS decimal(8,2))
						INTO #ORT  
						FROM #Temp11 
						GROUP BY DERSAD,SINAVAD,BOLUMNO

						INSERT INTO #ORT
						SELECT SINAVAD,'TOPLAM',999
						,CAST(SUM(DOGRU	)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS DOGRUORT	
						,CAST(SUM(YANLIS)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS YANLISORT	
						,CAST(SUM(BOS	)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS BOSORT		
						,CAST(SUM(NET	)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS NETORT	
						,CAST((SELECT AVG(YUZDENET) FROM #T1) AS decimal(8,2)) AS YUZDENETORT	
						,CAST(SUM(PUAN	)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS PUANORT	
						FROM #Temp11
						GROUP BY SINAVAD

						SELECT DERSAD,DOGRUORT,YANLISORT,BOSORT,NETORT,PUANORT,YUZDENETORT FROM #ORT
						ORDER BY BOLUMNO

						drop table #Temp11
						drop table #ORT
----------------------------------------
							  
						declare  @Columns		varchar(max)
								,@ColumnsD		varchar(max)
								,@ColumnsY		varchar(max)
								,@ColumnsB		varchar(max)
								,@ColumnsN		varchar(max)
								,@ColumnsYN		varchar(max)
								,@ColumnsDP		varchar(max)
								,@ColumnsMAX	varchar(max)
								,@ColumnsPT		varchar(max)
								,@ColumnsSS		varchar(max)
								,@ColumnsOS		varchar(max)
								,@ColumnsCS		varchar(max)
								,@ColumnsIL		varchar(max)
								,@ColumnsGS		varchar(max)
								,@ColumnsPTMAX	varchar(max)
								,@SQL			varchar(max)
						
						 Select 
							  @Columns  =Coalesce(@Columns  +',','')+QUOTENAME(BOLUMNO) 
							 ,@ColumnsD =Coalesce(@ColumnsD +',','')+QUOTENAME('D' +CAST(BOLUMNO AS varchar)) 
							 ,@ColumnsY =Coalesce(@ColumnsY +',','')+QUOTENAME('Y' +CAST(BOLUMNO AS varchar)) 
							 ,@ColumnsB =Coalesce(@ColumnsB +',','')+QUOTENAME('B' +CAST(BOLUMNO AS varchar)) 
							 ,@ColumnsN =Coalesce(@ColumnsN +',','')+QUOTENAME('N' +CAST(BOLUMNO AS varchar)) 
							 ,@ColumnsYN=Coalesce(@ColumnsYN+',','')+QUOTENAME('YN'+CAST(BOLUMNO AS varchar)) 
							 ,@ColumnsDP=Coalesce(@ColumnsDP+',','')+QUOTENAME('DP'+CAST(BOLUMNO AS varchar)) 
							 ,@ColumnsMAX=Coalesce(@ColumnsMAX+',','')
											 +'ISNULL(CAST(MAX('+'D' +CAST(BOLUMNO AS varchar) +') AS VARCHAR),''-'') AS D' +CAST(BOLUMNO AS varchar) +','
											 +'ISNULL(CAST(MAX('+'Y' +CAST(BOLUMNO AS varchar) +') AS VARCHAR),''-'') AS Y' +CAST(BOLUMNO AS varchar) +','
											 +'ISNULL(CAST(MAX('+'B' +CAST(BOLUMNO AS varchar) +') AS VARCHAR),''-'') AS B' +CAST(BOLUMNO AS varchar) +','
											 +'ISNULL(CAST(MAX('+'N' +CAST(BOLUMNO AS varchar) +') AS VARCHAR),''-'') AS N' +CAST(BOLUMNO AS varchar) +','
											 +'ISNULL(CAST(MAX('+'YN'+CAST(BOLUMNO AS varchar) +') AS VARCHAR),''-'') AS YN'+CAST(BOLUMNO AS varchar) +','
											 +'ISNULL(CAST(MAX('+'DP'+CAST(BOLUMNO AS varchar) +') AS VARCHAR),''-'') AS DP'+CAST(BOLUMNO AS varchar) 
						 from ( Select distinct BOLUMNO from #T2 ) as b order by BOLUMNO
						 Select 
							  @ColumnsPT=Coalesce(@ColumnsPT+',','')+QUOTENAME('PT'+CAST(ID_SINAVPUANTURU AS varchar)) 
							 ,@ColumnsSS=Coalesce(@ColumnsSS+',','')+QUOTENAME('SS'+CAST(ID_SINAVPUANTURU AS varchar)) 
							 ,@ColumnsOS=Coalesce(@ColumnsOS+',','')+QUOTENAME('OS'+CAST(ID_SINAVPUANTURU AS varchar)) 
							 ,@ColumnsCS=Coalesce(@ColumnsCS+',','')+QUOTENAME('CS'+CAST(ID_SINAVPUANTURU AS varchar)) 
							 ,@ColumnsIL=Coalesce(@ColumnsIL+',','')+QUOTENAME('IL'+CAST(ID_SINAVPUANTURU AS varchar)) 
							 ,@ColumnsGS=Coalesce(@ColumnsGS+',','')+QUOTENAME('GS'+CAST(ID_SINAVPUANTURU AS varchar)) 
							 ,@ColumnsPTMAX=Coalesce(@ColumnsPTMAX+',','')
											 +'MAX('+'PT'+CAST(ID_SINAVPUANTURU AS varchar) +') AS PT'+CAST(ID_SINAVPUANTURU AS varchar) +','
											 +'MAX('+'SS'+CAST(ID_SINAVPUANTURU AS varchar) +') AS SS'+CAST(ID_SINAVPUANTURU AS varchar) +','
											 +'MAX('+'OS'+CAST(ID_SINAVPUANTURU AS varchar) +') AS OS'+CAST(ID_SINAVPUANTURU AS varchar) +','
											 +'MAX('+'CS'+CAST(ID_SINAVPUANTURU AS varchar) +') AS CS'+CAST(ID_SINAVPUANTURU AS varchar) +','
											 +'MAX('+'IL'+CAST(ID_SINAVPUANTURU AS varchar) +') AS IL'+CAST(ID_SINAVPUANTURU AS varchar) +','
											 +'MAX('+'GS'+CAST(ID_SINAVPUANTURU AS varchar) +') AS GS'+CAST(ID_SINAVPUANTURU AS varchar) 
						 from ( Select distinct ID_SINAVPUANTURU from #T3 ) as b order by ID_SINAVPUANTURU



				SET @SQL ='
							SELECT   SS.TCKIMLIKNO
									,T1.AD +'' ''+SOYAD ADSOYAD
									,T1.SUBEAD
									,T1.SINIFAD
									,
									'+@ColumnsMAX+'
									,T1.TD
									,T1.TY
									,T1.TB
									,T1.TN
									,T1.YUZDENET AS YN
									,T1.SINIFSIRA
									,T1.OKULSIRA
									,T1.ILCESIRA
									,T1.ILSIRA
									,T1.GENELSIRA
									,T1.BURSTUR
									,T1.BURS_IDSINAVDERS
									,T1.BURS_BOLUMNO
									,T1.BURSORANI		
									,T1.OKULADI		
									,T1.VELI_ADSOYAD	
									,T1.TELEFON_EV		
									,T1.TELEFON_CEP	
									,T1.MAIL
									'
									IF @ColumnsPT IS NOT NULL
										SET @SQL +=',' +@ColumnsPTMAX
									SET @SQL+='
									FROM (
										SELECT TCKIMLIKNO,
											'+@ColumnsMAX+'
										FROM (
											SELECT TCKIMLIKNO,DOGRU,YANLIS,BOS,NET,PUAN,YUZDENET
												,''D''+CAST(BOLUMNO AS VARCHAR) BLMD
												,''Y''+CAST(BOLUMNO AS VARCHAR) BLMY
												,''B''+CAST(BOLUMNO AS VARCHAR) BLMB
												,''N''+CAST(BOLUMNO AS VARCHAR) BLMN
												,''YN''+CAST(BOLUMNO AS VARCHAR) BLMYN
												,''DP''+CAST(BOLUMNO AS VARCHAR) BLMDP
											FROM #T2	)AS T2
											PIVOT (MAX(DOGRU)	FOR BLMD	IN('+@ColumnsD +'))  as P
											PIVOT (MAX(YANLIS)	FOR BLMY	IN('+@ColumnsY +'))  as P
											PIVOT (MAX(BOS)		FOR BLMB	IN('+@ColumnsB +'))  as P
											PIVOT (MAX(NET)		FOR BLMN	IN('+@ColumnsN +'))  as P
											PIVOT (MAX(YUZDENET)FOR BLMYN	IN('+@ColumnsYN+'))  as P
											PIVOT (MAX(PUAN)	FOR BLMDP	IN('+@ColumnsDP+'))  as P
											GROUP BY TCKIMLIKNO
											) AS SS 
											JOIN #T1 T1 ON T1.TCKIMLIKNO = SS.TCKIMLIKNO
											'
											IF @ColumnsPT IS NOT NULL
												SET @SQL +='  
												JOIN ( 
													SELECT TCKIMLIKNO,'+@ColumnsPTMAX+' FROM (
														SELECT *
															,''PT''+CAST(ID_SINAVPUANTURU AS varchar) PT
															,''SS''+CAST(ID_SINAVPUANTURU AS varchar) SS
															,''OS''+CAST(ID_SINAVPUANTURU AS varchar) OS
															,''CS''+CAST(ID_SINAVPUANTURU AS varchar) CS
															,''IL''+CAST(ID_SINAVPUANTURU AS varchar) IL
															,''GS''+CAST(ID_SINAVPUANTURU AS varchar) GS
														FROM #T3) AS T3
														PIVOT (MAX(PUAN)		FOR PT IN('+@ColumnsPT+')) as P
														PIVOT (MAX(SINIFSIRA)	FOR SS IN('+@ColumnsSS+')) as P
														PIVOT (MAX(OKULSIRA)	FOR OS IN('+@ColumnsOS+')) as P
														PIVOT (MAX(ILCESIRA)	FOR CS IN('+@ColumnsCS+')) as P
														PIVOT (MAX(ILSIRA)		FOR IL IN('+@ColumnsIL+')) as P
														PIVOT (MAX(GENELSIRA)	FOR GS IN('+@ColumnsGS+')) as P		
														GROUP BY TCKIMLIKNO													
													) AS S ON S.TCKIMLIKNO= SS.TCKIMLIKNO'
											SET @SQL +=
													'	
													WHERE	(	T1.ID_SUBE	IN (select value from openjson ('''+@ID_SUBES+'''))		OR	(T1.ID_SUBE IN (SELECT ID_SUBE FROM v3SubeYetki WHERE TCKIMLIKNO='''+@TCKIMLIKNO+''') and (0 IN (select value from openjson ('''+@ID_SUBES+''')))))
														AND (	T1.ID_SINIF	IN (select value from openjson ('''+@ID_SINIFS+'''))	OR	(0 IN (select value from openjson ('''+@ID_SINIFS+'''))) OR '''+@ID_SINIFS+'''=''[]'')		
													GROUP BY SS.TCKIMLIKNO
															,T1.TD
															,T1.TY
															,T1.TB
															,T1.TN
															,T1.SINIFSIRA
															,T1.OKULSIRA
															,T1.ILCESIRA
															,T1.ILSIRA
															,T1.GENELSIRA
															,T1.AD
															,T1.SOYAD
															,T1.SUBEAD
															,T1.SINIFAD
															,T1.YUZDENET															
															,T1.BURSTUR
															,T1.BURS_IDSINAVDERS
															,T1.BURS_BOLUMNO
															,T1.BURSORANI		
															,T1.OKULADI		
															,T1.VELI_ADSOYAD	
															,T1.TELEFON_EV		
															,T1.TELEFON_CEP	
															,T1.MAIL
												ORDER BY TCKIMLIKNO
							'
				PRINT @SQL
				EXEC (@SQL)

			end 

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #BOLUMSIRALA
			DROP TABLE IF EXISTS #OGRENCILIST
			DROP TABLE IF EXISTS #ALINANBURS
			DROP TABLE IF EXISTS #BURSOGRENCI
			DROP TABLE IF EXISTS #OGRENCIBURS
			DROP TABLE IF EXISTS #BurslulukSinavOgrenci


		END

	END

	END TRY
			BEGIN CATCH
				SELECT 
					@ErrorSeverity	= ERROR_SEVERITY(),
					@ErrorState		= ERROR_STATE()
							
				SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
				RAISERROR (@MSG , -- Message text.
							@ErrorSeverity, -- Severity.
							@ErrorState -- State.
							);
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_KonuAnalizi]...';


GO
ALTER procedure [dbo].[sp_KonuAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	--@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@LIMIT				INT				= 100,
	@ID_SINAVS			NVARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END
	--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
	IF @return_variable = 1
	BEGIN
		
		IF @ISLEM = 1	--	KONU ANALİZİ
		BEGIN
		
			--exec sp_KonuAnalizi @ISLEM=1, @TCKIMLIKNO='34454003058',@OTURUM='AF6EC483-F078-4F55-AAAD-A4FFD02604D4',@TC_OGRENCI='34454003058',@DONEM= '', @ID_MENU= 1031,@ID_SINAVS='[]'

			--SET @TCKIMLIKNO='53500095298'
			SELECT @ID_SINIF=ID_SINIF,@ID_SUBE=ID_SUBE FROM v3Ogrenci WHERE TCKIMLIKNO =@TC_OGRENCI		
			SELECT @IL=IL,@ILCE=ILCE FROM V3SUBE WHERE ID_SUBE=@ID_SUBE

			IF OBJECT_ID('tempdb..#PUAN')		IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#KONU')		IS NOT NULL		DROP TABLE #KONU
			IF OBJECT_ID('tempdb..#KONUANALIZ')	IS NOT NULL		DROP TABLE #KONUANALIZ
			IF OBJECT_ID('tempdb..#TT')			IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#TT1')		IS NOT NULL		DROP TABLE #TT1
			IF OBJECT_ID('tempdb..#KK')			IS NOT NULL		DROP TABLE #KK
			IF OBJECT_ID('tempdb..#T1')			IS NOT NULL		DROP TABLE #T1
			IF OBJECT_ID('tempdb..#T2')			IS NOT NULL		DROP TABLE #T2
			IF OBJECT_ID('tempdb..#T3')			IS NOT NULL		DROP TABLE #T3
			IF OBJECT_ID('tempdb..#T4')			IS NOT NULL		DROP TABLE #T4
			IF OBJECT_ID('tempdb..#T5')			IS NOT NULL		DROP TABLE #T5
			
			SELECT	
					count(1) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
					o.ID_SINAV
			into #KONU
			from SinavOgrenci		o
			JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
			JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
			JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
			JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
											AND	K.AD						= o.KITAPCIK
			JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
											AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
											AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
			JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
			JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
			WHERE	o.TCKIMLIKNO=@TC_OGRENCI 
				AND ( @DONEM='' OR @DONEM=0 OR @DONEM=s.DONEM )
				AND ( @ID_SINAVTURU is null OR @ID_SINAVTURU=0 OR @ID_SINAVTURU=s.ID_SINAVTURU )
				AND (	@ID_SINAVS='[]' OR
						O.ID_SINAV IN (SELECT value FROM OPENJSON  ( @ID_SINAVS)))
				AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				
			GROUP BY c.DURUM,d.TAKMAAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK
			ORDER BY d.TAKMAAD

			
			--(SELECT Value FROM dbo.fn_Split(@ID_MENUS, ',', null))


			--INTO #TT
				SELECT DISTINCT
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TT1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
				
				SELECT 
					KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TT
				FROM #TT1
						UNION ALL 
				SELECT 
					DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TT1
				GROUP BY DERSAD,ID_SINAV
				--order by ID_SINAV,DERSAD,TOPLAMSORU,KOD



			SELECT	KONUAD,
				DERSAD,
				KOD,
				CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
				SUM(DOGRU+YANLIS+BOS) SORU,
				SUM(DOGRU) DOGRU,
				SUM(YANLIS) YANLIS,
				SUM(BOS) BOS,
				--CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
				CAST((cast(SUM(DOGRU) as decimal(11,2))/cast(SUM(DOGRU+YANLIS+BOS) as decimal(11,2))) * 100 as DECIMAL(11,2)) YUZDE,
				TIP
			INTO	#KONUANALIZ
			FROM	#TT
			GROUP BY KOD,KONUAD,DERSAD,TIP


			SELECT	*
					,SUM(SORU) TOPLAMSORU 
					,SUM(DOGRU) TOPLAMDOGRU
					,SUM(YANLIS) TOPLAMYANLIS
					,SUM(BOS) TOPLAMBOS
					--,CAST(AVG(YUZDE)AS decimal(5,2)) TOPLAMYUZDE
					,CAST((cast(SUM(DOGRU) as decimal(11,2))/cast(SUM(DOGRU+YANLIS+BOS) as decimal(11,2))) * 100 as DECIMAL(11,2)) TOPLAMYUZDE
					,CAST(SUM(DOGRU) *100 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) DOGRUYUZDE
					,CAST(SUM(YANLIS) *100 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) YANLISYUZDE
					,CAST(SUM(BOS) *100 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) BOSYUZDE
			INTO	#T1
			FROM	#KONUANALIZ
			GROUP BY KONUAD,DERSAD,KOD,BOLUMYUZDE,SORU,DOGRU,YANLIS,BOS,YUZDE,TIP
			
			

			--JSON SEND
			select(
				select * from(
					select 
					(						 
						SELECT * FROM #T1
						where (YUZDE<(@LIMIT+1) and KOD<>'') or KOD=''
						ORDER BY DERSAD,TIP, YUZDE desc--,KOD
						FOR JSON AUTO
					) as t1					
				) as tablo FOR JSON AUTO
			) as tt
			 
	
--	exec sp_KonuAnalizi @ISLEM=1, @TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@TC_OGRENCI='53500095298',@DONEM= 2017, @ID_MENU= 1031,@ID_SINAVS='[49,43]',@LIMIT=60	
			--select * from #T1
			--			where (YUZDE<@LIMIT and KOD<>'') or KOD=''
			--			ORDER BY DERSAD,KOD
			 
			
			IF OBJECT_ID('tempdb..#PUAN')		IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#KONU')		IS NOT NULL		DROP TABLE #KONU
			IF OBJECT_ID('tempdb..#KONUANALIZ')	IS NOT NULL		DROP TABLE #KONUANALIZ
			IF OBJECT_ID('tempdb..#TT')			IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#TT1')		IS NOT NULL		DROP TABLE #TT1
			IF OBJECT_ID('tempdb..#KK')			IS NOT NULL		DROP TABLE #KK
			IF OBJECT_ID('tempdb..#T1')			IS NOT NULL		DROP TABLE #T1
			IF OBJECT_ID('tempdb..#T2')			IS NOT NULL		DROP TABLE #T2
			IF OBJECT_ID('tempdb..#T3')			IS NOT NULL		DROP TABLE #T3
			IF OBJECT_ID('tempdb..#T4')			IS NOT NULL		DROP TABLE #T4
			IF OBJECT_ID('tempdb..#T5')			IS NOT NULL		DROP TABLE #T5


		END
	END

	END TRY
			BEGIN CATCH
				SELECT 
					@ErrorSeverity	= ERROR_SEVERITY(),
					@ErrorState		= ERROR_STATE()
							
				SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
				RAISERROR (@MSG , -- Message text.
							@ErrorSeverity, -- Severity.
							@ErrorState -- State.
							);
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_HedefBelirlemeRapor]...';


GO
ALTER procedure [dbo].[sp_HedefBelirlemeRapor]
	@ISLEM				INT				= NULL,
	@ID_MENU			INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_KADEME3			INT				= NULL,

	@ID_SUBEs			NVARCHAR(MAX)	= NULL,
	@ID_SINIFs			NVARCHAR(MAX)	= NULL,
	@DONEM				NVARCHAR(4)		= NULL,
	@HEDEF				BIT				= NULL,

	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU
	
	IF @return_variable = 1
	BEGIN
		IF @ISLEM = 1	
		BEGIN

			SELECT O.TCKIMLIKNO
				,SINIFAD	= GS.SINIF
				,SUBEAD		= GS.SUBEAD
				,KADEME3
				,ADSOYAD	= K.AD+' '+K.SOYAD
				,O.DONEM
			INTO #OGRENCILIST
			FROM v3OgrenciTum				O	WITH (NOLOCK)	
			JOIN v3Kullanici				K	WITH (NOLOCK)		ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN vw_SubeSinifGrupKademeTum	GS	WITH (NOLOCK)		ON	GS.ID_SINIF		= O.ID_SINIF
			WHERE	GS.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)) 

			SELECT	SIRA = ROW_NUMBER() OVER( ORDER BY SUBEAD, KADEME3, SINIFAD, ADSOYAD) , O.TCKIMLIKNO, O.ADSOYAD, O.KADEME3, O.SINIFAD, O.SUBEAD, 
					(
						SELECT COUNT(1) 
						FROM OgrenciHedef OH 			WITH (NOLOCK)	
						JOIN UniversiteTabanPuanlari TP	WITH (NOLOCK)	 ON TP.PROGRAMKODU = OH.PROGRAMKODU AND TP.YIL = O.DONEM
						WHERE OH.AKTIF = 1 AND OH.TCKIMLIKNO = O.TCKIMLIKNO AND OH.DONEM = O.DONEM
					) AS TERCIHSAYISI
			FROM #OGRENCILIST O
			GROUP BY O.TCKIMLIKNO, O.ADSOYAD, O.KADEME3, O.SINIFAD, O.SUBEAD, O.DONEM
			ORDER BY SIRA
				
			
			--CREATE TABLE #OGRENCIHEDEF ( TCKIMLIKNO VARCHAR(11)
			--							,SUBEAD		VARCHAR(50)
			--							,SINIFAD	VARCHAR(50)
			--							,KADEME3	VARCHAR(50)
			--							,ADSOYAD	VARCHAR(90)
			--							,TERCIHSAYISI INT)


			--IF @HEDEF = 1	--	HEDEF BELİRLEYENLER
			--BEGIN
				
			--	INSERT INTO #OGRENCIHEDEF (TCKIMLIKNO, SUBEAD, SINIFAD, KADEME3, ADSOYAD)
			--	SELECT DISTINCT OL.TCKIMLIKNO, OL.SUBEAD, OL.SINIFAD, KADEME3, ADSOYAD
			--	FROM OgrenciHedef	OH 
			--	JOIN #OGRENCILIST	OL	ON	OL.TCKIMLIKNO	= OH.TCKIMLIKNO
			--						--	AND OL.DONEM		= OH.DONEM  
			--	WHERE OH.AKTIF = 1

			--END
			--ELSE			--	HEDEF BELİRLEMEYENLER
			--BEGIN
				
			--	INSERT INTO #OGRENCIHEDEF (TCKIMLIKNO, SUBEAD, SINIFAD, KADEME3, ADSOYAD)
			--	SELECT DISTINCT OL.TCKIMLIKNO, OL.SUBEAD, OL.SINIFAD, KADEME3, ADSOYAD
			--	FROM #OGRENCILIST OL
			--	WHERE OL.TCKIMLIKNO NOT IN (
			--		SELECT O.TCKIMLIKNO
			--		FROM OgrenciHedef		OH
			--		JOIN v3OgrenciTum		O	ON	O.TCKIMLIKNO	= OH.TCKIMLIKNO		
			--									AND O.DONEM			= OH.DONEM  
			--								--	AND OH.DONEM		= OL.DONEM
			--		WHERE OH.AKTIF = 1
			--	)
			--END

			--SELECT	TCKIMLIKNO, 
			--		SUBEAD, 
			--		SINIFAD, 
			--		KADEME3, 
			--		ADSOYAD, 
			--		SIRA = ROW_NUMBER() OVER( ORDER BY SUBEAD, KADEME3, SINIFAD, ADSOYAD) 
			--FROM #OGRENCIHEDEF

				
			DROP TABLE #OGRENCILIST
			--DROP TABLE #OGRENCIHEDEF
			
		END

		IF @ISLEM = 2 -- DETAYLI	
		BEGIN

			SELECT O.TCKIMLIKNO
				,SINIFAD	= GS.SINIF
				,SUBEAD		= GS.SUBEAD
				,KADEME3
				,ADSOYAD	= K.AD+' '+K.SOYAD
				,O.DONEM
			INTO #OGRENCILIST2
			FROM v3OgrenciTum				O	WITH (NOLOCK)	
			JOIN v3Kullanici				K	WITH (NOLOCK)	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN vw_SubeSinifGrupKademeTum	GS	WITH (NOLOCK)	ON	GS.ID_SINIF		= O.ID_SINIF
			WHERE	GS.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)) 

			SELECT	SIRA = ROW_NUMBER() OVER( ORDER BY SUBEAD, KADEME3, SINIFAD, ADSOYAD, IL, UNIVERSITE, FAKULTE, BOLUM)
					, O.TCKIMLIKNO, O.ADSOYAD, O.KADEME3, O.SINIFAD, O.SUBEAD
					,TP.IL
					,TP.UNIVERSITE
					,TP.FAKULTE
					,TP.BOLUM2 AS BOLUM
			FROM #OGRENCILIST2 O
			JOIN OgrenciHedef OH WITH (NOLOCK) ON	OH.TCKIMLIKNO = O.TCKIMLIKNO AND OH.AKTIF = 1 AND OH.DONEM = O.DONEM
			JOIN UniversiteTabanPuanlari TP WITH (NOLOCK)	ON TP.PROGRAMKODU = OH.PROGRAMKODU AND TP.YIL = O.DONEM
			ORDER BY SIRA

			DROP TABLE #OGRENCILIST2
		END
	
	END

END TRY
		BEGIN CATCH
			SELECT 
				@ErrorSeverity	= ERROR_SEVERITY(),
				@ErrorState		= ERROR_STATE()
							
			SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
			RAISERROR (@MSG , -- Message text.
						@ErrorSeverity, -- Severity.
						@ErrorState -- State.
						);
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Menu]...';


GO
ALTER procedure [dbo].[sp_Menu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUYARDIM		INT				= 1,
	@ID_MENU			INT				= 1,
	@ID_KADEME			INT				= NULL,
	@ID_KULLANICITIPI	INT				= NULL	
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_YETKI					= @TC_YETKI		
			,OTURUM						= @OTURUM			
			,ID_MENUYARDIM				= @ID_MENUYARDIM	
			,ID_MENU					= @ID_MENU		
			,ID_KADEME					= @ID_KADEME		
			,ID_KULLANICITIPI			= @ID_KULLANICITIPI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY   
	DECLARE @TCKIMLIKNOTEMP VARCHAR(11) = @TCKIMLIKNO
	--EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNOTEMP, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 DECLARE @return_variable INT
	EXEC @return_variable = [dbo].[sp_OturumKontrol] @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU

	IF @return_variable = 1
	BEGIN
	
		SELECT DISTINCT ID_KADEME INTO #KADEMELER FROM OkyanusDB.dbo.v4KullaniciKademe WHERE TCKIMLIKNO = @TCKIMLIKNOTEMP
		IF @ISLEM = 1	--	Menü Getir
		BEGIN	
			IF dbo.fn_GenelHak(@TCKIMLIKNOTEMP)>0
			BEGIN
					SELECT DISTINCT M.ID_MENU, M.AD, M.KOD, M.URL, M.RESIM
					FROM Menu							M
					where M.GIZLI = 0					
						 AND (		(@TCKIMLIKNOTEMP = '62362359264' AND ID_MENU IN (1099,1193,1200,1335,1344))
								OR	@TCKIMLIKNOTEMP != '62362359264')				
				UNION 				
					SELECT -1, 'Bağlantılar', '000', '', 'icon-directions'
					WHERE EXISTS (	SELECT * 
									FROM OzelSayfa		OS
									JOIN OzelSayfaYetki	Y	ON	Y.ID_OZELSAYFA = OS.ID_OZELSAYFA
									WHERE	AKTIF				= 1
										AND Y.ID_KULLANICITIPI	= 1) --	ADMİN
				UNION				
					SELECT	  -1
							, OS.AD
							, CASE WHEN OS.ID_OZELSAYFA		> 999	THEN '000999'		ELSE  RIGHT( '000000' + CAST(OS.ID_OZELSAYFA AS varchar),6) END
							, OS.YOL							
							, CASE WHEN OS.ID_OZELSAYFATURU	= 1		THEN 'icon-globe'	ELSE 'icon-doc' END
					FROM OzelSayfa		OS
					JOIN OzelSayfaYetki	Y	ON	Y.ID_OZELSAYFA = OS.ID_OZELSAYFA				
					WHERE	AKTIF				= 1
						AND Y.ID_KULLANICITIPI	= 1	--	ADMİN
				ORDER BY M.KOD

			END
			ELSE
			BEGIN	
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNOTEMP)
			BEGIN
				SELECT DISTINCT
					ID_MENU,
					AD,
					KOD,
					URL,
					RESIM
				FROM MENU
				WHERE ID_MENU IN(1050, 1333, 1381)
			END
			ELSE
			BEGIN						
				SELECT DISTINCT ID_KULLANICITIPI 
				INTO #v3SubeYetki FROM v3SubeYetki
				WHERE TCKIMLIKNO = @TCKIMLIKNOTEMP
				
				SELECT	DISTINCT
					 M.ID_MENU
					,M.AD
					,M.KOD
					--,M.URL					
					,URL	= CASE WHEN LEFT(M.URL, 7) = 'Dinamik' THEN eokul_v2.dbo.Fn_DinamikUrl(M.URL, @TCKIMLIKNOTEMP) ELSE M.URL END
					,M.RESIM
				INTO #MenuListe FROM Menu		M
				INNER JOIN MenuYetki			Y	ON Y.ID_MENU			= M.ID_MENU  
				INNER JOIN #v3SubeYetki			S	ON S.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
				INNER JOIN #KADEMELER			K	ON K.ID_KADEME			= Y.ID_KADEME
				WHERE M.GIZLI = 0
			UNION								
				SELECT
					 M.ID_MENU
					,M.AD
					,M.KOD
					,M.URL
					,M.RESIM
				FROM Menu							M
				INNER  JOIN MenuKullaniciYetki		KY			ON M.ID_MENU		= KY.ID_MENU	
				WHERE KY.TCKIMLIKNO = @TCKIMLIKNOTEMP	AND M.GIZLI = 0
								
				UNION 

				SELECT -1, 'Bağlantılar', '000', '', 'icon-directions'
				WHERE EXISTS (	SELECT * 
								FROM OzelSayfa							OS
								JOIN OzelSayfaYetki						Y	ON	Y.ID_OZELSAYFA		= OS.ID_OZELSAYFA
								JOIN #KADEMELER							K	ON	K.ID_KADEME			= Y.ID_KADEME
								JOIN #v3SubeYetki						SY	ON	SY.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI 
								JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.TCKIMLIKNO		= @TCKIMLIKNOTEMP
																			AND KY.ID_KADEME3		= Y.ID_KADEME3
								WHERE AKTIF = 1)				
			UNION
				SELECT	-1
						, OS.AD
						, CASE WHEN OS.ID_OZELSAYFA > 999 THEN '000999' ELSE  RIGHT( '000000' + CAST(OS.ID_OZELSAYFA AS varchar),6) END
						, OS.YOL
						, CASE WHEN OS.ID_OZELSAYFATURU	= 1 THEN 'icon-globe' ELSE 'icon-doc' END
				FROM OzelSayfa							OS
				JOIN OzelSayfaYetki						Y	ON	Y.ID_OZELSAYFA		= OS.ID_OZELSAYFA
				JOIN #KADEMELER							K	ON	K.ID_KADEME			= Y.ID_KADEME
				JOIN #v3SubeYetki						SY	ON	SY.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI 
				JOIN OkyanusDB.dbo.vw_KullaniciYetki	KY	ON	KY.TCKIMLIKNO		= @TCKIMLIKNOTEMP
															AND KY.ID_KADEME3		= Y.ID_KADEME3
				WHERE OS.AKTIF = 1
			UNION	-- CORPUS STUDIO
				SELECT TOP 1
					ID_MENU				= -1,
					AD					= 'Corpus.Study',
					KOD					= '-00',
					URL					= '',
					RESIM				= 'icon-list'

				FROM Pusulam.dbo.CurpusStudy
				WHERE TCKIMLIKNO =  @TCKIMLIKNOTEMP

				UNION
				SELECT
					ID_MENU				= -1,
					AD					= 'Corpus.Study',
					KOD					= '-00001',
					URL					= 'https://okyanus.corpus.study/okul-kontrol.php?token='+TOKEN,
					RESIM				= 'icon-list'

				FROM Pusulam.dbo.CurpusStudy
				WHERE TCKIMLIKNO =  @TCKIMLIKNOTEMP AND YONETIM = 0
			UNION	-- CORPUS STUDIO YÖNETİM
				SELECT
					ID_MENU				= -1,
					AD					= 'Corpus.Study Yönetim',
					KOD					= '-00002',
					URL					= 'https://okyanus.corpus.study/yonetim/ogrt-kontrol.php?token='+TOKEN,
					RESIM				= 'icon-list'
				FROM Pusulam.dbo.CurpusStudy
				WHERE TCKIMLIKNO =  @TCKIMLIKNOTEMP AND YONETIM = 1
			UNION	-- RehberlikOnline
				SELECT TOP 1
					ID_MENU				= -1,
					AD					= 'Rehberlik Online',
					KOD					= '-01',
					URL					= '',
					RESIM				= 'icon-list'

				FROM Pusulam.dbo.RehberlikOnlineLink
				WHERE TCKIMLIKNO =  @TCKIMLIKNOTEMP
			UNION
				SELECT
					ID_MENU				= -1,
					AD					= TESTADI,
					KOD					= '-01' + RIGHT('000'+ CAST(ROW_NUMBER() OVER(ORDER BY TESTADI) AS varchar) ,3 ) ,
					URL					= LINK,
					RESIM				= 'icon-globe'

				FROM Pusulam.dbo.RehberlikOnlineLink
				WHERE TCKIMLIKNO =  @TCKIMLIKNOTEMP
			ORDER BY M.KOD



				--UPDATE #MenuListe SET URL = '#Ogrenci/Hedefler/MevcutDurum'
				--WHERE 
				--	ID_MENU = 1 
				--AND EXISTS(SELECT ID_KADEME			FROM #KADEMELER			WHERE ID_KADEME			= 5)
				--AND EXISTS(SELECT ID_KULLANICITIPI	FROM #v3SubeYetki		WHERE ID_KULLANICITIPI	= 4)
				--
				--UPDATE #MenuListe SET URL = '#Ogrenci/Hedefler/MevcutDurumOO'
				--WHERE 
				--		ID_MENU = 1 
				--	AND EXISTS(SELECT ID_KADEME			FROM #KADEMELER			WHERE ID_KADEME			= 4)
				--	AND EXISTS(SELECT ID_KULLANICITIPI	FROM #v3SubeYetki		WHERE ID_KULLANICITIPI	= 4)

				IF @TCKIMLIKNOTEMP = '98765432101'	--	GARANTİ BBVA
				BEGIN

					SELECT	DISTINCT
						 M.ID_MENU
						,M.AD
						,M.KOD
						,M.URL
						,M.RESIM
					FROM Menu		M
					WHERE M.ID_MENU = 1316
					
				END 
				ELSE
				BEGIN
					SELECT * FROM #MenuListe
					ORDER BY KOD
				END
				END
				DROP TABLE #v3SubeYetki
				DROP TABLE #MenuListe
			END
		END
		
		IF @ISLEM = 2	--	Menü Getir YETKİ SAYFASI
		BEGIN
			SELECT 
					M.ID_MENU,
					replicate('-', LEN(KOD)-3)+AD AD,
					YETKILI = (SELECT COUNT(1) FROM MenuYetki Y WHERE Y.ID_KULLANICITIPI=@ID_KULLANICITIPI AND Y.ID_MENU=M.ID_MENU AND Y.ID_KADEME = @ID_KADEME)
			FROM Menu		M
			WHERE GIZLI = 0 AND (OZEL = 0 /*OR dbo.fn_GenelHak(@TCKIMLIKNO)>0*/)
			ORDER BY KOD 
		END
		
		
		IF @ISLEM = 3	--	Kullanıcı Menü Getir YETKİ SAYFASI
		BEGIN
			SELECT 
					M.ID_MENU,
					replicate('-', LEN(KOD)-3)+AD AD,
					YETKILI = (SELECT COUNT(1) FROM MenuKullaniciYetki Y WHERE Y.TCKIMLIKNO=@TC_YETKI AND Y.ID_MENU=M.ID_MENU)
			FROM Menu		M
			WHERE GIZLI = 0 AND (OZEL = 0 OR dbo.fn_GenelHak(@TCKIMLIKNOTEMP)>0)
			ORDER BY KOD 
		END
		
		
		IF @ISLEM = 4	--	Menü Yardım Getir
		BEGIN
			SELECT 
					YARDIMHTML
			FROM Menu		M
			WHERE ID_MENU=@ID_MENUYARDIM
		END

		DROP TABLE IF EXISTS #KADEMELER
	END

END TRY
		BEGIN CATCH
			
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OturumKontrolMenuYetkiLog]...';


GO
ALTER procedure [dbo].[sp_OturumKontrolMenuYetkiLog]
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(200)	= NULL,
	@ID_MENU			INT				= NULL,
	@LOGJSON			VARCHAR(MAX)	= NULL,
	@ISLEM				INT				= NULL,
	@PROSEDURADI		VARCHAR(200)	= NULL	
AS
BEGIN
	BEGIN TRY  
		DECLARE @ID_LOGTABLE TABLE (ID_LOG INT) 
		DECLARE @ID_LOG INT
		
		INSERT INTO [dbo].[Log]
				   ([TCKIMLIKNO]
				   ,[OTURUM]
				   ,[ID_MENU]
				   ,[PROSEDURADI]
				   ,[ISLEM]
				   ,[PARAMETRELER])
		OUTPUT INSERTED.ID_LOG
        INTO @ID_LOGTABLE
		VALUES(@TCKIMLIKNO, @OTURUM, @ID_MENU, @PROSEDURADI, @ISLEM, @LOGJSON)

		SELECT @ID_LOG = MAX(ID_LOG) FROM @ID_LOGTABLE

		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;
		DECLARE @MSG VARCHAR(4000)				
			
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()

		IF EXISTS (SELECT TOP 1 1 FROM DisIslem WHERE PROSEDURADI = @PROSEDURADI AND ISLEM = @ISLEM)
		BEGIN
			RETURN @ID_LOG
		END
		ELSE
		BEGIN
			IF	(	(SELECT COUNT(TCKIMLIKNO) FROM OkyanusDB.[dbo].[v3Kullanici] WHERE TCKIMLIKNO = @TCKIMLIKNO AND AKTIF = 1 and LOWER([OTURUM]) = LOWER(@OTURUM))   > 0
				OR	(SELECT COUNT(1) FROM OkyanusIletisim.dbo.LoginLog WHERE KYE_TCKIMLIKNO = @TCKIMLIKNO AND OTURUM = @OTURUM AND LOGOUT = 0) > 0)
			AND (EXISTS(	SELECT TOP 1 1
							FROM Menu											M
							INNER JOIN MenuYetki								Y	ON	Y.ID_MENU			= M.ID_MENU
							INNER JOIN OkyanusDB.DBO.v4KullaniciSubeTurKademe	KT	ON	KT.ID_KULLANICITIPI	= Y.ID_KULLANICITIPI
							INNER JOIN OkyanusDB.dbo.v3KademeBilgi				KB	ON	KB.ID_KADEME		= Y.ID_KADEME 
																					AND KB.ID_KADEME3		= KT.ID_KADEME
							INNER JOIN OkyanusDB.dbo.v3Kullanici				K	ON	K.TCKIMLIKNO		= KT.TCKIMLIKNO 
																					AND K.AKTIF				= 1
							WHERE	KT.TCKIMLIKNO	= @TCKIMLIKNO	
								AND	M.GIZLI			= 0
						UNION
							SELECT TOP 1 1
							FROM Menu								M
							INNER  JOIN MenuKullaniciYetki			KY	ON	M.ID_MENU		= KY.ID_MENU	
							INNER  JOIN v3SubeYetki					SY	ON	SY.TCKIMLIKNO	= @TCKIMLIKNO
							INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= SY.TCKIMLIKNO 
																		AND K.AKTIF			= 1
							WHERE KY.TCKIMLIKNO	= @TCKIMLIKNO	
								AND M.GIZLI		= 0 /*AND M.ID_MENU = @ID_MENU*/
						) 
					OR  dbo.fn_GenelHak(@TCKIMLIKNO) = 1 
					OR EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO )			

				)
			BEGIN
				RETURN @ID_LOG
			END
			ELSE
			BEGIN				
				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Oturum Sonlandırıldı!', @SEVERITY = 16, @STATE = 1, @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
			END		
		END				
	END TRY
	BEGIN CATCH
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
			
		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Oturum Sonlandırıldı!', @SEVERITY = @ErrorSeverity, @STATE = @ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_ZumreCalisma]...';


GO
ALTER procedure [dbo].[sp_ZumreCalisma]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,

	@SQLJSON					VARCHAR(MAX)	= NULL,
	@ID_ZUMRECALISMA			INT				= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@ID_SUBE					INT				= NULL,
	@ID_ZUMRECALISMAKATILIMCI	INT				= NULL,

	@ID_KULLANICITIPILIST		VARCHAR(MAX)	= NULL,
	@BRANSLIST					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@TCKIMLIKNO_KULLANICI		VARCHAR(11)		= NULL,
	@ONAY						BIT				= NULL,
	@DURUM						INT				= NULL,
	@BROWSER					VARCHAR(MAX)	= NULL,
	@IP							VARCHAR(MAX)	= NULL
AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU
											
				,SQLJSON					= @SQLJSON
				,ID_ZUMRECALISMA			= @ID_ZUMRECALISMA
				,DONEM						= @DONEM
				,ID_SUBE					= @ID_SUBE
				,ID_ZUMRECALISMAKATILIMCI	= @ID_ZUMRECALISMAKATILIMCI
				,ID_KULLANICITIPILIST		= @ID_KULLANICITIPILIST
				,BRANSLIST					= @BRANSLIST
				,ID_SUBELIST				= @ID_SUBELIST
				,TCKIMLIKNO_KULLANICI		= @TCKIMLIKNO_KULLANICI
				,ONAY						= @ONAY
				,DURUM						= @DURUM
				,IP							= @IP
				,YOKLAMABROWSER				= @BROWSER
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @ID_LOG > 0
		BEGIN			
			DECLARE @ORDERCOL INT,
					@ORDERDIR VARCHAR(4),
					@orderByClause VARCHAR(MAX),
					@whereClause VARCHAR(MAX),
					@displayStart INT,
					@displayLength INT,
					@query varchar(MAX),
					@COLUMNS VARCHAR(max) = ''

			IF @ISLEM IN (2, 3, 6, /*8,*/ 13, 14, 15)
			BEGIN
				DECLARE @ID_ZUMRECALISMATEMP INT

				IF @ID_ZUMRECALISMA IS NULL 
				BEGIN
					SELECT @ID_ZUMRECALISMATEMP = ID_ZUMRECALISMA FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE 
				BEGIN
					SET @ID_ZUMRECALISMATEMP = @ID_ZUMRECALISMA
				END

				IF NOT EXISTS (SELECT TOP 1 1 FROM ZumreCalisma ZC WHERE ZC.ID_ZUMRECALISMA = @ID_ZUMRECALISMATEMP AND CAST(CAST(TARIH AS varchar(MAX)) + ' ' + CAST(SAAT AS varchar(MAX)) AS datetime2) > GETDATE())				
				BEGIN   /*, atama, */ 
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Zümre çalışma başladıktan sonra düzenleme, silme, onaylama gibi işlemler yapılamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 1	--	EKLE
			BEGIN	
				IF NOT EXISTS (SELECT TOP 1 1  FROM OPENJSON(@SQLJSON) WITH (DONEM VARCHAR(4), ID_SUBE INT, TARIH VARCHAR(MAX), SAAT VARCHAR(MAX)) J JOIN [dbo].[ZumreCalisma] ZC ON ZC.DONEM = J.DONEM AND ZC.ID_SUBE = J.ID_SUBE AND ZC.TARIH = J.TARIH AND ZC.SAAT = J.SAAT)
				BEGIN
					INSERT INTO [dbo].[ZumreCalisma] ([DONEM],[AD],[EGITIMCI],[ID_SUBE],[MEKAN],[TARIH],[SAAT],[KOTA],[ONAY],[YAZILILINK],[DETAY],[KYE_KULLANICI])
					SELECT [DONEM],[AD],[EGITIMCI],[ID_SUBE],[MEKAN],[TARIH],[SAAT],[KOTA],[ONAY],[YAZILILINK],[DETAY],@TCKIMLIKNO
					FROM OPENJSON(@SQLJSON)
					WITH (
						DONEM VARCHAR(4),
						AD VARCHAR(MAX),
						EGITIMCI VARCHAR(MAX),
						ID_SUBE INT,
						MEKAN VARCHAR(MAX),
						TARIH VARCHAR(MAX),
						SAAT VARCHAR(MAX),
						KOTA INT,
						ONAY BIT,
						YAZILILINK VARCHAR(MAX),
						DETAY VARCHAR(MAX)
					)
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Bir şubede aynı gün ve saatte birden fazla zümre çalışması yapılamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 2	--	GÜNCELLE
			BEGIN	
				IF NOT EXISTS (SELECT TOP 1 1  FROM OPENJSON(@SQLJSON) WITH (ID_ZUMRECALISMA INT, DONEM VARCHAR(4), ID_SUBE INT, TARIH VARCHAR(MAX), SAAT VARCHAR(MAX)) J JOIN [dbo].[ZumreCalisma] ZC ON ZC.ID_ZUMRECALISMA <> J.ID_ZUMRECALISMA AND ZC.DONEM = J.DONEM AND ZC.ID_SUBE = J.ID_SUBE AND ZC.TARIH = J.TARIH AND ZC.SAAT = J.SAAT AND ZC.AKTIF = 1)
				BEGIN
					IF (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1) <= (SELECT KOTA FROM OPENJSON(@SQLJSON) WITH (KOTA INT))
					BEGIN
						UPDATE ZC SET	 ZC.[DONEM]			= J.[DONEM]
										,ZC.[AD]			= J.[AD]
										,ZC.[EGITIMCI]		= J.[EGITIMCI]
										,ZC.[ID_SUBE]		= J.[ID_SUBE]
										,ZC.[MEKAN]			= J.[MEKAN]
										,ZC.[TARIH]			= J.[TARIH]
										,ZC.[SAAT]			= J.[SAAT]
										,ZC.[KOTA]			= J.[KOTA]
										,ZC.[ONAY]			= J.[ONAY]
										,ZC.[YAZILILINK]	= J.[YAZILILINK]
										,ZC.[DETAY]			= J.[DETAY]
										,ZC.[KYE_KULLANICI] = @TCKIMLIKNO
						FROM [dbo].[ZumreCalisma] ZC
						JOIN OPENJSON(@SQLJSON)
						WITH (
							ID_ZUMRECALISMA INT,
							DONEM VARCHAR(4),
							AD VARCHAR(MAX),
							EGITIMCI VARCHAR(MAX),
							ID_SUBE INT,
							MEKAN VARCHAR(MAX),
							TARIH VARCHAR(MAX),
							SAAT VARCHAR(MAX),
							KOTA INT,
							ONAY BIT,
							YAZILILINK VARCHAR(MAX),
							DETAY VARCHAR(MAX)
						) J ON J.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA
					END
					ELSE
					BEGIN
						EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Kota mevcut katılımcı sayısından küçük olamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
					END
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Bir şubede aynı gün ve saatte birden fazla zümre çalışması yapılamaz!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 3	--	SİL
			BEGIN	
				UPDATE ZC SET	ZC.AKTIF = 0
				FROM [dbo].[ZumreCalisma] ZC
				WHERE ZC.ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 4	--	LİSTELE
			BEGIN
				SELECT 
				ISNULL (
				(
					SELECT	 ID_ZUMRECALISMA	= ZC.ID_ZUMRECALISMA
							,DONEM				= ZC.DONEM
							,AD					= ZC.AD
							,EGITIMCI			= ZC.EGITIMCI
							,ID_SUBE			= ZC.ID_SUBE
							,SUBE				= SB.AD 
							,MEKAN				= ZC.MEKAN
							,TARIH				= CONVERT(VARCHAR(MAX),[TARIH],104)
							,SAAT				= ZC.SAAT
							,KOTA				= ZC.KOTA
							,ONAY				= ZC.ONAY
							,YAZILILINK			= ZC.YAZILILINK
							,DETAY				= ZC.DETAY
							,KYE_KULLANICI		= ZC.KYE_KULLANICI
							,YOKLAMA_DURUM		= ZC.YOKLAMA_DURUM
							,YAZILI_DURUM		= ZC.YAZILI_DURUM
							,KATILIM_DURUM		= IIF (EXISTS(SELECT TOP 1 K.ID_ZUMRECALISMA FROM ZumreCalismaKatilimci K WHERE K.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA AND K.YOKLAMA_DURUM = 1),1,0)
					FROM ZumreCalisma			ZC
					JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE	= ZC.ID_SUBE
					WHERE	DONEM	= @DONEM 
						AND (	@ID_SUBE IS NULL 
							OR	ZC.ID_SUBE = @ID_SUBE 
							OR (	@ID_SUBE = 0 
								AND ZC.ID_SUBE IN (SELECT ID_SUBE FROM OkyanusDB.dbo.v3SubeYetki SY WHERE SY.TCKIMLIKNO = @TCKIMLIKNO)
								)
							) 
						AND AKTIF = 1
					FOR JSON PATH, INCLUDE_NULL_VALUES
				), '[]')
			END

			IF @ISLEM = 5	--	KATILIMCI LİSTELE
			BEGIN
				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				SET @orderByClause = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'ADSOYAD'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				SELECT @whereClause = value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX))
				SELECT @displayStart = start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)
				SELECT @displayLength = length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT)

				IF @whereClause <> ''
				BEGIN
					SET @COLUMNS = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR ADSOYAD LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE ' + @COLUMNS
				END

				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT	 ZCK.ID_ZUMRECALISMAKATILIMCI
												,ZCK.TCKIMLIKNO
												,TRIM(K.AD + '' '' + K.SOYAD) AS ADSOYAD
										FROM ZumreCalismaKatilimci ZCK
										JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
										--LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = ZCK.TCKIMLIKNO
										WHERE ZCK.ID_ZUMRECALISMA = '+CAST(@ID_ZUMRECALISMA AS varchar)+' AND ZCK.ONAY = 1
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' 
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = ' + CAST(@ID_ZUMRECALISMA AS varchar) + ' AND ONAY = 1) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
			END

			IF @ISLEM = 6	--	KATILIMCI SİL
			BEGIN
				DELETE FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
			END

			IF @ISLEM = 7	--	FİLTRE KULLANICI LİSTELE
			BEGIN
				SELECT	 SY.TCKIMLIKNO
						,TRIM(K.AD + ' ' + K.SOYAD) AS ADSOYAD
				INTO #TEMPTOTAL
				FROM OkyanusDB.dbo.v3SubeYetki SY
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = SY.TCKIMLIKNO-- AND O.TCKIMLIKNO <> '11111111111'
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SY.TCKIMLIKNO
				WHERE	(SY.ID_KULLANICITIPI IN (SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)) OR @ID_KULLANICITIPILIST = '[]')
				AND		(SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) OR @ID_SUBELIST = '[]')
				AND		(O.BRANS IN (SELECT VALUE FROM OPENJSON(@BRANSLIST)) OR @BRANSLIST = '[]')
				AND		(SY.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM ZumreCalismaKatilimci ZCK WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA))
				GROUP BY SY.TCKIMLIKNO, K.AD, K.SOYAD

				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				SET @orderByClause = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'ADSOYAD'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				SELECT @whereClause = value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX))
				SELECT @displayStart = start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)
				SELECT @displayLength = length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT)

				IF @whereClause <> ''
				BEGIN
					SET @COLUMNS = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR ADSOYAD LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE ' + @COLUMNS
				END

				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT * FROM #TEMPTOTAL
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' 
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM #TEMPTOTAL) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
				DROP TABLE #TEMPTOTAL
			END

			IF @ISLEM = 8	--	KATILIMCI ATA
			BEGIN
				IF NOT EXISTS (SELECT TOP 1 1 FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND TCKIMLIKNO = @TCKIMLIKNO_KULLANICI)
				BEGIN
					IF (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1) < (SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA)
					BEGIN
						INSERT INTO ZumreCalismaKatilimci(ID_ZUMRECALISMA, TCKIMLIKNO, KYE_KULLANICI)
						SELECT @ID_ZUMRECALISMA, @TCKIMLIKNO_KULLANICI, @TCKIMLIKNO
					END
					ELSE
					BEGIN
						EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Belirlenen katılımcı kotası dolu!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
					END
				END
			END

			IF @ISLEM = 9	--	KATILIMCI EXCEL
			BEGIN
				SELECT	 ZCK.TCKIMLIKNO
						,UPPER(TRIM(K.AD + ' ' + K.SOYAD)) AS ADSOYAD
						,eokul_v2.dbo.Fn_SubeYetkiGetir(K.TCKIMLIKNO) AS SUBEYETKI
						,ISNULL(O.BRANS, '') AS BRANS
						,UPPER(TRIM(K2.AD + ' ' + K2.SOYAD)) AS EKLEYENADSOYAD
				FROM ZumreCalismaKatilimci ZCK
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = ZCK.KYE_KULLANICI
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ZCK.ONAY = 1
				ORDER BY ADSOYAD
			END

			IF @ISLEM = 10	--	ZÜMRE ÇALIŞMA LİSTE
			BEGIN
				SELECT 
				ISNULL (
				(
					SELECT [ID_ZUMRECALISMA], [AD]
					FROM [dbo].[ZumreCalisma]
					WHERE DONEM = @DONEM AND (@ID_SUBE IS NULL OR ID_SUBE = @ID_SUBE) AND AKTIF = 1
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 11	--	ONAY ZÜMRE ÇALIŞMA LİSTE
			BEGIN
				SELECT 
				ISNULL (
				(
					SELECT [ID_ZUMRECALISMA], [AD]
					FROM [dbo].[ZumreCalisma]
					WHERE DONEM = @DONEM AND (@ID_SUBE IS NULL OR ID_SUBE = @ID_SUBE) AND AKTIF = 1 AND ONAY = 1 --AND CAST(CAST(TARIH AS varchar(MAX)) + ' ' + CAST(SAAT AS varchar(MAX)) AS datetime2) > GETDATE()
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 12	--	FİLTRE KULLANICI LİSTELE - ONAY
			BEGIN
				SELECT	 SY.TCKIMLIKNO
						,TRIM(K.AD + ' ' + K.SOYAD) AS ADSOYAD
						,ZCK.ID_ZUMRECALISMAKATILIMCI
				INTO #TEMPTOTAL12
				FROM OkyanusDB.dbo.v3SubeYetki SY
				JOIN ZumreCalismaKatilimci ZCK ON ZCK.TCKIMLIKNO = SY.TCKIMLIKNO AND ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = @ONAY
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SY.TCKIMLIKNO
				AND		(SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) OR @ID_SUBELIST = '[]')
				GROUP BY SY.TCKIMLIKNO, K.AD, K.SOYAD, ZCK.ID_ZUMRECALISMAKATILIMCI

				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				SET @orderByClause = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'ADSOYAD'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				SELECT @whereClause = value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX))
				SELECT @displayStart = start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)
				SELECT @displayLength = length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT)

				IF @whereClause <> ''
				BEGIN
					SET @COLUMNS = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR ADSOYAD LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE ' + @COLUMNS
				END

				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT * FROM #TEMPTOTAL12
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' 
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM #TEMPTOTAL12) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
				DROP TABLE #TEMPTOTAL12
			END

			IF @ISLEM = 13	--	KATILIMCI ONAY
			BEGIN	
				DECLARE @ID_ZUMRECALISMA13 INT
				SELECT @ID_ZUMRECALISMA13 = ID_ZUMRECALISMA FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				IF (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA13 AND ONAY = 1) < (SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA13) OR @ONAY = 0
				BEGIN
					UPDATE ZumreCalismaKatilimci SET ONAY = @ONAY, ONAY_KULLANICI = @TCKIMLIKNO, ONAY_TARIH = GETDATE() WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Belirlenen katılımcı kotası dolu!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END	
			END

			IF @ISLEM = 14	--	KATILIMCI ATA TOPLU
			BEGIN
				SELECT	 SY.TCKIMLIKNO
						,TRIM(K.AD + ' ' + K.SOYAD) AS ADSOYAD
				INTO #TEMPTOTAL14
				FROM OkyanusDB.dbo.v3SubeYetki SY
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = SY.TCKIMLIKNO-- AND O.TCKIMLIKNO <> '11111111111'
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SY.TCKIMLIKNO
				WHERE	(SY.ID_KULLANICITIPI IN (SELECT VALUE FROM OPENJSON(@ID_KULLANICITIPILIST)) OR @ID_KULLANICITIPILIST = '[]')
				AND		(SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) OR @ID_SUBELIST = '[]')
				AND		(O.BRANS IN (SELECT VALUE FROM OPENJSON(@BRANSLIST)) OR @BRANSLIST = '[]')
				AND		(SY.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM ZumreCalismaKatilimci ZCK WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA))
				GROUP BY SY.TCKIMLIKNO, K.AD, K.SOYAD

				IF (SELECT COUNT(1) FROM #TEMPTOTAL14) + (SELECT COUNT(1) FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1) <= (SELECT KOTA FROM ZumreCalisma WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA)
				BEGIN
					INSERT INTO ZumreCalismaKatilimci (ID_ZUMRECALISMA, TCKIMLIKNO, KYE_KULLANICI)
					SELECT @ID_ZUMRECALISMA, TCKIMLIKNO, @TCKIMLIKNO FROM #TEMPTOTAL14
				END
				ELSE
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Tümünü ekleyebilmek için yeterli kota yok!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END

				DROP TABLE #TEMPTOTAL14
			END

			IF @ISLEM = 15	--	KATILIMCI SİL TOPLU
			BEGIN
				DELETE FROM ZumreCalismaKatilimci WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ONAY = 1
			END

			IF @ISLEM = 16	--	YOKLAMA DURUM GÜNCELLE
			BEGIN
				UPDATE ZumreCalisma SET YOKLAMA_DURUM = @DURUM WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 17	--	YOKLAMA EXCEL
			BEGIN
				SELECT	 ZCK.TCKIMLIKNO
						,UPPER(TRIM(K.AD + ' ' + K.SOYAD)) AS ADSOYAD
						,eokul_v2.dbo.Fn_SubeYetkiGetir(K.TCKIMLIKNO) AS SUBEYETKI
						,ISNULL(O.BRANS, '') AS BRANS
						,UPPER(TRIM(K2.AD + ' ' + K2.SOYAD)) AS EKLEYENADSOYAD
						,CASE WHEN ZCK.YOKLAMA_DURUM = 1 THEN 'X' ELSE '' END AS YOKLAMA_DURUM
				FROM ZumreCalismaKatilimci ZCK
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = ZCK.KYE_KULLANICI
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ZCK.ONAY = 1
				ORDER BY ADSOYAD
			END

			IF @ISLEM = 18	--	YOKLAMA LİSTELE
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT ZCK.ID_ZUMRECALISMAKATILIMCI, ZCK.YOKLAMA_DURUM, ZC.AD, ZC.EGITIMCI, ZC.MEKAN, CONVERT(VARCHAR(MAX),[TARIH],104) AS TARIH, CAST(ZC.SAAT AS VARCHAR(5)) AS SAAT
					FROM ZumreCalismaKatilimci ZCK 
					JOIN ZumreCalisma ZC ON ZC.ID_ZUMRECALISMA = ZCK.ID_ZUMRECALISMA
					WHERE ZCK.TCKIMLIKNO = @TCKIMLIKNO AND ZC.AKTIF = 1 AND ZC.YOKLAMA_DURUM = 1 AND ZCK.ONAY = 1
					FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 19	--	YOKLAMA GİRİŞ GÜNCELLE
			BEGIN
				IF 1 = (SELECT ZC.YOKLAMA_DURUM FROM ZumreCalisma ZC JOIN ZumreCalismaKatilimci ZCK ON ZCK.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA WHERE ZCK.ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI)
				BEGIN
					UPDATE ZumreCalismaKatilimci SET YOKLAMA_DURUM = @DURUM, YOKLAMA_TARIH = GETDATE(), YOKLAMA_IP = @IP, YOKLAMA_BROWSER = @BROWSER WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE 
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Zümre çalışma için yoklama işlemi sonra erdiğinden kayıt işlemi gerçekleşmedi!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 20	--	YAZILI DURUM GÜNCELLE
			BEGIN
				UPDATE ZumreCalisma SET YAZILI_DURUM = @DURUM WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 21	--	YAZILI EXCEL
			BEGIN
				SELECT	 ZCK.TCKIMLIKNO
						,UPPER(TRIM(K.AD + ' ' + K.SOYAD)) AS ADSOYAD
						,eokul_v2.dbo.Fn_SubeYetkiGetir(K.TCKIMLIKNO) AS SUBEYETKI
						,ISNULL(O.BRANS, '') AS BRANS
						,UPPER(TRIM(K2.AD + ' ' + K2.SOYAD)) AS EKLEYENADSOYAD
						,CASE WHEN ZCK.YAZILI_DURUM = 1 THEN 'X' ELSE '' END AS YAZILI_DURUM
				FROM ZumreCalismaKatilimci ZCK
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = ZCK.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = ZCK.KYE_KULLANICI
				LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND ZCK.ONAY = 1
				ORDER BY ADSOYAD
			END

			IF @ISLEM = 22	--	YAZILI VAR MI?
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT ZCK.ID_ZUMRECALISMAKATILIMCI, ZCK.YAZILI_DURUM, ZC.AD, ZC.EGITIMCI, ZC.MEKAN, CONVERT(VARCHAR(MAX),[TARIH],104) AS TARIH, CAST(ZC.SAAT AS VARCHAR(5)) AS SAAT, ZC.YAZILILINK
					FROM ZumreCalismaKatilimci ZCK 
					JOIN ZumreCalisma ZC ON ZC.ID_ZUMRECALISMA = ZCK.ID_ZUMRECALISMA
					WHERE ZCK.TCKIMLIKNO = @TCKIMLIKNO AND ZC.AKTIF = 1 AND ZC.YAZILI_DURUM = 1 AND ZCK.ONAY = 1
					FOR JSON PATH
				),'[]')
			END

			IF @ISLEM = 23	--	YAZILI GİRİŞ GÜNCELLE
			BEGIN
				IF 1 = (SELECT ZC.YAZILI_DURUM FROM ZumreCalisma ZC JOIN ZumreCalismaKatilimci ZCK ON ZCK.ID_ZUMRECALISMA = ZC.ID_ZUMRECALISMA WHERE ZCK.ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI)
				BEGIN
					UPDATE ZumreCalismaKatilimci SET YAZILI_DURUM = @DURUM, YAZILI_TARIH = GETDATE(), YAZILI_IP = @IP, YAZILI_BROWSER = @BROWSER WHERE ID_ZUMRECALISMAKATILIMCI = @ID_ZUMRECALISMAKATILIMCI
				END
				ELSE 
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Zümre çalışma için yazılı işlemi sonra erdiğinden kayıt işlemi gerçekleşmedi!', @SEVERITY = 16 , @STATE = 1 , @ID_LOG = @ID_LOG, @ID_LOGTUR = 3
				END
			END

			IF @ISLEM = 24	--	YAZILI NOT VAR MI
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT TCKIMLIKNO, YAZILI_NOT 
					FROM ZumreCalismaKatilimci 
					WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA AND YAZILI_NOT IS NOT NULL
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 25	--	YAZILI NOT YUKLE
			BEGIN
				UPDATE ZumreCalismaKatilimci SET YAZILI_NOT = NULL WHERE ID_ZUMRECALISMA = @ID_ZUMRECALISMA

				UPDATE ZCK SET ZCK.YAZILI_NOT = J.YAZILI_NOT, ZCK.YAZILI_NOT_KULLANICI = @TCKIMLIKNO, ZCK.YAZILI_NOT_TARIH = GETDATE()
				FROM ZumreCalismaKatilimci ZCK
				JOIN OPENJSON(@SQLJSON)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					YAZILI_NOT INT
				) J ON J.TCKIMLIKNO = ZCK.TCKIMLIKNO
				WHERE ZCK.ID_ZUMRECALISMA = @ID_ZUMRECALISMA
			END

			IF @ISLEM = 26	--	ÇALIŞMALARIM
			BEGIN
				SELECT 
				ISNULL(
				(
					SELECT	 ZC.ID_ZUMRECALISMA
							,ZC.AD
							,ZC.MEKAN
							,ZC.EGITIMCI
							,CONVERT(VARCHAR(MAX), ZC.TARIH, 104) + ' ' + CAST(ZC.SAAT AS VARCHAR(5)) AS TARIH
							,ZCK.YOKLAMA_DURUM
							,ISNULL(CAST(ZCK.YAZILI_NOT AS VARCHAR), 'GİRİLMEDİ') AS YAZILI
							,ZCK.ID_ZUMRECALISMAKATILIMCI
					FROM ZumreCalismaKatilimci ZCK
					JOIN ZumreCalisma ZC ON ZC.ID_ZUMRECALISMA = ZCK.ID_ZUMRECALISMA
					WHERE ZC.AKTIF = 1 AND ZCK.TCKIMLIKNO = @TCKIMLIKNO AND ZCK.ONAY = 1
					ORDER BY ZC.ID_ZUMRECALISMA DESC
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 27	--	KATILIM BELGESİ
			BEGIN

				SELECT	 ZC.EGITIMCI
						,CONVERT(VARCHAR(MAX), ZC.TARIH, 104) + ' ' + CAST(ZC.SAAT AS VARCHAR(5)) AS TARIH
						,ADSOYAD = CONCAT_WS(' ',K.AD,K.SOYAD)
						,KONU = ZC.AD
				FROM ZumreCalismaKatilimci	ZCK
				JOIN ZumreCalisma			ZC	ON	ZC.ID_ZUMRECALISMA	= ZCK.ID_ZUMRECALISMA
				JOIN v3Kullanici			K	ON	K.TCKIMLIKNO		= ZCK.TCKIMLIKNO
				WHERE	ZC.AKTIF			= 1
					AND ZCK.ONAY			= 1
					AND ZCK.YOKLAMA_DURUM	= 1
					AND (	ZCK.ID_ZUMRECALISMA			= @ID_ZUMRECALISMA	
						OR	ZCK.ID_ZUMRECALISMAKATILIMCI= @ID_ZUMRECALISMAKATILIMCI
						)
				ORDER BY ADSOYAD
				
			END
		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_VIU]...';


GO
ALTER procedure [dbo].[sp_VIU]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	
	@BASTARIH			VARCHAR(MAX)	= NULL,
	@BITTARIH			VARCHAR(MAX)	= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@TCOGRETMENLIST		VARCHAR(MAX)	= NULL,
	@ID_ARAMADURUMLIST	VARCHAR(MAX)	= NULL,
	@ID_ARAMASEBEPLIST	VARCHAR(MAX)	= NULL,
	@JSON				BIT				= NULL,
	@ID_SUBELER		    VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
									
				,BASTARIH			= @BASTARIH
				,BITTARIH			= @BITTARIH
				,ID_SUBELIST		= @ID_SUBELIST
				,TCOGRETMENLIST		= @TCOGRETMENLIST
				,ID_ARAMADURUMLIST	= @ID_ARAMADURUMLIST
				,ID_ARAMASEBEPLIST	= @ID_ARAMASEBEPLIST
				,[JSON]				= @JSON
				,ID_SUBELER		    = @ID_SUBELER
				,ID_SINIFLAR        = @ID_SINIFLAR
				,SQLJSON			= @SQLJSON
				,TC_OGRETMEN		= @TC_OGRETMEN
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @ID_LOG > 0
		BEGIN	
			IF @ISLEM = 1	--	VIU Rapor Mesaj
			BEGIN			
				SELECT
					 ACIKLAMA	=	B.AD + IIF(D.ID_DOKUMAN IS NOT NULL ,'https://okyanusdata.s3-eu-west-1.amazonaws.com/viu/'+ D.GUID ,'')
					,KYE_TARIH	=	CONVERT(VARCHAR(10), B.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), B.KYE_TARIH, 108)
					,GONDERENTC	=	KYE.TCKIMLIKNO
					,GONDEREN	=	KYE.AD  +' '+ KYE.SOYAD
					,KIME		=	KIME.AD +' '+ KIME.SOYAD
					,KIMICIN	=	KYI.AD  +' '+ KYI.SOYAD
					
					,GONDERENSUBE	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,GONDERENTIP	=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMESUBE		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki	SY
									INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,KIMETIP		=	STUFF((
									SELECT DISTINCT ', ' + SB.AD
									FROM OkyanusDB.dbo.v3SubeYetki				SY
									INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
									WHERE SY.TCKIMLIKNO = KIME.TCKIMLIKNO
									FOR XML PATH('')
									), 1, 1, '')
					,RENK = IIF( IPTAL = 1 , 'Red' , 'Black' )
				FROM OkyanusIletisim.dbo.BilgiNot					B
				INNER JOIN OkyanusIletisim.dbo.BilgiNotKullanici	N		ON	N.ID_BILGINOT	= B.ID_BILGINOT
				LEFT  JOIN OkyanusIletisim.dbo.Dokuman				D		ON	D.ID_DOKUMAN	= B.ID_DOKUMAN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYE		ON	KYE.TCKIMLIKNO	= B.KYE_TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KYI		ON	KYI.TCKIMLIKNO	= N.TCKIMLIKNO_KIMICIN
				INNER JOIN OkyanusDB.dbo.v3Kullanici				KIME	ON	KIME.TCKIMLIKNO	= N.TCKIMLIKNO_KIME
				WHERE CAST(B.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								KYE.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = KYE.TCKIMLIKNO AND SB.ID_SUBE	IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
					)		
				ORDER BY B.KYE_TARIH DESC
			END
	
			IF @ISLEM = 2	--	VIU Rapor VIÜ Kullanmayanlar
			BEGIN				
				
				DECLARE @DONEM NVARCHAR(MAX)

				SELECT TOP 1 @DONEM = '01.09.' + DONEM 
				FROM OkyanusDB.dbo.v3AktifDonem
				WHERE AKTIF = 1


				--SELECT DISTINCT
				--	 SUBE			= SB.AD
				--	,TCKIMLIKNO		= K.TCKIMLIKNO
				--	,AD				= K.AD
				--	,SOYAD			= K.SOYAD
				--	,KULLANICIAD	= K.KULLANICIAD
				--	,SIFRE			= K.SIFRE
				--	,SINIF			= SN.AD
				--	,KADEME			= K3.AD
				--	,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
				--	,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				--INTO #KULLANICILIST
				--FROM		OkyanusDB.dbo.v3Kullanici	K
				--INNER JOIN	OkyanusDB.dbo.v3SubeYetki	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO 
				--INNER JOIN	OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO	= K.TCKIMLIKNO
				--INNER JOIN	OkyanusDB.dbo.v3Ogrenci		OG	ON	OG.TCKIMLIKNO	= OV.TCKIMLIKNO_OGR
				--INNER JOIN	OkyanusDB.dbo.v3Sinif		SN	ON	SN.ID_SINIF		= OG.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3Satislar	SL	ON	SL.ID_SINIF		= SN.ID_SINIF
				--INNER JOIN	OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= SL.ID_SATISTURU
				--INNER JOIN	OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3 
				--INNER JOIN	OkyanusDB.dbo.v3Sube		SB	ON	SB.ID_SUBE		= SY.ID_SUBE
				--LEFT JOIN	OkyanusIletisim.dbo.LoginLog L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
				--											AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				--WHERE	K.AKTIF = 1 
				--	AND SY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				--	AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))
				--GROUP BY SB.AD, K.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, SN.AD, K3.AD, L.KYE_TCKIMLIKNO
				
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST

				SELECT VALUE ID_SUBE INTO #SUBELIST FROM OPENJSON(@ID_SUBELIST)

				SELECT DISTINCT 
					 SUBE			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SB.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE = SKY.ID_SUBE
														WHERE	SKY.TCKIMLIKNO	= KY.TCKIMLIKNO													
															AND SKY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 													
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,TCKIMLIKNO		= KY.TCKIMLIKNO
					,AD				= K.AD
					,SOYAD			= K.SOYAD
					,KULLANICIAD	= K.KULLANICIAD
					,SIFRE			= K.SIFRE
					,KULLANICITIPI	= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( KT.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3KullaniciTipi		KT	ON	KT.ID_KULLANICITIPI	= SKY.ID_KULLANICITIPI
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	 IN (5, 3, 53, 54, 26)
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,SINIF			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SN.AD AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.v3Sinif				SN	ON	SN.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,KADEME			= (SELECT STUFF((	SELECT DISTINCT ', ' +  CAST( SGS.KADEME3 AS VARCHAR) 
														FROM OkyanusDB.dbo.vw_KullaniciYetki	SKY 
														JOIN #SUBELIST							SL	ON	SL.ID_SUBE	= SKY.ID_SUBE
														JOIN OkyanusDB.dbo.vw_SubeGrupSinif		SGS	ON	SGS.ID_SINIF = SKY.ID_SINIF
														WHERE	SKY.TCKIMLIKNO			= KY.TCKIMLIKNO
															AND SKY.ID_KULLANICITIPI	= 5
										FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
					,ID_LOGINLOG	= MAX(ID_LOGINLOG) 
					,[LOGIN]		= IIF(L.KYE_TCKIMLIKNO IS NULL, 0, 1)
				INTO #KULLANICILIST
				FROM OkyanusDB.dbo.vw_KullaniciYetki	KY
				JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= KY.TCKIMLIKNO
				JOIN #SUBELIST							SL	ON	SL.ID_SUBE		= KY.ID_SUBE
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	CAST(L.KYE_TARIH AS DATE) >= CAST(@DONEM AS DATE) 
															AND L.KYE_TCKIMLIKNO = K.TCKIMLIKNO
				WHERE	KY.ID_KULLANICITIPI IN (5, 3, 53, 54, 26) --veli-öğretmen-müdür-mdryrd-rehber 
				GROUP BY KY.TCKIMLIKNO, K.AD, K.SOYAD, K.KULLANICIAD, K.SIFRE, L.KYE_TCKIMLIKNO--, SN.AD, K3.AD, SB.AD




				SELECT KL.*
					,LOGINTARIH		= CONVERT(VARCHAR(10), L.KYE_TARIH, 104) + ' ' + CONVERT(VARCHAR(8), L.KYE_TARIH, 108) 
					,LOGINOTURUM	= SUBSTRING(CAST(L.OTURUM AS VARCHAR(MAX)),1,LEN(CAST(L.OTURUM AS VARCHAR(MAX)))-5)+ '*****'
				FROM #KULLANICILIST						KL
				LEFT JOIN OkyanusIletisim.dbo.LoginLog	L	ON	L.ID_LOGINLOG	= KL.ID_LOGINLOG
				ORDER BY SUBE, AD, SOYAD
								
				DROP TABLE IF EXISTS #KULLANICILIST
				DROP TABLE IF EXISTS #SUBELIST


			END
			
			IF @ISLEM = 3	--	Arama Sebep Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMASEBEP, S.AD + ' (' + K.AD + ')' AS AD
					FROM [OkyanusIletisim].[dbo].[AramaSebep] S
					JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = S.ID_KADEME
					ORDER BY S.ID_KADEME, S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 4	--	Arama Durum Liste
			BEGIN
				SELECT
				(
					SELECT ID_ARAMADURUM, S.AD
					FROM [OkyanusIletisim].[dbo].[AramaDurum] S
					ORDER BY S.AD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 5	--	Arama Rapor
			BEGIN
				IF @JSON = 1
				BEGIN
					SELECT 
					ISNULL (
					(
						SELECT	 GUID			=	A.GUID
								,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
								,ARAYANTC		=	A.TC_ARAYAN
								,ARAYAN			=	K.AD  +' '+ K.SOYAD
								,KIME			=	A.ADSOYAD_ARANAN
								,ARAMASEBEP		=	S.AD 
								,ARAMADURUM		=	D.AD 
								,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
								,GRUP			=	K3.AD
								,SINIF			=	SNF.AD
								,ARAYANSUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
															FOR XML PATH('')
													), 1, 1, '')
								--,ARAYANTIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
								--				FOR XML PATH('')
								--				), 1, 1, '')
								,KIMESUBE		=	STUFF(( SELECT DISTINCT ', ' + SB.AD
															FROM OkyanusDB.dbo.v3SubeYetki	SY
															INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
															WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
															FOR XML PATH('')
													), 1, 1, '')
								--,KIMETIP		=	STUFF((
								--				SELECT DISTINCT ', ' + SB.AD
								--				FROM OkyanusDB.dbo.v3SubeYetki				SY
								--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
								--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
								--				FOR XML PATH('')
								--				), 1, 1, '') 
						FROM OkyanusIletisim.dbo.Arama		A	WITH (NOLOCK)
						JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO	= A.TC_ARAYAN
						JOIN OkyanusDB.dbo.v3Kullanici		KYI ON	KYI.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
						JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
						JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
						JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
						JOIN OkyanusIletisim.dbo.AramaSebep S	ON	S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
						JOIN OkyanusIletisim.dbo.AramaDurum D	ON	D.ID_ARAMADURUM = A.ID_ARAMADURUM
						WHERE	CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
						AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
						AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
						AND (
									(	EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST)))
							OR		(NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND K.TCKIMLIKNO IN (	SELECT DISTINCT  SY.TCKIMLIKNO
														FROM OkyanusDB.dbo.v3SubeYetki	SY
														INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
														WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
									)	
								)
							)	
						AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
						ORDER BY A.KYE_TARIH DESC
						FOR JSON PATH
					), '[]')
				END
				ELSE
				BEGIN
					SELECT	 GUID			=	A.GUID
							,KYE_TARIH		=	CONVERT(VARCHAR(10), A.KYE_TARIH, 104) +' - '+ CONVERT(VARCHAR(5), A.KYE_TARIH, 108)
							,ARAYANTC		=	A.TC_ARAYAN
							,ARAYAN			=	K.AD  +' '+ K.SOYAD
							,KIME			=	A.ADSOYAD_ARANAN
							,ARAMASEBEP		=	S.AD 
							,ARAMADURUM		=	D.AD 
							,KIMICIN		=	KYI.AD  +' '+ KYI.SOYAD
							,GRUP			=	K3.AD
							,SINIF			=	SNF.AD
							,ARAYANSUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
											FOR XML PATH('')
											), 1, 1, '')
							--,ARAYANTIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = A.TC_ARAYAN
							--				FOR XML PATH('')
							--				), 1, 1, '')
							,KIMESUBE		=	STUFF((
											SELECT DISTINCT ', ' + SB.AD
											FROM OkyanusDB.dbo.v3SubeYetki	SY
											INNER JOIN OkyanusDB.dbo.v3Sube	SB	ON	SB.ID_SUBE = SY.ID_SUBE
											WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
											FOR XML PATH('')
											), 1, 1, '')
							--,KIMETIP		=	STUFF((
							--				SELECT DISTINCT ', ' + SB.AD
							--				FROM OkyanusDB.dbo.v3SubeYetki				SY
							--				INNER JOIN OkyanusDB.dbo.v3KullaniciTipi	SB	ON	SB.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
							--				WHERE SY.TCKIMLIKNO = KYI.TCKIMLIKNO
							--				FOR XML PATH('')
							--				), 1, 1, '') 
					FROM OkyanusIletisim.dbo.Arama A	WITH (NOLOCK)
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = A.TC_ARAYAN
					JOIN OkyanusDB.dbo.v3Kullanici KYI ON KYI.TCKIMLIKNO = A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Ogrenci		O	ON	O.TCKIMLIKNO	= A.TC_ARAMASEBEP
					JOIN OkyanusDB.dbo.v3Sinif			SNF	ON	SNF.ID_SINIF	= O.ID_SINIF
					JOIN OkyanusDB.dbo.v3SatisTuru		ST	ON	ST.ID_SATISTURU	= SNF.ID_SATISTURU
					JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
					JOIN OkyanusIletisim.dbo.AramaSebep S ON S.ID_ARAMASEBEP = A.ID_ARAMASEBEP
					JOIN OkyanusIletisim.dbo.AramaDurum D ON D.ID_ARAMADURUM = A.ID_ARAMADURUM
					WHERE CAST(A.KYE_TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
					AND A.ID_ARAMADURUM IN (SELECT VALUE FROM OPENJSON(@ID_ARAMADURUMLIST))
					AND A.ID_ARAMASEBEP IN (SELECT VALUE FROM OPENJSON(@ID_ARAMASEBEPLIST))
					AND (
							(
								EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
							)
							OR
							(
								NOT EXISTS (SELECT VALUE FROM OPENJSON (@TCOGRETMENLIST))
								AND
								K.TCKIMLIKNO IN ( 
													SELECT DISTINCT  SY.TCKIMLIKNO
													FROM OkyanusDB.dbo.v3SubeYetki	SY
													INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SY.ID_SUBE
													WHERE SY.TCKIMLIKNO = K.TCKIMLIKNO AND SB.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST))				
													)	
							)
						)	
					AND EXISTS ( SELECT TOP 1 Y.ID_SUBE FROM v3SubeYetki Y WHERE Y.TCKIMLIKNO = A.TC_ARAMASEBEP AND Y.ID_SUBE IN ( SELECT VALUE FROM OPENJSON (@ID_SUBELIST)  ))
					ORDER BY A.KYE_TARIH DESC
				END
			END

			IF @ISLEM = 6   --  Yoklama Rapor
			BEGIN
				--SELECT distinct 
				--	 D.SUBEAD
				--	,D.SINIF
				--	,K.AD + ' '+ K.SOYAD [AD SOYAD]
				--	,CONVERT(VARCHAR(10), Y.TARIH, 105)AS TARIH
				--	,K.TCKIMLIKNO
				--	,D.ID_SINIF
				--	,Y.ID_YOKLAMA
				--	,YK.GELDI
				--	,Y.TARIH AS tarih
				--	,CASE
				--			WHEN GELDI>0 THEN 'GELDİ'
				--			WHEN GELDI<1 THEN 'GELMEDİ'
				--		END AS DURUM
				--FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				--INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				--INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				--INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				--INNER JOIN  [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF	= D.ID_SINIF	AND	S.ID_SINIF		= Y.ID_SINIF
				--INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici] YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA  AND YK.TCKIMLIKNO	= K.TCKIMLIKNO
				--WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				--AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				--AND CAST(TARIH AS DATE) BETWEEN CAST(@BASTARIH AS DATE) AND CAST(@BITTARIH AS DATE)
				--ORDER BY  D.SUBEAD ASC,D.SINIF ASC,[AD SOYAD] ASC ,tarih DESC

				SELECT DERSNO, AD = BASSAAT + ' - ' + BITSAAT
				INTO #DERSSAAT
				FROM Pusulam.dbo.OnlineDersSaat   

				SELECT CAST(DATEADD(DAY, number, @BASTARIH) AS DATE) [Date]
				INTO #DATES
				FROM master..spt_values
				WHERE type = 'P'
				AND DATEADD(DAY, number, @BASTARIH) <= @BITTARIH

				SELECT distinct 
					 SD.SUBEAD
					,SD.SINIF
					,K.AD + ' '+ K.SOYAD [AD SOYAD]
					,K.TCKIMLIKNO
					,S.ID_SINIF
				INTO #KULLANICI
				FROM		OkyanusDB.dbo.vw_SinifOgrenci				S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				SD	ON S.ID_SINIF	= SD.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= SD.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				WHERE AD.AKTIF=1        
				AND ( ( SD.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( SD.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  

				SELECT K.*, D.Date AS TARIH, CONVERT(VARCHAR(MAX), D.Date, 104) AS STRTARIH
				INTO #KULLANICITARIH
				FROM #KULLANICI K
				CROSS APPLY #DATES D

				SELECT K.TCKIMLIKNO, K.TARIH, DP.DERSSAAT, CASE WHEN YK.GELDI = 1 THEN 'GELDİ' ELSE 'GELMEDİ' END AS DURUM
				INTO #KULLANICIDURUM
				FROM #KULLANICITARIH K
				INNER JOIN [OkyanusIletisim].[dbo].[Yoklama]			Y	ON Y.ID_SINIF = K.ID_SINIF AND Y.TARIH = K.TARIH
				INNER JOIN  [OkyanusIletisim].[dbo].[YoklamaKullanici]	YK	ON YK.ID_YOKLAMA= Y.ID_YOKLAMA AND YK.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN  OkyanusDB.dbo.v3DersProgram DP					ON DP.ID_DERSPROGRAM = Y.ID_DERSPROGRAM


				DECLARE @INDEX INT = 1
				DECLARE @COLUMN VARCHAR(MAX) = ''
				DECLARE @DERSNO VARCHAR(MAX) = ''

				WHILE @INDEX <= (SELECT MAX(DERSNO) FROM #DERSSAAT WHERE AD != ' - ')
				BEGIN
					SELECT @COLUMN = AD, @DERSNO = DERSNO FROM #DERSSAAT WHERE DERSNO = @INDEX

					EXECUTE('
					ALTER TABLE #KULLANICITARIH
					ADD [' + @COLUMN + '] VARCHAR(MAX)
					')
		
					EXECUTE ('UPDATE K SET K.[' + @COLUMN + '] = ISNULL((
																			SELECT DURUM
																			FROM #KULLANICIDURUM KD
																			WHERE KD.TARIH = K.TARIH AND KD.TCKIMLIKNO = K.TCKIMLIKNO AND KD.DERSSAAT = ' + @DERSNO + '
																), ''-'') FROM #KULLANICITARIH K')


					SET @INDEX = @INDEX + 1
				END

				SELECT *
				FROM #KULLANICITARIH
				ORDER BY SUBEAD ASC,SINIF ASC, [AD SOYAD] ASC, TARIH

				DROP TABLE #KULLANICI
				DROP TABLE #DERSSAAT
				DROP TABLE #DATES
				DROP TABLE #KULLANICITARIH
				DROP TABLE #KULLANICIDURUM
			END

			IF @ISLEM = 7   --  Viu Yetki Listesi
			BEGIN
			
				SELECT 
				(
					SELECT	Distinct K.AD + ' '+ K.SOYAD AS ADSOYAD ,K.TCKIMLIKNO
							
							,(	
							   
								SELECT distinct D.SUBEAD AS SUBEAD,D.ID_SUBE, 
								SECILI = (SELECT COUNT(1) FROM  ViuAramaKullaniciSube S where D.ID_SUBE=S.ID_SUBE and S.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.SUBEAD,D.ID_SUBE
								ORDER BY D.SUBEAD,D.ID_SUBE
								FOR JSON PATH
							 ) AS SUBE
							 ,(
							 SELECT distinct D.KADEME3 AS GRUP,D.ID_KADEME3, 
							 SECILI = (SELECT COUNT(1) FROM  ViuAramaKullaniciKademe K where K.ID_KADEME3=D.ID_KADEME3 and K.TCKIMLIKNO=@TC_OGRETMEN)
								FROM OkyanusDB.dbo.vw_v4SinifDetay D 
								INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci S   ON D.ID_SINIF=S.ID_SINIF 
								GROUP BY D.KADEME3,D.ID_KADEME3
								ORDER BY D.ID_KADEME3
								FOR JSON PATH
							 )
							 AS GRUP
					FROM OkyanusDB.dbo.v3Kullanici	K
					INNER JOIN OkyanusDB.[dbo].[v4KullaniciSubeTurKademe] TK  ON   TK.TCKIMLIKNO=K.TCKIMLIKNO 
					WHERE K.TCKIMLIKNO =@TC_OGRETMEN
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8   --  Viu Yetki Kaydet
			BEGIN
		   
				DELETE FROM ViuAramaKullanici WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciSube WHERE TCKIMLIKNO = @TC_OGRETMEN
				DELETE FROM ViuAramaKullaniciKademe WHERE TCKIMLIKNO = @TC_OGRETMEN
				
				MERGE INTO ViuAramaKullanici AS A 
                USING ( 
						SELECT *
                        FROM OPENJSON(@SQLJSON) WITH ( TCKIMLIKNO VARCHAR(MAX) )) B
                ON (A.TCKIMLIKNO = B.TCKIMLIKNO) 
                WHEN MATCHED THEN 
                UPDATE  SET A.TCKIMLIKNO =B.TCKIMLIKNO                  
                WHEN NOT MATCHED THEN 
                INSERT  (TCKIMLIKNO)
				VALUES (B.TCKIMLIKNO);

					

				SELECT DISTINCT TCKIMLIKNO
                FROM OPENJSON(@SQLJSON)
                WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
		                ,SUBE		NVARCHAR(MAX) AS JSON 
		                ,GRUP		NVARCHAR(MAX) AS JSON
                ) AS J
					
                     
				INSERT INTO ViuAramaKullaniciSube(TCKIMLIKNO, ID_SUBE)
				SELECT DISTINCT TCKIMLIKNO, ID_SUBE 
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.SUBE)
				WITH(	 ID_SUBE	INT
						,SECILI		BIT	
				) AS S
				WHERE S.SECILI = 1

				INSERT INTO ViuAramaKullaniciKademe(TCKIMLIKNO,ID_KADEME3)
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME3  
				FROM OPENJSON(@SQLJSON)
				WITH(	 TCKIMLIKNO	NVARCHAR(MAX)
						,SUBE		NVARCHAR(MAX) AS JSON 
						,GRUP		NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.GRUP)
				WITH (	 ID_KADEME3	INT
						,SECILI		BIT	
				) AS G
				WHERE G.SECILI = 1








        END 

			IF @ISLEM = 9	--	Kullanıcı Tipine Göre Kullanıcı Listele
			BEGIN
		
				SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
				FROM [dbo].[v3Kullanici]			KL	
				JOIN OkyanusDB.[dbo].[v3SubeYetki]	TK  ON   TK.TCKIMLIKNO=KL.TCKIMLIKNO 
				WHERE	TK.ID_KULLANICITIPI=101
				order by ADSOYAD 

			END

			IF @ISLEM = 10  --  Viu Toplu Mesaj Kaydet
			BEGIN				
				DROP TABLE IF EXISTS #MESAJLIST

				SELECT *, RN = ROW_NUMBER() OVER(ORDER BY TC_GONDEREN)
				INTO #MESAJLIST
				FROM OPENJSON(@SQLJSON)
				WITH (
					TC_GONDEREN	VARCHAR(MAX),
					TC_ALAN		VARCHAR(MAX),
					MESAJ		VARCHAR(MAX),
					LINK_ETIKET	VARCHAR(MAX),
					LINK		VARCHAR(MAX)
				)	ML
				JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= ML.TC_ALAN
				
				DECLARE @TOPLUMESAJ INT = NULL
				DECLARE @INSERT10 TABLE (ID INT)
				
				INSERT INTO OkyanusIletisim.dbo.TopluMesaj (KYE_TARIH,KYE_TCKIMLIKNO) 
					OUTPUT inserted.ID_TOPLUMESAJ INTO @INSERT10(ID) 
				VALUES(GETDATE(),@TCKIMLIKNO)

				SET @TOPLUMESAJ =(SELECT TOP 1 ID FROM @INSERT10)



				WHILE EXISTS ( SELECT TOP 1 1 FROM #MESAJLIST )
				BEGIN
		
					DECLARE @TC_GONDEREN	VARCHAR(MAX),
							@TC_ALAN		VARCHAR(MAX),
							@MESAJ			VARCHAR(MAX),
							@LINK_ETIKET	VARCHAR(MAX),
							@LINK			VARCHAR(MAX),
							@RN				INT
					SELECT TOP 1 
						 @TC_GONDEREN	= ML.TC_GONDEREN
						,@TC_ALAN		= ML.TC_ALAN
						,@MESAJ			= ML.MESAJ	
						,@LINK_ETIKET	= ML.LINK_ETIKET
						,@LINK			= ML.LINK
						,@RN			= ML.RN
					FROM #MESAJLIST		ML
					ORDER BY RN

					IF NOT EXISTS (
						SELECT TOP 1 1
						FROM v3Kullanici K
						WHERE K.TCKIMLIKNO	= @TC_GONDEREN
							AND K.AKTIF		= 1
					)
						SET  @TC_GONDEREN = '14531453000'	-- OKYANUS KOLEJLERİ
	
					
					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TC_GONDEREN
						,@HEADER			= 'Yeni Mesaj'
						,@MESAJ				= @MESAJ
						,@LINK				= @LINK
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @MESAJ
						,@LINK_ETIKET		= @LINK_ETIKET
						,@TOPLUMESAJ		= @TOPLUMESAJ

					DELETE FROM #MESAJLIST WHERE RN = @RN

				END

				DROP TABLE IF EXISTS #MESAJLIST

			END
			

		END 
	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YG_MevcutDagilim]...';


GO
ALTER procedure [dbo].[sp_YG_MevcutDagilim]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
				--DECLARE @DONEM VARCHAR(4) = '2018'

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #TEMP_TBL

				SELECT	 GS.ID_SUBE
						,SUBEAD		= UPPER(GS.SUBEAD)
						,GS.ID_KADEME3
						,KADEME3	= UPPER(GS.KADEME3)
						,K.ID_KATEGORI
						,KATEGORI	= UPPER(K.AD)
						,OGRSAY		= COUNT(DISTINCT YO.TCKIMLIKNO) 
				INTO #TEMP
				FROM YG_KategoriOgrenci				YO
				LEFT JOIN YG_KategoriOgrenciYorum	Y	ON	Y.ID_KATEGORIOGRENCI = YO.ID_KATEGORIOGRENCI
				LEFT JOIN YG_Kategori				K	ON	K.ID_KATEGORI	= YO.ID_KATEGORI
														OR	K.ID_KATEGORI	= Y.ID_KATEGORI
				JOIN v3OgrenciTum					O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
														AND O.DONEM			= YO.DONEM
				JOIN vw_SubeGrupSinifTum			GS	ON	GS.ID_SINIF		= O.ID_SINIF
														AND GS.ID_KADEME3	= YO.ID_KADEME3
				WHERE	YO.DONEM = @DONEM
				GROUP BY GS.ID_SUBE, GS.ID_KADEME3, K.ID_KATEGORI, GS.KADEME3, K.AD, GS.SUBEAD
				ORDER BY ID_SUBE, ID_KADEME3,KATEGORI


				DECLARE @SQL VARCHAR(MAX)
				DECLARE @SQL2 VARCHAR(MAX) = ''
				DECLARE @colsKademe3 VARCHAR(MAX)
				--DECLARE @colsKademe3AD VARCHAR(MAX)

				SET @colsKademe3	= STUFF((	SELECT ',' +  QUOTENAME( C.KADEME3)		FROM (SELECT DISTINCT ID_KADEME3, KADEME3	FROM #TEMP)	c ORDER BY ID_KADEME3	FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
				--SET @colsKademe3AD	= STUFF((	SELECT ',' +  QUOTENAME( C.KADEME3)		FROM (SELECT DISTINCT ID_KADEME3, KADEME3	FROM #TEMP)	c ORDER BY ID_KADEME3	FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')


				DROP TABLE IF EXISTS #TEMP_TBL
				CREATE TABLE #TEMP_TBL( [KAMPÜS]	VARCHAR(MAX),
										[KATEGORI]	VARCHAR(MAX))
						
				SELECT DISTINCT T.KADEME3, T.ID_KADEME3 INTO #DONGU FROM #TEMP T
				WHILE EXISTS(SELECT * FROM #DONGU)
				BEGIN
					DECLARE @KADEME3 VARCHAR(MAX) 
					DECLARE @ID_KADEME3 INT 

					SELECT TOP 1 @KADEME3 = KADEME3, @ID_KADEME3 = ID_KADEME3 FROM #DONGU ORDER BY ID_KADEME3

					SET @SQL2  = @SQL2 + ' ALTER TABLE #TEMP_TBL ADD ['+CAST(@KADEME3 AS varchar)+'] DECIMAL(8,2) '

					DELETE FROM #DONGU WHERE ID_KADEME3 = @ID_KADEME3
				END

				PRINT @SQL2
				EXEC(@SQL2)

				SET @SQL = '
							INSERT INTO #TEMP_TBL ([KAMPÜS], KATEGORI,'+@colsKademe3+')
							SELECT SUBEAD, KATEGORI,'+@colsKademe3+' FROM (
								SELECT 
									SUBEAD
									,KADEME3
									--,ID_KATEGORI
									,KATEGORI	
									,OGRSAY		
								FROM #TEMP
							) AS D
							PIVOT (MAX(OGRSAY) FOR KADEME3 IN ('+@colsKademe3+')) AS P
						'

				PRINT @SQL
				EXEC (@SQL)

				
				IF @ISLEM = 1	--	JSON
				BEGIN				
					
					SELECT ISNULL((
						SELECT T.KATEGORI, K.* FROM #TEMP_TBL T
						JOIN #TEMP_TBL K ON K.KATEGORI = T.KATEGORI AND K.[KAMPÜS] = T.[KAMPÜS]
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					),'[]')

				END

				IF @ISLEM = 2	--	DATASET
				BEGIN
				
					SELECT * FROM #TEMP_TBL

					SELECT DISTINCT KATEGORI FROM #TEMP ORDER BY KATEGORI

				END


				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #TEMP_TBL

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YG_OgrenciSecimRaporu]...';


GO
ALTER procedure [dbo].[sp_YG_OgrenciSecimRaporu]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@ID_SUBEs				VARCHAR(MAX)= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
				,ID_SUBEs		= @ID_SUBEs
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	Rapor
			BEGIN
				SELECT SB.AD AS KAMPUS, S.AD AS SINIF, K.AD + ' ' + K.SOYAD AS ADSOYAD, KG.AD AS KULUP
				FROM YG_KategoriOgrenci YO
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = YO.DONEM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN YG_Kategori KG ON KG.ID_KATEGORI = YO.ID_KATEGORI
				WHERE  YO.DONEM = @DONEM
				AND ((@ID_SUBEs = '[]' AND O.ID_SUBE IN (SELECT ID_SUBE FROM OkyanusDB.dbo.v3SubeYetki SY WHERE SY.TCKIMLIKNO = @TCKIMLIKNO)) OR O.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs)))
				AND YO.ID_KADEME3 <> 7
				ORDER BY YO.ID_KADEME3, KAMPUS, SINIF, ADSOYAD				
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YG_Secim]...';


GO
ALTER procedure [dbo].[sp_YG_Secim]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@TC_OGRENCI				VARCHAR(MAX)= NULL,
	@ID_KATEGORI			INT			= NULL
AS
BEGIN
	

	DECLARE 
		@SUB_DONEM					VARCHAR(MAX)= @DONEM		,
		@SUB_TC_OGRENCI				VARCHAR(MAX)= @TC_OGRENCI	,
		@SUB_ID_KATEGORI			INT			= @ID_KATEGORI
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @SUB_DONEM
				,TC_OGRENCI		= @SUB_TC_OGRENCI
				,ID_KATEGORI	= @SUB_ID_KATEGORI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @_ID_LOG > 0
		BEGIN
		
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @SUB_DONEM)
				SET @SUB_DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	SEÇİLEBİLECEK YETENEK DERS LİSTESİ	
			BEGIN
				
				SET @SUB_DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
				DROP TABLE IF EXISTS #KOTAOGRENCI1
				DROP TABLE IF EXISTS #TEMP1


				SELECT	KK.KOTA,
						KK.DONEM,
						KK.ID_KADEME3,
						KK.ID_KATEGORI,
						KK.ID_SUBE,
						OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
											FROM YG_KategoriOgrenci YO	
											JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																			AND KK.ID_SUBE		= O.ID_SUBE		
											WHERE	KK.DONEM		= YO.DONEM
												AND KK.ID_KADEME3	= YO.ID_KADEME3		
												AND YO.ID_KATEGORI	= KK.ID_KATEGORI
										),0)
				INTO #KOTAOGRENCI1
				FROM YG_KategoriKota		KK
				JOIN YG_KategoriSecimTarih	ST	ON	ST.DONEM	= KK.DONEM
				--JOIN OkyanusDB.DBO.vw_SinifOgrenci	SO	ON	SO.TCKIMLIKNO	= @SUB_TC_OGRENCI
				--JOIN OkyanusDB.DBO.vw_v4SinifDetay	SD	ON	SD.ID_SINIF	= SO.ID_SINIF
				--										AND SD.ID_SUBE	= KK.ID_SUBE
				--										AND SD.ID_KADEME3= KK.ID_KADEME3
				WHERE	KK.DONEM	= @SUB_DONEM
					AND KK.AKTIF	= 1
					AND ST.AKTIF	= 1
					AND (	(	EXISTS		(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							AND ST.ESKI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.ESKI_BIT_TARIH >= CAST(GETDATE() AS date)
							)
						OR	(	
							--	NOT EXISTS	(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							--AND 
								ST.YENI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.YENI_BIT_TARIH >= CAST(GETDATE() AS date)
							)				
						)

				DECLARE @SECILECEKDERSYOK BIT = 0
				IF NOT EXISTS (SELECT TOP 1 1 FROM #KOTAOGRENCI1)
				BEGIN
					
					SET @SECILECEKDERSYOK  = 1

					INSERT INTO #KOTAOGRENCI1
					SELECT	KK.KOTA,
							KK.DONEM,
							KK.ID_KADEME3,
							KK.ID_KATEGORI,
							KK.ID_SUBE,
							OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
												FROM YG_KategoriOgrenci YO	
												JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																				AND KK.ID_SUBE		= O.ID_SUBE		
												WHERE	KK.DONEM		= YO.DONEM
													AND KK.ID_KADEME3	= YO.ID_KADEME3		
													AND YO.ID_KATEGORI	= KK.ID_KATEGORI
											),0)


					FROM YG_KategoriOgrenci		KO
					JOIN YG_Kategori			K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
					JOIN YG_KategoriKota		KK	ON	KK.ID_KATEGORI	= K.ID_KATEGORI
													AND KK.DONEM		= KO.DONEM
					WHERE	KO.DONEM	= @SUB_DONEM
						AND TCKIMLIKNO	= @SUB_TC_OGRENCI
						AND KK.AKTIF	= 1
				END
					
					
				SELECT	 KO.DONEM
						,KO.ID_KADEME3
						,KO.ID_KATEGORI
						,KO.ID_SUBE
						,KO.KOTA
						,KO.OGRSAY
						,KALANKONTEJAN	= KO.KOTA - KO.OGRSAY 
						,K.AD
						,K.ACIKLAMA
						,K.ID_USTKATEGORI
						,SECILI = CASE WHEN SO.ID_KATEGORI IS NULL THEN 0 ELSE 1 END
				INTO #TEMP1
				FROM #KOTAOGRENCI1		KO
				JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
				JOIN v3Ogrenci			O	ON	O.ID_SUBE		= KO.ID_SUBE
				JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= O.ID_SINIF
											AND GS.ID_KADEME3	= KO.ID_KADEME3	
				LEFT JOIN YG_KategoriOgrenci SO	ON	SO.DONEM		= KO.DONEM
												AND SO.ID_KATEGORI	= KO.ID_KATEGORI
												AND SO.ID_KADEME3	= KO.ID_KADEME3
												AND SO.TCKIMLIKNO	= @SUB_TC_OGRENCI
				WHERE	O.TCKIMLIKNO	= @SUB_TC_OGRENCI
					AND	((SO.ID_KATEGORI IS NULL AND KO.KOTA	> KO.OGRSAY) OR SO.ID_KATEGORI IS NOT NULL)
				
				DECLARE @YETENEKDERS VARCHAR(MAX) = (SELECT TOP 1 K.AD
													FROM YG_KategoriOgrenci	KO
													JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
													WHERE	DONEM		= @SUB_DONEM
														AND TCKIMLIKNO	= @SUB_TC_OGRENCI)

				DECLARE @SECIMTARIH BIT = 0
				IF EXISTS (	SELECT TOP 1 1
							FROM YG_KategoriSecimTarih 
							WHERE	DONEM = @SUB_DONEM
								AND AKTIF = 1
								AND	(	CAST(GETDATE() AS date) BETWEEN ESKI_BAS_TARIH AND ESKI_BIT_TARIH
									OR	CAST(GETDATE() AS date) BETWEEN YENI_BAS_TARIH AND YENI_BIT_TARIH)
						)
					SET @SECIMTARIH = 1

				
				SELECT(
						SELECT (
								SELECT ISNULL(( SELECT *
									FROM #TEMP1
									ORDER BY SECILI DESC, AD
									FOR JSON AUTO, INCLUDE_NULL_VALUES
								),'[]')					
						)AS LIST,
						(
							SELECT @SECIMTARIH SECIMTARIH, @YETENEKDERS YETENEKDERS,@SECILECEKDERSYOK SECILECEKDERSYOK 
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS SECIM
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)


				--SELECT ISNULL(( SELECT *
				--				FROM #TEMP1
				--				ORDER BY SECILI DESC, AD
				--				FOR JSON AUTO
				--			),'[]')

				
				DROP TABLE IF EXISTS #KOTAOGRENCI1
				DROP TABLE IF EXISTS #TEMP1

			END

			IF @ISLEM = 2	--	YETENEK DERSİ SEÇ					
			BEGIN
			
				SET @SUB_DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
				DROP TABLE IF EXISTS #KOTAOGRENCI2
				DROP TABLE IF EXISTS #TEMP2

				SELECT	KK.KOTA,
						KK.DONEM,
						KK.ID_KADEME3,
						KK.ID_KATEGORI,
						KK.ID_SUBE,
						OGRSAY	= ISNULL((	SELECT COUNT( DISTINCT YO.TCKIMLIKNO) 
											FROM YG_KategoriOgrenci		YO	
											JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
																			AND O.ID_SUBE		= KK.ID_SUBE		
											WHERE	YO.DONEM		= KK.DONEM
												AND YO.ID_KADEME3	= KK.ID_KADEME3	
												AND YO.ID_KATEGORI	= KK.ID_KATEGORI	
										),0)
				INTO #KOTAOGRENCI2
				FROM YG_KategoriKota		KK
				JOIN YG_KategoriSecimTarih	ST	ON	ST.DONEM	= KK.DONEM
				WHERE	KK.DONEM	= @SUB_DONEM
					AND KK.AKTIF	= 1
					AND ST.AKTIF	= 1
					AND (	(	EXISTS		(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							AND ST.ESKI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.ESKI_BIT_TARIH >= CAST(GETDATE() AS date)
							)
						OR	(	
							--	NOT EXISTS	(SELECT TCKIMLIKNO FROM YG_KategoriOgrenci T WHERE T.TCKIMLIKNO = @SUB_TC_OGRENCI AND CAST(T.DONEM AS INT)  = CAST(@SUB_DONEM AS INT) - 1 )
							--AND 
								ST.YENI_BAS_TARIH <= CAST(GETDATE() AS date)
							AND ST.YENI_BIT_TARIH >= CAST(GETDATE() AS date)
							)				
						)
										
				SELECT	 KO.DONEM
						,KO.ID_KADEME3
						,KO.ID_KATEGORI
						,KO.ID_SUBE
						,KO.KOTA
						,KO.OGRSAY
						,KO.KOTA - KO.OGRSAY AS KALANKONTEJAN
						,K.AD
						,K.ACIKLAMA
				INTO #TEMP2
				FROM #KOTAOGRENCI2		KO
				JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
				JOIN v3Ogrenci			O	ON	O.ID_SUBE		= KO.ID_SUBE
				JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= O.ID_SINIF
											AND GS.ID_KADEME3	= KO.ID_KADEME3			
				WHERE	O.TCKIMLIKNO	= @SUB_TC_OGRENCI
					AND KO.ID_KATEGORI	= @SUB_ID_KATEGORI
					AND	KO.KOTA			> KO.OGRSAY
					
				IF ( SELECT TOP 1 KALANKONTEJAN FROM #TEMP2 ) > 0
				BEGIN

					DELETE YG_KategoriOgrenci WHERE TCKIMLIKNO = @SUB_TC_OGRENCI AND DONEM = @SUB_DONEM

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO, DONEM, ID_KADEME3, ID_KATEGORI)
					SELECT TOP 1 TCKIMLIKNO, @SUB_DONEM, GS.ID_KADEME3, @SUB_ID_KATEGORI FROM v3Ogrenci O JOIN vw_SubeGrupSinif GS ON GS.ID_SINIF = O.ID_SINIF WHERE TCKIMLIKNO = @SUB_TC_OGRENCI
					
				END
				ELSE 
				BEGIN
					
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Seçmek İstediğiniz Yetenek Dersinin Kontejanı Dolmuştur. Farklı Bir Yetenek Dersini Seçiniz.', @SEVERITY = 16, @STATE = 1, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 3

				END

				DROP TABLE IF EXISTS #KOTAOGRENCI2				
				DROP TABLE IF EXISTS #TEMP2
			END

			
		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YG_SecimAyar]...';


GO
ALTER procedure [dbo].[sp_YG_SecimAyar]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL,
	@ESKI_BAS_TARIH			VARCHAR(MAX)= NULL,
	@ESKI_BIT_TARIH			VARCHAR(MAX)= NULL,
	@YENI_BAS_TARIH			VARCHAR(MAX)= NULL,
	@YENI_BIT_TARIH			VARCHAR(MAX)= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,DONEM			= @DONEM
				,ESKI_BAS_TARIH	= @ESKI_BAS_TARIH
				,ESKI_BIT_TARIH	= @ESKI_BIT_TARIH
				,YENI_BAS_TARIH	= @YENI_BAS_TARIH
				,YENI_BIT_TARIH	= @YENI_BIT_TARIH
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				
			IF @ISLEM = 1	--	SECİM TARİHİ BELİRLE
			BEGIN
				
				UPDATE YG_KategoriSecimTarih SET 
					AKTIF = 0
				WHERE DONEM = @DONEM

				INSERT INTO YG_KategoriSecimTarih (DONEM, ESKI_BAS_TARIH, ESKI_BIT_TARIH, YENI_BAS_TARIH, YENI_BIT_TARIH, KYE_TCKIMLIKNO)
				VALUES (@DONEM, @ESKI_BAS_TARIH, @ESKI_BIT_TARIH, @YENI_BAS_TARIH, @YENI_BIT_TARIH, @TCKIMLIKNO)

			END

			IF @ISLEM = 2	--	AKTAR
			BEGIN
								
				IF EXISTS (	SELECT TOP 1 1 
							FROM YG_KategoriOgrenci	O
							WHERE DONEM = @DONEM
								AND (	EXISTS (SELECT * FROM YG_KategoriOgrenciPuan	P	WHERE	P.ID_KATEGORIOGRENCI	= O.ID_KATEGORIOGRENCI)
									OR	EXISTS (SELECT * FROM YG_KategoriOgrenciYorum	y	WHERE	y.ID_KATEGORIOGRENCI	= O.ID_KATEGORIOGRENCI))
							)
				BEGIN
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Seçili Döneme Ait Puan Girişi Yapıldığından Dolayı Aktarım Gerçekleştiremezsiniz. ', @SEVERITY = 16, @STATE = 1, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 3
				END
				ELSE 
				BEGIN

					DELETE FROM YG_KategoriOgrenci WHERE DONEM= @DONEM

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO, DONEM, ID_KADEME3, ID_KATEGORITAVSIYE, ID_KATEGORI, TC_OGRETMEN)
					SELECT TCKIMLIKNO, @DONEM, ID_KADEME3 + 1, ID_KATEGORITAVSIYE, ID_KATEGORI, TC_OGRETMEN 
					FROM YG_KategoriOgrenci 
					WHERE	DONEM = CAST( (CAST(@DONEM AS INT)-1) AS varchar) 
						AND ID_KADEME3 NOT IN (7,18)	
						--	7   => 1.  Sınıf
						--	18  => 12. Sınıf


						--AND ID_KATEGORI NOT IN (SELECT DISTINCT K.ID_KATEGORI
						--						FROM YG_Kategori K
						--						WHERE	ID_USTKATEGORI IS NULL
						--							AND EXISTS (SELECT * FROM YG_Kategori G WHERE G.ID_USTKATEGORI = K.ID_KATEGORI)
						--						) -- SADECE 1. SINIFLARIN SEÇEBİLECEĞİ YETENEKLER
					ORDER BY ID_KATEGORIOGRENCI
	
				END


			END
			
			IF @ISLEM = 3	--	TARİH GETİR
			BEGIN
				SELECT ISNULL((
					SELECT DONEM, ESKI_BAS_TARIH, ESKI_BIT_TARIH, YENI_BAS_TARIH, YENI_BIT_TARIH FROM YG_KategoriSecimTarih
					WHERE	DONEM = @DONEM
						AND AKTIF = 1
					FOR JSON AUTO
				),'[]')

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YYS]...';


GO

ALTER procedure [dbo].[sp_YYS]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,

	@ID_YYSSINAV			INT				= NULL,
	@ID_YYSSINAVDOSYA		INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@DOSYAADI				VARCHAR(MAX)	= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@DOSYAGUID				VARCHAR(MAX)	= NULL,
	@ID_YYSSINAVDOSYALIST	VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				
				,ID_YYSSINAV			= @ID_YYSSINAV	
				,ID_YYSSINAVDOSYA		= @ID_YYSSINAVDOSYA	
				,ID_SUBE				= @ID_SUBE		
				,DONEM					= @DONEM				
				,DOSYAADI				= @DOSYAADI			
				,AD						= @AD					
				,DOSYAGUID				= @DOSYAGUID			
				,SQLJSON				= @SQLJSON				
				,ID_YYSSINAVDOSYALIST	= @ID_YYSSINAVDOSYALIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN

			IF @ISLEM = 1	--	SINAV TANIMLA		
			BEGIN

				INSERT INTO YYSSinav(AD, DONEM, KYE_TCKIMLIKNO)
				SELECT @AD, @DONEM, @TCKIMLIKNO
				
			END

			IF @ISLEM = 2	--	SINAV LİSTELE		
			BEGIN
				SELECT
				(
					SELECT	 S.ID_YYSSINAV
							,S.AD
							,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
							,ADSOYAD		= K.AD + ' ' + K.SOYAD
					FROM YYSSinav		S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					WHERE	S.DONEM		 = @DONEM
						AND S.AKTIF		 = 1 
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 3	--	SINAV DUZENLE		
			BEGIN
				UPDATE YYSSinav SET 
					 AD			= @AD
				WHERE ID_YYSSINAV = @ID_YYSSINAV
			END

			IF @ISLEM = 4	--	SINAV SİL			
			BEGIN
				UPDATE YYSSinav SET AKTIF = 0 WHERE ID_YYSSINAV = @ID_YYSSINAV

				UPDATE YYSSinavDosya SET AKTIF = 0 WHERE ID_YYSSINAV = @ID_YYSSINAV

				UPDATE YYSOgrenci SET ID_YYSSINAV = @ID_YYSSINAV
			END

			IF @ISLEM = 5	--	SINAV EXCEL YÜKLE	
			BEGIN

				IF EXISTS (	
							SELECT 1 
							FROM YYSOgrenciCevap	O 
							JOIN YYSSoru	S	ON	S.ID_YYSSORU	= O.ID_YYSSORU
							JOIN YYSDers	D	ON	D.ID_YYSDERS	= S.ID_YYSDERS
							WHERE D.ID_YYSSINAV = @ID_YYSSINAV
						)
				BEGIN
					RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
				END
				ELSE
				BEGIN
					
					DROP TABLE IF EXISTS #TEMP2
					DROP TABLE IF EXISTS #TEMP
					
					DELETE FROM YYSDers		WHERE ID_YYSSINAV = @ID_YYSSINAV	--	CASCADE 
					DELETE FROM YYSOptik	WHERE ID_YYSSINAV = @ID_YYSSINAV

					SELECT	 DERSNO
							,DERSAD
							,SORUNO
							,SORU
							,CEVAP
							,DUZEY
							,ACIKLAMA
					INTO #TEMP
					FROM OPENJSON (@SQLJSON , '$.DERSLIST') WITH(
						DERSNO		INT,
						DERSAD		VARCHAR(MAX),
						SORULIST	NVARCHAR(MAX) AS JSON,
						DUZEYLIST	NVARCHAR(MAX) AS JSON
					) AS J
					CROSS APPLY OPENJSON( J.SORULIST) WITH(
						SORUNO		INT,
						SORU		VARCHAR(MAX),
						CEVAP		VARCHAR(MAX)
					) AS S	
					CROSS APPLY OPENJSON( J.DUZEYLIST) WITH(
						DUZEY		INT,
						ACIKLAMA	VARCHAR(MAX)
					) AS D	

					INSERT INTO YYSDers (DERSNO, AD, ID_YYSSINAV)
					SELECT DISTINCT 
						 T.DERSNO 
						,T.DERSAD
						,@ID_YYSSINAV 
					FROM #TEMP	T

					INSERT INTO YYSSoru	(ID_YYSDERS, SORUNO, SORU, CEVAP )
					SELECT DISTINCT	 
						 D.ID_YYSDERS
						,T.SORUNO
						,T.SORU
						,T.CEVAP
					FROM #TEMP		T
					JOIN YYSDers	D	ON	D.DERSNO	= T.DERSNO
					WHERE D.ID_YYSSINAV = @ID_YYSSINAV

					INSERT INTO YYSDuzey (ID_YYSDERS, DUZEY, ACIKLAMA)
					SELECT DISTINCT
						 D.ID_YYSDERS	 
						,T.DUZEY
						,T.ACIKLAMA
					FROM #TEMP		T
					JOIN YYSDers	D	ON	D.DERSNO	= T.DERSNO
					WHERE D.ID_YYSSINAV = @ID_YYSSINAV
					
					
					INSERT INTO YYSOptik (ID_YYSSINAV, AD, BASLANGIC, KARAKTERSAYISI, SABIT)
					SELECT	 ID_YYSSINAV	= @ID_YYSSINAV
							,AD
							,BASLANGIC
							,KARAKTERSAYISI
							,SABIT			= 1
					FROM OPENJSON (@SQLJSON , '$.OPTIK.OPTIKSABIT') WITH(
						AD				VARCHAR(MAX),
						BASLANGIC		INT,
						KARAKTERSAYISI	INT
					) AS J
				UNION
					SELECT	 @ID_YYSSINAV
							,AD
							,BASLANGIC
							,KARAKTERSAYISI
							,SABIT			= 0
					FROM OPENJSON (@SQLJSON , '$.OPTIK.OPTIKDERS') WITH(
						AD				VARCHAR(MAX) '$.DERSAD',
						BASLANGIC		INT,
						KARAKTERSAYISI	INT
					) AS J
					ORDER BY BASLANGIC
										
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #TEMP2
				END
			END

			IF @ISLEM = 6	--	SINAV EXCEL LİSTELE	
			BEGIN
				
				
				SELECT ISNULL((
					SELECT (
						SELECT	 DERSNO
								,AD AS DERSAD
								,SORULIST = (
									SELECT	 SORUNO
											,SORU
											,CEVAP
									FROM YYSSoru	S
									WHERE S.ID_YYSDERS = D.ID_YYSDERS
									FOR JSON PATH
								)
								,DUZEYLIST = (
									SELECT	 DUZEY
											,ACIKLAMA
									FROM YYSDuzey	DZ
									WHERE DZ.ID_YYSDERS = D.ID_YYSDERS
									FOR JSON PATH
								)
						FROM YYSDers	D
						WHERE ID_YYSSINAV = @ID_YYSSINAV
						FOR JSON PATH
					) AS DERSLIST
					,(
						SELECT (							
							SELECT AD, BASLANGIC, KARAKTERSAYISI
							FROM  YYSOptik
							WHERE ID_YYSSINAV	= @ID_YYSSINAV
								AND SABIT		= 1
							ORDER BY BASLANGIC
							FOR JSON PATH
						) AS OPTIKSABIT					
						,(
							SELECT AD AS DERSAD, BASLANGIC, KARAKTERSAYISI
							FROM  YYSOptik
							WHERE ID_YYSSINAV	= @ID_YYSSINAV
								AND SABIT		= 0
							ORDER BY BASLANGIC
							FOR JSON PATH
						) AS OPTIKDERS
						FOR JSON PATH
					) AS OPTIK
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 7	--	OPTİK YÜKLE			
			BEGIN

				IF EXISTS (SELECT TOP 1 1 FROM YYSSinavDosya WHERE ID_YYSSINAV=@ID_YYSSINAV AND ID_SUBE = @ID_SUBE AND AD=@DOSYAADI AND AKTIF=1)
				BEGIN
					DECLARE @MSG VARCHAR(MAX) = 'DAHA ÖNCE AYNI İSİMLİ DOSYA KAYDETTİNİZ. KONTROL EDİNİZ!'
					RAISERROR (@MSG ,16, 1);
				END
				ELSE
				BEGIN

					DECLARE @ID_YYSSINAVDOSYAx TABLE (ID_YYSSINAVDOSYA int)
					INSERT INTO [dbo].[YYSSinavDosya]
								([ID_YYSSINAV]
								,[ID_SUBE]
								,[AD]
								,[GUID]
								,[KYE_TCKIMLIKNO])
					OUTPUT INSERTED.ID_YYSSINAVDOSYA into @ID_YYSSINAVDOSYAx
					VALUES (@ID_YYSSINAV,@ID_SUBE,@DOSYAADI,@DOSYAGUID,@TCKIMLIKNO)

					DECLARE @IDX int=(SELECT TOP 1 ID_YYSSINAVDOSYA FROM @ID_YYSSINAVDOSYAx)

					DECLARE @SQLDOSYA		VARCHAR(max)	= NULL
					DECLARE @YOLDOSYA		VARCHAR(max)	= NULL
					DECLARE @GUIDDOSYA		VARCHAR(max)	= NULL
				
					DROP TABLE IF EXISTS #tmp
					DROP TABLE IF EXISTS #TEMP7
					DROP TABLE IF EXISTS #TEMPSORU
					DROP TABLE IF EXISTS #INSERT

					BEGIN 

						SET @GUIDDOSYA = (SELECT GUID FROM YYSSinavDosya where ID_YYSSINAVDOSYA=@IDX)
						CREATE TABLE #tmp (
							LINE nvarchar(max)
						);
						BEGIN TRY  
							SET @YOLDOSYA = '\\172.18.194.207\$SinavOptik\YYS\'+@GUIDDOSYA+'.txt'
							SET @SQLDOSYA=	'BULK INSERT #tmp 
											FROM '''+@YOLDOSYA+'''
											WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
							PRINT @SQLDOSYA
							EXEC(@SQLDOSYA) 
						END TRY  
						BEGIN CATCH  
							SET @YOLDOSYA = '\\172.18.194.207\$SinavOptik\YYS\'+@GUIDDOSYA+'.dat'
							SET @SQLDOSYA=	'BULK INSERT #tmp
											FROM '''+@YOLDOSYA+'''
											WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
							EXEC(@SQLDOSYA) 
						END CATCH 				
					END	
				
					;WITH TEMP AS (
						SELECT LINE, ROW_NUMBER () OVER(ORDER BY LINE) ID
						FROM #tmp
					)
					SELECT T.ID, SUBSTRING(T.LINE, BASLANGIC, KARAKTERSAYISI) DEGER, O.AD
					INTO #TEMP7
					FROM TEMP		T
					CROSS APPLY YYSOptik	O	
					WHERE O.ID_YYSSINAV = @ID_YYSSINAV
				
					DECLARE @INSERT TABLE (ID_YYSOGRENCI INT, ID INT)
					MERGE INTO YYSOgrenci 
					USING 
					(
						SELECT	 ID_YYSSINAV	= @ID_YYSSINAV
								,ID_YYSSINAVDOSYA = @IDX
								,A.ID
								,AD				= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'AD')
								,SOYAD			= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'SOYAD')
								,DOGUMTARIHI	= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'DOGUMTARIHI')
								,SINIF			= (SELECT TOP 1 DEGER FROM #TEMP7 T WHERE T.ID = A.ID AND T.AD = 'SINIF')
						FROM #TEMP7 A
						GROUP BY ID
					)
					AS TEMP ON 1 = 0
					WHEN NOT MATCHED THEN
						INSERT (ID_YYSSINAV, ID_YYSSINAVDOSYA, AD, SOYAD, DOGUMTARIHI, SINIF)
						VALUES (TEMP.ID_YYSSINAV, TEMP.ID_YYSSINAVDOSYA, TEMP.AD, TEMP.SOYAD, TEMP.DOGUMTARIHI, TEMP.SINIF)
						OUTPUT TEMP.ID, inserted.ID_YYSOGRENCI
						INTO @INSERT (ID, ID_YYSOGRENCI);

					SELECT * 
					INTO #INSERT
					FROM @INSERT
				
					SELECT	 
						 A.DEGER
						,ID_YYSDERS
						,ID_YYSOGRENCI
						,SORUSAYISI = (SELECT COUNT(1) FROM YYSSoru S WHERE S.ID_YYSDERS = D.ID_YYSDERS)
						,RN			= ROW_NUMBER() OVER(ORDER BY A.ID)
					INTO #TEMPSORU
					FROM #TEMP7 A
					JOIN YYSOptik	O	ON	O.AD			= A.AD
					JOIN YYSDers	D	ON	D.AD			= O.AD
										AND D.ID_YYSSINAV	= O.ID_YYSSINAV
					JOIN #INSERT	I	ON	I.ID			= A.ID
					WHERE	O.SABIT			= 0
						AND D.ID_YYSSINAV	= @ID_YYSSINAV				

					WHILE EXISTS (SELECT TOP 1 1 FROM #TEMPSORU)
					BEGIN
						DECLARE @RN INT, @SORUSAYISI INT, @COUNTSORU INT = 1
						SELECT TOP 1 
							 @RN		= RN
							,@SORUSAYISI= SORUSAYISI
						FROM #TEMPSORU 
						ORDER BY RN

						WHILE @COUNTSORU < @SORUSAYISI + 1 
						BEGIN
						
							INSERT INTO YYSOgrenciCevap (ID_YYSOGRENCI, ID_YYSSORU, CEVAP, DURUM)
							SELECT DISTINCT
								 T.ID_YYSOGRENCI
								,S.ID_YYSSORU
								,ISNULL(SUBSTRING(DEGER, @COUNTSORU, 1), '---') CEVAP
								,CASE WHEN ISNULL(SUBSTRING(DEGER, @COUNTSORU, 1), '---') = S.CEVAP THEN 1 ELSE 0 END
							FROM #TEMPSORU	T
							JOIN YYSSoru	S	ON	S.ID_YYSDERS = T.ID_YYSDERS
							WHERE	RN		= @RN
								AND S.SORUNO= @COUNTSORU

							SET @COUNTSORU = @COUNTSORU + 1

						END
					
						DELETE FROM #TEMPSORU WHERE RN = @RN
					END
								
					INSERT INTO YYSOgrenciSonuc (ID_YYSOGRENCI, ID_YYSDERS, PUAN)
					SELECT DISTINCT YO.ID_YYSOGRENCI, S.ID_YYSDERS, SUM(CAST(DURUM AS INT)) AS PUAN
					FROM YYSOgrenci			YO
					JOIN YYSOgrenciCevap	YOC	ON	YOC.ID_YYSOGRENCI	= YO.ID_YYSOGRENCI
					JOIN YYSSoru			S	ON	S.ID_YYSSORU		= YOC.ID_YYSSORU
					WHERE YO.ID_YYSSINAVDOSYA = @IDX
					GROUP BY YO.ID_YYSOGRENCI, S.ID_YYSDERS

					DROP TABLE IF EXISTS #tmp
					DROP TABLE IF EXISTS #TEMP7
					DROP TABLE IF EXISTS #TEMPSORU
					DROP TABLE IF EXISTS #INSERT

				END

			END

			IF @ISLEM = 8	--	SINAV DOSYA LİSTELE	
			BEGIN
				SELECT
				(
					SELECT	 ID_YYSSINAV		= S.ID_YYSSINAV
							,ID_YYSSINAVDOSYA	= S.ID_YYSSINAVDOSYA
							,DOSYAAD			= S.AD
							,ADSOYAD			= CONCAT_WS(' ', K.AD, K.SOYAD)
							,OGRENCISAYISI		= ISNULL((SELECT COUNT(1) FROM YYSOgrenci SO WHERE SO.ID_YYSSINAVDOSYA = S.ID_YYSSINAVDOSYA),0)
					FROM YYSSinavDosya	S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					WHERE	S.ID_YYSSINAV	= @ID_YYSSINAV
						AND S.ID_SUBE		= @ID_SUBE
						AND S.AKTIF			= 1
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 9	--	SINAV KARNE			
			BEGIN
			
				DROP TABLE IF EXISTS #TEMP9

				SELECT DISTINCT 
					 ID_YYSOGRENCI	= O.ID_YYSOGRENCI
					,AD				= O.AD
					,SOYAD			= O.SOYAD
					,DOGUMTARIHI	= CONVERT(VARCHAR, O.DOGUMTARIHI, 104)
					,SINIF			= O.SINIF
					,SINAVTARIHI	= CONVERT(VARCHAR, SD.KYE_TARIH, 104)
					,ID_YYSDERS		= OS.ID_YYSDERS
					,PUAN			= OS.PUAN
					,DERSNO			= ROW_NUMBER() OVER(PARTITION BY O.ID_YYSOGRENCI ORDER BY D.DERSNO)
					,DERSAD			= D.AD
					,DUZEY			= CASE WHEN DU.DUZEY IS NOT NULL THEN CAST(DU.DUZEY AS varchar) + '. DÜZEY' ELSE '' END
					,ACIKLAMA		= ISNULL(DU.ACIKLAMA, '')
				INTO #TEMP9
				FROM YYSSinav			S
				JOIN YYSSinavDosya		SD	ON	SD.ID_YYSSINAV		= S.ID_YYSSINAV
				JOIN YYSOgrenci			O	ON	O.ID_YYSSINAVDOSYA	= SD.ID_YYSSINAVDOSYA
				JOIN YYSOgrenciSonuc	OS	ON	OS.ID_YYSOGRENCI	= O.ID_YYSOGRENCI
				JOIN YYSDers			D	ON	D.ID_YYSDERS		= OS.ID_YYSDERS
				LEFT JOIN YYSDuzey		DU	ON	DU.ID_YYSDERS		= D.ID_YYSDERS
											AND DU.DUZEY			= OS.PUAN
				WHERE SD.ID_YYSSINAVDOSYA IN (SELECT VALUE FROM OPENJSON(@ID_YYSSINAVDOSYALIST))
				ORDER BY AD, SOYAD, ID_YYSDERS

				SELECT DISTINCT ID_YYSOGRENCI, AD, SOYAD, DOGUMTARIHI, SINIF = SINIF + ' Sınıf', SINAVTARIHI FROM #TEMP9

				--SELECT DISTINCT ID_YYSDERS, DERSAD FROM #TEMP9

				SELECT	 ID_YYSOGRENCI
						,ID_YYSDERS
						,PUAN
						,DERSNO
						,DERSAD
						,DUZEY
						,ACIKLAMA
				FROM #TEMP9
				
				DROP TABLE IF EXISTS #TEMP9
			END

			IF @ISLEM = 10	--	SINAV DOSYA SİL		
			BEGIN

				UPDATE YYSSinavDosya SET
					SIL_TCKIMLIKNO	= @TCKIMLIKNO,
					SIL_TARIH		= GETDATE(),
					AKTIF			= 0
				WHERE ID_YYSSINAVDOSYA = @ID_YYSSINAVDOSYA

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_ProjeDonem]...';


GO
ALTER procedure [dbo].[sp_ProjeDonem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@TC					VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@SINIFTIP			varchar(50)		= NULL,
	@ID_PROJETALEP		int				= NULL,
	@ID_PROJEDOSYA		int				= NULL,
	@ID_KULLANICI		int				= NULL,
	@ID_OGRENCI			int				= NULL,
	@SIRA				int				= NULL,
	@KRITER				int				= NULL,
	@DEGER				int				= NULL,
	@DURUM				int				= NULL,
	@YARIYIL			int				= 1,
	@DOSYA				NVARCHAR(MAX)	= NULL,
	@KONU				NVARCHAR(MAX)	= NULL,
	@KONTROL			NVARCHAR(MAX)	= NULL,
	@KONTROLTARIH		NVARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,TC							= @TC				
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_DERS					= @ID_DERS		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAGUID					= @DOSYAGUID		
			,SINIFTIP					= @SINIFTIP		
			,ID_PROJETALEP				= @ID_PROJETALEP	
			,ID_PROJEDOSYA				= @ID_PROJEDOSYA	
			,ID_KULLANICI				= @ID_KULLANICI	
			,ID_OGRENCI					= @ID_OGRENCI		
			,SIRA						= @SIRA			
			,KRITER						= @KRITER			
			,DEGER						= @DEGER			
			,DURUM						= @DURUM			
			,YARIYIL					= @YARIYIL		
			,DOSYA						= @DOSYA			
			,KONU						= @KONU			
			,KONTROL					= @KONTROL		
			,KONTROLTARIH				= @KONTROLTARIH	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)


	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1		-- KADEME
		BEGIN
			SELECT (
				SELECT TOP 1  kk.ID_KADEME
				FROM		OkyanusDB.dbo.v3Kullanici				K
				INNER JOIN	OkyanusDB.dbo.v4KullaniciKademe	kk	on	kk.TCKIMLIKNO = k.TCKIMLIKNO	
				WHERE K.TCKIMLIKNO = @TCKIMLIKNO and kk.ID_KADEME != 1 AND K.AKTIF = 1
				FOR JSON PATH
			)
		END

		
		IF @ISLEM = 2		-- SINIF DERS LİSTESİ				
		BEGIN
			--if @SINIFTIP='nor'			
			IF NOT EXISTS(SELECT TOP 1 1 FROM eokul_v2.DBO.KurSinifi WHERE ID_KUR = @ID_SINIF)
			begin
				SELECT(
					SELECT (
						SELECT  distinct
										sd.ID_DERS,
										d.DERSAD as DERSAD
						FROM		eokul_v2.dbo.DersOgretmen	sd
						inner join	OkyanusDB.dbo.v3Sinif		snf on	snf.ID_SINIF	= sd.ID_SINIF
						inner join	eokul_v2.dbo.Ders		d	on	d.ID_DERS		= sd.ID_DERS
						 left join	OkyanusDB.dbo.v3EgitimTuru	e	on	e.ID_EGITIMTURU	= sd.ID_EGITIMTURU
						WHERE SD.ID_SINIF	= @ID_SINIF 
						  AND DONEMKOD		= @AKTIFDONEM
						  AND e.ID_EGITIMTURU = 6
						ORDER BY DERSAD				
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end
			else --if @SINIFTIP='kur'
			begin
				SELECT(
					SELECT (
						SELECT distinct						
										sd.ID_DERS,
										d.DERSAD as DERSAD
						FROM eokul_v2.dbo.DersOgretmen sd
						inner join eokul_v2.dbo.KurSinifi snf on snf.ID_KUR=sd.ID_SINIF
						inner join eokul_v2.dbo.Ders d on d.ID_DERS=sd.ID_DERS
						 left join OkyanusDB.dbo.v3EgitimTuru e on e.ID_EGITIMTURU=sd.ID_EGITIMTURU
						WHERE SD.ID_SINIF=@ID_SINIF 
						  AND snf.DONEMKOD=@AKTIFDONEM 
						  and snf.AKTIF=1
						  AND e.ID_EGITIMTURU = 6
						  --AND d.AKTIF=1
						ORDER BY DERSAD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end
		END
				
		IF @ISLEM = 4		-- PROJE DURUM UPDATE				
		BEGIN	
			SET @ID_KULLANICI = ( SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)

			Update Pusulam.dbo.ProjeTalep Set  
				 DURUM			= @DURUM
				,ID_KULLANICI	= @ID_KULLANICI
				,KAYIT_TARIHI	= GETDATE() 
			where ID_PROJETALEP=@ID_PROJETALEP		
			select 1	
		END

		--OgretmenProjeTalepleri
		IF @ISLEM = 6		-- BRANŞ ÖĞRETMEN SINIF LİSTESİ		
		BEGIN
			IF @TC_OGRETMEN IS NULL OR @TC_OGRETMEN = ''
				SET @TC =(SELECT TCKIMLIKNO FROM OkyanusDB.dbo.v3Kullanici where OTURUM=@OTURUM)
			ELSE
				SET @TC = @TC_OGRETMEN


			--IF @ID_SINIF>70000			
			IF NOT EXISTS(SELECT TOP 1 1 FROM eokul_v2.DBO.KurSinifi WHERE ID_KUR = @ID_SINIF)
			BEGIN		
				SELECT(
					SELECT (					
						Select   
							ID_OGRENCI			= o.ID_OGRENCI,
							ADSOYAD				= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							FOTOGRAF			= isnull(Cast(r.FOTOGRAF AS VARBINARY(MAX)) ,0) ,
							OGRNO				= CAST(o.OgrNo AS VARCHAR),
							ID_SINIF			= sn.ID_SINIF,
							SINIFAD				= sn.AD,
							ID_DERS				= p.ID_DERS,
							KONU				= isnull(p.KONU,''),
							DURUM				= p.DURUM,
							DURUMACIKLAMA			= case when p.DURUM=0 then ''
													when p.DURUM=1 then 'Talebiniz alındı'
													when p.DURUM=2 then 'Kabul Edildi'
													when p.DURUM=3 then 'Reddedildi'
													end,
							ID_PROJETALEP		= p.ID_PROJETALEP ,
							KONTROLBIR			= isnull(pp.KONTROLBIR,''),
							KONTROLBIRTARIH		= isnull(pp.KONTROLBIRTARIH,''),
							KONTROLIKI			= isnull(pp.KONTROLIKI,''),
							KONTROLIKITARIH		= isnull(pp.KONTROLIKITARIH,''),
							KONTROLUC			= isnull(pp.KONTROLUC,''),
							KONTROLUCTARIH		= isnull(pp.KONTROLUCTARIH,''),
							KONTROLDORT			= isnull(pp.KONTROLDORT,''),
							KONTROLDORTTARIH	= isnull(pp.KONTROLDORTTARIH,''),
							PROJENOT			= isnull(pp.PROJENOT,0),
							PROJEDEGERLENDIRME	= isnull(pp.PROJEDEGERLENDIRME,''),
							DERSAD				= de.DERSAD,
							PLANOLUSTURMA		= isnull(pp.PLANOLUSTURMA,0),
							KAYNAKKULLANIM		= isnull(pp.KAYNAKKULLANIM,0),
							ISBIRLIGI			= isnull(pp.ISBIRLIGI,0),
							DILKULLANIM			= isnull(pp.DILKULLANIM,0),
							KAVRAMA				= isnull(pp.KAVRAMA,0),
							DERECE				= isnull(pp.DERECE,''),
							SIRA				= isnull(p.SIRA,0)
						from Pusulam.dbo.ProjeTalep p 
							inner join OkyanusDB.dbo.v3Ogrenci     o	on	p.ID_OGRENCI	= o.ID_OGRENCI
							inner join OkyanusDB.dbo.v3Donem       dn	on	dn.ID_DONEM		= o.ID_DONEM 
							inner join OkyanusDB.dbo.v3Kullanici   b	on	b.TCKIMLIKNO	= o.TCKIMLIKNO
							left join  Pusulam.dbo.ProjeNot			pp	on	pp.ID_PROJETALEP= p.ID_PROJETALEP
							left join  OkyanusDB.dbo.v3Resim		r	on	r.TCKIMLIKNO	= b.TCKIMLIKNO
							inner join OkyanusDB.dbo.v3Sinif       sn	on	sn.ID_SINIF		= p.ID_SINIF
							inner join eokul_v2.dbo.Ders			de	on	de.ID_DERS		= p.ID_DERS
							WHERE	p.ID_SINIF	= @ID_SINIF 
								and dn.KOD		= @AKTIFDONEM
								and p.YARIYIL	= @YARIYIL
								and
								  (((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC and ID_KULLANICITIPI  in (3,27,28,59))>0 and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen do  where do.TC_OGRETMEN=@TC and do.ID_SINIF=@ID_SINIF)) or
								   ((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC and ID_KULLANICITIPI  in (53,54))>0 and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen))
								  )
						order by b.AD,b.Soyad		
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS

				

			END
			ELSE
			BEGIN
			
				SELECT(
					SELECT (
					
						Select   
							ID_OGRENCI			= o.ID_OGRENCI,
							ADSOYAD				= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							FOTOGRAF			= isnull(Cast(r.FOTOGRAF AS VARBINARY(MAX)) ,0) ,
							OGRNO				= CAST(o.OgrNo AS VARCHAR),
							ID_SINIF			= S.ID_KUR,
							SINIFAD				= s.KURSINIFI,
							ID_DERS				= p.ID_DERS,
							KONU				= isnull(p.KONU,''),
							DURUM				= p.DURUM,
							DURUMACIKLAMA			= case when p.DURUM=0 then ''
													when p.DURUM=1 then 'Talebiniz alındı'
													when p.DURUM=2 then 'Kabul Edildi'
													when p.DURUM=3 then 'Reddedildi'
													end,
							ID_PROJETALEP		= p.ID_PROJETALEP ,
							KONTROLBIR			= isnull(pp.KONTROLBIR,''),
							KONTROLBIRTARIH		= isnull(pp.KONTROLBIRTARIH,''),
							KONTROLIKI			= isnull(pp.KONTROLIKI,''),
							KONTROLIKITARIH		= isnull(pp.KONTROLIKITARIH,''),
							KONTROLUC			= isnull(pp.KONTROLUC,''),
							KONTROLUCTARIH		= isnull(pp.KONTROLUCTARIH,''),
							KONTROLDORT			= isnull(pp.KONTROLDORT,''),
							KONTROLDORTTARIH	= isnull(pp.KONTROLDORTTARIH,''),
							PROJENOT			= isnull(pp.PROJENOT,0),
							PROJEDEGERLENDIRME	= isnull(pp.PROJEDEGERLENDIRME,''),
							DERSAD				= de.DERSAD,
							PLANOLUSTURMA		= isnull(pp.PLANOLUSTURMA,0),
							KAYNAKKULLANIM		= isnull(pp.KAYNAKKULLANIM,0),
							ISBIRLIGI			= isnull(pp.ISBIRLIGI,0),
							DILKULLANIM			= isnull(pp.DILKULLANIM,0),
							KAVRAMA				= isnull(pp.KAVRAMA,0),
							DERECE				= isnull(pp.DERECE,''),
							SIRA				= isnull(p.SIRA,0)
						from eokul_v2.DBO.KurSinifi		s 
						inner join eokul_v2.DBO.KurOgrenci		k	on	k.ID_KUR		= s.ID_KUR
						inner join OkyanusDB.dbo.v3Ogrenci     o	on	k.ID_OGRENCI	= o.ID_OGRENCI
						inner join OkyanusDB.dbo.v3Kullanici   b	on	b.TCKIMLIKNO	= o.TCKIMLIKNO
						inner join Pusulam.dbo.ProjeTalep		p	on	p.ID_OGRENCI	= o.ID_OGRENCI
						left join  Pusulam.dbo.ProjeNot		pp  on	pp.ID_PROJETALEP= p.ID_PROJETALEP
						left join  OkyanusDB.dbo.v3Resim		r	on	r.TCKIMLIKNO	= b.TCKIMLIKNO
						inner join eokul_v2.dbo.Ders		de	on	de.ID_DERS		= p.ID_DERS
						WHERE	s.ID_KUR	= @ID_SINIF 						
							and p.YARIYIL	= @YARIYIL
							and s.AKTIF		<>0  
							and
								(((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC 
																				and ID_KULLANICITIPI  in (3,27,28,59))>0 
																				and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen do  where do.ID_OGRETMEN in (Select ID_OGRETMEN from OkyanusDB.dbo.v3Ogretmen where TCKIMLIKNO=@TC) and do.ID_SINIF=@ID_SINIF)) or
								((Select Count(1) from OkyanusDB.dbo.v3SubeYetki where TCKIMLIKNO=@TC 
																				and ID_KULLANICITIPI  in (53,54))>0 
																				and p.ID_DERS in (Select ID_DERS from eokul_v2.DBO.DersOgretmen)))
						order by b.AD,b.Soyad					
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			END
		END

		--ProjeKontrol
		IF @ISLEM = 8		-- KONTROL KAYIT UPDATE				
		BEGIN
			
			IF (Select COUNT(1) from Pusulam.dbo.ProjeNot where ID_PROJETALEP=@ID_PROJETALEP)=0
			BEGIN
				INSERT INTO Pusulam.dbo.ProjeNot(ID_PROJETALEP)
				Values(@ID_PROJETALEP)
			END
			
			Update p 
			Set 
				 KONTROLBIR			= case when @SIRA = 1 then @KONTROL else p.KONTROLBIR end
				,KONTROLBIRTARIH	= case when @SIRA = 1 then @KONTROLTARIH else p.KONTROLBIRTARIH end
					
				,KONTROLIKI			= case when @SIRA = 2 then @KONTROL else p.KONTROLIKI end
				,KONTROLIKITARIH	= case when @SIRA = 2 then @KONTROLTARIH else p.KONTROLIKITARIH end

				,KONTROLUC			= case when @SIRA = 3 then @KONTROL else p.KONTROLUC end
				,KONTROLUCTARIH		= case when @SIRA = 3 then @KONTROLTARIH else p.KONTROLUCTARIH end

				,KONTROLDORT		= case when @SIRA = 4 then @KONTROL else p.KONTROLDORT end
				,KONTROLDORTTARIH	= case when @SIRA = 4 then @KONTROLTARIH else p.KONTROLDORTTARIH end

				,PROJEDEGERLENDIRME	= case when @SIRA = 5 then @KONTROL else p.PROJEDEGERLENDIRME end

			from Pusulam.dbo.ProjeNot p	
			where ID_PROJETALEP=@ID_PROJETALEP
			
			SELECT 1
		END
		
		IF @ISLEM = 10		-- ÖĞRENCİ PROJE TALEP LİSTESİ		
		BEGIN
		-- exec sp_ProjeDonem @TCKIMLIKNO='11198554824',@OTURUM='74AFE741-2F2C-44E4-A6DF-AEA4DCE0DC0A',@YARIYIL=1, @ISLEM=10

		
			IF @ID_OGRENCI = 0 or @ID_OGRENCI IS NULL
			BEGIN
				Set @TC=(Select TCKIMLIKNO from OkyanusDB.dbo.v3Kullanici where OTURUM=@OTURUM)
			END
			ELSE
			BEGIN
				Set @TC=(Select TCKIMLIKNO from OkyanusDB.dbo.v3Ogrenci where ID_OGRENCI=@ID_OGRENCI) 
			END

			IF @TC_OGRENCI != '' AND @TC_OGRENCI IS NOT NULL
			BEGIN
				Set @TC=@TC_OGRENCI
			END
			
			SELECT(
				SELECT (
					Select   
						--ID_OGRENCI			= o.ID_OGRENCI,
						--ID_DERS				= d.ID_DERS,
						DERSAD				= d.DERSAD ,
						KONU				= isnull(p.KONU,''),
						OGRETMENADSOYAD		= isnull(k.AD + ' ' +k.SOYAD,''),
						ID_PROJETALEP		= isnull(p.ID_PROJETALEP,0),
						KONTROLBIR			= isnull(pp.KONTROLBIR,''),
						KONTROLBIRTARIH		= isnull(pp.KONTROLBIRTARIH,''),
						KONTROLIKI			= isnull(pp.KONTROLIKI,''),
						KONTROLIKITARIH		= isnull(pp.KONTROLIKITARIH,''),
						KONTROLUC			= isnull(pp.KONTROLUC,''),
						KONTROLUCTARIH		= isnull(pp.KONTROLUCTARIH,''),
						KONTROLDORT			= isnull(pp.KONTROLDORT,''),
						KONTROLDORTTARIH	= isnull(pp.KONTROLDORTTARIH,''),
						--PROJENOT			= isnull(pp.PROJENOT,0),
						--DURUM				= isnull(p.DURUM,5),
						PROJEDEGERLENDIRME	= isnull(pp.PROJEDEGERLENDIRME,''),
						DOSYADURUM			= case when (Select COUNT(1) from ProjeDosya where ID_PROJETALEP=p.ID_PROJETALEP and SILINDI=0)>0 then 1 else 0 end,
						kk3.ID_KADEME
					from		OkyanusDB.dbo.v3Ogrenci		o 
					inner join	OkyanusDB.dbo.v3Sinif		sn	on	sn.ID_SINIF		= o.ID_SINIF
					left join	ProjeTalep					p	on	p.ID_OGRENCI	= o.ID_OGRENCI 
					left join	ProjeNot					pp  on	pp.ID_PROJETALEP= p.ID_PROJETALEP
					left join	OkyanusDB.dbo.v3Kullanici	k	on	k.TCKIMLIKNO	= p.TC_OGRETMEN
					inner join	eokul_v2.dbo.Ders			d	on	d.ID_DERS		= p.ID_DERS 
					inner join  v3KullaniciKademe3			kk3	on	kk3.TCKIMLIKNO	= o.TCKIMLIKNO
					WHERE	o.TCKIMLIKNO	= @TC
						and p.DURUM			= 2
						and p.YARIYIL		= @YARIYIL
						--and p.ID_PROJETALEP = @ID_PROJETALEP
					order by p.SIRA	
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS SS
			         
	
		END	
		
		--ProjeSinifListesi
		IF @ISLEM = 14		-- BR/DN ÖĞRETMEN KONTROL FORMU		
		BEGIN
			
			--if @SINIFTIP='nor'
			IF NOT EXISTS(SELECT TOP 1 1 FROM eokul_v2.DBO.KurSinifi WHERE ID_KUR = @ID_SINIF)
			begin	
				SELECT(
					SELECT (
						Select   
							ID_OGRENCI		= o.ID_OGRENCI,
							ADSOYAD			= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							OGRNO			= o.OGRNO,
							ID_SINIF		= sn.ID_SINIF,
							SINIFAD			= sn.AD,
							ID_PROJETALEP1	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP desc),0) ,
							DERSAD1			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							ID_DERS1		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							KONU1			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,				   
							DURUM1			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),5) ,	
							-----
							ID_PROJETALEP2	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),0) ,
							DERSAD2			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,
							ID_DERS2		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP),'') ,
							KONU2			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,				   
							DURUM2			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),5) ,	
							------
							ID_PROJETALEP3	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),0) ,
							DERSAD3			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,
							ID_DERS3		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP),'') ,
							KONU3			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,				   
							DURUM3			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP4	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),0) ,
							DERSAD4			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,
							ID_DERS4		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP),'') ,
							KONU4			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,				   
							DURUM4			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP5	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),0),
							DERSAD5			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,
							ID_DERS5		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP),'') ,
							KONU5			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,				   
							DURUM5			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),5) 
						from OkyanusDB.dbo.v3Ogrenci	o
						join OkyanusDB.dbo.v3Kullanici	b	on	b.TCKIMLIKNO=o.TCKIMLIKNO
						join OkyanusDB.dbo.v3Sinif		sn	on	sn.ID_SINIF=o.ID_SINIF	   
						WHERE	o.ID_SINIF = @ID_SINIF 
						order by b.AD,b.Soyad 
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end
			else --if @SINIFTIP='kur'
			begin
				SELECT(
					SELECT (
						SELECT   distinct
							ID_OGRENCI		= o.ID_OGRENCI,
							ADSOYAD			= isnull(b.Ad,'')+' '+isnull(b.Soyad,''),
							OGRNO			= KO.OGRNO,
							ID_SINIF		= sn.ID_KUR,
							SINIFAD			= sn.KURSINIFI,
							-----
							ID_PROJETALEP1	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP desc),0) ,
							DERSAD1			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							ID_DERS1		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,
							KONU1			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),'') ,				   
							DURUM1			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=0 order by ID_PROJETALEP),5) ,	
							-----
							ID_PROJETALEP2	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),0) ,
							DERSAD2			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,
							ID_DERS2		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP),'') ,
							KONU2			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),'') ,				   
							DURUM2			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=1 order by ID_PROJETALEP desc),5) ,	
							------
							ID_PROJETALEP3	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),0) ,
							DERSAD3			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,
							ID_DERS3		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP),'') ,
							KONU3			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),'') ,				   
							DURUM3			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=2 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP4	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),0) ,
							DERSAD4			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,
							ID_DERS4		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP),'') ,
							KONU4			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),'') ,				   
							DURUM4			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=3 order by ID_PROJETALEP desc),5) ,
							------
							ID_PROJETALEP5	= isnull((Select top 1 ID_PROJETALEP from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),0),
							DERSAD5			= isnull((Select top 1 (Select DERSAD from eokul_v2.dbo.Ders where ID_DERS=p.ID_DERS) from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,
							ID_DERS5		= isnull((Select top 1 ID_DERS from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP),'') ,
							KONU5			= isnull((Select top 1 KONU from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),'') ,				   
							DURUM5			= isnull((Select top 1 DURUM from Pusulam.dbo.ProjeTalep p where p.ID_OGRENCI=o.ID_OGRENCI and p.YARIYIL=@YARIYIL and SIRA=4 order by ID_PROJETALEP desc),5) 
						from eokul_V2.dbo.KurOgrenci	o
						join eokul_V2.dbo.KurSinifi		sn	on	sn.ID_KUR		= o.ID_KUR
						JOIN OkyanusDB.dbo.v3Ogrenci	ko	ON	KO.ID_OGRENCI	= O.ID_OGRENCI
						join OkyanusDB.dbo.v3Kullanici	b	on	b.TCKIMLIKNO	= Ko.TCKIMLIKNO	   
						WHERE	o.ID_KUR=@ID_SINIF and sn.AKTIF<>0
						order by ADSOYAD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SS
			end	
		END	
		
		IF @ISLEM = 16		-- PROJE DOSYA EKLE					
		BEGIN			 
			SET @ID_KULLANICI = (SELECT ID_KULLANICI FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)
			 
			Insert Into Pusulam.dbo.ProjeDosya(ID_PROJETALEP,DOSYA,DOSYAGUID,ID_KULLANICI,GUID)
			Values(@ID_PROJETALEP,@DOSYA,@DOSYAGUID,@ID_KULLANICI,'')

		END

		IF @ISLEM = 17		-- PROJE DOSYA SİL					
		BEGIN
			Update Pusulam.dbo.ProjeDosya Set SILINDI=1 where ID_PROJEDOSYA=@ID_PROJEDOSYA

			select 1
		END
				
		IF @ISLEM = 18		-- PROJE DOSYA LİSTELE				
		BEGIN						
			SELECT(
				SELECT (
					Select PT.KONU,PD.DOSYA, PD.ID_PROJETALEP, PD.ID_PROJEDOSYA
					from Pusulam.dbo.ProjeDosya PD 
					join Pusulam.dbo.ProjeTalep PT	on	PT.ID_PROJETALEP	= PD.ID_PROJETALEP
					where	SILINDI			= 0 
						and pt.ID_PROJETALEP= @ID_PROJETALEP
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS SS
		END
		
		IF @ISLEM = 20		-- PROJE TALEP EKLEME				
		BEGIN			
			SET @ID_KULLANICI =( SELECT ID_KULLANICI FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO) 	
			IF @ID_OGRENCI IS NULL OR @ID_OGRENCI = 0
			BEGIN
				SET @ID_OGRENCI =( SELECT ID_OGRENCI FROM OkyanusDB.DBO.v3Ogrenci WHERE TCKIMLIKNO = @TC_OGRENCI) 	
			END
			ELSE
			BEGIN
				SET @TC_OGRENCI =( SELECT TCKIMLIKNO FROM OkyanusDB.DBO.v3Ogrenci WHERE ID_OGRENCI = @ID_OGRENCI) 	
			END 

			SET @TC_OGRETMEN = (
									select DISTINCT o.TCKIMLIKNO 
									FROM ProjeTalep P
									JOIN eokul_v2.DBO.DersOgretmen DO ON DO.ID_DERS		= P.ID_DERS AND DO.ID_SINIF= P.ID_SINIF
									JOIN OkyanusDB.DBO.v3Ogretmen  O  ON O.ID_OGRETMEN  = DO.ID_OGRETMEN 
									WHERE	p.ID_SINIF			= @ID_SINIF
										AND P.ID_DERS			= @ID_DERS
										AND DO.ID_EGITIMTURU	= 6
								)


			IF (Select COUNT(1) from Pusulam.dbo.ProjeTalep where ID_PROJETALEP=@ID_PROJETALEP)>0 AND 0<>@ID_PROJETALEP
			BEGIN
					Update Pusulam.dbo.ProjeTalep Set DURUM=1,KONU=@KONU where ID_PROJETALEP=@ID_PROJETALEP
					--Set @ID_PROJETALEP=(Select ID_PROJETALEP from Pusulam.dbo.ProjeTalep where ID_OGRENCI=@ID_OGRENCI and SIRA=@SIRA)			
			END
			ELSE
			BEGIN
					Insert Into Pusulam.dbo.ProjeTalep(ID_SINIF,ID_OGRENCI,ID_DERS,KONU,DURUM,SIRA,ID_KULLANICI,YARIYIL,TC_OGRENCI,TC_OGRETMEN)
					Values(@ID_SINIF,@ID_OGRENCI,@ID_DERS,@KONU,1,@SIRA,@ID_KULLANICI,@YARIYIL,@TC_OGRENCI,@TC_OGRETMEN)	
					Set @ID_PROJETALEP=SCOPE_IDENTITY()					
			END	

			IF @DOSYAGUID IS NOT NULL OR @DOSYAGUID <> ''
			BEGIN
				Update Pusulam.dbo.ProjeDosya Set ID_PROJETALEP=@ID_PROJETALEP where DOSYAGUID=@DOSYAGUID
			END
			Select @ID_PROJETALEP
		END
		
		IF @ISLEM = 21		-- PROJE TALEP SİLME				
		BEGIN	
			SET @ID_KULLANICI = (SELECT ID_KULLANICI FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)
			Insert Into Pusulam.dbo.ProjeTalepSil(ID_PROJETALEP,ID_KULLANICI,SILINMETARIHI,ID_DERS,SIRA,DURUM,ID_OGRENCI,YARIYIL)
			Select ID_PROJETALEP,@ID_KULLANICI,GETDATE(),ID_DERS,SIRA,DURUM,ID_OGRENCI,YARIYIL from Pusulam.dbo.ProjeTalep where ID_PROJETALEP=@ID_PROJETALEP

			Delete from Pusulam.dbo.ProjeTalep where ID_PROJETALEP=@ID_PROJETALEP		
			Update Pusulam.dbo.ProjeDosya Set SILINDI=1 where ID_PROJETALEP=@ID_PROJETALEP
	
			Select 1
		END
		
		IF @ISLEM = 22		-- PROJE NOT EKLE					
		BEGIN
			IF (Select Count(1) from  Pusulam.dbo.ProjeNot where ID_PROJETALEP=@ID_PROJETALEP)=0
			BEGIN
				Insert Into  Pusulam.dbo.ProjeNot(ID_PROJETALEP) Values(@ID_PROJETALEP)
			END

			Update P 
			Set 				
				 PLANOLUSTURMA	= CASE WHEN @KRITER = 1 THEN @DEGER ELSE P.PLANOLUSTURMA	END
				,KAYNAKKULLANIM	= CASE WHEN @KRITER = 2 THEN @DEGER ELSE P.KAYNAKKULLANIM	END
				,ISBIRLIGI		= CASE WHEN @KRITER = 3 THEN @DEGER ELSE P.ISBIRLIGI		END
				,DILKULLANIM	= CASE WHEN @KRITER = 4 THEN @DEGER ELSE P.DILKULLANIM		END
				,KAVRAMA		= CASE WHEN @KRITER = 5 THEN @DEGER ELSE P.KAVRAMA			END
			FROM Pusulam.dbo.ProjeNot P
			where ID_PROJETALEP=@ID_PROJETALEP
			
			DECLARE @PROJENOT INT = (Select SUM(PLANOLUSTURMA+KAYNAKKULLANIM+ISBIRLIGI+DILKULLANIM+KAVRAMA) * 5 from Pusulam.dbo.ProjeNot where ID_PROJETALEP=@ID_PROJETALEP)

			Update	Pusulam.dbo.ProjeNot 
			Set		PROJENOT= @PROJENOT, 
					DERECE	= CASE 
								WHEN @PROJENOT < 50 THEN 'Geçmez'
								WHEN @PROJENOT > 49 and @PROJENOT < 60 THEN 'Geçer'
								WHEN @PROJENOT > 59 and @PROJENOT < 70 THEN 'Orta'
								WHEN @PROJENOT > 69 and @PROJENOT < 85 THEN 'İyi'
								WHEN @PROJENOT > 84 and @PROJENOT < 101 THEN 'Pekiyi'
								END
			where ID_PROJETALEP=@ID_PROJETALEP

			select 1

		END
	

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_ProjeDonemRapor]...';


GO
ALTER procedure [dbo].[sp_ProjeDonemRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIFs			NVARCHAR(MAX)	= NULL,
	@YARIYIL			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINIFs					= @ID_SINIFs	
			,YARIYIL					= @YARIYIL	
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	
		BEGIN
				
			DROP TABLE IF EXISTS #OGRENCILIST
 

			SELECT DISTINCT
					 TCKIMLIKNO			= K.TCKIMLIKNO
					,ADSOYAD			= K.AD+' '+K.SOYAD
					,OGRNO				= O.OGRNO
					,ID_OGRENCI			= O.ID_OGRENCI
					,SUBEAD				= GS.SUBEAD
					,KADEME3			= GS.KADEME3
					,SINIFAD			= GS.SINIF
					,DANISMANOGRETMEN	= ISNULL(OK.AD+' '+OK.SOYAD,'-')
					,ID_KADEME			= GS.ID_KADEME
			INTO #OGRENCILIST
			FROM v3OgrenciTum						O	
			JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN vw_SubeSinifGrupKademeTum			GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN ProjeTalep							PT	ON	PT.ID_OGRENCI	= O.ID_OGRENCI
			LEFT JOIN OkyanusDB.DBO.v3SinifPersonel	SD	ON	SD.ID_SINIF		= O.ID_SINIF AND SD.ID_KULLANICITIPI = 100
			LEFT JOIN v3Kullanici					OK	ON	OK.TCKIMLIKNO	= SD.TCKIMLIKNO
			WHERE GS.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
				AND DURUM = 2	-- PT ONAYLANDI
				AND (	(		GS.ID_KADEME != 5 	
							AND YARIYIL = @YARIYIL
						) 
						OR 
								GS.ID_KADEME = 5 
					)
	
			
			SELECT 
						 TCKIMLIKNO			
						,ADSOYAD			
						,OGRNO				
						,ID_OGRENCI			
						,SUBEAD				
						,KADEME3			
						,SINIFAD			
						,DANISMANOGRETMEN	
						,MAX([A0]) [A0],MAX([K0]) [K0],MAX([O0]) [O0]
						,MAX([A1]) [A1],MAX([K1]) [K1],MAX([O1]) [O1]
						,MAX([A2]) [A2],MAX([K2]) [K2],MAX([O2]) [O2]
						,MAX([A3]) [A3],MAX([K3]) [K3],MAX([O3]) [O3]
						,MAX([A4]) [A4],MAX([K4]) [K4],MAX([O4]) [O4]

			FROM (
				SELECT DISTINCT 
						 OL.TCKIMLIKNO			
						,OL.ADSOYAD			
						,OL.OGRNO				
						,OL.ID_OGRENCI			
						,OL.SUBEAD				
						,OL.KADEME3			
						,OL.SINIFAD			
						,OL.DANISMANOGRETMEN	
						,SDA			= 'A' + CAST(PT.SIRA AS VARCHAR)
						,SDK			= 'K' + CAST(PT.SIRA AS VARCHAR)
						,SDO			= 'O' + CAST(PT.SIRA AS VARCHAR)
						,DERSAD			= D.AD
						,DERSKONU		= PT.KONU
						,DERSOGRETMEN	= ISNULL(K.AD+' '+K.SOYAD,'-')
				FROM #OGRENCILIST		OL
				JOIN ProjeTalep			PT	ON	PT.ID_OGRENCI	= OL.ID_OGRENCI
				JOIN v3Ders				D	ON	D.ID_DERS		= PT.ID_DERS	
				LEFT JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= PT.TC_OGRETMEN
				WHERE DURUM = 2	-- PT ONAYLANDI	
					AND (	(		OL.ID_KADEME != 5 	
								AND PT.YARIYIL = @YARIYIL
							) 
							OR 
									OL.ID_KADEME = 5 
						)
			) AS S 
			PIVOT  ( MAX(DERSAD)		FOR SDA IN ([A0],[A1],[A2],[A3],[A4]) ) AS P
			PIVOT  ( MAX(DERSKONU)		FOR SDK IN ([K0],[K1],[K2],[K3],[K4]) ) AS P
			PIVOT  ( MAX(DERSOGRETMEN)	FOR SDO IN ([O0],[O1],[O2],[O3],[O4]) ) AS P
			GROUP BY	 TCKIMLIKNO			
						,ADSOYAD			
						,OGRNO				
						,ID_OGRENCI			
						,SUBEAD				
						,KADEME3			
						,SINIFAD			
						,DANISMANOGRETMEN	

			
			DROP TABLE IF EXISTS #OGRENCILIST

		END				

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_PuanaGoreYaziliSonuclari]...';


GO

--EXEC	@return_value = [dbo].[sp_PuanaGoreYaziliSonuclari]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_PuanaGoreYaziliSonuclari]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVLAR		VARCHAR(MAX)	= '',
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ID_DERSLER			VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@ID_KADEME3			INT				= 0,
	@YARIYIL			VARCHAR(10)		= '',
	@PUANARALIGI		VARCHAR(MAX)	= '',
	@TC					BIT				= 1
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAVLAR				= @ID_SINAVLAR
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ID_DERSLER					= @ID_DERSLER	
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
			,ID_KADEME3					= @ID_KADEME3	
			,YARIYIL					= @YARIYIL	
			,PUANARALIGI				= @PUANARALIGI
			,TC							= @TC			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			DECLARE @MAXPUAN DECIMAL(6, 2)
			DECLARE @MINPUAN DECIMAL(6, 2)

			IF @ISLEM = 1 OR @ISLEM = 2	--	Toplu Yazılı Yoklama Sunuçları Getir
			BEGIN
				SELECT sr.ID_SINAVRAPOR, 
					   sr.SINAVADI, 
					   su.AD							AS KAMPUS, 
					   sn.AD                            AS SINIF, 
					   k.TCKIMLIKNO, 
					   k.AD + ' ' + k.SOYAD             AS ADSOYAD, 
					   Sum(oo.PUAN)                     AS PUAN 
				INTO   #tablos 
				FROM	   eokul_v2.dbo.SinavRapor		sr 
				INNER JOIN eokul_v2.dbo.OgrenciNot		oo ON oo.ID_SINAVRAPOR = sr.ID_SINAVRAPOR 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci		og ON og.ID_OGRENCI = oo.ID_OGRENCI 
				INNER JOIN OkyanusDB.dbo.v3Sube			su ON su.ID_SUBE = og.ID_SUBE 
				INNER JOIN OkyanusDB.dbo.v3Sinif		sn ON sn.ID_SINIF = oo.ID_SINIF 
				INNER JOIN OkyanusDB.dbo.v3Kullanici	k ON k.TCKIMLIKNO = og.TCKIMLIKNO 
				--INNER JOIN eokul_v2.dbo.Ders			d ON d.ID_DERS = sr.ID_DERS 
				WHERE  sr.DONEMKOD = @DONEM 
					   AND sr.isActive = 1 
					   AND k.AKTIF = 1 
					   AND ( ( sr.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
					   AND ( ( sr.ID_SINAVRAPOR	IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
					   AND ( ( su.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
					   AND ( ( og.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
					   AND ( sr.GRUP = (select AD from OkyanusDB.dbo.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3) OR @ID_KADEME3 = 0 ) 
				GROUP  BY sr.ID_SINAVRAPOR, 
						  sr.SINAVADI, 
						  su.AD, 
						  sn.AD, 
						  k.TCKIMLIKNO, 
						  k.AD, 
						  k.SOYAD 

				SELECT Cast(VALUE AS DECIMAL(6, 2)) AS PUAN 
				INTO   #puanlar 
				FROM   dbo.fn_Split(@PUANARALIGI, '-', NULL) 

				SET @MAXPUAN = (SELECT Max(PUAN) 
				  FROM   #puanlar) 
				SET @MINPUAN = (SELECT Min(PUAN) 
				  FROM   #puanlar)

				IF @ISLEM = 1 -- HTML
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.TCKIMLIKNO, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablos t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 							
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_SINAVRAPOR, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablos t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 						
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_SINAVRAPOR, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
				END 
				ELSE IF @ISLEM = 2 -- DEVEXPRESS
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.TCKIMLIKNO, 
								t.ADSOYAD, 
								t.PUAN 
						FROM   #tablos t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_SINAVRAPOR, 
								  SINAVADI 
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.ADSOYAD, 
								t.PUAN  
						FROM   #tablos t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_SINAVRAPOR, 
								  SINAVADI 
					END 
				END

				DROP TABLE #tablos
				DROP TABLE #puanlar
			END 

			IF @ISLEM = 3 OR @ISLEM = 4	--	Toplu Yazılı Yoklama Sunuçları Getir
			BEGIN
				SELECT  Y.ID_YAZILI
						,Y.AD								AS SINAVADI
						,SB.AD								AS KAMPUS
						,S.AD								AS SINIF
						,K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD				AS ADSOYAD
						,ISNULL(YO.TELAFI, Sum(YOC.PUAN))	AS PUAN 
				INTO #tablosY
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE		Y.DONEM = @DONEM 
							AND Y.AKTIF = 1 
							AND k.AKTIF = 1 
							AND ( ( Y.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
							AND ( ( Y.ID_YAZILI		IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
							AND ( ( SB.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
							AND ( ( S.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
							--AND ( Y.ID_KADEME3 = @ID_KADEME3 OR @ID_KADEME3 = 0 ) 
				GROUP  BY	Y.ID_YAZILI, 
							Y.AD, 
							SB.AD, 
							S.AD, 
							k.TCKIMLIKNO, 
							k.AD, 
							k.SOYAD,
							YO.TELAFI 



				SELECT Cast(VALUE AS DECIMAL(6, 2)) AS PUAN 
				INTO   #puanlarY 
				FROM   dbo.fn_Split(@PUANARALIGI, '-', NULL) 

				SET @MAXPUAN = (SELECT Max(PUAN) 
				  FROM   #puanlarY) 
				SET @MINPUAN = (SELECT Min(PUAN) 
				  FROM   #puanlarY)

				IF @ISLEM = 3 -- HTML
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.TCKIMLIKNO, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablosY t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 							
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_YAZILI, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT
						(
							SELECT t.KAMPUS, 
									t.SINIF, 
									t.SINAVADI, 
									t.ADSOYAD, 
									t.PUAN 
							--  into #Tablo  
							FROM   #tablosY t 
							WHERE  PUAN >= @MINPUAN 
									AND PUAN <= @MAXPUAN 						
							ORDER  BY KAMPUS, 
									  SINIF, 
									  ADSOYAD, 
									  ID_YAZILI, 
									  SINAVADI 
							FOR JSON PATH
						) AS J
					END 
				END 
				ELSE IF @ISLEM = 4 -- DEVEXPRESS
				BEGIN
					IF @TC = 1 --tc var 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.TCKIMLIKNO, 
								t.ADSOYAD, 
								t.PUAN 
						FROM   #tablosY t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_YAZILI, 
								  SINAVADI 
					END 
					ELSE -- tc yok 
					BEGIN 
						SELECT t.KAMPUS, 
								t.SINIF, 
								t.SINAVADI, 
								t.ADSOYAD, 
								t.PUAN  
						FROM   #tablosY t 
						WHERE  PUAN >= @MINPUAN 
								AND PUAN <= @MAXPUAN 							
						ORDER  BY KAMPUS, 
								  SINIF, 
								  ADSOYAD, 
								  ID_YAZILI, 
								  SINAVADI 
					END 
				END
			END 

			DROP TABLE #tablosY
			DROP TABLE #puanlarY			
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_RehberlikEnvanter]...';


GO
ALTER procedure [dbo].[sp_RehberlikEnvanter]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_REHBERLIKENVANTER	INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@TESTADI				VARCHAR(MAX)	= NULL,
	@KLASOR					VARCHAR(MAX)	= NULL

		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
			SELECT	
				ISLEM							= @ISLEM					
				,TCKIMLIKNO						= @TCKIMLIKNO				
				,OTURUM							= @OTURUM					
				,ID_MENU						= @ID_MENU				
				,TC_OGRENCI						= @TC_OGRENCI				
				,ID_KADEME3						= @ID_KADEME3				
				,ID_SINIF						= @ID_SINIF				
				,ID_SUBE						= @ID_SUBE				
				,ID_REHBERLIKENVANTER			= @ID_REHBERLIKENVANTER	
				,DONEM							= @DONEM					
				,TESTADI						= @TESTADI				
				,KLASOR							= @KLASOR					
			FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
		)	
	
	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	
		BEGIN
			IF @ID_KADEME3 IS NULL OR @ID_KADEME3 = 0
			BEGIN
				SET @ID_KADEME3 = (	SELECT TOP 1 S.ID_KADEME3
									FROM OkyanusDB.DBO.v3Ogrenci		O
									JOIN OkyanusDB.DBO.v3SubeGrupSinif	S ON	S.ID_SINIF	= O.ID_SINIF
									WHERE O.TCKIMLIKNO =@TC_OGRENCI
								)
			END

			SELECT(
				SELECT (
					SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
					FROM RehberlikEnvanter	R
					JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3
					WHERE	(R.ID_KADEME3	=  @ID_KADEME3)
						AND (@DONEM	= 0		OR R.DONEM= @DONEM)
						AND AKTIF	= 1
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END	
		
		IF @ISLEM = 2	--	SINIF
		BEGIN
			
			SET @ID_KADEME3 = (	SELECT TOP 1 ID_KADEME3
									FROM OkyanusDB.DBO.v3SubeGrupSinif		
									WHERE ID_SINIF =@ID_SINIF
								)
			
			SELECT(
				SELECT (				
					SELECT * FROM (
							SELECT O.TCKIMLIKNO,S.AD SINIFAD,CONCAT(K.AD,' ',SOYAD) ADSOYAD
							FROM OkyanusDB.DBO.v3Ogrenci		O
							JOIN OkyanusDB.DBO.v3Sinif			S	ON	S.ID_SINIF	= O.ID_SINIF
							JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= O.TCKIMLIKNO
							WHERE	(O.TCKIMLIKNO =@TC_OGRENCI OR @TC_OGRENCI = '' OR @TC_OGRENCI IS NULL)
								AND S.ID_SINIF=@ID_SINIF
					) AS S
					CROSS JOIN (
							SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
							FROM RehberlikEnvanter	R
							JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3				
							WHERE	(R.ID_KADEME3	=  @ID_KADEME3)
								AND (ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER OR @ID_REHBERLIKENVANTER=0)
								AND (@DONEM	= 0		OR R.DONEM= @DONEM)						
								AND AKTIF	= 1
					) AS D
					ORDER BY ADSOYAD,DONEM,ID_REHBERLIKENVANTER
					FOR JSON PATH
				) AS LISTE
				FOR JSON PATH
			) AS SS


		END		
 
		IF @ISLEM = 3	--	SUBE KADEME3
		BEGIN
			
			--SET @ID_KADEME3 = (	SELECT TOP 1 ID_KADEME3
			--						FROM OkyanusDB.DBO.v3SubeGrupSinif		
			--						WHERE ID_SINIF =@ID_SINIF
			--					)
			
			SELECT(
				SELECT (				
					SELECT * FROM (
							SELECT O.TCKIMLIKNO,S.AD SINIFAD,CONCAT(K.AD,' ',SOYAD) ADSOYAD
							FROM OkyanusDB.DBO.v3Ogrenci		O
							JOIN OkyanusDB.DBO.v3Sinif			S	ON	S.ID_SINIF	= O.ID_SINIF
							JOIN OkyanusDB.dbo.v3SubeGrupSinif  GS	ON	GS.ID_SINIF	= S.ID_SINIF
							JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= O.TCKIMLIKNO
							WHERE	(O.TCKIMLIKNO =@TC_OGRENCI OR @TC_OGRENCI = '' OR @TC_OGRENCI IS NULL)								
								AND (S.ID_SINIF		= @ID_SINIF OR @ID_SINIF = 0)
								AND (GS.ID_SUBE		= @ID_SUBE  OR @ID_SUBE  = 0)
								AND GS.ID_KADEME3	= @ID_KADEME3
								--AND S.ID_SINIF=@ID_SINIF
					) AS S
					CROSS JOIN (
							SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
							FROM RehberlikEnvanter	R
							JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3				
							WHERE	(R.ID_KADEME3	=  @ID_KADEME3)
								AND (ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER OR @ID_REHBERLIKENVANTER=0)
								AND (@DONEM	= 0		OR R.DONEM= @DONEM)						
								AND AKTIF	= 1
					) AS D
					ORDER BY ADSOYAD,DONEM,ID_REHBERLIKENVANTER
					FOR JSON PATH
				) AS LISTE
				FOR JSON PATH
			) AS SS


		END	
	END

	END TRY
	BEGIN CATCH	
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_RehberlikEnvanterTanimlama]...';


GO
ALTER procedure [dbo].[sp_RehberlikEnvanterTanimlama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
 	@ID_KADEME3				INT				= NULL,
	@ID_REHBERLIKENVANTER	INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@TESTADI				VARCHAR(MAX)	= NULL,
	@KLASOR					VARCHAR(MAX)	= NULL

		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM					
			,TCKIMLIKNO						= @TCKIMLIKNO				
			,OTURUM							= @OTURUM					
			,ID_MENU						= @ID_MENU				
			,ID_KADEME3						= @ID_KADEME3				
			,ID_REHBERLIKENVANTER			= @ID_REHBERLIKENVANTER	
			,DONEM							= @DONEM					
			,TESTADI						= @TESTADI				
			,KLASOR							= @KLASOR					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
	
		IF @ISLEM = 1	--	KAYDET/GUNCELLE
		BEGIN

			--IF NOT EXISTS(SELECT * FROM RehberlikEnvanter WHERE TESTADI=@TESTADI AND DONEM=@DONEM AND ID_KADEME3=@ID_KADEME3 AND AKTIF=0)
			IF @ID_REHBERLIKENVANTER IS NULL OR @ID_REHBERLIKENVANTER !> 0
			BEGIN
				DECLARE @ID_TABLE TABLE (ID INT)

				INSERT INTO RehberlikEnvanter (TESTADI,ID_KADEME3,DONEM,KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_REHBERLIKENVANTER INTO @ID_TABLE
				VALUES(@TESTADI,@ID_KADEME3,@DONEM,@TCKIMLIKNO)
								
				DECLARE @ID INT = (SELECT TOP 1 ID FROM @ID_TABLE)
				DECLARE @KADEME3 VARCHAR(20) = (SELECT AD FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3)
				SET @KLASOR= '/'+@DONEM+'/'+CAST(@ID AS varchar)+'/'+@KADEME3

				UPDATE RehberlikEnvanter 
				SET KLASOR=@KLASOR
				WHERE ID_REHBERLIKENVANTER=@ID

				select 1

			END
			ELSE
			BEGIN
				UPDATE RehberlikEnvanter
				SET	 TESTADI	= @TESTADI
				WHERE ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER
			END
		END		

		IF @ISLEM = 2	-- LISTELE
		BEGIN
			SELECT(
				SELECT (
					SELECT ID_REHBERLIKENVANTER,TESTADI,R.ID_KADEME3,K.AD KADEME3,DONEM,KLASOR,AKTIF
					FROM RehberlikEnvanter	R
					JOIN v3Kademe3			K	ON	K.ID_KADEME3	= R.ID_KADEME3
					WHERE	(@ID_KADEME3=0 OR R.ID_KADEME3 = @ID_KADEME3)
						AND (@DONEM=0 OR R.DONEM= @DONEM)
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END

		IF @ISLEM = 3	--	AKTIF/PASIF
		BEGIN
			UPDATE RehberlikEnvanter
			SET AKTIF = CASE WHEN AKTIF=0 THEN 1 ELSE 0 END
			WHERE ID_REHBERLIKENVANTER=@ID_REHBERLIKENVANTER		
			
			select 1	
		END
 
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_SifremiDegistir]...';


GO

ALTER PROCEDURE [dbo].[sp_SifremiDegistir] 
@ISLEM			INT				= NULL,
@OLDPASS		VARCHAR(50)		= NULL,
@NEWPASS		VARCHAR(50)		= NULL,
@TCKIMLIKNO		VARCHAR(11)		= NULL,
@OTURUM			VARCHAR(36)		= NULL		
AS
BEGIN
DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM				= @ISLEM		
			,OLDPASS			= @OLDPASS	
			,NEWPASS			= @NEWPASS	
			,TCKIMLIKNO			= @TCKIMLIKNO	
			,OTURUM				= @OTURUM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	
	BEGIN TRY
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		IF @ID_LOG>1
		BEGIN
			IF @ISLEM=1
			BEGIN
			DECLARE @ERRCODE VARCHAR(2),@ERRMESSAGE VARCHAR(300)
			DROP TABLE IF EXISTS #UPDATE_TABLE
				CREATE TABLE #UPDATE_TABLE
				(
					ERRCODE		INT,
					ERRMESSAGE  varchar(200), 
				)

				DECLARE @TABLE_OLDPASS VARCHAR(50)=(SELECT SIFRE FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO)

				IF @TABLE_OLDPASS=@OLDPASS
					BEGIN
						UPDATE OkyanusDB.dbo.v3Kullanici 
					    SET SIFRE = @NEWPASS,
						   SIFREHASH=eokul_v2.dbo.clr_Crypto_HashPass(@NEWPASS) 
						WHERE AKTIF=1 
					    AND TCKIMLIKNO=@TCKIMLIKNO

						SET @ERRCODE=0
						SET @ERRMESSAGE='Şifreniz başarıyla güncellendi!'
						INSERT INTO #UPDATE_TABLE (ERRCODE,ERRMESSAGE) VALUES(@ERRCODE,@ERRMESSAGE)
						SELECT * FROM #UPDATE_TABLE FOR JSON AUTO
					END
				ELSE
					BEGIN
						SET @ERRCODE=1
						SET @ERRMESSAGE='Eski şifrenizi yanlış girdiniz!'

						INSERT INTO #UPDATE_TABLE (ERRCODE,ERRMESSAGE) VALUES(@ERRCODE,@ERRMESSAGE)
						SELECT * FROM #UPDATE_TABLE FOR JSON AUTO
					END
			END
		END
	END TRY

	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH
		

END
GO
PRINT N'Altering [dbo].[sp_SinavaKatilmayanOgrenciler]...';


GO

--EXEC	@return_value = [dbo].[sp_SinavaKatilmayanOgrenciler]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_SinavaKatilmayanOgrenciler]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1 OR @ISLEM = 2	--	KATILMAYAN
			BEGIN
				Select distinct 
					ID_OGRENCI,
					ID_SINAVRAPOR,
					ono.ID_SINIF
				into #tmp1 
				from eokul_v2.dbo.OgrenciNot ono 
				inner join OkyanusDb.Dbo.v3Sinif s on s.ID_SINIF=ono.ID_SINIF
				inner join OkyanusDb.Dbo.v3Donem d on d.ID_DONEM=s.ID_DONEM
				where ono.KATILMADI=1 
				and		ono.ID_SINAVRAPOR=@ID_SINAV
				AND		d.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELER))
				and		ono.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))

				IF @ISLEM = 1	--	JSON
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT DISTINCT
									sr.ID_SINAVRAPOR				,
									sr.SINAVADI						,
									o.ID_OGRENCI					,
									AD = K.AD+' '+K.SOYAD			,
									PUAN = (0)			            ,
									SINIF = sn.AD					,
									sr.DONEMKOD						,
									ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
									su.AD as SUBE
								FROM #tmp1 o
								INNER JOIN OkyanusDb.Dbo.v3Ogrenci		OG	on OG.ID_OGRENCI	= o.ID_OGRENCI
								INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= OG.TCKIMLIKNO
								INNER JOIN eokul_v2.dbo.SinavRapor		sr	on o.ID_SINAVRAPOR	= sr.ID_SINAVRAPOR
								INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on o.ID_SINIF		= sn.ID_SINIF
								INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= OG.ID_SUBE
								ORDER BY S_NO	
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T1
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END
				ELSE IF @ISLEM = 2	--	DEVEXPRESS
				BEGIN
					SELECT DISTINCT
						sr.ID_SINAVRAPOR				,
						sr.SINAVADI						,
						o.ID_OGRENCI					,
						AD = K.AD+' '+K.SOYAD			,
						PUAN = (0)			            ,
						SINIF = sn.AD					,
						sr.DONEMKOD						,
						ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
						su.AD as SUBE
					FROM #tmp1 o
					INNER JOIN OkyanusDb.Dbo.v3Ogrenci		OG	on OG.ID_OGRENCI	= o.ID_OGRENCI
					INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= OG.TCKIMLIKNO
					INNER JOIN eokul_v2.dbo.SinavRapor		sr	on o.ID_SINAVRAPOR	= sr.ID_SINAVRAPOR
					INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on o.ID_SINIF		= sn.ID_SINIF
					INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= OG.ID_SUBE
					ORDER BY S_NO	
				END
		
				drop table #tmp1
			END 

			IF @ISLEM = 3 OR @ISLEM = 4	--	KATILMAYAN YENİ
			BEGIN
				SELECT  O.ID_OGRENCI
						,Y.ID_YAZILI
						,O.ID_SINIF
						,YO.TCKIMLIKNO
						,O.ID_SUBE
						,Y.AD AS SINAVADI
						,Y.DONEM AS DONEMKOD
				INTO #tmp1Y
				FROM Yazili Y 
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE  Y.ID_YAZILI = @ID_SINAV
				AND YO.KATILMADI = 1 
				AND Y.AKTIF = 1
				AND ( ( O.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
				AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' )  

				IF @ISLEM = 3	--	JSON
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT DISTINCT
									O.ID_YAZILI				,
									O.SINAVADI						,
									o.ID_OGRENCI					,
									AD = K.AD+' '+K.SOYAD			,
									PUAN = (0)			            ,
									SINIF = sn.AD					,
									O.DONEMKOD						,
									ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
									su.AD as SUBE
								FROM #tmp1Y o
								INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= o.TCKIMLIKNO
								INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on o.ID_SINIF		= sn.ID_SINIF
								INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= o.ID_SUBE
								ORDER BY S_NO	
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T1
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END
				ELSE IF @ISLEM = 4	--	DEVEXPRESS
				BEGIN
					SELECT DISTINCT
						O.ID_YAZILI				,
						O.SINAVADI						,
						O.ID_OGRENCI					,
						AD = K.AD+' '+K.SOYAD			,
						PUAN = (0)			            ,
						SINIF = sn.AD					,
						O.DONEMKOD						,
						ROW_NUMBER() OVER(ORDER BY  sn.AD,k.AD+' '+k.SOYAD) AS S_NO,
						su.AD as SUBE
					FROM #tmp1Y O
					INNER JOIN OkyanusDb.Dbo.v3Kullanici	K	on K.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN OkyanusDb.Dbo.v3Sinif		sn	on O.ID_SINIF		= sn.ID_SINIF
					INNER JOIN OkyanusDb.Dbo.v3Sube			su	on su.ID_SUBE		= O.ID_SUBE
					ORDER BY S_NO	
				END
		
				drop table #tmp1Y
			END 
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_SinavAnaliz]...';


GO

--EXEC	[dbo].[sp_SinavAnaliz]
--		@TCKIMLIKNO = N'56545519606',
--		@OTURUM = N'9ECE89E5-DD7E-4EBC-A920-A0B75E540AFF',
--		@ID_MENU = 1088,
--		@ID_SINAV = 9826,
--		@ID_SUBELER = N'[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]',
--		@ID_SINIFLAR = N'[0,102208,102207,102293,104343,101677,101671,101679,101672,101676,101680,101926,101927,101924,101925,101873,101875,101435,101434,101709,101710,101707,101708,101826,102174,101497,101498,101417,101419,101613,101615,101614,101861,104756,101860,101867,100987,105219,105416,105417,102307,102306,102087,102086,102147,102146,104554,101943,101946,101525,101526,104673,104676]',
--		@ISLEM = 1,
--		@DONEM = N'2017'

ALTER procedure [dbo].[sp_SinavAnaliz]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= 0,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			
			DECLARE @TITLE VARCHAR(MAX)
			DECLARE @TKS INT

			IF @ISLEM = 1 OR @ISLEM = 2	--	Sınav Analiz Getir
			BEGIN
				SELECT o.SORUNO, 
					   sr.PUANDEGERI, 
					   d.AD															AS DERSAD, 
					   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), o.PUAN)))	AS ORTALAMA, 
					   Isnull(sr.KAZANIM, 'Belirtilmemiş')							AS KAZANIM 
				INTO   #tablo 
				FROM   eokul_v2.dbo.OgrenciNot o 
				INNER JOIN eokul_v2.dbo.SinavRaporDetay sr ON sr.ID_SINAVRAPOR = o.ID_SINAVRAPOR AND sr.SORUNO = o.SORUNO 
				INNER JOIN eokul_v2.dbo.SinavRapor s ON s.ID_SINAVRAPOR = o.ID_SINAVRAPOR 
				INNER JOIN OkyanusDB.dbo.v3SinavDers d ON d.ID_DERS = s.ID_DERS 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci og ON og.ID_OGRENCI = o.ID_OGRENCI 
				WHERE  o.ID_SINAVRAPOR = @ID_SINAV 
					   AND o.KATILMADI = 0 
					   AND ( ( og.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					   AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP  BY o.SORUNO, 
						  sr.PUANDEGERI, 
						  d.AD, 
						  sr.KAZANIM 

				SELECT o.ID_OGRENCI, 
					   Sum(o.PUAN) AS PUAN 
				INTO   #tablo2 
				FROM   eokul_v2.dbo.OgrenciNot o 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci og ON og.ID_OGRENCI = o.ID_OGRENCI 
				WHERE  o.ID_SINAVRAPOR = @ID_SINAV 
					   AND o.KATILMADI = 0 
					   AND ( ( og.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					   AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP  BY o.ID_OGRENCI 

				SELECT Count(1) AS KISISAYISI, 
					   'PEKIYI' AS DURUM, 
					   5        AS SIRA 
				INTO   #tablo3 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 101 
					   AND t.PUAN > 84 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'IYI'    AS DURUM, 
					   4        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 85 
					   AND t.PUAN > 69 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'ORTA'   AS DURUM, 
					   3        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 70 
					   AND t.PUAN > 59 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECER'  AS DURUM, 
					   2        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 60 
					   AND t.PUAN > 49 
				UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECMEZ' AS DURUM, 
					   1        AS SIRA 
				FROM   #tablo2 t 
				WHERE  t.PUAN < 50 
				ORDER  BY SIRA DESC 

				IF @ISLEM = 1
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT t.SORUNO                                                    AS SN, 
									   t.DERSAD                                                    AS DERS, 
									   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
									   t.KAZANIM 
								FROM   #tablo t 
								ORDER  BY t.SORUNO 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T1,
							(
								SELECT t.KISISAYISI, 
								   t.DURUM, 
								   t.SIRA, 
								   (SELECT Sum(KISISAYISI) FROM #tablo3) AS TOPLAMKISISAYISI 
								FROM   #tablo3 t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T2,
							(
								SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
								   Min(t.PUAN)                                                 AS ENDUSUK, 
								   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
								FROM   #tablo2 t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T3		
						) AS XTABLE	
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END 
				ELSE IF @ISLEM = 2
				BEGIN
					SET @TITLE = (SELECT ACIKLAMA FROM [dbo].[v3AktifDonem] WHERE DONEM = @DONEM)
					SET @TITLE += ' ('+ (SELECT SNVKOD FROM eokul_v2.dbo.SinavRapor WHERE ID_SINAVRAPOR = @ID_SINAV) + ') SORU ANALİZİ'
					SELECT t.SORUNO                                                    AS SN, 
						   t.DERSAD                                                    AS DERS, 
						   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
						   t.KAZANIM 
					FROM   #tablo t 
					ORDER  BY t.SORUNO 

					SET @TKS = (SELECT Sum(KISISAYISI) FROM #tablo3)

					SELECT t.KISISAYISI, 
						   t.DURUM, 
						   t.SIRA, 
						   @TKS AS TOPLAMKISISAYISI,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),t.KISISAYISI)/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS YUZDE
					FROM   #tablo3 t 

					SELECT (@TKS - t.KISISAYISI) AS BASARILI, 
						   (t.KISISAYISI) AS BASARISIZ,  
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(@TKS - t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARILIYUZDE,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARISIZYUZDE
					FROM   #tablo3 t 
					WHERE  t.SIRA=1

					SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
						   Min(t.PUAN)                                                 AS ENDUSUK, 
						   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
					FROM   #tablo2 t 

					SELECT @TITLE
				END			
				
				DROP TABLE #tablo3
				DROP TABLE #tablo2 
				DROP TABLE #tablo 
			END

			IF @ISLEM = 3 OR @ISLEM = 4	--	Sınav Analiz Getir
			BEGIN
				
				SELECT   YS.SORUNO								AS SORUNO
						,YS.PUAN								AS PUANDEGERI															
						,D.DERSAD								AS DERSAD
						,CONVERT(DECIMAL(18,2), AVG(YOC.PUAN))	AS ORTALAMA 
						,ISNULL(SDU.AD, 'Belirtilmemiş')		AS KAZANIM 
				INTO   #tabloY 
				FROM Yazili Y 
				INNER JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS				= Y.ID_DERS
				INNER JOIN YaziliSoru						YS	ON	YS.ID_YAZILI			= Y.ID_YAZILI
				INNER JOIN YaziliOgrenci					YO	ON	YO.ID_YAZILI			= Y.ID_YAZILI 
				INNER JOIN YaziliOgrenciCevap				YOC ON	YOC.ID_YAZILIOGRENCI	= YO.ID_YAZILIOGRENCI 
																AND YOC.ID_YAZILISORU		= YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.TCKIMLIKNO			= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON	SDU.KOD					= YS.KOD
				WHERE	Y.ID_YAZILI		= @ID_SINAV 
					AND YO.KATILMADI	= 0 
					AND YO.AKTIF		= 1
					AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP BY YS.SORUNO, YS.PUAN, D.DERSAD, SDU.AD--, YO.TELAFI
				
				
				SELECT O.ID_OGRENCI, 
						--ISNULL(YO.TELAFI, Sum(YOC.PUAN)) AS PUAN 
						CASE WHEN YO.KATILMADI = 1 THEN YO.TELAFI ELSE Sum(YOC.PUAN) END AS PUAN
				INTO   #tablo2Y 
				FROM   YaziliOgrenci YO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO 
				WHERE  Y.ID_YAZILI = @ID_SINAV 
					   AND YO.KATILMADI = 0 
					   AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
					   AND ( ( O.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
				GROUP  BY O.ID_OGRENCI, YO.TELAFI ,YO.KATILMADI
				
				CREATE TABLE #tablo3Y (KISISAYISI INT,DURUM VARCHAR(20),SIRA INT)

				
				IF EXISTS ( SELECT ID_YAZILI FROM Yazili Y JOIN v3KademeBilgi KB ON KB.ID_KADEME3 = Y.ID_KADEME3 WHERE Y.ID_YAZILI = @ID_SINAV AND KB.ID_KADEME = 5) -- LISE İSE
				BEGIN
				INSERT INTO #tablo3Y
				SELECT Count(1) AS KISISAYISI, 
					   'PEKIYI' AS DURUM, 
					   5        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 101 
					   AND t.PUAN > 84 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'IYI'    AS DURUM, 
					   4        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 85 
					   AND t.PUAN > 69 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'ORTA'   AS DURUM, 
					   3        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 70 
					   AND t.PUAN > 59 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECER'  AS DURUM, 
					   2        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 60 
					   AND t.PUAN > 49 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECMEZ' AS DURUM, 
					   1        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 50 
				ORDER  BY SIRA DESC 
				END
				ELSE
				BEGIN
				INSERT INTO #tablo3Y
				SELECT Count(1) AS KISISAYISI, 
					   'PEKIYI' AS DURUM, 
					   5        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 101 
					   AND t.PUAN >= 85
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'IYI'    AS DURUM, 
					   4        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 85 
					   AND t.PUAN >= 70
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'ORTA'   AS DURUM, 
					   3        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 70 
					   AND t.PUAN >= 55 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECER'  AS DURUM, 
					   2        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 55 
					   AND t.PUAN >= 45 
			UNION 
				SELECT Count(1) AS KISISAYISI, 
					   'GECMEZ' AS DURUM, 
					   1        AS SIRA 
				FROM   #tablo2Y t 
				WHERE  t.PUAN < 45 
				ORDER  BY SIRA DESC 
				END

				IF @ISLEM = 3
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT t.SORUNO                                                    AS SN, 
									   t.DERSAD                                                    AS DERS, 
									   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
									   t.KAZANIM 
								FROM   #tabloY t 
								ORDER  BY t.SORUNO 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T1,
							(
								SELECT t.KISISAYISI, 
								   t.DURUM, 
								   t.SIRA, 
								   (SELECT Sum(KISISAYISI) FROM #tablo3Y) AS TOPLAMKISISAYISI 
								FROM   #tablo3Y t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T2,
							(
								SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
								   Min(t.PUAN)                                                 AS ENDUSUK, 
								   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
								FROM   #tablo2Y t 
								FOR JSON AUTO, INCLUDE_NULL_VALUES
							) AS T3		
						) AS XTABLE	
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END 
				ELSE IF @ISLEM = 4
				BEGIN
					SET @TITLE = (SELECT ACIKLAMA FROM [dbo].[v3AktifDonem] WHERE DONEM = @DONEM)
					SET @TITLE += ' ('+ (SELECT KOD FROM Yazili WHERE ID_YAZILI = @ID_SINAV) + ') SORU ANALİZİ'
					SELECT t.SORUNO                                                    AS SN, 
						   t.DERSAD                                                    AS DERS, 
						   CONVERT(DECIMAL(5, 2), ( t.ORTALAMA / t.PUANDEGERI ) * 100) AS YUZDE, 
						   t.KAZANIM 
					FROM   #tabloY t 
					ORDER  BY t.SORUNO 

					SET @TKS = (SELECT Sum(KISISAYISI) FROM #tablo3Y)

					SELECT t.KISISAYISI, 
						   t.DURUM, 
						   t.SIRA, 
						   @TKS AS TOPLAMKISISAYISI,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),t.KISISAYISI)/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS YUZDE
					FROM   #tablo3Y t 

					SELECT (@TKS - t.KISISAYISI) AS BASARILI, 
						   (t.KISISAYISI) AS BASARISIZ,  
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(@TKS - t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARILIYUZDE,
						   '%'+CAST((CONVERT(decimal(10,2),CONVERT(decimal(10,2),(t.KISISAYISI))/CONVERT(decimal(10,2),@TKS) * 100.0)) AS VARCHAR) AS BASARISIZYUZDE
					FROM   #tablo3Y t 
					WHERE  t.SIRA=1

					SELECT Max(t.PUAN)                                                 AS ENYUKSEK, 
						   Min(t.PUAN)                                                 AS ENDUSUK, 
						   CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), t.PUAN))) AS ORTALAMA 
					FROM   #tablo2Y t 

					SELECT @TITLE
				END			
				
				DROP TABLE #tablo3Y
				DROP TABLE #tablo2Y
				DROP TABLE #tabloY 
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Sinif]...';


GO
ALTER procedure [dbo].[sp_Sinif]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@KADEME				VARCHAR(1)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@KUR				BIT				= NULL,
	@ESKIDONEMSINIF		BIT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SUBES			VARCHAR(MAX)	= NULL,
	@ID_KADEME3S		VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUP		INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,KADEME						= @KADEME			
			,DONEM						= @DONEM			
			,KUR						= @KUR			
			,ESKIDONEMSINIF				= @ESKIDONEMSINIF	
			,ID_SUBE					= @ID_SUBE		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SUBES					= @ID_SUBES		
			,ID_KADEME3S				= @ID_KADEME3S	
			,ID_SINAVGRUP				= @ID_SINAVGRUP	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	--exec sp_Sinif @TCKIMLIKNO= '56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@KADEME=2,@ID_SUBES='652,385,',@ID_SINAVGRUP=3,@ISLEM= 2,@ID_MENU=21

	IF @ID_LOG > 1
	BEGIN
		SELECT VALUE AS ID_KULLANICITIPI INTO #TEMPTIPLER FROM OPENJSON('[26,27,53,54,59,60,61,84,85,91]')

		DECLARE @AKTIFDONEM VARCHAR(4)=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		SELECT ID_KADEME 
		INTO #KADEMELER 
		FROM v3KullaniciKademe 
		WHERE TCKIMLIKNO=@TCKIMLIKNO

		SELECT ID_KULLANICITIPI 
		INTO #KULLANICITIPLER 
		FROM		OkyanusDB.[dbo].[v3Kullanici]	K
		INNER JOIN	OkyanusDB.[dbo].[v3SubeYetki]	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO
		WHERE K.TCKIMLIKNO=@TCKIMLIKNO


		IF @ISLEM = 1	--	Sınıf Listele
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD 
			FROM	   [dbo].[vw_SubeGrupSinif]		sgs
			INNER JOIN [dbo].[v3Sinif]				s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3AktifDonem]			ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(sgs.ID_SUBE=@ID_SUBE)  AND
				(sgs.ID_KADEME3=@ID_SINAVGRUP)  AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@KADEME) 
			ORDER BY AD
		END
		
		IF @ISLEM = 2	--	Sınıf Listele Multi Sube
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SUBEAD +' / '+ sgs.SINIF as AD ,st.ID_KADEME
			FROM	   [dbo].[vw_SubeGrupSinif]		sgs
			INNER JOIN [dbo].[v3Sinif]				s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3AktifDonem]			ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU		
			where 
					(sgs.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 
				AND
					(sgs.ID_KADEME3=@ID_KADEME3 or @ID_KADEME3=0 or @ID_KADEME3 is null)  
				AND 
					(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@KADEME) 
			ORDER BY AD
		END

		--SELECT * FROM [dbo].[vw_SubeGrupSinif]
		IF @ISLEM = 3	--	Sınıf Listele BY Kullanici
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
				FROM	vw_SubeGrupSinif	S
				JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
				WHERE	(@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
					AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 	
					AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
					AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
					AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
				ORDER BY S.SUBEAD,S.SINIF
			END
			ELSE
			BEGIN 
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI)
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					WHERE	
						(@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR S.ID_KADEME3=@ID_KADEME3) 	
					ORDER BY S.SUBEAD,S.SINIF
				END
				ELSE
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 				
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
					ORDER BY S.SUBEAD,S.SINIF
				END			
			END
		END

		IF @ISLEM = 4	--	Sınıf Listele BY Kullanici Multi Sube
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN

				IF @KUR = 1
				BEGIN
					SELECT DISTINCT	s.ID_SINIF,S.AD, SB.AD SUBEAD
					FROM OkyanusDB.dbo.v4Sinif	S
					JOIN OkyanusDB.dbo.V3SUBE	SB	ON	SB.ID_SUBE	= S.ID_SUBE
					WHERE	(S.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 	
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR S.ID_KADEME3=@ID_KADEME3) 	
					ORDER BY SUBEAD, S.AD
				END
				ELSE
				BEGIN
					SELECT DISTINCT	s.ID_SINIF,S.SINIF AD, S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
					WHERE	(S.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR kS.ID_KADEME3=@ID_KADEME3) 	
					ORDER BY S.SUBEAD, S.SINIF
				END
			END
			ELSE
			BEGIN 
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI)
				BEGIN
				
						IF @KUR = 1
						BEGIN
							SELECT DISTINCT	s.ID_SINIF,S.AD, SB.AD SUBEAD
							FROM OkyanusDB.dbo.v4Sinif	S
							JOIN OkyanusDB.dbo.V3SUBE	SB	ON	SB.ID_SUBE	= S.ID_SUBE
							WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE=@ID_SUBE) 
								AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR S.ID_KADEME3=@ID_KADEME3) 	
								AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES	) ))
								AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
							ORDER BY SUBEAD, S.AD
						END
						ELSE
						BEGIN
							SELECT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
							FROM	vw_SubeGrupSinif	S
							WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE=@ID_SUBE) 
								AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR S.ID_KADEME3=@ID_KADEME3) 	
								AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES	) ))
								AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
						END

				END
				ELSE
				BEGIN
					SELECT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 				
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
				END			
						
			END
		END

		IF @ISLEM = 5 -- SINIF LİSTELE TÜMÜ
		BEGIN
			SELECT SN.ID_SINIF,SN.AD
			FROM v3Sinif						SN
			JOIN OkyanusDB.DBO.v3SubeGrupSinif	G	ON	G.ID_SINIF= SN.ID_SINIF
			WHERE	ID_KADEME3  = @ID_KADEME3
				AND ID_SUBE		= @ID_SUBE

		END

		IF @ISLEM = 6 -- ÖĞRETMENİN REHBERLİK DIŞINDA GİRDİĞİ SINIF LİSTESİ
		BEGIN
			
			IF @TC_OGRETMEN IS NULL OR @TC_OGRETMEN = ''
				SET @TC_OGRETMEN = @TCKIMLIKNO

			SELECT (
				SELECT (
					SELECT DISTINCT
						S.ID_SINIF,
						SB.ID_SUBE,
						SB.AD SUBEAD,
						S.AD SINIFAD,
						SINIF = S.AD + ' (' + UPPER(SB.AD) +')',
						GS.ID_KADEME3
					FROM eokul_v2.dbo.DersOgretmen		DP
					JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS = DP.ID_DERS
					JOIN OkyanusDB.dbo.v3Sinif			S	ON	S.ID_SINIF = DP.ID_SINIF
					JOIN OkyanusDB.dbo.v3SubeGrupSinif	GS	ON	GS.ID_SINIF = S.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sube			SB	ON	SB.ID_SUBE = GS.ID_SUBE
					JOIN OkyanusDB.dbo.v3Donem			DO	ON	DO.ID_DONEM=S.ID_DONEM
					JOIN OkyanusDB.dbo.v3AktifDonem		AD	ON	AD.DONEM = DO.KOD  
					WHERE	DP.TC_OGRETMEN = @TC_OGRETMEN
						--AND D.AD		<> 'Rehberlik'
						AND AD.AKTIF	= 1
						AND DP.ID_EGITIMTURU= 6 -- YAZILI
					ORDER BY SUBEAD,SINIFAD
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END

		IF @ISLEM = 7 -- ÖĞRETMENİN DANIŞMAN OLDUĞU SINIF LİSTESİ
		BEGIN	
			IF @TC_OGRETMEN IS NULL OR @TC_OGRETMEN = ''
				SET @TC_OGRETMEN = @TCKIMLIKNO

			SELECT (
				SELECT (
					SELECT	S.ID_SINIF
							,SB.ID_SUBE
							,SB.AD AS SUBEAD
							,S.AD AS SINIFAD
							,S.AD + ' (' + UPPER(SB.AD) +')' AS SINIF
							,GS.ID_KADEME3
					  FROM OkyanusDB.dbo.v3SinifPersonel SD
					  INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = SD.ID_SINIF
					  INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif GS ON GS.ID_SINIF = S.ID_SINIF
					  INNER JOIN OkyanusDB.dbo.v3Sube SB ON	SB.ID_SUBE = GS.ID_SUBE
					  WHERE SD.TCKIMLIKNO = @TC_OGRETMEN AND SD.ID_KULLANICITIPI = 100
					ORDER BY SUBEAD,SINIFAD
					FOR JSON PATH
				) AS LISTE FOR JSON PATH
			) AS SS
		END
				
		IF @ISLEM = 8	--	Sınıf Listele BY Kullanici Multi Sube (ESKIDONEM)
		BEGIN
		
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT DISTINCT	s.ID_SINIF,S.SINIF AD, S.SUBEAD
				FROM	vw_SubeGrupSinifTum	S
				LEFT JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
				JOIN	v3SinifTum			ST	ON	ST.ID_SINIF	= S.ID_SINIF
				JOIN	v3Donem				D	ON	D.ID_DONEM	= ST.ID_DONEM 
				WHERE	(S.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBES)) or @ID_SUBES='[]' or @ID_SUBES is null) 
					AND (@ID_KADEME3 IS NULL OR S.ID_KADEME3=@ID_KADEME3) 			
					AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
					AND (	((@DONEM	IS NULL OR @DONEM		= '') AND D.KOD = @AKTIFDONEM)
						OR	D.KOD = @DONEM
							)	
				ORDER BY S.SUBEAD, S.SINIF
			END
			ELSE
			BEGIN
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI OR KT.ID_KULLANICITIPI = 1 )
				BEGIN
					SELECT DISTINCT	S.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinifTum	S
					JOIN	v3SinifTum			ST	ON	ST.ID_SINIF	= S.ID_SINIF
					JOIN	v3Donem				D	ON	D.ID_DONEM	= ST.ID_DONEM 
					WHERE	
						(@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	='[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES)		))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	='[]'	OR S.ID_KADEME3	in (select value from openjson (@ID_KADEME3S)	))
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	=0		OR S.ID_KADEME3	=	@ID_KADEME3) 	
						AND (	((@DONEM	IS NULL OR @DONEM		= '') AND D.KOD = @AKTIFDONEM)
							OR	D.KOD = @DONEM
								)
				END
				ELSE
				BEGIN
					SELECT DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD
					FROM	vw_SubeGrupSinifTum	S
					JOIN	v3SinifTum			ST	ON	S.ID_SINIF	= ST.ID_SINIF
					JOIN	v3Donem				D	ON	D.ID_DONEM	= ST.ID_DONEM 
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR S.ID_SUBE=@ID_SUBE) 
						AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR S.ID_SUBE in (select value from openjson (@ID_SUBES) ))
						AND (KS.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))--=@ID_KADEME) 
						AND (@ID_KADEME3 IS NULL OR @ID_KADEME3=0 OR KS.ID_KADEME3=@ID_KADEME3) 				
						AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
						AND (	((@DONEM	IS NULL OR @DONEM		= '') AND D.KOD = @AKTIFDONEM)
							OR	D.KOD = @DONEM
								)
				END			
			END	
		END

		IF @ISLEM = 9	--	Sınıf Listele Dönem
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD 
			FROM	   [dbo].[vw_SubeGrupSinifTum]	sgs
			INNER JOIN [dbo].[v3SinifTum]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(sgs.ID_SUBE=@ID_SUBE)  AND
				(sgs.ID_KADEME3=@ID_KADEME3)  AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) AND s.DONEM = @DONEM
			ORDER BY AD
		END

		IF @ISLEM = 10	--	SINIF LİSTELE DÖNEM - MULTİ - GENEL (TKT)
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD, sgs.SUBEAD 
			FROM	   [dbo].[vw_SubeGrupSinifTum]	sgs
			INNER JOIN [dbo].[v3SinifTum]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) AND s.DONEM = @DONEM
				AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson (@ID_SUBES) ))
				AND (@ID_KADEME3S IS NULL OR @ID_KADEME3S='[]' OR sgs.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
			ORDER BY SUBEAD, AD
		END

		IF @ISLEM = 11	--	SINIF ALAN LİSTELE
		BEGIN
			SELECT(
				SELECT ID_SINIFALAN, AD AS ALAN 
				FROM OkyanusDb.dbo.v4SinifAlan
				FOR JSON AUTO 
			)
		END

		

		--SELECT * FROM [dbo].[vw_SubeGrupSinif]
		IF @ISLEM = 12	--	Sınıf+KurSinif Listele BY Kullanici
		BEGIN
		
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD,0 KURSINIFIMI
				FROM	vw_SubeGrupSinif	S
				JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF	= S.ID_SINIF
				WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE		= @ID_SUBE) 
					AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3) 	
					AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
					AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3		in (select value from openjson (@ID_KADEME3S) ))
					AND (KS.ID_KADEME	IN (SELECT ID_KADEME FROM #KADEMELER))
			UNION 
				SELECT DISTINCT KS.ID_SINIF AS ID_KUR, KS.AD AS KURSINIFI,SB.AD,1
				FROM OkyanusDb.dbo.v4Sinif KS
				JOIN v3Sube					SB	ON	SB.ID_SUBE = KS.ID_SUBE
				WHERE	KS.DONEM		= @AKTIFDONEM AND KS.AKTIF = 1						
					AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR KS.ID_SUBE		= @ID_SUBE) 
					AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3)
					AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR KS.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
					AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR KS.ID_KADEME3	in (select value from openjson (@ID_KADEME3S) ))
				ORDER BY S.SUBEAD,S.SINIF
			END
			ELSE
			BEGIN 
				IF EXISTS (SELECT KT.ID_KULLANICITIPI FROM #KULLANICITIPLER KT INNER JOIN #TEMPTIPLER TEMP ON TEMP.ID_KULLANICITIPI = KT.ID_KULLANICITIPI)
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD,0 KURSINIFIMI
					FROM	vw_SubeGrupSinif	S
					WHERE	(@ID_SUBE		IS NULL OR @ID_SUBE		=0		OR S.ID_SUBE	= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	=0		OR S.ID_KADEME3	= @ID_KADEME3) 	
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	='[]'	OR S.ID_SUBE	in (select value from openjson (@ID_SUBES)	  ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	='[]'	OR S.ID_KADEME3 in (select value from openjson (@ID_KADEME3S) ))
				UNION					
					SELECT DISTINCT KS.ID_SINIF AS ID_KUR, KS.AD AS KURSINIFI,SB.AD,1
					FROM OkyanusDb.dbo.v4Sinif KS
					JOIN v3Sube					SB	ON	SB.ID_SUBE = KS.ID_SUBE
					WHERE	KS.DONEM		= @AKTIFDONEM AND KS.AKTIF = 1							
						AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR KS.ID_SUBE		= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3)
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR KS.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR KS.ID_KADEME3	in (select value from openjson (@ID_KADEME3S) ))
					ORDER BY S.SUBEAD,S.SINIF
				END
				ELSE
				BEGIN
					SELECT	DISTINCT	s.ID_SINIF,S.SINIF AD,S.SUBEAD,0 KURSINIFIMI
					FROM	vw_SubeGrupSinif	S
					JOIN	v3KullaniciSinif	KS	ON	KS.ID_SINIF		= S.ID_SINIF
					JOIN	v3SubeYetki			SY	ON	SY.TCKIMLIKNO	= KS.TCKIMLIKNO AND SY.ID_SUBE = S.ID_SUBE
					WHERE	KS.TCKIMLIKNO=@TCKIMLIKNO
						AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR S.ID_SUBE		= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3) 				
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR S.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR S.ID_KADEME3		in (select value from openjson (@ID_KADEME3S) ))
						AND (KS.ID_KADEME	IN (SELECT ID_KADEME FROM #KADEMELER))
				UNION					
					SELECT DISTINCT KS.ID_SINIF AS ID_KUR, KS.AD AS KURSINIFI,SB.AD,1
					FROM OkyanusDb.dbo.v4Sinif  KS
					JOIN v3Sube					SB	ON	SB.ID_SUBE		= KS.ID_SUBE
					JOIN OkyanusDB.dbo.v4SinifOgretmenDers SOD ON SOD.ID_SINIF = KS.ID_SINIF AND SOD.AKTIF = 1
					WHERE	KS.DONEM		= @AKTIFDONEM AND KS.AKTIF = 1	
						AND (@ID_SUBE		IS NULL OR @ID_SUBE		= 0		OR KS.ID_SUBE		= @ID_SUBE) 
						AND (@ID_KADEME3	IS NULL OR @ID_KADEME3	= 0		OR KS.ID_KADEME3	= @ID_KADEME3)
						AND (@ID_SUBES		IS NULL OR @ID_SUBES	= '[]'	OR KS.ID_SUBE		in (select value from openjson (@ID_SUBES)    ))
						AND (@ID_KADEME3S	IS NULL OR @ID_KADEME3S	= '[]'	OR KS.ID_KADEME3	in (select value from openjson (@ID_KADEME3S) ))
						AND (SOD.TC_OGRETMEN = @TCKIMLIKNO)
					ORDER BY S.SUBEAD,S.SINIF
				END			
			END
		END		

		IF @ISLEM = 13	--	SINIF LİSTELE DÖNEM - MULTİ ŞUBE - TEK GRUP - GENEL (TKT)
		BEGIN
			SELECT DISTINCT sgs.ID_SINIF, sgs.SINIF as AD, sgs.SUBEAD 
			FROM	   [dbo].[vw_SubeGrupSinifTum]	sgs
			INNER JOIN [dbo].[v3SinifTum]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			INNER JOIN [dbo].[v3Donem]				d		on d.ID_DONEM		=	s.ID_DONEM
			INNER JOIN [dbo].[v3SatisTuru]			st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			where 
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) AND s.DONEM = @DONEM
				AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson (@ID_SUBES) ))
				AND (sgs.ID_KADEME3 = @ID_KADEME3)
			ORDER BY SUBEAD, AD
		END

		DROP TABLE IF EXISTS #KADEMELER
		DROP TABLE IF EXISTS #KULLANICITIPLER
		DROP TABLE IF EXISTS #TEMPTIPLER	
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_SinifBazindaKazanimAnalizi]...';


GO

--EXEC	@return_value = [dbo].[sp_SinifBazindaKazanimAnalizi]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_SinifBazindaKazanimAnalizi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			IF @ISLEM = 1 OR @ISLEM = 2	--	Sınıf Bazında Kazanım Listesi
			BEGIN
				SELECT O.ID_OGRENCI, 
					   OG.OGRNO, 
					   O.ID_SINIF, 
					   SN.AD                            AS SINIF, 
					   ISNULL(K.AD + ' ' + K.SOYAD, '') AS ADSOYAD, 
					   O.SORUNO, 
					   O.PUAN, 
					   S.PUANDEGERI, 
					   ISNULL(S.KAZANIM, '')            AS KONUKODU, 
					   SB.AD                            AS SUBE 
				INTO   #OGRENCINOT 
				FROM   eokul_v2.dbo.OgrenciNot O 
				INNER JOIN eokul_v2.dbo.SinavRaporDetay S ON S.ID_SINAVRAPOR = O.ID_SINAVRAPOR AND S.SORUNO = O.SORUNO 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci OG ON OG.TCKIMLIKNO = O.TC_OGRENCI 
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OG.TCKIMLIKNO 
				INNER JOIN OkyanusDB.dbo.v3Sinif SN ON SN.ID_SINIF = O.ID_SINIF 
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = OG.ID_SUBE 
				WHERE  O.ID_SINAVRAPOR = @ID_SINAV
					   AND O.KATILMADI = 0 
					   AND K.AKTIF = 1 
					   AND ( ( SB.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
					   AND ( ( OG.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' )  
					   AND S.SILINDI = 0 

				IF @ISLEM = 1 -- HTML
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT * 
								FROM   #OGRENCINOT 
								ORDER  BY SUBE,
										  ID_SINIF, 
										  ID_OGRENCI, 
										  SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T1,
							(
								SELECT DISTINCT O.SORUNO, 
												O.PUANDEGERI, 
												O.KONUKODU 
								FROM   #OGRENCINOT O 
								ORDER  BY O.SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T2						
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE IF @ISLEM = 2 -- DEVEXPRESS
				BEGIN
					SELECT * 
					FROM   #OGRENCINOT 
					ORDER  BY SUBE,
							ID_SINIF, 
							ID_OGRENCI, 
							SORUNO 

					SELECT DISTINCT O.SORUNO, 
									O.PUANDEGERI, 
									O.KONUKODU 
					FROM   #OGRENCINOT O 
					ORDER  BY O.SORUNO 
				END

				DROP TABLE #OGRENCINOT
			END 

			IF @ISLEM = 3 OR @ISLEM = 4	--	Sınıf Bazında Kazanım Listesi Yeni
			BEGIN
				SELECT  O.ID_OGRENCI
						,O.OGRNO
						,O.ID_SINIF
						,S.AD AS SINIF
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,YS.SORUNO
						,YOC.PUAN
						,YS.PUAN AS PUANDEGERI
						,U.AD AS KONUKODU
						,SB.AD AS SUBE
				INTO #OGRENCINOTY
				FROM	   Yazili							Y 
				INNER JOIN YaziliSoru						YS	ON YS.ID_YAZILI			= Y.ID_YAZILI
				INNER JOIN YaziliOgrenci					YO	ON YO.ID_YAZILI			= Y.ID_YAZILI			AND YO.AKTIF		  = 1
				INNER JOIN YaziliOgrenciCevap				YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI	AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON O.TCKIMLIKNO			= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube				SB	ON SB.ID_SUBE			= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif			S	ON S.ID_SINIF			= O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici		K	ON K.TCKIMLIKNO			= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	U	ON U.KOD				= YS.KOD
				WHERE  Y.ID_YAZILI = @ID_SINAV
				AND YO.KATILMADI = 0 
				AND Y.AKTIF = 1
				AND ( ( O.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
				AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' )  

				IF @ISLEM = 3 -- HTML
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								SELECT * 
								FROM   #OGRENCINOTY 
								ORDER  BY SUBE,
										  ID_SINIF, 
										  ID_OGRENCI, 
										  SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T1,
							(
								SELECT DISTINCT O.SORUNO, 
												O.PUANDEGERI, 
												O.KONUKODU 
								FROM   #OGRENCINOTY O 
								ORDER  BY O.SORUNO 
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) T2						
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE IF @ISLEM = 4 -- DEVEXPRESS
				BEGIN
					SELECT * 
					FROM   #OGRENCINOTY 
					ORDER  BY SUBE,
							ID_SINIF, 
							ID_OGRENCI, 
							SORUNO 

					SELECT DISTINCT O.SORUNO, 
									O.PUANDEGERI, 
									O.KONUKODU 
					FROM   #OGRENCINOTY O 
					ORDER  BY O.SORUNO 
				END

				DROP TABLE #OGRENCINOTY
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Sube]...';


GO
ALTER procedure [dbo].[sp_Sube]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL--,
	--@KADEME				VARCHAR(1)		= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			
			SELECT DISTINCT ID_KULLANICITIPI INTO #KULLANICITIPLER FROM OkyanusDB.[dbo].[v3Kullanici]		K
			INNER JOIN OkyanusDB.[dbo].[v3SubeYetki]							SY ON SY.TCKIMLIKNO=K.TCKIMLIKNO
			WHERE K.TCKIMLIKNO=@TCKIMLIKNO
			

			IF @ISLEM = 1	--	Şube Listele
			BEGIN
				IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
				BEGIN
					SELECT S.ID_SUBE, S.SUBENO, S.AD  FROM OkyanusDB.[dbo].[v3Sube] S
					ORDER BY S.AD
				END
				ELSE
				BEGIN 
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]			S
					LEFT JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY ON SY.ID_SUBE=S.ID_SUBE						
					where SY.TCKIMLIKNO = @TCKIMLIKNO
					ORDER BY S.AD
				END
			END

			IF @ISLEM = 2	--	Şube Listele by Kullanici
			BEGIN
				IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
				BEGIN
					SELECT S.ID_SUBE, S.SUBENO, S.AD  FROM OkyanusDB.[dbo].[v3Sube] S
					ORDER BY S.AD
				END
				ELSE
				BEGIN 
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]			S
					LEFT JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY ON SY.ID_SUBE=S.ID_SUBE						
					where SY.TCKIMLIKNO = @TCKIMLIKNO
					ORDER BY S.AD
				END
			END
			
			IF @ISLEM = 3	--	Şube Listele tüm şubeler
			BEGIN				
				SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
				from OkyanusDB.[dbo].[v3Sube]			S	
				ORDER BY S.AD
			END
			

			IF @ISLEM = 4	--	Şube Listele(+KUR) by Kullanici
			BEGIN
				IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
				BEGIN
					SELECT S.ID_SUBE, S.SUBENO, S.AD  FROM OkyanusDB.[dbo].[v3Sube] S
					ORDER BY S.AD
				END
				ELSE
				BEGIN 
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]			S
					LEFT JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY ON SY.ID_SUBE=S.ID_SUBE						
					where SY.TCKIMLIKNO = @TCKIMLIKNO
				UNION
					SELECT DISTINCT S.ID_SUBE, S.SUBENO, S.AD 
					from OkyanusDB.[dbo].[v3Sube]	S
					JOIN eokul_v2.DBO.KurSinifi		KS	ON	KS.ID_SUBE = S.ID_SUBE
					JOIN v3Ogretmen					OG	ON	OG.ID_OGRETMEN = KS.ID_DANISMAN
					where	OG.TCKIMLIKNO = @TCKIMLIKNO
						AND DONEMKOD = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
					ORDER BY AD
				END
			END

			DROP TABLE IF EXISTS #KULLANICITIPLER
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Takvim]...';


GO
ALTER procedure [dbo].[sp_Takvim]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TAKVIM					VARCHAR(MAX)	= NULL,
	@RENK					VARCHAR(7)		= NULL,
	@ID_TAKVIM				INT				= NULL,
	@ID_KULLANICITIPI		INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@JSONKULLANICITIPI		VARCHAR(MAX)	= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ACIKLAMA				VARCHAR(MAX)	= NULL,
	@BAS_TARIH				VARCHAR(MAX)	= NULL,
	@BIT_TARIH				VARCHAR(MAX)	= NULL,
	@ID_TAKVIMETKINLIK		INT				= NULL,
	@ID_TAKVIMS				VARCHAR(MAX)	= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@ID_TATIL				INT				= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM				
			,TCKIMLIKNO						= @TCKIMLIKNO			
			,OTURUM							= @OTURUM				
			,ID_MENU						= @ID_MENU			
			,TAKVIM							= @TAKVIM				
			,RENK							= @RENK				
			,ID_TAKVIM						= @ID_TAKVIM			
			,ID_KULLANICITIPI				= @ID_KULLANICITIPI	
			,ID_KADEME3						= @ID_KADEME3			
			,JSONKULLANICITIPI				= @JSONKULLANICITIPI	
			,AD								= @AD					
			,ACIKLAMA						= @ACIKLAMA			
			,BAS_TARIH						= @BAS_TARIH			
			,BIT_TARIH						= @BIT_TARIH			
			,ID_TAKVIMETKINLIK				= @ID_TAKVIMETKINLIK	
			,ID_TAKVIMS						= @ID_TAKVIMS			
			,SQLJSON						= @SQLJSON			
			,ID_TATIL						= @ID_TATIL			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

		IF @ID_LOG > 1
		BEGIN
			SET LANGUAGE Turkish;

			IF @ISLEM = 1	--	Takvim Listele
			BEGIN
				SELECT
				(
					SELECT T.ID_TAKVIM, T.AD, CAST(COUNT(TE.ID_TAKVIMETKINLIK) AS VARCHAR) + ' adet etkinlik var' AS ETKINLIKSAYISI, T.RENK
					FROM [dbo].[Takvim] T
					LEFT JOIN TakvimEtkinlik TE ON TE.ID_TAKVIM=T.ID_TAKVIM AND (TE.AKTIF IS NULL OR TE.AKTIF=1)
					WHERE T.AKTIF=1
					GROUP BY T.ID_TAKVIM, T.AD, T.RENK
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 2	--	Takvim Ekle
			BEGIN
				INSERT INTO [dbo].[Takvim]
						   ([AD]
						   ,[RENK]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@TAKVIM
						   ,@RENK
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 3	--	Takvim Sil
			BEGIN
				UPDATE Takvim SET AKTIF = 0, SIL_TARIH=GETDATE(), SIL_TCKIMLIKNO=@TCKIMLIKNO WHERE ID_TAKVIM = @ID_TAKVIM
			END

			IF @ISLEM = 4	--	Kullanıcı Tipi Listele
			BEGIN
				SELECT
				(
					SELECT KT.ID_KULLANICITIPI, AD, CASE WHEN TY.ID_KULLANICITIPI IS NULL THEN 0 ELSE 1 END AS SELECTED FROM OkyanusDB.dbo.v3KullaniciTipi KT
					LEFT JOIN TakvimYetki TY ON TY.ID_KULLANICITIPI=KT.ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					GROUP BY KT.ID_KULLANICITIPI, AD, TY.ID_KULLANICITIPI
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 5	--	Kademe3 Listele
			BEGIN
				SELECT
				(
					SELECT K3.ID_KADEME3, AD, CASE WHEN TY.ID_KADEME3 IS NULL THEN 0 ELSE 1 END SELECTED FROM OkyanusDB.dbo.v3Kademe3 K3
					LEFT JOIN TakvimYetki TY ON TY.ID_KADEME3=K3.ID_KADEME3 AND TY.ID_KULLANICITIPI=@ID_KULLANICITIPI AND ID_TAKVIM=@ID_TAKVIM
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 6	--	Takvim Yetki Ekle
			BEGIN
				DELETE FROM TakvimYetki WHERE ID_TAKVIM = @ID_TAKVIM

				INSERT INTO [dbo].[TakvimYetki]
						   ([ID_TAKVIM]
						   ,[ID_KULLANICITIPI]
						   ,[ID_KADEME3]
						   ,[KYE_TCKIMLIKNO])
				SELECT @ID_TAKVIM, ID_KULLANICITIPI, ID_KADEME3, @TCKIMLIKNO
				FROM OPENJSON(@JSONKULLANICITIPI)
				WITH(ID_KULLANICITIPI INT, ID_KADEME3 INT, SELECTED BIT)
				WHERE SELECTED = 1
			END

			IF @ISLEM = 7	--	Takvim Etkinlik Listele
			BEGIN
				SELECT
				(
					SELECT	ID_TAKVIMETKINLIK
							,AD
							,ACIKLAMA
							,CONVERT(VARCHAR, BAS_TARIH, 104) AS BAS_TARIH
							,CONVERT(VARCHAR, BIT_TARIH, 104) AS BIT_TARIH 
					FROM TakvimEtkinlik 
					WHERE ID_TAKVIM=@ID_TAKVIM AND AKTIF=1 
					ORDER BY ID_TAKVIMETKINLIK DESC
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 8	--	Takvim Etkinlik Ekle
			BEGIN
				INSERT INTO [dbo].[TakvimEtkinlik]
						   ([ID_TAKVIM]
						   ,[AD]
						   ,[ACIKLAMA]
						   ,[BAS_TARIH]
						   ,[BIT_TARIH]
						   ,[KYE_TCKIMLIKNO])
					 VALUES
						   (@ID_TAKVIM
						   ,@AD
						   ,@ACIKLAMA
						   ,CONVERT(date,@BAS_TARIH,104)
						   ,CONVERT(date,@BIT_TARIH,104)
						   ,@TCKIMLIKNO)
			END

			IF @ISLEM = 9	--	Takvim Etkinlik Sil
			BEGIN
				UPDATE TakvimEtkinlik SET AKTIF = 0, SIL_TARIH = GETDATE(), SIL_TCKIMLIKNO = @TCKIMLIKNO WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 10	--	Takvim Etkinlik Güncelle
			BEGIN
				UPDATE TakvimEtkinlik SET AD = @AD, ACIKLAMA = @ACIKLAMA, BAS_TARIH = CONVERT(date,@BAS_TARIH,104), BIT_TARIH = CONVERT(date,@BIT_TARIH,104) WHERE ID_TAKVIMETKINLIK = @ID_TAKVIMETKINLIK
			END

			IF @ISLEM = 11	--	Duyuru Listele
			BEGIN
				CREATE TABLE #DUYURULAR (ID_DUYURUV2 INT, BASLIK VARCHAR(MAX), ICERIK VARCHAR(MAX), FOTOGRAF VARCHAR(MAX), TARIH VARCHAR(MAX), BANNER VARCHAR(MAX), EKDOSYA VARCHAR(MAX), FOTOGRAF_MOBIL VARCHAR(MAX))

				DECLARE @ID_KULLANICI INT = (SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);
				--DECLARE @OTURUM2 VARCHAR(MAX) = (SELECT OTURUM FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO);

				INSERT INTO #DUYURULAR
				EXEC eokul_v2.dbo.spDuyuruAnasayfa @ID_KULLANICI= @ID_KULLANICI, @OTURUM=@OTURUM

				SELECT
				(
					SELECT * FROM #DUYURULAR
					FOR JSON PATH
				) AS J

				DROP TABLE #DUYURULAR
			END

			IF @ISLEM = 12	--	Takvim Getir
			BEGIN
				DECLARE @DATE DATE = CONVERT(DATE, @BAS_TARIH, 104), @FIRSTDAY DATE, @LASTDAY DATE, @FIRSTWEEKDAY INT, @LASTWEEKDAY INT, @STARTDATE DATETIME, @ENDDATE DATETIME

				SELECT @FIRSTDAY = DATEADD(MONTH, DATEDIFF(MONTH, 0, @DATE), 0)
				SELECT @LASTDAY  = DATEADD(S, -1, DATEADD(MM, DATEDIFF(M, 0, @DATE) + 1, 0))

				SELECT @FIRSTWEEKDAY = DATEPART(DW, @FIRSTDAY)
				SELECT @LASTWEEKDAY  = DATEPART(DW, @LASTDAY)


				SELECT @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, @FIRSTWEEKDAY - 1	, @FIRSTDAY), 0)
				SELECT @ENDDATE	  = DATEADD(DAY, DATEDIFF(DAY, -(7 - @LASTWEEKDAY)	, @LASTDAY ), 0)

				;WITH DateList
				AS
				(
				SELECT @STARTDATE [Date]
				UNION ALL
				SELECT [Date] + 1 FROM DateList WHERE [Date] < @ENDDATE
				)
				SELECT [Date] = CAST([Date] AS DATE) INTO #DateList FROM DateList option (maxrecursion 0);
				
				IF @ID_KULLANICITIPI NOT IN (4,5) AND (4 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO) AND 5 NOT IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO))
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								 SELECT DISTINCT TE.AD						AS 'AD'
								,TE.ACIKLAMA								AS 'ACIKLAMA'
								,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
								,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
								,T.RENK										AS 'RENK'
								,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
								,TE.ID_TAKVIM								AS 'ID_TAKVIM'
								,ISNULL((SELECT STUFF((SELECT   ', ' + CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
												LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
													AND  ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, '')),
										(SELECT STUFF((SELECT   ', ' + KT.AD
												FROM  TakvimYetki		TY	
												INNER JOIN	 OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI 
												WHERE	TY.ID_TAKVIM=T.ID_TAKVIM
												FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))) 
								AS 'YETKI'

								--,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								--INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								--INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								--LEFT JOIN	OkyanusDB.dbo.v3KullaniciKademe3 KK3 ON KK3.ID_KADEME3 = TY.ID_KADEME3 AND KK3.TCKIMLIKNO=@TCKIMLIKNO
								--LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = KK3.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									--AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									
									--AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,D.DERSAD + ' - (' + O.BASLIK + ')' AS AD
										,'#0000FF' AS RENK
										,'0' AS TC_OGRENCI
								FROM		OdevSinifOgrenci	OSO
								INNER JOIN	OdevSinif			OS	ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev				O	ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders	D	ON D.ID_DERS = O.ID_DERS
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF = 1
								AND O.KYE_KULLANICI = @TCKIMLIKNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,D.DERSAD + ' - (' + E.ETUT + ')' AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E					
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= E.TC_OGRETMEN
								WHERE	E.TC_OGRETMEN	= @TCKIMLIKNO
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT 
							 CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
							,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
							,GUN	= DAY(Date)
							,YIL	= YEAR(Date)
							,GUNAD	= DATENAME(DW, Date) 
							,AYAD	= DATENAME(MONTH, Date)
							,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
							,(
								SELECT DISTINCT 
										 TE.AD										AS 'AD'
										,TE.ACIKLAMA								AS 'ACIKLAMA'
										,CONVERT(VARCHAR(10), TE.BAS_TARIH, 104)	AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), TE.BIT_TARIH, 104)	AS 'BIT_TARIH'
										,T.RENK										AS 'RENK'
										,TE.ID_TAKVIMETKINLIK						AS 'ID_TAKVIMETKINLIK'
										,TE.ID_TAKVIM								AS 'ID_TAKVIM'
										,CASE WHEN TY.ID_KULLANICITIPI IN (4,5) THEN K3.AD + ' ' + KT.AD ELSE KT.AD END AS 'YETKI' 
								FROM TakvimEtkinlik	TE		
								INNER JOIN	Takvim			T	ON	T.ID_TAKVIM=TE.ID_TAKVIM 
								INNER JOIN	TakvimYetki		TY	ON	TY.ID_TAKVIM=T.ID_TAKVIM
								INNER JOIN	OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = TY.ID_KULLANICITIPI
								LEFT JOIN	OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = TY.ID_KADEME3
								WHERE  (@ID_TAKVIMS='[]' OR @ID_TAKVIMS IS NULL OR TE.ID_TAKVIM IN (SELECT VALUE FROM OPENJSON(@ID_TAKVIMS)))
									AND DL.Date BETWEEN CAST(TE.BAS_TARIH AS DATE) AND CAST(TE.BIT_TARIH AS DATE)
									AND TE.BAS_TARIH>=BAS_TARIH AND TE.BIT_TARIH<=@ENDDATE
									AND TE.AKTIF=1
									AND T.AKTIF=1
									AND ((@ID_KULLANICITIPI=0 AND TY.ID_KULLANICITIPI IN (SELECT DISTINCT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)) OR TY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
									AND ((@ID_KADEME3=0 AND (TY.ID_KADEME3=0 OR TY.ID_KADEME3 IN (SELECT DISTINCT ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO))) OR TY.ID_KADEME3=@ID_KADEME3)
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'Liste'
							,(
								SELECT DISTINCT 
										 O.ID_ODEV
										,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + O.BASLIK + ')' ELSE D.DERSAD + ' - (' + O.BASLIK + ')' END AS AD
										,'#0000FF' AS RENK
										,CASE WHEN O.ID_ODEVTUR = 5 THEN OSO.TCKIMLIKNO ELSE '0' END AS TC_OGRENCI
								FROM OdevSinifOgrenci					OSO
								INNER JOIN	OdevSinif					OS		ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
								INNER JOIN	Odev						O		ON O.ID_ODEV = OS.ID_ODEV
								INNER JOIN	eokul_v2.dbo.Ders			D		ON D.ID_DERS = O.ID_DERS
								INNER JOIN	OkyanusDB.dbo.v3Kullanici	K		ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci		OG		ON OG.TCKIMLIKNO = @TCKIMLIKNO
								WHERE DL.Date = CAST(O.TESLIM_TARIHI AS DATE)
								AND O.AKTIF=1
								AND (OSO.TCKIMLIKNO = @TCKIMLIKNO OR OSO.TCKIMLIKNO IN (SELECT TCKIMLIKNO_OGR FROM OkyanusDB.dbo.v3OgrenciVeli WHERE TCKIMLIKNO = @TCKIMLIKNO))
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeOdev'
							,(
								SELECT DISTINCT
									 E.ID_ETUT
									,CASE WHEN OG.TCKIMLIKNO IS NULL THEN K.AD + ' ' + K.SOYAD + ' - ' + D.DERSAD + ' - (' + E.ETUT + ')' 
										ELSE D.DERSAD + ' - (' + E.ETUT + ')' 
									END AS AD
									,'#FF7F24' AS RENK
									,'0' AS TC_OGRENCI
								FROM		Etut					E
								INNER JOIN	EtutOgrenci				EO	ON	EO.ID_ETUT		= E.ID_ETUT
								INNER JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
								INNER JOIN	v3Kullanici				K	ON	K.TCKIMLIKNO	= EO.TC_OGRENCI
								LEFT JOIN	OkyanusDB.dbo.v3Ogrenci	OG	ON	OG.TCKIMLIKNO	= @TCKIMLIKNO
								WHERE	EO.TC_OGRENCI	= @TCKIMLIKNO
									AND EO.AKTIF		= 1
									AND E.AKTIF			= 1
									AND E.TARIH			= DL.Date
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS 'ListeEtut'
						FROM		#DateList		DL
						ORDER BY DL.Date ASC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS J
				END
				DROP TABLE #DateList
			END		

			IF @ISLEM = 13	--	TAKVİM ETKİNLİK EKLE EXCEL
			BEGIN
				INSERT INTO TakvimEtkinlik (ID_TAKVIM, AD, ACIKLAMA, BAS_TARIH, BIT_TARIH, KYE_TCKIMLIKNO)
				SELECT @ID_TAKVIM, AD, ACIKLAMA, BASLANGIC, BITIS, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
				WITH(
					AD VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					BASLANGIC VARCHAR(MAX),
					BITIS VARCHAR(MAX)
				)
			END	
			IF @ISLEM = 14 -- TATİL LİSTELE
			BEGIN
			
				SELECT 
					 ID
					,ADI
					,CONVERT(VARCHAR, BASLANGIC_TARIH, 104)	AS BASLANGIC_TARIH
					,CONVERT(VARCHAR, BITIS_TARIH, 104)		AS BITIS_TARIH 
				FROM Tatil 
				ORDER BY BASLANGIC_TARIH 			
			END 
			IF @ISLEM = 15 --TATİL EKLE
			BEGIN
				INSERT INTO Tatil (ADI,BASLANGIC_TARIH,BITIS_TARIH) 
				VALUES(@AD,@BAS_TARIH,@BIT_TARIH)
			END

			IF @ISLEM = 16 --TATİL Sil
			BEGIN
				DELETE FROM Tatil WHERE ID=@ID_TATIL
			END
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_TestMaddeAnalizi]...';


GO
ALTER procedure [dbo].[sp_TestMaddeAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SINIFALANLIST		VARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ICDISOGRENCI		INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END	
		
		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )


		IF (@ISLEM = 1 OR @ISLEM = 2)  -- SINIF
		BEGIN
		
			IF @ICDISOGRENCI IS NULL 
				SET @ICDISOGRENCI = 0
			
			DROP TABLE IF EXISTS #ALTCEVAPLAR
			DROP TABLE IF EXISTS #ALTGRUP
			DROP TABLE IF EXISTS #DERECE
			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #USTCEVAPLAR
			DROP TABLE IF EXISTS #USTGRUP
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #SUBE
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #SINAV
			DROP TABLE IF EXISTS #SINIFALAN
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #TEMPDERS
			DROP TABLE IF EXISTS #GOSTERDERS
			DROP TABLE IF EXISTS #OGRBOLUM

			
			
			
			SELECT VALUE ID_SUBE  INTO #SUBE		FROM OPENJSON(@ID_SUBEs )
			SELECT VALUE ID_DERS  INTO #DERS		FROM OPENJSON(@ID_DERSs )
			SELECT VALUE ID_SINAV INTO #SINAV		FROM OPENJSON(@ID_SINAVs)
			SELECT VALUE ALAN	  INTO #SINIFALAN	FROM OPENJSON(@SINIFALANLIST)

			
			
			SELECT T.* 
			INTO #SINIFLIST
			FROM v3SinifTum	T
			JOIN v3Donem	D	ON	D.ID_DONEM	= T.ID_DONEM
			JOIN #SUBE		S	ON	S.ID_SUBE	= D.ID_SUBE
			WHERE	T.DONEM			= @OGRENCIDONEM
				AND @ICDISOGRENCI	IN (0,1)
				AND (	(SELECT COUNT(1) FROM #SINIFALAN) = 0
					OR	EXISTS (SELECT * FROM #SINIFALAN A WHERE T.AD LIKE '%'+ A.ALAN +'%')
					)



			--SELECT TOP 10 * FROM vw_SinavOgrenciSoru
			
			SELECT
				 ID_SINAV		= S.ID_SINAV
				,SINAVAD		= S.AD
				,SINAVTARIH		= CONVERT(VARCHAR,S.SINAVTARIH,103) 
				,TCKIMLIKNO		= OS.TCKIMLIKNO
				,ID_DERS		= SD.ID_DERS
				,DERSAD			= SD.TAKMAAD 
				,DOGRU			= OB.DOGRU
				,NET			= OB.NET
				,DURUM			= OS.DURUM
				,OGRENCICEVAP	= OS.CEVAP
				,DOGRUCEVAP		= OS.DOGRUCEVAP
				,SORUNO_A		= OS.SORUNO_A	
				,BOLUMNO		= OB.BOLUMNO
				,OLCEKSINAVI	= S.OLCEKSINAVI 
				,KATSAYI		= SA.KATSAYI
				,OZNEL			= CAST(CASE WHEN S.OLCEKSINAVI = 1 AND SA.KATSAYI IS NOT NULL THEN 1 ELSE 0 END AS BIT)
				,PUAN			= OB.PUAN	
				,BILGI			= ISNULL(B.AD, '')
				,BILISSELSUREC	= ISNULL(BS.AD, '')
			INTO #TEMP_OGRENCI
			FROM Pusulam.dbo.Sinav					S	WITH (NOLOCK)		
			JOIN #SINAV								TS					ON	TS.ID_SINAV			= S.ID_SINAV
			JOIN Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN Pusulam.dbo.v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN #SINIFLIST							SL					ON	SL.ID_SINIF			= O.ID_SINIF
			JOIN #SUBE								TB					ON	TB.ID_SUBE			= O.ID_SUBE
			JOIN Pusulam.dbo.vw_SinavOgrenciBolum	OB					ON	OB.ID_SINAV			= S.ID_SINAV
																		AND OB.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= OB.ID_SINAVDERS
			JOIN Pusulam.dbo.vw_SinavOgrenciSoru	OS					ON	OS.ID_SINAV			= S.ID_SINAV
																		AND OS.TCKIMLIKNO		= SO.TCKIMLIKNO
																		AND OS.ID_SINAVDERS		= SD.ID_SINAVDERS
			JOIN Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																		AND SA.SORUNO_A			= OS.SORUNO_A
																		AND SA.ID_SINAVKITAPCIK	= OS.ID_SINAVKITAPCIK
			LEFT JOIN	Pusulam.dbo.Bilgi			B	WITH (NOLOCK)	ON	B.ID_BILGI			= SA.ID_BILGI
			LEFT JOIN	Pusulam.dbo.BilisselSurec	BS	WITH (NOLOCK)	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC														
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (S.OZEL			= 0		OR	@OZELSINAVGOR = 1)
				AND @ICDISOGRENCI	= 1
		UNION		
			SELECT
				 ID_SINAV		= S.ID_SINAV
				,SINAVAD		= S.AD
				,SINAVTARIH		= CONVERT(VARCHAR,S.SINAVTARIH,103) 
				,TCKIMLIKNO		= OS.TCKIMLIKNO
				,ID_DERS		= SD.ID_DERS
				,DERSAD			= SD.TAKMAAD 
				,DOGRU			= OB.DOGRU
				,NET			= OB.NET
				,DURUM			= OS.DURUM
				,OGRENCICEVAP	= OS.CEVAP
				,DOGRUCEVAP		= OS.DOGRUCEVAP
				,SORUNO_A		= OS.SORUNO_A	
				,BOLUMNO		= OB.BOLUMNO
				,OLCEKSINAVI	= S.OLCEKSINAVI 
				,KATSAYI		= SA.KATSAYI
				,OZNEL			= CAST(CASE WHEN S.OLCEKSINAVI = 1 AND SA.KATSAYI IS NOT NULL THEN 1 ELSE 0 END AS BIT)
				,PUAN			= OB.PUAN	
				,BILGI			= ISNULL(B.AD, '')
				,BILISSELSUREC	= ISNULL(BS.AD, '')
			--INTO #TEMP_OGRENCI
			FROM Pusulam.dbo.Sinav					S	WITH (NOLOCK)		
			JOIN #SINAV								TS					ON	TS.ID_SINAV			= S.ID_SINAV
			JOIN Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV			
			JOIN Pusulam.dbo.v3Sube					SB	WITH (NOLOCK)	ON	CAST(SB.SUBENO AS INT)	= CAST(SO.SUBENO AS INT)
			JOIN #SUBE								TB					ON	TB.ID_SUBE			= SB.ID_SUBE
			JOIN Pusulam.dbo.vw_SinavOgrenciBolum	OB					ON	OB.ID_SINAV			= S.ID_SINAV
																		AND OB.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= OB.ID_SINAVDERS
			JOIN Pusulam.dbo.vw_SinavOgrenciSoru	OS					ON	OS.ID_SINAV			= S.ID_SINAV
																		AND OS.TCKIMLIKNO		= SO.TCKIMLIKNO
																		AND OS.ID_SINAVDERS		= SD.ID_SINAVDERS
			JOIN Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																		AND SA.SORUNO_A			= OS.SORUNO_A	
																		AND SA.ID_SINAVKITAPCIK	= OS.ID_SINAVKITAPCIK
			LEFT JOIN	Pusulam.dbo.Bilgi			B	WITH (NOLOCK)	ON	B.ID_BILGI			= SA.ID_BILGI
			LEFT JOIN	Pusulam.dbo.BilisselSurec	BS	WITH (NOLOCK)	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC														
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (S.OZEL			= 0		OR	@OZELSINAVGOR = 1)
				AND (@ICDISOGRENCI	= 0
					OR (	@ICDISOGRENCI	= 2  
						AND SUBSTRING(SO.SINIF,1,4) = 'OKY-'
						)
					)
			

			SELECT DISTINCT T.BOLUMNO 
			INTO #GOSTERDERS
			FROM #TEMP_OGRENCI	T
			JOIN #DERS			D	ON	D.ID_DERS =	T.ID_DERS


				DROP TABLE IF EXISTS #TEMP
				SELECT  DISTINCT DURUM, COUNT(DURUM) DURUMSAYISI,0 KISISAYISI, DERSAD, BOLUMNO, SORUNO_A, 0 CEVAPLAYANSAYISI, OZNEL
				INTO #TEMP
				FROM #TEMP_OGRENCI T
				GROUP BY BOLUMNO, SORUNO_A,DURUM, DERSAD, OZNEL

				UPDATE T
				SET	 KISISAYISI			=		 (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO)				
					,CEVAPLAYANSAYISI	= ISNULL((SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO AND DURUM != 'B'),0)
				FROM #TEMP T

				
				-- HİÇ DOĞRU YAPILMAMIŞSA
				INSERT INTO #TEMP (DURUM, DURUMSAYISI,KISISAYISI, DERSAD, BOLUMNO, SORUNO_A, CEVAPLAYANSAYISI, OZNEL)
				SELECT DISTINCT 'D', 0, T.KISISAYISI, T.DERSAD, T.BOLUMNO, T.SORUNO_A, 0, OZNEL
				FROM #TEMP T
				WHERE NOT EXISTS (
					SELECT DISTINCT BOLUMNO, SORUNO_A
					FROM #TEMP S
					WHERE DURUM = 'D'
						AND S.BOLUMNO = T.BOLUMNO
						AND S.SORUNO_A = T.SORUNO_A
				)
				
				DROP TABLE IF EXISTS #OGRENCIBOLUMNET
				SELECT DISTINCT TCKIMLIKNO,BOLUMNO, DOGRU AS NET, RN = 0, MAX_RN = 0 
				INTO #OGRENCIBOLUMNET
				FROM #TEMP_OGRENCI 

				UPDATE O 
				SET O.RN=G.RN2
				FROM #OGRENCIBOLUMNET O 
				JOIN (	SELECT D.BOLUMNO, D.TCKIMLIKNO, RN2 = ROW_NUMBER() OVER(PARTITION BY D.BOLUMNO ORDER BY D.NET DESC,D.TCKIMLIKNO)  
						FROM #OGRENCIBOLUMNET D
					) AS G	ON	G.TCKIMLIKNO	= O.TCKIMLIKNO 
							AND G.BOLUMNO		= O.BOLUMNO
				

				UPDATE O 
				SET O.MAX_RN = D.MAX_RN
				FROM #OGRENCIBOLUMNET O 
				JOIN (
					SELECT MAX(RN) MAX_RN , BOLUMNO
					FROM #OGRENCIBOLUMNET S 
					GROUP BY S.BOLUMNO 
				) AS D ON D.BOLUMNO = O.BOLUMNO
				
				--SELECT * FROM #OGRENCIBOLUMNET
				--ORDER BY RN,BOLUMNO
				--RETURN
				
				DROP TABLE IF EXISTS #OGRSAY
				SELECT BOLUMNO, OGRSAY = IIF( O.MAX_RN > 100, cast(O.MAX_RN * 27 / 100.0 as int) ,CAST(CAST(O.MAX_RN AS DECIMAL(8,2)) / 2 AS DECIMAL(8,2)))
				INTO #OGRSAY
				FROM #OGRENCIBOLUMNET O
				GROUP BY BOLUMNO, MAX_RN

				--DECLARE @OGRSAY INT = (SELECT TOP 1 cast(O.MAX_RN * 27 / 100.0 as int)  FROM #OGRENCIBOLUMNET O)

				DROP TABLE IF EXISTS #ALTGRUP
				SELECT O.* 
				INTO #ALTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN >= O.MAX_RN - S.OGRSAY + 1
					--	(	O.MAX_RN > 100	AND RN >= O.MAX_RN - S.OGRSAY + 1 )
					--OR	(	O.MAX_RN <= 100 AND RN > CAST(O.MAX_RN / 2 AS INT) )
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
								
				DROP TABLE IF EXISTS #USTGRUP
				SELECT O.* 
				INTO #USTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN <= S.OGRSAY
					--(	O.MAX_RN > 100  AND RN <= S.OGRSAY )
					--OR (	O.MAX_RN <= 100 AND RN <= CAST(O.MAX_RN / 2 AS INT))
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
			
				--SELECT * FROM #OGRSAY where bolumno = 1
				--SELECT * FROM #USTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #ALTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #TEMP_OGRENCI where bolumno = 1 and SORUNO_A = 1
				DROP TABLE IF EXISTS #DERECE
				SELECT DISTINCT O.BOLUMNO
					,O.SORUNO_A
					,O.DURUM
					,O.DERSAD
					,DOGRUCEVAP
					,DOGRUSAYISI	= ISNULL(T.DURUMSAYISI,0)
					,USTKISISAYISI	= COUNT(DISTINCT U.TCKIMLIKNO)
					,ALTKISISAYISI	= COUNT(DISTINCT A.TCKIMLIKNO)
					--,O.OLCEKSINAVI
					,ZORLUKDERECESI		= CONVERT(DECIMAL(8,2),	
											CASE WHEN O.OZNEL = 0 THEN	CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float) /	NULLIF(CAST((S.OGRSAY * 2) AS float),0.0)
												 ELSE					ISNULL(CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float)* O.KATSAYI /  NULLIF((	CAST((S.OGRSAY * 2) AS float) * O.KATSAYI),0.0),0.0)
											END
										)
					,AYIRICILIK			= CONVERT(DECIMAL(8,2),	CASE WHEN O.OZNEL = 0 THEN	CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  NULLIF(CAST(S.OGRSAY AS float),0.0)
																	 ELSE					ISNULL(CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float)* O.KATSAYI /  NULLIF((CAST(S.OGRSAY AS float) * O.KATSAYI),0.0),0)
																END
																)
					,VARYANS			= CONVERT(DECIMAL(8,2),0)
					,SAPMA				= CONVERT(DECIMAL(8,2),0)
					,T.KISISAYISI
					,T.CEVAPLAYANSAYISI
					,O.BILGI
					,O.BILISSELSUREC
				INTO #DERECE
				FROM #TEMP				T
				JOIN #TEMP_OGRENCI		O	ON	O.BOLUMNO		= T.BOLUMNO
											AND O.SORUNO_A		= T.SORUNO_A
											AND O.DURUM			= T.DURUM
				JOIN #OGRSAY			S	ON	S.BOLUMNO		= O.BOLUMNO
				LEFT JOIN #USTGRUP		U	ON	U.TCKIMLIKNO	= O.TCKIMLIKNO 
											AND U.BOLUMNO		= O.BOLUMNO
				LEFT JOIN #ALTGRUP		A	ON	A.TCKIMLIKNO	= O.TCKIMLIKNO
											AND A.BOLUMNO		= O.BOLUMNO
				WHERE O.DURUM = 'D' 
				GROUP BY O.BOLUMNO, O.SORUNO_A, O.DURUM, O.DERSAD, T.KISISAYISI, O.DOGRUCEVAP, T.DURUMSAYISI,T.CEVAPLAYANSAYISI, S.OGRSAY,O.OZNEL, O.KATSAYI, O.BILGI, O.BILISSELSUREC


				UPDATE #DERECE SET	
					 VARYANS			= ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)
					,SAPMA				= SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)))
					--,MADDEGUVENILIRLIK	= Convert(Decimal(8,2),isnull(AYIRICILIK*SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI))),0.00))


				-- HİÇ DOĞRU YAPILMAMIŞSA
				INSERT INTO #DERECE (BOLUMNO,SORUNO_A,DURUM,DERSAD,DOGRUCEVAP,DOGRUSAYISI,USTKISISAYISI,ALTKISISAYISI,ZORLUKDERECESI,AYIRICILIK,VARYANS,SAPMA,KISISAYISI,CEVAPLAYANSAYISI,BILGI,BILISSELSUREC)
				SELECT DISTINCT T.BOLUMNO, T.SORUNO_A, 'D', T.DERSAD, O.DOGRUCEVAP, 0, 0 , 0 ,0 ,0 ,0 ,0 ,T.KISISAYISI, 0 ,O.BILGI, O.BILISSELSUREC
				FROM #TEMP			T
				JOIN #TEMP_OGRENCI	O	ON	O.BOLUMNO		= T.BOLUMNO
										AND O.SORUNO_A		= T.SORUNO_A
										AND O.DURUM			= T.DURUM
				LEFT JOIN #DERECE	D	ON	D.BOLUMNO	= T.BOLUMNO
										AND	D.SORUNO_A	= T.SORUNO_A
				WHERE D.BOLUMNO IS NULL


				DROP TABLE IF EXISTS #USTCEVAPLAR
				SELECT O.TCKIMLIKNO,O.BOLUMNO,O.SORUNO_A, IIF(O.DURUM='B','BOS',O.OGRENCICEVAP) OGRENCICEVAP, U.TCKIMLIKNO UST_TC
				INTO #USTCEVAPLAR
				FROM #TEMP_OGRENCI		O
				JOIN #USTGRUP			U	ON	U.TCKIMLIKNO	= O.TCKIMLIKNO 
											AND U.BOLUMNO		= O.BOLUMNO
											
				DROP TABLE IF EXISTS #ALTCEVAPLAR
				SELECT O.TCKIMLIKNO,O.BOLUMNO,O.SORUNO_A,IIF(O.DURUM='B','BOS',O.OGRENCICEVAP) OGRENCICEVAP, A.TCKIMLIKNO ALT_TC
				INTO #ALTCEVAPLAR
				FROM #TEMP_OGRENCI		O
				JOIN #ALTGRUP			A	ON	A.TCKIMLIKNO	= O.TCKIMLIKNO 
											AND A.BOLUMNO		= O.BOLUMNO

											
			DECLARE @VARYANS FLOAT,@V1  FLOAT,@P FLOAT,@KR20 DECIMAL(8,4)

			SET @V1			= (SELECT CONVERT(DECIMAL(8,2),SUM(DOGRUSAYISI))/MAX(KISISAYISI) FROM #DERECE)				
			SET @VARYANS	= (SELECT SQUARE(SUM(CONVERT(DECIMAL(8,2),DOGRUSAYISI)-@V1)) / MAX(KISISAYISI) FROM #DERECE)
			SET @P			= (SELECT SUM(  (CAST(DOGRUSAYISI AS DECIMAL(8,2))/KISISAYISI)*ABS(1-CAST(DOGRUSAYISI AS DECIMAL(8,2))/KISISAYISI)  ) FROM #DERECE)
			SET @KR20		= (SELECT CONVERT(DECIMAL(8,4), (COUNT(1)/(COUNT(1)-1))*(1-(@P/NULLIF(@VARYANS, 0.0)))) FROM #DERECE)

			DROP TABLE IF EXISTS #TEMPDERS
			DROP TABLE IF EXISTS #OGRBOLUM
			--;WITH OGRBOLUM AS (
				SELECT DISTINCT 
					 TCKIMLIKNO
					,BOLUMNO
					,PUAN
					,NET
					,NETSIRA	= ROW_NUMBER() OVER(PARTITION BY BOLUMNO ORDER BY NET ) 
					,PUANSIRA	= ROW_NUMBER() OVER(PARTITION BY BOLUMNO ORDER BY PUAN) 
				INTO #OGRBOLUM
				FROM #TEMP_OGRENCI
			--)
			SELECT
				 O.OZNEL
				,O.BOLUMNO
				,SAPMA			= CAST((SELECT ISNULL( AVG(D.SAPMA) ,0)FROM #DERECE D WHERE D.BOLUMNO = O.BOLUMNO) AS DECIMAL(8,2))
				,KR20			= ISNULL(@KR20, 0)
				,ZORLUK			= CONVERT(DECIMAL(8,2),0)
				,AYIRICILIK		= CONVERT(DECIMAL(8,2),0)

				,MEDYAN			= CAST(CASE WHEN O.OZNEL = 1	THEN (SELECT TOP 1 S.PUAN	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO AND S.PUANSIRA	= MAX(B.PUANSIRA)/2)
								 								ELSE (SELECT TOP 1 S.NET	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO AND S.NETSIRA	= MAX(B.NETSIRA )/2)
								  END  AS  DECIMAL(8,2))
				,ORTALAMA		= CAST(CASE WHEN O.OZNEL = 1	THEN (SELECT AVG(S.PUAN)	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								 								ELSE (SELECT AVG(S.NET )	FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								  END  AS  DECIMAL(8,2))
				,SINAVKATILIM	= ISNULL((SELECT DISTINCT KISISAYISI FROM #DERECE D WHERE D.BOLUMNO = O.BOLUMNO) ,0)
				,RANJ			= CAST(CASE WHEN O.OZNEL = 1	THEN (SELECT MAX(S.PUAN) - MIN(S.PUAN) FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								 								ELSE (SELECT MAX(S.NET ) - MIN(S.NET ) FROM #OGRBOLUM S WHERE S.BOLUMNO = O.BOLUMNO )
								  END  AS  DECIMAL(8,2))
				,SORUSAYISI		= (SELECT COUNT(DISTINCT G.SORUNO_A) FROM #TEMP G WHERE G.BOLUMNO = O.BOLUMNO) 
			INTO #TEMPDERS
			FROM #TEMP_OGRENCI	O
			JOIN #OGRBOLUM		B	ON	B.BOLUMNO = O.BOLUMNO
			GROUP BY O.BOLUMNO, O.OZNEL


			UPDATE T SET
				 ZORLUK		= CAST((SELECT (SUM(D.ZORLUKDERECESI	) * 1.0 / COUNT(1) /*SORUSAYISI*/)	FROM #DERECE D) AS DECIMAL(8,2))
				,AYIRICILIK = CAST((SELECT (SUM(D.AYIRICILIK		) * 1.0 / COUNT(1) /*SORUSAYISI*/)	FROM #DERECE D) AS DECIMAL(8,2))
				--,SORUSAYISI = (SELECT COUNT(DISTINCT D.SORUNO_A ) FROM #DERECE D WHERE D.BOLUMNO = T.BOLUMNO)
			FROM #TEMPDERS T

			SELECT ISNULL(SA.ID_BILGI, 0) AS ID_BILGI, ISNULL(SA.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC, COUNT(1) AS SAYI
			INTO #BILGIBILISSEL
			FROM SinavDers SD
			JOIN SinavAnahtar SA ON SA.ID_SINAVDERS = SD.ID_SINAVDERS 
			JOIN SinavKitapcik SK ON SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK
			WHERE SD.ID_SINAV = (SELECT TOP 1 ID_SINAV FROM #SINAV) AND SK.AD = 'A'
			GROUP BY SA.ID_BILGI, SA.ID_BILISSELSUREC
		
			SELECT *
			INTO #TEMPBB
			FROM (
				SELECT B.AD AS [BİLGİ - BİLİŞSEL SÜREÇ], BS.AD AS BILISSELSUREC, SAYI
				FROM #BILGIBILISSEL BB
				JOIN Bilgi B ON B.ID_BILGI = BB.ID_BILGI
				JOIN BilisselSurec BS ON BS.ID_BILISSELSUREC = BB.ID_BILISSELSUREC
			) AS pTablom
			PIVOT
			(
			SUM(SAYI)
			FOR BILISSELSUREC IN ([Hatırlama], [Anlama], [Uygulama], [Çözümleme], [Değerlendirme], [Yaratma])
			)
			AS Pvt

			IF (SELECT COUNT(1) FROM #TEMPBB) = 0
			BEGIN
				INSERT INTO #TEMPBB ([BİLGİ - BİLİŞSEL SÜREÇ], [Hatırlama], [Anlama], [Uygulama], [Çözümleme], [Değerlendirme], [Yaratma])
				SELECT AD, '', '', '', '', '', ''
				FROM Bilgi
			END

			DROP TABLE #BILGIBILISSEL

			IF @ISLEM = 1  -- JSON
			BEGIN			
				select(
					select * from(
						select 
						(	
							SELECT * ,
								case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
										when ZORLUKDERECESI < 0.35 then 'Zor'
										when ZORLUKDERECESI < 0.65 then 'Önerilen'
										when ZORLUKDERECESI < 0.80 then 'Kolay'
										when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
								end as [ZORLUKACIKLAMA],
								case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     							when AYIRICILIK < 0.30 then 'Sınırda'
		   								when AYIRICILIK < 0.40 then 'İyi'
		     							when AYIRICILIK > 0.39 then 'Çok İyi' 
								end as [AYIRICILIKACIKLAMA]
							FROM #DERECE							
							WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblVeri,					
						(		
							SELECT	 BOLUMNO,SORUNO_A
									,A		= ISNULL(P.A,0)
									,B		= ISNULL(P.B,0)
									,C		= ISNULL(P.C,0)
									,D		= ISNULL(P.D,0)
									,E		= ISNULL(P.E,0)
									,BOS	= ISNULL(P.BOS,0)
									,TOPLAM	= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
							FROM (
								SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
								FROM #USTCEVAPLAR
								WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
								GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
							) AS G
							PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblUstList	,		
						(		
							SELECT	 BOLUMNO
									,SORUNO_A
									,A		= ISNULL(P.A,0)
									,B		= ISNULL(P.B,0)
									,C		= ISNULL(P.C,0)
									,D		= ISNULL(P.D,0)
									,E		= ISNULL(P.E,0)
									,BOS	= ISNULL(P.BOS,0)
									,TOPLAM	= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
							FROM (
								SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
								FROM #ALTCEVAPLAR
								WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
								GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
							) AS G
							PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblAltList,
						(
							SELECT DISTINCT SINAVAD,SINAVTARIH
							FROM #TEMP_OGRENCI 
							WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
							FOR JSON AUTO
						) as TblSinavOzellik,
						(							
							SELECT DISTINCT 
								 T.BOLUMNO
								,T.DERSAD
								,D.SORUSAYISI
								,D.SINAVKATILIM
								,D.ORTALAMA
								,D.SAPMA
								,D.MEDYAN
								,D.ZORLUK
								,D.AYIRICILIK
								,D.RANJ
								,D.KR20
							FROM #TEMP		T
							JOIN #TEMPDERS	D	ON	D.BOLUMNO = T.BOLUMNO
							WHERE T.BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
							ORDER BY BOLUMNO,DERSAD 
							FOR JSON PATH, INCLUDE_NULL_VALUES
						) as TblDersList,
						(	
							SELECT	 [ZORLUK_CZ]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.20								)
									,[ZORLUK_Z]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.35 AND S.ZORLUKDERECESI > 0.19 )
									,[ZORLUK_O]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.65 AND S.ZORLUKDERECESI > 0.34 )
									,[ZORLUK_K]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.80 AND S.ZORLUKDERECESI > 0.64 )
									,[ZORLUK_CK]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND								S.ZORLUKDERECESI > 0.79 )
																											   
									--,[AYIRICILIK_K] = (SELECT COUNT(1) FROM #DERECE S WHERE S.AYIRICILIK < 0							)
									,[AYIRICILIK_Z] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.20							)
									,[AYIRICILIK_S] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.30 AND S.AYIRICILIK > 0.19 )
									,[AYIRICILIK_I] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.40 AND S.AYIRICILIK > 0.29 )
									,[AYIRICILIK_CI]= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND							S.AYIRICILIK > 0.39 )
							FOR JSON PATH
						) as TblGrup,
						(
							SELECT *
							FROM #TEMPBB
							FOR JSON PATH
						) AS BilgiBilisselSurec
						
					) as tablo FOR JSON AUTO
				) as tt		

			END
			ELSE
			BEGIN
				SELECT * ,
					case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
							when ZORLUKDERECESI < 0.35 then 'Zor'
							when ZORLUKDERECESI < 0.65 then 'Önerilen'
							when ZORLUKDERECESI < 0.80 then 'Kolay'
							when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
					end as [ZORLUKACIKLAMA],
					case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     				when AYIRICILIK < 0.30 then 'Sınırda'
		   					when AYIRICILIK < 0.40 then 'İyi'
		     				when AYIRICILIK > 0.39 then 'Çok İyi' 
					end as [AYIRICILIKACIKLAMA]
				FROM #DERECE
				WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
				ORDER BY BOLUMNO,SORUNO_A
				
				SELECT	 BOLUMNO,SORUNO_A
						,A	= ISNULL(P.A,0)
						,B	= ISNULL(P.B,0)
						,C	= ISNULL(P.C,0)
						,D	= ISNULL(P.D,0)
						,E	= ISNULL(P.E,0)
						,BOS= ISNULL(P.BOS,0)
						,TOPLAM= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
				FROM (
					SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
					FROM #USTCEVAPLAR
					WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
					GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
				) AS G
				PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
				ORDER BY BOLUMNO,SORUNO_A

				SELECT	 BOLUMNO,SORUNO_A
						,A	= ISNULL(P.A,0)
						,B	= ISNULL(P.B,0)
						,C	= ISNULL(P.C,0)
						,D	= ISNULL(P.D,0)
						,E	= ISNULL(P.E,0)
						,BOS= ISNULL(P.BOS,0)
						,TOPLAM= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
				FROM (
					SELECT OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A 
					FROM #ALTCEVAPLAR
					WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
					GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
				) AS G
				PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
				ORDER BY BOLUMNO,SORUNO_A

				SELECT DISTINCT SINAVAD,SINAVTARIH
				FROM #TEMP_OGRENCI 				
				WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
								
				
				SELECT DISTINCT 
					 T.BOLUMNO
					,T.DERSAD
					,D.SORUSAYISI
					,D.SINAVKATILIM
					,D.ORTALAMA
					,D.SAPMA
					,D.MEDYAN
					,D.ZORLUK
					,D.AYIRICILIK
					,D.RANJ
					,D.KR20
				FROM #TEMP		T
				JOIN #TEMPDERS	D	ON	D.BOLUMNO = T.BOLUMNO
				WHERE T.BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD)
				ORDER BY BOLUMNO,DERSAD 
								
				SELECT	 [ZORLUK_CZ]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.20								)
						,[ZORLUK_Z]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.35 AND S.ZORLUKDERECESI > 0.19 )
						,[ZORLUK_O]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.65 AND S.ZORLUKDERECESI > 0.34 )
						,[ZORLUK_K]		= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.ZORLUKDERECESI < 0.80 AND S.ZORLUKDERECESI > 0.64 )
						,[ZORLUK_CK]	= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND								S.ZORLUKDERECESI > 0.79 )
																											   
						--,[AYIRICILIK_K] = (SELECT COUNT(1) FROM #DERECE S WHERE S.AYIRICILIK < 0							)
						,[AYIRICILIK_Z] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.20							)
						,[AYIRICILIK_S] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.30 AND S.AYIRICILIK > 0.19 )
						,[AYIRICILIK_I] = (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND S.AYIRICILIK < 0.40 AND S.AYIRICILIK > 0.29 )
						,[AYIRICILIK_CI]= (SELECT COUNT(1) FROM #DERECE S WHERE BOLUMNO IN (SELECT GD.BOLUMNO FROM #GOSTERDERS GD) AND							S.AYIRICILIK > 0.39 )
				

				SELECT * 
				FROM #TEMPBB			
			END
			
			DROP TABLE IF EXISTS #TEMPBB
			DROP TABLE IF EXISTS #ALTCEVAPLAR
			DROP TABLE IF EXISTS #ALTGRUP
			DROP TABLE IF EXISTS #DERECE
			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #USTCEVAPLAR
			DROP TABLE IF EXISTS #USTGRUP
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #SUBE
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #SINAV
			DROP TABLE IF EXISTS #SINIFALAN
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #TEMPDERS
			DROP TABLE IF EXISTS #GOSTERDERS
			DROP TABLE IF EXISTS #OGRBOLUM


		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_TKTTest]...';


GO
ALTER procedure [dbo].[sp_TKTTest]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_TKTTEST			INT				= NULL,
	@TCKIMLIKNO_OGR		VARCHAR(11)		= NULL,
	@SINAV_TARIH		date			= NULL,
	@ID_SUBE			INT				= NULL,	
	@ID_SUBES			VARCHAR(MAX)	= NULL,
	@ID_SINIFS			VARCHAR(MAX)	= NULL,
	@ID_TKTZEKATURUS	VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUPS  	VARCHAR(MAX)	= NULL,
	@ID_TKTTESTS	  	VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUP		INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@PUANSIZ			bit				= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@HESAPTURU			BIT				= NULL			
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_KATEGORI				= @ID_KATEGORI	
			,ID_TKTTEST					= @ID_TKTTEST		
			,TCKIMLIKNO_OGR				= @TCKIMLIKNO_OGR	
			,SINAV_TARIH				= @SINAV_TARIH	
			,ID_SUBE					= @ID_SUBE		
			,ID_SUBES					= @ID_SUBES		
			,ID_SINIFS					= @ID_SINIFS		
			,ID_TKTZEKATURUS			= @ID_TKTZEKATURUS
			,ID_SINAVGRUPS  			= @ID_SINAVGRUPS  
			,ID_TKTTESTS	  			= @ID_TKTTESTS	
			,ID_SINAVGRUP				= @ID_SINAVGRUP	
			,ID_SINIF					= @ID_SINIF		
			,SQLJSON				 	= @SQLJSON		
			,PUANSIZ					= @PUANSIZ		
			,DONEM						= @DONEM			
			,TARIH						= @TARIH			
			,HESAPTURU					= @HESAPTURU		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
		DECLARE @ID_KADEME3 INT

		IF @ISLEM = 1	--	Test Listele
		BEGIN
			SELECT ID_TKTTEST, AD FROM TKTTest
		END

		IF @ISLEM = 2	--	Kategori Listele
		BEGIN
			SELECT ID_TKTKATEGORI as ID_KATEGORI, AD FROM UpgradeKategori
		END

		IF @ISLEM = 3	--	Öğrenci Cevap Listele Kategori Bazlı
		BEGIN
			declare @tarih varchar(MAX) = (SELECT TOP 1 CONVERT(varchar, SINAVTARIH, 104) FROM TKTOgrenciSinav WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTTEST = @ID_TKTTEST AND DONEM = @DONEM)

			SELECT @ID_KADEME3 = S.ID_KADEME3 
			FROM OkyanusDB.dbo.v3OgrenciTum O 
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = O.ID_SINIF
			WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND  O.DONEM = @DONEM

			IF @ID_KADEME3 NOT IN(4, 5, 7)
			BEGIN
				select s.*, oc.OGRENCICEVAP, @tarih as TARIH from vw_TKTSoru s
				Left Join (
							select SOC.OGRENCICEVAP, SOS.SINAVTARIH, SOC.ID_TKTSORU 
							from TKTOgrenciCevap SOC
							INNER JOIN TKTOgrenciSinav SOS ON SOS.ID_TKTOGRENCISINAV = SOC.ID_TKTOGRENCISINAV
							where SOS.TCKIMLIKNO=@TCKIMLIKNO_OGR AND SOS.DONEM = @DONEM
						) oc on oc.ID_TKTSORU=s.ID_TKTSORU
				where s.ID_TKTTEST=@ID_TKTTEST and s.ID_KATEGORI=@ID_KATEGORI AND S.ID_KADEME3 = 0
				order by s.SORUNO
			END
			ELSE
			BEGIN
				select s.*, oc.OGRENCICEVAP, @tarih as TARIH from vw_TKTSoru s
				Left Join (
							select SOC.OGRENCICEVAP, SOS.SINAVTARIH, SOC.ID_TKTSORU 
							from TKTOgrenciCevap SOC
							INNER JOIN TKTOgrenciSinav SOS ON SOS.ID_TKTOGRENCISINAV = SOC.ID_TKTOGRENCISINAV
							where SOS.TCKIMLIKNO=@TCKIMLIKNO_OGR AND SOS.DONEM = @DONEM
						) oc on oc.ID_TKTSORU=s.ID_TKTSORU
				where s.ID_TKTTEST=@ID_TKTTEST and s.ID_KATEGORI=@ID_KATEGORI AND S.ID_KADEME3 = @ID_KADEME3
				order by s.SORUNO
			END
		END

		IF @ISLEM = 4	--	Öğrenci Cevap Kaydet Kategori Bazlı
		BEGIN
			SELECT @ID_KADEME3 = S.ID_KADEME3 
			FROM OkyanusDB.dbo.v3OgrenciTum O 
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = O.ID_SINIF
			WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND  O.DONEM = @DONEM

			DELETE oc FROM [dbo].[TKTOgrenciCevap]	oc
			INNER JOIN [dbo].[TKTSoru]				s	ON	s.ID_TKTSORU			=	oc.ID_TKTSORU
			INNER JOIN TKTOgrenciSinav				so	ON so.ID_TKTOGRENCISINAV	=	oc.ID_TKTOGRENCISINAV and so.ID_TKTTEST = s.ID_TKTTEST
			where so.[TCKIMLIKNO] = @TCKIMLIKNO_OGR and s.ID_TKTTEST = @ID_TKTTEST and s.ID_KATEGORI = @ID_KATEGORI AND (@DONEM IS NULL OR so.DONEM = @DONEM)

			IF NOT EXISTS (SELECT TOP 1 1 FROM TKTOgrenciSinav WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTTEST = @ID_TKTTEST AND DONEM = @DONEM)
			BEGIN
				INSERT INTO TKTOgrenciSinav (TCKIMLIKNO, ID_TKTTEST, DONEM, SINAVTARIH, KYE_KULLANICI)
				SELECT @TCKIMLIKNO_OGR, @ID_TKTTEST, @DONEM, @SINAV_TARIH, @TCKIMLIKNO
			END
			ELSE
			BEGIN
				UPDATE TKTOgrenciSinav SET SINAVTARIH = @SINAV_TARIH, KYE_KULLANICI = @TCKIMLIKNO, KYE_TARIH = GETDATE() WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTTEST = @ID_TKTTEST AND DONEM = @DONEM
			END

			DECLARE @ID_TKTOGRENCISINAV INT = (SELECT ID_TKTOGRENCISINAV FROM TKTOgrenciSinav WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTTEST = @ID_TKTTEST AND DONEM = @DONEM)

			INSERT INTO [dbo].[TKTOgrenciCevap]
					   ([ID_TKTSORU]
					   ,[OGRENCICEVAP]
					   ,[ID_TKTOGRENCISINAV])
				 (SELECT [ID_TKTSORU], [OGRENCICEVAP], [ID_TKTOGRENCISINAV] = @ID_TKTOGRENCISINAV FROM OPENJSON(@SQLJSON, '$.KATEGORISORU_LISTESI')
				 WITH ( ID_TKTSORU int,
						OGRENCICEVAP  varchar(50)) as jtable where jtable.[OGRENCICEVAP] is not null AND jtable.[OGRENCICEVAP]!='' AND jtable.[OGRENCICEVAP] NOT LIKE 'FALSE')  
		END

		IF @ISLEM = 5	--	Öğrenci Listele Cevap Bazlı
		BEGIN
			declare @DONEMxx varchar(4) = @DONEM
			IF @DONEM IS NULL
			BEGIN
				SET @DONEMxx = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
			END

			select distinct so.TCKIMLIKNO, k.AD + ' ' + k.SOYAD as AD
			from TKTOgrenciCevap			oc
			Inner Join [dbo].[TKTSoru]		s	on	s.ID_TKTSORU	=	oc.ID_TKTSORU
			INNER JOIN TKTOgrenciSinav		so	ON	so.ID_TKTOGRENCISINAV = oc.ID_TKTOGRENCISINAV and so.ID_TKTTEST = s.ID_TKTTEST
			Inner Join [dbo].[v3OgrenciTum]	o	on	o.TCKIMLIKNO	=	so.TCKIMLIKNO AND o.DONEM = @DONEM
			Inner Join [dbo].[v3Kullanici]	k	on	k.TCKIMLIKNO	=	so.TCKIMLIKNO
			Inner Join [dbo].[v3SubeYetki]	sy	on	sy.TCKIMLIKNO	=	so.TCKIMLIKNO
			inner join [dbo].[v3SinifTum]	sn	on	sn.ID_SINIF		=	o.ID_SINIF
			inner join [dbo].[v3SatisTuru]	st	on	st.ID_SATISTURU	=	sn.ID_SATISTURU  
			where 
					(@ID_TKTTEST IS NULL OR @ID_TKTTEST=0 OR s.ID_TKTTEST=@ID_TKTTEST)  
				AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  
				AND (@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  
				AND (@ID_SINIF IS NULL OR @ID_SINIF=0 OR sn.ID_SINIF=@ID_SINIF) 
				AND (st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) 
				
				AND (@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sy.ID_SUBE in (select value from openjson (@ID_SUBES) ))
				AND (@ID_SINAVGRUPS IS NULL OR @ID_SINAVGRUPS='[]' OR st.ID_KADEME3 in (select value from openjson (@ID_SINAVGRUPS) ))
				AND (@ID_SINIFS IS NULL OR @ID_SINIFS='[]' OR sn.ID_SINIF in (select value from openjson (@ID_SINIFS) ))
				AND (@ID_TKTTESTS IS NULL OR @ID_TKTTESTS='[]' OR s.ID_TKTTEST in (select value from openjson (@ID_TKTTESTS) ))
				AND (@DONEM IS NULL OR so.DONEM = @DONEM)
		END

		IF @ISLEM = 6	--	Öğrenci Sonuc Listele Test Bazlı
		BEGIN
			SELECT @ID_KADEME3 = S.ID_KADEME3 
			FROM OkyanusDB.dbo.v3OgrenciTum O 
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = O.ID_SINIF
			WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND  O.DONEM = @DONEM

			DECLARE @kategoriid int
			select @kategoriid = min( ID_TKTKATEGORI ) from UpgradeKategori

			CREATE TABLE #ResultTable
			(
				ID_KATEGORI int, KATEGORI varchar(100), ALTKATEGORI varchar(100), DOGRUSAYISI int
			)

			while @kategoriid is not null
			begin
				select k.ID_TKTKATEGORI as ID_KATEGORI, k.AD as KATEGORI, ak.AD as ALTKATEGORI, count(oc.OGRENCICEVAP) as DOGRUSAYISI 
				into #KATEGORI
				from		TKTAltKategori		ak
				Inner Join	UpgradeKategori		k	on	k.ID_TKTKATEGORI	=	ak.ID_KATEGORI
				Inner Join	TKTSoru				s	on	s.ID_ALTKATEGORI	=	ak.ID_AltKategori AND s.ID_KADEME3 = (CASE WHEN @ID_KADEME3 IN(4, 5, 7) THEN @ID_KADEME3 ELSE 0 END)
				Left Join	TKTOgrenciSinav		so	ON	so.TCKIMLIKNO		=	@TCKIMLIKNO_OGR 
												AND so.ID_TKTTEST			=	s.ID_TKTTEST
												AND so.DONEM				=	@DONEM
				Left Join	TKTOgrenciCevap		oc	on	oc.ID_TKTSORU		=	s.ID_TKTSORU
												AND oc.OGRENCICEVAP			=	1	
												AND oc.ID_TKTOGRENCISINAV	=	so.ID_TKTOGRENCISINAV	
				where k.ID_TKTKATEGORI = @kategoriid AND s.ID_TKTTEST= @ID_TKTTEST
				group by ak.AD, k.ID_TKTKATEGORI, k.AD 
				order by k.ID_TKTKATEGORI

				select ID_KATEGORI,KATEGORI,sum(DOGRUSAYISI) as DOGRUSAYISI into #SUM from #KATEGORI
				group by ID_KATEGORI,KATEGORI
  
				insert into #KATEGORI
				(ID_KATEGORI, KATEGORI, ALTKATEGORI, DOGRUSAYISI)
				select ID_KATEGORI,KATEGORI,'TOPLAM',DOGRUSAYISI from #SUM

				insert into #ResultTable
				select * from #KATEGORI order by ID_KATEGORI

				drop table #KATEGORI
				drop table #SUM
				select @kategoriid = min( ID_TKTKATEGORI ) from UpgradeKategori where ID_TKTKATEGORI > @kategoriid
			end

			insert into #ResultTable
			(ID_KATEGORI, KATEGORI, ALTKATEGORI, DOGRUSAYISI)
			select 999 as ID_KATEGORI,'' as KATEGORI,'GENEL TOPLAM' as ALTKATEGORI,SUM(DOGRUSAYISI) as DOGRUSAYISI from #ResultTable
			where ALTKATEGORI!='TOPLAM'

			SELECT ID_KATEGORI, KATEGORI, ALTKATEGORI, CASE WHEN @ID_TKTTEST=2 THEN (DOGRUSAYISI * 2) ELSE DOGRUSAYISI END AS DOGRUSAYISI FROM #ResultTable --	ARA TEST İÇİN 2X
			ORDER BY ID_KATEGORI, KATEGORI, ALTKATEGORI
			drop table #ResultTable
		END

		IF @ISLEM = 7	--	Öğrenci Karne Getir
		BEGIN 
			select k.AD+' '+k.SOYAD as ADSOYAD, S.ID_KADEME3
			from [dbo].[v3OgrenciTum]				o
			Join [dbo].[v3Kullanici]				k	on	k.TCKIMLIKNO	=	o.TCKIMLIKNO
			Join OkyanusDB.dbo.v3SubeGrupSinifTum	S	on	S.ID_SINIF		=	o.ID_SINIF
			where o.TCKIMLIKNO=@TCKIMLIKNO_OGR AND o.DONEM = @DONEM
			
			--SELECT @ID_KADEME3 = S.ID_KADEME3 
			--FROM OkyanusDB.dbo.v3OgrenciTum O 
			--INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = O.ID_SINIF
			--WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND  O.DONEM = @DONEM

			SELECT KTABLE.KATEGORI, KTABLE.DOGRUSAYISI, 0 AS ID_YASARALIGI, SE.AD AS SEVIYE, KS.Acıklama, CONVERT(VARCHAR, TARIH, 104) AS TARIH
			FROM (
				SELECT SNV.TCKIMLIKNO, S.ID_KADEME3, K.ID_TKTKATEGORI AS ID_KATEGORI, K.AD AS KATEGORI, CASE WHEN S.ID_KADEME3 NOT IN (4, 5) AND S.ID_TKTTEST = 2 THEN (count(K.AD)*2) ELSE COUNT(K.AD) END AS DOGRUSAYISI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE SNV.SINAVTARIH END) AS TARIH, YASAY= DATEDIFF(MONTH, u.DOGUMTARIHI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE CAST(MAX(SNV.SINAVTARIH) AS DATE) END))-1
				FROM TKTOgrenciSinav		SNV
				JOIN TKTOgrenciCevap		CVB ON CVB.ID_TKTOGRENCISINAV = SNV.ID_TKTOGRENCISINAV AND CVB.OGRENCICEVAP = 1
				JOIN TKTSoru				S	ON S.ID_TKTSORU = CVB.ID_TKTSORU
				JOIN UpgradeKategori		K	ON K.ID_TKTKATEGORI = S.ID_KATEGORI
				JOIN [dbo].[v3Kullanici]	U	ON U.TCKIMLIKNO	= SNV.TCKIMLIKNO
				WHERE SNV.TCKIMLIKNO = @TCKIMLIKNO_OGR AND SNV.DONEM = @DONEM AND S.ID_TKTTEST = @ID_TKTTEST
				GROUP BY K.ID_TKTKATEGORI, S.ID_KADEME3, K.AD, SNV.TCKIMLIKNO, SNV.SINAVTARIH, u.DOGUMTARIHI, S.ID_TKTTEST
			) KTABLE
			JOIN UpgradePuan			UP ON UP.ID_KADEME3	= KTABLE.ID_KADEME3 
										AND UP.ID_TKTKATEGORI = KTABLE.ID_KATEGORI 
										AND (
											(KTABLE.ID_KADEME3 IN (4, 5) AND UP.ID_TKTYASARALIGI = 0)
											OR 
											(KTABLE.ID_KADEME3 NOT IN (4, 5) AND UP.ID_TKTYASARALIGI  = (SELECT ID_TKTYASARALIGI FROM UpgradeYasAraligi YA WHERE YA.YASAY1 <= KTABLE.YASAY AND YA.YASAY2 >= KTABLE.YASAY))
										)
										AND UP.PUAN1 <= KTABLE.DOGRUSAYISI 
										AND UP.PUAN2 >= KTABLE.DOGRUSAYISI
			JOIN TKTSeviye				SE ON SE.HARF = UP.HARF
			JOIN TKTKategoriSeviye		KS ON KS.HARF = UP.HARF	AND KS.ID_KATEGORI = KTABLE.ID_KATEGORI
			ORDER BY KTABLE.ID_KATEGORI

			--IF @ID_KADEME3 NOT IN(4, 5, 7)
			--BEGIN	
			--	SELECT KTABLE.KATEGORI, KTABLE.DOGRUSAYISI, YA.ID_TKTYASARALIGI AS ID_YASARALIGI, SE.AD AS SEVIYE, KS.Acıklama, CONVERT(VARCHAR, TARIH, 104) AS TARIH FROM
			--	(
			--		SELECT SNV.TCKIMLIKNO, K.ID_TKTKATEGORI AS ID_KATEGORI, K.AD AS KATEGORI, CASE WHEN @ID_TKTTEST=2 THEN (count(K.AD)*2) ELSE COUNT(K.AD) END AS DOGRUSAYISI, YASAY= DATEDIFF(MONTH, u.DOGUMTARIHI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE CAST(MAX(SNV.SINAVTARIH) AS DATE) END))-1, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE SNV.SINAVTARIH END) AS TARIH
			--		FROM UpgradeKategori		K
			--		JOIN TKTAltKategori			AK	ON AK.ID_KATEGORI			=	K.ID_TKTKATEGORI
			--		JOIN TKTSoru				S	ON S.ID_KADEME3				=	0 AND S.ID_ALTKATEGORI = AK.ID_AltKategori
			--		JOIN TKTOgrenciCevap		OC	ON OC.ID_TKTSORU			=	S.ID_TKTSORU			AND	OC.OGRENCICEVAP	= 1
			--		JOIN TKTOgrenciSinav		SNV ON SNV.ID_TKTOGRENCISINAV	=	OC.ID_TKTOGRENCISINAV	AND SNV.ID_TKTTEST	= S.ID_TKTTEST
			--		JOIN [dbo].[v3Kullanici]	U	ON U.TCKIMLIKNO				=	SNV.TCKIMLIKNO
			--		WHERE SNV.TCKIMLIKNO = @TCKIMLIKNO_OGR AND S.ID_TKTTEST = @ID_TKTTEST AND (@DONEM IS NULL OR SNV.DONEM = @DONEM)
			--		GROUP BY K.ID_TKTKATEGORI, K.AD, SNV.TCKIMLIKNO, U.DOGUMTARIHI, SNV.SINAVTARIH
			--	) KTABLE
			--	JOIN UpgradeYasAraligi	YA	ON YA.YASAY1		<=	KTABLE.YASAY AND YA.YASAY2 >= KTABLE.YASAY
			--	JOIN UpgradePuan		UP	ON UP.ID_KADEME3	=	0 AND UP.ID_TKTKATEGORI = KTABLE.ID_KATEGORI AND	UP.ID_TKTYASARALIGI = YA.ID_TKTYASARALIGI AND UP.PUAN1 <= KTABLE.DOGRUSAYISI AND UP.PUAN2 >= KTABLE.DOGRUSAYISI
			--	JOIN TKTSeviye			SE	ON SE.HARF			=	UP.HARF
			--	JOIN TKTKategoriSeviye	KS	ON KS.HARF			=	UP.HARF	AND KS.ID_KATEGORI = KTABLE.ID_KATEGORI
			--	ORDER BY KTABLE.ID_KATEGORI
			--END
			--ELSE
			--BEGIN
			--	SELECT KTABLE.KATEGORI, KTABLE.DOGRUSAYISI, 0 AS ID_YASARALIGI, SE.AD AS SEVIYE, KS.Acıklama, CONVERT(VARCHAR, TARIH, 104) AS TARIH FROM
			--	(
			--		SELECT SNV.TCKIMLIKNO, K.ID_TKTKATEGORI AS ID_KATEGORI, K.AD AS KATEGORI, COUNT(K.AD) AS DOGRUSAYISI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE SNV.SINAVTARIH END) AS TARIH
			--		FROM UpgradeKategori		K
			--		JOIN TKTAltKategori			AK	ON AK.ID_KATEGORI			=	K.ID_TKTKATEGORI
			--		JOIN TKTSoru				S	ON S.ID_KADEME3				=	@ID_KADEME3				AND S.ID_ALTKATEGORI	= AK.ID_AltKategori
			--		JOIN TKTOgrenciCevap		OC	ON OC.ID_TKTSORU			=	S.ID_TKTSORU			AND	OC.OGRENCICEVAP		= 1
			--		JOIN TKTOgrenciSinav		SNV ON SNV.ID_TKTOGRENCISINAV	=	OC.ID_TKTOGRENCISINAV	AND SNV.ID_TKTTEST		= S.ID_TKTTEST
			--		JOIN [dbo].[v3Kullanici]	U	ON U.TCKIMLIKNO				=	SNV.TCKIMLIKNO
			--		WHERE SNV.TCKIMLIKNO = @TCKIMLIKNO_OGR AND S.ID_TKTTEST = @ID_TKTTEST AND (@DONEM IS NULL OR SNV.DONEM = @DONEM)
			--		GROUP BY K.ID_TKTKATEGORI, K.AD, SNV.TCKIMLIKNO, U.DOGUMTARIHI, SNV.SINAVTARIH
			--	) KTABLE
			--	JOIN UpgradePuan		UP	ON UP.ID_KADEME3	=	@ID_KADEME3 AND UP.ID_TKTKATEGORI = KTABLE.ID_KATEGORI AND	UP.ID_TKTYASARALIGI = 0 AND UP.PUAN1 <= KTABLE.DOGRUSAYISI AND UP.PUAN2 >= KTABLE.DOGRUSAYISI
			--	JOIN TKTSeviye			SE	ON SE.HARF			=	UP.HARF
			--	JOIN TKTKategoriSeviye	KS	ON KS.HARF			=	UP.HARF	AND KS.ID_KATEGORI = KTABLE.ID_KATEGORI
			--	ORDER BY KTABLE.ID_KATEGORI
			--END

		END

		IF @ISLEM = 8	--	Öğrenci Cevap Sil Kategori Bazlı
		BEGIN
			delete c from TKTOgrenciCevap as c 
			inner join TKTSoru s on s.ID_TKTSORU=c.ID_TKTSORU
			inner join TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=c.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
			where os.TCKIMLIKNO=@TCKIMLIKNO_OGR and s.ID_KATEGORI=@ID_KATEGORI and s.ID_TKTTEST=@ID_TKTTEST AND os.DONEM = @DONEM

			IF (SELECT COUNT(1) FROM TKTOgrenciSinav OS INNER JOIN TKTOgrenciCevap OC ON OC.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV where OS.TCKIMLIKNO=@TCKIMLIKNO_OGR and OS.ID_TKTTEST=@ID_TKTTEST AND OS.DONEM = @DONEM) = 0
			BEGIN
				DELETE FROM TKTOgrenciSinav where TCKIMLIKNO=@TCKIMLIKNO_OGR and ID_TKTTEST=@ID_TKTTEST AND DONEM = @DONEM
			END
		END

		IF @ISLEM = 9	--	TKTZekaTuruListele
		BEGIN
			SELECT * FROM TKTZekaTuru
		END

		IF @ISLEM = 10	--	TKT ZEKA PUAN OGRENCI LISTE
		BEGIN
			SELECT SNV.TCKIMLIKNO, S.ID_TKTTEST, SNV.SINAVTARIH AS KYE_TARIH, SNV.DONEM
			INTO #OGRENCILIST
			FROM TKTOgrenciCevap O
			JOIN TKTSORU S ON O.ID_TKTSORU=S.ID_TKTSORU
			INNER JOIN TKTOgrenciSinav SNV ON SNV.ID_TKTOGRENCISINAV = O.ID_TKTOGRENCISINAV AND SNV.ID_TKTTEST = S.ID_TKTTEST
			JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = SNV.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
			WHERE OGRENCICEVAP=1 AND SNV.DONEM = @DONEM
			AND OO.ID_SINIF	IN ((SELECT Value FROM dbo.fn_Split(@ID_SINIFS, ',', null)))
			GROUP BY SNV.TCKIMLIKNO, O.OGRENCICEVAP, SNV.DONEM, S.ID_TKTTEST, SNV.SINAVTARIH
			HAVING COUNT(DISTINCT S.ID_KATEGORI) = 4

			SELECT	 O.TCKIMLIKNO
					,O.ID_TKTTEST
					,O.DONEM
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE CAST(O.KYE_TARIH AS DATE) END)) - 1
					,ZEKAPUANI	= CAST(ROUND(Y.ID_TKTZEKAYAS * 100.0 / (DATEDIFF(MONTH, k.DOGUMTARIHI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE CAST(O.KYE_TARIH AS DATE) END)) + 1), 0) AS INT)
			INTO #OGRENCIZEKAPUANLIST
			FROM #OGRENCILIST O
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			INNER JOIN TKTZekaYas Y ON Y.ID_TKTPUAN = (
															SELECT CASE WHEN  (CASE WHEN S.ID_TKTTEST = 2 THEN COUNT(OGRENCICEVAP) * 2 ELSE COUNT(OGRENCICEVAP) END) < 29 then 29
															WHEN			  (CASE WHEN S.ID_TKTTEST = 2 THEN COUNT(OGRENCICEVAP) * 2 ELSE COUNT(OGRENCICEVAP) END) > 130 then 130
															ELSE			  (CASE WHEN S.ID_TKTTEST = 2 THEN COUNT(OGRENCICEVAP) * 2 ELSE COUNT(OGRENCICEVAP) END) 
															END PUAN
 															FROM TKTOGRENCiCEVAP OC
 															INNER JOIN TKTSoru S ON S.ID_TKTSORU = OC.ID_TKTSORU
															INNER JOIN TKTOgrenciSinav OS ON OS.ID_TKTOGRENCISINAV = OC.ID_TKTOGRENCISINAV AND OS.ID_TKTTEST = S.ID_TKTTEST
															WHERE OS.TCKIMLIKNO = O.TCKIMLIKNO AND OGRENCICEVAP = 1 AND S.ID_TKTTEST = O.ID_TKTTEST AND OS.DONEM = O.DONEM
															GROUP BY S.ID_TKTTEST
														)

			SELECT  
				P1.TCKIMLIKNO,
				P1.ADSOYAD,
				ISNULL(MAX(P1.P1),'') ONZEKAPUANI	,ISNULL(MAX(P1.P2),'') ARAZEKAPUANI		,ISNULL(MAX(P1.P3),'') SONZEKAPUANI,
				ISNULL(MAX(P1.K1),'') ONZEKAKATEGORI,ISNULL(MAX(P1.K2),'') ARAZEKAKATEGORI	,ISNULL(MAX(P1.K3),'') SONZEKAKATEGORI,
				ID_SINIF
			INTO #TEMP
			FROM(
				SELECT P.TCKIMLIKNO,K.AD+' '+K.SOYAD ADSOYAD,Z.ACIKLAMA,P.ZEKAPUANI,P.ID_TKTTEST,Z.ID_TKTZEKATURU,O.ID_SINIF
				,'P' +CAST(ID_TKTTEST as varchar) as PUAN
				,'K' +CAST(ID_TKTTEST as varchar) as PUAN2
				FROM #OGRENCIZEKAPUANLIST	P
				--FROM TKTOgrenciZekaPuan	P
				JOIN v3OgrenciTum			O ON P.TCKIMLIKNO	=O.TCKIMLIKNO AND O.DONEM = @DONEM
				JOIN v3Kullanici			K ON K.TCKIMLIKNO	=O.TCKIMLIKNO
				JOIN TKTZekaTuru			Z ON P.ZEKAPUANI BETWEEN Z.PUAN_BASLANGIC AND Z.PUAN_BITIS
				WHERE		O.ID_SINIF IN ((SELECT Value FROM dbo.fn_Split(@ID_SINIFS, ',', null) ) )
				AND (@DONEM IS NULL OR P.DONEM = @DONEM)
						
			) AS gTablo
			PIVOT( MAX(ZEKAPUANI) FOR PUAN  IN ([P1],[P2],[P3]) ) AS P1
			PIVOT( MAX(ACIKLAMA)  FOR PUAN2 IN ([K1],[K2],[K3]) ) AS P1
			WHERE ID_TKTZEKATURU IN	((SELECT Value FROM dbo.fn_Split(@ID_TKTZEKATURUS, ',', null)))
			GROUP BY TCKIMLIKNO,ADSOYAD,ID_SINIF--,ID_TKTZEKATURU
		
			IF @PUANSIZ=1
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO,K.AD+' '+K.SOYAD ADSOYAD, VS.AD SINIFAD, S.AD SUBEAD, ST.ACIKLAMA SINIF
					,CASE WHEN ONZEKAPUANI		IS NULL THEN 'Puan Hesaplanmadı' ELSE RIGHT('000' + CAST(ONZEKAPUANI		AS VARCHAR(15)),3) END ONZEKAPUANI
					,CASE WHEN ARAZEKAPUANI		IS NULL THEN 'Puan Hesaplanmadı' ELSE RIGHT('000' + CAST(ARAZEKAPUANI		AS VARCHAR(15)),3) END ARAZEKAPUANI
					,CASE WHEN SONZEKAPUANI		IS NULL THEN 'Puan Hesaplanmadı' ELSE RIGHT('000' + CAST(SONZEKAPUANI		AS VARCHAR(15)),3) END SONZEKAPUANI
					,CASE WHEN ONZEKAKATEGORI	IS NULL THEN '---' ELSE ONZEKAKATEGORI END ONZEKAKATEGORI
					,CASE WHEN ARAZEKAKATEGORI	IS NULL THEN '---' ELSE ARAZEKAKATEGORI END ARAZEKAKATEGORI
					,CASE WHEN SONZEKAKATEGORI	IS NULL THEN '---' ELSE SONZEKAKATEGORI END SONZEKAKATEGORI
				INTO		#T1
				FROM		V3SinifTum		VS
				JOIN		v3OgrenciTum	O	ON VS.ID_SINIF		= O.ID_SINIF AND O.DONEM = @DONEM
				JOIN		v3Kullanici		K	ON K.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN		v3Sube			S	ON S.ID_SUBE		= O.ID_SUBE
				JOIN		V3SatisTuru		ST	ON ST.ID_SATISTURU	= VS.ID_SATISTURU
				LEFT JOIN	#TEMP			T	ON T.ID_SINIF	= VS.ID_SINIF AND O.TCKIMLIKNO=T.TCKIMLIKNO
				WHERE		VS.ID_SINIF			IN	((SELECT Value FROM dbo.fn_Split(@ID_SINIFS, ',', null))) AND VS.DONEM = @DONEM

				select(
					select * from(
						select 
						(
							select * from #T1		
							FOR JSON AUTO
						) as t1						
					) as tablo FOR JSON AUTO
				) as tt
			END
			ELSE
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO,K.AD+' '+K.SOYAD ADSOYAD, VS.AD SINIFAD, S.AD SUBEAD, ST.ACIKLAMA SINIF
					,ONZEKAPUANI
					,ARAZEKAPUANI
					,SONZEKAPUANI
					,ONZEKAKATEGORI
					,ARAZEKAKATEGORI
					,SONZEKAKATEGORI
				INTO		#T2
				FROM		V3SinifTum		VS
				JOIN		v3OgrenciTum	O	ON VS.ID_SINIF		= O.ID_SINIF AND O.DONEM = @DONEM
				JOIN		v3Kullanici		K	ON K.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN		v3Sube			S	ON S.ID_SUBE		= O.ID_SUBE
				JOIN		V3SatisTuru		ST	ON ST.ID_SATISTURU	= VS.ID_SATISTURU
				JOIN		#TEMP			T	ON T.ID_SINIF	= VS.ID_SINIF AND O.TCKIMLIKNO=T.TCKIMLIKNO
				WHERE		VS.ID_SINIF			IN	((SELECT Value FROM dbo.fn_Split(@ID_SINIFS, ',', null))) AND VS.DONEM = @DONEM

				select(
					select * from(
						select 
						(
							select * from #T2			
							FOR JSON AUTO
						) as t1					
									
					) as tablo FOR JSON AUTO
				) as tt
			END

			DROP TABLE #T1
			DROP TABLE #TEMP
			DROP TABLE #OGRENCILIST
			DROP TABLE #OGRENCIZEKAPUANLIST
		END

		IF @ISLEM = 11	--	Öğrenci Karne Getir (GRAFİKLİ)
		BEGIN
			SELECT @ID_KADEME3 = S.ID_KADEME3 
			FROM OkyanusDB.dbo.v3OgrenciTum O 
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = O.ID_SINIF
			WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND  O.DONEM = @DONEM

			select k.AD+' '+k.SOYAD as ADSOYAD, @ID_KADEME3 as ID_KADEME3
			from [dbo].[v3OgrenciTum]				o
			Join [dbo].[v3Kullanici]				k	on	k.TCKIMLIKNO	=	o.TCKIMLIKNO
			Join OkyanusDB.dbo.v3SubeGrupSinifTum	S	on	S.ID_SINIF		=	o.ID_SINIF
			where o.TCKIMLIKNO=@TCKIMLIKNO_OGR AND o.DONEM = @DONEM

			SELECT KTABLE.KATEGORI, KTABLE.DOGRUSAYISI, 0 AS ID_YASARALIGI, SE.AD AS SEVIYE, KS.Acıklama, CONVERT(VARCHAR, TARIH, 104) AS TARIH
			FROM (
				SELECT SNV.TCKIMLIKNO, S.ID_KADEME3, K.ID_TKTKATEGORI AS ID_KATEGORI, K.AD AS KATEGORI, CASE WHEN S.ID_KADEME3 NOT IN (4, 5) AND S.ID_TKTTEST = 2 THEN (count(K.AD)*2) ELSE COUNT(K.AD) END AS DOGRUSAYISI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE SNV.SINAVTARIH END) AS TARIH, YASAY= DATEDIFF(MONTH, u.DOGUMTARIHI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE CAST(MAX(SNV.SINAVTARIH) AS DATE) END))-1
				FROM TKTOgrenciSinav		SNV
				JOIN TKTOgrenciCevap		CVB ON CVB.ID_TKTOGRENCISINAV = SNV.ID_TKTOGRENCISINAV AND CVB.OGRENCICEVAP = 1
				JOIN TKTSoru				S	ON S.ID_TKTSORU = CVB.ID_TKTSORU
				JOIN UpgradeKategori		K	ON K.ID_TKTKATEGORI = S.ID_KATEGORI
				JOIN [dbo].[v3Kullanici]	U	ON U.TCKIMLIKNO	= SNV.TCKIMLIKNO
				WHERE SNV.TCKIMLIKNO = @TCKIMLIKNO_OGR AND SNV.DONEM = @DONEM AND S.ID_TKTTEST = @ID_TKTTEST
				GROUP BY K.ID_TKTKATEGORI, S.ID_KADEME3, K.AD, SNV.TCKIMLIKNO, SNV.SINAVTARIH, u.DOGUMTARIHI, S.ID_TKTTEST
			) KTABLE
			JOIN UpgradePuan			UP ON UP.ID_KADEME3	= KTABLE.ID_KADEME3 
										AND UP.ID_TKTKATEGORI = KTABLE.ID_KATEGORI 
										AND (
											(KTABLE.ID_KADEME3 IN (4, 5) AND UP.ID_TKTYASARALIGI = 0)
											OR 
											(KTABLE.ID_KADEME3 NOT IN (4, 5) AND UP.ID_TKTYASARALIGI  = (SELECT ID_TKTYASARALIGI FROM UpgradeYasAraligi YA WHERE YA.YASAY1 <= KTABLE.YASAY AND YA.YASAY2 >= KTABLE.YASAY))
										)
										AND UP.PUAN1 <= KTABLE.DOGRUSAYISI 
										AND UP.PUAN2 >= KTABLE.DOGRUSAYISI
			JOIN TKTSeviye				SE ON SE.HARF = UP.HARF
			JOIN TKTKategoriSeviye		KS ON KS.HARF = UP.HARF	AND KS.ID_KATEGORI = KTABLE.ID_KATEGORI
			ORDER BY KTABLE.ID_KATEGORI

			--IF @ID_KADEME3 NOT IN(4, 5, 7)
			--BEGIN	
			--	SELECT KTABLE.KATEGORI, KTABLE.DOGRUSAYISI, YA.ID_TKTYASARALIGI AS ID_YASARALIGI, SE.AD AS SEVIYE, KS.Acıklama, CONVERT(VARCHAR, TARIH, 104) AS TARIH FROM
			--	(
			--		SELECT SNV.TCKIMLIKNO, K.ID_TKTKATEGORI AS ID_KATEGORI, K.AD AS KATEGORI, CASE WHEN @ID_TKTTEST=2 THEN (count(K.AD)*2) ELSE COUNT(K.AD) END AS DOGRUSAYISI, YASAY= DATEDIFF(MONTH, u.DOGUMTARIHI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE CAST(MAX(SNV.SINAVTARIH) AS DATE) END))-1, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE SNV.SINAVTARIH END) AS TARIH
			--		FROM UpgradeKategori		K
			--		JOIN TKTAltKategori			AK	ON AK.ID_KATEGORI			=	K.ID_TKTKATEGORI
			--		JOIN TKTSoru				S	ON S.ID_KADEME3				=	0 AND S.ID_ALTKATEGORI = AK.ID_AltKategori
			--		JOIN TKTOgrenciCevap		OC	ON OC.ID_TKTSORU			=	S.ID_TKTSORU			AND	OC.OGRENCICEVAP	= 1
			--		JOIN TKTOgrenciSinav		SNV ON SNV.ID_TKTOGRENCISINAV	=	OC.ID_TKTOGRENCISINAV	AND SNV.ID_TKTTEST	= S.ID_TKTTEST
			--		JOIN [dbo].[v3Kullanici]	U	ON U.TCKIMLIKNO				=	SNV.TCKIMLIKNO
			--		WHERE SNV.TCKIMLIKNO = @TCKIMLIKNO_OGR AND S.ID_TKTTEST = @ID_TKTTEST AND (@DONEM IS NULL OR SNV.DONEM = @DONEM)
			--		GROUP BY K.ID_TKTKATEGORI, K.AD, SNV.TCKIMLIKNO, U.DOGUMTARIHI, SNV.SINAVTARIH
			--	) KTABLE
			--	JOIN UpgradeYasAraligi	YA	ON YA.YASAY1		<=	KTABLE.YASAY AND YA.YASAY2 >= KTABLE.YASAY
			--	JOIN UpgradePuan		UP	ON UP.ID_KADEME3	=	0 AND UP.ID_TKTKATEGORI = KTABLE.ID_KATEGORI AND	UP.ID_TKTYASARALIGI = YA.ID_TKTYASARALIGI AND UP.PUAN1 <= KTABLE.DOGRUSAYISI AND UP.PUAN2 >= KTABLE.DOGRUSAYISI
			--	JOIN TKTSeviye			SE	ON SE.HARF			=	UP.HARF
			--	JOIN TKTKategoriSeviye	KS	ON KS.HARF			=	UP.HARF	AND KS.ID_KATEGORI = KTABLE.ID_KATEGORI
			--	ORDER BY KTABLE.ID_KATEGORI
			--END
			--ELSE
			--BEGIN
			--	SELECT KTABLE.KATEGORI, KTABLE.DOGRUSAYISI, 0 AS ID_YASARALIGI, SE.AD AS SEVIYE, KS.Acıklama, CONVERT(VARCHAR, TARIH, 104) AS TARIH FROM
			--	(
			--		SELECT SNV.TCKIMLIKNO, K.ID_TKTKATEGORI AS ID_KATEGORI, K.AD AS KATEGORI, COUNT(K.AD) AS DOGRUSAYISI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE SNV.SINAVTARIH END) AS TARIH
			--		FROM UpgradeKategori		K
			--		JOIN TKTAltKategori			AK	ON AK.ID_KATEGORI			=	K.ID_TKTKATEGORI
			--		JOIN TKTSoru				S	ON S.ID_KADEME3				=	@ID_KADEME3				AND S.ID_ALTKATEGORI	= AK.ID_AltKategori
			--		JOIN TKTOgrenciCevap		OC	ON OC.ID_TKTSORU			=	S.ID_TKTSORU			AND	OC.OGRENCICEVAP		= 1
			--		JOIN TKTOgrenciSinav		SNV ON SNV.ID_TKTOGRENCISINAV	=	OC.ID_TKTOGRENCISINAV	AND SNV.ID_TKTTEST		= S.ID_TKTTEST
			--		JOIN [dbo].[v3Kullanici]	U	ON U.TCKIMLIKNO				=	SNV.TCKIMLIKNO
			--		WHERE SNV.TCKIMLIKNO = @TCKIMLIKNO_OGR AND S.ID_TKTTEST = @ID_TKTTEST AND (@DONEM IS NULL OR SNV.DONEM = @DONEM)
			--		GROUP BY K.ID_TKTKATEGORI, K.AD, SNV.TCKIMLIKNO, U.DOGUMTARIHI, SNV.SINAVTARIH
			--	) KTABLE
			--	JOIN UpgradePuan		UP	ON UP.ID_KADEME3	=	@ID_KADEME3 AND UP.ID_TKTKATEGORI = KTABLE.ID_KATEGORI AND	UP.ID_TKTYASARALIGI = 0 AND UP.PUAN1 <= KTABLE.DOGRUSAYISI AND UP.PUAN2 >= KTABLE.DOGRUSAYISI
			--	JOIN TKTSeviye			SE	ON SE.HARF			=	UP.HARF
			--	JOIN TKTKategoriSeviye	KS	ON KS.HARF			=	UP.HARF	AND KS.ID_KATEGORI = KTABLE.ID_KATEGORI
			--	ORDER BY KTABLE.ID_KATEGORI
			--END

			select @kategoriid = min( ID_TKTKATEGORI ) from UpgradeKategori

			CREATE TABLE #ResultTable2
			(
				ID_TKTTEST int, ID_KATEGORI int, KATEGORI varchar(100), ALTKATEGORI varchar(100), DOGRUSAYISI DECIMAL(5,2)
			)

			while @kategoriid is not null
			begin
				select S.ID_TKTTEST, k.ID_TKTKATEGORI as ID_KATEGORI, k.AD as KATEGORI, ak.AD as ALTKATEGORI, CONVERT(decimal(10,2),(CONVERT(decimal(10,2),count(oc.OGRENCICEVAP))/CONVERT(decimal(10,2),count(ak.AD))*100.0)) as DOGRUSAYISI --count(oc.OGRENCICEVAP) as DOGRUSAYISI 
				into #KATEGORI2
				from		TKTAltKategori		ak
				Inner Join	UpgradeKategori		k	on	k.ID_TKTKATEGORI	=	ak.ID_KATEGORI
				Inner Join	TKTSoru				s	on	s.ID_ALTKATEGORI	=	ak.ID_AltKategori AND S.ID_KADEME3 = (CASE WHEN @ID_KADEME3 IN(4, 5, 7) THEN @ID_KADEME3 ELSE 0 END)
				LEFT JOIN	TKTOgrenciSinav		os	on	os.DONEM			=	@DONEM
												and os.TCKIMLIKNO			=	@TCKIMLIKNO_OGR
												and os.ID_TKTTEST			=	s.ID_TKTTEST
				Left Join	TKTOgrenciCevap		oc	on	oc.ID_TKTSORU		=	s.ID_TKTSORU		
												and	oc.ID_TKTOGRENCISINAV	=	os.ID_TKTOGRENCISINAV
												and oc.OGRENCICEVAP			=	1
				where k.ID_TKTKATEGORI=@kategoriid
				group by s.ID_TKTTEST, ak.AD, k.ID_TKTKATEGORI, k.AD 
				order by s.ID_TKTTEST, k.ID_TKTKATEGORI

				select ID_TKTTEST, ID_KATEGORI, KATEGORI, sum(DOGRUSAYISI) as DOGRUSAYISI into #SUM2 from #KATEGORI2
				group by ID_TKTTEST, ID_KATEGORI,KATEGORI

				insert into #ResultTable2
				select * from #KATEGORI2 order by ID_KATEGORI

				drop table #KATEGORI2
				drop table #SUM2
				select @kategoriid = min( ID_TKTKATEGORI ) from UpgradeKategori where ID_TKTKATEGORI > @kategoriid
			end

			SELECT ID_KATEGORI, KATEGORI, ALTKATEGORI, ISNULL([1],0) AS ONTEST, ISNULL([2],0) AS ARATEST, ISNULL([3],0) AS SONTEST FROM
			(
				SELECT ID_TKTTEST, ID_KATEGORI, KATEGORI, REPLACE(ALTKATEGORI,' Puanı','') AS ALTKATEGORI, DOGRUSAYISI FROM #ResultTable2
			) AS T1
			PIVOT(SUM(DOGRUSAYISI) FOR ID_TKTTEST IN ([1],[2],[3])) AS PIVOTTABLE
			drop table #ResultTable2
		END
		
		IF @ISLEM = 12	--	TKT SONUCLAR TOPLU EXCEL 
		BEGIN
		
			DROP TABLE IF EXISTS #TMP_TKT
			declare  @sID_SUBES			varchar(max) = @ID_SUBES				
					,@sID_SINAVGRUPS	varchar(max) = @ID_SINAVGRUPS
					,@sID_SINIFS		varchar(max) = @ID_SINIFS	
					,@sDONEM			varchar(max) = @DONEM		

			SELECT TCKIMLIKNO, 
				MAX(p1.[Ayırt Etme Hızı]) AS [Ö - Ayırt Etme Hızı], MAX(p1.[Dil Kavramı]) AS [Ö - Dil Kavramı], MAX(p1.[Sayı Kavramı]) AS [Ö - Sayı Kavramı], MAX(p1.[Yer Kavramı]) AS [Ö - Yer Kavramı],
				MAX(p1.[1-Ayırt Etme Hızı]) AS [A - Ayırt Etme Hızı], MAX(p1.[1-Dil Kavramı]) AS [A - Dil Kavramı], MAX(p1.[1-Sayı Kavramı]) AS [A - Sayı Kavramı], MAX(p1.[1-Yer Kavramı]) AS [A - Yer Kavramı],
				MAX(p1.[2-Ayırt Etme Hızı]) AS [S - Ayırt Etme Hızı], MAX(p1.[2-Dil Kavramı]) AS [S - Dil Kavramı], MAX(p1.[2-Sayı Kavramı]) AS [S - Sayı Kavramı], MAX(p1.[2-Yer Kavramı]) AS [S - Yer Kavramı],
				CONVERT(VARCHAR, MAX(P1.[Ön Test TARIH]), 104) AS [Ö - Tarih], CONVERT(VARCHAR, MAX(P1.[Ara Test TARIH]), 104) AS [A - Tarih], CONVERT(VARCHAR, MAX(P1.[Son Test TARIH]), 104) AS [S - Tarih]
			INTO #TMP_TKT 
			FROM(
				SELECT *
				FROM (
						SELECT	SNV.TCKIMLIKNO
								,T.AD AS TEST
								,T.AD + ' TARIH' AS TEST2
								,K.AD AS KATEGORI
								,'1-' + K.AD AS KATEGORI1
								,'2-' + K.AD AS KATEGORI2
								,SUM(CASE WHEN S.ID_TKTTEST = 2 AND SGS.ID_KADEME3 <> 4 AND SGS.ID_KADEME3 <> 5 THEN 2 ELSE 1 END) AS PUAN 
								,MAX(SNV.SINAVTARIH) AS TARIH
								,MAX(SNV.SINAVTARIH) AS TARIH1
								,MAX(SNV.SINAVTARIH) AS TARIH2
						FROM TKTOgrenciCevap		OC
						INNER JOIN TKTOgrenciSinav	SNV ON SNV.ID_TKTOGRENCISINAV	= OC.ID_TKTOGRENCISINAV
						INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = SNV.TCKIMLIKNO AND O.DONEM = SNV.DONEM
						INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
						INNER JOIN TKTSoru			S	ON S.ID_TKTSORU				= OC.ID_TKTSORU --AND S.ID_KADEME3 = (CASE WHEN SGS.ID_KADEME3 IN (4, 5) THEN SGS.ID_KADEME3 ELSE 0 END)
						INNER JOIN UpgradeKategori	K	ON K.ID_TKTKATEGORI			= S.ID_KATEGORI
						INNER JOIN TKTTest			T	ON T.ID_TKTTEST				= S.ID_TKTTEST
						WHERE OC.OGRENCICEVAP = 1 AND SNV.DONEM = @sDONEM		
						GROUP BY SNV.TCKIMLIKNO, T.AD, K.AD
				) as gTablo
				PIVOT ( AVG(PUAN)   FOR TEST	  IN ([Ön Test],[Ara Test],[Son Test])					 ) AS p1
				PIVOT ( MAX(TARIH)  FOR TEST2	  IN ([Ön Test TARIH],[Ara Test TARIH],[Son Test TARIH]) ) AS p1
			) AS G
			PIVOT ( AVG([Ön Test])  FOR KATEGORI  IN ([Ayırt Etme Hızı],[Dil Kavramı],[Sayı Kavramı],[Yer Kavramı])			) AS p1
			PIVOT ( AVG([Ara Test]) FOR KATEGORI1 IN ([1-Ayırt Etme Hızı],[1-Dil Kavramı],[1-Sayı Kavramı],[1-Yer Kavramı]) ) AS p1
			PIVOT ( AVG([Son Test]) FOR KATEGORI2 IN ([2-Ayırt Etme Hızı],[2-Dil Kavramı],[2-Sayı Kavramı],[2-Yer Kavramı]) ) AS p1
			GROUP BY TCKIMLIKNO


			SELECT KUL.AD, KUL.SOYAD, SU.AD AS SUBE, K3.AD AS GRUP, SNF.AD AS SINIF, CONVERT(VARCHAR, KUL.DOGUMTARIHI, 104) AS DOGUMTARIHI,
				[Ö - Ayırt Etme Hızı], [Ö - Dil Kavramı], [Ö - Sayı Kavramı], [Ö - Yer Kavramı],
				[A - Ayırt Etme Hızı], [A - Dil Kavramı], [A - Sayı Kavramı], [A - Yer Kavramı],
				[S - Ayırt Etme Hızı], [S - Dil Kavramı], [S - Sayı Kavramı], [S - Yer Kavramı],
				[Ö - Tarih], [A - Tarih], [S - Tarih]
			FROM #TMP_TKT T
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum		O	ON O.TCKIMLIKNO		= T.TCKIMLIKNO	AND O.DONEM		= @sDONEM		
			INNER JOIN OkyanusDB.dbo.v3Sube				SU	ON SU.ID_SUBE		= O.ID_SUBE
			INNER JOIN OkyanusDB.dbo.v3SinifTum			SNF ON SNF.ID_SINIF		= O.ID_SINIF	AND SNF.DONEM	= O.DONEM
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum	SGS ON SGS.ID_SINIF		= O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Kademe3			K3	ON K3.ID_KADEME3	= SGS.ID_KADEME3
			INNER JOIN OkyanusDB.dbo.v3Kullanici		KUL ON KUL.TCKIMLIKNO	= O.TCKIMLIKNO
			WHERE   (@sID_SUBES		 IS NULL OR @sID_SUBES='[]'			OR SU.ID_SUBE		in (select value from openjson (@sID_SUBES)		))
				AND (@sID_SINAVGRUPS IS NULL OR @sID_SINAVGRUPS='[]'	OR SGS.ID_KADEME3	in (select value from openjson (@sID_SINAVGRUPS)))
				AND (@sID_SINIFS	 IS NULL OR @sID_SINIFS='[]'		OR SNF.ID_SINIF		in (select value from openjson (@sID_SINIFS)	))
			ORDER BY SU.AD, K3.ID_KADEME3, SNF.AD, KUL.AD, KUL.SOYAD

			DROP TABLE IF EXISTS #TMP_TKT
		END

		IF @ISLEM = 13	--	TKT KAZANIM ANALİZ
		BEGIN
			SELECT ROW_NUMBER() OVER(ORDER BY S.ID_KATEGORI, S.SORUNO) AS SORUNO, CASE WHEN S.ID_SORUTUR = 3 THEN 'PUAN ALIR' ELSE S.DOGRUCEVAP END AS CEVAP, S.ID_TKTSORU
			INTO #SORULIST
			FROM [dbo].[vw_TKTSoru] S
			WHERE S.ID_TKTTEST = @ID_TKTTEST
			AND ((@ID_SINAVGRUP IN (4, 5) AND S.ID_KADEME3 = @ID_SINAVGRUP) OR (@ID_SINAVGRUP NOT IN (4, 5) AND S.ID_KADEME3 = 0))

			SELECT OS.ID_TKTOGRENCISINAV, O.TCKIMLIKNO, YASAY = DATEDIFF(MONTH, KUL.DOGUMTARIHI, CAST(OS.SINAVTARIH AS DATE))-1
			INTO #OGRENCILIST13
			FROM OkyanusDB.dbo.v3OgrenciTum				O	
			INNER JOIN OkyanusDB.dbo.v3Sube				SU	ON SU.ID_SUBE		= O.ID_SUBE
			INNER JOIN OkyanusDB.dbo.v3SinifTum			SNF ON SNF.ID_SINIF		= O.ID_SINIF	AND SNF.DONEM	= O.DONEM
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum	SGS ON SGS.ID_SINIF		= O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Kademe3			K3	ON K3.ID_KADEME3	= SGS.ID_KADEME3
			INNER JOIN OkyanusDB.dbo.v3Kullanici		KUL ON KUL.TCKIMLIKNO	= O.TCKIMLIKNO
			INNER JOIN TKTOgrenciSinav					OS	ON OS.TCKIMLIKNO	= O.TCKIMLIKNO AND AKTIF = 1 AND OS.DONEM = O.DONEM
			WHERE O.DONEM = @DONEM AND SGS.ID_KADEME3 = @ID_SINAVGRUP AND OS.ID_TKTTEST = @ID_TKTTEST AND KUL.DOGUMTARIHI IS NOT NULL
				AND (@ID_SUBES	IS NULL OR @ID_SUBES='[]'	OR SU.ID_SUBE	in (select value from openjson (@ID_SUBES)		))
				AND (@ID_SINIFS	IS NULL OR @ID_SINIFS='[]'	OR SNF.ID_SINIF	in (select value from openjson (@ID_SINIFS)	))
			ORDER BY SU.AD, K3.ID_KADEME3, SNF.AD, KUL.AD, KUL.SOYAD

			SELECT * 
			INTO #OGRENCISORU
			FROM #OGRENCILIST13 O
			CROSS APPLY #SORULIST S

			CREATE TABLE #YAS (YASAY INT)

			DECLARE @I INT = 50
			WHILE @I < 101
			BEGIN
				INSERT INTO #YAS
				SELECT @I

				SET @I = @I + 1
			END

			SELECT *
			INTO #SORUAYLIST
			FROM #YAS Y 
			CROSS JOIN #SORULIST S

			SELECT OS.SORUNO, OS.CEVAP, OS.YASAY, SUM(CASE WHEN OC.ID_TKTOGRENCICEVAP IS NULL THEN 0 ELSE 1 END) AS DS, SUM(CASE WHEN OC.ID_TKTOGRENCICEVAP IS NULL THEN 1 ELSE 0 END) AS YS
			INTO #GRUP
			FROM #OGRENCISORU OS 
			LEFT JOIN TKTOgrenciCevap OC ON OC.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV AND OC.ID_TKTSORU = OS.ID_TKTSORU
			GROUP BY OS.SORUNO, OS.CEVAP, OS.YASAY

			SELECT SORUNO, CEVAP,
						MAX([50DS]) AS [50DS],MAX([51DS]) AS [51DS],MAX([52DS]) AS [52DS],MAX([53DS]) AS [53DS],MAX([54DS]) AS [54DS],MAX([55DS]) AS [55DS],MAX([56DS]) AS [56DS],MAX([57DS]) AS [57DS],MAX([58DS]) AS [58DS],MAX([59DS]) AS [59DS],MAX([60DS]) AS [60DS],MAX([61DS]) AS [61DS],MAX([62DS]) AS [62DS],MAX([63DS]) AS [63DS],MAX([64DS]) AS [64DS],MAX([65DS]) AS [65DS],MAX([66DS]) AS [66DS],MAX([67DS]) AS [67DS],MAX([68DS]) AS [68DS],MAX([69DS]) AS [69DS],MAX([70DS]) AS [70DS],MAX([71DS]) AS [71DS],MAX([72DS]) AS [72DS],MAX([73DS]) AS [73DS],MAX([74DS]) AS [74DS],MAX([75DS]) AS [75DS],MAX([76DS]) AS [76DS],MAX([77DS]) AS [77DS],MAX([78DS]) AS [78DS],MAX([79DS]) AS [79DS],MAX([80DS]) AS [80DS],MAX([81DS]) AS [81DS],MAX([82DS]) AS [82DS],MAX([83DS]) AS [83DS],MAX([84DS]) AS [84DS],MAX([85DS]) AS [85DS],MAX([86DS]) AS [86DS],MAX([87DS]) AS [87DS],MAX([88DS]) AS [88DS],MAX([89DS]) AS [89DS],MAX([90DS]) AS [90DS],MAX([91DS]) AS [91DS],MAX([92DS]) AS [92DS],MAX([93DS]) AS [93DS],MAX([94DS]) AS [94DS],MAX([95DS]) AS [95DS],MAX([96DS]) AS [96DS],MAX([97DS]) AS [97DS],MAX([98DS]) AS [98DS],MAX([99DS]) AS [99DS],MAX([100DS]) AS [100DS],
						MAX([50YS]) AS [50YS],MAX([51YS]) AS [51YS],MAX([52YS]) AS [52YS],MAX([53YS]) AS [53YS],MAX([54YS]) AS [54YS],MAX([55YS]) AS [55YS],MAX([56YS]) AS [56YS],MAX([57YS]) AS [57YS],MAX([58YS]) AS [58YS],MAX([59YS]) AS [59YS],MAX([60YS]) AS [60YS],MAX([61YS]) AS [61YS],MAX([62YS]) AS [62YS],MAX([63YS]) AS [63YS],MAX([64YS]) AS [64YS],MAX([65YS]) AS [65YS],MAX([66YS]) AS [66YS],MAX([67YS]) AS [67YS],MAX([68YS]) AS [68YS],MAX([69YS]) AS [69YS],MAX([70YS]) AS [70YS],MAX([71YS]) AS [71YS],MAX([72YS]) AS [72YS],MAX([73YS]) AS [73YS],MAX([74YS]) AS [74YS],MAX([75YS]) AS [75YS],MAX([76YS]) AS [76YS],MAX([77YS]) AS [77YS],MAX([78YS]) AS [78YS],MAX([79YS]) AS [79YS],MAX([80YS]) AS [80YS],MAX([81YS]) AS [81YS],MAX([82YS]) AS [82YS],MAX([83YS]) AS [83YS],MAX([84YS]) AS [84YS],MAX([85YS]) AS [85YS],MAX([86YS]) AS [86YS],MAX([87YS]) AS [87YS],MAX([88YS]) AS [88YS],MAX([89YS]) AS [89YS],MAX([90YS]) AS [90YS],MAX([91YS]) AS [91YS],MAX([92YS]) AS [92YS],MAX([93YS]) AS [93YS],MAX([94YS]) AS [94YS],MAX([95YS]) AS [95YS],MAX([96YS]) AS [96YS],MAX([97YS]) AS [97YS],MAX([98YS]) AS [98YS],MAX([99YS]) AS [99YS],MAX([100YS]) AS [100YS]
			FROM   
			(
				SELECT *
				FROM   
				(
					SELECT SA.SORUNO, SA.CEVAP, CAST(SA.YASAY AS VARCHAR) + 'DS' AS YASAYDS, CAST(SA.YASAY AS VARCHAR) + 'YS' AS YASAYYS, ISNULL(G.DS, 0) AS DS, ISNULL(G.YS, 0) AS YS
					FROM #SORUAYLIST SA
					LEFT JOIN #GRUP G ON G.SORUNO = SA.SORUNO AND G.YASAY = SA.YASAY
				) p  
				PIVOT  
				(  
					SUM (DS)  
					FOR YASAYDS IN  
					( [50DS],[51DS],[52DS],[53DS],[54DS],[55DS],[56DS],[57DS],[58DS],[59DS],[60DS],[61DS],[62DS],[63DS],[64DS],[65DS],[66DS],[67DS],[68DS],[69DS],[70DS],[71DS],[72DS],[73DS],[74DS],[75DS],[76DS],[77DS],[78DS],[79DS],[80DS],[81DS],[82DS],[83DS],[84DS],[85DS],[86DS],[87DS],[88DS],[89DS],[90DS],[91DS],[92DS],[93DS],[94DS],[95DS],[96DS],[97DS],[98DS],[99DS],[100DS] )  
				) AS pvt  
			) p  
			PIVOT  
			(  
				SUM (YS)  
				FOR YASAYYS IN  
				( [50YS],[51YS],[52YS],[53YS],[54YS],[55YS],[56YS],[57YS],[58YS],[59YS],[60YS],[61YS],[62YS],[63YS],[64YS],[65YS],[66YS],[67YS],[68YS],[69YS],[70YS],[71YS],[72YS],[73YS],[74YS],[75YS],[76YS],[77YS],[78YS],[79YS],[80YS],[81YS],[82YS],[83YS],[84YS],[85YS],[86YS],[87YS],[88YS],[89YS],[90YS],[91YS],[92YS],[93YS],[94YS],[95YS],[96YS],[97YS],[98YS],[99YS],[100YS] )  
			) AS pvt  
			GROUP BY SORUNO, CEVAP
			ORDER BY SORUNO

			DROP TABLE #GRUP
			DROP TABLE #SORUAYLIST
			DROP TABLE #YAS
			DROP TABLE #OGRENCISORU
			DROP TABLE #OGRENCILIST13
			DROP TABLE #SORULIST
		END

		DROP TABLE IF EXISTS #KADEMELER
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_TopluYaziliYoklamaSonuclari]...';


GO

--EXEC	@return_value = [dbo].[sp_TopluYaziliYoklamaSonuclari]
--		@TCKIMLIKNO = '56545519606',
--		@OTURUM = '35EBC180-01A2-4FB3-B59F-1D42781A3C42',
--		@ID_MENU = 1091,
--		@ID_DERSLER = '[850]',
--		@ISLEM = 3,
--		@DONEM = '2017',
--		@ID_KADEME3 = 18

ALTER procedure [dbo].[sp_TopluYaziliYoklamaSonuclari]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVLAR		VARCHAR(MAX)	= '',
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ID_DERSLER			VARCHAR(MAX)	= '',
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= null,
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@ID_KADEME3			INT				= 0,
	@YARIYIL			VARCHAR(10)		= ''
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAVLAR				= @ID_SINAVLAR
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ID_DERSLER					= @ID_DERSLER	
			,SINIFLAR					= @SINIFLAR	
			,ID_DERS					= @ID_DERS	
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
			,ID_KADEME3					= @ID_KADEME3	
			,YARIYIL					= @YARIYIL	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			
			DECLARE @SQL AS VARCHAR(max) 
			DECLARE @Columns AS VARCHAR(max) 
			DECLARE @Columns2 AS VARCHAR(max) 
			DECLARE @Columns3 AS VARCHAR(max) 

			IF @ISLEM = 1 OR @ISLEM = 2	--	Toplu Yazılı Yoklama Sunuçları Getir
			BEGIN
				SELECT sr.ID_SINAVRAPOR, 
					   sr.SINAVADI, 
					   su.AD						    AS KAMPUS, 
					   sn.AD                            AS SINIF, 
					   k.TCKIMLIKNO, 
					   k.AD + ' ' + k.SOYAD             AS ADSOYAD, 
					   Sum(oo.PUAN)                     AS PUAN 
				INTO   #tablo 
				FROM	   eokul_v2.dbo.SinavRapor		sr 
				INNER JOIN eokul_v2.dbo.OgrenciNot		oo ON oo.ID_SINAVRAPOR = sr.ID_SINAVRAPOR 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci		og ON og.ID_OGRENCI = oo.ID_OGRENCI 
				INNER JOIN OkyanusDB.dbo.v3Sube			su ON su.ID_SUBE = og.ID_SUBE 
				INNER JOIN OkyanusDB.dbo.v3Satislar		sa ON sa.ID_SOZLESME = og.ID_SOZLESME 
				INNER JOIN OkyanusDB.dbo.v3Sinif		sn ON sn.ID_SINIF = sa.ID_SINIF 
				INNER JOIN OkyanusDB.dbo.v3Kullanici	k ON k.TCKIMLIKNO = og.TCKIMLIKNO 
				INNER JOIN eokul_v2.dbo.Ders			d ON d.ID_DERS = sr.ID_DERS 
				WHERE  sr.DONEMKOD = @DONEM 
					   AND sr.isActive = 1 
					   AND k.AKTIF = 1 
					   AND ( ( sr.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
					   AND ( ( sr.ID_SINAVRAPOR	IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
					   AND ( ( su.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
					   AND ( ( og.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
					   AND ( sr.GRUP = (select AD from OkyanusDB.dbo.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3) OR @ID_KADEME3 = 0 ) 
					   AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				GROUP  BY sr.ID_SINAVRAPOR, 
						  sr.SINAVADI, 
						  su.AD, 
						  sn.AD, 
						  k.TCKIMLIKNO, 
						  k.AD, 
						  k.SOYAD 
				ORDER  BY sr.ID_SINAVRAPOR, 
						  sr.SINAVADI, 
						  su.AD, 
						  sn.AD, 
						  k.AD, 
						  k.SOYAD 

				SELECT @Columns = COALESCE(@Columns+',', '') + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_SINAVRAPOR FROM #tablo) AS b 
				ORDER  BY b.ID_SINAVRAPOR 

				SELECT @Columns2 = COALESCE(@Columns2+',', '') + 'ISNULL(' + Quotename(SINAVADI) + ',-1) AS ' + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_SINAVRAPOR FROM   #tablo) AS b 
				ORDER  BY b.ID_SINAVRAPOR 

				SET @SQL=';with PivotData as   
						  ( Select   KAMPUS,  
									 SINAVADI,  
									 SINIF,  
									 TCKIMLIKNO,  
									 ADSOYAD,  
									 PUAN 
							from #Tablo   
						  )   
						  Select     KAMPUS, 
									 SINIF, 
									 TCKIMLIKNO, 
									 ADSOYAD,    
									 ' + @Columns2 + '    
						  into #pivot    
						  from PivotData    
						  PIVOT    
						  ( 
							SUM(PUAN) 
							FOR SINAVADI IN(' + @Columns + ')    
						  ) as PivotResult    
						  ORDER BY KAMPUS,SINIF,ADSOYAD
						  '

				IF @ISLEM = 1 -- HTML
				BEGIN
					SET @SQL = @SQL + 'SELECT
									  (        
										  Select * from #pivot p
										  FOR JSON PATH, INCLUDE_NULL_VALUES   
									  ) AS J'
				END 
				ELSE IF @ISLEM = 2 -- DEVEXPRESS
				BEGIN
					SET @SQL = @SQL + 'Select * from #pivot p'
				END
				
				EXEC (@SQL) 
				DROP TABLE #tablo
			END 

			IF @ISLEM = 3	--	Yazılı Listele
			BEGIN
				SELECT
				(
					Select DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD, TARIH
					from eokul_v2.dbo.SinavRapor SR
					where sr.isActive=1 
					AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM OkyanusDb.dbo.v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
					AND (@ID_DERSLER IS NULL OR @ID_DERSLER='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER)))
					AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
					AND SR.isActive=1
					and sr.DONEMKOD=@DONEM
					order by TARIH
					FOR JSON PATH
				) AS J
				--SELECT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
				--INTO #TEMPX
				--FROM	eokul_v2.dbo.OgrenciNot		O			
				--INNER JOIN	eokul_v2.dbo.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
				--INNER JOIN    OkyanusDb.dbo.v3Ogrenci		VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
				--INNER JOIN	OkyanusDb.dbo.v3Kullanici	VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
				--WHERE	SR.DONEMKOD=@DONEM
				--	AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM OkyanusDb.dbo.v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
				--	AND (@ID_SINIFLAR IS NULL OR @ID_SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFLAR)))
				--	AND (@ID_DERSLER IS NULL OR @ID_DERSLER='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER)))
				--	AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				--	AND sr.isActive=1

				--SELECT DISTINCT * FROM #TEMPX
				--DROP TABLE #TEMPX
			END 

			IF @ISLEM = 4	--	Yazılı Listele Test
			BEGIN
				IF @ID_DERS IS NULL
				BEGIN
					SELECT
					(
						Select DISTINCT ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						where sr.AKTIF=1 
						AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (@ID_DERSLER IS NULL OR @ID_DERSLER='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER)))
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						where sr.AKTIF=1 
						AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			END 

			IF @ISLEM = 5 OR @ISLEM = 6	--	Toplu Yazılı Yoklama Sunuçları Getir YENİ
			BEGIN
				SELECT DISTINCT Y.ID_YAZILI
						,Y.AD					AS SINAVADI
						,SB.AD					AS KAMPUS
						,S.AD					AS SINIF
						,K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD	AS ADSOYAD
						,ISNULL(YO.TELAFI, Sum(YOC.PUAN))			AS PUAN 
				INTO #tabloY
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE		Y.DONEM = @DONEM 
							AND Y.AKTIF = 1 
							AND k.AKTIF = 1 
							AND ( ( Y.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSLER)) )		OR @ID_DERSLER = '' ) 
							AND ( ( Y.ID_YAZILI		IN (SELECT VALUE FROM Openjson (@ID_SINAVLAR)) )	OR @ID_SINAVLAR = '' ) 
							AND ( ( SB.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) )		OR @ID_SUBELER = '' ) 
							AND ( ( S.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) )	OR @ID_SINIFLAR = '' ) 
							--AND ( Y.ID_KADEME3 = @ID_KADEME3 OR @ID_KADEME3 = 0 ) 
							AND (@YARIYIL IS NULL OR @YARIYIL=0 OR Y.YARIYIL LIKE '%'+@YARIYIL+'%')
				GROUP BY	Y.ID_YAZILI, 
							Y.AD, 
							SB.AD, 
							S.AD, 
							K.TCKIMLIKNO, 
							K.AD, 
							K.SOYAD,
							YO.TELAFI
				ORDER BY	Y.ID_YAZILI, 
							Y.AD, 
							SB.AD, 
							S.AD, 
							ADSOYAD


				SELECT @Columns = COALESCE(@Columns+',', '') + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_YAZILI FROM #tabloY) AS b 
				ORDER  BY b.ID_YAZILI 

				SELECT @Columns2 = COALESCE(@Columns2+',', '') + 'ISNULL(' + Quotename(SINAVADI) + ',-1) AS ' + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_YAZILI FROM   #tabloY) AS b 
				ORDER  BY b.ID_YAZILI 
				
				SELECT @Columns3 = COALESCE(@Columns3+',', '') + ' CASE WHEN ' + Quotename(SINAVADI) +' = -1 THEN ''-'' ELSE CAST(' + Quotename(SINAVADI) +' AS VARCHAR) END AS ' + Quotename(SINAVADI) 
				FROM   (SELECT DISTINCT SINAVADI, ID_YAZILI FROM   #tabloY) AS b 
				ORDER  BY b.ID_YAZILI

				SET @SQL=';with PivotData as   
						  ( Select   KAMPUS,  
									 SINAVADI,  
									 SINIF,  
									 TCKIMLIKNO,  
									 ADSOYAD,  
									 PUAN 
							from #tabloY 
						  )   
						  Select     KAMPUS, 
									 SINIF, 
									 TCKIMLIKNO, 
									 ADSOYAD,    
									 ' + @Columns2 + '    
						  into #pivotY    
						  from PivotData    
						  PIVOT    
						  ( 
							SUM(PUAN) 
							FOR SINAVADI IN(' + @Columns + ')    
						  ) as PivotResult    
						  ORDER BY KAMPUS,SINIF,ADSOYAD
						  '

				IF @ISLEM = 5 -- HTML
				BEGIN
					SET @SQL = @SQL + 'SELECT
									  (        
										  Select * from #pivotY p
										  FOR JSON AUTO, INCLUDE_NULL_VALUES   
									  ) AS J'
				END 
				ELSE IF @ISLEM = 6 -- DEVEXPRESS
				BEGIN
					SET @SQL = @SQL + 'Select KAMPUS, 
										SINIF, 
										TCKIMLIKNO, 
										ADSOYAD,    '+@Columns3+' from #pivotY p'
				END
				
				EXEC (@SQL) 
				DROP TABLE #tabloY
			END 
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_UniteTarama]...';


GO
ALTER procedure [dbo].[sp_UniteTarama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@AD						VARCHAR(MAX)	= NULL,
	@ID_UNITESINAV			INT				= NULL,
	@ID_UNITETARAMASINAV	INT			= NULL,
	@SQLJSON				VARCHAR(MAX)	= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@O_TCKIMLIKNO			VARCHAR(11)		= NULL,
	@DERS					VARCHAR(MAX)	= NULL,
	@DERS_ID				INT             = NULL,
	@ID_DERS				INT             = NULL,
	@ID_UNITETARAMASORU		INT				= NULL,			
	@SIRA					INT				= NULL,
	@KITAPCIKSAYISI			INT				= NULL,
	@ID_KADEME3				INT				= NULL,
	@OVGORSUN				BIT				= NULL,
	@ID_UNITETARAMAKITAPCIK INT         =NULL,
	@ID_SINAVTURU			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURUS			VARCHAR(MAX)	= NULL,
	@ID_SINIFs				VARCHAR(MAX)	= NULL,
	@ID_SINAVs				VARCHAR(MAX)	= NULL,
	@ID_DERSs				VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM			char(4)			= '',
	@ID_ODEVTUR				INT				= NULL,
	@KOD					VARCHAR(MAX)	= NULL ,
	@ID_SUBELER				VARCHAR(MAX)	= NULL,
	@ID_SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST			VARCHAR(MAX)	= NULL,
	@KODs					VARCHAR(MAX)	= NULL
	
AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM									=	@ISLEM					
			,TCKIMLIKNO								=	@TCKIMLIKNO				
			,OTURUM									=	@OTURUM					
			,ID_MENU								=	@ID_MENU				
			,DONEM									=	@DONEM					
			,AD										=	@AD						
			,ID_UNITESINAV							=	@ID_UNITESINAV			
			,ID_UNITETARAMASINAV					=	@ID_UNITETARAMASINAV	
			,SQLJSON								=	@SQLJSON				
			,ID_SINIF								=	@ID_SINIF				
			,ID_SUBE								=	@ID_SUBE				
			,ID_SUBEs								=	@ID_SUBEs				
			,O_TCKIMLIKNO							=	@O_TCKIMLIKNO			
			,DERS									=	@DERS					
			,DERS_ID							    =	@DERS_ID				
			,ID_DERS							    =	@ID_DERS				
			,ID_UNITETARAMASORU						=	@ID_UNITETARAMASORU		
			,SIRA									=	@SIRA					
			,KITAPCIKSAYISI							=	@KITAPCIKSAYISI			
			,ID_KADEME3								=	@ID_KADEME3				
			,OVGORSUN								=	@OVGORSUN				
			,ID_UNITETARAMAKITAPCIK			        =	@ID_UNITETARAMAKITAPCIK 
			,ID_SINAVTURU							=	@ID_SINAVTURU			
			,ID_SINAVTURUS							=	@ID_SINAVTURUS			
			,ID_SINIFs								=	@ID_SINIFs				
			,ID_SINAVs								=	@ID_SINAVs				
			,ID_DERSs								=	@ID_DERSs				
			,OGRENCIDONEM							=	@OGRENCIDONEM			
			,ID_ODEVTUR								=	@ID_ODEVTUR				
			,KOD									=	@KOD					
			,ID_SUBELER								=	@ID_SUBELER				
			,ID_SINIFLAR							=	@ID_SINIFLAR			
			,ID_SINIFLIST							=	@ID_SINIFLIST			
			,KODs									=	@KODs					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--BEGIN TRANSACTION [Tran1]
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			DECLARE  @OZELSINAVGOR BIT=0

			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
			BEGIN
				SET @OZELSINAVGOR=1
			END
						
			Declare  @SQL		as varchar(max)=null
					,@Columns	as varchar(max)=null
					,@Columns2	as varchar(max)=null
					,@Columns3	as varchar(max)=null

			IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )
			BEGIN
				IF @ISLEM = 1	--	SINAV TANIMLA
				BEGIN
					DECLARE @INSERTED TABLE(ID INT NOT NULL);  

					INSERT INTO UniteTaramaSinav(AD, DONEM, KYE_TCKIMLIKNO, ID_KADEME3)
					OUTPUT inserted.ID_UNITETARAMASINAV
					INTO @INSERTED
					SELECT @AD, @DONEM, @TCKIMLIKNO, @ID_KADEME3

					DECLARE @cnt INT = 0;

					WHILE @cnt < @KITAPCIKSAYISI
					BEGIN
						INSERT INTO UniteTaramaKitapcik(ID_UNITETARAMASINAV, AD)
						SELECT ID, CHAR(65 + @cnt) FROM @INSERTED
						SET @cnt = @cnt + 1;
					END;
				END	
			
				IF @ISLEM = 2	--	SINAV LİSTELE
				BEGIN
					SELECT
					(
						SELECT	 S.ID_UNITETARAMASINAV
								,S.AD
								,KADEME3		= K3.AD
								,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
								,ADSOYAD		= K.AD + ' ' + K.SOYAD 
								,KITAPCIKSAYISI	= (SELECT COUNT(1) FROM UniteTaramaKitapcik SK WHERE SK.ID_UNITETARAMASINAV = S.ID_UNITETARAMASINAV) 
								,S.OVGORSUN
						FROM UniteTaramaSinav S 
						INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.KYE_TCKIMLIKNO
						INNER JOIN v3Kademe3				 K3 ON K3.ID_KADEME3	= S.ID_KADEME3
						WHERE	S.DONEM		 = @DONEM 
							AND S.ID_KADEME3 = @ID_KADEME3
							AND S.AKTIF		 = 1 
						ORDER BY S.KYE_TARIH DESC 
						FOR JSON PATH
					)
				END

				IF @ISLEM = 3	--	SINAV DUZENLE
				BEGIN
					UPDATE UniteTaramaSinav SET 
						 AD			= @AD
						,ID_KADEME3 = @ID_KADEME3 
					WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					DECLARE @MEVCUTKITAPCIKSAYISI INT = (SELECT COUNT(1) FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV)

					IF @KITAPCIKSAYISI <> @MEVCUTKITAPCIKSAYISI
					BEGIN
						IF @KITAPCIKSAYISI > @MEVCUTKITAPCIKSAYISI
						BEGIN
							DECLARE @cntx INT = @MEVCUTKITAPCIKSAYISI;

							WHILE @cntx < @KITAPCIKSAYISI
							BEGIN
								INSERT INTO UniteTaramaKitapcik(ID_UNITETARAMASINAV, AD)
								SELECT @ID_UNITETARAMASINAV, CHAR(65 + @cntx)

								DECLARE @YENIID_UNITETARAMAKITAPCIK INT = (SELECT ID_UNITETARAMAKITAPCIK FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV AND AD = CHAR(65 + @cntx))

								IF EXISTS (SELECT 1 FROM UniteTaramaSoru WHERE ID_UNITETARAMASINAV= @ID_UNITETARAMASINAV)
								BEGIN
									INSERT INTO UniteTaramaSoruKarsilik(ID_UNITETARAMASORU, ID_UNITETARAMAKITAPCIK, SORUNO)
									SELECT S.ID_UNITETARAMASORU, @YENIID_UNITETARAMAKITAPCIK, S.SORUNO
									FROM UniteTaramaSoru S
								END
							
								SET @cntx = @cntx + 1;
							END;
						END
						ELSE
						BEGIN
							SELECT TOP(@MEVCUTKITAPCIKSAYISI - @KITAPCIKSAYISI) ID_UNITETARAMAKITAPCIK 
							INTO #TEMPKITAPCIK
							FROM UniteTaramaKitapcik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
							ORDER BY ID_UNITETARAMAKITAPCIK DESC

							DELETE SK FROM UniteTaramaSoruKarsilik SK
							INNER JOIN #TEMPKITAPCIK K ON K.ID_UNITETARAMAKITAPCIK = SK.ID_UNITETARAMAKITAPCIK

							DELETE K FROM UniteTaramaKitapcik K
							INNER JOIN #TEMPKITAPCIK T ON T.ID_UNITETARAMAKITAPCIK = K.ID_UNITETARAMAKITAPCIK
						END
					END
				END

				IF @ISLEM = 4	--	SINAV SİL
				BEGIN
					UPDATE UniteTaramaSinav SET AKTIF = 0 WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				END

				IF @ISLEM = 5	--	SINAV EXCEL YÜKLE
				BEGIN
					IF EXISTS (	
								SELECT TOP 1 1 FROM UniteTaramaOgrenci O 
								INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = O.ID_UNITETARAMASORU
								WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
							)
					BEGIN
						RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
					END
					ELSE
					BEGIN
						DELETE SK FROM UniteTaramaSoruKarsilik SK
						INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = SK.ID_UNITETARAMASORU
						WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				
						DELETE FROM UniteTaramaSoru WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaYorum WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaPuanAralik WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
						DELETE FROM UniteTaramaBeceri WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV


						DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  
						INSERT INTO UniteTaramaSoru (ID_UNITETARAMASINAV, ID_DERS,SORUNO, KAZANIMKOD, PUAN)
						OUTPUT inserted.ID_UNITETARAMASORU, inserted.SORUNO
						INTO @INSERTEDSORU
						SELECT @ID_UNITETARAMASINAV, ID_DERS, SORUNO, KAZANIMKOD, PUAN FROM OPENJSON(@SQLJSON)
						WITH (
							PUAN		INT,
							SORUNO		INT,
							ID_DERS		VARCHAR(MAX),
							KAZANIMKOD	VARCHAR(MAX)
						)

						INSERT INTO UniteTaramaSoruKarsilik
						SELECT ID, K.ID_UNITETARAMAKITAPCIK, S.SORUNO FROM @INSERTEDSORU S
						CROSS JOIN UniteTaramaKitapcik K WHERE K.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				
						--INSERT INTO UniteTaramaYorum (ID_UNITETARAMASINAV, DERS, DUZEY, YORUM, ONERI)
						--SELECT @ID_UNITETARAMASINAV, DERS, DUZEY, YORUM, ONERI FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
						--WITH (
						--	DERS VARCHAR(MAX),
						--	DUZEY INT,
						--	YORUM VARCHAR(MAX),
						--	ONERI VARCHAR(MAX)
						--)
				
						--INSERT INTO UniteTaramaPuanAralik(ID_UNITETARAMASINAV, MAXIMUMPUAN, DUZEY)
						--SELECT @ID_UNITETARAMASINAV, MAXIMUMPUAN, DUZEY FROM OPENJSON(@SQLJSON, '$.PUANARALIKLIST')
						--WITH (
						--	MAXIMUMPUAN INT,
						--	DUZEY INT
						--)
				
						--INSERT INTO UniteTaramaBeceri(ID_UNITETARAMASINAV, DERS, BECERI, ACIKLAMA)
						--SELECT @ID_UNITETARAMASINAV, DERS, BECERI, ACIKLAMA FROM OPENJSON(@SQLJSON, '$.BECERILIST')
						--WITH (
						--	DERS VARCHAR(MAX),
						--	BECERI VARCHAR(MAX),
						--	ACIKLAMA VARCHAR(MAX)
						--)
					END
				END

				IF @ISLEM = 6	--	SINAV EXCEL LİSTELE
				BEGIN
					SELECT
					(	SELECT * 
						FROM [Pusulam].[dbo].[UniteTaramaSoru] 
						WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV 				
						FOR JSON PATH--, WITHOUT_ARRAY_WRAPPER
					)
				END

				IF @ISLEM = 7	--	ÖĞRENCİ LİSTELE
				BEGIN
					SELECT
					(
						SELECT	O.OGRNO 
								,O.TCKIMLIKNO
								,K.AD + ' ' + K.SOYAD AS ADSOYAD
								,(	
									SELECT D.DERSAD AS DERS, SUM(CASE WHEN AO.PUAN IS NULL THEN 0 ELSE 1 END) AS CEVAPSAYISI 
									FROM UniteTaramaSoru S INNER JOIN eokul_v2.[dbo].[Ders] D ON D.ID_DERS=S.ID_DERS
									LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
									WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
									GROUP BY S.ID_DERS,D.DERSAD
									FOR JSON PATH
								 ) AS CEVAP
						FROM OkyanusDB.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					
						WHERE O.ID_SINIF = @ID_SINIF AND O.DONEM = @DONEM
						ORDER BY K.AD + ' ' + K.SOYAD
						FOR JSON PATH
					)
				END

				IF @ISLEM = 8	--	ÖĞRENCİ PUAN LİSTELE
				BEGIN
					SELECT
					(
						SELECT S.ID_UNITETARAMASORU, S.SORUNO, VD.AD AS KAZANIM,S.PUAN AS MAXPUAN ,AO.PUAN
						FROM UniteTaramaSoru S
						INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD ON S.ID_DERS=VD.ID_DERS
						AND VD.KOD=S.KAZANIMKOD
						INNER JOIN UniteTaramaSoruKarsilik SK ON SK.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU
						INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=S.ID_DERS
						LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = @O_TCKIMLIKNO AND AO.AKTIF = 1
					
						WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV AND D.DERSAD = @DERS AND (@ID_UNITETARAMAKITAPCIK IS NULL OR SK.ID_UNITETARAMAKITAPCIK = @ID_UNITETARAMAKITAPCIK) 
					
					
						ORDER BY SK.SORUNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END

				IF @ISLEM = 9	--	ÖĞRENCİ PUAN KAYDET
				BEGIN
					UPDATE UniteTaramaOgrenci SET AKTIF = 0 WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND ID_UNITETARAMASORU IN (SELECT ID_UNITETARAMASORU FROM OPENJSON(@SQLJSON) WITH (ID_UNITETARAMASORU INT))

					INSERT INTO UniteTaramaOgrenci (ID_UNITETARAMASORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO, ID_UNITETARAMAKITAPCIK)
					SELECT ID_UNITETARAMASORU, @O_TCKIMLIKNO, PUAN, @TCKIMLIKNO, @ID_UNITETARAMAKITAPCIK FROM OPENJSON(@SQLJSON)
					WITH
					(
						ID_UNITETARAMASORU INT,
						PUAN INT
					)
					WHERE PUAN IS NOT NULL
				END

				IF @ISLEM = 10	--	ÖĞRENCİ DERS PUAN SİL
				BEGIN
					UPDATE AO SET AO.AKTIF = 0 
					FROM UniteTaramaOgrenci AO 
					INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = AO.ID_UNITETARAMASORU
					INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=S.ID_DERS
					WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND D.DERSAD = @DERS AND S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
				END

				IF @ISLEM = 17	--	SINAV LİSTELE by OGRENCI
				BEGIN
					SELECT
					(
						SELECT DISTINCT S.ID_UNITETARAMASINAV, S.AD, CONVERT(varchar, S.KYE_TARIH, 104) AS TARIH, K.AD + ' ' + K.SOYAD AS ADSOYAD,S.KYE_TARIH
						FROM UniteTaramaSinav	S 
						JOIN v3Kullanici		K	ON	K.TCKIMLIKNO			= S.KYE_TCKIMLIKNO
						JOIN UniteTaramaSoru	SO	ON	SO.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
						JOIN UniteTaramaOgrenci	O	ON	O.ID_UNITETARAMASORU	= SO.ID_UNITETARAMASORU
						WHERE	S.DONEM			= @DONEM 
							AND O.TCKIMLIKNO	= @O_TCKIMLIKNO
							AND S.AKTIF			= 1 
							AND S.OVGORSUN		= 1
						ORDER BY S.KYE_TARIH DESC
						FOR JSON PATH
					)
				END

				IF @ISLEM = 18	--	PUAN LİSTESİ GETİR (EXCEL)
				BEGIN
					SELECT D.AD DERS, MAX(SORUNO) AS SORUNO 
					FROM UniteTaramaSinav		S
					INNER JOIN UniteTaramaSoru	SS	ON	SS.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
					INNER JOIN v3Ders			D	ON	D.ID_DERS				= SS.ID_DERS 
					WHERE S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
					GROUP BY D.AD
					ORDER BY DERS

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #DERS

					SELECT 
							SB.AD AS SUBE
							,K3.AD AS GRUP
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,SN.AD AS SINIF
							,SN.ID_SINIF
							,AO.TCKIMLIKNO
							,D.DERSAD AS DERS
							,SORU.SORUNO
							,AO.PUAN
					INTO #TEMP
					FROM UniteTaramaOgrenci AO
					INNER JOIN UniteTaramaSoru SORU ON SORU.ID_UNITETARAMASORU = AO.ID_UNITETARAMASORU
					INNER JOIN eokul_v2.[dbo].[Ders] D on  D.ID_DERS=SORU.ID_DERS
					INNER JOIN UniteTaramaSinav SINAV ON SINAV.ID_UNITETARAMASINAV = SORU.ID_UNITETARAMASINAV
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = AO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = AO.TCKIMLIKNO AND O.DONEM = SINAV.DONEM
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = SN.ID_SATISTURU
					INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = ST.ID_KADEME3
					WHERE	SINAV.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV 
						AND SINAV.DONEM = @DONEM
						AND SINAV.AKTIF = 1 
						AND AO.AKTIF = 1
						AND (@ID_SUBE	IS NULL OR @ID_SUBE		= 0 OR O.ID_SUBE	= @ID_SUBE)
						AND (@ID_SINIF	IS NULL OR @ID_SINIF	= 0 OR O.ID_SINIF	= @ID_SINIF)

					DECLARE 
							@COLS AS NVARCHAR(MAX),
							@QUERY  AS NVARCHAR(MAX)

					SELECT DERS+'-'+CAST(SORUNO AS VARCHAR) AS DERS
					INTO #DERS
					FROM #TEMP
					GROUP BY DERS, SORUNO
					ORDER BY DERS, SORUNO

					SELECT @COLS = STUFF((SELECT ','+QUOTENAME(DERS2)+' VARCHAR(MAX) DEFAULT ''-''' 
										  FROM (
													SELECT
														T.DERS + '-' + CAST(T.SORUNO AS VARCHAR) AS DERS2
													FROM #TEMP T 
													GROUP BY T.DERS, T.SORUNO
												) AS S
											FOR XML PATH(''), TYPE
											).value('.', 'NVARCHAR(MAX)') 
										,1,1,'')

					SET @QUERY = '
						DROP TABLE IF EXISTS #T
						CREATE TABLE #T (SUBE VARCHAR(MAX), GRUP VARCHAR(MAX), ADSOYAD VARCHAR(MAX), SINIF VARCHAR(MAX), TCKIMLIKNO VARCHAR(MAX),' + @COLS + ')

						INSERT INTO #T (SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO)
						SELECT SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO FROM #TEMP

						WHILE EXISTS ( SELECT *  FROM #DERS)
						BEGIN

							DECLARE @DERSAD VARCHAR(100) = (SELECT TOP(1) DERS FROM #DERS ORDER BY DERS)	
							DECLARE @QUERY2 NVARCHAR(MAX)

							SET @QUERY2=	
							''
								UPDATE T
								SET T.[''+@DERSAD+''] = P.PUAN
								FROM #T T
								JOIN #TEMP P ON T.TCKIMLIKNO = P.TCKIMLIKNO AND P.DERS + ''''-'''' +  CAST(P.SORUNO AS VARCHAR) = ''''''+@DERSAD+''''''
							''
							EXEC sp_executesql @QUERY2; 

							DELETE FROM #DERS WHERE DERS = @DERSAD
						END
						SELECT DISTINCT * FROM #T
						DROP TABLE IF EXISTS #T
					'
					PRINT @QUERY
					EXEC sp_executesql @QUERY; 

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #DERS
				END

				IF @ISLEM = 21	--	SINAV KİTAPÇIK LİSTELE
				BEGIN
					SELECT	DISTINCT K.ID_UNITETARAMAKITAPCIK
							,K.AD
							,CASE WHEN EXISTS(	
								SELECT 1 
								FROM UniteTaramaOgrenci O
								INNER JOIN UniteTaramaSoru S ON S.ID_UNITETARAMASORU = O.ID_UNITETARAMASORU
								INNER JOIN eokul_v2.[dbo].[Ders] D ON D.ID_DERS=S.ID_DERS
								WHERE O.ID_UNITETARAMAKITAPCIK = K.ID_UNITETARAMAKITAPCIK  AND O.TCKIMLIKNO = @O_TCKIMLIKNO AND O.AKTIF = 1 
							)
							THEN 1
							ELSE 0 
							END AS SECILI
					INTO #TEMPKITAPCIKSEC
					FROM UniteTaramaKitapcik K
					WHERE K.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					--IF NOT EXISTS (SELECT * FROM #TEMPKITAPCIKSEC WHERE SECILI = 1)
					--BEGIN
					--	UPDATE #TEMPKITAPCIKSEC SET SECILI = 1 WHERE AD = 'A'
					--END

					SELECT
					(
						SELECT * FROM #TEMPKITAPCIKSEC
						ORDER BY AD
						FOR JSON PATH
					)

					DROP TABLE #TEMPKITAPCIKSEC
				END

				IF @ISLEM = 25	--	OVGORSUN DEĞİŞTİR
				BEGIN
					UPDATE UniteTaramaSinav SET OVGORSUN = @OVGORSUN WHERE ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV

					select 1
				END

				IF @ISLEM = 26	--	KAZANIM LİSTELE
				BEGIN
					SELECT
					(
						SELECT DISTINCT D.AD DERSAD, VD.AD AS KAZANIM,S.ID_DERS,S.SORUNO,vd.KOD
						FROM UniteTaramaSoru S
						INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	VD	ON	S.ID_DERS				= VD.ID_DERS			AND VD.KOD=S.KAZANIMKOD
						INNER JOIN UniteTaramaSinav					Sn	on	S.ID_UNITETARAMASINAV	= Sn.ID_UNITETARAMASINAV
						INNER JOIN OkyanusDB.DBO.v3Ders				D	on  D.ID_DERS				= S.ID_DERS
						INNER JOIN UniteTaramaOgrenci				UO	ON	UO.ID_UNITETARAMASORU	= S.ID_UNITETARAMASORU
						INNER JOIN OkyanusDB.dbo.v3OgrenciTUM		O	ON	O.TCKIMLIKNO			= UO.TCKIMLIKNO
						INNER JOIN v3SinifTum						ST	ON	ST.ID_SINIF				= O.ID_SINIF			AND ST.DONEM = O.DONEM
						WHERE	Sn.DONEM				= @DONEM 
							AND Sn.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV 
							AND Sn.ID_KADEME3			= @ID_KADEME3
							AND (O.ID_SUBE	IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
							AND (O.ID_SINIF	IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')				    
						ORDER BY D.AD
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					as TblListe
				END

				IF @ISLEM = 27	--	Kazanım öğrenci listesi
				BEGIN
					SELECT
					(
		
							SELECT DISTINCT
								 S.ID_UNITETARAMASINAV AS ID_SINAVBILGI
								,GS.SUBEAD AS [KAMPÜS]
								,GS.SINIF
								,UO.TCKIMLIKNO
								,K.AD + ' '+ K.SOYAD [AD SOYAD]
								,O.ID_SINIF
								,D.DERSAD AS DERS
								,VD.AD AS KAZANIM
								,D.ID_DERS
								--,UO.PUAN
								,[PUAN] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100 AS DECIMAL(8,2))
								,[DOĞRULUK YÜZDESİ] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100 AS DECIMAL(8,2))
							FROM	   [Pusulam].dbo.UniteTaramaSinav		S						
							INNER JOIN [Pusulam].dbo.UniteTaramaSoru		SO WITH (NOLOCK)ON SO.ID_UNITETARAMASINAV=S.ID_UNITETARAMASINAV
							INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD	ON	SO.ID_DERS=VD.ID_DERS AND VD.KOD=SO.KAZANIMKOD 
							INNER JOIN [Pusulam].dbo.UniteTaramaOgrenci		UO	ON	UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
							INNER JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO=UO.TCKIMLIKNO
							INNER JOIN OkyanusDB.[dbo].[v3OgrenciTUM]		O	ON	O.TCKIMLIKNO=UO.TCKIMLIKNO AND O.DONEM = S.DONEM
							INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS	ON	GS.ID_SINIF = O.ID_SINIF
							INNER JOIN eokul_v2.dbo.Ders					D	ON D.ID_DERS=SO.ID_DERS
							INNER JOIN OkyanusDB.dbo.v3Kademe3				K3	ON K3.ID_KADEME3=S.ID_KADEME3
							WHERE		S.AKTIF			= 1
									AND S.DONEM			= @DONEM
									AND D.ID_DERS		= @ID_DERS
									AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
									AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
									AND SO.KAZANIMKOD=@KOD
							--GROUP BY S.ID_UNITETARAMASINAV ,S.AD ,D.DERSAD ,D.ID_DERS,UO.TCKIMLIKNO,O.ID_SINIF,K.AD,K.SOYAD,UO.PUAN,VD.AD
							ORDER BY ID_SINAVBILGI ,[KAMPÜS] ,SINIF ,[AD SOYAD], DERS, KAZANIM
							FOR JSON PATH, INCLUDE_NULL_VALUES
							) as TblListeOgr


	  
		
				END

				IF @ISLEM = 28	--	Kazanım öğrenci listesi
				BEGIN
					SELECT
					(
		
						
							SELECT DISTINCT
								 S.ID_UNITETARAMASINAV AS ID_SINAVBILGI
								,GS.SUBEAD AS [KAMPÜS]
								,GS.SINIF
								,UO.TCKIMLIKNO
								,K.AD + ' '+ K.SOYAD [AD SOYAD]
								,O.ID_SINIF
								,D.DERSAD AS DERS
								,VD.AD AS KAZANIM
								,D.ID_DERS
								,SO.KAZANIMKOD
								--,UO.PUAN
								,[PUAN] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100.00 AS DECIMAL(8,2))
								,[DOĞRULUK YÜZDESİ] = CAST(CAST(UO.PUAN AS FLOAT) / SO.PUAN * 100.00 AS DECIMAL(8,2))
							FROM	   [Pusulam].dbo.UniteTaramaSinav		S						
							INNER JOIN [Pusulam].dbo.UniteTaramaSoru		SO WITH (NOLOCK)ON SO.ID_UNITETARAMASINAV=S.ID_UNITETARAMASINAV
							INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD	ON	SO.ID_DERS=VD.ID_DERS AND VD.KOD=SO.KAZANIMKOD 
							INNER JOIN [Pusulam].dbo.UniteTaramaOgrenci		UO	ON	UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
							INNER JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO=UO.TCKIMLIKNO
							INNER JOIN OkyanusDB.[dbo].[v3OgrenciTUM]		O	ON	O.TCKIMLIKNO=UO.TCKIMLIKNO AND O.DONEM = S.DONEM
							INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS	ON	GS.ID_SINIF = O.ID_SINIF
							INNER JOIN eokul_v2.dbo.Ders					D	ON D.ID_DERS=SO.ID_DERS
							INNER JOIN OkyanusDB.dbo.v3Kademe3				K3	ON K3.ID_KADEME3=S.ID_KADEME3
							WHERE		S.AKTIF			= 1
									--AND S.DONEM			= @DONEM
									AND S.ID_UNITETARAMASINAV = @ID_UNITETARAMASINAV
									--AND D.ID_DERS		= @ID_DERS
									AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
									AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
									AND (SO.KAZANIMKOD	IN (SELECT VALUE FROM OPENJSON(@KODs))			OR @KODs		= '[]')
							--GROUP BY S.ID_UNITETARAMASINAV ,S.AD ,D.DERSAD ,D.ID_DERS,UO.TCKIMLIKNO,O.ID_SINIF,K.AD,K.SOYAD,UO.PUAN,VD.AD
							ORDER BY ID_SINAVBILGI ,[KAMPÜS] ,SINIF ,[AD SOYAD], DERS, KAZANIM
							FOR JSON PATH, INCLUDE_NULL_VALUES
							) as TblListeOgr


	  
		
				END

				IF  @ISLEM= 30	--	SINIF Listesi
				BEGIN
  
					 SELECT distinct D.SUBEAD,DS.SEVIYE AS [KUR SEVİYESİ],D.SINIF,S.TCKIMLIKNO,K.AD + ' '+ K.SOYAD [AD SOYAD] 
					 FROM  OkyanusDB.dbo.vw_SinifOgrenci S 
					 INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay D          ON   S.ID_SINIF=D.ID_SINIF
					 INNER JOIN  v3AktifDonem  AD                         ON   AD.DONEM=d.DONEM 
					 INNER JOIN OkyanusDB.dbo.v3Kullanici			K	  ON   K.TCKIMLIKNO=S.TCKIMLIKNO
					 LEFT JOIN   OkyanusDB.[dbo].[v4SinifOgretmenDers] SD ON   SD.ID_SINIF=D.ID_SINIF 
					 LEFT JOIN    OkyanusDB.[dbo].v4DersSeviye DS         ON   SD.ID_DERS=DS.ID_DERS AND SD.ID_DERSSEVIYE= DS.ID_DERSSEVIYE
					 WHERE AD.AKTIF=1        
					 AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
					 AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
 
					ORDER BY D.SUBEAD ASC,DS.SEVIYE DESC
			   END

				IF  @ISLEM= 31	--	Morpa Kazanım Bul
				BEGIN
					SELECT ISNULL((
						SELECT TOP 1 M.*,D.AD MORPADERS 
						,MATERYALLIST = (SELECT STUFF((SELECT DISTINCT ', ' +  CAST( SM.AD AS VARCHAR) FROM MorpaMateryal SM WHERE SM.ID_MORPADERS = M.ID_MORPADERS AND SM.AKTIF = 1  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 2, ''))
						,ID_MATERYALLIST = (SELECT SM.*
											FROM MorpaMateryal SM 
											WHERE	SM.ID_MORPADERS = M.ID_MORPADERS 
												AND SM.AKTIF		= 1
											FOR JSON PATH)
						FROM OkyanusDB.DBO.v3SinavDersUnite	U
						JOIN MorpaKazanim					M	ON	M.KOD_OKY		= U.KOD
						JOIN MorpaDers						D	ON	D.ID_MORPADERS	= M.ID_MORPADERS
						WHERE	U.KOD	= @KOD
							AND M.AKTIF	= 1
							AND D.AKTIF	= 1
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
			   END

				IF  @ISLEM= 32	--	Sınava Giren Öğrenci Listesi
				BEGIN
					SELECT ISNULL((
					
						SELECT DISTINCT
							 O.SUBEAD
							,O.SINIFAD
							,O.TCKIMLIKNO
							,O.AD
							,O.SOYAD
							,O.ID_SINIF
							,GIRDI  = cast(	IIF(	EXISTS (	SELECT TOP 1 S.ID_UNITETARAMASINAV 
																FROM UniteTaramaSinav	S
																JOIN UniteTaramaSoru	SO	ON	SO.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
																JOIN UniteTaramaOgrenci	U	ON	U.ID_UNITETARAMASORU	= SO.ID_UNITETARAMASORU
																							AND	U.TCKIMLIKNO			= O.TCKIMLIKNO 
																							AND U.AKTIF					= 1
																WHERE	S.ID_UNITETARAMASINAV	= @ID_UNITETARAMASINAV	
																	AND S.AKTIF					= 1
															)
												,1,0) 
										as bit)
						FROM OkyanusDB.DBO.vw_OgrenciDetayTum	O
						WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLIST))

						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]')
			   END

		   		IF (@ISLEM = 34 OR @ISLEM = 33)  -- SINIF
				BEGIN
			

				DROP TABLE IF EXISTS #TEMP_SINIF
				DROP TABLE IF EXISTS #SINIF
				DROP TABLE IF EXISTS #SINIF_DYB
				DROP TABLE IF EXISTS ##TblSinif
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #k
				DROP TABLE IF EXISTS #TblOrtalama
				DROP TABLE IF EXISTS #DERSS

			
			
					SELECT DERSAD INTO #DERSS from eokul_v2.dbo.Ders DA
					WHERE ID_DERS IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'
				
			
							SELECT	DISTINCT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD
						   ,O.ID_SUBE,SU.AD SUBEAD,SO.PUAN AS PUAN,SOO.PUAN AS SPUAN										
						   ,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM ,SOO.SORUNO
					
							INTO	#TEMP_SINIF
							FROM	UniteTaramaSinav		S	WITH (NOLOCK)
							JOIN	UniteTaramaSoru			SOO	WITH (NOLOCK)	ON	SOO.ID_UNITETARAMASINAV         = S.ID_UNITETARAMASINAV
							JOIN	UniteTaramaOgrenci		SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASORU			= SOO.ID_UNITETARAMASORU
							JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
							JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
							JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
							JOIN	v3SubeGrupSinifTum		GS	WITH (NOLOCK)	ON	GS.ID_SINIF						= SN.ID_SINIF
							JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SOO.ID_DERS			
							JOIN	#DERSS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD			
							left JOIN	v3SinavDersUnite	U	WITH (NOLOCK)	ON	U.KOD						    = SOO.KAZANIMKOD
							WHERE	S.AKTIF			=	1 		
								AND GS.ID_KADEME3	=	@ID_KADEME3				
								AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')		
							
								AND (S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	
								--IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
					--SELECT * FROM #TEMP_SINIF   	
					DROP TABLE IF EXISTS #SINIF_DYB
					SELECT KOD, KAZANIM, ID_SINIF, SINIFAD, ID_DERS, DERSAD, ID_UNITETARAMASINAV, SINAVAD, SUBEAD, ID_SUBE,COUNT(TCKIMLIKNO) DURUMSAYISI,SUM(PUAN) AS P,SPUAN,				
					CAST(SUM(PUAN) AS FLOAT) / CAST(COUNT(TCKIMLIKNO)AS FLOAT)/CAST(SPUAN AS FLOAT)*CAST(100 AS FLOAT) AS PUAN,0 OGRSAY, SORUNO
					--CAST((SUM(PUAN)/COUNT(DISTINCT(TCKIMLIKNO)))AS FLOAT)/SPUAN*100 AS PUAN, 0 OGRSAY, SORUNO


			
					INTO #SINIF_DYB
					FROM #TEMP_SINIF T
					GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,SUBEAD,ID_SUBE,SORUNO,SPUAN

					UPDATE	S 
					SET		S.OGRSAY=G.OGRSAY
					FROM	#SINIF_DYB	S
					JOIN    (SELECT SORUNO,ID_SINIF,ID_DERS,SUM(DURUMSAYISI) OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO,ID_SINIF, ID_DERS) AS G	ON G.ID_SINIF=S.ID_SINIF  AND S.ID_DERS = G.ID_DERS
			    
					--select * from #SINIF_DYB
						
					SELECT *, CAST(	(	SELECT PUAN
										FROM #SINIF_DYB G 
									WHERE	
											G.PUAN		= S.PUAN 
										AND G.ID_SINIF	= S.ID_SINIF 
										AND G.KOD		= S.KOD 
										AND G.SORUNO	= S.SORUNO 									
								) AS DECIMAL(8,2)) AS YUZDE
					INTO #SINIF
					FROM #SINIF_DYB S
					ORDER BY SORUNO
			
		   
							SELECT ID_SINIF, ID_SUBE ,COUNT(DISTINCT TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
							INTO #OGRSAY
							FROM #TEMP_SINIF
							GROUP BY ID_SINIF,  SUBEAD, SINIFAD, ID_SUBE			
							Select distinct ID_SINIF,SINIFAD, ID_SUBE,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 
		
							Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
							from 
							( Select DISTINCT ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
							ORDER BY SUBEAD,SINIFAD
				
							Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
							from 
							( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
							ORDER BY SUBEAD,COL DESC,SINIFAD

							Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
							from 
							( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
							ORDER BY SUBEAD,COL DESC,SINIFAD
								
			
			
					Set @SQL='	
					Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO,ID_UNITETARAMASINAV,SINAVAD
						,'+@Columns2+' 
					into ##TblSinif
					from (
						Select  *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF 
						UNION ALL 
						Select *,SUBEAD COL from #SINIF  
					) AS S
					PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
					GROUP BY  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO,ID_UNITETARAMASINAV,SINAVAD
					ORDER BY DERSAD
					INSERT INTO ##TblSinif
					SELECT '''',ID_DERS,DERSAD,''SINIF ORTALAMASI'',0,ID_UNITETARAMASINAV,SINAVAD
							, '+@Columns3+'
					FROM ##TblSinif
					GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_DERS,DERSAD
					ORDER BY DERSAD
				'
			
				PRINT @SQL						
				EXEC (@SQL)
			
					SELECT  ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
					INTO #TblOrtalama
					FROM #SINIF				
					GROUP BY ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD
				
					
				UNION ALL				
					SELECT  ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,0 ID_SUBE,'' SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
					FROM #SINIF				
					GROUP BY ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD
					ORDER BY DERSAD			
				--SELECT * FROM ##TblSinif 
				If (OBJECT_ID('tempdb..##TblSinif ') Is Null)			
				BEGIN
			
					SELECT KOD = NULL,ID_DERS= NULL,DERSAD= NULL,KAZANIM= NULL,SORUNO= NULL,ID_UNITETARAMASINAV= NULL,PUAN=NULL,SINAVAD= NULL INTO  ##TblSinif 
					DELETE FROM ##TblSinif 
				END
				BEGIN
					IF @ISLEM = 34  -- DEVEXPRESS
					BEGIN
				
						Select ID_SINIF, SINIFAD, SUBEAD, COL 
						from #k 
						ORDER BY SUBEAD, SINIFAD

						SELECT * FROM ##TblSinif 

						SELECT DISTINCT ID_SINIF,ID_SUBE,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF,OGRSAY

				
						SELECT ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, YUZDE
						FROM #TblOrtalama
						ORDER BY SUBEAD,DERSAD

					END
					ELSE
					BEGIN
						select(
							select * from(
								select 
								(					
									Select ID_SINIF, SINIFAD, SUBEAD, COL 
									from #k 
									ORDER BY SUBEAD, SINIFAD
									FOR JSON AUTO,INCLUDE_NULL_VALUES
								) as TblSinifListesi,					
								(					
									SELECT * FROM ##TblSinif  order by DERSAD,SORUNO 
									FOR JSON AUTO
								) as TblVeri,
								(					
									SELECT DISTINCT ID_SINIF,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF,OGRSAY
									FOR JSON AUTO
								) as TblOgrSay,
								(	
									SELECT ID_DERS,DERSAD,ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD, YUZDE
									FROM #TblOrtalama
									ORDER BY SUBEAD,DERSAD
									FOR JSON AUTO
								) as TblOrtalama
							) as tablo FOR JSON AUTO
						) as tt				 
					END
				END

			

				DROP TABLE IF EXISTS #k
				DROP TABLE IF EXISTS #TEMP_SINIF
				DROP TABLE IF EXISTS #SINIF
				DROP TABLE IF EXISTS #SINIF_DYB
				DROP TABLE IF EXISTS ##TblSinif
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #TblOrtalama
				DROP TABLE IF EXISTS #DERSSSS



			END
			END
		END
		--COMMIT TRANSACTION [Tran1]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [Tran1]
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_UniteTaramaSinifPuanOrtalamalari]...';


GO
ALTER procedure [dbo].[sp_UniteTaramaSinifPuanOrtalamalari]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@IL						VARCHAR(36)		= NULL,
	@ILCE					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@DONEM					char(4)			= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINAVTURU			INT				= NULL,
	@ID_SINAV				INT				= NULL,
	@ID_UNITETARAMASINAV	INT				= NULL,
	@ID_DERS				INT				= NULL,
	@ID_SUBE				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@DOSYAADI				varchar(100)	= NULL,
	@DOSYAGUID				varchar(50)		= NULL,
	@ID_SINAVDOSYA			int				= NULL,
	@SQLJSON				NVARCHAR(MAX)	= NULL,
	@ID_SUBEs				VARCHAR(MAX)	= NULL,
	@ID_SINAVs				VARCHAR(MAX)	= NULL,
	@ID_SINIFs				VARCHAR(MAX)	= NULL,
	@ID_DERSs				VARCHAR(MAX)	= NULL,
	@PUAN					int				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,TC_OGRENCI					= @TC_OGRENCI			
			,OTURUM						= @OTURUM				
			,IL							= @IL					
			,ILCE						= @ILCE				
			,ID_MENU					= @ID_MENU			
			,DONEM						= @DONEM				
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,ID_SINAV					= @ID_SINAV			
			,ID_UNITETARAMASINAV		= @ID_UNITETARAMASINAV
			,ID_DERS					= @ID_DERS			
			,ID_SUBE					= @ID_SUBE			
			,ID_SINIF					= @ID_SINIF			
			,DOSYAADI					= @DOSYAADI			
			,DOSYAGUID					= @DOSYAGUID			
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA		
			,SQLJSON					= @SQLJSON			
			,ID_SUBEs					= @ID_SUBEs			
			,ID_SINAVs					= @ID_SINAVs			
			,ID_SINIFs					= @ID_SINIFs			
			,ID_DERSs					= @ID_DERSs			
			,PUAN						= @PUAN		        
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='32051057542',@OTURUM='10F4322D-70ED-4AB6-B4C6-0ECC61118DFC',@DONEM='2017',@ID_SINAVTURU=8,@ID_KADEME3=15,@ID_SINAVs='[243,330,286]',@ID_SUBEs='[427,11]',@ID_SINIFS='[107210,107209,108612,107251]',@ID_DERSs='[0,147,150,152,873,962,1119]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
	
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
				
		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11


		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null

		------------------------------------------ DERS NET
		BEGIN
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
				--CAST((SUM(UO.PUAN)/COUNT(DISTINCT(UO.TCKIMLIKNO))/SO.PUAN )AS FLOAT) AS PUAN
				--CONVERT(float, 14.85);
		SELECT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD ,
		--CAST((SUM(UO.PUAN)/COUNT(DISTINCT(UO.TCKIMLIKNO)))AS FLOAT) AS PUAN
		CAST(SUM(UO.PUAN) AS NUMERIC(10,4)) / CAST(COUNT(DISTINCT(UO.TCKIMLIKNO))AS NUMERIC(10,4)) AS PUAN
		--,
				,O.ID_SUBE,SU.AD SUBEAD
		INTO	#Temp
		FROM	UniteTaramaSinav		S	WITH (NOLOCK)
		JOIN	UniteTaramaSoru			SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASINAV= S.ID_UNITETARAMASINAV
		JOIN    UniteTaramaOgrenci      UO  WITH (NOLOCK)	ON  UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= UO.TCKIMLIKNO 
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
	   
		JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SO.ID_DERS
		--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_DERS		= VD.ID_DERS	
		WHERE	
		        --S.DURUM			= 2
			 S.AKTIF			= 1
			 AND UO.AKTIF=1
			--AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND S.ID_UNITETARAMASINAV=@ID_UNITETARAMASINAV	
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			GROUP BY S.ID_UNITETARAMASINAV,S.AD,O.ID_SINIF, SN.AD,VD.ID_DERS,VD.DERSAD,O.ID_SUBE,SU.AD
		--SELECT * FROM #Temp
	 
			SELECT ID_UNITETARAMASINAV,SINAVAD,ID_DERS,DERSAD,(SUM(PUAN)/COUNT(1)) TS, CAST(AVG(PUAN) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			INTO #Net
			FROM #Temp	T
			GROUP BY ID_DERS,ID_UNITETARAMASINAV,SINAVAD,DERSAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD

		--Select * from #Net
			
		--UNION ALL 
		--	SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		--	FROM #Temp	T
		--	GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			
			INSERT INTO #Net			
			SELECT ID_UNITETARAMASINAV,SINAVAD,0,'TOPLAM',(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			FROM #Net	T
			GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		
			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp  ) as b 
			--order by b.SINAVTARIH

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp  ) as b 
			--order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp  ) as b 
			--order by b.SINAVTARIH
				
			
			--Select  SINAVAD, ID_SINAV, SINAVTARIH, ID_DERS, ID_SUBE, SUBEAD, DERSAD, NET into ##pivots from #Net
			--DELETE FROM ##pivots
			--SELECT TOP 1 ID_DERS,DERSAD INTO ##GenelOrt FROM #Net
			--DELETE FROM ##GenelOrt

		

			if not exists (select * from #Net)
			begin
				Select 				
					ID_DERS=null,
					ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					DERSAD=null
				into ##pivots

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt
			end

		

		Set @SQL='	
			
			Select
				ID_DERS,
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				DERSAD,
				999 BOLUMNO,
				'+@Columns2+' 
			into ##pivots
			from (
				Select 
					SINAVAD,
					ID_UNITETARAMASINAV,
					
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					DERSAD,
					-- TS,
					NET
				from #Net
			) AS S
			PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY DERSAD,SUBEAD,ID_SUBE,ID_DERS,ID_SINIF,SINIFAD	
				
			SELECT ID_DERS,DERSAD,999 BOLUMNO,'+@Columns3+'
			INTO ##GenelOrt
			FROM ##pivots 
			GROUP BY ID_DERS,DERSAD		
		'
		PRINT @SQL
		EXEC (@SQL)
		
		SELECT * 
		INTO #PIVOTS
		FROM ##pivots 
		DROP TABLE IF EXISTS ##pivots
		
		SELECT * 
		INTO #GENELORT
		FROM ##GenelOrt 		
		DROP TABLE IF EXISTS ##GenelOrt


		--BEGIN

		--	SELECT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,VD.ID_DERS,VD.DERSAD DERSAD,UO.PUAN,UO.TCKIMLIKNO
		--	INTO	#Temp11
		--	FROM	UniteTaramaSinav					S	WITH (NOLOCK)
		--	JOIN	UniteTaramaSoru			SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASINAV= S.ID_UNITETARAMASINAV	
		--	JOIN    UniteTaramaOgrenci      UO  WITH (NOLOCK)	ON  UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
		--	--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		--	--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
		--	JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SO.ID_DERS
		--	WHERE	
		--	--S.DURUM			= 2
		--		S.AKTIF			= 1
		--		--AND (OZEL=0 OR @OZELSINAVGOR=1)
		--		AND S.ID_UNITETARAMASINAV=@ID_UNITETARAMASINAV

		--	SELECT SINAVAD,DERSAD,CAST(AVG(PUAN) AS decimal(8,2)) AS ORT INTO #ORT  FROM #Temp11 
		--	GROUP BY DERSAD,SINAVAD
		--INSERT INTO #ORT
		--	SELECT SINAVAD,'TOPLAM',CAST(SUM(PUAN)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS ORT  FROM #Temp11
		--	GROUP BY SINAVAD
			

		--	SELECT value SINAVAD INTO #COL FROM string_split(@Columns,',')
		--	WHILE EXISTS (SELECT * FROM #COL)
		--	BEGIN
		--		DECLARE @COL VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL ORDER BY 1 DESC)
		--	SET @SQL = N'
		--			UPDATE P
		--			SET	P.'+@COL+' = O.ORT
		--			FROM #GENELORT P
		--			JOIN #ORT	O ON O.DERSAD = P.DERSAD AND ''[''+ O.SINAVAD +'']'' = '''+@COL+'''
		--		'
		--		PRINT @SQL
		--		EXEC (@SQL)
		--		DELETE FROM #COL WHERE SINAVAD = (SELECT TOP 1 SINAVAD FROM #COL ORDER BY 1 DESC)
		--	END
		--END
		
		--DECLARE @ID_EGITIMTURU VARCHAR(15)=
		--CASE @ID_SINAVTURU 
		--								WHEN  0 THEN 6 
		--								WHEN  2 THEN 7 
		--								WHEN  3 THEN 8 
		--								WHEN  6 THEN 9 
		--								WHEN  5 THEN 10
		--								--YENENLEEKLENEİ 
		--								WHEN  8  THEN 11
		--								WHEN  9 THEN 12
		--								WHEN  7 THEN 13
		--								WHEN  10 THEN 14
										
		--								END

		--	CASE  WHEN @ID_SINAVTURU = 2 THEN 7
		--		  WHEN @ID_SINAVTURU = 3 THEN 8
		--		  WHEN @ID_SINAVTURU = 6 THEN 9
		--		  ELSE @ID_SINAVTURU 
		--		  END 

	
	
			
		SELECT DISTINCT T.ID_UNITETARAMASINAV,T.SINAVAD
		INTO #SinavList
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value
		
	
		--DECLARE @ILK_ID_SINAV INT=(SELECT TOP 1 VALUE FROM OPENJSON(@ID_UNITETARAMASINAV) WHERE VALUE > 0)
	
	

		SELECT		DISTINCT SS.TAKMAAD , SS.TAKMAAD AS DERSAD,SS.BOLUMNO	BOLUM	
		INTO #BOLUMLER		
		FROM		#PIVOTS				G
		JOIN		UniteTaramaSinav				S	ON	S.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV
		JOIN		UniteTaramaSoru			SD	ON	SD.ID_UNITETARAMASINAV	= S.ID_UNITETARAMASINAV 
		JOIN		eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= SD.ID_DERS
		JOIN		SinavDers			SS	ON	SS.ID_DERS	= D.ID_DERS
		ORDER BY BOLUM

		INSERT INTO #BOLUMLER (TAKMAAD,DERSAD,BOLUM)
		SELECT DISTINCT DERSAD,DERSAD,(SELECT MAX(BOLUM) FROM #BOLUMLER)+ ROW_NUMBER() OVER(ORDER BY DERSAD ASC) FROM #PIVOTS  P
	--	WHERE DERSAD !='TOPLAM' AND  DERSAD NOT IN (SELECT DERSAD FROM #BOLUMLER )
		
		


		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS	G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		
		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD
		
		SELECT  distinct P.*,  isnull(K.AD+' '+K.SOYAD,'') ADSOYAD 
		INTO #T1
		FROM #PIVOTS p		
		JOIN eokul_v2.DBO.Ders				D	ON	D.ID_DERS = P.ID_DERS
		--JOIN eokul_v2.DBO.Ders				D2	ON	D2.DERSAD = D.DERSAD
												--AND D2.ID_KADEME3 = D.ID_KADEME3
												AND D.AKTIF = 1
		--left JOIN eokul_v2.DBO.dersOgretmen do	on	do.ID_SINIF=p.ID_SINIF 
												--AND DO.ID_DERS=D2.ID_DERS 
		  left join		[OkyanusDB].[dbo].[v3DersProgram] do on do.ID_SINIF=P.ID_SINIF
		  And do.ID_DERS=d.ID_DERS
		  left JOIN v3Kullanici	K	ON	K.TCKIMLIKNO=DO.TCKIMLIKNO
		
		ORDER BY ID_DERS DESC
		
		--select * from #PIVOTS
		
		
		END
		------------------------------------------ PUAN
		BEGIN

		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
		SELECT	S.ID_UNITETARAMASINAV,S.AD SINAVAD,UO.TCKIMLIKNO
				,SN.ID_SINIF,SN.AD SINIFAD
				,O.ID_SUBE,SU.AD SUBEAD
				--,PT.ID_SINAVPUANTURU,PT.AD PUANTURU
				,UO.PUAN
		INTO	#Temp2
		FROM	UniteTaramaSinav					S	WITH (NOLOCK)
		JOIN	UniteTaramaSoru			SO	WITH (NOLOCK)	ON	SO.ID_UNITETARAMASINAV= S.ID_UNITETARAMASINAV
		JOIN    UniteTaramaOgrenci      UO  WITH (NOLOCK)	ON  UO.ID_UNITETARAMASORU=SO.ID_UNITETARAMASORU
		--JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		--JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
		--													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
		--JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= UO.TCKIMLIKNO
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		WHERE	--S.DURUM			= 2
			 S.AKTIF			= 1
			  AND UO.AKTIF=1
			--AND (OZEL=0 OR @OZELSINAVGOR=1)
			 --S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_UNITETARAMASINAV))
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			--AND PT.ID_SINAVTURU	= @ID_SINAVTURU
			--AND S.ID_KADEME3	= @ID_KADEME3
			AND S.ID_UNITETARAMASINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND S.ID_UNITETARAMASINAV=@ID_UNITETARAMASINAV	
		--SELECT * FROM #Temp
		
			
			
		SELECT ID_UNITETARAMASINAV,SINAVAD,CAST(AVG(PUAN) AS DECIMAL(8,2)) PUAN ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		INTO #Net2
		FROM #Temp2	T
		GROUP BY ID_UNITETARAMASINAV,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD


		SET @SQL 	  =NULL
		SET @Columns  =NULL
		SET @Columns2 =NULL
		SET @Columns3 =NULL

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp2  ) as b 
			--order by b.SINAVTARIH

		--Select @Columns2=Coalesce(@Columns2+',','')+'MAX(CAST(ISNULL(CAST('+QUOTENAME(SINAVAD)+' AS VARCHAR),''-'') AS VARCHAR)) AS ' +QUOTENAME(SINAVAD) from (
			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp2  ) as b 
			--order by b.SINAVTARIH
				
				
			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_UNITETARAMASINAV from #Temp2  ) as b 
			--order by b.SINAVTARIH

			

			if not exists (select * from #Net2)
			begin
				Select 				
				ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					ID_SINAVPUANTURU=null,
					PUANTURU=null
				into ##pivots2

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt2
			end
			
		
		Set @SQL='	
			
			Select 				
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				
				
				'+@Columns2+' 
			into ##pivots2
			from (
				Select 
					SINAVAD,
					ID_UNITETARAMASINAV,
					
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					
					-- TS,
					PUAN
				from #Net2
			) AS S
			PIVOT (MAX(PUAN) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY SUBEAD,ID_SUBE,ID_SINIF,SINIFAD

	
			SELECT '+@Columns3+'
			INTO ##GenelOrt2
			FROM ##pivots2 
			
		'
		PRINT @SQL
		EXEC (@SQL)

		SELECT * 
		INTO #PIVOTS2
		FROM ##pivots2 
		DROP TABLE ##pivots2
		
		SELECT * 
		INTO #GENELORT2
		FROM ##GenelOrt2 		
		DROP TABLE ##GenelOrt2




		SELECT DISTINCT T.ID_UNITETARAMASINAV,T.SINAVAD
		INTO #SinavList2
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp2 T ON '['+T.SINAVAD+']'=FN.Value
		--SELECT DISTINCT ID_SUBE,SUBEAD FROM #Temp2
		--SELECT DISTINCT ID_SINAVPUANTURU,PUANTURU FROM #Temp2

		
		END
		------------------------------------------ JSON SEND
		
		 select(
				select * from(
						select 
						(					
							SELECT		*
							FROM		#T1 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							--	AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							ORDER BY	BOLUMNO 
							FOR JSON AUTO
						) as t1,
						
						(					
							SELECT ID_UNITETARAMASINAV,SINAVAD FROM #SinavList
							ORDER BY SINAVAD
							FOR JSON AUTO
						) as t2,
						(					
							SELECT		*
							FROM		#PIVOTS2 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							--	AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							--ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t3,
						(					
							SELECT ID_UNITETARAMASINAV,SINAVAD FROM #SinavList2
							--ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t4,

						(					
							SELECT		*
							FROM		#GENELORT 
							--ORDER BY	ID_DERS DESC
							FOR JSON AUTO
						) as t5,
						(					
							SELECT		*
							FROM		#GENELORT2
							--ORDER BY	ID_SINAVPUANTURU DESC
							FOR JSON AUTO
						) as t6
						
												
					) as tablo FOR JSON AUTO
				) as tt

				--select * from #GENELORT
				--Select * from  #T1

		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_UpgradeSoru]...';


GO
ALTER procedure [dbo].[sp_UpgradeSoru]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@ID_TKTYASARALIGI			INT				= NULL,
	@ID_TKTKATEGORI				INT				= NULL,
	@ID_TKTPUAN					INT				= NULL,
	@ID_TKTSORU					INT				= NULL,
	@YASAY						TINYINT			= NULL,
	@ID_SUBE					INT				= NULL,
	@ID_SINAVGRUP				TINYINT			= NULL,
	@ID_SINIF					INT				= NULL,
	@TCKIMLIKNO_OGR				VARCHAR(11)		= NULL,
	@ID_TKTSINAV				INT				= NULL,
	@ID_TKTSINAVORTALAMALIST	VARCHAR(MAX)	= NULL,
	@ID_TKTTEST					INT				= NULL,
	@ID_TKTDONEM				INT				= NULL,
	@ID_TKTDONEMS				NVARCHAR(MAX)	= NULL,
	@ID_SINIFS					NVARCHAR(MAX)	= '[]',
	@ID_SATISTURU				INT				= NULL,
	@SQLJSON					NVARCHAR(MAX)	= NULL,	
	@DONEM						VARCHAR(4)		= NULL,
	@TARIH						VARCHAR(MAX)	= NULL,
	@HESAPTURU					BIT				= NULL,
	@BASLANGIC					VARCHAR(MAX)	= NULL,
	@BITIS						VARCHAR(MAX)	= NULL,
	@HESAPTURUSORU				BIT				= NULL,
	@KAZANIMADEDI				INT				= NULL,
	@ID_SUBES					VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUPS				VARCHAR(MAX)	= NULL,
	@TUR                        VARCHAR(20)     =NULL,
    @SAYI					    int				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM								= @ISLEM					
			,TCKIMLIKNO							= @TCKIMLIKNO				
			,OTURUM								= @OTURUM					
			,ID_MENU							= @ID_MENU				
			,ID_TKTYASARALIGI					= @ID_TKTYASARALIGI		
			,ID_TKTKATEGORI						= @ID_TKTKATEGORI			
			,ID_TKTPUAN							= @ID_TKTPUAN				
			,ID_TKTSORU							= @ID_TKTSORU				
			,YASAY								= @YASAY					
			,ID_SUBE							= @ID_SUBE				
			,ID_SINAVGRUP						= @ID_SINAVGRUP			
			,ID_SINIF							= @ID_SINIF				
			,TCKIMLIKNO_OGR						= @TCKIMLIKNO_OGR			
			,ID_TKTSINAV						= @ID_TKTSINAV			
			,ID_TKTSINAVORTALAMALIST			= @ID_TKTSINAVORTALAMALIST
			,ID_TKTTEST							= @ID_TKTTEST				
			,ID_TKTDONEM						= @ID_TKTDONEM			
			,ID_TKTDONEMS						= @ID_TKTDONEMS			
			,ID_SINIFS							= @ID_SINIFS				
			,ID_SATISTURU						= @ID_SATISTURU			
			,SQLJSON							= @SQLJSON				
			,DONEM								= @DONEM					
			,TARIH								= @TARIH					
			,HESAPTURU							= @HESAPTURU				
			,BASLANGIC							= @BASLANGIC				
			,BITIS								= @BITIS					
			,HESAPTURUSORU						= @HESAPTURUSORU			
			,KAZANIMADEDI						= @KAZANIMADEDI			
			,ID_SUBES							= @ID_SUBES				
			,ID_SINAVGRUPS						= @ID_SINAVGRUPS			
			,TUR								= @TUR                    
			,SAYI								= @SAYI					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		DECLARE @ID_ST			INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	Yaş Aralığı Listele
			BEGIN
				SELECT ID_TKTYASARALIGI, YASAY1, YASAY2
				FROM UpgradeYasAraligi
				WHERE AKTIF=1
			END

			IF @ISLEM = 2	--	Kategori Listele (Puan Tablosunda Yaş Aralığı Bulunan Kategoriler)
			BEGIN
				SELECT ID_TKTKATEGORI, AD FROM [dbo].[UpgradeKategori]
			END

			IF @ISLEM = 3	--	Puan Aralığı Listele (Puan Tablosunda Yaş Aralığı ve Kategoriye Göre)
			BEGIN
				SELECT ID_TKTPUAN, HARF,
					   SEVIYE = (CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END)
				FROM UpgradePuanTek
				WHERE (@ID_TKTKATEGORI IS NULL OR ID_TKTKATEGORI = @ID_TKTKATEGORI)
				ORDER BY HARF
			END

			IF @ISLEM = 4	--	Soru Ekle
			BEGIN
				IF NOT EXISTS (SELECT Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null))
				BEGIN
					RAISERROR ('Dönem seçimi zorunludur!' , -- Message text.
						16, -- Severity.
						1 -- State.
						);
				END
				ELSE
				BEGIN
					INSERT INTO UpgradeSoru(ID_TKTPUAN, KYE_KULLANICI, ID_SATISTURU, KAZANIMADEDI) VALUES(@ID_TKTPUAN, @TCKIMLIKNO, @ID_SATISTURU, @KAZANIMADEDI)
					SET @ID_TKTSORU=@@IDENTITY

					INSERT INTO UPGRADESORUDONEM (ID_TKTSORU,ID_TKTDONEM)
					((SELECT @ID_TKTSORU,Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null) ) )
						
					SELECT @ID_TKTSORU
				END
			END

			IF @ISLEM = 5	--	Soru Listele
			BEGIN
					SELECT	DISTINCT
							 S.[ID_TKTSORU]
							,S.[ID_TKTPUAN]
							,S.[ID_TKTKATEGORI]
							,S.[KATEGORIAD]
							,S.[ID_SATISTURU]
							,S.[HARF]
							,(CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END) as SEVIYE
							,(SELECT CASE WHEN GRUP='Ü.Z İLKOKUL' THEN ACIKLAMA+ ' (ÜSTÜN)' ELSE ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru WHERE ID_SATISTURU=S.ID_SATISTURU) as GRUP
							,S.[DOSYAAD]
							,S.[DOSYAUZANTI]
							,S.[KYE_KULLANICI]
							,S.[KYE_TARIH]
							,S.[KAZANIMADEDI]
							,STUFF((SELECT ',' + DONEM 
								FROM [vw_UpgradeSoru]
								where [ID_TKTSORU]=S.[ID_TKTSORU] and [ID_SATISTURU]=S.[ID_SATISTURU]
								FOR XML PATH('')) ,1,1,'') as DONEM
					FROM [vw_UpgradeSoru]	S
					WHERE	(@ID_TKTKATEGORI IS NULL	OR @ID_TKTKATEGORI = 0		OR ID_TKTKATEGORI=@ID_TKTKATEGORI) AND
							(@ID_SATISTURU IS NULL		OR @ID_SATISTURU = 0		OR ID_SATISTURU=@ID_SATISTURU) AND
							(@ID_TKTPUAN IS NULL		OR @ID_TKTPUAN = 0			OR ID_TKTPUAN=@ID_TKTPUAN) AND
							(@HESAPTURU = 0 
							OR @BASLANGIC IS NULL 
							OR @BITIS IS NULL 
							OR (
								CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
								AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)))
					GROUP BY S.[ID_TKTSORU]
							,S.[ID_TKTPUAN]
							,S.[ID_TKTKATEGORI]
							,S.[KATEGORIAD]
							,S.[ID_SATISTURU]
							,S.[HARF]
							,S.[DOSYAAD]
							,S.[DOSYAUZANTI]
							,S.[KYE_KULLANICI]
							,S.[KYE_TARIH]
							,S.DONEM 
							,S.[KAZANIMADEDI]
  	
			END

			IF @ISLEM = 6	--	Soru Sil
			BEGIN
				BEGIN TRY
					DELETE FROM UpgradeSoruDonem WHERE ID_TKTSORU=@ID_TKTSORU
					DELETE FROM UpgradeSoru WHERE ID_TKTSORU=@ID_TKTSORU
					DECLARE @ID_DOKUMANTEMP INT = (SELECT ID_DOKUMAN FROM DokumanDetay WHERE ID = @ID_TKTSORU)	
					DELETE DD 
					FROM DokumanDetay DD
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE DD.ID = @ID_TKTSORU AND D.ID_DOKUMANTUR=1
					DELETE FROM Dokuman WHERE ID_DOKUMAN = @ID_DOKUMANTEMP AND ID_DOKUMANTUR=1
				END TRY
				BEGIN CATCH
					SELECT 
						@ErrorSeverity	= ERROR_SEVERITY(),
						@ErrorState		= ERROR_STATE()
			
					RAISERROR ('Bu soru öğrenci sınavlarında kullanıldığı için silinemedi.' , -- Message text.
								@ErrorSeverity, -- Severity.
								@ErrorState -- State.
								);
				END CATCH;
			END

			IF @ISLEM = 7	--	Sınav Listele
			BEGIN
				SELECT ID_TKTSINAV, SINAVAD FROM UpgradeSinav WHERE ID_TKTSINAV < @ID_TKTSINAV OR @ID_TKTSINAV IS NULL ORDER BY ID_TKTSINAV ASC
			END

			IF @ISLEM = 8	--	Öğrenci Kategori ve Puan Listele (Puan Girişi Modal)
			BEGIN

				SELECT DISTINCT 
					P.ID_TKTKATEGORI, 
					P.AD,
					PUAN = ISNULL((SELECT PUAN FROM UpgradeOgrenciPuanDetay WHERE ID_TKTKATEGORI=P.ID_TKTKATEGORI AND ID_TKTOGRENCIPUAN=(SELECT ID_TKTOGRENCIPUAN FROM UpgradeOgrenciPuan WHERE TCKIMLIKNO=@TCKIMLIKNO_OGR AND ID_TKTSINAV=@ID_TKTSINAV)),0)
				FROM vw_UpgradePuan P
				WHERE
					 --P.ID_SINAVGRUP=@ID_SINAVGRUP AND 
					  --(@YASYIL BETWEEN P.YASYIL1 AND P.YASYIL2) AND
					  (@YASAY BETWEEN P.YASAY1 AND P.YASAY2)  
				ORDER BY P.ID_TKTKATEGORI ASC

			END

			IF @ISLEM = 9	--	Puan Kaydet
			BEGIN

				--Daha Önce Tanımlandıysa ID Hafızaya Al
				DECLARE @ID_TKTOGRENCIPUAN INT
				SELECT @ID_TKTOGRENCIPUAN=ID_TKTOGRENCIPUAN FROM UpgradeOgrenciPuan WHERE TCKIMLIKNO=@TCKIMLIKNO_OGR AND ID_TKTSINAV=@ID_TKTSINAV
			
				--Önce Sil
				DELETE FROM UpgradeOgrenciPuanDetay WHERE ID_TKTOGRENCIPUAN=@ID_TKTOGRENCIPUAN
				DELETE FROM UpgradeOgrenciPuan WHERE ID_TKTOGRENCIPUAN=@ID_TKTOGRENCIPUAN
			
				--Sonra Ekle
				INSERT INTO UpgradeOgrenciPuan (ID_TKTSINAV, TCKIMLIKNO, KYE_KULLANICI, KYE_TARIH)
				VALUES (@ID_TKTSINAV, @TCKIMLIKNO_OGR, @TCKIMLIKNO, GETDATE())

				SET @ID_TKTOGRENCIPUAN = @@IDENTITY				
				INSERT INTO UpgradeOgrenciPuanDetay (ID_TKTOGRENCIPUAN, ID_TKTKATEGORI, PUAN)
				SELECT @ID_TKTOGRENCIPUAN, ID_TKTKATEGORI, PUAN FROM OPENJSON (@SQLJSON, '$.KATEGORIPUAN_LISTESI')
				WITH  (ID_TKTKATEGORI INT, PUAN int ) 

			END

			IF @ISLEM = 10	--	Tkt Öğrenci Karne Getir
			BEGIN	
				SELECT DISTINCT O.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, SU.AD AS SUBEAD, SAT.ID_SATISTURU, SGS.ID_KADEME3
				INTO #TMP_OGRENCIBILGI
				FROM	   [dbo].[v3OgrenciTum]			O
				INNER JOIN [dbo].[v3Satislar]			SAT	ON SAT.ID_SOZLESME = O.ID_SOZLESME AND SAT.ID_SINIF IS NOT NULL
				INNER JOIN [dbo].[v3SubeGrupSinifTum]	SGS	ON SGS.ID_SINIF = SAT.ID_SINIF
				INNER JOIN [dbo].[v3SatisTuru]			ST	ON ST.ID_SATISTURU = SAT.ID_SATISTURU
				INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.TCKIMLIKNO = O.TCKIMLIKNO AND SY.XBASE=1
				INNER JOIN [dbo].[v3Kullanici]			K	ON k.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN [dbo].[v3Sube]				SU	ON SU.ID_SUBE = SY.ID_SUBE
				WHERE 
					(@TCKIMLIKNO_OGR IS NULL OR @TCKIMLIKNO_OGR = '0' OR O.TCKIMLIKNO = @TCKIMLIKNO_OGR) 
				AND	(@ID_SINIFS IS NULL OR @ID_SINIFS = '[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFS)))
				AND	(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP = 0 OR ST.ID_KADEME3 = @ID_SINAVGRUP) 
				AND (@ID_SUBE IS NULL OR @ID_SUBE = 0 OR O.ID_SUBE = @ID_SUBE) 
				AND O.DONEM = @DONEM
				ORDER BY O.TCKIMLIKNO 
								
				SELECT os.TCKIMLIKNO, OB.ID_KADEME3, s.ID_TKTTEST, s.ID_KATEGORI, (CASE WHEN @HESAPTURU = 1 THEN CAST(@TARIH AS DATE) ELSE os.SINAVTARIH END) AS SINAV_TARIH, CASE WHEN OB.ID_KADEME3 <> 4 AND OB.ID_KADEME3 <> 5 THEN SUM(CASE WHEN s.ID_TKTTEST = 2 THEN 2 ELSE 1 END) ELSE SUM(1) END AS PUAN
				INTO #TEMP
				FROM dbo.TKTOgrenciCevap AS oc 
				INNER JOIN dbo.TKTSoru AS s ON s.ID_TKTSORU = oc.ID_TKTSORU 
				INNER JOIN TKTOgrenciSinav os ON os.ID_TKTOGRENCISINAV = oc.ID_TKTOGRENCISINAV AND os.ID_TKTTEST = s.ID_TKTTEST
				INNER JOIN #TMP_OGRENCIBILGI OB ON OB.TCKIMLIKNO = os.TCKIMLIKNO
				WHERE (oc.OGRENCICEVAP = 1) AND os.DONEM = @DONEM
				GROUP BY os.TCKIMLIKNO, s.ID_KATEGORI, s.ID_TKTTEST, os.SINAVTARIH, OB.ID_KADEME3

				SELECT ktable.TCKIMLIKNO, ktable.ID_TKTTEST, ktable.ID_KATEGORI, ktable.SINAV_TARIH, ktable.PUAN, se.HARF
				INTO #TEMP2
				FROM #TEMP AS ktable 
				INNER JOIN v3Kullanici AS k ON k.TCKIMLIKNO = ktable.TCKIMLIKNO 
				LEFT JOIN UpgradeYasAraligi AS ya ON ya.YASAY1 <= DATEDIFF(MONTH, k.DOGUMTARIHI, ktable.SINAV_TARIH) - 1 AND ya.YASAY2 >= DATEDIFF(MONTH, k.DOGUMTARIHI, ktable.SINAV_TARIH) - 1 
				INNER JOIN UpgradePuan AS up ON up.ID_TKTKATEGORI = ktable.ID_KATEGORI AND up.ID_KADEME3 = (CASE WHEN ktable.ID_KADEME3 = 4 OR ktable.ID_KADEME3 = 5 THEN ktable.ID_KADEME3 ELSE 0 END) AND ((ktable.ID_KADEME3 = 4 OR ktable.ID_KADEME3 = 5) OR up.ID_TKTYASARALIGI = ya.ID_TKTYASARALIGI) AND up.PUAN1 <= ktable.PUAN AND up.PUAN2 >= ktable.PUAN 
				INNER JOIN TKTSeviye AS se ON se.HARF = up.HARF	

				CREATE TABLE #TOTALRESULTTABLE(ID_TKTSORU INT, TCKIMLIKNO VARCHAR(11), ADSOYAD VARCHAR(200), SUBEAD VARCHAR(200), DOSYAAD VARCHAR(200), DOSYAUZANTI VARCHAR(10), ID_TKTKATEGORI int); 
				DECLARE @TEMPTCKIMLIK VARCHAR(11) 
				--Toplu sınav kağıdıda oluşturulabilmesi için
				WHILE EXISTS(SELECT * FROM #TMP_OGRENCIBILGI)
				BEGIN
					SELECT TOP 1 @TEMPTCKIMLIK = TCKIMLIKNO	From #TMP_OGRENCIBILGI

					--SET @ID_ST = (	
					--						SELECT ST.ID_SATISTURU
					--						FROM OkyanusDB.dbo.v3OgrenciTum O
					--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
					--						WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND O.DONEM = @DONEM
					--					)

					IF EXISTS(	
								--SELECT * FROM UpgradeOgrenciSinav OS
								--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
								--WHERE TCKIMLIKNO=@TEMPTCKIMLIK AND ID_TKTSINAV=@ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
								SELECT * FROM UpgradeOgrenciSinavDonem OSD
								JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
								WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND ID_TKTSINAV = @ID_TKTSINAV AND DONEM = @DONEM
							)
					BEGIN
						--INSERT INTO #TOTALRESULTTABLE 
						--select DISTINCT OS.ID_TKTSORU, OS.TCKIMLIKNO, K.ADSOYAD, K.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI
						--from UpgradeOgrenciSinav OS 
						--WITH (NOLOCK)
						--INNER JOIN #TMP_OGRENCIBILGI K ON K.TCKIMLIKNO=OS.TCKIMLIKNO
						--INNER JOIN vw_UpgradeSoru S	ON S.ID_TKTSORU=OS.ID_TKTSORU 
						--WHERE OS.TCKIMLIKNO=@TEMPTCKIMLIK AND OS.ID_TKTSINAV=@ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST

						INSERT INTO #TOTALRESULTTABLE 
						SELECT DISTINCT OSDS.ID_TKTSORU, OSD.TCKIMLIKNO, K.ADSOYAD, K.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI
						FROM UpgradeOgrenciSinavDonem OSD 
						INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
						INNER JOIN #TMP_OGRENCIBILGI K ON K.TCKIMLIKNO = OSD.TCKIMLIKNO
						INNER JOIN vw_UpgradeSoru S	ON S.ID_TKTSORU = OSDS.ID_TKTSORU 
						WHERE OSD.TCKIMLIKNO = @TEMPTCKIMLIK AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					END
					ELSE
					BEGIN
						SELECT S.ID_TKTSORU, O.TCKIMLIKNO, O.ADSOYAD, O.SUBEAD, S.DOSYAAD, S.DOSYAUZANTI, S.ID_TKTKATEGORI, ID_TKTSINAV = @ID_TKTSINAV, S.AY 
						INTO #TMP_TKTOGRENCISINAV
						FROM vw_UpgradeSoru S
						INNER JOIN #TEMP2						OKP	ON OKP.ID_KATEGORI = S.ID_TKTKATEGORI
						INNER JOIN #TMP_OGRENCIBILGI			O	ON O.TCKIMLIKNO = OKP.TCKIMLIKNO 
						WHERE
						((@ID_TKTTEST < 4  AND OKP.ID_TKTTEST = @ID_TKTTEST) OR (@ID_TKTTEST = 4 AND OKP.ID_TKTTEST = (SELECT MAX(ID_TKTTEST) FROM #TEMP2 T WHERE T.TCKIMLIKNO = OKP.TCKIMLIKNO AND T.ID_KATEGORI = OKP.ID_KATEGORI)))
						AND (OKP.HARF = S.HARF)
						AND (S.ID_SATISTURU=O.ID_SATISTURU)
						AND (S.AY=DATEPART(month, GETDATE()))
						AND OKP.TCKIMLIKNO=@TEMPTCKIMLIK
						AND (
								@HESAPTURUSORU = 0 
								OR @BASLANGIC IS NULL 
								OR @BITIS IS NULL 
								OR (
										CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
										AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)
									)
							)
						ORDER BY OKP.TCKIMLIKNO 

						--SELECT ID_TKTSORU, TCKIMLIKNO, ADSOYAD, SUBEAD, DOSYAAD, DOSYAUZANTI, ID_TKTKATEGORI INTO #TMP_TKTOGRENCISINAV2 FROM #TMP_TKTOGRENCISINAV
						--WITH (NOLOCK) WHERE
						--(ID_TKTSORU NOT IN (SELECT ID_TKTSORU FROM UpgradeOgrenciSinav WHERE TCKIMLIKNO=@TEMPTCKIMLIK)) 
						--and ID_TKTSINAV=@ID_TKTSINAV

						SELECT ID_TKTSORU, TCKIMLIKNO, ADSOYAD, SUBEAD, DOSYAAD, DOSYAUZANTI, ID_TKTKATEGORI 
						INTO #TMP_TKTOGRENCISINAV2 
						FROM #TMP_TKTOGRENCISINAV
						WITH (NOLOCK) WHERE
						(ID_TKTSORU NOT IN (SELECT ID_TKTSORU FROM UpgradeOgrenciSinavDonem OSD JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSD.DONEM = @DONEM)) 
						and ID_TKTSINAV = @ID_TKTSINAV
						--Eskiden sorulmuş sorular sorulmasın 
		
						--KATEGORILER OGRENCI PUANINA GORE SIRALANIYOR
						CREATE TABLE #SIRALAMA (KategoriRow INT, ID_TKTKATEGORI INT)
						IF @ID_TKTTEST = 4 AND @ID_TKTSINAVORTALAMALIST IS NOT NULL
						BEGIN
							INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
							SELECT		ROW_NUMBER() OVER(ORDER BY CAST((CAST(SUM(OSDS.DOGRUKAZANIMADEDI) AS decimal(18, 2)) / CAST(SUM(S.KAZANIMADEDI) AS decimal(18, 2)) * 100.0) AS decimal(18, 2)) asc) AS 'KategoriRow',
										S.ID_TKTKATEGORI
							FROM UpgradeOgrenciSinavDonem OSD
							JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							JOIN vw_UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
							WHERE OSD.TCKIMLIKNO = @TEMPTCKIMLIK AND OSD.DONEM = @DONEM AND OSDS.DOGRUKAZANIMADEDI IS NOT NULL AND S.KAZANIMADEDI IS NOT NULL AND OSD.ID_TKTSINAV IN (SELECT VALUE FROM OPENJSON(@ID_TKTSINAVORTALAMALIST))
							GROUP BY OSD.TCKIMLIKNO, S.ID_TKTKATEGORI, S.KATEGORIAD

							IF (SELECT COUNT(1) FROM #SIRALAMA) = 0 -- ORTALAMA YOK İSE ÖN TESTE GÖRE
							BEGIN
								INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
								SELECT ROW_NUMBER() OVER(ORDER BY PUAN asc) AS 'KategoriRow', ID_KATEGORI AS ID_TKTKATEGORI
								FROM vw_OgrenciKategoriPuan
								WITH (NOLOCK)
								WHERE TCKIMLIKNO=@TEMPTCKIMLIK and ID_TKTTEST = 1 and (@DONEM IS NULL OR DONEM = @DONEM)
							END
						END
						ELSE
						BEGIN
							INSERT INTO #SIRALAMA (KategoriRow, ID_TKTKATEGORI)
							SELECT ROW_NUMBER() OVER(ORDER BY PUAN asc) AS 'KategoriRow', ID_KATEGORI AS ID_TKTKATEGORI
							FROM vw_OgrenciKategoriPuan
							WITH (NOLOCK)
							WHERE TCKIMLIKNO=@TEMPTCKIMLIK and ID_TKTTEST = @ID_TKTTEST and (@DONEM IS NULL OR DONEM = @DONEM)
						END						

						--OGRENCININ PUANINA GORE TERS ORANTILI KATEGORIDEN 4,3,2,1 TOPLAM 10 SORU GETIR
						DECLARE @ID_TKTKATEGORIx INT	=	0
						DECLARE @ROWNUMBER		 INT	=	0
						CREATE TABLE #RESULTTABLE(ID_TKTSORU INT, TCKIMLIKNO VARCHAR(11), ADSOYAD VARCHAR(200), SUBEAD VARCHAR(200), DOSYAAD VARCHAR(200), DOSYAUZANTI VARCHAR(10), ID_TKTKATEGORI INT); 
						WHILE EXISTS(SELECT * FROM #SIRALAMA)
						BEGIN
							SELECT TOP 1 @ID_TKTKATEGORIx	=	ID_TKTKATEGORI	FROM #SIRALAMA
							SELECT TOP 1 @ROWNUMBER			=	KategoriRow		FROM #SIRALAMA
							INSERT INTO #RESULTTABLE SELECT TOP (5 - @ROWNUMBER) * FROM #TMP_TKTOGRENCISINAV2 WHERE ID_TKTKATEGORI = @ID_TKTKATEGORIx		
							DELETE #SIRALAMA WHERE ID_TKTKATEGORI = @ID_TKTKATEGORIx
						END
						DROP TABLE #SIRALAMA
		
						--Gelecekte aynı soruyla sınav oluşturmamak için TktOgrenciSinav tablosuna kaydediyoruz
						--INSERT INTO UpgradeOgrenciSinav(TCKIMLIKNO, ID_TKTSORU, ID_TKTSINAV, KYE_KULLANICI, KYE_TARIH)
						--SELECT TS.TCKIMLIKNO, TS.ID_TKTSORU, @ID_TKTSINAV, @TCKIMLIKNO, GETDATE() FROM #RESULTTABLE TS
						--WITH (NOLOCK)
						--WHERE NOT EXISTS (SELECT * FROM UpgradeOgrenciSinav WHERE TCKIMLIKNO=TS.TCKIMLIKNO AND ID_TKTSORU=TS.ID_TKTSORU)
						
						IF (SELECT COUNT(1) FROM #RESULTTABLE) = 0 -- BILGI YOK ISE
						BEGIN
							PRINT 1
						END
						ELSE
						BEGIN
							DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
							WHERE TCKIMLIKNO = @TEMPTCKIMLIK AND ID_TKTSINAV = @ID_TKTSINAV AND DONEM = @DONEM

							DECLARE @IDTABLE TABLE (ID INT)
							INSERT INTO UpgradeOgrenciSinavDonem (TCKIMLIKNO, ID_TKTSINAV, ID_TKTTEST, DONEM, KYE_KULLANICI, KYE_TARIH)
							OUTPUT inserted.ID_UPGRADEOGRENCISINAVDONEM INTO @IDTABLE
							SELECT DISTINCT TCKIMLIKNO, @ID_TKTSINAV, @ID_TKTTEST, @DONEM, @TCKIMLIKNO, GETDATE() 
							FROM #RESULTTABLE R 
							WHERE NOT EXISTS (
												SELECT ID_TKTSORU 
												FROM UpgradeOgrenciSinavDonem OSD 
												JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM 
												WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSDS.ID_TKTSORU = R.ID_TKTSORU AND OSD.DONEM = @DONEM
											)

							DECLARE @ID INT 
							SELECT @ID = ID FROM @IDTABLE

							INSERT INTO UpgradeOgrenciSinavDonemSoru(ID_UPGRADEOGRENCISINAVDONEM, ID_TKTSORU)
							SELECT @ID, R.ID_TKTSORU
							FROM #RESULTTABLE R 
							WHERE NOT EXISTS (
												SELECT ID_TKTSORU 
												FROM UpgradeOgrenciSinavDonem OSD 
												JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM 
												WHERE OSD.TCKIMLIKNO=@TEMPTCKIMLIK AND OSDS.ID_TKTSORU = R.ID_TKTSORU AND OSD.DONEM = @DONEM
											)

							IF @ID_TKTSINAVORTALAMALIST IS NOT NULL
							BEGIN
								INSERT INTO UpgradeOgrenciSinavDonemEtkinlik (ID_UPGRADEOGRENCISINAVDONEM, ID_TKTSINAV)
								SELECT @ID, VALUE FROM OPENJSON(@ID_TKTSINAVORTALAMALIST) WHERE VALUE <> 0
							END
						
							INSERT INTO #TOTALRESULTTABLE SELECT * FROM #RESULTTABLE
						END
				
						DROP TABLE #RESULTTABLE
						DROP TABLE #TMP_TKTOGRENCISINAV2
						DROP TABLE #TMP_TKTOGRENCISINAV
					END				
			
					DELETE #TMP_OGRENCIBILGI WHERE TCKIMLIKNO = @TEMPTCKIMLIK
				END
				SET @SAYI = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TOTALRESULTTABLE)
				IF @SAYI>1
				BEGIN
				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT DISTINCT  @TCKIMLIKNO, TC.TCKIMLIKNO,'TOPLU EKLENDİ',GETDATE() FROM #TOTALRESULTTABLE AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				END
			    IF @SAYI =1
				BEGIN
				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT  DISTINCT  @TCKIMLIKNO, TC.TCKIMLIKNO,'EKLENDİ',GETDATE() FROM #TOTALRESULTTABLE AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				END
				
				DROP TABLE #TMP_OGRENCIBILGI
				
				SELECT t.TCKIMLIKNO, t.ADSOYAD, t.SUBEAD, t.DOSYAAD, t.DOSYAUZANTI ,s.AD SINIF, ROW_NUMBER() OVER(PARTITION BY t.TCKIMLIKNO ORDER BY t.TCKIMLIKNO, t.ID_TKTSORU) AS SIRA
				FROM #TOTALRESULTTABLE t
				JOIN v3OgrenciTum	o ON o.TCKIMLIKNO=t.TCKIMLIKNO
				JOIN v3SinifTum		s ON s.ID_SINIF=o.ID_SINIF
				WHERE o.DONEM = @DONEM
				ORDER BY t.TCKIMLIKNO, t.ID_TKTSORU
			
				DROP TABLE #TOTALRESULTTABLE
				DROP TABLE #TEMP2
				DROP TABLE #TEMP
			END

			IF @ISLEM = 11	--	Tkt Donem Getir
			BEGIN
				SELECT * FROM UpgradeDonem
			END

			IF @ISLEM = 12	--	Tkt Doneme Göre Sınav Getir
			BEGIN
				SELECT	DISTINCT
						 S.[ID_TKTSORU]
						,S.[ID_TKTPUAN]
						,S.[ID_TKTKATEGORI]
						,S.[KATEGORIAD]
						,S.[ID_SATISTURU]
						,S.[HARF]
						,(CASE WHEN HARF='A' THEN 'Üstün' WHEN HARF='B' THEN 'Ortanın Üstü' WHEN HARF='C' THEN 'Orta' WHEN HARF='D' THEN 'Ortanın Altı' WHEN HARF='E' THEN 'Desteklenmeli' END) as SEVIYE
						,(SELECT CASE WHEN GRUP='Ü.Z İLKOKUL' THEN ACIKLAMA+ ' (ÜSTÜN)' ELSE ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru WHERE ID_SATISTURU=S.ID_SATISTURU) as GRUP
						,S.[DOSYAAD]
						,S.[DOSYAUZANTI]
						,S.[KYE_KULLANICI]
						,S.[KYE_TARIH]
						,STUFF((SELECT ',' + DONEM 
							FROM [vw_UpgradeSoru]
							where [ID_TKTSORU]=S.[ID_TKTSORU] and [ID_SATISTURU]=S.[ID_SATISTURU]
							FOR XML PATH('')) ,1,1,'') as DONEM
				FROM [vw_UpgradeSoru]	S
				JOIN UpgradeSoruDonem	SD	ON SD.ID_TKTSORU=S.ID_TKTSORU
				WHERE 
						(@ID_TKTDONEMS		IS NULL		OR @ID_TKTDONEMS = ''		OR SD.ID_TKTDONEM IN ((SELECT Value FROM dbo.fn_Split(@ID_TKTDONEMS, ',', null))) ) 
					AND (@ID_TKTKATEGORI	IS NULL		OR @ID_TKTKATEGORI = 0		OR S.ID_TKTKATEGORI=@ID_TKTKATEGORI) 
					AND	(@ID_SATISTURU		IS NULL		OR @ID_SATISTURU = 0		OR S.ID_SATISTURU=@ID_SATISTURU) 
					AND	(@ID_TKTPUAN		IS NULL		OR @ID_TKTPUAN = 0			OR S.ID_TKTPUAN=@ID_TKTPUAN)
				GROUP BY S.[ID_TKTSORU]
						,S.[ID_TKTPUAN]
						,S.[ID_TKTKATEGORI]
						,S.[KATEGORIAD]
						,S.[ID_SATISTURU]
						,S.[HARF]
						,S.[DOSYAAD]
						,S.[DOSYAUZANTI]
						,S.[KYE_KULLANICI]
						,S.[KYE_TARIH]
						,S.DONEM 
			END

			IF @ISLEM = 13	--	Upgrade Grup Getir
			BEGIN
				SELECT DISTINCT st.ID_SATISTURU, CASE WHEN st.GRUP='Ü.Z İLKOKUL' THEN st.ACIKLAMA+ ' (ÜSTÜN)' ELSE st.ACIKLAMA END AS ACIKLAMA FROM v3SatisTuru st
				INNER JOIN v3Kademe k ON k.ID_KADEME=st.ID_KADEME
				WHERE k.ID_KADEME in (2,3)
			END

			IF @ISLEM = 14	--	Upgrade Soru Sayıları getir
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT
							(SELECT AD FROM TKTSeviye ORDER BY ID_TKTSeviye DESC FOR JSON PATH) AS SEVIYE
									
							,(SELECT AD FROM UpgradeKategori FOR JSON PATH) AS KATEGORI

							,(SELECT TS.AD AS SEVIYE, UK.AD AS KATEGORI, COUNT(SD.ID_TKTSORUDONEM) AS SAYI
							FROM TKTSeviye TS
							INNER JOIN UpgradePuanTek UP ON UP.HARF=TS.HARF
							INNER JOIN UpgradeKategori UK ON UK.ID_TKTKATEGORI=UP.ID_TKTKATEGORI
							LEFT JOIN UpgradeSoru S ON S.ID_TKTPUAN=UP.ID_TKTPUAN AND S.ID_SATISTURU = @ID_SATISTURU AND
														(@HESAPTURU = 0 
														OR @BASLANGIC IS NULL 
														OR @BITIS IS NULL 
														OR (
															CAST(S.KYE_TARIH AS DATE) >= CAST(@BASLANGIC AS DATE) 
															AND CAST(S.KYE_TARIH AS DATE) <= CAST(@BITIS AS DATE)))
							LEFT JOIN UpgradeSoruDonem SD ON SD.ID_TKTSORU=S.ID_TKTSORU AND SD.ID_TKTDONEM = @ID_TKTDONEM
							WHERE UK.AKTIF = 1
							GROUP BY TS.AD, UK.AD, TS.ID_TKTSeviye, UK.ID_TKTKATEGORI
							ORDER BY TS.ID_TKTSeviye DESC, UK.ID_TKTKATEGORI
							FOR JSON PATH) AS SONUC					
					) AS SUBTABLE FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 15	--	Sınav Kağıdı Sil
			BEGIN
				--DELETE OS FROM UpgradeOgrenciSinav OS
				--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
				--INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				--WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND ST.ID_KADEME3 = @ID_SINAVGRUP

				DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
				WHERE OSD.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
			
				INSERT INTO EtkinlikKagidiOlusturLog (KIM,KIME,ISLEM,TARIH) VALUES (@TCKIMLIKNO,@TCKIMLIKNO_OGR,@TUR,@TARIH)
				
			END

			IF @ISLEM = 16	--	Sınav Kağıdı Sil Toplu
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, SGS.ID_KADEME3
				INTO #TMP_OGRENCIBILGISIL
				FROM	   [dbo].[v3OgrenciTum]			O
				INNER JOIN [dbo].[v3SubeGrupSinifTum]	SGS	ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN [dbo].[v3Satislar]			SAT	ON SAT.ID_SOZLESME = O.ID_SOZLESME
				INNER JOIN [dbo].[v3SatisTuru]			ST	ON ST.ID_SATISTURU = SAT.ID_SATISTURU
				INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.TCKIMLIKNO = O.TCKIMLIKNO AND SY.XBASE=1
				INNER JOIN [dbo].[v3Kullanici]			K	ON k.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN [dbo].[v3Sube]				SU	ON SU.ID_SUBE = SY.ID_SUBE
				WHERE 
					(@ID_SINIFS IS NULL OR @ID_SINIFS = '[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@ID_SINIFS)))
				AND	(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP = 0 OR ST.ID_KADEME3 = @ID_SINAVGRUP) 
				AND (@ID_SUBE IS NULL OR @ID_SUBE = 0 OR O.ID_SUBE = @ID_SUBE) 
				AND O.DONEM = @DONEM

				--DELETE OS FROM UpgradeOgrenciSinav OS
				--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
				--INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				--INNER JOIN #TMP_OGRENCIBILGISIL OBS ON OBS.TCKIMLIKNO = OS.TCKIMLIKNO AND OBS.ID_KADEME3= ST.ID_KADEME3
				--WHERE ID_TKTSINAV = @ID_TKTSINAV

				DELETE OSD FROM UpgradeOgrenciSinavDonem OSD
				JOIN #TMP_OGRENCIBILGISIL O ON O.TCKIMLIKNO = OSD.TCKIMLIKNO
				WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM

				INSERT INTO EtkinlikKagidiOlusturLog
				SELECT  @TCKIMLIKNO, TC.TCKIMLIKNO,@TUR,@TARIH FROM #TMP_OGRENCIBILGISIL AS TC LEFT OUTER JOIN EtkinlikKagidiOlusturLog AS E ON TC.TCKIMLIKNO = e.KIME
				DROP TABLE #TMP_OGRENCIBILGISIL
			END

			IF @ISLEM = 17	--	Soru Kazanım Adedi Güncelle
			BEGIN
				UPDATE UpgradeSoru SET KAZANIMADEDI = @KAZANIMADEDI WHERE ID_TKTSORU = @ID_TKTSORU 
			END

			IF @ISLEM = 18	--	Öğrenci Soru Listele
			BEGIN
				--SET @ID_ST = (	
				--						SELECT ST.ID_SATISTURU
				--						FROM OkyanusDB.dbo.v3OgrenciTum O
				--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
				--						WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND O.DONEM = @DONEM
				--					)

				SELECT
				(
					--SELECT ROW_NUMBER() OVER(ORDER BY OS.ID_TKTSORU) AS SORUNO, OS.ID_TKTOGRENCISINAV, K.AD AS KATEGORI, S.KAZANIMADEDI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 0 ELSE 1 END AS ISDISABLED, OS.DOGRUKAZANIMADEDI, P.HARF, 'https://pusulam.okyanuskoleji.k12.tr/Dosyalar/' + D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM
					--FROM UpgradeOgrenciSinav OS
					--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
					--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					--INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					--INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					--WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
					--ORDER BY OS.ID_TKTSORU

					SELECT ROW_NUMBER() OVER(ORDER BY OSDS.ID_TKTSORU) AS SORUNO, OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU, K.AD AS KATEGORI, S.KAZANIMADEDI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 0 ELSE 1 END AS ISDISABLED, OSDS.DOGRUKAZANIMADEDI, P.HARF, 'https://pusulam.okyanuskoleji.k12.tr/Dosyalar/' + D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM
					FROM UpgradeOgrenciSinavDonem OSD
					JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
					INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
					INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					ORDER BY OSDS.ID_TKTSORU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 19	--	Öğrenci Soru Puan Kaydet
			BEGIN
				--UPDATE OS SET OS.DOGRUKAZANIMADEDI = J.DOGRUKAZANIMADEDI 
				--FROM UpgradeOgrenciSinav OS
				--INNER JOIN OPENJSON(@SQLJSON)
				--WITH(
				--	ID_TKTOGRENCISINAV INT,
				--	KAZANIMADEDI INT,
				--	DOGRUKAZANIMADEDI INT
				--) AS J ON J.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV

				UPDATE OSDS SET OSDS.DOGRUKAZANIMADEDI = J.DOGRUKAZANIMADEDI 
				FROM UpgradeOgrenciSinavDonemSoru OSDS
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_UPGRADEOGRENCISINAVDONEMSORU INT,
					KAZANIMADEDI INT,
					DOGRUKAZANIMADEDI INT
				) AS J ON J.ID_UPGRADEOGRENCISINAVDONEMSORU = OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU

				--UPDATE S SET S.KAZANIMADEDI = J.KAZANIMADEDI 
				--FROM UpgradeSoru S
				--INNER JOIN UpgradeOgrenciSinav OS ON OS.ID_TKTSORU = S.ID_TKTSORU
				--INNER JOIN OPENJSON(@SQLJSON)
				--WITH(
				--	ID_TKTOGRENCISINAV INT,
				--	KAZANIMADEDI INT,
				--	DOGRUKAZANIMADEDI INT
				--) AS J ON J.ID_TKTOGRENCISINAV = OS.ID_TKTOGRENCISINAV
				--WHERE S.KAZANIMADEDI IS NULL

				UPDATE S SET S.KAZANIMADEDI = J.KAZANIMADEDI 
				FROM UpgradeSoru S
				INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_TKTSORU = S.ID_TKTSORU
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_UPGRADEOGRENCISINAVDONEMSORU INT,
					KAZANIMADEDI INT,
					DOGRUKAZANIMADEDI INT
				) AS J ON J.ID_UPGRADEOGRENCISINAVDONEMSORU = OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU
				WHERE S.KAZANIMADEDI IS NULL
			END

			IF @ISLEM = 20	--	Öğrenci Sonuç Listele
			BEGIN
				--SET @ID_ST = (	
				--						SELECT ST.ID_SATISTURU
				--						FROM OkyanusDB.dbo.v3OgrenciTum O
				--						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF
				--						WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR AND O.DONEM = @DONEM
				--					)

				SELECT
				(
					--SELECT ROW_NUMBER() OVER(ORDER BY OS.ID_TKTSORU) AS SORUNO, D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM, OS.ID_TKTOGRENCISINAV, K.AD AS KATEGORI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(S.KAZANIMADEDI AS VARCHAR) END AS KAZANIMADEDI, CASE WHEN OS.DOGRUKAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(OS.DOGRUKAZANIMADEDI AS VARCHAR) END AS DOGRUKAZANIMADEDI
					--FROM UpgradeOgrenciSinav OS
					--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
					--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					--INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					--INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					--WHERE OS.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OS.ID_TKTSINAV = @ID_TKTSINAV AND S.ID_SATISTURU = @ID_ST
					--ORDER BY OS.ID_TKTSORU

					SELECT ROW_NUMBER() OVER(ORDER BY OSDS.ID_TKTSORU) AS SORUNO, D.DOSYAAD + '.' + D.DOSYAUZANTI AS RESIM, OSDS.ID_UPGRADEOGRENCISINAVDONEMSORU, K.AD AS KATEGORI, CASE WHEN S.KAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(S.KAZANIMADEDI AS VARCHAR) END AS KAZANIMADEDI, CASE WHEN OSDS.DOGRUKAZANIMADEDI IS NULL THEN 'GİRİLMEDİ' ELSE CAST(OSDS.DOGRUKAZANIMADEDI AS VARCHAR) END AS DOGRUKAZANIMADEDI
					FROM UpgradeOgrenciSinavDonem OSD
					INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
					INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
					INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
					INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
					INNER JOIN DokumanDetay DD ON DD.ID = S.ID_TKTSORU
					INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
					WHERE OSD.TCKIMLIKNO = @TCKIMLIKNO_OGR AND OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
					ORDER BY OSDS.ID_TKTSORU
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 21	--	Toplu Sonuç Listele
			BEGIN
				SELECT O.TCKIMLIKNO, K.AD, K.SOYAD, SB.AD AS KAMPUS, K3.AD AS GRUP, SNF.AD AS SINIF, SAT.ID_SATISTURU, convert(varchar, K.DOGUMTARIHI, 104) as DOGUMTARIHI
				INTO #OGRENCI
				FROM OkyanusDB.dbo.v3OgrenciTum O
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = SGS.ID_KADEME3
				INNER JOIN OkyanusDB.dbo.v3Sinif SNF ON SNF.ID_SINIF = SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Satislar SAT ON SAT.ID_SOZLESME = O.ID_SOZLESME AND SAT.ID_DONEM = O.ID_DONEM
				WHERE O.DONEM = @DONEM		
					AND (@ID_SUBES		IS NULL OR @ID_SUBES='[]'		OR SGS.ID_SUBE		in (select value from openjson (@ID_SUBES)))
					AND (@ID_SINAVGRUPS IS NULL OR @ID_SINAVGRUPS='[]'	OR SGS.ID_KADEME3	in (select value from openjson (@ID_SINAVGRUPS)))
					AND (@ID_SINIFS		IS NULL OR @ID_SINIFS='[]'		OR SGS.ID_SINIF		in (select value from openjson (@ID_SINIFS)))
				ORDER BY O.TCKIMLIKNO

				SELECT TCKIMLIKNO, AD, SOYAD, KAMPUS, GRUP, SINIF, DOGUMTARIHI,
					MAX([1-DOGRUKAZANIMADEDI]) AS [1-DOGRUKAZANIMADEDI],
					MAX([2-DOGRUKAZANIMADEDI]) AS [2-DOGRUKAZANIMADEDI],
					MAX([3-DOGRUKAZANIMADEDI]) AS [3-DOGRUKAZANIMADEDI],
					MAX([4-DOGRUKAZANIMADEDI]) AS [4-DOGRUKAZANIMADEDI],
					MAX([5-DOGRUKAZANIMADEDI]) AS [5-DOGRUKAZANIMADEDI],
					MAX([6-DOGRUKAZANIMADEDI]) AS [6-DOGRUKAZANIMADEDI],
					MAX([7-DOGRUKAZANIMADEDI]) AS [7-DOGRUKAZANIMADEDI],
					MAX([8-DOGRUKAZANIMADEDI]) AS [8-DOGRUKAZANIMADEDI],
					MAX([9-DOGRUKAZANIMADEDI]) AS [9-DOGRUKAZANIMADEDI],
					MAX([10-DOGRUKAZANIMADEDI]) AS [10-DOGRUKAZANIMADEDI],
					MAX([1-KAZANIMADEDI]) AS [1-KAZANIMADEDI],
					MAX([2-KAZANIMADEDI]) AS [2-KAZANIMADEDI],
					MAX([3-KAZANIMADEDI]) AS [3-KAZANIMADEDI],
					MAX([4-KAZANIMADEDI]) AS [4-KAZANIMADEDI],
					MAX([5-KAZANIMADEDI]) AS [5-KAZANIMADEDI],
					MAX([6-KAZANIMADEDI]) AS [6-KAZANIMADEDI],
					MAX([7-KAZANIMADEDI]) AS [7-KAZANIMADEDI],
					MAX([8-KAZANIMADEDI]) AS [8-KAZANIMADEDI],
					MAX([9-KAZANIMADEDI]) AS [9-KAZANIMADEDI],
					MAX([10-KAZANIMADEDI]) AS [10-KAZANIMADEDI],
					MAX([1-KATEGORI]) AS [1-KATEGORI],
					MAX([2-KATEGORI]) AS [2-KATEGORI],
					MAX([3-KATEGORI]) AS [3-KATEGORI],
					MAX([4-KATEGORI]) AS [4-KATEGORI],
					MAX([5-KATEGORI]) AS [5-KATEGORI],
					MAX([6-KATEGORI]) AS [6-KATEGORI],
					MAX([7-KATEGORI]) AS [7-KATEGORI],
					MAX([8-KATEGORI]) AS [8-KATEGORI],
					MAX([9-KATEGORI]) AS [9-KATEGORI],
					MAX([10-KATEGORI]) AS [10-KATEGORI]
				FROM 
				( 
					SELECT * 
					FROM 
					( 
						SELECT * 
						FROM 
						( 
							--SELECT O.*, K.AD AS KATEGORI, ISNULL(CAST(S.KAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS KAZANIMADEDI, ISNULL(CAST(OS.DOGRUKAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS DOGRUKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-DOGRUKAZANIMADEDI ' AS SORUNODOGRUKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-KAZANIMADEDI ' AS SORUNOKAZANIMADEDI,
							--	CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OS.ID_TKTSORU) AS varchar(2)) + '-KATEGORI ' AS SORUNOKATEGORI 
							--FROM #OGRENCI O
							--INNER JOIN UpgradeOgrenciSinav OS ON OS.TCKIMLIKNO = O.TCKIMLIKNO
							--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU AND S.ID_SATISTURU = O.ID_SATISTURU
							--INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
							--INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
							--WHERE OS.ID_TKTSINAV = @ID_TKTSINAV

							SELECT O.*, K.AD AS KATEGORI, ISNULL(CAST(S.KAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS KAZANIMADEDI, ISNULL(CAST(OSDS.DOGRUKAZANIMADEDI AS VARCHAR), 'GİRİLMEDİ') AS DOGRUKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-DOGRUKAZANIMADEDI ' AS SORUNODOGRUKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-KAZANIMADEDI ' AS SORUNOKAZANIMADEDI,
								CAST(ROW_NUMBER() OVER(PARTITION BY O.TCKIMLIKNO ORDER BY OSDS.ID_TKTSORU) AS varchar(2)) + '-KATEGORI ' AS SORUNOKATEGORI 
							FROM #OGRENCI O
							INNER JOIN UpgradeOgrenciSinavDonem OSD ON OSD.TCKIMLIKNO = O.TCKIMLIKNO
							INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU AND S.ID_SATISTURU = O.ID_SATISTURU
							INNER JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
							INNER JOIN UpgradeKategori K ON K.ID_TKTKATEGORI = P.ID_TKTKATEGORI
							WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
						) AS XTABLE 
						PIVOT 
						( 
							MAX(DOGRUKAZANIMADEDI) FOR SORUNODOGRUKAZANIMADEDI IN ([1-DOGRUKAZANIMADEDI],[2-DOGRUKAZANIMADEDI],[3-DOGRUKAZANIMADEDI],[4-DOGRUKAZANIMADEDI],[5-DOGRUKAZANIMADEDI],[6-DOGRUKAZANIMADEDI],[7-DOGRUKAZANIMADEDI],[8-DOGRUKAZANIMADEDI],[9-DOGRUKAZANIMADEDI],[10-DOGRUKAZANIMADEDI]) 
						) AS P_DOGRUKAZANIMADEDI
						)
					AS XTABLE 
					PIVOT 
					( 
						MAX(KAZANIMADEDI) FOR SORUNOKAZANIMADEDI IN ([1-KAZANIMADEDI],[2-KAZANIMADEDI],[3-KAZANIMADEDI],[4-KAZANIMADEDI],[5-KAZANIMADEDI],[6-KAZANIMADEDI],[7-KAZANIMADEDI],[8-KAZANIMADEDI],[9-KAZANIMADEDI],[10-KAZANIMADEDI]) 
					) AS P_KAZANIMADEDI
				)
				AS XTABLE 
				PIVOT 
				( 
					MAX(KATEGORI) FOR SORUNOKATEGORI IN ([1-KATEGORI],[2-KATEGORI],[3-KATEGORI],[4-KATEGORI],[5-KATEGORI],[6-KATEGORI],[7-KATEGORI],[8-KATEGORI],[9-KATEGORI],[10-KATEGORI]) 
				) AS P_KATEGORI
				GROUP BY TCKIMLIKNO, AD, SOYAD, KAMPUS, GRUP, SINIF, DOGUMTARIHI
				ORDER BY KAMPUS, GRUP, SINIF, AD, SOYAD

				DROP TABLE #OGRENCI
			END

			IF @ISLEM = 22	--	SORULARIN ÇÖZÜLME ORANLARI
			BEGIN
				SELECT S.ID_TKTSORU, S.DOSYAAD + '.' + S.DOSYAUZANTI AS DOSYA, (CASE WHEN S.HARF='A' THEN 'Üstün' WHEN S.HARF='B' THEN 'Ortanın Üstü' WHEN S.HARF='C' THEN 'Orta' WHEN S.HARF='D' THEN 'Ortanın Altı' WHEN S.HARF='E' THEN 'Desteklenmeli' END) AS PUANARALIGI, S.KAZANIMADEDI
				INTO #TEMPSORU
				FROM vw_UpgradeSoru S
				JOIN UpgradePuan P ON P.ID_TKTPUAN = S.ID_TKTPUAN
				WHERE S.ID_SATISTURU = @ID_SATISTURU AND S.ID_TKTKATEGORI = @ID_TKTKATEGORI
				GROUP BY S.ID_TKTSORU, S.DOSYAAD, S.DOSYAUZANTI, S.KAZANIMADEDI, S.HARF

				SELECT ISNULL(
				(
					SELECT S.ID_TKTSORU, S.DOSYA, S.PUANARALIGI, S.KAZANIMADEDI, COUNT(1) AS OGRENCISAYISI, CONVERT (DECIMAL(5,2), (SUM(OS.DOGRUKAZANIMADEDI) * 100.0) / (S.KAZANIMADEDI * COUNT(1))) AS COZULMEORANI
					FROM #TEMPSORU S
					JOIN UpgradeOgrenciSinavDonemSoru OS ON OS.ID_TKTSORU = S.ID_TKTSORU
					JOIN UpgradeOgrenciSinavDonem O ON O.ID_UPGRADEOGRENCISINAVDONEM = OS.ID_UPGRADEOGRENCISINAVDONEM
					WHERE OS.DOGRUKAZANIMADEDI IS NOT NULL AND O.DONEM = @DONEM
					GROUP BY S.ID_TKTSORU, S.DOSYA, S.PUANARALIGI, S.KAZANIMADEDI
					ORDER BY S.ID_TKTSORU
					FOR JSON PATH
				), '[]')

				DROP TABLE #TEMPSORU
			END			
			
			IF @ISLEM = 23  -- UPGRADE ISLEM RAPOR LOG
			BEGIN
				SELECT KIM, KIME, ISLEM, TARIH = CONVERT(VARCHAR,TARIH, 104) +' '  + CONVERT(VARCHAR,TARIH, 108)
				FROM EtkinlikKagidiOlusturLog
				WHERE KIME = @TCKIMLIKNO_OGR
				ORDER BY TARIH DESC
			END
			
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_Yardim]...';


GO
ALTER procedure [dbo].[sp_Yardim]
	@ISLEM				INT				= NULL,
	@ID_MENU			INT				= NULL,
	@ID_MENU_SELECTED	INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@HTML				NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,ID_MENU					= @ID_MENU			
			,ID_MENU_SELECTED			= @ID_MENU_SELECTED	
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,SQLJSON					= @SQLJSON			
			,HTML						= @HTML				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	Menü Listele
		BEGIN
			SELECT (SELECT ID_MENU, (REPLICATE('-', LEN(KOD)-3) + AD) AS AD FROM Menu WHERE GIZLI=0 ORDER BY KOD FOR JSON AUTO) AS J
		END
		IF @ISLEM = 2	--	Menü Yardım HTML Getir
		BEGIN
			SELECT (SELECT YARDIMHTML FROM Menu WHERE ID_MENU=@ID_MENU_SELECTED FOR JSON AUTO, INCLUDE_NULL_VALUES) AS J
		END
		IF @ISLEM = 3	--	Menü Yardım HTML Kaydet
		BEGIN
			UPDATE Menu SET YARDIMHTML=@HTML WHERE ID_MENU=@ID_MENU_SELECTED
		END
	END
	
	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_YaziliYoklama]...';


GO
ALTER procedure [dbo].[sp_YaziliYoklama]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@ID_KADEME2				VARCHAR(MAX)	= NULL,
	@ID_DERSLER				VARCHAR(MAX)	= NULL,
	@SINIFLAR				VARCHAR(MAX)	= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_YAZILI				INT				= NULL,
	@DONEM					char(4)			= NULL,
	@YARIYIL				TINYINT			= NULL,
	@PASIF					BIT				= NULL,
	@TAKMAAD				VARCHAR(MAX)	= NULL,
	@ID_DERS				INT				= NULL,
	@ID_SINIF				INT				= NULL,	
	@SQLJSON		 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCI 		NVARCHAR(MAX)	= NULL,
	@SQLJSONOGRENCICEVAP	NVARCHAR(MAX)	= NULL,
	@OVGORSUN				BIT				= NULL,
	@AKTIF					BIT				= NULL,
	@KARNEDEGORUNSUN		BIT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM							= @ISLEM				
			,TCKIMLIKNO						= @TCKIMLIKNO			
			,TC_OGRENCI						= @TC_OGRENCI			
			,OTURUM							= @OTURUM				
			,ID_MENU						= @ID_MENU			
			,ID_KADEME2						= @ID_KADEME2			
			,ID_DERSLER						= @ID_DERSLER			
			,SINIFLAR						= @SINIFLAR			
			,ID_KADEME3						= @ID_KADEME3			
			,ID_YAZILI						= @ID_YAZILI			
			,DONEM							= @DONEM				
			,YARIYIL						= @YARIYIL			
			,PASIF							= @PASIF				
			,TAKMAAD						= @TAKMAAD			
			,ID_DERS						= @ID_DERS			
			,ID_SINIF						= @ID_SINIF			
			,SQLJSON		 				= @SQLJSON		 	
			,SQLJSONOGRENCI 				= @SQLJSONOGRENCI 	
			,SQLJSONOGRENCICEVAP			= @SQLJSONOGRENCICEVAP
			,OVGORSUN						= @OVGORSUN			
			,AKTIF							= @AKTIF				
			,KARNEDEGORUNSUN				= @KARNEDEGORUNSUN	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	KADEME 3 Listele
			BEGIN
				SELECT
				(
					SELECT DISTINCT st.ID_KADEME3, k.AD
					FROM		  [dbo].[v3Sinif]			s
					INNER JOIN	  [dbo].[v3Donem]			d		ON d.ID_DONEM		=	s.ID_DONEM
					INNER JOIN	  [dbo].[v3AktifDonem]		ad		ON ad.DONEM			=	d.KOD			and ad.AKTIF=1
					INNER JOIN	  [dbo].[v3SatisTuru]		st		ON st.ID_SATISTURU	=	s.ID_SATISTURU
					INNER JOIN	  [dbo].[v3Kademe3]			k		ON k.ID_KADEME3		=	st.ID_KADEME3
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 2	--	KADEME 2 LİSTELE
			BEGIN
				SELECT
				(
					SELECT KB.ID_KADEME2, K2.AD FROM OkyanusDB.dbo.v3KademeBilgi KB
					INNER JOIN OkyanusDB.dbo.v3Kademe2 K2 ON K2.ID_KADEME2=KB.ID_KADEME2
					where ID_KADEME3 = @ID_KADEME3
					FOR JSON PATH
				) AS J
			END	

			IF @ISLEM = 3	--	EKLE
			BEGIN
				----------
				--YAZILI--
				----------
				DECLARE @ID_YAZILILIST TABLE (ID_YAZILI INT)
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI INTO @ID_YAZILILIST(ID_YAZILI)
				select		[AD] ,[KOD] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM], YARIYIL, [ID_KADEME3], ID_DERS, convert(datetime, [YAZILITARIH], 103), @TCKIMLIKNO, [ID_YAZILITURU]
				from OPENJSON(@SQLJSON)
				with
				(
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) AS J

				-----------------
				--YAZILIKADEME2--
				-----------------
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select (select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')
									
				-----------
				--SORULAR--
				-----------
				INSERT INTO [dbo].[YaziliSoru]
						   ([ID_YAZILI]
						   ,[SORUNO]
						   ,[PUAN]
						   ,[KOD]
						   ,[ID_BILGI]
						   ,[ID_BILISSELSUREC])
				SELECT
					(select ID_YAZILI from @ID_YAZILILIST) as [ID_YAZILI]
					,JSON_Value (s.value, '$.SORUNO') as SORUNO
					,ISNULL(CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.')), 0) as PUAN
					,JSON_Value (s.value, '$.KOD') as KOD
					,CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END AS ID_BILGI
					,CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END AS ID_BILISSELSUREC
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
			
				select ID_YAZILI from @ID_YAZILILIST	
			END

			IF @ISLEM = 4	--	GÜNCELLE
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILI
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILI TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				UPDATE	 SORU SET SORU.PUAN = CONVERT(float,REPLACE(JSON_Value (s.value, '$.PUAN'),',','.'))
						,SORU.KOD = JSON_Value (s.value, '$.KOD')
						,SORU.ID_BILGI = CASE WHEN JSON_Value (s.value, '$.ID_BILGI') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILGI') END
						,SORU.ID_BILISSELSUREC = CASE WHEN JSON_Value (s.value, '$.ID_BILISSELSUREC') = 0 THEN NULL ELSE JSON_Value (s.value, '$.ID_BILISSELSUREC') END
				FROM OPENJSON (@SQLJSON, '$.SORULIST') as s
				INNER JOIN YaziliSoru SORU ON SORU.ID_YAZILI = @ID_YAZILI AND SORU.SORUNO = JSON_Value (s.value, '$.SORUNO')
				
				DROP TABLE #TEMPYAZILI
				select @ID_YAZILI	
			END

			IF @ISLEM = 5	--	BİLGİ GETİR
			BEGIN
				SELECT 
				(
					SELECT * FROM
					(
						Select (
							Select  
								s.AD as AD, 
								s.KOD, 
								ID_KADEME3, 
								Convert(varchar, YAZILITARIH, 103) as YAZILITARIH,
								s.ID_DERS,
								(SELECT COUNT(*) FROM YaziliSoru YS WHERE YS.ID_YAZILI=s.ID_YAZILI) as SORUSAYISI,
								SORULIST.SORUNO as SORUNO,
								SORULIST.KOD,
								UNITE = ISNULL(SD.AD, ''), 
								SORULIST.PUAN,
								s.YARIYIL,
								s.ID_YAZILITURU,
								ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
								ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC
							from	   Yazili			s
							LEFT join YaziliSoru		SORULIST		on	SORULIST.ID_YAZILI		= s.ID_YAZILI 
							LEFT JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
							where s.ID_YAZILI = @ID_YAZILI
						for json auto) as T1
						,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON AUTO) AS T2
					) AS XTABLE
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 6	--	LISTELE
			BEGIN
				SELECT
				(
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_YAZILI
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, YAZILITARIH, 104) AS YAZILITARIH
							,AKTIF 
							,(SELECT COUNT(*) FROM (SELECT TCKIMLIKNO FROM YaziliOgrenci WHERE ID_YAZILI = S.ID_YAZILI GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,OVGORSUN
							,KARNEDEGORUNSUN,
							ID_YAZILITURU
						FROM Yazili S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN YaziliKademe2 K2 ON K2.ID_YAZILI = S.ID_YAZILI
						WHERE	DONEM = @DONEM 
						AND		(@YARIYIL = 0 OR YARIYIL = @YARIYIL)
						AND		(@ID_KADEME3 = 0 OR S.ID_KADEME3 = @ID_KADEME3)
						AND		(@ID_KADEME2 = '[]' OR K2.ID_KADEME2 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME2)) or 0 in (SELECT VALUE FROM OPENJSON(@ID_KADEME2)))
						AND		(S.AKTIF = 1 OR @PASIF = 1)
						AND		(@ID_DERS = 0 OR S.ID_DERS = @ID_DERS)
					)XTABLE
					ORDER BY Convert(datetime, YAZILITARIH, 104) DESC
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 7	--	AKTİF PASİF
			BEGIN
				DECLARE @DURUM BIT = (SELECT CASE WHEN AKTIF = 1 THEN 0 ELSE 1 END FROM Yazili WHERE ID_YAZILI = @ID_YAZILI)
				UPDATE Yazili SET AKTIF = @DURUM, GUN_TCKIMLIKNO = @TCKIMLIKNO, GUN_TARIH = GETDATE() WHERE ID_YAZILI = @ID_YAZILI
				SELECT @DURUM
			END

			IF @ISLEM = 8	--	ÖĞRENCİ LİSTELE
			BEGIN
				--DECLARE @KUR BIT = (
				--			SELECT D.KUR FROM Yazili Y
				--			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--			WHERE ID_YAZILI = @ID_YAZILI
				--		)

				SELECT X.TCKIMLIKNO, X.AD, X.SOYAD, YOC.ID_YAZILIOGRENCI, X.ID_YAZILI, X.ID_YAZILISORU, X.SORUNO, X.PUAN AS MAXPUAN, ISNULL(YOC.PUAN, 0) AS PUAN, ISNULL(YO.KATILMADI, 0) AS KATILMADI, YO.TELAFI
				INTO #TEMP
				FROM
				(
					SELECT * FROM
					(
						SELECT Y.ID_YAZILI, YS.ID_YAZILISORU, YS.SORUNO, YS.PUAN 
						FROM Yazili Y
						INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
						WHERE Y.ID_YAZILI = @ID_YAZILI
					) AS T1
					CROSS JOIN 
					(
						SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDb.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
						WHERE S.ID_SINIF = @ID_SINIF --AND @KUR = 0
					UNION 
						SELECT DISTINCT K.TCKIMLIKNO, K.AD, K.SOYAD
						FROM OkyanusDB.dbo.v4SinifOgrenci SO 
						INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= SO.TC_OGRENCI
						WHERE SO.ID_SINIF = @ID_SINIF AND SO.AKTIF = 1
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM OkyanusDb.dbo.v3OgrenciTumKur O
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					--	INNER JOIN OkyanusDb.dbo.v3Sinif		S	ON	S.ID_SINIF		= O.ID_SINIF
					--	WHERE S.ID_SINIF = @ID_SINIF AND @KUR = 1
					--UNION 
					--	SELECT DISTINCT O.TCKIMLIKNO, K.AD, K.SOYAD
					--	FROM eokul_v2.dbo.KurOgrenci			KO
					--	INNER JOIN OkyanusDB.dbo.v3OgrenciTum		O	ON	O.ID_OGRENCI	= KO.ID_OGRENCI
					--	INNER JOIN OkyanusDB.dbo.v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
					--	WHERE KO.ID_KUR = @ID_SINIF
					) AS T2
				) AS X
				LEFT JOIN YaziliOgrenci YO ON YO.ID_YAZILI = X.ID_YAZILI AND YO.TCKIMLIKNO = X.TCKIMLIKNO AND AKTIF = 1
				LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = X.ID_YAZILISORU

				SELECT
				(
					SELECT
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILISORU, SORUNO, PUAN, MAXPUAN FROM #TEMP					
						ORDER BY TCKIMLIKNO, SORUNO
						FOR JSON PATH
					) AS T1,
					(
						SELECT DISTINCT TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI, COUNT(DISTINCT ID_YAZILISORU) AS SORUSAYISI 
						FROM #TEMP
						GROUP BY TCKIMLIKNO, ID_YAZILI, AD, SOYAD, KATILMADI, TELAFI
						ORDER BY TCKIMLIKNO
						FOR JSON PATH
					) AS T2
					FOR JSON PATH
				) AS J

				DROP TABLE #TEMP
			END

			IF @ISLEM = 9	--	KOPYALA
			BEGIN
				DECLARE @ID_YAZILILISTX TABLE (ID_YAZILI INT)
				INSERT INTO Yazili ([AD],[KOD],[DONEM],[YARIYIL],[ID_YAZILITURU],[ID_KADEME3],[ID_DERS],[YAZILITARIH],[KYE_TCKIMLIKNO],[KYE_TARIH],[AKTIF],[GUN_TARIH],[GUN_TCKIMLIKNO])
				OUTPUT inserted.ID_YAZILI INTO @ID_YAZILILISTX
				SELECT [AD]
					  ,[KOD]
					  ,[DONEM]
					  ,[YARIYIL]
					  ,[ID_YAZILITURU]
					  ,[ID_KADEME3]
					  ,[ID_DERS]
					  ,[YAZILITARIH]
					  ,@TCKIMLIKNO
					  ,GETDATE()
					  ,1
					  ,GETDATE()
					  ,'' 
				FROM Yazili 
				WHERE ID_YAZILI = @ID_YAZILI

				DECLARE @ID_YAZILIX INT = (SELECT ID_YAZILI FROM @ID_YAZILILISTX)  

				INSERT INTO YaziliKademe2 ([ID_YAZILI],[ID_KADEME2])
				SELECT @ID_YAZILIX
					  ,[ID_KADEME2] 
				FROM YaziliKademe2 
				WHERE ID_YAZILI = @ID_YAZILI
			
				INSERT INTO YaziliSoru ([ID_YAZILI],[SORUNO],[PUAN],[KOD])
				SELECT (SELECT ID_YAZILI FROM @ID_YAZILILISTX) AS ID_YAZILI
					  ,[SORUNO]
					  ,[PUAN]
					  ,[KOD] 
				FROM YaziliSoru YS
				WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 10	--	BİLGİ GETİR LİSTE
			BEGIN
				SELECT
				(
					SELECT DONEM
							,ID_KADEME3
							,ID_DERS
							,YARIYIL
							,(SELECT ID_KADEME2 FROM YaziliKademe2 WHERE ID_YAZILI = @ID_YAZILI FOR JSON PATH) AS ID_KADEME2 
					FROM Yazili 
					WHERE ID_YAZILI = @ID_YAZILI
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 11	--	LİSTELE SELECT
			BEGIN
				SELECT
				(
					SELECT Y.ID_YAZILI, Y.AD, Y.KOD 
					FROM Yazili			Y
					JOIN YaziliKademe2	K2	ON	K2.ID_YAZILI	= Y.ID_YAZILI
					WHERE	ID_KADEME3	= @ID_KADEME3 
						AND DONEM		= @DONEM 
						AND YARIYIL		= @YARIYIL 
						AND AKTIF		= 1 					
						AND (	
							ID_KADEME2 IN (SELECT ID_KADEME2 FROM OkyanusDB.dbo.v4Sinif S
									INNER JOIN OkyanusDB.dbo.v3KademeBilgi K ON K.ID_KADEME3 = S.ID_KADEME3
									WHERE S.ID_SINIF = @ID_SINIF) 
							OR  ID_KADEME2	= (SELECT ST.ID_KADEME2 FROM OkyanusDB.dbo.v3Sinif S INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU WHERE ID_SINIF = @ID_SINIF))
					GROUP BY Y.ID_YAZILI, Y.AD, Y.KOD
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 12	--	ÖĞRENCİ KAYDET
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
			
				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0

				UPDATE YO SET AKTIF = 0
				FROM YaziliOgrenci YO
				JOIN #TEMPOGRENCI T ON T.ID_YAZILI = YO.ID_YAZILI AND T.TCKIMLIKNO = YO.TCKIMLIKNO
				WHERE YO.AKTIF = 1

				DECLARE @ID_YAZILIOGRENCILIST TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST
				SELECT * FROM #TEMPOGRENCI T

				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT ID_YAZILISORU 
						--(	SELECT ID_YAZILIOGRENCI 
						--	FROM YaziliOgrenci 
						--	WHERE ID_YAZILI = 
						--			(	SELECT ID_YAZILI 
						--				FROM YaziliSoru 
						--				WHERE ID_YAZILISORU = OG.ID_YAZILISORU) 
						--		AND TCKIMLIKNO = OG.TCKIMLIKNO 
						--		AND AKTIF = 1 
						--		AND ISNULL(TELAFI, 0) = 0)
						, L.ID_YAZILIOGRENCI
						, PUAN 
						FROM OPENJSON(@SQLJSONOGRENCICEVAP) 
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG	
					JOIN @ID_YAZILIOGRENCILIST L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  		

				DROP TABLE #TEMPOGRENCI
			END

			IF @ISLEM = 13	--	ÖĞRENCİ SİL
			BEGIN
				SELECT ID_YAZILI, OG.TCKIMLIKNO, TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI2
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI INT,
					KATILMADI BIT
				) OG
				UPDATE Y SET AKTIF = 0, SIL_TCKIMLIKNO = @TCKIMLIKNO, SIL_TARIH = GETDATE()
				FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI2 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.AKTIF=1

				DROP TABLE #TEMPOGRENCI2
			END

			IF @ISLEM = 14	--	ÖĞRENCİ KAYDET TOPLU
			BEGIN
				SELECT DISTINCT ID_YAZILI, OG.TCKIMLIKNO, CAST((CASE WHEN TELAFI = '' THEN NULL ELSE TELAFI END) AS INT) AS TELAFI, KATILMADI, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #TEMPOGRENCI3
				FROM OPENJSON(@SQLJSONOGRENCI)
				WITH(
					TCKIMLIKNO VARCHAR(11),
					ID_YAZILI INT,
					TELAFI VARCHAR(5),
					KATILMADI BIT
				) OG

				UPDATE Y SET AKTIF = 0 FROM YaziliOgrenci Y 
				INNER JOIN #TEMPOGRENCI3 O ON O.ID_YAZILI = Y.ID_YAZILI AND O.TCKIMLIKNO = Y.TCKIMLIKNO

				delete c
				from YaziliOgrenci yo
				join YaziliOgrenciCevap c on c.ID_YAZILIOGRENCI = yo.ID_YAZILIOGRENCI
				where yo.AKTIF=0
			
				DECLARE @ID_YAZILIOGRENCILIST2 TABLE( ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(20))

				INSERT INTO YaziliOgrenci (ID_YAZILI, TCKIMLIKNO, TELAFI, KATILMADI, KYE_TCKIMLIKNO)
				OUTPUT INSERTED.ID_YAZILIOGRENCI,INSERTED.TCKIMLIKNO INTO @ID_YAZILIOGRENCILIST2
				SELECT * FROM #TEMPOGRENCI3			
			
				BEGIN TRY 
					INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
					SELECT DISTINCT ID_YAZILISORU
						--, (SELECT ID_YAZILIOGRENCI FROM YaziliOgrenci WHERE ID_YAZILI = (SELECT ID_YAZILI FROM YaziliSoru WHERE ID_YAZILISORU = OG.ID_YAZILISORU) AND TCKIMLIKNO = OG.TCKIMLIKNO AND AKTIF = 1)
						, L.ID_YAZILIOGRENCI
						, PUAN FROM OPENJSON(@SQLJSONOGRENCICEVAP)
					WITH(
						TCKIMLIKNO VARCHAR(11),
						ID_YAZILISORU INT,
						PUAN INT
					) OG		
					JOIN @ID_YAZILIOGRENCILIST2 L ON L.TCKIMLIKNO = OG.TCKIMLIKNO
				END	TRY		
				BEGIN CATCH  
				END CATCH  	


				DROP TABLE #TEMPOGRENCI3
			END

			IF @ISLEM = 15	--	Yazılı Listele by Sınıf
			BEGIN
				DECLARE  @ID_DERSLER2	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEM2		VARCHAR(MAX)=@DONEM
						,@YARIYIL2		INT			=@YARIYIL
						,@SINIFLAR2		VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TC
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TC
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLAR2))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (@ID_DERSLER2 IS NULL OR @ID_DERSLER2='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLER2)))
						AND (@YARIYIL2 IS NULL OR @YARIYIL2=0 OR sr.YARIYIL = @YARIYIL2)
						and sr.DONEM=@DONEM2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TC				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						--AND (@ID_KADEME3 IS NULL OR ID_KADEME3 = @ID_KADEME3)
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						and sr.DONEM=@DONEM
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TC
			END 

			IF @ISLEM = 16	--	YAZILI EKLE EXCEL
			BEGIN
				SELECT 
						 AD = JSON_Value (J.value, '$.AD') 
						,KOD = JSON_Value (J.value, '$.KOD')
						,ID_KADEME3 = K3.ID_KADEME3
						,ID_DERS = JSON_Value (J.value, '$.DERS')
						,ID_KADEME2 = K2.value
						,TARIH = JSON_Value (J.value, '$.TARIH')
						,YARIYIL = JSON_Value (J.value, '$.YARIYIL')
						,SORUNO = JSON_Value (S.value, '$.SORUNO')
						,UNITEKOD = JSON_Value (S.value, '$.KOD')
						,PUAN = JSON_Value (S.value, '$.PUAN')
						,ID_YAZILITURU = JSON_Value (J.value, '$.ID_YAZILITURU')
						,ID_BILGI = JSON_Value (S.value, '$.ID_BILGI')
						,ID_BILISSELSUREC = JSON_Value (S.value, '$.ID_BILISSELSUREC')
				INTO #YAZILI
				FROM OPENJSON(@SQLJSON) AS J
				CROSS APPLY OPENJSON (J.value, '$.OKULTUR') as K2
				CROSS APPLY OPENJSON (J.value, '$.SORULIST') as S
				INNER JOIN OkyanusDb.dbo.v3Kademe3 K3 ON K3.AD = JSON_Value (J.value, '$.GRUP')

				DECLARE @ID_YAZILIAD TABLE (ID_YAZILI INT, AD VARCHAR(50))
				INSERT INTO [dbo].[Yazili]
							([AD] ,[KOD] ,[DONEM] ,[YARIYIL] ,[ID_KADEME3], [ID_DERS], [YAZILITARIH], [KYE_TCKIMLIKNO], [ID_YAZILITURU])
				OUTPUT INSERTED.ID_YAZILI, INSERTED.AD INTO @ID_YAZILIAD(ID_YAZILI, AD)
				SELECT DISTINCT AD, KOD, (select DONEM from [dbo].[v3AktifDonem] where AKTIF=1), YARIYIL, ID_KADEME3, ID_DERS, TARIH, @TCKIMLIKNO, ID_YAZILITURU FROM #YAZILI Y

				INSERT INTO [dbo].[YaziliKademe2]([ID_YAZILI] ,[ID_KADEME2])
				SELECT DISTINCT YA.ID_YAZILI, ID_KADEME2 
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 

				INSERT INTO [dbo].[YaziliSoru]([ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC])
				SELECT DISTINCT YA.ID_YAZILI, Y.SORUNO, ISNULL(Y.PUAN, 0) AS PUAN, Y.UNITEKOD, Y.ID_BILGI, Y.ID_BILISSELSUREC
				FROM #YAZILI Y
				INNER JOIN @ID_YAZILIAD YA ON YA.AD = Y.AD 
			
				SELECT MAX(ID_YAZILI) FROM @ID_YAZILIAD

				DROP TABLE #YAZILI
			END

			IF @ISLEM = 17	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET OVGORSUN = @OVGORSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 18	--	AKTIF DEĞİŞTİR
			BEGIN
				UPDATE Yazili SET AKTIF = @AKTIF WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM = 19	--	YAZILI TÜRÜ LİSTELE
			BEGIN
				SELECT
				(
					SELECT * 
					FROM YaziliTuru
					WHERE AKTIF = 1
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 20	--	YAZILI BİLGİLERİNİ GÜNCELLE (SORULAR HARİÇ)
			BEGIN
				----------
				--YAZILI--
				----------
				SELECT ID_YAZILI, AD, KOD, YARIYIL, ID_KADEME3, ID_DERS, YAZILITARIH, ID_YAZILITURU 
				INTO #TEMPYAZILIGUNCELLE
				FROM OPENJSON(@SQLJSON)
				WITH
				(
					[ID_YAZILI] [int],
					[AD] [varchar](50),
					[KOD] [varchar](50),
					[YARIYIL] [tinyint],
					[ID_KADEME3] [int],
					[ID_DERS] [int],
					[YAZILITARIH] [varchar](50),
					[ID_YAZILITURU] [int]
				) 

				UPDATE Y SET  Y.[AD] = TY.AD
							 ,Y.[KOD] = TY.KOD
							 ,Y.[DONEM] = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) 
							 ,Y.[YARIYIL] = TY.YARIYIL
							 ,Y.[ID_KADEME3] = TY.ID_KADEME3
							 ,Y.[ID_DERS] = TY.ID_DERS
							 ,Y.[YAZILITARIH] = TY.YAZILITARIH
							 ,Y.[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							 ,Y.[GUN_TARIH] = GETDATE()
							 ,Y.[ID_YAZILITURU] = TY.ID_YAZILITURU
				FROM [dbo].[Yazili] Y
				INNER JOIN #TEMPYAZILIGUNCELLE TY ON TY.ID_YAZILI = Y.ID_YAZILI

				-----------------
				--YAZILIKADEME2--
				-----------------
				DELETE FROM [dbo].[YaziliKademe2] WHERE ID_YAZILI = @ID_YAZILI
				INSERT INTO [dbo].[YaziliKademe2]
							([ID_YAZILI]
							,[ID_KADEME2])
				select @ID_YAZILI as [ID_YAZILI], value from OPENJSON(@SQLJSON,'$.JSONKADEME2')

				DROP TABLE #TEMPYAZILIGUNCELLE
				SELECT @ID_YAZILI
			END

			IF @ISLEM = 21	--	Yazılı Listele by Sınıf - KOS
			BEGIN
				DECLARE  @ID_DERSLERKOS	VARCHAR(MAX)=@ID_DERSLER	
						,@DONEMKOS		VARCHAR(MAX)=@DONEM
						,@YARIYILKOS	INT			=@YARIYIL
						,@SINIFLARKOS	VARCHAR(MAX)=@SINIFLAR
		
				DROP TABLE IF EXISTS #TCKOS
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TCKOS
				FROM v3Ogrenci	O
				WHERE O.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@SINIFLARKOS))


				IF @ID_DERS IS NULL 
				BEGIN
					SELECT
					(
						Select DISTINCT sr.ID_YAZILI, AD, YAZILITARIH
						from Yazili				SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (@ID_DERSLERKOS IS NULL OR @ID_DERSLERKOS='[]' OR sr.ID_DERS IN (SELECT value FROM OPENJSON(@ID_DERSLERKOS)))
						AND (@YARIYILKOS IS NULL OR @YARIYILKOS=0 OR sr.YARIYIL = @YARIYILKOS)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
				ELSE 
				BEGIN	
					SELECT
					(
						Select DISTINCT SR.ID_YAZILI, AD, YAZILITARIH
						from Yazili SR
						JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI	= SR.ID_YAZILI
						JOIN #TCKOS				T	ON	T.TCKIMLIKNO	= YO.TCKIMLIKNO
						where sr.AKTIF=1 
						AND (sr.ID_DERS = @ID_DERS)
						AND (@YARIYIL IS NULL OR @YARIYIL=0 OR sr.YARIYIL = @YARIYIL)
						AND sr.DONEM=@DONEMKOS
						AND sr.ID_YAZILITURU = 2
						order by YAZILITARIH
						FOR JSON PATH
					) AS J
				END
			
				DROP TABLE IF EXISTS #TCKOS
			END 

			IF @ISLEM = 22	--	KARNEDEGORUNSUN
			BEGIN
				UPDATE Yazili SET KARNEDEGORUNSUN = @KARNEDEGORUNSUN WHERE ID_YAZILI = @ID_YAZILI
			END

			IF @ISLEM=23 -- YY İşlemleri Excelden Toplu sonuç Yükleme Kayıt Kontrol
			BEGIN
				DECLARE @SINAV_DONEM23 INT=0
				DECLARE @SINAV_GRUP23 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM23 = DONEM , @SINAV_GRUP23 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI

					--Hatalı kayıtları listelemek için hata table'ı oluşturuldu.
				DROP TABLE IF EXISTS #HATALI_DATA
				DROP TABLE IF EXISTS #TEMP_EXCEL_OGRENCI_SONUC
				CREATE TABLE #HATALI_DATA(TCKIMLIKNO VARCHAR(11),HATA VARCHAR(100))

				--Jsondan gelen data örneği
				--SET @SQLJSONOGRENCICEVAP ='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'				

			--JSON'dan GELEN DATA TEMP TABLE'A ATILIYOR
				SELECT TCKIMLIKNO,ID_YAZILI,SORU1,SORU2,SORU3,SORU4,SORU5,SORU6,SORU7,SORU8,SORU9,SORU10,SORU11,SORU12,SORU13,SORU14,SORU15,SORU16,SORU17,SORU18,SORU19,SORU20,TELAFI
				INTO #TEMP_EXCEL_OGRENCI_SONUC
				FROM OPENJSON(@SQLJSONOGRENCICEVAP) WITH(TCKIMLIKNO VARCHAR(11),ID_YAZILI INT,SORU1 INT,SORU2 INT,SORU3 INT,SORU4 INT,SORU5 INT,SORU6 INT,SORU7 INT,SORU8 INT,SORU9 INT,SORU10 INT,SORU11 INT,SORU12 INT,SORU13 INT,SORU14 INT,SORU15 INT,SORU16 INT,SORU17 INT,SORU18 INT,SORU19 INT,SORU20 INT,TELAFI INT)

			--TC KONTROL ve Öğrenci tablosunda olmayan kayıtlar Hata tablosuna ekleniyor. 
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Kayıtlı öğrenci değil'
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
				WHERE NOT EXISTS(SELECT TOP 1 1 FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O WHERE O.TCKIMLIKNO = T.TCKIMLIKNO)
			--TC'si Ogrenci tablosunda olmayan Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--Yazılı Donem Kontrolü - Hatalı döneme sahip öğrenciler Hata tablosuna kayıt ediliyor
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Öğrencinin dönemi hatalı' AS HATA
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T
				WHERE NOT EXISTS(	SELECT TOP 1 1 
									FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
									WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
										AND DONEM		= @SINAV_DONEM23
								)
			--Dönemi Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--GRUP Kontrol
				INSERT #HATALI_DATA(TCKIMLIKNO,HATA)
				SELECT T.TCKIMLIKNO,'Öğrencinin grubu hatalı'
				FROM #TEMP_EXCEL_OGRENCI_SONUC AS T 
				WHERE NOT EXISTS(	SELECT TOP 1 1 
									FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] O 
									WHERE	O.TCKIMLIKNO= T.TCKIMLIKNO 
										AND ID_KADEME3	= @SINAV_GRUP23
								)
			--Grubu Hatalı datalar temp tabledan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO

			--MÜKERRER Kayıtlar Belirleniyor 
				INSERT INTO #HATALI_DATA 
				SELECT DISTINCT TCKIMLIKNO, 'Mükerrer Kayıt' 
				FROM #TEMP_EXCEL_OGRENCI_SONUC 
				GROUP BY TCKIMLIKNO 
				HAVING COUNT (TCKIMLIKNO) > 1

			--Mükkerer Kayıtlar TEMP_EXCEL_OGRENCI_SONUC tablosundan siliniyor
				DELETE O
				FROM #TEMP_EXCEL_OGRENCI_SONUC O
				JOIN #HATALI_DATA H ON H.TCKIMLIKNO = O.TCKIMLIKNO
			--Hatalı data tablosu geri JSON olarak dönülüyor
				SELECT * FROM #HATALI_DATA FOR JSON AUTO;

			--Temp table'lar silinyor.
				DROP TABLE #HATALI_DATA
 
			END

			IF @ISLEM=24
			BEGIN
				--@SQLJSONOGRENCICEVAP doğru olarak gelen datalar için CRUD işlemleri yapılıyor
--				DECLARE @SQLJSONOGRENCICEVAP NVARCHAR(MAX)='[{"TCKIMLIKNO":"12538356788","ID_YAZILI":1973,"SORU1":10,"SORU2":9,"SORU3":8,"SORU4":10},{"TCKIMLIKNO":"10057081990","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10022549418","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"12345678912","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10042588862","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"10037805868","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10},{"TCKIMLIKNO":"16076206154","ID_YAZILI":1973,"SORU1":10,"SORU2":10,"SORU3":10,"SORU4":10,"SORU5":10}]'
--DECLARE @ID_YAZILI		INT = 1973
--DECLARE @SINAV_DONEM	INT = 0
--DECLARE @SINAV_GRUP		INT = 0
--DECLARE @TCKIMLIKNO		VARCHAR(MAX) = '32051057542'

				DECLARE @SINAV_DONEM24 INT=0
				DECLARE @SINAV_GRUP24 INT=0

				--Sınavın yapıldığı dönem ve sınavın grubu
				SELECT TOP 1 @SINAV_DONEM24 = DONEM , @SINAV_GRUP24 = ID_KADEME3 from Yazili where ID_YAZILI =  @ID_YAZILI
				
				DROP TABLE IF EXISTS #EXCEL
				CREATE TABLE #EXCEL (
				TCKIMLIKNO	VARCHAR(MAX),
				SORU1		VARCHAR(MAX),
				SORU2		VARCHAR(MAX),
				SORU3		VARCHAR(MAX),
				SORU4		VARCHAR(MAX),
				SORU5		VARCHAR(MAX),
				SORU6		VARCHAR(MAX),
				SORU7		VARCHAR(MAX),
				SORU8		VARCHAR(MAX),
				SORU9		VARCHAR(MAX),
				SORU10		VARCHAR(MAX),
				SORU11		VARCHAR(MAX),
				SORU12		VARCHAR(MAX),
				SORU13		VARCHAR(MAX),
				SORU14		VARCHAR(MAX),
				SORU15		VARCHAR(MAX),
				SORU16		VARCHAR(MAX),
				SORU17		VARCHAR(MAX),
				SORU18		VARCHAR(MAX),
				SORU19		VARCHAR(MAX),
				SORU20		VARCHAR(MAX),
				TELAFI		VARCHAR(MAX),
				ID_YAZILIOGRENCI INT
				)
				​
				INSERT INTO #EXCEL (TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI) 
				SELECT TCKIMLIKNO, SORU1, SORU2, SORU3, SORU4, SORU5, SORU6, SORU7, SORU8, SORU9, SORU10, SORU11, SORU12, SORU13, SORU14, SORU15, SORU16, SORU17, SORU18, SORU19, SORU20,TELAFI
				FROM OPENJSON (@SQLJSONOGRENCICEVAP)
				WITH (
					TCKIMLIKNO	VARCHAR(MAX),
					SORU1		VARCHAR(MAX),
					SORU2		VARCHAR(MAX),
					SORU3		VARCHAR(MAX),
					SORU4		VARCHAR(MAX),
					SORU5		VARCHAR(MAX),
					SORU6		VARCHAR(MAX),
					SORU7		VARCHAR(MAX),
					SORU8		VARCHAR(MAX),
					SORU9		VARCHAR(MAX),
					SORU10		VARCHAR(MAX),
					SORU11		VARCHAR(MAX),
					SORU12		VARCHAR(MAX),
					SORU13		VARCHAR(MAX),
					SORU14		VARCHAR(MAX),
					SORU15		VARCHAR(MAX),
					SORU16		VARCHAR(MAX),
					SORU17		VARCHAR(MAX),
					SORU18		VARCHAR(MAX),
					SORU19		VARCHAR(MAX),
					SORU20		VARCHAR(MAX),
					TELAFI		VARCHAR(MAX)
				)

				--SELECT * FROM #EXCEL

				DROP TABLE IF EXISTS #YAZILISORU
				SELECT * INTO #YAZILISORU FROM YaziliSoru WHERE ID_YAZILI = @ID_YAZILI

				--TCKIMLIKNO ve ID_YAZILI ile daha önce eklenen kayıt var ise durumu pasif'e çekiliyor.
				UPDATE Y SET 
					AKTIF = 0 
				FROM YaziliOgrenci Y 
				INNER JOIN #EXCEL O ON O.TCKIMLIKNO = Y.TCKIMLIKNO
				WHERE Y.ID_YAZILI=@ID_YAZILI
						
				DELETE C
				FROM YaziliOgrenci YO
				JOIN YaziliOgrenciCevap C on C.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF=0

				-- Tüm öğrencilerde dönemi ve grubu olanları al.
				DROP TABLE IF EXISTS #TUM_OGRENCILER
				SELECT DISTINCT TCKIMLIKNO 
				INTO #TUM_OGRENCILER 
				FROM [OkyanusDB].[dbo].[vw_OgrenciDetayTum] 
				WHERE	ID_KADEME3	= @SINAV_GRUP24
					AND DONEM		= @SINAV_DONEM24
					
				--SELECT * FROM #TUM_OGRENCILER
				DECLARE @INSERTTABLO TABLE (ID_YAZILIOGRENCI INT, TCKIMLIKNO VARCHAR(11))
				INSERT INTO YaziliOgrenci(ID_YAZILI,TCKIMLIKNO,KYE_TCKIMLIKNO,KATILMADI,TELAFI)
				OUTPUT inserted.ID_YAZILIOGRENCI,inserted.TCKIMLIKNO INTO @INSERTTABLO(ID_YAZILIOGRENCI,TCKIMLIKNO)
				SELECT	 @ID_YAZILI
						,OT.TCKIMLIKNO
						,@TCKIMLIKNO
						,KATILMADI	= CASE WHEN EXISTS (SELECT TOP 1 1 FROM #EXCEL AS E WHERE E.TCKIMLIKNO = OT.TCKIMLIKNO)
											THEN 0 
											ELSE 1	
										END
						,TELAFI		= (SELECT TOP 1 ISNULL(E.TELAFI,NULL) FROM #EXCEL AS E WHERE OT.TCKIMLIKNO=E.TCKIMLIKNO)
				FROM #TUM_OGRENCILER AS OT

				UPDATE E SET
						E.ID_YAZILIOGRENCI = I.ID_YAZILIOGRENCI
				FROM #EXCEL E
				JOIN  @INSERTTABLO I ON I.TCKIMLIKNO = E.TCKIMLIKNO
 
				DECLARE @sqlCommand varchar(1000)	
				DROP TABLE IF EXISTS #WHILE
				SELECT * INTO #WHILE FROM #YAZILISORU

				WHILE EXISTS( SELECT TOP 1 1 FROM #WHILE)
				BEGIN
					DECLARE @SORUNO VARCHAR(2) = (SELECT TOP 1 CAST(SORUNO AS varchar) FROM #WHILE ORDER BY SORUNO)
					SET @sqlCommand	= 'SELECT SORU'+ @SORUNO  +' FROM #EXCEL ' 
	
					SET @sqlCommand = 
					'	INSERT INTO YaziliOgrenciCevap (ID_YAZILISORU, ID_YAZILIOGRENCI, PUAN)
						SELECT (SELECT TOP 1 ID_YAZILISORU FROM #YAZILISORU YS WHERE YS.SORUNO = '+@SORUNO+') AS ID_YAZILISORU, ID_YAZILIOGRENCI, SORU'+@SORUNO+' FROM #EXCEL'
					EXEC (@sqlCommand)
				​
					DELETE FROM #WHILE WHERE SORUNO = @SORUNO
				END
 
				DROP TABLE #TUM_OGRENCILER					
			END
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_YaziliYoklamaSonuclari]...';


GO
ALTER procedure [dbo].[sp_YaziliYoklamaSonuclari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAVRAPOR		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_DERSLER			VARCHAR(MAX)	= NULL,
	@YARIYIL			VARCHAR(10)		= NULL,
	@ID_SUBE			INT				= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@SUBELER			VARCHAR(MAX)	= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAVRAPOR				= @ID_SINAVRAPOR	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_DERSLER					= @ID_DERSLER		
			,YARIYIL					= @YARIYIL		
			,ID_SUBE					= @ID_SUBE		
			,SINIFLAR					= @SINIFLAR		
			,SUBELER					= @SUBELER		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE
			 @XISLEM			INT				= @ISLEM			
			,@XTCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO	
			,@XTC_OGRENCI		VARCHAR(11)		= @TC_OGRENCI	
			,@XOTURUM			VARCHAR(36)		= @OTURUM		
			,@XIL				VARCHAR(36)		= @IL			
			,@XILCE				VARCHAR(36)		= @ILCE			
			,@XID_MENU			INT				= @ID_MENU		
			,@XDONEM			char(4)			= @DONEM			
			,@XID_KADEME3		INT				= @ID_KADEME3	
			,@XID_SINAVTURU		INT				= @ID_SINAVTURU	
			,@XID_SINAVRAPOR	INT				= @ID_SINAVRAPOR	
			,@XID_SINAV			INT				= @ID_SINAV		
			,@XID_DERS			INT				= @ID_DERS		
			,@XID_DERSLER		VARCHAR(MAX)	= @ID_DERSLER	
			,@XYARIYIL			VARCHAR(10)		= @YARIYIL		
			,@XID_SUBE			INT				= @ID_SUBE		
			,@XSINIFLAR			VARCHAR(MAX)	= @SINIFLAR		
			,@XSUBELER			VARCHAR(MAX)	= @SUBELER		
			,@XDOSYAADI			varchar(100)	= @DOSYAADI		
			,@XDOSYAGUID		varchar(50)		= @DOSYAGUID		
			,@XID_SINAVDOSYA	int				= @ID_SINAVDOSYA	
			,@XSQLJSON			NVARCHAR(MAX)	= @SQLJSON	


		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1)	--	YaziliYoklamaSonuclari						
		BEGIN
			SELECT   Y.ID_YAZILI							AS ID_SINAVRAPOR	
					,K.AD + ' ' + K.SOYAD					AS ADSOYAD	
					,D.DERSAD								AS DERSAD
					,Y.AD									AS SINAVADI
					,Y.YAZILITARIH							AS SINAVTARIH
					,YS.SORUNO
					,CASE WHEN YO.KATILMADI = 1 THEN ISNULL(YOC.PUAN,'-') else ISNULL(CAST(YOC.PUAN AS VARCHAR(10)),'VERİLMEDİ') end AS PUAN
					,DETAYMI = 1
					,ISNULL(SDU.AD, '')						AS KAZANIM
					,YO.KATILMADI
					,ISNULL(YS.PUAN, 0) as PUANDEGERI
					,(SELECT COUNT(1) FROM YaziliSoru SUBYS WHERE SUBYS.ID_YAZILI = Y.ID_YAZILI) AS SORUSAYISI
					,O.TCKIMLIKNO
					,O.ID_SINIF
					,O.ID_SUBE
					,Y.ID_YAZILITURU
					,KB.ID_KADEME
			INTO #GENEL
			FROM Yazili Y 
			INNER JOIN YaziliSoru						YS	ON	YS.ID_YAZILI			= Y.ID_YAZILI
			INNER JOIN YaziliOgrenci					YO	ON	YO.ID_YAZILI			= Y.ID_YAZILI
			LEFT JOIN  YaziliOgrenciCevap				YOC ON	YOC.ID_YAZILIOGRENCI	= YO.ID_YAZILIOGRENCI 
															AND YOC.ID_YAZILISORU		= YS.ID_YAZILISORU
			INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.TCKIMLIKNO			= YO.TCKIMLIKNO
			INNER JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS				= Y.ID_DERS
			LEFT JOIN  OkyanusDB.dbo.v3SinavDersUnite	SDU ON	SDU.KOD					= YS.KOD
			INNER JOIN OkyanusDB.dbo.v3Kullanici		K	ON	K.TCKIMLIKNO			= YO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3KademeBilgi		KB	ON	KB.ID_KADEME3			= Y.ID_KADEME3
			WHERE	YOC.PUAN	IS NOT NULL
				AND Y.AKTIF		= 1 
				AND YO.AKTIF	= 1
				AND Y.ID_YAZILI	= @XID_SINAVRAPOR
			GROUP BY Y.ID_YAZILI, D.DERSAD, Y.AD, Y.YAZILITARIH, YS.SORUNO, YOC.PUAN, YO.KATILMADI, YS.PUAN, K.AD, K.SOYAD, SDU.AD, O.TCKIMLIKNO, O.ID_SUBE, O.ID_SINIF, Y.ID_YAZILITURU, KB.ID_KADEME

			SELECT TCKIMLIKNO, ID_SUBE, ID_SINIF, CONVERT(DECIMAL(18,2), SUM(PUAN)) AS TOPLAMPUAN INTO #OGRENCITOPLAM FROM #GENEL GROUP BY TCKIMLIKNO, ID_SUBE, ID_SINIF

			SELECT	 TCKIMLIKNO
					,TOPLAMPUAN
					,GENELSIRA		= DENSE_RANK() OVER(						ORDER BY TOPLAMPUAN DESC)
					,SUBESIRA		= DENSE_RANK() OVER(PARTITION BY ID_SUBE	ORDER BY TOPLAMPUAN DESC)
					,SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINIF	ORDER BY TOPLAMPUAN DESC) 
			INTO #OGRENCISIRA
			FROM #OGRENCITOPLAM

			DECLARE @GENELORTALAMA DECIMAL(18,2)
			SELECT	@GENELORTALAMA = CONVERT(DECIMAL(18,2), AVG(TOPLAMPUAN))
			FROM #OGRENCITOPLAM

			SELECT ID_SUBE, ORTALAMA = CONVERT(DECIMAL(18,2), AVG(TOPLAMPUAN))
			INTO #SUBEORTALAMA
			FROM #OGRENCITOPLAM
			GROUP BY ID_SUBE

			SELECT ID_SINIF, ORTALAMA = CONVERT(DECIMAL(18,2), AVG(TOPLAMPUAN))
			INTO #SINIFORTALAMA
			FROM #OGRENCITOPLAM
			GROUP BY ID_SINIF

			SELECT   G.*
					,S.GENELSIRA
					,S.SUBESIRA
					,S.SINIFSIRA
					,GENELORTALAMA	= @GENELORTALAMA 
					,SUBEORTALAMA	= SBO.ORTALAMA
					,SINIFORTALAMA	= SNO.ORTALAMA
			INTO #T1
			FROM #GENEL G
			INNER JOIN #OGRENCISIRA S ON S.TCKIMLIKNO = G.TCKIMLIKNO
			INNER JOIN #SUBEORTALAMA SBO ON SBO.ID_SUBE = G.ID_SUBE
			INNER JOIN #SINIFORTALAMA SNO ON SNO.ID_SINIF = G.ID_SINIF
			WHERE G.TCKIMLIKNO = @XTC_OGRENCI

			DROP TABLE #GENEL
			DROP TABLE #OGRENCITOPLAM
			DROP TABLE #OGRENCISIRA
			DROP TABLE #SUBEORTALAMA
			DROP TABLE #SINIFORTALAMA

			select(
				select * from(
					select 
					(						 
						SELECT * FROM #T1
						ORDER BY SORUNO , DETAYMI
						FOR JSON AUTO
					) as t1							
				) as tablo FOR JSON AUTO
			) as tt

			DROP TABLE #T1
		END

		IF (@ISLEM = 2)	--	ÖĞRENCİ SINAV LİSTE							
		BEGIN
			SELECT  Y.ID_YAZILI								AS ID_SINAV	
					,Y.AD		
					,CONVERT(VARCHAR, Y.YAZILITARIH, 104)	AS SINAVTARIH
					,Y.DONEM
					,ISNULL(YO.TELAFI, SUM(YOC.PUAN))		AS PUAN
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			WHERE	YO.TCKIMLIKNO = @TC_OGRENCI AND Y.DONEM = @DONEM AND YO.AKTIF = 1 AND (Y.OVGORSUN = 1 OR @OV = 0) AND Y.ID_YAZILITURU = 1 AND Y.AKTIF = 1
			GROUP BY Y.ID_YAZILI, Y.AD, Y.YAZILITARIH, Y.DONEM, YO.TELAFI
		END

		IF (@ISLEM = 3)	--	GENEL YAZILI YOKLAMA SONUÇLARI				
		BEGIN
			--SELECT	o.ID_OGRENCI,
			--		og.OgrNo,
			--		o.ID_SINIF,
			--		sn.AD AS SINIF,
			--		isnull(k.Ad+' '+k.Soyad,'') AS ADSOYAD,
			--		o.SORUNO,
			--		o.PUAN,
			--		s.PUANDEGERI,
			--		isnull(s.KAZANIM,'') AS KONUKODU,
			--		sb.AD AS SUBE
			--	INTO #OGRENCILER
			--   FROM EOKUL_V2.DBO.OgrenciNot		o
		 --INNER JOIN EOKUL_V2.DBO.SinavRaporDetay s	ON s.ID_SINAVRAPOR=o.ID_SINAVRAPOR and s.SORUNO=o.SORUNO 
		 --INNER JOIN v3Ogrenci								og	ON og.ID_OGRENCI=o.ID_OGRENCI
		 --INNER JOIN v3Kullanici								k	ON k.TCKIMLIKNO=og.TCKIMLIKNO
		 --INNER JOIN v3Sinif									sn	ON sn.ID_SINIF=o.ID_SINIF
		 --INNER JOIN v3Sube									sb	ON sb.ID_SUBE=og.ID_SUBE
			--  WHERE o.ID_SINAVRAPOR=@ID_SINAV
			--	AND o.KATILMADI=0
			--	AND (og.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) or @SUBELER='[]' or @SUBELER is null)
			--	AND ((o.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)) or @SINIFLAR='[]' or @SINIFLAR is null))
			--	AND s.SILINDI=0
			SELECT  O.ID_OGRENCI
					,O.OGRNO
					,O.ID_SINIF
					,S.AD AS SINIF
					,K.AD + ' ' + K.SOYAD AS ADSOYAD
					,YS.SORUNO
					,YOC.PUAN
					,YS.PUAN AS PUANDEGERI
					,ISNULL(SDU.AD, '') AS KONUKODU
					,SB.AD AS SUBE
			INTO #OGRENCILER
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
			LEFT JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
			LEFT JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			WHERE	Y.ID_YAZILI = @ID_SINAV
				AND YO.KATILMADI = 0
				AND (O.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) or @SUBELER='[]' or @SUBELER is null)
				AND ((O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)) or @SINIFLAR='[]' or @SINIFLAR is null))
				AND YO.AKTIF = 1
		   SELECT
		   (
			   SELECT 
			   (
				   SELECT ID_OGRENCI, OgrNo, ID_SINIF, SINIF, ADSOYAD, SORUNO, PUAN, SUBE FROM #OGRENCILER ORDER BY SUBE,ID_SINIF,OgrNo,SORUNO FOR JSON AUTO
			   ) AS ROWS,
			   (
				   SELECT SORUNO, KONUKODU, PUANDEGERI FROM #OGRENCILER GROUP BY SORUNO, KONUKODU, PUANDEGERI ORDER BY SORUNO FOR JSON AUTO
			   ) AS COLS
			   FOR JSON PATH
		   ) AS J
		   DROP TABLE #OGRENCILER
		END

		IF (@ISLEM = 4)	--	GENEL YAZILI YOKLAMA SINAVLARI				
		BEGIN
			--SELECT DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
			--FROM	EOKUL_V2.DBO.OgrenciNot		O			
			--JOIN	EOKUL_V2.DBO.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
			--JOIN	v3Ogrenci								VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
			--JOIN	v3Kullanici								VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
			--WHERE	SR.DONEMKOD=@DONEM
			--	AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
			--	AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			--	AND (@ID_DERS IS NULL OR sr.ID_DERS=@ID_DERS)
			--	AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
			--	AND sr.isActive=1
			SELECT DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
			FROM	EOKUL_V2.DBO.OgrenciNot		O			
			JOIN	EOKUL_V2.DBO.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
			JOIN	v3Ogrenci								VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
			JOIN	v3Kullanici								VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
			WHERE	SR.DONEMKOD=@DONEM
				AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
				AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
				AND (@ID_DERS IS NULL OR sr.ID_DERS=@ID_DERS)
				AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				AND sr.isActive=1
		END

		IF (@ISLEM = 5 OR @ISLEM = 7)	--	ISLEM 3 YENİ SİSTEM			
		BEGIN
			SELECT DISTINCT O.ID_OGRENCI
					,O.OGRNO
					,O.ID_SINIF
					,S.AD AS SINIF
					,K.AD + ' ' +K.SOYAD AS ADSOYAD
					,YS.SORUNO
					,YOC.PUAN
					,YS.PUAN AS PUANDEGERI
					,ISNULL(SDU.AD, '') AS KONUKODU
					,SB.AD AS SUBE
			INTO #YENIOGRENCILER
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
			WHERE Y.ID_YAZILI = @ID_SINAV AND YO.KATILMADI = 0 AND YO.AKTIF = 1
				AND (O.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) or @SUBELER='[]' or @SUBELER is null)
				AND ((O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)) or @SINIFLAR='[]' or @SINIFLAR is null))
			--ORDER BY OGRNO, SORUNO

			IF @ISLEM = 5
			BEGIN
				SELECT
				(
					SELECT 
					(
					SELECT ID_OGRENCI, OgrNo, ID_SINIF, SINIF, ADSOYAD, SORUNO, PUAN, SUBE FROM #YENIOGRENCILER ORDER BY SUBE,ID_SINIF,OgrNo,SORUNO FOR JSON AUTO
					) AS ROWS,
					(
					SELECT SORUNO, KONUKODU, PUANDEGERI FROM #YENIOGRENCILER GROUP BY SORUNO, KONUKODU, PUANDEGERI ORDER BY SORUNO FOR JSON AUTO
					) AS COLS
					FOR JSON PATH
				) AS J
			END
			ELSE
			BEGIN
				SELECT ID_OGRENCI, OgrNo, ID_SINIF, SINIF, ADSOYAD, SORUNO, PUAN, SUBE FROM #YENIOGRENCILER ORDER BY SUBE,ID_SINIF,OgrNo,SORUNO
				SELECT SORUNO, KONUKODU, PUANDEGERI FROM #YENIOGRENCILER GROUP BY SORUNO, KONUKODU, PUANDEGERI ORDER BY SORUNO
			END
			DROP TABLE #YENIOGRENCILER
		END

		IF (@ISLEM = 6)	--	GENEL YAZILI YOKLAMA SINAVLARI YENİ SİSTEM	
		BEGIN
			SELECT DISTINCT SR.ID_SINAVRAPOR ID_SINAV,SR.SINAVADI AD
			FROM	EOKUL_V2.DBO.OgrenciNot		O			
			JOIN	EOKUL_V2.DBO.SinavRapor		sr	ON sr.ID_SINAVRAPOR		=	o.ID_SINAVRAPOR
			JOIN	v3Ogrenci								VO	ON VO.ID_OGRENCI		=	o.ID_OGRENCI
			JOIN	v3Kullanici								VK	ON VO.TCKIMLIKNO		=	VK.TCKIMLIKNO
			WHERE	SR.DONEMKOD=@DONEM
				AND (@ID_KADEME3 IS NULL OR REPLACE(SR.GRUP,' ','')=(SELECT REPLACE(AD,' ','') FROM v3Kademe3 WHERE ID_KADEME3=@ID_KADEME3))
				AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
				AND (@ID_DERS IS NULL OR sr.ID_DERS=@ID_DERS)
				AND (@YARIYIL IS NULL OR sr.DONEMBILGI LIKE '%'+@YARIYIL+'%')
				AND sr.isActive=1
		END

		IF (@ISLEM = 8)	--	KOS RAPORU									
		BEGIN
			DECLARE @YAZILIDONEM VARCHAR(4) = (SELECT DONEM FROM Yazili WHERE ID_YAZILI = @XID_SINAVRAPOR)

			SELECT YS.*
			INTO #YAZILISORU
			FROM Yazili Y 
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			WHERE Y.ID_YAZILI = @XID_SINAVRAPOR

			SELECT   YO.TCKIMLIKNO
					,YS.SORUNO
					,SDU.AD AS KAZANIM
					,YOC.PUAN
					,YS.PUAN AS PUANSORU
					,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
			INTO #YAZILISORUOGRENCI
			FROM #YAZILISORU YS 
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = YS.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			WHERE	YO.ID_YAZILI = @XID_SINAVRAPOR
				AND YO.AKTIF = 1			
				AND YO.KATILMADI = 0
				AND (@XSUBELER IS NULL OR @XSUBELER='[]' OR @XSUBELER='' OR O.ID_SUBE IN (SELECT value FROM OPENJSON(@XSUBELER)))
				AND (@XSINIFLAR IS NULL OR @XSINIFLAR='[]' OR @XSUBELER='' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@XSINIFLAR)))
				AND (@XTC_OGRENCI IS NULL OR @XTC_OGRENCI = '' OR YO.TCKIMLIKNO = @XTC_OGRENCI)

			SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
			INTO #YAZILIOGRENCITOPLAMPUAN
			FROM #YAZILISORUOGRENCI YOS
			GROUP BY YOS.TCKIMLIKNO

			SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
			FROM #YAZILIOGRENCITOPLAMPUAN YOP
			INNER JOIN KosYorum KY ON KY.BASPUAN <= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM = @YAZILIDONEM
			INNER JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
			ORDER BY ADSOYAD

			SELECT	 TCKIMLIKNO
					,SORUNO
					,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
					,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
							WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
							WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
							WHEN PUANORAN < 40						THEN '1'
					 END AS DURUM
			FROM #YAZILISORUOGRENCI

			DROP TABLE #YAZILIOGRENCITOPLAMPUAN
			DROP TABLE #YAZILISORUOGRENCI
			DROP TABLE #YAZILISORU
		END

		IF (@ISLEM = 9)	--	ÖĞRENCİ KOS LİSTE							
		BEGIN
			SELECT
			(
				SELECT DISTINCT Y.ID_YAZILI, Y.AD
				FROM Yazili Y 
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				WHERE YO.TCKIMLIKNO = @TC_OGRENCI AND Y.AKTIF = 1 AND Y.OVGORSUN = 1 AND Y.ID_YAZILITURU = 2 AND YO.AKTIF = 1 AND Y.DONEM = @DONEM
				FOR JSON AUTO
			) AS J
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_YetenekGelisim]...';


GO
ALTER procedure [dbo].[sp_YetenekGelisim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_KATEGORIOGRENCI	INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_KATEGORITAVSIYE	INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,	
	@ACIKLAMA			VARCHAR(MAX)	= NULL,	
	@OGRENCIYILDIZLIST	VARCHAR(MAX)	= NULL,	
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_SINIF					= @ID_SINIF			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_KATEGORIOGRENCI			= @ID_KATEGORIOGRENCI	
			,ID_KATEGORI				= @ID_KATEGORI		
			,ID_KATEGORITAVSIYE			= @ID_KATEGORITAVSIYE	
			,TC_OGRENCI					= @TC_OGRENCI			
			,DONEM						= @DONEM				
			,ID_SINIFs					= @ID_SINIFs			
			,ACIKLAMA					= @ACIKLAMA			
			,OGRENCIYILDIZLIST			= @OGRENCIYILDIZLIST	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	KATEGORİ LİSTESİ			
		BEGIN
			SELECT (
				SELECT K.ID_KATEGORI	'ID_KATEGORI'
					,K.AD				'KATEGORI'
					,Y.ID_KATEGORI		'Y.ID_ALTKATEGORI'
					,Y.ID_USTKATEGORI	'Y.ID_USTKATEGORI'
					,Y.AD				'Y.KATEGORI'
				FROM YG_Kategori K
				LEFT JOIN YG_Kategori Y ON Y.ID_USTKATEGORI = K.ID_KATEGORI
				WHERE	K.ID_USTKATEGORI IS NULL		
				FOR JSON AUTO
			)
		END

		IF @ISLEM = 2	--	OGRENCI 1. SINIF KATEGORI	
		BEGIN

			SELECT @ID_KADEME3= ID_KADEME3 FROM vw_SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF

			IF @ID_KADEME3 = 7	--	1. SINIF
			BEGIN
				select(
						select * from(
							select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.ID_SINIF
										,O.DONEM

										,YK.ID_KATEGORI
										,YK.AD KATEGORI

										,KOY.PUAN

								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON K.TCKIMLIKNO				= O.TCKIMLIKNO
								CROSS JOIN	YG_Kategori				YK	
								LEFT JOIN	YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO			= O.TCKIMLIKNO
																		AND KO.DONEM				= O.DONEM
								LEFT JOIN	YG_KategoriOgrenciYorum	KOY	ON	KOY.ID_KATEGORI			= YK.ID_KATEGORI
																		AND KOY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI										
								WHERE	O.ID_SINIF = @ID_SINIF
									AND YK.ID_USTKATEGORI IS NULL AND YK.ID_KATEGORI NOT IN (13,20)
								ORDER BY ADSOYAD,ID_KATEGORI
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE,
							(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL AND ID_KATEGORI NOT IN (13,20)
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
						) as tablo FOR JSON AUTO
					) as tt
			END	
			ELSE IF @ID_KADEME3 > 7
			BEGIN
				select(
					select * from(
						select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
								FROM v3OgrenciTum				O
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci	KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
																AND KO.DONEM		= O.DONEM
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE						
						) as tablo FOR JSON AUTO
					) as tt

			END
					
		END

		IF @ISLEM = 3	--	YORUM PUAN KAYDET			
		BEGIN
			
					
			SELECT	
				 TCKIMLIKNO	
				,ADSOYAD		
				,ID_SINIF	
				,DONEM		
				,YK.ID_KATEGORI
				,YK.PUAN
				,0 ID_KATEGORIOGRENCI
			INTO #KAYIT
			FROM OPENJSON (@SQLJSON)
			WITH ( 
				TCKIMLIKNO	VARCHAR(11)		'$.TCKIMLIKNO',
				ADSOYAD		VARCHAR(100)	'$.ADSOYAD',
				ID_SINIF	INT				'$.ID_SINIF',
				DONEM		VARCHAR(4)		'$.DONEM',
				YK			NVARCHAR(MAX)	'$.YK' AS JSON
			) AS J
			CROSS APPLY OPENJSON (YK) 
			WITH(
				ID_KATEGORI VARCHAR(11) '$.ID_KATEGORI',
				PUAN		INT			'$.KOY[0].PUAN'
			) AS YK
			WHERE PUAN IS NOT NULL
			

			
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #OGRLIST FROM #KAYIT K JOIN YG_KategoriOgrenci O ON O.TCKIMLIKNO = K.TCKIMLIKNO AND O.DONEM = K.DONEM 
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #EKSIKOGRLIST FROM #KAYIT K WHERE K.TCKIMLIKNO NOT IN (SELECT DISTINCT TCKIMLIKNO FROM #OGRLIST) 
			

			INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,ID_KADEME3,DONEM,TC_OGRETMEN)
			SELECT E.TCKIMLIKNO,S.ID_KADEME3,E.DONEM,@TCKIMLIKNO 
			FROM #EKSIKOGRLIST		 E
			JOIN vw_SubeGrupSinifTum S	ON	S.ID_SINIF	= E.ID_SINIF 
										AND S.ID_KADEME3= 7					--	1. SINIFLAR SADECE 

			UPDATE K SET
				K.ID_KATEGORIOGRENCI = O.ID_KATEGORIOGRENCI
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO
										AND O.DONEM			= K.DONEM


			DELETE Y 
			FROM YG_KategoriOgrenciYorum	Y 
			JOIN #KAYIT						K	ON	K.ID_KATEGORIOGRENCI = Y.ID_KATEGORIOGRENCI
			
			INSERT INTO YG_KategoriOgrenciYorum	 (ID_KATEGORIOGRENCI,ID_KATEGORI,PUAN)
			SELECT K.ID_KATEGORIOGRENCI,K.ID_KATEGORI,K.PUAN 
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci O ON O.ID_KATEGORIOGRENCI = K.ID_KATEGORIOGRENCI

			SELECT 1 

			DROP TABLE #EKSIKOGRLIST
			DROP TABLE #OGRLIST
			DROP TABLE #KAYIT

			


		END

		IF @ISLEM = 4	--	OGRENCI ESKI GELISIMLERI	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
										,KO.DONEM
										,KO.ID_KADEME3 
										,KO.ID_KATEGORITAVSIYE
										,ILKSINIF	= (SELECT   ID_KATEGORI= OY.ID_KATEGORI
																,KATEGORI	= YK.AD
																,PUAN		= OY.PUAN
																,DERECE		= Y.DERECE
														FROM YG_KategoriOgrenciYorum	OY
														JOIN YG_Kategori				YK	ON	YK.ID_KATEGORI	= OY.ID_KATEGORI
														JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI	= OY.ID_KATEGORI
																							AND Y.MIN_YORUM		< OY.PUAN
																							AND Y.MAX_YORUM		> OY.PUAN
														WHERE OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
														ORDER BY ID_KATEGORI
														FOR JSON PATH,INCLUDE_NULL_VALUES
													)
										,DIGER		= (	SELECT	 ID_KATEGORI	= PK.ID_KATEGORI
																,KATEGORI		= PK.AD
																,ID_KATEGORIPUAN= KP.ID_KATEGORIPUAN
																,KATEGORIPUAN	= KP.AD
																,PUAN			= P.PUAN
														FROM YG_KategoriPuan				KP		
														LEFT JOIN YG_KategoriOgrenciPuan	P	ON	KP.ID_KATEGORIPUAN	= P.ID_KATEGORIPUAN
																								AND P.ID_KATEGORIOGRENCI= KO.ID_KATEGORIOGRENCI
														LEFT JOIN YG_Kategori				PK	ON	PK.ID_KATEGORI		= KO.ID_KATEGORI
														ORDER BY ID_KATEGORIPUAN
														FOR JSON AUTO,INCLUDE_NULL_VALUES
													)			
										,OK.AD+' ' + OK.SOYAD OGRETMENADSOYAD
										,KADEME3	= K3.AD
								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN v3Kullanici				OK	ON	OK.TCKIMLIKNO	= KO.TC_OGRETMEN
								LEFT JOIN v3Kademe3					K3	ON	K3.ID_KADEME3	= KO.ID_KADEME3
								WHERE O.TCKIMLIKNO	= @TC_OGRENCI 
									AND ID_SINIF	= @ID_SINIF
								ORDER BY ADSOYAD,KO.DONEM
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS  OGRENCIGECMIS
							,(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL		
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
							,(
								SELECT	 K.ID_KATEGORIPUAN	'ID_KATEGORIPUAN'
										,K.AD				'KATEGORIPUAN'
										,PUAN	=0
								FROM YG_KategoriPuan K								
								ORDER BY ID_KATEGORIPUAN
								FOR JSON PATH
							) AS  KATEGORIPUAN
							,(								
								SELECT *
								FROM YG_Kategori		K
								LEFT JOIN (
									SELECT *
									FROM YG_Kategori
									WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
								)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
								WHERE K.ID_USTKATEGORI IS NULL
								ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
								FOR JSON AUTO
							) AS YETENEKDERSLIST
							,(								
								SELECT * FROM YG_KateroriTavsiye 
								ORDER BY ID_KATEGORITAVSIYE
								FOR JSON AUTO
							) AS KATEGORITAVSIYELIST
							,(								
								SELECT @DONEM AKTIFDONEM
								FOR JSON PATH
							) AS AKTIFDONEM
						) as tablo FOR JSON AUTO
					) as tt

		END

		IF @ISLEM = 5	--	KARNE						
		BEGIN
			
			SELECT @ID_KADEME3 = ID_KADEME3
			FROM YG_KategoriOgrenci
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI 

			SELECT 
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,OGRETMENADSOYAD= ORT.AD+' '+ORT.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= CASE WHEN @ID_KADEME3 = 7 THEN 'MY TALENT JOURNEY' ELSE ISNULL(K.AD,'') END
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN v3Kullanici			ORT ON	ORT.TCKIMLIKNO	= KO.TC_OGRETMEN
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	KO.ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
					AND K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
													AND KO.ID_KATEGORIOGRENCI	= @ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END


		END

		IF @ISLEM = 6	--	PUAN KAYDET					
		BEGIN
		
			SET @ID_KADEME3	= (SELECT ID_KADEME3 FROM v3Ogrenci O JOIN vw_SubeGrupSinif GS ON GS.ID_SINIF = O.ID_SINIF WHERE TCKIMLIKNO = @TC_OGRENCI)
			IF @ID_KADEME3 IS NOT NULL
			BEGIN
				SET @ID_KATEGORIOGRENCI = (SELECT ID_KATEGORIOGRENCI FROM YG_KategoriOgrenci KO WHERE KO.TCKIMLIKNO = @TC_OGRENCI AND KO.DONEM = @DONEM)

				DELETE OP 
				FROM YG_KategoriOgrenciPuan OP
				WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

				IF @ID_KATEGORIOGRENCI IS NULL
				BEGIN
					DECLARE @IDTABLE TABLE (ID INT)

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,DONEM,ID_KADEME3,ID_KATEGORI,TC_OGRETMEN,ID_KATEGORITAVSIYE)
					OUTPUT (inserted.ID_KATEGORIOGRENCI) INTO @IDTABLE
					VALUES (@TC_OGRENCI,@DONEM,@ID_KADEME3,@ID_KATEGORI,@TCKIMLIKNO,@ID_KATEGORITAVSIYE)

					SET @ID_KATEGORIOGRENCI = (SELECT TOP 1 ID FROM @IDTABLE)
				END
				ELSE
				BEGIN
					UPDATE YG_KategoriOgrenci SET
						ID_KATEGORI = @ID_KATEGORI,
						TC_OGRETMEN = @TCKIMLIKNO,
						ID_KATEGORITAVSIYE = @ID_KATEGORITAVSIYE
					WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
				END

			
				INSERT INTO YG_KategoriOgrenciPuan 
						(ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN)			
				SELECT	@ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN  
				FROM OPENJSON(@OGRENCIYILDIZLIST)
				WITH (
					ID_KATEGORIPUAN INT,
					PUAN			INT
				)

				SELECT 1 			
			END
			ELSE
				SELECT 0

		END
		
		IF @ISLEM = 7	--	TOPLU KARNE					
		BEGIN
			
			SELECT YO.ID_KATEGORIOGRENCI, ID_KADEME3
			INTO #OGRECILIST7
			FROM YG_KategoriOgrenci	YO
			JOIN v3OgrenciTum		OT	ON	OT.TCKIMLIKNO	= YO.TCKIMLIKNO
										AND OT.DONEM		= YO.DONEM
			WHERE OT.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			
			SELECT TOP 1 @ID_KADEME3 = ID_KADEME3
			FROM #OGRECILIST7

			SELECT DISTINCT
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= ISNULL(K.AD,'')
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN #OGRECILIST7			OL	ON	OL.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END

			DROP TABLE IF EXISTS #OGRECILIST7

		END

		IF @ISLEM = 8	--	YETENEK GELİŞİM KATEGORILER	
		BEGIN
			SELECT ISNULL((	SELECT *
							FROM YG_Kategori		K
							LEFT JOIN (
								SELECT *
								FROM YG_Kategori
								WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
							)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
							WHERE K.ID_USTKATEGORI IS NULL
							ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
							FOR JSON AUTO
						),'[]' )AS YETENEKDERSLIST
		END

		IF @ISLEM = 9	--	YG DERS ACIKLAMA EKLE		
		BEGIN
			UPDATE YG_Kategori SET 
				ACIKLAMA = CASE WHEN @ACIKLAMA = '' THEN NULL ELSE @ACIKLAMA END 
			WHERE ID_KATEGORI = @ID_KATEGORI
		END

		IF @ISLEM = 10	--	YG DERS ACIKLAMA GETİR		
		BEGIN
			SELECT ISNULL((
				SELECT	 ID_KATEGORI
						,ISNULL(ACIKLAMA,'') AS ACIKLAMA 
				FROM YG_Kategori  
				WHERE ID_KATEGORI = @ID_KATEGORI 
				FOR JSON AUTO, INCLUDE_NULL_VALUES
			),'[]' )
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_YG_Karne]...';


GO
ALTER procedure [dbo].[sp_YG_Karne]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINIF					= @ID_SINIF	
			,TC_OGRENCI					= @TC_OGRENCI	
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	OGRENCI LIST
		BEGIN
			select 
			(		
				SELECT	 O.TCKIMLIKNO
						,O.ID_SINIF
						,O.DONEM
						,ADSOYAD			= K.AD+' ' + K.SOYAD
						,ID_KATEGORIOGRENCI	= ISNULL(KO.ID_KATEGORIOGRENCI,0)
						,SINIFAD			= GS.SINIF
						,GS.SUBEAD
						,GS.ID_KADEME3
				FROM v3OgrenciTum					O
				JOIN v3Kullanici					K	ON K.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN vw_SubeGrupSinifTum			GS	ON	GS.ID_SINIF		= O.ID_SINIF
				LEFT JOIN	YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
														AND KO.DONEM		= O.DONEM
														AND (	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciYorum	Y WHERE Y.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
															OR	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciPuan	P WHERE P.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
															)															
				WHERE	O.ID_SINIF = @ID_SINIF						
				ORDER BY ADSOYAD
				FOR JSON PATH,INCLUDE_NULL_VALUES
			) AS OGRENCILISTE
		END

		IF @ISLEM = 2	--	OGRENCI KARNE LIST
		BEGIN
			SELECT 
			(		
				SELECT	 O.TCKIMLIKNO
						,O.ID_SINIF
						,O.DONEM
						,ADSOYAD			= K.AD+' ' + K.SOYAD 
						,ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
						,SINIFAD			= GS.SINIF
						,GS.SUBEAD
						,GS.ID_KADEME3
				FROM v3OgrenciTum			O
				JOIN v3Kullanici			K	ON K.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
				JOIN YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
												AND KO.DONEM		= O.DONEM
				WHERE	O.TCKIMLIKNO = @TC_OGRENCI
					AND (	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciYorum	Y WHERE Y.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
						OR	EXISTS (SELECT TOP 1 1 FROM YG_KategoriOgrenciPuan	P WHERE P.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI)
						)
				ORDER BY DONEM DESC
				FOR JSON PATH,INCLUDE_NULL_VALUES
			) AS OGRENCILISTE
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_YG_YetenekGelisim]...';


GO
ALTER procedure [dbo].[sp_YG_YetenekGelisim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_KATEGORIOGRENCI	INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_KATEGORITAVSIYE	INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,	
	@ACIKLAMA			VARCHAR(MAX)	= NULL,	
	@OGRENCIYILDIZLIST	VARCHAR(MAX)	= NULL,	
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_SINIF					= @ID_SINIF			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_KATEGORIOGRENCI			= @ID_KATEGORIOGRENCI	
			,ID_KATEGORI				= @ID_KATEGORI		
			,ID_KATEGORITAVSIYE			= @ID_KATEGORITAVSIYE	
			,TC_OGRENCI					= @TC_OGRENCI			
			,DONEM						= @DONEM				
			,ID_SINIFs					= @ID_SINIFs			
			,ACIKLAMA					= @ACIKLAMA			
			,OGRENCIYILDIZLIST			= @OGRENCIYILDIZLIST	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	KATEGORİ LİSTESİ			
		BEGIN
			SELECT (
				SELECT K.ID_KATEGORI	'ID_KATEGORI'
					,K.AD				'KATEGORI'
					,Y.ID_KATEGORI		'Y.ID_ALTKATEGORI'
					,Y.ID_USTKATEGORI	'Y.ID_USTKATEGORI'
					,Y.AD				'Y.KATEGORI'
				FROM YG_Kategori K
				LEFT JOIN YG_Kategori Y ON Y.ID_USTKATEGORI = K.ID_KATEGORI
				WHERE	K.ID_USTKATEGORI IS NULL		
				FOR JSON AUTO
			)
		END

		IF @ISLEM = 2	--	OGRENCI 1. SINIF KATEGORI	
		BEGIN

			SELECT @ID_KADEME3= ID_KADEME3 FROM vw_SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF

			IF @ID_KADEME3 = 7	--	1. SINIF
			BEGIN
				select(
						select * from(
							select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.ID_SINIF
										,O.DONEM

										,YK.ID_KATEGORI
										,YK.AD KATEGORI

										,KOY.PUAN

								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON K.TCKIMLIKNO				= O.TCKIMLIKNO
								CROSS JOIN	YG_Kategori				YK	
								LEFT JOIN	YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO			= O.TCKIMLIKNO
																		AND KO.DONEM				= O.DONEM
								LEFT JOIN	YG_KategoriOgrenciYorum	KOY	ON	KOY.ID_KATEGORI			= YK.ID_KATEGORI
																		AND KOY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI										
								WHERE	O.ID_SINIF = @ID_SINIF
									AND YK.ID_USTKATEGORI IS NULL AND YK.ID_KATEGORI NOT IN (13,20)
								ORDER BY ADSOYAD,ID_KATEGORI
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE,
							(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL AND ID_KATEGORI NOT IN (13,20)
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
						) as tablo FOR JSON AUTO
					) as tt
			END	
			ELSE IF @ID_KADEME3 > 7
			BEGIN
				select(
					select * from(
						select 
							(		
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
								FROM v3OgrenciTum				O
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci	KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
																AND KO.DONEM		= O.DONEM
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS OGRENCILISTE						
						) as tablo FOR JSON AUTO
					) as tt

			END
					
		END

		IF @ISLEM = 3	--	YORUM PUAN KAYDET			
		BEGIN
			
					
			SELECT	
				 TCKIMLIKNO	
				,ADSOYAD		
				,ID_SINIF	
				,DONEM		
				,YK.ID_KATEGORI
				,YK.PUAN
				,0 ID_KATEGORIOGRENCI
			INTO #KAYIT
			FROM OPENJSON (@SQLJSON)
			WITH ( 
				TCKIMLIKNO	VARCHAR(11)		'$.TCKIMLIKNO',
				ADSOYAD		VARCHAR(100)	'$.ADSOYAD',
				ID_SINIF	INT				'$.ID_SINIF',
				DONEM		VARCHAR(4)		'$.DONEM',
				YK			NVARCHAR(MAX)	'$.YK' AS JSON
			) AS J
			CROSS APPLY OPENJSON (YK) 
			WITH(
				ID_KATEGORI VARCHAR(11) '$.ID_KATEGORI',
				PUAN		INT			'$.KOY[0].PUAN'
			) AS YK
			WHERE PUAN IS NOT NULL
			

			
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #OGRLIST FROM #KAYIT K JOIN YG_KategoriOgrenci O ON O.TCKIMLIKNO = K.TCKIMLIKNO AND O.DONEM = K.DONEM 
			SELECT DISTINCT K.TCKIMLIKNO,K.DONEM,K.ID_SINIF INTO #EKSIKOGRLIST FROM #KAYIT K WHERE K.TCKIMLIKNO NOT IN (SELECT DISTINCT TCKIMLIKNO FROM #OGRLIST) 
			

			INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,ID_KADEME3,DONEM,TC_OGRETMEN)
			SELECT E.TCKIMLIKNO,S.ID_KADEME3,E.DONEM,@TCKIMLIKNO 
			FROM #EKSIKOGRLIST		 E
			JOIN vw_SubeGrupSinifTum S	ON	S.ID_SINIF	= E.ID_SINIF 
										AND S.ID_KADEME3= 7					--	1. SINIFLAR SADECE 

			UPDATE K SET
				K.ID_KATEGORIOGRENCI = O.ID_KATEGORIOGRENCI
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO
										AND O.DONEM			= K.DONEM


			DELETE Y 
			FROM YG_KategoriOgrenciYorum	Y 
			JOIN #KAYIT						K	ON	K.ID_KATEGORIOGRENCI = Y.ID_KATEGORIOGRENCI
			
			INSERT INTO YG_KategoriOgrenciYorum	 (ID_KATEGORIOGRENCI,ID_KATEGORI,PUAN)
			SELECT K.ID_KATEGORIOGRENCI,K.ID_KATEGORI,K.PUAN 
			FROM #KAYIT K
			JOIN YG_KategoriOgrenci O ON O.ID_KATEGORIOGRENCI = K.ID_KATEGORIOGRENCI

			SELECT 1 

			DROP TABLE #EKSIKOGRLIST
			DROP TABLE #OGRLIST
			DROP TABLE #KAYIT

			


		END

		IF @ISLEM = 4	--	OGRENCI ESKI GELISIMLERI	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT	 O.TCKIMLIKNO
										,K.AD+' ' + K.SOYAD ADSOYAD
										,O.DONEM
										,O.ID_SINIF
										,KO.ID_KATEGORIOGRENCI
										,KO.DONEM
										,KO.ID_KADEME3 
										,KO.ID_KATEGORITAVSIYE
										,ILKSINIF	= (SELECT   ID_KATEGORI= OY.ID_KATEGORI
																,KATEGORI	= YK.AD
																,PUAN		= OY.PUAN
																,DERECE		= Y.DERECE
														FROM YG_KategoriOgrenciYorum	OY
														JOIN YG_Kategori				YK	ON	YK.ID_KATEGORI	= OY.ID_KATEGORI
														JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI	= OY.ID_KATEGORI
																							AND Y.MIN_YORUM		< OY.PUAN
																							AND Y.MAX_YORUM		> OY.PUAN
														WHERE OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
														ORDER BY ID_KATEGORI
														FOR JSON PATH,INCLUDE_NULL_VALUES
													)
										,DIGER		= (	SELECT	 ID_KATEGORI	= PK.ID_KATEGORI
																,KATEGORI		= PK.AD
																,ID_KATEGORIPUAN= KP.ID_KATEGORIPUAN
																,KATEGORIPUAN	= KP.AD
																,PUAN			= P.PUAN
														FROM YG_KategoriPuan				KP		
														LEFT JOIN YG_KategoriOgrenciPuan	P	ON	KP.ID_KATEGORIPUAN	= P.ID_KATEGORIPUAN
																								AND P.ID_KATEGORIOGRENCI= KO.ID_KATEGORIOGRENCI
														LEFT JOIN YG_Kategori				PK	ON	PK.ID_KATEGORI		= KO.ID_KATEGORI
														ORDER BY ID_KATEGORIPUAN
														FOR JSON AUTO,INCLUDE_NULL_VALUES
													)			
										,OK.AD+' ' + OK.SOYAD OGRETMENADSOYAD
										,KADEME3	= K3.AD
								FROM v3OgrenciTum					O
								JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN YG_KategoriOgrenci		KO	ON	KO.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN v3Kullanici				OK	ON	OK.TCKIMLIKNO	= KO.TC_OGRETMEN
								LEFT JOIN v3Kademe3					K3	ON	K3.ID_KADEME3	= KO.ID_KADEME3
								WHERE O.TCKIMLIKNO	= @TC_OGRENCI 
									AND ID_SINIF	= @ID_SINIF
								ORDER BY ADSOYAD,KO.DONEM
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) AS  OGRENCIGECMIS
							,(
								SELECT K.ID_KATEGORI	'ID_KATEGORI'
									,K.AD				'KATEGORI'
								FROM YG_Kategori K
								WHERE K.ID_USTKATEGORI IS NULL		
								ORDER BY ID_KATEGORI
								FOR JSON AUTO
							) AS  KATEGORILISTE
							,(
								SELECT	 K.ID_KATEGORIPUAN	'ID_KATEGORIPUAN'
										,K.AD				'KATEGORIPUAN'
										,PUAN	=0
								FROM YG_KategoriPuan K								
								ORDER BY ID_KATEGORIPUAN
								FOR JSON PATH
							) AS  KATEGORIPUAN
							,(								
								SELECT *
								FROM YG_Kategori		K
								LEFT JOIN (
									SELECT *
									FROM YG_Kategori
									WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
								)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
								WHERE K.ID_USTKATEGORI IS NULL
								ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
								FOR JSON AUTO
							) AS YETENEKDERSLIST
							,(								
								SELECT * FROM YG_KateroriTavsiye 
								ORDER BY ID_KATEGORITAVSIYE
								FOR JSON AUTO
							) AS KATEGORITAVSIYELIST
							,(								
								SELECT @DONEM AKTIFDONEM
								FOR JSON PATH
							) AS AKTIFDONEM
						) as tablo FOR JSON AUTO
					) as tt

		END

		IF @ISLEM = 5	--	KARNE						
		BEGIN
			
			SELECT @ID_KADEME3 = ID_KADEME3
			FROM YG_KategoriOgrenci
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI 

			SELECT 
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,OGRETMENADSOYAD= ORT.AD+' '+ORT.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= CASE WHEN @ID_KADEME3 = 7 THEN 'MY TALENT JOURNEY' ELSE ISNULL(K.AD,'') END
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN v3Kullanici			ORT ON	ORT.TCKIMLIKNO	= KO.TC_OGRETMEN
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	KO.ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
					AND K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
													AND KO.ID_KATEGORIOGRENCI	= @ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END


		END

		IF @ISLEM = 6	--	PUAN KAYDET					
		BEGIN
		
			SET @ID_KADEME3	= (SELECT ID_KADEME3 FROM v3Ogrenci O JOIN vw_SubeGrupSinif GS ON GS.ID_SINIF = O.ID_SINIF WHERE TCKIMLIKNO = @TC_OGRENCI)
			IF @ID_KADEME3 IS NOT NULL
			BEGIN
				SET @ID_KATEGORIOGRENCI = (SELECT ID_KATEGORIOGRENCI FROM YG_KategoriOgrenci KO WHERE KO.TCKIMLIKNO = @TC_OGRENCI AND KO.DONEM = @DONEM)

				DELETE OP 
				FROM YG_KategoriOgrenciPuan OP
				WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI

				IF @ID_KATEGORIOGRENCI IS NULL
				BEGIN
					DECLARE @IDTABLE TABLE (ID INT)

					INSERT INTO YG_KategoriOgrenci (TCKIMLIKNO,DONEM,ID_KADEME3,ID_KATEGORI,TC_OGRETMEN,ID_KATEGORITAVSIYE)
					OUTPUT (inserted.ID_KATEGORIOGRENCI) INTO @IDTABLE
					VALUES (@TC_OGRENCI,@DONEM,@ID_KADEME3,@ID_KATEGORI,@TCKIMLIKNO,@ID_KATEGORITAVSIYE)

					SET @ID_KATEGORIOGRENCI = (SELECT TOP 1 ID FROM @IDTABLE)
				END
				ELSE
				BEGIN
					UPDATE YG_KategoriOgrenci SET
						ID_KATEGORI = @ID_KATEGORI,
						TC_OGRETMEN = @TCKIMLIKNO,
						ID_KATEGORITAVSIYE = @ID_KATEGORITAVSIYE
					WHERE ID_KATEGORIOGRENCI = @ID_KATEGORIOGRENCI
				END

			
				INSERT INTO YG_KategoriOgrenciPuan 
						(ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN)			
				SELECT	@ID_KATEGORIOGRENCI, ID_KATEGORIPUAN, PUAN  
				FROM OPENJSON(@OGRENCIYILDIZLIST)
				WITH (
					ID_KATEGORIPUAN INT,
					PUAN			INT
				)

				SELECT 1 			
			END
			ELSE
				SELECT 0

		END
		
		IF @ISLEM = 7	--	TOPLU KARNE					
		BEGIN
			
			SELECT YO.ID_KATEGORIOGRENCI, ID_KADEME3
			INTO #OGRECILIST7
			FROM YG_KategoriOgrenci	YO
			JOIN v3OgrenciTum		OT	ON	OT.TCKIMLIKNO	= YO.TCKIMLIKNO
										AND OT.DONEM		= YO.DONEM
			WHERE OT.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			
			SELECT TOP 1 @ID_KADEME3 = ID_KADEME3
			FROM #OGRECILIST7

			SELECT DISTINCT
				 KO.TCKIMLIKNO
				,SUBEAD			= 'OKYANUS KOLEJİ '+UPPER(GS.SUBEAD) +' KAMPÜSÜ'
				,ADSOYAD		= OK.AD+' '+OK.SOYAD
				,SINIFAD		= GS.SINIF
				,KATEGORIAD		= ISNULL(K.AD,'')
				,ID_KATEGORI	= ISNULL(K.ID_USTKATEGORI,0)
				,DONEMBASLIK	= KO.DONEM + ' - '+ CAST((CAST(KO.DONEM AS INT)+1) AS VARCHAR) + ' YILI'
			FROM YG_KategoriOgrenci		KO
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= KO.TCKIMLIKNO
											AND O.DONEM			= KO.DONEM
			JOIN v3Kullanici			OK	ON	OK.TCKIMLIKNO	= KO.TCKIMLIKNO
			JOIN vw_SubeGrupSinifTum	GS	ON	GS.ID_SINIF		= O.ID_SINIF
			JOIN #OGRECILIST7			OL	ON	OL.ID_KATEGORIOGRENCI = KO.ID_KATEGORIOGRENCI
			LEFT JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= KO.ID_KATEGORI
			

			IF @ID_KADEME3 = 7 
			BEGIN
	

				SELECT 
					 KO.TCKIMLIKNO
					,K.ID_KATEGORI
					,KATEGORIAD	= K.AD
					,DERECE		= Y.DERECE
					,PUAN		= OY.PUAN
					,YORUM		= Y.YORUM
				FROM YG_KategoriOgrenci			KO
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_KategoriOgrenciYorum	OY	ON	OY.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= OY.ID_KATEGORI
				JOIN YG_KategoriYorum			Y	ON	Y.ID_KATEGORI			= OY.ID_KATEGORI
													AND Y.MIN_YORUM				<= OY.PUAN
													AND Y.MAX_YORUM				>= OY.PUAN
				WHERE	K.ID_USTKATEGORI IS NULL AND K.ID_KATEGORI NOT IN (13,20)
				ORDER BY K.ID_KATEGORI

			END
			ELSE IF @ID_KADEME3 > 7
			BEGIN
	
				SELECT 
					 KO.TCKIMLIKNO
					,P.ID_KATEGORIPUAN
					,PUANAD		= P.AD
					,PUAN		= ISNULL(OP.PUAN,0)
					,KT.ID_KATEGORITAVSIYE
				FROM YG_KategoriPuan			P
				JOIN YG_KategoriOgrenciPuan		OP	ON	P.ID_KATEGORIPUAN		= OP.ID_KATEGORIPUAN
				JOIN YG_KategoriOgrenci			KO	ON	OP.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI	 
				JOIN #OGRECILIST7				OL	ON	OL.ID_KATEGORIOGRENCI	= KO.ID_KATEGORIOGRENCI
				JOIN YG_Kategori				K	ON	K.ID_KATEGORI			= KO.ID_KATEGORI	
				LEFT JOIN YG_KateroriTavsiye	KT	ON	KT.ID_KATEGORITAVSIYE	= KO.ID_KATEGORITAVSIYE
				ORDER BY P.ID_KATEGORIPUAN
	
			END

			DROP TABLE IF EXISTS #OGRECILIST7

		END

		IF @ISLEM = 8	--	YETENEK GELİŞİM KATEGORILER	
		BEGIN
			SELECT ISNULL((	SELECT *
							FROM YG_Kategori		K
							LEFT JOIN (
								SELECT *
								FROM YG_Kategori
								WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
							)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
							WHERE K.ID_USTKATEGORI IS NULL
							ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
							FOR JSON AUTO
						),'[]' )AS YETENEKDERSLIST
		END

		IF @ISLEM = 9	--	YG DERS ACIKLAMA EKLE		
		BEGIN
			UPDATE YG_Kategori SET 
				ACIKLAMA = CASE WHEN @ACIKLAMA = '' THEN NULL ELSE @ACIKLAMA END 
			WHERE ID_KATEGORI = @ID_KATEGORI
		END

		IF @ISLEM = 10	--	YG DERS ACIKLAMA GETİR		
		BEGIN
			SELECT ISNULL((
				SELECT	 ID_KATEGORI
						,ISNULL(ACIKLAMA,'') AS ACIKLAMA 
				FROM YG_Kategori  
				WHERE ID_KATEGORI = @ID_KATEGORI 
				FOR JSON AUTO, INCLUDE_NULL_VALUES
			),'[]' )
		END

		IF @ISLEM = 11	--	YG DERS LİSTE GETİR			
		BEGIN
			SELECT ISNULL((
				SELECT *
				FROM YG_Kategori		K
				LEFT JOIN (
					SELECT *
					FROM YG_Kategori
					WHERE ID_KATEGORI NOT IN (SELECT DISTINCT ID_USTKATEGORI FROM YG_Kategori WHERE ID_USTKATEGORI IS NOT NULL)		
				)	A	ON	A.ID_USTKATEGORI	= K.ID_KATEGORI OR A.ID_KATEGORI = K.ID_KATEGORI
				WHERE K.ID_USTKATEGORI IS NULL
				ORDER BY K.ID_KATEGORI,A.ID_KATEGORI
				FOR JSON AUTO
			),'[]' )
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_YG_YorumEkle]...';


GO
ALTER procedure [dbo].[sp_YG_YorumEkle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_KATEGORIOGRENCI	INT				= NULL,
	@ID_KATEGORI		INT				= NULL,
	@ID_KATEGORITAVSIYE	INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@OGRENCIYILDIZLIST	VARCHAR(MAX)	= NULL,	
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_SINIF					= @ID_SINIF			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_KATEGORIOGRENCI			= @ID_KATEGORIOGRENCI	
			,ID_KATEGORI				= @ID_KATEGORI		
			,ID_KATEGORITAVSIYE			= @ID_KATEGORITAVSIYE	
			,TC_OGRENCI					= @TC_OGRENCI			
			,DONEM						= @DONEM				
			,OGRENCIYILDIZLIST			= @OGRENCIYILDIZLIST	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	KATEGORİ YORUM LİSTESİ
		BEGIN
			SELECT (				
				SELECT DISTINCT Y.ID_KATEGORI
					,KATEGORIAD = K.AD
					,SY.ID_KATEGORIYORUM
					,SY.MIN_YORUM
					,SY.MAX_YORUM
					,SY.DERECE
					,SY.YORUM
				FROM YG_KategoriYorum	Y
				JOIN YG_KategoriYorum	SY	ON	SY.ID_KATEGORI	= Y.ID_KATEGORI
				JOIN YG_Kategori		K	ON	K.ID_KATEGORI	= Y.ID_KATEGORI
				FOR JSON AUTO
			) AS S
		END

		IF @ISLEM = 2	--	KATEGORI YORUM UPDATE
		BEGIN			

			SELECT SY.* 
			INTO #TEMP
			FROM OPENJSON (@SQLJSON)
			WITH( 
				ID_KATEGORI INT,
				SY			NVARCHAR(MAX)	'$.K[0].SY' AS JSON
			) AS J
			CROSS APPLY OPENJSON (J.SY)
			WITH (
				ID_KATEGORIYORUM	INT
				,MIN_YORUM			INT
				,MAX_YORUM			INT
				,DERECE				INT
				,YORUM				VARCHAR(MAX)
			) AS SY

			UPDATE Y SET
				 Y.DERECE		= T.DERECE
				,Y.MIN_YORUM	= T.MIN_YORUM
				,Y.MAX_YORUM	= T.MAX_YORUM
				,Y.YORUM		= T.YORUM
			FROM YG_KategoriYorum	Y
			JOIN #TEMP				T	ON	T.ID_KATEGORIYORUM = Y.ID_KATEGORIYORUM

			DROP TABLE IF EXISTS #TEMP

			SELECT 1

		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_ZekaTest]...';


GO
ALTER procedure [dbo].[sp_ZekaTest]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@TCKIMLIKNO_OGR				VARCHAR(11)		= NULL,
	@ID_ZEKATEST				INT				= NULL,
	@SQLJSON_SORU				VARCHAR(MAX)	= NULL,
	@SQLJSON_OGRENCI			VARCHAR(MAX)	= NULL,
	@DOSYAAD					VARCHAR(MAX)	= NULL,
	@DOSYAGUID					VARCHAR(MAX)	= NULL,
	@DOSYATIP					VARCHAR(MAX)	= NULL,
	@ID_ZEKATESTOGRENCIDOSYA	INT				= NULL,
	@LISTELEMETIPI				BIT				= NULL,
	@ID_ZEKATESTOGRENCIZEKATEST	INT				= NULL,
	@SQLJSON					VARCHAR(MAX)	= '',
	@TESTTARIHI1				VARCHAR(MAX)	= '',
	@TESTTARIHI2				VARCHAR(MAX)	= '',
	@SEARCH						VARCHAR(MAX)	= '',
	@ORDERCOLEXCEL				VARCHAR(MAX)	= '',
	@ORDERDIREXCEL				VARCHAR(MAX)	= '',
	@DURUM						INT				= 1,
	@ID_ZEKATESTOGRENCIDOSYATUR	INT				= 1
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM								= @ISLEM						
			,TCKIMLIKNO							= @TCKIMLIKNO					
			,OTURUM								= @OTURUM						
			,ID_MENU							= @ID_MENU					
			,TCKIMLIKNO_OGR						= @TCKIMLIKNO_OGR				
			,ID_ZEKATEST						= @ID_ZEKATEST				
			,SQLJSON_SORU						= @SQLJSON_SORU				
			,SQLJSON_OGRENCI					= @SQLJSON_OGRENCI			
			,DOSYAAD							= @DOSYAAD					
			,DOSYAGUID							= @DOSYAGUID					
			,DOSYATIP							= @DOSYATIP					
			,ID_ZEKATESTOGRENCIDOSYA			= @ID_ZEKATESTOGRENCIDOSYA	
			,LISTELEMETIPI						= @LISTELEMETIPI				
			,ID_ZEKATESTOGRENCIZEKATEST			= @ID_ZEKATESTOGRENCIZEKATEST
			,SQLJSON							= @SQLJSON					
			,TESTTARIHI1						= @TESTTARIHI1				
			,TESTTARIHI2						= @TESTTARIHI2				
			,SEARCH								= @SEARCH						
			,ORDERCOLEXCEL						= @ORDERCOLEXCEL				
			,ORDERDIREXCEL						= @ORDERDIREXCEL				
			,DURUM								= @DURUM						
			,ID_ZEKATESTOGRENCIDOSYATUR			= @ID_ZEKATESTOGRENCIDOSYATUR
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG = 1
		BEGIN
			IF @ISLEM = 1	--	ZEKA TEST LİSTELE
			BEGIN
				SELECT
				(
					SELECT *
					FROM ZekaTest
					FOR JSON AUTO
				) AS J
			END

			IF @ISLEM = 2	--	ÖĞRENCİ ARA
			BEGIN
				SELECT DISTINCT
						 O.ID_ZEKATESTOGRENCI
						,O.TCKIMLIKNO
						,O.AD
						,O.SOYAD
						,DATEPART(YEAR, O.DOGUMTARIHI) AS DOGUMYIL
						,DATEPART(MONTH, O.DOGUMTARIHI) AS DOGUMAY
						,DATEPART(DAY, O.DOGUMTARIHI) AS DOGUMGUN
				INTO #ZEKAOGRENCI
				FROM ZekaTestOgrenci O
				WHERE TCKIMLIKNO = @TCKIMLIKNO_OGR	

				IF EXISTS (SELECT 1 FROM #ZEKAOGRENCI)
				BEGIN
					SELECT
					(
						SELECT * FROM #ZEKAOGRENCI
						FOR JSON PATH
					)
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT	 0 AS ID_ZEKATESTOGRENCI
								,O.TCKIMLIKNO
								,K.AD
								,K.SOYAD
								,DATEPART(YEAR, K.DOGUMTARIHI) AS DOGUMYIL
								,DATEPART(MONTH, K.DOGUMTARIHI) AS DOGUMAY
								,DATEPART(DAY, K.DOGUMTARIHI) AS DOGUMGUN
						FROM OkyanusDb.dbo.v3Ogrenci O 
						INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
						WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR
						FOR JSON PATH
					)
				END

				DROP TABLE #ZEKAOGRENCI
			END

			IF @ISLEM = 3	--	SORU LİSTELE
			BEGIN
				SELECT
				(
					SELECT 
					(
						SELECT ZTK.AD AS KATEGORI, (SELECT ZTS.ID_ZEKATESTSORU, ZTS.SORU, ZTS.KALIN, '' as PUAN FROM ZekaTestSoru ZTS WHERE ZTS.ID_ZEKATESTKATEGORI = ZTK.ID_ZEKATESTKATEGORI FOR JSON PATH, INCLUDE_NULL_VALUES) AS SORULIST
						FROM ZekaTest ZT
						INNER JOIN ZekaTestKategori ZTK ON ZTK.ID_ZEKATEST = ZT.ID_ZEKATEST
						WHERE ZT.ID_ZEKATEST = @ID_ZEKATEST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS KATEGORILIST,
					null AS DOSYA FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				)
			END

			IF @ISLEM = 4	--	KAYDET
			BEGIN
				DECLARE @ID_ZEKATESTOGRENCI INT,
						@TC VARCHAR(11),
						@AD VARCHAR(MAX),
						@SOYAD VARCHAR(MAX),
						@DOGUMTARIHI VARCHAR(MAX),
						@TESTTARIHI VARCHAR(MAX)

				SELECT	 @ID_ZEKATESTOGRENCI = ID_ZEKATESTOGRENCI 
						,@TC = TCKIMLIKNO
						,@AD = AD
						,@SOYAD = SOYAD
						,@DOGUMTARIHI = DOGUMTARIHI
						,@TESTTARIHI = ISNULL(TESTTARIHI, CONVERT(VARCHAR, GETDATE(), 104))
				FROM OPENJSON(@SQLJSON_OGRENCI)
				WITH(
					ID_ZEKATESTOGRENCI INT,
					TCKIMLIKNO VARCHAR(11),
					AD VARCHAR(MAX),
					SOYAD VARCHAR(MAX),
					DOGUMTARIHI VARCHAR(MAX),
					TESTTARIHI VARCHAR(MAX)
				)

				SET @ID_ZEKATESTOGRENCI = (SELECT ID_ZEKATESTOGRENCI FROM ZekaTestOgrenci WHERE TCKIMLIKNO = @TC)

				IF NOT EXISTS(SELECT TOP 1 1 FROM ZekaTestOgrenci WHERE TCKIMLIKNO = @TC)
				BEGIN
					DECLARE @INSERTED TABLE (ID_ZEKATESTOGRENCI INT)

					INSERT INTO ZekaTestOgrenci (TCKIMLIKNO, AD, SOYAD, DOGUMTARIHI)
					OUTPUT inserted.ID_ZEKATESTOGRENCI INTO @INSERTED
					SELECT @TCKIMLIKNO_OGR, @AD, @SOYAD, @DOGUMTARIHI

					SET @ID_ZEKATESTOGRENCI = (SELECT ID_ZEKATESTOGRENCI FROM @INSERTED)
				END

				DECLARE @INSERTEDID_ZEKATESTOGRENCIZEKATEST TABLE (ID_ZEKATESTOGRENCIZEKATEST INT)
				INSERT INTO ZekaTestOgrenciZekaTest (ID_ZEKATESTOGRENCI, ID_ZEKATEST, TESTTARIHI, KYE_KULLANICI)
				OUTPUT inserted.ID_ZEKATESTOGRENCIZEKATEST INTO @INSERTEDID_ZEKATESTOGRENCIZEKATEST
				SELECT @ID_ZEKATESTOGRENCI, @ID_ZEKATEST, @TESTTARIHI, @TCKIMLIKNO

				SET @ID_ZEKATESTOGRENCIZEKATEST = (SELECT ID_ZEKATESTOGRENCIZEKATEST FROM @INSERTEDID_ZEKATESTOGRENCIZEKATEST)

				INSERT INTO ZekaTestOgrenciPuan (ID_ZEKATESTOGRENCIZEKATEST, ID_ZEKATESTSORU, PUAN)
				SELECT	@ID_ZEKATESTOGRENCIZEKATEST,
						JSON_Value (S.value, '$.ID_ZEKATESTSORU') as ID_ZEKATESTSORU,
						JSON_Value (S.value, '$.PUAN') as PUAN
				FROM OPENJSON(@SQLJSON_SORU, '$.KATEGORILIST') AS K
				CROSS APPLY OPENJSON (K.value, '$.SORULIST') as S
				WHERE JSON_Value (S.value, '$.PUAN') <> ''

				SELECT @ID_ZEKATESTOGRENCIZEKATEST
			END

			IF @ISLEM = 5	--	ÖĞRENCİ PUAN SİL
			BEGIN
				DELETE P 
				FROM ZekaTestOgrenciPuan P
				INNER JOIN ZekaTestSoru S ON S.ID_ZEKATESTSORU = P.ID_ZEKATESTSORU
				INNER JOIN ZekaTestKategori K ON K.ID_ZEKATESTKATEGORI = S.ID_ZEKATESTKATEGORI
				INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCIZEKATEST = P.ID_ZEKATESTOGRENCIZEKATEST
				INNER JOIN ZekaTestOgrenci O ON O.ID_ZEKATESTOGRENCI = OZT.ID_ZEKATESTOGRENCI
				WHERE O.TCKIMLIKNO = @TCKIMLIKNO_OGR AND K.ID_ZEKATEST = @ID_ZEKATEST
			END

			IF @ISLEM = 6	--	DOSYA KAYDET
			BEGIN
				DELETE FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST AND ID_ZEKATESTOGRENCIDOSYATUR = @ID_ZEKATESTOGRENCIDOSYATUR

				INSERT INTO ZekaTestOgrenciDosya (AD, GUID, TIP, ID_ZEKATESTOGRENCIZEKATEST, ID_ZEKATESTOGRENCIDOSYATUR)
				SELECT @DOSYAAD, @DOSYAGUID, @DOSYATIP, @ID_ZEKATESTOGRENCIZEKATEST, @ID_ZEKATESTOGRENCIDOSYATUR
			END

			IF @ISLEM = 7	--	DOSYA SİL
			BEGIN
				DELETE FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIDOSYA = @ID_ZEKATESTOGRENCIDOSYA
			END

			IF @ISLEM = 8	--	SONUÇ LİSTELE
			BEGIN
				DECLARE @CONTROL BIT = 0

				IF EXISTS (SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE ID_KULLANICITIPI IN (1, 91) AND TCKIMLIKNO = @TCKIMLIKNO)
				BEGIN
					SET @CONTROL = 1
				END

				DECLARE @ORDERCOL INT,
						@ORDERDIR VARCHAR(4) 

				SELECT @ORDERCOL = JSON_Value (value, '$.column'), @ORDERDIR = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				DECLARE @orderByClause VARCHAR(MAX) = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 2 THEN 'AD'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 3 THEN 'SOYAD'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 4 THEN 'convert(DATE, DOGUMTARIHI, 104)'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 5 THEN 'convert(DATE, TESTTARIHI, 104)'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 6 THEN 'KYE_ADSOYAD'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 7 THEN 'YAS'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 8 THEN 'TEST'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 9 THEN 'TOPLAMPUAN'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 10 THEN 'ID'
								WHEN CAST(@ORDERCOL AS VARCHAR) = 11 THEN 'DOSYA'
							END
						+ ' ' + CAST(@ORDERDIR AS VARCHAR)
		

				DECLARE @whereClause VARCHAR(MAX) = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				DECLARE @displayStart INT = (SELECT start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)) 
				DECLARE @displayLength INT = (SELECT length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF @whereClause <> ''
				BEGIN
					DECLARE @COLUMNS VARCHAR(max) = ''
					SET @COLUMNS='(TCKIMLIKNO LIKE ''%' + @whereClause + '%'' OR AD LIKE ''%' + @whereClause + '%'' OR SOYAD LIKE ''%' + @whereClause + '%'' OR DOGUMTARIHI LIKE ''%' + @whereClause + '%'' OR TESTTARIHI LIKE ''%' + @whereClause + '%'' OR KYE_KULLANICI LIKE ''%' + @whereClause + '%'' OR YAS LIKE ''%' + @whereClause + '%'' OR TEST LIKE ''%' + @whereClause + '%'' OR TOPLAMPUAN LIKE ''%' + @whereClause + '%'' OR DOSYA LIKE ''%' + @whereClause + '%'')'

					SET @whereClause='WHERE (KYE_KULLANICI = ''' + @TCKIMLIKNO + ''' OR ' + CAST(@CONTROL AS VARCHAR) + ' = 1)'
									+ ' AND ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
									+ ' AND ' + @COLUMNS
				END
				ELSE
				BEGIN
					SET @whereClause='WHERE (KYE_KULLANICI = ''' + @TCKIMLIKNO + ''' OR ' + CAST(@CONTROL AS VARCHAR) + ' = 1)'
									+ ' AND ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
				END

				Declare @query varchar(MAX)
				set @query='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT	O.TCKIMLIKNO
												,ISNULL(OK.AD, O.AD) AS AD
												,ISNULL(OK.SOYAD, O.SOYAD) AS SOYAD
												,ISNULL(CONVERT(VARCHAR, OK.DOGUMTARIHI, 104)
												,CONVERT(VARCHAR, O.DOGUMTARIHI, 104)) AS DOGUMTARIHI
												,CONVERT(VARCHAR, OZT.TESTTARIHI, 104) AS TESTTARIHI
												,KK.AD + '' '' + KK.SOYAD AS KYE_ADSOYAD
												,dbo.fn_DateDiffasYAG(ISNULL(OK.DOGUMTARIHI, O.DOGUMTARIHI), OZT.TESTTARIHI) AS YAS
												,Z.AD AS TEST
												,ISNULL((SELECT CAST(P.PUAN AS VARCHAR) FROM ZekaTestOgrenciPuan P WHERE P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND P.ID_ZEKATESTSORU = CASE WHEN Z.ID_ZEKATEST = 1 THEN 5 WHEN Z.ID_ZEKATEST = 2 THEN 20 ELSE 21 END), ''-'') AS TOPLAMPUAN
												,D.GUID + ''.'' + D.TIP AS DOSYA
												,DUZMAN.GUID + ''.'' + DUZMAN.TIP AS DOSYAUZMAN
												,OZT.KYE_KULLANICI
												,OZT.ID_ZEKATESTOGRENCIZEKATEST AS ID
										FROM ZekaTestOgrenci O
										INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI
										LEFT JOIN OkyanusDB.dbo.v3Kullanici OK ON OK.TCKIMLIKNO = O.TCKIMLIKNO
										INNER JOIN OkyanusDB.dbo.v3Kullanici KK ON KK.TCKIMLIKNO = OZT.KYE_KULLANICI
										INNER JOIN ZekaTest Z ON Z.ID_ZEKATEST = OZT.ID_ZEKATEST
										LEFT JOIN ZekaTestOgrenciDosya D ON D.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND D.ID_ZEKATESTOGRENCIDOSYATUR = 1
										LEFT JOIN ZekaTestOgrenciDosya DUZMAN ON DUZMAN.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND DUZMAN.ID_ZEKATESTOGRENCIDOSYATUR = 2
										WHERE OZT.AKTIF = 1
									) AS XTABLE
									'+@whereClause+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ ' FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM ZekaTestOgrenciZekaTest WHERE AKTIF = 1) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@query)
			END

			IF @ISLEM = 9	--	SORU LİSTELE - LİSTE SAYFASI
			BEGIN
				SET @ID_ZEKATEST = (SELECT ID_ZEKATEST FROM ZekaTestOgrenciZekaTest WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST)

				SELECT O.ID_ZEKATESTOGRENCI, S.ID_ZEKATESTSORU, P.PUAN, OZT.KYE_KULLANICI
				INTO #OGRENCI
				FROM ZekaTestOgrenci O
				INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI 
				INNER JOIN ZekaTestOgrenciPuan P ON P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST 
				INNER JOIN ZekaTestSoru S ON S.ID_ZEKATESTSORU = P.ID_ZEKATESTSORU
				INNER JOIN ZekaTestKategori K ON K.ID_ZEKATESTKATEGORI = S.ID_ZEKATESTKATEGORI
				WHERE OZT.ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST

				SELECT
				(
					SELECT 
					(
						SELECT ZTK.AD AS KATEGORI, (SELECT ZTS.ID_ZEKATESTSORU, ZTS.SORU, ZTS.KALIN, ISNULL(CAST(O.PUAN AS VARCHAR), '') AS PUAN FROM ZekaTestSoru ZTS LEFT JOIN #OGRENCI O ON O.ID_ZEKATESTSORU = ZTS.ID_ZEKATESTSORU WHERE ZTS.ID_ZEKATESTKATEGORI = ZTK.ID_ZEKATESTKATEGORI FOR JSON PATH, INCLUDE_NULL_VALUES) AS SORULIST
						FROM ZekaTest ZT
						INNER JOIN ZekaTestKategori ZTK ON ZTK.ID_ZEKATEST = ZT.ID_ZEKATEST
						WHERE ZT.ID_ZEKATEST = @ID_ZEKATEST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS KATEGORILIST
					FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				)		

				DROP TABLE #OGRENCI
			END

			IF @ISLEM = 10	--	SONUÇ LİSTELE - EXCEL
			BEGIN
				DECLARE @CONTROLEXCEL BIT = 0

				IF EXISTS (SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE ID_KULLANICITIPI IN (1, 59, 91) AND TCKIMLIKNO = @TCKIMLIKNO)
				BEGIN
					SET @CONTROLEXCEL = 1
				END	

				DECLARE @orderByClauseEXCEL VARCHAR(MAX) = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 2 THEN 'AD'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 3 THEN 'SOYAD'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 4 THEN 'convert(DATE, DOGUMTARIHI, 104)'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 5 THEN 'convert(DATE, TESTTARIHI, 104)'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 6 THEN 'KYE_ADSOYAD'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 7 THEN 'YAS'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 8 THEN 'TEST'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 9 THEN 'TOPLAMPUAN'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 10 THEN 'ID'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 11 THEN 'DOSYA'
								WHEN CAST(@ORDERCOLEXCEL AS VARCHAR) = 11 THEN 'DOSYAUZMAN'
							END
						+ ' ' + CAST(@ORDERDIREXCEL AS VARCHAR)

				DECLARE @whereClauseEXCEL VARCHAR(MAX) = ''
		
				DECLARE @COLUMNSEXCEL VARCHAR(max) = ''
				SET @COLUMNSEXCEL='(TCKIMLIKNO LIKE ''%' + @SEARCH + '%'' OR AD LIKE ''%' + @SEARCH + '%'' OR SOYAD LIKE ''%' + @SEARCH + '%'' OR DOGUMTARIHI LIKE ''%' + @SEARCH + '%'' OR TESTTARIHI LIKE ''%' + @SEARCH + '%'' OR KYE_KULLANICI LIKE ''%' + @SEARCH + '%'' OR YAS LIKE ''%' + @SEARCH + '%'' OR TEST LIKE ''%' + @SEARCH + '%'' OR TOPLAMPUAN LIKE ''%' + @SEARCH + '%'')'

				SET @whereClauseEXCEL='WHERE (KYE_KULLANICI = ''' + @TCKIMLIKNO + ''' OR ' + CAST(@CONTROLEXCEL AS VARCHAR) + ' = 1)'
								+ ' AND ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
								+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
								+ ' AND ' + @COLUMNSEXCEL
								+ CASE @DURUM WHEN 0 THEN '' WHEN 1 THEN 'AND 1 = AKTIF' WHEN 2 THEN 'AND 0 = AKTIF' END

				Declare @queryEXCEL varchar(MAX)
				set @queryEXCEL='
								SELECT TCKIMLIKNO, AD, SOYAD, DOGUMTARIHI AS ''DOĞUM TARİHİ'', TESTTARIHI AS ''TEST TARİHİ'', KYE_ADSOYAD AS ''KAYIT EDEN'', YAS AS ''KRONOLOJİK YAŞ'', TEST, TOPLAMPUAN AS ''TOPLAM PUAN'', ''pusulam.okyanuskoleji.k12.tr/Dosyalar/ZekaTest/'' + DOSYA AS DOSYA, ''pusulam.okyanuskoleji.k12.tr/Dosyalar/ZekaTest/'' + DOSYAUZMAN AS DOSYAUZMAN FROM
								(
									SELECT	O.TCKIMLIKNO
											,ISNULL(OK.AD, O.AD) AS AD
											,ISNULL(OK.SOYAD, O.SOYAD) AS SOYAD
											,ISNULL(CONVERT(VARCHAR, OK.DOGUMTARIHI, 104)
											,CONVERT(VARCHAR, O.DOGUMTARIHI, 104)) AS DOGUMTARIHI
											,CONVERT(VARCHAR, OZT.TESTTARIHI, 104) AS TESTTARIHI
											,KK.AD + '' '' + KK.SOYAD AS KYE_ADSOYAD
											,dbo.fn_DateDiffasYAG(ISNULL(OK.DOGUMTARIHI, O.DOGUMTARIHI), OZT.TESTTARIHI) AS YAS
											,Z.AD AS TEST
											,ISNULL((SELECT CAST(P.PUAN AS VARCHAR) FROM ZekaTestOgrenciPuan P WHERE P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND P.ID_ZEKATESTSORU = CASE WHEN Z.ID_ZEKATEST = 1 THEN 5 WHEN Z.ID_ZEKATEST = 2 THEN 20 ELSE 21 END), ''-'') AS TOPLAMPUAN
											,D.GUID + ''.'' + D.TIP AS DOSYA
											,DUZMAN.GUID + ''.'' + DUZMAN.TIP AS DOSYAUZMAN
											,OZT.KYE_KULLANICI
											,OZT.AKTIF
									FROM ZekaTestOgrenci O
									INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI
									LEFT JOIN OkyanusDB.dbo.v3Kullanici OK ON OK.TCKIMLIKNO = O.TCKIMLIKNO
									INNER JOIN OkyanusDB.dbo.v3Kullanici KK ON KK.TCKIMLIKNO = OZT.KYE_KULLANICI
									INNER JOIN ZekaTest Z ON Z.ID_ZEKATEST = OZT.ID_ZEKATEST
									LEFT JOIN ZekaTestOgrenciDosya D ON D.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND D.ID_ZEKATESTOGRENCIDOSYATUR = 1
									LEFT JOIN ZekaTestOgrenciDosya DUZMAN ON DUZMAN.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND DUZMAN.ID_ZEKATESTOGRENCIDOSYATUR = 2
								) AS XTABLE
								'+@whereClauseEXCEL+'
								'+@orderByClauseEXCEL+'
				'

				execute (@queryEXCEL)
			END

			IF @ISLEM = 11	--	SONUÇ LİSTELE
			BEGIN
				DECLARE @ORDERCOLABB INT,
						@ORDERDIRABB VARCHAR(4) 

				SELECT @ORDERCOLABB = JSON_Value (value, '$.column'), @ORDERDIRABB = JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')
				DECLARE @orderByClauseABB VARCHAR(MAX) = ' ORDER BY ' 
						+ CASE	WHEN CAST(@ORDERCOLABB AS VARCHAR) = 1 THEN 'TCKIMLIKNO'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 2 THEN 'AD'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 3 THEN 'SOYAD'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 4 THEN 'convert(DATE, DOGUMTARIHI, 104)'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 5 THEN 'convert(DATE, TESTTARIHI, 104)'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 6 THEN 'KYE_ADSOYAD'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 7 THEN 'YAS'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 8 THEN 'TEST'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 9 THEN 'TOPLAMPUAN'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 10 THEN 'ID'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 11 THEN 'DOSYA'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 12 THEN 'DOSYAUZMAN'
								WHEN CAST(@ORDERCOLABB AS VARCHAR) = 13 THEN 'AKTIF'
							END
						+ ' ' + CAST(@ORDERDIRABB AS VARCHAR)
		

				DECLARE @whereClauseABB VARCHAR(MAX) = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				DECLARE @displayStartABB INT = (SELECT start + 1 FROM OPENJSON(@SQLJSON) WITH (start INT)) 
				DECLARE @displayLengthABB INT = (SELECT length - 1 FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF @whereClauseABB <> ''
				BEGIN
					DECLARE @COLUMNSABB VARCHAR(max) = ''
					SET @COLUMNSABB='(TCKIMLIKNO LIKE ''%' + @whereClauseABB + '%'' OR AD LIKE ''%' + @whereClauseABB + '%'' OR SOYAD LIKE ''%' + @whereClauseABB + '%'' OR DOGUMTARIHI LIKE ''%' + @whereClauseABB + '%'' OR TESTTARIHI LIKE ''%' + @whereClauseABB + '%'' OR KYE_KULLANICI LIKE ''%' + @whereClauseABB + '%'' OR YAS LIKE ''%' + @whereClauseABB + '%'' OR TEST LIKE ''%' + @whereClauseABB + '%'' OR TOPLAMPUAN LIKE ''%' + @whereClauseABB + '%'' OR DOSYA LIKE ''%' + @whereClauseABB + '%'')'

					SET @whereClauseABB='WHERE ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
									+ CASE @DURUM WHEN 0 THEN '' WHEN 1 THEN 'AND 1 = AKTIF' WHEN 2 THEN 'AND 0 = AKTIF' END
									+ ' AND ' + @COLUMNSABB
				END
				ELSE
				BEGIN
					SET @whereClauseABB='WHERE ('''+@TESTTARIHI1+''' = '''' OR CAST(TESTTARIHI AS DATE) >= '''+@TESTTARIHI1+''')'
									+ ' AND ('''+@TESTTARIHI2+''' = '''' OR CAST(TESTTARIHI AS DATE) <= '''+@TESTTARIHI2+''')'
									+ CASE @DURUM WHEN 0 THEN '' WHEN 1 THEN 'AND 1 = AKTIF' WHEN 2 THEN 'AND 0 = AKTIF' END
				END

				Declare @queryABB varchar(MAX)
				set @queryABB='
							SELECT * INTO #TEMP FROM   
							(
								SELECT ROW_NUMBER() OVER('+@orderByClauseABB+') AS RowNumber, * 
								FROM(
									SELECT * FROM
									(
										SELECT	O.TCKIMLIKNO
												,ISNULL(OK.AD, O.AD) AS AD
												,ISNULL(OK.SOYAD, O.SOYAD) AS SOYAD
												,ISNULL(CONVERT(VARCHAR, OK.DOGUMTARIHI, 104)
												,CONVERT(VARCHAR, O.DOGUMTARIHI, 104)) AS DOGUMTARIHI
												,CONVERT(VARCHAR, OZT.TESTTARIHI, 104) AS TESTTARIHI
												,KK.AD + '' '' + KK.SOYAD AS KYE_ADSOYAD
												,dbo.fn_DateDiffasYAG(ISNULL(OK.DOGUMTARIHI, O.DOGUMTARIHI), OZT.TESTTARIHI) AS YAS
												,Z.AD AS TEST
												,ISNULL((SELECT CAST(P.PUAN AS VARCHAR) FROM ZekaTestOgrenciPuan P WHERE P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND P.ID_ZEKATESTSORU = CASE WHEN Z.ID_ZEKATEST = 1 THEN 5 WHEN Z.ID_ZEKATEST = 2 THEN 20 ELSE 21 END), ''-'') AS TOPLAMPUAN
												,D.GUID + ''.'' + D.TIP AS DOSYA
												,DUZMAN.GUID + ''.'' + DUZMAN.TIP AS DOSYAUZMAN
												,OZT.KYE_KULLANICI
												,OZT.ID_ZEKATESTOGRENCIZEKATEST AS ID
												,OZT.AKTIF AS AKTIF
										FROM ZekaTestOgrenci O
										INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI
										LEFT JOIN OkyanusDB.dbo.v3Kullanici OK ON OK.TCKIMLIKNO = O.TCKIMLIKNO
										INNER JOIN OkyanusDB.dbo.v3Kullanici KK ON KK.TCKIMLIKNO = OZT.KYE_KULLANICI
										INNER JOIN ZekaTest Z ON Z.ID_ZEKATEST = OZT.ID_ZEKATEST
										LEFT JOIN ZekaTestOgrenciDosya D ON D.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND D.ID_ZEKATESTOGRENCIDOSYATUR = 1
										LEFT JOIN ZekaTestOgrenciDosya DUZMAN ON DUZMAN.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST AND DUZMAN.ID_ZEKATESTOGRENCIDOSYATUR = 2
									) AS XTABLE
									'+@whereClauseABB+'
								) 
							RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStartABB)+' AND '+CONVERT(VARCHAR(MAX),(@displayStartABB+@displayLengthABB))+ ' FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM ZekaTestOgrenciZekaTest) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'

				execute (@queryABB)
			END

			IF @ISLEM = 12	--	PASİF YAP
			BEGIN
				UPDATE ZekaTestOgrenciZekaTest SET AKTIF = 0 WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST
			END

			IF @ISLEM = 13	--	AKTİF YAP
			BEGIN
				UPDATE ZekaTestOgrenciZekaTest SET AKTIF = 1 WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST
			END

			IF @ISLEM = 14	--	SORU LİSTELE - GÜNCELLEME
			BEGIN
				SET @ID_ZEKATEST = (SELECT ID_ZEKATEST FROM ZekaTestOgrenciZekaTest WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST)

				SELECT O.ID_ZEKATESTOGRENCI, S.ID_ZEKATESTSORU, P.PUAN, OZT.KYE_KULLANICI
				INTO #OGRENCIGUNCELLEME
				FROM ZekaTestOgrenci O
				INNER JOIN ZekaTestOgrenciZekaTest OZT ON OZT.ID_ZEKATESTOGRENCI = O.ID_ZEKATESTOGRENCI 
				INNER JOIN ZekaTestOgrenciPuan P ON P.ID_ZEKATESTOGRENCIZEKATEST = OZT.ID_ZEKATESTOGRENCIZEKATEST 
				INNER JOIN ZekaTestSoru S ON S.ID_ZEKATESTSORU = P.ID_ZEKATESTSORU
				INNER JOIN ZekaTestKategori K ON K.ID_ZEKATESTKATEGORI = S.ID_ZEKATESTKATEGORI
				WHERE OZT.ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST

				SELECT
				(
					SELECT 
					@ID_ZEKATEST AS ID_ZEKATEST,
					(
						SELECT ZTK.AD AS KATEGORI, (SELECT ZTS.ID_ZEKATESTSORU, ZTS.SORU, ZTS.KALIN, ISNULL(CAST(O.PUAN AS VARCHAR), '') AS PUAN FROM ZekaTestSoru ZTS LEFT JOIN #OGRENCIGUNCELLEME O ON O.ID_ZEKATESTSORU = ZTS.ID_ZEKATESTSORU WHERE ZTS.ID_ZEKATESTKATEGORI = ZTK.ID_ZEKATESTKATEGORI FOR JSON PATH, INCLUDE_NULL_VALUES) AS SORULIST
						FROM ZekaTest ZT
						INNER JOIN ZekaTestKategori ZTK ON ZTK.ID_ZEKATEST = ZT.ID_ZEKATEST
						WHERE ZT.ID_ZEKATEST = @ID_ZEKATEST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS KATEGORILIST,
					(SELECT ID_ZEKATESTOGRENCIDOSYA, GUID + '.' + TIP AS URL FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST AND ID_ZEKATESTOGRENCIDOSYATUR = 1 FOR JSON PATH) AS DOSYA,
					(SELECT ID_ZEKATESTOGRENCIDOSYA, GUID + '.' + TIP AS URL FROM ZekaTestOgrenciDosya WHERE ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST AND ID_ZEKATESTOGRENCIDOSYATUR = 2 FOR JSON PATH) AS DOSYAUZMAN FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				)		

				DROP TABLE #OGRENCIGUNCELLEME
			END

			IF @ISLEM = 15	--	GÜNCELLE
			BEGIN
				DELETE P FROM ZekaTestOgrenciPuan P 
				WHERE P.ID_ZEKATESTOGRENCIZEKATEST = @ID_ZEKATESTOGRENCIZEKATEST		

				INSERT INTO ZekaTestOgrenciPuan (ID_ZEKATESTOGRENCIZEKATEST, ID_ZEKATESTSORU, PUAN)
				SELECT	@ID_ZEKATESTOGRENCIZEKATEST,
						JSON_Value (S.value, '$.ID_ZEKATESTSORU') as ID_ZEKATESTSORU,
						JSON_Value (S.value, '$.PUAN') as ID_ZEKATESTSORU
				FROM OPENJSON(@SQLJSON_SORU, '$.KATEGORILIST') AS K
				CROSS APPLY OPENJSON (K.value, '$.SORULIST') as S
				WHERE JSON_Value (S.value, '$.PUAN') <> ''

				SELECT @ID_ZEKATESTOGRENCIZEKATEST
			END
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Creating [dbo].[sp_SorunBildir]...';


GO
CREATE PROC [dbo].[sp_SorunBildir]
	@ISLEM							INT				= NULL,
	@TCKIMLIKNO						VARCHAR(11)		= NULL,
	@OTURUM							VARCHAR(36)		= NULL,
	@ID_MENU						INT				= NULL,
	@SQLJSON						VARCHAR(MAX)	= NULL,
	@GUID							VARCHAR(MAX)	= NULL,
	@ID_SINAV						INT				= NULL


AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	
	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT

		
		IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
		BEGIN
			IF @ISLEM = 1 -- Sorun Bildir
			BEGIN
				INSERT INTO SorunBildir (ID_KURUMDISIOGRENCI, SORUN, FILEGUID,MAIL)				
				SELECT (SELECT ID_DIS_OGRENCI FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO), SORUN, @GUID ,MAIL
				FROM OPENJSON (@SQLJSON)
				WITH(
					SORUN			VARCHAR(MAX),
					MAIL			VARCHAR(250)
				)	

				CREATE TABLE #MAIL (KONU VARCHAR(MAX),SORUN VARCHAR(MAX),GUID VARCHAR(MAX),TCKIMLIKNO VARCHAR(MAX),MAIL VARCHAR(300))

				INSERT INTO #MAIL(KONU,SORUN,GUID,TCKIMLIKNO,MAIL)
				SELECT KONU,SORUN,@GUID,@TCKIMLIKNO,MAIL
				FROM OPENJSON(@SQLJSON)
				WITH(
					KONU		VARCHAR(MAX),
					SORUN		VARCHAR(MAX),
					MAIL		VARCHAR(300)
				)				
				DECLARE @KONU VARCHAR(MAX) = 'KONU: '+(SELECT KONU FROM #MAIL) + '- SINAV ADI: ' + (SELECT AD FROM Sinav WHERE ID_SINAV=@ID_SINAV)
				DECLARE @PROFIL VARCHAR(MAX)= 'Pusulam'
				DECLARE @MAIL VARCHAR(MAX)='onlinesinav@okyanuskoleji.k12.tr'	
				DECLARE @TBODY VARCHAR(MAX)=(SELECT SORUN FROM #MAIL) + ' <br> Mail Adresi: '+(SELECT MAIL FROM #MAIL) + '  <br> link: https://okyanusdata.s3-eu-west-1.amazonaws.com/pusulam/disogrenci/sorun/'
											+ (@GUID) +'<br> Ad Soyad: ' +(SELECT AD+' ' +SOYAD FROM DisOgrenci WHERE TCKIMLIKNO = @TCKIMLIKNO ) + '<br> T.C Kimlik No: ' + @TCKIMLIKNO
				--DECLARE @MAIL VARCHAR(MAX)='kadircengiz@techlife.com.tr'
				--MAIL GÖNDER--
				DECLARE @mailstatement varchar(MAX)
				EXEC @mailstatement=msdb.dbo.sp_send_dbmail @recipients=@MAIL, @body=@TBODY, @subject=@KONU, @body_format='HTML', @profile_name = @PROFIL	

				DROP TABLE #MAIL
			END
			IF @ISLEM = 2  -- Sınav Listele
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT S.ID_SINAV as ID_SINAV, S.AD AS AD
					FROM Sinav						S
					JOIN Tbl_OnlineSinavOgrenci		OSO ON S.ID_SINAV = OSO.ID_SINAV
					WHERE OSO.TCKIMLIKNO = @TCKIMLIKNO AND S.AKTIF=1
					FOR JSON PATH
				), '[]')
			END
		END		
			
			
	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Ogrenci]...';


GO
ALTER procedure [dbo].[sp_Ogrenci]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SUBELIST		VARCHAR(MAX)	= NULL,
	@ID_SINAVGRUP		INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINIFS			VARCHAR(MAX)	= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_TKTZEKATURUS	VARCHAR(MAX)	= NULL,
	@ID_TKTSINAV		INT				= NULL,
	@ID_TKTTEST			INT				= NULL,
	@TARIH				Date			= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ISJSON				BIT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SUBE					= @ID_SUBE		
			,ID_SUBELIST				= @ID_SUBELIST	
			,ID_SINAVGRUP				= @ID_SINAVGRUP	
			,ID_SINIF					= @ID_SINIF		
			,ID_KADEME					= @ID_KADEME		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINIFS					= @ID_SINIFS		
			,SINIFLAR					= @SINIFLAR		
			,ID_TKTZEKATURUS			= @ID_TKTZEKATURUS
			,ID_TKTSINAV				= @ID_TKTSINAV	
			,ID_TKTTEST					= @ID_TKTTEST		
			,TARIH						= @TARIH			
			,DONEM						= @DONEM			
			,TC_OGRENCI					= @TC_OGRENCI		
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ISJSON						= @ISJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
	
			SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
			IF @ISLEM = 1	--	Upgrade Öğrenci Listele 
			BEGIN
				SELECT DISTINCT o.ID_OGRENCI, o.TCKIMLIKNO, st.ID_SATISTURU 
				INTO #OGRENCILIST
				FROM [dbo].[v3OgrenciTum] o
				inner join [dbo].[v3SubeYetki]	sy		on sy.TCKIMLIKNO	=	o.TCKIMLIKNO 
				inner join [dbo].[v3SinifTum]	s		on s.ID_SINIF		=	o.ID_SINIF AND s.DONEM = o.DONEM
				inner join [dbo].[v3SatisTuru]	st		on st.ID_SATISTURU	=	s.ID_SATISTURU 
				WHERE 
				o.DONEM = @DONEM AND
				(@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  AND
				(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  AND
				(@ID_SINIFS IS NULL OR @ID_SINIFS='[]' OR s.ID_SINIF in (select value from openjson( @ID_SINIFS)) ) AND
				(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))

				SELECT O.ID_OGRENCI, OS.KYE_KULLANICI, CONVERT(VARCHAR, MAX(OS.KYE_TARIH),104) AS TARIH, SUM(OS.SAY) AS SORUSAYISI, OS.ID_TKTTEST, OS.ID_UPGRADEOGRENCISINAVDONEM
				INTO #OGRENCILIST2
				FROM #OGRENCILIST O
				LEFT JOIN (
							--SELECT OS.TCKIMLIKNO, S.ID_SATISTURU, OS.KYE_KULLANICI, OS.KYE_TARIH, 1 AS SAY
							--FROM UpgradeOgrenciSinav OS
							--INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OS.ID_TKTSORU
							--WHERE OS.ID_TKTSINAV = @ID_TKTSINAV

							SELECT OSD.TCKIMLIKNO, S.ID_SATISTURU, OSD.KYE_KULLANICI, OSD.KYE_TARIH, 1 AS SAY, OSD.ID_TKTTEST, OSD.ID_UPGRADEOGRENCISINAVDONEM
							FROM UpgradeOgrenciSinavDonem OSD
							INNER JOIN UpgradeOgrenciSinavDonemSoru OSDS ON OSDS.ID_UPGRADEOGRENCISINAVDONEM = OSD.ID_UPGRADEOGRENCISINAVDONEM
							INNER JOIN UpgradeSoru S ON S.ID_TKTSORU = OSDS.ID_TKTSORU
							WHERE OSD.ID_TKTSINAV = @ID_TKTSINAV AND OSD.DONEM = @DONEM
						) OS ON OS.TCKIMLIKNO = O.TCKIMLIKNO AND OS.ID_SATISTURU = O.ID_SATISTURU
				GROUP BY O.ID_OGRENCI, OS.KYE_KULLANICI, OS.ID_TKTTEST, OS.ID_UPGRADEOGRENCISINAVDONEM


				SELECT 
					 o.ID_OGRENCI
					,k.AD
					,k.SOYAD
					,DOGUMTARIHI = CONVERT(VARCHAR, k.DOGUMTARIHI, 103)
					,o.TCKIMLIKNO 
					,PUANGIRISI = case when @ID_TKTTEST = 4 then 1 else (	
									SELECT COUNT(1) FROM TktOgrenciCevap oc
									Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
									INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
									WHERE s.ID_TKTTEST=@ID_TKTTEST AND os.TCKIMLIKNO=o.TCKIMLIKNO
									AND (os.DONEM = @DONEM OR @DONEM IS NULL)
									) end
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, GETDATE())-1
					,s.AD SINIF
					,K2.AD + ' ' + K2.SOYAD AS KYE_ADSOYAD 
					,OL.TARIH
					,OL.SORUSAYISI
					,CASE WHEN OL.ID_TKTTEST = 4 THEN 'Ortalamaya Göre;' + STUFF((SELECT '<br/>' + US.SINAVAD FROM UpgradeOgrenciSinavDonemEtkinlik OSDE JOIN UpgradeSinav US ON US.ID_TKTSINAV = OSDE.ID_TKTSINAV WHERE OSDE.ID_UPGRADEOGRENCISINAVDONEM = OL.ID_UPGRADEOGRENCISINAVDONEM FOR XML PATH, TYPE).value(N'.[1]', N'nvarchar(max)'),1, 0, N'') WHEN  OL.ID_TKTTEST IS NULL THEN '' ELSE (SELECT AD FROM TKTTest WHERE ID_TKTTEST = OL.ID_TKTTEST) END AS OLUSTURMASEKLI
				FROM		[dbo].[v3OgrenciTum]	o
				Inner Join	[dbo].[v3Kullanici]		k	on k.TCKIMLIKNO		=	o.TCKIMLIKNO
				inner join	[dbo].[v3SinifTum]		s	on s.ID_SINIF		=	o.ID_SINIF AND s.DONEM = o.DONEM
				INNER JOIN #OGRENCILIST2			OL	ON OL.ID_OGRENCI	=	o.ID_OGRENCI
				LEFT JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO	=	OL.KYE_KULLANICI 
				WHERE 
				o.DONEM = @DONEM
				ORDER BY k.AD, k.SOYAD

				DROP TABLE #OGRENCILIST2
				DROP TABLE #OGRENCILIST
			END

			IF @ISLEM = 2	--	TKT Öğrenci Listele 
			BEGIN
				SELECT distinct
					 O.ID_OGRENCI
					,REPLACE(UPPER(k.AD),'UNDEFİNED','') as AD
					,UPPER(k.SOYAD) as SOYAD
					,DOGUMTARIHI = CONVERT(VARCHAR, k.DOGUMTARIHI, 103)
					,O.TCKIMLIKNO 
					,PUANGIRISI1 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=1 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI2 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=2 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI3 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=3 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,PUANGIRISI4 = (
						SELECT COUNT(1) FROM TktOgrenciCevap oc
						Inner Join TKTSoru s on s.ID_TKTSORU=oc.ID_TKTSORU 
						INNER JOIN TKTOgrenciSinav os on os.ID_TKTOGRENCISINAV=oc.ID_TKTOGRENCISINAV and os.ID_TKTTEST = s.ID_TKTTEST
						WHERE s.ID_TKTTEST=@ID_TKTTEST AND TCKIMLIKNO=O.TCKIMLIKNO and ID_KATEGORI=4 AND (os.DONEM = @DONEM OR @DONEM IS NULL)
					)
					,YASAY		= DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1
					,DURUM		= case when (DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1)<=(select max(YASAY2) from UpgradeYasAraligi) and (DATEDIFF(MONTH, k.DOGUMTARIHI, CAST(GETDATE() AS DATE))-1)>=(select min(YASAY1) from UpgradeYasAraligi) then 1 else 0 end
				FROM	   [dbo].[v3OgrenciTum]		O
				Inner Join [dbo].[v3Kullanici]		k	on	k.TCKIMLIKNO	=	o.TCKIMLIKNO
				inner join [dbo].[v3SubeYetki]		sy	on	sy.TCKIMLIKNO	=	o.TCKIMLIKNO
				inner join [dbo].[v3SinifTum]		s	on	s.ID_SINIF		=	o.ID_SINIF 
				inner join [dbo].[v3SatisTuru]		st	on	st.ID_SATISTURU	=	s.ID_SATISTURU  
				where O.DONEM = @DONEM AND (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sy.ID_SUBE=@ID_SUBE)  AND
					(@ID_SINAVGRUP IS NULL OR @ID_SINAVGRUP=0 OR st.ID_KADEME3=@ID_SINAVGRUP)  AND
					(@ID_SINIF IS NULL OR @ID_SINIF=0 OR s.ID_SINIF=@ID_SINIF)  AND
					(st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER))
			END

			IF @ISLEM = 4	--	Öğrenci Listele 
			BEGIN
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM v3OgrenciTum		O
				JOIN v3Kullanici	K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE ID_SINIF=@ID_SINIF
				ORDER BY K.AD, K.SOYAD
			END

			IF @ISLEM = 5	--	Öğrenci Listele by Veli
			BEGIN

				IF @ID_KADEME IS NULL
					SET @ID_KADEME = 0

				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO,ID_KADEME
				FROM V3KULLANici			K	
				JOIN V3OgrenciVeli			V	ON	V.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO		= K.TCKIMLIKNO
				JOIN vw_SubeSinifGrupKademe	GS	ON	GS.ID_SINIF			= O.ID_SINIF
				WHERE V.TCKIMLIKNO=@TCKIMLIKNO
					AND (@ID_KADEME = 0 OR GS.ID_KADEME = @ID_KADEME )
			END

			IF @ISLEM = 6	--	Öğrenci Listele MultiSinif
			BEGIN
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM V3OGRENCi		O
				JOIN V3KULLANici	K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE (@SINIFLAR='[]' or ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			END

			IF @ISLEM = 7	--	Demo Öğrenci Listele 
			BEGIN
				SELECT	 [FOTOĞRAF]		= ISNULL(R.FOTOGRAF,'')
						,[AD SOYAD]		= K.AD +' '+ K.SOYAD
						,[ÖĞRENCİ NO]	= O.OGRNO
						,[SINIF]		= SN.AD
						,[TCKIMLIKNO]	= O.TCKIMLIKNO
						,[İŞLEM]		= '<input style="float:right;margin: 10px;" type="button" class="btn btn-success" v-on:click="DemoLogin('+O.TCKIMLIKNO+')" value="Giriş Yap">'
				INTO #DemoOgrenciList
				FROM v3Ogrenci						O
				JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF		= O.ID_SINIF
				JOIN v3Sinif						SN	ON	SN.ID_SINIF		= O.ID_SINIF
				JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.DBO.v3Resim		R	ON	R.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	(O.ID_SUBE	= @ID_SUBE			OR @ID_SUBE		= 0 )
					AND (O.ID_SINIF = @ID_SINIF			OR @ID_SINIF	= 0 )
					AND (ID_KADEME3 = @ID_KADEME3		OR @ID_KADEME3	= 0 )
					--AND (K.AD		LIKE '%'+@AD+'%'	OR @AD			= '')
					--AND (K.SOYAD	LIKE '%'+@SOYAD+'%'	OR @SOYAD		= '')
				ORDER BY [AD SOYAD],[ÖĞRENCİ NO]
				
				select(
						select * from(
							select 
							(						 
								SELECT * FROM #DemoOgrenciList
								ORDER BY [AD SOYAD],[ÖĞRENCİ NO]
								FOR JSON AUTO
							) as DemoOgrenciList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #DemoOgrenciList

			END

			IF @ISLEM = 8	--	ÖĞRENCİ KADEME GETİR
			BEGIN
				SELECT DISTINCT ST.ID_KADEME
				FROM OkyanusDB.dbo.v3Ogrenci O
				JOIN OkyanusDB.dbo.v3Satislar S ON S.ID_SOZLESME = O.ID_SOZLESME
				JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
				WHERE TCKIMLIKNO = @TC_OGRENCI
			END

			IF @ISLEM = 9	--	ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				SELECT
				ISNULL
				(
					(
						SELECT  ID_SINAV	= S.ID_SINAV, 
								TCKIMLIKNO	= FO.TC_OGRENCI, 
								TUR			= ST.KISAAD, 
								TARIH		= CONVERT(varchar(MAX), S.SINAVTARIH, 104), 
								AD			= S.AD, 
								FREKANS		= ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
						FROM v2FrekansOgrenciDetay FO
						JOIN Sinav S ON S.ID_SINAV = FO.ID_SINAV
						JOIN SinavTuru ST ON ST.ID_SINAVTURU = S.ID_SINAVTURU
						WHERE TC_OGRENCI = @TC_OGRENCI AND S.DONEM = @DONEM
						GROUP BY S.ID_SINAV, FO.TC_OGRENCI, ST.KISAAD, S.SINAVTARIH, S.AD
						ORDER BY S.SINAVTARIH DESC
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 10	--	ÖĞRENCİ FREKANS DETAY LİSTESİ
			BEGIN
				SELECT
				ISNULL
				(
					(						
						SELECT DISTINCT FO.TAKMAAD, ISNULL(CAST(FO.FREKANS AS VARCHAR(MAX)) + '%', 'HESAPLANMADI') AS FREKANS
						FROM v2FrekansOgrenciDetay FO
						JOIN Sinav S ON S.ID_SINAV = FO.ID_SINAV
						WHERE TC_OGRENCI = @TC_OGRENCI AND S.ID_SINAV = @ID_SINAV
						ORDER BY FO.TAKMAAD
						FOR JSON PATH
					),
					'[]'
				)
			END

			IF @ISLEM = 11	--	ŞUBE SINAV ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				IF @ISJSON = 1
				BEGIN
					SELECT
					ISNULL
					(
						(						
							SELECT	 K.TCKIMLIKNO
									,FOD.SUBEAD
									,FOD.SINIFAD
									,ADSOYAD = K.AD + ' ' + K.SOYAD
									,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')									
									--,DERSLIST = ISNULL((SELECT DERSAD,NET,SS,FREKANS
									--					FROM v2FrekansOgrenciDetay L
									--					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI
														
									--					WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND L.ID_SINAV = @ID_SINAV  AND L.TC_OGRENCI=FOD.TC_OGRENCI		
														
									--					FOR JSON PATH, INCLUDE_NULL_VALUES
									--				),'[]')
 							  
							FROM v2FrekansOgrenciDetay FOD
							JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
							WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
							GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI
							ORDER BY SUBEAD, SINIFAD, ADSOYAD
							FOR JSON PATH
						),'[]')	

				END
				ELSE
				BEGIN
					SELECT	 K.TCKIMLIKNO
							,FOD.SUBEAD
							,FOD.SINIFAD
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
					FROM v2FrekansOgrenciDetay FOD
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
					GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				END
			END
			
			IF @ISLEM = 12	--	ŞUBE SINAV ÖĞRENCİ FREKANS LİSTESİ
			BEGIN
				IF @ISJSON = 1

				BEGIN
				
		
					SELECT  ID_SINAV,AD,ID_SINAVTURU,DONEM 
					INTO #TEMPSINAV 
					FROM Sinav  
					WHERE	ID_SINAVTURU	= @ID_SINAVTURU 
						AND DONEM			= @DONEM  
						AND FREKANSHESAPLA	= 1

					SELECT DISTINCT TAKMAAD INTO #DERSLER FROM SinavDers Where ID_SINAV in(Select ID_SINAV FROM Sinav  where ID_SINAVTURU=@ID_SINAVTURU AND DONEM=@DONEM  AND FREKANSHESAPLA=1 )
			
					SELECT	 K.TCKIMLIKNO
									,FOD.SUBEAD
									,FOD.SINIFAD
									,FOD.ID_SINIF
									,ADSOYAD = K.AD + ' ' + K.SOYAD
									,SINAVAD=S.AD
									,DERSAD=FOD.DERSAD
									,FREKANS=FOD.FREKANS
									,NET=FOD.NET
									,SORUSAYISI=FOD.SS
									--,DERSLIST = ((SELECT DISTINCT S.ID_SINAV, DERSAD,L.NET,L.SS,L.FREKANS,K.AD,K.SOYAD
									--						FROM v2FrekansOgrenciDetay L
									--						JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI				
									--						--JOIN Sinav S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU 
									--						JOIN #TEMPSINAV S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU
									--							WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  AND L.TC_OGRENCI=K.TCKIMLIKNO	And L.TC_OGRENCI=FOD.TC_OGRENCI 
									--							AND L.ID_SINAVTURU=@ID_SINAVTURU	AND S.DONEM=@DONEM	--AND SS.AD=S.AD  --AND L.TC_OGRENCI=OS.TCKIMLIKNO --AND L.TC_OGRENCI=T.TCKIMLIKNO
									--						    GROUP BY K.TCKIMLIKNO,K.AD,K.SOYAD,L.DERSAD,S.ID_SINAV,L.NET,L.FREKANS,L.SS												
									--							FOR JSON PATH, INCLUDE_NULL_VALUES
									--					))
							INTO #OGRFREKANS
							FROM v2FrekansOgrenciDetay FOD
							JOIN #TEMPSINAV S ON S.ID_SINAV=FOD.ID_SINAV AND S.ID_SINAVTURU=FOD.ID_SINAVTURU
							--JOIN #DERSLER D ON S.ID_SINAV=FOD.ID_SINAV --AND D.ID_SINAVTURU=FOD.ID_SINAVTURU
							JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
							WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAVTURU = @ID_SINAVTURU
							GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI,S.AD,FOD.DERSAD,FOD.FREKANS,FOD.NET,FOD.SS,FOD.ID_SINIF
							ORDER BY SUBEAD, SINIFAD, ADSOYAD
					
					select(
						select * from(
								select 
								(					
									SELECT		*
									FROM		#TEMPSINAV 
							
									FOR JSON AUTO
								) as t1,
								(					
									SELECT * FROM #DERSLER							
									FOR JSON AUTO
								) as t2,
								(					
									SELECT * FROM #OGRFREKANS	
									GROUP BY TCKIMLIKNO,SINAVAD,DERSAD,SUBEAD,SINIFAD,ADSOYAD,FREKANS,NET,SORUSAYISI,ID_SINIF
									FOR JSON AUTO
								) as t3	
							) as tablo FOR JSON AUTO
						) as tt


			
	
					--		SELECT 
					--      ( 
					--	SELECT		
					--			DISTINCT T.TCKIMLIKNO, SINAVLAR = (
					--				SELECT 	SINAVAD = SS.AD, 
					--				        SINAVFREKANS=ISNULL(CAST(CAST(AVG(OS.FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI'),
					--						SORUSAYISI=OS.SS,
					--						SINAVNET=OS.NET,
					--						TCKIMLIKNO=OS.TCKIMLIKNO,									
					--						DERSLIST = ISNULL((SELECT DISTINCT S.ID_SINAV, DERSAD,L.NET,L.SS,L.FREKANS,K.AD,K.SOYAD
					--										FROM v2FrekansOgrenciDetay L
					--										JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = L.TC_OGRENCI				
					--										JOIN Sinav S ON S.ID_SINAV=L.ID_SINAV AND S.ID_SINAVTURU=L.ID_SINAVTURU 													
					--											WHERE L.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  AND L.TC_OGRENCI=K.TCKIMLIKNO	And L.TC_OGRENCI=FOD.TC_OGRENCI 
					--											AND L.ID_SINAVTURU=@ID_SINAVTURU	AND S.DONEM=@DONEM	AND SS.AD=S.AD  --AND L.TC_OGRENCI=OS.TCKIMLIKNO --AND L.TC_OGRENCI=T.TCKIMLIKNO
					--										    GROUP BY K.TCKIMLIKNO,K.AD,K.SOYAD,L.DERSAD,S.ID_SINAV,L.NET,L.FREKANS,L.SS												
					--											FOR JSON PATH, INCLUDE_NULL_VALUES
					--									),'[]')
						  
					--			FROM v2FrekansOgrenciDetay FOD
					--			JOIN Sinav SS ON SS.ID_SINAV=FOD.ID_SINAV AND SS.ID_SINAVTURU=FOD.ID_SINAVTURU 					
					--			JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					--			JOIN v2FrekansOgrenciSinav OS ON SS.ID_SINAV=OS.ID_SINAV AND K.TCKIMLIKNO=OS.TCKIMLIKNO AND OS.ID_SINAVTURU=SS.ID_SINAVTURU
					--			WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))  And FOD.TC_OGRENCI=T.TCKIMLIKNO 
					--			AND SS.ID_SINAVTURU=@ID_SINAVTURU AND SS.DONEM=@DONEM AND OS.TCKIMLIKNO=K.TCKIMLIKNO AND K.TCKIMLIKNO=FOD.TC_OGRENCI AND FOD.TC_OGRENCI=OS.TCKIMLIKNO AND OS.ID_SINAVTURU=@ID_SINAVTURU
					--			GROUP BY FOD.SUBEAD, FOD.SINIFAD,SS.AD,FOD.TC_OGRENCI, K.TCKIMLIKNO, K.AD, K.SOYAD,FOD.TC_OGRENCI,OS.FREKANS,OS.SS,OS.NET,OS.TCKIMLIKNO
					--			ORDER BY SUBEAD, SINIFAD
					--				FOR JSON PATH
					--			) 
					--	 FROM v2FrekansOgrenciSinav T
					--	 inner join v2FrekansOgrenciDetay FD ON  FD.ID_SINAV=T.ID_SINAV
					--	 JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND T.TCKIMLIKNO=FD.TC_OGRENCI
					--	 WHERE 
					--	 FD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND K.TCKIMLIKNO=FD.TC_OGRENCI AND K.TCKIMLIKNO=T.TCKIMLIKNO AND T.DONEM=@DONEM AND T.ID_SINAVTURU=@ID_SINAVTURU
					
					--	GROUP BY FD.SUBEAD, FD.SINIFAD,FD.TC_OGRENCI,T.TCKIMLIKNO,T.ID_SINAV
					--	FOR JSON PATH
					--) AS J 
			

				END
				ELSE
				BEGIN
					SELECT	 K.TCKIMLIKNO
							,FOD.SUBEAD
							,FOD.SINIFAD
							,ADSOYAD = K.AD + ' ' + K.SOYAD
							,FREKANS = ISNULL(CAST(CAST(AVG(FREKANS) AS decimal(18, 2)) AS varchar(MAX)) + '%', 'HESAPLANMADI')
					FROM v2FrekansOgrenciDetay FOD
					JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = FOD.TC_OGRENCI
					WHERE FOD.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST)) AND FOD.ID_SINAV = @ID_SINAV
					GROUP BY FOD.SUBEAD, FOD.SINIFAD, K.TCKIMLIKNO, K.AD, K.SOYAD
					ORDER BY SUBEAD, SINIFAD, ADSOYAD
				END
			END

			IF @ISLEM = 13	--	ÖĞRENCİ DÖNEM DETAY			
			BEGIN
			
				IF @DONEM IS NULL
					SET @DONEM = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)

				SELECT ISNULL((				
					SELECT	 D.TCKIMLIKNO
							,ADSOYAD	= CONCAT_WS(' ', D.AD, D.SOYAD)
							,KADEME3
							,SUBEAD
							,SINIFAD
							,ID_SUBE
							,ID_SINIF
							,FOTOGRAF	= ISNULL(R.FOTOGRAF,'')
					FROM OkyanusDB.dbo.vw_OgrenciDetayTum	D
					LEFT JOIN OkyanusDB.dbo.v3Resim			R	ON	R.TCKIMLIKNO	= D.TCKIMLIKNO
																AND R.SIRANO		= 1
					WHERE	D.DONEM			= @DONEM
						AND D.TCKIMLIKNO	= @TC_OGRENCI
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
				
			END

			IF @ISLEM = 14	--	Öğrenci Listele by Veli Sınav
			BEGIN

				IF @ID_KADEME IS NULL
					SET @ID_KADEME = 0

				SELECT DISTINCT K.AD ,K.SOYAD ,K.TCKIMLIKNO,ID_KADEME
				FROM V3KULLANici			K	
				JOIN V3OgrenciVeli			V	ON	V.TCKIMLIKNO_OGR	= K.TCKIMLIKNO
				JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO		= K.TCKIMLIKNO
				JOIN SinavOgrenci			SO  ON  SO.TCKIMLIKNO       = O.TCKIMLIKNO --SINAV ÖĞRENCİ
				JOIN Sinav					S   ON	S.ID_SINAV			= SO.ID_SINAV
												AND S.DONEM				= OkyanusDB.dbo.fn_AktifDonem()
				JOIN vw_SubeSinifGrupKademe	GS	ON	GS.ID_SINIF			= O.ID_SINIF
				WHERE V.TCKIMLIKNO=@TCKIMLIKNO
					AND (@ID_KADEME = 0 OR GS.ID_KADEME = @ID_KADEME )
			END
		
			DROP TABLE IF EXISTS #KADEMELER
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2

	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Sinav2]...';


GO
ALTER procedure [dbo].[sp_Sinav2]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@SINAVSORUISLEM		BIT				= 0,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAVTURUS		VARCHAR(MAX)	= NULL,
	@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@TAKMAAD			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SUBES			NVARCHAR(MAX)	= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SINAVOTURUM		tinyint			= NULL,
	@UNITEKOD			VARCHAR(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@TCLIST				VARCHAR(MAX)	= NULL,
	@ID_SINAVDERSLIST	VARCHAR(MAX)	= NULL,
	@DURUM				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@DURUMDEGER			BIT				= NULL,
	@ESKIDONEMSINIF		BIT				= 0,
	@ID_TYTSECIMTUR		INT				= NULL,
	@BARAJ				VARCHAR(MAX)	= NULL,
	@ID_SORUBANKASI		int				= NULL,
	@KOD				VARCHAR(MAX)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,TC_OGRENCI					= @TC_OGRENCI			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,DONEM						= @DONEM				
			,OGRENCIDONEM				= @OGRENCIDONEM		
			,SINAVSORUISLEM				= @SINAVSORUISLEM		
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,ID_SINAVTURUS				= @ID_SINAVTURUS		
			,KADEME						= @KADEME				
			,ID_SINAV					= @ID_SINAV			
			,ID_SINAVDERS				= @ID_SINAVDERS		
			,TAKMAAD					= @TAKMAAD			
			,ID_DERS					= @ID_DERS			
			,ID_SUBE					= @ID_SUBE			
			,ID_SUBES				 	= @ID_SUBES			
			,DOSYAADI					= @DOSYAADI			
			,DOSYAGUID					= @DOSYAGUID			
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA		
			,SINAVOTURUM				= @SINAVOTURUM		
			,UNITEKOD					= @UNITEKOD			
			,SQLJSON					= @SQLJSON			
			,TCLIST						= @TCLIST				
			,ID_SINAVDERSLIST			= @ID_SINAVDERSLIST	
			,DURUM						= @DURUM				
			,TARIH						= @TARIH				
			,DURUMDEGER					= @DURUMDEGER			
			,ESKIDONEMSINIF				= @ESKIDONEMSINIF		
			,ID_TYTSECIMTUR				= @ID_TYTSECIMTUR		
			,BARAJ						= @BARAJ				
			,ID_SORUBANKASI				= @ID_SORUBANKASI		
			,KOD						= @KOD				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN

			--IF (SELECT COUNT(*) FROM SinavDegerlendir WHERE AKTIF = 1 AND ID_SINAV = @ID_SINAV) > 0
			--BEGIN
			--	RAISERROR ('Sınav değerlendirme işlemi yapılıyor daha sonra tekrar deneyiniz.' , -- Message text.
			--		16, -- Severity.
			--		1 -- State.
			--		);
			--END
			--ELSE
			--BEGIN

			DECLARE @ONLINESINAV BIT = NULL

			BEGIN
				SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
				DECLARE @AKTIFDONEM VARCHAR(4)=(	SELECT  DONEM FROM v3AktifDonem WHERE AKTIF=1)

				DECLARE  @OZELSINAVGOR BIT=0
				IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) )
				BEGIN
					SET @OZELSINAVGOR=1
				END
			
				DECLARE @ID_KADEME3ESKI INT  = @ID_KADEME3

					IF @DONEM IS NULL OR @DONEM=''
					BEGIN
						SELECT @DONEM= DONEM FROM v3AktifDonem WHERE AKTIF=1
					END

					IF NOT EXISTS ( SELECT 1 FROM v3AktifDonem WHERE DONEM = @OGRENCIDONEM)
					BEGIN
						SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
					END 

					DECLARE @DONEMFARKI INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
					IF  (@DONEMFARKI<>0) AND (SELECT @ESKIDONEMSINIF ) = 0
					BEGIN
						DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
						SELECT @ID_KADEME3ESKI=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
					END
			END

				IF @ISLEM = 0	--	Dönem Listele
				BEGIN
					SELECT * FROM [dbo].[v3AktifDonem] order by DONEM desc
				END
				IF @ISLEM = 1	--	Sınav Türü Listele
				BEGIN
					IF 4 IN (SELECT ID_KULLANICITIPI FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO)	--	ÖĞRENCİ İSE YALNIZCA GİRDİĞİ SINAV TÜRLERİ
					BEGIN	
						SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD FROM SinavOgrenci SO
						INNER JOIN Sinav S ON S.ID_SINAV=SO.ID_SINAV
						INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
						WHERE SO.TCKIMLIKNO = @TCKIMLIKNO
					END
					ELSE
					BEGIN
						SELECT ID_SINAVTURU, AD, KISAAD FROM SinavTuru where AKTIF=1
					END
				END
				IF @ISLEM = 2	--	Sınav Grup Listele
				BEGIN
					select distinct st.ID_KADEME3, k.AD
					from		  [dbo].[vw_SubeGrupSinif]	sgs
					Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
					Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
					Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
					Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
					Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
					where	(@ID_SUBES IS NULL OR @ID_SUBES='[]' OR sgs.ID_SUBE in (select value from openjson( @ID_SUBES)))  AND
							(@ID_SUBE IS NULL OR @ID_SUBE=0 OR @ID_SUBE=sgs.ID_SUBE) AND
							((@KADEME IS NULL AND st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) OR (@KADEME IS NOT NULL AND st.ID_KADEME=@KADEME))
					--ORDER BY k.SIRA

				END
				IF @ISLEM = 3	--	Sınav Ders Listele
				BEGIN
					SELECT (
						SELECT 
						KADEME		AS 'id',
						KADEME		AS 'text', 
						(
							SELECT 
							ID_DERS AS 'id', 
							AD		AS 'text'
							FROM [dbo].[v3SinavDers] sd 
							WHERE sd.ID_KADEME3=xTable.ID_KADEME3 
							ORDER BY sd.AD
							FOR JSON PATH
						) AS 'children'
						from
						(
							SELECT k3.AD AS 'KADEME', k3.ID_KADEME3 AS 'ID_KADEME3'
							FROM		[dbo].[v3SinavDers]		sd
							INNER JOIN	[dbo].[v3Kademe3]		k3	ON	k3.ID_KADEME3 = sd.ID_KADEME3
							GROUP BY k3.AD, k3.ID_KADEME3
						) AS xTable
						ORDER BY ID_KADEME3
						FOR JSON PATH
					) AS 'JSON'
				END
				IF @ISLEM = 4	--	Sınav Ekle
				BEGIN
					BEGIN TRANSACTION [Tran4]
					BEGIN TRY    
						---------
						--SINAV--
						---------
						DECLARE @ID_SINAVLIST TABLE (ID_SINAV INT)
						INSERT INTO [dbo].[Sinav]
								   ([ID_SINAVTURU] ,[AD] ,[KOD] ,[RAPORBASLIK] ,[DONEM] ,[ID_KADEME3] ,[SINAVTARIH] ,[OZEL] ,[FREKANSHESAPLA] ,[PUANGIZLE] ,[YUKLEMEKAPAT] ,[CEVAPANAHTARIYUKLEMEKAPAT],ONLINESINAV,[YANLISSAYISI], [OLCEKSINAVI], [KYE_TCKIMLIKNO])
						OUTPUT INSERTED.ID_SINAV INTO @ID_SINAVLIST(ID_SINAV)
						select		[ID_SINAVTURU] ,[AD] ,[KOD] ,[RAPORBASLIK] ,(select DONEM from [dbo].[v3AktifDonem] where AKTIF=1) as [DONEM],[ID_KADEME3] ,convert(datetime, [SINAVTARIH], 103) ,[OZEL] ,[FREKANSHESAPLA] ,CASE WHEN (SELECT COUNT(1) FROM SinavPuanTuru WHERE ID_SINAVTURU=J.[ID_SINAVTURU])>0 THEN [PUANGIZLE] ELSE 1 END ,[YUKLEMEKAPAT] ,[CEVAPANAHTARIYUKLEMEKAPAT],ONLINESINAV ,[YANLISSAYISI] ,[OLCEKSINAVI] ,@TCKIMLIKNO 
						from OPENJSON(@SQLJSON)
						with
						(
							[ID_SINAVTURU] [int],
							[AD] [varchar](50),
							[KOD] [varchar](50),
							[RAPORBASLIK] [varchar](MAX),
							[ID_KADEME3] [nchar](10),
							[SINAVTARIH] [varchar](50),
							[OZEL] [bit],
							[FREKANSHESAPLA] [bit],
							[PUANGIZLE] [bit],
							[YUKLEMEKAPAT] [bit],
							[CEVAPANAHTARIYUKLEMEKAPAT] [bit],
							[ONLINESINAV] [bit],
							[YANLISSAYISI] [tinyint],
							[OLCEKSINAVI] [bit]
						) AS J

						
						SET @ONLINESINAV = IIF (EXISTS((SELECT TOP 1 1 FROM Sinav S WHERE ID_SINAV = (select ID_SINAV from @ID_SINAVLIST) AND S.ONLINESINAV = 1)),1, 0 )
						-------------
						--SINAVDERS--
						-------------
						DECLARE @SINAVDERS TABLE (ID_SINAVDERS INT,ID_DERS varchar(20), BOLUMNO int)
						INSERT INTO [dbo].[SinavDers]
								   ([ID_SINAV]
								   ,[BOLUMNO]
								   ,[ID_DERS]
								   ,[TAKMAAD])
						output INSERTED.ID_SINAVDERS, inserted.ID_DERS, inserted.BOLUMNO into @SINAVDERS(ID_SINAVDERS, ID_DERS, BOLUMNO)
						select (select ID_SINAV from @ID_SINAVLIST) as [ID_SINAV], SIRA as [BOLUMNO], ID_DERS=id, CASE WHEN TAKMAAD='' THEN text ELSE TAKMAAD END as TAKMAAD from OPENJSON(@SQLJSON,'$.JSONDERS')
						with
						(
							id varchar(20),
							SIRA int,
							text varchar(max),
							TAKMAAD varchar(max)
						)
						------------
						--KITAPCIK--
						------------
						DECLARE @KITAPCIKSAYISI int = (select KITAPCIKSAYISI from OPENJSON(@SQLJSON)with(KITAPCIKSAYISI int))

						IF @ONLINESINAV = 1
							SET @KITAPCIKSAYISI = 1



						CREATE TABLE #HARFLER (AD char(1))
						DECLARE @asciiCode INT= 65 WHILE @asciiCode <= 90 BEGIN
							INSERT  #HARFLER (AD) SELECT  CHAR(@asciiCode)
							SELECT  @asciiCode = @asciiCode + 1
						END

						DECLARE @ID_SINAVKITAPCIK TABLE (ID_SINAVKITAPCIK INT, AD CHAR(1))
						INSERT INTO [dbo].[SinavKitapcik]
								   ([ID_SINAV]
								   ,[AD])
						output INSERTED.ID_SINAVKITAPCIK, INSERTED.AD into @ID_SINAVKITAPCIK(ID_SINAVKITAPCIK, AD)
						select top(@KITAPCIKSAYISI)(select ID_SINAV from @ID_SINAVLIST) as [ID_SINAV], AD from #HARFLER ORDER BY AD
						drop table #HARFLER
						------------------
						--SINAVANAHTAR A--
						------------------
						INSERT INTO [dbo].[SinavAnahtar]
								   ([ID_SINAVKITAPCIK]
								   ,[ID_SINAVDERS]
								   ,[ID_SINAVSORUTURU]
								   ,[SORUNO_A]
								   ,[CEVAP]
								   ,[OPTIKKARAKTERSAYISI]
								   ,[KOD]
								   ,[KATSAYI]
								   ,[SORUNO]
								   ,[ID_BILGI]
								   ,[ID_BILISSELSUREC]
								   ,ID_SORUBANKASI)
						SELECT
							(select ID_SINAVKITAPCIK from @ID_SINAVKITAPCIK WHERE AD='A'),
							sd.ID_SINAVDERS as ID_SINAVDERS,
							JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
							JSON_Value (s.value, '$.SORUNO') as SORUNOA, 
							CEVAP = CASE	WHEN SBC.ID_CEVAP	IS NULL THEN JSON_Value (s.value, '$.ACEVAP')
											WHEN SBC.CEVAPNO = 1		THEN 'A'
											WHEN SBC.CEVAPNO = 2		THEN 'B'
											WHEN SBC.CEVAPNO = 3		THEN 'C'
											WHEN SBC.CEVAPNO = 4		THEN 'D'
											WHEN SBC.CEVAPNO = 5		THEN 'E'
										END,
							--JSON_Value (s.value, '$.ACEVAP') as CEVAP,
							JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (s.value, '$.KOD') as KOD,
							CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
							JSON_Value (s.value, '$.SORUNO') as SORUNO ,
							JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI ,
							JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
							SSD.ID_SORU
						FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
						CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
						INNER JOIN @SINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')						
						LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
						LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
						LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
						LEFT JOIN SoruBankasi.dbo.Cevap		SBC	ON	SBC.ID_SORU	= SSD.ID_SORU AND DEGER = '1'
						DELETE from @ID_SINAVKITAPCIK where ID_SINAVKITAPCIK=(select ID_SINAVKITAPCIK from @ID_SINAVKITAPCIK WHERE AD='A')--A kitapçığı siliniyor

						----------------------
						--SINAVANAHTAR DIGER--
						----------------------
						declare @ID int=(select min(ID_SINAVKITAPCIK) from @ID_SINAVKITAPCIK)
						while @ID is not null
						begin
							INSERT INTO [dbo].[SinavAnahtar]
									   ([ID_SINAVKITAPCIK]
									   ,[ID_SINAVDERS]
									   ,[ID_SINAVSORUTURU]
									   ,[SORUNO_A]
									   ,[CEVAP]
									   ,[OPTIKKARAKTERSAYISI]
									   ,[KOD]
									   ,[KATSAYI]
									   ,[SORUNO]
									   ,[ID_BILGI]
									   ,[ID_BILISSELSUREC]
									   ,ID_SORUBANKASI)
							select 
								ID_SINAVKITAPCIK = @ID,
								sd.ID_SINAVDERS as ID_SINAVDERS,
								JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
								JSON_Value (s.value, '$.SORUNO') as SORUNOA,
								JSON_Value (s.value, '$.ACEVAP') as CEVAP,
								JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
								JSON_Value (s.value, '$.KOD') as KOD,
								CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
								JSON_Value (k.value, '$.SIRA') as SORUNO,  
								JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI ,
								JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
								SSD.ID_SORU
							FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
							CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
							CROSS APPLY OPENJSON (s.value, '$.KARSILIKLIST') as k
							INNER JOIN @SINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
							LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
							LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
							LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
							where JSON_Value (k.value, '$.KITAPCIK')=(select AD from SinavKitapcik where ID_SINAVKITAPCIK = @ID)

							select @ID = min(ID_SINAVKITAPCIK) from @ID_SINAVKITAPCIK where ID_SINAVKITAPCIK > @ID
						end
						select ID_SINAV from @ID_SINAVLIST
						COMMIT TRANSACTION [Tran4]
					END TRY
					BEGIN CATCH
						ROLLBACK TRANSACTION [Tran4]

						SELECT 
							@ErrorSeverity	= ERROR_SEVERITY(),
							@ErrorState		= ERROR_STATE()
							
						SELECT @MSG = 'Kayıt işlemi sırasında sistemsel bir hata meydana geldi! Lütfen daha sonra tekrar deneyiniz...'
			
						RAISERROR (@MSG , -- Message text.
									@ErrorSeverity, -- Severity.
									@ErrorState -- State.
									);
					END CATCH;
				END
				IF @ISLEM = 5	--	Sınav Listele
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,S.RAPORBASLIK
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.CEVAPANAHTARIYUKLEMEKAPAT AS CEVAPANAHTARIYUKLEMEKAPAT
							,S.ONLINESINAV
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3ESKI and S.AKTIF = 1
						AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 6	--	Sınav Bilgi Getir
				BEGIN

					--SELECT SD.ID_DERS, A.KOD, A.AD
					--INTO #SinavDers FROM SinavDers	SD
					----CROSS APPLY [dbo].[fn_DersUniteListe](SD.ID_DERS, NULL)	DU
					--INNER JOIN v3SinavDersUnite		A	ON A.ID_DERS = SD.ID_DERS
					--WHERE SD.ID_SINAV = @ID_SINAV

					DECLARE @ID_SINAVKITAPCIKX INT = (select  top 1  ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD='A')

					Select (
						Select 
							ID_SINAVTURU, 
							s.AD as AD, 
							(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) as KITAPCIKSAYISI, 
							s.KOD, 
							s.RAPORBASLIK,
							ID_KADEME3, 
							Convert(varchar, SINAVTARIH, 103) as SINAVTARIH,
							OZEL,
							FREKANSHESAPLA,
							PUANGIZLE,
							YUKLEMEKAPAT,
							CEVAPANAHTARIYUKLEMEKAPAT,
							ONLINESINAV,
							YANLISSAYISI,
							OLCEKSINAVI,
							JSONDERS.ID_DERS as id,
							JSONDERS.ID_SINAVDERS as id_sinavders,
							JSONDERS.TAKMAAD as text,
							(select count(1)/(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) from SinavAnahtar sa where ID_SINAVDERS=JSONDERS.ID_SINAVDERS) as SORUSAYISI,
							JSONDERS.BOLUMNO as SIRA,
							SORULIST.SORUNO_A as SORUNO,
							SORULIST.ID_SINAVSORUTURU as SORUTURU,
							SORULIST.CEVAP as ACEVAP,
							SORULIST.KOD,
							ISNULL(CAST(SORULIST.ID_SORUBANKASI AS VARCHAR), '') AS ID_SORUBANKASI,
							ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
							ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC, 
							UNITE = ISNULL(SD.AD, ''), 
							SORULIST.OPTIKKARAKTERSAYISI as KARAKTERSAYISI,
							SORULIST.KATSAYI,
							(select (select AD from SinavKitapcik where ID_SINAVKITAPCIK=ssa.ID_SINAVKITAPCIK) as KITAPCIK
								, SORUNO as SIRA 
							from SinavAnahtar ssa 
							where ID_SINAVKITAPCIK in (	select ID_SINAVKITAPCIK 
														from SinavKitapcik 
														where	ID_SINAV=@ID_SINAV 
															and AD<>'A') 
								and SORUNO_A=SORULIST.SORUNO 
								and ID_SINAVDERS=JSONDERS.ID_SINAVDERS 
							for json path) AS KARSILIKLIST
							,s.DONEM
						from	   Sinav			s
						inner join SinavDers		JSONDERS		on	JSONDERS.ID_SINAV		= s.ID_SINAV 
						LEFT  join SinavAnahtar		SORULIST		on	SORULIST.ID_SINAVDERS	= JSONDERS.ID_SINAVDERS and SORULIST.ID_SINAVKITAPCIK=@ID_SINAVKITAPCIKX
						LEFT  JOIN v3SinavDersUnite	SD				ON	SD.KOD					= SORULIST.KOD
						where s.ID_SINAV = @ID_SINAV
						order by BOLUMNO,SORULIST.SORUNO_A
					for json auto) as J

					--DROP TABLE #SinavDers

				END
				IF @ISLEM = 7	--	Sınav Güncelle
				BEGIN					
					BEGIN TRANSACTION [Tran7]
					BEGIN TRY    
						---------
						--SINAV--
						---------
						UPDATE
							[dbo].[Sinav]
						SET
							[ID_SINAVTURU] = J.ID_SINAVTURU
							,[AD] = J.AD
							,[KOD] = J.KOD
							,[RAPORBASLIK] = J.RAPORBASLIK
							,[ID_KADEME3] = J.ID_KADEME3
							,[SINAVTARIH] = convert(datetime, J.SINAVTARIH, 103)
							,[OZEL] = J.OZEL
							,[FREKANSHESAPLA] = J.FREKANSHESAPLA
							,[PUANGIZLE] = CASE WHEN (SELECT COUNT(1) FROM SinavPuanTuru WHERE ID_SINAVTURU=J.ID_SINAVTURU)>0 THEN J.[PUANGIZLE] ELSE 1 END
							,[YUKLEMEKAPAT] = J.YUKLEMEKAPAT
							,[CEVAPANAHTARIYUKLEMEKAPAT]  = J.CEVAPANAHTARIYUKLEMEKAPAT
							,[ONLINESINAV] = J.[ONLINESINAV]
							,[YANLISSAYISI] = J.YANLISSAYISI
							,[OLCEKSINAVI] = J.OLCEKSINAVI
							,[GUN_TCKIMLIKNO] = @TCKIMLIKNO
							,[GUN_TARIH] = GETDATE()
						FROM
							OPENJSON(@SQLJSON)
							with
							(
								[ID_SINAVTURU] [int],
								[AD] [varchar](50),
								[KOD] [varchar](50),
								[RAPORBASLIK] [varchar](MAX),
								[ID_KADEME3] int,
								[SINAVTARIH] [varchar](50),
								[OZEL] [bit],
								[FREKANSHESAPLA] [bit],
								[PUANGIZLE] [bit],
								[YUKLEMEKAPAT] [bit],
								[CEVAPANAHTARIYUKLEMEKAPAT]  [bit],
								[ONLINESINAV]  [bit],
								[YANLISSAYISI] [tinyint],
								[OLCEKSINAVI] [bit]
							) as J
						WHERE
							[dbo].[Sinav].[ID_SINAV] = @ID_SINAV
							
						SET @ONLINESINAV = IIF (EXISTS((SELECT TOP 1 1 FROM Sinav S WHERE ID_SINAV = @ID_SINAV AND S.ONLINESINAV = 1)),1, 0 )
						---------------
						--SORUBANKASI--
						---------------
						SELECT SI.ID_SORUILISKI, SD.ID_SINAV, SD.ID_DERS, SORUNO_A
						INTO #TEMPSORUILISKI
						FROM SinavAnahtar SA
						INNER JOIN SinavKitapcik SK ON SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK
						INNER JOIN SinavDers SD ON SD.ID_SINAVDERS = SA.ID_SINAVDERS
						INNER JOIN SoruBankasi.dbo.SoruIliski SI ON SI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						WHERE SK.ID_SINAV = @ID_SINAV AND SK.AD = 'A'

						---------
						--Silme--
						---------
						DELETE sa
						FROM SinavAnahtar sa
						INNER JOIN SinavKitapcik sk
							ON sk.ID_SINAVKITAPCIK=sa.ID_SINAVKITAPCIK
						WHERE sk.ID_SINAV=@ID_SINAV

						DELETE sk
						FROM SinavKitapcik sk
						WHERE sk.ID_SINAV=@ID_SINAV

						--SINAV KRİTER
						SELECT SNK.*, SNKD.ID_SINAVDERS, SD.TAKMAAD, SD.ID_DERS
						INTO #TempSinavNetKriterDers
						FROM [Pusulam].[dbo].[SinavNetKriter] SNK
						JOIN [Pusulam].[dbo].[SinavNetKriterDers] SNKD ON SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
						JOIN [Pusulam].[dbo].[SinavDers] SD ON SD.ID_SINAVDERS = SNKD.ID_SINAVDERS
						WHERE SD.ID_SINAV = @ID_SINAV

						SELECT DISTINCT ID_SINAVNETKRITER, NET, ID_SINAVPUANTURU
						INTO #TempSinavNetKriter
						FROM #TempSinavNetKriterDers

						SELECT *
						INTO #TempSinavTYTSecimTurKriter
						FROM [Pusulam].[dbo].[SinavTYTSecimTurKriter]
						WHERE ID_SINAV = @ID_SINAV

						--TempSinavOptikDers
						SELECT sd.ID_SINAV,sd.ID_DERS,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM,TAKMAAD INTO #TempSinavOptikDers 
						FROM SinavOptikDers sod
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV						

						DELETE sod
						FROM SinavOptikDers sod
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						--TempSinavKatsayi
						SELECT sd.ID_SINAV,sd.TAKMAAD,ID_SINAVPUANTURU,KATSAYI INTO #TempSinavKatsayi
						FROM SinavKatsayi sk
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sk.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE sk
						FROM SinavKatsayi sk
						INNER JOIN SinavDers sd on sd.ID_SINAVDERS=sk.ID_SINAVDERS
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE sd
						FROM SinavDers sd
						WHERE sd.ID_SINAV=@ID_SINAV

						DELETE soc
						FROM SinavOgrenciCevap soc
						INNER JOIN SinavOgrenciCevapBolum socb on socb.ID_SINAVOGRENCICEVAPBOLUM=soc.ID_SINAVOGRENCICEVAPBOLUM
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=socb.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE socb
						FROM SinavOgrenciCevapBolum socb
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=socb.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE sos
						FROM SinavOgrenciSonuc sos
						INNER JOIN SinavOgrenci so on so.ID_SINAVOGRENCI=sos.ID_SINAVOGRENCI
						WHERE so.ID_SINAV=@ID_SINAV

						DELETE sop
						FROM SinavOgrenciPuan sop					
						WHERE sop.ID_SINAV=@ID_SINAV

						DELETE sot
						FROM SinavOgrenciToplam sot
						WHERE sot.ID_SINAV=@ID_SINAV

						DELETE so
						FROM SinavOgrenci so
						WHERE so.ID_SINAV=@ID_SINAV

						-------------
						--SINAVDERS--
						-------------
						DECLARE @USINAVDERS TABLE (ID_SINAVDERS INT,ID_DERS varchar(20), BOLUMNO int)
						INSERT INTO [dbo].[SinavDers]
									([ID_SINAV]
									,[BOLUMNO]
									,[ID_DERS]
									,[TAKMAAD])
						output INSERTED.ID_SINAVDERS, inserted.ID_DERS, inserted.BOLUMNO into @USINAVDERS(ID_SINAVDERS, ID_DERS, BOLUMNO)
						select @ID_SINAV as [ID_SINAV], SIRA as [BOLUMNO], ID_DERS=id, CASE WHEN TAKMAAD='' THEN text ELSE TAKMAAD END as TAKMAAD 
						from OPENJSON(@SQLJSON,'$.JSONDERS')
						with
						(
							id varchar(20),
							SIRA int,
							text varchar(max),
							TAKMAAD varchar(max)
						)

						--------------------------------------------
						--EŞLEŞEN OPTİK VE KATSAYILARI GERİ KAYDET--
						--------------------------------------------
						INSERT INTO [dbo].[SinavOptikDers]
									([ID_SINAVDERS]
									,[BASLANGIC]
									,[OPTIKKARAKTERSAYISI]
									,[OTURUM])
								SELECT SD.ID_SINAVDERS, TSOD.BASLANGIC, TSOD.OPTIKKARAKTERSAYISI,OTURUM FROM #TempSinavOptikDers TSOD
								INNER JOIN SinavDers SD ON SD.ID_SINAV=TSOD.ID_SINAV AND SD.ID_DERS=TSOD.ID_DERS AND SD.TAKMAAD=TSOD.TAKMAAD
						DROP TABLE #TempSinavOptikDers

						INSERT INTO [dbo].[SinavKatsayi]
									([ID_SINAV]
									,[ID_SINAVPUANTURU]
									,[ID_SINAVDERS]
									,[KATSAYI])
								SELECT TSK.ID_SINAV, TSK.ID_SINAVPUANTURU, SD.ID_SINAVDERS, TSK.KATSAYI FROM #TempSinavKatsayi TSK
								INNER JOIN SinavDers SD ON SD.ID_SINAV=TSK.ID_SINAV AND SD.TAKMAAD=TSK.TAKMAAD
						DROP TABLE #TempSinavKatsayi

						--------------------------------------------
						--EŞLEŞEN KRİTERLERİ GERİ KAYDET--
						--------------------------------------------
						DECLARE @ID_SINAVNETKRITERTABLE7 TABLE (ID_SINAVNETKRITER INT, ID_SINAVNETKRITERESKI INT)
						MERGE INTO SinavNetKriter 
						USING #TempSinavNetKriter AS TEMP ON 1 = 0
						WHEN NOT MATCHED THEN
						INSERT ([NET] ,[ID_SINAVPUANTURU])
						VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
						OUTPUT TEMP.ID_SINAVNETKRITER, inserted.ID_SINAVNETKRITER
						INTO @ID_SINAVNETKRITERTABLE7 (ID_SINAVNETKRITERESKI, ID_SINAVNETKRITER);

						INSERT INTO SinavNetKriterDers (ID_SINAVNETKRITER, ID_SINAVDERS)
						SELECT DISTINCT ID_SNK.ID_SINAVNETKRITER, SD.ID_SINAVDERS
						FROM @ID_SINAVNETKRITERTABLE7 ID_SNK
						JOIN #TempSinavNetKriterDers SNKD ON SNKD.ID_SINAVNETKRITER = ID_SNK.ID_SINAVNETKRITERESKI
						JOIN SinavDers SD ON SD.ID_SINAV = @ID_SINAV AND SD.ID_DERS = SNKD.ID_DERS AND SD.TAKMAAD = SNKD.TAKMAAD

						INSERT INTO SinavTYTSecimTurKriter (ID_SINAV, ID_TYTSECIMTUR, PUAN)
						SELECT DISTINCT ID_SINAV, ID_TYTSECIMTUR, PUAN
						FROM #TempSinavTYTSecimTurKriter
						
						DROP TABLE #TempSinavNetKriter
						DROP TABLE #TempSinavNetKriterDers
						DROP TABLE #TempSinavTYTSecimTurKriter

						------------
						--KITAPCIK--
						------------
						DECLARE @UKITAPCIKSAYISI int = (select KITAPCIKSAYISI from OPENJSON(@SQLJSON)with(KITAPCIKSAYISI int))
												
						IF @ONLINESINAV = 1
							SET @KITAPCIKSAYISI = 1

						CREATE TABLE #UHARFLER (AD char(1))
						DECLARE @UasciiCode INT= 65 WHILE @UasciiCode <= 90 BEGIN
							INSERT  #UHARFLER (AD) SELECT  CHAR(@UasciiCode)
							SELECT  @UasciiCode = @UasciiCode + 1
						END

						DECLARE @UID_SINAVKITAPCIK TABLE (ID_SINAVKITAPCIK INT, AD CHAR(1))
						INSERT INTO [dbo].[SinavKitapcik]
									([ID_SINAV]
									,[AD])
						output INSERTED.ID_SINAVKITAPCIK, inserted.AD into @UID_SINAVKITAPCIK(ID_SINAVKITAPCIK, AD)
						select top(@UKITAPCIKSAYISI)@ID_SINAV as [ID_SINAV], AD from #UHARFLER ORDER BY AD
						drop table #UHARFLER

						------------------
						--SINAVANAHTAR A--
						------------------
						INSERT INTO [dbo].[SinavAnahtar]
									([ID_SINAVKITAPCIK]
									,[ID_SINAVDERS]
									,[ID_SINAVSORUTURU]
									,[SORUNO_A]
									,[CEVAP]
									,[OPTIKKARAKTERSAYISI]
									,[KOD]
									,[KATSAYI]
									,[SORUNO]
									,[ID_BILGI]
									,[ID_BILISSELSUREC]
									,[ID_SORUBANKASI])
						SELECT
							(select ID_SINAVKITAPCIK from @UID_SINAVKITAPCIK WHERE AD = 'A'),
							sd.ID_SINAVDERS as ID_SINAVDERS,
							JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
							JSON_Value (s.value, '$.SORUNO') as SORUNOA, 
							
							CEVAP = CASE	WHEN SBC.ID_CEVAP	IS NULL THEN JSON_Value (s.value, '$.ACEVAP')
											WHEN SBC.CEVAPNO = 1		THEN 'A'
											WHEN SBC.CEVAPNO = 2		THEN 'B'
											WHEN SBC.CEVAPNO = 3		THEN 'C'
											WHEN SBC.CEVAPNO = 4		THEN 'D'
											WHEN SBC.CEVAPNO = 5		THEN 'E'
										END,
							--JSON_Value (s.value, '$.ACEVAP') as CEVAP,
							JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (s.value, '$.KOD') as KOD,
							CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
							JSON_Value (s.value, '$.SORUNO') as SORUNO,  
							JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI,
							JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
							SSD.ID_SORU
						FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
						CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
						INNER JOIN @USINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
						LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
						LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
						LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD')  AND SSD.SILINDI = 0
						LEFT JOIN SoruBankasi.dbo.Cevap		SBC	ON	SBC.ID_SORU	= SSD.ID_SORU AND DEGER = '1'
						DELETE from @UID_SINAVKITAPCIK where ID_SINAVKITAPCIK=(select ID_SINAVKITAPCIK from @UID_SINAVKITAPCIK WHERE AD = 'A')--A kitapçığı siliniyor

						----------------------
						--SINAVANAHTAR DIGER--
						----------------------
						declare @UID int=(select min(ID_SINAVKITAPCIK) from @UID_SINAVKITAPCIK)
						while @UID is not null
						begin
							INSERT INTO [dbo].[SinavAnahtar]
										([ID_SINAVKITAPCIK]
										,[ID_SINAVDERS]
										,[ID_SINAVSORUTURU]
										,[SORUNO_A]
										,[CEVAP]
										,[OPTIKKARAKTERSAYISI]
										,[KOD]
										,[KATSAYI]
										,[SORUNO]
										,[ID_BILGI]
										,[ID_BILISSELSUREC]
										,[ID_SORUBANKASI])
							select 
								ID_SINAVKITAPCIK = @UID,
								sd.ID_SINAVDERS as ID_SINAVDERS,
								JSON_Value (s.value, '$.SORUTURU') as ID_SINAVSORUTURU,
								JSON_Value (s.value, '$.SORUNO') as SORUNOA,
								JSON_Value (s.value, '$.ACEVAP') as CEVAP,
								JSON_Value (s.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
								JSON_Value (s.value, '$.KOD') as KOD,
								CONVERT(float,REPLACE(JSON_Value (s.value, '$.KATSAYI'),',','.')) as KATSAYI,
								JSON_Value (k.value, '$.SIRA') as SORUNO,  
								JSON_Value (s.value, '$.ID_BILGI') as ID_BILGI,
								JSON_Value (s.value, '$.ID_BILISSELSUREC') as ID_BILISSELSUREC,
								SSD.ID_SORU
							FROM OPENJSON (@SQLJSON, '$.JSONDERS') as d
							CROSS APPLY OPENJSON (d.value, '$.SORULIST') as s
							CROSS APPLY OPENJSON (s.value, '$.KARSILIKLIST') as k
							INNER JOIN @USINAVDERS sd on sd.ID_DERS= JSON_Value (d.value, '$.id') and sd.BOLUMNO=JSON_Value(d.value, '$.SIRA')
							LEFT JOIN SoruBankasi.dbo.Soru SS ON SS.ID_SORU = JSON_Value (s.value, '$.ID_SORUBANKASI') 
							LEFT JOIN Sinav JS ON JS.ID_SINAV = @ID_SINAV 
							LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON SSD.ID_SORU = SS.ID_SORU AND JS.ID_KADEME3 = SSD.ID_SINAVGRUP AND SSD.UNITE = JSON_Value (s.value, '$.KOD') AND SSD.SILINDI = 0
							where JSON_Value (k.value, '$.KITAPCIK')=(select AD from SinavKitapcik where ID_SINAVKITAPCIK = @UID)

							select @UID = min(ID_SINAVKITAPCIK) from @UID_SINAVKITAPCIK where ID_SINAVKITAPCIK > @UID
						END
			

						UPDATE Sinav SET DURUM = 0 WHERE ID_SINAV = @ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR

						---------------
						--SORUBANKASI--
						---------------
						UPDATE SI SET SI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						FROM SoruBankasi.dbo.SoruIliski SI
						INNER JOIN #TEMPSORUILISKI T ON T.ID_SORUILISKI = SI.ID_SORUILISKI
						INNER JOIN SinavDers SD ON SD.ID_SINAV = T.ID_SINAV AND SD.ID_DERS = T.ID_DERS
						INNER JOIN SinavKitapcik SK ON SK.ID_SINAV = T.ID_SINAV AND SK.AD = 'A'
						INNER JOIN SinavAnahtar SA ON SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK AND SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.SORUNO_A = T.SORUNO_A

						DROP TABLE IF EXISTS #TEMPSORUILISKI
						COMMIT TRANSACTION [Tran7]
					END TRY
					BEGIN CATCH
						ROLLBACK TRANSACTION [Tran7]

						SELECT 
							@ErrorSeverity	= ERROR_SEVERITY(),
							@ErrorState		= ERROR_STATE()
							
						SELECT @MSG = 'Güncelleme işlemi sırasında sistemsel bir hata meydana geldi! Lütfen daha sonra tekrar deneyiniz...'
			
						RAISERROR (@MSG , -- Message text.
									@ErrorSeverity, -- Severity.
									@ErrorState -- State.
									);
					END CATCH;
				END
				IF @ISLEM = 8	--	Sınav Ders Konu Listele
				BEGIN
				
					EXEC [dbo].[sp_DersUniteGetir] @ID_DERS = @ID_DERS

					--SELECT ID_DERS, KOD, AD, SECILEBILIR FROM [dbo].[fn_DersUniteListe](@ID_DERS, NULL)			
				
				END
				IF @ISLEM = 9	--	Sınav Katsayı Listele
				BEGIN
					SELECT
					(
						SELECT	 ID_SINAV = @ID_SINAV
								,SPT.ID_SINAVPUANTURU
								,PUANTURU = SPT.AD
								,KATSAYILIST = ISNULL(
								(
									SELECT	 SK.ID_SINAVKATSAYI
											,S.ID_SINAV
											,SPT.ID_SINAVPUANTURU
											,SD.ID_SINAVDERS
											,DERS = SD.TAKMAAD
											,ISNULL(CONVERT(DECIMAL(18,10 ), SK.KATSAYI), 0) AS KATSAYI 
									FROM SinavDers SD
									INNER JOIN Sinav S on S.ID_SINAV = SD.ID_SINAV
									LEFT JOIN SinavKatsayi SK on SK.ID_SINAV = S.ID_SINAV AND SK.ID_SINAVDERS = SD.ID_SINAVDERS
									WHERE s.ID_SINAV = @ID_SINAV AND (sk.ID_SINAVPUANTURU IS NULL OR SK.ID_SINAVPUANTURU=SPT.ID_SINAVPUANTURU) 
									ORDER BY SD.BOLUMNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								), '[]')
								,KRITERLIST = ISNULL(
								(
									SELECT	 ID_SINAVPUANTURU	= SPT.ID_SINAVPUANTURU
											,NET				= SNK.NET
											,ID_SINAVDERSLIST	= dbo.ufnToRawJsonArray((SELECT ID_SINAVDERS FROM SinavNetKriterDers SNKD WHERE SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER FOR JSON PATH), 'ID_SINAVDERS')
									FROM SinavNetKriter SNK
									WHERE SNK.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU
									AND SNK.ID_SINAVNETKRITER IN (SELECT ID_SINAVNETKRITER FROM SinavNetKriterDers WHERE ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV))
									FOR JSON PATH
								), '[]')
								,SINAVDERSLIST = ISNULL(
								(
									SELECT	ID_SINAVDERS, AD = TAKMAAD
									FROM SinavDers
									WHERE ID_SINAV = @ID_SINAV
									FOR JSON PATH
								), '[]')
								,STP.ID_SINAVTABANPUAN AS ID_SINAVTABANPUAN
								,ISNULL(STP.TABANPUAN, 0) AS TABANPUAN
						FROM SinavPuanTuru SPT
						LEFT JOIN SinavTabanPuan STP ON STP.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU AND STP.ID_SINAV = @ID_SINAV
						WHERE ID_SINAVTURU = (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV)
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS RESULT
				END
				IF @ISLEM = 10	--	Sınav Katsayı - Taban Puan Keydet
				BEGIN
					--TABAN PUAN INSERT
					DELETE FROM SinavTabanPuan WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavTabanPuan]
								([ID_SINAV]
								,[ID_SINAVPUANTURU]
								,[TABANPUAN])
					SELECT
							JSON_Value (j.value, '$.ID_SINAV') as ID_SINAV,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU, 
							ISNULL(JSON_Value (j.value, '$.TABANPUAN'),0) as TABANPUAN
					FROM OPENJSON (@SQLJSON) as j
					--WHERE JSON_Value (j.value, '$.ID_SINAVTABANPUAN') is null

					--TABAN PUAN UPDATE
					--UPDATE [dbo].[SinavTabanPuan]
					--SET	[TABANPUAN] = JSON_Value (j.value, '$.TABANPUAN')
					--FROM
					--	[dbo].[SinavTabanPuan] stp
					--	INNER JOIN OPENJSON (@SQLJSON) j
					--		ON JSON_Value (j.value, '$.ID_SINAVTABANPUAN') = stp.ID_SINAVTABANPUAN
					--WHERE
					--	JSON_Value (j.value, '$.ID_SINAVTABANPUAN') IS NOT NULL

					--KATSAYI INSERT
				

					DELETE FROM [SinavKatsayi] WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavKatsayi]
								([ID_SINAV]
								,[ID_SINAVPUANTURU]
								,[ID_SINAVDERS]
								,[KATSAYI])
					SELECT	DISTINCT
							JSON_Value (j.value, '$.ID_SINAV') as ID_SINAV,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU, 
							JSON_Value (j.value, '$.ID_SINAVDERS') as ID_SINAVDERS,
							ISNULL(REPLACE(JSON_Value (j.value, '$.KATSAYI'),',','.'),0.0) as KATSAYI
					FROM OPENJSON(@SQLJSON) as parent
					CROSS APPLY OPENJSON (parent.value, '$.KATSAYILIST') as j
					--WHERE JSON_Value (j.value, '$.KATSAYI') IS NOT NULL


					--KRİTER--
					DECLARE @ID_SINAVNETKRITERTABLE TABLE (ID_SINAVNETKRITER INT, GUID VARCHAR(MAX))

					DELETE SNK 
					FROM [SinavNetKriter] SNK
					JOIN SinavNetKriterDers SNKD ON SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
					WHERE SNKD.ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV)

					SELECT	DISTINCT
							ISNULL(REPLACE(JSON_Value (j.value, '$.NET'),',','.'),0.0) as NET,
							JSON_Value (j.value, '$.ID_SINAVPUANTURU') as ID_SINAVPUANTURU,
							JSON_Value (j.value, '$.GUID') as GUID
					INTO #SINAVNETKRITER
					FROM OPENJSON(@SQLJSON) as parent
					CROSS APPLY OPENJSON (parent.value, '$.KRITERLIST') as j

					SELECT	 GUID = JSON_Value (KRITERLIST.value, '$.GUID')
							,ID_SINAVDERS = ID_SINAVDERSLIST.value
					INTO #SINAVNETKRITERDERS
					FROM OPENJSON(@SQLJSON) J
					CROSS APPLY OPENJSON (J.value, '$.KRITERLIST') as KRITERLIST
					CROSS APPLY OPENJSON (KRITERLIST.value, '$.ID_SINAVDERSLIST') as ID_SINAVDERSLIST

					MERGE INTO SinavNetKriter 
					USING #SINAVNETKRITER AS TEMP ON 1 = 0
					WHEN NOT MATCHED THEN
					INSERT ([NET] ,[ID_SINAVPUANTURU])
					VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
					OUTPUT TEMP.GUID, inserted.ID_SINAVNETKRITER
					INTO @ID_SINAVNETKRITERTABLE (GUID, ID_SINAVNETKRITER);

					INSERT INTO SinavNetKriterDers (ID_SINAVNETKRITER, ID_SINAVDERS)
					SELECT ID_SINAVNETKRITER, SNKD.ID_SINAVDERS
					FROM @ID_SINAVNETKRITERTABLE ID_SNK
					JOIN #SINAVNETKRITERDERS SNKD ON SNKD.GUID = ID_SNK.GUID

					DROP TABLE IF EXISTS #SINAVNETKRITER
					DROP TABLE IF EXISTS #SINAVNETKRITERDERS
					--KRİTER--

					--KATSAYI UPDATE
					--UPDATE [dbo].[SinavKatsayi]
					--SET [KATSAYI] = k.KATSAYI
					--FROM
					--	[dbo].[SinavKatsayi] sk
					--	INNER JOIN (SELECT JSON_Value (j.value, '$.ID_SINAVKATSAYI') as ID_SINAVKATSAYI, REPLACE(JSON_Value (j.value, '$.KATSAYI'),',','.') as KATSAYI FROM OPENJSON(@SQLJSON) as parent CROSS APPLY OPENJSON (parent.value, '$.KATSAYILIST') as j) k on k.ID_SINAVKATSAYI=sk.ID_SINAVKATSAYI
					--WHERE k.ID_SINAVKATSAYI IS NOT NULL and k.KATSAYI IS NOT NULL
				END
				IF @ISLEM = 11	--	Sınav Optik Listele
				BEGIN
					SELECT [ID_SINAVOPTIKSABIT] as ID	
						  ,ILISKI=so.ID_SINAVOPTIK
						  ,[BASLANGIC]
						  ,[OPTIKKARAKTERSAYISI] as KARAKTERSAYISI
						  ,TUR=1
						  ,AD=so.AD
						  ,OTURUM=1
						  ,BOLUMNO=0
					  INTO #TEMPOPTIK
					  FROM [SinavOptik]				so
					  LEFT JOIN [SinavOptikSabit]	sos on sos.ID_SINAVOPTIK=so.ID_SINAVOPTIK and sos.ID_SINAV=@ID_SINAV
					  ORDER BY sos.ID_SINAVOPTIKSABIT
			
					SELECT [ID_SINAVOPTIKDERS] as ID
						  ,sd.[ID_SINAVDERS] as ILISKI
						  ,[BASLANGIC]
						  ,[OPTIKKARAKTERSAYISI] as KARAKTERSAYISI
						  ,TUR=2
						  ,AD=sd.TAKMAAD
						  ,ISNULL(sod.OTURUM,1) AS OTURUM
						  ,sd.BOLUMNO
					  INTO #TEMPOPTIK2
					  FROM [SinavDers]				sd
					  LEFT JOIN [SinavOptikDers]	sod on sod.ID_SINAVDERS=sd.ID_SINAVDERS
					  WHERE sd.ID_SINAV=@ID_SINAV

					 SELECT *  FROM #TEMPOPTIK
					 UNION
					 SELECT * FROM #TEMPOPTIK2
					 ORDER BY BOLUMNO
			 
					 DROP TABLE IF EXISTS #TEMPOPTIK
					 DROP TABLE IF EXISTS #TEMPOPTIK2
				END
				IF @ISLEM = 12	--	Sınav Optik Kaydet
				BEGIN
					--OPTIK SABIT INSERT
					DELETE FROM [SinavOptikSabit] WHERE ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavOptikSabit]
							   ([ID_SINAV]
							   ,[ID_SINAVOPTIK]
							   ,[BASLANGIC]
							   ,[OPTIKKARAKTERSAYISI])
					SELECT
							@ID_SINAV as ID_SINAV,
							JSON_Value (j.value, '$.ILISKI') as ID_SINAVOPTIK, 
							JSON_Value (j.value, '$.BASLANGIC') as BASLANGIC, 
							JSON_Value (j.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI
					FROM OPENJSON (@SQLJSON) as j
					WHERE JSON_Value (j.value, '$.TUR') = 1 --and (JSON_Value (j.value, '$.ID') IS NULL or JSON_Value (j.value, '$.ID') = 0)

					--OPTIK SABIT UPDATE
					--UPDATE [dbo].[SinavOptikSabit]
					--SET	[BASLANGIC] = JSON_Value (j.value, '$.BASLANGIC'), [OPTIKKARAKTERSAYISI] = JSON_Value (j.value, '$.KARAKTERSAYISI')
					--FROM OPENJSON (@SQLJSON) as j
					--WHERE
					--	JSON_Value (j.value, '$.TUR') = 1 
					--	and (JSON_Value (j.value, '$.ID') IS NOT NULL 
					--	and JSON_Value (j.value, '$.ID') > 0)
					--	and ID_SINAVOPTIKSABIT=JSON_Value (j.value, '$.ID')

					--OPTIK DERS INSERT
					DELETE SOD FROM [SinavOptikDers] SOD INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOD.ID_SINAVDERS WHERE SD.ID_SINAV=@ID_SINAV
					INSERT INTO [dbo].[SinavOptikDers]
							   ([ID_SINAVDERS]
							   ,[BASLANGIC]
							   ,[OPTIKKARAKTERSAYISI]
							   ,[OTURUM])
					SELECT
							JSON_Value (j.value, '$.ILISKI') as ID_SINAVDERS, 
							JSON_Value (j.value, '$.BASLANGIC') as BASLANGIC, 
							JSON_Value (j.value, '$.KARAKTERSAYISI') as OPTIKKARAKTERSAYISI,
							JSON_Value (j.value, '$.OTURUM') as OTURUM
					FROM OPENJSON (@SQLJSON) as j
					WHERE JSON_Value (j.value, '$.TUR') = 2 --and (JSON_Value (j.value, '$.ID') IS NULL or JSON_Value (j.value, '$.ID') = 0)

					--OPTIK DERS UPDATE
					--UPDATE [dbo].[SinavOptikDers]
					--SET	[BASLANGIC] = JSON_Value (j.value, '$.BASLANGIC'), [OPTIKKARAKTERSAYISI] = JSON_Value (j.value, '$.KARAKTERSAYISI'),
					--	[OTURUM] = JSON_Value (j.value, '$.OTURUM')
					--FROM OPENJSON (@SQLJSON) as j
					--WHERE
					--	JSON_Value (j.value, '$.TUR') = 2 
					--	and (JSON_Value (j.value, '$.ID') IS NOT NULL 
					--	and JSON_Value (j.value, '$.ID') > 0)
					--	and ID_SINAVOPTIKDERS=JSON_Value (j.value, '$.ID')
				END
				IF @ISLEM = 13	--	Sınav Dosya Listele
				BEGIN
					SELECT 
						 sd.ID_SINAVDOSYA
						,sd.AD
						,k.AD AS KAD
						,k.SOYAD AS KSOYAD
						,sd.KYE_TARIH 
						,ISNULL(s.AD,'') SUBEAD
						,(SELECT COUNT(t.LINE) FROM SinavOptikTemp t WHERE t.ID_SINAVDOSYA=sd.ID_SINAVDOSYA) KATILIM
						,(SELECT COUNT(1) FROM [dbo].[fn_TcEslesmeGetir](sn.ID_KADEME3,SD.ID_SINAVDOSYA,sn.ID_SINAV,cast(@SINAVOTURUM as int),0)) SORUNLUTC
						--,(SELECT COUNT(1) FROM [dbo].[fn_TcEslesmeGetir](sn.ID_KADEME3,SD.ID_SINAVDOSYA,sn.ID_SINAV,@SINAVOTURUM,1))TEKRARLAYANTC
						,sn.DURUM
						,sn.YUKLEMEKAPAT
					FROM		SinavDosya		sd
					INNER JOIN	Sinav			sn	on sn.ID_SINAV	= sd.ID_SINAV 
					INNER JOIN	v3Kullanici		k	on k.TCKIMLIKNO	= sd.KYE_TCKIMLIKNO
					LEFT  JOIN	v3Sube			s	on s.ID_SUBE	= sd.ID_SUBE
					where sd.ID_SINAV=@ID_SINAV AND sd.AKTIF=1 AND (@ID_SUBE=0 OR sd.ID_SUBE=@ID_SUBE) AND (@SINAVOTURUM = 0 OR sd.OTURUM = @SINAVOTURUM)
				END
				IF @ISLEM = 14	--	Sınav Dosya Kaydet
				BEGIN

					 IF EXISTS (SELECT 1 FROM SinavDosya WHERE ID_SINAV=@ID_SINAV AND AD=@DOSYAADI AND AKTIF=1)
					 BEGIN
						SELECT @MSG = 'DAHA ÖNCE AYNI İSİMLİ DOSYA KAYDETTİNİZ. KONTROL EDİNİZ!'
			
						RAISERROR (@MSG , -- Message text.
							16, -- Severity.
							1-- State.
							);					
					 END
					 ELSE
					 BEGIN
						DECLARE @ID_SINAVDOSYAx TABLE (ID_SINAVDOSYA int)
						INSERT INTO [dbo].[SinavDosya]
									([ID_SINAV]
									,[ID_SUBE]
									,[AD]
									,[GUID]
									,[KYE_TCKIMLIKNO]
									,[OTURUM])
									OUTPUT INSERTED.ID_SINAVDOSYA into @ID_SINAVDOSYAx
								VALUES
									(@ID_SINAV,@ID_SUBE,@DOSYAADI,@DOSYAGUID,@TCKIMLIKNO,@SINAVOTURUM)
						DECLARE @IDX int=(select top 1 ID_SINAVDOSYA from @ID_SINAVDOSYAx)
						DECLARE	@return_value int
			
						--UPDATE Sinav SET DURUM=3 WHERE ID_SINAV=@ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR
			
						--EXEC	@return_value = [dbo].[sp_OptikIslemleri]
						--		@ID_SINAV = @ID_SINAV,
						--		@ID_SINAVDOSYA = @IDX,
						--		@ID_SUBE=@ID_SUBE,
						--		@ISLEM = 0

						--UPDATE Sinav SET DURUM=0 WHERE ID_SINAV=@ID_SINAV

						DECLARE @SQLDOSYA		VARCHAR(max)	= NULL
						DECLARE @YOLDOSYA		VARCHAR(max)	= NULL
						DECLARE @GUIDDOSYA		VARCHAR(max)	= NULL

						IF @IDX IS NOT NULL AND NOT EXISTS(SELECT 1 FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@IDX)
						BEGIN
				
							PRINT '2: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

							SET @GUIDDOSYA = (SELECT GUID FROM SinavDosya where ID_SINAVDOSYA=@IDX)
							create table #tmp (
								line nvarchar(max)
							);
							BEGIN TRY  
								SET @YOLDOSYA = '\\172.18.194.207\$SinavOptik\'+@GUIDDOSYA+'.txt'
								SET @SQLDOSYA=
								'BULK INSERT #tmp
								FROM '''+@YOLDOSYA+'''
								WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
								EXEC(@SQLDOSYA) 
							END TRY  
							BEGIN CATCH  
								SET @YOLDOSYA = '\\172.18.194.207\$SinavOptik\'+@GUIDDOSYA+'.dat'
								SET @SQLDOSYA=
								'BULK INSERT #tmp
								FROM '''+@YOLDOSYA+'''
								WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
								EXEC(@SQLDOSYA) 
							END CATCH 
				
							INSERT INTO SinavOptikTemp (LINE,ID_SINAVDOSYA)
							SELECT line, @IDX FROM #tmp
							WHERE line IS NOT NULL
							DROP TABLE IF EXISTS #tmp

							PRINT '3: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						END	

						SELECT DISTINCT OTURUM INTO #OTURUMLARDOSYAYUKLE FROM SinavDosya WHERE ID_SINAV  = @ID_SINAV
						DECLARE @HATALIDOSYAYUKLE BIT=0
						WHILE (SELECT COUNT(1) FROM #OTURUMLARDOSYAYUKLE)>0
						BEGIN 
							DECLARE @SUB_OTURUMDOSYAYUKLE INT = (SELECT TOP 1 OTURUM FROM #OTURUMLARDOSYAYUKLE)
				
							IF  ((SELECT COUNT(1) TE_TC FROM [dbo].[fn_TcEslesmeGetir](NULL,NULL,@ID_SINAV,@SUB_OTURUMDOSYAYUKLE,1)) > 0)
							BEGIN
								--SELECT @MSG = 'TEKRARLANAN TC OLDUĞUNDAN DEĞERLENDİRME YAPILAMAZ KONTROL EDİNİZ!'
			
								--RAISERROR (@MSG , -- Message text.
								--	16, -- Severity.
								--	1-- State.
								--	);
								SET @HATALIDOSYAYUKLE = 1
							END
				
							DELETE FROM #OTURUMLARDOSYAYUKLE WHERE OTURUM = @SUB_OTURUMDOSYAYUKLE
						END

						IF @HATALIDOSYAYUKLE = 0
						BEGIN
							UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 0 where ID_SINAV = @ID_SINAV -- SIRAYA ALINDI
			
							INSERT INTO [dbo].[SinavDegerlendir]
									([ID_SINAV]
									,[KYE_TCKIMLIKNO])
								VALUES
									(@ID_SINAV
									,@TCKIMLIKNO)
						END

						SELECT @IDX
					END
				END
				IF @ISLEM = 15	--	Sınav Dosya Sil
				BEGIN
					UPDATE SinavDosya set AKTIF=0, SIL_TCKIMLIKNO=@TCKIMLIKNO, SIL_TARIH=getdate() where ID_SINAVDOSYA=@ID_SINAVDOSYA
					DELETE FROM SinavOgrenci WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA
					DELETE FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA
				END
				IF @ISLEM = 16	--	Optik Girildi Mi
				BEGIN
					IF((select count(1) from SinavOptikDers sod inner join SinavDers sd on sd.ID_SINAVDERS=sod.ID_SINAVDERS where sd.ID_SINAV=@ID_SINAV)
					+(select count(1) from SinavOptikSabit where ID_SINAV=@ID_SINAV)
					=(select count(1) from SinavOptik)+(select count(1) from SinavDers where ID_SINAV=@ID_SINAV))
					BEGIN
						select 1
					END
					ELSE
					BEGIN
						select 0
					END 
				END
				IF @ISLEM = 17	--	Sınav Değerlendir
				BEGIN
					SELECT DISTINCT OTURUM INTO #OTURUMLAR FROM SiNAVDOSYA WHERE ID_SINAV=@ID_SINAV
					DECLARE @HATALI BIT=0
					WHILE (SELECT COUNT(1) FROM #OTURUMLAR)>0
					BEGIN 
				
						DECLARE @SUB_OTURUM INT =(SELECT TOP 1 OTURUM FROM #OTURUMLAR)
				
						IF  ((SELECT COUNT(1) TE_TC FROM [dbo].[fn_TcEslesmeGetir](NULL,NULL,@ID_SINAV,@SUB_OTURUM,1))>0)
						BEGIN
							SELECT @MSG = 'TEKRARLANAN TC OLDUĞUNDAN DEĞERLENDİRME YAPILAMAZ KONTROL EDİNİZ!'
			
							RAISERROR (@MSG , -- Message text.
								16, -- Severity.
								1-- State.
								);
							SET @HATALI=1

						END
				
						DELETE FROM #OTURUMLAR WHERE OTURUM=@SUB_OTURUM
					END





					IF  (@HATALI=0)			
					BEGIN
						UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 0 where ID_SINAV = @ID_SINAV -- SIRAYA ALINDI
			
						INSERT INTO [dbo].[SinavDegerlendir]
								   ([ID_SINAV]
								   ,[KYE_TCKIMLIKNO])
							 VALUES
								   (@ID_SINAV
								   ,@TCKIMLIKNO)
					END
				END
				IF @ISLEM = 18	--	Sınav Puan Türü (@ID_SINAVTURU)
				BEGIN
					--SELECT		S.ID_SINAV, KOD, S.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 103) as SINAVTARIH, DURUM 
					--FROM		Sinav			S
					--INNER JOIN	SinavOgrenci	SO	ON SO.ID_SINAV=S.ID_SINAV
					--WHERE		SO.TCKIMLIKNO	= @TC_OGRENCI	AND S.DONEM	= @DONEM
					--ORDER BY	S.SINAVTARIH

					SELECT		DISTINCT PT.ID_SINAVPUANTURU,PT.AD,PT.KOD
					FROM		SinavPuanTuru	PT
					INNER JOIN	Sinav			S	ON PT.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE		S.ID_SINAVTURU=@ID_SINAVTURU
					ORDER BY	PT.ID_SINAVPUANTURU 


				END
				IF @ISLEM = 19	--	Sınav Listele by Ogrenci
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	and (@TC_OGRENCI IS NULL OR TCKIMLIKNO=@TC_OGRENCI)
						where s.AKTIF=1 and s.DURUM=2  
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (cast(@ID_SINAVTURU as int)=0 or s.ID_SINAVTURU=cast(@ID_SINAVTURU as int))
					) as XTABLE
					order by cast(SINAVTARIH as datetime) desc
				END
				IF @ISLEM = 20	--	Ünite Ara
				BEGIN			
					--select AD from dbo.[fn_DersUniteListe](@ID_DERS,@UNITEKOD)

					SELECT AD FROM v3SinavDersUnite
					WHERE KOD = @UNITEKOD

				END
				IF @ISLEM = 21  --  SINAV AKTIF PASIF
				BEGIN
					UPDATE Sinav 
					SET AKTIF=CASE WHEN AKTIF=1 THEN 0 ELSE 1 END
					WHERE ID_SINAV=@ID_SINAV
					select AKTIF from Sinav WHERE ID_SINAV=@ID_SINAV
				END 
				IF @ISLEM = 22  --  Sınav Dosya İçerik
				BEGIN

					declare @SQL varchar(max),@cols varchar(max)--,@ID_SINAVDOSYA int=196,@ID_SINAV int=43
					
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS ##T1
					
					select @ID_SINAV=ID_SINAV FROM SinavDosya WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA

					SELECT 
						 DEGER	= CAST( RTRIM(SUBSTRING(LINE,BASLANGIC , OPTIKKARAKTERSAYISI )) AS varchar(MAX))
						,SO.KOLONADI
						,ID_SINAVOPTIKTEMP
						,SIRA = SO.ID_SINAVOPTIK 
					INTO #TEMP
					FROM SinavOptikTemp		SOT
					JOIN SinavOptikSabit	SOS ON	SOS.ID_SINAV=@ID_SINAV and SOS.OPTIKKARAKTERSAYISI>0
					JOIN SinavOptik			SO	ON	SO.ID_SINAVOPTIK=SOS.ID_SINAVOPTIK
					where ID_SINAVDOSYA=@ID_SINAVDOSYA
					UNION ALL
					select			
						 RTRIM(SUBSTRING(LINE, sod.BASLANGIC, sod.OPTIKKARAKTERSAYISI)) DEGER
						,sd.TAKMAAD KOLONADI
						,ID_SINAVOPTIKTEMP	
						,SIRA = 100 + CAST(SD.BOLUMNO AS INT)
					from SinavOptikTemp			sot
					inner join	SinavDers		sd	on	sd.ID_SINAV=@ID_SINAV
					inner join	SinavOptikDers	sod	on	sod.ID_SINAVDERS=sd.ID_SINAVDERS
					where ID_SINAVDOSYA=@ID_SINAVDOSYA


					SET @cols = STUFF((SELECT DISTINCT ',' + QUOTENAME(c.KOLONADI) 
											FROM #TEMP c
											FOR XML PATH(''), TYPE
											).value('.', 'NVARCHAR(MAX)') 
										,1,1,'')

					SET @SQL='  SELECT * INTO ##T1  FROM ( SELECT DEGER,KOLONADI,ID_SINAVOPTIKTEMP FROM #TEMP ) AS x 
								PIVOT  (MAX(DEGER) FOR KOLONADI IN ('+@cols+')) AS p'
					EXECUTE(@SQL)

					select(
						select * from(
							select 
							(
								select * from ##T1
								FOR JSON AUTO
							) as t1	
							,(
								SELECT KOLONADI FROM #TEMP GROUP BY KOLONADI,SIRA ORDER BY SIRA
								FOR JSON AUTO
							) as t2					
						) as tablo FOR JSON AUTO
					) as tt

					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS ##T1


				END 
				IF @ISLEM = 23  --  Sınav Dosya İçerik Düzenle
				BEGIN
					--DECLARE @SQLJSON VARCHAR(MAX)='[{"ID_SINAVOPTIKTEMP":37314,"KOLONADI":"AD","DEGER":"ZİLAN     KARAYİĞİTAS"},{"ID_SINAVOPTIKTEMP":37326,"KOLONADI":"KITAPCIK","DEGER":"A"},{"ID_SINAVOPTIKTEMP":37315,"KOLONADI":"KITAPCIK","DEGER":"A"}]'
					DROP TABLE IF EXISTS #TEMP2
					SELECT
						JSON_Value (j.value, '$.ID_SINAVOPTIKTEMP') as ID_SINAVOPTIKTEMP,
						JSON_Value (j.value, '$.KOLONADI') as KOLONADI, 
						JSON_Value (j.value, '$.DEGER') as DEGER
					INTO #TEMP2
					FROM OPENJSON (@SQLJSON) as j
			
					SELECT @ID_SINAVDOSYA=ID_SINAVDOSYA,@ID_SINAV=ID_SINAV  FROM SinavDosya WHERE ID_SINAVDOSYA =(SELECT ID_SINAVDOSYA FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=(SELECT TOP 1 ID_SINAVOPTIKTEMP FROM #TEMP2))
			
					WHILE ((SELECT COUNT(DISTINCT KOLONADI) FROM #TEMP2)>0)
					BEGIN
						UPDATE	SOT
						SET		
								sot.LINE = STUFF(LINE,SOS.BASLANGIC,SOS.OPTIKKARAKTERSAYISI,LEFT( upper(DEGER)+SPACE(SOS.OPTIKKARAKTERSAYISI),SOS.OPTIKKARAKTERSAYISI))
						FROM	SinavOptikTemp		SOT
						JOIN	#TEMP2				T	ON	T.ID_SINAVOPTIKTEMP	= SOT.ID_SINAVOPTIKTEMP
						JOIN	SinavOptik			SO	ON	SO.KOLONADI			= T.KOLONADI
						JOIN	SinavDosya			SD	ON	SD.ID_SINAVDOSYA	= SOT.ID_SINAVDOSYA
						JOIN	SinavOptikSabit		SOS	ON	SOS.ID_SINAVOPTIK	= SO.ID_SINAVOPTIK
														AND SOS.ID_SINAV		= SD.ID_SINAV
						WHERE	T.KOLONADI=(SELECT TOP 1 KOLONADI FROM #TEMP2 ORDER BY KOLONADI)

						DELETE FROM #TEMP2 WHERE KOLONADI=(SELECT TOP 1 KOLONADI FROM #TEMP2 ORDER BY KOLONADI)
					END
			
					DROP TABLE IF EXISTS #TEMP2			

					UPDATE Sinav SET DURUM=0 WHERE ID_SINAV=@ID_SINAV	--	SINAV DURUMU BEKLEMEDEYE ALINIYOR
			
					--EXEC	@return_value = [dbo].[sp_OptikIslemleri]
					--		@ID_SINAV = @ID_SINAV,
					--		@ID_SINAVDOSYA = @ID_SINAVDOSYA,
					--		@ISLEM = 0
			
					select 1
				END 
				IF @ISLEM = 24  --  Öğrenci Listele by ID_SINAV
				BEGIN
					DROP TABLE IF EXISTS #T1

					SELECT	DISTINCT SO.TCKIMLIKNO
							,ISNULL(VK.AD,SO.AD) AD
							,ISNULL(VK.SOYAD,SO.SOYAD) SOYAD
							,ISNULL(VS.SUBEAD,'') SUBEAD
							,ISNULL(VS.SINIF,'') SINIF
					 INTO #T1
					 FROM SinavOgrenci		SO
				LEFT JOIN V3OGRENCi			VO	ON	SO.TCKIMLIKNO	= VO.TCKIMLIKNO
				LEFT JOIN V3Kullanici		VK	ON	VK.TCKIMLIKNO	= SO.TCKIMLIKNO
												AND VK.AKTIF		= 1
				LEFT JOIN vw_SubeGrupSinif	VS	ON	VS.ID_SINIF		= VO.ID_SINIF
					WHERE							SO.ID_SINAV		= @ID_SINAV

					select(
						select * from(
							select 
							(
								select DISTINCT TCKIMLIKNO,AD,SOYAD,SUBEAD,SINIF from #T1
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
			
						DROP TABLE IF EXISTS #T1
				END 
				IF @ISLEM = 25  --  Sınav Özellikleri
				BEGIN
						SELECT 
							 SD.TAKMAAD 
							,SA.SORUNO_A
							,SA.CEVAP
							,SA.SORUNO
							,SA.KOD
							,BILGI = ISNULL(B.AD, '')
							,BILISSELSUREC = ISNULL(BS.AD, '')
							,SA.ID_SORUBANKASI

							,KAZANIM= CASE WHEN LEN(SA.KOD) >0 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SA.KOD								) ELSE '' END
							,UNITE	= CASE WHEN LEN(SA.KOD) >3 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SUBSTRING(SA.KOD ,1,LEN(SA.KOD)-3)	) ELSE '' END
							,KONU	= CASE WHEN LEN(SA.KOD) >6 THEN (select top 1 AD from v3SinavDersUnite DK where DK.KOD=SUBSTRING(SA.KOD ,1,LEN(SA.KOD)-6)	) ELSE '' END
					
							,SD.ID_SINAVDERS
							,S.ID_SINAV
							,ISNULL(SOD.OTURUM,1) OTURUM
							,VD.ACIKLAMA DONEM
							,VK.AD GRUP
							,S.AD SINAVAD
							,convert(varchar(15), S.SINAVTARIH, 104) SINAVTARIH
						FROM	Sinav				S
						JOIN	SinavKitapcik		SK	ON	SK.ID_SINAV			= S.ID_SINAV
														AND SK.AD				= 'B'
						JOIN	SinavAnahtar		SA	ON	SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
						JOIN	SinavDers			SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
					LEFT JOIN	SinavOptikDers		SOD	ON	SOD.ID_SINAVDERS	= SD.ID_SINAVDERS
						JOIN	V3AKTiFDONEM		VD	ON	VD.DONEM			= S.DONEM
						JOIN	V3Kademe3			VK	ON	VK.ID_KADEME3		= S.ID_KADEME3		
					LEFT JOIN	Bilgi				B	ON	B.ID_BILGI			= SA.ID_BILGI
					LEFT JOIN	BilisselSurec		BS	ON	BS.ID_BILISSELSUREC	= SA.ID_BILISSELSUREC
						WHERE S.ID_SINAV=@ID_SINAV
						ORDER BY OTURUM,SORUNO_A,SD.BOLUMNO
				END 
				IF @ISLEM = 26  --  Sınav Derslerini Listele
				BEGIN	
					select(
						select * from(
							select 
							(
								SELECT	DISTINCT SD.ID_SINAVDERS, SD.ID_DERS,SD.TAKMAAD DERSAD,BOLUMNO
								FROM	SinavDers	SD	
								WHERE 	SD.ID_SINAV=@ID_SINAV
								ORDER BY BOLUMNO
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END 
				IF @ISLEM = 27  --  Sınav Dersler Sorularını Listele
				BEGIN
					--SELECT	SORUNO,SORUNO_A,CEVAP,SK.AD
					--FROM	SinavDers		SD	
					--JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
					--JOIN	SinavKitapcik	SK	ON	SK.ID_SINAV		= S.ID_SINAV
					--						AND SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
					--WHERE	SD.ID_SINAVDERS = @ID_SINAVDERS		

						DROP TABLE IF EXISTS ##TEMP
						DECLARE @cols2 AS NVARCHAR(MAX),
							@query  AS NVARCHAR(MAX);

						SET @cols2 = STUFF((SELECT distinct ',' + QUOTENAME(SK.AD) 
									FROM SinavDers		SD	
									JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
									JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
									WHERE	SD.ID_SINAVDERS = @ID_SINAVDERS
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SORUNO_A,CEVAP,A,B
								--@SINAVSORUISLEM =1 ise soru işlem tablosuna eklenenler listelenmeyecek 
						set @query = 'SELECT * INTO ##TEMP FROM
						(
							SELECT	SORUNO,SORUNO_A,CEVAP,SK.AD
							FROM	SinavDers		SD	
							JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS	= SD.ID_SINAVDERS
							JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
							WHERE	SD.ID_SINAVDERS = '+CAST(@ID_SINAVDERS AS varchar(MAX))+'
							and ('+CAST(@SINAVSORUISLEM AS varchar(MAX))+'=0 OR SA.ID_SINAVANAHTAR not in (select distinct ID_SINAVANAHTAR from SinavSoruIslem))
						) AS xTablo
						PIVOT( MAX(SORUNO) FOR AD IN (' + @cols2 + '))AS p'

						execute(@query)

						select(
							select * from(
								select 
								(
									select * from ##TEMP
									ORDER BY SORUNO_A
									FOR JSON AUTO
								) as t1	,	
								(
									SELECT	DISTINCT SK.AD
									FROM	SinavDers		SD	
									JOIN	SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK	
									WHERE	SD.ID_SINAVDERS		=	@ID_SINAVDERS
									FOR JSON AUTO
								) as t2							
							) as tablo FOR JSON AUTO
						) as tt


						DROP TABLE IF EXISTS ##TEMP

				END 
				IF @ISLEM = 28	--	Sınav Listele Pasif Dahil
				BEGIN
					SELECT DISTINCT 
						S.ID_SINAV
						,KOD
						,S.AD
						,K3.AD AS GRUP
						,S.ID_KADEME3
						,Convert(varchar, SINAVTARIH, 103) AS SINAVTARIH
						,DURUM
						,AKTIF 
						,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
						,S.OZEL AS OZEL
						,S.FREKANSHESAPLA AS FREKANSHESAPLA
						,S.PUANGIZLE AS PUANGIZLE
						,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
						,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
						,S.[ONLINESINAV]  AS [ONLINESINAV] 
						,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = S.ID_SINAV) AS HARICIOGRSAY
					FROM Sinav S
					INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
					LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
					WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3
				END
				IF @ISLEM = 29	--	Öğrenci Sil
				BEGIN
					SELECT SO.ID_SINAVOGRENCI, SOT.ID_SINAVOPTIKTEMP 
					INTO #OGRENCIDELETE
					FROM SinavOgrenci SO
					INNER JOIN SinavOptikTemp SOT ON SOT.ID_SINAVOPTIKTEMP = SO.ID_SINAVOPTIKTEMP
					WHERE SO.ID_SINAV = @ID_SINAV AND SO.TCKIMLIKNO IN (SELECT VALUE FROM OPENJSON(@TCLIST))
			
					DELETE FROM SinavOgrenci WHERE ID_SINAVOGRENCI IN (SELECT ID_SINAVOGRENCI FROM #OGRENCIDELETE)
					DELETE FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP IN (SELECT ID_SINAVOPTIKTEMP FROM #OGRENCIDELETE)

					DROP TABLE #OGRENCIDELETE

					SELECT 1
				END
				IF @ISLEM = 30	--	Öğrenci Sil
				BEGIN
					UPDATE SinavDers SET TAKMAAD=@TAKMAAD WHERE ID_SINAVDERS=@ID_SINAVDERS
					SELECT 1
				END			
				IF @ISLEM = 31  --  SınavTürü Derslerini Listele
				BEGIN	
					select(
						select * from(
							select 
							(
								SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
								FROM	SinavDers			SD	
								JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV
								JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS 
																AND D.ID_KADEME3= S.ID_KADEME3
								WHERE	S.ID_SINAVTURU	= @ID_SINAVTURU 
									AND S.ID_KADEME3	= @ID_KADEME3ESKI		
									AND (S.DONEM		= @DONEM		OR @DONEM = '' )
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END 
				IF @ISLEM = 32	--	Sınav Listele Değerlendirilmiş
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
							,S.[ONLINESINAV]  AS [ONLINESINAV] 
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3 and S.AKTIF = 1 and S.DURUM=2
							and (OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 33	--	Sınav Türü Listele Gruba Göre
				BEGIN
					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD FROM  Sinav S 
					INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE S.ID_KADEME3 = @ID_KADEME3ESKI AND S.AKTIF=1 AND S.DURUM=2
							and (OZEL=0 OR @OZELSINAVGOR=1)
				END							
				IF @ISLEM = 34	--	Sınav Türü Listele Gruba Göre
				BEGIN
					IF (@ID_KADEME3ESKI IS NULL OR @ID_KADEME3ESKI='') AND (@TC_OGRENCI IS NOT NULL AND @TC_OGRENCI != '')
					BEGIN
						SELECT @ID_KADEME3ESKI=S.ID_KADEME3
						FROM OkyanusDB.DBO.v3Ogrenci		O
						JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF=O.ID_SINIF 
						WHERE TCKIMLIKNO=@TC_OGRENCI
					END

					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
					FROM  Sinav S 
					INNER JOIN SinavTuru ST ON ST.ID_SINAVTURU=S.ID_SINAVTURU
					WHERE S.ID_KADEME3 = @ID_KADEME3ESKI AND S.AKTIF=1 AND S.DURUM=2 AND S.DONEM=@DONEM
							and (OZEL=0 OR @OZELSINAVGOR=1)
				END
				IF @ISLEM = 35	--	Sınav Listele by Grup
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV
						where s.AKTIF=1 and s.DURUM=2 and s.ID_KADEME3=@ID_KADEME3ESKI
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (cast(@ID_SINAVTURU as int)=0 or s.ID_SINAVTURU=cast(@ID_SINAVTURU as int))
					) as XTABLE
					order by cast(SINAVTARIH as date) desc
				END
				IF @ISLEM = 36	--	Sınav Listele by Grup - ÇOKLU
				BEGIN
					select * from
					(
						Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, st.AD as TUR
						from Sinav			s
						join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
						join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV
						where s.AKTIF=1 and s.DURUM=2 and s.ID_KADEME3=@ID_KADEME3ESKI
							and (OZEL=0 OR @OZELSINAVGOR=1)
							and ((@DONEM='0' and DONEM=(SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)) or DONEM=@DONEM) 
							and (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
					) as XTABLE
					order by TUR, cast(SINAVTARIH as date) desc
				END
				IF @ISLEM = 37	--	Sınav Özellik Güncelle
				BEGIN
					DECLARE @SQL37 VARCHAR(MAX) ='
						UPDATE Sinav
						SET '+@DURUM+'='+CAST(@DURUMDEGER AS varchar)+'
						WHERE ID_SINAV='+CAST(@ID_SINAV AS varchar)+'
					'
					PRINT (@SQL37)
					EXEC (@SQL37)

					SELECT 1
					
				
				END							
				IF @ISLEM = 38	--	Sınav Listele KADEME DONEM
				BEGIN

					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.CEVAPANAHTARIYUKLEMEKAPAT AS CEVAPANAHTARIYUKLEMEKAPAT
							,S.ONLINESINAV AS ONLINESINAV
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
							,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = S.ID_SINAV) AS HARICIOGRSAY
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM and ID_SINAVTURU = @ID_SINAVTURU and S.ID_KADEME3 = @ID_KADEME3 and S.AKTIF = 1
						AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 39	--	sınav ders liste
				BEGIN
					SELECT   SD.*
							,SA.SORUNO
							,SA.CEVAP
							,SA.KOD
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'B' ) B_KARSILIK	
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'C' ) C_KARSILIK	
							,(SELECT SORUNO FROM SinavAnahtar GSA JOIN SinavKitapcik GSK ON GSK.ID_SINAVKITAPCIK = GSA.ID_SINAVKITAPCIK WHERE GSA.ID_SINAVDERS = SD.ID_SINAVDERS AND GSA.SORUNO_A = SA.SORUNO AND GSK.AD = 'D' ) D_KARSILIK		
							,SA.ID_BILGI
							,SA.ID_BILISSELSUREC
							,SA.ID_SORUBANKASI
					FROM Sinav							S
					JOIN SinavDers						SD	ON	SD.ID_SINAV			= S.ID_SINAV
					JOIN OPENJSON (@ID_SINAVDERSLIST)	DL	ON	DL.VALUE			= SD.ID_SINAVDERS
					JOIN SinavAnahtar					SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS 
					JOIN SinavKitapcik					SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
															AND	SK.AD				= 'A'
					WHERE	S.ID_SINAV	= @ID_SINAV
					GROUP BY SD.ID_SINAVDERS,BOLUMNO,ID_DERS,TAKMAAD,SD.ID_SINAV,SA.CEVAP,SA.KOD,SA.SORUNO,SA.ID_BILGI,SA.ID_BILISSELSUREC	,SA.ID_SORUBANKASI	
					ORDER BY BOLUMNO,SORUNO
				END
				IF @ISLEM = 40	--	CEVAP ANAHTARI EXCEL YUKLE
				BEGIN
					--declare @SQLJSON varchar(max)= '[{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"1","CEVAP":"B","B_KARSILIK":"20","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"2","CEVAP":"E","B_KARSILIK":"19","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"3","CEVAP":"E","B_KARSILIK":"18","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"4","CEVAP":"A","B_KARSILIK":"17","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001007"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"5","CEVAP":"C","B_KARSILIK":"16","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"6","CEVAP":"D","B_KARSILIK":"15","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL103001019"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"7","CEVAP":"A","B_KARSILIK":"14","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"8","CEVAP":"B","B_KARSILIK":"13","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001005"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"9","CEVAP":"D","B_KARSILIK":"12","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL110002001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"10","CEVAP":"D","B_KARSILIK":"11","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL103001008"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"11","CEVAP":"C","B_KARSILIK":"10","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107002011"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"12","CEVAP":"E","B_KARSILIK":"9","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"13","CEVAP":"D","B_KARSILIK":"8","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"14","CEVAP":"A","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL111003001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"15","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL112001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"16","CEVAP":"B","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL112001001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"17","CEVAP":"B","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107002011"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"18","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL105009001"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"19","CEVAP":"A","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL105001007"},{"ID_SINAVDERS":"19944","TAKMAAD":"Türk Dili Edebiyatı","SORUNO":"20","CEVAP":"C","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİL107001007"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"1","CEVAP":"E","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK316003006"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"2","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK316003003"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"3","CEVAP":"E","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK315002010"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"4","CEVAP":"A","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK314003001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"5","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK317003001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"6","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK313004001"},{"ID_SINAVDERS":"19945","TAKMAAD":"Tarih","SORUNO":"7","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"İNK315005001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"1","CEVAP":"D","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"2","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ401002001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"3","CEVAP":"B","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ416005001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"4","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"5","CEVAP":"A","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ423002003"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"6","CEVAP":"E","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ406002001"},{"ID_SINAVDERS":"19946","TAKMAAD":"Coğrafya","SORUNO":"7","CEVAP":"A","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"COĞ406002001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"1","CEVAP":"C","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN804001002"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"2","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN804004004"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"3","CEVAP":"D","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN806006001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"4","CEVAP":"C","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN806008002"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"5","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN805004001"},{"ID_SINAVDERS":"19947","TAKMAAD":"Din Kült. Ve A. B.","SORUNO":"6","CEVAP":"E","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"DİN502002001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"1","CEVAP":"D","B_KARSILIK":"20","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"2","CEVAP":"B","B_KARSILIK":"19","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"3","CEVAP":"C","B_KARSILIK":"18","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"4","CEVAP":"E","B_KARSILIK":"17","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201005002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"5","CEVAP":"D","B_KARSILIK":"16","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201006004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"6","CEVAP":"D","B_KARSILIK":"15","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201006003"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"7","CEVAP":"E","B_KARSILIK":"14","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT203002005"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"8","CEVAP":"E","B_KARSILIK":"13","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT206001001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"9","CEVAP":"C","B_KARSILIK":"12","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001005"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"10","CEVAP":"A","B_KARSILIK":"11","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"11","CEVAP":"E","B_KARSILIK":"10","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"12","CEVAP":"A","B_KARSILIK":"9","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT206001002"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"13","CEVAP":"B","B_KARSILIK":"8","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"14","CEVAP":"B","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202006007"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"15","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"16","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202003004"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"17","CEVAP":"B","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT201010001"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"18","CEVAP":"B","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"19","CEVAP":"C","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19948","TAKMAAD":"Matematik","SORUNO":"20","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"MAT202001026"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"1","CEVAP":"C","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607011006"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"2","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ603003001"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"3","CEVAP":"A","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ606002003"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"4","CEVAP":"B","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ608002003"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"5","CEVAP":"D","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607004001"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"6","CEVAP":"B","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ604001002"},{"ID_SINAVDERS":"19949","TAKMAAD":"Fizik","SORUNO":"7","CEVAP":"B","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"FİZ607011006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"1","CEVAP":"A","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM701003005"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"2","CEVAP":"D","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703003001"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"3","CEVAP":"E","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703005006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"4","CEVAP":"B","B_KARSILIK":"7","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM702003004"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"5","CEVAP":"C","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM705008002"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"6","CEVAP":"A","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM703005006"},{"ID_SINAVDERS":"19950","TAKMAAD":"Kimya","SORUNO":"7","CEVAP":"E","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"KİM701006001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"1","CEVAP":"D","B_KARSILIK":"3","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY806001001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"2","CEVAP":"C","B_KARSILIK":"5","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY806001005"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"3","CEVAP":"A","B_KARSILIK":"2","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY807002001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"4","CEVAP":"E","B_KARSILIK":"6","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY804002005"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"5","CEVAP":"E","B_KARSILIK":"4","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY810001001"},{"ID_SINAVDERS":"19951","TAKMAAD":"Biyoloji","SORUNO":"6","CEVAP":"D","B_KARSILIK":"1","C_KARSILIK":"","D_KARSILIK":"","KOD":"BİY810001004"}]'
				
					DROP TABLE IF EXISTS #SQLJSON
					DROP TABLE IF EXISTS #BKONTROL
					DROP TABLE IF EXISTS #CKONTROL
					DROP TABLE IF EXISTS #DKONTROL


					SELECT ID_SINAVDERS, TAKMAAD, SORUNO, CEVAP, B_KARSILIK,C_KARSILIK,D_KARSILIK, KOD, ID_BILGI, ID_BILISSELSUREC, ID_SORUBANKASI
					INTO #SQLJSON 
					FROM OPENJSON(@SQLJSON)
					with
					(
						ID_SINAVDERS [int],
						TAKMAAD [varchar](MAX),
						SORUNO [int],
						CEVAP [varchar](MAX),
						B_KARSILIK [int],
						C_KARSILIK [int],
						D_KARSILIK [int],
						KOD [varchar](MAX),
						ID_BILGI INT,
						ID_BILISSELSUREC INT,
						ID_SORUBANKASI INT
					) AS J
				
					DECLARE @RESULT BIT = 0
				
					--SELECT SA.CEVAP,SA.SORUNO_A,SA.KOD, '' AS SS, J.SORUNO,J.CEVAP,J.KOD,J.B_KARSILIK,J.C_KARSILIK,J.D_KARSILIK
				
					IF NOT EXISTS (SELECT 1 FROM #SQLJSON WHERE CEVAP NOT IN ('A','B','C','D','E','F'))
					BEGIN

						UPDATE  SA
						SET
							 SA.CEVAP				= J.CEVAP
							,SA.KOD					= J.KOD
							,SA.ID_BILGI			= J.ID_BILGI 
							,SA.ID_BILISSELSUREC	= J.ID_BILISSELSUREC 
							,SA.ID_SORUBANKASI		= SSD.ID_SORU --J.ID_SORUBANKASI
						FROM SinavDers					SD	
						JOIN #SQLJSON					J	ON	J.ID_SINAVDERS		= SD.ID_SINAVDERS
						JOIN SinavAnahtar				SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
															AND SA.SORUNO_A			= J.SORUNO 
						JOIN SinavKitapcik				SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK 
															AND	SK.AD				= 'A'
					LEFT JOIN SoruBankasi.dbo.Soru		SS	ON	SS.ID_SORU			= J.ID_SORUBANKASI
					LEFT JOIN Sinav						JS	ON	JS.ID_SINAV			= SD.ID_SINAV
					LEFT JOIN SoruBankasi.dbo.SoruDetay SSD ON	SSD.ID_SORU			= SS.ID_SORU
															AND JS.ID_KADEME3		= SSD.ID_SINAVGRUP
															AND SSD.SILINDI			= 0
															AND SSD.UNITE			= J.KOD
						WHERE SD.ID_SINAV = @ID_SINAV

						BEGIN	-- KITAPÇIK YANLIŞ KONTROL
					
							SELECT 
									S.SORUNO,
									G.B_KARSILIK,
									G.ID_SINAVDERS,
									COUNT(G.B_KARSILIK) SAY
							INTO #BKONTROL
							FROM #SQLJSON S
					   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.B_KARSILIK 
											AND S.ID_SINAVDERS	= G.ID_SINAVDERS
							GROUP BY 
									S.SORUNO,
									G.B_KARSILIK,
									G.ID_SINAVDERS
							HAVING COUNT(G.B_KARSILIK)=0

				
							SELECT 
									S.SORUNO,
									G.C_KARSILIK,
									G.ID_SINAVDERS,
									COUNT(G.C_KARSILIK) SAY
							INTO #CKONTROL
							FROM #SQLJSON S
					   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.C_KARSILIK 
											AND S.ID_SINAVDERS	= G.ID_SINAVDERS
							GROUP BY 
									S.SORUNO,
									G.C_KARSILIK,
									G.ID_SINAVDERS
							HAVING COUNT(G.C_KARSILIK)=0

				
							SELECT 
								S.SORUNO,
								G.D_KARSILIK,
								G.ID_SINAVDERS,
								COUNT(G.D_KARSILIK) SAY
						INTO #DKONTROL
						FROM #SQLJSON S
				   LEFT JOIN #SQLJSON G	ON	S.SORUNO		= G.D_KARSILIK 
										AND S.ID_SINAVDERS	= G.ID_SINAVDERS
						GROUP BY 
								S.SORUNO,
								G.D_KARSILIK,
								G.ID_SINAVDERS
						HAVING COUNT(G.D_KARSILIK)=0

						END
					
						IF NOT EXISTS (SELECT 1 FROM #BKONTROL)
						BEGIN
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.B_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.B_KARSILIK
							FROM	SinavAnahtar		SA
							JOIN	SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'B' 
							JOIN	#SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
															AND J.SORUNO			= SA.SORUNO_A

						END		
					
						IF NOT EXISTS (SELECT 1 FROM #CKONTROL)
						BEGIN
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.C_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.C_KARSILIK
							FROM SinavAnahtar		SA
							JOIN SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'C' 
							JOIN #SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
														AND J.SORUNO			= SA.SORUNO_A

						END		
					
						IF NOT EXISTS (SELECT 1 FROM #DKONTROL)
						BEGIN
							
							--SELECT SA.SORUNO,SA.CEVAP,SA.KOD,SA.SORUNO_A,J.SORUNO,J.CEVAP,J.KOD,J.D_KARSILIK
							UPDATE	SA
							SET		SA.SORUNO	= J.D_KARSILIK
							FROM SinavAnahtar		SA
							JOIN SinavKitapcik		KB	ON	KB.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK AND KB.AD = 'D' 
							JOIN #SQLJSON			J	ON	J.ID_SINAVDERS		= SA.ID_SINAVDERS 
														AND J.SORUNO			= SA.SORUNO_A
						END

					SET @RESULT = 1

				END
				

					SELECT @RESULT


					DROP TABLE IF EXISTS #SQLJSON
					DROP TABLE IF EXISTS #BKONTROL
					DROP TABLE IF EXISTS #CKONTROL
					DROP TABLE IF EXISTS #DKONTROL


				END								
				IF @ISLEM = 41	--	Sınav/Yazılı Listele Tarihe Göre
				BEGIN

						SELECT ID_SINAV,S.AD,K.ID_KADEME3, K.AD KADEME3, S.ID_SINAVTURU, ST.KISAAD SINAVTURU
						INTO #SINAVLISTESI
						FROM Sinav		S
						JOIN v3Kademe3	K	ON	K.ID_KADEME3	= S.ID_KADEME3
						JOIN SinavTuru	ST	ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
						WHERE	S.SINAVTARIH	= @TARIH
							AND S.DONEM			= @DONEM
							AND (K.ID_KADEME3	= @ID_KADEME3 OR @ID_KADEME3 = 0 OR @ID_KADEME3 IS NULL )
							AND	S.AKTIF			= 1
					UNION ALL
						SELECT ID_YAZILI,Y.AD,K.ID_KADEME3, K.AD KADEME3, 0 ID_SINAVTURU,'YZL' SINAVTURU
						FROM Yazili		Y
						JOIN v3Kademe3	K	ON	K.ID_KADEME3	= Y.ID_KADEME3
						WHERE	Y.YAZILITARIH	= @TARIH
							AND Y.DONEM			= @DONEM
							AND (K.ID_KADEME3	= @ID_KADEME3 OR @ID_KADEME3 = 0 OR @ID_KADEME3 IS NULL )
							AND	Y.AKTIF			= 1
					ORDER BY ID_KADEME3 

					SELECT (
						SELECT *
						FROM #SINAVLISTESI
						for json path, INCLUDE_NULL_VALUES 
					)AS SINAVLISTESI

					DROP TABLE #SINAVLISTESI					

				END								
				IF @ISLEM = 42	--	Bursluluk Dosya Liste
				BEGIN

					SELECT ISNULL(
						(	SELECT *
							FROM BurslulukDosya
							WHERE (DONEM = @DONEM OR ((@DONEM IS NULL OR @DONEM = '') AND (@DONEM =@AKTIFDONEM )))
								AND AKTIF = 1
							for json auto
						)
					,'[]')AS DOSYALISTESI

				END
				IF @ISLEM = 43	--	Sınav Listele Multi Sınav Turu
				BEGIN
					SELECT * FROM
					(
						SELECT DISTINCT 
							S.ID_SINAV
							,KOD
							,S.AD
							,K3.AD AS GRUP
							,S.ID_KADEME3
							,Convert(varchar, SINAVTARIH, 104) AS SINAVTARIH
							,DURUM
							,AKTIF 
							,(CASE WHEN  SK.ID_SINAV IS NULL THEN 0 ELSE 1 END ) B_KITAPCIK
							,S.OZEL AS OZEL
							,S.FREKANSHESAPLA AS FREKANSHESAPLA
							,S.PUANGIZLE AS PUANGIZLE
							,S.YUKLEMEKAPAT AS YUKLEMEKAPAT
							,S.[CEVAPANAHTARIYUKLEMEKAPAT]  AS [CEVAPANAHTARIYUKLEMEKAPAT] 
							,S.ONLINESINAV  AS ONLINESINAV 
							,(SELECT COUNT(1) FROM (SELECT TCKIMLIKNO FROM SinavOgrenci WHERE ID_SINAV = S.ID_SINAV GROUP BY TCKIMLIKNO) XTABLE ) AS KATILIM
						FROM Sinav S
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						LEFT JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='B'
						WHERE DONEM = @DONEM 
						and S.ID_KADEME3 = @ID_KADEME3ESKI 
						and (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
						and S.AKTIF = 1 
						and S.DURUM = 2
						and (OZEL = 0 OR @OZELSINAVGOR=1)
					)XTABLE
					ORDER BY Convert(datetime, SINAVTARIH, 104) DESC
				END
				IF @ISLEM = 44	--	AYT için TYT Seçim Türü
				BEGIN
					SELECT 
					(
						SELECT DISTINCT TST.ID_TYTSECIMTUR, TST.AD, CASE WHEN STST.ID_SINAV IS NULL THEN 0 ELSE 1 END SELECTED, ISNULL(STST.PUAN, 0) AS PUAN
						FROM TYTSecimTur TST
						LEFT JOIN SinavTYTSecimTurKriter STST ON STST.ID_TYTSECIMTUR = TST.ID_TYTSECIMTUR AND STST.ID_SINAV = @ID_SINAV
						FOR JSON PATH
					)
				END
				IF @ISLEM = 45	--	AYT için TYT Seçim Kriter Kaydet
				BEGIN
					DELETE FROM SinavTYTSecimTurKriter WHERE ID_SINAV = @ID_SINAV

					INSERT INTO SinavTYTSecimTurKriter (ID_SINAV, ID_TYTSECIMTUR, PUAN)
					VALUES (@ID_SINAV, @ID_TYTSECIMTUR, ISNULL(REPLACE(@BARAJ,',','.'),0.0))
				END
				IF @ISLEM = 46	--	SORU BANKASI SORU LISTESI
				BEGIN					
					DECLARE
					@DISPLAYLENGTH		INT				= 0,
					@DISPLAYSTART		INT				= 0,
					@WHERECLAUSE		VARCHAR(MAX)	= '',
					@ORDERBYCLAUSE		VARCHAR(MAX)	= '',
					@FILTER				VARCHAR(MAX)	= '',
					@TABLENAME			VARCHAR(MAX)	= 'vw_Soru',
					@COLUMNNAME			VARCHAR(MAX)	= '',
					@COLUMNS			VARCHAR(MAX)	= ''	

					SET @COLUMNNAME		= (SELECT COLUMN_NAME FROM SoruBankasi.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = @TABLENAME AND TABLE_SCHEMA='dbo' AND ORDINAL_POSITION = (SELECT CASE WHEN JSON_Value (VALUE, '$.column') = '0' THEN '1' ELSE JSON_Value (VALUE, '$.column') END FROM OPENJSON(@SQLJSON,'$.order')))

					SET @ORDERBYCLAUSE = (SELECT ' ORDER BY '+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
					SET @WHERECLAUSE = (SELECT value FROM OPENJSON(@SQLJSON, '$.search') WITH (value VARCHAR(MAX)))
					SET @DISPLAYSTART = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT)) + 1
					SET @DISPLAYLENGTH = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT)) - 1

					IF	@WHERECLAUSE=''
					BEGIN
						SET @WHERECLAUSE = '
							WHERE	SILINDI			= 0  
								AND ID_HAREKETDURUM	= 13 
								AND ID_SORUTUR		= 4
								AND SNV.ID_SINAV	= ' + CAST(@ID_SINAV AS VARCHAR) + ' 
								AND UNITE			= ''' + @KOD +''''
					END
					ELSE
					BEGIN
						SET @COLUMNS = ''
				
						SET @COLUMNS = '(' + (SELECT ' X.' + COLUMN_NAME + ' LIKE ''%' + @WHERECLAUSE + '%'' OR' AS [text()] 
											FROM SoruBankasi.INFORMATION_SCHEMA.COLUMNS 
											WHERE	TABLE_NAME		= @TABLENAME 
												AND TABLE_SCHEMA	= 'dbo'
											FOR XML PATH ('')) + ')'

						SET @COLUMNS = SUBSTRING(@COLUMNS, 1, LEN(@COLUMNS)-3) + ') '
						SET @WHERECLAUSE = 'WHERE ' + @COLUMNS

						SET @WHERECLAUSE = @WHERECLAUSE + '	
								AND	X.SILINDI			= 0  
								AND X.ID_HAREKETDURUM	= 13 
								AND X.ID_SORUTUR		= 4
								AND SNV.ID_SINAV		= ' + CAST(@ID_SINAV AS VARCHAR) + ' 
								AND (''' + @KOD + ''' IS NULL OR ''' + @KOD + ''' = '''' OR X.UNITE LIKE ''%' + @KOD + '%'') '
					END

					DECLARE @LINK VARCHAR(MAX)=  'SoruBankasi/'
					SET @QUERY='
								SELECT * INTO #TEMP FROM   
								(
									SELECT ROW_NUMBER() OVER(' + @ORDERBYCLAUSE + ') AS RowNumber, * 
									FROM(
										SELECT X.*  
										FROM ' + @TABLENAME + ' X
										JOIN Sinav				SNV	ON	SNV.ID_KADEME3	= X.ID_SINAVGRUP
										' + @WHERECLAUSE + '
									) 
								RawResults) DATA 


								DECLARE @DATA VARCHAR(MAX)=(
										SELECT	RowNumber
												,ID_SORU
												,	''Soru Türü: '' + ISNULL(SORUTUR, '''') + ''<br />'' +
													''Grup: '' + ISNULL(SINAVGRUP, '''') + ''<br />'' +
													''Ders: '' + ISNULL(DERSAD, '''') + ''<br />'' +
													''Zorluk: '' + ISNULL(ZORLUKTUR, '''') + ''<br />'' +
													''Durum: '' + ISNULL(HAREKETDURUM, '''') + ''<br />'' +
													''Yazar: '' + ISNULL(KULLANICIAD, '''') + ''<br />'' +
													''Tarih: '' + CONVERT(VARCHAR, KYE_TARIH, 104) AS SORUBILGILERI 
												,SORUHTML	= (SELECT '''+ @LINK +''' + SORUHTML FROM SoruBankasi.dbo.SoruHtml WHERE ID_SORU = S.ID_SORU AND ID_TASLAKTUR=20) 
												,CEVAP		= (SELECT CEVAPNO,'''+ @LINK +''' + CEVAPHTML AS CEVAPHTML, DEGER FROM SoruBankasi.dbo.CEVAP WHERE ID_SORU = S.ID_SORU ORDER BY ID_CEVAP FOR JSON PATH, INCLUDE_NULL_VALUES) 
												,ID_SORUTUR
												,USTSORUHTML= CASE	WHEN ID_USTSORU IS NOT NULL THEN (SELECT SORUHTML FROM SoruBankasi.dbo.SoruHtml WHERE ID_SORU = S.ID_USTSORU AND ID_TASLAKTUR=20) 
																	ELSE '''' 
																END 
												,COZUM		= (SELECT COZUMHTML, ID_COZUMTUR FROM SoruBankasi.dbo.SoruCozum WHERE ID_SORU = S.ID_SORU ORDER BY SIRA FOR JSON PATH, INCLUDE_NULL_VALUES)
												,KULLANIM	= (	SELECT SN.AD, CONVERT(VARCHAR, SN.KYE_TARIH, 104) AS KYE_TARIH, SS.KITAPCIK, SS.SORUNO FROM SoruBankasi.dbo.SinavSoru SS
																	INNER JOIN SoruBankasi.dbo.Sinav SN ON SN.ID_SINAV = SS.ID_SINAV
																	WHERE SN.SILINDI = 0 AND SS.ID_SORU = S.ID_SORU 
																	ORDER BY SS.KITAPCIK
																	FOR JSON PATH, INCLUDE_NULL_VALUES)
												,ID_HAREKETDURUM
												,ALTSORU = (SELECT SUBS.ID_SORU, SORUTUR, DERSAD, ZORLUKTUR FROM '+@TABLENAME+' SUBS
															WHERE SUBS.ID_USTSORU = S.ID_SORU
															FOR JSON PATH, INCLUDE_NULL_VALUES)
												,SORUTUR, DERSAD, ZORLUKTUR
										FROM #TEMP S
										WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX), @DISPLAYSTART)+' AND '+CONVERT(VARCHAR(MAX), (@DISPLAYSTART + @DISPLAYLENGTH))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
								)

								SELECT(
									SELECT (SELECT draw FROM OPENJSON(''' + @SQLJSON + ''') WITH(draw INT)) AS draw, 
									(SELECT COUNT(1) FROM ' + @TABLENAME + ') AS recordsTotal, 
									(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
									@DATA AS data FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS JSONDATA

								DROP TABLE #TEMP
					'
					print @QUERY
					EXECUTE (@QUERY)
				

				END
				IF @ISLEM = 47	--	SORU BANKASI ID KONTROL
				BEGIN

				
					SELECT ISNULL(S.ID_SORU,0)
					FROM SoruBankasi.dbo.Soru		S
					JOIN SoruBankasi.dbo.SoruDetay	SD	ON	SD.ID_SORU		= S.ID_SORU
					JOIN Sinav						SNV	ON	SNV.ID_KADEME3	= SD.ID_SINAVGRUP
					WHERE	S.ID_SORU		= @ID_SORUBANKASI
						AND	SD.UNITE		= @UNITEKOD
						AND	SD.SILINDI		= 0
						AND SNV.ID_SINAV	= @ID_SINAV
						AND S.ID_SORUTUR	= 4

				END

				-- GENEL 
				DROP TABLE IF EXISTS #KADEMELER
				DROP TABLE IF EXISTS #OTURUMLAR
			--END

			
		END
	
		--COMMIT TRANSACTION [Tran1]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [Tran1]
		IF @ISLEM IN (14, 17)	--	DOSYA YÜKLEME
		BEGIN
			UPDATE Sinav			SET DURUM = 0, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV
		END

		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = /*'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' +*/ ERROR_MESSAGE()
			
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_OnlineSinav]...';


GO
ALTER PROC [dbo].[sp_OnlineSinav]
	@ISLEM							INT				= NULL,
	@TCKIMLIKNO						VARCHAR(11)		= NULL,
	@OTURUM							VARCHAR(36)		= NULL,
	@ID_MENU						INT				= NULL,

	@ID_SORU						INT				= NULL,
	@ID_SINAV						INT				= NULL,
	@ID_DERS						INT				= NULL,
	@ID_SINAVTURU					INT				= NULL,
	@ID_SINAVANAHTAR				INT				= NULL,
	@ID_CEVAP						INT				= NULL,
	@ID_ONLINESINAVOGRENCI			INT				= NULL,
	@SINAVOTURUM					INT				= NULL,
	@ID_ONLINESINAVOGRENCIOTURUM	INT				= NULL,
	@CEVAPANAHTARI					BIT				= NULL,
	@KYE_TARIH						DATETIME		= NULL,
	@TC_EKLEYEN						VARCHAR(MAX)	= NULL,
	@TC_OGRENCI						VARCHAR(MAX)	= NULL,
	@ID_SINIFLIST					VARCHAR(MAX)	= NULL,
	@ID_SUBELIST					VARCHAR(MAX)	= NULL,
	@TC_OGRENCILIST					VARCHAR(MAX)	= NULL,
	@JSON							VARCHAR(MAX)	= NULL,
	@SQLJSON						VARCHAR(MAX)	= NULL,
	@DIS_OGRENCI					BIT				= 0
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM	
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU
								
				,ID_SORU					= @ID_SORU
				,TC_EKLEYEN					= @TC_EKLEYEN
				,KYE_TARIH					= @KYE_TARIH
				,ID_SINAV					= @ID_SINAV
				,ID_DERS					= @ID_DERS
				,ID_SINAVTURU				= @ID_SINAVTURU
				,ID_ONLINESINAVOGRENCI		= @ID_ONLINESINAVOGRENCI
				,ID_ONLINESINAVOGRENCIOTURUM= @ID_ONLINESINAVOGRENCIOTURUM
				,SINAVOTURUM				= @SINAVOTURUM
				,CEVAPANAHTARI				= @CEVAPANAHTARI
				,[JSON]						= @JSON
				,SQLJSON					= @SQLJSON
				,ID_SINIFLIST				= @ID_SINIFLIST
				,TC_OGRENCILIST				= @TC_OGRENCILIST
				,TC_OGRENCI					= @TC_OGRENCI
				,ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
				,ID_CEVAP					= @ID_CEVAP
				,ID_SUBELIST				= @ID_SUBELIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	
	
	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT

		IF @ISLEM IN (12,13,14)
		BEGIN
			SET @_ID_LOG = 1
		END
		IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
		BEGIN
			SET @_ID_LOG=1
		END
		ELSE
			EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @_ID_LOG > 0
		BEGIN
		
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 
						FROM OkyanusDB.DBO.v3SubeYetki 
						WHERE	TCKIMLIKNO		 = @TCKIMLIKNO 
							AND ID_KULLANICITIPI IN (1,60)
			) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK			
				SET @OZELSINAVGOR=1
			
			DECLARE @QUERY NVARCHAR(MAX) = NULL

			IF @ISLEM = 1	--	Sınav Listele
			BEGIN
				SELECT
				(
					SELECT *, CONVERT(decimal(4,2), (CONVERT(decimal(4,2), XTABLE.DOGRU)/CONVERT(decimal(4,2), (XTABLE.DOGRU + XTABLE.BOS + XTABLE.YANLIS))*100.0)) AS PERFORMANS  
					FROM
					(
						SELECT 
							SOA.ID_SINAV
							,ISNULL(OSO.ID_ONLINESINAVOGRENCI,0) AS ID_ONLINESINAVOGRENCI
							,(
								SELECT DISTINCT AD + ', ' AS [text()] 
								FROM v3Sinavders 
								WHERE ID_DERS IN 
									(
										SELECT SUBSD.ID_DERS 
										FROM		SoruBankasi.dbo.SoruDetay	SUBSD 
										INNER JOIN	SoruBankasi.dbo.SinavSoru	SUBSS	ON SUBSS.ID_SORU = SUBSD.ID_SORU
										WHERE SUBSS.ID_SINAV=SOA.ID_SINAV
									) 
								For XML PATH ('')
							) AS DERS
							,V.AD AS SINAVTURU
							,S.AD AS ADI
							,ISNULL(OSO.GIRIS_SAYISI, 0) AS GIRIS
							,ISNULL(CONVERT(VARCHAR, OSO.BAS_TARIH, 104), '-') AS SONGIRIS
							,cast(ISNULL(OSO.DURUM, 0) as int) AS DURUM
							,CAST(DATEPART(HOUR,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR)+':'+CAST(DATEPART(MINUTE,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR)+':'+CAST(DATEPART(SECOND,OSO.BIT_TARIH-OSO.BAS_TARIH) AS VARCHAR) AS SURE
							,COUNT(C.DEGER) AS DOGRU
							,(SELECT COUNT(1) - COUNT(C.DEGER) FROM OnlineSinavOgrenciCevap SUBOC WHERE SUBOC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI) AS YANLIS
							,(
								SELECT COUNT(1) - (COUNT(C.DEGER) + (SELECT COUNT(1) - COUNT(C.DEGER) FROM OnlineSinavOgrenciCevap SUBOC WHERE SUBOC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI))
								FROM SoruBankasi.dbo.Soru SUBS
								INNER JOIN SoruBankasi.dbo.SinavSoru SUBSS ON SUBSS.ID_SORU=SUBS.ID_SORU
								INNER JOIN SoruBankasi.dbo.Cevap	 SUBC  ON SUBC.ID_SORU=SUBS.ID_SORU
								WHERE SUBSS.ID_SINAV=SOA.ID_SINAV AND SUBSS.KITAPCIK='A' AND (
																(SUBS.ID_SORUTUR=2)						--	AÇIK UÇLU
															OR (SUBS.ID_SORUTUR=3)						--	DOĞRU YANLIŞ
															OR (SUBS.ID_SORUTUR=4 AND SUBC.DEGER='1')	--	TEST
															OR (SUBS.ID_SORUTUR=5 AND SUBC.DEGER<>'')	--	EŞLEŞTİRME
															OR (SUBS.ID_SORUTUR=6)						--	BOŞLUK DOLDURMA
															)
							) AS BOS,
							CASE WHEN (S.BAS_TARIH<=CAST(GETDATE() AS DATE) AND S.BAS_SAAT<=convert(varchar(10), GETDATE(), 108))
								  AND ((S.BIT_TARIH=CAST(GETDATE() AS DATE) AND S.BIT_SAAT>=convert(varchar(10), GETDATE(), 108))
										OR 
										(S.BIT_TARIH>CAST(GETDATE() AS DATE))
									)
							THEN 1 ELSE 0 END AS DEVAM
						FROM		SoruBankasi.dbo.SinavOgrenciAtama	SOA
						INNER JOIN	SoruBankasi.dbo.Sinav				S	ON S.ID_SINAV=SOA.ID_SINAV 
						INNER JOIN	SoruBankasi.dbo.Varlik				V	ON V.ID_VARLIK=S.ID_SINAVTUR
						INNER JOIN	SoruBankasi.dbo.SinavSoru			SS	ON SS.ID_SINAV=S.ID_SINAV AND SS.KITAPCIK='A'
						INNER JOIN	SoruBankasi.dbo.Soru				SOR	ON SOR.ID_SORU=SS.ID_SORU 
						INNER JOIN	SoruBankasi.dbo.SoruDetay			SD	ON SD.ID_SORU=SS.ID_SORU 
						LEFT  JOIN	OnlineSinavOgrenci					OSO ON OSO.TCKIMLIKNO=SOA.TCKIMLIKNO AND OSO.ID_ONLINESINAV=SOA.ID_SINAV
						LEFT  JOIN	OnlineSinavOgrenciCevap				OC	ON OC.ID_ONLINESINAVOGRENCI=OSO.ID_ONLINESINAVOGRENCI AND OC.ID_SORU=SOR.ID_SORU
						LEFT  JOIN	SoruBankasi.dbo.Cevap				C	ON C.ID_SORU=SOR.ID_SORU AND (
																												(SOR.ID_SORUTUR=2 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	AÇIK UÇLU
																											OR (SOR.ID_SORUTUR=3 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	DOĞRU YANLIŞ
																											OR (SOR.ID_SORUTUR=4 AND C.DEGER='1' AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.CEVAPNO AS VARCHAR))				--	TEST
																											OR (SOR.ID_SORUTUR=5 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	EŞLEŞTİRME
																											OR (SOR.ID_SORUTUR=6 AND OC.CEVAPNO=C.CEVAPNO AND CAST(OC.CEVAP AS VARCHAR)=CAST(C.DEGER AS VARCHAR))		--	BOŞLUK DOLDURMA
																											)
						WHERE	(@ID_SINAV IS NULL OR SOA.ID_SINAV=@ID_SINAV) 
							
							AND ID_SORUTUR<>1 
							AND ID_USTSORU IS NULL 
							AND SOA.TCKIMLIKNO=@TCKIMLIKNO
							AND (@ID_SINAVTURU IS NULL OR @ID_SINAVTURU = 0 OR S.ID_SINAVTUR=@ID_SINAVTURU) 
							AND (@ID_DERS IS NULL OR @ID_DERS = 0 OR SD.ID_DERS=@ID_DERS) --@TCKIMLIKNO AND 
						GROUP BY SOA.ID_SINAV, S.BAS_TARIH, S.BAS_SAAT, S.BIT_TARIH, S.BIT_SAAT, OSO.ID_ONLINESINAVOGRENCI, V.AD, S.AD, OSO.DURUM, OSO.GIRIS_SAYISI, OSO.BAS_TARIH, OSO.BIT_TARIH
					) XTABLE
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS JSON
			END

			IF @ISLEM = 2	--	Soru Listesi Getir 
			BEGIN
				SELECT
				(
					SELECT 
						S.ID_SORU
						,S.ID_SORUTUR
						,S.ID_USTSORU
						,SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
						,(SELECT
							(
								SELECT
									SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
									,(
										 SELECT 
											 ID_SORU=ISNULL(ID_SORU,0)
											,ID_USTSORU=ISNULL(ID_USTSORU,0)
											,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
											,SUBV.AD AS SORUTUR
											,KOD=ISNULL(KOD,0)
											,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
											,ID_DERS=ISNULL(ID_DERS,0)
											,UNITE=ISNULL(UNITE,0)
											,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
										 FROM SoruBankasi.dbo.SoruDetay SUBSD 
										 INNER JOIN SoruBankasi.dbo.Varlik SUBV ON SUBV.ID_VARLIK=SUBS.ID_SORUTUR
										 Where ID_SORU=SUBS.ID_SORU 
										 FOR JSON PATH
									 ) AS Soru,
									(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
									(	
										SELECT C.*
										FROM SoruBankasi.dbo.Cevap C
										Where C.ID_SORU=SUBS.ID_SORU ORDER BY ID_CEVAP,C.CEVAPNO,LEN(DEGER) DESC FOR JSON PATH
									)AS CevapListesi,
									(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS CozumListesi
								FROM SoruBankasi.dbo.Soru SUBS 
								WHERE SUBS.ID_SORU = S.ID_SORU OR SUBS.ID_USTSORU = S.ID_SORU
								FOR JSON AUTO, INCLUDE_NULL_VALUES 
							) AS SoruPaketList
						)AS SoruPaketList
					FROM SoruBankasi.dbo.Soru S
					INNER JOIN SoruBankasi.dbo.SinavSoru SS ON SS.ID_SORU=S.ID_SORU
					WHERE ID_SINAV=@ID_SINAV AND SS.KITAPCIK='A' AND ID_SORUTUR<>1 AND ID_USTSORU IS NULL
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			IF @ISLEM = 3	--	Soru Getir
			BEGIN
				SELECT
				(
					SELECT 
						 SORUNO = ROW_NUMBER() OVER(ORDER BY ID_SORU ASC)
						,(
							 SELECT 
								 ID_SORU=ISNULL(ID_SORU,0)
								,ID_USTSORU=ISNULL(ID_USTSORU,0)
								,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
								,KOD=ISNULL(KOD,0)
								,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
								,ID_DERS=ISNULL(ID_DERS,0)
								,UNITE=ISNULL(UNITE,0)
								,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
							 FROM SoruBankasi.dbo.SoruDetay Where ID_SORU=S.ID_SORU 
							 FOR JSON PATH
						 ) AS Soru,
						(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=S.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
						(SELECT * FROM SoruBankasi.dbo.Cevap	 Where ID_SORU=S.ID_SORU ORDER BY  LEN(DEGER) DESC, CEVAPNO ASC FOR JSON PATH)AS CevapListesi,
						(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=S.ID_SORU FOR JSON PATH)AS CozumListesi
					FROM SoruBankasi.dbo.Soru S 
					WHERE S.ID_SORU = @ID_SORU OR S.ID_USTSORU = @ID_SORU
					FOR JSON AUTO, INCLUDE_NULL_VALUES 
				) AS SoruPaketList
			END

			IF @ISLEM = 4	--	Sınav Türü Getir
			BEGIN
				SELECT
				(
					SELECT ID_VARLIK, AD FROM SoruBankasi.dbo.Varlik V
					WHERE ID_VARLIKTUR=5
					FOR JSON PATH
				) J
			END

			IF @ISLEM = 5	--	Giriş Ekle
			BEGIN
				IF NOT EXISTS(SELECT ID_ONLINESINAVOGRENCI FROM [OnlineSinavOgrenci] WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV)
				BEGIN
					declare @ID table(ID int)
					INSERT INTO [dbo].[OnlineSinavOgrenci]
							   ([TCKIMLIKNO]
							   ,[ID_ONLINESINAV]
							   ,[DURUM]
							   ,[GIRIS_SAYISI]
							   ,[BAS_TARIH]
							   ,[BIT_TARIH])
						OUTPUT inserted.ID_ONLINESINAVOGRENCI into @ID 
						 VALUES
								(@TCKIMLIKNO
								,@ID_SINAV
								,0
								,1
								,GETDATE()
								,NULL)
					select ID from @ID
				END
				ELSE
				BEGIN
					UPDATE [dbo].[OnlineSinavOgrenci] SET [GIRIS_SAYISI]=[GIRIS_SAYISI]+1, [BAS_TARIH]=GETDATE(), [BIT_TARIH]=NULL WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV
					SELECT ID_ONLINESINAVOGRENCI FROM [OnlineSinavOgrenci] WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_ONLINESINAV=@ID_SINAV
				END

			END

			IF @ISLEM = 6	--	Sınavı Bitir
			BEGIN
				DELETE FROM [dbo].[OnlineSinavOgrenciCevap] WHERE ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
			
				INSERT INTO [dbo].[OnlineSinavOgrenciCevap]
						   ([ID_SORU]
						   ,[ID_ONLINESINAVOGRENCI]
						   ,[CEVAPNO]
						   ,[CEVAP])
				SELECT ID_SORU, @ID_ONLINESINAVOGRENCI, CEVAPNO, CEVAP FROM OPENJSON(@JSON)
				WITH(
					 ID_SORU	INT				'$.ID_SORU' 
					,CEVAPNO	INT				'$.CEVAPNO' 
					,CEVAP		VARCHAR(MAX)	'$.CEVAP' 
				)

				UPDATE OnlineSinavOgrenci SET DURUM=1, BIT_TARIH=GETDATE() WHERE ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
			END

			IF @ISLEM = 7	--	Soru Listesi Getir Cevaplı
			BEGIN
				SELECT
				(
					SELECT 
						S.ID_SORU
						,S.ID_SORUTUR
						,S.ID_USTSORU
						,SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
						,(SELECT
							(
								SELECT
									SORUNO= ROW_NUMBER() OVER (ORDER BY SS.SORUNO)
									,(
										 SELECT 
											 ID_SORU=ISNULL(ID_SORU,0)
											,ID_USTSORU=ISNULL(ID_USTSORU,0)
											,ID_SORUTUR=ISNULL(ID_SORUTUR,0)
											,SUBV.AD AS SORUTUR
											,KOD=ISNULL(KOD,0)
											,ID_SINAVGRUP=ISNULL(ID_SINAVGRUP,0)
											,ID_DERS=ISNULL(ID_DERS,0)
											,UNITE=ISNULL(UNITE,0)
											,ID_ZORLUKTUR =ISNULL(ID_ZORLUKTUR,0)
										 FROM SoruBankasi.dbo.SoruDetay SUBSD 
										 INNER JOIN SoruBankasi.dbo.Varlik SUBV ON SUBV.ID_VARLIK=SUBS.ID_SORUTUR
										 Where ID_SORU=SUBS.ID_SORU 
										 FOR JSON PATH
									 ) AS Soru,
									(SELECT * FROM SoruBankasi.dbo.SoruHtml  Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS SoruHtmlListesi,
									(	
										SELECT C.*, OC.CEVAP, SECILI = CASE WHEN SUBS.ID_SORUTUR=4 THEN (CASE WHEN C.ID_CEVAP=(SELECT ID_CEVAP FROM SoruBankasi.dbo.Cevap WHERE ID_SORU=C.ID_SORU AND CEVAPNO=OC.CEVAP) THEN 1 ELSE 0 END) ELSE 0 END
										FROM SoruBankasi.dbo.Cevap C
										LEFT JOIN OnlineSinavOgrenciCevap OC ON OC.ID_SORU=C.ID_SORU AND (SUBS.ID_SORUTUR=4 OR (SUBS.ID_SORUTUR<>4 AND OC.CEVAPNO=C.CEVAPNO)) AND OC.ID_ONLINESINAVOGRENCI=@ID_ONLINESINAVOGRENCI
										Where C.ID_SORU=SUBS.ID_SORU ORDER BY ID_CEVAP,C.CEVAPNO,LEN(DEGER) DESC FOR JSON PATH
									)AS CevapListesi,
									(SELECT * FROM SoruBankasi.dbo.SoruCozum Where ID_SORU=SUBS.ID_SORU FOR JSON PATH)AS CozumListesi
								FROM SoruBankasi.dbo.Soru SUBS 
								WHERE SUBS.ID_SORU = S.ID_SORU OR SUBS.ID_USTSORU = S.ID_SORU
								FOR JSON AUTO, INCLUDE_NULL_VALUES 
							) AS SoruPaketList
						)AS SoruPaketList
					FROM SoruBankasi.dbo.Soru S
					INNER JOIN SoruBankasi.dbo.SinavSoru SS ON SS.ID_SORU=S.ID_SORU
					WHERE ID_SINAV=@ID_SINAV AND SS.KITAPCIK='A' AND ID_SORUTUR<>1 AND ID_USTSORU IS NULL
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			-- YENİ ONLINE SINAV

			IF @ISLEM = 8	--	ONLINE SINAV DETAY						
			BEGIN

				SELECT ISNULL((
					SELECT DISTINCT 
						 S.ID_SINAV
						,CEVAPGOR		= ISNULL(OSD.CEVAPGOR,0)
						,ACIKLANMATARIH	= CONVERT(varchar,ISNULL(OSD.ACIKLANMATARIH,DATEADD(WEEK,2,GETDATE())),104)
						,ACIKLANMASAAT	= CONVERT(char(5),ISNULL(OSD.ACIKLANMATARIH,DATEADD(WEEK,2,GETDATE())),108)
						,OSDO.ID_ONLINESINAVDETAYOTURUM
						,OTURUM			= ISNULL(SOD.OTURUM,1)
						,BASTARIH		= CONVERT(varchar,ISNULL(OSDO.BASTARIH,GETDATE()),104)
						,BASSAAT		= CONVERT(char(5),ISNULL(OSDO.BASTARIH,DATEADD(HOUR,ISNULL(SOD.OTURUM,1),GETDATE())),108)
						,BITTARIH		= CONVERT(varchar,ISNULL(OSDO.BITTARIH,DATEADD(WEEK,1,GETDATE())),104)
						,BITSAAT		= CONVERT(char(5),ISNULL(OSDO.BITTARIH,DATEADD(WEEK,1,DATEADD(HOUR,ISNULL(SOD.OTURUM,1),GETDATE()))),108)
						,SURE			= ISNULL(OSDO.SURE,100)
					FROM Sinav								S	 WITH(NOLOCK) 
					LEFT JOIN Tbl_OnlineSinavDetay			OSD	 WITH(NOLOCK) ON	OSD.ID_SINAV			= S.ID_SINAV
																			  AND	OSD.AKTIF				= 1 
					LEFT JOIN SinavDers						SD	 WITH(NOLOCK) ON	SD.ID_SINAV				= S.ID_SINAV
					LEFT JOIN SinavOptikDers				SOD	 WITH(NOLOCK) ON	SOD.ID_SINAVDERS		= SD.ID_SINAVDERS
					LEFT JOIN Tbl_OnlineSinavDetayOturum	OSDO WITH(NOLOCK) ON	OSDO.ID_ONLINESINAVDETAY= OSD.ID_ONLINESINAVDETAY
																			  AND	OSDO.OTURUM				= ISNULL(SOD.OTURUM,1)
					WHERE	S.ID_SINAV	= @ID_SINAV
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 9	--	ONLINE SINAV DETAY KAYDET				
			BEGIN

				UPDATE Tbl_OnlineSinavDetay SET
					AKTIF = 0
				WHERE	ID_SINAV = JSON_VALUE (@SQLJSON, '$.ID_SINAV') 
					AND AKTIF	 = 1

				
				DROP TABLE IF EXISTS #TEMP9

				SELECT	 ID_SINAV
						,BASTARIH		= CAST(CAST(BASTARIH		+ ' ' +BASSAAT		+':00' AS datetime2) AS smalldatetime)
						,BITTARIH		= CAST(CAST(BITTARIH		+ ' ' +BITSAAT		+':00' AS datetime2) AS smalldatetime)
						,ACIKLANMATARIH = CAST(CAST(ACIKLANMATARIH	+ ' ' +ACIKLANMASAAT+':00' AS datetime2) AS smalldatetime)
						,BITACIKLANMATARIH = CAST(CAST(BITACIKLANMATARIH	+ ' ' +ACIKLANMASAAT+':00' AS datetime2) AS smalldatetime)
						,SURE
						,CEVAPGOR
						,OTURUM
				INTO #TEMP9
				FROM OPENJSON(@SQLJSON)
				WITH(
					ID_SINAV			INT,
					CEVAPGOR			BIT,
					ACIKLANMATARIH		VARCHAR(MAX),
					ACIKLANMASAAT		VARCHAR(MAX),
					BITACIKLANMATARIH	VARCHAR(MAX),
					OSDO				NVARCHAR(MAX) AS JSON
				) AS J
				CROSS APPLY OPENJSON(J.OSDO)
				WITH(
					OTURUM		INT,
					BASTARIH	VARCHAR(MAX),
					BASSAAT		VARCHAR(MAX),
					BITTARIH	VARCHAR(MAX),
					BITSAAT		VARCHAR(MAX),
					SURE		INT		
				)

				DECLARE @INSTABLE9 TABLE (ID INT)

				DECLARE @ACIKLANMATARIH smalldatetime = (
					SELECT IIF(MAX(ACIKLANMATARIH) > MAX(BITTARIH), MAX(ACIKLANMATARIH), MAX(BITTARIH) )
					FROM #TEMP9
				)
				DECLARE @BITACIKLANMATARIH smalldatetime = (
					SELECT IIF(MAX(BITACIKLANMATARIH) > MAX(BITTARIH), MAX(BITACIKLANMATARIH), MAX(BITTARIH) )
					FROM #TEMP9
				)
				
				INSERT INTO Tbl_OnlineSinavDetay (ID_SINAV, ACIKLANMATARIH,BITACIKLANMATARIH, CEVAPGOR, KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_ONLINESINAVDETAY  INTO @INSTABLE9 (ID)
				SELECT TOP 1 ID_SINAV, @ACIKLANMATARIH,@BITACIKLANMATARIH, CEVAPGOR, @TCKIMLIKNO FROM #TEMP9
				
				DECLARE @ID_ONLINESINAVDETAY INT = (SELECT TOP 1 ID FROM @INSTABLE9)
				
				INSERT INTO Tbl_OnlineSinavDetayOturum (ID_ONLINESINAVDETAY, OTURUM, BASTARIH, BITTARIH, SURE)
				SELECT @ID_ONLINESINAVDETAY, OTURUM, BASTARIH, BITTARIH, SURE FROM #TEMP9

				DROP TABLE IF EXISTS #TEMP9

			END

			IF @ISLEM = 10	--	OGRENCI ATAMA							
			BEGIN

				IF EXISTS (SELECT TOP 1 1 FROM OPENJSON(@TC_OGRENCILIST))
				BEGIN
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV, VALUE AS TCKIMLIKNO, @TCKIMLIKNO FROM OPENJSON(@TC_OGRENCILIST) J
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND OS.TCKIMLIKNO = J.VALUE)
				END
				ELSE
				BEGIN
					INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT DISTINCT @ID_SINAV, SO.TCKIMLIKNO, @TCKIMLIKNO
					FROM OPENJSON(@ID_SINIFLIST)		S
					JOIN OkyanusDB.dbo.vw_SinifOgrenci	SO  WITH(NOLOCK)	ON	SO.ID_SINIF	= S.VALUE
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 AND OS.ID_SINAV = @ID_SINAV AND OS.TCKIMLIKNO = SO.TCKIMLIKNO)
				END

			END

			IF @ISLEM = 11	--	OGRENCI ATAMA LİSTE						
			BEGIN

			IF(@DIS_OGRENCI=1)
			BEGIN
					SELECT ISNULL((
					SELECT DISTINCT 
						 K.TCKIMLIKNO
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,TARIH			= CONVERT(VARCHAR, OSO.KYE_TARIH, 104 )
						,OGRENCISAYISI	= COUNT(1)
						,OGRENCILIST	= ISNULL((
							SELECT DISTINCT 
								 DO.TCKIMLIKNO
								,ADSOYAD	= DO.AD + ' ' + DO.SOYAD
								,'' AS SUBEAD
								,'' AS SINIFAD
							FROM Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)
							JOIN DisOgrenci	DO	WITH(NOLOCK)	ON	DO.TCKIMLIKNO	= SO.TCKIMLIKNO
							WHERE	SO.KYE_TCKIMLIKNO	= K.TCKIMLIKNO
								AND SO.KYE_TARIH		= OSO.KYE_TARIH
								AND	SO.AKTIF			= 1
 								AND DO.DONEM			= (SELECT OkyanusDB.dbo.fn_AktifDonem())
							FOR JSON PATH
						),'[]')
						,OSO.KYE_TARIH
					FROM Tbl_OnlineSinavOgrenci	OSO	WITH(NOLOCK)	
					JOIN v3Kullanici			K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= OSO.KYE_TCKIMLIKNO
					JOIN DisOgrenci	DO	WITH(NOLOCK)	ON	DO.TCKIMLIKNO	= OSO.TCKIMLIKNO
					WHERE	OSO.ID_SINAV	= @ID_SINAV
						AND OSO.AKTIF		= 1
						AND K.AKTIF			= 1
					GROUP BY OSO.KYE_TARIH, K.TCKIMLIKNO, K.AD, K.SOYAD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END

			ELSE
			BEGIN
				SELECT ISNULL((
					SELECT DISTINCT 
						 K.TCKIMLIKNO
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,TARIH			= CONVERT(VARCHAR, OSO.KYE_TARIH, 104 )
						,OGRENCISAYISI	= COUNT(DISTINCT K.TCKIMLIKNO)
						,OGRENCILIST	= ISNULL((
							SELECT DISTINCT 
								 SK.TCKIMLIKNO
								,ADSOYAD	= SK.AD + ' ' + SK.SOYAD
								,SK.SUBEAD
								,SK.SINIFAD
							FROM Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)
							JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	SK	WITH(NOLOCK)	ON	SK.TCKIMLIKNO	= SO.TCKIMLIKNO
							WHERE	SO.KYE_TCKIMLIKNO	= K.TCKIMLIKNO
								AND SO.KYE_TARIH		= OSO.KYE_TARIH
								AND	SO.AKTIF			= 1
								AND SK.ID_SINIF			> 0
								AND SK.DONEM			= (SELECT OkyanusDB.dbo.fn_AktifDonem())
							FOR JSON PATH
						),'[]')
						,OSO.KYE_TARIH
					FROM Tbl_OnlineSinavOgrenci	OSO	WITH(NOLOCK)	
					JOIN v3Kullanici			K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= OSO.KYE_TCKIMLIKNO
					JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	SK	WITH(NOLOCK)	ON	SK.TCKIMLIKNO	= OSO.TCKIMLIKNO
					WHERE	OSO.ID_SINAV	= @ID_SINAV
						AND OSO.AKTIF		= 1
						AND K.AKTIF			= 1
					GROUP BY OSO.KYE_TARIH, K.TCKIMLIKNO, K.AD, K.SOYAD
					FOR JSON PATH, INCLUDE_NULL_VALUES
				),'[]')
			END

			

			END

			IF @ISLEM = 12	--	ÖĞRENCİ YENİ ONLINE SINAV LİSTESİ		
			BEGIN
			
				CREATE TABLE #TEMP12SINAV (ID_SINAV INT)

				SET @QUERY = (	SELECT DEGER 
								FROM Parametre		P 	WITH(NOLOCK)	
								JOIN ParametreDeger PD	WITH(NOLOCK)	ON	PD.ID_PARAMETREDEGER = P.ID_PARAMETREDEGER 
								WHERE P.ID_PARAMETRE = 1) -- Öğrenci Online Sınav Listesi

				INSERT INTO #TEMP12SINAV
				EXEC (@QUERY)
				
				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,SINAVTURU	= ST.AD
						,SINAVAD	= S.AD
						,OTURUM		= IIF((GETDATE() > SD.ACIKLANMATARIH AND S.DURUM = 2),  0, SDO.OTURUM)--SDO.OTURUM
						,ACIKLANDI	= CAST(IIF( (GETDATE() > SD.ACIKLANMATARIH AND S.DURUM = 2), 1 , 0) AS bit )
						,DEVAM		= CAST(CASE WHEN	GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH 
													AND GETDATE() < DATEADD(MINUTE, SDO.SURE, ISNULL(SOO.BASTARIH,GETDATE())) THEN 1 
												ELSE 0 
											END 
										AS BIT)
						,COZULDU	= CAST( IIF(C.ID_ONLINESINAVOGRENCI IS NULL, 0 , 1) AS bit)
						,PERFORMANS	= CASE 
										WHEN GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH	THEN '--' 
										WHEN GETDATE() < SDO.BASTARIH							THEN 'Sınav Henüz Başlamadı' 
										WHEN GETDATE() > SD.ACIKLANMATARIH  AND S.DURUM != 2	THEN 'Açıklanması Bekleniyor' 
										ELSE CAST((	SELECT CAST(CAST(sum(SOT.TN) AS decimal(8,2)) / CAST(sum(SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
													FROM SinavOgrenciToplam SOT	WITH(NOLOCK)
													WHERE	SOT.TCKIMLIKNO	= SO.TCKIMLIKNO
														AND	SOT.ID_SINAV	= S.ID_SINAV
											 	) AS VARCHAR)
									END
						,Convert(varchar,SDO.BITTARIH , 120) AS BITTARIH					
						,Convert(varchar,SDO.BASTARIH , 120) AS BASTARIH
						,SDO.SURE
						,CONVERT(VARCHAR,S.SINAVTARIH , 104) AS SINAVTARIH
					FROM Sinav								S	WITH(NOLOCK)	
					JOIN #TEMP12SINAV						TS					ON	TS.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetay				SD	WITH(NOLOCK)	ON	SD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			SDO	WITH(NOLOCK)	ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
																				AND SDO.OTURUM				= IIF((GETDATE() > SD.ACIKLANMATARIH   AND S.DURUM = 2),  1, SDO.OTURUM)
					JOIN SinavTuru							ST	WITH(NOLOCK)	ON	ST.ID_SINAVTURU			= S.ID_SINAVTURU
					JOIN Tbl_OnlineSinavOgrenci				SO	WITH(NOLOCK)	ON	SO.ID_SINAV				= SD.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	SOO	WITH(NOLOCK)	ON	SOO.TCKIMLIKNO			= SO.TCKIMLIKNO
																				AND SOO.ID_SINAV			= S.ID_SINAV
																				AND SOO.OTURUM				= SDO.OTURUM

					LEFT JOIN Tbl_OnlineSinavOgrenciCevap	C	WITH(NOLOCK)	ON	C.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
																				AND C.AKTIF					= 1
																				AND EXISTS (SELECT TOP 1 1 
																							FROM SinavAnahtar	GSA
																							JOIN SinavDers		GSD ON GSD.ID_SINAVDERS = GSA.ID_SINAVDERS
																							JOIN SinavOptikDers GSO ON GSO.ID_SINAVDERS = GSD.ID_SINAVDERS
																							WHERE	(GSO.OTURUM		= SDO.OTURUM OR (GETDATE() > SD.ACIKLANMATARIH   AND S.DURUM = 2))
																								AND GSD.ID_SINAV	= SO.ID_SINAV
																								AND C.ID_SINAVANAHTAR = GSA.ID_SINAVANAHTAR
																				)
					WHERE	SO.TCKIMLIKNO	= @TCKIMLIKNO
						AND SD.AKTIF		= 1
						AND SO.AKTIF		= 1
						AND S.ONLINESINAV	= 1
					ORDER BY Convert(varchar,SDO.BITTARIH , 120)  DESC
					FOR JSON PATH
				),'[]')
				DROP TABLE IF EXISTS #TEMP12SINAV

			END

			IF @ISLEM = 13	--	ÖĞRENCİ YENİ ONLINE SINAV DETAY			
			BEGIN

				IF @SINAVOTURUM IS NULL 
					SET @SINAVOTURUM = 0

				UPDATE OO SET
					BASTARIH = GETDATE()
				FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
					AND O.AKTIF			= 1
					AND OO.ID_SINAV		= @ID_SINAV
					AND OO.OTURUM		= @SINAVOTURUM
					AND OO.BASTARIH		IS NULL

				IF	@SINAVOTURUM > 0
					AND NOT EXISTS (SELECT TOP 1 1 
									FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
									JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO	= O.TCKIMLIKNO
									WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
										AND O.AKTIF			= 1
										AND OO.ID_SINAV		= @ID_SINAV
										AND OO.OTURUM		= @SINAVOTURUM
									)
					AND EXISTS (SELECT TOP 1 1
								FROM Tbl_OnlineSinavDetay		D	WITH(NOLOCK)	
								JOIN Tbl_OnlineSinavDetayOturum	DO	WITH(NOLOCK)	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
								WHERE	D.ID_SINAV	= @ID_SINAV
									AND D.AKTIF		= 1
									AND DO.OTURUM	= @SINAVOTURUM
									AND GETDATE() BETWEEN DO.BASTARIH AND DO.BITTARIH
								)
				BEGIN
					INSERT INTO  Tbl_OnlineSinavOgrenciOturum (TCKIMLIKNO, ID_SINAV, OTURUM )
					VALUES (@TCKIMLIKNO, @ID_SINAV, @SINAVOTURUM)
				END
							
																

				DECLARE @BASLAMA_TARIHI DATETIME;
				DECLARE @BITIS_TARIHI DATETIME;
				DECLARE @GIRIS_TARIHI DATETIME;

				DECLARE @SINAV_SONLANMA_SAATI DATETIME;
				DECLARE @SURE INT = 0;
				DECLARE @SINAV_BITISE_KALAN INT =0;
				DECLARE @KALAN VARCHAR(MAX) =NULL;
				SELECT @BASLAMA_TARIHI = OSDO.BASTARIH,@BITIS_TARIHI=OSDO.BITTARIH,@GIRIS_TARIHI=OSOO.BASTARIH,@SURE=OSDO.SURE
				FROM Sinav								S		WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
				JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
																				AND (	OSDO.OTURUM				= @SINAVOTURUM
																					OR	0						= @SINAVOTURUM)
				JOIN Tbl_OnlineSinavOgrenci				OSO		WITH(NOLOCK)	ON	OSO.ID_SINAV				= S.ID_SINAV
				LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OSOO	WITH(NOLOCK)	ON	OSOO.TCKIMLIKNO				= OSO.TCKIMLIKNO
																				AND OSOO.ID_SINAV				= S.ID_SINAV
																				AND OSOO.OTURUM					= OSDO.OTURUM
				WHERE	S.ID_SINAV		= @ID_SINAV
					AND OSO.TCKIMLIKNO	= @TCKIMLIKNO
					AND OSD.AKTIF		= 1
					AND OSO.AKTIF		= 1
					AND S.AKTIF			= 1
					AND S.OZEL			= 0
						
				SET @SINAV_SONLANMA_SAATI	= DATEADD(MINUTE,@SURE,@GIRIS_TARIHI)
				SET @SINAV_BITISE_KALAN		= DATEDIFF(MINUTE,GETDATE(),@BITIS_TARIHI)
				
				IF @SINAV_SONLANMA_SAATI < @BITIS_TARIHI
					SET @SINAV_BITISE_KALAN = DATEDIFF(MINUTE,GETDATE(),@SINAV_SONLANMA_SAATI)

				IF  @SINAV_BITISE_KALAN >= @SURE  
				BEGIN
					SET @SINAV_SONLANMA_SAATI	= DATEADD(MINUTE,@SURE ,@GIRIS_TARIHI)
					SET @SINAV_BITISE_KALAN		= DATEDIFF(MINUTE,GETDATE(),@SINAV_SONLANMA_SAATI)
				END
				SET @KALAN	= CAST(CAST( @SINAV_BITISE_KALAN AS VARCHAR ) 
							+ ':' 
							+ IIF(@SINAV_BITISE_KALAN > -1
									,CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, @SINAV_BITISE_KALAN, @BITIS_TARIHI)) % 60) AS varchar)
									,'00')
								AS varchar)

				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,DEVAM			= CAST(CASE WHEN GETDATE() BETWEEN OSDO.BASTARIH AND OSDO.BITTARIH AND GETDATE() < DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH) THEN 1 ELSE 0 END AS bit )
						,ACIKLANDI		= CAST(CASE WHEN GETDATE() > OSD.ACIKLANMATARIH AND S.DURUM = 2 THEN 1 ELSE 0 END AS bit )
					--KALANSURE		= CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH)) / 60) AS varchar) + ':' + CAST((DATEDIFF(SECOND,GETDATE(), DATEADD(MINUTE, OSDO.SURE, OSOO.BASTARIH)) % 60) AS varchar)
						,KALANSURE      = @KALAN	
						,ID_SINAVDERS	= SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,TAKMAAD		= SD.TAKMAAD
						,SORUNO			= SA.SORUNO
						,ID_SINAVANAHTAR= SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END
						,OGRENCICEVAP	= ISNULL(OSOC.ID_CEVAP, NULL)
						,COZUMLIST		= JSON_QUERY(
											IIF(GETDATE() < OSD.ACIKLANMATARIH, 
												NULL,
												(SELECT	 SC.ID_COZUM
														,COZUMHTML	= CASE WHEN SC.COZUMHTML  IS NULL THEN '' ELSE 'SoruBankasi/'+ SC.COZUMHTML  END
												FROM SoruBankasi.dbo.SoruCozum SC WITH(NOLOCK)	
												WHERE SC.ID_SORU = SBSH.ID_SORU
												ORDER BY SC.SIRA
												FOR JSON PATH)
											))
						,CEVAPNO		= SBC.CEVAPNO
						,ID_CEVAP		= SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
						,OGRENCICEVAP	= CAST(IIF( OSOC.ID_CEVAP = SBC.ID_CEVAP , 1, 0) AS bit)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
																					AND (	OSDO.OTURUM				= @SINAVOTURUM
																						OR	0						= @SINAVOTURUM)
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
					JOIN Tbl_OnlineSinavOgrenci				OSO		WITH(NOLOCK)	ON	OSO.ID_SINAV				= S.ID_SINAV
					LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OSOO	WITH(NOLOCK)	ON	OSOO.TCKIMLIKNO				= OSO.TCKIMLIKNO
																					AND OSOO.ID_SINAV				= S.ID_SINAV
																					AND OSOO.OTURUM					= OSDO.OTURUM
					LEFT JOIN Tbl_OnlineSinavOgrenciCevap	OSOC	WITH(NOLOCK)	ON	OSOC.ID_ONLINESINAVOGRENCI	= OSO.ID_ONLINESINAVOGRENCI
																					AND OSOC.ID_SINAVANAHTAR		= SA.ID_SINAVANAHTAR
																					AND OSOC.AKTIF					= 1
					WHERE	S.ID_SINAV		= @ID_SINAV
						AND OSO.TCKIMLIKNO	= @TCKIMLIKNO
						AND OSD.AKTIF		= 1
						AND OSO.AKTIF		= 1
						AND SK.AD			= 'A'
						AND S.AKTIF			= 1
						AND S.OZEL			= 0
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')

			END

			IF @ISLEM = 14	--	ÖĞRENCİ YENİ ONLINE SINAV SORU İŞARETLE	
			BEGIN

				IF NOT EXISTS(SELECT TOP 1 1 FROM SinavAnahtar WHERE ID_SINAVANAHTAR = @ID_SINAVANAHTAR)
				BEGIN
					RAISERROR('Sınav güncellendiği için cevabınızı kaydedemiyoruz. Lüten sınavı yeniden açınız !!!',16,1)
					RETURN
				END
				ELSE
				BEGIN

					SET @ID_ONLINESINAVOGRENCI = ISNULL((
						SELECT TOP 1 ID_ONLINESINAVOGRENCI
						FROM Tbl_OnlineSinavOgrenci			O	WITH(NOLOCK)	
						JOIN Tbl_OnlineSinavDetay			D	WITH(NOLOCK)	ON	D.ID_SINAV				= O.ID_SINAV
						JOIN Tbl_OnlineSinavDetayOturum		DO	WITH(NOLOCK)	ON	DO.ID_ONLINESINAVDETAY	= D.ID_ONLINESINAVDETAY
						JOIN Tbl_OnlineSinavOgrenciOturum	OO	WITH(NOLOCK)	ON	OO.TCKIMLIKNO			= O.TCKIMLIKNO
																				AND OO.ID_SINAV				= O.ID_SINAV
																				AND OO.OTURUM				= DO.OTURUM
						WHERE	O.TCKIMLIKNO	= @TCKIMLIKNO
							AND O.ID_SINAV		= @ID_SINAV
							AND DO.OTURUM		= @SINAVOTURUM
							AND O.AKTIF			= 1
							AND D.AKTIF			= 1
							AND GETDATE() BETWEEN DO.BASTARIH AND DO.BITTARIH
							AND GETDATE() < DATEADD(MINUTE, DO.SURE, OO.BASTARIH)
					),0)

					IF @ID_ONLINESINAVOGRENCI > 0
					BEGIN

						UPDATE Tbl_OnlineSinavOgrenciCevap SET
							AKTIF = 0
						WHERE	ID_ONLINESINAVOGRENCI	= @ID_ONLINESINAVOGRENCI
							AND	ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
							AND AKTIF					= 1

						IF @ID_CEVAP IS NOT NULL
							INSERT INTO Tbl_OnlineSinavOgrenciCevap (ID_ONLINESINAVOGRENCI, ID_SINAVANAHTAR, ID_CEVAP)  
							VALUES (@ID_ONLINESINAVOGRENCI, @ID_SINAVANAHTAR, @ID_CEVAP)

					END

					SELECT ISNULL(@ID_ONLINESINAVOGRENCI,0)

				END

			END

			IF @ISLEM = 15	--	ÖĞRENCİ YENİ ONLINE SINAV PERFORMANS	
			BEGIN
			
				DECLARE @TABLE TABLE(RESULT VARCHAR(MAX))

				INSERT INTO @TABLE
				EXEC sp_OnlineSinav @TCKIMLIKNO = @TCKIMLIKNO, @OTURUM = @OTURUM, @ID_SINAV = @ID_SINAV, @ISLEM = 13
								
				SELECT (
					SELECT ISNULL((
						SELECT DISTINCT
							 SINAVTURU		= ST.AD
							,SINAVAD		= S.AD
							,SONGIRIS		= (	SELECT TOP 1 CONVERT(varchar, OSOC.KYE_TARIH, 104) + ' ' + CONVERT(varchar, OSOC.KYE_TARIH, 108)
												FROM Tbl_OnlineSinavOgrenci			OSO  WITH(NOLOCK) 
												JOIN Tbl_OnlineSinavOgrenciCevap	OSOC WITH(NOLOCK) ON	OSOC.ID_ONLINESINAVOGRENCI = OSO.ID_ONLINESINAVOGRENCI
												WHERE	OSO.AKTIF	= 1
													AND OSOC.AKTIF	= 1
												ORDER BY OSOC.ID_ONLINESINAVOGRENCICEVAP DESC
												)
							,DOGRU			= SOT.TD
							,YANLIS			= SOT.TY
							,BOS			= SOT.TB
							,NET			= SOT.TN
							,NETPERFORMANS	= CAST(CAST(SOT.TN AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,DOGRUPERFORMANS	= CAST(CAST(SOT.TD AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,YANLISPERFORMANS	= CAST(CAST(SOT.TY AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							--,BOSPERFORMANS	= CAST(CAST(SOT.TB AS decimal(8,2)) / CAST((SOT.TD + SOT.TY + SOT.TB) AS decimal(8,2)) * 100.0  AS decimal(8,2))
							,DERSPERFORMANS	= JSON_QUERY(
													ISNULL((	SELECT	 SD.BOLUMNO
																	,SD.TAKMAAD
																	,YUZDENET
															FROM SinavDers				SD	 WITH(NOLOCK) 
															JOIN vw_SinavOgrenciBolum	SOB	 WITH(NOLOCK)	ON	SOB.ID_SINAVDERS	= SD.ID_SINAVDERS
																											AND SOB.TCKIMLIKNO		= SOT.TCKIMLIKNO
															WHERE SD.ID_SINAV = S.ID_SINAV
															ORDER BY BOLUMNO
															FOR JSON PATH
													),'[]')
												)
						FROM Tbl_OnlineSinavDetay		OSD	 WITH(NOLOCK) 
						JOIN Tbl_OnlineSinavDetayOturum	DO	 WITH(NOLOCK) ON	DO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
						JOIN SinavOgrenciToplam			SOT	 WITH(NOLOCK) ON	SOT.ID_SINAV	= OSD.ID_SINAV
						JOIN Sinav						S	 WITH(NOLOCK) ON	S.ID_SINAV		= SOT.ID_SINAV
						JOIN SinavTuru					ST	 WITH(NOLOCK) ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
						WHERE	SOT.ID_SINAV		= @ID_SINAV
							AND SOT.TCKIMLIKNO		= @TCKIMLIKNO
							AND OSD.AKTIF			= 1
							AND S.AKTIF				= 1
							AND S.OZEL				= 0
							AND DO.BITTARIH			< GETDATE()
							AND OSD.ACIKLANMATARIH	< GETDATE()
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),'[]') AS PERFORMANS,
					JSON_QUERY((	
						SELECT RESULT 
						FROM @TABLE
					))  AS SINAV
					FOR JSON PATH
				)

			END

			IF @ISLEM = 16	--	ÖĞRENCİ ATAMA KALDIRMA					
			BEGIN

				UPDATE O SET
					AKTIF = 0
				FROM Tbl_OnlineSinavOgrenci	O  WITH(NOLOCK) 
				WHERE	ID_SINAV		= @ID_SINAV
					AND	KYE_TCKIMLIKNO	= @TC_EKLEYEN
					AND KYE_TARIH		= @KYE_TARIH
					AND NOT EXISTS (SELECT TOP 1 1 
									FROM Tbl_OnlineSinavOgrenciCevap C  WITH(NOLOCK) 
									WHERE	C.ID_ONLINESINAVOGRENCI = O.ID_ONLINESINAVOGRENCI 
										AND C.AKTIF					= 1)

				SELECT COUNT(DISTINCT TCKIMLIKNO)
				FROM Tbl_OnlineSinavOgrenci			O  WITH(NOLOCK) 
				JOIN Tbl_OnlineSinavOgrenciCevap	C  WITH(NOLOCK) ON	C.ID_ONLINESINAVOGRENCI = O.ID_ONLINESINAVOGRENCI					
				WHERE	O.ID_SINAV		= @ID_SINAV
					AND	O.KYE_TCKIMLIKNO= @TC_EKLEYEN
					AND O.KYE_TARIH		= @KYE_TARIH
					AND O.AKTIF			= 1
					AND C.AKTIF			= 1

			END

			IF @ISLEM = 17	--	SINAV DETAY RAPOR						
			BEGIN
			
				DECLARE @OGRENCI17 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY  WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
					IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
					BEGIN
						SET @OGRENCI17=1
					END												

				IF @OGRENCI17 = 1
					SET @CEVAPANAHTARI = 1
				ELSE IF NOT EXISTS(	SELECT TOP 1 1 
									FROM v3SubeYetki	SY  WITH(NOLOCK) 
									WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
										AND SY.ID_KULLANICITIPI = 1				--	ADMİN
									)
				BEGIN
					RETURN
					SET @CEVAPANAHTARI = 0
				END

				DROP TABLE IF EXISTS #TEMP17

				SELECT DISTINCT
					 S.ID_SINAV
					,SINAVAD		= S.AD						
					,SD.ID_SINAVDERS
					,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
					,TAKMAAD		= UPPER(SD.TAKMAAD)
					,SA.SORUNO
					,SA.ID_SINAVANAHTAR
					,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
					,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
					,SBC.CEVAPNO
					,CEVAPAD		= CASE	WHEN SBC.CEVAPNO = 1 THEN 'A'
											WHEN SBC.CEVAPNO = 2 THEN 'B'
											WHEN SBC.CEVAPNO = 3 THEN 'C'
											WHEN SBC.CEVAPNO = 4 THEN 'D'
											WHEN SBC.CEVAPNO = 5 THEN 'E'
											ELSE ''
										END
					,SBC.ID_CEVAP
					,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
					,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH 
											or EXISTS(	SELECT TOP 1 1 
														FROM v3SubeYetki	SY  WITH(NOLOCK) 
														WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
															AND SY.ID_KULLANICITIPI = 1				--	ADMİN
											), SBC.DEGER, NULL) AS BIT)
				INTO #TEMP17
				FROM Sinav								S		WITH(NOLOCK)	
				JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
				JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
				JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																				AND SK.AD						= 'A'
				JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
				JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																				AND SOD.OTURUM					= OSDO.OTURUM
				JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																				AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
				JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
				JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
				JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																				AND SBDC.DEGER					= '1'
				WHERE	S.ID_SINAV			= @ID_SINAV
					AND OSD.AKTIF			= 1
					AND SK.AD				= 'A'
					AND S.AKTIF				= 1
					AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
					AND (@OGRENCI17					= 0
						OR	(	@OGRENCI17			= 1
							AND S.DURUM				= 2
							AND OSD.ACIKLANMATARIH	< GETDATE()						
						))
				ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO


				SELECT DISTINCT
					 ID_SINAV
					,SINAVAD
				FROM #TEMP17
					
				SELECT DISTINCT
					 ID_SINAVDERS
					,BOLUMNO
					,TAKMAAD
					,SORUNO
					,ID_SINAVANAHTAR
					,SORUHTML
					,CEVAPNO
					,CEVAPAD
					,CEVAPHTML
				FROM #TEMP17
					
				SELECT DISTINCT
					 ID_SINAVDERS
					,BOLUMNO
					,TAKMAAD
					,SORUNO
					,CEVAP	= CASE	WHEN CEVAPNO = 1 THEN 'A'
									WHEN CEVAPNO = 2 THEN 'B'
									WHEN CEVAPNO = 3 THEN 'C'
									WHEN CEVAPNO = 4 THEN 'D'
									WHEN CEVAPNO = 5 THEN 'E'
									ELSE ''
								END
				FROM #TEMP17
				WHERE	DEGER			= 1
					AND @CEVAPANAHTARI	= 1

				DROP TABLE IF EXISTS #TEMP17


			END

			IF @ISLEM = 18	--	ONLINE SINAV ONIZLEME					
			BEGIN

				DECLARE @OGRENCI18 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY  WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
				IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
					BEGIN
						SET @OGRENCI18=1
					END					

				
				IF @OGRENCI18 = 0 AND NOT EXISTS(	SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 1				--	ADMİN
													)
				BEGIN
					SELECT '[]'
				END
				


				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,S.AD						
						,SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,SD.TAKMAAD
						,SA.SORUNO
						,SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
						,SBC.CEVAPNO
						,SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					JOIN SoruBankasi.dbo.Cevap				SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
					WHERE	S.ID_SINAV					= @ID_SINAV
						AND OSD.AKTIF					= 1
						AND SK.AD						= 'A'
						AND S.AKTIF						= 1
						AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
						AND (@OGRENCI18					= 0
							OR	(	@OGRENCI18			= 1
								AND S.DURUM				= 2
								AND OSD.ACIKLANMATARIH	< GETDATE()						
							))
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				

			END

			IF @ISLEM = 19	--	ONLINE SINAV ÖĞR OTURUM	SIFIRLAMA LİSTE	
			BEGIN
				IF @DIS_OGRENCI = 0
				BEGIN
					SELECT ISNULL((
						SELECT	 TCKIMLIKNO	= OD.TCKIMLIKNO
								,AD			= OD.AD
								,SOYAD		= OD.SOYAD
								,SUBEAD		= OD.SUBEAD
								,SINIFAD	= OD.SINIFAD
								,OTURUMLIST.ID_ONLINESINAVOGRENCIOTURUM
								,BASTARIH	= CONVERT(VARCHAR, OTURUMLIST.BASTARIH,104) + ' ' + CONVERT(VARCHAR, OTURUMLIST.BASTARIH,108)
								,OTURUM		= ISNULL(SDO.OTURUM,0)
						FROM Tbl_OnlineSinavDetay				SD			WITH(NOLOCK) 
						JOIN Tbl_OnlineSinavDetayOturum			SDO			WITH(NOLOCK) ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
						JOIN Tbl_OnlineSinavOgrenci				SO			WITH(NOLOCK) ON	SO.ID_SINAV				= SD.ID_SINAV
						JOIN OkyanusDB..v3Ogrenci				O			WITH(NOLOCK) ON	O.TCKIMLIKNO			= SO.TCKIMLIKNO
						JOIN OkyanusDB..vw_OgrenciDetayTum		OD			WITH(NOLOCK) ON	OD.TCKIMLIKNO			= O.TCKIMLIKNO
																						 AND OD.ID_SINIF			= O.ID_SINIF
						LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OTURUMLIST	WITH(NOLOCK) ON	OTURUMLIST.TCKIMLIKNO	= SO.TCKIMLIKNO
																						 AND OTURUMLIST.ID_SINAV	= SO.ID_SINAV
																						 AND OTURUMLIST.OTURUM		= SDO.OTURUM
																						 AND GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH
						WHERE	SD.ID_SINAV	= @ID_SINAV
							AND	SO.AKTIF	= 1
							AND SD.AKTIF	= 1
						ORDER BY SUBEAD, SINIFAD, AD, SOYAD, TCKIMLIKNO, SDO.OTURUM
						FOR JSON AUTO, INCLUDE_NULL_VALUES, ROOT('OGRENCILIST')
					),'{OGRENCILIST:[]}')
				END
				IF @DIS_OGRENCI = 1
				BEGIN
					SELECT ISNULL((
						SELECT	 TCKIMLIKNO	= DO.TCKIMLIKNO
								,AD			= DO.AD
								,SOYAD		= DO.SOYAD
								,SUBEAD		= (SELECT S.AD FROM v3Sube S WHERE S.SUBENO=DO.SUBE_NO )
								,SINIFAD	= (SELECT K.AD FROM v3Kademe K WHERE K.ID_KADEME = DO.ID_KADEME3)
								,OTURUMLIST.ID_ONLINESINAVOGRENCIOTURUM
								,BASTARIH	= CONVERT(VARCHAR, OTURUMLIST.BASTARIH,104) + ' ' + CONVERT(VARCHAR, OTURUMLIST.BASTARIH,108)
								,OTURUM		= ISNULL(SDO.OTURUM,0)
						FROM Tbl_OnlineSinavDetay				SD			WITH(NOLOCK) 
						JOIN Tbl_OnlineSinavDetayOturum			SDO			WITH(NOLOCK) ON	SDO.ID_ONLINESINAVDETAY	= SD.ID_ONLINESINAVDETAY 
						JOIN Tbl_OnlineSinavOgrenci				SO			WITH(NOLOCK) ON	SO.ID_SINAV				= SD.ID_SINAV
						JOIN DisOgrenci							DO			WITH(NOLOCK) ON	DO.TCKIMLIKNO			= SO.TCKIMLIKNO
						LEFT JOIN Tbl_OnlineSinavOgrenciOturum	OTURUMLIST	WITH(NOLOCK) ON	OTURUMLIST.TCKIMLIKNO	= SO.TCKIMLIKNO
																						 AND OTURUMLIST.ID_SINAV	= SO.ID_SINAV
																						 AND OTURUMLIST.OTURUM		= SDO.OTURUM
																						 AND GETDATE() BETWEEN SDO.BASTARIH AND SDO.BITTARIH
						WHERE	SD.ID_SINAV	= @ID_SINAV
							AND	SO.AKTIF	= 1
							AND SD.AKTIF	= 1
						ORDER BY SUBEAD, SINIFAD, AD, SOYAD, TCKIMLIKNO, SDO.OTURUM
						FOR JSON AUTO, INCLUDE_NULL_VALUES, ROOT('OGRENCILIST')
					),'{OGRENCILIST:[]}')

				END

			END

			IF @ISLEM = 20	--	ONLINE SINAV ÖĞR OTURUM	SIFIRLAMA 		
			BEGIN

				--UPDATE SOC SET
				--	SOC.AKTIF = 0
				DELETE SOC
				FROM Tbl_OnlineSinavOgrenciOturum	OO  WITH(NOLOCK) 
				JOIN Tbl_OnlineSinavOgrenci			SO  WITH(NOLOCK) 	ON	SO.ID_SINAV					= OO.ID_SINAV 
																		AND SO.TCKIMLIKNO				= OO.TCKIMLIKNO
				JOIN Tbl_OnlineSinavOgrenciCevap	SOC WITH(NOLOCK) 	ON	SOC.ID_ONLINESINAVOGRENCI	= SO.ID_ONLINESINAVOGRENCI
				JOIN vw_SinavDersOturum				SDO WITH(NOLOCK) 	ON	SDO.ID_SINAV				= SO.ID_SINAV
																		AND SDO.OTURUM					= OO.OTURUM
				JOIN SinavAnahtar					SA  WITH(NOLOCK) 	ON	SA.ID_SINAVDERS				= SDO.ID_SINAVDERS
																		AND SA.ID_SINAVANAHTAR			= SOC.ID_SINAVANAHTAR
				WHERE	ID_ONLINESINAVOGRENCIOTURUM	= @ID_ONLINESINAVOGRENCIOTURUM
					AND	SO.AKTIF					= 1
					AND	SOC.AKTIF					= 1

				DELETE FROM Tbl_OnlineSinavOgrenciOturum
				WHERE ID_ONLINESINAVOGRENCIOTURUM = @ID_ONLINESINAVOGRENCIOTURUM				

			END

			IF @ISLEM = 21	--	ONLINE SINAV ÇIKTI						
			BEGIN
					
				DECLARE @OGRENCI21 BIT = IIF(EXISTS(SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 4				--	ÖĞRENCİ
													),1,0) 
				IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
					BEGIN
						SET @OGRENCI21=1
					END					
				
				IF @OGRENCI21 = 0 AND NOT EXISTS(	SELECT TOP 1 1 
													FROM v3SubeYetki	SY WITH(NOLOCK) 
													WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
														AND SY.ID_KULLANICITIPI = 1				--	ADMİN
													)
				BEGIN
					SELECT '[]'
				END
				


				SELECT ISNULL((
					SELECT DISTINCT
						 S.ID_SINAV
						,S.AD						
						,SD.ID_SINAVDERS
						,BOLUMNO		= DENSE_RANK() OVER( ORDER BY SD.BOLUMNO)
						,SD.TAKMAAD
						,SA.SORUNO
						,SA.ID_SINAVANAHTAR
						,DOGRUCEVAP		= IIF(GETDATE() > OSD.ACIKLANMATARIH, SBDC.ID_CEVAP, NULL)
						,SORUHTML		= CASE WHEN SBSH.SORUHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBSH.SORUHTML END						
						,CEVAP			= CASE	WHEN SBDC.CEVAPNO = 1 THEN 'A'
												WHEN SBDC.CEVAPNO = 2 THEN 'B'
												WHEN SBDC.CEVAPNO = 3 THEN 'C'
												WHEN SBDC.CEVAPNO = 4 THEN 'D'
												WHEN SBDC.CEVAPNO = 5 THEN 'E'
												ELSE ''
										END
						,SBC.CEVAPNO
						,SBC.ID_CEVAP
						,CEVAPHTML		= CASE WHEN SBC.CEVAPHTML IS NULL THEN '' ELSE 'SoruBankasi/'+ SBC.CEVAPHTML END
						,DEGER			= CAST(IIF(GETDATE() > OSD.ACIKLANMATARIH, SBC.DEGER, NULL) AS BIT)
					FROM Sinav								S		WITH(NOLOCK)	
					JOIN Tbl_OnlineSinavDetay				OSD		WITH(NOLOCK)	ON	OSD.ID_SINAV				= S.ID_SINAV
					JOIN Tbl_OnlineSinavDetayOturum			OSDO	WITH(NOLOCK)	ON	OSDO.ID_ONLINESINAVDETAY	= OSD.ID_ONLINESINAVDETAY
					JOIN SinavKitapcik						SK		WITH(NOLOCK)	ON	SK.ID_SINAV					= S.ID_SINAV
																					AND SK.AD						= 'A'
					JOIN SinavDers							SD		WITH(NOLOCK)	ON	SD.ID_SINAV					= S.ID_SINAV
					JOIN SinavOptikDers						SOD		WITH(NOLOCK)	ON	SOD.ID_SINAVDERS			= SD.ID_SINAVDERS 
																					AND SOD.OTURUM					= OSDO.OTURUM
					JOIN SinavAnahtar						SA		WITH(NOLOCK)	ON	SA.ID_SINAVDERS				= SD.ID_SINAVDERS 
																					AND SA.ID_SINAVKITAPCIK			= SK.ID_SINAVKITAPCIK
					JOIN SoruBankasi.dbo.SoruHtml			SBSH	WITH(NOLOCK)	ON	SBSH.ID_SORU				= SA.ID_SORUBANKASI
					JOIN SoruBankasi.dbo.Cevap				SBC		WITH(NOLOCK)	ON	SBC.ID_SORU					= SBSH.ID_SORU
					LEFT JOIN SoruBankasi.dbo.Cevap			SBDC	WITH(NOLOCK)	ON	SBDC.ID_SORU				= SBSH.ID_SORU
																					AND SBDC.DEGER					= '1'
																					AND (GETDATE()					> OSD.ACIKLANMATARIH
																						OR EXISTS(	SELECT TOP 1 1 
																									FROM v3SubeYetki	SY WITH(NOLOCK) 
																									WHERE	SY.TCKIMLIKNO		= @TCKIMLIKNO
																										AND SY.ID_KULLANICITIPI = 1				--	ADMİN
																									)																						
																						)
																					AND @CEVAPANAHTARI				= 1

					WHERE	S.ID_SINAV					= @ID_SINAV
						AND OSD.AKTIF					= 1
						AND SK.AD						= 'A'
						AND S.AKTIF						= 1
						AND (S.OZEL=0	OR	@OZELSINAVGOR=1)
						AND (@OGRENCI21					= 0
							OR(	@OGRENCI21				= 1
							AND	EXISTS (SELECT TOP 1 1
										FROM Tbl_OnlineSinavOgrenci	SO WITH(NOLOCK) 
										WHERE TCKIMLIKNO	= @TCKIMLIKNO
											AND SO.ID_SINAV	= S.ID_SINAV
											AND SO.AKTIF	= 1
							)
						))
						AND (@OGRENCI21					= 0
							OR	(	@OGRENCI21			= 1
								AND S.DURUM				= 2
								AND OSD.ACIKLANMATARIH	< GETDATE()						
							))
					ORDER BY BOLUMNO, SA.SORUNO, SBC.CEVAPNO
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
				

			END

			IF @ISLEM = 22	--	ONLINE SINAV OTURUM OGRENCI LISTE		
			BEGIN
				IF @DIS_OGRENCI = 0
				BEGIN
					SELECT ISNULL((
						SELECT SO.TCKIMLIKNO
							,K.AD
							,K.SOYAD
							,SOO.OTURUM
							,SUBE	= SB.AD
							,SINIF	= S.AD
							,TARIH	=  CONVERT(VARCHAR(MAX), SOO.BASTARIH, 104) + ' ' + CONVERT(VARCHAR(MAX), SOO.BASTARIH, 108)
						FROM Sinav							SNV WITH(NOLOCK)
						JOIN Tbl_OnlineSinavOgrenci			SO	WITH(NOLOCK)	ON	SO.ID_SINAV		= SNV.ID_SINAV 
																				AND SO.AKTIF		= 1
						JOIN Tbl_OnlineSinavOgrenciOturum	SOO WITH(NOLOCK)	ON	SOO.TCKIMLIKNO	= SO.TCKIMLIKNO 
																				AND SOO.ID_SINAV	= SO.ID_SINAV
						JOIN OkyanusDB.dbo.v3Kullanici		K	WITH(NOLOCK)	ON	K.TCKIMLIKNO	= SOO.TCKIMLIKNO
						JOIN OkyanusDB.dbo.v3OgrenciTum		O	WITH(NOLOCK)	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO 
																				AND O.DONEM			= SNV.DONEM
						JOIN OkyanusDB.dbo.v3Sube			SB	WITH(NOLOCK)	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN OkyanusDB.dbo.v3SinifTum		S	WITH(NOLOCK)	ON	S.ID_SINIF		= O.ID_SINIF 
																				AND S.DONEM			= SNV.DONEM
						WHERE	SNV.AKTIF = 1 
							AND SNV.ID_SINAV = @ID_SINAV
							AND (	(O.ID_SUBE	IN (select value from openjson (@ID_SUBELIST)))
								OR	(0			IN (select value from openjson (@ID_SUBELIST))) 
								OR	@ID_SUBELIST='[]'
								)
						ORDER BY SB.AD, S.AD, K.AD, K.SOYAD, SOO.OTURUM
						FOR JSON PATH
					), '[]')
				END
				IF	@DIS_OGRENCI = 1
				BEGIN
					SELECT ISNULL((
					SELECT SO.TCKIMLIKNO
						,DO.AD
						,DO.SOYAD
						,SOO.OTURUM
						,SUBE	= S.AD
						,TARIH	=  CONVERT(VARCHAR(MAX), SOO.BASTARIH, 104) + ' ' + CONVERT(VARCHAR(MAX), SOO.BASTARIH, 108)
					FROM Sinav							SNV WITH(NOLOCK)
					JOIN Tbl_OnlineSinavOgrenci			SO	WITH(NOLOCK)	ON	SO.ID_SINAV		= SNV.ID_SINAV 
																			AND SO.AKTIF		= 1
					JOIN Tbl_OnlineSinavOgrenciOturum	SOO WITH(NOLOCK)	ON	SOO.TCKIMLIKNO	= SO.TCKIMLIKNO 
																			AND SOO.ID_SINAV	= SO.ID_SINAV
					JOIN DisOgrenci						DO	WITH(NOLOCK)	ON	DO.TCKIMLIKNO	= SOO.TCKIMLIKNO
					JOIN v3Sube							S	WITH(NOLOCK)	ON	S.SUBENO		= DO.SUBE_NO
					JOIN v3Kademe3						K   WITH(NOLOCK)	ON	K.ID_KADEME3	= DO.ID_KADEME3
					
					WHERE	SNV.AKTIF = 1 
						AND SNV.ID_SINAV = @ID_SINAV
						AND (	(S.ID_SUBE	IN (select value from openjson (@ID_SUBELIST)))
								OR	(0			IN (select value from openjson (@ID_SUBELIST))) 
								OR	@ID_SUBELIST='[]'
								)
						
					ORDER BY S.AD,DO.AD, DO.SOYAD, SOO.OTURUM
					FOR JSON PATH
				), '[]')
				END
			END

			IF @ISLEM = 23  -- ONLINE SINAV OTURUM SIFIRLAMA
			BEGIN			
				UPDATE Tbl_OnlineSinavOgrenciOturum
				SET BASTARIH = NULL
				WHERE ID_ONLINESINAVOGRENCIOTURUM = @ID_ONLINESINAVOGRENCIOTURUM
			END

			IF @ISLEM = 24  -- YONERGE KONTROL
			BEGIN
				SELECT ISNULL((
					SELECT S.YONERGE_GUID as YONERGE_GUID,OSO.YONERGE AS YONERGE
					FROM Sinav				    S
					JOIN Tbl_OnlineSinavOgrenci OSO ON OSO.ID_SINAV=S.ID_SINAV
					WHERE S.AKTIF = 1 AND S.YONERGE_GUID IS NOT NULL AND S.ID_SINAV=@ID_SINAV AND OSO.YONERGE=0 OR OSO.YONERGE IS NULL AND OSO.TCKIMLIKNO=@TCKIMLIKNO			
						FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END

			IF @ISLEM = 25  -- YONERGE ONAY
			BEGIN
				UPDATE Tbl_OnlineSinavOgrenci set YONERGE=1 WHERE ID_SINAV=@ID_SINAV and TCKIMLIKNO=@TCKIMLIKNO
			END
		END

	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_ApiDisOgrenci]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[sp_ApiDisOgrenci]
@ISLEM			INT,
@AD				VARCHAR(200)=NULL,
@SOYAD			VARCHAR(200)=NULL,
@TCKIMLIKNO		VARCHAR(11)=NULL,
@SINAVID		INT=NULL,
@SUBENO			INT=NULL

AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM		
				,AD						= @AD			
				,SOYAD					= @SOYAD		
				,TCKIMLIKNO				= @TCKIMLIKNO	
				,SINAVID				= @SINAVID	
				,SUBENO					= @SUBENO						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME


	IF @ID_LOG>1
	BEGIN
		IF @ISLEM=1
			BEGIN

			SELECT TCORJ = K.TCKIMLIKNO, TCYENI = CONVERT(varchar(11),CONVERT(bigint, K.TCKIMLIKNO) + 1 )
						INTO #API_ORJ_KULLANICI
						FROM v3Kullanici K 
						JOIN v3SubeYetki SY ON K.TCKIMLIKNO = SY.TCKIMLIKNO
			
				DECLARE @SINAV_GRUP INT=0
				DECLARE @SINAV_DONEM INT=0
				DECLARE @AKTIF_DONEM INT=(SELECT OkyanusDB.dbo.fn_AktifDonem())

				--Dışarıdan gelen SınavID ye göre Dönem ve Sınıf bilgisi bulunuyor ve değişkenlere atılıyor
				SELECT TOP 1 @SINAV_DONEM = DONEM
							,@SINAV_GRUP = ID_KADEME3 
				FROM Sinav 
				where ID_SINAV =  @SINAVID	

			--Öğrenci DisOgrenci tablsounda varsa DONEM ve ID_KADEME si sınava göre Update ediliyor
			UPDATE  DisOgrenci 
					SET DONEM=@SINAV_DONEM,
						ID_KADEME3=@SINAV_GRUP 
					WHERE TCKIMLIKNO=@TCKIMLIKNO 
					AND
					EXISTS (SELECT TOP 1 1 FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
 	
			--Gelen kayıt  TC Kontrolü ile dışÖğrenci tablosuna yazılıyor.
			INSERT INTO DisOgrenci (TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBE_NO)
						SELECT		@TCKIMLIKNO,@AD,@SOYAD,@SINAV_GRUP,@SINAV_DONEM,'','','',@SUBENO
						WHERE	
							NOT EXISTS (SELECT TOP 1 1 FROM DisOgrenci D WHERE D.TCKIMLIKNO = @TCKIMLIKNO AND AKTIF=1)
							AND NOT EXISTS(SELECT TOP 1 1 FROM v3Ogrenci O WHERE O.TCKIMLIKNO=(CONVERT(bigint, @TCKIMLIKNO)-1))

			--Gelen kayıt TCKIMLIKNO ve Aktif Sınav kontrolü ile Online Sınav tablosuna yazılıyor
			--EKLEYEN BILGISINE OKYANUS KOLEJLERİ TCKIMLIKNOSU MANUEL OLARAK VERILDI METE HOCA ILE GORUSULDU
			INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT  DISTINCT @SINAVID AS ID_SINAV, @TCKIMLIKNO , '14531453000'
					WHERE 
						NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 
						AND OS.ID_SINAV = @SINAVID AND CAST((CAST(OS.TCKIMLIKNO  AS bigint) + 1) AS varchar(MAX)) = @TCKIMLIKNO)
						AND NOT EXISTS(SELECT TOP 1 1 FROM v3Ogrenci O WHERE O.TCKIMLIKNO=(CONVERT(bigint,@TCKIMLIKNO)-1)) 


			INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
					SELECT  DISTINCT @SINAVID AS ID_SINAV, (CONVERT(bigint,@TCKIMLIKNO)-1) , '14531453000'
					WHERE 
						NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK) WHERE OS.AKTIF = 1 
						AND OS.ID_SINAV = @SINAVID AND CAST((CAST(OS.TCKIMLIKNO  AS bigint) + 1) AS varchar(MAX)) = @TCKIMLIKNO)
						AND EXISTS(SELECT TOP 1 1 FROM v3Ogrenci O WHERE O.TCKIMLIKNO=(CONVERT(bigint,@TCKIMLIKNO)-1))

			--SELECT @AD,@SOYAD,@TCKIMLIKNO,@SINAVID,@SUBENO FOR JSON AUTO

			SELECT 'Öğrenci başarıyla kayıt edildi' AS Mesaj FOR JSON PATH

			END
	END

	END TRY

	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		--EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH
	SET NOCOUNT OFF;
END
GO
PRINT N'Altering [dbo].[sp_AraKarne]...';


GO
ALTER procedure [dbo].[sp_AraKarne]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	--@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	
		ISLEM					= @ISLEM			
		,TCKIMLIKNO				= @TCKIMLIKNO		
		,TC_OGRENCI				= @TC_OGRENCI		
		,OTURUM					= @OTURUM			
		,IL						= @IL				
		,ILCE					= @ILCE			
		,ID_MENU				= @ID_MENU		
		,DONEM					= @DONEM			
		,ID_KADEME3				= @ID_KADEME3		
		,ID_SINAVTURU			= @ID_SINAVTURU	
		,ID_SINAV				= @ID_SINAV		
		,ID_DERS				= @ID_DERS		
		,ID_SUBE				= @ID_SUBE		
		,ID_SINIF				= @ID_SINIF		
		,DOSYAADI				= @DOSYAADI		
		,DOSYAGUID				= @DOSYAGUID		
		,ID_SINAVDOSYA			= @ID_SINAVDOSYA	
		,SQLJSON				= @SQLJSON		
		
		 					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--exec sp_AraKarne @ISLEM=2

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
 
	DECLARE @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM VARCHAR(4)=@DONEM,@sTC_OGRENCI VARCHAR(11)=@TC_OGRENCI
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END

	IF @ID_LOG > 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)	--	ARA KARNE DENEME SINAVLARI
		BEGIN
			DROP TABLE IF EXISTS #SINAVOGRENCI
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #Y1
			DROP TABLE IF EXISTS #Y2
			DROP TABLE IF EXISTS #Y3

			SET @ID_KADEME3 = (
								SELECT SG.ID_KADEME3 
								FROM OkyanusDB.dbo.v3OgrenciTum			OT
								JOIN OkyanusDB.dbo.v3SubeGrupSinifTum	SG	ON	SG.ID_SINIF		= OT.ID_SINIF
								WHERE OT.DONEM = @DONEM AND OT.TCKIMLIKNO = @TC_OGRENCI)

			SELECT DISTINCT	 SO.ID_SINAV
					,SO.ID_SINAVDERS
					,SO.TCKIMLIKNO
					,SO.DOGRU
					,SO.YANLIS
					,SO.BOS
					,SO.NET
					,DERSAD		= D.TAKMAAD
					,SINAVAD	= S.AD
					,DERSPUAN	= SO.PUAN
					,S.ID_SINAVTURU
					,S.PUANGIZLE
					,S.SINAVTARIH
					,S.OLCEKSINAVI
			INTO #SINAVOGRENCI
			FROM vw_SinavOgrenciBolum		SO
			JOIN Sinav						S	ON	S.ID_SINAV		= SO.ID_SINAV				
			JOIN SinavDers					D	ON	D.ID_SINAV		= SO.ID_SINAV
												AND D.ID_SINAVDERS	= SO.ID_SINAVDERS
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND S.DONEM			= @DONEM 
				AND S.ID_KADEME3	= @ID_KADEME3		
				AND (OZEL=0			OR @OZELSINAVGOR=1)
				AND SO.TCKIMLIKNO	= @TC_OGRENCI
			

			SELECT 	 SUBEAD	= ISNULL(SB.AD,'')
					,ISNULL(SNF.AD, S.SINIF) AS SINIF
					,ADSOYAD	= S.AD + ' ' + S.SOYAD
					,SO.TCKIMLIKNO 
					,ID_SINIF	= ISNULL(OT.ID_SINIF,0)
					,SV.ID_SINAVTURU
			INTO #T1
			FROM #SINAVOGRENCI						SO
			JOIN Sinav								SV	ON	SV.ID_SINAV				= SO.ID_SINAV
			JOIN SinavOgrenci						S	ON	S.TCKIMLIKNO			= SO.TCKIMLIKNO
														AND S.ID_SINAV				= SO.ID_SINAV
			LEFT JOIN OkyanusDB.dbo.V3Sube			SB	ON	CAST(SB.SUBENO AS INT)	= CAST(S.SUBENO AS INT)
			LEFT JOIN OkyanusDB.dbo.v3OgrenciTum	OT	ON	OT.TCKIMLIKNO			= S.TCKIMLIKNO
														AND OT.DONEM				= SV.DONEM
			LEFT JOIN OkyanusDB.dbo.v3Sinif			SNF ON SNF.ID_SINIF = OT.ID_SINIF


			INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU)
			SELECT TOP 1 SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1 FROM #T1
			
				
			
			SELECT DISTINCT UPPER(D.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD,do.ID_SINIF
			INTO #T2
			FROM EOKUL_V2.DBO.dersogretmen	DO
			JOIN OkyanusDB.dbo.v3kullanici  K	ON	K.TCKIMLIKNO	= DO.TC_OGRETMEN
			JOIN OkyanusDB.dbo.v3SinavDers	D	ON	D.ID_DERS		= DO.ID_DERS
			JOIN OkyanusDB.dbo.v3OgrenciTum O	ON	O.ID_SINIF		= DO.ID_SINIF 
												AND O.DONEM			= DO.DONEMKOD
			where	O.TCKIMLIKNO	= @TC_OGRENCI
				AND DO.DONEMKOD		= @DONEM




			SELECT	 SO.ID_SINAV
					,SO.ID_SINAVDERS
					,SO.TCKIMLIKNO					
					,OT.TD
					,OT.TY
					,OT.TB
					,OT.TN
					,SO.DERSAD
					,SO.ID_SINAVTURU
					,SO.SINAVAD
					,SO.SINAVTARIH   
					,SO.OLCEKSINAVI
					,SO.DOGRU
					,SO.YANLIS
					,SO.BOS
					,SO.NET
					,SO.DERSPUAN
			INTO #T4
			FROM #SINAVOGRENCI		SO
			JOIN SinavOgrenciToplam	OT	ON	OT.ID_SINAV		= SO.ID_SINAV 
										AND OT.TCKIMLIKNO	= SO.TCKIMLIKNO


			SELECT DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
			INTO	#T3
			FROM	#T4			T4
			JOIN	SinavTuru	ST	ON	ST.ID_SINAVTURU	= T4.ID_SINAVTURU	
			JOIN	SinavDers	SD	ON	SD.TAKMAAD		= T4.DERSAD 
									AND SD.ID_SINAV		= T4.ID_SINAV
			GROUP BY DERSAD ,ST.ID_SINAVTURU,ST.AD 	
			 

			SELECT	 SO.TCKIMLIKNO
					,SO.ID_SINAV				
					,PUANTURU	= UPPER(PT.AD) 
					,SO.SINAVAD	
					,SO.PUANGIZLE
					,SO.ID_SINAVTURU
					,SO.SINAVTARIH
					,P.PUAN
					,P.ID_SINAVPUANTURU
					,P.GENELSIRA
					,P.ILSIRA
					,P.ILCESIRA
					,P.OKULSIRA
					,P.SINIFSIRA
					,GENELKATILIM	= OT.KATILIM_GENEL
					,ILKATILIM		= OT.KATILIM_IL
					,ILCEKATILIM	= OT.KATILIM_ILCE
					,SUBEKATILIM	= OT.KATILIM_OKUL
					,SINIFKATILIM	= OT.KATILIM_SINIF
			INTO #T5
			FROM #SINAVOGRENCI			SO
			JOIN vw_SinavOgrenciPuan	P	ON	P.TCKIMLIKNO		= SO.TCKIMLIKNO
											AND P.ID_SINAV			= SO.ID_SINAV
			JOIN SinavOgrenciToplam		OT	ON	OT.TCKIMLIKNO		= SO.TCKIMLIKNO
											AND OT.ID_SINAV			= SO.ID_SINAV			
			JOIN SinavPuanTuru			PT	ON	PT.ID_SINAVPUANTURU	= P.ID_SINAVPUANTURU
			WHERE SO.PUANGIZLE = 0


			---------------------------------------------------------------------
			-- YAZILI
		BEGIN
			SELECT k.TCKIMLIKNO,
			   o.ID_OGRENCI,
			   k.AD+' '+k.SOYAD as ADSOYAD,
			   s.SubeNo as SUBENO,
			   s.AD as SUBEAD,
			   sn.ID_SINIF,
			   sn.AD as SINIF,
			   --isnull(Cast(rs.FOTOGRAF AS VARBINARY(MAX)),Cast('' AS VARBINARY(MAX))) as FOTOGRAF	,
			   @ID_KADEME3 as ID_KADEME3
			INTO #Y1
		  FROM OkyanusDB.dbo.v3Kullanici k
		INNER JOIN OkyanusDB.dbo.v3OgrenciTum o on o.TCKIMLIKNO=k.TCKIMLIKNO
		INNER JOIN v3SinifTum sn on sn.ID_SINIF=o.ID_SINIF
		INNER JOIN v3Donem dn on dn.ID_DONEM=o.ID_DONEM AND dn.KOD=@DONEM
		INNER JOIN v3Sube s   on s.ID_SUBE=o.ID_SUBE
		LEFT JOIN OkyanusDB.dbo.v3Resim rs on rs.TCKIMLIKNO=O.TCKIMLIKNO
		 WHERE o.TCKIMLIKNO=@TC_OGRENCI

		  
			SELECT DISTINCT d.ID_DERS, do.ID_SINIF, upper(d.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD
			INTO #Y2
			FROM EOKUL_V2.DBO.dersogretmen do
			JOIN OkyanusDB.dbo.v3kullanici  k	on k.TCKIMLIKNO=do.TC_OGRETMEN
			JOIN OkyanusDB.dbo.v3SinavDers d on d.ID_DERS=do.ID_DERS
			JOIN OkyanusDB.dbo.v3OgrenciTum o on o.ID_SINIF=do.ID_SINIF AND o.DONEM=do.DONEMKOD
			WHERE o.TCKIMLIKNO=@TC_OGRENCI
			AND do.DONEMKOD=@DONEM


			SELECT	D.DERSAD AS DERSAD
					,Y.ID_DERS 
					,Y.AD + ' :' AS  SINAVADI
					,Y.ID_YAZILI AS ID_SINAVRAPOR
					,O.ID_OGRENCI
					,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
					,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
					,y.YAZILITARIH
			INTO #Y3
			FROM Yazili Y
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND o.DONEM=@DONEM
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
			WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND Y.DONEM = @DONEM
				AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
			GROUP BY D.DERSAD 
					,Y.ID_DERS
					,Y.AD 
					,Y.ID_YAZILI 
					,O.ID_OGRENCI
					,Y.YARIYIL
					,YO.TELAFI
					,y.YAZILITARIH
			order by o.ID_OGRENCI, d.DERSAD, Y.YARIYIL, Y.ID_YAZILI
		END

			
			--JSON SEND
			IF (@ISLEM = 1)
			BEGIN
				select(
						select * from(
							select 
							(						 
								SELECT DISTINCT * FROM #T1
								FOR JSON AUTO
							) as t1
							,( 
								SELECT DISTINCT  * FROM #T2
								FOR JSON AUTO
							)as t2
							,(
								SELECT  DISTINCT * FROM #T3 
								order by BOLUMNO
								FOR JSON AUTO
							) as t3 
							,( 
								SELECT  DISTINCT
										 ID_SINAV
										,SINAVAD
										,DERSAD
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU		AS VARCHAR) END AS DOGRU
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS	AS VARCHAR) END AS YANLIS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS		AS VARCHAR) END AS BOS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET		AS VARCHAR) END AS NET
										,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
										,OLCEKSINAVI					
										,TD
										,TY
										,TB
										,TN
										--,SINIFSIRA
										--,OKULSIRA
										--,ILCESIRA
										--,ILSIRA
										--,GENELSIRA
										,ID_SINAVTURU
										,SINAVTARIH   
								from #T4
								order by SINAVTARIH,DERSAD
								FOR JSON AUTO
							)as t4
							,(
								SELECT DISTINCT * FROM #T5
								ORDER BY SINAVTARIH,ID_SINAV,PUANTURU
								FOR JSON AUTO
							) as t5 
							,(
								SELECT DISTINCT PUANTURU,ID_SINAVPUANTURU,ID_SINAVTURU FROM #T5
								ORDER BY PUANTURU
								FOR JSON AUTO
							) as t6,
							
							(						 
								SELECT DISTINCT  * FROM #Y1
								FOR JSON AUTO
							) as y1
							,( 
								SELECT DISTINCT * FROM #Y2
								FOR JSON AUTO
							)as y2
							,(
								SELECT DISTINCT   DERSAD,ID_DERS  FROM #Y3 
								order by DERSAD
								FOR JSON AUTO
							) as y3 
							,( 
								select DISTINCT * from #Y3
								order by DERSAD
								FOR JSON AUTO
							)as y4	
						) as tablo FOR JSON AUTO
					) as tt
				END
			IF (@ISLEM = 2)
			BEGIN
							 
								SELECT DISTINCT * FROM #T1
								
								SELECT DISTINCT * FROM #T2
								
								SELECT DISTINCT * FROM #T3 
								order by BOLUMNO

								SELECT  DISTINCT
										 ID_SINAV
										,SINAVAD
										,DERSAD
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU		AS VARCHAR) END AS DOGRU
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS	AS VARCHAR) END AS YANLIS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS		AS VARCHAR) END AS BOS
										,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET		AS VARCHAR) END AS NET
										,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
										,OLCEKSINAVI					
										,TD
										,TY
										,TB
										,TN
										--,SINIFSIRA
										--,OKULSIRA
										--,ILCESIRA
										--,ILSIRA
										--,GENELSIRA
										,ID_SINAVTURU
										,SINAVTARIH   
								from #T4
								order by SINAVTARIH,DERSAD

								SELECT DISTINCT * FROM #T5
								ORDER BY SINAVTARIH,ID_SINAV,PUANTURU

								SELECT DISTINCT PUANTURU,ID_SINAVPUANTURU,ID_SINAVTURU FROM #T5
								ORDER BY PUANTURU

								SELECT DISTINCT * FROM #Y1

								SELECT DISTINCT * FROM #Y2

								SELECT DISTINCT  DERSAD,ID_DERS  FROM #Y3 
								order by DERSAD

								SELECT DISTINCT * from #Y3
								order by DERSAD

		 END


			DROP TABLE IF EXISTS #SINAVOGRENCI
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #Y1
			DROP TABLE IF EXISTS #Y2
			DROP TABLE IF EXISTS #Y3
		END	
	
	END

	END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
						
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_AraKarneCoklu]...';


GO
ALTER procedure [dbo].[sp_AraKarneCoklu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@ID_SINAVTURU		varchar(100)	= NULL,
	@YAZILI_DONEM		varchar(100)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
		ISLEM				= @ISLEM		
		,TCKIMLIKNO			= @TCKIMLIKNO	
		,TC_OGRENCI			= @TC_OGRENCI	
		,OTURUM				= @OTURUM		
		,IL					= @IL			
		,ILCE				= @ILCE		
		,ID_MENU			= @ID_MENU	
		,DONEM				= @DONEM		
		,ID_KADEME3			= @ID_KADEME3	
		,ID_SINAV			= @ID_SINAV	
		,ID_DERS			= @ID_DERS	
		,ID_SUBE			= @ID_SUBE	
		,ID_SINIF			= @ID_SINIF	
		,DOSYAADI			= @DOSYAADI	
		,DOSYAGUID			= @DOSYAGUID	
		,ID_SINAVDOSYA		= @ID_SINAVDOSYA
		,ID_SINAVTURU		= @ID_SINAVTURU
		,YAZILI_DONEM		= @YAZILI_DONEM
		,SQLJSON			= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
 
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END


	IF @ID_LOG > 1
		BEGIN
			DECLARE @OV BIT = 0

			IF NOT EXISTS(SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
				BEGIN
					SET @OV = 1
				END

			IF (@ISLEM = 1 or @ISLEM = 2)	--	ARA KARNE DENEME SINAVLARI
				BEGIN
				--declare @ID_SINAVTURU INT=3,@DONEM varchar(4)='2017',@TC_OGRENCI varchar(11)='50764204008'

				DROP TABLE IF EXISTS #SINAVOGRENCI
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T3
				DROP TABLE IF EXISTS #T4
				DROP TABLE IF EXISTS #T5
				DROP TABLE IF EXISTS #Y1
				DROP TABLE IF EXISTS #Y2
				DROP TABLE IF EXISTS #Y3

				if @TC_OGRENCI is not null and @TC_OGRENCI <> ''
					BEGIN 
						SET @ID_SINIF = null
					END


				SELECT DISTINCT	 SO.ID_SINAV
						,SO.ID_SINAVDERS
						,SO.TCKIMLIKNO
						,SO.DOGRU
						,SO.YANLIS
						,SO.BOS
						,SO.NET
						,DERSAD		= D.TAKMAAD
						,SINAVAD	= S.AD
						,DERSPUAN	= SO.PUAN
						,S.ID_SINAVTURU
						,S.PUANGIZLE
						,S.SINAVTARIH
						,S.OLCEKSINAVI
						,GS.ID_KADEME
				INTO #SINAVOGRENCI
				FROM vw_SinavOgrenciBolum				SO
				JOIN Sinav								S	ON	S.ID_SINAV		= SO.ID_SINAV				
				JOIN SinavDers							D	ON	D.ID_SINAV		= SO.ID_SINAV
															AND D.ID_SINAVDERS	= SO.ID_SINAVDERS
				JOIN OkyanusDB.dbo.v3OgrenciTum			VO	ON	VO.TCKIMLIKNO	= SO.TCKIMLIKNO AND VO.DONEM = S.DONEM
				JOIN [dbo].[vw_SubeSinifGrupKademe]		GS	ON  GS.ID_SINIF			= VO.ID_SINIF
				WHERE	S.DONEM			= @DONEM  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND (@TC_OGRENCI is null or @TC_OGRENCI='' or SO.TCKIMLIKNO = @TC_OGRENCI)
					AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)
					AND (@ID_SINAVTURU is null or @ID_SINAVTURU='' or ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))


				SELECT	 SUBEAD	= ISNULL(SB.AD,'')
						,S.SINIF
						,ADSOYAD	= S.AD + ' ' + S.SOYAD
						,SO.TCKIMLIKNO 
						,ID_SINIF	= ISNULL(OT.ID_SINIF,0)
						,SV.ID_SINAVTURU
						,ID_KADEME
				INTO #T1
				FROM #SINAVOGRENCI						SO
				JOIN Sinav								SV	ON	SV.ID_SINAV				= SO.ID_SINAV
				JOIN SinavOgrenci						S	ON	S.TCKIMLIKNO			= SO.TCKIMLIKNO
															AND S.ID_SINAV				= SO.ID_SINAV
				LEFT JOIN OkyanusDB.dbo.V3Sube			SB	ON	CAST(SB.SUBENO AS INT)	= CAST(S.SUBENO AS INT)
				LEFT JOIN OkyanusDB.dbo.v3OgrenciTum	OT	ON	OT.TCKIMLIKNO			= S.TCKIMLIKNO
															AND OT.DONEM				= SV.DONEM

														
				--INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU,ID_KADEME)
				--SELECT TOP 1 SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1,ID_KADEME FROM #T1

				INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU,ID_KADEME)
				SELECT DISTINCT SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1,ID_KADEME FROM #T1
				WHERE (@ID_SINAVTURU is null or @ID_SINAVTURU='' or -1 in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))

			
				SELECT DISTINCT UPPER(D.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD,do.ID_SINIF
				INTO #T2
				FROM EOKUL_V2.DBO.dersogretmen	DO
				JOIN OkyanusDB.dbo.v3kullanici  K	ON	K.TCKIMLIKNO	= DO.TC_OGRETMEN
				JOIN OkyanusDB.dbo.v3SinavDers	D	ON	D.ID_DERS		= DO.ID_DERS
				JOIN OkyanusDB.dbo.v3OgrenciTum O	ON	O.ID_SINIF		= DO.ID_SINIF 
													AND O.DONEM			= DO.DONEMKOD
				where	(@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
					AND (@ID_SINIF is null or @ID_SINIF='' or o.ID_SINIF = @ID_SINIF)
					AND do.DONEMKOD=@DONEM


				SELECT	 SO.ID_SINAV
						,SO.ID_SINAVDERS
						,SO.TCKIMLIKNO					
						,OT.TD
						,OT.TY
						,OT.TB
						,OT.TN
						,SO.DERSAD
						,SO.ID_SINAVTURU
						,SO.SINAVAD
						,SO.SINAVTARIH   
						,SO.OLCEKSINAVI
						,SO.DOGRU
						,SO.YANLIS
						,SO.BOS
						,SO.NET
						,SO.DERSPUAN
				INTO #T4
				FROM #SINAVOGRENCI		SO
				JOIN SinavOgrenciToplam	OT	ON	OT.ID_SINAV		= SO.ID_SINAV 
											AND OT.TCKIMLIKNO	= SO.TCKIMLIKNO


				SELECT DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO, T4.TCKIMLIKNO
				INTO	#T3
				FROM	#T4			T4
				JOIN	SinavTuru	ST	ON	ST.ID_SINAVTURU	= T4.ID_SINAVTURU	
				JOIN	SinavDers	SD	ON	SD.TAKMAAD		= T4.DERSAD 
										AND SD.ID_SINAV		= T4.ID_SINAV
				GROUP BY DERSAD ,ST.ID_SINAVTURU,ST.AD,T4.TCKIMLIKNO


				SELECT	 SO.TCKIMLIKNO
						,SO.ID_SINAV				
						,PUANTURU	= UPPER(PT.AD) 
						,SO.SINAVAD	
						,SO.PUANGIZLE
						,SO.ID_SINAVTURU
						,SO.SINAVTARIH
						,ISNULL(P.PUAN				  ,0)	PUAN				 
						,ISNULL(P.ID_SINAVPUANTURU	  ,0)	ID_SINAVPUANTURU	 
						,ISNULL(P.GENELSIRA			  ,0)	GENELSIRA			 
						,ISNULL(P.ILSIRA			  ,0)	ILSIRA			 
						,ISNULL(P.ILCESIRA			  ,0)	ILCESIRA			 
						,ISNULL(P.OKULSIRA			  ,0)	OKULSIRA			 
						,ISNULL(P.SINIFSIRA			  ,0)	SINIFSIRA			 
						,GENELKATILIM	= OT.KATILIM_GENEL
						,ILKATILIM		= OT.KATILIM_IL
						,ILCEKATILIM	= OT.KATILIM_ILCE
						,SUBEKATILIM	= OT.KATILIM_OKUL
						,SINIFKATILIM	= OT.KATILIM_SINIF
				INTO #T5
				FROM #SINAVOGRENCI				SO
				JOIN SinavOgrenciToplam			OT	ON	OT.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND OT.ID_SINAV			= SO.ID_SINAV			
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV			
				LEFT JOIN vw_SinavOgrenciPuan	P	ON	P.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND P.ID_SINAV			= SO.ID_SINAV
				LEFT JOIN SinavPuanTuru			PT	ON	PT.ID_SINAVPUANTURU	= P.ID_SINAVPUANTURU
				JOIN OkyanusDB.dbo.v3OgrenciTum	O	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND O.DONEM				= S.DONEM
				WHERE	SO.PUANGIZLE = 0
					and (@TC_OGRENCI is null or @TC_OGRENCI='' or P.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF   is null or @ID_SINIF  ='' or O.ID_SINIF   = @ID_SINIF  )



	--------------------------------------------------------------------------------------
				/*
				--into puan
				SELECT 
						O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
						,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
						(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
						,ID_SINAVTURU,S.SINAVTARIH,GS.ID_KADEME
				INTO #PUAN
				FROM SinavOgrenci						O
				JOIN SinavOgrenciCevapBolum				B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				JOIN Sinav								S	ON	S.ID_SINAV			= O.ID_SINAV
				JOIN SinavDers							D	ON	D.ID_SINAV			= O.ID_SINAV	
															AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN OkyanusDB.dbo.v3OgrenciTum			VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				JOIN OkyanusDB.dbo.v3SinifTum			SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				JOIN [dbo].[vw_SubeSinifGrupKademe]		GS	ON  GS.ID_SINIF			= VO.ID_SINIF
				JOIN OkyanusDB.dbo.V3Sube				VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				JOIN SinavKitapcik						K	ON	K.ID_SINAV			= O.ID_SINAV
															AND	K.AD				= O.KITAPCIK
				JOIN OkyanusDB.dbo.v3Kullanici			VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				WHERE	S.DONEM			= @DONEM  
					and s.DURUM			= 2
					and s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					and (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)
					and (@ID_SINAVTURU is null or @ID_SINAVTURU='' or ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))
			
			
				--İNTO TT
				SELECT 
					t.ID_SINAVOGRENCI,t.TCKIMLIKNO,ID_SINAV
					,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				into #tt
				FROM #PUAN	t
				group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,ID_SINAV

			
				UPDATE T
				SET	 TD=D.TD
					,TY=D.TY
					,TB=D.TB
					,TN=D.TN
					,TS=D.TS
				FROM #tt T
				JOIN (
					SELECT T2.ID_SINAV,T2.TCKIMLIKNO,SUM(T2.TD) TD,SUM(T2.TY) TY,SUM(T2.TB) TB,SUM(T2.TN) TN,SUM(T2.TS) TS					
					FROM #tt T2
					GROUP BY T2.ID_SINAV,T2.TCKIMLIKNO,T2.ID_SINAV
				) AS D ON D.TCKIMLIKNO=T.TCKIMLIKNO AND T.ID_SINAV = D.ID_SINAV

				-- into tt1
				select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				into #tt1 
				from #tt t
				join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL
				--order by 1
			
			
				-- SORGULAR
			
				-- öğrenci
				SELECT DISTINCT SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO ,ID_SINIF,ID_SINAVTURU, ID_KADEME
				INTO #T1
				FROM #PUAN 

				INSERT INTO #T1 (SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,ID_SINAVTURU,ID_KADEME)
				SELECT DISTINCT SUBEAD,SINIF,ADSOYAD,TCKIMLIKNO,ID_SINIF,-1,ID_KADEME FROM #T1
				WHERE (@ID_SINAVTURU is null or @ID_SINAVTURU='' or -1 in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)))

				-- öğretmen
				SELECT distinct upper(d.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD,do.ID_SINIF
				INTO #T2
				FROM EOKUL_V2.DBO.dersogretmen do
				join v3kullanici  k	on k.TCKIMLIKNO=do.TC_OGRETMEN
				join OkyanusDB.dbo.v3SinavDers d on d.ID_DERS=do.ID_DERS
				join OkyanusDB.dbo.v3OgrenciTum o on o.ID_SINIF=do.ID_SINIF AND o.DONEM=do.DONEMKOD
				where (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF is null or @ID_SINIF='' or o.ID_SINIF = @ID_SINIF)
				and do.DONEMKOD=@DONEM
						
				--ders dybn
				SELECT distinct P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
						,TD,TY,TB,TN
						,ID_SINAVTURU,p.SINAVTARIH
				INTO #T4
				FROM #PUAN				P						
				left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--WHERE p.TCKIMLIKNO	=@TC_OGRENCI
				group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
						,TD,TY,TB,TN
						,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH
				--order by p.SINAVTARIH

			
				-- dersler sorgu
				SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				INTO	#T3
				FROM	#T4			T4
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--ORDER BY SD.BOLUMNO


				SELECT DISTINCT ID_SINAV INTO #SINAVLAR FROM #PUAN

				SELECT  SUM(1) KATILIM,
						SOS.ID_SINAVPUANTURU,
						SOS.PUAN,
						S.ID_SINAV,		
						SO.TCKIMLIKNO,
						VO.ID_SINIF,
						VO.ID_SUBE,
						SB.ILCE,
						SB.IL
				INTO	#KATILIM
				FROM	#SINAVLAR					P
				JOIN	Sinav					S	ON	P.ID_SINAV=S.ID_SINAV
				join	SinavOgrenci			SO	ON	SO.ID_SINAV		= S.ID_SINAV
				left JOIN	SinavOgrenciSonuc		SOS	ON	SOS.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= SO.TCKIMLIKNO AND VO.DONEM = S.DONEM
				JOIN	OkyanusDB.DBO.v3Sube	SB	ON	SB.ID_SUBE		= VO.ID_SUBE
				GROUP BY S.ID_SINAV,SO.TCKIMLIKNO,VO.ID_SINIF,VO.ID_SUBE,SB.ILCE,SB.IL,SOS.ID_SINAVPUANTURU,SOS.PUAN
			
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'GENEL',DEGER = 'GENEL'
				INTO #GENEL
				FROM #KATILIM	
				GROUP BY ID_SINAV,ID_SINAVPUANTURU
				UNION ALL 
				SELECT	COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'IL',DEGER= IL
				FROM #KATILIM	
				GROUP BY ID_SINAV,IL,ID_SINAVPUANTURU
				UNION ALL 
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'ILCE',DEGER= ILCE
				FROM #KATILIM	
				GROUP BY ID_SINAV,ILCE,ID_SINAVPUANTURU
				UNION ALL 
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'OKUL',DEGER= CAST(ID_SUBE AS VARCHAR)
				FROM #KATILIM	
				GROUP BY ID_SINAV,ID_SUBE,ID_SINAVPUANTURU
				UNION ALL 
				SELECT COUNT(TCKIMLIKNO) KATILIM,ID_SINAV,ID_SINAVPUANTURU,[ISLEM] = 'SINIF',DEGER= CAST(ID_SINIF AS VARCHAR)
				FROM #KATILIM	
				GROUP BY ID_SINAV,ID_SINIF,ID_SINAVPUANTURU

				SELECT K.* 
					,SINIFKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.ID_SINIF	AND G.ISLEM='SINIF'	)
					,SUBEKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.ID_SUBE		AND G.ISLEM='OKUL'	)
					,ILCEKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.ILCE		AND G.ISLEM='ILCE'	)
					,ILKATILIM		= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER=K.IL			AND G.ISLEM='IL'	)
					,GENELKATILIM	= (SELECT G.KATILIM FROM #GENEL G WHERE G.ID_SINAV=K.ID_SINAV AND ((G.ID_SINAVPUANTURU IS NULL AND K.ID_SINAVPUANTURU IS NULL) OR G.ID_SINAVPUANTURU=K.ID_SINAVPUANTURU) AND G.DEGER='GENEL'		AND G.ISLEM='GENEL'	)
				INTO #PUANLAMA
				FROM #KATILIM K	

				--puan
				SELECT DISTINCT P.TCKIMLIKNO,P.ID_SINAV,SINAVAD,PUANGIZLE,OS.PUAN,PT.AD PUANTURU,OS.ID_SINAVPUANTURU,P.ID_SINAVTURU,p.SINAVTARIH
						,PP.SINIFKATILIM
						,PP.SUBEKATILIM
						,PP.ILCEKATILIM
						,PP.ILKATILIM
						,PP.GENELKATILIM 	
						,OS.SINIFSIRA
						,OS.OKULSIRA
						,OS.ILCESIRA
						,OS.ILSIRA
						,OS.GENELSIRA		
				INTO #T5
				FROM		#PUAN				P						
				left JOIN	SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				left JOIN	SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= OS.ID_SINAVPUANTURU
				left JOIN	#PUANLAMA			PP	ON	PP.TCKIMLIKNO		= P.TCKIMLIKNO
													AND PP.ID_SINAV			= P.ID_SINAV												
													AND ((PP.ID_SINAVPUANTURU is null and PT.ID_SINAVPUANTURU is null) or PP.ID_SINAVPUANTURU = PT.ID_SINAVPUANTURU)
				WHERE P.PUANGIZLE=0
					and (@TC_OGRENCI is null or @TC_OGRENCI='' or P.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF   is null or @ID_SINIF  ='' or P.ID_SINIF   = @ID_SINIF  )
			
				DROP TABLE #GENEL
				DROP TABLE #KATILIM

				*/
				---------------------------------------------------------------------
				-- YAZILI

				Select DISTINCT k.TCKIMLIKNO,
					o.ID_OGRENCI,
					k.AD+' '+k.SOYAD as ADSOYAD,
					s.SubeNo as SUBENO,
					s.AD as SUBEAD,
					sn.ID_SINIF,
					sn.AD as SINIF,
					isnull(Cast(rs.FOTOGRAF AS VARBINARY(MAX)),Cast('' AS VARBINARY(MAX))) as FOTOGRAF,
					GS.ID_KADEME	   
				INTO #Y1
				from OkyanusDB.dbo.v3Kullanici k
				inner join OkyanusDB.dbo.v3OgrenciTum o on o.TCKIMLIKNO=k.TCKIMLIKNO
				inner join v3Donem dn on dn.ID_DONEM=o.ID_DONEM and dn.KOD=@DONEM
				inner join v3Sube s   on s.ID_SUBE=o.ID_SUBE
				inner join v3SinifTum sn on sn.ID_SINIF=o.ID_SINIF
				JOIN [dbo].[vw_SubeSinifGrupKademe]	 GS	ON  GS.ID_SINIF			= O.ID_SINIF
				left join OkyanusDB.dbo.v3Resim rs on rs.TCKIMLIKNO=O.TCKIMLIKNO
				where (@TC_OGRENCI is null or @TC_OGRENCI='' or O.TCKIMLIKNO = @TC_OGRENCI)
						and (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)

			-- select * from EOKUL_V2.DBO.Resim where CZKIMLIKNO='19057128520'
		  
				SELECT distinct d.ID_DERS, do.ID_SINIF, upper(d.AD) DERSAD,k.TCKIMLIKNO,k.AD+' '+SOYAD ADSOYAD
				INTO #Y2
				FROM EOKUL_V2.DBO.dersogretmen do
				join OkyanusDB.dbo.v3kullanici  k	on k.TCKIMLIKNO=do.TC_OGRETMEN
				join OkyanusDB.dbo.v3SinavDers d on d.ID_DERS=do.ID_DERS
				join OkyanusDB.dbo.v3OgrenciTum o on o.ID_SINIF=do.ID_SINIF AND o.DONEM=do.DONEMKOD
				where (@TC_OGRENCI is null or @TC_OGRENCI='' or O.TCKIMLIKNO = @TC_OGRENCI)
					and (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				and do.DONEMKOD=@DONEM



									 SELECT DISTINCT	YO.TCKIMLIKNO
											,D.DERSAD AS DERSAD
											,Y.ID_DERS 
											,Y.AD + ' :' AS  SINAVADI
											,Y.ID_YAZILI AS ID_SINAVRAPOR
											,O.ID_OGRENCI
											,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
											,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
									INTO #Y3
									FROM Yazili Y
									INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
									INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
									INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
									INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
									WHERE	Y.AKTIF = 1 
										AND YO.AKTIF = 1 
										AND Y.DONEM = @DONEM
										AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
										AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
										AND (@YAZILI_DONEM is null or @YAZILI_DONEM='' or Y.YARIYIL in (SELECT SUBSTRING(Value, 1, 1) FROM OPENJSON(@YAZILI_DONEM)))
										AND (Y.OVGORSUN = 1 OR @OV = 0)
										AND Y.ID_YAZILITURU = 1
										AND Y.KARNEDEGORUNSUN = 1
									GROUP BY YO.TCKIMLIKNO 
											,D.DERSAD 
											,Y.ID_DERS
											,Y.AD 
											,Y.ID_YAZILI 
											,O.ID_OGRENCI
											,Y.YARIYIL
											,YO.TELAFI


							 
									SELECT DISTINCT * FROM #T1
								
									SELECT DISTINCT * FROM #T2
								
									SELECT DISTINCT * FROM #T3 
									order by BOLUMNO

									select  DISTINCT
											TCKIMLIKNO
											,ID_SINAV
											,SINAVAD
											,DERSAD
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
											,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
											,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
											,OLCEKSINAVI					
											,TD
											,TY
											,TB
											,TN
											,ID_SINAVTURU
											,SINAVTARIH   
									from #T4
									order by SINAVTARIH,DERSAD

									SELECT DISTINCT	t.TCKIMLIKNO
											,t.ID_SINAV
											,SINAVAD
											,PUANGIZLE
											,PUAN
											,PUANTURU
											,t.ID_SINAVPUANTURU
											,ID_SINAVTURU
											,SINAVTARIH
											,SINIFSIRA
											,OKULSIRA
											,ILCESIRA
											,ILSIRA
											,GENELSIRA
											,t.SINIFKATILIM
											,t.SUBEKATILIM
											,t.ILCEKATILIM
											,t.ILKATILIM
											,t.GENELKATILIM  
									FROM #T5 t
									ORDER BY SINAVTARIH,t.ID_SINAV,PUANTURU

									SELECT DISTINCT PUANTURU,ID_SINAVPUANTURU,ID_SINAVTURU FROM #T5
									ORDER BY PUANTURU
									SELECT * FROM #Y1

									SELECT DISTINCT * FROM #Y2

									SELECT DISTINCT  DERSAD,ID_DERS  FROM #Y3 
									order by DERSAD

									select DISTINCT * from #Y3
									order by ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

			
				DROP TABLE IF EXISTS #SINAVOGRENCI
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T3
				DROP TABLE IF EXISTS #T4
				DROP TABLE IF EXISTS #T5
				DROP TABLE IF EXISTS #Y1
				DROP TABLE IF EXISTS #Y2
				DROP TABLE IF EXISTS #Y3

			END	
		END

	END TRY

	BEGIN CATCH
	 DECLARE @_ErrorSeverity INT;
	 DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_BurslulukOgrenciIslemleri]...';


GO
ALTER procedure [dbo].[sp_BurslulukOgrenciIslemleri]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_BURSLULUKDOSYA	INT				= NULL,
	@ID_BURSOGRENCI		INT				= NULL,
	@RAPORGENEL			BIT				= NULL,
	@DOSYAADI			VARCHAR(50)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@ID_SINAVs			NVARCHAR(MAX)	= NULL,
	@displayLength		INT				= 0,
	@displayStart		INT				= 0,
	@whereClause		VARCHAR(MAX)	='',
	@orderByClause		VARCHAR(MAX)	='',
	@SQLJSON			NVARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT			
				ISLEM				 =@ISLEM				
				,TCKIMLIKNO			 =@TCKIMLIKNO			
				,OTURUM				 =@OTURUM				
				,ID_MENU			 =@ID_MENU			
				,ID_BURSLULUKDOSYA	 =@ID_BURSLULUKDOSYA	
				,ID_BURSOGRENCI		 =@ID_BURSOGRENCI		
				,RAPORGENEL			 =@RAPORGENEL			
				,DOSYAADI			 =@DOSYAADI			
				,DONEM				 =@DONEM				
				,ID_SINAVs			 =@ID_SINAVs			
				,displayLength		 =@displayLength		
				,displayStart		 =@displayStart		
				,whereClause		 =@whereClause		
				,orderByClause		 =@orderByClause		
				,SQLJSON			 =@SQLJSON							
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	EXCEL OGRENCI KAYDETME	
		BEGIN

			DECLARE @ID_TABLE TABLE ( ID INT )			
			
			INSERT INTO BurslulukDosya (AD, DONEM)
			OUTPUT INSERTED.ID_BURSLULUKDOSYA INTO @ID_TABLE(ID)
			VALUES (@DOSYAADI, (SELECT TOP 1 DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1))

			SET @ID_BURSLULUKDOSYA = (SELECT TOP 1 ID FROM @ID_TABLE)

			INSERT INTO BurslulukSinavOgrenci (
				 TCKIMLIKNO		
				,OGRENCI_ADSOYAD
				,OKULADI		
				,SINIFDUZEYI
				,SUBEAD
				,VELI_ADSOYAD	
				,MAIL			
				,TELEFON_EV		
				,TELEFON_CEP	
				,BASVURUTARIH	
				,SINAVTARIH		
				,SEANS
				,ID_KADEME3
				,ID_SUBE
				,ID_SINAV
				,ID_BURSLULUKDOSYA
			)
			SELECT 
				 TCKIMLIKNO			= J.TCKIMLIKNO		
				,OGRENCI_ADSOYAD	= J.OGRENCI_ADSOYAD
				,OKULADI			= J.OKULADI		
				,SINIFDUZEYI		= J.SINIFDUZEYI
				,SUBEAD				= J.SUBEAD
				,VELI_ADSOYAD		= J.VELI_ADSOYAD	
				,MAIL				= J.MAIL			
				,TELEFON_EV			= J.TELEFON_EV		
				,TELEFON_CEP		= J.TELEFON_CEP	
				,BASVURUTARIH		= CAST(J.BASVURUTARIH AS date) 
				,SINAVTARIH			= CAST(J.SINAVTARIH	AS date) 
				,SEANS				= J.SEANS
				,ID_KADEME3			= K3.ID_KADEME3
				,ID_SUBE			= ISNULL(SB.ID_SUBE,0)
				,ID_SINAV			= ISNULL(S.ID_SINAV,0)
				,ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
			FROM OPENJSON(@SQLJSON)
			WITH(
				 TCKIMLIKNO			VARCHAR(MAX)
				,OGRENCI_ADSOYAD	VARCHAR(MAX)
				,OKULADI			VARCHAR(MAX)
				,SINIFDUZEYI		VARCHAR(MAX)
				,SUBEAD            	VARCHAR(MAX)
				,VELI_ADSOYAD		VARCHAR(MAX)
				,MAIL				VARCHAR(MAX)
				,TELEFON_EV			VARCHAR(MAX)
				,TELEFON_CEP		VARCHAR(MAX)
				,BASVURUTARIH		VARCHAR(MAX)
				,SINAVTARIH			VARCHAR(MAX)
				,SEANS				VARCHAR(MAX)
			) AS J
			LEFT JOIN v3Sube	SB	ON  SB.AD  = REPLACE( J.SUBEAD, 'Okyanus Koleji-', '')
			LEFT JOIN v3Kademe3	K3	ON	SUBSTRING( K3.AD, 0, CHARINDEX('.', K3.AD, 0))	= SUBSTRING( SINIFDUZEYI, 0, CHARINDEX('.', SINIFDUZEYI, 0))
			LEFT JOIN Sinav		S	ON	S.ID_SINAV IN (SELECT VALUE FROM OPENJSON (@ID_SINAVs))
									AND S.ID_KADEME3	= K3.ID_KADEME3
			WHERE J.TCKIMLIKNO != ''
			
			SELECT @ID_BURSLULUKDOSYA


		END

		IF @ISLEM = 2	--	OGRENCI LISTE			
		BEGIN
			SELECT TCKIMLIKNO
			INTO #OGRLIST
			FROM BurslulukSinavOgrenci
			WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA
			GROUP BY TCKIMLIKNO
			HAVING COUNT(1)>1
			
			SELECT 
				 BO.TCKIMLIKNO
				,BO.OGRENCI_ADSOYAD	
				,BO.SINIFDUZEYI		
				,BO.SUBEAD			
				,BO.SEANS			
				,ISLEM = '
							<button type="button" class="btn yellow" onclick="funcOgrenciDuzenleModalAc('+CAST(BO.ID_BURSOGRENCI AS VARCHAR)+')">Düzenle</button>
							<button type="button" class="btn red   " onclick="funcBurslulukOgrenciSil('  +CAST(BO.ID_BURSOGRENCI AS VARCHAR)+')">Sil</button>
						'
				,TCKIMLIKNOHTML		= '<div '+ 
										CASE WHEN OL.TCKIMLIKNO IS NOT NULL THEN 'style="color:red"' ELSE '' END 
									  +'>'+BO.TCKIMLIKNO+'</div>'
				,BO.OKULADI			
				,BO.ID_BURSOGRENCI
				,BO.VELI_ADSOYAD	
				,BO.MAIL			
				,BO.TELEFON_EV		
				,BO.TELEFON_CEP		
				,BO.BASVURUTARIH	
				,BO.SINAVTARIH		
				,BO.ID_KADEME3		
				,BO.ID_SUBE			
				,TCVAR = CASE WHEN OL.TCKIMLIKNO IS NOT NULL THEN 1 ELSE 0 END 
			INTO #TEMPx
			FROM BurslulukSinavOgrenci	BO
			LEFT JOIN #OGRLIST			OL	ON	OL.TCKIMLIKNO	= BO.TCKIMLIKNO
			WHERE ID_BURSLULUKDOSYA		= @ID_BURSLULUKDOSYA


			--SELECT ISNULL((
			--	SELECT 
			--	 BO.ID_BURSOGRENCI
			--	,BO.TCKIMLIKNO		
			--	,BO.OGRENCI_ADSOYAD	
			--	,BO.OKULADI			
			--	,BO.SINIFDUZEYI		
			--	,BO.SUBEAD			
			--	,BO.VELI_ADSOYAD	
			--	,BO.MAIL			
			--	,BO.TELEFON_EV		
			--	,BO.TELEFON_CEP		
			--	,BO.BASVURUTARIH	
			--	,BO.SINAVTARIH		
			--	,BO.SEANS			
			--	,BO.ID_KADEME3		
			--	,BO.ID_SUBE			
			--	,TCVAR = CASE WHEN OL.TCKIMLIKNO IS NOT NULL THEN 1 ELSE 0 END 

			--	FROM BurslulukSinavOgrenci	BO
			--	LEFT JOIN #OGRLIST			OL	ON	OL.TCKIMLIKNO	= BO.TCKIMLIKNO
			--	WHERE ID_BURSLULUKDOSYA		= @ID_BURSLULUKDOSYA
			--	FOR JSON PATH
			--),'') AS OGRENCILISTE

			DROP TABLE IF EXISTS #OGRLIST


			
				DECLARE @COLUMNNAME VARCHAR(MAX) = (SELECT name FROM tempdb.sys.columns where object_id = object_id('tempdb..#TEMPx')  AND column_id = (SELECT JSON_Value (value, '$.column') FROM OPENJSON(@SQLJSON,'$.order')))
				SET @orderByClause = (SELECT ' ORDER BY TCVAR desc, CASE WHEN TCVAR = 1 THEN TCKIMLIKNO END ,'+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
				SET @whereClause = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				SET @displayStart = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT))
				SET @displayLength = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				--IF	@whereClause=''
				--BEGIN
				--	SET @whereClause='where ID_BURSLULUKDOSYA='''+@ID_BURSLULUKDOSYA+''''
				--END
				--ELSE
				BEGIN
					DECLARE @COLUMNS VARCHAR(max) = ''					
					SET @COLUMNS='('+(SELECT ' ' + name + ' LIKE ''%' + @whereClause + '%'' OR' AS [text()] FROM tempdb.sys.columns WHERE object_id = object_id('tempdb..#TEMPx')
					For XML PATH (''))+')'
					SET @COLUMNS = SUBSTRING(@COLUMNS,1,LEN(@COLUMNS)-3)+') '
					SET @whereClause='WHERE '+@COLUMNS
					--SET @whereClause=@whereClause+' and ID_BURSLULUKDOSYA='''+@ID_BURSLULUKDOSYA+''''
				END
				Declare @query varchar(MAX)
				set @query='
							SELECT * INTO #TEMP FROM   
									(
										SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * FROM(
											SELECT
											*  FROM #TEMPx
											'+@whereClause+'
										) 
									RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))
									+ '
									ORDER BY RowNumber
									FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM #TEMPx) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'
				execute (@query)
				
							DROP TABLE #TEMPx

		END

		IF @ISLEM = 3	--	OGRENCI DUZENLE			
		BEGIN

			UPDATE BO SET			
				 BO.TCKIMLIKNO		= J.TCKIMLIKNO		
				,BO.OGRENCI_ADSOYAD	= J.OGRENCI_ADSOYAD
				,BO.OKULADI			= J.OKULADI		
				,BO.SINIFDUZEYI		= J.SINIFDUZEYI
				,BO.SUBEAD			= J.SUBEAD
				,BO.VELI_ADSOYAD	= J.VELI_ADSOYAD	
				,BO.MAIL			= J.MAIL			
				,BO.TELEFON_EV		= J.TELEFON_EV		
				,BO.TELEFON_CEP		= J.TELEFON_CEP	
				,BO.BASVURUTARIH	= CAST(J.BASVURUTARIH AS date) 
				,BO.SINAVTARIH		= CAST(J.SINAVTARIH	AS date) 
				,BO.SEANS			= J.SEANS
				,BO.ID_KADEME3		= K3.ID_KADEME3
				,BO.ID_SUBE			= ISNULL(SB.ID_SUBE,0)
				,BO.ID_SINAV		= ISNULL(S.ID_SINAV,0)
			FROM OPENJSON(@SQLJSON)
			WITH(
				 ID_BURSOGRENCI		INT
				,TCKIMLIKNO			VARCHAR(MAX)
				,OGRENCI_ADSOYAD	VARCHAR(MAX)
				,OKULADI			VARCHAR(MAX)
				,SINIFDUZEYI		VARCHAR(MAX)
				,SUBEAD            	VARCHAR(MAX)
				,VELI_ADSOYAD		VARCHAR(MAX)
				,MAIL				VARCHAR(MAX)
				,TELEFON_EV			VARCHAR(MAX)
				,TELEFON_CEP		VARCHAR(MAX)
				,BASVURUTARIH		VARCHAR(MAX)
				,SINAVTARIH			VARCHAR(MAX)
				,SEANS				VARCHAR(MAX)
			) AS J
			JOIN BurslulukSinavOgrenci		BO	ON	BO.ID_BURSOGRENCI	= J.ID_BURSOGRENCI
			LEFT JOIN v3Sube				SB	ON  SB.AD  = REPLACE( J.SUBEAD, 'Okyanus Koleji-', '')
			LEFT JOIN v3Kademe3				K3	ON	SUBSTRING( K3.AD, 0, CHARINDEX('.', K3.AD, 0))	= SUBSTRING( J.SINIFDUZEYI, 0, CHARINDEX('.', J.SINIFDUZEYI, 0))			
			LEFT JOIN Sinav					S	ON	S.ID_SINAV	= (SELECT TOP 1 ID_SINAV FROM BurslulukSinavOgrenci	BO2	WHERE BO2.ID_BURSLULUKDOSYA	= BO.ID_BURSLULUKDOSYA AND BO2.ID_KADEME3 = K3.ID_KADEME3)
			SELECT 1 

		END

		IF @ISLEM = 4	--	OGRENCI SIL				
		BEGIN
			DELETE FROM BurslulukSinavOgrenci WHERE ID_BURSOGRENCI = @ID_BURSOGRENCI
			SELECT @ID_BURSOGRENCI
		END

		IF @ISLEM = 5	--	OGRENCI LISTESI RAPOR	
		BEGIN

			SELECT 
				 BO.ID_BURSOGRENCI
				,BO.TCKIMLIKNO		
				,BO.OGRENCI_ADSOYAD	
				,BO.OKULADI			
				,BO.SINIFDUZEYI		
				,BO.SUBEAD			
				,BO.VELI_ADSOYAD	
				,BO.MAIL			
				,BO.TELEFON_EV		
				,BO.TELEFON_CEP		
				,CONVERT(VARCHAR, BO.BASVURUTARIH,104)BASVURUTARIH
				,CONVERT(VARCHAR, BO.SINAVTARIH	 ,104)SINAVTARIH
				,BO.SEANS			
			FROM BurslulukSinavOgrenci	BO
			WHERE ID_BURSLULUKDOSYA		= @ID_BURSLULUKDOSYA

		END

		IF @ISLEM = 6	--	BURSLULUK SINAV LISTE	
		BEGIN
			SELECT(
				SELECT S.AD, S.ID_SINAV, S.ID_KADEME3
				FROM Sinav S
				WHERE	S.ID_SINAVTURU	= 12
					AND S.DONEM			= @DONEM
					AND S.AKTIF			= 1
					AND S.ID_SINAV	NOT IN (SELECT DISTINCT BS.ID_SINAV FROM BurslulukSinavOgrenci BS)
				FOR JSON AUTO
			) AS J
		END
		
		IF @ISLEM = 7	--	BURSLULUK DOSYA SİL		
		BEGIN
			
			DELETE FROM BurslulukDosya
			WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA
						
			DELETE FROM BurslulukSinavOgrenci
			WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA

			SELECT 1

		END

		IF @ISLEM = 8	--	KATILIM RAPORU			
		BEGIN
			DECLARE  @xID_BURSLULUKDOSYA	INT = @ID_BURSLULUKDOSYA
					,@xRAPORGENEL			BIT = @RAPORGENEL
			DECLARE  @GENEL					INT = 9999

			DROP TABLE IF EXISTS #KATILIMSAYISI
			DROP TABLE IF EXISTS #KATILIMYUZDESI
		
			SELECT ID_KADEME3	= BSO.ID_KADEME3
				,ID_SUBE		= BSO.ID_SUBE
				,SINAVGUN		= CASE WHEN @xRAPORGENEL = 0 THEN DATENAME(dw, BSO.SINAVTARIH)	ELSE NULL END	
				,SINAVTARIH		= CASE WHEN @xRAPORGENEL = 0 THEN BSO.SINAVTARIH					ELSE NULL END
				,SEANS			= CASE WHEN @xRAPORGENEL = 0 THEN BSO.SEANS						ELSE NULL END
				,BASVURAN_OGRSAY= COUNT(DISTINCT BSO.TCKIMLIKNO)	
				,KATILAN_OGRSAY	= COUNT(DISTINCT SOP.TCKIMLIKNO)	
			INTO #KATILIMSAYISI
			FROM BurslulukSinavOgrenci	BSO
			LEFT JOIN SinavOgrenciPuan	SOP	ON	SOP.TCKIMLIKNO	= BSO.TCKIMLIKNO
											AND SOP.ID_SINAV	= BSO.ID_SINAV
			WHERE BSO.ID_BURSLULUKDOSYA = @xID_BURSLULUKDOSYA 
			GROUP BY BSO.ID_KADEME3, BSO.ID_SUBE, CASE WHEN @xRAPORGENEL = 0 THEN BSO.SINAVTARIH END, CASE WHEN @xRAPORGENEL = 0 THEN BSO.SEANS END,CASE WHEN @xRAPORGENEL = 0 THEN DATENAME(dw, BSO.SINAVTARIH ) END

			INSERT INTO #KATILIMSAYISI (ID_KADEME3, ID_SUBE, SINAVGUN, SINAVTARIH, SEANS, BASVURAN_OGRSAY, KATILAN_OGRSAY)
			SELECT @GENEL, ID_SUBE, SINAVGUN, SINAVTARIH, SEANS, SUM(BASVURAN_OGRSAY), SUM(KATILAN_OGRSAY)
			FROM #KATILIMSAYISI
			GROUP BY ID_SUBE, SINAVGUN, SINAVTARIH, SEANS


			INSERT INTO #KATILIMSAYISI (ID_KADEME3, ID_SUBE, SINAVGUN, SINAVTARIH, SEANS, BASVURAN_OGRSAY, KATILAN_OGRSAY)
			SELECT ID_KADEME3
				,@GENEL
				,SINAVGUN
				,SINAVTARIH
				,SEANS
				,BASVURAN_OGRSAY	= SUM(BASVURAN_OGRSAY)
				,KATILAN_OGRSAY		= SUM(KATILAN_OGRSAY)
			FROM #KATILIMSAYISI
			GROUP BY ID_KADEME3, SINAVGUN, SINAVTARIH, SEANS


			SELECT ID_SUBE
				,SINAVGUN
				,SINAVTARIH
				,SEANS
				,KATILIMYUZDESI	= CAST( CAST(CAST(KATILAN_OGRSAY AS decimal(8,2))/NULLIF(CAST(BASVURAN_OGRSAY AS decimal(8,2)),0)*100.0  AS decimal(8,2)) AS VARCHAR)
			INTO #KATILIMYUZDESI
			FROM #KATILIMSAYISI
			WHERE ID_KADEME3 = @GENEL

			--		SORGULAR
			BEGIN
				SELECT * 
				FROM #KATILIMSAYISI
				ORDER BY ID_SUBE, ID_KADEME3

				SELECT *
				FROM #KATILIMYUZDESI
				ORDER BY ID_SUBE


				SELECT DISTINCT SB.ID_SUBE, SB.AD AS SUBEAD
				FROM #KATILIMSAYISI	KS
				JOIN v3Sube			SB	ON	SB.ID_SUBE	= KS.ID_SUBE


				SELECT DISTINCT K3.ID_KADEME3, K3.AD KADEMEAD
				FROM #KATILIMSAYISI	KS
				JOIN v3Kademe3		K3	ON	K3.ID_KADEME3	= KS.ID_KADEME3 
			UNION 
				SELECT @GENEL,'GENEL'
				
								
				SELECT DISTINCT CONVERT(varchar,SINAVTARIH,104) SINAVTARIH,SINAVGUN,SEANS
				FROM #KATILIMSAYISI

			END
		
			DROP TABLE IF EXISTS #KATILIMSAYISI
			DROP TABLE IF EXISTS #KATILIMYUZDESI

		END
		
		IF @ISLEM = 9	--	BURSLULUK TARIH SEANS	
		BEGIN
			
			SELECT ISNULL((
				SELECT DISTINCT CONVERT(VARCHAR, O.SINAVTARIH ,104 ) SINAVTARIH, O.SEANS
				FROM BurslulukSinavOgrenci O
				WHERE ID_BURSLULUKDOSYA = @ID_BURSLULUKDOSYA
				FOR JSON AUTO
			),'[]') AS S

		END

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_CevapAnahtariDuzenle]...';


GO
ALTER procedure [dbo].[sp_CevapAnahtariDuzenle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	  
			ISLEM				 = @ISLEM		
			,TCKIMLIKNO			 = @TCKIMLIKNO	
			,OTURUM				 = @OTURUM		
			,TC_YETKI			 = @TC_YETKI	
			,DERSLIST			 = @DERSLIST	
			,ID_MENU			 = @ID_MENU	
			,ID_SINAV			 = @ID_SINAV	
			,SQLJSON			 = @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	SINAV BİLGİ GETİR (DERS PROGRAMINDAKİ DERSLER + CEVAPANAHTARIKULLANICIYETKI DERSLER)
			BEGIN
				DECLARE @ID_SINAVKITAPCIKX INT = (select  top 1  ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD='A')

				SELECT DISTINCT D.DERSAD AS DERSAD   
				INTO #DERSLIST
				FROM OKYANUSDB.[dbo].[v3DersProgram]	DP
				JOIN eokul_v2.dbo.Ders					D	ON	D.ID_DERS=DP.ID_DERS
				WHERE TCKIMLIKNO=@TCKIMLIKNO
			UNION 
				SELECT DISTINCT DERSAD 
				FROM CevapAnahtariKullaniciYetki 
				WHERE TCKIMLIKNO=@TCKIMLIKNO
			
			IF EXISTS (SELECT TOP 1 1 FROM v3SubeYetki WHERE TCKIMLIKNO=@TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VE ÖLÇME DEĞERLENDİRME KULLANICILARI
			BEGIN
				INSERT INTO #DERSLIST (DERSAD)
				SELECT DISTINCT D.AD AS DERSAD   				
				FROM SinavDers			SD
				JOIN v3SinavDers		D	ON	D.ID_DERS=SD.ID_DERS
				WHERE	SD.ID_SINAV = @ID_SINAV
					AND D.AD NOT IN (SELECT DERSAD FROM #DERSLIST)
			END

				Select (
					Select 
						ID_SINAVTURU, 
						s.AD as AD, 
						(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) as KITAPCIKSAYISI, 
						s.KOD, 
						S.ID_KADEME3, 
						Convert(varchar, SINAVTARIH, 103) as SINAVTARIH,
						OZEL,
						FREKANSHESAPLA,
						PUANGIZLE,
						YUKLEMEKAPAT,
						YANLISSAYISI,
						OLCEKSINAVI,
						JSONDERS.ID_DERS as id,
						JSONDERS.ID_SINAVDERS as id_sinavders,
						JSONDERS.TAKMAAD as text,
						(select count(1)/(select count(1) from SinavKitapcik where ID_SINAV=@ID_SINAV) from SinavAnahtar sa where ID_SINAVDERS=JSONDERS.ID_SINAVDERS) as SORUSAYISI,
						JSONDERS.BOLUMNO as SIRA,
						SORULIST.SORUNO_A as SORUNO,
						SORULIST.ID_SINAVSORUTURU as SORUTURU,
						SORULIST.CEVAP as ACEVAP,
						SORULIST.KOD,
						UNITE = ISNULL(SD.AD, ''), 
						SORULIST.OPTIKKARAKTERSAYISI as KARAKTERSAYISI,
						SORULIST.KATSAYI,
						ISNULL(SORULIST.ID_BILGI, 0) AS ID_BILGI,
						ISNULL(SORULIST.ID_BILISSELSUREC, 0) AS ID_BILISSELSUREC,
						(select (select AD from SinavKitapcik where ID_SINAVKITAPCIK=ssa.ID_SINAVKITAPCIK) as KITAPCIK, SORUNO as SIRA from SinavAnahtar ssa where ID_SINAVKITAPCIK in (select ID_SINAVKITAPCIK from SinavKitapcik where ID_SINAV=@ID_SINAV and AD<>'A') and SORUNO_A=SORULIST.SORUNO and ID_SINAVDERS=JSONDERS.ID_SINAVDERS for json path) AS KARSILIKLIST
						,s.DONEM
					from	   Sinav						S
					inner join SinavDers			JSONDERS	ON	JSONDERS.ID_SINAV		= s.ID_SINAV 
					inner join SinavAnahtar			SORULIST	ON	SORULIST.ID_SINAVDERS	= JSONDERS.ID_SINAVDERS 
					INNER JOIN v3SinavDers					D	ON	D.ID_DERS				= JSONDERS.ID_DERS
					INNER JOIN #DERSLIST					L	ON	L.DERSAD				= D.AD 
					LEFT  JOIN v3SinavDersUnite				SD	ON	SD.KOD					= SORULIST.KOD
					where	s.ID_SINAV = @ID_SINAV 
						AND S.CEVAPANAHTARIYUKLEMEKAPAT = 0
						and ID_SINAVKITAPCIK=@ID_SINAVKITAPCIKX						
					order by id_sinavders, SORUNO		
				for json auto) as J
				
				DROP TABLE #DERSLIST
			END

			IF @ISLEM = 2   --	KAYDET
			BEGIN
				DROP TABLE IF EXISTS #DUZENLE
				DROP TABLE IF EXISTS #SINAVKITAPCIK

				SELECT   JSON_VALUE(S.VALUE,'$.ACEVAP')				AS ACEVAP
						,JSON_VALUE(S.VALUE,'$.KOD')				AS KOD
						,JSON_VALUE(S.VALUE,'$.SORUNO')				AS SORUNO
						,JSON_VALUE(S.VALUE,'$.ID_BILGI')			AS ID_BILGI
						,JSON_VALUE(S.VALUE,'$.ID_BILISSELSUREC')	AS ID_BILISSELSUREC
						,JSON_Value(D.value,'$.ID_SINAVDERS')		AS ID_SINAVDERS
		
						,JSON_VALUE(K.VALUE,'$.KITAPCIK')			AS KITAPCIK
						,JSON_VALUE(K.VALUE,'$.SIRA')				AS SIRA
				INTO #DUZENLE 
				FROM		OPENJSON (@SQLJSON, '$.JSONDERS') as D
				CROSS APPLY OPENJSON (D.value , '$.SORULIST') as S
				OUTER APPLY OPENJSON (S.value , '$.KARSILIKLIST') as K

				SELECT * INTO #SINAVKITAPCIK FROM SinavKitapcik SK WHERE SK.ID_SINAV=@ID_SINAV AND AD IN (SELECT DISTINCT KITAPCIK FROM #DUZENLE)

			--  SINAV ANAHTAR CEVAPLARINI DEĞİŞTİRİR (A,B,C KİTAPÇIKLARININ) 
				UPDATE	 SA
				SET		 SA.CEVAP				= D.ACEVAP
						,SA.KOD					= D.KOD
						,SA.ID_BILGI			= D.ID_BILGI
						,SA.ID_BILISSELSUREC	= D.ID_BILISSELSUREC
				FROM SinavAnahtar	SA
				JOIN #DUZENLE		D	ON	D.ID_SINAVDERS	= SA.ID_SINAVDERS
										AND D.SORUNO		= SA.SORUNO_A

			--	SINAV ANAHTAR SIRA NUMARASINI DEĞİŞTİRİR
				UPDATE SA
				SET	 SA.SORUNO	= D.SIRA
				FROM SinavAnahtar	SA
				JOIN #DUZENLE		D	ON	D.ID_SINAVDERS		= SA.ID_SINAVDERS
										AND D.SORUNO			= SA.SORUNO_A
				JOIN #SINAVKITAPCIK	SK	ON	SK.AD				= D.KITAPCIK
										AND SK.ID_SINAVKITAPCIK = SA.ID_SINAVKITAPCIK

			--	SINAV DURUMU BEKLEMEDE OLARAK DEĞİŞTİR
				UPDATE Sinav
				SET DURUM=0
				WHERE ID_SINAV=@ID_SINAV

						
				DROP TABLE #DUZENLE
				DROP TABLE #SINAVKITAPCIK

				SELECT @ID_SINAV
			END
		
		END

	END TRY
	BEGIN CATCH	
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_DenemeSinavRaporlari]...';


GO
ALTER procedure [dbo].[sp_DenemeSinavRaporlari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_KADEME3			INT				= NULL,	
	@ID_SINIF			INT				= NULL,	
	@ID_SINAV			INT				= NULL,
	@LIMIT				INT				= NULL,
	@DONEM				VARCHAR(4)		= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	  
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENU			= @ID_MENU		
			,ID_SUBE			= @ID_SUBE		
			,ID_SINAVTURU		= @ID_SINAVTURU	
			,ID_KADEME3			= @ID_KADEME3		
			,ID_SINIF			= @ID_SINIF		
			,ID_SINAV			= @ID_SINAV		
			,LIMIT				= @LIMIT			
			,DONEM				= @DONEM			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN			
		DECLARE @SINAVGRUP INT = (SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV)
		IF @ISLEM = 1	--	Sınav Listele
		BEGIN
			SELECT
			(
				SELECT S.ID_SINAV, S.AD, CONVERT(VARCHAR,S.SINAVTARIH,104) AS SINAVTARIH, COUNT(SO.TCKIMLIKNO) AS KATILIM FROM Sinav S
				INNER JOIN SinavOgrenci SO ON SO.ID_SINAV=S.ID_SINAV
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO AND O.DONEM = S.DONEM
				WHERE S.DONEM=@DONEM AND AKTIF=1
				AND (@ID_SINAVTURU=0 OR ID_SINAVTURU=@ID_SINAVTURU)
				AND (@ID_KADEME3=0 OR ID_KADEME3=@ID_KADEME3)
				AND (@ID_SINIF=0 OR @ID_SINIF=O.ID_SINIF)
				AND (@ID_SUBE IS NULL OR @ID_SUBE = O.ID_SUBE)
				GROUP BY S.ID_SINAV, S.AD, S.SINAVTARIH
				ORDER BY CAST(SINAVTARIH AS DATE) DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS J
		END

		IF @ISLEM = 2	--	Katılmayan Listele
		BEGIN
			SELECT K.TCKIMLIKNO, K.AD+' '+K.SOYAD AS ADSOYAD, SU.AD AS OKUL, SN.AD AS SINIF 
			FROM OkyanusDB.dbo.v3OgrenciTum O
			INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO=O.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE=O.ID_SUBE
			LEFT JOIN SinavOgrenci SO ON SO.TCKIMLIKNO=O.TCKIMLIKNO AND SO.ID_SINAV=@ID_SINAV
			WHERE SO.ID_SINAVOGRENCI IS NULL 
			AND	  (@ID_SUBE=0 OR @ID_SUBE=O.ID_SUBE)
			AND   (@ID_SINIF=0 OR @ID_SINIF=O.ID_SUBE)
			AND   (@SINAVGRUP=SGS.ID_KADEME3)
			AND	  (O.DONEM=(SELECT DONEM FROM Sinav WHERE ID_SINAV=@ID_SINAV))
			ORDER BY O.ID_SUBE, O.ID_SINIF, K.AD, K.SOYAD

			SELECT CAST(S.DONEM AS VARCHAR) + '-' + CAST(CAST(S.DONEM AS INT)+1 AS VARCHAR) + ' OKYANUS KOLEJİ ' + K3.AD + ' ' + S.AD + ' SINAVINA KATILMAYAN ÖĞRENCİLER' FROM Sinav S INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = S.ID_KADEME3 WHERE ID_SINAV = @ID_SINAV
		END

		IF @ISLEM = 3	--	Baraj Altı Öğrenci Listele
		BEGIN
			DECLARE @PUANTURLERI VARCHAR(MAX)=''
			DECLARE @PUANTURLERIISIMLI VARCHAR(MAX)=''
			DECLARE @PUANTURLERIWHERE VARCHAR(MAX)=''
			DECLARE @PUANTURLERIISIM VARCHAR(MAX)=''
			DECLARE @DERSLER VARCHAR(MAX)=''
			DECLARE @DERSLERISIMLI VARCHAR(MAX)=''
			DECLARE @DERSLERSUM VARCHAR(MAX)='CAST(('

			SELECT	@PUANTURLERI+='['+CAST(SPT.ID_SINAVPUANTURU AS VARCHAR)+'],'
					,@PUANTURLERIISIMLI+='CAST(['+CAST(SPT.ID_SINAVPUANTURU AS VARCHAR)+'] AS DECIMAL(6,3)) AS [PT-'+SPT.AD+'],' 
					,@PUANTURLERIWHERE+='[PT-'+SPT.AD+'] < '+CAST(@LIMIT AS VARCHAR)+ ' AND '
					,@PUANTURLERIISIM+='[PT-'+SPT.AD+'],'
			FROM Sinav S
			INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU=S.ID_SINAVTURU
			WHERE S.ID_SINAV=@ID_SINAV

			SET @PUANTURLERI=SUBSTRING(@PUANTURLERI,0,LEN(@PUANTURLERI))
			SET @PUANTURLERIISIMLI=SUBSTRING(@PUANTURLERIISIMLI,0,LEN(@PUANTURLERIISIMLI))
			SET @PUANTURLERIWHERE=SUBSTRING(@PUANTURLERIWHERE,0,LEN(@PUANTURLERIWHERE)-3)
			SET @PUANTURLERIISIM=SUBSTRING(@PUANTURLERIISIM,0,LEN(@PUANTURLERIISIM))

			IF EXISTS(SELECT AD FROM SinavPuanTuru WHERE ID_SINAVTURU=(SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV=@ID_SINAV))
			BEGIN
				SELECT @DERSLER+='['+TAKMAAD+'],'
					,@DERSLERISIMLI+='CAST(['+TAKMAAD+'] AS DECIMAL(5,2)) AS [DR-'+TAKMAAD+'],'
					,@DERSLERSUM+='['+TAKMAAD+']+'
				FROM SinavDers SD WHERE SD.ID_SINAV=@ID_SINAV

				SET @DERSLER=SUBSTRING(@DERSLER,0,LEN(@DERSLER))
				SET @DERSLERISIMLI=SUBSTRING(@DERSLERISIMLI,0,LEN(@DERSLERISIMLI))
				SET @DERSLERSUM=SUBSTRING(@DERSLERSUM,0,LEN(@DERSLERSUM))+') AS DECIMAL(5,2)) AS [DR-TOPLAM]'

				DECLARE @SQL NVARCHAR(MAX)=''

				SET @SQL=
				'
				SELECT *
				INTO #TEMP
				FROM
				(
					SELECT TCKIMLIKNO, ADSOYAD, OKUL, SINIF, '+@PUANTURLERIISIMLI+', SD.TAKMAAD, SOCB.NET
					FROM
					(
						SELECT K.TCKIMLIKNO, K.AD+'' ''+K.SOYAD AS ADSOYAD, SU.AD AS OKUL, SN.AD AS SINIF, SOS.ID_SINAVPUANTURU, SOS.PUAN 
						FROM Sinav S
						INNER JOIN SinavOgrenci SO ON SO.ID_SINAV=S.ID_SINAV
						INNER JOIN SinavOgrenciPuan SOS ON SOS.ID_SINAV=SO.ID_SINAV AND SOS.TCKIMLIKNO = SO.TCKIMLIKNO
						INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVPUANTURU=SOS.ID_SINAVPUANTURU
						INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3KullaniciKademe3 K3 ON K3.TCKIMLIKNO=O.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO=O.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE=O.ID_SUBE
						INNER JOIN OkyanusDB.dbo.v3Sinif SN ON SN.ID_SINIF=O.ID_SINIF
						WHERE	S.ID_SINAV='+CAST(@ID_SINAV AS VARCHAR)+'
						AND		EXISTS (SELECT PUAN FROM SinavOgrenciPuan SOSS WHERE SOSS.ID_SINAV=SO.ID_SINAV AND SOSS.TCKIMLIKNO = SO.TCKIMLIKNO AND PUAN<='+CAST(@LIMIT AS VARCHAR)+')
						AND		('+CAST(@ID_SUBE AS VARCHAR)+'=0 OR '+CAST(@ID_SUBE AS VARCHAR)+'=O.ID_SUBE)
						AND		('+CAST(@SINAVGRUP AS VARCHAR)+'=K3.ID_KADEME3)
						AND		('+CAST(@ID_SINIF AS VARCHAR)+'=0 OR '+CAST(@ID_SINIF AS VARCHAR)+'=O.ID_SINIF)
						GROUP BY SOS.ID_SINAVPUANTURU, K.TCKIMLIKNO, K.AD, K.SOYAD, SU.AD, SN.AD, SOS.PUAN 
					) AS SourceTable
					PIVOT
					(
					AVG(PUAN)
					FOR ID_SINAVPUANTURU IN ('+@PUANTURLERI+')
					) AS PivotTable
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI IN (SELECT ID_SINAVOGRENCI FROM SinavOgrenci WHERE ID_SINAV='+CAST(@ID_SINAV AS VARCHAR)+' AND TCKIMLIKNO=PivotTable.TCKIMLIKNO)
					INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
				) AS SourceTableDers


				SELECT ROW_NUMBER() OVER(ORDER BY OKUL,SINIF,ADSOYAD) AS SIRA, /*P.TCKIMLIKNO,*/ P.OKUL, P.SINIF, P.ADSOYAD, '+@DERSLERISIMLI+','+@DERSLERSUM+','+@PUANTURLERIISIM+'  FROM #TEMP T
				PIVOT
				(
				AVG(NET)
				FOR TAKMAAD IN ('+@DERSLER+')
				) AS P
				WHERE '+@PUANTURLERIWHERE+'

				DROP TABLE #TEMP
				'

				PRINT @SQL
				EXEC(@SQL)
			END
			ELSE
			BEGIN
				SELECT 1 
			END

			SELECT	S.AD AS SINAVADI
					,CONVERT(VARCHAR, S.SINAVTARIH, 104) AS SINAVTARIHI
					,@PUANTURLERIISIM+' Puan Türünde '+CAST(@LIMIT AS VARCHAR)+' Puan Barajını Aşamayan Öğrenciler' AS TITLE FROM Sinav S WHERE S.ID_SINAV=@ID_SINAV
		END

		IF @ISLEM = 4	--	Kurum Soru Analizi
		BEGIN
			SELECT SD.TAKMAAD, SA.SORUNO_A, SA.SORUNO, SA.CEVAP, SK.AD, CASE WHEN SSI.ID_SINAVSORUDUZENLE IS NULL THEN 0 ELSE 1 END AS HATALI, SDU.AD AS KAZANIM
			INTO #CEVAPLAR 
			FROM Sinav S
			INNER JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV
			INNER JOIN SinavDers SD ON SD.ID_SINAV=S.ID_SINAV
			INNER JOIN SinavAnahtar SA ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
			LEFT JOIN SinavSoruIslem SSI ON SSI.ID_SINAVANAHTAR=SA.ID_SINAVANAHTAR 
			LEFT JOIN v3SinavDersUnite SDU ON SDU.KOD=SA.KOD
			WHERE S.ID_SINAV=@ID_SINAV
			ORDER BY SD.BOLUMNO, SK.AD, SA.SORUNO_A

			DECLARE @SUBENO VARCHAR(3), @OKUL VARCHAR(MAX), @SINAVADI VARCHAR(MAX)
			SELECT @SUBENO=RIGHT('000' + SUBENO, 3), @OKUL=AD FROM OkyanusDB.dbo.v3Sube WHERE ID_SUBE=@ID_SUBE
			SELECT @SINAVADI=AD FROM Sinav WHERE ID_SINAV=@ID_SINAV

			SELECT	SD.BOLUMNO
					,SD.TAKMAAD
					,C.SORUNO_A AS SORU
					,C.CEVAP AS DC
					,SUM(CASE WHEN SOC.CEVAP='A' THEN 1 ELSE 0 END) AS A 
					,SUM(CASE WHEN SOC.CEVAP='B' THEN 1 ELSE 0 END) AS B
					,SUM(CASE WHEN SOC.CEVAP='C' THEN 1 ELSE 0 END) AS C
					,SUM(CASE WHEN SOC.CEVAP='D' THEN 1 ELSE 0 END) AS D
					,SUM(CASE WHEN SOC.CEVAP='E' THEN 1 ELSE 0 END) AS E
					,SUM(CASE WHEN SOC.CEVAP='' THEN 1 ELSE 0 END) AS BOS
					,SUM(CASE WHEN SOC.CEVAP IS NOT NULL THEN 1 ELSE 0 END) AS TOPLAM
					,C.HATALI
					,C.KAZANIM
			INTO #ANALIZ
			FROM Sinav S
			INNER JOIN SinavOgrenci SO ON SO.ID_SINAV=S.ID_SINAV
			INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN #CEVAPLAR C ON C.TAKMAAD=SD.TAKMAAD AND C.SORUNO=SOC.SORUNO AND C.AD=SO.KITAPCIK
			WHERE S.ID_SINAV=@ID_SINAV AND SO.SUBENO=@SUBENO
			GROUP BY  SD.BOLUMNO, SD.TAKMAAD, C.SORUNO_A, C.CEVAP, C.HATALI, C.KAZANIM

			SELECT BOLUMNO, TAKMAAD, SORU, DC, 
			CAST(A AS VARCHAR)+' - %'+CAST(CAST((CAST(A AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS A, 
			CAST(B AS VARCHAR)+' - %'+CAST(CAST((CAST(B AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS B, 
			CAST(C AS VARCHAR)+' - %'+CAST(CAST((CAST(C AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS C, 
			CAST(D AS VARCHAR)+' - %'+CAST(CAST((CAST(D AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS D, 
			CAST(E AS VARCHAR)+' - %'+CAST(CAST((CAST(E AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS E, 
			CAST(BOS AS VARCHAR)+' - %'+CAST(CAST((CAST(BOS AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)) AS VARCHAR) AS BOS, 
			HATALI, KAZANIM FROM #ANALIZ
			ORDER BY BOLUMNO, SORU

			SELECT @OKUL, @SINAVADI
			
			SELECT 
			(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO=@SUBENO) AS SUBE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL AND S2.ILCE=S.ILCE
																											WHERE S.ID_SUBE=@ID_SUBE)) AS ILCE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL
																											WHERE S.ID_SUBE=@ID_SUBE)) AS IL
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV) AS GENEL

			DROP TABLE IF EXISTS #CEVAPLAR
			DROP TABLE IF EXISTS #ANALIZ			
		END

		IF @ISLEM = 5	--	Net Ortalamaları
		BEGIN
			IF(@ID_SUBE=0)
			BEGIN
				SELECT SO.TCKIMLIKNO, SUM(SOCB.NET) AS TOPLAMNET, SO.SUBENO
				INTO #SINAVOGRENCINET
				FROM SinavOgrenci SO 
				INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				WHERE SO.ID_SINAV=@ID_SINAV
				GROUP BY SO.TCKIMLIKNO, SO.SUBENO

				SELECT SU.SUBENO, SU.AD, CAST(AVG(SON.TOPLAMNET) AS DECIMAL(5,2)) AS NET
				FROM #SINAVOGRENCINET SON
				INNER JOIN OkyanusDB.dbo.v3Sube SU ON RIGHT('000' + SU.SUBENO, 3) = SON.SUBENO
				GROUP BY SU.SUBENO, SU.AD
				ORDER BY CAST(SU.SUBENO AS INT)

				DROP TABLE #SINAVOGRENCINET
			END
			ELSE
			BEGIN
				SELECT SO.TCKIMLIKNO, SUM(SOCB.NET) AS TOPLAMNET, SO.SINIF
				INTO #SINAVOGRENCINET2
				FROM SinavOgrenci SO 
				INNER JOIN SinavOgrenciCevapBolum SOCB	ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN OkyanusDB.dbo.v3Sube		SB	ON RIGHT('000' + SB.SUBENO, 3) = SO.SUBENO AND SB.ID_SUBE = @ID_SUBE
				WHERE SO.ID_SINAV = @ID_SINAV --AND SO.SUBENO=(SELECT RIGHT('000' + SUBENO, 3) FROM OkyanusDB.dbo.v3Sube WHERE ID_SUBE = @ID_SUBE)
				GROUP BY SO.TCKIMLIKNO, SO.SINIF

				SELECT 1, SN.AD AS SINIF, CAST(AVG(SON.TOPLAMNET) AS DECIMAL(5,2)) AS NET
				FROM #SINAVOGRENCINET2 SON
				INNER JOIN OkyanusDB.dbo.v3Sinif SN ON SN.AD = SON.SINIF
				GROUP BY SN.AD
				ORDER BY SN.AD 

				DROP TABLE #SINAVOGRENCINET2
			END			
		END
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_DersCalismaProgrami]...';


GO
ALTER procedure [dbo].[sp_DersCalismaProgrami]
	@TCKIMLIKNO			NVARCHAR(11)	    = NULL,
	@TC_OGRENCI			NVARCHAR(11)	    = '',
	@OTURUM				NVARCHAR(36)	    = NULL,
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					= NULL,
	@ID_KADEME3         INT                 = NULL,
	@ID_DERS            INT                 = NULL,
	@ID_DERSUNITE       INT                 = NULL,
	@AD                 NVARCHAR(250)       = NULL,
	@KOD                NVARCHAR(20)        = NULL,
	@DONEM              NVARCHAR(4)         = NULL,
	@LINKLIST           NVARCHAR(MAX)		= NULL,
	@SQLJSON            NVARCHAR(MAX)		= NULL,
	@JSON            NVARCHAR(MAX)		= NULL,
	@VERILIS_TARIHI     DATETIME            = NULL,
	@SAAT               NVARCHAR(MAX)       = NULL,
	@HEDEFSORU          NVARCHAR(MAX)       = NULL,
	@OGRTCKIMLIKNO		VARCHAR(11)		    = NULL,
	@ID_SINIF           INT                 = NULL,
	@ID_SUBE            INT                 = NULL,
	@ID_SUBELER		    VARCHAR(MAX)	    = NULL,
	@ID_SINIFLAR        VARCHAR(MAX)	    = NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO			=	@TCKIMLIKNO		
			,TC_OGRENCI			=	@TC_OGRENCI		
			,OTURUM				=	@OTURUM			
			,ISLEM				=	@ISLEM			
			,ID_MENU			=	@ID_MENU		
			,ID_KADEME3         =	@ID_KADEME3    
			,ID_DERS            =	@ID_DERS       
			,ID_DERSUNITE       =	@ID_DERSUNITE  
			,AD                 =	@AD            
			,KOD                =	@KOD           
			,DONEM              =	@DONEM         
			,LINKLIST           =	@LINKLIST      
			,SQLJSON            =	@SQLJSON       
			,[JSON]				=	@JSON          
			,VERILIS_TARIHI     =	@VERILIS_TARIHI
			,SAAT               =	@SAAT          
			,HEDEFSORU          =	@HEDEFSORU     
			,OGRTCKIMLIKNO		=	@OGRTCKIMLIKNO	
			,ID_SINIF           =	@ID_SINIF      
			,ID_SUBE            =	@ID_SUBE       
			,ID_SUBELER		    =	@ID_SUBELER		
			,ID_SINIFLAR        =	@ID_SINIFLAR   
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY   
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 

	IF @ID_LOG > 1
	BEGIN
	   DECLARE @AKTIFDONEM VARCHAR(4)= (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
	    IF @ISLEM = 1	--	Odev Ekle güncelle			
		BEGIN		
			
			--UPDATE OKYANUSDB.DBO.v3SinavDersUnite
			--SET AD= @AD--, KOD = @KOD
			--WHERE ID_DERSUNITE=@ID_DERSUNITE

			--SET @KOD = ( SELECT KOD FROM OKYANUSDB.DBO.v3SinavDersUnite WHERE ID_DERSUNITE = @ID_DERSUNITE )
			
			UPDATE OKYANUSDB.DBO.v3SinavDersUniteOdev SET
				AKTIF = 0 
			WHERE KOD = @KOD

			INSERT INTO  OKYANUSDB.DBO.v3SinavDersUniteOdev (KOD, ODEV, KYE_TCKIMLIKNO) 
			SELECT @KOD, ODEV, @TCKIMLIKNO FROM OPENJSON(@LINKLIST) WITH (ODEV VARCHAR(MAX))


		END
		IF @ISLEM = 2	--	Ders ünite listesi		
		BEGIN	

			SELECT ISNULL((
				SELECT	 D1.ID_DERS
						,D1.ID_DERSUNITE
						,D1.KOD
						,D1.AD
						,LINKLIST = ISNULL((SELECT ODEV
											FROM OKYANUSDB.DBO.v3SinavDersUniteOdev L
											WHERE	L.KOD	= D1.KOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"ODEV":""}]')
				FROM v3SinavDersUnite		D1
				inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
				WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
				ORDER BY d1.KOD
				FOR JSON PATH, INCLUDE_NULL_VALUES
			),'[]')


		END
		IF @ISLEM = 8	--	Ders ünite listesi		
		BEGIN	

			SELECT ISNULL((
				SELECT	 D1.ID_DERS
						,D1.ID_DERSUNITE
						,D1.KOD
						,D1.AD
						,LINKLIST = ISNULL((SELECT HEDEFSORU,TARIH,SAAT,KAZANIMKOD
											FROM DersCalismaProgram L
											WHERE	L.KAZANIMKOD	= D1.KOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"HEDEFSORU":""},{"TARIH":""},{"SAAT":""},{"KAZANIMKOD":""}]')
				FROM v3SinavDersUnite		D1
				inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
				WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
				ORDER BY d1.KOD
				FOR JSON PATH, INCLUDE_NULL_VALUES
			),'[]')


		END
		IF @ISLEM = 3	--	Kazanım Program Ekle			
		BEGIN		
			
			--UPDATE DersCalismaProgram SET
			--	AKTIF = 0 
			--WHERE KAZANIMKOD = @KOD  AND TCKIMLIKNO=@TC_OGRENCI


				--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,KYE_TARIH,TARIH,SAAT,HEDEFSORU) 
			 --   SELECT @KOD,@TCKIMLIKNO,@TC_OGRENCI,KYE_TARIH,TARIH,SAAT,HEDEFSORU FROM OPENJSON(@LINKLIST) WITH (KYE_TARIH VARCHAR(MAX),TARIH VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX))

				INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			    SELECT @KOD,@TCKIMLIKNO, @TC_OGRENCI,VERILIS_TARIHI ,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) 




			--IF EXISTS(select * from DersCalismaProgram  d 
			--INNER JOIN
   --        OPENJSON(@LINKLIST) WITH(KAZANIMKOD VARCHAR(MAX),TARIH VARCHAR(MAX),KYE_TARIH VARCHAR(MAX)) j on j.KAZANIMKOD=D.KAZANIMKOD
			--where D.KAZANIMKOD=@KOD AND AKTIF=1 AND TCKIMLIKNO=@TC_OGRENCI AND D.KAZANIMKOD=j.KAZANIMKOD AND j.KYE_TARIH=D.KYE_TARIH AND j.TARIH=D.TARIH)
			--UPDATE D  SET
			--	AKTIF = 0
			--	from openjson(@LINKLIST)
			--	WITH (TARIH NVARCHAR(MAX),KAZANIMKOD NVARCHAR(MAX),KYE_TARIH NVARCHAR(MAX)) as json
			--	inner join DersCalismaProgram as D 
			--	on D.KAZANIMKOD= json.KAZANIMKOD
			--    WHERE D.KAZANIMKOD = @KOD  AND D.TARIH=json.TARIH AND D.KYE_TARIH=json.KYE_TARIH
   --         ELSE
			


			


			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO, @TC_OGRENCI,VERILIS_TARIHI ,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) 

			--"KYE_TARIH\":\"2019-11-21\",\"KAZANIMKOD\":\"İNK809001001\",\"TARIH\":\"2019-10-31\",\"SAAT\":\"9:30\",\"HEDEFSORU\":\"BRC\"}
			--UPDATE DersCalismaProgram SET
			--	AKTIF = 0 
			--WHERE KAZANIMKOD = @KOD

			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO,@TC_OGRENCI,VERILIS_TARIHI,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX))


		END
		IF @ISLEM = 9	--	Kazanım Program Sil			
		BEGIN		
			
			UPDATE DersCalismaProgram SET
				AKTIF = 0 
			WHERE KAZANIMKOD = @KOD  AND TCKIMLIKNO=@TC_OGRENCI


			IF EXISTS(select TOP 1 1 from DersCalismaProgram  d 
			INNER JOIN
           OPENJSON(@LINKLIST) WITH(KAZANIMKOD VARCHAR(MAX),TARIH VARCHAR(MAX),KYE_TARIH VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) j on j.KAZANIMKOD=D.KAZANIMKOD
			where D.KAZANIMKOD=@KOD AND AKTIF=0 AND TCKIMLIKNO=@TC_OGRENCI AND D.KAZANIMKOD=j.KAZANIMKOD AND j.KYE_TARIH=D.KYE_TARIH AND j.TARIH=D.TARIH AND D.HEDEFSORU=j.HEDEFSORU)
			UPDATE D  SET
				AKTIF = 1
				from openjson(@LINKLIST)
				WITH (TARIH NVARCHAR(MAX),KAZANIMKOD NVARCHAR(MAX),KYE_TARIH NVARCHAR(MAX),HEDEFSORU NVARCHAR(MAX)) as json
				inner join DersCalismaProgram as D 
				on D.KAZANIMKOD= json.KAZANIMKOD
			    WHERE D.KAZANIMKOD = @KOD  AND D.TARIH=json.TARIH AND D.KYE_TARIH=json.KYE_TARIH AND D.HEDEFSORU=json.HEDEFSORU
            
			 


			


			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO, @TC_OGRENCI,VERILIS_TARIHI ,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX)) 

			--"KYE_TARIH\":\"2019-11-21\",\"KAZANIMKOD\":\"İNK809001001\",\"TARIH\":\"2019-10-31\",\"SAAT\":\"9:30\",\"HEDEFSORU\":\"BRC\"}
			--UPDATE DersCalismaProgram SET
			--	AKTIF = 0 
			--WHERE KAZANIMKOD = @KOD

			--INSERT INTO  DersCalismaProgram(KAZANIMKOD,KYE_TCKIMLIKNO,TCKIMLIKNO,TARIH,SAAT,HEDEFSORU) 
			--SELECT @KOD,@TCKIMLIKNO,@TC_OGRENCI,VERILIS_TARIHI,SAAT,HEDEFSORU FROM OPENJSON(@SQLJSON) WITH (VERILIS_TARIHI VARCHAR(MAX),SAAT VARCHAR(MAX),HEDEFSORU VARCHAR(MAX))


		END
		IF @ISLEM = 4	--	ÖĞRENCİ KAZANIM LİSTELE YENİ			
		BEGIN
			DECLARE @ID_KADEME3_OGR INT

			SELECT @ID_KADEME3_OGR = ST.ID_KADEME3 
			FROM OkyanusDB.dbo.v3Ogrenci O
			JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
			WHERE O.TCKIMLIKNO = @OGRTCKIMLIKNO

			SELECT  SO.ID_SINAV
				,SD.TAKMAAD AS [DERS.AD]
				,SOCB.DOGRU AS [DERS.DOGRU]
				,SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS [DERS.SORU]
				,CASE WHEN SDU.AD IS NULL THEN CONVERT(VARCHAR(MAX),SA.KOD) ELSE SDU.AD END AS [DERS.UNITE.AD]
				,SA.KOD  AS [DERS.UNITE.KOD]
				,SUM(case SOC.DURUM when 'D' then 1 else 0 end) as [DERS.UNITE.DOGRU]
				,SUM(case SOC.DURUM when 'Y' then 1 else 0 end) as [DERS.UNITE.YANLIS]
				,SUM(case SOC.DURUM when 'B' then 1 else 0 end) as [DERS.UNITE.BOS]
				,COUNT(1) as [DERS.UNITE.SORU]
			INTO #TEMP1X
			FROM SinavOgrenci SO WITH(NOLOCK)
			INNER JOIN SinavOgrenciCevapBolum SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC WITH(NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
			INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN SinavAnahtar SA  WITH(NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
			INNER JOIN v3SinavDersUnite SDU WITH(NOLOCK) on SDU.KOD=SA.KOD
			INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
			WHERE SO.TCKIMLIKNO=@OGRTCKIMLIKNO AND S.AKTIF=1 AND S.OZEL = 0 AND ((@ID_KADEME3_OGR < 15 AND S.DONEM = @AKTIFDONEM) OR @ID_KADEME3_OGR >= 15) -- LİSE DEĞİLSE SADECE MEVCUT DÖNEM
			GROUP BY SO.ID_SINAV, SD.TAKMAAD, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SDU.AD, SA.KOD			

			SELECT
			(
				SELECT	DERSAD = [DERS.AD],
						DERSYUZDE = CONVERT(DECIMAL(5,2),CONVERT(DECIMAL(18,2),SUM([DERS.DOGRU]))/CONVERT(DECIMAL(18,2),SUM([DERS.SORU]))*100.0),
						UNITELER = (
							SELECT	UNITEAD = SUBT.[DERS.UNITE.AD], 
									TD = SUM(SUBT.[DERS.UNITE.DOGRU]), 
									TY = SUM(SUBT.[DERS.UNITE.YANLIS]), 
									TB = SUM(SUBT.[DERS.UNITE.BOS]),									
									LINKLIST = ISNULL((SELECT KYE_TARIH,KAZANIMKOD,TARIH,SAAT,HEDEFSORU
														FROM DersCalismaProgram L
														WHERE	L.KAZANIMKOD	= SUBT.[DERS.UNITE.KOD]
															    AND L.AKTIF = 1
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									MORPAKAZANIMLIST = ISNULL((SELECT MK.KOD
														FROM MorpaKazanim MK
														JOIN MorpaDers MD ON MD.ID_MORPADERS = MK.ID_MORPADERS AND MD.AKTIF = 1
														WHERE	MK.KOD_OKY	= SUBT.[DERS.UNITE.KOD]
															AND MK.AKTIF = 1
															AND MD.ID_KADEME3 = @ID_KADEME3_OGR
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									[UNITEYUZDE] = CONVERT(DECIMAL(5,2), SUM(SUBT.[DERS.UNITE.DOGRU]) / CONVERT(DECIMAL(5,2),SUM(SUBT.[DERS.UNITE.SORU]))) * 100,
									UNITEKOD= SUBT.[DERS.UNITE.KOD],						
								   [CALISMASAYISI]= (SELECT COUNT(DISTINCT KYE_TARIH) FROM [Pusulam].[dbo].[DersCalismaProgram] D Where D.TCKIMLIKNO=@OGRTCKIMLIKNO AND D.KAZANIMKOD= SUBT.[DERS.UNITE.KOD] AND D.AKTIF=1)
								  
							FROM #TEMP1X SUBT 
							WHERE SUBT.[DERS.AD] = T.[DERS.AD]
							GROUP BY SUBT.[DERS.AD], SUBT.[DERS.UNITE.KOD], SUBT.[DERS.UNITE.AD]
							ORDER BY UNITEYUZDE DESC
							FOR JSON PATH
						) 
				FROM #TEMP1X T
				GROUP BY [DERS.AD]
				ORDER BY DERSYUZDE DESC
				FOR JSON PATH
			) AS J

			DROP TABLE #TEMP1X
		END
		IF @ISLEM = 5	--	Ders ünite Program Listesi
		BEGIN
		SET LANGUAGE Turkish;
	SELECT
				(
					SELECT	GS.SUBEAD
							,GS.SINIF
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT VD.AD,S.HedefSoru,convert(varchar, S.TARIH, 6) as TARIH,S.SAAT,D.DERSAD
								,LINKLIST = ISNULL((SELECT ODEV
											FROM OKYANUSDB.DBO.v3SinavDersUniteOdev L
											WHERE	L.KOD	= S.KAZANIMKOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"ODEV":""}]')
								,YAKLASANODEVLIST = ISNULL (( SELECT BASLIK,O.TESLIM_TARIHI,DS.DERSAD
								                FROM OdevSinifOgrenci OSO WITH(NOLOCK)
												INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
					                            INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
												INNER JOIN eokul_v2.dbo.Ders DS WITH(NOLOCK) ON DS.ID_DERS = O.ID_DERS
					                            INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
												Where OSO.TCKIMLIKNO=@OGRTCKIMLIKNO 
												AND O.TESLIM_TARIHI=convert(varchar, getdate()+1, 23)
												
												FOR JSON PATH, INCLUDE_NULL_VALUES
												),'[{"ODEV":""}]')
								FROM DersCalismaProgram S INNER JOIN [OkyanusDB].[dbo].[v3SinavDersUnite] VD ON S.KAZANIMKOD=VD.KOD
								INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.TCKIMLIKNO AND S.KAZANIMKOD= VD.KOD
								INNER JOIN eokul_v2.[dbo].[Ders] D     ON D.ID_DERS=VD.ID_DERS
								--LEFT JOIN UniteTaramaOgrenci AO ON AO.ID_UNITETARAMASORU = S.ID_UNITETARAMASORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
								WHERE S.TCKIMLIKNO = @OGRTCKIMLIKNO AND  S.AKTIF=1 
								--GROUP BY S.TARIH
								ORDER BY TARIH 
								FOR JSON PATH
							 ) AS PROGRAMLIST
							
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO 
					INNER JOIN OKYANUSDB.dbo.[vw_SubeGrupSinifTum]	GS ON GS.ID_SINIF = O.ID_SINIF 
					WHERE 
					--O.ID_SINIF = @ID_SINIF  
					O.ID_SINIF=(Select (ID_SINIF ) FROM v3OgrenciTum OT INNER JOIN  Pusulam.dbo.v3AktifDonem AD	ON AD.DONEM	= OT.DONEM  Where TCKIMLIKNO=@OGRTCKIMLIKNO AND AD.AKTIF=1)
					AND K.TCKIMLIKNO=@OGRTCKIMLIKNO 
					--AND O.ID_SUBE=@ID_SUBE
					AND  O.ID_SUBE=(Select (ID_SUBE ) FROM v3OgrenciTum OT INNER JOIN  Pusulam.dbo.v3AktifDonem AD	ON AD.DONEM	= OT.DONEM  Where TCKIMLIKNO=@OGRTCKIMLIKNO AND AD.AKTIF=1)
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
		 END
		IF @ISLEM = 6   --  Ders Program Öğrenci Rapor
			BEGIN
				SELECT distinct 
					 D.SUBEAD
					,D.SINIF
					,K.AD
					,K.SOYAD
					,PROGRAMSAYISI = (SELECT COUNT(DISTINCT KYE_TARIH) FROM  DersCalismaProgram S where  S.TCKIMLIKNO=K.TCKIMLIKNO AND S.AKTIF=1) 
					,KAZANIMSAYISI = (SELECT COUNT(DISTINCT S.KAZANIMKOD) FROM  DersCalismaProgram S where  S.TCKIMLIKNO=K.TCKIMLIKNO AND S.AKTIF=1) 
				    ,D.ID_SUBE
					,D.ID_SINIF
				FROM  OkyanusDB.dbo.vw_SinifOgrenci						S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	= D.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		= d.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	= S.TCKIMLIKNO 
				INNER JOIN DersCalismaProgram                           P   ON P.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE=@ID_SUBE)) 
				--AND ( ( D.ID_SINIF=@ID_SINIF))  
				AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				
				ORDER BY  D.SUBEAD ASC,D.SINIF ASC, AD ASC 
				--,tarih DESC
			END
		IF @ISLEM = 7   --  Ders Program Öğretmen Rapor
			BEGIN
				SELECT distinct 
					 D.SUBEAD
					,D.SINIF
					,K.AD
					,K.SOYAD
					,OGRPROGRAMSAYISI = (SELECT COUNT(DISTINCT S.TCKIMLIKNO) FROM  DersCalismaProgram S where  S.KYE_TCKIMLIKNO=K.TCKIMLIKNO) 
					,TOPLAMPROGRAMSAYISI = (SELECT COUNT(1) FROM  DersCalismaProgram S where  S.KYE_TCKIMLIKNO=K.TCKIMLIKNO) 
				    ,D.ID_SUBE
					,D.ID_SINIF
				FROM  OkyanusDB.dbo.v3KullaniciSinif					    S 
				INNER JOIN  OkyanusDB.dbo.vw_v4SinifDetay				D	ON S.ID_SINIF	    = D.ID_SINIF 			
				INNER JOIN  Pusulam.dbo.v3AktifDonem					AD	ON AD.DONEM		    = d.DONEM 
				INNER JOIN	OkyanusDB.dbo.v3Kullanici					K	ON K.TCKIMLIKNO	    = S.TCKIMLIKNO 
				INNER JOIN DersCalismaProgram                           P   ON P.KYE_TCKIMLIKNO = K.TCKIMLIKNO								
				WHERE AD.AKTIF=1        
				--AND ( ( D.ID_SUBE=@ID_SUBE)) 
				--AND ( ( D.ID_SINIF=@ID_SINIF))  
				AND ( ( D.ID_SUBE		IN (SELECT VALUE FROM Openjson (@ID_SUBELER)))) 
				AND ( ( D.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR))))  
				ORDER BY  D.SUBEAD ASC,D.SINIF ASC, AD ASC 
				--,tarih DESC
			END
     

	END
END TRY
BEGIN CATCH	
	DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_DisOgrenci]...';


GO
-- =============================================
-- Author:		<Gökhan Kahraman>
-- Create date: <24-12-2020>
-- Description:	<dbo.DisOgrenci>
-- =============================================
ALTER PROCEDURE [dbo].[sp_DisOgrenci] 
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					=NULL,
	@SQLJSON			varchar(MAX)		='',
	@ID_SINAV			INT					=NULL,
	@TCKIMLIKNO			VARCHAR(11)			=NULL,
	@OTURUM				VARCHAR(36)			= NULL

AS
BEGIN
SET NOCOUNT ON;
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM				=	@ISLEM		
			,ID_MENU			=	@ID_MENU	
			,SQLJSON			=	@SQLJSON	
			,ID_SINAV			=	@ID_SINAV	
			,TCKIMLIKNO			=	@TCKIMLIKNO	
			,OTURUM				=	@OTURUM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY

		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM=1 --DisOgrenci Listele
			BEGIN

			SELECT 
				DO.ID_DIS_OGRENCI
				,DO.TCKIMLIKNO
				,DO.AD
				,DO.SOYAD
				,DO.ID_KADEME3
				,K.AD
				,DO.DONEM
				,D.ACIKLAMA AS DONEM_ACIKLAMA
				,DO.EPOSTA
				,DO.VELI_AD_SOYAD
				,DO.SIFRE
				,DO.KYE_TCKIMLIKNO
				,DO.AKTIF  
				FROM DisOgrenci AS DO
		 JOIN OkyanusDB.dbo.v3AktifDonem AS D ON DO.DONEM=D.DONEM
		 JOIN OkyanusDB.dbo.v3Kademe3 AS K ON DO.ID_KADEME3=K.ID_KADEME3 FOR JSON AUTO			
			END

		IF @ISLEM=2 -- DisOgrenci EXCEL YUKLE
			BEGIN
				DECLARE @SINAV_GRUP INT=0
				DECLARE @SINAV_DONEM INT=0
				DECLARE @AKTIF_DONEM INT=(SELECT OkyanusDB.dbo.fn_AktifDonem())

				--Dışarıdan gelen SınavID ye göre Dönem ve Sınıf bilgisi bulunuyor ve değişkenlere atılıyor
				SELECT TOP 1 @SINAV_DONEM = DONEM
							,@SINAV_GRUP = ID_KADEME3 
				FROM Sinav 
				where ID_SINAV =  @ID_SINAV
				
			--JSON kontrolü
			If (ISJSON(@SQLJSON)=1)
				BEGIN
						 --TempTable Json ile dolduruluyor			
						SELECT TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBENO
						INTO #TMP_DisOgrenci
						FROM OPENJSON(@SQLJSON)
						WITH(TCKIMLIKNO VARCHAR(11),AD VARCHAR(200),SOYAD VARCHAR(200),ID_KADEME3 INT,DONEM INT,EPOSTA NVARCHAR(320),VELI_AD_SOYAD VARCHAR(300),KYE_TCKIMLIKNO VARCHAR(11),SUBENO INT)

						IF (SELECT COUNT(1) FROM #TMP_DisOgrenci)>0
						BEGIN
						

						SELECT TCORJ = K.TCKIMLIKNO, TCYENI = CONVERT(varchar(11),CONVERT(bigint, K.TCKIMLIKNO) + 1 )
						INTO #KUL
						FROM v3Kullanici K 
						JOIN v3SubeYetki SY ON K.TCKIMLIKNO = SY.TCKIMLIKNO

						--Öğrenci DisOgrenci tablsounda varsa DONEM ve ID_KADEME si sınava göre Update ediliyor
						UPDATE DisOgrenci SET DONEM=@SINAV_DONEM,ID_KADEME3=@SINAV_GRUP 
							   WHERE TCKIMLIKNO=@TCKIMLIKNO 
							   AND
							   EXISTS (SELECT TOP 1 1 FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)

						--TC kimlik numarası ve Aktif durum kontrolüne göre daha önce eklenmemiş ise ve AktifÖğrenci tablosunda yok ise DisOgrenci tablosuna yazılıyor
						INSERT INTO DisOgrenci (TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBE_NO)
						SELECT TCKIMLIKNO,AD,SOYAD,ID_KADEME3,DONEM,EPOSTA,VELI_AD_SOYAD,KYE_TCKIMLIKNO,SUBENO
						FROM #TMP_DisOgrenci T
						WHERE	NOT EXISTS (SELECT TOP 1 1 FROM DisOgrenci D WHERE D.TCKIMLIKNO = T.TCKIMLIKNO AND AKTIF=1)
								AND NOT EXISTS(SELECT TOP 1 1 FROM v3Ogrenci O WHERE O.TCKIMLIKNO=(CONVERT(bigint,T.TCKIMLIKNO)-1))

						INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
						SELECT DISTINCT @ID_SINAV AS ID_SINAV, K.TCORJ, @TCKIMLIKNO
						FROM OPENJSON(@SQLJSON) WITH (TCKIMLIKNO VARCHAR(MAX)) J
						JOIN #KUL	K	ON	K.TCYENI = J.TCKIMLIKNO
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM Tbl_OnlineSinavOgrenci O WHERE O.TCKIMLIKNO = K.TCORJ AND O.AKTIF = 1 AND O.ID_SINAV = @ID_SINAV)

						INSERT INTO Tbl_OnlineSinavOgrenci (ID_SINAV, TCKIMLIKNO, KYE_TCKIMLIKNO)
						SELECT DISTINCT @ID_SINAV AS ID_SINAV, J.TCKIMLIKNO , @TCKIMLIKNO 
						FROM OPENJSON(@SQLJSON) WITH (TCKIMLIKNO VARCHAR(MAX)) J
						WHERE 	NOT EXISTS (SELECT TOP 1 1 
											FROM Tbl_OnlineSinavOgrenci OS WITH(NOLOCK)
											WHERE	OS.AKTIF		= 1 
												AND OS.ID_SINAV		= @ID_SINAV 
												AND OS.TCKIMLIKNO	= J.TCKIMLIKNO 											
											)
							AND NOT EXISTS (SELECT TOP 1 1 
												FROM #KUL K
												WHERE	K.TCYENI		= J.TCKIMLIKNO
													--OR	K.TCYENI	= OS.TCKIMLIKNO
												)
					
					
						--CREATE TABLE #TMP_KurumIci(TCKIMLIKNO VARCHAR(50),AD VARCHAR(200),SOYAD VARCHAR(200))
						--INSERT INTO #TMP_KurumIci (TCKIMLIKNO,AD,SOYAD)
						--SELECT TCKIMLIKNO,AD,SOYAD
						--FROM OPENJSON(@SQLJSON) 
						--WITH(
						--	 TCKIMLIKNO	VARCHAR(11)
						--	,AD			VARCHAR(200)
						--	,SOYAD		VARCHAR(200)
						--) AS J

						--SELECT ISNULL((
						--	SELECT TCKIMLIKNO,AD,SOYAD FROM #TMP_KurumIci
						--	FOR JSON AUTO, INCLUDE_NULL_VALUES
						--),'[]')					
					
					END
					--Temp table siliniyor
					DROP TABLE #TMP_DisOgrenci;
				END
			END

		END

	END TRY

	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH
 
END
GO
PRINT N'Altering [dbo].[sp_DSNetPuanOrtalamalariOS]...';


GO
ALTER procedure [dbo].[sp_DSNetPuanOrtalamalariOS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@DONEM				char(4)			= NULL,
	@ID_MENU			INT				= 0,
	@ID_KADEME3			INT				= 0,
	@ID_SINAVTURU		INT				= 0,
	@ID_SINAV			INT				= 0,
	@ID_DERS			INT				= 0,
	@ID_SUBE			INT				= 0,
	@ID_SINIF			INT				= 0,
	@ID_SINAVDOSYA		int				= 0,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= '[]',
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,DONEM						= @DONEM			
			,ID_MENU					= @ID_MENU		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@DONEM='2017',@ID_SINAVTURU=6,@ID_KADEME3=17,@ID_SINAVs='[0,168,158,160,145,70,78,144,143,67,69]',@ID_SUBEs='[427,11]',@ID_SINIFS='[0,104795,102205,102206,101684,101674,101675,101673,101681,102311]',@ID_DERSs='[914,977,978,980,981,1016,1047,1051]'

BEGIN TRY   

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END

	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	SINIF	
		BEGIN
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SIRALAMA_SINIF

			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[163]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 3
			--		,@ID_KADEME3	INT			= 18

			IF @ID_SINAVs<>'[]'  AND @ID_SINAVTURU = 0
			BEGIN
				SELECT @ID_SINAVTURU = ID_SINAVTURU FROM Sinav WHERE ID_SINAV=@ID_SINAV
			END
			IF @ID_SINAVs<>'[]' AND @ID_KADEME3=0
			BEGIN
				SET @ID_KADEME3= (SELECT TOP 1 ID_KADEME3 FROM Sinav WHERE ID_SINAV IN ((SELECT VALUE FROM OPENJSON(@ID_SINAVs))))
			END 


			SELECT S.ID_SINAV, SO.TCKIMLIKNO, ID_SINIF, VD.ID_DERS, SD.BOLUMNO, SD.TAKMAAD DERSAD, NET, DOGRU, YANLIS, BOS
					, O.ID_SUBE
			INTO	#TEMP_SINIFGENEL	FROM Sinav	S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS 			
			JOIN	eokul_v2.DBO.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
																AND (
																	VD.DERSAD IN (SELECT D.DERSAD FROM eokul_v2.DBO.Ders D WHERE D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSs)))
																	OR @ID_DERSs = '[]'
																	)
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				--AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs)) OR @ID_SUBEs='[]' OR @ID_SUBEs='[0]')
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))




			SELECT * INTO #TEMP_SINIF FROM #TEMP_SINIFGENEL WHERE (ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs)) OR @ID_SUBEs='[]' OR @ID_SUBEs='[0]') 



			SELECT ID_DERS, DERSAD, BOLUMNO, ID_SINIF, ID_SUBE, ID_SINAV, NETORT = CAST(AVG(NET) AS DECIMAL(8,2)), SINIFKATILIM = COUNT(NET), SORUSAYISI= 0
			INTO #SINIFGENEL FROM #TEMP_SINIFGENEL
			GROUP BY ID_DERS, BOLUMNO, DERSAD, ID_SINIF, ID_SUBE, ID_SINAV
			
			SELECT	 S.*
					,GENELSIRA	= DENSE_RANK() OVER(PARTITION BY BOLUMNO			ORDER BY NETORT DESC) 
			INTO #SIRALAMA_GENEL FROM #SINIFGENEL	S




			SELECT ID_DERS, DERSAD, BOLUMNO, ID_SINIF, ID_SUBE, ID_SINAV, NETORT = CAST(AVG(NET) AS DECIMAL(8,2)), SINIFKATILIM = COUNT(NET), SORUSAYISI= 0
			INTO #SINIF FROM #TEMP_SINIF
			GROUP BY ID_DERS, BOLUMNO, DERSAD, ID_SINIF, ID_SUBE, ID_SINAV
			
			UPDATE	S 
			SET		S.SORUSAYISI=J.SORUSAYISI
			FROM	#SINIF AS S
			JOIN (
			SELECT ID_DERS,AVG(DOGRU+YANLIS+BOS) SORUSAYISI, BOLUMNO  FROM #TEMP_SINIF GROUP BY ID_DERS, BOLUMNO)  J ON J.ID_DERS=S.ID_DERS AND J.BOLUMNO = S.BOLUMNO

			SELECT	 S.*
					,SUBESIRA	= DENSE_RANK() OVER(PARTITION BY S.BOLUMNO,S.ID_SUBE	ORDER BY S.NETORT DESC) 
					,SG.GENELSIRA
			INTO #SIRALAMA_SINIF FROM #SINIF	S 
			JOIN #SIRALAMA_GENEL SG ON SG.BOLUMNO = S.BOLUMNO AND SG.ID_SINIF = S.ID_SINIF



			DECLARE @ID_EGITIMTURU VARCHAR(15)=
				CASE	WHEN @ID_SINAVTURU = 2 THEN 7
						WHEN @ID_SINAVTURU = 3 THEN 8
						WHEN @ID_SINAVTURU = 6 THEN 9
						ELSE @ID_SINAVTURU 
				END 


			SELECT	 SS.*					
					,SINAVTARIH	= CONVERT(VARCHAR,S.SINAVTARIH,103) 
					,SINAVAD	= S.AD
					,KADEME3	= UPPER(K3.AD)
					,SUBEAD		= SU.AD 
					,SINIFAD	= SN.AD					
					,ADSOYAD	= (
									SELECT TOP 1
										K.AD +' '+ K.SOYAD 
									FROM v3Kullanici						K
									INNER JOIN eokul_v2.dbo.DersOgretmen	DO	ON		DO.ID_SINIF		= SS.ID_SINIF
																					AND DO.ID_DERS		= SS.ID_DERS
																					AND DO.ID_EGITIMTURU= @ID_EGITIMTURU--S.ID_SINAVTURU
																					AND DO.DONEMKOD		= @DONEM
																					AND DO.TC_OGRETMEN	= K.TCKIMLIKNO
									)
			FROM		#SIRALAMA_SINIF SS
			JOIN		v3Sube						SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= SS.ID_SUBE
			JOIN		v3Sinif						SN	WITH (NOLOCK)	ON	SN.ID_SINIF			= SS.ID_SINIF
			JOIN		Sinav						S	WITH (NOLOCK)	ON	S.ID_SINAV			= SS.ID_SINAV
			JOIN		v3Kademe3					K3	WITH (NOLOCK)	ON	K3.ID_KADEME3		= S.ID_KADEME3
			ORDER BY	BOLUMNO,GENELSIRA,SUBESIRA


			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP_SINIFGENEL
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SIRALAMA_SINIF
			DROP TABLE IF EXISTS #SIRALAMA_GENEL
		END
		IF @ISLEM = 2	--	OKUL	
		BEGIN
			
			DROP TABLE IF EXISTS #SinavList
			DROP TABLE IF EXISTS ##GenelOrt 
			DROP TABLE IF EXISTS ##pivots
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Net

			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[427,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[163]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 3
			--		,@ID_KADEME3	INT			= 18

			IF @ID_SINAVs<>'[]' AND @ID_KADEME3=0
			BEGIN
				SET @ID_KADEME3= (SELECT TOP 1 ID_KADEME3 FROM Sinav WHERE ID_SINAV IN ((SELECT VALUE FROM OPENJSON(@ID_SINAVs))))
			END 

			SELECT DISTINCT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,ID_SINIF,VD.ID_DERS,SD.BOLUMNO,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OS.PUAN,OS.ID_SINAVPUANTURU,PT.AD PUANTURU
			INTO	#Temp
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
	   LEFT JOIN	SinavOgrenciPuan		OS	WITH (NOLOCK)	ON	OS.ID_SINAV			= SO.ID_SINAV
																AND OS.TCKIMLIKNO		= SO.TCKIMLIKNO
	   LEFT JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = OS.ID_SINAVPUANTURU
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.DBO.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs)) OR @ID_SUBEs='[]' OR @ID_SUBEs='[]')
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
				--AND PT.ID_SINAVTURU	= @ID_SINAVTURU
				--AND S.ID_KADEME3	= @ID_KADEME3

			--SELECT * FROM #Temp

			SELECT ID_SINAV,SINAVAD,PUANTURU,SINAVTARIH,ID_SUBE,SUBEAD, TCKIMLIKNO, PUAN
			INTO #Temp2
			FROM #Temp	T
			WHERE T.ID_SINAVPUANTURU IS NOT NULL
			GROUP BY ID_SINAV,SINAVAD,PUANTURU,SINAVTARIH,ID_SUBE,SUBEAD, TCKIMLIKNO, PUAN


				SELECT ID_SINAV,SINAVAD,ID_DERS,BOLUMNO,DERSAD,SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD
				INTO #Net FROM #Temp	T
				GROUP BY ID_DERS,BOLUMNO,ID_SINAV,SINAVTARIH,SINAVAD,DERSAD,ID_SUBE,SUBEAD

			
		INSERT INTO #Net			
			--SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD
			--FROM #Net	T
			--GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD

			--UNION ALL 
				SELECT ID_SINAV,SINAVAD,0,999,'TOPLAM',SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS,
				--CAST(AVG(NET) AS DECIMAL(8,2)) NET 
				NET = (SELECT CAST(AVG(TN) AS DECIMAL(8,2)) NET FROM SinavOgrenciToplam S JOIN OkyanusDB.DBO.vw_OgrenciDetayTum D ON D.TCKIMLIKNO = S.TCKIMLIKNO WHERE D.ID_SUBE = T.ID_SUBE AND S.ID_SINAV = T.ID_SINAV)
				,ID_SUBE,SUBEAD
				FROM #Temp	T
				GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD
			UNION ALL 
				SELECT ID_SINAV,SINAVAD,-1,1000,PUANTURU,SINAVTARIH,0 AS TS, CAST(AVG(PUAN) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD
				FROM #Temp2	T
				GROUP BY ID_SINAV,SINAVTARIH,PUANTURU,SINAVAD,ID_SUBE,SUBEAD


			Declare @SQL as varchar(max)
			Declare @Columns as varchar(max)
			Declare @Columns2 as varchar(max)
			Declare @Columns3 as varchar(max)

				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
				from 
					( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
				order by b.SINAVTARIH


				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
				from 
					( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
				order by b.SINAVTARIH

				Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst(CASE WHEN  '+QUOTENAME(SINAVAD)+' = ''-'' THEN NULL ELSE '+QUOTENAME(SINAVAD)+' END AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
				from 
					( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
				order by b.SINAVTARIH
		
				
			
			Set @SQL='	
				Select 								 
					--ID_SINAV,
					--SINAVTARIH,
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					DERSAD,
					BOLUMNO,
					-- TS,
					'+@Columns2+' 
				into ##pivots
				from (
					Select 
						SINAVAD,
						ID_SINAV,
						SINAVTARIH,
						ID_DERS,
						ID_SUBE,
						SUBEAD,
						DERSAD,
						BOLUMNO,
						-- TS,
						NET
					from #Net
				) AS S
				PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
				GROUP BY DERSAD,SUBEAD,ID_SUBE,ID_DERS,BOLUMNO			
	
				
				SELECT ID_DERS,BOLUMNO,DERSAD,'+@Columns3+'
				INTO ##GenelOrt
				FROM ##pivots 
				GROUP BY ID_DERS,BOLUMNO,DERSAD		
			'
			PRINT @SQL
			EXEC (@SQL)


			SELECT * FROM ##pivots 
			ORDER BY BOLUMNO


			SELECT * FROM ##GenelOrt ORDER BY BOLUMNO

			
			SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH , KADEME3 = UPPER(K3.AD)
			FROM dbo.fn_Split(@Columns,',',NULL) FN
			JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value
			JOIN v3Kademe3 K3 ON K3.ID_KADEME3=@ID_KADEME3

			SELECT DISTINCT ID_SUBE,SUBEAD FROM #Temp
			SELECT DISTINCT BOLUMNO,DERSAD FROM #Temp


			DROP TABLE IF EXISTS #SinavList
			DROP TABLE IF EXISTS ##GenelOrt 
			DROP TABLE IF EXISTS ##pivots
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Temp2
			DROP TABLE IF EXISTS #Net


							
		END
	

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_Etut]...';


GO
ALTER procedure [dbo].[sp_Etut]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= '',
	@OGRENCIDONEM		char(4)			= '',
	@AKTIFDONEM			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAVTURUS		VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@KOD				VARCHAR(MAX)	= '',
	@ETUT				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@SAAT				VARCHAR(MAX)	= NULL,
	@SURE				VARCHAR(MAX)	= NULL,	
	@YER				VARCHAR(MAX)	= NULL,	
	@ID_ETUTTURU		INT				= NULL,
	@TC_OGRENCIs		VARCHAR(MAX)	= NULL,		
	@KODs				VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ETUTJSON			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@KATILDI			BIT				= 0,
	@KATILACAK			BIT				= 0




	--ETUT,TARIH,SAAT,SURE,ID_SUBE,YER,ID_DERS,DONEM,AKTIF,KYE_TCKIMLIKNO,ID_KADEME3,TC_OGRETMEN,ID_ETUTTURU
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM				 	= @ISLEM			
			,TCKIMLIKNO			 	= @TCKIMLIKNO		
			,TC_OGRENCI			 	= @TC_OGRENCI		
			,TC_OGRETMEN		 	= @TC_OGRETMEN	
			,OTURUM				 	= @OTURUM			
			,ID_MENU			 	= @ID_MENU		
			,DONEM				 	= @DONEM			
			,OGRENCIDONEM		 	= @OGRENCIDONEM	
			,AKTIFDONEM			 	= @AKTIFDONEM		
			,ID_KADEME3			 	= @ID_KADEME3		
			,ID_SINAVTURU		 	= @ID_SINAVTURU	
			,ID_SINAVTURUS		 	= @ID_SINAVTURUS	
			,ID_SINAV			 	= @ID_SINAV		
			,ID_DERS			 	= @ID_DERS		
			,ID_SUBE			 	= @ID_SUBE		
			,ID_SINIF			 	= @ID_SINIF		
			,ID_SUBEs			 	= @ID_SUBEs		
			,ID_SINIFs			 	= @ID_SINIFs		
			,ID_DERSs			 	= @ID_DERSs		
			,ID_SINAVs			 	= @ID_SINAVs		
			,KOD				 	= @KOD			
			,ETUT				 	= @ETUT			
			,TARIH				 	= @TARIH			
			,SAAT				 	= @SAAT			
			,SURE				 	= @SURE			
			,YER				 	= @YER			
			,ID_ETUTTURU		 	= @ID_ETUTTURU	
			,TC_OGRENCIs		 	= @TC_OGRENCIs	
			,KODs				 	= @KODs			
			,DERSAD				 	= @DERSAD			
			,ETUTJSON			 	= @ETUTJSON		
			,ID_ETUT			 	= @ID_ETUT		
			,KATILDI			 	= @KATILDI		
			,KATILACAK			 	= @KATILACAK		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END


	IF @ID_LOG > 1
	BEGIN
		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		
		SELECT @AKTIFDONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		PRINT @DONEM
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
			PRINT @DONEM
		END

		IF @ISLEM = 1	--	PUSULAM SINAV					
		BEGIN
			-- SINAVLAR

			drop table if exists #temp4T
			drop table if exists #TEMPORTT
			drop table if exists #t1
			drop table if exists #t3
			drop table if exists #temp
			drop table if exists #temp3
			drop table if exists #temp4
			drop table if exists #TEMPORT
			drop table if exists #TEMPORTS
			drop table if exists #tempY2
			drop table if exists #ttemp
			drop table if exists #ttemp3
			drop table if exists #TTEMPORTS
			--drop table if exists #UNITE

		
			SELECT 
				 S.ID_SINAV AS ID_SINAVBILGI
				,S.AD		AS ACIKLAMA
				,D.DERSAD	AS DERSAD
				,D.ID_DERS
				,SUBSTRING(V.KOD,1,6) AS UNITEKOD
				,SUBSTRING(V.KOD,1,9) AS KONUKOD
				,V.DURUM
			INTO #LISTEOGRENCI
			FROM  vw_SinavOgrenciSoru	V
			JOIN Sinav					S	ON	S.ID_SINAV		= V.ID_SINAV	
			JOIN v3OgrenciTUM			O	ON O.TCKIMLIKNO		= V.TCKIMLIKNO
			JOIN v3SinifTum				ST	ON ST.ID_SINIF		= O.ID_SINIF AND ST.DONEM = O.DONEM
			JOIN SinavDers				SD	ON	SD.ID_SINAVDERS	= V.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= SD.ID_DERS 
			JOIN eokul_v2.dbo.Ders		D2	ON	D2.DERSAD		= D.DERSAD	
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND (S.OZEL=0 OR @OZELSINAVGOR=1)
				AND S.DONEM			= @DONEM
				AND (D2.ID_DERS		IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs	= '[]' OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs)) )
				AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
				AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR (@ID_SINIFs	= '[]') AND O.DONEM = @AKTIFDONEM)
				AND (S.ID_SINAV		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))		)


			SELECT ID_SINAVBILGI
				,ACIKLAMA
				,ID_DERS
				,DERSAD
				,KOD=KONUKOD
				,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=UNITEKOD),'-') AS UNITE
				,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=KONUKOD ),'-') AS KONU
				,SUM(CASE WHEN DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
				,SUM(1) AS KONUSAYISI
			INTO #ttemp
			FROM #LISTEOGRENCI
			GROUP BY ID_SINAVBILGI , ACIKLAMA,DERSAD ,KONUKOD ,UNITEKOD, ID_DERS

			Select t2.ID_SINAVBILGI,  
					t2.ACIKLAMA,
					t2.DERSAD,
					ID_DERS,
					t2.KOD,
					t2.UNITE,
					t2.KONU,
					t2.KONUSAYISI,
					t2.DOGRUSAYISI,
					(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
			into #ttemp3
			from #ttemp t2
		order by t2.ID_SINAVBILGI,t2.KOD


			Select KOD,
					SUM(KONUSAYISI) as KONUSAYISI,
					SUM(DOGRUSAYISI) as DOGRUSAYISI
			into #TTEMPORTS
			from #ttemp3 
		group by KOD

			Select KOD,
					(Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
			into #TEMPORTT
			from #TTEMPORTS 


			Select t3.ID_SINAVBILGI,  
					t3.ACIKLAMA,
					t3.DERSAD,ID_DERS,
					t3.KOD,
					t3.UNITE,
					t3.KONU,
					--t3.KAZANIM,
					'%' + Cast(t3.YUZDE as varchar) as YUZDE
			into #temp4T
			from #ttemp3 t3
		order by t3.ID_SINAVBILGI,t3.KOD,t3.DERSAD

	  
		
			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
			from
			(
			Select distinct 
					ACIKLAMA,
					ID_SINAVBILGI	
				from #temp4T --order by ID_SINAVBILGI
			) as b
			order by b.ID_SINAVBILGI

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
			from
			(
			Select distinct 
					ACIKLAMA,
					ID_SINAVBILGI
				from #temp4T --order by ID_SINAVBILGI
			) as b
			order by b.ID_SINAVBILGI

		  declare @k int = (Select COUNT(1) from #temp4T)
		  print (@k)
		   
				if (Select COUNT(1) from #temp4T)>0
				begin
					drop table if exists ##pivotS
					drop table if exists ##TT
						Set @SQL='
							Select  DERSAD,ID_DERS, KOD, UNITE, KONU, '+@Columns2+' 
							into ##pivotS 
							from ( Select  ACIKLAMA, DERSAD,ID_DERS, KOD, KONU, YUZDE, UNITE from #temp4T ) AS PivotData
							PIVOT ( MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+') ) as PivotResult
							ORDER BY DERSAD,KOD

							SELECT * 
							INTO ##TT
							FROM ##pivotS
							GROUP BY DERSAD,ID_DERS,KOD,UNITE,KONU,'+@Columns+'
							'
							PRINT @SQL
							EXECute (@SQL)
						
		
			

				Select  p.*,ORTALAMA =  '%'+ Cast( CAST(
														(SELECT top 1 ORTALAMA FROM #TEMPORTT WHERE KOD = p.KOD)
												AS DECIMAL(10,2)) as varchar(10))
				INTO #t3 from ##TT p
				
				
		
			select(
				select * from(
					select 
					(					
						SELECT * FROM #t3
						FOR JSON AUTO
					) as TblListe,
					(					
						Select distinct  ACIKLAMA AS SINAVAD, ID_SINAVBILGI AS ID_SINAV from #temp4T
						FOR JSON AUTO
					) as TblSinav
				) as tablo FOR JSON AUTO
			) as tt

			END



			else 
			begin
			SELECT bos=null
						FOR JSON PATH
			--	select(
			--	select * from(
			--		select 
			--		(					
			--			SELECT bos=null
			--			FOR JSON PATH
			--		) as TblListe,
			--		(					
			--			Select bos=null
			--			FOR JSON PATH
			--		) as TblSinav
			--	) as tablo FOR JSON PATH
			--) as tt
			end 
			
			drop table if exists #temp4T
			drop table if exists #TEMPORTT
			drop table if exists #t1
			drop table if exists #t3
			drop table if exists #temp
			drop table if exists #temp3
			drop table if exists #temp4
			drop table if exists #TEMPORT
			drop table if exists #TEMPORTS
			drop table if exists #tempY2
			drop table if exists #ttemp
			drop table if exists #ttemp3
			drop table if exists #TTEMPORTS
			drop table if exists #LISTEOGRENCI

		END

		IF @ISLEM = 2	--	YAZILI YOKLAMA					
		BEGIN
			BEGIN
				drop table IF EXISTS ##pivotYY
				drop table IF EXISTS #TblYY
				drop table IF EXISTS #tempYY1
				drop table IF EXISTS #tempYY
				drop table IF EXISTS #tempYYOrt
				drop table IF EXISTS #tempPivot



					SELECT   Y.ID_YAZILI							AS ID_SINAVRAPOR		
							,Y.AD									AS ACIKLAMA
							,Y.ID_DERS
							,D.DERSAD								AS DERSAD
							,YS.KOD			
							,ISNULL((SELECT AD FROM OkyanusDB.dbo.v3SinavDersUnite SUBSDU WHERE SUBSDU.KOD = SUBSTRING(SDU.KOD, 1, 9)), '')	AS KONU
							,SDU.AD									AS KAZANIM	
							,SUM(YS.PUAN)							AS PUANDEGERI
							,ISNULL(YO.TELAFI, Sum(YOC.PUAN))		AS PUAN 
					INTO #tempYYX
					FROM Yazili				Y 
					JOIN YaziliSoru			YS	ON	YS.ID_YAZILI			= Y.ID_YAZILI
					JOIN YaziliOgrenci		YO	ON	YO.ID_YAZILI			= Y.ID_YAZILI
					JOIN YaziliOgrenciCevap YOC ON	YOC.ID_YAZILIOGRENCI	= YO.ID_YAZILIOGRENCI 
												AND YOC.ID_YAZILISORU		= YS.ID_YAZILISORU
					JOIN v3OgrenciTum		O	ON	O.TCKIMLIKNO			= YO.TCKIMLIKNO 
					JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS				= Y.ID_DERS
												AND D.ID_KADEME3			= Y.ID_KADEME3
					JOIN eokul_v2.dbo.Ders	D2	ON	D2.DERSAD				= D.DERSAD
					JOIN v3SinavDersUnite	SDU ON	SDU.KOD					= YS.KOD
					WHERE		Y.DONEM		= @DONEM 
							AND O.DONEM		= @OGRENCIDONEM
							AND Y.AKTIF		= 1 
							AND YO.AKTIF	= 1
							AND ( ( D2.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSs)) )		OR @ID_DERSs = ''  OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))) 
							AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFs)) )		OR @ID_SINIFs = '' ) 
					GROUP BY	Y.ID_YAZILI	
								,Y.AD		
								,Y.ID_DERS
								,D.DERSAD		
								,YS.KOD			
								,SDU.AD	
								,YO.TELAFI
								,SDU.KOD

					SELECT ID_SINAVRAPOR, ACIKLAMA, ID_DERS, DERSAD, KOD, KONU, KAZANIM, SUM(PUANDEGERI) AS PUANDEGERI, SUM(PUAN) AS PUAN 
					INTO #tempYY
					FROM #tempYYX
					GROUP BY ID_SINAVRAPOR, ACIKLAMA, ID_DERS, DERSAD, KOD, KONU, KAZANIM

					DROP TABLE #tempYYX

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/Convert(decimal(8,2),t.PUANDEGERI))*100.0) as YUZDE
					  into #tempYY1
					  from #tempYY t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   '%'+ CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/Convert(decimal(8,2),t.PUANDEGERI))*100.0) AS varchar(10))as YUZDE
					  into #tempPivot
					  from #tempYY t

					  Select KOD,
							 ID_DERS,
							 Convert(decimal(8,2),AVG(YUZDE)) as ORTALAMA
						into #tempYYOrt
						from #tempYY1
					group by KOD,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR	
						  from #tempYY1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR
						  from #tempYY1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR
		   
		  
					 -- IF EXISTS (SELECT TOP 1 * FROM #tempPivot)
					  BEGIN
						  Set @SQL='
									Select  ID_DERS, DERSAD, KONU,KAZANIM, KOD, '+@Columns2+'
									into ##pivotYY
									from ( Select ACIKLAMA, ID_DERS, DERSAD, KONU,KAZANIM, KOD, YUZDE from #tempPivot ) as PivotData
									PIVOT (MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+')) as PivotResult
									ORDER BY KONU
						   '
						   PRINT @SQL
						   EXEC (@SQL)
					   END
					  -- ELSE
					  -- BEGIN
							--Select ID_DERS=NULL, DERSAD=NULL, KONU=NULL, KOD=NULL into ##pivotYY 
					  -- END


					    Select p.*,
							  ORTALAMA = '%'+CAST(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #tempYYOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD)) AS VARCHAR)
						INTO #TblYY from ##pivotYY p

			
						--SELECT * FROM	#TblYY 
	
	
			END
		
			select(
				select * from(
					select 
					(					
						SELECT * FROM #TblYY
						FOR JSON AUTO
					) as TblListe,
					(					
						Select distinct  ACIKLAMA AS SINAVAD, ID_SINAVRAPOR AS ID_SINAV from #tempYY1
						FOR JSON AUTO
					) as TblSinav
				) as tablo FOR JSON AUTO
			) as tt

			
			drop table IF EXISTS ##pivotYY
			drop table IF EXISTS #TblYY
			drop table IF EXISTS #tempYY1
			drop table IF EXISTS #tempYY
			drop table IF EXISTS #tempYYOrt
			drop table IF EXISTS #tempPivot
		END 

		IF @ISLEM = 3	--	SINAV TURU						
		BEGIN 
			

				DECLARE @DONEMFARKI INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
				IF  (@DONEMFARKI<>0) 
				BEGIN
					DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
					SELECT @ID_KADEME3=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
				END

			

			select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
			INTO #GrupSinavTuru 
			from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
		union 
			select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
		union 
			select 0,15 , 'YAZILI', 'YAZ'
		union 
			select 0,16 , 'YAZILI', 'YAZ'
		union 
			select 0,17 , 'YAZILI', 'YAZ'
		union 
			select 0,18 , 'YAZILI', 'YAZ'


			
			IF EXISTS (SELECT TOP 1 1 FROM #GrupSinavTuru WHERE ID_KADEME3=@ID_KADEME3)
			BEGIN
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	= @ID_KADEME3	--in (SELECT VALUE FROM OPENJSON(@ID_KADEME3)) 
			END
			ELSE
			BEGIN
				SELECT 0 ID_SINAVTURU,@ID_KADEME3 ,'YAZILI' AD, 'YAZ' KISAAD
				UNION ALL 
				select DISTINCT ST.ID_SINAVTURU,@ID_KADEME3 , ST.AD, ST.KISAAD
				from SinavTuru		ST
				JOIN Sinav			S	ON	S.ID_SINAVTURU	= ST.ID_SINAVTURU
				JOIN v3KademeBilgi	KB	ON	KB.ID_KADEME3	= S.ID_KADEME3
				WHERE	KB.ID_KADEME= 4
					AND	S.AKTIF		= 1
					AND S.DURUM		= 2
			END

			drop table #GrupSinavTuru
		END

		IF @ISLEM = 4	--  SınavTürü Derslerini Listele	
		BEGIN	
			IF @ID_SINAVTURUS IS NULL
			BEGIN
				IF @ID_SINAVTURU = 0 
				BEGIN
					select(
						select * from(
							select 
							(
								SELECT DISTINCT 
									 D.ID_DERS
									,D.DERSAD	AS AD
									,D.ID_DERS	AS ID
								FROM Yazili								Y
								JOIN YaziliOgrenci						YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI
																			AND YO.AKTIF		= 1
								JOIN v3OgrenciTum						O	ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
								JOIN v3SinifTum							S	ON	S.ID_SINIF		= O.ID_SINIF
																			AND S.DONEM			= O.DONEM
								JOIN eokul_v2.dbo.Ders					D	ON	D.ID_DERS		= Y.ID_DERS
																			AND D.ID_KADEME3	= Y.ID_KADEME3
								WHERE	O.ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))
									AND Y.DONEM = @DONEM
									--AND O.DONEM	= @OGRENCIDONEM
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				
				END
				ELSE 
				BEGIN				
					DECLARE @DONEMFARKI2 INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
					IF  (@DONEMFARKI2<>0) 
					BEGIN
						DECLARE @SIRA2 INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
						SELECT @ID_KADEME3=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA2- @DONEMFARKI2
					END
					select(
						select * from(
							select 
							(
								SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
								FROM	SinavDers			SD	
								JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV							
								JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS
																AND D.ID_KADEME3= S.ID_KADEME3 
								WHERE	S.ID_SINAVTURU	= @ID_SINAVTURU 
									AND S.ID_KADEME3	= @ID_KADEME3
								FOR JSON AUTO
							) as t1								
						) as tablo FOR JSON AUTO
					) as tt
				END
			END
			ELSE 
			BEGIN
				DECLARE @DONEMFARKI3 INT = CAST(@OGRENCIDONEM AS INT ) - CAST (@DONEM AS INT)
				IF  (@DONEMFARKI3<>0) 
				BEGIN
					DECLARE @SIRA3 INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
					SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA3- @DONEMFARKI3
				END

				select(
					select * from(
						select 
						(
							SELECT DISTINCT	D.ID_DERS,D.DERSAD AD,D.ID_DERS ID
							FROM	SinavDers			SD	
							JOIN	Sinav				S	ON	S.ID_SINAV	= SD.ID_SINAV							
							JOIN	eokul_v2.dbo.Ders	D	ON  D.ID_DERS	= SD.ID_DERS
															AND D.ID_KADEME3= S.ID_KADEME3 
							WHERE (S.ID_SINAVTURU IN (SELECT value FROM OPENJSON  ( @ID_SINAVTURUS)))
								AND S.ID_KADEME3	= @ID_KADEME3
							FOR JSON AUTO
						) as t1								
					) as tablo FOR JSON AUTO
				) as tt
			END
		END 

		IF @ISLEM = 5	--	Etüt Sınav						
		BEGIN
						drop table if exists #TempOgr
						drop table if exists #TempOgr2
						drop table if exists #TempOgr3
						drop table if exists #TempOgrOrt
						drop table if exists #TempOgrOrt2
						drop table if exists #TblOgr
						--drop table if exists #UNITEKOD



		
						SELECT
							 S.ID_SINAV AS ID_SINAVBILGI
							,SO.TCKIMLIKNO
							,SO.AD + ' '+ SO.SOYAD ADSOYAD
							,O.ID_SINIF
							,S.AD AS ACIKLAMA
							,D.DERSAD AS DERSAD
							,D.ID_DERS
							,SUBSTRING(SA.KOD,1,9) AS KOD
							--,SA.KOD AS KOD
							,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=SUBSTRING(SA.KOD,1,6)),'-') AS UNITE
							,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=SUBSTRING(SA.KOD,1,9)),'-') AS KONU
							--,ISNULL((SELECT TOP 1 AD FROM v3SinavDersUnite U WHERE U.KOD=SUBSTRING(SA.KOD,1,12)),'-') AS KAZANIM
							,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
							,SUM(1) AS KONUSAYISI
						INTO #TempOgr
						FROM	   [Pusulam].dbo.Sinav S
						INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK)ON SO.ID_SINAV=S.ID_SINAV
						INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3SinifTum ST ON ST.ID_SINIF = O.ID_SINIF AND ST.DONEM = O.DONEM
						INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
						INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
						INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
						INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
						INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=SD.ID_DERS
						INNER JOIN eokul_v2.dbo.Ders D2 ON D2.DERSAD=D.DERSAD
						INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
						WHERE		S.AKTIF			= 1
								AND S.DURUM			= 2
								AND (OZEL=0 OR @OZELSINAVGOR=1)
								--AND S.ID_SINAVTURU	= @ID_SINAVTURU
								--AND S.ID_KADEME3	= @ID_KADEME3
								AND S.DONEM			= @DONEM
								AND (D2.ID_DERS		IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs	= '[]' OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs)))
								AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
								AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
								AND (S.ID_SINAV		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))		OR @ID_SINAVs	= '[]')
								AND SUBSTRING(SA.KOD,1,9)=@KOD
						GROUP BY S.ID_SINAV ,S.AD ,D.DERSAD ,SA.KOD,D.ID_DERS,SO.TCKIMLIKNO,SO.AD,SO.SOYAD,O.ID_SINIF
						ORDER BY S.ID_SINAV,SA.KOD

						--SELECT * FROM #TempOgr


					  Select t2.ID_SINAVBILGI,  
							 t2.ACIKLAMA,
							 t2.DERSAD,
							 t2.KOD,
							 t2.UNITE,
							 t2.KONU,
							 TCKIMLIKNO,ADSOYAD,ID_SINIF,
							 t2.KONUSAYISI,
							 t2.DOGRUSAYISI,
							(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
						into #TempOgr2
						from #TempOgr t2
					order by t2.ID_SINAVBILGI,t2.KOD


					  Select KOD,
							 TCKIMLIKNO,
							 SUM(KONUSAYISI) as KONUSAYISI,
							 SUM(DOGRUSAYISI) as DOGRUSAYISI
						into #TempOgrOrt2
						from #TempOgr2 
					group by KOD,TCKIMLIKNO

					  Select KOD,TCKIMLIKNO,
							 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
						into #TempOgrOrt
						from #TempOgrOrt2 


					  Select t3.ID_SINAVBILGI,  
							 t3.ACIKLAMA,
							 t3.DERSAD,
							 t3.KOD,
							 t3.UNITE,
							 t3.KONU,
							 TCKIMLIKNO,ADSOYAD,ID_SINIF,
							 '%' + Cast(t3.YUZDE as varchar) as YUZDE
						into #TempOgr3
						from #TempOgr2 t3
					order by t3.ID_SINAVBILGI,t3.KOD,t3.DERSAD

	  
		
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVBILGI	
						  from #TempOgr3 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVBILGI

					  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVBILGI
						  from #TempOgr3 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVBILGI
		  
		  
		   
		   
				begin
					drop table if exists ##TempOgrPivot
					drop table if exists ##TblOgr
						Set @SQL='
							Select  DERSAD, KOD, UNITE, KONU,TCKIMLIKNO,ADSOYAD,ID_SINIF, '+@Columns2+' 
							into ##TempOgrPivot 
							from ( Select  ACIKLAMA, DERSAD, KOD, KONU, YUZDE,TCKIMLIKNO,ADSOYAD,ID_SINIF, UNITE from #TempOgr3 ) AS PivotData
							PIVOT ( MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+') ) as PivotResult
							ORDER BY DERSAD,KOD--,UNITE

							SELECT * 
							INTO ##TblOgr
							FROM ##TempOgrPivot
							GROUP BY DERSAD,KOD,UNITE,KONU,TCKIMLIKNO,ADSOYAD,ID_SINIF,'+@Columns+'
							'
							PRINT @SQL
							EXECute (@SQL)
				END
		


				Select  p.*
							,ORT=(SELECT ORTALAMA FROM #TempOgrOrt WHERE KOD = p.KOD AND TCKIMLIKNO=P.TCKIMLIKNO)
							,ORTALAMA =  '%'+ Cast( CAST(
														(SELECT ORTALAMA FROM #TempOgrOrt WHERE KOD = p.KOD AND TCKIMLIKNO=P.TCKIMLIKNO)
												AS DECIMAL(10,2)) as varchar(10))
				INTO #TblOgr from ##TblOgr p
				
				select(
							select * from(
								select 
								(					
									SELECT * FROM #TblOgr
									FOR JSON AUTO
								) as TblListeOgr												
							) as tablo FOR JSON AUTO
						) as tt

				drop table if exists #TempOgr
				drop table if exists #TempOgr2
				drop table if exists #TempOgr3
				drop table if exists #TempOgrOrt
				drop table if exists #TempOgrOrt2
				drop table if exists #TblOgr

				--drop table if exists #UNITEKOD
				drop table if exists ##TempOgrPivot 
				drop table if exists ##TblOgr
		END		

		IF @ISLEM = 6	--	Etüt Yazılı						
		BEGIN
			BEGIN
				drop table IF EXISTS ##pivotYYOgr
				drop table IF EXISTS #TblYYOgr
				drop table IF EXISTS #tempYYOgr1
				drop table IF EXISTS #tempYYOgr
				drop table IF EXISTS #tempYYOgrOrt
				drop table IF EXISTS #tempPivotOgr


		--DECLARE  @DONEM VARCHAR(MAX)='2017'
		--		,@ID_DERSs VARCHAR(MAX)='[850,852,1046]'
		--		,@ID_SUBEs VARCHAR(MAX)='[11]'
		--		,@ID_SINIFs VARCHAR(MAX)='[]'
		--		,@ID_SINAVTURU INT=2
		--		,@ID_KADEME3 INT=18

					SELECT  Y.ID_YAZILI								AS ID_SINAVRAPOR		
							,Y.AD									AS ACIKLAMA
							,YO.TCKIMLIKNO
							,O.ID_SINIF
							,K.AD + ' ' + K.SOYAD					AS ADSOYAD
							,Y.ID_DERS
							,D.DERSAD									AS DERSAD
							,YS.KOD			
							,ISNULL((SELECT AD FROM OkyanusDB.dbo.v3SinavDersUnite SUBSDU WHERE SUBSDU.KOD = SUBSTRING(SDU.KOD, 1, 9)), '')	AS KONU
							,SDU.AD									AS KAZANIM	
							,SUM(YS.PUAN)							AS PUANDEGERI
							,ISNULL(YO.TELAFI, Sum(YOC.PUAN))		AS PUAN 
					INTO #tempYYOgr
					FROM Yazili Y 
					INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
					INNER JOIN V3SinifTum S ON S.ID_SINIF=O.ID_SINIF AND S.DONEM=O.DONEM
					INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=Y.ID_DERS
					INNER JOIN eokul_v2.dbo.Ders D2 ON D2.DERSAD=D.DERSAD
					INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
					WHERE		Y.DONEM = @DONEM AND Y.AKTIF = 1 AND YO.AKTIF = 1
								AND ( ( D2.ID_DERS		IN (SELECT VALUE FROM Openjson (@ID_DERSs)) )		OR @ID_DERSs = ''  OR 0 IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))) 
								AND (O.ID_SUBE			IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))			OR @ID_SUBEs	= '[]')
								AND ( ( O.ID_SINIF		IN (SELECT VALUE FROM Openjson (@ID_SINIFs)) )		OR @ID_SINIFs = '' ) 
								AND (Y.ID_YAZILI		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))			OR @ID_SINAVs	= '[]')
								AND SDU.KOD = @KOD
								--AND O.DONEM = @OGRENCIDONEM
					GROUP BY	Y.ID_YAZILI	
								,Y.AD	
								,YO.TCKIMLIKNO
								,O.ID_SINIF
								,K.AD + ' ' + K.SOYAD	
								,Y.ID_DERS
								,D.DERSAD		
								,YS.KOD			
								,SDU.AD	
								,SDU.KOD
								,YO.TELAFI

					
								--AND (D.ID_DERS		IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs	= '[]')
								--AND (O.ID_SUBE		IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs	= '[]')
								--AND (O.ID_SINIF		IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs))		OR @ID_SINIFs	= '[]')
								--AND (S.ID_SINAV		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))		OR @ID_SINAVs	= '[]')
								--AND SUBSTRING(SA.KOD,1,9)=@KOD


					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   TCKIMLIKNO,ADSOYAD,ID_SINIF,
						   t.ID_DERS,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempYYOgr1
					  from #tempYYOgr t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   TCKIMLIKNO,ADSOYAD,ID_SINIF,
						   t.DERSAD,
						   t.KAZANIM,
						   t.KONU,
						   t.KOD,
						   '%'+ CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempPivotOgr
					  from #tempYYOgr t

					  Select KOD,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
							 ,TCKIMLIKNO
						into #tempYYOgrOrt
						from #tempYYOgr1
					--group by KOD,ID_DERS
					group by KOD,ID_DERS,TCKIMLIKNO

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR	
						  from #tempYYOgr1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,
							   ID_SINAVRAPOR
						  from #tempYYOgr1 --order by ID_SINAVBILGI
					  ) as b
					  order by b.ID_SINAVRAPOR
		   
		  
					 -- IF EXISTS (SELECT TOP 1 * FROM #tempPivotOgr)
					  BEGIN
						  Set @SQL='
									Select  ID_DERS,TCKIMLIKNO,ADSOYAD, DERSAD, KONU UNITE,KAZANIM KONU,ID_SINIF, KOD, '+@Columns2+'
									into ##pivotYYOgr
									from ( Select ACIKLAMA, ID_DERS,TCKIMLIKNO,ID_SINIF,ADSOYAD, DERSAD, KONU,KAZANIM, KOD, YUZDE from #tempPivotOgr ) as PivotData
									PIVOT (MAX(YUZDE) FOR ACIKLAMA IN('+@Columns+')) as PivotResult
									ORDER BY KONU
						   '
						   PRINT @SQL
						   EXEC (@SQL)
					   END
					  -- ELSE
					  -- BEGIN
							--Select ID_DERS=NULL, DERSAD=NULL, KONU=NULL, KOD=NULL into ##pivotYYOgr 
					  -- END


					    Select	 p.*							
								,ORT		= (SELECT avg(ORTALAMA) FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD and p.TCKIMLIKNO=TCKIMLIKNO)
								,ORTALAMA	= '%'+CAST(CONVERT(DECIMAL(10,2),(SELECT avg(ORTALAMA) FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD and p.TCKIMLIKNO=TCKIMLIKNO)) AS VARCHAR)
							--,ORT=(SELECT ORTALAMA FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD)
							--,ORTALAMA = '%'+CAST(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #tempYYOgrOrt WHERE ID_DERS = p.ID_DERS AND KOD = p.KOD)) AS VARCHAR)
						INTO #TblYYOgr from ##pivotYYOgr p

			
						--SELECT * FROM	#TblYYOgr 
	
	
			END
		--SELECT * FROM #TblYYOgr
		--Select distinct  ACIKLAMA AS SINAVAD, ID_SINAVRAPOR AS ID_SINAV from #tempYYOgr1
			select(
				select * from(
					select 
					(					
						SELECT * FROM #TblYYOgr
						FOR JSON AUTO
					) as TblListeOgr
				) as tablo FOR JSON AUTO
			) as tt

			
			drop table IF EXISTS ##pivotYYOgr
			drop table IF EXISTS #TblYYOgr
			drop table IF EXISTS #tempYYOgr1
			drop table IF EXISTS #tempYYOgr
			drop table IF EXISTS #tempYYOgrOrt
			drop table IF EXISTS #tempPivotOgr
		END
				
		IF @ISLEM = 7	--	Öğretmen Liste					
		BEGIN
			

				select(
						select * from(
							select 
							(					
								SELECT DISTINCT K.TCKIMLIKNO, K.AD +' ' + K.SOYAD ADSOYAD
								FROM eokul_v2.dbo.DersOgretmen		DO
								JOIN OkyanusDB.DBO.v3Ogretmen		OG	ON	OG.TCKIMLIKNO	= DO.TC_OGRETMEN
								JOIN OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO	= DO.TC_OGRETMEN
								JOIN OkyanusDB.DBO.v3SubeGrupSinif	SG	ON	SG.ID_SINIF		= DO.ID_SINIF
								JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS		= DO.ID_DERS
								JOIN eokul_v2.dbo.Ders				DAD	ON	DAD.DERSAD		= D.DERSAD
								WHERE	SG.ID_SUBE	= @ID_SUBE
									AND ((DAD.ID_DERS= @ID_DERS OR @ID_DERS = 0)
										or (@ID_DERS = -99 and DAD.DERSAD = 'Akademi Öğrt.')									
									)
								ORDER BY ADSOYAD
								FOR JSON AUTO
							) as TblListeOgretmen												
						) as tablo FOR JSON AUTO
					) as tt

		END 

		IF @ISLEM = 8	--	ETUT KAYIT						
		BEGIN
			
			--select * from EtutTuru

			declare @tcOgrenciList	varchar(max)= NULL
			declare @kodList		varchar(max)= NULL

			IF @ID_ETUTTURU=1 -- sınav
			BEGIN
				 SELECT CAST(VALUE AS VARCHAR) as KONUKOD INTO #KODLISTESI FROM OPENJSON (@KODs)	 where value !=''

				 SELECT DISTINCT U.KONUKODESKI AS VALUE
				 INTO #KONUKOD
				 FROM UNiTEKARSiLiK U
				 JOIN #KODLISTESI K ON K.KONUKOD=U.KONUKOD 

				 
				Select @kodList		= Coalesce(@kodList		 +',','')+VALUE from ( SELECT CAST(VALUE AS VARCHAR) AS VALUE FROM #KONUKOD) as s
			END
			ELSE -- yazılı
			BEGIN
				Select @kodList		= Coalesce(@kodList		 +',','')+VALUE from ( SELECT CAST(VALUE AS VARCHAR) as VALUE FROM OPENJSON (@KODs)			) as s
			END

			Select @tcOgrenciList	= Coalesce(@tcOgrenciList+',','')+VALUE from ( SELECT CAST(ID_OGRENCI AS VARCHAR) AS VALUE FROM v3Ogrenci WHERE TCKIMLIKNO IN( SELECT CAST(VALUE AS VARCHAR) as VALUE FROM OPENJSON (@TC_OGRENCIs)	)) as s
			--(Select @kodList		= Coalesce(@kodList		 +',','')+VALUE from ( SELECT CAST(VALUE AS VARCHAR) as VALUE FROM OPENJSON (@KODs)			) as s)



			declare @idKullanici int	= (SELECT TOP 1 ID_KULLANICI FROM OKYANUSDB.DBO.V3KULLANiCi WHERE TCKIMLIKNO=@TCKIMLIKNO)
			declare @idOgretmen int		= (SELECT ID_OGRETMEN FROM OkyanusDB.DBO.v3Ogretmen WHERE TCKIMLIKNO=@TC_OGRETMEN) 
			declare @GRUP VARCHAR(MAX)	= (select AD from OkyanusDB.dbo.v3Kademe3 where ID_KADEME3=@ID_KADEME3) 

			DECLARE @TAR DATE=convert(datetime, @TARIH, 103)
			
			print @tcOgrenciList
			print @kodList
			print @idKullanici
			print @idOgretmen
			print @GRUP
			print @TAR


			--SELECT RESULT=NULL INTO #RESULT

			--CREATE TABLE #RESULT (R VARCHAR(MAX))
			--
			--INSERT INTO #RESULT (R)
			--exec eokul_v2.dbo.spEtudON 
			--	@UNITEKODU= @kodList,
			--	@ID_UNITE= 0,
			--	@ID_DERS= @ID_DERS,
			--	@YER= @YER,
			--	@ID_SUBE= @ID_SUBE,
			--	@TARIH= @TAR,
			--	@SAAT= @SAAT,
			--	@ETUD= @ETUT,
			--	@ID_OGRENCILER= @tcOgrenciList,
			--	@GRUP= @GRUP,
			--	@ID_OGRETMEN= @idOgretmen,
			--	@SURE= @SURE,
			--	@ID_ETUD= 0,
			--	@ISLEM=1,
			--	@ID_KULLANICI=@idKullanici,
			--	@OTURUM=@OTURUM
			--		
			----select * from #RESULT
			--IF EXISTS (SELECT R FROM #RESULT WHERE R LIKE 'Etüd oluşturuldu%')
			--BEGIN
			--	--SELECT * FROM Etut
			--	--YAZILI 0
			--	INSERT INTO ETUT ( ETUT,                   TARIH	  , SAAT, SURE, ID_SUBE, YER, ID_DERS, DONEM,KYE_TCKIMLIKNO, ID_KADEME3, TC_OGRETMEN, ID_ETUTTURU)
			--	VALUES			 (@ETUT,convert(datetime, @TARIH, 103) ,@SAAT,@SURE,@ID_SUBE,@YER,@ID_DERS,@DONEM,   @TCKIMLIKNO,@ID_KADEME3,@TC_OGRETMEN,@ID_ETUTTURU)
			--
			--	SET @ID_ETUT=SCOPE_IDENTITY()  
			--	--TC_OGRENCIs : "["10004443130","18005786768","18884111248","22042200002","24992028422","28570024592","37930624396","38284285998","41024147722","54937706078","58519081164"]"
			--	--KODs : ["KİM701002", "KİM701008", "KİM702002", "KİM703005"]
			--
			--	--SELECT * FROM EtutOgrenci
			--	INSERT INTO EtutOgrenci (ID_ETUT,TC_OGRENCI,KATILDI)
			--	SELECT @ID_ETUT,CAST(VALUE AS VARCHAR),0 FROM OPENJSON (@TC_OGRENCIs)
			--
			--	--SELECT * FROM EtutUnite
			--	INSERT INTO EtutUnite (ID_ETUT,KOD)
			--	SELECT @ID_ETUT,CAST(VALUE AS VARCHAR) FROM OPENJSON (@KODs)
			--END 
			--
			--	
			--SELECT R FROM #RESULT


			IF EXISTS (

						SELECT TOP 1 1 FROM Etut E
						WHERE	E.AKTIF			= 1
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
									BETWEEN  
										CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
									AND
										DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
								)
			) 
			BEGIN
				SELECT 'Etüde eklenmek istenen öğretmen aynı tarih ve yakın saatli başka bir etüde kayıtlı.'
			END
			ELSE IF EXISTS (
				SELECT TOP 1 1 
				FROM Etut						E
				JOIN EtutOgrenci				EO	ON	EO.ID_ETUT	= E.ID_ETUT
				JOIN OPENJSON (@TC_OGRENCIs)	O	ON	O.VALUE		= EO.TC_OGRENCI
				WHERE	E.AKTIF	= 1
					AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
									BETWEEN  
										CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
									AND
										DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
								)
			)
			BEGIN
				Declare @OGRENCILER varchar(max)=''
				Select @OGRENCILER = @OGRENCILER + Ad+' '+Soyad+',' from OkyanusDB.dbo.v3Kullanici where TCKIMLIKNO in
					(Select TCKIMLIKNO from OkyanusDB.dbo.v3Ogrenci where TCKIMLIKNO in
						(
						SELECT EO.TC_OGRENCI 
							FROM Etut						E
							JOIN EtutOgrenci				EO	ON	EO.ID_ETUT	= E.ID_ETUT
							JOIN OPENJSON (@TC_OGRENCIs)	O	ON	O.VALUE		= EO.TC_OGRENCI
							WHERE	E.AKTIF	= 1
								AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
												BETWEEN  
													CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
												AND
													DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)))
						))
				Select 'Etüde eklenmek istenen öğrencilerden bazıları aynı tarih ve yakın saatli başka bir etüde kayıtlı.'+@OGRENCILER
			END
			ELSE 
			BEGIN

			

				INSERT INTO ETUT ( ETUT,                   TARIH	  , SAAT, SURE, ID_SUBE, YER, ID_DERS, DONEM,KYE_TCKIMLIKNO, ID_KADEME3, TC_OGRETMEN, ID_ETUTTURU)
				VALUES			 (@ETUT,convert(datetime, @TARIH, 103) ,@SAAT,@SURE,@ID_SUBE,@YER,@ID_DERS,@DONEM,   @TCKIMLIKNO,@ID_KADEME3,@TC_OGRETMEN,@ID_ETUTTURU)

				SET @ID_ETUT=SCOPE_IDENTITY()  
			
				INSERT INTO EtutOgrenci (ID_ETUT,TC_OGRENCI,KATILDI)
				SELECT @ID_ETUT,CAST(VALUE AS VARCHAR),0 FROM OPENJSON (@TC_OGRENCIs)

			
				INSERT INTO EtutUnite (ID_ETUT,KOD)
				SELECT @ID_ETUT,CAST(VALUE AS VARCHAR) FROM OPENJSON (@KODs)

				
				
				SELECT CAST(VALUE AS VARCHAR) TCKIMLIKNO INTO #OGRLIST FROM OPENJSON (@TC_OGRENCIs)
				
				DECLARE @ID_KULLANICI INT =  (SELECT TOP 1 ID_KULLANICI FROM v3Kullanici WHERE TCKIMLIKNO = @TCKIMLIKNO)



				--4-öğrencilere mesaj gönderiliyor.
				
				SET @DERSAD=(Select AD as DERSAD from OkyanusDB.dbo.v3SinavDers where ID_DERS=@ID_DERS)
				INSERT INTO eokul_v2.dbo.MesajV2
				(
					KONU	,
					ICERIK	,
					TARIH	
				)
				VALUES
				(
					@DERSAD+' etüdü oluşturuldu',
					'Sizin için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Size tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					GETDATE()
				)
				Declare @ID_MESAJ int
				SET @ID_MESAJ = SCOPE_IDENTITY()

				Insert Into eokul_v2.dbo.MesajDetayV2(ID_MESAJ,ID_GONDEREN,ID_ALAN,OKUNDU,SIL,GONDERENSIL,GUID_ALAN,GUID_GONDEREN,TC_ALAN,TC_GONDEREN)
					 Select @ID_MESAJ,@ID_KULLANICI,k.ID_KULLANICI,0,0,0,
						   '',--(Select GUID from Kullanici where KullaniciId=k.KullaniciId),
						   ''--(Select GUID from Kullanici where KullaniciId=@ID_KULLANICI) --mesajı gönderen kişi
						   ,vo.TCKIMLIKNO,
						   @TCKIMLIKNO
					  from #OGRLIST o
				inner join v3Ogrenci vo on vo.TCKIMLIKNO=o.TCKIMLIKNO
				inner join OkyanusDB.dbo.v3Kullanici K on K.TCKIMLIKNO=vo.TCKIMLIKNO

				--5-velilere mesaj gönderiliyor.
				INSERT INTO eokul_v2.dbo.MesajV2 ( KONU, ICERIK, TARIH )
				VALUES (
					 @DERSAD+' etüdü oluşturuldu',
					'Öğrenciniz için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Öğrencinize tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					GETDATE()
				)
				Declare @ID_MESAJ2 int
				SET @ID_MESAJ2 = SCOPE_IDENTITY()

				Insert Into eokul_v2.dbo.MesajDetayV2(ID_MESAJ,ID_GONDEREN,ID_ALAN,OKUNDU,SIL,GONDERENSIL,GUID_ALAN,GUID_GONDEREN,TC_ALAN,TC_GONDEREN)
				Select 
					 ID_MESAJ	= @ID_MESAJ2
					,ID_GONDEREN= @ID_KULLANICI
					,ID_ALAN	= k.ID_KULLANICI
					,OKUNDU		= 0
					,SIL		= 0
					,GONDERENSIL= 0
					,GUID_ALAN	= ''
					,GUID_GOND	= ''
					,TC_ALAN	= V.TCKIMLIKNO
					,TC_GONDEREN= @TCKIMLIKNO
				from #OGRLIST o
				inner join v3Ogrenci vo on vo.TCKIMLIKNO=o.TCKIMLIKNO
				inner join v3OgrenciVeli v     on v.TCKIMLIKNO_OGR=vo.TCKIMLIKNO
				inner join V3Kullanici k on k.TCKIMLIKNO=v.TCKIMLIKNO
				
				print '4'

				DROP TABLE IF EXISTS #BILDIRIMLIST


				SELECT DISTINCT
					K.TCKIMLIKNO--, OV.TCKIMLIKNO_OGR AS TC_OGRENICI					
				INTO #BILDIRIMLIST
				FROM #OGRLIST O
				INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	OV	WITH(NOLOCK) ON OV.TCKIMLIKNO_OGR	= O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON K.TCKIMLIKNO		= OV.TCKIMLIKNO
				WHERE K.AKTIF = 1
				
				WHILE EXISTS (SELECT TOP 1 1 FROM #BILDIRIMLIST)
				BEGIN
					DECLARE @TC_ALAN VARCHAR(MAX), @YOL VARCHAR(MAX)

					SELECT TOP 1 @TC_ALAN	= TCKIMLIKNO
					FROM #BILDIRIMLIST 
					ORDER BY TCKIMLIKNO 
										
					SET @YOL = (SELECT TOP 1 [PUSULAM SERVER] + '&URL=Etut/EtutProgramiOV' FROM fn_OturumGetir(@TC_ALAN) )

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Etüt'
						,@MESAJ				= 'Öğrencinize Etüt Oluşturulmuştur.'
						,@LINK				= @YOL
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @TC_ALAN
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= 'Öğrencinize Etüt Oluşturulmuştur. Detay için Linke Tıklayınız'
						,@LINK_ETIKET		= 'Etüte Git'

					DELETE FROM #BILDIRIMLIST WHERE TCKIMLIKNO = @TC_ALAN
				END
	
				DROP TABLE IF EXISTS #BILDIRIMLIST


				--6-öğretmene mesaj gönderiliyor
				INSERT INTO eokul_v2.dbo.MesajV2 ( KONU, ICERIK, TARIH )
				VALUES (
					@DERSAD+' etüdü oluşturuldu',
					'Sizin için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Size tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					GETDATE()
				)
				Declare @ID_MESAJO int
				SET @ID_MESAJO = SCOPE_IDENTITY()
			
				Insert Into eokul_v2.dbo.MesajDetayV2(ID_MESAJ,ID_GONDEREN,ID_ALAN,OKUNDU,SIL,GONDERENSIL,GUID_ALAN,GUID_GONDEREN,TC_ALAN,TC_GONDEREN)
				Select @ID_MESAJO,@ID_KULLANICI,k.ID_KULLANICI,0,0,0,
					'',--(Select GUID from Kullanici where KullaniciId=k.KullaniciId),
					'',--(Select GUID from Kullanici where KullaniciId=@ID_KULLANICI), --mesajı gönderen kişi				   
					K.TCKIMLIKNO,--(Select TcKimlikNo from Kullanici where KullaniciId=k.KullaniciId)	,		
					@TCKIMLIKNO--,(Select TCKIMLIKNO from OkyanusDB.dbo.v3Kullanici where ID_KULLANICI=@ID_KULLANICI)
				from OkyanusDB.dbo.v3Ogretmen oo
				inner join V3Kullanici k on k.TCKIMLIKNO=oo.TCKIMLIKNO
				where oo.TCKIMLIKNO=@TC_OGRETMEN
				
				print '7'


					----7-öğretmene mail gidiyor.
					--Declare @EMAIL varchar(1000)
					----SET @EMAIL=(Select top 1 isnull(Email,'') from Kullanici where GUID in (Select GUID from Ogretmen where ID_OGRETMEN=@ID_OGRETMEN))
					--SET @EMAIL = (select TOP 1 EMAIL from OkyanusDB.dbo.v3kullanicibilgi where tcKIMLIKNO IN (SELECT tcKIMLIKNO FROM OKYANUSDB.DBO.V3OGRETMEN WHERE TCKIMLIKNO=@TC_OGRETMEN))
					--IF LEN(@EMAIL)>0
					--BEGIN
					-- Insert Into eokul_v2.dbo.MailIcerik(MAIL,KONU,MODUL,ID_BAGLANTI)
					-- Select 'Sizin için '+Cast(@TARIH as varchar)+' '+@SAAT+' tarihine bir etüt oluşturuldu.Size tanımlanmış etütleri Etüt Programı sayfasından kontrol edebilirsiniz',
					--		'İnteraktif Etüt Bildirimi - '+@DERSAD+' Etüdü',
					--		'ETD',
					--		@ID_ETUT 

					-- Declare @ID_MAILICERIK int
					--	 Set @ID_MAILICERIK=(SCOPE_IDENTITY())

					-- Insert Into eokul_v2.dbo.MailDetay(ID_MAILICERIK,MAILADRES,GONDERILDI,ONCELIK)
					--	  Select @ID_MAILICERIK,@EMAIL,0,3
					--END

				  Select 'Etüd oluşturuldu -'+Cast(@ID_ETUT as varchar)



			END
			 

			--ETUTSINAV
			--SELECT * FROM EtutSinav

		END

		IF @ISLEM = 9	--	ETÜT LİSTESİ					
		BEGIN
			IF @ID_ETUT = 0 OR @ID_ETUT IS NULL
			BEGIN
				select(
						select * from(
							select 
							(	
								SELECT  DISTINCT
									 E.ID_ETUT
									,E.ETUT
									,YER
									,D.ID_DERS
									,D.DERSAD
									,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
									,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
									,SAAT ETUTSAAT
									,ADSOYAD	= K.AD+' '+ K.SOYAD
									,E.TC_OGRETMEN
									, SUBSTRING(E.SAAT,1, charindex(':',E.SAAT)-1) SAAT
									, SUBSTRING(E.SAAT, charindex(':',E.SAAT)+1,LEN(E.SAAT)) DAKIKA
									,E.SURE																		
									,E.AKTIF
									--,OGRENCILIST = (
									--					SELECT K.AD+' '+K.SOYAD ADSOYAD,K.TCKIMLIKNO,EO.KATILDI ,SN.AD SINIFAD,SB.AD SUBEAD
									--					FROM v3Kullanici K 
									--					JOIN EtutOgrenci EO ON K.TCKIMLIKNO = EO.TC_OGRENCI 
									--					JOIN v3Ogrenci O  ON O.TCKIMLIKNO = EO.TC_OGRENCI
									--					JOIN v3Sinif SN ON SN.ID_SINIF = O.ID_SINIF
									--					JOIN v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
									--					WHERE EO.ID_ETUT = E.ID_ETUT
									--						AND EO.AKTIF= 1 
									--					ORDER BY ADSOYAD
									--					FOR JSON PATH,INCLUDE_NULL_VALUES  )
								FROM Etut				E
								JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
								JOIN v3SubeYetki		Y	ON	Y.ID_SUBE	= E.ID_SUBE
								WHERE (E.ID_ETUT = @ID_ETUT OR @ID_ETUT=0 OR @ID_ETUT IS NULL)
								--AND E.AKTIF = 1
								AND DONEM	= @DONEM								
								AND Y.TCKIMLIKNO = @TCKIMLIKNO
								ORDER BY TARIH,ADSOYAD,DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
				END
				ELSE
				BEGIN
				select(
						select * from(
							select 
							(	
								SELECT  DISTINCT
									 E.ID_ETUT
									,E.ETUT
									,YER
									,D.ID_DERS
									,D.DERSAD
									,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
									,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
									,SAAT ETUTSAAT
									,ADSOYAD	= K.AD+' '+ K.SOYAD
									,E.TC_OGRETMEN
									, SUBSTRING(E.SAAT,1, charindex(':',E.SAAT)-1) SAAT
									, SUBSTRING(E.SAAT, charindex(':',E.SAAT)+1,LEN(E.SAAT)) DAKIKA
									,E.SURE																		
									,E.AKTIF
									,OGRENCILIST = (
														SELECT K.AD+' '+K.SOYAD ADSOYAD,K.TCKIMLIKNO,EO.KATILDI ,SN.AD SINIFAD,SB.AD SUBEAD
														FROM v3Kullanici K 
														JOIN EtutOgrenci EO ON K.TCKIMLIKNO = EO.TC_OGRENCI 
														JOIN v3Ogrenci O  ON O.TCKIMLIKNO = EO.TC_OGRENCI
														JOIN v3Sinif SN ON SN.ID_SINIF = O.ID_SINIF
														JOIN v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
														WHERE EO.ID_ETUT = E.ID_ETUT
															AND EO.AKTIF= 1 
														ORDER BY ADSOYAD
														FOR JSON PATH,INCLUDE_NULL_VALUES  )
								FROM Etut				E
								JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
								JOIN v3SubeYetki		Y	ON	Y.ID_SUBE	= E.ID_SUBE
								WHERE (E.ID_ETUT = @ID_ETUT OR @ID_ETUT=0 OR @ID_ETUT IS NULL)
								--AND E.AKTIF = 1
								AND DONEM	= @DONEM								
								AND Y.TCKIMLIKNO = @TCKIMLIKNO
								ORDER BY TARIH,ADSOYAD,DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
				END
		END

		IF @ISLEM = 10	--	ETÜT ÖĞRENCİ KATILIM			
		BEGIN
			UPDATE EO
			SET	KATILDI = @KATILDI
			FROM EtutOgrenci EO
			WHERE	ID_ETUT		= @ID_ETUT 
				AND TC_OGRENCI	= @TC_OGRENCI

			SELECT 1
		END

		IF @ISLEM = 11	--	ETÜT ÖĞRENCİ LİST				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT K.TCKIMLIKNO
									, @ID_ETUT ID_ETUT
									, K.AD+' '+ K.SOYAD ADSOYAD
									, CASE WHEN EO.TC_OGRENCI IS NOT NULL THEN 1 ELSE 0 END KATILACAK
								FROM v3Ogrenci			O 
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
								LEFT JOIN EtutOgrenci	EO	ON	EO.TC_OGRENCI	= O.TCKIMLIKNO
															AND EO.ID_ETUT		= @ID_ETUT
															AND EO.AKTIF		= 1
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END

		IF @ISLEM = 12	--	ETÜT ÖĞRENCİ EKLE				
		BEGIN
			IF NOT EXISTS (SELECT TOP 1 1  FROM EtutOgrenci WHERE TC_OGRENCI = @TC_OGRENCI AND ID_ETUT = @ID_ETUT)
			BEGIN
				INSERT INTO EtutOgrenci(ID_ETUT,TC_OGRENCI,KATILDI)
				VALUES(@ID_ETUT , @TC_OGRENCI, 0)
			END

			UPDATE EtutOgrenci SET AKTIF = @KATILACAK,KATILDI = 0  WHERE TC_OGRENCI = @TC_OGRENCI AND ID_ETUT = @ID_ETUT 
			

			SELECT 1
		END

		IF @ISLEM = 13	--	SUBE KADEME DERS LİSTESİ		
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT D.DERSAD
								FROM eokul_v2.dbo.DersOgretmen		DO
								JOIN v3Sinif						SN	ON	SN.ID_SINIF = DO.ID_SINIF 
								JOIN OkyanusDB.dbo.v3SubeGrupSinif	GS	ON	GS.ID_SINIF = SN.ID_SINIF
								JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS	= DO.ID_DERS
								--JOIN v3Kullanici					K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE	ID_SUBE			= @ID_SUBE
									AND GS.ID_KADEME3	= @ID_KADEME3
								ORDER BY DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END
		
		IF @ISLEM = 14	--	SUBE KADEME DERS ÖĞRETMEN LİSTE	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT K.AD + ' ' + K.SOYAD ADSOYAD,TCKIMLIKNO
								FROM eokul_v2.dbo.DersOgretmen		DO
								JOIN v3Sinif						SN	ON	SN.ID_SINIF = DO.ID_SINIF 
								JOIN OkyanusDB.dbo.v3SubeGrupSinif	GS	ON	GS.ID_SINIF = SN.ID_SINIF
								JOIN eokul_v2.dbo.Ders				D	ON	D.ID_DERS	= DO.ID_DERS
								JOIN v3Kullanici					K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE	ID_SUBE			= @ID_SUBE
									AND GS.ID_KADEME3	= @ID_KADEME3
									AND DERSAD			= @DERSAD
								ORDER BY ADSOYAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END
				
		IF @ISLEM = 15	--	ETÜT DÜZELT						
		BEGIN
				SELECT
					 ID_ETUT				AS T_ID_ETUT		
					,ETUT					AS T_ETUT
					,YER					AS T_YER
					,REPLACE(TARIH,'/','.') AS T_TARIH
					,SAAT+':'+DAKIKA		AS T_SAAT
					,SURE					AS T_SURE
					,TC_OGRETMEN			AS T_TC_OGRETMEN
				INTO #ETUT
				FROM OPENJSON (@ETUTJSON) 
				WITH (
					ID_ETUT		INT '$.ID_ETUT',
					ETUT		VARCHAR(MAX) '$.ETUT',
					YER			VARCHAR(MAX) '$.YER',
					TARIH		VARCHAR(MAX) '$.TARIH',
					SAAT		VARCHAR(MAX) '$.SAAT',
					DAKIKA		VARCHAR(MAX) '$.DAKIKA',
					SURE		VARCHAR(MAX) '$.SURE',
					TC_OGRETMEN VARCHAR(MAX) '$.TC_OGRETMEN'
				)
				
			SELECT @TC_OGRETMEN = T_TC_OGRETMEN, @TARIH = T_TARIH, @SAAT = T_SAAT,@ID_ETUT = T_ID_ETUT FROM #ETUT
			IF EXISTS (

						SELECT TOP 1 1 FROM Etut E
						WHERE	E.AKTIF			= 1
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND E.ID_ETUT		!=@ID_ETUT
							AND (CAST(@TARIH+' '+ @SAAT  AS datetime2)
									BETWEEN  
										CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
									AND
										DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
								)
			) 
			BEGIN
				SELECT 0
			END
			ELSE
			BEGIN
				UPDATE E
				SET  ETUT		= T_ETUT
					,YER		= T_YER
					,TARIH		= T_TARIH
					,SAAT		= T_SAAT
					,SURE		= T_SURE
					,TC_OGRETMEN= T_TC_OGRETMEN
				FROM Etut	E
				JOIN #ETUT	T	ON	T.T_ID_ETUT =E.ID_ETUT

				SELECT 1
			END

				DROP TABLE #ETUT
		END

		IF @ISLEM = 16	--	ETÜT AKTİF PASİF				
		BEGIN
			
			

			IF NOT EXISTS (	SELECT TOP 1 1
						FROM Etut	E
						JOIN Etut	G	ON	
									CAST(CAST(G.TARIH AS varchar)+' '+ G.SAAT  AS datetime2)
								BETWEEN  
									CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2)
								AND
									DATEADD(MINUTE,CAST(E.SURE AS INT), CAST(CAST(E.TARIH AS varchar)+' '+ E.SAAT  AS datetime2))
									AND G.ID_ETUT != E.ID_ETUT
									AND G.TC_OGRETMEN = E.TC_OGRETMEN
						WHERE	E.ID_ETUT = @ID_ETUT
							AND G.AKTIF = 1
							AND E.AKTIF = 0
						 )
			BEGIN
				UPDATE E
				SET AKTIF = CASE WHEN AKTIF = 1 THEN 0 ELSE 1 END
				FROM Etut E
				WHERE E.ID_ETUT = @ID_ETUT

				SELECT 1
			END
			ELSE
			BEGIN
				SELECT 0
			END
		END

		IF @ISLEM = 17	--	ETÜT DETAY GETİR				
		BEGIN
			
			SELECT(
				SELECT	 E.ID_ETUT
						,E.ETUT
						,TARIH = CONVERT(VARCHAR, E.TARIH, 104)
						,E.SAAT
						,E.SURE
						,E.YER
						,ET.ETUT_TURU
						,ADSOYAD	= CONCAT_WS(' ', K.AD, K.SOYAD)
						,DERSAD
						,UNITELIST	= (
							SELECT SDU.KOD, SDU.AD
							FROM EtutUnite						EU	
							JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON	SDU.KOD			= EU.KOD
							WHERE EU.ID_ETUT = E.ID_ETUT
							FOR JSON PATH
						)
				FROM Etut					E
				JOIN EtutTuru				ET	ON	ET.ID_ETUT_TURU	= E.ID_ETUTTURU
				LEFT JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= E.TC_OGRETMEN
				JOIN eokul_v2.dbo.Ders		D	ON	D.ID_DERS		= E.ID_DERS
				WHERE E.ID_ETUT	= @ID_ETUT
				FOR JSON PATH
			)
			
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_FrekansOgrenciHesapla]...';


GO
ALTER procedure [dbo].[sp_FrekansOgrenciHesapla]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
-- EXEC sp_FrekansOgrenciHesapla
BEGIN TRY    

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	IF @ID_LOG > 1
	BEGIN
			SET @DONEM = (SELECT Donem FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)

			SELECT	D.* 
			INTO	#DERSLER 
			FROM	v3SinavDers D
			INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD
				--and AD			in ('Türk Edebiyatı','Dil ve Anlatım','Matematik','Geometri','Fizik','Kimya','Biyoloji','Tarih','Coğrafya','Felsefe','Din Kült. Ve A. B.','Main Course','Almanca','Sosyoloji')

			SELECT	 ID_EGITIMTURU
					,ID_SINAVTURU	--=  CASE ID_EGITIMTURU 
									--	WHEN 6  THEN 0
									--	WHEN 7  THEN 2
									--	WHEN 8  THEN 3
									--	WHEN 9  THEN 6
									--	WHEN 10 THEN 5
									--	--YENİ EKLENENLER
									--	WHEN 11 THEN 8 
									--	WHEN 12 THEN 9
									--	WHEN 13 THEN 7
									--	WHEN 14 THEN 10
									--
									--ELSE 0 END
			INTO #EgitimTuru FROM OkyanusDB.DBO.V3EgitimTuru
			WHERE PASIF = 0
		-- FREKANS OGRENCI
		BEGIN
			Delete from FrekansOgrenci WHERE DONEM=@DONEM 		

			SELECT	S.ID_SINAV, 
					S.ID_SINAVTURU, 
					S.SINAVTARIH,
					TAKMAAD =  DR.AD,
					SO.TCKIMLIKNO, 
					O.ID_OGRENCI, 
					KK3.ID_KADEME3, 
					SUM(SOCB.NET) AS TOPLAMNET, 
					SUM(SOCB.DOGRU + SOCB.YANLIS + SOCB.BOS) AS TOPLAMSORUSAYISI,
					MAX(SD.ID_DERS) ID_DERS
			INTO #TEMP
			FROM	   [Pusulam].dbo.SinavOgrenci				SO		WITH (NOLOCK) 
			INNER JOIN [Pusulam].dbo.Sinav						S		WITH (NOLOCK) ON	S.ID_SINAV				= SO.ID_SINAV
			INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum		SOCB	WITH (NOLOCK) ON	SOCB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			INNER JOIN [Pusulam].dbo.SinavDers					SD		WITH (NOLOCK) ON	SD.ID_SINAVDERS			= SOCB.ID_SINAVDERS
			INNER JOIN OkyanusDB.dbo.V3Ogrenci					O		WITH (NOLOCK) ON	O.TCKIMLIKNO			= SO.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3KullaniciKademe3			KK3		WITH (NOLOCK) ON	KK3.TCKIMLIKNO			= O.TCKIMLIKNO
			INNER JOIN #DERSLER									DR		WITH (NOLOCK) ON	DR.ID_DERS				= SD.ID_DERS
			WHERE   S.DONEM			= @DONEM 
				AND S.DURUM			= 2
				AND S.FREKANSHESAPLA= 1
				AND S.AKTIF			= 1
				--AND	KK3.ID_KADEME3	IN (15, 16, 17, 18) 
				--AND S.ID_SINAVTURU	IN (2,3,4,5,6) --LİSE
			GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SO.TCKIMLIKNO, O.ID_OGRENCI, DR.AD, KK3.ID_KADEME3,S.SINAVTARIH--, (SOCB.DOGRU + SOCB.YANLIS + SOCB.BOS)
		UNION ALL
			SELECT	Y.ID_YAZILI AS ID_SINAV
					,0 AS ID_SINAVTURU
					,Y.YAZILITARIH AS SINAVTARIH
					,D.DERSAD AS TAKMAAD
					,YO.TCKIMLIKNO 
					,O.ID_OGRENCI
					,D.ID_KADEME3
					,CAST(ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS DECIMAL(8,2)) AS TOPLAMNET
					,100 AS TOPLAMSORUSAYISI
					,Y.ID_DERS
			FROM Yazili Y
			INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
			INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
			WHERE Y.DONEM = @DONEM AND Y.AKTIF = 1 AND YO.AKTIF = 1 AND YO.KATILMADI = 0
			GROUP BY Y.ID_YAZILI, Y.YAZILITARIH, D.DERSAD, YO.TCKIMLIKNO, O.ID_OGRENCI, D.ID_KADEME3, Y.ID_DERS, YO.TELAFI
			--SELECT		ONOT.ID_SINAVRAPOR ID_SINAV, 
			--			0 ID_SINAVTURU, 
			--			SR.TARIH SINAVTARIH,
			--			D.AD TAKMAAD, 
			--			ONOT.TC_OGRENCI TCKIMLIKNO, 
			--			ONOT.ID_OGRENCI, 
			--			D.ID_KADEME3, 
			--			-- cast(SR.SORUSAYISI decimal(8,2))/cast (SELECT SUM(PUAN) FROM eokul_v2.dbo.OgrenciNot OG WHERE OG.TC_OGRENCI=ONOT.TC_OGRENCI AND OG.ID_SINAVRAPOR=ONOT.ID_SINAVRAPOR) as decimal(8,2)) TOPLAMNET,
			--			----100 TOPLAMSORUSAYISI,
			--			--SR.SORUSAYISI TOPLAMSORUSAYISI,
						
			--			--ÇALIŞAN BUYDU
			--			--cast(
			--			--		cast((SELECT SUM(PUAN) FROM eokul_v2.dbo.OgrenciNot OG WHERE OG.TC_OGRENCI=ONOT.TC_OGRENCI AND OG.ID_SINAVRAPOR=ONOT.ID_SINAVRAPOR) as float)
			--			--	/	cast(100 as decimal(8,2)) 	
			--			--	*	SR.SORUSAYISI	
			--			--as decimal(8,2))			TOPLAMNET,
			--			--SR.SORUSAYISI				TOPLAMSORUSAYISI,

			--			TOPLAMNET			= cast((SELECT SUM(PUAN) FROM eokul_v2.dbo.OgrenciNot OG WHERE OG.TC_OGRENCI=ONOT.TC_OGRENCI AND OG.ID_SINAVRAPOR=ONOT.ID_SINAVRAPOR) as decimal(8,2)),
			--			TOPLAMSORUSAYISI	= 100,
			--			SR.ID_DERS
			--FROM		eokul_v2.dbo.OgrenciNot		ONOT
			--INNER JOIN	eokul_v2.dbo.SinavRapor		SR		ON	SR.ID_SINAVRAPOR		= ONOT.ID_SINAVRAPOR
			--INNER JOIN	#DERSLER					D		ON	D.ID_DERS				= SR.ID_DERS
			--WHERE		SR.DONEMKOD		=	@DONEM 
			--	--AND		D.ID_KADEME3	IN	(15, 16, 17, 18) --LİSE		
			--	AND		SR.isActive		=	1			
			--GROUP BY	ONOT.ID_SINAVRAPOR,ONOT.TC_OGRENCI,D.AD,ONOT.ID_OGRENCI,D.ID_KADEME3,SR.ID_DERS,SR.SORUSAYISI,SR.TARIH



			SELECT T1.ID_SINAV, T1.ID_SINAVTURU, T1.TAKMAAD, T1.TCKIMLIKNO, T1.ID_OGRENCI, T1.ID_KADEME3, T1.TOPLAMNET, T1.TOPLAMSORUSAYISI 
					,ILK_ID_SINAV	= (SELECT TOP 1 ID_SINAV FROM #TEMP G WHERE G.SINAVTARIH=MIN(T2.SINAVTARIH) 
																			AND G.ID_SINAVTURU	= T1.ID_SINAVTURU 
																			AND G.TCKIMLIKNO	= T1.TCKIMLIKNO 
																			AND G.TAKMAAD		= T1.TAKMAAD		
																ORDER BY G.SINAVTARIH,G.ID_SINAV				) 
					--, MIN(T2.ID_SINAV) AS ILK_ID_SINAV
			INTO	#TEMP2
			FROM	#TEMP	T1
			JOIN	#TEMP	T2	ON	T2.ID_SINAVTURU	= T1.ID_SINAVTURU 
								AND T2.TCKIMLIKNO	= T1.TCKIMLIKNO 
								AND T2.TAKMAAD		= T1.TAKMAAD
			GROUP BY T1.ID_SINAV, T1.ID_SINAVTURU, T1.TAKMAAD, T1.TCKIMLIKNO, T1.ID_OGRENCI, T1.ID_KADEME3, T1.TOPLAMNET, T1.TOPLAMSORUSAYISI
			ORDER BY TCKIMLIKNO, TAKMAAD

			Insert Into FrekansOgrenci (ID_SINAVTURU,ID_KADEME3,ID_OGRENCI,TCKIMLIKNO,ID_DERS,TAKMAAD,HBNET,ID_SINAV,NET,SS,ILK_ID_SINAV,ILK_NET,ILK_SS,FREKANS,DONEM)
			SELECT   T2.ID_SINAVTURU
					,T2.ID_KADEME3
					,T2.ID_OGRENCI
					,T2.TCKIMLIKNO
					,ID_DERS
					,T2.TAKMAAD
					,T1.TOPLAMNET HBNET
					,T2.ID_SINAV
					,ISNULL(convert(decimal(8,2),(cast(T1.TOPLAMSORUSAYISI	as float)	/ NULLIF(cast(T2.TOPLAMSORUSAYISI as float)	/NULLIF(cast(T2.TOPLAMNET as float),0 ),0 ))),0)as NET
					,T1.TOPLAMSORUSAYISI AS SS 
					,T2.ILK_ID_SINAV
					,T1.TOPLAMNET AS ILK_NET
					,T1.TOPLAMSORUSAYISI AS ILK_SS
					,CASE WHEN T2.ID_SINAV=T2.ILK_ID_SINAV				AND T2.ID_SINAVTURU!=0					THEN null
						  WHEN T1.TOPLAMNET=T1.TOPLAMSORUSAYISI AND T2.TOPLAMSORUSAYISI>0	THEN (Convert(DECIMAL(8,2),T2.TOPLAMNET)/T2.TOPLAMSORUSAYISI)*100
						  ELSE  convert(decimal(8,2),
								cast((T2.TOPLAMNET-			cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)								
								/
								NULLIF(
										cast((T1.TOPLAMSORUSAYISI-	cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)
								,0)
								*100 
								)
					 END AS FREKANS
					,@DONEM
			FROM		#TEMP2	T2
			INNER JOIN	#TEMP	T1	ON	T2.ILK_ID_SINAV	= T1.ID_SINAV 
									AND T2.ID_SINAVTURU	= T1.ID_SINAVTURU 
									AND T2.TCKIMLIKNO	= T1.TCKIMLIKNO 
									AND T2.TAKMAAD		= T1.TAKMAAD
			ORDER BY T2.ID_KADEME3, ID_OGRENCI, T2.TAKMAAD

			-------------------------------------------
			--Insert Into FrekansOgrenci (ID_SINAVTURU,ID_KADEME3,ID_OGRENCI,TCKIMLIKNO,ID_DERS,TAKMAAD,HBNET,ID_SINAV,NET,SS,ILK_ID_SINAV,ILK_NET,ILK_SS,FREKANS,DONEM)
			--SELECT   T2.ID_SINAVTURU
			--		,T2.ID_KADEME3
			--		,T2.ID_OGRENCI
			--		,T2.TCKIMLIKNO
			--		,ID_DERS
			--		,T2.TAKMAAD
			--		,T1.TOPLAMNET HBNET
			--		,T2.ID_SINAV
			--		,ISNULL(convert(decimal(8,2),(cast(T1.TOPLAMSORUSAYISI	as float)	/ NULLIF(cast(T2.TOPLAMSORUSAYISI as float)	/NULLIF(cast(T2.TOPLAMNET as float),0 ),0 ))),0)as NET
			--		,T1.TOPLAMSORUSAYISI AS SS 
			--		,T2.ILK_ID_SINAV
			--		,T1.TOPLAMNET AS ILK_NET
			--		,T1.TOPLAMSORUSAYISI AS ILK_SS
			--		,CASE WHEN T2.ID_SINAV=T2.ILK_ID_SINAV									THEN null
			--			  WHEN T1.TOPLAMNET=T1.TOPLAMSORUSAYISI AND T2.TOPLAMSORUSAYISI>0	THEN (Convert(DECIMAL(8,2),T2.TOPLAMNET)/T2.TOPLAMSORUSAYISI)*100
			--			  ELSE  convert(decimal(8,2),
			--					cast((T2.TOPLAMNET-			cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)								
			--					/
			--					NULLIF(
			--							cast((T1.TOPLAMSORUSAYISI-	cast(((Convert(DECIMAL(8,2),T1.TOPLAMNET)/2)) as float)) as float)
			--					,0)
			--					*100 
			--					)
			--		 END AS FREKANS
			--		,@DONEM
			--FROM		#TEMP2	T2
			--INNER JOIN	#TEMP	T1	ON	T2.ILK_ID_SINAV	= T1.ID_SINAV 
			--						AND T2.ID_SINAVTURU	= T1.ID_SINAVTURU 
			--						AND T2.TCKIMLIKNO	= T1.TCKIMLIKNO 
			--						AND T2.TAKMAAD		= T1.TAKMAAD			
			--WHERE		T2.ID_SINAVTURU=0
			--ORDER BY T2.ID_KADEME3, ID_OGRENCI, T2.TAKMAAD
			-------------------------------------------


			DROP TABLE #TEMP
			DROP TABLE #TEMP2
		END			
		-- FREKANS OGRENCI DETAY 
		BEGIN 
			--TRUNCATE TABLE FrekansOgrenciDetay

			Delete from FrekansOgrenciDetay WHERE DONEM=@DONEM

			INSERT INTO FrekansOgrenciDetay (ID_SINAVTURU
											,ID_KADEME3
											,ID_OGRENCI
											,TC_OGRENCI
											,TAKMAAD
											,ID_SINAV
											,NET
											,SS
											,ILK_ID_SINAV
											,ILK_NET
											,HBNET
											,ILK_SS
											,FREKANS
											,DONEM
											,ID_SINIF
											,ID_SUBE
											,ID_DERS
											,TC_OGRETMEN
											,OGRETMENADSOYAD
											,DERSAD
											,SUBEAD
											,SINIFAD)
			(
						SELECT	
							FO.ID_SINAVTURU,FO.ID_KADEME3,FO.ID_OGRENCI,FO.TCKIMLIKNO TC_OGRENCI,FO.TAKMAAD,FO.ID_SINAV,FO.NET,FO.SS,ILK_ID_SINAV,ILK_NET,ILK_NET,ILK_SS,FREKANS,FO.DONEM
							
							,ISNULL(SVF.ID_SINIF, O.ID_SINIF)
							
							,O.ID_SUBE,FO.ID_DERS,OGT.TCKIMLIKNO TC_OGRETMEN,OGK.AD+' '+OGK.SOYAD OGRETMENADSOYAD,D.AD DERSAD
							,SB.AD SUBEAD
							
							,SINIFAD = ISNULL(SVF.AD, SNF.AD)
					--INTO	#TEMPOGRENCI 
					FROM	FrekansOgrenci				FO
					JOIN	v3Ogrenci					O	ON	O.ID_OGRENCI= FO.ID_OGRENCI	
					JOIN	Sinav						S	ON	S.ID_SINAV	= FO.ID_SINAV
					JOIN	v3Sube						SB	ON	SB.ID_SUBE	= O.ID_SUBE
					JOIN	v3Sinif						SNF	ON	SNF.ID_SINIF= O.ID_SINIF
					JOIN	#DERSLER					D	ON	D.ID_DERS	= FO.ID_DERS
					JOIN	eokul_v2.dbo.DersOgretmen	OS	ON	OS.ID_SINIF	= O.ID_SINIF
															AND OS.ID_DERS	= FO.ID_DERS
					JOIN	#EgitimTuru					ET	ON  ET.ID_EGITIMTURU = OS.ID_EGITIMTURU AND ET.ID_SINAVTURU = S.ID_SINAVTURU AND ET.ID_EGITIMTURU <> 6 -- YAZILI
					JOIN	OkyanusDB.dbo.v3Ogretmen	OGT ON	OGT.ID_OGRETMEN	= OS.ID_OGRETMEN
					JOIN	v3Kullanici					OGK	ON	OGK.TCKIMLIKNO	= OGT.TCKIMLIKNO
					LEFT JOIN v3Sinif					SV	ON	SV.ID_OGRENCI	= O.ID_OGRENCI AND FO.ID_SINAVTURU = 5
					LEFT JOIN v3Sinif					SVF	ON	SVF.ID_SINIF	= SV.ID_SINIF
					--JOIN	OkyanusDB.dbo.v3SubeGrupSinif	SGS	ON	SGS.ID_SINIF	= O.ID_SINIF
					WHERE	
						--	(FO.ID_SINAVTURU	<>	0 AND ((FO.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))) OR @ID_SINAVTURU='[]'))
						--AND (D.ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3)) OR @ID_KADEME3='[]')
						--AND (O.ID_SUBE			=	@ID_SUBE	OR @ID_SUBE	= 0)
						--AND (FO.TAKMAAD			=	@DERSAD		OR @DERSAD	= 'Tüm Dersler')
						--AND 
							(FO.DONEM			=	@DONEM)
						AND (S.FREKANSHESAPLA	=	1)
						AND S.AKTIF=1
						AND S.DURUM=2
			UNION ALL
					SELECT									
							FO.ID_SINAVTURU,FO.ID_KADEME3,FO.ID_OGRENCI,FO.TCKIMLIKNO TC_OGRENCI,FO.TAKMAAD,FO.ID_SINAV,FO.NET,FO.SS,ILK_ID_SINAV,ILK_NET,ILK_NET,ILK_SS,FREKANS,FO.DONEM
							,O.ID_SINIF,O.ID_SUBE,FO.ID_DERS,OGT.TCKIMLIKNO TC_OGRETMEN,OGK.AD+' '+OGK.SOYAD OGRETMENADSOYAD,D.AD DERSAD 
							,SB.AD SUBEAD,SNF.AD SINIFAD
					FROM	FrekansOgrenci				FO
					JOIN	v3Ogrenci					O	ON	O.ID_OGRENCI= FO.ID_OGRENCI
					JOIN	#DERSLER					D	ON	D.ID_DERS	= FO.ID_DERS
					JOIN	eokul_v2.dbo.DersOgretmen	OS	ON	OS.ID_SINIF	= O.ID_SINIF
															AND OS.ID_DERS	= FO.ID_DERS
															AND OS.ID_EGITIMTURU = 6 -- YAZILI 
					JOIN	OkyanusDB.dbo.v3Ogretmen	OGT ON	OGT.ID_OGRETMEN	= OS.ID_OGRETMEN
					JOIN	v3Kullanici					OGK	ON	OGK.TCKIMLIKNO	= OGT.TCKIMLIKNO
					JOIN	v3Sube						SB	ON	SB.ID_SUBE	= O.ID_SUBE
					JOIN	v3Sinif						SNF	ON	SNF.ID_SINIF= O.ID_SINIF
					WHERE	
						--	(FO.ID_SINAVTURU	=	0 AND ((0 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))) OR @ID_SINAVTURU='[]'))
						--AND (D.ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3)) OR @ID_KADEME3='[]')
						--AND (O.ID_SUBE			=	@ID_SUBE	OR @ID_SUBE	= 0)
						--AND (FO.TAKMAAD			=	@DERSAD		OR @DERSAD	= 'Tüm Dersler')
						--AND 
							(FO.DONEM			=	@DONEM)
							AND FO.ID_SINAVTURU = 0 -- YAZILI
					group by FO.ID_SINAVTURU,FO.ID_KADEME3,FO.ID_OGRENCI,FO.TCKIMLIKNO,FO.TAKMAAD,FO.ID_SINAV,FO.NET,FO.SS,ILK_ID_SINAV,ILK_NET,ILK_SS,FREKANS,FO.DONEM
							,O.ID_SINIF,O.ID_SUBE,FO.ID_DERS,OGT.TCKIMLIKNO,OGK.AD+' '+OGK.SOYAD ,D.AD  ,SB.AD,SNF.AD
			)
		END
		-- FREKANS OGRETMEN
		BEGIN
						

				DECLARE  @ID_STGENEL INT=9999

				
			--	INTO #SINAVTURU
			DROP TABLE IF EXISTS #SINAVTURU	
				DECLARE @SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				INSERT INTO @SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				INSERT INTO @SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
			SELECT * INTO #SINAVTURU FROM @SINAVTURU


			SELECT	 ID_SINAVTURU
					,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
			INTO #GenelFiltre2 FROM FrekansOgrenciDetay	T
			GROUP BY ID_SINAVTURU


			SELECT	 
						DERSAD
					,SUBEAD
					,OGRETMENADSOYAD
					,TC_OGRETMEN
					,T.ID_SUBE
					,ID_SINAVTURU
					,ID_KADEME3
			INTO #Filtre2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
			INTO #FiltreFrekans2 FROM #Filtre2	O
			INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
		UNION ALL			
			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
			FROM #Filtre2	O
			INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
		ORDER BY O.OGRETMENADSOYAD


			-- Öğretmen Genel
			SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SINAVTURU
		UNION ALL
			SELECT TC_OGRETMEN, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T			
			GROUP BY TC_OGRETMEN

			--DECLARE @GENELADET2 INT = (SELECT COUNT(DISTINCT TC_OGRETMEN) FROM #GenelFrekans2)

			SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
			INTO #GenelSira2 FROM #GenelFrekans2 T
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Genel
			SELECT TC_OGRETMEN, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, DERSAD, ID_SINAVTURU
		UNION ALL			
			SELECT TC_OGRETMEN, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, DERSAD


			SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD)
			INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelKampusFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE, ID_SINAVTURU
		UNION ALL
			SELECT TC_OGRETMEN, ID_SUBE, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE


			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
			INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreKampusFrekans2 FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU
		UNION ALL
			SELECT TC_OGRETMEN, ID_SUBE, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			FROM FrekansOgrenciDetay	T
			GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD), SUBEAD = S.AD
			INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
			INTO #OgrenciSinifListe2 
			FROM #Filtre2				O
			JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
											AND D.DERSAD = O.DERSAD 
											AND D.ID_SUBE = O.ID_SUBE 
											AND D.ID_SINAVTURU = O.ID_SINAVTURU 
											AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
		UNION ALL 			
			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
			FROM #Filtre2				O
			JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
											AND D.DERSAD = O.DERSAD 
											AND D.ID_SUBE = O.ID_SUBE 
											AND D.ID_SINAVTURU = O.ID_SINAVTURU 
											AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
			
			INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@ID_STGENEL,'GENEL','GNL',1,2)
				
			-- Liste
			SELECT 
				 [SINAV TÜRÜ]		= S.AD 
				,[STKISAAD]			= S.KISAAD
				,[BRANŞ]			= F.DERSAD
				,[TC_OGRETMEN]		= F.TC_OGRETMEN
				,[FREKANS]			= MAX(F.FREKANS)
				,[FREKANS KATKI]	= CASE 
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>75	THEN	'ÇOK ETKİLİ'
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>50	THEN	'ETKİLİ'
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>25	THEN	'NORMAL ETKİLİ'
										WHEN (AVG(F.FREKANS)/NULLIF((SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU ),0))>-1	THEN	'AZ ETKİLİ'
										ELSE 'ETKİSİZ'
									END
				,[KAMPÜS GENEL]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2	tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU)>1							then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU ORDER BY K.SUBEAD		FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))					
				,[GENEL ZÜMRE]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2		tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD )>1	then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU AND K.DERSAD = F.DERSAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))
				,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR)
				--,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET2 AS VARCHAR)
					,F.ID_SINAVTURU
			INTO	#T1
			FROM #FiltreFrekans2				F
			INNER JOIN #OgrenciSinifListe2	O ON O.TC_OGRETMEN	= F.TC_OGRETMEN		AND O.ID_SINAVTURU = F.ID_SINAVTURU		AND O.DERSAD = F.DERSAD		
			INNER JOIN #SINAVTURU			S ON S.ID_SINAVTURU = F.ID_SINAVTURU
			LEFT  JOIN #GenelSira2			G ON G.TC_OGRETMEN	= F.TC_OGRETMEN		AND G.ID_SINAVTURU = S.ID_SINAVTURU
			GROUP BY S.AD, F.TC_OGRETMEN, F.ID_SINAVTURU, F.DERSAD, G.SN,S.KISAAD

			TRUNCATE TABLE FrekansOgretmen

			--DELETE FROM FrekansOgretmen WHERE DONEM=@DONEM

			INSERT INTO FrekansOgretmen (SINAVTURU,STKISAAD,BRANS,TC_OGRETMEN,FREKANS,FREKANSKATKI,KAMPUSGENEL,GENELZUMRE,GENEL,ID_SINAVTURU)
			SELECT [SINAV TÜRÜ],STKISAAD,[BRANŞ],TC_OGRETMEN,FREKANS,[FREKANS KATKI],[KAMPÜS GENEL],[GENEL ZÜMRE],GENEL,ID_SINAVTURU FROM #T1 WHERE FREKANS IS NOT NULL ORDER BY TC_OGRETMEN,BRANŞ,ID_SINAVTURU

				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2

			--SELECT	 [SINAV TÜRÜ]	= SINAVTURU
			--		,STKISAAD
			--		,[BRANŞ]		= BRANS
			--		,TC_OGRETMEN
			--		,FREKANS
			--		,[FREKANS KATKI]= FREKANSKATKI
			--		,[KAMPÜS GENEL]	= KAMPUSGENEL
			--		,[GENEL ZÜMRE]	=GENELZUMRE
			--		,GENEL
			--		,ID_SINAVTURU FROM FrekansOgretmen
			----where TC_OGRETMEN='46846434098'
			--ORDER BY TC_OGRETMEN,BRANS,ID_SINAVTURU
		END

			DROP TABLE #EgitimTuru

	END
	


	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_FrekansSistem]...';


GO
ALTER procedure [dbo].[sp_FrekansSistem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON					= @SQLJSON		
			,FREKANSKARNE				= @FREKANSKARNE	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--	exec sp_FrekansSistem @ISLEM=2,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN

	DECLARE @ID_STGENEL INT=9999
		
		BEGIN

			--	INTO #SINAVTURU
			DROP TABLE IF EXISTS #SINAVTURU	
				DECLARE @SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				INSERT INTO @SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				INSERT INTO @SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
			SELECT * INTO #SINAVTURU FROM @SINAVTURU

			--	INTO #DERSLER
			DROP TABLE IF EXISTS #DERSLER						
			SELECT	D.* 
			INTO	#DERSLER 
			FROM	v3SinavDers D
			INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD


		END
		
		IF @DONEM=''
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		END

--	exec sp_FrekansSistem @TCKIMLIKNO='36412660570',@FREKANSKARNE=1 ,@OTURUM='23C46AF7-B1C6-4B9D-8782-530181048CBA',@ISLEM=2,@DERSAD='Tümü',@DONEM='',@ID_SUBE=0,@ID_KADEME3='[0]',@ID_SINAVTURU='[-1]',@ID_SINIF=101676,@TC_OGRETMEN='36412660570'
		IF @ISLEM =	1-- 
		BEGIN 
		

--DECLARE @DERSAD VARCHAR(MAX) = 'GEOMETRİ', @ID_SUBE INT = 236, @ID_KADEME3 VARCHAR(MAX) = '[0,15,16,17,18]', @ID_SINAVTURU VARCHAR(MAX) = '[2,6]'

			SELECT	 
					 DERSAD
					,SUBEAD
					,OGRETMENADSOYAD
					,TC_OGRETMEN
					,T.ID_SUBE
					,ID_SINAVTURU
					,ID_KADEME3
			INTO #Filtre FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				AND (DERSAD	= @DERSAD OR @DERSAD = 'Tümü') 
				AND (ID_SUBE = @ID_SUBE OR @ID_SUBE = 0) 
				AND DONEM=@DONEM
			GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
			INTO #FiltreFrekans FROM #Filtre	O
			INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
			ORDER BY O.OGRETMENADSOYAD


			-- Öğretmen Genel
			SELECT TC_OGRETMEN, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN

			DECLARE @GENELADET INT = (SELECT COUNT(DISTINCT TC_OGRETMEN) FROM #GenelFrekans)

			SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC)
			INTO #GenelSira FROM #GenelFrekans
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Genel
			SELECT TC_OGRETMEN, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN, DERSAD


			SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans G WHERE G.DERSAD = F.DERSAD)
			INTO #GenelZumreSira FROM #GenelZumreFrekans	F
			WHERE FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelKampusFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN, ID_SUBE


			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
			INTO #GenelKampusSira FROM #GenelKampusFrekans	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------

			-- Öğretmen Zümre Kampus Genel
			SELECT TC_OGRETMEN, ID_SUBE, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
			INTO #GenelZumreKampusFrekans FROM FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
			GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

			SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD), SUBEAD = S.AD
			INTO #GenelZumreKampusSira FROM #GenelZumreKampusFrekans	F
			INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
			WHERE F.FREKANS IS NOT NULL
			--------------------------------------------------------------------


			SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
			INTO #OgrenciSinifListe 
			FROM #Filtre					O
			INNER JOIN FrekansOgrenciDetay	D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
			GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

			-- Liste
			SELECT 
					 [SIRA]				= CASE WHEN @DERSAD = 'Tümü' THEN ISNULL(G.SN,9999) ELSE (SELECT MIN(SN) FROM #GenelZumreSira K WHERE K.TC_OGRETMEN=F.TC_OGRETMEN AND K.DERSAD=@DERSAD )   END
					,[BRANŞ]			= F.DERSAD 
					,[KAMPÜS]			= ISNULL( (SELECT STUFF((SELECT   '<br>' +CAST(K.SUBEAD AS VARCHAR)	FROM #GenelKampusSira K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[ÖĞRETMEN]			= F.OGRETMENADSOYAD 
					,[SORU SAYISI]		= SORUSAYISI
					,[HB NET]			= F.HBNET
					,[TC_OGRETMEN]		= F.TC_OGRETMEN
					,[FREKANS]			= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')
					,[SINIF SAYISI]		= O.SINIFSAY
					,[ÖĞRENCİ SAYISI]	= O.OGRSAY
					,[KAMPÜS ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN  AND K.DERSAD = tt.DERSAD )>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira	K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[KAMPÜS GENEL]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[GENEL ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND K.DERSAD = tt.DERSAD )>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
					,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET AS VARCHAR),'-')
					
			INTO		#T
			FROM		#FiltreFrekans		F
			INNER JOIN #OgrenciSinifListe	O ON O.TC_OGRETMEN = F.TC_OGRETMEN AND O.DERSAD = F.DERSAD
			LEFT  JOIN #GenelSira			G ON G.TC_OGRETMEN = F.TC_OGRETMEN

		
			select(
						select * from(
							select 
							(					
								SELECT		*
								FROM		#T 
								--ORDER BY [GENEL]--[ÖĞRETMEN]	,[GENEL]
								order by SIRA
								FOR JSON AUTO
							) as t												
						) as tablo FOR JSON AUTO
					) as tt
					
			DROP TABLE IF EXISTS #T
			DROP TABLE IF EXISTS #Filtre
			DROP TABLE IF EXISTS #FiltreFrekans
			DROP TABLE IF EXISTS #OgrenciSinifListe 

			DROP TABLE IF EXISTS #GenelFrekans
			DROP TABLE IF EXISTS #GenelSira

			DROP TABLE IF EXISTS #GenelZumreFrekans
			DROP TABLE IF EXISTS #GenelZumreSira

			DROP TABLE IF EXISTS #GenelKampusFrekans
			DROP TABLE IF EXISTS #GenelKampusSira

			DROP TABLE IF EXISTS #GenelZumreKampusFrekans
			DROP TABLE IF EXISTS #GenelZumreKampusSira

		


		END
		IF @ISLEM = 2 -- GENEL SIRALAMA 
		BEGIN 

			SELECT	 [SINAV TÜRÜ]	= SINAVTURU
					,STKISAAD
					,[BRANŞ]		= BRANS
					,TC_OGRETMEN
					,FREKANS
					,[FREKANS KATKI]= FREKANSKATKI
					,[KAMPÜS GENEL]	= KAMPUSGENEL
					,[GENEL ZÜMRE]	=GENELZUMRE
					,GENEL
					,ID_SINAVTURU 
			INTO	#T1
			FROM	FrekansOgretmen
			WHERE	TC_OGRETMEN	= @TCKIMLIKNO


			-- frekans karne değil ise  veya (ders,sinav türü,sınıf)tümü seçilmemişse Frekansogretmendeki gösterecek
			IF (@FREKANSKARNE=0 
				OR (	@DERSAD<>'Tümü' 
					AND -1	NOT IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) 
					AND 0	NOT IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3)) 					
					)
				)
			BEGIN
		
				SELECT	 ID_SINAVTURU
						,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
				INTO #GenelFiltre2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
					AND (DERSAD		= @DERSAD OR @DERSAD = 'Tümü') 
				GROUP BY ID_SINAVTURU


				SELECT	 
							DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
				INTO #Filtre2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
					AND (DERSAD		= @DERSAD OR @DERSAD = 'Tümü') 
					AND (ID_SUBE	= @ID_SUBE OR @ID_SUBE = 0)
					AND TC_OGRETMEN	= @TC_OGRETMEN
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			
				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
				INTO #FiltreFrekans2 FROM #Filtre2	O
				INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
			UNION ALL			
				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
				FROM #Filtre2	O
				INNER JOIN FrekansOgrenciDetay		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
			ORDER BY O.OGRETMENADSOYAD


				-- Öğretmen Genel
				SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SINAVTURU
			UNION ALL				
				SELECT TC_OGRETMEN, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T			
				GROUP BY TC_OGRETMEN

				SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
				INTO #GenelSira2 FROM #GenelFrekans2 T
				WHERE FREKANS IS NOT NULL
				
				--------------------------------------------------------------------

				-- Öğretmen Zümre Genel
				SELECT TC_OGRETMEN, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, DERSAD, ID_SINAVTURU
			UNION ALL			
				SELECT TC_OGRETMEN, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, DERSAD


				SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
				INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE, ID_SINAVTURU
			UNION ALL
				SELECT TC_OGRETMEN, ID_SUBE, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
				INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Zümre Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreKampusFrekans2 FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU
			UNION ALL
				SELECT TC_OGRETMEN, ID_SUBE, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				FROM FrekansOgrenciDetay	T
				WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )))
				GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
				INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------


				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
				INTO #OgrenciSinifListe2 
				FROM #Filtre2				O
				JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
												AND D.DERSAD = O.DERSAD 
												AND D.ID_SUBE = O.ID_SUBE 
												AND D.ID_SINAVTURU = O.ID_SINAVTURU 
												AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
			UNION ALL 			
				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
				FROM #Filtre2				O
				JOIN FrekansOgrenciDetay	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
												AND D.DERSAD = O.DERSAD 
												AND D.ID_SUBE = O.ID_SUBE 
												AND D.ID_SINAVTURU = O.ID_SINAVTURU 
												AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

			
				INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@ID_STGENEL,'GENEL','GNL',1,2)

				-- Liste
				DELETE FROM #T1

				INSERT INTO #T1
				SELECT 
					 [SINAV TÜRÜ]		= S.AD 
					,[STKISAAD]			= S.KISAAD
					,[BRANŞ]			= F.DERSAD
					,[TC_OGRETMEN]		= F.TC_OGRETMEN
					,[FREKANS]			= MAX(F.FREKANS)
					,[FREKANS KATKI]	= CASE 
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>75	THEN	'ÇOK ETKİLİ'
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>50	THEN	'ETKİLİ'
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>25	THEN	'NORMAL ETKİLİ'
											WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>-1	THEN	'AZ ETKİLİ'
											ELSE 'ETKİSİZ'
										END
					,[KAMPÜS GENEL]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2	tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)								FROM #GenelKampusSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))					
					,[GENEL ZÜMRE]		= (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2		tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD )>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)		FROM #GenelZumreSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD  AND K.ID_SINAVTURU=F.ID_SINAVTURU FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, ''))
					,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR)
					--,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET2 AS VARCHAR)
					--,[GENEL]			= CASE WHEN G.ID_SINAVTURU=@ID_STGENEL THEN CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET3 AS VARCHAR) ELSE CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET2 AS VARCHAR) END 
						,F.ID_SINAVTURU
				--INTO	#T1
				FROM #FiltreFrekans2				F
				INNER JOIN #OgrenciSinifListe2	O ON O.TC_OGRETMEN	= F.TC_OGRETMEN		AND O.ID_SINAVTURU = F.ID_SINAVTURU		AND O.DERSAD = F.DERSAD		
				INNER JOIN #SINAVTURU			S ON S.ID_SINAVTURU = F.ID_SINAVTURU
				LEFT  JOIN #GenelSira2			G ON G.TC_OGRETMEN	= F.TC_OGRETMEN		AND G.ID_SINAVTURU = S.ID_SINAVTURU
				GROUP BY S.AD, F.TC_OGRETMEN, F.ID_SINAVTURU, F.DERSAD, G.SN,S.KISAAD

		

			END


			-------------------------------------------------	(2.2)	2. SAYFA ALT


			print 11
			SELECT	 DERSAD
					,SUBEAD
					,OGRETMENADSOYAD
					,MAX(T.SS) SORUSAYISI
					,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
					--,CAST(AVG(FREKANS) AS decimal(8,2)) FREKANS --coalesce(some_column, 0)
					,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
					,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
					,TC_OGRETMEN
					,ID_DERS
					,T.ID_SUBE
					,T.ID_SINAVTURU
					,ID_SINIF
					,SINIFAD
					,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
					,AVG(ILK_SS) ILK_SS
			INTO	#ORTALAMA3
			FROM	FrekansOgrenciDetay	T
			WHERE	(ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)) OR  -1 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
				AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @ID_KADEME3  )) )
				AND (DERSAD		= @DERSAD OR @DERSAD = 'Tümü') 
				AND (ID_SUBE	= @ID_SUBE OR @ID_SUBE = 0)
				AND TC_OGRETMEN	= @TC_OGRETMEN
				--AND FREKANS IS NOT NULL
			GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD


			SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
					,[BRANŞ]		= DERSAD
					,[SINAV TÜRÜ]	= ST.AD
					,[KAMPÜS]		= SUBEAD
					,[SINIF]		= ORT.SINIFAD	
					,[H.B. NET ORT.]= ORT.HBNET	
					,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
					,ORT.FREKANS		
					,ID_SINIF
					,TC_OGRETMEN
					,SIRA
					,ORT.ID_SINAVTURU
			INTO	#T2
			FROM	#ORTALAMA3	ORT
			JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
									AND ST.SIRA			<> 2
			WHERE	ORT.FREKANS IS NOT NULL
			ORDER BY ST.SIRA


			select(
						select * from(
							select 
							(						 
								SELECT * FROM #T1
								ORDER BY BRANŞ,ID_SINAVTURU
								FOR JSON AUTO
							) as t1
							,( 
								SELECT * FROM #T2
								ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
								FOR JSON AUTO
							)as t2							
						) as tablo FOR JSON AUTO
					) as tt


					
					
			DROP TABLE IF EXISTS #ORTALAMA3
			DROP TABLE IF EXISTS #T2
				DROP TABLE #T1
				DROP TABLE #Filtre2
				DROP TABLE #GenelFiltre2
				DROP TABLE #FiltreFrekans2
				DROP TABLE #OgrenciSinifListe2 

				DROP TABLE #GenelFrekans2
				DROP TABLE #GenelSira2

				DROP TABLE #GenelZumreFrekans2
				DROP TABLE #GenelZumreSira2

				DROP TABLE #GenelKampusFrekans2
				DROP TABLE #GenelKampusSira2

				DROP TABLE #GenelZumreKampusFrekans2
				DROP TABLE #GenelZumreKampusSira2

				
			DROP TABLE IF EXISTS #T
			DROP TABLE IF EXISTS #Filtre
			DROP TABLE IF EXISTS #FiltreFrekans
			DROP TABLE IF EXISTS #OgrenciSinifListe 

			DROP TABLE IF EXISTS #GenelFrekans
			DROP TABLE IF EXISTS #GenelSira

			DROP TABLE IF EXISTS #GenelZumreFrekans
			DROP TABLE IF EXISTS #GenelZumreSira

			DROP TABLE IF EXISTS #GenelKampusFrekans
			DROP TABLE IF EXISTS #GenelKampusSira

			DROP TABLE IF EXISTS #GenelZumreKampusFrekans
			DROP TABLE IF EXISTS #GenelZumreKampusSira
		END	
		IF @ISLEM = 3
		BEGIN 

			SELECT	[KAMPÜS]	= SUBEAD,
					[SINIF]		= SINIFAD,
					[BRANŞ]		= TAKMAAD,
					[SINAV TÜRÜ]= ST.AD,
					[AD SOYAD]	= K.AD+' '+K.SOYAD,
					[SORU SAYISI]=MAX(T.ILK_SS),
					[H.B NET]	= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
					[NET ORT]	= CAST(AVG(T.NET) AS DECIMAL(8,2)),
					[HEDEFE UZAKLIK]= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),
					--[HEDEF]		= 100,--T.ILK_SS-T.ILK_NET,
					--[FREKANS]	= CAST(AVG(FREKANS) AS DECIMAL(8,2))					
					[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					,TC_OGRENCI,TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU--,ID_SINAV
			INTO	#FREKANSOGRENCI
			FROM	FrekansOgrenciDetay	T
			JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
			JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
			WHERE 	T.ID_SINIF	= @ID_SINIF
				AND TC_OGRETMEN	= @TC_OGRETMEN
				AND T.DERSAD	= @DERSAD
				AND FREKANS		IS NOT NULL
				AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
			GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET--,ID_SINAV

			--SELECT * FROM #FREKANSOGRENCI ORDER BY OGRENCIADSOYAD

			select(
						select * from(
							select 
							(					
								SELECT		* 
								FROM		#FREKANSOGRENCI 
								ORDER BY	[AD SOYAD]
								FOR JSON AUTO
							) as t3
												
						) as tablo FOR JSON AUTO
					) as tt
			DROP TABLE #FREKANSOGRENCI
		END
		IF @ISLEM = 4
		BEGIN 

			SELECT	 SUBEAD
					,TAKMAAD
					,ST.AD SINAVTURU
					,CASE 
						WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
						ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
					END SINAVADI
					,CAST(CASE 
						WHEN ST.ID_SINAVTURU=0 THEN (	
														SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
														INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
														WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
														GROUP BY YO.TELAFI
													) 
						ELSE						(	T.FREKANS
													) 
					END AS decimal(8,2)) SINAVPUANI
					,K.AD+' '+K.SOYAD ADSOYAD
					,SINIFAD
					,SS 
					,HBNET
					,ILK_SS HEDEF
					,NET
			INTO	#OGRENCISINAV
			FROM	FrekansOgrenciDetay	T
			JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
			JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
			WHERE	TC_OGRENCI		=	@TC_OGRENCI
				AND TAKMAAD			=	@DERSAD
				AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
				AND T.FREKANS IS NOT NULL
			GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET

			IF (SELECT COUNT(1) FROM #OGRENCISINAV)>1
			BEGIN
				INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET)
				SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,HBNET,HEDEF,CAST(AVG(NET) AS DECIMAL(8,2))
				FROM	#OGRENCISINAV 
				GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HBNET,HEDEF
			END

			select(
						select * from(
							select 
							(					
								SELECT		[KAMPÜS]		= SUBEAD,
											[SINIF]			= SINIFAD,
											[BRANŞ]			= TAKMAAD,
											[SINAV TÜRÜ]	= SINAVTURU,
											[SINAV]			= SINAVADI,
											[SORU SAYISI]	= SS,
											[H.B. NET ORT.] = HBNET,
											[HEDEFE UZAKLIK]= HEDEF-HBNET,
											[SON NET]		= NET,
											[PUAN]			= SINAVPUANI,
											[FREKANS]		= SINAVPUANI,
											ADSOYAD
								FROM		#OGRENCISINAV 
								FOR JSON AUTO
							) as t4
												
						) as tablo FOR JSON AUTO
					) as tt
			
			DROP TABLE IF EXISTS #OGRENCISINAV
		END
		IF @ISLEM = 5
		BEGIN 
			
					
			

			DECLARE @SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
			IF (0 IN (SELECT VALUE FROM OPENJSON( @ID_SINAVTURU)))
			BEGIN

					SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
							,'FREKANS' SINAVADI
					INTO	#FREKANSOGRETMEN2
					FROM	FrekansOgrenciDetay	T
					JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
					WHERE 	TC_OGRETMEN	= @TC_OGRETMEN --'56377383260'
						AND FREKANS IS NOT NULL
						AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
						--AND ID_SINAVTURU=0
					GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

					SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO ##PIVOT  FROM #FREKANSOGRETMEN2

					INSERT INTO @SINAVLAR (SINAVADI) VALUES ('FREKANS')

			END
			ELSE
			BEGIN

					SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
							,CASE 
								WHEN ST.ID_SINAVTURU=0 THEN (SELECT TOP 1 AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
								ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
							END SINAVADI
					INTO	#FREKANSOGRETMEN
					FROM	FrekansOgrenciDetay	T
					JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
					WHERE 	TC_OGRETMEN	= @TC_OGRETMEN --'56377383260'
						AND FREKANS IS NOT NULL
						AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @ID_SINAVTURU))
						--AND ID_SINAVTURU=0
					GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

					--TAHSİN--
					INSERT INTO #FREKANSOGRETMEN
					SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,999999999 as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
							,ST.KISAAD+' ORT' as SINAVADI
					FROM	FrekansOgrenciDetay	T
					JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
					WHERE 	TC_OGRETMEN	= @TC_OGRETMEN --'56377383260'
						AND FREKANS IS NOT NULL
						AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
						--AND ID_SINAVTURU=0
					GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
					--TAHSİN--
					
					DECLARE @cols	AS NVARCHAR(MAX),
							@cols2	AS NVARCHAR(MAX),
							@cols3	AS NVARCHAR(MAX),
							@SQL	AS NVARCHAR(MAX);

					--SET @cols = STUFF((SELECT distinct ',' + QUOTENAME(c.SINAVADI) 
					--			FROM #FREKANSOGRETMEN c
					--			FOR XML PATH(''), TYPE
					--			).value('.', 'NVARCHAR(MAX)') 
					--		,1,1,'')

					--SET @cols2 = STUFF((SELECT distinct ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
					----',' + QUOTENAME(c.SINAVADI) 
					--			FROM #FREKANSOGRETMEN c
					--			FOR XML PATH(''), TYPE
					--			).value('.', 'NVARCHAR(MAX)') 
					--		,1,1,'')

					--		--SUM DAN DOLAYI SORUN OLABILIR
					--SET @cols3 = STUFF((SELECT distinct ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
					----',' + QUOTENAME(c.SINAVADI) 
					--			FROM #FREKANSOGRETMEN c
					--			FOR XML PATH(''), TYPE
					--			).value('.', 'NVARCHAR(MAX)') 
					--		,1,1,'')

					--TAHSİN--
					SET @cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
								FROM #FREKANSOGRETMEN c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
								FOR XML PATH(''), TYPE
								).value('.', 'NVARCHAR(MAX)') 
							,1,1,'')
		
					SET @cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
					--',' + QUOTENAME(c.SINAVADI) 
								FROM #FREKANSOGRETMEN c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
								FOR XML PATH(''), TYPE
								).value('.', 'NVARCHAR(MAX)') 
							,1,1,'')

							--SUM DAN DOLAYI SORUN OLABILIR
					SET @cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
					--',' + QUOTENAME(c.SINAVADI) 
								FROM #FREKANSOGRETMEN c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
								FOR XML PATH(''), TYPE
								).value('.', 'NVARCHAR(MAX)') 
							,1,1,'')
					--TAHSİN--


					SET @SQL='SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols2 AS varchar(MAX))+' INTO ##PIVOT1 FROM (
						SELECT * FROM #FREKANSOGRETMEN
					)AS TABLO
					PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@cols AS varchar(MAX))+')) AS P'
					

					EXECUTE (@SQL)

					set @SQL='
						SELECT		TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols3 AS varchar(MAX))+'
								INTO		##PIVOT
								FROM		##PIVOT1 
								group by TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]'

								execute (@SQL)
								

					INSERT INTO @SINAVLAR (SINAVADI)
						SELECT	DISTINCT SINAVADI
						FROM	#FREKANSOGRETMEN
			END
			select(
						select * from(
							select 
							(					
								SELECT		*
								FROM		##PIVOT 
								FOR JSON AUTO
							) as t5,
							(					
								SELECT	SINAVADI
								FROM	@SINAVLAR
								FOR JSON AUTO
							) as t6
												
						) as tablo FOR JSON AUTO
					) as tt

			DROP TABLE ##PIVOT
			DROP TABLE ##PIVOT1
			DROP TABLE #FREKANSOGRETMEN
			DROP TABLE #FREKANSOGRETMEN2
			
		END
		IF @ISLEM = 6 -- DERSLER
		BEGIN 
			
			select(
						select * from(
							select 
							(	

								SELECT	DISTINCT D.AD
								FROM	#DERSLER			D
								JOIN	FrekansOgrenciDetay OD	ON	OD.DERSAD=D.AD
								WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@ID_KADEME3)) 
									AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU)) 

								FOR JSON AUTO
							) as t5
												
						) as tablo FOR JSON AUTO
					) as tt
		END
		IF @ISLEM = 7 -- SINAV TURU
		BEGIN 
			
			

			select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
			INTO #GrupSinavTuru 
			from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
		union 
			select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
		union 
			select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
		union 
			select 0,15 , 'YAZILI', 'YAZ'
		union 
			select 0,16 , 'YAZILI', 'YAZ'
		union 
			select 0,17 , 'YAZILI', 'YAZ'
		union 
			select 0,18 , 'YAZILI', 'YAZ'

				INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
				SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
				FROM v3Kademe3	K
				JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
				WHERE ID_KADEME3 IN ( 11,12,13,14)


				INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
				SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
				FROM v3Kademe3	K
				WHERE ID_KADEME3 IN ( 11,12,13,14)

					
			SELECT distinct	ID_SINAVTURU,AD,KISAAD
			FROM	#GrupSinavTuru 
			WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@ID_KADEME3)) 


			drop table #GrupSinavTuru
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_GelisimRaporu]...';


GO
ALTER procedure [dbo].[sp_GelisimRaporu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVPUANTURUs	VARCHAR(MAX)	= NULL,
	@TN					bit				= 1,
	@SQLJSON			NVARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,TC_OGRENCI					= @TC_OGRENCI			
			,TC_OGRETMEN				= @TC_OGRETMEN		
			,OTURUM						= @OTURUM				
			,IL							= @IL					
			,ILCE						= @ILCE				
			,ID_MENU					= @ID_MENU			
			,DONEM						= @DONEM				
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,ID_SINAV					= @ID_SINAV			
			,ID_DERS					= @ID_DERS			
			,ID_SUBE					= @ID_SUBE			
			,ID_SINIF					= @ID_SINIF			
			,DOSYAADI					= @DOSYAADI			
			,DOSYAGUID					= @DOSYAGUID			
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA		
			,DERSAD						= @DERSAD				
			,ID_DERSs					= @ID_DERSs			
			,ID_SINAVPUANTURUs			= @ID_SINAVPUANTURUs	
			,TN							= @TN					
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--EXEC [sp_GelisimRaporu] @ISLEM=1,@TCKIMLIKNO='34454003058',@OTURUM='AF6EC483-F078-4F55-AAAD-A4FFD02604D4',@DONEM='2017',@ID_DERS=153

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END
	--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1 OR @ISLEM = 2
		BEGIN			
			SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			INTO	#GelisimRaporu
			FROM	Sinav					S
			JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
												AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
			JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
												AND K3.ID_KADEME3		= S.ID_KADEME3
			WHERE	S.DURUM			= 2 
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.DONEM			= @DONEM
				AND SO.TCKIMLIKNO	= @TC_OGRENCI
				AND (D.DERSAD IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))	OR ('TÜMÜ' IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))))		
			ORDER BY S.SINAVTARIH
				
			SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
			INTO	#GelisimRaporu2	
			FROM	#GelisimRaporu 		G		
			GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
			ORDER BY DERSAD
			
			INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
			SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
					[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
			FROM	#GelisimRaporu2 	G	
			JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
													AND SINAVLIST.DERSAD=G.DERSAD
			GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD
			
			------------------------------------------------------------------------
			-- PUANLAR

			SELECT S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
			INTO #Sonuc
			FROM SinavOgrenci				SO 
			JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
												AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
			JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
												AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
			JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2 
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.PUANGIZLE		= 0
				AND SO.TCKIMLIKNO	= @TC_OGRENCI
				AND S.DONEM			= @DONEM
				AND (D.DERSAD IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))	OR ('TÜMÜ' IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))))	
				--AND (SD.ID_DERS		IN (SELECT SUBSTRING(VALUE,3,999) FROM OPENJSON(@ID_DERSs))	OR ('D-0' IN (SELECT VALUE FROM OPENJSON(@ID_DERSs))))	
			
			SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
			INTO	#Sonuc2
			FROM	#Sonuc	S
			WHERE	KOD		IN (SELECT VALUE FROM OPENJSON(@ID_SINAVPUANTURUs))
			--WHERE	KOD		IN (SELECT  SUBSTRING(VALUE,3,999)  FROM OPENJSON(@ID_SINAVPUANTURUs))

			SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
					,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
			INTO	#Puan
			FROM	#Sonuc2			S
			JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
			GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			SELECT DISTINCT	G.ID_SINAV, G.TCKIMLIKNO,G.SINAVAD,G.ID_SINAVPUANTURU,G.PUANTURU		
			INTO #Puan2			
			FROM #Puan G
			GROUP BY G.ID_SINAV, G.TCKIMLIKNO,G.SINAVAD,G.ID_SINAVPUANTURU,G.SINAVAD,G.PUANTURU

			
			SELECT DISTINCT TCKIMLIKNO INTO #OGRENCI FROM #GelisimRaporu
					
			IF @ISLEM = 1 -- JSON SEND
			BEGIN
				select(
					select * 
					from(
						select 
						(					
							SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, G.SORUSAYISI, 
									[SINAV ADI] = SINAVAD, [DOĞRU] = DOGRU,[YANLIŞ] = YANLIS,[BOŞ] = BOS,NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET		-- SINAVLIST
							FROM	#GelisimRaporu2 	G	
							JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
																	AND SINAVLIST.DERSAD=G.DERSAD
							ORDER BY DERSAD,ID_SINAVTURU,TIP,SINAVTARIH
							FOR JSON AUTO
						) as t1,
						(
							SELECT DISTINCT	
									 ID_SINAV
									,TCKIMLIKNO
									,[SINAV ADI]	= SINAVAD
									,[DOĞRU]		= SUM(DOGRU) 
									,[YANLIŞ]		= SUM(YANLIS) 
									,[BOŞ]			= SUM(BOS) 
									,NET			= SUM(NET) 
									,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
									,SS				= SUM(DOGRU+YANLIS+BOS)
							FROM	#Sonuc	
							GROUP BY ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,SINAVAD

							FOR JSON AUTO
						) AS t2,
						(	
							SELECT DISTINCT	 G.TCKIMLIKNO,G.ID_SINAVPUANTURU,G.PUANTURU
									,[SINAV ADI] = P.SINAVAD,P.ID_SINAVPUANTURU,P.PUAN,[BAŞARI %] = P.BASARI-- ,P.PTKOD
							FROM #Puan G
							JOIN #Puan P	ON	P.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
							FOR JSON AUTO
						) AS t3,
						(
							SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
							FROM EtutOgrenci EO
							INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
							INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
							INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
							WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
							GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
							ORDER BY O.TCKIMLIKNO, E.TARIH DESC
							FOR JSON PATH
						) AS t4					
					) as tablo FOR JSON AUTO
				) as tt
			END
			IF @ISLEM = 2 -- DATASET
			BEGIN
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET		-- SINAVLIST
						,K.AD+ ' ' + K.SOYAD ADSOYAD, S.AD SUBEAD,SN.AD SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				JOIN	OkyanusDB.DBO.v3Ogrenci		O	ON	O.TCKIMLIKNO	= G.TCKIMLIKNO
				JOIN	OkyanusDB.DBO.v3Kullanici	K	ON	K.TCKIMLIKNO	= G.TCKIMLIKNO
				JOIN	OkyanusDB.DBO.v3Sube		S	ON	S.ID_SUBE		= O.ID_SUBE
				JOIN	OkyanusDB.DBO.v3Sinif		SN	ON	SN.ID_SINIF		= O.ID_SINIF
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT DISTINCT	
							ID_SINAV
						,TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= SUM(DOGRU+YANLIS+BOS)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
				FROM	#Sonuc	
				--WHERE	@TN=1
				GROUP BY ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,SINAVAD
							
				SELECT DISTINCT	 G.TCKIMLIKNO,G.ID_SINAVPUANTURU,G.PUANTURU
						,[SINAV ADI] = P.SINAVAD,P.ID_SINAVPUANTURU,P.PUAN,[BAŞARI %] = P.BASARI	--,P.PTKOD
				FROM #Puan G
				JOIN #Puan P	ON	P.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU

				SELECT TCKIMLIKNO FROM #OGRENCI

				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
							
			END
			DROP TABLE #OGRENCI
			DROP TABLE #GelisimRaporu
			DROP TABLE #GelisimRaporu2
			
			DROP TABLE #Puan
			DROP TABLE #Puan2
			DROP TABLE #Sonuc
			DROP TABLE #Sonuc2

		END
		
		IF @ISLEM = 3 -- Gelişim Raporu Filtre
		BEGIN 			
			--declare @ID_KADEME3 int =0 , @TCKIMLIKNO VARCHAR(MAX)='19070248786'
			
			IF @DONEM IS NULL OR @DONEM =''
			BEGIN
				SELECT @DONEM= DONEM FROM v3AktifDonem WHERE AKTIF=1
			END
				
		
			SELECT 'D-0' ID,'TÜMÜ' AD, 'DERS' DEGER INTO #GELISIMFILTRE
		UNION ALL
			SELECT	DISTINCT 
					--'D-'+CAST(D.ID_DERS AS VARCHAR) ID
					--,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.AD) AD
					'D-1' ID
					,'D-'+UPPER(D.DERSAD) AD
					,'DERS' DEGER 
			FROM	SinavOgrenci		SO
			JOIN	SinavOgrenciPuan	SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
											AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			JOIN	Sinav				S	ON	S.ID_SINAV			= SO.ID_SINAV
			JOIN	SinavDers			SD	ON	SD.ID_SINAV			= SO.ID_SINAV 
			JOIN	eokul_v2.dbo.Ders	D	ON	D.ID_DERS			= SD.ID_DERS 
			JOIN	v3Kademe3			K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
			WHERE	SO.TCKIMLIKNO	= @TC_OGRENCI
				AND S.DONEM			= @DONEM 
		UNION ALL
			SELECT  'P-'+PT.KOD , 'P-'+PT.KOD, 'PT' DEGER  
			FROM SinavOgrenci		SO
			JOIN SinavOgrenciPuan	SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
										AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			WHERE SO.TCKIMLIKNO=@TC_OGRENCI
			GROUP BY PT.KOD
		UNION ALL
			SELECT 'T-0','TOPLAM NET','TN' DEGER


				select(
						select * from(
							select 
							(					
								SELECT	DISTINCT ID, AD,DEGER
								FROM	#GELISIMFILTRE 
								ORDER BY DEGER

								FOR JSON AUTO
							) as GELISIMFILTRE 
												
						) as tablo FOR JSON AUTO
					) as tt
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_GelisimRaporuLS]...';


GO
ALTER procedure [dbo].[sp_GelisimRaporuLS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL 
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,RAPORTURLIST				= @RAPORTURLIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @ID_LOG > 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
			INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	

		IF (@ISLEM=4)
		BEGIN
		
			--DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

			INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
					TCKIMLIKNO	 VARCHAR(MAX),
					DERSAD VARCHAR(MAX),
					ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
					TCKIMLIKNO	 VARCHAR(MAX),
					DERSAD VARCHAR(MAX),
					ID_DERS INT,
					SINAVADI VARCHAR(MAX),
					ID_SINAVRAPOR INT,
					PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
			SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
					DOGRU DECIMAL(8,2),
					YANLIS DECIMAL(8,2),
					BOS DECIMAL(8,2),
					YUZDE DECIMAL(8,2),
					TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
					INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
			SELECT (
						SELECT 						
							--ÖĞRENCİ
							OGRENCI							= (	SELECT * 
																FROM #TEMP_OGRENCI 
																FOR JSON PATH)					
							--DERS ÖĞRETMEN
							,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
																FROM #TEMP_DERS_OGRETMEN 
																ORDER BY DERSAD, ADSOYAD
																FOR JSON PATH)
							--YOKLAMA DERS
							,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
																FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
																ORDER BY DERSAD FOR JSON PATH)
							-- YAZILI YOKLAMA SONUÇLARI
							,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
																, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
																FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
																JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
																JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
																WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
																	OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
																ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
																FOR JSON PATH)  
							--DENEME SINAVI DERSLERI
							,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
																		ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= T.DERSAD 
																	,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
																	,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
																FROM	#TEMP_DENEME_SONUCLARI_T	T
																JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
																--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
																ORDER BY ST.AD, BOLUMNO, T.DERSAD
																FOR JSON AUTO)
							--DENEME SINAVI DERSLERI
							,DENEMESINAVILISTESI			= (
																	SELECT	 DISTINCT 
																			ST.ID_SINAVTURU
																		,SINAVTURU	= ST.AD
																		,SINAVAD
																		,ID_SINAV
																		,SINAVTARIH
																	FROM	#TEMP_DENEME_SONUCLARI_T	T
																	JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
																	ORDER BY ST.AD, T.SINAVTARIH
																	FOR JSON AUTO
																)
							-- DENEME SINAVI SONUCLARI
							,DENEMESINAVISONUCLARI			=  (
																	SELECT	 ST.ID_SINAVTURU
																			,SINAVTURU	= ST.AD
																			,DERSAD		= TT.DERSAD 
																			,TT.ID_SINAV
																			,TT.OLCEKSINAVI
																			,TD = ISNULL(T2.TD,0)
																			,TY = ISNULL(T2.TY,0)
																			,TB = ISNULL(T2.TB,0)
																			,TN = ISNULL(T2.TN,0)
																			,TT.SINAVAD																	
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																			,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																			,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
																	FROM	#TEMP_DENEME_SONUCLARI_T	T
																	JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
																	JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																											AND SD.ID_SINAV			= T.ID_SINAV
																	JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																											AND TT.DERSAD			= T.DERSAD
																	JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																											AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
																	ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
																	FOR JSON AUTO
																)
								-- GELİŞİM ANALİZİ DERSLERİ
								,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
																	[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
																	[SINAVADI] = SINAVAD, 
																	[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
																	[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
																	[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
																	NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
																	,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
																FROM	#TEMP_GELISIM_RAPORU_2 	G	
																JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																												AND SINAVLIST.DERSAD		= G.DERSAD
																												AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
																JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
																ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
								--GELİŞİM ANAZILIZI SONUC
								,GELISIMANALIZISONUC		= (	SELECT	
																		G.TCKIMLIKNO
																	,G.STKISAAD + ' TOPLAM' AS STKISAAD
																	,G.ID_SINAVTURU
																	--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
																	,SINAVLIST.ID_SINAV
																	,[SINAVADI]		= SINAVAD
																	,[DOGRU]		= SUM(DOGRU) 
																	,[YANLIS]		= SUM(YANLIS) 
																	,[BOS]			= SUM(BOS) 
																	,NET			= SUM(NET) 
																	,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
																	,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
																	--,G.STKISAAD + ' TOPLAM' AS STKISAAD
																FROM	#TEMP_GELISIM_RAPORU_2 	G	
																JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																												AND SINAVLIST.DERSAD = G.DERSAD
																												AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
																WHERE SINAVAD <> 'ORTALAMA'
																GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
																ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
								--GELİŞİM ANALİZİ PUAN
								,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
																		G.TCKIMLIKNO
																	,G.ID_SINAVPUANTURU
																	,G.PUANTURU
																	,S.SINAVAD
																	,S.PUAN
																	,S.BASARI	
																	,S.BASARI as NET
																FROM #TEMP_PUAN G 
																JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																					AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
																FOR JSON AUTO)
								--NET ORTALAMA KARŞ
								,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
																FROM #TEMP_OO OO
																INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
																INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
																INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
																INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
																ORDER BY STKISAAD, BOLUMNO, DERSAD 
																FOR JSON PATH)
								--KONU ANALIZ
								,KONUANALIZ					= (	SELECT * 
																FROM #TEMP_KONUANALIZ TT 
																ORDER BY TT.DERSAD, TT.KOD 
																FOR JSON PATH)
								--ÖDEV RAPORU
								,ODEVRAPORU					= ( SELECT * 
																FROM #TEMP_ODEV_RAPORU 
																FOR JSON PATH)
								--ÖĞRETMEN DEĞERLENDİRME
								,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
																FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
																ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
																FOR JSON PATH)
								,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																		,K.AD + ' ' + K.SOYAD AS ADSOYAD
																		,DY.YORUM
																		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																		,CASE DY.TUR WHEN 0 THEN STUFF ((
																			SELECT DISTINCT ', ' + UPPER(D.AD)
																			FROM EOKUL_V2.DBO.dersogretmen DO
																			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																			FOR XML PATH('')), 1, 2, '') 
																			WHEN 1 THEN 'REHBERLİK'
																			WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
																FROM DegerlendirmeYorum				DY
																INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
																INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
																INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
																INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
																WHERE	DY.YORUM <> '' 
																	AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
																ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
																FOR JSON PATH)
								-- ETÜT RAPORU
								,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
																FROM #TEMP_ETUT_RAPORU
																ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
								,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																		,SINAV
																		,DERS
																		,DUZEY
																		,MAXDUZEY
																FROM #TEMP_NEREDEYIM_GRAFIGI
																ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
								--LUS RAPORU
								,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
																	OPT, 
																	CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
																	CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
																	YAZOGRETMEN, 
																	CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
																	CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
																	YAZOGRENCI, 
																	CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
																	CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
																	TOPLAM
																FROM #TEMP_RESULT
																WHERE TOPLAM != '-' FOR JSON PATH)
								,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
																FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
																JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
																JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
																JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
																JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
																GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
																ORDER BY ADSOYAD FOR JSON PATH)
								,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																		,SORUNO
																		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																				WHEN PUANORAN < 40						THEN '1'
																			END AS DURUM
																FROM #TEMP_YAZILISORUOGRENCI
																ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
								,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
																FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
																ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
																FOR JSON PATH)
						FOR JSON PATH
					)
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_GelisimRaporuOgrenciBelge]...';


GO
ALTER procedure [dbo].[sp_GelisimRaporuOgrenciBelge]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAVS			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@OOD				BIT				= NULL,
	@ETUTRAPORU			BIT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAVS					= @ID_SINAVS		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,OOD						= @OOD			
			,ETUTRAPORU					= @ETUTRAPORU		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	DECLARE  @OZELSINAVGOR BIT=0
	IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	BEGIN
		SET @OZELSINAVGOR=1
	END
						
	IF @ID_LOG > 1
	BEGIN						
		SELECT DISTINCT o.TCKIMLIKNO, v3o.ID_SINIF, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+d.TAKMAAD) DERSAD, DOGRU, YANLIS, BOS, NET, YUZDENET,SINAVTARIH
		INTO	#GelisimRaporu
		FROM 
		Sinav							s	
		JOIN SinavOgrenci				o	ON	s.ID_SINAV					= o.ID_SINAV
		JOIN OkyanusDb.dbo.v3Donem		DO	ON	DO.KOD						= s.DONEM	
		JOIN OkyanusDb.dbo.v3Ogrenci	v3o	ON	v3o.TCKIMLIKNO				= o.TCKIMLIKNO	 AND v3o.ID_DONEM=DO.ID_DONEM
		JOIN SinavOgrenciCevapBolum		b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
		JOIN SinavOgrenciCevap			c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
		JOIN SinavDers					d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS
		JOIN OkyanusDB.dbo.v3Kademe3	k3	ON	k3.ID_KADEME3				= s.ID_KADEME3
		JOIN SinavTuru					st	ON	st.ID_SINAVTURU				= s.ID_SINAVTURU
		WHERE	S.DURUM			= 2 
			AND S.AKTIF			= 1
			AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND ( @DONEM='' OR @DONEM=0 OR @DONEM=s.DONEM )
			AND ( @ID_SINAVTURU IS NULL OR @ID_SINAVTURU='[]' OR s.ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)) )
			AND ( @ID_SINAVS IS NULL OR @ID_SINAVS='[]' OR s.ID_SINAV in (SELECT Value FROM OPENJSON(@ID_SINAVS)))
			AND ( @TC_OGRENCI IS NULL OR @TC_OGRENCI='' OR @TC_OGRENCI='0' OR o.TCKIMLIKNO=@TC_OGRENCI)
			AND ( @ID_SINIF IS NULL OR @ID_SINIF=0 OR v3o.ID_SINIF=@ID_SINIF)
			AND ( @ID_SUBE IS NULL OR @ID_SUBE=0 OR v3o.ID_SUBE=@ID_SUBE)


		SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
		INTO	#GelisimRaporu2	
		FROM	#GelisimRaporu 		G		
		GROUP BY G.TCKIMLIKNO, G.SINAVTURU, G.ID_SINAVTURU, G.STKISAAD, G.DERSAD	
		
		------------
		-- PUANLAR

		SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SO.ID_SINAVOGRENCI,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
		INTO #Sonuc
		FROM
		Sinav							s	
		JOIN SinavOgrenci				so	ON	s.ID_SINAV			= So.ID_SINAV
		JOIN OkyanusDb.dbo.v3Donem		DO	ON	DO.KOD				= s.DONEM	
		JOIN OkyanusDb.dbo.v3Ogrenci	v3o	ON	v3o.TCKIMLIKNO		= So.TCKIMLIKNO	 AND v3o.ID_DONEM=DO.ID_DONEM
		JOIN SinavOgrenciSonuc			SOS	ON	SOS.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		JOIN SinavDers					SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
		JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
		WHERE	S.AKTIF			= 1
			AND S.DURUM			= 2 
			AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.PUANGIZLE		= 0
			AND ( @DONEM='' OR @DONEM=0 OR @DONEM=s.DONEM )
			AND ( @ID_SINAVTURU IS NULL OR @ID_SINAVTURU='[]' OR s.ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)) )
			AND ( @ID_SINAVS IS NULL OR @ID_SINAVS='[]' OR s.ID_SINAV in (SELECT Value FROM OPENJSON(@ID_SINAVS)))
			AND ( @TC_OGRENCI IS NULL OR @TC_OGRENCI='' OR @TC_OGRENCI='0' OR SO.TCKIMLIKNO=@TC_OGRENCI)
			AND ( @ID_SINIF IS NULL OR @ID_SINIF=0 OR v3o.ID_SINIF=@ID_SINIF)
			AND ( @ID_SUBE IS NULL OR @ID_SUBE=0 OR v3o.ID_SUBE=@ID_SUBE)		
			
		SELECT distinct S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVOGRENCI,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
		INTO	#Sonuc2
		FROM	#Sonuc	S

		SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
				,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
		INTO	#Puan
		FROM	#Sonuc2			S
		JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
		GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
		SELECT DISTINCT	G.ID_SINAV, G.TCKIMLIKNO,G.SINAVAD,G.ID_SINAVPUANTURU,G.PUANTURU		
		INTO #Puan2			
		FROM #Puan G
		GROUP BY G.ID_SINAV, G.TCKIMLIKNO,G.SINAVAD,G.ID_SINAVPUANTURU,G.SINAVAD,G.PUANTURU


		SELECT distinct	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, G.SORUSAYISI, 
				[SINAV ADI] = SINAVAD, [DOĞRU] = DOGRU,[YANLIŞ] = YANLIS,[BOŞ] = BOS,NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET		-- SINAVLIST
				,K.AD+ ' ' + K.SOYAD ADSOYAD, S.AD SUBEAD,SN.AD SINIF
		FROM	#GelisimRaporu2 	G	
		JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
												AND SINAVLIST.DERSAD=G.DERSAD
												AND SINAVLIST.TCKIMLIKNO=G.TCKIMLIKNO
		JOIN	OkyanusDB.DBO.v3Ogrenci		O	ON	O.TCKIMLIKNO	= G.TCKIMLIKNO
		JOIN	OkyanusDB.DBO.v3Kullanici	K	ON	K.TCKIMLIKNO	= G.TCKIMLIKNO
		JOIN	OkyanusDB.DBO.v3Sube		S	ON	S.ID_SUBE		= O.ID_SUBE
		JOIN	OkyanusDB.DBO.v3Sinif		SN	ON	SN.ID_SINIF		= O.ID_SINIF
				
		SELECT DISTINCT	
				ID_SINAV
				,TCKIMLIKNO
				,[SINAV ADI]	= SINAVAD
				,[DOĞRU]		= SUM(DOGRU) 
				,[YANLIŞ]		= SUM(YANLIS) 
				,[BOŞ]			= SUM(BOS) 
				,NET			= SUM(NET) 
				,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
				,SS				= SUM(DOGRU+YANLIS+BOS)
				,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
		FROM	#Sonuc	
		GROUP BY TCKIMLIKNO,ID_SINAV,ID_SINAVPUANTURU,SINAVAD
							
		SELECT DISTINCT	 G.TCKIMLIKNO,G.ID_SINAVPUANTURU,G.PUANTURU
				,[SINAV ADI] = P.SINAVAD,P.ID_SINAVPUANTURU,P.PUAN,[BAŞARI %] = P.BASARI	
		FROM #Puan G
		JOIN #Puan P	ON	P.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU AND P.TCKIMLIKNO=G.TCKIMLIKNO
				
		SELECT DISTINCT TCKIMLIKNO, ID_SINIF INTO #OGRENCI FROM #GelisimRaporu	

		--SELECT * FROM #OGRENCI
		
		IF @OOD = 1 
		BEGIN
			DECLARE  @PUANTURSAYISIEXCEL	INT			 = (SELECT COUNT(1) FROM DegerlendirmePuanTur)

			SELECT DISTINCT O.TCKIMLIKNO, K.ID_KADEME
			INTO #OGRENCILIST
			FROM v3OgrenciTum O 
			INNER JOIN #OGRENCI OX ON OX.TCKIMLIKNO = O.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum S ON S.ID_SINIF = O.ID_SINIF
			INNER JOIN OkyanusDB.dbo.v3KademeBilgi K ON K.ID_KADEME3 = S.ID_KADEME3
			WHERE ( @DONEM='' OR @DONEM=0 OR @DONEM=O.DONEM )
			AND ( @TC_OGRENCI IS NULL OR @TC_OGRENCI='' OR @TC_OGRENCI='0' OR o.TCKIMLIKNO=@TC_OGRENCI)
			AND ( @ID_SINIF IS NULL OR @ID_SINIF=0 OR O.ID_SINIF=@ID_SINIF)
			AND ( @ID_SUBE IS NULL OR @ID_SUBE=0 OR O.ID_SUBE=@ID_SUBE)

			SELECT CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISIEXCEL) AS MAXPUAN
			INTO #TOPLAMPUANLIST
			FROM DegerlendirmeSoru DS
			INNER JOIN DegerlendirmeKategori	DK	ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
			INNER JOIN DegerlendirmePuan		DP	ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
			INNER JOIN DegerlendirmePeriyot		PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
			INNER JOIN #OGRENCILIST				O	ON O.TCKIMLIKNO = DP.TCKIMLIKNO AND O.ID_KADEME = PER.ID_KADEME
			WHERE	DS.DONEM = @DONEM
			AND		DS.ID_KULLANICITIPI = 4
			GROUP BY PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
			ORDER BY DP.TCKIMLIKNO

			SELECT PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS KENDI
			FROM #TOPLAMPUANLIST TC
			GROUP BY TC.TCKIMLIKNO, PERIYOT, BOLUM

			SELECT	 DY.TCKIMLIKNO
					,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
					,K.AD + ' ' + K.SOYAD AS ADSOYAD
					,DY.YORUM
					,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
					,CASE DY.TUR WHEN 0 THEN STUFF ((
						SELECT DISTINCT ', ' + UPPER(D.AD)
						FROM EOKUL_V2.DBO.dersogretmen DO
						INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
						WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
						FOR XML PATH('')), 1, 2, '') 
						WHEN 1 THEN 'REHBERLİK'
						WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
			FROM DegerlendirmeYorum DY
			INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
			INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
			INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
			WHERE DY.YORUM <> '' 
			AND DYD.DURUM = 1
			ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC

			DROP TABLE IF EXISTS #TOPLAMPUANLIST
			DROP TABLE IF EXISTS #OGRENCILIST
		END		
		
		IF @ETUTRAPORU = 1
		BEGIN
			SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
			FROM EtutOgrenci EO
			INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
			INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
			INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
			WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
			GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
			ORDER BY O.TCKIMLIKNO, E.TARIH DESC
		END		
			
		DROP TABLE #OGRENCI
		DROP TABLE #GelisimRaporu
		DROP TABLE #GelisimRaporu2
			
		DROP TABLE #Puan
		DROP TABLE #Puan2
		DROP TABLE #Sonuc
		DROP TABLE #Sonuc2
	END
END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_GelisimRaporuOO]...';


GO
ALTER procedure [dbo].[sp_GelisimRaporuOO]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@RAPORTURLIST		VARCHAR(50)		= NULL 
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,RAPORTURLIST				= @RAPORTURLIST
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY  
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 
	
	DECLARE  @OZELSINAVGOR BIT=0
	--IF EXISTS ( SELECT * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60)) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
	--BEGIN
	--	SET @OZELSINAVGOR=1
	--END

	DECLARE @DONEMX VARCHAR(4)

	IF @DONEM = '' OR @DONEM IS NULL OR @DONEM = '0'
	BEGIN
		SELECT @DONEMX = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
	END
	ELSE
	BEGIN
		SET @DONEMX = @DONEM
	END

	IF @ID_LOG > 1
	BEGIN
		DECLARE @OV BIT = 0

		IF NOT EXISTS(SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
		BEGIN
			SET @OV = 1
		END

		IF (@ISLEM = 1 or @ISLEM = 2)
		BEGIN			
			SELECT DISTINCT TCKIMLIKNO
			INTO #OGRENCILIST
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
						
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME
			INTO #OGRENCI
			FROM #OGRENCILIST OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)
			
			DROP TABLE #OGRENCILIST
			SELECT * FROM #OGRENCI 
			-- DERS ÖĞRETMEN
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END
			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,O.ID_OGRENCI
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				INTO #YAZILI
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

				--SELECT	YO.TCKIMLIKNO
				--	,D.DERSAD AS DERSAD
				--	,Y.ID_DERS 
				--	,Y.AD + ' :' AS  SINAVADI
				--	,Y.ID_YAZILI AS ID_SINAVRAPOR
				--	,O.ID_OGRENCI
				--	,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
				--	,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI
				--INTO #YAZILI
				--FROM Yazili Y
				--INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO AND O.DONEM = Y.DONEM
				--INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				--INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				--WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				--AND (Y.DONEM = @DONEMX)
				--AND (@TC_OGRENCI is null or @TC_OGRENCI='' or YO.TCKIMLIKNO = @TC_OGRENCI)
				--AND (@ID_SINIF is null or @ID_SINIF='' or O.ID_SINIF = @ID_SINIF)
				--AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
				--	OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
				--						WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
				--						END)
				--GROUP BY YO.TCKIMLIKNO 
				--	,D.DERSAD 
				--	,Y.ID_DERS
				--	,Y.AD 
				--	,Y.ID_YAZILI 
				--	,O.ID_OGRENCI
				--	,Y.YARIYIL
				--	,YO.TELAFI

				SELECT DISTINCT DERSAD, ID_DERS 
				FROM #YAZILI 
				ORDER BY DERSAD

				SELECT DISTINCT * 
				FROM #YAZILI
				ORDER BY ID_OGRENCI,DERSAD,DONEMBILGI,ID_SINAVRAPOR

				DROP TABLE #YAZILI
			END
			-- DENEME SONUÇLARI
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI, S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				INTO #T
				FROM #OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				SELECT	T.TCKIMLIKNO, T.DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				FROM	#T			T
				JOIN	SinavTuru	ST ON ST.ID_SINAVTURU = T.ID_SINAVTURU	
				JOIN	SinavDers	SD ON SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV
				GROUP BY T.TCKIMLIKNO, DERSAD, ST.ID_SINAVTURU, ST.AD 
				ORDER BY BOLUMNO


				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN
				INTO #T2
				FROM #T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				select 
						 T.TCKIMLIKNO
						,T.ID_SINAVOGRENCI
						,T.ID_SINAV
						,SINAVAD
						,DERSAD
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
						,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
						,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
						,OLCEKSINAVI					
						,T5.TD
						,T5.TY
						,T5.TB
						,T5.TN
						,ID_SINAVTURU
						,SINAVTARIH   
				from #T T
				INNER JOIN #T2 T5 ON T5.TCKIMLIKNO = T.TCKIMLIKNO AND T5.ID_SINAV = T.ID_SINAV
				order by T.TCKIMLIKNO, SINAVTARIH, DERSAD

				DROP TABLE #T
				DROP TABLE #T2
				--SELECT		O.ID_SINAVOGRENCI,B.DOGRU,B.YANLIS,B.BOS,B.NET,YUZDENET,O.ID_SINAV,VO.ID_SINIF ID_SINIF,VO.ID_SUBE ID_SUBE,D.TAKMAAD DERSAD,VK.AD +' ' +VK.SOYAD ADSOYAD
				--			,O.TCKIMLIKNO,VS.ILCE ILCE,VS.IL IL,VS.AD SUBEAD,SNF.AD as SINIF,B.PUAN DERSPUAN,S.OLCEKSINAVI,
				--			(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK ) TOPLAMSORU,S.AD SINAVAD,PUANGIZLE,D.ID_SINAVDERS
				--			,ID_SINAVTURU,S.SINAVTARIH
				--INTO #PUAN
				--FROM SinavOgrenci				O
				--JOIN SinavOgrenciCevapBolum		B	ON	O.ID_SINAVOGRENCI	= B.ID_SINAVOGRENCI
				--JOIN Sinav						S	ON	S.ID_SINAV			= O.ID_SINAV
				--JOIN SinavDers					D	ON	D.ID_SINAV			= O.ID_SINAV	
				--									AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				--JOIN OkyanusDB.dbo.v3OgrenciTum	VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO AND VO.DONEM = S.DONEM
				--JOIN OkyanusDB.dbo.v3SinifTum	SNF	ON	SNF.ID_SINIF		= VO.ID_SINIF
				--JOIN OkyanusDB.dbo.V3Sube		VS	ON	VS.ID_SUBE			= VO.ID_SUBE
				--JOIN SinavKitapcik				K	ON	K.ID_SINAV			= O.ID_SINAV
				--									AND	K.AD				= O.KITAPCIK
				--JOIN OkyanusDB.dbo.v3Kullanici	VK	ON	VK.TCKIMLIKNO		= O.TCKIMLIKNO
				--WHERE	S.DONEM			= @DONEMX  
				--	AND s.DURUM			= 2
				--	AND s.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND (@TC_OGRENCI is null or @TC_OGRENCI='' or o.TCKIMLIKNO = @TC_OGRENCI)
				--	AND (@ID_SINIF is null or @ID_SINIF='' or VO.ID_SINIF = @ID_SINIF)


				--SELECT 
				--	t.ID_SINAVOGRENCI,t.TCKIMLIKNO
				--	,SUM(DOGRU) TD,SUM(YANLIS) TY,SUM(BOS) TB,SUM(NET) TN,SUM(TOPLAMSORU) TS				
				--into #tt
				--FROM #PUAN	t
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO

				---- into tt1
				--select t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS	
				--into #tt1 
				--from #tt t
				--join #PUAN p on p.ID_SINAVOGRENCI=t.ID_SINAVOGRENCI
				--group by t.ID_SINAVOGRENCI,t.TCKIMLIKNO,TD,TY,TB,TN,TS,ID_SINAVDERS,ID_SINIF,ID_SUBE,ILCE,IL



				--SELECT DISTINCT P.TCKIMLIKNO, P.ID_SINAVOGRENCI,ID_SINAV,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,CAST(NET AS VARCHAR) AS NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAVTURU,p.SINAVTARIH
				--INTO #T4
				--FROM #PUAN				P						
				--left JOIN SinavOgrenciSonuc	OS	ON	P.ID_SINAVOGRENCI	= OS.ID_SINAVOGRENCI
				--JOIN #tt1				tt	ON	P.ID_SINAVOGRENCI	= tt.ID_SINAVOGRENCI
				--group by P.TCKIMLIKNO, P.ID_SINAVOGRENCI,SINAVAD,DERSAD,DOGRU,YANLIS,BOS,NET,DERSPUAN,OLCEKSINAVI
				--		,TD,TY,TB,TN
				--		,ID_SINAV,ID_SINAVTURU,p.SINAVTARIH

				--SELECT TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD  SINAVTURU, MAX(SD.BOLUMNO) AS BOLUMNO
				--FROM	#T4			T4
				--JOIN	SinavTuru	ST ON ST.ID_SINAVTURU=T4.ID_SINAVTURU	
				--JOIN	SinavDers	SD ON SD.TAKMAAD=T4.DERSAD AND SD.ID_SINAV=T4.ID_SINAV
				--GROUP BY TCKIMLIKNO, DERSAD ,ST.ID_SINAVTURU,ST.AD 
				--order by BOLUMNO

				--SELECT	T.TCKIMLIKNO, T.ID_SINAV
				--		,SUM(CAST(DOGRU AS INT)) AS TD
				--		,SUM(CAST(YANLIS AS INT)) AS TY
				--		,SUM(CAST(BOS AS INT)) AS TB
				--		,SUM(CAST(NET AS decimal(16,2))) AS TN
				--INTO #T5
				--FROM #T4 T
				--GROUP BY T.TCKIMLIKNO, T.ID_SINAV

				--select 
				--		T4.TCKIMLIKNO
				--		,ID_SINAVOGRENCI
				--		,T4.ID_SINAV
				--		,SINAVAD
				--		,DERSAD
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DOGRU AS VARCHAR) END AS DOGRU
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(YANLIS AS VARCHAR) END AS YANLIS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(BOS AS VARCHAR) END AS BOS
				--		,case when ID_SINAVTURU<>2 AND ID_SINAVTURU<>6 AND (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(NET AS VARCHAR) END AS NET
				--		,case when (DOGRU+YANLIS+BOS) = BOS THEN '' ELSE CAST(DERSPUAN AS VARCHAR) END AS DERSPUAN
				--		,OLCEKSINAVI					
				--		,T5.TD
				--		,T5.TY
				--		,T5.TB
				--		,T5.TN
				--		,ID_SINAVTURU
				--		,SINAVTARIH   
				--from #T4 T4
				--INNER JOIN #T5 T5 ON T5.TCKIMLIKNO = T4.TCKIMLIKNO AND T5.ID_SINAV = T4.ID_SINAV
				--order by SINAVTARIH,DERSAD

				--DROP TABLE #T4
				--DROP TABLE #T5
				--DROP TABLE #PUAN
				--DROP TABLE #tt1
				--DROP TABLE #tt
			END
			-- GELİŞİM ANALİZLERİ
			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
				INTO	#GelisimRaporu
				FROM	#OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH


				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))
				INTO	#GelisimRaporu2	
				FROM	#GelisimRaporu 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #GelisimRaporu (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
						[SINAV ADI] = SINAVAD, 
						[DOĞRU] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU AS VARCHAR))-1)) END,
						[YANLIŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
						[BOŞ] = CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS AS VARCHAR) ELSE (SUBSTRING(CAST(BOS AS VARCHAR),1,CHARINDEX('.',CAST(BOS AS VARCHAR))-1)) END,
						NET,[BAŞARI %] = YUZDENET, YUZDE= YUZDENET	
						,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				JOIN	#OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
				ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH
				
				SELECT	ID_SINAV
						,G.TCKIMLIKNO
						,[SINAV ADI]	= SINAVAD
						,[DOĞRU]		= SUM(DOGRU) 
						,[YANLIŞ]		= SUM(YANLIS) 
						,[BOŞ]			= SUM(BOS) 
						,NET			= SUM(NET) 
						,[BAŞARI %]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
						,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
						,G.STKISAAD + ' TOPLAM' AS STKISAAD
				FROM	#GelisimRaporu2 	G	
				JOIN	#GelisimRaporu		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD = G.DERSAD
														AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
				WHERE SINAVAD <> 'ORTALAMA'
				GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
				ORDER BY G.ID_SINAVTURU,SINAVTARIH

				DROP TABLE #GelisimRaporu
				DROP TABLE #GelisimRaporu2


				-- PUANLAR

				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				INTO #Sonuc
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
			
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD
				INTO	#Sonuc2
				FROM	#Sonuc	S

				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))
				INTO	#Puan
				FROM	#Sonuc2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD

				
				SELECT DISTINCT	 
						 G.TCKIMLIKNO
						,G.ID_SINAVPUANTURU
						,G.PUANTURU
						,[SINAV ADI] = G.SINAVAD
						,G.PUAN
						,[BAŞARI %] = G.BASARI	
						,NET = G.BASARI
				FROM #Puan G

				DROP TABLE #Puan
				DROP TABLE #Sonuc
				DROP TABLE #Sonuc2




				
			END
			-- NET ORTALAMA KARŞ
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				DECLARE @ID_KADEME3 INT = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)

				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				INTO #OGRENCISINAV
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ

				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
				INTO	#OGRENCINET
				FROM	#OGRENCISINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #O
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD

				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SUO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA
				INTO #SO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO
				INTO #OO
				FROM #OGRENCINET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF FROM #OO OO
				INNER JOIN #O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
				INNER JOIN #SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
				INNER JOIN #SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
				INNER JOIN #OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
				ORDER BY STKISAAD, BOLUMNO, DERSAD

				DROP TABLE #OGRENCINET
				DROP TABLE #OGRENCISINAV
				DROP TABLE #OO
				DROP TABLE #O
				DROP TABLE #SUO
				DROP TABLE #SO
			END
			-- % 50 ALTI KAZANIM
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				into #KONU
				from #OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				INTO #TTK1
				FROM ( SELECT * FROM #KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p


				SELECT * INTO #TTK2 FROM #TTK1 WHERE YUZDE < 50

				
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				INTO #TTK
				FROM #TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				INTO	#KONUANALIZ
				FROM	#TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

				SELECT * FROM #KONUANALIZ

				DROP TABLE #TTK
				DROP TABLE #KONUANALIZ
				DROP TABLE #TTK1
				DROP TABLE #TTK2
				DROP TABLE #KONU
			END
			-- ÖDEV RAPORU
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM
			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				SELECT	 DY.TCKIMLIKNO
						,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,DY.YORUM
						,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
						,CASE DY.TUR WHEN 0 THEN STUFF ((
							SELECT DISTINCT ', ' + UPPER(D.AD)
							FROM EOKUL_V2.DBO.dersogretmen DO
							INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
							WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
							FOR XML PATH('')), 1, 2, '') 
						 WHEN 1 THEN 'REHBERLİK'
						 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				FROM DegerlendirmeYorum DY
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				WHERE	DY.YORUM <> '' 
					AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
				ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
			END
			-- ETÜT RAPORU
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1 AND E.DONEM = @DONEM
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
			END
			-- LUS RAPORU
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			
				--OPTIK--
				BEGIN
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
					INTO #OPTTUM
					FROM #OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					INTO #OPTSON1
					FROM #OGRENCI O
					INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #OPTTUM TUM
					INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZTUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
					INTO #YAZSON1
					FROM #OGRENCI O
					INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #YAZTUM TUM
					INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
					INTO #YAZ2TUM
					FROM #OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
					INTO #YAZ2SON1
					FROM #OGRENCI O
					INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #YAZ2TUM TUM
					INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				INTO #RESULT
				FROM #OGRENCI O
				LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO

				SELECT	TCKIMLIKNO,
						OPT, 
						CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
						CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
						YAZOGRETMEN, 
						CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
						CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
						YAZOGRENCI, 
						CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
						CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
						TOPLAM
				FROM #RESULT
				WHERE TOPLAM != '-'
			
				DROP TABLE #YAZSON
				DROP TABLE #YAZSON1
				DROP TABLE #YAZ2SON
				DROP TABLE #YAZ2SON1
				DROP TABLE #OPTSON
				DROP TABLE #OPTSON1
				DROP TABLE #YAZTUM
				DROP TABLE #YAZ2TUM
				DROP TABLE #OPTTUM
				DROP TABLE #RESULT



			END
			-- KOS RAPORU
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				INTO #KOS_OGRENCI
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				SELECT DISTINCT YS.*
				INTO #YAZILISORU
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				INTO #YAZILISORUOGRENCI
				FROM #YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN
				INTO #YAZILIOGRENCITOPLAMPUAN
				FROM #YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				FROM #YAZILIOGRENCITOPLAMPUAN			YOP
				JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				ORDER BY ADSOYAD

				SELECT	 TCKIMLIKNO
						,SORUNO
						,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
						,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
								WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
								WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
								WHEN PUANORAN < 40						THEN '1'
							END AS DURUM
				FROM #YAZILISORUOGRENCI
				ORDER BY TCKIMLIKNO, SORUNO

				DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				DROP TABLE IF EXISTS #YAZILISORU
				DROP TABLE IF EXISTS #KOS_OGRENCI

			END
			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)
			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				DECLARE  @PUANTURSAYISI14	INT	= (SELECT COUNT(1) FROM DegerlendirmePuanTur),
						 @ID_KADEME14		INT	= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL14
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.ID_KULLANICITIPI = 4
				AND		DS.DONEM = @DONEMX
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL14
				FROM #TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				FROM #KENDIPUANORTALAMALARIEXCEL14 K
				ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				
				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC


				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL14
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL14
			END



			DROP TABLE IF EXISTS #OGRENCI
			DROP TABLE IF EXISTS #OGRENCILIST

		END	

		IF (@ISLEM=4)
		BEGIN
		
		 --DROP TABLE
			DROP TABLE IF EXISTS #TEMP_OGRENCILIST_1
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR1
			DROP TABLE IF EXISTS #TEMP_OGRENCI_TUR2
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T
			DROP TABLE IF EXISTS #TEMP_DENEME_SONUCLARI_T2
			DROP TABLE IF EXISTS #TEMP_DERS_OGRETMEN
			DROP TABLE IF EXISTS #TEMP_YAZILI_YOKLAMA_SONUCU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU
			DROP TABLE IF EXISTS #TEMP_GELISIM_RAPORU_2
			DROP TABLE IF EXISTS #TEMP_SONUC
			DROP TABLE IF EXISTS #TEMP_SONUC_2
			DROP TABLE IF EXISTS #TEMP_PUAN
			DROP TABLE IF EXISTS #TEMP_OGRENCI_SINAV
			DROP TABLE IF EXISTS #TEMP_OGRENCI_NET
			DROP TABLE IF EXISTS #TEMP_O
			DROP TABLE IF EXISTS #TEMP_SUO
			DROP TABLE IF EXISTS #TEMP_SO
			DROP TABLE IF EXISTS #TEMP_OO
			DROP TABLE IF EXISTS #TEMP_KONU
			DROP TABLE IF EXISTS #TEMP_TTK1
			DROP TABLE IF EXISTS #TEMP_TTK2
			DROP TABLE IF EXISTS #TEMP_TTK
			DROP TABLE IF EXISTS #TEMP_KONUANALIZ
			DROP TABLE IF EXISTS #TEMP_ODEV_RAPORU
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL
			DROP TABLE IF EXISTS #TEMP_ETUT_RAPORU
			DROP TABLE IF EXISTS #TEMP_NEREDEYIM_GRAFIGI
			DROP TABLE IF EXISTS #TEMP_OPTTUM 
			DROP TABLE IF EXISTS #TEMP_OPTSON 
			DROP TABLE IF EXISTS #TEMP_OPTSON1
			DROP TABLE IF EXISTS #TEMP_YAZTUM 
			DROP TABLE IF EXISTS #TEMP_YAZSON 
			DROP TABLE IF EXISTS #TEMP_YAZSON1
			DROP TABLE IF EXISTS #TEMP_YAZ2TUM 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON 
			DROP TABLE IF EXISTS #TEMP_YAZ2SON1
			DROP TABLE IF EXISTS #TEMP_RESULT
			DROP TABLE IF EXISTS #TEMP_KOS_OGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILISORU
			DROP TABLE IF EXISTS #TEMP_YAZILISORUOGRENCI
			DROP TABLE IF EXISTS #TEMP_YAZILIOGRENCITOPLAMPUAN
			DROP TABLE IF EXISTS #TEMP_TOPLAMPUANLISTEXCEL14
			DROP TABLE IF EXISTS #TEMP_KENDIPUANORTALAMALARIEXCEL14
			DROP TABLE IF EXISTS #TEMP_DEGERLENDIRME_YORUMU
		--DROP TABLE AND



			CREATE TABLE #TEMP_OGRENCILIST_1 --TEMP
			(
				TCKIMLIKNO VARCHAR(11)
			)

		    INSERT INTO #TEMP_OGRENCILIST_1
			SELECT DISTINCT TCKIMLIKNO			
			FROM OkyanusDB.dbo.v3OgrenciTum
			WHERE (@ID_SINIF IS NULL OR @ID_SINIF = '' OR ID_SINIF = @ID_SINIF)
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR TCKIMLIKNO = @TC_OGRENCI)
										
			CREATE TABLE #TEMP_OGRENCI --TEMP
			(
				TCKIMLIKNO VARCHAR(11),
				ADSOYAD VARCHAR(MAX),
				SUBE VARCHAR(MAX),
				SINIF VARCHAR(MAX),
				ID_SINIF INT,
				ID_OGRENCI INT,
				ID_KADEME INT
			)

			INSERT INTO #TEMP_OGRENCI
			SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, GS.SUBEAD AS SUBE, GS.SINIF , GS.ID_SINIF, O.ID_OGRENCI, GS.ID_KADEME		
			FROM #TEMP_OGRENCILIST_1 OL
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OL.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = K.TCKIMLIKNO
			INNER JOIN vw_SubeSinifGrupKademeTum GS ON GS.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3SinifTum S ON S.ID_SINIF = O.ID_SINIF
			--INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE = O.ID_SUBE
			WHERE (@DONEMX IS NULL OR @DONEMX = '' OR O.DONEM = @DONEMX)			
			
			-- DERS ÖĞRETMEN
			CREATE TABLE #TEMP_DERS_OGRETMEN --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ADSOYAD VARCHAR(MAX)
				)
			IF 1 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_DERS_OGRETMEN
				SELECT DISTINCT O.TCKIMLIKNO, UPPER(D.AD) AS DERSAD, K.AD + ' ' + K.SOYAD AS ADSOYAD 
				FROM #TEMP_OGRENCI O
				INNER JOIN EOKUL_V2.DBO.dersogretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
			END

			-- YAZILI YOKLAMA SONUÇLARI (1-2)
			CREATE TABLE #TEMP_YAZILI_YOKLAMA_SONUCU --TEMP
				(
				 TCKIMLIKNO	 VARCHAR(MAX),
				 DERSAD VARCHAR(MAX),
				 ID_DERS INT,
				 SINAVADI VARCHAR(MAX),
				 ID_SINAVRAPOR INT,
				 PUAN VARCHAR(MAX),
				DONEMBILGI VARCHAR(MAX),
				ID_OGRENCI INT
				)
			IF 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) 
			OR 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_YAZILI_YOKLAMA_SONUCU
				SELECT	YO.TCKIMLIKNO
						,D.DERSAD AS DERSAD
						,Y.ID_DERS 
						,Y.AD + ' :' AS  SINAVADI
						,Y.ID_YAZILI AS ID_SINAVRAPOR
						,CONVERT(VARCHAR(20),ISNULL(YO.TELAFI, SUM(YOC.PUAN))) AS PUAN
						,CAST(Y.YARIYIL AS VARCHAR) + '. Dönem' AS DONEMBILGI				
						,O.ID_OGRENCI
				FROM #TEMP_OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI 
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 
				AND (Y.DONEM = @DONEMX)
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				AND Y.ID_YAZILITURU = 1
				AND ((2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) AND 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)))
					OR Y.YARIYIL = CASE WHEN 2 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 1 
										WHEN 3 IN (SELECT value FROM OPENJSON(@RAPORTURLIST)) THEN 2
										END)
				GROUP BY YO.TCKIMLIKNO 
						,D.DERSAD 
						,Y.ID_DERS
						,Y.AD 
						,Y.ID_YAZILI 
						,O.ID_OGRENCI
						,Y.YARIYIL
						,YO.TELAFI

						
			END
			-- DENEME SONUÇLARI
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			ID_SINAV INT,
			DOGRU INT,
			YANLIS INT,
			BOS INT,
			NET DECIMAL(18,2),
			ID_SINAVOGRENCI INT,
			SINAVAD VARCHAR(MAX),
			OLCEKSINAVI BIT,
		    SINAVTARIH DATE,
			DERSPUAN DECIMAL(18,2)
			)
			CREATE TABLE #TEMP_DENEME_SONUCLARI_T2
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			TD INT,
			TY INT,
			TB INT,
			TN DECIMAL(8,2)
			)
			IF 4 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_DENEME_SONUCLARI_T
				SELECT	O.TCKIMLIKNO, 
						D.TAKMAAD AS DERSAD, 
						S.ID_SINAVTURU, 
						S.ID_SINAV, 
						B.DOGRU, 
						B.YANLIS, 
						B.BOS, 
						B.NET, 
						SO.ID_SINAVOGRENCI, 
						S.AD AS SINAVAD, 
						S.OLCEKSINAVI,
						S.SINAVTARIH, 
						B.PUAN AS DERSPUAN
				
				FROM #TEMP_OGRENCI						O
				INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				INNER JOIN SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				INNER JOIN Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				INNER JOIN SinavDers				D	ON	D.ID_SINAV			= SO.ID_SINAV	
														AND D.ID_SINAVDERS		= B.ID_SINAVDERS
				INNER JOIN SinavKitapcik			K	ON	K.ID_SINAV			= SO.ID_SINAV
														AND	K.AD				= SO.KITAPCIK
				WHERE S.DONEM			= @DONEMX  
					AND s.DURUM			= 2
					AND s.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ


				

				INSERT INTO #TEMP_DENEME_SONUCLARI_T2
				SELECT	T.TCKIMLIKNO, T.ID_SINAV
						,SUM(CAST(DOGRU AS INT)) AS TD
						,SUM(CAST(YANLIS AS INT)) AS TY
						,SUM(CAST(BOS AS INT)) AS TB
						,SUM(CAST(NET AS decimal(16,2))) AS TN				
				FROM #TEMP_DENEME_SONUCLARI_T T
				GROUP BY T.TCKIMLIKNO, T.ID_SINAV							
			END

			-- GELİŞİM ANALİZLERİ
			CREATE TABLE #TEMP_GELISIM_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVTARIH DATE,
			TIP INT
			)
			CREATE TABLE #TEMP_GELISIM_RAPORU_2
			(
			TCKIMLIKNO VARCHAR(MAX),	
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			SORUSAYISI DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SONUC 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET DECIMAL(8,2),
			SINAVAD VARCHAR(MAX),
			KOD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_SONUC_2 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			ID_SINAVDERS INT,
			DOGRU DECIMAL(8,2),
			YANLIS DECIMAL(8,2),
			BOS DECIMAL(8,2),
			NET DECIMAL(8,2),
			YUZDENET  DECIMAL(8,2),
			SINAVAD VARCHAR(MAX)
			)
			CREATE TABLE #TEMP_PUAN 
			(
			ID_SINAV INT,
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAVPUANTURU INT,
			PUAN DECIMAL(8,2),
			PTKOD VARCHAR(MAX),
			PUANTURU VARCHAR(MAX),
			SINAVAD VARCHAR(MAX),
			BASARI DECIMAL(8,2)
			)

			IF 5 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_GELISIM_RAPORU
				SELECT  SO.TCKIMLIKNO, S.ID_SINAV, S.AD SINAVAD, S.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD,UPPER('('+ REPLACE(SUBSTRING(K3.AD, 1,2),'.','')+') '+D.DERSAD) DERSAD, CONVERT(DECIMAL(10,2),DOGRU) AS DOGRU, CONVERT(DECIMAL(10,2),YANLIS) AS YANLIS, CONVERT(DECIMAL(10,2),BOS) AS BOS, NET, YUZDENET,SINAVTARIH, 0 as TIP
			
				FROM	#TEMP_OGRENCI				O
				JOIN	SinavOgrenci			SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
				JOIN	Sinav					S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN	SinavTuru				ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN	v3Kademe3				K3	ON	K3.ID_KADEME3		= D.ID_KADEME3
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_SINAVTURU != 13	-- LUS HARİÇ
				ORDER BY S.SINAVTARIH

				INSERT INTO	#TEMP_GELISIM_RAPORU_2	
				SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, SORUSAYISI = (SUM(DOGRU+YANLIS+BOS)/count(1))			
				FROM	#TEMP_GELISIM_RAPORU 		G		
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD	
				ORDER BY DERSAD
			
				INSERT INTO #TEMP_GELISIM_RAPORU (TCKIMLIKNO, ID_SINAV, ID_SINAVTURU, SINAVTURU, STKISAAD, DERSAD, SINAVAD, DOGRU, YANLIS, BOS, NET, YUZDENET, SINAVTARIH, TIP)
				SELECT	G.TCKIMLIKNO, 0, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
						[SINAV ADI] = 'ORTALAMA', [DOĞRU] = CONVERT(DECIMAL(10,2),AVG(DOGRU)),[YANLIŞ] = CONVERT(DECIMAL(10,2),AVG(YANLIS)),[BOŞ] = CONVERT(DECIMAL(10,2),AVG(BOS)),[NET] = CONVERT(DECIMAL(10,2),AVG(NET)),[BAŞARI %] = (CONVERT(DECIMAL(10,2),(SUM(NET)/CAST(SUM(G.SORUSAYISI) AS decimal)*100))),'01.01.2018', 1
				FROM	#TEMP_GELISIM_RAPORU_2 	G	
				JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU=G.ID_SINAVTURU	
														AND SINAVLIST.DERSAD=G.DERSAD
				GROUP BY G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD

				
				-- PUANLAR
				INSERT INTO #TEMP_SONUC
				SELECT distinct S.ID_SINAV,SO.TCKIMLIKNO,SOS.ID_SINAVPUANTURU,SOS.PUAN,SD.ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,S.AD SINAVAD,PT.KOD
				
				FROM SinavOgrenci				SO 
				JOIN SinavOgrenciPuan			SOS	ON	SOS.ID_SINAV		= SO.ID_SINAV
													AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
				JOIN Sinav						S	ON	S.ID_SINAV			= SO.ID_SINAV
				JOIN SinavOgrenciCevapBolum		B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
				JOIN SinavDers					SD	ON	SD.ID_SINAV			= S.ID_SINAV
													AND SD.ID_SINAVDERS		= B.ID_SINAVDERS
				JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS			= SD.ID_DERS
				JOIN SinavPuanTuru				PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
				JOIN #TEMP_OGRENCI					OG	ON	OG.TCKIMLIKNO		= SO.TCKIMLIKNO
				WHERE	S.AKTIF			= 1
					AND S.DURUM			= 2 
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.PUANGIZLE		= 0
					AND S.DONEM			= @DONEM
				INSERT INTO #TEMP_SONUC_2
				SELECT S.ID_SINAV,TCKIMLIKNO,ID_SINAVPUANTURU,PUAN,ID_SINAVDERS,DOGRU,YANLIS,BOS,NET,YUZDENET,SINAVAD			
				FROM	#TEMP_SONUC	S

				INSERT INTO	#TEMP_PUAN
				SELECT	DISTINCT ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD PTKOD,UPPER(PT.AD) PUANTURU,SINAVAD
						,BASARI	= CAST(CAST(PUAN AS DECIMAL(8,2)) / MAX(PT.MAX_PUAN) * 100 AS DECIMAL(8,2))				
				FROM	#TEMP_SONUC_2			S
				JOIN	SinavPuanTuru	PT	ON	PT.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
				GROUP BY ID_SINAV,TCKIMLIKNO,S.ID_SINAVPUANTURU,PUAN,PT.KOD,SINAVAD ,PT.AD
			
			END
			-- NET ORTALAMA KARŞ	
			CREATE TABLE #TEMP_OGRENCI_SINAV 
			(
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			DONEM VARCHAR(max),
			SINAVTARIH DATE
			)
			CREATE TABLE #TEMP_OGRENCI_NET 
			( --SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO
			TCKIMLIKNO VARCHAR(MAX),
			ID_SINAV INT,
			SINAVAD VARCHAR(MAX),
			ID_SINAVTURU INT,
			SINAVTURU VARCHAR(MAX),
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			NET DECIMAL(8,2),
			ID_SINIF INT,
			ID_SUBE INT,
			BOLUMNO INT
			)
			CREATE TABLE #TEMP_O
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SUO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SUBE INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_SO
			(
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_OO
			(			
			STKISAAD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			ID_SUBE INT,
			ID_SINIF INT,
			ORTALAMA DECIMAL(8,2),
			BOLUMNO INT
			)
			IF 6 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				--SELECT DISTINCT SO.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH
				--INTO #OGRENCISINAV
				--FROM #OGRENCI O
				--INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				--INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				--WHERE	S.DURUM			= 2 
				--	AND S.AKTIF			= 1
				--	AND (OZEL=0 OR @OZELSINAVGOR=1)
				--	AND S.DONEM			= @DONEMX

				SET @ID_KADEME3  = (SELECT ID_KADEME3 - (CAST((SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEMX AS INT)) FROM OkyanusDB.dbo.v3SubeGrupSinifTum WHERE ID_SINIF = @ID_SINIF)
				INSERT	INTO #TEMP_OGRENCI_SINAV
				SELECT DISTINCT S.ID_SINAV, S.AD AS SINAVAD, S.ID_SINAVTURU, S.DONEM, S.SINAVTARIH				
				FROM Sinav S
				WHERE	S.DURUM			= 2 
					AND S.AKTIF			= 1
					AND (S.OZEL=0 OR @OZELSINAVGOR=1)
					AND S.DONEM			= @DONEMX
					AND S.ID_KADEME3	= @ID_KADEME3
					AND S.ID_SINAVTURU	!= 13			-- LUS SINAVI HARİÇ
				INSERT INTO	#TEMP_OGRENCI_NET
				SELECT  SO.TCKIMLIKNO, OS.ID_SINAV, OS.SINAVAD, OS.ID_SINAVTURU, ST.AD SINAVTURU, ST.KISAAD STKISAAD, D.DERSAD, SOCB.NET, O.ID_SINIF, O.ID_SUBE, SD.BOLUMNO				
				FROM	#TEMP_OGRENCI_SINAV			OS
				JOIN	SinavOgrenci			SO		ON	SO.ID_SINAV			= OS.ID_SINAV
				JOIN	SinavTuru				ST		ON	ST.ID_SINAVTURU		= OS.ID_SINAVTURU
				JOIN	SinavDers				SD		ON	SD.ID_SINAV			= OS.ID_SINAV
				JOIN	eokul_v2.dbo.Ders		D		ON	D.ID_DERS			= SD.ID_DERS
				JOIN	SinavOgrenciCevapBolum	SOCB	ON	SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI AND SOCB.ID_SINAVDERS = SD.ID_SINAVDERS
				JOIN	v3OgrenciTum			O		ON	O.TCKIMLIKNO = SO.TCKIMLIKNO AND O.DONEM = OS.DONEM
				ORDER BY OS.SINAVTARIH

				INSERT INTO #TEMP_O
				SELECT STKISAAD, DERSAD, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA		
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD

				INSERT INTO #TEMP_SUO
				SELECT STKISAAD, DERSAD, ID_SUBE, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SUBE

				INSERT INTO #TEMP_SO
				SELECT STKISAAD, DERSAD, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA				
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, ID_SINIF

				INSERT INTO #TEMP_OO
				SELECT STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF, CAST(AVG(NET) AS decimal(18,2)) AS ORTALAMA, MIN(BOLUMNO) AS BOLUMNO			
				FROM #TEMP_OGRENCI_NET
				GROUP BY STKISAAD, DERSAD, TCKIMLIKNO, ID_SUBE, ID_SINIF

				
				
			END
			-- % 50 ALTI KAZANIM
			CREATE TABLE #TEMP_KONU
			(
			TCKIMLIKNO VARCHAR(MAX),
			SORUSAYISI INT,
			DURUM VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			YUZDE DECIMAL(8,2),
			TOPLAMSORU INT,
			ID_SINAV INT
			)
			CREATE TABLE #TEMP_TTK1
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK2
			(
			TCKIMLIKNO VARCHAR(MAX),
			KONUAD VARCHAR(MAX),
			KOD VARCHAR(MAX),
			DERSAD VARCHAR(MAX),
			BOLUMYUZDE DECIMAL (8,2),
			TOPLAMSORU INT,
			DOGRU DECIMAL (8,2),
			YANLIS DECIMAL (8,2),
			BOS DECIMAL (8,2),
			ID_SINAV INT,
			YUZDE DECIMAL (8,2),
			)
			CREATE TABLE #TEMP_TTK
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD   VARCHAR(MAX),
				KOD		 VARCHAR(MAX),
				DERSAD	 VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				TOPLAMSORU INT,
				DOGRU DECIMAL(8,2),
				YANLIS DECIMAL(8,2),
				BOS DECIMAL(8,2),
				ID_SINAV INT,
				YUZDE DECIMAL(8,2),
				TIP INT
				)
			CREATE TABLE #TEMP_KONUANALIZ
				(
				TCKIMLIKNO VARCHAR(MAX),
				KONUAD VARCHAR(MAX),
				DERSAD VARCHAR(MAX),
				KOD VARCHAR(MAX),
				BOLUMYUZDE DECIMAL(8,2),
				SORU DECIMAL(8,2),
				 DOGRU DECIMAL(8,2),
				 YANLIS DECIMAL(8,2),
				 BOS DECIMAL(8,2),
				 YUZDE DECIMAL(8,2),
				 TIP INT
				)
			IF 7 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO  #TEMP_KONU
				SELECT	oo.TCKIMLIKNO,
						count(1) SORUSAYISI,
						c.DURUM,
						DD.DERSAD DERSAD,
						isnull(u.KOD,'') KOD,
						isnull(u.AD,'') KONUAD,
						max(b.YUZDEDOGRU) YUZDE,
						(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
						o.ID_SINAV
				
				from #TEMP_OGRENCI				oo
				JOIN SinavOgrenci			o	ON	o.TCKIMLIKNO				= oo.TCKIMLIKNO
				JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
				JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
				JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
				JOIN eokul_v2.dbo.Ders		DD	ON	DD.ID_DERS					= d.ID_DERS
				JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
				JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 			-- SONRADAN EKLENDİ		
				JOIN v3SinavDersUnite		u	ON	u.KOD						= a.KOD
				JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV
				WHERE	( @DONEMX='' OR @DONEMX=0 OR @DONEMX=s.DONEM )
					AND s.AKTIF=1 AND s.DURUM=2 and (OZEL=0 OR @OZELSINAVGOR=1)
				GROUP BY oo.TCKIMLIKNO,c.DURUM,DD.DERSAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK

				INSERT INTO #TEMP_TTK1
				SELECT DISTINCT
						TCKIMLIKNO,
						KONUAD,
						KOD,						
						DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
						ISNULL( 
						CAST(((100 /
							CAST((
								CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
							))
							* CAST([D] AS INT)  
						) AS DECIMAL(11,2)) 
						,0) AS YUZDE
				
				FROM ( SELECT * FROM #TEMP_KONU )AS GTABLO
				PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p

				INSERT INTO #TEMP_TTK2
				SELECT *   FROM #TEMP_TTK1 WHERE YUZDE < 50
				
				INSERT INTO #TEMP_TTK
				SELECT 
					TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE, TIP = 1 
				
				FROM #TEMP_TTK2
						UNION ALL 
				SELECT 
					TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE), TIP = 0
					FROM #TEMP_TTK2
				GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV

				
			INSERT INTO #TEMP_KONUANALIZ
				SELECT	
					TCKIMLIKNO,
					CASE WHEN TIP = 1 THEN '     ' + KONUAD ELSE KONUAD END AS KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU)  DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS)    BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
					TIP
				
				FROM	#TEMP_TTK
				GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD,TIP

			

				
			END

			-- ÖDEV RAPORU
			CREATE TABLE #TEMP_ODEV_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS	 VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT,
			)
			IF 8 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_ODEV_RAPORU
				SELECT	 OSO.TCKIMLIKNO
						,D.AD AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,1 AS TUR	
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	OkyanusDB.dbo.v3Ders		D	ON	D.ID_DERS = ODV.ID_DERS
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')	
				GROUP BY OSO.TCKIMLIKNO, D.ID_DERS, D.AD, OD.AD
				UNION ALL
				SELECT	OSO.TCKIMLIKNO
						,'GENEL' AS DERS
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI	
						,2 AS TUR		
				FROM	OdevSinifOgrenci			OSO 
				JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
				JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				JOIN	#TEMP_OGRENCI					O	ON	O.TCKIMLIKNO = OSO.TCKIMLIKNO
				WHERE	(ODV.DONEM	= @DONEMX OR @DONEMX = '')		
				GROUP BY OSO.TCKIMLIKNO, OD.AD
				ORDER BY TCKIMLIKNO, TUR, DERS, ODEVDURUM

				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMLU)
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL
				(
				ID_DEGERLENDIRMEPERIYOT INT, 
				PERIYOT VARCHAR(MAX),
				BOLUM VARCHAR(MAX),
				TCKIMLIKNO VARCHAR(MAX),
				PUAN DECIMAL(8,2),
				MAXPUAN  DECIMAL(8,2)
				)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL
			(
			ID_DEGERLENDIRMEPERIYOT INT,
			PERIYOT VARCHAR(MAX),
			TCKIMLIKNO VARCHAR(MAX),
			BOLUM VARCHAR(MAX),
			ORTALAMA DECIMAL(8,2)
			)
			CREATE TABLE #TEMP_DEGERLENDIRME_YORUMU
			(
			TCKIMLIKNO VARCHAR(MAX),
			DERS VARCHAR(MAX),
			ODEVDURUM VARCHAR(MAX),
			SAYI INT,
			TUR INT
			)
			IF 9 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET   @PUANTURSAYISI	= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
						SET @ID_KADEME			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END
				
				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN				
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				
				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				
				FROM #TEMP_TOPLAMPUANLISTEXCEL TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT DY.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, DY.YORUM, CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DYD.DURUM = 1 AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				


				
			END

			-- ETÜT RAPORU
			CREATE TABLE #TEMP_ETUT_RAPORU
			(
			TCKIMLIKNO VARCHAR(MAX),
			TARIH VARCHAR(MAX),
			BRANS VARCHAR(MAX),
			ICERIK VARCHAR(MAX)
			)
			IF 10 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_ETUT_RAPORU
				SELECT O.TCKIMLIKNO, CONVERT(VARCHAR, E.TARIH, 104) AS TARIH, D.DERSAD AS BRANS, E.ETUT AS ICERIK 
				FROM EtutOgrenci EO
				INNER JOIN Etut E ON E.ID_ETUT = EO.ID_ETUT
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = E.ID_DERS
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = EO.TC_OGRENCI
				WHERE EO.KATILDI = 1 AND EO.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, E.TARIH, D.DERSAD, E.ETUT
				ORDER BY O.TCKIMLIKNO, E.TARIH DESC

				
			END
			-- ABİDE NEREDEYİM GRAFİĞİ(TÜM DERSLER)
			CREATE TABLE #TEMP_NEREDEYIM_GRAFIGI
			(TCKIMLIKNO VARCHAR(11),
			SINAV VARCHAR(MAX),
			DERS VARCHAR(MAX),
			DUZEY DECIMAL(8,2),
			MAXDUZEY DECIMAL(8,2)
			)
			IF 11 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
			INSERT INTO #TEMP_NEREDEYIM_GRAFIGI
				SELECT	O.TCKIMLIKNO
						,SN.AD AS SINAV
						,S.DERS
						,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
						,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY					
				FROM AbideOgrenci O
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
				INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
				WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #TEMP_OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
				GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV
				ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				
				
			END

			-- LUS RAPORU
			CREATE TABLE #TEMP_OPTTUM
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_OPTSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN DECIMAL(6,3)
			)
			CREATE TABLE #TEMP_YAZTUM 
			(
			TCKIMLIKNO VARCHAR(11),
			AD VARCHAR(50),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON 
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)
			CREATE TABLE #TEMP_YAZSON1
			(
			TCKIMLIKNO VARCHAR(11),
			TARIH DATE,
			PUAN int
			)

			CREATE TABLE #TEMP_YAZ2TUM (TCKIMLIKNO VARCHAR(11),AD VARCHAR(50),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_YAZ2SON1 (TCKIMLIKNO VARCHAR(11),TARIH date,PUAN int)
			CREATE TABLE #TEMP_RESULT (TCKIMLIKNO varchar(11),ADSOYAD varchar(MAX),SUBE varchar(MAX),SINIF varchar(MAX),ID_SINIF int,ID_OGRENCI int,ID_KADEME int,OPT varchar(30),OPT1 varchar(30),YAZOGRETMEN varchar(30),YAZOGRETMEN1 varchar(30),YAZOGRENCI varchar(30),YAZOGRENCI1 varchar(30),TOPLAM varchar(30))
			IF 12 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN			
				--OPTIK--
				BEGIN
				    INSERT INTO  #TEMP_OPTTUM
					SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
					INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
					WHERE S.AKTIF = 1			
					AND S.DONEM = @DONEMX
					AND (OZEL=0 OR @OZELSINAVGOR=1)
					AND S.OLCEKSINAVI = 1
					AND S.ID_SINAVTURU = 13 -- LUS

					INSERT INTO #TEMP_OPTSON
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_OPTSON1
					SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, OPT.PUAN
			

					DELETE TUM
					FROM #TEMP_OPTTUM TUM
					INNER JOIN #TEMP_OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH				
				END
				
				--ÖĞRETMEN GÖZLEM FORMU--
				BEGIN
					INSERT INTO #TEMP_YAZTUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 3 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZSON
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN

					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZSON1
					SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN				
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ.PUAN


					
					DELETE TUM
					FROM #TEMP_YAZTUM TUM
					INNER JOIN #TEMP_YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					END

				--ÖĞRENCİ DENEY RAPOR--
				BEGIN		
					INSERT INTO #TEMP_YAZ2TUM
					SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
					WHERE YO.AKTIF = 1
					AND Y.AKTIF = 1				
					AND Y.DONEM = @DONEMX
					AND Y.ID_YAZILITURU = 4 -- LUS
					AND (Y.OVGORSUN = 1 OR @OV = 0)
					GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

					INSERT INTO #TEMP_YAZ2SON
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

					INSERT INTO #TEMP_YAZ2SON1
					SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN					
					FROM #TEMP_OGRENCI O
					INNER JOIN #TEMP_YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
					GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

					
					DELETE TUM
					FROM #TEMP_YAZ2TUM TUM
					INNER JOIN #TEMP_YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				END

				INSERT INTO  #TEMP_RESULT
				SELECT O.*
						,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
						,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
						,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
						,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
						,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
						,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
						,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
				
				FROM #TEMP_OGRENCI O
				LEFT JOIN #TEMP_OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN #TEMP_YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO				
				
			END

			-- KOS RAPORU		
			CREATE TABLE #TEMP_KOS_OGRENCI (ID_YAZILI int,YAZILITARIH date,TCKIMLIKNO varchar(11))
			--[ID_YAZILISORU], [ID_YAZILI], [SORUNO], [PUAN], [KOD], [ID_BILGI], [ID_BILISSELSUREC]
			
			CREATE TABLE #TEMP_YAZILISORU 
			(
			ID_YAZILISORU INT,
			ID_YAZILI INT,
			SORUNO INT,
			PUAN INT,
			KOD VARCHAR(MAX),
			ID_BILGI INT,
			ID_BILISSELSUREC INT
			)
			CREATE TABLE #TEMP_YAZILISORUOGRENCI (TCKIMLIKNO varchar(11),SORUNO int,KAZANIM nvarchar(MAX),PUAN int,PUANSORU int,PUANORAN decimal(18,2))
			CREATE TABLE #TEMP_YAZILIOGRENCITOPLAMPUAN (TCKIMLIKNO varchar(11),TOPLAMPUAN decimal(18,2))
			IF 13 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				INSERT INTO #TEMP_KOS_OGRENCI			
				SELECT MAX(Y.ID_YAZILI) ID_YAZILI ,MAX(Y.YAZILITARIH ) YAZILITARIH , OL.TCKIMLIKNO
				FROM Yazili Y 
				JOIN YaziliOgrenci	YO	ON	YO.ID_YAZILI	= Y.ID_YAZILI  
				JOIN #TEMP_OGRENCI		OL	ON	OL.TCKIMLIKNO	= YO.TCKIMLIKNO
				WHERE	ID_YAZILITURU	= 2 
					AND DONEM			= @DONEMX 
					AND YO.KATILMADI	= 0
					AND Y.AKTIF			= 1
					AND YO.AKTIF		= 1
				GROUP BY OL.TCKIMLIKNO

				INSERT INTO #TEMP_YAZILISORU
				SELECT DISTINCT YS.*				
				FROM Yazili			Y 
				JOIN YaziliSoru		YS	ON	YS.ID_YAZILI = Y.ID_YAZILI
				JOIN #TEMP_KOS_OGRENCI	K	ON	K.ID_YAZILI	 = Y.ID_YAZILI

				INSERT INTO #TEMP_YAZILISORUOGRENCI
				SELECT   YO.TCKIMLIKNO
						,YS.SORUNO
						,SDU.AD AS KAZANIM
						,YOC.PUAN
						,YS.PUAN AS PUANSORU
						,CONVERT(DECIMAL(18, 2), CAST(YOC.PUAN AS FLOAT) / CAST(YS.PUAN AS FLOAT) * 100.0) AS PUANORAN
				
				FROM #TEMP_YAZILISORU							YS 
				INNER JOIN YaziliOgrenci					YO	ON  YO.ID_YAZILI		= YS.ID_YAZILI
				INNER JOIN #TEMP_KOS_OGRENCI						K	ON	K.ID_YAZILI			= YS.ID_YAZILI		AND K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU ON  SDU.KOD				= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC ON  YOC.ID_YAZILIOGRENCI= YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	ON  O.TCKIMLIKNO		= YO.TCKIMLIKNO
				WHERE	YO.AKTIF		= 1

				INSERT INTO #TEMP_YAZILIOGRENCITOPLAMPUAN
				SELECT YOS.TCKIMLIKNO, CONVERT(DECIMAL(18,2), CAST(SUM(YOS.PUAN) AS FLOAT) / CAST(SUM(YOS.PUANSORU) AS FLOAT) * 100.0) AS TOPLAMPUAN				
				FROM #TEMP_YAZILISORUOGRENCI YOS
				GROUP BY YOS.TCKIMLIKNO

				--SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
				--JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
				--JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
				--JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
				--JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
				--ORDER BY ADSOYAD

				--SELECT	 TCKIMLIKNO
				--		,SORUNO
				--		,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
				--		,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
				--				WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
				--				WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
				--				WHEN PUANORAN < 40						THEN '1'
				--			END AS DURUM
				--FROM #TEMP_YAZILISORUOGRENCI
				--ORDER BY TCKIMLIKNO, SORUNO

				--DROP TABLE IF EXISTS #YAZILIOGRENCITOPLAMPUAN
				--DROP TABLE IF EXISTS #YAZILISORUOGRENCI
				--DROP TABLE IF EXISTS #YAZILISORU
				--DROP TABLE IF EXISTS #KOS_OGRENCI

				
				
			END

			-- ÖĞRETMEN ÖĞR. DEĞERLENDİRME (YORUMSUZ)			
			CREATE TABLE #TEMP_TOPLAMPUANLISTEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),BOLUM varchar(MAX),TCKIMLIKNO varchar(11),PUAN int,MAXPUAN int)
			CREATE TABLE #TEMP_KENDIPUANORTALAMALARIEXCEL14 (ID_DEGERLENDIRMEPERIYOT int,PERIYOT varchar(63),TCKIMLIKNO varchar(11),BOLUM varchar(MAX),ORTALAMA decimal(18,2))

			IF 14 IN (SELECT value FROM OPENJSON(@RAPORTURLIST))
			BEGIN
				SET  @PUANTURSAYISI14		= (SELECT COUNT(1) FROM DegerlendirmePuanTur)
					SET	 @ID_KADEME14			= (
													SELECT DISTINCT KB.ID_KADEME FROM OkyanusDB.dbo.v3SubeGrupSinifTum ST
													INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = ST.ID_KADEME3
													WHERE ST.ID_SINIF = @ID_SINIF
												)

				IF (@ID_SINIF IS NULL OR @ID_SINIF = 0)
				BEGIN
					SELECT @ID_KADEME14 = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO=@TC_OGRENCI
				END

				INSERT INTO #TEMP_TOPLAMPUANLISTEXCEL14
				SELECT DP.ID_DEGERLENDIRMEPERIYOT, CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI14) AS MAXPUAN
			
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	DS.DONEM = @DONEMX
				AND		DS.ID_KULLANICITIPI = 4
				AND		DS.ID_KADEME = @ID_KADEME14
				GROUP BY DP.ID_DEGERLENDIRMEPERIYOT, PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				INSERT INTO #TEMP_KENDIPUANORTALAMALARIEXCEL14
				SELECT ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA			
				FROM #TEMP_TOPLAMPUANLISTEXCEL14 TC
				INNER JOIN #TEMP_OGRENCI O ON O.TCKIMLIKNO = TC.TCKIMLIKNO
				GROUP BY ID_DEGERLENDIRMEPERIYOT, PERIYOT, TC.TCKIMLIKNO, BOLUM

				--SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
				--FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
				--ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT
				

				--SELECT	 DY.TCKIMLIKNO
				--		,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,DY.YORUM
				--		,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
				--		,CASE DY.TUR WHEN 0 THEN STUFF ((
				--			SELECT DISTINCT ', ' + UPPER(D.AD)
				--			FROM EOKUL_V2.DBO.dersogretmen DO
				--			INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
				--			WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
				--			FOR XML PATH('')), 1, 2, '') 
				--		 WHEN 1 THEN 'REHBERLİK'
				--		 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
				--FROM DegerlendirmeYorum DY
				--INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				--INNER JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--INNER JOIN DegerlendirmePeriyot DP ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
				--WHERE DY.YORUM <> '' 
				--AND DYD.DURUM = 1
				--ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC
				

				
			END
		
			
			SELECT (
				SELECT 						
					--ÖĞRENCİ
					OGRENCI							= (	SELECT * 
														FROM #TEMP_OGRENCI 
														FOR JSON PATH)					
					--DERS ÖĞRETMEN
					,DERSOGRETMEN					= (	SELECT DISTINCT TCKIMLIKNO, DERSAD, ADSOYAD 
														FROM #TEMP_DERS_OGRETMEN 
														ORDER BY DERSAD, ADSOYAD
														FOR JSON PATH)
					--YOKLAMA DERS
					,YOKLAMADERS					= (	SELECT DISTINCT DERSAD, ID_DERS 
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU 
														ORDER BY DERSAD FOR JSON PATH)
					-- YAZILI YOKLAMA SONUÇLARI
					,YAZILIYOKLAMA					= ( SELECT DISTINCT YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI, YS.PUAN
														, SIRA = IIF(YS.SINAVADI LIKE ('%01%'), 1 , 2)
														FROM #TEMP_YAZILI_YOKLAMA_SONUCU Y
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YD ON YD.DONEMBILGI = Y.DONEMBILGI
														JOIN #TEMP_YAZILI_YOKLAMA_SONUCU YS ON YS.ID_DERS = Y.ID_DERS
														WHERE	YS.SINAVADI LIKE ('%101%') OR YS.SINAVADI LIKE ('%102%')
															OR	YS.SINAVADI LIKE ('%201%') OR YS.SINAVADI LIKE ('%202%')
														ORDER BY YD.DONEMBILGI, Y.DERSAD, YS.SINAVADI
														FOR JSON PATH)  
					--DENEME SINAVI DERSLERI
					,DENEMESINAVIDERSLERI			= ( SELECT DISTINCT
															 ST.ID_SINAVTURU
															,SINAVTURU	= ST.AD
															,DERSAD		= T.DERSAD 
															,OLCEKSINAVI = (SELECT MAX(CAST(S.OLCEKSINAVI AS INT)) FROM #TEMP_DENEME_SONUCLARI_T S WHERE S.ID_SINAVTURU = T.ID_SINAVTURU)
															,BOLUMNO = (SELECT MAX(BOLUMNO) FROM SinavDers	SD WHERE SD.TAKMAAD = T.DERSAD AND SD.ID_SINAV = T.ID_SINAV)
														FROM	#TEMP_DENEME_SONUCLARI_T	T
														JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
														--GROUP BY ST.ID_SINAVTURU, ST.AD, T.DERSAD, T.ID_SINAV
														ORDER BY ST.AD, BOLUMNO, T.DERSAD
														FOR JSON AUTO)
					--DENEME SINAVI DERSLERI
					,DENEMESINAVILISTESI			= (
															SELECT	 DISTINCT 
																 ST.ID_SINAVTURU
																,SINAVTURU	= ST.AD
																,SINAVAD
																,ID_SINAV
																,SINAVTARIH
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU
															ORDER BY ST.AD, T.SINAVTARIH
															FOR JSON AUTO
														)
					-- DENEME SINAVI SONUCLARI
					,DENEMESINAVISONUCLARI			=  (
															SELECT	 ST.ID_SINAVTURU
																	,SINAVTURU	= ST.AD
																	,DERSAD		= TT.DERSAD 
																	,TT.ID_SINAV
																	,TT.OLCEKSINAVI
																	,TD = ISNULL(T2.TD,0)
																	,TY = ISNULL(T2.TY,0)
																	,TB = ISNULL(T2.TB,0)
																	,TN = ISNULL(T2.TN,0)
																	,TT.SINAVAD																	
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DOGRU  AS VARCHAR) END AS DOGRU
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.YANLIS AS VARCHAR) END AS YANLIS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.BOS	 AS VARCHAR) END AS BOS
																	,case when TT.ID_SINAVTURU<>2 AND TT.ID_SINAVTURU<>6 AND (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.NET	 AS VARCHAR) END AS NET
																	,case when (TT.DOGRU+TT.YANLIS+TT.BOS) = TT.BOS THEN '' ELSE CAST(TT.DERSPUAN AS VARCHAR) END AS DERSPUAN
																	
															FROM	#TEMP_DENEME_SONUCLARI_T	T
															JOIN	SinavTuru					ST	ON	ST.ID_SINAVTURU		= T.ID_SINAVTURU	
															JOIN	SinavDers					SD	ON	SD.TAKMAAD			= T.DERSAD 
																									AND SD.ID_SINAV			= T.ID_SINAV
															JOIN	#TEMP_DENEME_SONUCLARI_T	TT	ON	TT.ID_SINAVOGRENCI	= T.ID_SINAVOGRENCI 
																									AND TT.DERSAD			= T.DERSAD
															JOIN	#TEMP_DENEME_SONUCLARI_T2	T2	ON	T2.ID_SINAV			= T.ID_SINAV 
																									AND T2.TCKIMLIKNO		= TT.TCKIMLIKNO
															ORDER BY ST.AD, T.DERSAD, TT.SINAVTARIH
															FOR JSON AUTO
														)
						-- GELİŞİM ANALİZİ DERSLERİ
						,GELISIMANALIZIDERS			= ( SELECT	G.TCKIMLIKNO, G.ID_SINAVTURU, G.SINAVTURU, G.STKISAAD, G.DERSAD, 
															[SORUSAYISI] = CAST(G.SORUSAYISI AS INT),
															[SINAVADI] = SINAVAD, 
															[DOGRU]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(DOGRU	AS VARCHAR) ELSE (SUBSTRING(CAST(DOGRU	AS VARCHAR),1,CHARINDEX('.',CAST(DOGRU	AS VARCHAR))-1)) END,
															[YANLIS]	= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(YANLIS AS VARCHAR) ELSE (SUBSTRING(CAST(YANLIS AS VARCHAR),1,CHARINDEX('.',CAST(YANLIS AS VARCHAR))-1)) END,
															[BOS]		= CASE WHEN SINAVAD='ORTALAMA' THEN CAST(BOS	AS VARCHAR) ELSE (SUBSTRING(CAST(BOS	AS VARCHAR),1,CHARINDEX('.',CAST(BOS	AS VARCHAR))-1)) END,
															NET,[BASARI] = YUZDENET, YUZDE= YUZDENET	
															,O.ADSOYAD, O.SUBE AS SUBEAD, O.SINIF
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU	= G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD		= G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO	= G.TCKIMLIKNO
														JOIN	#TEMP_OGRENCI			O			ON O.TCKIMLIKNO=G.TCKIMLIKNO
														ORDER BY DERSAD,G.ID_SINAVTURU,TIP,SINAVTARIH FOR JSON PATH)
						--GELİŞİM ANAZILIZI SONUC
						,GELISIMANALIZISONUC		= (	SELECT	
															 G.TCKIMLIKNO
															,G.STKISAAD + ' TOPLAM' AS STKISAAD
															,G.ID_SINAVTURU
															--,SS				= CAST(SUM(DOGRU+YANLIS+BOS) AS INT)
															,SINAVLIST.ID_SINAV
															,[SINAVADI]		= SINAVAD
															,[DOGRU]		= SUM(DOGRU) 
															,[YANLIS]		= SUM(YANLIS) 
															,[BOS]			= SUM(BOS) 
															,NET			= SUM(NET) 
															,[BASARI]		= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															,YUZDE			= CAST(AVG(YUZDENET)AS DECIMAL(8,2))
															--,G.STKISAAD + ' TOPLAM' AS STKISAAD
														FROM	#TEMP_GELISIM_RAPORU_2 	G	
														JOIN	#TEMP_GELISIM_RAPORU		SINAVLIST	ON	SINAVLIST.ID_SINAVTURU = G.ID_SINAVTURU	
																										AND SINAVLIST.DERSAD = G.DERSAD
																										AND SINAVLIST.TCKIMLIKNO = G.TCKIMLIKNO
														WHERE SINAVAD <> 'ORTALAMA'
														GROUP BY ID_SINAV,G.TCKIMLIKNO,G.ID_SINAVTURU,SINAVAD,G.STKISAAD,SINAVTARIH
														ORDER BY G.ID_SINAVTURU,SINAVTARIH FOR JSON AUTO)
						--GELİŞİM ANALİZİ PUAN
						,GELISIMANALIZIPUAN			= ( SELECT DISTINCT	 
															 G.TCKIMLIKNO
															,G.ID_SINAVPUANTURU
															,G.PUANTURU
															,S.SINAVAD
															,S.PUAN
															,S.BASARI	
															,S.BASARI as NET
														FROM #TEMP_PUAN G 
														JOIN #TEMP_PUAN S ON S.TCKIMLIKNO = G.TCKIMLIKNO
																		  AND S.ID_SINAVPUANTURU = G.ID_SINAVPUANTURU
														FOR JSON AUTO)
						--NET ORTALAMA KARŞ
						,NETORTALAMAKARS			= (	SELECT OO.*, O.ORTALAMA AS GENEL, SUO.ORTALAMA AS SUBE, SO.ORTALAMA AS SINIF 
														FROM #TEMP_OO OO
														INNER JOIN #TEMP_O O ON O.STKISAAD = OO.STKISAAD AND O.DERSAD = OO.DERSAD
														INNER JOIN #TEMP_SUO SUO ON SUO.STKISAAD = OO.STKISAAD AND SUO.DERSAD = OO.DERSAD AND SUO.ID_SUBE = OO.ID_SUBE
														INNER JOIN #TEMP_SO SO ON SO.STKISAAD = OO.STKISAAD AND SO.DERSAD = OO.DERSAD AND SO.ID_SINIF = OO.ID_SINIF
														INNER JOIN #TEMP_OGRENCI OG ON OG.TCKIMLIKNO = OO.TCKIMLIKNO
														ORDER BY STKISAAD, BOLUMNO, DERSAD 
														FOR JSON PATH)
						--KONU ANALIZ
						,KONUANALIZ					= (	SELECT * 
														FROM #TEMP_KONUANALIZ TT 
														ORDER BY TT.DERSAD, TT.KOD 
														FOR JSON PATH)
						--ÖDEV RAPORU
						,ODEVRAPORU					= ( SELECT * 
														FROM #TEMP_ODEV_RAPORU 
														FOR JSON PATH)
						--ÖĞRETMEN DEĞERLENDİRME
						,OGRETMENDEGERLENDIRME		= (	SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEDETAY	= (	SELECT	 DY.TCKIMLIKNO
																,'PERİYOT: ' + CONVERT(VARCHAR, DP.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, DP.BITIS, 104) AS PERIYOT
																,K.AD + ' ' + K.SOYAD AS ADSOYAD
																,DY.YORUM
																,CONVERT(VARCHAR, DY.KYE_TARIH, 104) AS TARIH
																,CASE DY.TUR WHEN 0 THEN STUFF ((
																	SELECT DISTINCT ', ' + UPPER(D.AD)
																	FROM EOKUL_V2.DBO.dersogretmen DO
																	INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = DO.ID_DERS
																	WHERE DO.TC_OGRETMEN = DY.KYE_TCKIMLIKNO AND DO.ID_SINIF = O.ID_SINIF
																	FOR XML PATH('')), 1, 2, '') 
																 WHEN 1 THEN 'REHBERLİK'
																 WHEN 2 THEN 'DANIŞMANLIK' END AS BRANS
														FROM DegerlendirmeYorum				DY
														INNER JOIN #TEMP_OGRENCI			O	ON O.TCKIMLIKNO = DY.TCKIMLIKNO
														INNER JOIN DegerlendirmeYorumDurum	DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM
														INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
														INNER JOIN DegerlendirmePeriyot		DP	ON DP.ID_DEGERLENDIRMEPERIYOT = DY.ID_DEGERLENDIRMEPERIYOT
														WHERE	DY.YORUM <> '' 
															AND (@ID_MENU = 1142 OR DYD.DURUM = 1 )															-- 1142		Rapor/OgrenciBelge/GelisimRaporuOO
														ORDER BY DY.TCKIMLIKNO, DY.ID_DEGERLENDIRMEPERIYOT DESC, DY.KYE_TARIH DESC 
														FOR JSON PATH)
						-- ETÜT RAPORU
						,ETUTRAPORU					= ( SELECT TCKIMLIKNO,  TARIH, BRANS, ICERIK 
														FROM #TEMP_ETUT_RAPORU
														ORDER BY TCKIMLIKNO, TARIH DESC FOR JSON PATH)														
						,ABIDENEREDEYIMGRAFIK		= ( SELECT	 TCKIMLIKNO
																,SINAV
																,DERS
																,DUZEY
																,MAXDUZEY
														FROM #TEMP_NEREDEYIM_GRAFIGI
														ORDER BY TCKIMLIKNO, DERS,SINAV DESC FOR JSON PATH)														
						--LUS RAPORU
						,LUSRAPORU					= ( SELECT	TCKIMLIKNO,
															OPT, 
															CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
															CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
															YAZOGRETMEN, 
															CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
															CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
															YAZOGRENCI, 
															CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
															CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
															TOPLAM
														FROM #TEMP_RESULT
														WHERE TOPLAM != '-' FOR JSON PATH)
						,KOSRAPOR					= ( SELECT YOP.TCKIMLIKNO, CAST(YOP.TOPLAMPUAN AS INT) AS TOPLAM, KY.YORUM, K.AD + ' ' + K.SOYAD AS ADSOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														FROM #TEMP_YAZILIOGRENCITOPLAMPUAN			YOP
														JOIN KosYorum							KY	ON	KY.BASPUAN	<= YOP.TOPLAMPUAN AND KY.BITPUAN >= YOP.TOPLAMPUAN
														JOIN OkyanusDB.dbo.v3OgrenciTum			O	ON	O.TCKIMLIKNO = YOP.TCKIMLIKNO AND O.DONEM	  = @DONEMX
														JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum	SGS ON	SGS.ID_SINIF = O.ID_SINIF
														JOIN OkyanusDB.dbo.v3Kullanici			K	ON	K.TCKIMLIKNO = O.TCKIMLIKNO
														GROUP BY YOP.TCKIMLIKNO, YOP.TOPLAMPUAN, KY.YORUM, K.AD, K.SOYAD, SGS.SUBEAD, SGS.SINIF, O.OGRNO
														ORDER BY ADSOYAD FOR JSON PATH)
						,KOSRAPORDETAY				= ( SELECT	 TCKIMLIKNO
																,SORUNO
																,CAST(SORUNO AS VARCHAR) + ' -) ' + KAZANIM AS KAZANIM
																,CASE	WHEN PUANORAN < 101	AND PUANORAN >= 80	THEN '4'
																		WHEN PUANORAN < 80	AND PUANORAN >= 60	THEN '3'
																		WHEN PUANORAN < 60	AND PUANORAN >= 40	THEN '2'
																		WHEN PUANORAN < 40						THEN '1'
																	END AS DURUM
														FROM #TEMP_YAZILISORUOGRENCI
														ORDER BY TCKIMLIKNO, SORUNO  FOR JSON PATH)
						,OGRETMENDEGERLENDIRMEYORUMSUZ = ( SELECT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI
														FROM #TEMP_KENDIPUANORTALAMALARIEXCEL14 K
														ORDER BY K.TCKIMLIKNO, K.BOLUM, ID_DEGERLENDIRMEPERIYOT 
														FOR JSON PATH)
				FOR JSON PATH
			)

		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_GenelSoruAnalizi]...';


GO
ALTER procedure [dbo].[sp_GenelSoruAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,SQLJSON					= @SQLJSON		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBE					= @ID_SUBE		
			,ID_DERS					= @ID_DERS		
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_KADEME3					= @ID_KADEME3		
			,TC_OGRENCI			 		= @TC_OGRENCI		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )

		IF (@ISLEM = 1 OR @ISLEM = 2)  -- SINIF
		BEGIN
			
		
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[427,236]'
		--			,@ID_SINIFs		VARCHAR(MAX)= NULL
		--			,@ID_DERSs		VARCHAR(MAX)= '[847,942]'
		--			,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--			,@DONEM			VARCHAR(MAX)= '2017'
		--			,@ISLEM			INT			= 1		

			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #SINIF_CEVAP
			DROP TABLE IF EXISTS #SORUKARSILIK
			DROP TABLE IF EXISTS #YUZDE
			DROP TABLE IF EXISTS #DERS

			
			
			SELECT DERSAD INTO #DERS from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'

			

			SELECT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM,OC.CEVAP OGRENCICEVAP,SA.CEVAP DOGRUCEVAP
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A, SD.BOLUMNO
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD				= SO.KITAPCIK 
																AND SD.ID_SINAV			= S.ID_SINAV
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
		left	JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND O.DONEM			= @OGRENCIDONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		


			DROP TABLE IF EXISTS #SINIF_CEVAP
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,COUNT(OGRENCICEVAP) CEVAPSAYISI,CASE WHEN OGRENCICEVAP = '' THEN 'BOS' ELSE OGRENCICEVAP  END AS OGRENCICEVAP   ,0 OGRSAY,SORUNO_A,BOLUMNO,DOGRUCEVAP
			INTO #SINIF_CEVAP 
			FROM #TEMP_SINIF T
			GROUP BY KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,OGRENCICEVAP,SORUNO_A,BOLUMNO,DOGRUCEVAP
			

			DROP TABLE IF EXISTS #TEMP
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH, OGRSAY,SORUNO_A,BOLUMNO
				,ISNULL(P.A,0) A, AYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.B,0) B, BYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.C,0) C, CYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.D,0) D, DYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.E,0) E, EYUZDE=CAST(0 AS DECIMAL(8,2))
				,ISNULL(P.[BOS],0) BOS, BOSYUZDE=CAST(0 AS DECIMAL(8,2))
				,0 DOGRU, DOGRUYUZDE=CAST(0 AS DECIMAL(8,2))
				,DOGRUCEVAP
			INTO #TEMP
			FROM (
				SELECT * FROM #SINIF_CEVAP
			) AS Tbl
			PIVOT (MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]) ) AS P

			UPDATE T
			SET	AYUZDE = CAST(ISNULL(CAST(A AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				BYUZDE = CAST(ISNULL(CAST(B AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				CYUZDE = CAST(ISNULL(CAST(C AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				DYUZDE = CAST(ISNULL(CAST(D AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				EYUZDE = CAST(ISNULL(CAST(E AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2)),
				BOSYUZDE = CAST(ISNULL(CAST(BOS AS float) / CAST((SELECT SUM(A+B+C+D+E+BOS) FROM #TEMP G WHERE G.BOLUMNO=T.BOLUMNO AND G.SORUNO_A = T.SORUNO_A) AS float) ,0) * 100 AS DECIMAL(8,2))
			FROM #TEMP T

			UPDATE #TEMP 
			SET DOGRU=CASE DOGRUCEVAP
				WHEN 'A' THEN A 
				WHEN 'B' THEN B 
				WHEN 'C' THEN C 
				WHEN 'D' THEN D 
				WHEN 'E' THEN E
				ELSE NULL 
				END ,
				DOGRUYUZDE = CASE DOGRUCEVAP
				WHEN 'A' THEN AYUZDE 
				WHEN 'B' THEN BYUZDE 
				WHEN 'C' THEN CYUZDE 
				WHEN 'D' THEN DYUZDE 
				WHEN 'E' THEN EYUZDE
				ELSE NULL 
				END


			SELECT DISTINCT SK.AD KITAPCIK,SA.SORUNO_A,SA.SORUNO,SD.BOLUMNO
			INTO #SORUKARSILIK
			FROM Sinav			S
			JOIN #TEMP			T	ON	T.ID_SINAV			= S.ID_SINAV
			JOIN SinavDers		SD	ON	SD.ID_SINAV			= S.ID_SINAV
									AND SD.ID_DERS			= T.ID_DERS
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= S.ID_SINAV
									AND SK.AD				!='A'
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									AND SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
									AND SA.SORUNO_A			= T.SORUNO_A		
									

			IF @ISLEM = 1  -- DEVEXPRESS
			BEGIN
				select(
					select * from(
						select 
						(					
							SELECT * FROM #TEMP
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO,INCLUDE_NULL_VALUES
						) as TblVeri,					
						(					
							SELECT * FROM #SORUKARSILIK
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblSoruKarsilik
						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE
			BEGIN
				SELECT * FROM #TEMP
				ORDER BY BOLUMNO,SORUNO_A

				SELECT * FROM #SORUKARSILIK
				ORDER BY BOLUMNO,SORUNO_A	
				

				
			END
			



			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #SINIF_CEVAP
			DROP TABLE IF EXISTS #SORUKARSILIK
			DROP TABLE IF EXISTS #YUZDE
			DROP TABLE IF EXISTS #DERS			



		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_KarmaListe]...';


GO
ALTER procedure [dbo].[sp_KarmaListe]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_BURSLULUKDOSYA	INT				= NULL,
	@KENDISINIF			BIT				= NULL,
	@BURSLULUK			BIT				= NULL,
	@SINIFKAPASITE		BIT				= 0, --0 xbase/ 1 öğr say
	@SINAVTARIH			VARCHAR(50)		= NULL,
	@SEANS				VARCHAR(50)		= NULL,
	@JSEXCEL			NVARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL
AS
BEGIN
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_BURSLULUKDOSYA			= @ID_BURSLULUKDOSYA	
			,KENDISINIF					= @KENDISINIF			
			,BURSLULUK					= @BURSLULUK			
			,SINIFKAPASITE				= @SINIFKAPASITE		
			,SINAVTARIH					= @SINAVTARIH			
			,SEANS						= @SEANS				
			,JSEXCEL					= @JSEXCEL			
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
	
		DROP TABLE IF EXISTS #SINAVSINIF
		DROP TABLE IF EXISTS #OGRENCILIST
		DROP TABLE IF EXISTS #OL
		DROP TABLE IF EXISTS #SL
		DROP TABLE IF EXISTS #TT
		DROP TABLE IF EXISTS #SNF
		DROP TABLE IF EXISTS #ATANACAK
		DROP TABLE IF EXISTS #ATANAMAYANLAR
		DROP TABLE IF EXISTS #WSB
		DROP TABLE IF EXISTS #WSN
		DROP TABLE IF EXISTS #KARMA
		DROP TABLE IF EXISTS #KarmaTemp
		DROP TABLE IF EXISTS #OGR

		DECLARE @ID_KARMALISTE INT
		SET @ID_KARMALISTE = (	SELECT TOP 1 
									ID_KARMALISTE 
								FROM KarmaListeSQL 
								WHERE	KYE_TCKIMLIKNO	= @TCKIMLIKNO 
									AND SINAVTARIH		= @SINAVTARIH 
									AND (	(	@BURSLULUK = 1 AND SEANS = @SEANS)
											OR	@BURSLULUK = 0
										)
								ORDER BY ID_KARMALISTE DESC
							)

		IF @ISLEM =	0
		BEGIN
			RAISERROR ('Daha sonra tekrar deneyiniz.' , -- Message text.
						16, -- Severity.
						1-- State.
						);
		END

		IF @ISLEM =	1	--	YENİ DAĞIT
		BEGIN

			DECLARE @BASTARIH DATETIME=GETDATE()

	

				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= S.ID_SINIF
					,ID_SUBE		= SGS.ID_SUBE
					,SNFOGRSAY		= CASE	WHEN @SINIFKAPASITE = 1 
											THEN (SELECT COUNT(TCKIMLIKNO) FROM v3Ogrenci G WHERE G.ID_SINIF = S.ID_SINIF )
											ELSE D.SINAVKAPASITE
										END
					,RND			= ROW_NUMBER() OVER(ORDER BY NEWID())
				INTO #SINAVSINIF 
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.DBO.v3SubeGrupSinif 		AS	SGS	ON	SGS.ID_SINIF	= SL.VALUE
				INNER JOIN OkyanusDB.dbo.v3Sinif				AS	S	ON	S.ID_SINIF		= SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= S.ID_DERSLIK
		UNION
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= S.ID_SINIF
					,ID_SUBE		= S.ID_SUBE
					,SNFOGRSAY		= CASE	WHEN @SINIFKAPASITE = 1 AND S.ID_SINIF_KAMPUS IS NULL 
												THEN (SELECT COUNT(TC_OGRENCI) FROM OkyanusDB.dbo.v4SinifOgrenci G WHERE G.ID_SINIF = S.ID_SINIF AND G.AKTIF = 1)
											WHEN (@SINIFKAPASITE = 1 AND S.ID_SINIF_KAMPUS IS NOT NULL ) OR (@SINIFKAPASITE = 0 AND S.ID_SINIF_KAMPUS IS NOT NULL )
												THEN (SELECT COUNT(TCKIMLIKNO) FROM v3Ogrenci G WHERE G.ID_SINIF = S.ID_SINIF_KAMPUS )
											ELSE D.SINAVKAPASITE
										END
					,RND			= ROW_NUMBER() OVER(ORDER BY NEWID())
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.dbo.v4Sinif				AS	S	ON	S.ID_SINIF		= SL.VALUE
				LEFT  JOIN OkyanusDB.dbo.v3Sinif				AS	KS	ON	KS.ID_SINIF		= S.ID_SINIF_KAMPUS
				LEFT  JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= KS.ID_DERSLIK
				WHERE S.AKTIF = 1
			
			
			
			CREATE TABLE #OGRENCILIST (TCKIMLIKNO VARCHAR(MAX),ID_SINIF INT,RND INT,SINAVSINIF INT,ID_SUBE INT,ID_SINAV INT,ID_SINAVTURU INT)
			
			BEGIN
				BEGIN
					
					

					IF (@BURSLULUK=0)
					BEGIN
						
						INSERT INTO #OGRENCILIST
						SELECT DISTINCT O.TCKIMLIKNO,O.ID_SINIF,ROW_NUMBER() OVER(ORDER BY NEWID()) RND,0 SINAVSINIF,SS.ID_SUBE,ID_SINAV,ID_SINAVTURU
						FROM #SINAVSINIF	SS
						JOIN OkyanusDB.dbo.vw_SinifOgrenci		O	ON	O.ID_SINIF	= SS.ID_SINIF

					END
					ELSE
					BEGIN
						INSERT INTO #OGRENCILIST (TCKIMLIKNO ,ID_SINIF ,RND ,SINAVSINIF ,ID_SUBE ,ID_SINAV ,ID_SINAVTURU )
						SELECT	DISTINCT J.TCKIMLIKNO
								,0
								,ROW_NUMBER() OVER(ORDER BY NEWID())
								,0
								,J.ID_SUBE
								,J.ID_SINAV
								,12
						FROM BurslulukSinavOgrenci	J
						JOIN Sinav					S	ON	S.ID_SINAV	= J.ID_SINAV												
						WHERE	J.ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
							AND J.SINAVTARIH		= @SINAVTARIH
							AND J.SEANS				= @SEANS
							AND J.ID_SUBE			IN (SELECT ID_SUBE FROM #SINAVSINIF)
								
						WHILE EXISTS (SELECT * FROM #OGRENCILIST WHERE ID_SINIF = 0 )
						BEGIN		
							DECLARE @T VARCHAR(11) = (SELECT TOP 1 TCKIMLIKNO FROM #OGRENCILIST WHERE ID_SINIF = 0 ORDER BY RND)

							UPDATE O
							SET O.ID_SINIF = (	SELECT TOP 1 
													ID_SINIF 
												FROM #SINAVSINIF SS 
												WHERE	SS.SNFOGRSAY > (SELECT COUNT(1) FROM #OGRENCILIST OL WHERE OL.ID_SINIF = SS.ID_SINIF AND OL.ID_SUBE = SS.ID_SUBE) 
													AND O.ID_SUBE = SS.ID_SUBE 
												ORDER BY SS.SNFOGRSAY DESC
											)
							FROM #OGRENCILIST O
							WHERE TCKIMLIKNO = @T
						END
					END	
					
				END
				
				
				
				IF @KENDISINIF = 1
				BEGIN
					UPDATE O
					SET SINAVSINIF = O.ID_SINIF
					FROM #OGRENCILIST O
				END
				ELSE
				BEGIN

					DECLARE @tc VARCHAR(11), @idSinif INT, @idSube INT 

				
					CREATE TABLE #SNF(ID_SUBE INT, ID_SINIF INT, SNFOGRSAY INT, RND INT, RNSB INT)
					CREATE TABLE #OGR(ID_SUBE INT, ID_SINIF INT, TCKIMLIKNO VARCHAR(11), RND INT)
					CREATE TABLE #KARMA(TCKIMLIKNO VARCHAR(11), ID_SINIF INT)
					
					INSERT INTO #OGR(ID_SUBE, ID_SINIF, TCKIMLIKNO, RND)
					SELECT SS.ID_SUBE, O.ID_SINIF, TCKIMLIKNO, RND = ROW_NUMBER() OVER(ORDER BY NEWID()) 
					FROM OkyanusDB.dbo.vw_SinifOgrenci	O
					JOIN #SINAVSINIF					SS	ON	SS.ID_SINIF = O.ID_SINIF 

					
					INSERT INTO #SNF(ID_SUBE ,ID_SINIF, SNFOGRSAY) 
					SELECT ID_SUBE, ID_SINIF, COUNT(1)
					FROM #OGR O
					GROUP BY ID_SUBE, ID_SINIF

					
					UPDATE S
					SET S.RNSB = K.RNSB
					FROM #SNF S
					JOIN (
						SELECT ID_SUBE, RNSB = ROW_NUMBER() OVER(ORDER BY ID_SUBE) 
						FROM #SNF K
						GROUP BY ID_SUBE) AS K ON K.ID_SUBE = S.ID_SUBE

					UPDATE S
					SET S.RND = K.RND
					FROM #SNF S
					JOIN (  SELECT 
								 ID_SUBE
								,ID_SINIF
								,RND = ROW_NUMBER() OVER(PARTITION BY ID_SUBE ORDER BY NEWID())
							FROM #SNF K
							GROUP BY ID_SUBE, ID_SINIF
					) AS K ON K.ID_SUBE = S.ID_SUBE AND K.ID_SINIF = S.ID_SINIF


				SELECT DISTINCT T.ID_SUBE, T.ID_SINIF, ADET = 0
				INTO #KarmaTemp FROM #SNF	T

				DECLARE @I_SUBE INT = 1, @COUNT_SUBE INT
				SET @COUNT_SUBE = (SELECT MAX(RNSB) FROM #SNF)
				-- Sube Kadar Dön
				WHILE @I_SUBE <= @COUNT_SUBE
				BEGIN

					DECLARE @I_SINIF INT = 1, @COUNT_SINIF INT, @SNFOGRSAY INT = 0
					SET @COUNT_SINIF = (SELECT COUNT(DISTINCT ID_SINIF) FROM #SNF WHERE RNSB = @I_SUBE)
					-- Sýnýf Kadar Dön
					WHILE @I_SINIF <= @COUNT_SINIF
					BEGIN
		
						SELECT @idSinif = ID_SINIF, @SNFOGRSAY = SNFOGRSAY FROM #SNF WHERE RND = @I_SINIF AND RNSB = @I_SUBE
			
						CREATE TABLE #OGRTEMP(ID_SUBE INT, TCKIMLIKNO VARCHAR(11), RND INT)

						INSERT INTO #OGRTEMP(ID_SUBE, TCKIMLIKNO, RND)
						SELECT DISTINCT ID_SUBE, TCKIMLIKNO, RND = ROW_NUMBER() OVER(ORDER BY NEWID()) 
						FROM #OGR
						WHERE ID_SINIF = @idSinif


						DECLARE @I INT = 1, @COUNT INT = 0
						SET @COUNT = (SELECT COUNT(1) FROM #OGRTEMP)

						SET @I = 1
						-- Sınıftaki Öğrenci Kadar Dön
						WHILE @I <= @COUNT
						BEGIN
	
							SELECT @tc = TCKIMLIKNO, @idSube = ID_SUBE FROM #OGRTEMP WHERE RND = @I
	
							SELECT TOP 1
								@idSinif = K.ID_SINIF
							FROM #SNF				T
							INNER JOIN #KarmaTemp	K	ON	T.ID_SINIF = K.ID_SINIF AND T.ID_SUBE = K.ID_SUBE AND T.SNFOGRSAY > K.ADET
							WHERE T.ID_SUBE = @idSube
							ORDER BY K.ADET

		
							INSERT INTO #KARMA(TCKIMLIKNO, ID_SINIF) VALUES(@tc, @idSinif)

							UPDATE #KarmaTemp
							SET ADET = ADET + 1
							WHERE ID_SINIF = @idSinif

							SET @I = @I + 1
						END

						DROP TABLE #OGRTEMP

						SET @I_SINIF = @I_SINIF + 1
					END


					SET @I_SUBE = @I_SUBE + 1
				END
				
			
				
				UPDATE O
				SET SINAVSINIF = T.ID_SINIF
				FROM #OGRENCILIST O
				JOIN #KARMA T ON T.TCKIMLIKNO = O.TCKIMLIKNO			

						
				
					
				END

				IF EXISTS( SELECT 1 FROM #OGRENCILIST WHERE SINAVSINIF IS NULL OR SINAVSINIF = 0)
				BEGIN
					RAISERROR ('Seçilen sınıf sayısı yeterli değildir.', 16, 1);
					RETURN;
				END
				ELSE
				BEGIN
						IF @BURSLULUK = 1
						BEGIN
							DELETE FROM KarmaListeSQL WHERE SINAVTARIH = CAST(@SINAVTARIH as datetime) AND SEANS = @SEANS AND KYE_TCKIMLIKNO = @TCKIMLIKNO
							INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO,BAS_TARIH,SEANS)
							VALUES (@SQLJSON,@KENDISINIF,@SINAVTARIH,@TCKIMLIKNO,@BASTARIH,@SEANS)
							SET @ID_KARMALISTE = SCOPE_IDENTITY()
						END
						ELSE
						BEGIN
							DELETE FROM KarmaListeSQL WHERE SINAVTARIH =  cast(@SINAVTARIH as datetime)  AND KYE_TCKIMLIKNO=@TCKIMLIKNO
							INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO,BAS_TARIH)
							VALUES (@SQLJSON,@KENDISINIF,@SINAVTARIH,@TCKIMLIKNO,@BASTARIH)
							SET @ID_KARMALISTE = SCOPE_IDENTITY()
						END
				

					DELETE FROM KarmaListeTemp WHERE ID_KARMALISTE NOT IN (SELECT ID_KARMALISTE FROM KarmaListeSQL)
					INSERT INTO KarmaListeTemp (ID_KARMALISTE,TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU)
					SELECT @ID_KARMALISTE,TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU FROM #OGRENCILIST
				END

			END

			SET @ISLEM = 3 -- RAPOR			
			

		END

		IF @ISLEM = 2	--	KarmaListeExcel YÜKLE
		BEGIN		
		
			DELETE FROM KarmaListeSQL WHERE SINAVTARIH =  cast(@SINAVTARIH as datetime)  AND KYE_TCKIMLIKNO=@TCKIMLIKNO
			INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO)
			VALUES ('EXCEL',0,cast(@SINAVTARIH as datetime),@TCKIMLIKNO)

			SET @ID_KARMALISTE = SCOPE_IDENTITY()
		
			DELETE FROM KarmaListeExcel WHERE ID_KARMALISTE NOT IN (SELECT ID_KARMALISTE FROM KarmaListeSQL)

			INSERT INTO KarmaListeExcel (ID_KARMALISTE,TCKIMLIKNO,ADSOYAD)
			SELECT	 @ID_KARMALISTE
					,TCKIMLIKNO		= JSON_VALUE (J.VALUE,'$.TCKIMLIKNO') 
					,ADSOYAD		= JSON_VALUE (J.VALUE,'$.ADSOYAD') 			
			FROM OPENJSON (@JSEXCEL) AS J
			--FOR JSON PATH
		END

		IF @ISLEM = 3	--	RAPOR
		BEGIN
	
				SELECT TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU INTO #OGRENCILIST2 FROM KarmaListeTemp WHERE ID_KARMALISTE = @ID_KARMALISTE

				SET @SQLJSON = (SELECT TOP 1 SQLJSON FROM KarmaListeSQL WHERE ID_KARMALISTE = @ID_KARMALISTE)

				
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= SL.VALUE 
					,ID_SUBE		= SGS.ID_SUBE
					--,SNFOGRSAY		= D.SINAVKAPASITE
					,SUBOGRSAY		= 0
					,SNFSAY			= 0
					,RND			= 0
					,MINSINIF		= 0
					--,ID_DERSSEVIYE	= NULL
					,DERSSEVIYE		= NULL
				INTO #SINAVSINIF2 
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.DBO.v3SubeGrupSinif 		AS	SGS	ON	SGS.ID_SINIF	= SL.VALUE
				INNER JOIN OkyanusDB.dbo.v3Sinif				AS	S	ON	S.ID_SINIF		= SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= S.ID_DERSLIK
			UNION
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= SL.VALUE 
					,ID_SUBE		= S.ID_SUBE
					--,SNFOGRSAY		= D.SINAVKAPASITE
					,SUBOGRSAY		= 0
					,SNFSAY			= 0
					,RND			= 0
					,MINSINIF		= 0
					--,ID_DERSSEVIYE	= SD.ID_DERSSEVIYE
					,DERSSEVIYE		= SD.DERSSEVIYE
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.dbo.v4Sinif				AS	S	ON	S.ID_SINIF		= SL.VALUE
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay		AS	SD	ON	SD.ID_SINIF		= S.ID_SINIF
				LEFT  JOIN OkyanusDB.dbo.v3Sinif				AS	KS	ON	KS.ID_SINIF		= S.ID_SINIF_KAMPUS
				LEFT  JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= KS.ID_DERSLIK
				WHERE S.AKTIF = 1



		
					IF @BURSLULUK = 0
					BEGIN
					
						SELECT	OL.TCKIMLIKNO
							,SINIFAD			= OSN.AD
							,SUBEAD				= SB.AD
							,ID_SUBE			= SB.ID_SUBE	
							,ID_SINIF			= OSN.ID_SINIF	
							,SINAVSINIFAD		= SSN.AD
							,SINIFSUBEAD		= SB.AD+'-'+OSN.AD
							,SINAVSINIFSUBEAD	= SB.AD+'-'+SSN.AD
							,ID_SINIFSINAV		= SSN.ID_SINIF
							,ADSOYAD			= K.AD+' '+K.SOYAD
							,RND
							,O.OGRNO
							,DERSSEVIYE			= NULL
							,SINAVAD			= CASE	WHEN OL.ID_SINAVTURU = 0 
													THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
													ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
													END
						FROM #OGRENCILIST2	OL
						JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= OL.TCKIMLIKNO
						JOIN v3Sinif		OSN	ON	OSN.ID_SINIF	= O.ID_SINIF
						JOIN v3Sinif		SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube			SB	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO						
					UNION
						SELECT	
							 TCKIMLIKNO			= OL.TCKIMLIKNO
							,SINIFAD			= OS.AD
							,SUBEAD				= SB.AD
							,ID_SUBE			= SB.ID_SUBE	
							,ID_SINIF			= OS.ID_SINIF	
							,SINAVSINIFAD		= ISNULL(SS.AD,SSN.AD)
							,SINIFSUBEAD		= SB.AD + '-' + OS.AD
							,SINAVSINIFSUBEAD	= SB.AD + '-' + ISNULL(SS.AD,SSN.AD)
							,ID_SINIFSINAV		= ISNULL(SS.ID_SINIF,SSN.ID_SINIF)
							,ADSOYAD			= K.AD + ' ' + K.SOYAD
							,RND
							,O.OGRNO
							--,ID_DERSSEVIYE		= OSN.ID_DERSSEVIYE
							,DERSSEVIYE			= OSN.DERSSEVIYE
							,SINAVAD			= CASE	WHEN OL.ID_SINAVTURU = 0 
													THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
													ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
													END
						FROM #OGRENCILIST2						OL
						JOIN v3Ogrenci							O	ON	O.TCKIMLIKNO	= OL.TCKIMLIKNO
						JOIN v3Sinif							OS	ON	OS.ID_SINIF		= O.ID_SINIF
						JOIN OkyanusDB.dbo.vw_v4SinifDetay		OSN	ON	OSN.ID_SINIF	= OL.ID_SINIF
						JOIN OkyanusDB.dbo.v4Sinif				SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube								SB	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						--JOIN v3Sinif							SS	ON	SS.ID_SINIF		= SSN.ID_SINIF_KAMPUS
						LEFT JOIN v3Sinif						SS	ON	SS.ID_SINIF		= SSN.ID_SINIF_KAMPUS

					END
					ELSE
					BEGIN

						SELECT	OL.TCKIMLIKNO
							,SINIFAD	  = ''
							,SUBEAD		  = SB.AD
							,ID_SUBE	  = SB.ID_SUBE	
							,ID_SINIF	  = OSN.ID_SINIF	
							,SINAVSINIFAD = SSN.AD
							,ID_SINIFSINAV= SSN.ID_SINIF
							,SINIFSUBEAD  = SB.AD+'-'+OSN.AD
							,SINAVSINIFSUBEAD  = SB.AD+'-'+SSN.AD

							,ADSOYAD	  = K.AD+' '+K.SOYAD
							,RND
							,OGRNO		= ''--row_number() over(order by OL.TCKIMLIKNO)
							,SINAVAD	= CASE	WHEN OL.ID_SINAVTURU = 0 
												THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
												ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
												END
						FROM #OGRENCILIST2	OL	
						JOIN v3Sinif		OSN	ON	OSN.ID_SINIF	= OL.ID_SINIF
						JOIN v3Sinif		SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube			SB	ON	SB.ID_SUBE		= OL.ID_SUBE
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= OL.TCKIMLIKNO
						ORDER BY OL.ID_SUBE,OL.SINAVSINIF,RND
					END

					-- SINIF
					SELECT	 SS.ID_SINIF
							,SINIFAD		= SD.SUBEAD +'-'+ SD.SINIF
							,KAGITSAYISI	= (SELECT COUNT(1) FROM #OGRENCILIST2 O WHERE O.SINAVSINIF = SS.ID_SINIF AND O.ID_SINAV = OL.ID_SINAV)
							,SINAVAD		= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,TARIH			= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,GUN			= datename(dw,
													CASE	WHEN OL.ID_SINAVTURU = 0 
																				THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																				ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																				END)
							,SEANS			= ISNULL(@SEANS,'')
							--,ID_DERSSEVIYE	= NULL
							,DERSSEVIYE		= NULL
					FROM #SINAVSINIF2					SS
					JOIN #OGRENCILIST2					OL	ON	OL.SINAVSINIF	= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sinif			S	ON	S.ID_SINIF		= SS.ID_SINIF
					JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= SS.ID_SINIF
					GROUP BY SS.ID_SINIF,OL.ID_SINAVTURU,OL.ID_SINAV,OL.ID_SUBE,SD.SUBEAD,SD.SINIF
				UNION 					
					SELECT	 SS.ID_SINIF
							,SINIFAD		= IIF(SD.SINIF IS NOT NULL ,SD.SUBEAD +'-'+ SD.SINIF,SB.AD+'-'+S.AD)
							,KAGITSAYISI	= (SELECT COUNT(1) FROM #OGRENCILIST2 O WHERE O.SINAVSINIF = SS.ID_SINIF AND O.ID_SINAV = OL.ID_SINAV)
							,SINAVAD		= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,TARIH			= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,GUN			= datename(dw,
													CASE	WHEN OL.ID_SINAVTURU = 0 
																				THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																				ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																				END)
							,SEANS			= ISNULL(@SEANS,'')
							--,SS.ID_DERSSEVIYE
							,OSD.DERSSEVIYE
					FROM #SINAVSINIF2						SS
					JOIN #OGRENCILIST2						OL	ON	OL.SINAVSINIF	= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v4Sinif				S	ON	S.ID_SINIF		= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE		= S.ID_SUBE
					JOIN OkyanusDB.dbo.vw_v4SinifDetay		OSD	ON	OSD.ID_SINIF	= OL.ID_SINIF
					LEFT JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= S.ID_SINIF_KAMPUS
					GROUP BY SS.ID_SINIF,OL.ID_SINAVTURU,OL.ID_SINAV,OL.ID_SUBE,SD.SUBEAD,SD.SINIF, OSD.DERSSEVIYE, S.AD, SB.AD--,SD.ID_DERSSEVIYE
					ORDER BY SS.ID_SINIF



					-- OKUL		
					SELECT	 ID_SINAV
							,OL.ID_SUBE
							,KAGITSAYISI= COUNT(1) 
							,SUBEAD		= SD.SUBEAD --(SELECT TOP 1 AD FROM v3Sube SB WHERE SB.ID_SUBE = OL.ID_SUBE )
							,SINAVAD	= CASE	WHEN OL.ID_SINAVTURU = 0 
														THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
														ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
														END
							,TARIH		= CASE	WHEN OL.ID_SINAVTURU = 0 
														THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
														ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
														END
							,GUN		= datename(dw,
												CASE	WHEN OL.ID_SINAVTURU = 0 
																			THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																			ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																			END)
							,SEANS		= ISNULL(@SEANS,'')
							--,SD.ID_DERSSEVIYE
							,SD.DERSSEVIYE
					FROM #OGRENCILIST2					OL
					JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= OL.ID_SINIF
					GROUP BY ID_SINAV,OL.ID_SUBE,ID_SINAVTURU,SD.SUBEAD, SD.DERSSEVIYE--,SD.ID_DERSSEVIYE


		END
		
		IF @ISLEM = 4	--	KARMA LISTE BURSLULUK LISTE
		BEGIN
		
			DROP TABLE IF EXISTS #TEMP

			SELECT  
				 ID_SUBE		= T.ID_SUBE
				,ID_SINAV		= T.ID_SINAV
				,ID_KADEME3		= T.ID_KADEME3
				,KADEME3		= K3.AD
				,BSV_SAY		= COUNT(1)	
				,SINAVAD		= S.AD
				,ID_SINAVTURU	= S.ID_SINAVTURU
			INTO #TEMP
			FROM BurslulukSinavOgrenci	T
			JOIN v3Kademe3				K3	ON	K3.ID_KADEME3	= T.ID_KADEME3
			JOIN Sinav					S	ON	S.ID_SINAV		= T.ID_SINAV
			WHERE	T.ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
				AND T.SINAVTARIH		= @SINAVTARIH
				AND T.SEANS				= @SEANS
			GROUP BY T.ID_SUBE, T.ID_SINAV, T.ID_KADEME3, K3.AD, S.AD, S.ID_SINAVTURU

			SELECT(
				SELECT   
					 ID_SUBE	= SB.ID_SUBE
					,SUBEAD		= SB.AD
					,ID_KADEME3	= SN.ID_KADEME3
					,ID_SINAV	= SN.ID_SINAV
					,SINAVAD	= SN.SINAVAD
					,KADEME3	= SN.KADEME3
					,BSV_SAY	= SN.BSV_SAY
					,ID_SINAVTURU
				FROM #TEMP		SN
				JOIN v3Sube		SB	ON	SB.ID_SUBE		= SN.ID_SUBE	
				WHERE SN.ID_SINAV > 0
				ORDER BY ID_SUBE,ID_KADEME3
				FOR JSON AUTO
			) AS S

			DROP TABLE IF EXISTS #TEMP

		END
		
		DROP TABLE IF EXISTS #ATANACAK
		DROP TABLE IF EXISTS #ATANAMAYANLAR
		DROP TABLE IF EXISTS #OGRENCILIST
		DROP TABLE IF EXISTS #OGRENCILIST2
		DROP TABLE IF EXISTS #OL
		DROP TABLE IF EXISTS #SINAVSINIF
		DROP TABLE IF EXISTS #SINAVSINIF2
		DROP TABLE IF EXISTS #SL
		DROP TABLE IF EXISTS #SNF
		DROP TABLE IF EXISTS #TT
		DROP TABLE IF EXISTS #WSB
		DROP TABLE IF EXISTS #WSN
		DROP TABLE IF EXISTS #KARMA
		DROP TABLE IF EXISTS #KarmaTemp
		DROP TABLE IF EXISTS #OGR

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_KarmaListe3]...';


GO
ALTER procedure [dbo].[sp_KarmaListe3]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_BURSLULUKDOSYA	INT				= NULL,
	@KENDISINIF			BIT				= NULL,
	@BURSLULUK			BIT				= NULL,
	@SINIFKAPASITE		BIT				= 0, --0 xbase/ 1 öğr say
	@SINAVTARIH			VARCHAR(50)		= NULL,
	@SEANS				VARCHAR(50)		= NULL,
	@JSEXCEL			NVARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,ID_BURSLULUKDOSYA			= @ID_BURSLULUKDOSYA	
			,KENDISINIF					= @KENDISINIF			
			,BURSLULUK					= @BURSLULUK			
			,SINIFKAPASITE				= @SINIFKAPASITE		
			,SINAVTARIH					= @SINAVTARIH			
			,SEANS						= @SEANS				
			,JSEXCEL					= @JSEXCEL			
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
	
		DROP TABLE IF EXISTS #SINAVSINIF
		DROP TABLE IF EXISTS #OGRENCILIST
		DROP TABLE IF EXISTS #OL
		DROP TABLE IF EXISTS #SL
		DROP TABLE IF EXISTS #TT
		DROP TABLE IF EXISTS #SNF
		DROP TABLE IF EXISTS #ATANACAK
		DROP TABLE IF EXISTS #ATANAMAYANLAR
		DROP TABLE IF EXISTS #WSB
		DROP TABLE IF EXISTS #WSN
		DROP TABLE IF EXISTS #KARMA
		DROP TABLE IF EXISTS #KarmaTemp
		DROP TABLE IF EXISTS #OGR

		DECLARE @ID_KARMALISTE INT
		SET @ID_KARMALISTE = (	SELECT TOP 1 
									ID_KARMALISTE 
								FROM KarmaListeSQL 
								WHERE	KYE_TCKIMLIKNO	= @TCKIMLIKNO 
									AND SINAVTARIH		= @SINAVTARIH 
									AND (	(	@BURSLULUK = 1 AND SEANS = @SEANS)
											OR	@BURSLULUK = 0
										)
								ORDER BY ID_KARMALISTE DESC
							)

		IF @ISLEM =	0
		BEGIN
			RAISERROR ('Daha sonra tekrar deneyiniz.' , -- Message text.
						16, -- Severity.
						1-- State.
						);
		END

		IF @ISLEM =	1	--	YENİ DAĞIT
		BEGIN

			DECLARE @BASTARIH DATETIME=GETDATE()

	

				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= S.ID_SINIF
					,ID_SUBE		= SGS.ID_SUBE
					,SNFOGRSAY		= CASE	WHEN @SINIFKAPASITE = 1 
											THEN (SELECT COUNT(TCKIMLIKNO) FROM v3Ogrenci G WHERE G.ID_SINIF = S.ID_SINIF )
											ELSE D.SINAVKAPASITE
										END
					,RND			= ROW_NUMBER() OVER(ORDER BY NEWID())
				INTO #SINAVSINIF 
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.DBO.v3SubeGrupSinif 		AS	SGS	ON	SGS.ID_SINIF	= SL.VALUE
				INNER JOIN OkyanusDB.dbo.v3Sinif				AS	S	ON	S.ID_SINIF		= SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= S.ID_DERSLIK
		UNION
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= S.ID_SINIF
					,ID_SUBE		= S.ID_SUBE
					,SNFOGRSAY		= CASE	WHEN @SINIFKAPASITE = 1 AND S.ID_SINIF_KAMPUS IS NULL 
												THEN (SELECT COUNT(TC_OGRENCI) FROM OkyanusDB.dbo.v4SinifOgrenci G WHERE G.ID_SINIF = S.ID_SINIF AND G.AKTIF = 1)
											WHEN (@SINIFKAPASITE = 1 AND S.ID_SINIF_KAMPUS IS NOT NULL ) OR (@SINIFKAPASITE = 0 AND S.ID_SINIF_KAMPUS IS NOT NULL )
												THEN (SELECT COUNT(TCKIMLIKNO) FROM v3Ogrenci G WHERE G.ID_SINIF = S.ID_SINIF_KAMPUS )
											ELSE D.SINAVKAPASITE
										END
					,RND			= ROW_NUMBER() OVER(ORDER BY NEWID())
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.dbo.v4Sinif				AS	S	ON	S.ID_SINIF		= SL.VALUE
				LEFT  JOIN OkyanusDB.dbo.v3Sinif				AS	KS	ON	KS.ID_SINIF		= S.ID_SINIF_KAMPUS
				LEFT  JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= KS.ID_DERSLIK
				WHERE S.AKTIF = 1
			
			
			
			CREATE TABLE #OGRENCILIST (TCKIMLIKNO VARCHAR(MAX),ID_SINIF INT,RND INT,SINAVSINIF INT,ID_SUBE INT,ID_SINAV INT,ID_SINAVTURU INT)
			
			BEGIN
				BEGIN
					
					

					IF (@BURSLULUK=0)
					BEGIN
						
						INSERT INTO #OGRENCILIST
						SELECT DISTINCT O.TCKIMLIKNO,O.ID_SINIF,ROW_NUMBER() OVER(ORDER BY NEWID()) RND,0 SINAVSINIF,SS.ID_SUBE,ID_SINAV,ID_SINAVTURU
						FROM #SINAVSINIF	SS
						JOIN OkyanusDB.dbo.vw_SinifOgrenci		O	ON	O.ID_SINIF	= SS.ID_SINIF

					END
					ELSE
					BEGIN
						INSERT INTO #OGRENCILIST (TCKIMLIKNO ,ID_SINIF ,RND ,SINAVSINIF ,ID_SUBE ,ID_SINAV ,ID_SINAVTURU )
						SELECT	DISTINCT J.TCKIMLIKNO
								,0
								,ROW_NUMBER() OVER(ORDER BY NEWID())
								,0
								,J.ID_SUBE
								,J.ID_SINAV
								,12
						FROM BurslulukSinavOgrenci	J
						JOIN Sinav					S	ON	S.ID_SINAV	= J.ID_SINAV												
						WHERE	J.ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
							AND J.SINAVTARIH		= @SINAVTARIH
							AND J.SEANS				= @SEANS
							AND J.ID_SUBE			IN (SELECT ID_SUBE FROM #SINAVSINIF)
								
						WHILE EXISTS (SELECT * FROM #OGRENCILIST WHERE ID_SINIF = 0 )
						BEGIN		
							DECLARE @T VARCHAR(11) = (SELECT TOP 1 TCKIMLIKNO FROM #OGRENCILIST WHERE ID_SINIF = 0 ORDER BY RND)

							UPDATE O
							SET O.ID_SINIF = (	SELECT TOP 1 
													ID_SINIF 
												FROM #SINAVSINIF SS 
												WHERE	SS.SNFOGRSAY > (SELECT COUNT(1) FROM #OGRENCILIST OL WHERE OL.ID_SINIF = SS.ID_SINIF AND OL.ID_SUBE = SS.ID_SUBE) 
													AND O.ID_SUBE = SS.ID_SUBE 
												ORDER BY SS.SNFOGRSAY DESC
											)
							FROM #OGRENCILIST O
							WHERE TCKIMLIKNO = @T
						END
					END	
					
				END
				
				
				
				IF @KENDISINIF = 1
				BEGIN
					UPDATE O
					SET SINAVSINIF = O.ID_SINIF
					FROM #OGRENCILIST O
				END
				ELSE
				BEGIN

					DECLARE @tc VARCHAR(11), @idSinif INT, @idSube INT 

				
					CREATE TABLE #SNF(ID_SUBE INT, ID_SINIF INT, SNFOGRSAY INT, RND INT, RNSB INT)
					CREATE TABLE #OGR(ID_SUBE INT, ID_SINIF INT, TCKIMLIKNO VARCHAR(11), RND INT)
					CREATE TABLE #KARMA(TCKIMLIKNO VARCHAR(11), ID_SINIF INT)
					
					INSERT INTO #OGR(ID_SUBE, ID_SINIF, TCKIMLIKNO, RND)
					SELECT SS.ID_SUBE, O.ID_SINIF, TCKIMLIKNO, RND = ROW_NUMBER() OVER(ORDER BY NEWID()) 
					FROM OkyanusDB.dbo.vw_SinifOgrenci	O
					JOIN #SINAVSINIF					SS	ON	SS.ID_SINIF = O.ID_SINIF 

					
					INSERT INTO #SNF(ID_SUBE ,ID_SINIF, SNFOGRSAY) 
					SELECT ID_SUBE, ID_SINIF, COUNT(1)
					FROM #OGR O
					GROUP BY ID_SUBE, ID_SINIF

					
					UPDATE S
					SET S.RNSB = K.RNSB
					FROM #SNF S
					JOIN (
						SELECT ID_SUBE, RNSB = ROW_NUMBER() OVER(ORDER BY ID_SUBE) 
						FROM #SNF K
						GROUP BY ID_SUBE) AS K ON K.ID_SUBE = S.ID_SUBE

					UPDATE S
					SET S.RND = K.RND
					FROM #SNF S
					JOIN (  SELECT 
								 ID_SUBE
								,ID_SINIF
								,RND = ROW_NUMBER() OVER(PARTITION BY ID_SUBE ORDER BY NEWID())
							FROM #SNF K
							GROUP BY ID_SUBE, ID_SINIF
					) AS K ON K.ID_SUBE = S.ID_SUBE AND K.ID_SINIF = S.ID_SINIF


				SELECT DISTINCT T.ID_SUBE, T.ID_SINIF, ADET = 0
				INTO #KarmaTemp FROM #SNF	T

				DECLARE @I_SUBE INT = 1, @COUNT_SUBE INT
				SET @COUNT_SUBE = (SELECT MAX(RNSB) FROM #SNF)
				-- Sube Kadar Dön
				WHILE @I_SUBE <= @COUNT_SUBE
				BEGIN

					DECLARE @I_SINIF INT = 1, @COUNT_SINIF INT, @SNFOGRSAY INT = 0
					SET @COUNT_SINIF = (SELECT COUNT(DISTINCT ID_SINIF) FROM #SNF WHERE RNSB = @I_SUBE)
					-- Sýnýf Kadar Dön
					WHILE @I_SINIF <= @COUNT_SINIF
					BEGIN
		
						SELECT @idSinif = ID_SINIF, @SNFOGRSAY = SNFOGRSAY FROM #SNF WHERE RND = @I_SINIF AND RNSB = @I_SUBE
			
						CREATE TABLE #OGRTEMP(ID_SUBE INT, TCKIMLIKNO VARCHAR(11), RND INT)

						INSERT INTO #OGRTEMP(ID_SUBE, TCKIMLIKNO, RND)
						SELECT DISTINCT ID_SUBE, TCKIMLIKNO, RND = ROW_NUMBER() OVER(ORDER BY NEWID()) 
						FROM #OGR
						WHERE ID_SINIF = @idSinif


						DECLARE @I INT = 1, @COUNT INT = 0
						SET @COUNT = (SELECT COUNT(1) FROM #OGRTEMP)

						SET @I = 1
						-- Sınıftaki Öğrenci Kadar Dön
						WHILE @I <= @COUNT
						BEGIN
	
							SELECT @tc = TCKIMLIKNO, @idSube = ID_SUBE FROM #OGRTEMP WHERE RND = @I
	
							SELECT TOP 1
								@idSinif = K.ID_SINIF
							FROM #SNF				T
							INNER JOIN #KarmaTemp	K	ON	T.ID_SINIF = K.ID_SINIF AND T.ID_SUBE = K.ID_SUBE AND T.SNFOGRSAY > K.ADET
							WHERE T.ID_SUBE = @idSube
							ORDER BY K.ADET

		
							INSERT INTO #KARMA(TCKIMLIKNO, ID_SINIF) VALUES(@tc, @idSinif)

							UPDATE #KarmaTemp
							SET ADET = ADET + 1
							WHERE ID_SINIF = @idSinif

							SET @I = @I + 1
						END

						DROP TABLE #OGRTEMP

						SET @I_SINIF = @I_SINIF + 1
					END


					SET @I_SUBE = @I_SUBE + 1
				END
				
			
				
				UPDATE O
				SET SINAVSINIF = T.ID_SINIF
				FROM #OGRENCILIST O
				JOIN #KARMA T ON T.TCKIMLIKNO = O.TCKIMLIKNO			

						
				
					
				END

				IF EXISTS( SELECT 1 FROM #OGRENCILIST WHERE SINAVSINIF IS NULL OR SINAVSINIF = 0)
				BEGIN
					RAISERROR ('Seçilen sınıf sayısı yeterli değildir.', 16, 1);
					RETURN;
				END
				ELSE
				BEGIN
						IF @BURSLULUK = 1
						BEGIN
							DELETE FROM KarmaListeSQL WHERE SINAVTARIH = CAST(@SINAVTARIH as datetime) AND SEANS = @SEANS AND KYE_TCKIMLIKNO = @TCKIMLIKNO
							INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO,BAS_TARIH,SEANS)
							VALUES (@SQLJSON,@KENDISINIF,@SINAVTARIH,@TCKIMLIKNO,@BASTARIH,@SEANS)
							SET @ID_KARMALISTE = SCOPE_IDENTITY()
						END
						ELSE
						BEGIN
							DELETE FROM KarmaListeSQL WHERE SINAVTARIH =  cast(@SINAVTARIH as datetime)  AND KYE_TCKIMLIKNO=@TCKIMLIKNO
							INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO,BAS_TARIH)
							VALUES (@SQLJSON,@KENDISINIF,@SINAVTARIH,@TCKIMLIKNO,@BASTARIH)
							SET @ID_KARMALISTE = SCOPE_IDENTITY()
						END
				

					DELETE FROM KarmaListeTemp WHERE ID_KARMALISTE NOT IN (SELECT ID_KARMALISTE FROM KarmaListeSQL)
					INSERT INTO KarmaListeTemp (ID_KARMALISTE,TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU)
					SELECT @ID_KARMALISTE,TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU FROM #OGRENCILIST
				END

			END

			SET @ISLEM = 3 -- RAPOR			
			

		END

		IF @ISLEM = 2	--	KarmaListeExcel YÜKLE
		BEGIN		
		
			DELETE FROM KarmaListeSQL WHERE SINAVTARIH =  cast(@SINAVTARIH as datetime)  AND KYE_TCKIMLIKNO=@TCKIMLIKNO
			INSERT INTO KarmaListeSQL (SQLJSON,KENDISINIF,SINAVTARIH,KYE_TCKIMLIKNO)
			VALUES ('EXCEL',0,cast(@SINAVTARIH as datetime),@TCKIMLIKNO)

			SET @ID_KARMALISTE = SCOPE_IDENTITY()
		
			DELETE FROM KarmaListeExcel WHERE ID_KARMALISTE NOT IN (SELECT ID_KARMALISTE FROM KarmaListeSQL)

			INSERT INTO KarmaListeExcel (ID_KARMALISTE,TCKIMLIKNO,ADSOYAD)
			SELECT	 @ID_KARMALISTE
					,TCKIMLIKNO		= JSON_VALUE (J.VALUE,'$.TCKIMLIKNO') 
					,ADSOYAD		= JSON_VALUE (J.VALUE,'$.ADSOYAD') 			
			FROM OPENJSON (@JSEXCEL) AS J
			--FOR JSON PATH
		END

		IF @ISLEM = 3	--	RAPOR
		BEGIN
	
				SELECT TCKIMLIKNO,ID_SINIF,RND,SINAVSINIF,ID_SUBE,ID_SINAV,ID_SINAVTURU INTO #OGRENCILIST2 FROM KarmaListeTemp WHERE ID_KARMALISTE = @ID_KARMALISTE

				SET @SQLJSON = (SELECT TOP 1 SQLJSON FROM KarmaListeSQL WHERE ID_KARMALISTE = @ID_KARMALISTE)

				
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= SL.VALUE 
					,ID_SUBE		= SGS.ID_SUBE
					--,SNFOGRSAY		= D.SINAVKAPASITE
					,SUBOGRSAY		= 0
					,SNFSAY			= 0
					,RND			= 0
					,MINSINIF		= 0
					--,ID_DERSSEVIYE	= NULL
					,DERSSEVIYE		= NULL
				INTO #SINAVSINIF2 
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.DBO.v3SubeGrupSinif 		AS	SGS	ON	SGS.ID_SINIF	= SL.VALUE
				INNER JOIN OkyanusDB.dbo.v3Sinif				AS	S	ON	S.ID_SINIF		= SGS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= S.ID_DERSLIK
			UNION
				SELECT 
					 ID_SINAV		= JSON_VALUE (J.VALUE,'$.ID_SINAV') 
					,ID_SINAVTURU	= JSON_VALUE (J.VALUE,'$.ID_SINAVTURU') 
					,ID_SINIF		= SL.VALUE 
					,ID_SUBE		= S.ID_SUBE
					--,SNFOGRSAY		= D.SINAVKAPASITE
					,SUBOGRSAY		= 0
					,SNFSAY			= 0
					,RND			= 0
					,MINSINIF		= 0
					--,ID_DERSSEVIYE	= SD.ID_DERSSEVIYE
					,DERSSEVIYE		= SD.DERSSEVIYE
				FROM OPENJSON (@SQLJSON) AS J
				CROSS APPLY OPENJSON(J.VALUE, '$.SINIF_LIST')   AS	SL 
				INNER JOIN OkyanusDB.dbo.v4Sinif				AS	S	ON	S.ID_SINIF		= SL.VALUE
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay		AS	SD	ON	SD.ID_SINIF		= S.ID_SINIF
				LEFT  JOIN OkyanusDB.dbo.v3Sinif				AS	KS	ON	KS.ID_SINIF		= S.ID_SINIF_KAMPUS
				LEFT  JOIN OkyanusDB.dbo.v3Derslik				AS	D	ON	D.ID_DERSLIK	= KS.ID_DERSLIK
				WHERE S.AKTIF = 1



		
					IF @BURSLULUK = 0
					BEGIN
					
						SELECT	OL.TCKIMLIKNO
							,SINIFAD			= OSN.AD
							,SUBEAD				= SB.AD
							,ID_SUBE			= SB.ID_SUBE	
							,ID_SINIF			= OSN.ID_SINIF	
							,SINAVSINIFAD		= SSN.AD
							,SINIFSUBEAD		= SB.AD+'-'+OSN.AD
							,SINAVSINIFSUBEAD	= SB.AD+'-'+SSN.AD
							,ID_SINIFSINAV		= SSN.ID_SINIF
							,ADSOYAD			= K.AD+' '+K.SOYAD
							,RND
							,O.OGRNO
							,DERSSEVIYE			= NULL
							,SINAVAD			= CASE	WHEN OL.ID_SINAVTURU = 0 
													THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
													ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
													END
						FROM #OGRENCILIST2	OL
						JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= OL.TCKIMLIKNO
						JOIN v3Sinif		OSN	ON	OSN.ID_SINIF	= O.ID_SINIF
						JOIN v3Sinif		SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube			SB	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO						
					UNION
						SELECT	
							 TCKIMLIKNO			= OL.TCKIMLIKNO
							,SINIFAD			= OS.AD
							,SUBEAD				= SB.AD
							,ID_SUBE			= SB.ID_SUBE	
							,ID_SINIF			= OS.ID_SINIF	
							,SINAVSINIFAD		= ISNULL(SS.AD,SSN.AD)
							,SINIFSUBEAD		= SB.AD + '-' + OS.AD
							,SINAVSINIFSUBEAD	= SB.AD + '-' + ISNULL(SS.AD,SSN.AD)
							,ID_SINIFSINAV		= ISNULL(SS.ID_SINIF,SSN.ID_SINIF)
							,ADSOYAD			= K.AD + ' ' + K.SOYAD
							,RND
							,O.OGRNO
							--,ID_DERSSEVIYE		= OSN.ID_DERSSEVIYE
							,DERSSEVIYE			= OSN.DERSSEVIYE
							,SINAVAD			= CASE	WHEN OL.ID_SINAVTURU = 0 
													THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
													ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
													END
						FROM #OGRENCILIST2						OL
						JOIN v3Ogrenci							O	ON	O.TCKIMLIKNO	= OL.TCKIMLIKNO
						JOIN v3Sinif							OS	ON	OS.ID_SINIF		= O.ID_SINIF
						JOIN OkyanusDB.dbo.vw_v4SinifDetay		OSN	ON	OSN.ID_SINIF	= OL.ID_SINIF
						JOIN OkyanusDB.dbo.v4Sinif				SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube								SB	ON	SB.ID_SUBE		= O.ID_SUBE
						JOIN v3Kullanici						K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						--JOIN v3Sinif							SS	ON	SS.ID_SINIF		= SSN.ID_SINIF_KAMPUS
						LEFT JOIN v3Sinif						SS	ON	SS.ID_SINIF		= SSN.ID_SINIF_KAMPUS

					END
					ELSE
					BEGIN

						SELECT	OL.TCKIMLIKNO
							,SINIFAD	  = ''
							,SUBEAD		  = SB.AD
							,ID_SUBE	  = SB.ID_SUBE	
							,ID_SINIF	  = OSN.ID_SINIF	
							,SINAVSINIFAD = SSN.AD
							,ID_SINIFSINAV= SSN.ID_SINIF
							,SINIFSUBEAD  = SB.AD+'-'+OSN.AD
							,SINAVSINIFSUBEAD  = SB.AD+'-'+SSN.AD

							,ADSOYAD	  = K.AD+' '+K.SOYAD
							,RND
							,OGRNO		= ''--row_number() over(order by OL.TCKIMLIKNO)
							,SINAVAD	= CASE	WHEN OL.ID_SINAVTURU = 0 
												THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
												ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
												END
						FROM #OGRENCILIST2	OL	
						JOIN v3Sinif		OSN	ON	OSN.ID_SINIF	= OL.ID_SINIF
						JOIN v3Sinif		SSN	ON	SSN.ID_SINIF	= OL.SINAVSINIF
						JOIN v3Sube			SB	ON	SB.ID_SUBE		= OL.ID_SUBE
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= OL.TCKIMLIKNO
						ORDER BY OL.ID_SUBE,OL.SINAVSINIF,RND
					END

					-- SINIF
					SELECT	 SS.ID_SINIF
							,SINIFAD		= SD.SUBEAD +'-'+ SD.SINIF
							,KAGITSAYISI	= (SELECT COUNT(1) FROM #OGRENCILIST2 O WHERE O.SINAVSINIF = SS.ID_SINIF AND O.ID_SINAV = OL.ID_SINAV)
							,SINAVAD		= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,TARIH			= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,GUN			= datename(dw,
													CASE	WHEN OL.ID_SINAVTURU = 0 
																				THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																				ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																				END)
							,SEANS			= ISNULL(@SEANS,'')
							--,ID_DERSSEVIYE	= NULL
							,DERSSEVIYE		= NULL
					FROM #SINAVSINIF2					SS
					JOIN #OGRENCILIST2					OL	ON	OL.SINAVSINIF	= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sinif			S	ON	S.ID_SINIF		= SS.ID_SINIF
					JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= SS.ID_SINIF
					GROUP BY SS.ID_SINIF,OL.ID_SINAVTURU,OL.ID_SINAV,OL.ID_SUBE,SD.SUBEAD,SD.SINIF
				UNION 					
					SELECT	 SS.ID_SINIF
							,SINIFAD		= IIF(SD.SINIF IS NOT NULL ,SD.SUBEAD +'-'+ SD.SINIF,SB.AD+'-'+S.AD)
							,KAGITSAYISI	= (SELECT COUNT(1) FROM #OGRENCILIST2 O WHERE O.SINAVSINIF = SS.ID_SINIF AND O.ID_SINAV = OL.ID_SINAV)
							,SINAVAD		= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,TARIH			= CASE	WHEN OL.ID_SINAVTURU = 0 
															THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
															ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
															END
							,GUN			= datename(dw,
													CASE	WHEN OL.ID_SINAVTURU = 0 
																				THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																				ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																				END)
							,SEANS			= ISNULL(@SEANS,'')
							--,SS.ID_DERSSEVIYE
							,OSD.DERSSEVIYE
					FROM #SINAVSINIF2						SS
					JOIN #OGRENCILIST2						OL	ON	OL.SINAVSINIF	= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v4Sinif				S	ON	S.ID_SINIF		= SS.ID_SINIF
					JOIN OkyanusDB.dbo.v3Sube				SB	ON	SB.ID_SUBE		= S.ID_SUBE
					JOIN OkyanusDB.dbo.vw_v4SinifDetay		OSD	ON	OSD.ID_SINIF	= OL.ID_SINIF
					LEFT JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= S.ID_SINIF_KAMPUS
					GROUP BY SS.ID_SINIF,OL.ID_SINAVTURU,OL.ID_SINAV,OL.ID_SUBE,SD.SUBEAD,SD.SINIF, OSD.DERSSEVIYE, S.AD, SB.AD--,SD.ID_DERSSEVIYE
					ORDER BY SS.ID_SINIF



					-- OKUL		
					SELECT	 ID_SINAV
							,OL.ID_SUBE
							,KAGITSAYISI= COUNT(1) 
							,SUBEAD		= SD.SUBEAD --(SELECT TOP 1 AD FROM v3Sube SB WHERE SB.ID_SUBE = OL.ID_SUBE )
							,SINAVAD	= CASE	WHEN OL.ID_SINAVTURU = 0 
														THEN (SELECT Y.AD FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
														ELSE (SELECT S.AD FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
														END
							,TARIH		= CASE	WHEN OL.ID_SINAVTURU = 0 
														THEN (SELECT CONVERT(varchar,Y.YAZILITARIH,104) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
														ELSE (SELECT CONVERT(varchar,S.SINAVTARIH ,104) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
														END
							,GUN		= datename(dw,
												CASE	WHEN OL.ID_SINAVTURU = 0 
																			THEN (SELECT CONVERT(date,Y.YAZILITARIH) FROM Yazili Y WHERE Y.ID_YAZILI = OL.ID_SINAV )
																			ELSE (SELECT CONVERT(date,S.SINAVTARIH ) FROM Sinav S  WHERE S.ID_SINAV  = OL.ID_SINAV )
																			END)
							,SEANS		= ISNULL(@SEANS,'')
							--,SD.ID_DERSSEVIYE
							,SD.DERSSEVIYE
					FROM #OGRENCILIST2					OL
					JOIN OkyanusDB.dbo.vw_v4SinifDetay	SD	ON	SD.ID_SINIF		= OL.ID_SINIF
					GROUP BY ID_SINAV,OL.ID_SUBE,ID_SINAVTURU,SD.SUBEAD, SD.DERSSEVIYE--,SD.ID_DERSSEVIYE


		END
		
		IF @ISLEM = 4	--	KARMA LISTE BURSLULUK LISTE
		BEGIN
		
			DROP TABLE IF EXISTS #TEMP

			SELECT  
				 ID_SUBE		= T.ID_SUBE
				,ID_SINAV		= T.ID_SINAV
				,ID_KADEME3		= T.ID_KADEME3
				,KADEME3		= K3.AD
				,BSV_SAY		= COUNT(1)	
				,SINAVAD		= S.AD
				,ID_SINAVTURU	= S.ID_SINAVTURU
			INTO #TEMP
			FROM BurslulukSinavOgrenci	T
			JOIN v3Kademe3				K3	ON	K3.ID_KADEME3	= T.ID_KADEME3
			JOIN Sinav					S	ON	S.ID_SINAV		= T.ID_SINAV
			WHERE	T.ID_BURSLULUKDOSYA	= @ID_BURSLULUKDOSYA
				AND T.SINAVTARIH		= @SINAVTARIH
				AND T.SEANS				= @SEANS
			GROUP BY T.ID_SUBE, T.ID_SINAV, T.ID_KADEME3, K3.AD, S.AD, S.ID_SINAVTURU

			SELECT(
				SELECT   
					 ID_SUBE	= SB.ID_SUBE
					,SUBEAD		= SB.AD
					,ID_KADEME3	= SN.ID_KADEME3
					,ID_SINAV	= SN.ID_SINAV
					,SINAVAD	= SN.SINAVAD
					,KADEME3	= SN.KADEME3
					,BSV_SAY	= SN.BSV_SAY
					,ID_SINAVTURU
				FROM #TEMP		SN
				JOIN v3Sube		SB	ON	SB.ID_SUBE		= SN.ID_SUBE	
				WHERE SN.ID_SINAV > 0
				ORDER BY ID_SUBE,ID_KADEME3
				FOR JSON AUTO
			) AS S

			DROP TABLE IF EXISTS #TEMP

		END
		
		DROP TABLE IF EXISTS #ATANACAK
		DROP TABLE IF EXISTS #ATANAMAYANLAR
		DROP TABLE IF EXISTS #OGRENCILIST
		DROP TABLE IF EXISTS #OGRENCILIST2
		DROP TABLE IF EXISTS #OL
		DROP TABLE IF EXISTS #SINAVSINIF
		DROP TABLE IF EXISTS #SINAVSINIF2
		DROP TABLE IF EXISTS #SL
		DROP TABLE IF EXISTS #SNF
		DROP TABLE IF EXISTS #TT
		DROP TABLE IF EXISTS #WSB
		DROP TABLE IF EXISTS #WSN
		DROP TABLE IF EXISTS #KARMA
		DROP TABLE IF EXISTS #KarmaTemp
		DROP TABLE IF EXISTS #OGR

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_KonuAnaliziCoklu]...';


GO
ALTER procedure [dbo].[sp_KonuAnaliziCoklu]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@LIMIT				INT				= 100,
	@ID_SINAVS			VARCHAR(MAX)	= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,LIMIT						= @LIMIT			
			,ID_SINAVS					= @ID_SINAVS		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0


BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1	--	KONU ANALİZİ
		BEGIN
		
			--exec sp_KonuAnalizi @ISLEM=1, @TCKIMLIKNO='34454003058',@OTURUM='AF6EC483-F078-4F55-AAAD-A4FFD02604D4',@TC_OGRENCI='34454003058',@DONEM= '', @ID_MENU= 1031,@ID_SINAVS='[]'

			--SET @TCKIMLIKNO='53500095298'

			--declare 
			--@DONEM varchar(max)='2017',
			--@ID_SINAVTURU  varchar(max)='[2]',
			--@ID_SINAVS varchar(max)='[185]',
			--@TC_OGRENCI varchar(max)='',
			--@ID_SINIF int=102207,
			--@ID_SUBE int=427,
			--@LIMIT int = 100

			
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) )
			BEGIN
				SET @OZELSINAVGOR=1
			END

			SELECT @ID_SINIF=ID_SINIF,@ID_SUBE=ID_SUBE FROM v3Ogrenci WHERE TCKIMLIKNO =@TC_OGRENCI		
			SELECT @IL=IL,@ILCE=ILCE FROM V3SUBE WHERE ID_SUBE=@ID_SUBE

			IF OBJECT_ID('tempdb..#PUAN')		IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#KONU')		IS NOT NULL		DROP TABLE #KONU
			IF OBJECT_ID('tempdb..#KONUANALIZ')	IS NOT NULL		DROP TABLE #KONUANALIZ
			IF OBJECT_ID('tempdb..#TT')			IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#TT1')		IS NOT NULL		DROP TABLE #TT1
			IF OBJECT_ID('tempdb..#KK')			IS NOT NULL		DROP TABLE #KK
			IF OBJECT_ID('tempdb..#T1')			IS NOT NULL		DROP TABLE #T1
			IF OBJECT_ID('tempdb..#T2')			IS NOT NULL		DROP TABLE #T2
			IF OBJECT_ID('tempdb..#T3')			IS NOT NULL		DROP TABLE #T3
			IF OBJECT_ID('tempdb..#T4')			IS NOT NULL		DROP TABLE #T4
			IF OBJECT_ID('tempdb..#T5')			IS NOT NULL		DROP TABLE #T5

			SELECT	
					O.TCKIMLIKNO,
					count(1) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=K.ID_SINAVKITAPCIK) TOPLAMSORU,
					o.ID_SINAV
			into #KONU
			from SinavOgrenci				o
			JOIN OkyanusDb.dbo.v3Ogrenci	v3o	ON	v3o.TCKIMLIKNO				= o.TCKIMLIKNO	
			JOIN SinavOgrenciCevapBolum		b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
			JOIN SinavOgrenciCevap			c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
			JOIN SinavDers					d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS and d.ID_SINAV=o.ID_SINAV
			JOIN SinavKitapcik				k	ON	k.ID_SINAV					= o.ID_SINAV
												AND	K.AD						= o.KITAPCIK
			JOIN SinavAnahtar				a	ON	a.SORUNO					= c.SORUNO	
												AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
												AND a.ID_SINAVDERS				= B.ID_SINAVDERS 		
			JOIN v3SinavDersUnite			u	ON	u.KOD						= a.KOD
			JOIN Sinav						s	ON	s.ID_SINAV					= o.ID_SINAV
			WHERE	
					( @DONEM='' OR @DONEM=0 OR @DONEM=s.DONEM )
				AND ( @ID_SINAVTURU IS NULL OR @ID_SINAVTURU='[]' OR s.ID_SINAVTURU in (SELECT Value FROM OPENJSON(@ID_SINAVTURU)) )
				AND ( @ID_SINAVS IS NULL OR @ID_SINAVS='[]' OR s.ID_SINAV in (SELECT Value FROM OPENJSON(@ID_SINAVS)))
				AND ( @TC_OGRENCI IS NULL OR @TC_OGRENCI='' OR @TC_OGRENCI='0' OR o.TCKIMLIKNO=@TC_OGRENCI)
				AND ( @ID_SINIF IS NULL OR @ID_SINIF=0 OR v3o.ID_SINIF=@ID_SINIF)
				AND ( @ID_SUBE IS NULL OR @ID_SUBE=0 OR v3o.ID_SUBE=@ID_SUBE)
				AND s.AKTIF=1 AND s.DURUM=2	and (OZEL=0 OR @OZELSINAVGOR=1)	
			GROUP BY O.TCKIMLIKNO, c.DURUM,d.TAKMAAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,K.ID_SINAVKITAPCIK
			ORDER BY d.TAKMAAD

			SELECT DISTINCT
					TCKIMLIKNO,
					KONUAD,
					KOD,						
					DERSAD,YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
					ISNULL( 
					CAST(((100 /
						CAST((
							CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) AS DECIMAL(11,2) 
						))
						* CAST([D] AS INT)  
					) AS DECIMAL(11,2)) 
					,0) AS YUZDE
			INTO #TT1
			FROM ( SELECT * FROM #KONU )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
				
			SELECT 
				TCKIMLIKNO,KONUAD,KOD,DERSAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS,ID_SINAV,YUZDE 
			INTO #TT
			FROM #TT1
					UNION ALL 
			SELECT 
				TCKIMLIKNO,DERSAD,'',DERSAD,MAX(BOLUMYUZDE),MAX(TOPLAMSORU),SUM(DOGRU),SUM(YANLIS),SUM(BOS),ID_SINAV,AVG(YUZDE) 
				FROM #TT1
			GROUP BY TCKIMLIKNO,DERSAD,ID_SINAV
			order by ID_SINAV,DERSAD,TOPLAMSORU,KOD



			SELECT	TCKIMLIKNO,KONUAD,
				DERSAD,
				KOD,
				CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
				SUM(DOGRU+YANLIS+BOS) SORU,
				SUM(DOGRU) DOGRU,
				SUM(YANLIS) YANLIS,
				SUM(BOS) BOS,
				CAST((cast(SUM(DOGRU) as decimal(11,2))/cast(SUM(DOGRU+YANLIS+BOS) as decimal(11,2))) * 100 as DECIMAL(11,2)) YUZDE
				--CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE
			INTO	#KONUANALIZ
			FROM	#TT
			GROUP BY TCKIMLIKNO,KOD,KONUAD,DERSAD


			SELECT	*
					,SUM(SORU) TOPLAMSORU 
					,SUM(DOGRU) TOPLAMDOGRU
					,SUM(YANLIS) TOPLAMYANLIS
					,SUM(BOS) TOPLAMBOS
					,CAST((cast(SUM(DOGRU) as decimal(11,2))/cast(SUM(DOGRU+YANLIS+BOS) as decimal(11,2))) * 100 as DECIMAL(11,2)) TOPLAMYUZDE
					--,CAST(AVG(YUZDE)AS decimal(5,2)) TOPLAMYUZDE
					,CAST(CAST(SUM(DOGRU) AS FLOAT) *100.0 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) DOGRUYUZDE
					,CAST(CAST(SUM(YANLIS) AS FLOAT) *100.0 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) YANLISYUZDE
					,CAST(CAST(SUM(BOS) AS FLOAT) *100.0 / CAST(SUM(SORU) AS FLOAT) AS decimal(5,2)) BOSYUZDE
			INTO	#T1
			FROM	#KONUANALIZ
			GROUP BY TCKIMLIKNO,KONUAD,DERSAD,KOD,BOLUMYUZDE,SORU,DOGRU,YANLIS,BOS,YUZDE
			
			
			 
			SELECT * FROM #T1
			where (YUZDE<(@LIMIT+1) and KOD<>'') or KOD=''
			ORDER BY TCKIMLIKNO,DERSAD,KOD

			SELECT DISTINCT K.AD +' '+ SOYAD AS ADSOYAD, S.AD AS SINIF, SB.AD AS OKUL, K.TCKIMLIKNO 
			FROM OkyanusDB.dbo.v3Kullanici K 
			INNER JOIN #T1 T ON T.TCKIMLIKNO=K.TCKIMLIKNO AND ((YUZDE<(@LIMIT+1) and KOD<>'') or KOD='')
			INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=T.TCKIMLIKNO 
			INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF=O.ID_SINIF 
			INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE=O.ID_SUBE 
			
			IF OBJECT_ID('tempdb..#PUAN')		IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#KONU')		IS NOT NULL		DROP TABLE #KONU
			IF OBJECT_ID('tempdb..#KONUANALIZ')	IS NOT NULL		DROP TABLE #KONUANALIZ
			IF OBJECT_ID('tempdb..#TT')			IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#KK')			IS NOT NULL		DROP TABLE #KK
			IF OBJECT_ID('tempdb..#T1')			IS NOT NULL		DROP TABLE #T1
			IF OBJECT_ID('tempdb..#T2')			IS NOT NULL		DROP TABLE #T2
			IF OBJECT_ID('tempdb..#T3')			IS NOT NULL		DROP TABLE #T3
			IF OBJECT_ID('tempdb..#T4')			IS NOT NULL		DROP TABLE #T4
			IF OBJECT_ID('tempdb..#T5')			IS NOT NULL		DROP TABLE #T5
		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_LUSRapor]...';


GO
ALTER procedure [dbo].[sp_LUSRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@SUBELER			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_KADEME3					= @ID_KADEME3	
			,SINIFLAR					= @SINIFLAR	
			,SUBELER					= @SUBELER	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		IF (@ISLEM = 1)	--	LUS RAPORU
		BEGIN
			DECLARE  @OZELSINAVGOR BIT=0
			IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) 
			BEGIN
				SET @OZELSINAVGOR=1
			END

			DECLARE @OV BIT = 0

			IF NOT EXISTS(SELECT 1 FROM OkyanusDB.dbo.v3SubeYetki WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI <> 5 AND ID_KULLANICITIPI <> 4)
			BEGIN
				SET @OV = 1
			END

			SELECT O.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, O.OGRNO, SGS.SUBEAD, SGS.SINIF
			INTO #OGRENCI
			FROM OkyanusDB.dbo.v3OgrenciTum O
			INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
			INNER JOIN OkyanusDB.dbo.vw_SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
			WHERE O.DONEM = @DONEM
			AND (@SUBELER IS NULL OR @SUBELER='[]' OR @SUBELER='' OR O.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)))
			AND (@SINIFLAR IS NULL OR @SINIFLAR='[]' OR @SUBELER='' OR O.ID_SINIF IN (SELECT value FROM OPENJSON(@SINIFLAR)))
			AND (@TC_OGRENCI IS NULL OR @TC_OGRENCI = '' OR O.TCKIMLIKNO = @TC_OGRENCI)

			--OPTIK--
			BEGIN
				SELECT O.TCKIMLIKNO, S.AD, S.SINAVTARIH AS TARIH, SOCB.PUAN
				INTO #OPTTUM
				FROM #OGRENCI O
				INNER JOIN SinavOgrenci SO ON SO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Sinav S ON S.ID_SINAV = SO.ID_SINAV
				INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
				WHERE S.AKTIF = 1			
				AND S.DONEM = @DONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.OLCEKSINAVI = 1
				AND S.ID_SINAVTURU = 13 -- LUS

				SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, MAX(OPT.PUAN) AS PUAN
				INTO #OPTSON
				FROM #OGRENCI O
				INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, OPT.PUAN
		
				DELETE TUM
				FROM #OPTTUM TUM
				INNER JOIN #OPTSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH


				SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, MAX(OPT.PUAN) AS PUAN
				INTO #OPTSON1
				FROM #OGRENCI O
				INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, OPT.PUAN

				DELETE TUM
				FROM #OPTTUM TUM
				INNER JOIN #OPTSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT O.TCKIMLIKNO, MAX(OPT.TARIH) AS TARIH, OPT.PUAN
				--INTO #OPTSON2
				--FROM #OGRENCI O
				--INNER JOIN #OPTTUM OPT ON OPT.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY O.TCKIMLIKNO, OPT.PUAN

				--DELETE TUM
				--FROM #OPTTUM TUM
				--INNER JOIN #OPTSON2 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT * FROM #OPTSON
				--SELECT * FROM #OPTSON1
				--SELECT * FROM #OPTSON2
			END

			--ÖĞRETMEN GÖZLEM FORMU--
			BEGIN
				SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
				INTO #YAZTUM
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF = 1
				AND Y.AKTIF = 1				
				AND Y.DONEM = @DONEM
				AND Y.ID_YAZILITURU = 3 -- LUS
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, MAX(YAZ.PUAN) AS PUAN
				INTO #YAZSON
				FROM #OGRENCI O
				INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ.PUAN

				DELETE TUM
				FROM #YAZTUM TUM
				INNER JOIN #YAZSON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, MAX(YAZ.PUAN) AS PUAN
				INTO #YAZSON1
				FROM #OGRENCI O
				INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ.PUAN

				DELETE TUM
				FROM #YAZTUM TUM
				INNER JOIN #YAZSON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT O.TCKIMLIKNO, MAX(YAZ.TARIH) AS TARIH, YAZ.PUAN
				--INTO #YAZSON2
				--FROM #OGRENCI O
				--INNER JOIN #YAZTUM YAZ ON YAZ.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY O.TCKIMLIKNO, YAZ.PUAN

				--DELETE TUM
				--FROM #YAZTUM TUM
				--INNER JOIN #YAZSON2 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT * FROM #YAZSON
				--SELECT * FROM #YAZSON1
				--SELECT * FROM #YAZSON2
			END

			--ÖĞRENCİ DENEY RAPOR--
			BEGIN
				SELECT O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH AS TARIH, SUM(YOC.PUAN) AS PUAN
				INTO #YAZ2TUM
				FROM #OGRENCI O
				INNER JOIN YaziliOgrenci YO ON YO.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN Yazili Y ON Y.ID_YAZILI = YO.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				WHERE YO.AKTIF = 1
				AND Y.AKTIF = 1				
				AND Y.DONEM = @DONEM
				AND Y.ID_YAZILITURU = 4 -- LUS
				AND (Y.OVGORSUN = 1 OR @OV = 0)
				GROUP BY O.TCKIMLIKNO, Y.AD, Y.YAZILITARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, MAX(YAZ2.PUAN) AS PUAN
				INTO #YAZ2SON
				FROM #OGRENCI O
				INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ2.PUAN

				DELETE TUM
				FROM #YAZ2TUM TUM
				INNER JOIN #YAZ2SON SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, MAX(YAZ2.PUAN) AS PUAN
				INTO #YAZ2SON1
				FROM #OGRENCI O
				INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
				GROUP BY O.TCKIMLIKNO--, YAZ2.PUAN

				DELETE TUM
				FROM #YAZ2TUM TUM
				INNER JOIN #YAZ2SON1 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT O.TCKIMLIKNO, MAX(YAZ2.TARIH) AS TARIH, YAZ2.PUAN
				--INTO #YAZ2SON2
				--FROM #OGRENCI O
				--INNER JOIN #YAZ2TUM YAZ2 ON YAZ2.TCKIMLIKNO = O.TCKIMLIKNO
				--GROUP BY O.TCKIMLIKNO, YAZ2.PUAN

				--DELETE TUM
				--FROM #YAZ2TUM TUM
				--INNER JOIN #YAZ2SON2 SON ON SON.TCKIMLIKNO = TUM.TCKIMLIKNO AND SON.TARIH = TUM.TARIH

				--SELECT * FROM #YAZ2SON
				--SELECT * FROM #YAZ2SON1
				--SELECT * FROM #YAZ2SON2
			END

			SELECT O.*
					,ISNULL(CAST(CONVERT(INT, OPTSON.PUAN) AS VARCHAR), '-') AS OPT
					,ISNULL(CAST(CONVERT(INT, OPTSON1.PUAN) AS VARCHAR), '-') AS OPT1
					--,ISNULL(CAST(CONVERT(INT, OPTSON2.PUAN) AS VARCHAR), '-') AS OPT2
					,ISNULL(CAST(YAZSON.PUAN AS VARCHAR), '-') AS YAZOGRETMEN
					,ISNULL(CAST(YAZSON1.PUAN AS VARCHAR), '-') AS YAZOGRETMEN1
					--,ISNULL(CAST(YAZSON2.PUAN AS VARCHAR), '-') AS YAZOGRETMEN2
					,ISNULL(CAST(YAZ2SON.PUAN AS VARCHAR), '-') AS YAZOGRENCI
					,ISNULL(CAST(YAZ2SON1.PUAN AS VARCHAR), '-') AS YAZOGRENCI1
					--,ISNULL(CAST(YAZ2SON2.PUAN AS VARCHAR), '-') AS YAZOGRENCI2
					,ISNULL(CAST(CONVERT(DECIMAL(5,2), (CONVERT(INT, OPTSON.PUAN) + YAZSON.PUAN + YAZ2SON.PUAN) / 2.0) AS VARCHAR), '-') AS TOPLAM 
			INTO #RESULT
			FROM #OGRENCI O
			LEFT JOIN #OPTSON OPTSON ON OPTSON.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #OPTSON1 OPTSON1 ON OPTSON1.TCKIMLIKNO = O.TCKIMLIKNO
			--LEFT JOIN #OPTSON2 OPTSON2 ON OPTSON2.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZSON  YAZSON  ON YAZSON.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZSON1 YAZSON1 ON YAZSON1.TCKIMLIKNO = O.TCKIMLIKNO
			--LEFT JOIN #YAZSON2 YAZSON2 ON YAZSON2.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZ2SON  YAZ2SON  ON YAZ2SON.TCKIMLIKNO = O.TCKIMLIKNO
			LEFT JOIN #YAZ2SON1 YAZ2SON1 ON YAZ2SON1.TCKIMLIKNO = O.TCKIMLIKNO
			--LEFT JOIN #YAZ2SON2 YAZ2SON2 ON YAZ2SON2.TCKIMLIKNO = O.TCKIMLIKNO

			SELECT	DISTINCT
					TCKIMLIKNO,
					ADSOYAD,
					OGRNO,
					SUBEAD,
					SINIF,
					OPT, 
					CASE WHEN OPT1 = '-' THEN OPT ELSE OPT1 END AS OPT1,
					CASE WHEN OPT1 = '-' THEN '-' ELSE OPT END AS OPT2,
					YAZOGRETMEN, 
					CASE WHEN YAZOGRETMEN1 = '-' THEN YAZOGRETMEN ELSE YAZOGRETMEN1 END AS YAZOGRETMEN1,
					CASE WHEN YAZOGRETMEN1 = '-' THEN '-' ELSE YAZOGRETMEN END AS YAZOGRETMEN2,
					YAZOGRENCI, 
					CASE WHEN YAZOGRENCI1 = '-' THEN YAZOGRENCI ELSE YAZOGRENCI1 END AS YAZOGRENCI1,
					CASE WHEN YAZOGRENCI1 = '-' THEN '-' ELSE YAZOGRENCI END AS YAZOGRENCI2,
					TOPLAM
			FROM #RESULT
			
			DROP TABLE #YAZSON
			DROP TABLE #YAZSON1
			--DROP TABLE #YAZSON2
			DROP TABLE #YAZ2SON
			DROP TABLE #YAZ2SON1
			--DROP TABLE #YAZ2SON2
			DROP TABLE #OPTSON
			DROP TABLE #OPTSON1
			--DROP TABLE #OPTSON2
			DROP TABLE #YAZTUM
			DROP TABLE #YAZ2TUM
			DROP TABLE #OPTTUM
			DROP TABLE #OGRENCI
			DROP TABLE #RESULT
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OdulListesi]...';


GO
ALTER procedure [dbo].[sp_OdulListesi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@MIN_NET			DECIMAL(8,2)	= NULL,
	@MIN_DERECE			INT				= NULL,
	@MAX_DERECE			INT				= NULL,
	@ID_SINAVPUANTURU	INT				= NULL,

	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SUBEs					= @ID_SUBEs		
			,MIN_NET					= @MIN_NET		
			,MIN_DERECE					= @MIN_DERECE		
			,MAX_DERECE					= @MAX_DERECE		
			,ID_SINAVPUANTURU			= @ID_SINAVPUANTURU
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
			SELECT	 ST.TCKIMLIKNO
					,ST.ID_SINAV
					,O.ID_SUBE
					,O.ID_SINIF
					,ST.TN
					,PUAN= ISNULL(SP.PUAN,0)
					,DENSE_RANK() OVER(PARTITION BY ST.ID_SINAV, O.ID_SUBE ORDER BY ISNULL(SP.PUAN,TN) DESC) SIRA
			INTO #OGRENCILIST
			FROM SinavOgrenciToplam		ST
			LEFT JOIN SinavOgrenciPuan	SP	ON	SP.TCKIMLIKNO	= ST.TCKIMLIKNO
											AND SP.ID_SINAV		= ST.ID_SINAV							
			JOIN Sinav					S	ON	S.ID_SINAV		= ST.ID_SINAV
			JOIN v3OgrenciTum			O	ON	O.TCKIMLIKNO	= ST.TCKIMLIKNO
											AND O.DONEM			= S.DONEM
			WHERE	ST.ID_SINAV IN (SELECT VALUE FROM OPENJSON(@ID_SINAVs))
				AND O.ID_SUBE	IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				AND ST.TN > @MIN_NET
				AND (	SP.ID_SINAVPUANTURU = @ID_SINAVPUANTURU
					OR	0					= @ID_SINAVPUANTURU
					OR  S.PUANGIZLE			= 1
					)

			SELECT	 TCKIMLIKNO	= OL.TCKIMLIKNO
					,ID_SUBE	= OL.ID_SUBE
					,TN			= OL.TN
					,PUAN		= OL.PUAN
					,SIRA		= OL.SIRA
					,ID_SINAV	= S.ID_SINAV
					,SINAVAD	= S.AD
					,KADEME3	= GST.KADEME3
					,SINAVTARIH	= CONVERT(VARCHAR,S.SINAVTARIH ,104)
					,SUBEAD		= GST.SUBEAD
					,SINIFAD	= GST.SINIF
					,ADSOYAD	= K.AD + ' ' + K.SOYAD
					,MINNET		= @MIN_NET
			INTO #LISTE
			FROM #OGRENCILIST				OL
			JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= OL.TCKIMLIKNO
			JOIN Sinav						S	ON	S.ID_SINAV		= OL.ID_SINAV
			JOIN vw_SubeSinifGrupKademeTum	GST	ON GST.ID_SINIF		= OL.ID_SINIF
			WHERE OL.SIRA BETWEEN @MIN_DERECE AND @MAX_DERECE

		IF @ISLEM = 1	--	JSON
		BEGIN
			SELECT ISNULL(
				(
					SELECT * FROM #LISTE
					ORDER BY ID_SINAV, ID_SUBE, SIRA, PUAN
					FOR JSON AUTO
				),'[]'
			) AS S
		END
		IF @ISLEM = 2	--	DATASET
		BEGIN			
			SELECT * FROM #LISTE
			ORDER BY ID_SINAV, ID_SUBE, SIRA, PUAN
		END
		
		DROP TABLE IF EXISTS #OGRENCILIST	
		DROP TABLE IF EXISTS #LISTE	

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OgrenciHedef]...';


GO
ALTER procedure [dbo].[sp_OgrenciHedef]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@PROGRAMKODU		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@PUANTURU			VARCHAR(5)		= NULL,
	@ID_SINAVPUANTURU	INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@OOBP				INT				= NULL,
	@OGRTCKIMLIKNO		VARCHAR(11)		= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,PROGRAMKODU				= @PROGRAMKODU		
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,PUANTURU					= @PUANTURU			
			,ID_SINAVPUANTURU			= @ID_SINAVPUANTURU	
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,SQLJSON					= @SQLJSON			
			,OOBP						= @OOBP				
			,OGRTCKIMLIKNO				= @OGRTCKIMLIKNO		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	
	 
	DECLARE @ID_KADEME3		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

	IF @ID_LOG > 1
	BEGIN

	DECLARE @AKTIFDONEM VARCHAR(4)= (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 

		IF @ISLEM = 1	--	Öğrenci Hedef Ekle						
		BEGIN
			IF NOT EXISTS(SELECT 1 FROM OgrenciHedef WHERE PROGRAMKODU=@PROGRAMKODU and  TCKIMLIKNO= @TCKIMLIKNO and DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) and AKTIF = 1)
			BEGIN
				INSERT INTO [dbo].[OgrenciHedef]
						   ([TCKIMLIKNO]
						   ,[PROGRAMKODU]
						   ,[DONEM])
					 VALUES
						   (@TCKIMLIKNO
						   ,@PROGRAMKODU
						   ,(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1))
			END
		END

		IF @ISLEM = 2	--	Öğrenci Hedef Listele					
		BEGIN
			SELECT 
			(
				SELECT	oh.[PROGRAMKODU]
						,tp.[UNIVERSITE]
						,tp.[FAKULTE]
						,tp.[BOLUM]
						,tp.[BOLUM2]
						,tp.[EGITIMDILI]
						,tp.[UCRETBURS]
						,tp.[IL]
						,tp.[UNIVERSITETURU]
						,tp.[OGRENIMSURESI]
						,tp.[OGRENIMTURU]
						,tp.[PUANTURU]
						,tp.[YIL]
						,tp.[TABANPUAN]
						,tp.[KONTENJAN]
						,tp.[PROGRAMTURU]
						,tp.[SONYGSYERLESTIRME]
						,tp.[OKULBIRINCILIGIKONTENJANI]
						,tp.[YERONCELIKLERI]
						,tp.[ENBUYUKPUAN]
						,tp.[BASARISIRALAMA]
						,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
									FROM UniversiteOzelKosul ok
									WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
									FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
				FROM OgrenciHedef oh
				INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU-- AND tp.YIL = oh.DONEM
				WHERE TCKIMLIKNO=@TCKIMLIKNO  AND TP.YIL = @AKTIFDONEM
					--AND TP.DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
					AND AKTIF=1
				ORDER BY KYE_TARIH DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) JSONDATA
		END

		IF @ISLEM = 3	--	Öğrenci Hedef Sil						
		BEGIN
			UPDATE OgrenciHedef SET AKTIF=0 where TCKIMLIKNO=@TCKIMLIKNO and PROGRAMKODU=@PROGRAMKODU
		END

		IF @ISLEM = 4	--	Öğrenci Hedef Listele Puan Tür Bazlı	
		BEGIN
			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO

			SELECT
			(
				SELECT 
				(
					SELECT	oh.[PROGRAMKODU]
							,tp.[UNIVERSITE]
							,tp.[FAKULTE]
							,tp.[BOLUM]
							,tp.[BOLUM2]
							,tp.[EGITIMDILI]
							,tp.[UCRETBURS]
							,tp.[IL]
							,tp.[UNIVERSITETURU]
							,tp.[OGRENIMSURESI]
							,tp.[OGRENIMTURU]
							,tp.[PUANTURU]
							,tp.[YIL]
							,[TABANPUAN] = ISNULL(tp.[TABANPUAN], 0)
							,tp.[KONTENJAN]
							,tp.[PROGRAMTURU]
							,tp.[SONYGSYERLESTIRME]
							,tp.[OKULBIRINCILIGIKONTENJANI]
							,tp.[YERONCELIKLERI]
							,tp.[ENBUYUKPUAN]
							,tp.[BASARISIRALAMA]
							,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
										FROM UniversiteOzelKosul ok
										WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
										FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
					FROM OgrenciHedef oh
					INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU --and tp.YIL = oh.DONEM
					WHERE TCKIMLIKNO=@OGRTCKIMLIKNO 
						--AND DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
						AND AKTIF=1 
						AND TP.YIL = @AKTIFDONEM
						AND (@PUANTURU = '0' OR tp.PUANTURU= (SELECT KOD FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVPUANTURU=@PUANTURU))
					ORDER BY tp.[TABANPUAN] DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS LIST,
				(
					SELECT COUNT(1) AS TERCIHSAYISI FROM OgrenciHedef WHERE TCKIMLIKNO=@OGRTCKIMLIKNO --and DONEM = @AKTIFDONEM
				) AS TERCIHSAYISI
				FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
			)
			
			--SELECT 
			--(
			--	SELECT	oh.[PROGRAMKODU]
			--			,tp.[UNIVERSITE]
			--			,tp.[FAKULTE]
			--			,tp.[BOLUM]
			--			,tp.[BOLUM2]
			--			,tp.[EGITIMDILI]
			--			,tp.[UCRETBURS]
			--			,tp.[IL]
			--			,tp.[UNIVERSITETURU]
			--			,tp.[OGRENIMSURESI]
			--			,tp.[OGRENIMTURU]
			--			,tp.[PUANTURU]
			--			,tp.[YIL]
			--			,tp.[TABANPUAN]
			--			,tp.[KONTENJAN]
			--			,tp.[PROGRAMTURU]
			--			,tp.[SONYGSYERLESTIRME]
			--			,tp.[OKULBIRINCILIGIKONTENJANI]
			--			,tp.[YERONCELIKLERI]
			--			,tp.[ENBUYUKPUAN]
			--			,tp.[BASARISIRALAMA]
			--			,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
			--						FROM UniversiteOzelKosul ok
			--						WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
			--						FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
			--			,(SELECT COUNT(*) FROM OgrenciHedef WHERE TCKIMLIKNO=@OGRTCKIMLIKNO and DONEM = @AKTIFDONEM) AS TERCIHSAYISI
			--	FROM OgrenciHedef oh
			--	INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU 
			--	WHERE TCKIMLIKNO=@OGRTCKIMLIKNO 
			--		--AND DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
			--		AND AKTIF=1 
			--		AND TP.YIL = @AKTIFDONEM
			--		AND (@PUANTURU = '0' OR tp.PUANTURU= (SELECT KOD FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVPUANTURU=@PUANTURU))
			--	ORDER BY tp.[TABANPUAN] DESC
			--	FOR JSON PATH, INCLUDE_NULL_VALUES
			--) JSONDATA
			
		END

		IF @ISLEM = 5	--	Öğrenci Puan Turu Son Puan				
		BEGIN
			SELECT 
			ISNULL
			(
			(				
				SELECT TOP 1 sos.PUAN + ISNULL((SELECT OOBP*0.6 FROM OgrenciOOBP WHERE TCKIMLIKNO=SO.TCKIMLIKNO),85*0.6) AS PUAN, ISNULL(HP.PUAN,sos.PUAN + ISNULL((SELECT OOBP*0.6 FROM OgrenciOOBP WHERE TCKIMLIKNO=SO.TCKIMLIKNO),85*0.6)) AS HEDEFPUAN FROM SinavOgrenciSonuc sos WITH(NOLOCK)
				INNER JOIN SinavOgrenci so WITH(NOLOCK) ON so.ID_SINAVOGRENCI=sos.ID_SINAVOGRENCI
				INNER JOIN SinavPuanTuru spt WITH(NOLOCK) ON spt.ID_SINAVPUANTURU=sos.ID_SINAVPUANTURU
				INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=so.ID_SINAV
				LEFT JOIN OgrenciHedefPuan HP ON HP.TCKIMLIKNO=SO.TCKIMLIKNO AND HP.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU
				WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO and spt.ID_SINAVPUANTURU = @ID_SINAVPUANTURU AND S.OZEL = 0
				ORDER BY s.SINAVTARIH DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			), '[{"PUAN": 0, "HEDEFPUAN": 560}]') AS PUANLAR
		END

		IF @ISLEM = 6	--	Öğrenci Net Listele						
		BEGIN
			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
			IF @ID_SINAVPUANTURU = 6 -- DİL
			BEGIN
				SELECT
				(
					SELECT
					ISNULL((
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
						FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
						INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
						INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
						LEFT JOIN OgrenciHedefNet HN ON HN.ID_SINAVTURU=4 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
						LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=4 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
						WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
						AND S.OZEL = 0
						AND SO.ID_SINAV=(
											SELECT ID_SINAV FROM
											(
												SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
												INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV AND S.AKTIF=1 AND S.OZEL = 0
												WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO AND S.ID_SINAVTURU=4
														AND DONEM = @AKTIFDONEM
											) XTABLE
											WHERE RN=1
										)
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),
					(
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AYT DİL' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
						FROM Sinav S  WITH(NOLOCK)
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
						INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
						INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
						LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
						where S.ID_SINAVTURU=4 AND S.OZEL = 0 AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=4  AND DONEM = @AKTIFDONEM AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND SUBS.OZEL = 0)
						GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, BOLUMNO, HN.NET, S.AD
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					)
					AS YKSSINAVSONUC,
					ISNULL((
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
						FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
						INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
						INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
						LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=2 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
						LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=2 AND SUBS.ID_SINAV<SO.ID_SINAV AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
						WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
						AND S.OZEL = 0
						AND SO.ID_SINAV=(
											SELECT ID_SINAV FROM
											(
												SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
												INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
												WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
													AND S.ID_SINAVTURU=2 
													AND S.AKTIF=1 
													AND S.OZEL = 0
													AND DONEM = @AKTIFDONEM
											) XTABLE
											WHERE RN=1
										)
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					),
					(
						SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'TYT' AS AD, (COUNT(*)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
						FROM Sinav S WITH(NOLOCK) 
						INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
						INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
						INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
						LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
						where S.ID_SINAVTURU=2 
						AND S.ID_SINAV = (SELECT MAX(ID_SINAV) FROM Sinav SUBS WHERE ID_SINAVTURU=2 AND DONEM = @AKTIFDONEM AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) AND SUBS.OZEL = 0) 
						AND S.OZEL = 0
						GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
						ORDER BY SD.BOLUMNO
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
					) AS TYTSINAVSONUC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS SINAVSONUC
			END
			ELSE 
			BEGIN
				IF @ID_KADEME3 IN (17) -- 11 İse TYT-AYT VE AAYKS
				BEGIN
					SELECT
					(
						SELECT
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum		 SOC	WITH(NOLOCK)
							INNER JOIN SinavOgrenci			 SO		WITH(NOLOCK) ON SO.ID_SINAVOGRENCI	=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers			 SD		WITH(NOLOCK) ON SD.ID_SINAVDERS		=SOC.ID_SINAVDERS
							INNER JOIN Sinav				 S		WITH(NOLOCK) ON S.ID_SINAV			=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet		 HN		WITH(NOLOCK) ON HN.ID_SINAVTURU		=3 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2	WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=3 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV AND S.AKTIF=1 AND S.OZEL = 0
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO
														AND S.ID_SINAVTURU=3 
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=3 
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=3 
										AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
										AND SUBS.OZEL = 0
										AND DONEM = @AKTIFDONEM) 
							AND S.OZEL = 0
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						)
						AS YKSSINAVSONUC,
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
							INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
							INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=2 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=2 AND SUBS.ID_SINAV<SO.ID_SINAV AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
														AND S.ID_SINAVTURU=2 
														AND S.AKTIF=1 
														AND S.OZEL= 0
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'TYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=2 
							AND S.OZEL = 0
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) 
											WHERE ID_SINAVTURU=2 
											AND DONEM = @AKTIFDONEM
											AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV AND SUBS.OZEL = 0))
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						) AS TYTSINAVSONUC,					
						ISNULL(
							(
								SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
								FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
								INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
								INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
								INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
								LEFT JOIN OgrenciHedefNet HN  WITH(NOLOCK)ON HN.ID_SINAVTURU=6 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
								LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=6 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.SINAVTARIH DESC)
								WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
								AND S.OZEL = 0
								AND SO.ID_SINAV=(
													SELECT ID_SINAV FROM
													(
														SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
														INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
														WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO AND S.ID_SINAVTURU=6 AND S.AKTIF=1 AND S.OZEL = 0
														AND DONEM = @AKTIFDONEM
													) XTABLE
													WHERE RN=1
												)
								ORDER BY SD.BOLUMNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							),
							(
								SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AAYKS' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
								FROM Sinav S  WITH(NOLOCK)
								INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
								INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
								INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
								LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
								where S.ID_SINAVTURU=6 
								AND S.OZEL = 0
								AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=6 
												AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
												AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
												AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
												AND SUBS.OZEL = 0
												AND DONEM = @AKTIFDONEM)
								GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
								ORDER BY SD.BOLUMNO
								FOR JSON PATH, INCLUDE_NULL_VALUES
							)
						)
						AS AAYKSSINAVSONUC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS SINAVSONUC					
				END
				ELSE IF @ID_KADEME3 IN (18) -- 12 İse TYT-AYT
				BEGIN
					SELECT
					(
						SELECT
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum		 SOC	WITH(NOLOCK)
							INNER JOIN SinavOgrenci			 SO		WITH(NOLOCK) ON SO.ID_SINAVOGRENCI	=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers			 SD		WITH(NOLOCK) ON SD.ID_SINAVDERS		=SOC.ID_SINAVDERS
							INNER JOIN Sinav				 S		WITH(NOLOCK) ON S.ID_SINAV			=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet		 HN		WITH(NOLOCK) ON HN.ID_SINAVTURU		=3 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2	WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=3 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV AND S.AKTIF=1 AND S.OZEL = 0
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO
														AND S.ID_SINAVTURU=3 
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=3 
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=3 
										AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
										AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
										AND SUBS.OZEL = 0
										AND DONEM = @AKTIFDONEM) 
							AND S.OZEL = 0
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						)
						AS YKSSINAVSONUC,
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
							INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
							INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=2 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=2 AND SUBS.ID_SINAV<SO.ID_SINAV AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.ID_SINAV DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
													WHERE	SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
														AND S.ID_SINAVTURU=2 
														AND S.AKTIF=1 
														AND S.OZEL= 0
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'TYT' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=2 
							AND S.OZEL = 0
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) 
											WHERE ID_SINAVTURU=2 
											AND DONEM = @AKTIFDONEM
											AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV AND SUBS.OZEL = 0))
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						) AS TYTSINAVSONUC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS SINAVSONUC					
				END
				ELSE -- 9, 10 İse AAYKS
				BEGIN
					SELECT
					(
						SELECT
						ISNULL((
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SOC.NET, (SOC.DOGRU + SOC.YANLIS + SOC.BOS) AS SORUSAYISI,ISNULL((SELECT DISTINCT S1.AD FROM Sinav S1 WITH(NOLOCK) INNER JOIN SinavDers S2 WITH(NOLOCK) ON S2.ID_SINAV=S1.ID_SINAV AND S2.ID_SINAVDERS=SOC2.ID_SINAVDERS AND S1.OZEL = 0),'YOK') AS BIRONCEKIAD, S.AD AS AD, ISNULL(SOC2.NET,0) AS BIRONCEKINET, (ISNULL(SOC2.DOGRU,0) + ISNULL(SOC2.YANLIS,0) + ISNULL(SOC2.BOS,0)) AS BIRONCEKISORUSAYISI,ISNULL(HN.NET-SOC.NET,0) AS ARTIS,ISNULL(HN.NET,SOC.NET) AS HEDEFNET 
							FROM SinavOgrenciCevapBolum SOC WITH(NOLOCK)
							INNER JOIN SinavOgrenci SO WITH(NOLOCK) ON SO.ID_SINAVOGRENCI=SOC.ID_SINAVOGRENCI
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOC.ID_SINAVDERS
							INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SD.ID_SINAV
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=6 AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=SO.TCKIMLIKNO AND HN.AKTIF=1
							LEFT JOIN SinavOgrenciCevapBolum SOC2 WITH(NOLOCK) ON (SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC2.ID_SINAVDERS)=(SELECT TAKMAAD FROM SinavDers WITH(NOLOCK) WHERE ID_SINAVDERS=SOC.ID_SINAVDERS) AND SOC2.ID_SINAVOGRENCI=(SELECT TOP 1 ID_SINAVOGRENCI FROM SinavOgrenci SUBSO WITH(NOLOCK) INNER JOIN Sinav SUBS WITH(NOLOCK) ON SUBS.ID_SINAV=SUBSO.ID_SINAV WHERE TCKIMLIKNO=SO.TCKIMLIKNO AND SUBS.ID_SINAVTURU=6 AND SUBS.SINAVTARIH<S.SINAVTARIH AND SUBS.AKTIF=1 AND SUBS.OZEL = 0 ORDER BY SUBS.SINAVTARIH DESC)
							WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO
							AND S.OZEL = 0
							AND SO.ID_SINAV=(
												SELECT ID_SINAV FROM
												(
													SELECT ROW_NUMBER() OVER (ORDER BY S.SINAVTARIH DESC) RN, S.ID_SINAV FROM SinavOgrenci SO WITH(NOLOCK)
													INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
													WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO AND S.ID_SINAVTURU=6 AND S.AKTIF=1 AND S.OZEL = 0
														AND DONEM = @AKTIFDONEM
												) XTABLE
												WHERE RN=1
											)
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						),
						(
							SELECT S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, 0 AS NET, (COUNT(1)) AS SORUSAYISI, 0 AS BIRONCEKINET,'YOK' AS BIRONCEKIAD, 'AAYKS' AS AD, (COUNT(1)) AS BIRONCEKISORUSAYISI, ISNULL(HN.NET,0) AS ARTIS, ISNULL(HN.NET,0) AS HEDEFNET 
							FROM Sinav S  WITH(NOLOCK)
							INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAV=S.ID_SINAV
							INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=S.ID_SINAV AND SK.AD='A'
							INNER JOIN SinavAnahtar SA WITH(NOLOCK) ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
							LEFT JOIN OgrenciHedefNet HN WITH(NOLOCK) ON HN.ID_SINAVTURU=S.ID_SINAVTURU AND HN.TAKMAAD=SD.TAKMAAD AND HN.TCKIMLIKNO=@OGRTCKIMLIKNO AND HN.AKTIF=1
							where S.ID_SINAVTURU=6 
							AND S.OZEL = 0
							AND S.ID_SINAV=(SELECT MAX(ID_SINAV) FROM Sinav SUBS WITH(NOLOCK) WHERE ID_SINAVTURU=6 
											AND EXISTS (SELECT 1 FROM SinavKatsayi WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
											AND EXISTS (SELECT 1 FROM SinavDers WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV) 
											AND EXISTS (SELECT 1 FROM SinavKitapcik WITH(NOLOCK) WHERE ID_SINAV=SUBS.ID_SINAV)
											AND SUBS.OZEL = 0
											AND DONEM = @AKTIFDONEM)
							GROUP BY S.ID_SINAV, S.ID_SINAVTURU, SD.TAKMAAD, SD.BOLUMNO, HN.NET, S.AD
							ORDER BY SD.BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)
						)
						AS AAYKSSINAVSONUC
						FOR JSON PATH, INCLUDE_NULL_VALUES
					) AS SINAVSONUC
				END
			END
		END

		IF @ISLEM = 7	--	Öğrenci Hedef Net Ekle					
		BEGIN
			DECLARE @OOOBP INT 
			IF EXISTS (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @OGRTCKIMLIKNO)
			BEGIN
				SET @OOOBP = (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @OGRTCKIMLIKNO)
			END
			ELSE
			BEGIN
				SET @OOOBP =  85
			END	

			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO

			IF @ID_SINAVPUANTURU = 6 -- DİL
			BEGIN
				UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
				INSERT INTO [dbo].[OgrenciHedefNet]
							([TCKIMLIKNO]
							,[ID_SINAVTURU]
							,[TAKMAAD]
							,[NET]
							,[DONEM])
				SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.TYTSINAVSONUC')
				WITH (
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2),
					ID_SINAVTURU INT
				) AS j

				INSERT INTO [dbo].[OgrenciHedefNet]
							([TCKIMLIKNO]
							,[ID_SINAVTURU]
							,[TAKMAAD]
							,[NET]
							,[DONEM])
				SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.YKSSINAVSONUC')
				WITH (
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2),
					ID_SINAVTURU INT
				) AS j

				--PUAN HESAPLA--
				DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (SELECT ID_SINAVPUANTURU FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVTURU in (2,4))
				INSERT INTO [dbo].[OgrenciHedefPuan]
							([TCKIMLIKNO]
							,[ID_SINAVPUANTURU]
							,[PUAN])
				SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,(SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)+ (@OOOBP * 0.6) AS PUAN FROM OPENJSON(@SQLJSON, '$.TYTSINAVSONUC')
				WITH (
					ID_SINAV INT,
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2)
				) AS J
				INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV
				GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

				INSERT INTO [dbo].[OgrenciHedefPuan]
							([TCKIMLIKNO]
							,[ID_SINAVPUANTURU]
							,[PUAN])
				SELECT @OGRTCKIMLIKNO
						,STP.ID_SINAVPUANTURU
						,(
							CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1 AND PUAN>100))
							THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1)) 
							ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
							END
							+ (@OOOBP * 0.6)
						) AS PUAN 
				FROM OPENJSON(@SQLJSON, '$.YKSSINAVSONUC')
				WITH (
					ID_SINAV INT,
					TAKMAAD VARCHAR(MAX),
					NET DECIMAL(5,2),
					ARTIS DECIMAL(5,2)
				) AS J
				INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
				INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
				GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN
			END
			ELSE
			BEGIN
				IF @ID_KADEME3 IN (17, 18) -- 11, 12 İse TYT-YKS
				BEGIN
					UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
					INSERT INTO [dbo].[OgrenciHedefNet]
								([TCKIMLIKNO]
								,[ID_SINAVTURU]
								,[TAKMAAD]
								,[NET]
								,[DONEM])
					SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.TYTSINAVSONUC')
					WITH (
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2),
						ID_SINAVTURU INT
					) AS j

					INSERT INTO [dbo].[OgrenciHedefNet]
								([TCKIMLIKNO]
								,[ID_SINAVTURU]
								,[TAKMAAD]
								,[NET]
								,[DONEM])
					SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.YKSSINAVSONUC')
					WITH (
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2),
						ID_SINAVTURU INT
					) AS j

					--PUAN HESAPLA--
					DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (SELECT ID_SINAVPUANTURU FROM SinavPuanTuru WITH(NOLOCK) WHERE ID_SINAVTURU in (2,3))
					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,(SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN) + (@OOOBP * 0.6) AS PUAN FROM OPENJSON(@SQLJSON, '$.TYTSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO
						  ,STP.ID_SINAVPUANTURU
						  ,(
								CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1 AND PUAN>100))
								THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=1)) 
								ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
								END
								+ (@OOOBP * 0.6)
						   ) AS PUAN 
					FROM OPENJSON(@SQLJSON, '$.YKSSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN



					-- 11.SINIF AAYKS
					IF @ID_KADEME3 = 17
					BEGIN
						--UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@TCKIMLIKNO

						INSERT INTO [dbo].[OgrenciHedefNet]
									([TCKIMLIKNO]
									,[ID_SINAVTURU]
									,[TAKMAAD]
									,[NET]
									,[DONEM])
						SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.AAYKSSINAVSONUC')
						WITH (
							TAKMAAD VARCHAR(MAX),
							NET DECIMAL(5,2),
							ARTIS DECIMAL(5,2),
							ID_SINAVTURU INT
						) AS j

						--PUAN HESAPLA--
						DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (9, 11, 12, 13)
						INSERT INTO [dbo].[OgrenciHedefPuan]
									([TCKIMLIKNO]
									,[ID_SINAVPUANTURU]
									,[PUAN])
						SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN AS PUAN FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
						WITH (
							ID_SINAV INT,
							TAKMAAD VARCHAR(MAX),
							NET DECIMAL(5,2),
							ARTIS DECIMAL(5,2)
						) AS J
						INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV
						WHERE STP.ID_SINAVPUANTURU=9 AND SK.ID_SINAVPUANTURU=9
						GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

						INSERT INTO [dbo].[OgrenciHedefPuan]
									([TCKIMLIKNO]
									,[ID_SINAVPUANTURU]
									,[PUAN])
						SELECT @OGRTCKIMLIKNO
							  ,STP.ID_SINAVPUANTURU
							  ,(
									CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9 AND PUAN>100))
									THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9)) 
									ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
									END
									+ (@OOOBP * 0.6)
							   ) AS PUAN 
						FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
						WITH (
							ID_SINAV INT,
							TAKMAAD VARCHAR(MAX),
							NET DECIMAL(5,2),
							ARTIS DECIMAL(5,2)
						) AS J
						INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
						INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
						WHERE SK.ID_SINAVPUANTURU<>9
						GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN
					END
				END
				ELSE -- AAYKS
				BEGIN
					UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO

					INSERT INTO [dbo].[OgrenciHedefNet]
								([TCKIMLIKNO]
								,[ID_SINAVTURU]
								,[TAKMAAD]
								,[NET]
								,[DONEM])
					SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.NET+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  FROM OPENJSON(@SQLJSON,'$.AAYKSSINAVSONUC')
					WITH (
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2),
						ID_SINAVTURU INT
					) AS j

					--PUAN HESAPLA--
					DELETE FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU IN (9, 11, 12, 13)
					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO, STP.ID_SINAVPUANTURU,(SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)+ (@OOOBP * 0.6) AS PUAN FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU = SK.ID_SINAVPUANTURU
					WHERE STP.ID_SINAVPUANTURU = 9
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN

					INSERT INTO [dbo].[OgrenciHedefPuan]
								([TCKIMLIKNO]
								,[ID_SINAVPUANTURU]
								,[PUAN])
					SELECT @OGRTCKIMLIKNO
						  ,STP.ID_SINAVPUANTURU
						  ,(
								CASE WHEN EXISTS((SELECT PUAN FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9 AND PUAN>100))
								THEN (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN)*0.6) + (SELECT PUAN*0.4 FROM OgrenciHedefPuan WHERE TCKIMLIKNO=@OGRTCKIMLIKNO AND ID_SINAVPUANTURU=9)) 
								ELSE (((SUM((J.NET+J.ARTIS)*SK.KATSAYI)+STP.TABANPUAN))) 
								END
								+ (@OOOBP * 0.6)
						   ) AS PUAN 
					FROM OPENJSON(@SQLJSON, '$.AAYKSSINAVSONUC')
					WITH (
						ID_SINAV INT,
						TAKMAAD VARCHAR(MAX),
						NET DECIMAL(5,2),
						ARTIS DECIMAL(5,2)
					) AS J
					INNER JOIN SinavDers VSD WITH(NOLOCK) ON VSD.TAKMAAD=J.TAKMAAD AND VSD.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavKatsayi SK WITH(NOLOCK) ON SK.ID_SINAVDERS=VSD.ID_SINAVDERS AND SK.ID_SINAV=J.ID_SINAV
					INNER JOIN SinavTabanPuan STP WITH(NOLOCK) ON STP.ID_SINAV=J.ID_SINAV AND STP.ID_SINAVPUANTURU=SK.ID_SINAVPUANTURU
					WHERE SK.ID_SINAVPUANTURU IN (11, 12, 13)
					GROUP BY STP.ID_SINAVPUANTURU, STP.TABANPUAN
				END
			END
			
		END

		IF @ISLEM = 8	--	Öğrenci Kazanım Listele					
		BEGIN
			SELECT  SO.ID_SINAV
				,SD.TAKMAAD AS [DERS.AD]
				,SOCB.DOGRU AS [DERS.DOGRU]
				,SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS [DERS.SORU]
				,CASE WHEN SDU.AD IS NULL THEN CONVERT(VARCHAR(MAX),SA.KOD) ELSE SDU.AD END AS [DERS.UNITE.AD]
				,SUM(case SOC.DURUM when 'D' then 1 else 0 end) as [DERS.UNITE.DOGRU]
				,SUM(case SOC.DURUM when 'Y' then 1 else 0 end) as [DERS.UNITE.YANLIS]
				,SUM(case SOC.DURUM when 'B' then 1 else 0 end) as [DERS.UNITE.BOS]
				,COUNT(1) as [DERS.UNITE.SORU]
			INTO #TEMP1
			FROM SinavOgrenci SO WITH(NOLOCK)
			INNER JOIN SinavOgrenciCevapBolum SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC WITH(NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
			INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN SinavAnahtar SA  WITH(NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
			INNER JOIN v3SinavDersUnite SDU WITH(NOLOCK) on SDU.KOD=SA.KOD
			INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
			WHERE SO.TCKIMLIKNO=@OGRTCKIMLIKNO AND S.AKTIF=1 AND S.OZEL = 0
			GROUP BY SO.ID_SINAV, SD.TAKMAAD, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SDU.AD, SA.KOD
			
			SELECT 
			(
				SELECT 
				[DERS.AD] AS DERSAD, [DERS.UNITE.AD] AS UNITEAD
				,SUM([DERS.UNITE.DOGRU]) AS TD
				,SUM([DERS.UNITE.YANLIS]) AS TY
				,SUM([DERS.UNITE.BOS]) AS TB
				,(SELECT 
						CONVERT(DECIMAL(5,2),CONVERT(DECIMAL(5,2),SUM(DS))/CONVERT(DECIMAL(5,2),SUM(SS))*100.0) 
					FROM (SELECT [DERS.SORU] AS SS, [DERS.DOGRU] DS FROM #TEMP1 SUBT WHERE SUBT.[DERS.AD]=T.[DERS.AD] GROUP BY SUBT.ID_SINAV, [DERS.SORU], [DERS.DOGRU]) ASD
					) 
					AS [DERSYUZDE]
				,CONVERT(DECIMAL(5,2), SUM([DERS.UNITE.DOGRU])/CONVERT(DECIMAL(5,2),SUM([DERS.UNITE.SORU])))*100 AS [UNITEYUZDE]
				FROM
				#TEMP1 T
				GROUP BY [DERS.AD], [DERS.UNITE.AD]
				ORDER BY [DERS.AD], CONVERT(DECIMAL(5,2), SUM([DERS.UNITE.DOGRU])/CONVERT(DECIMAL(5,2),SUM([DERS.UNITE.SORU])))*100 desc
				FOR JSON AUTO
			) J

			DROP TABLE #TEMP1
		END	

		IF @ISLEM = 9	--	OOBP EKLE/GUNCELLE						
		BEGIN
			IF EXISTS (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @TCKIMLIKNO)
			BEGIN
				UPDATE OgrenciOOBP SET OOBP = @OOBP WHERE TCKIMLIKNO = @TCKIMLIKNO
			END
			ELSE
			BEGIN
				INSERT INTO OgrenciOOBP (OOBP, TCKIMLIKNO) VALUES (@OOBP, @TCKIMLIKNO)
			END
		END

		IF @ISLEM = 10	--	OOBP GETİR								
		BEGIN
			IF EXISTS (SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @TCKIMLIKNO)
			BEGIN
				SELECT OOBP FROM OgrenciOOBP WHERE TCKIMLIKNO = @TCKIMLIKNO
			END
			ELSE
			BEGIN
				SELECT 85
			END			
		END

		IF @ISLEM = 11	--	PUAN TÜRÜ GETİR							
		BEGIN
			
			SELECT @ID_KADEME3 = ID_KADEME3 FROM OkyanusDB.dbo.v3KullaniciKademe3 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
			IF @ID_KADEME3 IN (17, 18) -- 11, 12 İse TYT-YKS (11. SINIFLAR İÇİN AAYKS)
			BEGIN
				SELECT
				(
					SELECT ID_SINAVPUANTURU,SPT.ID_SINAVTURU,SPT.AD+' ('+ST.KISAAD+')' AD,KOD,MAX_PUAN 
					FROM OgrenciHedef					OH	WITH(NOLOCK)
					INNER JOIN UniversiteTabanPuanlari	U	WITH(NOLOCK)	ON U.PROGRAMKODU=OH.PROGRAMKODU
					INNER JOIN SinavPuanTuru			SPT WITH(NOLOCK)	ON SPT.KOD=U.PUANTURU
					INNER JOIN SinavTuru				ST	WITH(NOLOCK)	ON ST.ID_SINAVTURU	= SPT.ID_SINAVTURU
					WHERE	OH.TCKIMLIKNO=@OGRTCKIMLIKNO 
						AND U.YIL = @AKTIFDONEM and OH.AKTIF = 1
						AND (	@ID_KADEME3 = 17 AND SPT.ID_SINAVTURU IN (2,3,4,6)
							OR	SPT.ID_SINAVTURU IN (2,3,4)
							)

					GROUP BY SPT.ID_SINAVTURU, SPT.ID_SINAVPUANTURU, SPT.AD, SPT.KOD, SPT.MAX_PUAN,ST.KISAAD					
					ORDER BY ST.KISAAD,SPT.AD
					--ORDER BY COUNT(1) DESC
					FOR JSON AUTO
				) PUANTURLER
			END
			ELSE 
			BEGIN
				SELECT
				(
					SELECT SPT.* FROM OgrenciHedef OH WITH(NOLOCK)
					INNER JOIN UniversiteTabanPuanlari U WITH(NOLOCK)	ON U.PROGRAMKODU=OH.PROGRAMKODU
					INNER JOIN SinavPuanTuru SPT		 WITH(NOLOCK)	ON SPT.KOD=U.PUANTURU
					WHERE OH.TCKIMLIKNO=@OGRTCKIMLIKNO AND SPT.ID_SINAVTURU IN (6,4)
						AND U.YIL = @AKTIFDONEM and OH.AKTIF = 1
					GROUP BY SPT.ID_SINAVTURU, SPT.ID_SINAVPUANTURU, SPT.AD, SPT.KOD, SPT.MAX_PUAN
					ORDER BY COUNT(1) DESC
					FOR JSON AUTO
				) PUANTURLER
			END
		END

		IF @ISLEM = 12	--	Veli Öğrenci Hedef Listele				
		BEGIN
			SELECT 
			(
				SELECT	oh.[PROGRAMKODU]
						,tp.[UNIVERSITE]
						,tp.[FAKULTE]
						,tp.[BOLUM]
						,tp.[BOLUM2]
						,tp.[EGITIMDILI]
						,tp.[UCRETBURS]
						,tp.[IL]
						,tp.[UNIVERSITETURU]
						,tp.[OGRENIMSURESI]
						,tp.[OGRENIMTURU]
						,tp.[PUANTURU]
						,tp.[YIL]
						,tp.[TABANPUAN]
						,tp.[KONTENJAN]
						,tp.[PROGRAMTURU]
						,tp.[SONYGSYERLESTIRME]
						,tp.[OKULBIRINCILIGIKONTENJANI]
						,tp.[YERONCELIKLERI]
						,tp.[ENBUYUKPUAN]
						,tp.[BASARISIRALAMA]
						,REPLACE((STUFF((SELECT CAST('@@** ' + [KOSUL] AS VARCHAR(MAX)) 
									FROM UniversiteOzelKosul ok
									WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,' ','') , ','))
									FOR XML PATH ('')), 1, 2, '')),'@@','<br /><br />') AS [OZELKOSULACIKLAMA]
				FROM OgrenciHedef oh
				INNER JOIN UniversiteTabanPuanlari tp on tp.PROGRAMKODU=oh.PROGRAMKODU
				WHERE TCKIMLIKNO=@OGRTCKIMLIKNO 
					--AND DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1) 
					AND TP.YIL = @AKTIFDONEM
					AND AKTIF=1
				ORDER BY KYE_TARIH DESC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) JSONDATA
		END

		IF @ISLEM = 13	--	ÖĞRENCİ KAZANIM LİSTELE YENİ			
		BEGIN
			DECLARE @ID_KADEME3_OGR INT

			SELECT @ID_KADEME3_OGR = ST.ID_KADEME3 
			FROM OkyanusDB.dbo.v3Ogrenci O
			JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
			JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
			WHERE O.TCKIMLIKNO = @OGRTCKIMLIKNO

			SELECT  SO.ID_SINAV
				,SD.TAKMAAD AS [DERS.AD]
				,SOCB.DOGRU AS [DERS.DOGRU]
				,SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS [DERS.SORU]
				,CASE WHEN SDU.AD IS NULL THEN CONVERT(VARCHAR(MAX),SA.KOD) ELSE SDU.AD END AS [DERS.UNITE.AD]
				,SA.KOD  AS [DERS.UNITE.KOD]
				,SUM(case SOC.DURUM when 'D' then 1 else 0 end) as [DERS.UNITE.DOGRU]
				,SUM(case SOC.DURUM when 'Y' then 1 else 0 end) as [DERS.UNITE.YANLIS]
				,SUM(case SOC.DURUM when 'B' then 1 else 0 end) as [DERS.UNITE.BOS]
				,COUNT(1) as [DERS.UNITE.SORU]
			INTO #TEMP1X
			FROM SinavOgrenci SO WITH(NOLOCK)
			INNER JOIN SinavOgrenciCevapBolum SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
			INNER JOIN SinavOgrenciCevap SOC WITH(NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN SinavKitapcik SK WITH(NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
			INNER JOIN SinavDers SD WITH(NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
			INNER JOIN SinavAnahtar SA  WITH(NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
			INNER JOIN v3SinavDersUnite SDU WITH(NOLOCK) on SDU.KOD=SA.KOD
			INNER JOIN Sinav S WITH(NOLOCK) ON S.ID_SINAV=SO.ID_SINAV
			WHERE SO.TCKIMLIKNO=@OGRTCKIMLIKNO AND S.AKTIF=1 AND S.OZEL = 0 AND ((@ID_KADEME3_OGR < 15 AND S.DONEM = @AKTIFDONEM) OR @ID_KADEME3_OGR >= 15) -- LİSE DEĞİLSE SADECE MEVCUT DÖNEM
			GROUP BY SO.ID_SINAV, SD.TAKMAAD, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SDU.AD, SA.KOD			

			SELECT
			(
				SELECT	DERSAD = [DERS.AD],
						DERSYUZDE = CONVERT(DECIMAL(5,2),CONVERT(DECIMAL(18,2),SUM([DERS.DOGRU]))/CONVERT(DECIMAL(18,2),SUM([DERS.SORU]))*100.0),
						UNITELER = (
							SELECT	UNITEAD = SUBT.[DERS.UNITE.AD], 
									TD = SUM(SUBT.[DERS.UNITE.DOGRU]), 
									TY = SUM(SUBT.[DERS.UNITE.YANLIS]), 
									TB = SUM(SUBT.[DERS.UNITE.BOS]),
									LINKLIST = ISNULL((SELECT DISTINCT LINK
														FROM OKYANUSDB.DBO.v3SinavDersUniteLink L
														WHERE	L.KOD	= SUBT.[DERS.UNITE.KOD]
															AND L.AKTIF = 1
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									AKILLIBARKODLIST = ISNULL((SELECT DISTINCT LINK = 'https://www.akilliogretim.com/VideoList/' + L.AKILLIOGRETIMBARKODKOD
														FROM Pusulam.dbo.AkilliOgretimBarkod L
														WHERE	L.ALTKONUKOD	= SUBT.[DERS.UNITE.KOD]															
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									MORPAKAZANIMLIST = ISNULL((SELECT MK.KOD
														FROM MorpaKazanim MK
														JOIN MorpaDers MD ON MD.ID_MORPADERS = MK.ID_MORPADERS AND MD.AKTIF = 1
														WHERE	MK.KOD_OKY	= SUBT.[DERS.UNITE.KOD]
															AND MK.AKTIF = 1
															AND MD.ID_KADEME3 = @ID_KADEME3_OGR
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									KAZANIMDOSYALIST = ISNULL((SELECT KD.GUID
														FROM KazanimDosya KD
														WHERE	KD.KOD	= SUBT.[DERS.UNITE.KOD]
															AND KD.AKTIF= 1
														FOR JSON PATH, INCLUDE_NULL_VALUES
													),'[]'),
									[UNITEYUZDE] = CONVERT(DECIMAL(5,2), SUM(SUBT.[DERS.UNITE.DOGRU]) / CONVERT(DECIMAL(5,2),SUM(SUBT.[DERS.UNITE.SORU]))) * 100
									
							FROM #TEMP1X SUBT 
							WHERE SUBT.[DERS.AD] = T.[DERS.AD]
							GROUP BY SUBT.[DERS.AD], SUBT.[DERS.UNITE.KOD], SUBT.[DERS.UNITE.AD]
							ORDER BY UNITEYUZDE DESC
							FOR JSON PATH
						) 
				FROM #TEMP1X T
				GROUP BY [DERS.AD]
				ORDER BY DERSYUZDE DESC
				FOR JSON PATH
			) AS J

			DROP TABLE #TEMP1X
		END

		
		IF @ISLEM = 14	--	Sınav Türü Net Grafik Listele
		BEGIN
			SELECT	 B.NET
					,DERSAD				= D.TAKMAAD
					,SIRA				= 1
					,SINAVAD			= V.AD 
			INTO #SINAVNETGRAFIK
			FROM		SinavOgrenci			O
			JOIN		SinavOgrenciCevapBolum	B	ON  B.ID_SINAVOGRENCI	= O.ID_SINAVOGRENCI
			JOIN		SinavDers				D	ON  D.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN		Sinav					V	ON  V.ID_SINAV			= O.ID_SINAV
			WHERE	v.AKTIF			= 1		
				AND v.DURUM			= 2	
				AND O.TCKIMLIKNO	= @OGRTCKIMLIKNO
				AND V.DONEM			= @AKTIFDONEM
				AND V.ID_SINAVTURU	= @ID_SINAVTURU
				AND (OZEL=0 OR 0=1)
			UNION
			SELECT	 NET = SUM(B.NET)
					,DERSAD				= 'Toplam Net'
					,SIRA				= 0
					,SINAVAD			= V.AD 
			FROM		SinavOgrenci			O
			JOIN		SinavOgrenciCevapBolum	B	ON  B.ID_SINAVOGRENCI	= O.ID_SINAVOGRENCI
			JOIN		Sinav					V	ON  V.ID_SINAV			= O.ID_SINAV
			WHERE	v.AKTIF			= 1		
				AND v.DURUM			= 2	
				AND O.TCKIMLIKNO	= @OGRTCKIMLIKNO
				AND V.DONEM			= @AKTIFDONEM
				AND V.ID_SINAVTURU	= @ID_SINAVTURU
				AND (OZEL=0 OR 0=1)
			GROUP BY V.AD

			SELECT (
				SELECT	 NETLIST = ISNULL((
											SELECT * FROM #SINAVNETGRAFIK ORDER BY SINAVAD, DERSAD FOR JSON PATH
										), '[]')
						,DERSLIST = ISNULL((
											SELECT DISTINCT SIRA, DERSAD FROM #SINAVNETGRAFIK where DERSAD<>'Toplam Net' ORDER BY SIRA, DERSAD FOR JSON PATH
										), '[]')
				FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
			)

			DROP TABLE #SINAVNETGRAFIK

		END

		IF @ISLEM = 15	--	SINAV TÜRÜ LİSTELE
		BEGIN
			SELECT
			(
				SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
				FROM SinavTuru				ST	WITH(NOLOCK)
				INNER JOIN Sinav			S	WITH(NOLOCK) ON S.ID_SINAVTURU	= ST.ID_SINAVTURU
				INNER JOIN SinavOgrenci		SO	WITH(NOLOCK) ON SO.ID_SINAV		= S.ID_SINAV
				INNER JOIN v3Ogrenci		O	WITH(NOLOCK) ON O.TCKIMLIKNO	= SO.TCKIMLIKNO
				INNER JOIN vw_SubeGrupSinif	GS	WITH(NOLOCK) ON GS.ID_SINIF		= O.ID_SINIF
				WHERE	SO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
					AND S.AKTIF			= 1 
					AND S.OZEL			= 0
					AND S.DONEM			= @AKTIFDONEM
				FOR JSON PATH
			) AS J
		END
	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_OgrenciHedefOO]...';


GO
ALTER procedure [dbo].[sp_OgrenciHedefOO]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@PROGRAMKODU		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@OGRTCKIMLIKNO		VARCHAR(11)		= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,PROGRAMKODU				= @PROGRAMKODU	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVTURU				= @ID_SINAVTURU
			,SQLJSON					= @SQLJSON		
			,OGRTCKIMLIKNO				= @OGRTCKIMLIKNO
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		 
		DECLARE @ID_KADEME3		INT
		
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

		IF @ID_LOG > 1
		BEGIN		

		DECLARE @AKTIFDONEM VARCHAR(4) = (SELECT TOP 1 DONEM FROM v3AktifDonem WHERE AKTIF = 1)

			IF @ISLEM = 1	--	Öğrenci Sınav Turu Dogru Sayıları
			BEGIN
				DECLARE	 @MAXID		INT	,@SINAVAD1 VARCHAR(MAX), @SINAVTARIH1 DATE
						,@MAXID2	INT	,@SINAVAD2 VARCHAR(MAX)
						
				

				SELECT TOP 1	 @MAXID		= SUBS.ID_SINAV
								,@SINAVAD1	= SUBS.KOD 
								,@SINAVTARIH1 = SUBS.SINAVTARIH 
				FROM		SinavOgrenci	SUBSO	WITH(NOLOCK) 
				INNER JOIN	Sinav			SUBS	WITH(NOLOCK)	ON	SUBS.ID_SINAV	= SUBSO.ID_SINAV 
				WHERE	SUBS.ID_SINAVTURU	= @ID_SINAVTURU 
					AND SUBSO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
					AND SUBS.DONEM			= @AKTIFDONEM
					AND SUBS.AKTIF			= 1 
					AND SUBS.OZEL			= 0 
					AND (SUBS.ID_SINAV = @ID_SINAV OR @ID_SINAV IS NULL OR @ID_SINAV = 0)
				ORDER BY SUBS.SINAVTARIH DESC
				
				SELECT TOP 1 
					 @MAXID2	= SUBS.ID_SINAV
					,@SINAVAD2	= SUBS.KOD 
				FROM SinavOgrenci	SUBSO	WITH(NOLOCK) 
				INNER JOIN Sinav	SUBS	WITH(NOLOCK) ON SUBS.ID_SINAV = SUBSO.ID_SINAV 
				WHERE	SUBS.ID_SINAVTURU	= @ID_SINAVTURU 
					AND SUBSO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
					AND SUBS.AKTIF			= 1 
					AND SUBS.ID_SINAV		<> @MAXID 
					AND SUBS.OZEL			= 0 
					AND SUBS.DONEM			= @AKTIFDONEM
					AND SUBS.SINAVTARIH		<= @SINAVTARIH1
				ORDER BY SUBS.SINAVTARIH DESC

				IF (@MAXID IS NOT NULL)-- AND (@MAXID2 IS NOT NULL)
				BEGIN
					SELECT	 SD.TAKMAAD
							,ISNULL(SUM(SOCB.DOGRU), 0) AS DOGRU
							,(SELECT COUNT(1) FROM SinavAnahtar SA WITH(NOLOCK) WHERE SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK = (SELECT ID_SINAVKITAPCIK FROM SinavKitapcik SK WITH(NOLOCK) WHERE SK.ID_SINAV = SO.ID_SINAV AND SK.AD = 'A')) AS SORUSAYISI
					INTO #BIRONCEKI
					FROM SinavOgrenci					SO		WITH(NOLOCK)
					INNER JOIN SinavDers				SD		WITH(NOLOCK)	ON	SD.ID_SINAV				= SO.ID_SINAV
					LEFT  JOIN SinavOgrenciCevapBolum	SOCB	WITH(NOLOCK)	ON	SOCB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
																				AND SOCB.ID_SINAVDERS		= SD.ID_SINAVDERS 
					LEFT  JOIN OgrenciHedefNet			OHN		WITH(NOLOCK)	ON	OHN.TCKIMLIKNO			= SO.TCKIMLIKNO 
																				AND OHN.ID_SINAVTURU		= @ID_SINAVTURU 
																				AND OHN.TAKMAAD				= SD.TAKMAAD 
																				AND OHN.AKTIF				= 1
					WHERE SO.TCKIMLIKNO = @OGRTCKIMLIKNO 
					AND SO.ID_SINAV = @MAXID2
					GROUP BY SD.TAKMAAD, SD.BOLUMNO, SO.ID_SINAV, SD.ID_SINAVDERS
					ORDER BY SD.BOLUMNO
	
					SELECT
					(
						SELECT  SD.TAKMAAD, 
								ISNULL(MAX(O.DOGRU), 0) AS ONCEKIDOGRU, 
								ISNULL(O.SORUSAYISI, 0) AS ONCEKISORUSAYISI, 
								ISNULL(SUM(SOCB.DOGRU), 0) AS DOGRU, 
								(SELECT COUNT(1) FROM SinavAnahtar SA WITH(NOLOCK) WHERE SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK = (SELECT ID_SINAVKITAPCIK FROM SinavKitapcik SK WITH(NOLOCK) WHERE SK.ID_SINAV = SO.ID_SINAV AND SK.AD = 'A')) AS SORUSAYISI, 
								CAST(ISNULL(SUM(OHN.NET), 
								ISNULL(SUM(SOCB.DOGRU), 0)) AS INT) AS HEDEFDOGRU, 
								ISNULL(@SINAVAD1, '-') AS SINAVAD, 
								ISNULL(@SINAVAD2, '-') AS SINAVAD2, 
								CAST(ISNULL(SUM(OHN.NET), 
								ISNULL(SUM(SOCB.DOGRU), 0)) AS INT) - ISNULL(SUM(SOCB.DOGRU), 0) AS ARTIS, 
								@ID_SINAVTURU AS ID_SINAVTURU,
								SO.ID_SINAV 
						FROM		SinavOgrenci			SO	 WITH(NOLOCK)
						INNER JOIN	SinavDers				SD	 WITH(NOLOCK) ON SD.ID_SINAV			= SO.ID_SINAV
						LEFT  JOIN	#BIRONCEKI				O	 WITH(NOLOCK) ON O.TAKMAAD				= SD.TAKMAAD
						INNER JOIN	SinavOgrenciCevapBolum	SOCB WITH(NOLOCK) ON SOCB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
																			 AND SOCB.ID_SINAVDERS		= SD.ID_SINAVDERS --- left join
						LEFT  JOIN	OgrenciHedefNet			OHN	 WITH(NOLOCK) ON OHN.TCKIMLIKNO			= SO.TCKIMLIKNO 
																			 AND OHN.ID_SINAVTURU		= @ID_SINAVTURU 
																			 AND OHN.TAKMAAD			= SD.TAKMAAD 
																			 AND OHN.AKTIF				= 1
						WHERE	SO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
							AND SO.ID_SINAV		= @MAXID
						GROUP BY SD.TAKMAAD, SD.BOLUMNO, SO.ID_SINAV, SD.ID_SINAVDERS, O.SORUSAYISI
						ORDER BY SD.BOLUMNO
						FOR JSON PATH
					) AS J

					DROP TABLE #BIRONCEKI
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT SD.TAKMAAD, 0 AS ONCEKIDOGRU, 0 AS ONCEKISORUSAYISI, 0 AS DOGRU, (SELECT COUNT(1) FROM SinavAnahtar SA WITH(NOLOCK) WHERE SA.ID_SINAVDERS = SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK = (SELECT ID_SINAVKITAPCIK FROM SinavKitapcik SK WITH(NOLOCK) WHERE SK.ID_SINAV = S.ID_SINAV AND SK.AD = 'A')) AS SORUSAYISI, 0 AS HEDEFDOGRU, '-' AS SINAVAD, '-' AS SINAVAD2, 0 AS ARTIS, @ID_SINAVTURU AS ID_SINAVTURU, @MAXID AS ID_SINAV
						FROM		Sinav		S  WITH(NOLOCK)
						INNER JOIN	SinavDers	SD WITH(NOLOCK) ON SD.ID_SINAV = S.ID_SINAV
						WHERE S.ID_SINAV = (SELECT MAX(ID_SINAV) FROM Sinav WITH(NOLOCK) WHERE ID_SINAVTURU = @ID_SINAVTURU AND AKTIF = 1 AND OZEL = 0)
						AND  S.OZEL = 0
						FOR JSON PATH
					) AS J
				END
			END	

			IF @ISLEM = 2	--	SINAV TURU GETİR
			BEGIN
				SELECT
				(
					SELECT DISTINCT ST.ID_SINAVTURU, ST.AD, ST.KISAAD 
					FROM SinavTuru				ST	WITH(NOLOCK)
					INNER JOIN Sinav			S	WITH(NOLOCK) ON S.ID_SINAVTURU	= ST.ID_SINAVTURU
					INNER JOIN SinavOgrenci		SO	WITH(NOLOCK) ON SO.ID_SINAV		= S.ID_SINAV
					INNER JOIN v3Ogrenci		O	WITH(NOLOCK) ON O.TCKIMLIKNO	= SO.TCKIMLIKNO
					INNER JOIN vw_SubeGrupSinif	GS	WITH(NOLOCK) ON GS.ID_SINIF		= O.ID_SINIF
					WHERE	SO.TCKIMLIKNO	= @OGRTCKIMLIKNO 
						AND S.AKTIF			= 1 
						AND S.OZEL			= 0
						AND (	(GS.ID_KADEME3	IN (11,12) AND ST.ID_SINAVTURU = 9) -- 5,6 SINIFLAR NÖS
							OR	(GS.ID_KADEME3	IN (13,14) AND ST.ID_SINAVTURU = 8) -- 7,8 SINIFLAR LGS
							)
					FOR JSON PATH
				) AS J
			END
	
			IF @ISLEM = 3	--	HEDEF EKLE
			BEGIN
				--UPDATE [OgrenciHedefNet] SET AKTIF=0 WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
				delete from [OgrenciHedefNet] WHERE TCKIMLIKNO=@OGRTCKIMLIKNO
				INSERT INTO [dbo].[OgrenciHedefNet]
							([TCKIMLIKNO]
							,[ID_SINAVTURU]
							,[TAKMAAD]
							,[NET]
							,[DONEM])
				SELECT @OGRTCKIMLIKNO, J.ID_SINAVTURU, J.TAKMAAD, J.DOGRU+J.ARTIS, (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)  
				FROM OPENJSON(@SQLJSON)
				WITH (
					TAKMAAD VARCHAR(MAX),
					DOGRU INT,
					ARTIS INT,
					ID_SINAVTURU INT
				) AS j
			END

			IF @ISLEM = 4	--	ÖĞRENCİ SINAVTÜRÜ SINAVLARI
			BEGIN

				SELECT DISTINCT S.ID_SINAV, S.AD, S.KOD
				FROM Sinav			S
				JOIN SinavOgrenci	SO	ON	SO.ID_SINAV	=	S.ID_SINAV					
				WHERE	ID_SINAVTURU	= @ID_SINAVTURU
					AND S.DONEM			= @AKTIFDONEM
					AND SO.TCKIMLIKNO	= @OGRTCKIMLIKNO
					AND S.OZEL			= 0
					AND S.AKTIF			= 1
					AND S.DURUM			= 2

			END 


	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OgrenciIzleme]...';


GO
ALTER procedure [dbo].[sp_OgrenciIzleme]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMSINAV			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMSINAV					= @DONEMSINAV		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON				 	= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
-----------------------------------------------------------------------------------------------
----------------Net sayıları sınavların soru sayılarına göre normalize ediliyor----------------

-----------INTSNV1037	ENDEKSLEME KAPATILIP NORMAL NETLERİ VE AĞIRLIKLI ORT EKLENDİ-----------
-----------------------------------------------------------------------------------------------


--	http://pusulam/Rapor.aspx?rapor=Sinav.OgrenciIzlemePivot&raporTur=xls&p=32051057542;8A65CF46-5A8A-40D0-95F2-D8F3F5FED778;2017;18;2;[11];[101672];[847,850,851]
--	http://pusulam/Rapor.aspx?rapor=Sinav.OgrenciIzlemePivot&raporTur=xls&p=32051057542;FD2297C4-AF4C-42A6-B6A3-7E0510FB7995;2017;14;8;[427];[102195];[144]

--	EXEC [sp_OgrenciIzleme] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='DD159E6F-D2B5-4A0A-8404-3191C46C529E',@DONEM='2018',@DONEMSINAV='2018',@ID_KADEME3=14,@ID_SINAVTURU=8,@ID_SUBEs='[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,730,447,448,706,444,446,443,309,256,430]',@ID_SINIFs='[0,108378,108377,106603,106604,106578,106580,106582,106646,106435,106427,107264,107270,107266,107271,107272,106136,109352,106310,106311,106312,106358,106360,106361,106819,106820,106821,106549,106550,106218,106219,106898,106899,106701,106700,106699,106366,106367,107502,107501,107500,107163,107164,107695,108862,108531,108534,108533,107396,107397,107497,106517,106518,106519,106520,106804,106805,106806,106807,106808,106834,108404,108410,108412,106478,106479,106480,107365,107366,107358,108941]',@ID_DERSs='[0,141,144,145,146,830,1110]'


--	EXEC [sp_OgrenciIzleme] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='43EFA6B0-F85F-43CA-9092-16C1FF8C1403',@DONEM='2018',@DONEMSINAV='2018',@ID_KADEME3=15,@ID_SINAVTURU=5,@ID_SUBEs='[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,730,447,448,706,444,446,443,309,256,430]',@ID_SINIFs='[0,108614,106609,106611,106643,106644,106645,106642,106664,107214,107210,107209,107211,108612,107251,107253,106137,106138,106139,106140,106765,106299,106300,106335,106334,106333,106822,106823,106824,106825,106551,106552,106553,107548,107549,107552,107561,106688,106689,106368,106369,107513,107505,107504,107503,107179,107180,107181,108550,108551,108552,106161,107496,107354,106854,106853,106852,106851,108341,108342,108343,106481,106482,106483,106484,107368,107376,107374,108942]',@ID_DERSs='[0,804]'

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
 				
	IF @ID_LOG > 1
	BEGIN
		
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		
				DECLARE @DONEMFARKI INT = CAST(@DONEM AS INT ) - CAST (@DONEMSINAV AS INT)
				IF  (@DONEMFARKI<>0) 
				BEGIN
					DECLARE @SIRA INT = (SELECT SIRA FROM OkyanusDB.DBO.v3Kademe3 WHERE ID_KADEME3 = @ID_KADEME3)
					SELECT @ID_KADEME3=ID_KADEME3 FROM OkyanusDB.DBO.v3Kademe3 WHERE SIRA = @SIRA- @DONEMFARKI
				END

		IF @ISLEM = 1 OR @ISLEM = 2
		BEGIN
			
			

			DROP TABLE IF EXISTS #TempNet
			DROP TABLE IF EXISTS #TempNet2
			DROP TABLE IF EXISTS #NETLISTE
			DROP TABLE IF EXISTS ##PivotsNet

			DROP TABLE IF EXISTS #TempPuan
			DROP TABLE IF EXISTS ##PivotsPuan
		
			Declare @SQL		as varchar(max)
				,	@Columns	as varchar(max)
				,	@Columns2	as varchar(max)
				,	@Columns3	as varchar(max)
				,	@Columns4	as varchar(max)
				,	@Columns5	as varchar(max)
				,	@Columns6	as varchar(max)

		--DECLARE  @DERSAD varchar(max)='Tümü'		
		--		,@ID_SUBEs		VARCHAR(MAX)= '[427,11]'
		--		,@ID_SINIFs		VARCHAR(MAX)= '[0,101671,101679,101672,101676,101680]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18

			
			SELECT  DISTINCT	SO.TCKIMLIKNO,SO.AD + ' ' + SO.SOYAD ADSOYAD, S.ID_SINAV, S.AD SINAVAD,S.SINAVTARIH, SOS.ID_SINAVPUANTURU, PT.AD PUANTURU,SOS.PUAN, O.ID_SUBE,O.ID_SINIF,VS.AD SUBEAD,VSN.AD SINIFAD
			INTO	#TempPuan
			FROM	Sinav					S
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					VS	ON	VS.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				VSN	ON	VSN.ID_SINIF		= O.ID_SINIF 
			JOIN	v3Donem					D	ON	D.ID_DONEM			= VSN.ID_DONEM
			JOIN	SinavOgrenciSonuc		SOS	ON	SOS.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavPuanTuru			PT	ON	PT.ID_SINAVPUANTURU	= SOS.ID_SINAVPUANTURU
			WHERE	S.DURUM			= 2 
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.PUANGIZLE		= 0
				AND S.ID_SINAVTURU	= @ID_SINAVTURU
				AND S.ID_KADEME3	= @ID_KADEME3
				AND S.DONEM			= @DONEMSINAV	
				AND D.KOD			= @DONEM			
				AND (O.ID_SUBE		IN	(SELECT Value FROM OPENJSON(@ID_SUBEs))		OR	@ID_SUBEs	= '[]')
				AND (O.ID_SINIF		IN	(SELECT Value FROM OPENJSON(@ID_SINIFs))	OR	@ID_SINIFs	= '[]')				
			ORDER BY SO.TCKIMLIKNO
					
			INSERT INTO #TempPuan 
			SELECT TCKIMLIKNO, ADSOYAD, 9999, 'Ağırlıklı Ort',DATEADD (YEAR,1, GETDATE()), ID_SINAVPUANTURU, PUANTURU, AVG(PUAN), ID_SUBE, ID_SINIF, SUBEAD, SINIFAD FROM #TempPuan 			
			GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAVPUANTURU, PUANTURU,  ID_SUBE, ID_SINIF, SUBEAD, SINIFAD 
			
			SELECT  SO.TCKIMLIKNO,SO.AD + ' ' + SO.SOYAD ADSOYAD, S.ID_SINAV, S.AD SINAVAD,S.SINAVTARIH, S.ID_SINAVTURU,SD.ID_SINAVDERS ,SD.TAKMAAD, DOGRU, YANLIS, BOS, NET
			, YUZDENET,O.ID_SUBE,O.ID_SINIF,VS.AD SUBEAD,VSN.AD SINIFAD
			INTO	#TempNet
			FROM	Sinav					S
			JOIN	SinavOgrenci			SO	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					VS	ON	VS.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				VSN	ON	VSN.ID_SINIF		= O.ID_SINIF
			JOIN	v3Donem					DN	ON	DN.ID_DONEM			= VSN.ID_DONEM
			JOIN	SinavOgrenciCevapBolum	B	ON	B.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		D	ON	D.ID_DERS			= SD.ID_DERS
			WHERE	S.DURUM			= 2 
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAVTURU	= @ID_SINAVTURU
				AND S.ID_KADEME3	= @ID_KADEME3
				AND S.DONEM			= @DONEMSINAV
				AND DN.KOD			= @DONEM	
				AND (D.ID_DERS		IN	(SELECT Value FROM OPENJSON(@ID_DERSs))		OR	@ID_DERSs	= '[]')
				AND (O.ID_SUBE		IN	(SELECT Value FROM OPENJSON(@ID_SUBEs))		OR	@ID_SUBEs	= '[]')
				AND (O.ID_SINIF		IN	(SELECT Value FROM OPENJSON(@ID_SINIFs))	OR	@ID_SINIFs	= '[]')				
			ORDER BY S.SINAVTARIH
			
			SELECT TAKMAAD,MAX(SS) SS 
			INTO #TempNet2 
			FROM (
				SELECT	 DISTINCT 
						 ID_SINAVDERS
						,TAKMAAD
						,ID_SINAV
						--,SUM(DOGRU+YANLIS+BOS) SS	
						,(select max(sa.SORUNO_A) from SinavAnahtar sa where sa.ID_SINAVDERS = t.ID_SINAVDERS ) SS
				FROM #TempNet t
				--GROUP BY  TCKIMLIKNO,ID_SINAV, TAKMAAD,ID_SINAVDERS		
				) AS TEMP2
			GROUP BY  TAKMAAD

			SELECT DISTINCT TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD, ID_SINAVTURU,ID_SINAVDERS ,T.TAKMAAD, DOGRU, YANLIS, BOS, NET, YUZDENET,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD,SINAVTARIH
				,G.SS
				,NETORT = NET --CAST((CAST(NET AS DECIMAL(8,2))/nullif(SUM(DOGRU+YANLIS+BOS),0) * G.SS) AS DECIMAL(8,2))
			INTO #NETLISTE
			FROM #TempNet T
			JOIN #TempNet2 G ON G.TAKMAAD=T.TAKMAAD
			--GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD, ID_SINAVTURU,ID_SINAVDERS ,T.TAKMAAD, DOGRU, YANLIS, BOS, NET, YUZDENET,ID_SUBE,ID_SINIF,G.SS,SINIFAD,SUBEAD,SINAVTARIH
		UNION ALL			
			SELECT TCKIMLIKNO, ADSOYAD, 0, 'Ağırlıklı Ort', ID_SINAVTURU,0,T.TAKMAAD, 0, 0, 0, 0, 0,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD,DATEADD(YEAR,1,  GETDATE())
				,G.SS
				,NETORT	= CAST((CAST(SUM(NET) AS DECIMAL(8,2))/nullif(SUM(DOGRU+YANLIS+BOS),0)/*	* G.SS	*/) AS DECIMAL(8,2)) 
			FROM #TempNet T
			JOIN #TempNet2 G ON G.TAKMAAD=T.TAKMAAD
			GROUP BY TCKIMLIKNO, ADSOYAD,  ID_SINAVTURU,T.TAKMAAD, ID_SUBE,ID_SINIF,G.SS,SINIFAD,SUBEAD


PRINT 1
			IF NOT EXISTS (SELECT * FROM #NETLISTE)
			BEGIN
				SELECT SIRA=NULL, TCKIMLIKNO=NULL, ADSOYAD=NULL, ID_SINAVTURU=NULL,TAKMAAD=NULL,ID_SUBE=NULL,ID_SINIF=NULL,SINIFAD=NULL,SUBEAD=NULL, SS=NULL INTO ##PivotsNet				
			END	
			
				
			IF NOT EXISTS (SELECT * FROM #TempPuan)
			BEGIN				
				SELECT TCKIMLIKNO=NULL, ADSOYAD=NULL, ID_SINAV=NULL, SINAVAD=NULL,SINAVTARIH=NULL, ID_SINAVPUANTURU=NULL, PUANTURU=NULL, PUAN=NULL, ID_SUBE=NULL, ID_SINIF=NULL, SUBEAD=NULL, SINIFAD=NULL INTO ##PivotsPuan				
				delete from ##PivotsPuan
			END		
			
PRINT 3
		--	Select distinct ID_SINAV,SINAVTARIH from #NETLISTE 
				-- PIVOT 
				BEGIN
					Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #NETLISTE  ) as b 
					ORDER BY SINAVTARIH 
PRINT 4

					Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX(P2.'+QUOTENAME(ID_SINAV)+') AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #NETLISTE  ) as b 				
					ORDER BY SINAVTARIH 

					Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(CAST(SUM(CAST( CASE WHEN  P2.'+QUOTENAME(ID_SINAV)+' = ''-'' THEN NULL ELSE P2.'+QUOTENAME(ID_SINAV)+' END AS DECIMAL(8,2)) ) AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #NETLISTE  ) as b 				
					ORDER BY SINAVTARIH 

			
					Select @Columns4=Coalesce(@Columns4+',','')+QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #TempPuan  ) as b 
					ORDER BY SINAVTARIH 
			
					--Select @Columns5=Coalesce(@Columns5+',','')+'ISNULL(CAST(MAX(CAST( CASE WHEN P2.'+QUOTENAME(ID_SINAV)+' = ''-'' THEN NULL ELSE P2.'+QUOTENAME(ID_SINAV)+' END AS DECIMAL(8,2) ) AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					--from 
					--	( Select distinct ID_SINAV,SINAVTARIH from #TempPuan  ) as b 				
					--ORDER BY SINAVTARIH 
						
					Select @Columns5=Coalesce(@Columns5+',','')+'ISNULL(CAST(MAX(P2.'+QUOTENAME(ID_SINAV)+') AS VARCHAR),''-'') AS ' +QUOTENAME(ID_SINAV) 
					from 
						( Select distinct ID_SINAV,SINAVTARIH from #TempPuan  ) as b 				
					ORDER BY SINAVTARIH 

					
PRINT @Columns	
PRINT @Columns2


					Set @SQL='	

					Select 								 
						0 SIRA, TCKIMLIKNO, ADSOYAD, ID_SINAVTURU,TAKMAAD,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD, SS,'+@Columns2+' 
					into ##PivotsNet
					from (
						Select 
							TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD, ID_SINAVTURU,ID_SINAVDERS ,TAKMAAD, DOGRU, YANLIS, BOS, NET, YUZDENET,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD,SINAVTARIH,SS,NETORT
						from #NETLISTE
					) AS S			
					PIVOT (MAX(NETORT) FOR ID_SINAV IN('+@Columns+')) as P2
					GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAVTURU, TAKMAAD,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD, SS

					INSERT INTO ##PivotsNet
					SELECT	1 SIRA, TCKIMLIKNO, ADSOYAD, ID_SINAVTURU, ''TOPLAM'' TAKMAAD,ID_SUBE,ID_SINIF,SINIFAD,SUBEAD, SUM(SS) SS,'+@Columns3+'  
					FROM	##PivotsNet P2
					GROUP BY SIRA, TCKIMLIKNO, ADSOYAD, ID_SINAVTURU, ID_SUBE,ID_SINIF,SINIFAD,SUBEAD
'
				PRINT @SQL
				EXEC (@SQL)
			SET @SQL = '
					Select
						TCKIMLIKNO, ADSOYAD, ID_SINAVPUANTURU, PUANTURU,  ID_SUBE, ID_SINIF, SINIFAD, SUBEAD,'+@Columns5+' 
					into ##PivotsPuan
					from (
						Select 
							TCKIMLIKNO, ADSOYAD, ID_SINAV, SINAVAD,SINAVTARIH, ID_SINAVPUANTURU, PUANTURU, PUAN, ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
						from #TempPuan
					) AS S			
					PIVOT (MAX(PUAN) FOR ID_SINAV IN('+@Columns4+')) as P2
					GROUP BY TCKIMLIKNO, ADSOYAD, ID_SINAVPUANTURU, PUANTURU,  ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
				'
				PRINT @SQL
				EXEC (@SQL)
		
				--SELECT * FROM ##PivotsNet
				--ORDER BY ADSOYAD,TAKMAAD
		
				--SELECT * FROM ##PivotsPuan
				--ORDER BY ADSOYAD,PUANTURU

			END

		SELECT TOP 1 ST.KISAAD STKISAAD,K.AD KADEME3,D.ACIKLAMA DONEM
		INTO #BASLIK
		FROM ##PivotsNet	PT
		JOIN SinavTuru		ST ON ST.ID_SINAVTURU	= @ID_SINAVTURU
		JOIN V3KADEME3		K  ON K.ID_KADEME3		= @ID_KADEME3
		JOIN v3AktifDonem	D  ON D.DONEM			= @DONEM	

			IF @ISLEM = 1 -- JSON SEND
			BEGIN
		
					select(
							select * from(
								select 
								(					
									SELECT * FROM ##PivotsNet
									ORDER BY ADSOYAD,SIRA,TAKMAAD
									FOR JSON AUTO
								) as TblNet,
								(									
									Select distinct ID_SINAV,SINAVAD,SINAVTARIH from #NETLISTE order by SINAVTARIH		
									FOR JSON AUTO
								) as TblNetSinav,
								(					
									SELECT * FROM ##PivotsPuan
									ORDER BY ADSOYAD,PUANTURU
									FOR JSON AUTO
								) as TblPuan,
								(	
									Select distinct ID_SINAV,SINAVAD,SINAVTARIH from #TempPuan order by SINAVTARIH		
									FOR JSON AUTO
								) as TblPuanSinav,
								(	
									Select STKISAAD,KADEME3,DONEM from #BASLIK
									FOR JSON AUTO
								) as TblBaslik
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @ISLEM = 2 -- DATASET SEND
			BEGIN
				SELECT * 
				FROM ##PivotsNet
				ORDER BY ADSOYAD, SIRA, TAKMAAD

				;WITH SIRA AS (
				SELECT ID_SINAV,SIRA = CASE WHEN ID_SINAV = 0 THEN 'ORT' ELSE CAST(ROW_NUMBER() OVER (ORDER BY SINAVTARIH) AS VARCHAR) END FROM #NETLISTE GROUP BY ID_SINAV,SINAVTARIH
				)
				Select distinct 
					 N.ID_SINAV
					,SINAVAD =    '('
								+ RIGHT( '000' +  S.SIRA,3 )
								+ ')'
								+ SINAVAD
					,SINAVTARIH 
				from #NETLISTE	N
				JOIN SIRA		S	ON	S.ID_SINAV = N.ID_SINAV
				order by SINAVTARIH		
		
				SELECT * FROM ##PivotsPuan
				ORDER BY ADSOYAD,PUANTURU
				
				Select distinct ID_SINAV,SINAVAD,SINAVTARIH from #TempPuan order by SINAVTARIH		
				
				Select STKISAAD,KADEME3,DONEM from #BASLIK

			END

	
			DROP TABLE IF EXISTS #TempNet
			DROP TABLE IF EXISTS #TempNet2
			DROP TABLE IF EXISTS #NETLISTE
			DROP TABLE IF EXISTS ##PivotsNet

			DROP TABLE IF EXISTS #TempPuan
			DROP TABLE IF EXISTS ##PivotsPuan

			DROP TABLE IF EXISTS #BASLIK

		END		
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OgrenciMaddeAnalizi]...';


GO
ALTER procedure [dbo].[sp_OgrenciMaddeAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,SQLJSON				 	= @SQLJSON		
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,DONEM						= @DONEM			
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
				
		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )
		
		IF (@ISLEM = 1 OR @ISLEM = 2)  -- 
		BEGIN
		
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[]'
			--		,@ID_SINIFs		VARCHAR(MAX)= NULL
			--		,@ID_DERSs		VARCHAR(MAX)= '[]'--'[847,942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
			--		,@ISLEM			INT			= 1		
					
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #DERS

			SELECT DERSAD INTO #DERS from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'
					
			SELECT	DISTINCT SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD,K.AD +' ' +K.SOYAD ADSOYAD
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM,CASE WHEN OC.DURUM = 'D' THEN '+' ELSE OC.CEVAP END OGRENCICEVAP
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM
					, SD.BOLUMNO, SA.SORUNO_A
			INTO	#TEMP_OGRENCI
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Kullanici				K	WITH (NOLOCK)	ON	K.TCKIMLIKNO		= O.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM 
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD				= SO.KITAPCIK 
																AND SD.ID_SINAV			= S.ID_SINAV
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
	  left JOIN		v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND O.DONEM			= @OGRENCIDONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		

				

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 
						(	
							SELECT * FROM #TEMP_OGRENCI 
							ORDER BY TCKIMLIKNO,BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblVeri,
						(								
							SELECT DISTINCT TCKIMLIKNO,ADSOYAD,ID_SUBE,ID_SINIF,SUBEAD,SINIFAD FROM #TEMP_OGRENCI 
							ORDER BY SUBEAD,SINIFAD,ADSOYAD
							FOR JSON AUTO
						) as TblOgrenciList,
						(								
							SELECT DISTINCT BOLUMNO,SORUNO_A,DERSAD,KOD,KAZANIM FROM #TEMP_OGRENCI 
							ORDER BY BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblSoruList						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE
			BEGIN
				SELECT * FROM #TEMP_OGRENCI 
				ORDER BY TCKIMLIKNO,BOLUMNO,SORUNO_A

				SELECT DISTINCT TCKIMLIKNO,ADSOYAD,ID_SUBE,ID_SINIF,SUBEAD,SINIFAD FROM #TEMP_OGRENCI 
				ORDER BY SUBEAD,SINIFAD,ADSOYAD

				SELECT DISTINCT BOLUMNO,SORUNO_A,DERSAD,KOD,KAZANIM FROM #TEMP_OGRENCI 
				ORDER BY BOLUMNO,SORUNO_A

				SELECT AD AS SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH  FROM Sinav
				WHERE ID_SINAV IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			END


			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #DERS
					

		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_OgrenciRaporlari]...';


GO
ALTER procedure [dbo].[sp_OgrenciRaporlari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SINAVOTURUM		tinyint			= NULL,
	@UNITEKOD			VARCHAR(50)		= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SINAVOTURUM				= @SINAVOTURUM	
			,UNITEKOD					= @UNITEKOD		
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
		IF @ISLEM = 1	--	Sınav Listele by Ogrenci
		BEGIN
			--Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 103) as SINAVTARIH, DURUM ,DONEM
			--from Sinav			s
			--join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	
			--where TCKIMLIKNO=@TC_OGRENCI

			select * from
			(
				Select distinct s.ID_SINAV, KOD, s.AD, ID_KADEME3, Convert(varchar, SINAVTARIH, 104) as SINAVTARIH, DURUM, DONEM
				from Sinav			s
				join SinavTuru		st	on st.ID_SINAVTURU=s.ID_SINAVTURU
				join SinavOgrenci	so	on s.ID_SINAV=so.ID_SINAV	
				where s.AKTIF=1 and s.DURUM=2 and so.TCKIMLIKNO=@TC_OGRENCI AND (OZEL=0 OR @OZELSINAVGOR=1)
			) as XTABLE
			order by cast(SINAVTARIH as date) desc
		END
		
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_OkulNetPuanOrtalamalari]...';


GO
ALTER procedure [dbo].[sp_OkulNetPuanOrtalamalari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	--@KADEME				INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM		VARCHAR(4)		= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON				 	= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,OGRENCIDONEM				= @OGRENCIDONEM	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_OkulNetPuanOrtalamalari @TCKIMLIKNO='32051057542',@OTURUM='374EDF4B-850F-49F8-92E3-29B16D759ACD',@OGRENCIDONEM='2018',@DONEM='2018',@ID_SINAVTURU=3,@ID_KADEME3=18,@ID_SINAVs='[439]',@ID_SUBEs='[11,134,200,236]',@ID_SINIFs='[0,106657,106658,106652,106660,106653,106661,106671,107230,107231,107228,107229,109428,107260,106337,106336,106339,106338,106374,107499]'

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
 
	IF @ID_LOG > 1
	BEGIN
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
	
		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrtOkul
		DROP TABLE IF EXISTS ##pivotsOkulNet
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrtOkul2
		DROP TABLE IF EXISTS ##pivotsOkulNet2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS ##GenelOrt2OkulNet
		DROP TABLE IF EXISTS ##pivots2OkulNet
		DROP TABLE IF EXISTS #COL2
		DROP TABLE IF EXISTS #ORT2
		DROP TABLE IF EXISTS #Temp22
		
		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null
-------------------------------------------------------------------------------------------------------------------
		BEGIN
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18

		--SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,ID_SINIF,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS
		--		,O.ID_SUBE,SU.AD SUBEAD
		--INTO	#Temp
		--FROM	Sinav					S	WITH (NOLOCK)
		--JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		--JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO AND O.DONEM = @OGRENCIDONEM
		--JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
		--JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
		--WHERE	S.AKTIF			=	1
		--	AND S.DURUM			=	2
		--	AND S.DONEM			=	@DONEM
		--	AND ID_SINAVTURU	=	@ID_SINAVTURU
		--	AND (S.OZEL = 0		OR	@OZELSINAVGOR = 1)
		--	AND S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
		--	AND (@ID_SINIFs = '' OR	@ID_SINIFs IS NULL OR @ID_SINIFs = '[]' OR ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)))
		
			SELECT	 S.ID_SINAV
					,SINAVAD = S.AD
					,SINAVTARIH
					,O.TCKIMLIKNO
					,O.ID_SINIF
					,VD.ID_DERS
					,SD.TAKMAAD DERSAD
					,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD
			INTO	#Temp
			FROM vw_SinavOgrenciBolum	B	WITH (NOLOCK)	
			JOIN Sinav					S	WITH (NOLOCK)	ON	S.ID_SINAV		= B.ID_SINAV
			JOIN v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO	= B.TCKIMLIKNO AND O.DONEM = @OGRENCIDONEM			
			JOIN SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS	= B.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS		= SD.ID_DERS
			JOIN v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE		= O.ID_SUBE
			WHERE S.AKTIF			=	1
				AND S.DURUM			=	2
				AND S.DONEM			=	@DONEM
				AND ID_SINAVTURU	=	@ID_SINAVTURU
				AND (S.OZEL = 0		OR	@OZELSINAVGOR = 1)
				AND S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
				AND (@ID_SINIFs = '' OR	@ID_SINIFs IS NULL OR @ID_SINIFs = '[]' OR ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)))
			ORDER BY ID_SUBE,TCKIMLIKNO,ID_DERS


			SELECT ID_SINAV,SINAVAD,ID_DERS,DERSAD,SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD
			INTO #Net
			FROM #Temp	T
			GROUP BY ID_DERS,ID_SINAV,SINAVTARIH,SINAVAD,DERSAD,ID_SUBE,SUBEAD
		
		INSERT INTO #Net			
			SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD
			FROM #Net	T
			GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b order by b.SINAVTARIH

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b  order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b order by b.SINAVTARIH



		Set @SQL='	
		
		DROP TABLE IF EXISTS ##pivotsOkulNet
		DROP TABLE IF EXISTS ##GenelOrtOkulNet
			Select 			
				MAX(ID_DERS)ID_DERS,
				ID_SUBE,
				SUBEAD,
				DERSAD,
				999 BOLUMNO,
				'+@Columns2+' 
			into ##pivotsOkulNet
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					DERSAD,
					-- TS,
					NET
				from #Net
			) AS S
			PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY DERSAD,ID_SUBE,SUBEAD			--, '+@Columns+' 		
			
			SELECT MAX(ID_DERS) AS ID_DERS,DERSAD,999 BOLUMNO,'+@Columns3+'
			INTO ##GenelOrtOkulNet
			FROM ##pivotsOkulNet 
			GROUP BY DERSAD					
		'
		PRINT @SQL
		EXEC (@SQL)

		
		BEGIN

			--SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,SO.TCKIMLIKNO
			--INTO	#Temp11
			--FROM	Sinav					S	WITH (NOLOCK)
			--JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV		
			--JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			--JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			--JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			--WHERE	S.DURUM			= 2
			--	AND S.AKTIF			= 1
			--	AND (OZEL=0 OR @OZELSINAVGOR=1)
			--	AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))

			
			SELECT S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,SB.NET,SB.TCKIMLIKNO
			INTO	#Temp11
			FROM vw_SinavOgrenciBolum	SB	WITH (NOLOCK)	
			JOIN Sinav					S	WITH (NOLOCK)	ON	S.ID_SINAV			= SB.ID_SINAV
			JOIN SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			ORDER BY TCKIMLIKNO,ID_DERS

			SELECT SINAVAD,DERSAD,CAST(AVG(NET) AS decimal(8,2)) AS ORT INTO #ORT FROM #Temp11 
			GROUP BY DERSAD,SINAVAD			
		INSERT INTO #ORT
			SELECT SINAVAD,'TOPLAM',CAST(SUM(NET)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS ORT  FROM #Temp11
			GROUP BY SINAVAD

			SELECT value SINAVAD INTO #COL FROM string_split(@Columns,',')
			WHILE EXISTS (SELECT * FROM #COL)
			BEGIN
				DECLARE @COL VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL ORDER BY 1 DESC)
			SET @SQL = N'
					UPDATE P
					SET	P.'+@COL+' = O.ORT
					FROM ##GenelOrtOkulNet P
					JOIN #ORT	O ON O.DERSAD = P.DERSAD AND ''[''+ O.SINAVAD +'']'' = '''+@COL+'''
				'
				PRINT @SQL
				EXEC (@SQL)
				DELETE FROM #COL WHERE SINAVAD = (SELECT TOP 1 SINAVAD FROM #COL ORDER BY 1 DESC)
			END
		END
		
		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value

		
		DECLARE @ILK_ID_SINAV INT=(SELECT TOP 1 VALUE FROM OPENJSON(@ID_SINAVs) WHERE VALUE > 0)


		SELECT		DISTINCT SD.TAKMAAD , SD.TAKMAAD AS DERSAD,SD.BOLUMNO	BOLUM	
		INTO #BOLUMLER		
		FROM		##pivotsOkulNet			G
		JOIN		Sinav				S	ON	S.ID_SINAV	= @ILK_ID_SINAV
		JOIN		SinavDers			SD	ON	SD.ID_SINAV	= S.ID_SINAV 
		JOIN		eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= SD.ID_DERS
		ORDER BY BOLUM
		
		INSERT INTO #BOLUMLER (TAKMAAD,DERSAD,BOLUM)
		SELECT DISTINCT DERSAD,DERSAD,(SELECT MAX(BOLUM) FROM #BOLUMLER)+ ROW_NUMBER() OVER(ORDER BY DERSAD ASC) FROM ##pivotsOkulNet  P
		WHERE DERSAD !='TOPLAM' AND  DERSAD NOT IN (SELECT DERSAD FROM #BOLUMLER )


		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM ##pivotsOkulNet	G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		
		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM ##GenelOrtOkulNet G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD
		

		END
		------------------------------------------ PUAN
		BEGIN


		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
		
		SELECT DISTINCT	 S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,ID_SINIF
				,O.ID_SUBE,SU.AD SUBEAD
				,ISNULL(PT.ID_SINAVPUANTURU,0)ID_SINAVPUANTURU ,ISNULL(PT.AD,'') PUANTURU
				,ISNULL(SOS.PUAN,0) PUAN
		INTO	#Temp2
		FROM	Sinav					S	WITH (NOLOCK)
		JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO AND O.DONEM = @OGRENCIDONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
   LEFT JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
															AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
   LEFT JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
		WHERE	S.AKTIF			=	1
			AND S.DURUM			=	2
			AND S.DONEM			=	@DONEM
			AND S.ID_SINAVTURU	=	@ID_SINAVTURU
			AND (OZEL = 0		OR	@OZELSINAVGOR=1)
			AND S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			AND (@ID_SINIFs = '' OR	@ID_SINIFs IS NULL OR @ID_SINIFs = '[]' OR ID_SINIF IN (SELECT VALUE FROM OPENJSON(@ID_SINIFs)))

		
		SELECT ID_SINAV,SINAVAD,SINAVTARIH,CAST(AVG(PUAN) AS DECIMAL(8,2)) PUAN ,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU
		INTO #Net2
		FROM #Temp2	T
		GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU

		SET @Columns	= NULL
		SET @Columns2	= NULL
		SET @Columns3	= NULL

		Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
		from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b order by b.SINAVTARIH

		Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
		from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b order by b.SINAVTARIH

		Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
		from ( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b order by b.SINAVTARIH
			
			
		if not exists (select 1 from #Net2)
		begin
			Select ID_SUBE=null,SUBEAD=null,ID_SINAVPUANTURU=null,PUANTURU=null into ##pivots2OkulNet

			SELECT ID_SINAVPUANTURU=null,PUANTURU=null INTO ##GenelOrt2OkulNet
		end
			
		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList2
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp2 T ON '['+T.SINAVAD+']'=FN.Value


		Set @SQL='	
			Select 
				ID_SUBE,
				SUBEAD,
				ID_SINAVPUANTURU,
				PUANTURU,
				'+@Columns2+' 
			into ##pivots2OkulNet
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_SUBE,
					SUBEAD,
					ID_SINAVPUANTURU,
					PUANTURU,
					PUAN
				from #Net2
			) AS S
			PIVOT (MAX(PUAN) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY SUBEAD,ID_SUBE,ID_SINAVPUANTURU,PUANTURU
			
			SELECT ID_SINAVPUANTURU,PUANTURU,'+@Columns3+'
			INTO ##GenelOrt2OkulNet
			FROM ##pivots2OkulNet 
			GROUP BY ID_SINAVPUANTURU,PUANTURU

		'
		PRINT @SQL
		EXEC (@SQL)

		
		BEGIN

			SELECT DISTINCT 
					 S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO
					,ISNULL(PT.ID_SINAVPUANTURU,0)ID_SINAVPUANTURU ,ISNULL(PT.AD,'') PUANTURU
					,ISNULL(SOS.PUAN,0) PUAN
			INTO	#Temp22
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
	   LEFT JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
																AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
	   LEFT JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))

			SELECT SINAVAD,PUANTURU,CAST(AVG(PUAN) AS decimal(8,2)) AS ORT INTO #ORT2 FROM #Temp22 
			GROUP BY SINAVAD,PUANTURU
			

			SELECT value SINAVAD INTO #COL2 FROM string_split(@Columns,',')
			WHILE EXISTS (SELECT * FROM #COL2)
			BEGIN
				DECLARE @COL2 VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL2 ORDER BY 1 DESC)
			SET @SQL = N'
					UPDATE P
					SET	P.'+@COL2+' = O.ORT
					FROM ##GenelOrt2OkulNet P
					JOIN #ORT2	O ON O.PUANTURU = P.PUANTURU AND ''[''+ O.SINAVAD +'']'' = '''+@COL2+'''
				'
				PRINT @SQL
				EXEC (@SQL)
				DELETE FROM #COL2 WHERE SINAVAD = @COL2
			END
		END
		
		END

		 select(
				select * from(
						select 
						(					
							SELECT	*
							FROM	##pivotsOkulNet 
							WHERE ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							ORDER BY	BOLUMNO
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t1,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList
							ORDER BY SINAVTARIH
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t2,
						(					
							SELECT		*
							FROM		##pivots2OkulNet 
							WHERE ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
							ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t3,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList2
							ORDER BY SINAVTARIH
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t4,
						(					
							SELECT		*
							FROM		##GenelOrtOkulNet 
							ORDER BY	BOLUMNO
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t5,
						(					
							SELECT		*
							FROM		##GenelOrt2OkulNet
							ORDER BY	ID_SINAVPUANTURU DESC
							FOR JSON AUTO, INCLUDE_NULL_VALUES    
						) as t6
					) as tablo FOR JSON AUTO
				) as tt



		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrtOkul
		DROP TABLE IF EXISTS ##pivotsOkulNet
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrtOkul2
		DROP TABLE IF EXISTS ##pivotsOkulNet2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS ##GenelOrt2OkulNet
		DROP TABLE IF EXISTS ##pivots2OkulNet
		DROP TABLE IF EXISTS #COL2
		DROP TABLE IF EXISTS #ORT2
		DROP TABLE IF EXISTS #Temp22

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_OkulRapor]...';


GO
ALTER procedure [dbo].[sp_OkulRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@IL					VARCHAR(MAX)	= NULL,	 
	@ILCE				VARCHAR(MAX)	= NULL,
	@SUBENO				VARCHAR(MAX)	= NULL

AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBE					= @ID_SUBE	
			,ID_SINIF					= @ID_SINIF	
			,IL							= @IL			
			,ILCE						= @ILCE		
			,SUBENO						= @SUBENO		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		DECLARE @ID_SINAV INT = 161, @ID_SUBE INT = 11, @IL VARCHAR(MAX) = '', @ILCE VARCHAR(MAX) = '', @SUBENO VARCHAR(MAX) = ''
--		exec dbo.sp_OkulRapor @ID_SINAV = 161, @ID_SUBE = 11

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		SELECT @IL = IL, @ILCE = ILCE, @SUBENO = RIGHT('000' + SUBENO, 3) FROM v3Sube
		WHERE ID_SUBE = @ID_SUBE

		DECLARE @SINIF VARCHAR(MAX)=(SELECT AD FROM OkyanusDB.dbo.v3SinifTum WHERE ID_SINIF=@ID_SINIF)

		DECLARE @SINAVAD VARCHAR(MAX), @SINAVTARIH VARCHAR(MAX)
		SELECT @SINAVAD = AD, @SINAVTARIH = CONVERT(VARCHAR(10), SINAVTARIH, 104)
		FROM Sinav
		WHERE ID_SINAV = @ID_SINAV


		--0--
		SELECT SUBEAD = AD, SUBEIL = IL, SUBEILCE = ILCE, SINAVAD = @SINAVAD, SINAVTARIH = @SINAVTARIH
		FROM v3Sube
		WHERE ID_SUBE = @ID_SUBE
		--1--
		SELECT ID_SINAVDERS, TAKMAAD, BOLUMNO
		FROM SinavDers
		WHERE ID_SINAV = @ID_SINAV
		ORDER BY BOLUMNO


		SELECT  ID_SINAV, SO.TCKIMLIKNO, ISNULL(K.AD, SO.AD) AS AD, ISNULL(K.SOYAD, SO.SOYAD) AS SOYAD, KITAPCIK, SINIF, ID_SINAVDOSYA, ID_SINAVOPTIKTEMP, SB.IL, SB.ILCE, SO.SUBENO
		INTO #SinavOgrenci 
		FROM		SinavOgrenci				SO
		INNER JOIN	v3Sube						SB	ON CAST(SB.SUBENO AS INT)	= CAST(SO.SUBENO AS INT)
		LEFT JOIN	OkyanusDB.dbo.v3Kullanici	K	ON K.TCKIMLIKNO				= SO.TCKIMLIKNO
		WHERE SO.ID_SINAV = @ID_SINAV AND SO.TCKIMLIKNO<>''


		SELECT DISTINCT SO.TCKIMLIKNO, SO.AD, SO.SOYAD, SB.DOGRU, SB.YANLIS, SB.BOS, SB.NET, SD.ID_SINAVDERS, SD.TAKMAAD, SO.IL, SO.ILCE, SO.SUBENO, SD.BOLUMNO, SO.SINIF, YUZDEDOGRU
		INTO #SinavOgrenciCevapBolum 
		FROM #SinavOgrenci					SO
		--INNER JOIN SinavOgrenciCevapBolum	SB	ON SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI		
		INNER JOIN [dbo].[vw_SinavOgrenciBolum]	SB	ON SB.TCKIMLIKNO		= SO.TCKIMLIKNO AND SB.ID_SINAV = @ID_SINAV
		INNER JOIN SinavDers				SD	ON SD.ID_SINAVDERS		= SB.ID_SINAVDERS

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
		INTO #DersGenelort 
		FROM #SinavOgrenciCevapBolum	SB
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,IL
		INTO #DersIlort 
		FROM #SinavOgrenciCevapBolum	SB
		WHERE IL = @IL
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, IL


		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,IL
			,ILCE
		INTO #DersIlceort FROM #SinavOgrenciCevapBolum	SB
		WHERE IL = @IL AND ILCE = @ILCE
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, IL, ILCE

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,SUBENO
		INTO #DersSubeort FROM #SinavOgrenciCevapBolum	SB
		--WHERE SUBENO = @SUBENO
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, SUBENO

		--2--
		-- Okul Net Oratalaması
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'Genel'
		FROM #DersGenelort
	UNION ALL
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'İl'
		FROM #DersIlort
	UNION ALL
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'İlçe'
		FROM #DersIlceort
	UNION ALL
		SELECT BOLUMNO, DOGRU, YANLIS, BOS, NET, TAKMAAD, ID_SINAVDERS, SIRALAMA = 'Okul'
		FROM #DersSubeort
		WHERE SUBENO = @SUBENO
		ORDER BY SIRALAMA, BOLUMNO



--SELECT * INTO #TEMP_PUANLAR FROM [dbo].[fn_SinavOgrenciToplamDYBN](@ID_SINAV)


		-- Puanlar
		SELECT DISTINCT SO.TCKIMLIKNO, SO.AD, SO.SOYAD, SS.PUAN, SP.ID_SINAVPUANTURU, SP.KOD, SO.SINIF, SO.IL, SO.ILCE, SO.SUBENO, SS.GENELSIRA, SS.ILSIRA, SS.ILCESIRA, SS.OKULSIRA, SS.SINIFSIRA
		INTO #SinavOgrenciPuan 
		FROM #SinavOgrenci						SO
		INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SS	ON	SS.TCKIMLIKNO		= SO.TCKIMLIKNO 
													AND SS.ID_SINAV			= @ID_SINAV
		INNER JOIN SinavPuanTuru				SP	ON	SP.ID_SINAVPUANTURU	= SS.ID_SINAVPUANTURU

		-- Puan Genel Ort
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanGenelOrt FROM #SinavOgrenciPuan
		GROUP BY ID_SINAVPUANTURU, KOD

		-- Puan İl Ort
		SELECT ID_SINAVPUANTURU, KOD, IL, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanIlOrt FROM #SinavOgrenciPuan
		WHERE IL = @IL
		GROUP BY ID_SINAVPUANTURU, KOD, IL

		-- Puan İlçe Ort
		SELECT ID_SINAVPUANTURU, KOD, IL, ILCE, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanIlceOrt FROM #SinavOgrenciPuan
		WHERE IL = @IL AND ILCE = @ILCE
		GROUP BY ID_SINAVPUANTURU, KOD, IL, ILCE

		-- Puan Şube Ort
		SELECT ID_SINAVPUANTURU, KOD, SUBENO, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		INTO #SinavOgrenciPuanSubeOrt FROM #SinavOgrenciPuan
		GROUP BY ID_SINAVPUANTURU, KOD, SUBENO


		--3--
		-- Okul Puan Ortalaması
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'Genel'
		FROM #SinavOgrenciPuanGenelOrt
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'İl'
		FROM #SinavOgrenciPuanIlOrt
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'İlçe'
		FROM #SinavOgrenciPuanIlceOrt
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN, SIRALAMA = 'Okul'
		FROM #SinavOgrenciPuanSubeOrt
		WHERE SUBENO = @SUBENO
		ORDER BY SIRALAMA, ID_SINAVPUANTURU

		--4--
		-- Sınıf Net Ortalamaları
		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,SINIF
		FROM #SinavOgrenciCevapBolum	SB
		WHERE SUBENO = @SUBENO
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, SUBENO, SINIF
		ORDER BY SINIF, BOLUMNO

		--5--
		-- Sınıf Puan Ortalamaları
		SELECT ID_SINAVPUANTURU, KOD, SINIF, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT)))
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO
		GROUP BY ID_SINAVPUANTURU, KOD, SINIF
		ORDER BY SINIF, ID_SINAVPUANTURU


		--6--
		-- Ders Başarı Oranları
		SELECT 
			 BASARIORAN	= CONVERT(DECIMAL(18, 2), AVG(CAST(YUZDEDOGRU	AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
		FROM #SinavOgrenciCevapBolum	SB
		WHERE SUBENO = @SUBENO
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO
		ORDER BY BOLUMNO


		-- Toplam Netler
		SELECT SUBENO, SINIF, TCKIMLIKNO, AD, SOYAD, ID_SINAVDERS = 0, TAKMAAD = 'Toplam', BOLUMNO = 99, DOGRU = SUM(DOGRU), YANLIS = SUM(YANLIS), BOS = SUM(BOS), NET = SUM(NET)
		INTO #ToplamNet FROM #SinavOgrenciCevapBolum
		GROUP BY SUBENO, SINIF, TCKIMLIKNO, AD, SOYAD

		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA = DENSE_RANK() OVER (ORDER BY NET DESC), SIRALAMA = 'Genel'
		INTO #ToplamNetGenel FROM #ToplamNet

		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA = DENSE_RANK() OVER (ORDER BY NET DESC), SIRALAMA = 'Şube'
		INTO #ToplamNetSube FROM #ToplamNet
		WHERE SUBENO = @SUBENO

		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA = DENSE_RANK() OVER (PARTITION BY SINIF ORDER BY NET DESC), SIRALAMA = 'Sınıf'
		INTO #ToplamNetSinif FROM #ToplamNet
		WHERE SUBENO = @SUBENO


		-- Öğrenci Okul Ders Ortalamaları
		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,SUBENO
			,ID_SINAVDERS
			,TAKMAAD
			,BOLUMNO
		INTO #OkulDersOrtalama FROM #SinavOgrenciCevapBolum
		WHERE SUBENO = @SUBENO
		GROUP BY ID_SINAVDERS, TAKMAAD, SUBENO, BOLUMNO

		--7--
		-- Toplam Nete Göre Öğrenci Listesi
		-- Toplam Netler
		SELECT SUBENO, SINIF, TCKIMLIKNO, AD, SOYAD, ID_SINAVDERS, TAKMAAD, BOLUMNO, DOGRU, YANLIS, BOS, NET, ONCELIK = 2, SIRA = 0
		FROM #ToplamNet
		WHERE SUBENO = @SUBENO
		UNION ALL
		-- Öğrenci Listesi
		SELECT S.SUBENO, S.SINIF, S.TCKIMLIKNO, S.AD, S.SOYAD, S.ID_SINAVDERS, S.TAKMAAD, S.BOLUMNO, S.DOGRU, S.YANLIS, S.BOS, S.NET, ONCELIK = 1, T.SIRA
		FROM #SinavOgrenciCevapBolum	S
		INNER JOIN #ToplamNetGenel		T	ON T.TCKIMLIKNO = S.TCKIMLIKNO
		WHERE S.SUBENO = @SUBENO
		UNION ALL
		-- Okul Ortalamaları
		SELECT SUBENO, SINIF = '', TCKIMLIKNO = '', AD = 'OKUL', SOYAD = 'ORTALAMALARI', ID_SINAVDERS, TAKMAAD, BOLUMNO, DOGRU, YANLIS, BOS, NET, ONCELIK = 3, SIRA = 0
		FROM #OkulDersOrtalama
		ORDER BY ONCELIK, SIRA, TCKIMLIKNO, BOLUMNO

		--8--
		-- Toplam Nete Göre Öğrenci Listesi Sıralama
		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA, SIRALAMA
		FROM #ToplamNetGenel
		WHERE SUBENO = @SUBENO
		UNION ALL
		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA, SIRALAMA
		FROM #ToplamNetSube
		WHERE SUBENO = @SUBENO
		UNION ALL
		SELECT SUBENO, SINIF, TCKIMLIKNO, NET, SIRA, SIRALAMA
		FROM #ToplamNetSinif
		WHERE SUBENO = @SUBENO

		--9--
		-- Okul Puan Öğrenci Listesi
		SELECT *
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO
		ORDER BY IL, ILCE, SINIF, TCKIMLIKNO, ID_SINAVPUANTURU

		--10--
		-- Okul Puan Ortalamaları
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT))), SIRALAMA = 'Genel'
		FROM #SinavOgrenciPuan
		GROUP BY ID_SINAVPUANTURU, KOD
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT))), SIRALAMA = 'İl'
		FROM #SinavOgrenciPuan
		WHERE IL = @IL
		GROUP BY ID_SINAVPUANTURU, KOD
		UNION ALL
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT))), SIRALAMA = 'Okul'
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO
		GROUP BY ID_SINAVPUANTURU, KOD
		ORDER BY SIRALAMA, ID_SINAVPUANTURU

		--11--
		-- Sınıf Puan Ortalamaları
		SELECT ID_SINAVPUANTURU, KOD, SINIF, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN		AS FLOAT)))
		FROM #SinavOgrenciPuan
		WHERE SUBENO = @SUBENO--  AND (@SINIF IS NULL OR SINIF=@SINIF)
		GROUP BY ID_SINAVPUANTURU, KOD, SINIF

		SELECT SA.KOD, SD.ID_SINAVDERS, SD.TAKMAAD, SA.SORUNO
		INTO #UniteKod FROM Sinav	S
		INNER JOIN SinavDers		SD	ON SD.ID_SINAV			= S.ID_SINAV
		INNER JOIN SinavAnahtar		SA	ON SA.ID_SINAVDERS		= SD.ID_SINAVDERS
		INNER JOIN SinavKitapcik	SK	ON SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
		WHERE S.ID_SINAV = @ID_SINAV AND SK.AD = 'A'

		--12--
		-- Okul Konu Analizi
		SELECT 		
				 SD.ID_SINAVDERS
				,SD.TAKMAAD
				,SD.BOLUMNO
				,SDUKONU.AD AS UNITE
				,SDU.AD AS KONU
				,DOGRU	= SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END)
				,YANLIS	= SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END)
				,BOS	= SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END)
				,TOPLAM	= COUNT(OS.DURUM)
				,SS		= (SELECT COUNT(1) FROM #UniteKod U WHERE U.KOD = SDU.KOD)
				,DOGRU_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,YANLIS_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,BOS_YUZDE		= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
		FROM #SinavOgrenci					SO
		JOIN [dbo].[vw_SinavOgrenciSoru]	OS	ON	OS.ID_SINAV		= SO.ID_SINAV
												AND OS.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN SinavDers						SD	ON	SD.ID_SINAVDERS = OS.ID_SINAVDERS
		JOIN v3SinavDersUnite				SDU	ON SDU.KOD			= OS.KOD
		JOIN v3SinavDersUnite			SDUKONU	ON SDUKONU.KOD		= SUBSTRING(OS.KOD,1,9)
		WHERE SO.SUBENO = @SUBENO
		GROUP BY SD.ID_SINAVDERS, SD.TAKMAAD, SD.BOLUMNO, SDUKONU.AD, SDU.KOD, SDU.AD
		ORDER BY SD.BOLUMNO,SDU.KOD

		--13--
		-- Okul Sınıf Konu Analizi
		SELECT 		
				SD.ID_SINAVDERS
				,SD.TAKMAAD
				,SD.BOLUMNO
				,SDUKONU.AD AS UNITE
				,SDU.AD AS KONU
				,DOGRU	= SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END)
				,YANLIS	= SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END)
				,BOS	= SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END)
				,TOPLAM	= COUNT(OS.DURUM)
				,SS		= (SELECT COUNT(1) FROM #UniteKod U WHERE U.KOD = SDU.KOD)
				,DOGRU_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'D' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,YANLIS_YUZDE	= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'Y' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,BOS_YUZDE		= CONVERT(DECIMAL(18, 2), SUM(CASE WHEN OS.DURUM = 'B' THEN 1 ELSE 0 END) / CAST(COUNT(OS.DURUM) AS FLOAT) * 100)
				,SO.SINIF
		FROM #SinavOgrenci					SO
		JOIN [dbo].[vw_SinavOgrenciSoru]	OS	ON	OS.ID_SINAV		= SO.ID_SINAV
												AND OS.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN SinavDers						SD	ON	SD.ID_SINAVDERS = OS.ID_SINAVDERS
		JOIN v3SinavDersUnite				SDU	ON SDU.KOD			= OS.KOD
		JOIN v3SinavDersUnite			SDUKONU	ON SDUKONU.KOD		= SUBSTRING(OS.KOD,1,9)
		WHERE SO.SUBENO = @SUBENO
		GROUP BY SD.ID_SINAVDERS, SD.TAKMAAD, SD.BOLUMNO, SDUKONU.AD, SDU.KOD, SDU.AD, SO.SINIF
		ORDER BY SO.SINIF,SD.BOLUMNO,SDU.KOD
		


		DROP TABLE #UniteKod


		-- Okul Soru Frekansı
					SELECT SD.TAKMAAD, SA.SORUNO_A, SA.SORUNO, SA.CEVAP, SK.AD, CASE WHEN SSI.ID_SINAVSORUDUZENLE IS NULL THEN 0 ELSE 1 END AS HATALI, SDU.AD AS KAZANIM
					INTO #CEVAPLAR 
					FROM Sinav S
					INNER JOIN SinavKitapcik SK ON SK.ID_SINAV=S.ID_SINAV
					INNER JOIN SinavDers SD ON SD.ID_SINAV=S.ID_SINAV
					INNER JOIN SinavAnahtar SA ON SA.ID_SINAVDERS=SD.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK
					LEFT JOIN SinavSoruIslem SSI ON SSI.ID_SINAVANAHTAR=SA.ID_SINAVANAHTAR 
					LEFT JOIN v3SinavDersUnite SDU ON SDU.KOD=SA.KOD
					WHERE S.ID_SINAV = @ID_SINAV
					ORDER BY SD.BOLUMNO, SK.AD, SA.SORUNO_A

					SELECT 		
							SD.BOLUMNO
							,SD.TAKMAAD
							,C.SORUNO_A AS SORU
							,C.CEVAP AS DC
							,SUM(CASE WHEN OS.CEVAP='A' THEN 1 ELSE 0 END) AS A 
							,SUM(CASE WHEN OS.CEVAP='B' THEN 1 ELSE 0 END) AS B
							,SUM(CASE WHEN OS.CEVAP='C' THEN 1 ELSE 0 END) AS C
							,SUM(CASE WHEN OS.CEVAP='D' THEN 1 ELSE 0 END) AS D
							,SUM(CASE WHEN OS.CEVAP='E' THEN 1 ELSE 0 END) AS E
							,SUM(CASE WHEN OS.CEVAP='' THEN 1 ELSE 0 END) AS BOS
							,SUM(CASE WHEN OS.CEVAP IS NOT NULL THEN 1 ELSE 0 END) AS TOPLAM
							,C.HATALI
							,C.KAZANIM
					INTO #ANALIZ
					FROM #SinavOgrenci					SO
					JOIN [dbo].[vw_SinavOgrenciSoru]	OS	ON	OS.ID_SINAV		= SO.ID_SINAV
															AND OS.TCKIMLIKNO	= SO.TCKIMLIKNO
					JOIN SinavDers						SD	ON	SD.ID_SINAVDERS = OS.ID_SINAVDERS
					JOIN #CEVAPLAR						C	ON C.TAKMAAD=SD.TAKMAAD AND C.SORUNO_A=OS.SORUNO_A AND C.AD=SO.KITAPCIK
					WHERE SO.SUBENO = @SUBENO
					GROUP BY  SD.BOLUMNO, SD.TAKMAAD, C.SORUNO_A, C.CEVAP, C.HATALI, C.KAZANIM

					--14--
					SELECT BOLUMNO, TAKMAAD, SORU, DC, 
			
					A_ADET	= A,
					A_ORAN	= CAST((CAST(A AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					B_ADET	= B,
					B_ORAN	= CAST((CAST(B AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					C_ADET	= C,
					C_ORAN	= CAST((CAST(C AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					D_ADET	= D,
					D_ORAN	= CAST((CAST(D AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					E_ADET	= E,
					E_ORAN	= CAST((CAST(E AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					BOS_ADET	= BOS,
					BOS_ORAN	= CAST((CAST(BOS AS DECIMAL)/CAST(TOPLAM AS DECIMAL)*100.0) AS DECIMAL(5,2)),

					HATALI, KAZANIM FROM #ANALIZ
					ORDER BY BOLUMNO, SORU


					DROP TABLE IF EXISTS #CEVAPLAR
					DROP TABLE IF EXISTS #ANALIZ	



		DECLARE @ID_SINAVTUR INT = (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV)

		SELECT DISTINCT SO.ID_SINAV, TCKIMLIKNO, SINAVAD = S.AD, SINAVTARIH = CONVERT(VARCHAR(10), S.SINAVTARIH, 104), DT = S.SINAVTARIH
		INTO #SinavOgrenciTum FROM SinavOgrenci	SO
		INNER JOIN v3Sube						SB	ON CAST(SB.SUBENO AS INT) = CAST(SO.SUBENO AS INT)
		INNER JOIN Sinav						S	ON S.ID_SINAV = SO.ID_SINAV
		WHERE S.AKTIF=1 
		AND S.ID_SINAVTURU = @ID_SINAVTUR 
		AND SO.SUBENO = @SUBENO 
		AND S.ID_KADEME3=(SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV)
		AND S.DONEM=(SELECT DONEM FROM Sinav WHERE ID_SINAV=@ID_SINAV)


		SELECT DISTINCT SO.ID_SINAV, SO.SINAVAD, SO.SINAVTARIH, DT/*, SO.ID_SINAVOGRENCI*/, SO.TCKIMLIKNO, SB.DOGRU, SB.YANLIS, SB.BOS, SB.NET, SD.ID_SINAVDERS, SD.TAKMAAD, SD.BOLUMNO, YUZDEDOGRU
		INTO #SinavOgrenciCevapBolumTum FROM #SinavOgrenciTum					SO
		--INNER JOIN SinavOgrenciCevapBolum	SB	ON SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		INNER JOIN [dbo].[vw_SinavOgrenciBolum] SB ON SB.TCKIMLIKNO		= SO.TCKIMLIKNO AND SB.ID_SINAV = SO.ID_SINAV
		INNER JOIN SinavDers				SD	ON SD.ID_SINAVDERS		= SB.ID_SINAVDERS

		SELECT 
			 DOGRU	= CONVERT(DECIMAL(18, 2), AVG(CAST(DOGRU	AS FLOAT)))
			,YANLIS = CONVERT(DECIMAL(18, 2), AVG(CAST(YANLIS	AS FLOAT)))
			,BOS	= CONVERT(DECIMAL(18, 2), AVG(CAST(BOS		AS FLOAT)))
			,NET	= CONVERT(DECIMAL(18, 2), AVG(CAST(NET		AS FLOAT)))
			,TAKMAAD
			,ID_SINAVDERS
			,BOLUMNO
			,ID_SINAV
			,SINAVAD
			,SINAVTARIH
			,DT
			,KATILIM=(SELECT COUNT(1) FROM (SELECT SO.TCKIMLIKNO FROM SinavOgrenci SO WHERE SO.ID_SINAV=SB.ID_SINAV AND SO.SUBENO=@SUBENO GROUP BY SO.TCKIMLIKNO) AS SUBTABLE)
		INTO #DersGenelortTum FROM #SinavOgrenciCevapBolumTum	SB
		GROUP BY TAKMAAD, ID_SINAVDERS, BOLUMNO, ID_SINAV, SINAVAD, SINAVTARIH, DT


		--15--
		SELECT * 
		FROM #DersGenelortTum
		ORDER BY DT, ID_SINAV, BOLUMNO



		-- Puanlar
		SELECT DISTINCT SO.TCKIMLIKNO, SS.PUAN, SS.ID_SINAVPUANTURU, SP.KOD, SO.ID_SINAV, SO.SINAVAD, SO.SINAVTARIH, SO.DT
		INTO #SinavOgrenciPuanTum		
		FROM #SinavOgrenciTum			SO
		INNER JOIN [dbo].[vw_SinavOgrenciPuan] SS ON SS.TCKIMLIKNO = SO.TCKIMLIKNO AND SS.ID_SINAV = SO.ID_SINAV
		INNER JOIN SinavPuanTuru		SP	ON SP.ID_SINAVPUANTURU	= SS.ID_SINAVPUANTURU

		-- Puan Genel Ort
		SELECT ID_SINAVPUANTURU, KOD, PUAN = CONVERT(DECIMAL(18, 3), AVG(CAST(PUAN	AS FLOAT))), ID_SINAV, SINAVAD, SINAVTARIH, DT
		INTO #SinavOgrenciPuanGenelOrtTum FROM #SinavOgrenciPuanTum
		GROUP BY ID_SINAVPUANTURU, KOD, ID_SINAV, SINAVAD, SINAVTARIH, DT

		--16--
		SELECT *
		FROM #SinavOgrenciPuanGenelOrtTum
		ORDER BY DT, ID_SINAV, ID_SINAVPUANTURU

		--17--
		-- KATILIM
		SELECT 
			(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO=@SUBENO) AS SUBE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL AND S2.ILCE=S.ILCE
																											WHERE S.ID_SUBE=@ID_SUBE)) AS ILCE
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV AND SUBENO IN (	SELECT RIGHT('000' + S2.SUBENO, 3) FROM OkyanusDB.dbo.v3Sube S
																											INNER JOIN OkyanusDB.dbo.v3Sube S2 ON S2.IL = S.IL
																											WHERE S.ID_SUBE=@ID_SUBE)) AS IL
			,(SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #SinavOgrenci WHERE ID_SINAV=@ID_SINAV) AS GENEL

		--18--
		select count(1) from Sinav s
		inner join SinavPuanTuru spt on spt.ID_SINAVTURU=s.ID_SINAVTURU
		where ID_SINAV=@ID_SINAV

		SELECT SD.BOLUMNO, SD.TAKMAAD, MAX(SA.SORUNO) AS SS 
		INTO #DERSSORUSAYI
		FROM SinavDers SD 
		INNER JOIN SinavAnahtar SA ON SA.ID_SINAVDERS = SD.ID_SINAVDERS
		WHERE SD.ID_SINAV = @ID_SINAV
		GROUP BY SD.BOLUMNO, SD.TAKMAAD
		ORDER BY SD.BOLUMNO
		
		--19--
		SELECT SB.ID_SUBE, SB.AD, O.TAKMAAD + '@@S.S=' + CAST(SS.SS AS VARCHAR) AS TAKMAAD, O.BOLUMNO, O.NET, SS.SS
		FROM #DersSubeort O
		INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.SUBENO = CAST(O.SUBENO AS INT)
		INNER JOIN #DERSSORUSAYI SS ON SS.BOLUMNO = O.BOLUMNO
		ORDER BY SB.AD, O.BOLUMNO

		--20--
		SELECT SB.ID_SUBE, SB.AD, O.KOD, O.PUAN
		FROM #SinavOgrenciPuanSubeOrt O
		INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.SUBENO = CAST(O.SUBENO AS INT)
		ORDER BY SB.AD, O.ID_SINAVPUANTURU

		DECLARE @PUANTURSAY INT = 0
		--	BARAJ	--
		SELECT @PUANTURSAY = COUNT(1) FROM Sinav S
		INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU = S.ID_SINAVTURU
		WHERE S.ID_SINAV = @ID_SINAV

		SELECT TCKIMLIKNO
		INTO #150BARAJ
		FROM #SinavOgrenciPuan SOP
		WHERE SOP.PUAN < 150 AND SOP.SUBENO = @SUBENO
		GROUP BY SOP.TCKIMLIKNO
		HAVING COUNT(1) = @PUANTURSAY

		--21--
		SELECT SOP.TCKIMLIKNO, SOP.AD, SOP.SOYAD, SPT.AD AS PUANTURU, SOP.PUAN
		FROM #SinavOgrenciPuan SOP
		INNER JOIN #150BARAJ B ON B.TCKIMLIKNO = SOP.TCKIMLIKNO
		INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVPUANTURU = SOP.ID_SINAVPUANTURU
		ORDER BY SOP.TCKIMLIKNO, SOP.ID_SINAVPUANTURU, SOP.PUAN

		--22--
		SELECT B.TCKIMLIKNO, SOCB.BOLUMNO, SOCB.TAKMAAD, SOCB.NET, SOCB.SINIF
		FROM #150BARAJ B
		INNER JOIN #SinavOgrenciCevapBolum SOCB ON SOCB.TCKIMLIKNO = B.TCKIMLIKNO
		ORDER BY B.TCKIMLIKNO, SOCB.BOLUMNO
		
		SELECT TCKIMLIKNO
		INTO #180BARAJ
		FROM #SinavOgrenciPuan SOP
		WHERE SOP.PUAN < 180 AND SOP.SUBENO = @SUBENO
		GROUP BY SOP.TCKIMLIKNO
		HAVING COUNT(1) = @PUANTURSAY

		--23--
		SELECT SOP.TCKIMLIKNO, SOP.AD, SOP.SOYAD, SPT.AD AS PUANTURU, SOP.PUAN
		FROM #SinavOgrenciPuan SOP
		INNER JOIN #180BARAJ B ON B.TCKIMLIKNO = SOP.TCKIMLIKNO
		INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVPUANTURU = SOP.ID_SINAVPUANTURU
		ORDER BY SOP.TCKIMLIKNO, SOP.ID_SINAVPUANTURU, SOP.PUAN
		
		--24--
		SELECT B.TCKIMLIKNO, SOCB.BOLUMNO, SOCB.TAKMAAD, SOCB.NET, SOCB.SINIF
		FROM #180BARAJ B
		INNER JOIN #SinavOgrenciCevapBolum SOCB ON SOCB.TCKIMLIKNO = B.TCKIMLIKNO
		ORDER BY B.TCKIMLIKNO, SOCB.BOLUMNO

		DECLARE @KATILIMBASLIK VARCHAR(MAX) = (SELECT CAST(S.DONEM AS VARCHAR) + '-' + CAST(CAST(S.DONEM AS INT)+1 AS VARCHAR) + ' OKYANUS KOLEJİ ' + K3.AD + ' ' + S.AD + ' SINAVINA KATILMAYAN ÖĞRENCİLER' FROM Sinav S INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = S.ID_KADEME3 WHERE ID_SINAV = @ID_SINAV)

		--25--
		SELECT K.TCKIMLIKNO, K.AD+' '+K.SOYAD AS ADSOYAD, SU.AD AS OKUL, SN.AD AS SINIF, @KATILIMBASLIK AS BASLIK 
		FROM OkyanusDB.dbo.v3OgrenciTum O
		INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
		INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = O.ID_SINIF
		INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO=O.TCKIMLIKNO
		INNER JOIN OkyanusDB.dbo.v3Sube SU ON SU.ID_SUBE=O.ID_SUBE
		LEFT JOIN SinavOgrenci SO ON SO.TCKIMLIKNO=O.TCKIMLIKNO AND SO.ID_SINAV=@ID_SINAV
		WHERE SO.ID_SINAVOGRENCI IS NULL 
		AND	  (@ID_SUBE=0 OR @ID_SUBE=O.ID_SUBE)
		AND	  (SGS.ID_KADEME3=(SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV))
		AND	  (O.DONEM=(SELECT DONEM FROM Sinav WHERE ID_SINAV=@ID_SINAV))
		ORDER BY O.ID_SUBE, O.ID_SINIF, K.AD, K.SOYAD		
	
		DROP TABLE #150BARAJ
		DROP TABLE #180BARAJ
		DROP TABLE #SinavOgrenciPuanTum
		DROP TABLE #SinavOgrenciPuanGenelOrtTum
		DROP TABLE #SinavOgrenci
		DROP TABLE #SinavOgrenciCevapBolum
		DROP TABLE #SinavOgrenciTum
		DROP TABLE #SinavOgrenciCevapBolumTum
		DROP TABLE #DersGenelortTum
		DROP TABLE #DersGenelort
		DROP TABLE #DersIlort
		DROP TABLE #DersIlceort
		DROP TABLE #DersSubeort
		DROP TABLE #SinavOgrenciPuan
		DROP TABLE #SinavOgrenciPuanGenelOrt
		DROP TABLE #SinavOgrenciPuanIlOrt
		DROP TABLE #SinavOgrenciPuanIlceOrt
		DROP TABLE #SinavOgrenciPuanSubeOrt
		DROP TABLE #ToplamNet
		DROP TABLE #ToplamNetGenel
		DROP TABLE #ToplamNetSube
		DROP TABLE #ToplamNetSinif
		DROP TABLE #OkulDersOrtalama
		DROP TABLE #DERSSORUSAYI


	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OptikYukle]...';


GO
ALTER procedure [dbo].[sp_OptikYukle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SINAVOTURUM		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,	
	@ID_SINAVOPTIKTEMP	INT				= NULL,
	@OGR_AD				VARCHAR(MAX)	= NULL,
	@OGR_SOYAD			VARCHAR(MAX)	= NULL,
	@SUBENO				VARCHAR(MAX)	= NULL,
	@SUBEAD				VARCHAR(MAX)	= NULL,
	@SINIF				VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,TC_OGRENCI					= @TC_OGRENCI			
			,OTURUM						= @OTURUM				
			,ID_MENU					= @ID_MENU			
			,DONEM						= @DONEM				
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SINAVTURU				= @ID_SINAVTURU		
			,ID_SINAV					= @ID_SINAV			
			,ID_DERS					= @ID_DERS			
			,ID_SUBE					= @ID_SUBE			
			,DOSYAADI					= @DOSYAADI			
			,DOSYAGUID					= @DOSYAGUID			
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA		
			,SINAVOTURUM				= @SINAVOTURUM		
			,SQLJSON				 	= @SQLJSON			
			,ID_SINAVOPTIKTEMP			= @ID_SINAVOPTIKTEMP	
			,OGR_AD						= @OGR_AD				
			,OGR_SOYAD					= @OGR_SOYAD			
			,SUBENO						= @SUBENO				
			,SUBEAD						= @SUBEAD				
			,SINIF						= @SINIF				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	Eşleşmeyen öğrenci listesi
			BEGIN
			
				SELECT  VK.TCKIMLIKNO,VK.AD,VK.SOYAD,RIGHT('000'+ VS.SUBENO,3)SUBENO,VS.AD SUBEAD,VSN.AD SINIF
				INTO	#T2
				FROM	V3Ogrenci			VO
				JOIN	V3Kullanici			VK	ON	VK.TCKIMLIKNO=VO.TCKIMLIKNO
				JOIN	V3SUBE				VS	ON	VS.ID_SUBE=VO.ID_SUBE
				JOIN	V3Sinif				VSN	ON	VSN.ID_SINIF=VO.ID_SINIF
				JOIN	v3KullaniciKademe3	VKK	ON	VKK.TCKIMLIKNO=VO.TCKIMLIKNO
				WHERE	ID_KADEME3=@ID_KADEME3
					AND (@ID_SUBE=0 OR VO.ID_SUBE=@ID_SUBE)

				select(
					select * from(
						select 
						(
							SELECT * FROM [dbo].[fn_TcEslesmeGetir](@ID_KADEME3,@ID_SINAVDOSYA,@ID_SINAV,@SINAVOTURUM,0)
							FOR JSON AUTO
						) as t1,
						(
							select * from #T2
							order by SUBENO,SUBEAD,SINIF,AD,SOYAD
							FOR JSON AUTO
						) as t2					
					) as tablo FOR JSON AUTO
				) as tt
			
				DROP TABLE IF EXISTS #T2			
			END

			IF @ISLEM = 2	--	sınavogrenci eşleştir
			BEGIN
			
				SELECT @ID_SINAV=ID_SINAV FROM SinavDosya WHERE ID_SINAVDOSYA=(SELECT ID_SINAVDOSYA FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP)

				DECLARE	 @BASLANGIC INT=(select BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
						,@KARAKTER INT=(select OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)					
						,@ESKILINE VARCHAR(MAX) = (SELECT LINE FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP)
				

				UPDATE	SinavOptikTemp
				SET		LINE=SUBSTRING(LINE,0,@BASLANGIC)+@TC_OGRENCI+SUBSTRING(LINE,@BASLANGIC+@KARAKTER,LEN(LINE))
				WHERE	ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP


				INSERT INTO SinavOptikGuncelleLog (ID_SINAV, ID_SINAVDOSYA, ESKILINE, YENILINE, KYE_TCKIMLIKNO)
				(SELECT  @ID_SINAV,ID_SINAVDOSYA,@ESKILINE, LINE, @TCKIMLIKNO FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP AND @ESKILINE != LINE)

				SELECT @ID_SINAVOPTIKTEMP
				
			END

			IF @ISLEM = 3	--	OptikYükle bilgilerini gör
			BEGIN		 

				--SELECT TOP 1 SD.ID_SINAV,S.DONEM,S.ID_SINAVTURU,S.ID_KADEME3
				--FROM	SinavDosya	SD
				--JOIN	Sinav		S	ON S.ID_SINAV=SD.ID_SINAV
				--WHERE	SD.ID_SINAV=@ID_SINAV AND S.AKTIF=1
			

				select(
							SELECT TOP 1 S.ID_SINAV,S.DONEM,S.ID_SINAVTURU,S.ID_KADEME3,s.DURUM
							FROM	SinavDosya	SD
							right JOIN	Sinav		S	ON S.ID_SINAV=SD.ID_SINAV
							WHERE	S.ID_SINAV=@ID_SINAV AND S.AKTIF=1
							FOR JSON PATH									
				) as tt
			END

			IF @ISLEM = 4	--	TC GÜNCELLE
			BEGIN
				SET	@BASLANGIC=(select BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
				SET @KARAKTER=(select OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)					
				DECLARE @ESKILINE2 VARCHAR(MAX) = (SELECT LINE FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP)				
				SELECT @ID_SINAV=ID_SINAV FROM SinavDosya WHERE ID_SINAVDOSYA=(SELECT ID_SINAVDOSYA FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP)
			
				UPDATE SinavOptikTemp SET LINE = STUFF(LINE, @BASLANGIC, @KARAKTER, @TC_OGRENCI) WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP		

				INSERT INTO SinavOptikGuncelleLog (ID_SINAV, ID_SINAVDOSYA, ESKILINE, YENILINE, KYE_TCKIMLIKNO)
				(SELECT  @ID_SINAV,ID_SINAVDOSYA,@ESKILINE2, LINE, @TCKIMLIKNO FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP  AND @ESKILINE2 != LINE)
			END

			IF @ISLEM = 5	--	OPTİK SATIR SİL
			BEGIN
				
				SELECT @ID_SINAV=ID_SINAV FROM SinavDosya WHERE ID_SINAVDOSYA=(SELECT ID_SINAVDOSYA FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP)
				INSERT INTO SinavOptikGuncelleLog (ID_SINAV, ID_SINAVDOSYA, ESKILINE, YENILINE, KYE_TCKIMLIKNO)
				(SELECT  @ID_SINAV,ID_SINAVDOSYA, LINE,NULL, @TCKIMLIKNO FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP)

				DELETE FROM SinavOptikTemp WHERE ID_SINAVOPTIKTEMP=@ID_SINAVOPTIKTEMP	
			END

			IF @ISLEM = 6	--	Tekrareden öğrenci listesi
			BEGIN
				SELECT  VK.TCKIMLIKNO,VK.AD,VK.SOYAD,RIGHT('000'+ VS.SUBENO,3)SUBENO,VS.AD SUBEAD,VSN.AD SINIF
				INTO	#TEKRAREDEN
				FROM	V3Ogrenci			VO
				JOIN	V3Kullanici			VK	ON	VK.TCKIMLIKNO=VO.TCKIMLIKNO
				JOIN	V3SUBE				VS	ON	VS.ID_SUBE=VO.ID_SUBE
				JOIN	V3Sinif				VSN	ON	VSN.ID_SINIF=VO.ID_SINIF
				JOIN	v3KullaniciKademe3	VKK	ON	VKK.TCKIMLIKNO=VO.TCKIMLIKNO
				WHERE	ID_KADEME3 = @ID_KADEME3
					and (@ID_SUBE=0 OR VO.ID_SUBE=@ID_SUBE)

				select(
					select * from(
						select 
						(
							SELECT * FROM [dbo].[fn_TcEslesmeGetir](@ID_KADEME3,@ID_SINAVDOSYA,@ID_SINAV,@SINAVOTURUM,1)
							FOR JSON AUTO
						) as t1,
						(
							select * from #TEKRAREDEN
							order by SUBENO,SUBEAD,SINIF,AD,SOYAD
							FOR JSON AUTO
						) as t2					
					) as tablo FOR JSON AUTO
				) as tt
						
				DROP TABLE IF EXISTS #TEKRAREDEN
			END

			IF @ISLEM = 7	--	
			BEGIN
			select (
				SELECT COUNT(1) TE_TC FROM [dbo].[fn_TcEslesmeGetir](@ID_KADEME3,@ID_SINAVDOSYA,@ID_SINAV,@SINAVOTURUM,1)FOR JSON AUTO
				)as tt
				--SELECT 
				--	(SELECT COUNT(*) FROM [dbo].[fn_TcEslesmeGetir](@ID_KADEME3,@ID_SINAVDOSYA,@ID_SINAV,@OTURUM,0)) AS TCESLESMEYENSAYISI	--	TC EŞLEŞMEYEN
				--	,(SELECT COUNT(*) FROM [dbo].[fn_TcEslesmeGetir](@ID_KADEME3,@ID_SINAVDOSYA,@ID_SINAV,@OTURUM,1)) AS COKLUTCSAYISI	--	ÇOKLU TC

			END

			IF @ISLEM = 8	--	TEKRAR EDEN OGRENCI LISTESI BURSLULUK EXCEL
			BEGIN

				SELECT TCKIMLIKNO
						,AD		= SUBSTRING(OGRENCI_ADSOYAD,0,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+1) 
						,SOYAD	= SUBSTRING(OGRENCI_ADSOYAD,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+2,LEN(OGRENCI_ADSOYAD)) 
						,SUBENO	= RIGHT('000'+ISNULL(SB.SUBENO,''),3)
						,SUBEAD	= ISNULL(SB.AD,'')
						,SINIF	= '' 
				INTO #TEMP8
				FROM BurslulukSinavOgrenci SO 
				LEFT JOIN v3Sube SB ON SB.ID_SUBE = SO.ID_SUBE
				WHERE ID_SINAV = @ID_SINAV

				select(
					select * from(
						select 
						(
							SELECT * FROM [dbo].[fn_TcEslesmeGetir](@ID_KADEME3,@ID_SINAVDOSYA,@ID_SINAV,@SINAVOTURUM,1)
							FOR JSON AUTO
						) as t1,
						(
							select * from #TEMP8
							order by SUBENO,AD,SOYAD
							FOR JSON AUTO
						) as t2					
					) as tablo FOR JSON AUTO
				) as tt
						
				DROP TABLE IF EXISTS #TEKRAREDEN	
				
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_SinavHariciPuanSira]...';


GO
ALTER procedure [dbo].[sp_SinavHariciPuanSira]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@DOGRULAMA			VARCHAR(44)		= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,DOGRULAMA					= @DOGRULAMA	
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
 
	IF @DOGRULAMA = '693M161f1Sv595Y' AND @ISLEM = 3  -- optik işlemlerinden geliyorsa 
		SET @ID_LOG=2
	ELSE
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1 
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @DONEM IS NULL OR @DONEM = ''
			SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
						
		IF @ISLEM = 1	--	PUANTURU
		BEGIN
			SELECT PT.ID_SINAVPUANTURU
				,PUANTURU = pt.AD
			FROM Sinav			S 
			JOIN SinavPuanTuru	PT	ON	PT.ID_SINAVTURU	= S.ID_SINAVTURU
			WHERE S.ID_SINAV = @ID_SINAV
			ORDER BY PT.ID_SINAVPUANTURU
		END

		IF @ISLEM = 2	--	SINAV DETAY GETİR
		BEGIN
		
			DROP TABLE IF EXISTS #OGRENCILIST

			SELECT  
				 TCKIMLIKNO			= JSON_VALUE(J.VALUE,'$.TCKIMLIKNO') 
				,ADSOYAD			= JSON_VALUE(J.VALUE,'$.ADSOYAD') 
				,ILCEKATILIM		= JSON_VALUE(J.VALUE,'$.ILCEKATILIM') 
				,ILKATILIM			= JSON_VALUE(J.VALUE,'$.ILKATILIM') 
				,GENELKATILIM		= JSON_VALUE(J.VALUE,'$.GENELKATILIM') 
				,ID_SINAV			= @ID_SINAV
				,ID_SINAVPUANTURU	= ID_SINAVPUANTURU	
				,PUAN				= PUAN
				,SINIFSIRA			= SINIFSIRA	
				,OKULSIRA			= OKULSIRA	
				,ILCESIRA			= ILCESIRA	
				,ILSIRA				= ILSIRA		
				,GENELSIRA			= GENELSIRA	
			INTO #OGRENCILIST
			FROM OPENJSON (@SQLJSON) AS J
			CROSS APPLY (
				SELECT PUAN				= replace(JSON_VALUE(H.VALUE,'$.PUAN'),',','.')
					,ID_SINAVPUANTURU	= JSON_VALUE(H.VALUE,'$.ID_SINAVPUANTURU')
					,SINIFSIRA			= JSON_VALUE(H.VALUE,'$.SINIFSIRA')
					,OKULSIRA			= JSON_VALUE(H.VALUE,'$.OKULSIRA')
					,ILCESIRA			= JSON_VALUE(H.VALUE,'$.ILCESIRA')
					,ILSIRA				= JSON_VALUE(H.VALUE,'$.ILSIRA')
					,GENELSIRA			= JSON_VALUE(H.VALUE,'$.GENELSIRA')
				FROM OPENJSON (J.VALUE,'$.HariciList') AS H 
			)AS S
			
			DELETE FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV
			
			INSERT INTO SinavOgrenciHariciPuanSiralama ( TCKIMLIKNO, ID_SINAV, ID_SINAVPUANTURU, PUAN, SINIFSIRA, OKULSIRA, ILCESIRA, ILSIRA, GENELSIRA, ILCEKATILIM, ILKATILIM, GENELKATILIM )
			SELECT DISTINCT OL.TCKIMLIKNO, OL.ID_SINAV, OL.ID_SINAVPUANTURU, OL.PUAN, OL.SINIFSIRA, OL.OKULSIRA, OL.ILCESIRA, OL.ILSIRA, OL.GENELSIRA, OL.ILCEKATILIM, OL.ILKATILIM, OL.GENELKATILIM
			FROM Sinav			S	
			JOIN SinavPuanTuru	PT	ON	PT.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN #OGRENCILIST	OL	ON	OL.ID_SINAV			= S.ID_SINAV	
									AND OL.ID_SINAVPUANTURU	= PT.ID_SINAVPUANTURU
			WHERE S.ID_SINAV = @ID_SINAV

			DROP TABLE IF EXISTS #OGRENCILIST
			
			SELECT COUNT(DISTINCT TCKIMLIKNO) FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV

			SET @ISLEM = 3

		END

		IF @ISLEM = 3
		BEGIN

			UPDATE P SET
				 P.PUAN			= PS.PUAN
				,P.SINIFSIRA	= PS.SINIFSIRA		
				,P.OKULSIRA		= PS.OKULSIRA			
				,P.ILCESIRA		= PS.ILCESIRA			
				,P.ILSIRA		= PS.ILSIRA			
				,P.GENELSIRA	= PS.GENELSIRA		
			FROM SinavOgrenci					SO
			JOIN SinavOgrenciSonuc				P	ON	P.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV			= SO.ID_SINAV
													AND PS.TCKIMLIKNO		= SO.TCKIMLIKNO
													AND PS.ID_SINAVPUANTURU = P.ID_SINAVPUANTURU
			WHERE PS.ID_SINAV = @ID_SINAV

			UPDATE P SET
				 P.PUAN			= PS.PUAN
				,P.SINIFSIRA	= PS.SINIFSIRA		
				,P.OKULSIRA		= PS.OKULSIRA			
				,P.ILCESIRA		= PS.ILCESIRA			
				,P.ILSIRA		= PS.ILSIRA			
				,P.GENELSIRA	= PS.GENELSIRA		
			FROM SinavOgrenciPuan				P	
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV		= P.ID_SINAV
													AND PS.TCKIMLIKNO	= P.TCKIMLIKNO
													AND PS.ID_SINAVPUANTURU = P.ID_SINAVPUANTURU
			WHERE PS.ID_SINAV = @ID_SINAV


			UPDATE K SET 
				 K.KATILIM_GENEL= ISNULL(PS.GENELKATILIM,K.KATILIM_GENEL)
				,K.KATILIM_IL	= ISNULL(PS.ILKATILIM	,K.KATILIM_IL)
				,K.KATILIM_ILCE = ISNULL(PS.ILCEKATILIM	,K.KATILIM_ILCE)
			FROM SinavOgrenciToplam				K
			JOIN SinavOgrenciHariciPuanSiralama	PS	ON	PS.ID_SINAV		= K.ID_SINAV
													AND PS.TCKIMLIKNO	= K.TCKIMLIKNO
			WHERE	K.ID_SINAV	= @ID_SINAV			
				AND (	PS.GENELKATILIM IS NOT NULL
					OR	PS.ILCEKATILIM  IS NOT NULL
					OR  PS.ILKATILIM	IS NOT NULL)

		END

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SinavIstatistik]...';


GO
ALTER procedure [dbo].[sp_SinavIstatistik]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				CHAR(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@DOSYAADI			VARCHAR(100)	= NULL,
	@DOSYAGUID			VARCHAR(50)		= NULL,
	@ID_SINAVDOSYA		INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
		IF @DONEM IS NULL OR @DONEM = ''
			SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
						
		IF @ISLEM = 1	--	SINAV İSTATİSTİK
		BEGIN

--		exec sp_SinavIstatistik @ISLEM=1, @TCKIMLIKNO='32051057542',@OTURUM='A51D1B28-244C-4A7E-8CCF-9564B00A9C35',@TC_OGRENCI='10502544810',@DONEM= 2017, @ID_MENU= 1029,@ID_SINAVTURU=9
			
			IF OBJECT_ID('tempdb..#TEMP')	IS NOT NULL		DROP TABLE #TEMP
			IF OBJECT_ID('tempdb..#PUAN')	IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#TT')		IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#T1')		IS NOT NULL		DROP TABLE #T1

			SELECT	
					count(1) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=MAX(D.ID_SINAVDERS)) TOPLAMSORU
					--,o.ID_SINAV
			into #TEMP 
			from SinavOgrenci		o
			JOIN SinavOgrenciCevapBolum	b	ON	o.ID_SINAVOGRENCI			= b.ID_SINAVOGRENCI	
			JOIN SinavOgrenciCevap		c	ON	b.ID_SINAVOGRENCICEVAPBOLUM	= c.ID_SINAVOGRENCICEVAPBOLUM
			JOIN SinavDers				d	ON	d.ID_SINAVDERS				= b.ID_SINAVDERS 
											and d.ID_SINAV					= o.ID_SINAV
			JOIN Sinav					s	ON	s.ID_SINAV					= o.ID_SINAV 
			JOIN SinavKitapcik			k	ON	k.ID_SINAV					= o.ID_SINAV
											AND	K.AD						= o.KITAPCIK
			JOIN SinavAnahtar			a	ON	a.SORUNO					= c.SORUNO	
											AND a.ID_SINAVKITAPCIK			= k.ID_SINAVKITAPCIK		
											AND A.ID_SINAVDERS				= B.ID_SINAVDERS 
			JOIN v3SinavDersUnite		u	ON  u.KOD						= a.KOD			-- ktt almanca ünite olmadığından boş çıkıyor.
			WHERE	S.AKTIF			= 1		
				AND S.DURUM			= 2	
				AND o.TCKIMLIKNO	= @TC_OGRENCI	
				AND S.ID_SINAVTURU	= @ID_SINAVTURU					
				AND (OZEL=0 OR @OZELSINAVGOR=1)
			GROUP BY c.DURUM,d.TAKMAAD,u.kod,U.AD--,D.ID_SINAVDERS--,o.ID_SINAV
			ORDER BY d.TAKMAAD

			SELECT	 O.TCKIMLIKNO
					,PUAN				= ISNULL( S.PUAN,0) 
					,B.NET
					,O.ID_SINAV
					,B.ID_SINAVDERS
					,DERSAD				= D.TAKMAAD
					,PUANTURU			= ISNULL( T.AD,'') 
					,ID_SINAVPUANTURU	= ISNULL( T.ID_SINAVPUANTURU,0) 
					,SINAVAD			= V.AD 
					,V.SINAVTARIH
					,V.PUANGIZLE
			INTO	#PUAN
			FROM		SinavOgrenci			O
			JOIN		SinavOgrenciCevapBolum	B	ON  B.ID_SINAVOGRENCI	= O.ID_SINAVOGRENCI
			JOIN		SinavDers				D	ON  D.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN		Sinav					V	ON  V.ID_SINAV			= O.ID_SINAV
			left JOIN	SinavOgrenciPuan		S	ON  S.ID_SINAV			= O.ID_SINAV
													AND S.TCKIMLIKNO		= O.TCKIMLIKNO
			left JOIN	SinavPuanTuru			T	ON	T.ID_SINAVPUANTURU	= S.ID_SINAVPUANTURU
			WHERE	v.AKTIF			= 1		
				AND v.DURUM			= 2	
				AND O.TCKIMLIKNO	= @TC_OGRENCI
				AND V.ID_SINAVTURU	= @ID_SINAVTURU
				AND V.DONEM			= @DONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)

			SELECT DERSAD,KOD,KONUAD,0 AS BOLUMYUZDE,TOPLAMSORU,ISNULL(max([D]),0) DOGRU,ISNULL(max([Y]),0) YANLIS,ISNULL(max([B]),0) BOS,--ID_SINAV,
			ISNULL( 
				CAST(((100 /
					CAST((
						ISNULL(max([D]),0)+ISNULL(max([Y]),0)+ISNULL(max([B]),0)) AS DECIMAL(11,2) 
					))
					* ISNULL(max([D]),0)
				) AS DECIMAL(11,2)) 
			,0) AS YUZDE
			into #TT
			FROM ( SELECT * FROM #TEMP )AS GTABLO--  WHERE LEN(KOD)<10 )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
			group by DERSAD,KOD,KONUAD,TOPLAMSORU

			select  DERSAD,KOD,KONUAD,BOLUMYUZDE,TOPLAMSORU,DOGRU,YANLIS,BOS--,ID_SINAV
			,YUZDE, 1 as TIP
			into #T1
			from #TT
	union all			
			SELECT	DERSAD,
					'' as KOD,
					DERSAD AS KONUAD,
					CAST(CAST(SUM(DOGRU) AS DECIMAL(8,2))/CAST(SUM(DOGRU+YANLIS+BOS) AS DECIMAL(8,2)) *100.0 AS DECIMAL(8,2)) AS BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS),
					SUM(DOGRU),
					SUM(YANLIS),
					SUM(BOS),
					CAST(CAST(SUM(DOGRU) AS DECIMAL(8,2))/CAST(SUM(DOGRU+YANLIS+BOS) AS DECIMAL(8,2)) *100.0  AS DECIMAL(8,2)),
					0 as TIP
			FROM #TT 
			GROUP BY DERSAD
									

			select(
				select * from(
					select 
					(
						select * from #T1
						order by DERSAD, TIP, YUZDE desc
						FOR JSON AUTO
					) as t1
					,( 
						SELECT ID_SINAV,SUM(NET) TOPLAMNET,PUAN,ID_SINAVPUANTURU,PUANTURU,SINAVAD,PUANGIZLE FROM #PUAN
						--WHERE PUANGIZLE = 0
						GROUP BY ID_SINAV,ID_SINAVPUANTURU,PUAN,PUANTURU,SINAVAD,SINAVTARIH,PUANGIZLE
						ORDER BY SINAVTARIH DESC
						FOR JSON AUTO
					)as t2
					,(
						SELECT   DERSAD
								,ID_SINAVPUANTURU
								,PUANTURU
								,(SELECT NET, SINAVAD FOR JSON PATH) AS D
						FROM #PUAN
						GROUP BY ID_SINAVDERS, DERSAD, NET, ID_SINAVPUANTURU, PUANTURU, SINAVAD,SINAVTARIH
						ORDER BY SINAVTARIH DESC
						FOR JSON PATH
					) as t3 
				) as tablo FOR JSON AUTO
			) as tt
			 



			
			IF OBJECT_ID('tempdb..#TEMP')	IS NOT NULL		DROP TABLE #TEMP
			IF OBJECT_ID('tempdb..#PUAN')	IS NOT NULL		DROP TABLE #PUAN
			IF OBJECT_ID('tempdb..#TT')		IS NOT NULL		DROP TABLE #TT
			IF OBJECT_ID('tempdb..#T1')		IS NOT NULL		DROP TABLE #T1

		END

		IF @ISLEM = 2	--	SINAV DETAY GETİR
		BEGIN
			SELECT
			(
				SELECT SD.TAKMAAD, SOCB.DOGRU+SOCB.YANLIS+SOCB.BOS AS SORU, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SOCB.NET
				FROM SinavOgrenci SO
				INNER JOIN SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN SinavDers SD ON SD.ID_SINAVDERS = SOCB.ID_SINAVDERS
				WHERE SO.TCKIMLIKNO=@TC_OGRENCI AND SO.ID_SINAV=@ID_SINAV
				GROUP BY SO.TCKIMLIKNO, SD.TAKMAAD, SD.BOLUMNO, SOCB.DOGRU, SOCB.YANLIS, SOCB.BOS, SOCB.NET
				ORDER BY SD.BOLUMNO
				FOR JSON PATH
			) AS J
		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SinavKatilim]...';


GO
ALTER procedure [dbo].[sp_SinavKatilim] 
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMSINAV			char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
 	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL

	--with recompile 
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMSINAV					= @DONEMSINAV		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.[sp_SinavKatilim] @TCKIMLIKNO='32051057542',@OTURUM='FD2297C4-AF4C-42A6-B6A3-7E0510FB7995',@ISLEM=2,@DONEM='2018',@ID_SINAVTURU=0,@ID_KADEME3=0,@ID_SINAVs='[]',@ID_SUBEs='[]',@ID_SINIFs='[]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
	
		DROP TABLE IF EXISTS #Okul
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Sinif
		DROP TABLE IF EXISTS #Genel
		DROP TABLE IF EXISTS ##Katilim
		DROP TABLE IF EXISTS ##Pivots
		DROP TABLE IF EXISTS ##PivotsSinif
		DROP TABLE IF EXISTS ##KatilimSinif
		DROP TABLE IF EXISTS #SinifKatilim
		DROP TABLE IF EXISTS #OkulKatilim
		DROP TABLE IF EXISTS #GenelSinif
		DROP TABLE IF EXISTS #OGRENCILIST




		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		--declare  @sID_SINIFs	varchar(max) = @ID_SINIFs
		--		,@sID_SUBEs		varchar(max) = @ID_SUBEs
		--		,@sID_KADEME3	int			 = @ID_KADEME3	
		--		,@sDONEMSINAV	varchar(max) = @ID_SUBEs	
		--		,@sDONEM		varchar(max) = @ID_SUBEs		
		--		,@sID_SINAVTURU	int			 = @ID_KADEME3		
		--		,@sID_SINAVs			



		IF @ID_SINAVTURU=0 
		BEGIN
			SELECT	top 1 @ID_KADEME3	= S.ID_KADEME3 
					,@DONEMSINAV		= S.DONEM
					,@DONEM				= S.DONEM
					,@ID_SINAVTURU		= S.ID_SINAVTURU
					,@ID_SINAVs			= '['+CAST(S.ID_SINAV AS VARCHAR)+']'
			FROM	Sinav	S
			WHERE	AKTIF=1 
				AND DURUM=2 
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF= 1)
				AND (SELECT COUNT(1) FROM SinavOgrenci SO WHERE SO.ID_SINAV = S.ID_SINAV)>1
			ORDER BY SINAVTARIH DESC
					,ID_SINAV   DESC

			SET @ID_SUBEs ='[]'
			SET @ID_SINIFs ='[]'


			--SELECT @ID_KADEME3,@DONEM,@ID_SINAVTURU,@ID_SINAVs,@ID_SUBEs,@ID_SINIFs
		END
		
			
			
			SELECT DISTINCT O.TCKIMLIKNO
			INTO #OGRENCILIST
			FROM v3OgrenciTum						O 	
			JOIN v3SinifTum							SN	ON	SN.ID_SINIF		= O.ID_SINIF
			JOIN OkyanusDB.DBO.v3SubeGrupSinifTum	T	ON	T.ID_SINIF		= SN.ID_SINIF
			WHERE	(SN.ID_SINIF IN (SELECT VALUE FROM OPENJSON (@ID_SINIFs)) OR @ID_SINIFs = '[]')
				AND (O.ID_SUBE	 IN (SELECT VALUE FROM OPENJSON (@ID_SUBEs))  OR @ID_SUBEs  = '[]')	
				AND O.DONEM = @DONEM
				AND T.ID_KADEME3 = @ID_KADEME3
				
	

		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)
		Declare @Columns3 as varchar(max)
		Declare @Columns4 as varchar(max)
		Declare @Columns5 as varchar(max)
		Declare @Columns6 as varchar(max)
		
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[335,368]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[90,75,153]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18


		-- GENEL OGR SAYISI
		BEGIN


		
		
			SELECT	SNF.ID_SINIF,SNF.AD SINIFAD,SU.ID_SUBE,SU.AD SUBEAD,COUNT(DISTINCT O.TCKIMLIKNO) OGRSAY
			INTO	#Sinif
			FROM	v3OgrenciTum						O
			JOIN	#OGRENCILIST						OL	ON	OL.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN	v3SinifTum							SNF	ON	SNF.ID_SINIF	= O.ID_SINIF 
			JOIN	V3DONEM								D	ON	D.ID_DONEM		= SNF.ID_DONEM
			JOIN	v3Sube								SU	ON	SU.ID_SUBE		= O.ID_SUBE
			JOIN	OKYANUSDB.DBO.v3SubeGrupSinifTum	SG	ON	SG.ID_SINIF		= SNF.ID_SINIF
			WHERE	D.KOD			= @DONEM				
			GROUP BY SNF.ID_SINIF,SNF.AD,SU.ID_SUBE,SU.AD



			SELECT	 ID_SUBE,SUBEAD,SUM(OGRSAY) OGRSAY
			INTO	#Okul
			FROM	#Sinif 
			GROUP BY ID_SUBE,SUBEAD
		
		END
		
		
		SELECT SO.TCKIMLIKNO,YO.ID_SUBE,YO.ID_SINIF,S.ID_SINAV,S.AD SINAVAD,S.SINAVTARIH
		INTO	#Temp
		FROM	Sinav				S
		JOIN	SinavOgrenci		SO	ON	S.ID_SINAV		= SO.ID_SINAV
		JOIN	v3OgrenciTum		O	ON	O.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN	V3DONEM				D	ON	D.ID_DONEM		= O.ID_DONEM
		JOIN	v3OgrenciTum		YO	ON	YO.TCKIMLIKNO	= O.TCKIMLIKNO AND YO.DONEM = @DONEM
		JOIN	OKYANUSDB.DBO.v3SubeGrupSinifTum	T	ON	T.ID_SINIF	= O.ID_SINIF
														AND T.ID_KADEME3= S.ID_KADEME3
		WHERE	S.ID_SINAVTURU	=	@ID_SINAVTURU
			AND S.DONEM			=	@DONEMSINAV
			AND (O.ID_SUBE		IN	(SELECT Value FROM OPENJSON(@ID_SUBEs))  OR @ID_SUBEs ='[]')
			AND (S.ID_SINAV		IN	(SELECT Value FROM OPENJSON(@ID_SINAVs)) OR @ID_SINAVs='[]')			
		GROUP BY SO.TCKIMLIKNO,YO.ID_SUBE,YO.ID_SINIF,S.ID_SINAV,S.AD,S.SINAVTARIH


		SELECT ID_SINIF,ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH,COUNT(1) SINIFKATILIM 
		INTO #SinifKatilim
		FROM #Temp
		GROUP BY ID_SINIF,ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH

		
		SELECT ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH,COUNT(1) OKULKATILIM 
		INTO #OkulKatilim
		FROM #Temp
		GROUP BY ID_SUBE,ID_SINAV,SINAVAD, SINAVTARIH

		--SELECT * FROM #SinifKatilim
		--SELECT * FROM #OkulKatilim


		SELECT	O.SUBEAD, OK.ID_SUBE, ID_SINAV, SINAVAD, SINAVTARIH, O.OGRSAY, OK.OKULKATILIM,OGRSAY-OKULKATILIM KATILMAYAN,OKULKATILIM KATILAN, CAST((CAST(OKULKATILIM AS decimal(8,2)) / OGRSAY) * 100 AS decimal(8,2))  YUZDE
		INTO	#Genel
		FROM	#OkulKatilim	OK
		JOIN	#Okul			O	ON	O.ID_SUBE=OK.ID_SUBE
		
		SELECT	S.SINIFAD, SK.ID_SINIF, S.SUBEAD, ID_SINAV, SINAVAD, SINAVTARIH, S.OGRSAY, SK.SINIFKATILIM,OGRSAY-SINIFKATILIM KATILMAYAN,SINIFKATILIM KATILAN, CAST((CAST(SINIFKATILIM AS decimal(8,2)) / OGRSAY) * 100 AS decimal(8,2))  YUZDE
		INTO	#GenelSinif
		FROM	#SinifKatilim	SK
		JOIN	#Sinif			S	ON	S.ID_SINIF=SK.ID_SINIF


			--Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			--from 
			--	( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			--order by b.SINAVTARIH
			
			--Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX(P.'+QUOTENAME(SINAVAD)+')AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			--from 
			--	( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			--order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(MAX(P2.'+QUOTENAME(ID_SINAV)+'),0) AS ' +QUOTENAME(ID_SINAV) 
			from 
				( Select distinct ID_SINAV,SINAVTARIH from #Temp  ) as b 				
			ORDER BY SINAVTARIH 

			Select @Columns4=Coalesce(@Columns4+',','')+QUOTENAME(ID_SINAV) 
			from 
				( Select distinct ID_SINAV,SINAVTARIH from #Temp  ) as b 
			ORDER BY SINAVTARIH 
			
			Select @Columns5=Coalesce(@Columns5+',','')+'SUM('+QUOTENAME(ID_SINAV) +') AS ' +QUOTENAME(ID_SINAV) 
				+',CAST(CAST(SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/ SUM(OGRSAY)*100.0 AS DECIMAL(8,2)) AS YUZDEKATILAN'+CAST(ID_SINAV AS VARCHAR)
				+',CAST(CAST(SUM(OGRSAY)-SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/ SUM(OGRSAY)*100.0 AS DECIMAL(8,2)) AS YUZDEKATILMAYAN'+CAST(ID_SINAV AS VARCHAR)
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH

			Select @Columns6=Coalesce(@Columns6+',','')+'SUM('+QUOTENAME(ID_SINAV) +') AS '+QUOTENAME(ID_SINAV) +' ,CAST(CAST(SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/OGRSAY*100.0 AS DECIMAL(8,2)) AS YUZDEKATILAN'+CAST(ID_SINAV AS VARCHAR)
						+',CAST(CAST(sum(OGRSAY)-SUM('+QUOTENAME(ID_SINAV) +') AS DECIMAL(8,2))/sum(OGRSAY)*100.0 AS DECIMAL(8,2)) AS YUZDEKATILMAYAN'+CAST(ID_SINAV AS VARCHAR)
			from 
				( Select distinct ID_SINAV,SINAVTARIH from #Temp  ) as b 
			ORDER BY SINAVTARIH 

			--Select @Columns5=Coalesce(@Columns5+',','')+'SUM('+QUOTENAME(ID_SINAV) +') AS ' +QUOTENAME(ID_SINAV) 
			--from 
			--	( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			--order by b.SINAVTARIH



		IF NOT EXISTS (SELECT * FROM #Temp)
		BEGIN
		print 11
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##Pivots
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##Katilim
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##PivotsSinif
			SELECT SIRA=NULL,SUBEAD=NULL, OGRSAY=NULL INTO ##KatilimSinif
		END			

		Set @SQL='	
		
			Select 								 
				0 SIRA,SUBEAD,OGRSAY, 
				'+@Columns3+' 
			into ##Pivots
			from (
				Select 
					SUBEAD,ID_SUBE, ID_SINAV, SINAVAD, SINAVTARIH, OGRSAY, OKULKATILIM, KATILMAYAN, KATILAN,YUZDE
				from #Genel
			) AS S			
			PIVOT (MAX(KATILAN) FOR ID_SINAV IN('+@Columns4+')) as P2
			GROUP BY SUBEAD,ID_SUBE,OGRSAY


		
			SELECT SIRA,SUBEAD,OGRSAY,'+@Columns6+' INTO ##Katilim FROM ##Pivots
			group by SIRA,SUBEAD,OGRSAY
		UNION ALL	
			SELECT 1 SIRA,''GENEL'' SUBEAD,SUM(OGRSAY) OGRSAY,'+@Columns5+' FROM ##Pivots			
		ORDER BY SIRA,SUBEAD
		
		

			Select 								 
				0 SIRA,SINIFAD,OGRSAY,ID_SINIF,SUBEAD, 
				'+@Columns3+' 
			into ##PivotsSinif
			from (
				Select 
					SINIFAD,ID_SINIF, ID_SINAV, SINAVAD, SINAVTARIH, OGRSAY, SINIFKATILIM, KATILMAYAN, KATILAN,YUZDE,SUBEAD
				from #GenelSinif
			) AS S			
			PIVOT (MAX(KATILAN) FOR ID_SINAV IN('+@Columns4+')) as P2
			GROUP BY SINIFAD,ID_SINIF,OGRSAY,SUBEAD

			
			SELECT SIRA,SUBEAD = ''(''+SUBEAD+'') ''+SINIFAD ,OGRSAY,ID_SINIF,'+@Columns6+' INTO ##KatilimSinif FROM ##PivotsSinif
			group by SIRA,SINIFAD,OGRSAY,ID_SINIF,SUBEAD	
			
		UNION ALL	
			SELECT 1 SIRA,''GENEL'' SUBEAD,SUM(OGRSAY) OGRSAY,0,'+@Columns5+' FROM ##PivotsSinif			
			

	
		'
		PRINT @SQL
		EXEC (@SQL)
		
--		exec dbo.[sp_SinavKatilim] @TCKIMLIKNO='32051057542',@OTURUM='6807E433-4AC5-4F31-9EA2-0117900ACB29',@ISLEM=2,@DONEM='2017',@ID_SINAVTURU=2,@ID_KADEME3=18,@ID_SINAVs='[164]',@ID_SUBEs='[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]',@ID_SINIFs='[0,102208,102207,102293,104343,101677,101671,101679,101672,101676,101680,101926,101927,101924,101925,101873,101875,101435,101434,101709,101710,101707,101708,101826,102174,101497,101498,101417,101419,101613,101615,101614,101861,104756,101860,101867,100987,105219,105416,105417,102307,102306,102087,102086,102147,102146,104554,101943,101525,101526,104673,104676]'

		--SELECT * FROM ##Katilim

		--SELECT DISTINCT ID_SINAV,SINAVAD,SINAVTARIH FROM #Temp ORDER BY SINAVTARIH
			SELECT DISTINCT T.ID_SINAV,SINAVAD,T.SINAVTARIH,UPPER(K.AD) KADEME3, UPPER(ST.AD) SINAVTURU
		INTO #Temp2
		FROM #Temp		T
		JOIN Sinav		S	ON	S.ID_SINAV		= T.ID_SINAV
		JOIN v3Kademe3	K	ON	K.ID_KADEME3	= S.ID_KADEME3
		JOIN SinavTuru	ST	ON	ST.ID_SINAVTURU	= S.ID_SINAVTURU
		ORDER BY T.SINAVTARIH

		IF @ISLEM = 1
		BEGIN

		 select(
				select * from(
						select 
						(					
							SELECT		*
							FROM		##Katilim 
							FOR JSON AUTO
						) as t1,
						(					
							SELECT DISTINCT ID_SINAV,SINAVAD,SINAVTARIH,KADEME3,SINAVTURU FROM #Temp2
							ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t2,
						(					
							SELECT		*
							FROM		##KatilimSinif 	
							ORDER BY SIRA,SUBEAD
							FOR JSON AUTO
						) as t3		
					) as tablo FOR JSON AUTO
				) as tt
		END
		IF @ISLEM = 2
		BEGIN
			SELECT * FROM ##Katilim 

			SELECT DISTINCT ID_SINAV,SINAVAD,SINAVTARIH,KADEME3,SINAVTURU FROM #Temp2
			ORDER BY SINAVTARIH

			SELECT * FROM ##KatilimSinif
			ORDER BY SIRA,SUBEAD
		END

		
		DROP TABLE IF EXISTS #Okul
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Sinif
		DROP TABLE IF EXISTS #Genel
		DROP TABLE IF EXISTS ##Katilim
		DROP TABLE IF EXISTS ##Pivots
		DROP TABLE IF EXISTS ##PivotsSinif
		DROP TABLE IF EXISTS ##KatilimSinif
		DROP TABLE IF EXISTS #SinifKatilim
		DROP TABLE IF EXISTS #OkulKatilim
		DROP TABLE IF EXISTS #GenelSinif
		DROP TABLE IF EXISTS #OGRENCILIST


	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SinavKonuAnalizi]...';


GO
ALTER procedure [dbo].[sp_SinavKonuAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@GRUPLAMATURU		INT				= 1
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,SQLJSON					= @SQLJSON		
			,DONEM						= @DONEM			
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,GRUPLAMATURU				= @GRUPLAMATURU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )

		IF (@ISLEM = 1 OR @ISLEM = 2)  -- SINIF
		BEGIN
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #DERS			
			
			SELECT DERSAD INTO #DERS 
			from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'

			
			SELECT	S.ID_SINAV
					,S.AD SINAVAD
					,SINAVTARIH		= CONVERT(VARCHAR,SINAVTARIH,103) 
					,SO.TCKIMLIKNO
					,O.ID_SINIF
					,SINIFAD		= SN.AD 
					,VD.ID_DERS
					,VD.DERSAD 
					,NET
					,DOGRU
					,YANLIS
					,BOS
					,O.ID_SUBE
					,SUBEAD			= SU.AD 
					,OC.DURUM
					,OGRENCICEVAP	= OC.CEVAP 
					,DOGRUCEVAP		= SA.CEVAP 
					,KOD			= CASE	WHEN @GRUPLAMATURU = 1 THEN ISNULL(SA.KOD,'') 
											WHEN @GRUPLAMATURU = 2 THEN SUBSTRING(SA.KOD, 1, 9) 
											WHEN @GRUPLAMATURU = 3 THEN SUBSTRING(SA.KOD, 1, 6) 
										ELSE '' END
					,KAZANIM		= CASE	WHEN @GRUPLAMATURU = 1 THEN U.AD 
										ELSE '' END
					,KONU			= CASE	WHEN @GRUPLAMATURU = 1 OR @GRUPLAMATURU = 2 THEN (SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 9)) 
										ELSE '' END 
					,UNITE			= (SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 6))
					,SA.SORUNO_A
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			INNER JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			INNER JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
			INNER JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
			INNER JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
			INNER JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI
			INNER JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			INNER JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			INNER JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			INNER JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM
			INNER JOIN	SinavKitapcik			SK	WITH (NOLOCK)	ON	SK.ID_SINAV						= S.ID_SINAV	
			 														AND	SK.AD							= SO.KITAPCIK 
			INNER JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																	AND SA.SORUNO						= OC.SORUNO
																	AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
																	AND SA.KOD IS NOT NULL AND SA.KOD <> ''
			INNER JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD							= SA.KOD
			WHERE	S.DURUM			=	2
				AND S.AKTIF			=	1
				AND O.DONEM			=	@OGRENCIDONEM
				AND (OZEL = 0		OR	@OZELSINAVGOR=1)				
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		
				
			DROP TABLE IF EXISTS #TEMP
			SELECT KOD, KONU, UNITE, KAZANIM, DURUM, COUNT(DURUM) DURUMSAYISI, 0 KISISAYISI, (SELECT COUNT(DISTINCT CONCAT_WS('-',SORUNO_A,ID_SINAV)) FROM #TEMP_SINIF S WHERE S.KOD=T.KOD) SORUSAYISI, DERSAD
			INTO #TEMP
			FROM #TEMP_SINIF T
			GROUP BY KOD, KONU, UNITE, KAZANIM, DURUM, DERSAD

			UPDATE T
			SET KISISAYISI = (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.KOD=T.KOD)
			FROM #TEMP T
				

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 
						(					
							SELECT KOD, KONU, KAZANIM, UNITE, SORUSAYISI, DERSAD
							,DOGRUYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND G.KOD = T.KOD AND DURUM = 'D'),0.00)
							,YANLISYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND G.KOD = T.KOD AND DURUM = 'Y'),0.00)
							,BOSYUZDESI		= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND G.KOD = T.KOD AND DURUM = 'B'),0.00)
							FROM #TEMP T
							GROUP BY KONU, KAZANIM, KOD, UNITE, SORUSAYISI, DERSAD--,ID_SUBE,SUBEAD
							ORDER BY DERSAD, UNITE, KONU, KAZANIM
							FOR JSON AUTO,INCLUDE_NULL_VALUES
						) as TblVeri,					
						(		
							SELECT DISTINCT DERSAD
							FROM #TEMP_SINIF
							ORDER BY DERSAD
							FOR JSON AUTO
						) as TblDersList,			
						(		
							SELECT DISTINCT ID_SINAV, SINAVAD, SINAVTARIH
							FROM #TEMP_SINIF
							ORDER BY ID_SINAV DESC
							FOR JSON AUTO
						) as TblSinavList
						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE
			BEGIN
				SELECT KOD, KONU, KAZANIM, UNITE, SORUSAYISI, DERSAD
					,DOGRUYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND  G.KOD = T.KOD AND DURUM = 'D'),0.00)
					,YANLISYUZDESI	= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND  G.KOD = T.KOD AND DURUM = 'Y'),0.00)
					,BOSYUZDESI		= ISNULL((SELECT CONVERT(DECIMAL(8,2),CONVERT(DECIMAL(8,2),DURUMSAYISI) / CONVERT(DECIMAL(8,2),KISISAYISI) * 100.0) FROM #TEMP G WHERE G.DERSAD = T.DERSAD AND  G.KOD = T.KOD AND DURUM = 'B'),0.00)
				FROM #TEMP T
				GROUP BY KAZANIM, UNITE, KOD, KONU, SORUSAYISI, DERSAD--,ID_SUBE,SUBEAD
				ORDER BY DERSAD, UNITE, KONU, KAZANIM
								
				SELECT DISTINCT DERSAD
				FROM #TEMP_SINIF
				ORDER BY DERSAD

				SELECT DISTINCT ID_SINAV, SINAVAD, SINAVTARIH
				FROM #TEMP_SINIF
				ORDER BY ID_SINAV DESC
			END
			
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #DERS
		END			
	END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_SinavListele]...';


GO
ALTER procedure [dbo].[sp_SinavListele]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@SORUNO				INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SORUISLEM		INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@ID_SINAVANAHTAR	int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,	
	@OGRENCICEVAP		NVARCHAR(MAX)	= NULL,	
	@ID_SINAVOGRENCI	INT				= NULL,
	@OGR_AD				VARCHAR(MAX)	= NULL,
	@OGR_SOYAD			VARCHAR(MAX)	= NULL,
	@SUBENO				VARCHAR(MAX)	= NULL,
	@SUBEAD				VARCHAR(MAX)	= NULL,
	@SINIF				VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_SINAVDERS				= @ID_SINAVDERS	
			,SORUNO						= @SORUNO			
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SORUISLEM				= @ID_SORUISLEM	
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,ID_SINAVANAHTAR			= @ID_SINAVANAHTAR
			,SQLJSON					= @SQLJSON		
			,OGRENCICEVAP				= @OGRENCICEVAP	
			,ID_SINAVOGRENCI			= @ID_SINAVOGRENCI
			,OGR_AD						= @OGR_AD			
			,OGR_SOYAD					= @OGR_SOYAD		
			,SUBENO						= @SUBENO			
			,SUBEAD						= @SUBEAD			
			,SINIF						= @SINIF			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		IF @ISLEM = 1 -- Eşleşmeyen öğrenci listesi		
		BEGIN
			SELECT		ID_SINAVOGRENCI,TCKIMLIKNO,SO.AD,SOYAD, SO.SUBENO,ISNULL(VS.AD,'') SUBEAD,SINIF
			INTO		#T1
			FROM		SinavOgrenci	SO
			LEFT JOIN	V3SUBE			VS ON SO.SUBENO=RIGHT ('000' + VS.SUBENO,3)
			WHERE	TCKIMLIKNO NOT IN 
						( SELECT DISTINCT TCKIMLIKNO FROM v3Ogrenci )
				AND	ID_SINAV=@ID_SINAV 
				
			SELECT  VK.TCKIMLIKNO,VK.AD,VK.SOYAD,RIGHT('000'+ VS.SUBENO,3)SUBENO,VS.AD SUBEAD,VSN.AD SINIF
			INTO	#T2
			FROM	V3Ogrenci			VO
			JOIN	V3Kullanici			VK	ON	VK.TCKIMLIKNO=VO.TCKIMLIKNO
			JOIN	V3SUBE				VS	ON	VS.ID_SUBE=VO.ID_SUBE
			JOIN	V3Sinif				VSN	ON	VSN.ID_SINIF=VO.ID_SINIF
			JOIN	v3KullaniciKademe3	VKK	ON	VKK.TCKIMLIKNO=VO.TCKIMLIKNO
			WHERE	ID_KADEME3=@ID_KADEME3


			select(
				select * from(
					select 
					(
						select * from #T1
						order by AD
						FOR JSON AUTO
					) as t1,
					(
						select * from #T2
						order by SUBENO,SUBEAD,SINIF,AD,SOYAD
						FOR JSON AUTO
					) as t2					
				) as tablo FOR JSON AUTO
			) as tt
		END
		IF @ISLEM = 2 -- sınavogrenci eşleştir			
		BEGIN
			
			UPDATE		 SO 
			SET 
						 AD			= KL.AD
						,SOYAD		= KL.SOYAD
						,SINIF		= SN.AD
						,SUBENO		= RIGHT('000' + SB.SUBENO, 3)
						,TCKIMLIKNO	= KL.TCKIMLIKNO			
			FROM		SinavOgrenci			SO
			INNER JOIN	v3Kullanici		KL	ON	KL.TCKIMLIKNO	= @TC_OGRENCI
			INNER JOIN	v3Ogrenci		KS	ON	KS.TCKIMLIKNO	= KL.TCKIMLIKNO
			INNER JOIN	v3Sinif			SN	ON	SN.ID_SINIF		= KS.ID_SINIF
			INNER JOIN	v3Sube			SB	ON	SB.ID_SUBE		= KS.ID_SUBE
			WHERE SO.ID_SINAVOGRENCI	=	@ID_SINAVOGRENCI
			
			-- IN (select ID_SINAVOGRENCI FROM SinavOgrenci WHERE ID_SINAV=@ID_SINAV)	
			
			--select(
			--	select * from(
			--		select 
			--		(
			--			select 1
			--			FOR JSON AUTO
			--		) as t1					
			--	) as tablo FOR JSON AUTO
			--) as tt
		END
		IF @ISLEM = 3 -- Sınav Kopyala					
		BEGIN
			declare @ID_SINAV_NEW INT --,@ID_SINAV int =43,@DONEM VARCHAR(4),@TCKIMLIKNO VARCHAR(11)='56545519606'
			SELECT @DONEM=DONEM FROM V3AktifDonem WHERE AKTIF=1

			-- SINAV INSERT
			DECLARE @ID_SINAVLIST TABLE (ID_SINAV int)
			insert into Sinav (ID_SINAVTURU,AD,KOD,DONEM,ID_KADEME3,SINAVTARIH,OZEL,FREKANSHESAPLA,PUANGIZLE,YUKLEMEKAPAT,YANLISSAYISI,OLCEKSINAVI,DURUM,KYE_TCKIMLIKNO,KYE_TARIH,AKTIF,ONLINESINAV)
			OUTPUT INSERTED.ID_SINAV INTO @ID_SINAVLIST(ID_SINAV)
			SELECT TOP 1
				ID_SINAVTURU,AD+'('+@DONEM+') Kopya',KOD+'('+@DONEM+') Kopya',@DONEM,ID_KADEME3,CAST(GETDATE() AS date),OZEL,FREKANSHESAPLA,PUANGIZLE,YUKLEMEKAPAT,YANLISSAYISI,OLCEKSINAVI,0,@TCKIMLIKNO,CAST(GETDATE() AS date),AKTIF,ONLINESINAV
			FROM Sinav where ID_SINAV=@ID_SINAV

			SET @ID_SINAV_NEW=(SELECT TOP 1 ID_SINAV FROM @ID_SINAVLIST)

			-- SINAVDERS INSERT
			INSERT INTO SinavDers (ID_SINAV,BOLUMNO,ID_DERS,TAKMAAD)
			SELECT @ID_SINAV_NEW,BOLUMNO,ID_DERS,TAKMAAD FROM SinavDers WHERE ID_SINAV=@ID_SINAV
			
			SELECT S.ID_SINAVDERS ESKIID,SD.ID_SINAVDERS YENIID 
			INTO #SINAVDERS
			FROM SinavDers	S
			JOIN SinavDers	SD	ON	SD.TAKMAAD	= S.TAKMAAD
								AND SD.ID_SINAV	= @ID_SINAV_NEW
			WHERE S.ID_SINAV	=	@ID_SINAV 

			-- KATSAYI INSERT
			INSERT INTO SinavKatsayi (ID_SINAV,ID_SINAVPUANTURU,ID_SINAVDERS,KATSAYI)
			SELECT @ID_SINAV_NEW,ID_SINAVPUANTURU,SD.YENIID,KATSAYI 
			FROM SinavKatsayi SK
			JOIN #SINAVDERS			SD	ON	SD.ESKIID=SK.ID_SINAVDERS
			WHERE ID_SINAV=@ID_SINAV

			-- SINAVNETKRITER INSERT
			DECLARE @ID_SINAVNETKRITERTABLE TABLE (ID_SINAVNETKRITER INT, ESKIID INT)

			MERGE INTO SinavNetKriter 
			USING 
			(
				SELECT DISTINCT SK.ID_SINAVNETKRITER, SK.ID_SINAVPUANTURU, SK.NET
				FROM SinavNetKriter SK
				JOIN SinavNetKriterDers SKD ON SKD.ID_SINAVNETKRITER = SK.ID_SINAVNETKRITER
				JOIN #SINAVDERS			SD	ON SD.ESKIID = SKD.ID_SINAVDERS
			)
			AS TEMP ON 1 = 0
			WHEN NOT MATCHED THEN
			INSERT ([NET] ,[ID_SINAVPUANTURU])
			VALUES (TEMP.NET, TEMP.ID_SINAVPUANTURU)
			OUTPUT TEMP.ID_SINAVNETKRITER AS ESKIID, inserted.ID_SINAVNETKRITER
			INTO @ID_SINAVNETKRITERTABLE (ESKIID, ID_SINAVNETKRITER);

			INSERT INTO SinavNetKriterDers (ID_SINAVDERS, ID_SINAVNETKRITER)
			SELECT SD.YENIID, T.ID_SINAVNETKRITER
			FROM @ID_SINAVNETKRITERTABLE T
			JOIN SinavNetKriterDers ESKD	ON ESKD.ID_SINAVNETKRITER = T.ESKIID
			JOIN #SINAVDERS			SD		ON SD.ESKIID = ESKD.ID_SINAVDERS

			--SINAVKITAPCIK INSERT
			INSERT INTO SinavKitapcik (ID_SINAV,AD)
			SELECT @ID_SINAV_NEW,AD FROM SinavKitapcik WHERE ID_SINAV=@ID_SINAV

			-- SINAVANAHTAR INSERT
			INSERT INTO SinavAnahtar (ID_SINAVKITAPCIK,ID_SINAVDERS,ID_SINAVSORUTURU,SORUNO_A,CEVAP,OPTIKKARAKTERSAYISI,KOD,KATSAYI,SORUNO,ID_BILGI,ID_BILISSELSUREC,ID_SORUBANKASI)
			SELECT SKK.ID_SINAVKITAPCIK,SD.YENIID,ID_SINAVSORUTURU,SORUNO_A,CEVAP,OPTIKKARAKTERSAYISI,KOD,KATSAYI,SORUNO,ID_BILGI,ID_BILISSELSUREC,ID_SORUBANKASI
			FROM SinavAnahtar	SA
			JOIN #SINAVDERS		SD	ON	SD.ESKIID=SA.ID_SINAVDERS
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK=SA.ID_SINAVKITAPCIK
			JOIN SinavKitapcik	SKK	ON	SKK.AD=SK.AD
									AND SKK.ID_SINAV=@ID_SINAV_NEW
			where SA.ID_SINAVDERS in (SELECT ID_SINAVDERS FROM SinavDers where ID_SINAV=@ID_SINAV )

			-- SONAVOPTIK INSERT
			INSERT INTO SinavOptikSabit (ID_SINAV,ID_SINAVOPTIK,BASLANGIC,OPTIKKARAKTERSAYISI)
			SELECT @ID_SINAV_NEW,ID_SINAVOPTIK,BASLANGIC,OPTIKKARAKTERSAYISI FROM SinavOptikSabit WHERE ID_SINAV=@ID_SINAV

			-- SINAVOPTIKDERS INSERT
			INSERT INTO SinavOptikDers (ID_SINAVDERS,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM)
			SELECT SD.YENIID,BASLANGIC,OPTIKKARAKTERSAYISI,OTURUM
			FROM SinavOptikDers		SOD
			JOIN #SINAVDERS			SD	ON	SD.ESKIID=SOD.ID_SINAVDERS
			
			--SINAVTABANPUAN INSERT
			INSERT INTO SinavTabanPuan (ID_SINAV,ID_SINAVPUANTURU,TABANPUAN)
			SELECT @ID_SINAV_NEW,ID_SINAVPUANTURU,TABANPUAN FROM SinavTabanPuan WHERE ID_SINAV=@ID_SINAV
						
			DROP TABLE IF EXISTS #SINAVDERS

			SELECT @ID_SINAV_NEW

		END
		IF @ISLEM = 4 -- SINAV BILGILERINI GETIR		
		BEGIN 
			SELECT ID_SINAV,AD,KOD,ID_KADEME3,ID_SINAVTURU FROM Sinav WHERE ID_SINAV=@ID_SINAV
		END
		IF @ISLEM = 5 -- SORU ISLEM BİLGİLERİ LISTELE	
		BEGIN 
			
			select(
				select * from(
					select 
					(
						SELECT ID_SORUISLEM,ACIKLAMA FROM SoruIslem
						FOR JSON AUTO
					) as t1		
				) as tablo FOR JSON AUTO
			) as tt
		END
		IF @ISLEM = 6 -- SINAV SORU ISLEM				
		BEGIN 
			UPDATE	Sinav
			SET		DURUM=0
			WHERE	ID_SINAV=(
					SELECT DISTINCT ID_SINAV 
					FROM	SinavAnahtar	SA	
					JOIN	SinavDers		SD	ON	SD.ID_SINAVDERS= SA.ID_SINAVDERS
					WHERE	SA.ID_SINAVDERS=@ID_SINAVDERS
				)


			IF @ID_SORUISLEM=3
			BEGIN
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) (				 
					--SELECT
					--	(SELECT	TOP 1 ID_SINAVANAHTAR
					--	FROM	SinavAnahtar	SA	
					--	JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
					--								--AND SK.AD				= 'A'
					--	WHERE	SA.ID_SINAVDERS	=	@ID_SINAVDERS
					--		AND SA.SORUNO_A		=	@SORUNO)
					--	,@ID_SORUISLEM
					--	,VALUE 
					--FROM OPENJSON(@OGRENCICEVAP)

					SELECT SA.ID_SINAVANAHTAR						
						,@ID_SORUISLEM
						,VALUE 
					FROM OPENJSON(@OGRENCICEVAP)
					JOIN SinavAnahtar		SA	ON	1	= 1
					JOIN SinavKitapcik		SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
					WHERE	SA.ID_SINAVDERS	=	@ID_SINAVDERS
						AND SA.SORUNO_A		=	@SORUNO
				)	
			END		
			ELSE
			BEGIN
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) (
						SELECT  ID_SINAVANAHTAR,@ID_SORUISLEM,NULL
						FROM	SinavAnahtar	SA	
						JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
													--AND SK.AD				= 'A'
						WHERE	SA.ID_SINAVDERS	=	@ID_SINAVDERS
							AND SA.SORUNO_A		=	@SORUNO
				)	
			END
		END
		IF @ISLEM = 7 -- SORU ISLEM LISTELE				
		BEGIN 
			
			select(
				select * from(
					select 
					(
					SELECT * FROM (
						SELECT  DISTINCT SSI.ID_SINAVANAHTAR,SK.ID_SINAV,SORUNO,SI.ACIKLAMA ISLEM,TAKMAAD--,*
						FROM	SinavAnahtar	SA	
						JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
						JOIN	SinavDers		SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
						JOIN	SinavSoruIslem	SSI	ON	SSI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						JOIN	SoruIslem		SI	ON	SI.ID_SORUISLEM		= SSI.ID_SORUISLEM	
						WHERE	SK.ID_SINAV	=	@ID_SINAV
							AND SK.AD='A') AS TABLO
						FOR JSON AUTO
					) as t1		
				) as tablo FOR JSON AUTO
			) as tt
		END
		IF @ISLEM = 8 -- SORU ISLEM SİL					
		BEGIN 			
			
			DELETE FROM SinavSoruIslem 
			WHERE ID_SINAVANAHTAR IN (
				SELECT ASA.ID_SINAVANAHTAR 
				FROM SinavAnahtar	SA 
				JOIN SinavAnahtar	ASA	ON	ASA.ID_SINAVDERS=SA.ID_SINAVDERS
										AND ASA.SORUNO_A=SA.SORUNO_A
			WHERE SA.ID_SINAVANAHTAR=@ID_SINAVANAHTAR)

			select(
				select * from(
					select 
					(
					SELECT * FROM (
						SELECT  DISTINCT SSI.ID_SINAVANAHTAR,SK.ID_SINAV,SORUNO,TAKMAAD
						,case 
							when SI.ID_SORUISLEM=3
								then 'Bu soru bütün sınavda '+
								substring(
								(SELECT distinct ',' + QUOTENAME(c.OGRENCICEVAP) 
																FROM SinavSoruIslem c
																where ID_SINAVANAHTAR=SSI.ID_SINAVANAHTAR and ID_SORUISLEM=3
																FOR XML PATH(''))
															,2,1000)
								+' şıkları seçenler için DOĞRU olsun.'
							else SI.ACIKLAMA
							end ISLEM
						FROM	SinavAnahtar	SA	
						JOIN	SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
						JOIN	SinavDers		SD	ON	SD.ID_SINAVDERS		= SA.ID_SINAVDERS
						JOIN	SinavSoruIslem	SSI	ON	SSI.ID_SINAVANAHTAR = SA.ID_SINAVANAHTAR
						JOIN	SoruIslem		SI	ON	SI.ID_SORUISLEM		= SSI.ID_SORUISLEM	
						WHERE	SK.ID_SINAV	=	@ID_SINAV
							AND SK.AD='A') AS TABLO
						FOR JSON AUTO
					) as t1		
				) as tablo FOR JSON AUTO
			) as tt

		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SinavSonuclari]...';


GO
ALTER procedure [dbo].[sp_SinavSonuclari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	 

	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

	IF @ID_LOG<1
	BEGIN
		IF EXISTS(SELECT TOP 1 1 FROM DisOgrenci WHERE TCKIMLIKNO=@TC_OGRENCI)
			BEGIN
				SET @ID_LOG=2
			END
	END
	IF @ID_LOG > 1
	BEGIN
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 * FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
						
		IF (@ISLEM = 1 OR @ISLEM = 2)	--	SINAV SONUÇLARI
		BEGIN
						
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5

			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #KONU
			
			DECLARE @GENEL INT = 999

			SELECT @ID_SINIF=ID_SINIF,@ID_SUBE=ID_SUBE FROM v3Ogrenci WHERE TCKIMLIKNO =@TC_OGRENCI		
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TC_OGRENCI)
			BEGIN
				SELECT  distinct 
					 SOT.TCKIMLIKNO
					,DO.AD+' '+DO.SOYAD ADSOYAD
					,K.AD AS SINIF
					--,SS.SUBEAD
					,'' AS SUBEAD
					,S.AD SINAVAD
					,CONVERT(VARCHAR, S.SINAVTARIH ,105) SINAVTARIH
					,(SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR)	FROM SinavOgrenci K WITH(NOLOCK) WHERE K.TCKIMLIKNO = SOT.TCKIMLIKNO and k.ID_SINAV = s.ID_SINAV FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
					,OP.PUAN
					,PT.KOD PUANTURU
					--,UPPER(ST.KISAAD+' SINAV SONUÇ BELGESİ') AS SINAVTURU
					,UPPER(S.RAPORBASLIK) AS SINAVTURU
					--,UPPER(ST.AD) AS SINAVTURUUZUN
					,'Testlerdeki Doğru ve Yanlış Sayıları' AS SINAVTURUUZUN
					,ST.ID_SINAVTURU
					,VD.ACIKLAMA DONEM
					,OP.SINIFSIRA,OP.OKULSIRA,OP.ILCESIRA,OP.ILSIRA,OP.GENELSIRA
					,S.PUANGIZLE
					,SINIFKATILIM	= SOT.KATILIM_SINIF
					,SUBEKATILIM	= SOT.KATILIM_OKUL
					,ILCEKATILIM	= SOT.KATILIM_ILCE
					,ILKATILIM		= SOT.KATILIM_IL
					,GENELKATILIM	= SOT.KATILIM_GENEL
					,ISNULL(PT.ID_SINAVPUANTURU,0) ID_SINAVPUANTURU
					,ID_KADEME = 0

				INTO #T11
				FROM SinavOgrenciToplam			SOT WITH(NOLOCK)
				LEFT JOIN vw_SinavOgrenciPuan	OP  WITH(NOLOCK)	ON	OP.TCKIMLIKNO		= SOT.TCKIMLIKNO AND OP.ID_SINAV = SOT.ID_SINAV
				LEFT JOIN SinavPuanTuru			PT  WITH(NOLOCK)	ON	PT.ID_SINAVPUANTURU	= OP.ID_SINAVPUANTURU
				JOIN Sinav						S   WITH(NOLOCK)	ON	S.ID_SINAV			= SOT.ID_SINAV
				JOIN SinavTuru					ST  WITH(NOLOCK)	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
				JOIN DisOgrenci					DO  WITH(NOLOCK)	ON	DO.TCKIMLIKNO		= SOT.TCKIMLIKNO
				--JOIN vw_SubeSinifGrupKademeTum	SS  WITH(NOLOCK)	ON	SS.ID_KADEME3		= DO.ID_KADEME3
				JOIN v3Kademe3					K	WITH(NOLOCK)	ON	K.ID_KADEME3		= DO.ID_KADEME3
				JOIN v3AktifDonem				VD  WITH(NOLOCK)	ON  VD.DONEM			= S.DONEM
				WHERE	SOT.TCKIMLIKNO	= @TC_OGRENCI
					AND	SOT.ID_SINAV	= @ID_SINAV
			END
			ELSE
			BEGIN
				SELECT  distinct 
				 SOT.TCKIMLIKNO
				,VK.AD+' '+VK.SOYAD ADSOYAD
				,SINIF
				,SS.SUBEAD
				,S.AD SINAVAD
				,CONVERT(VARCHAR, S.SINAVTARIH ,105) SINAVTARIH
				,(SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR)	FROM SinavOgrenci K WITH(NOLOCK) WHERE K.TCKIMLIKNO = SOT.TCKIMLIKNO and k.ID_SINAV = s.ID_SINAV FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
				,OP.PUAN
				,PT.KOD PUANTURU
				--,UPPER(ST.KISAAD+' SINAV SONUÇ BELGESİ') AS SINAVTURU
				,UPPER(S.RAPORBASLIK) AS SINAVTURU
				--,UPPER(ST.AD) AS SINAVTURUUZUN
				,'Testlerdeki Doğru ve Yanlış Sayıları' AS SINAVTURUUZUN
				,ST.ID_SINAVTURU
				,VD.ACIKLAMA DONEM
				,OP.SINIFSIRA,OP.OKULSIRA,OP.ILCESIRA,OP.ILSIRA,OP.GENELSIRA
				,S.PUANGIZLE
				,SINIFKATILIM	= SOT.KATILIM_SINIF
				,SUBEKATILIM	= SOT.KATILIM_OKUL
				,ILCEKATILIM	= SOT.KATILIM_ILCE
				,ILKATILIM		= SOT.KATILIM_IL
				,GENELKATILIM	= SOT.KATILIM_GENEL
				,ISNULL(PT.ID_SINAVPUANTURU,0) ID_SINAVPUANTURU
				,ID_KADEME = SS.ID_KADEME
			INTO #T1
			FROM SinavOgrenciToplam			SOT WITH(NOLOCK)
			LEFT JOIN vw_SinavOgrenciPuan	OP  WITH(NOLOCK)	ON	OP.TCKIMLIKNO		= SOT.TCKIMLIKNO AND OP.ID_SINAV = SOT.ID_SINAV
			LEFT JOIN SinavPuanTuru			PT  WITH(NOLOCK)	ON	PT.ID_SINAVPUANTURU	= OP.ID_SINAVPUANTURU
			JOIN Sinav						S   WITH(NOLOCK)	ON	S.ID_SINAV			= SOT.ID_SINAV
			JOIN SinavTuru					ST  WITH(NOLOCK)	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN v3Kullanici				VK  WITH(NOLOCK)	ON	VK.TCKIMLIKNO		= SOT.TCKIMLIKNO
			JOIN V3Ogrenci					VO  WITH(NOLOCK)	ON	VO.TCKIMLIKNO		= SOT.TCKIMLIKNO
			JOIN vw_SubeSinifGrupKademeTum	SS  WITH(NOLOCK)	ON	SS.ID_SINIF			= VO.ID_SINIF
			JOIN v3AktifDonem				VD  WITH(NOLOCK)	ON  VD.DONEM			= S.DONEM
			WHERE	SOT.TCKIMLIKNO	= @TC_OGRENCI
				AND	SOT.ID_SINAV	= @ID_SINAV
			END
			SELECT 
				 DERSAD					= SD.TAKMAAD
				,TOPLAMSORU				= (SELECT SUM(DOGRU+YANLIS+BOS) FROM vw_SinavOgrenciBolum SB WITH(NOLOCK) WHERE SB.TCKIMLIKNO = B.TCKIMLIKNO	AND SB.ID_SINAVDERS = B.ID_SINAVDERS )
				,DOGRU					= B.DOGRU
				,YANLIS					= B.YANLIS
				,BOS					= B.BOS
				,NET					= B.NET
				,PUAN					= B.PUAN
				,OLCEKSINAVI			= S.OLCEKSINAVI
				,TCKIMLIKNO				= B.TCKIMLIKNO
				,BOLUMNO				= SD.BOLUMNO
				,YUZDENET				= B.YUZDENET
			
				,SINIFNETORTALAMA		= B.NET_SINIFORT
				,SINIFDOGRUORTALAMA		= B.DOGRU_SINIFORT 
				,SINIFYUZDENETORTALAMA	= B.YUZDENET_SINIFORT

				,SUBENETORTALAMA		= B.NET_OKULORT

				,GENELDOGRUORTALAMA		= B.DOGRU_GENELORT
				,GENELNETORTALAMA		= B.NET_GENELORT
				,GENELYUZDENETORTALAMA	= B.YUZDENET_GENELORT
				,YUZDEBASARI			= YUZDENET 
				
				,SINIFSIRA				= B.NET_SINIFSIRA
				,OKULSIRA				= B.NET_OKULSIRA
				,ILCESIRA				= B.NET_ILCESIRA
				,ILSIRA					= B.NET_ILSIRA
				,GENELSIRA				= B.NET_GENELSIRA
			
				,B.ID_SINAV
			INTO #T2 
			FROM vw_SinavOgrenciBolum	B  WITH(NOLOCK)
			JOIN SinavOgrenciToplam		T  WITH(NOLOCK)	ON	T.TCKIMLIKNO		= B.TCKIMLIKNO 
														AND T.ID_SINAV			= B.ID_SINAV
			JOIN Sinav					S  WITH(NOLOCK)	ON	S.ID_SINAV			= B.ID_SINAV
			JOIN SinavDers				SD WITH(NOLOCK)	ON	SD.ID_SINAVDERS		= B.ID_SINAVDERS
			JOIN v3SinavDers			D  WITH(NOLOCK)	ON	D.ID_DERS			= SD.ID_DERS		
			WHERE	B.ID_SINAV	= @ID_SINAV
				AND B.TCKIMLIKNO= @TC_OGRENCI
	
			INSERT INTO #T2 				
				SELECT 
				 'TOPLAM'					
				,sum(TOPLAMSORU)
				,ST.TD
				,ST.TY
				,ST.TB
				,ST.TN 
				,0 PUAN					
				,T.OLCEKSINAVI			
				,T.TCKIMLIKNO				
				,@GENEL BOLUMNO				
				,cast((TN/(TD+TY+TB)*100.0) as decimal(8,2))		
				
				,cast(avg(SINIFNETORTALAMA		 ) as decimal(8,2))	
				,cast(avg(SINIFDOGRUORTALAMA	) as decimal(8,2))	
				,cast(avg(SINIFYUZDENETORTALAMA	) as decimal(8,2))				
				,cast(avg(SUBENETORTALAMA		) as decimal(8,2))				
				,cast(avg(GENELDOGRUORTALAMA	) as decimal(8,2))	
				,cast(avg(GENELNETORTALAMA		 ) as decimal(8,2))	
				,cast(avg(GENELYUZDENETORTALAMA	 ) as decimal(8,2))	
				,cast((TN/(TD+TY+TB)*100.0) as decimal(8,2))	
				
				,ST.TN_SINIFSIRA				
				,ST.TN_OKULSIRA				
				,ST.TN_ILCESIRA				
				,ST.TN_ILSIRA					
				,ST.TN_GENELSIRA				
				,ST.ID_SINAV

				FROM #T2 T
				JOIN SinavOgrenciToplam	ST	ON	ST.ID_SINAV		= T.ID_SINAV
											AND ST.TCKIMLIKNO	= T.TCKIMLIKNO
				JOIN Sinav				S	ON	S.ID_SINAV		= T.ID_SINAV
				--JOIN v3KademeBilgi		KB	ON	KB.ID_KADEME3	= S.ID_KADEME3
				WHERE (SELECT TOP 1 ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = S.ID_KADEME3) = 4
				GROUP BY ST.TD
				,ST.TY
				,ST.TB
				,ST.TN 				
				,T.OLCEKSINAVI			
				,T.TCKIMLIKNO	
				,ST.TN_SINIFSIRA				
				,ST.TN_OKULSIRA				
				,ST.TN_ILCESIRA				
				,ST.TN_ILSIRA					
				,ST.TN_GENELSIRA
				,ST.ID_SINAV

			SELECT 
				 OS.SORUNO
				,OS.CEVAP OGRENCICEVAP
				,OS.DOGRUCEVAP
				,OS.DURUM
				,OS.ID_SINAVDERS
				,SD.TAKMAAD DERSAD
				,SD.BOLUMNO
			INTO #T3
			FROM vw_SinavOgrenciSoru	OS WITH(NOLOCK)
			JOIN SinavDers				SD WITH(NOLOCK)	ON	SD.ID_SINAVDERS	= OS.ID_SINAVDERS		
			WHERE	OS.TCKIMLIKNO	= @TC_OGRENCI
				AND OS.ID_SINAV		= @ID_SINAV
			ORDER BY SD.BOLUMNO,ID_SINAVDERS,SORUNO

			SELECT   
				DERSAD
				,BOLUMNO
				,OGRENCI	= YUZDENET 
				,SINIF		= SINIFYUZDENETORTALAMA
				,GENEL		= GENELYUZDENETORTALAMA
			INTO #T4
			FROM #T2	B
			WHERE BOLUMNO != @GENEL
			ORDER BY BOLUMNO
		
			SELECT	
					count(1) SORUSAYISI,
					SOS.DURUM,
					D.BOLUMNO,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(SB.YUZDEDOGRU) YUZDE,
					SOS.ID_SINAV
					,(SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR)	FROM SinavOgrenci K WITH(NOLOCK) WHERE K.TCKIMLIKNO = @TC_OGRENCI and k.ID_SINAV = SOS.ID_SINAV FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
			into #KONU
			from vw_SinavOgrenciSoru	SOS WITH(NOLOCK) 
			JOIN vw_SinavOgrenciBolum	SB  WITH(NOLOCK)	ON	SB.ID_SINAVDERS = SOS.ID_SINAVDERS AND SB.TCKIMLIKNO	= SOS.TCKIMLIKNO
			JOIN SinavDers				D   WITH(NOLOCK)	ON	D.ID_SINAVDERS	= SOS.ID_SINAVDERS AND D.ID_SINAV		= SOS.ID_SINAV
			JOIN v3SinavDersUnite		U	WITH(NOLOCK)	ON  U.KOD			= SOS.KOD
			WHERE  SOS.TCKIMLIKNO=@TC_OGRENCI AND SOS.ID_SINAV=@ID_SINAV
			GROUP BY SOS.DURUM,d.TAKMAAD,u.kod,u.AD,D.ID_SINAVDERS,SOS.ID_SINAV,D.BOLUMNO
			ORDER BY d.TAKMAAD

			SELECT DISTINCT
					KONUAD,
					DERSAD,
					BOLUMNO,
					KOD,						
					YUZDE AS BOLUMYUZDE
					,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
					ISNULL( 
								CAST(((100 /
									CAST(
											(	 CAST(ISNULL([D],0) AS INT)
												+CAST(ISNULL([Y],0) AS INT)
												+CAST(ISNULL([B],0) AS INT)) 
										AS DECIMAL(11,2) 
									))
									* CAST([D] AS INT)  
								) AS DECIMAL(11,2)) 
						,0) AS YUZDE
						,KITAPCIK
			INTO #TT
			FROM ( SELECT * FROM #KONU  )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
			order by ID_SINAV,DERSAD,KOD

			SELECT	
				KONUAD,
				BOLUMNO,
				DERSAD,
				KOD,
				CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
				SUM(DOGRU+YANLIS+BOS) SORU,
				SUM(DOGRU) DOGRU,
				SUM(YANLIS) YANLIS,
				SUM(BOS) BOS,
				CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE,
				KITAPCIK
			INTO	#T5
			FROM	#TT
			GROUP BY KOD,KONUAD,DERSAD,BOLUMNO,KITAPCIK
		union 
			SELECT  DERSAD,
					BOLUMNO,
					DERSAD,
					'',
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE ,
					KITAPCIK
			FROM	#TT
			GROUP BY DERSAD,BOLUMNO,KITAPCIK
			order by BOLUMNO,kod


			IF @ISLEM = 1	--JSON SEND
			BEGIN
				select(
					select * from(
						select 
						(						 
							SELECT * FROM #T1
							ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t1
						,( 
							SELECT * FROM #T2
							ORDER BY BOLUMNO
							FOR JSON AUTO
						)as t2
						,(
							SELECT * 				
								,MAXSORU=(SELECT MAX (SORUNO) FROM #T3)
								,DERSSAYISI=(SELECT COUNT (DISTINCT BOLUMNO) FROM #T3) 
							FROM #T3
							ORDER BY BOLUMNO,ID_SINAVDERS,SORUNO
							FOR JSON AUTO
						) as t3 
						,( 
								
							SELECT * FROM #T4
							ORDER BY BOLUMNO					
							FOR JSON AUTO
						)as t4
						,(
							SELECT * FROM #T5
							ORDER BY BOLUMNO,DERSAD,KOD
							FOR JSON AUTO
						) as t5 
					) as tablo FOR JSON AUTO
				) as tt
			END
			IF @ISLEM = 2	--DATASET SEND
			BEGIN
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TC_OGRENCI)
			BEGIN
				SELECT * FROM #T11
				ORDER BY ID_SINAVPUANTURU
			END
			ELSE
			BEGIN
			SELECT * FROM #T1
				ORDER BY ID_SINAVPUANTURU
			END
				SELECT * FROM #T2
				ORDER BY BOLUMNO

				SELECT * 				
					,MAXSORU=(SELECT MAX (SORUNO) FROM #T3)
					,DERSSAYISI=(SELECT COUNT (DISTINCT BOLUMNO) FROM #T3) 
				FROM #T3
				ORDER BY BOLUMNO,ID_SINAVDERS,SORUNO
								
				SELECT * FROM #T4
				ORDER BY BOLUMNO
								
				SELECT * FROM #T5
				ORDER BY BOLUMNO,DERSAD,KOD


			END
			 
			
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5

			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #KONU
		END

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SinifDersAnalizi]...';


GO
ALTER procedure [dbo].[sp_SinifDersAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@DONEM				char(4)			= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@GRUPLAMATURU		INT				= 1
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SUBEs					= @ID_SUBEs	
			,ID_SINAVs					= @ID_SINAVs	
			,ID_SINIFs					= @ID_SINIFs	
			,ID_DERSs					= @ID_DERSs	
			,OGRENCIDONEM				= @OGRENCIDONEM
			,DONEM						= @DONEM		
			,SQLJSON					= @SQLJSON	
			,ID_KADEME3					= @ID_KADEME3	
			,ID_SINAVTURU				= @ID_SINAVTURU
			,GRUPLAMATURU				= @GRUPLAMATURU
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )


		IF (@ISLEM = 1 OR @ISLEM = 2 OR @ISLEM = 3 OR @ISLEM = 4)  -- SINIF
		BEGIN					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #BOLUM
			DROP TABLE IF EXISTS #VERI
			DROP TABLE IF EXISTS #DERS

			SELECT DERSAD INTO #DERS FROM eokul_v2.dbo.Ders 
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'			

			SELECT	DISTINCT S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD,SB.NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM,OC.CEVAP OGRENCICEVAP,OC.ID_SINAVOGRENCICEVAP,SA.CEVAP DOGRUCEVAP
					,SA.SORUNO_A,
					CASE WHEN @GRUPLAMATURU = 1 THEN ISNULL(SA.KOD,'') WHEN @GRUPLAMATURU = 2 THEN SUBSTRING(SA.KOD, 1, 9) WHEN @GRUPLAMATURU = 3 THEN SUBSTRING(SA.KOD, 1, 6) ELSE '' END KOD, 
					CASE WHEN @GRUPLAMATURU = 1 THEN U.AD ELSE '' END KAZANIM, 
					CASE WHEN @GRUPLAMATURU = 1 OR @GRUPLAMATURU = 2 THEN (SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 9)) ELSE '' END KONU, 
					(SELECT K.AD FROM v3SinavDersUnite K WHERE KOD = SUBSTRING(SA.KOD, 1, 6)) UNITE
			INTO	#TEMP_OGRENCI
			FROM	Sinav					S	WITH (NOLOCK)
			INNER JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			INNER JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			INNER JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			INNER JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			INNER JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI 
			INNER JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			INNER JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			INNER JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD
			INNER JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM 
			INNER JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD				= SO.KITAPCIK 
																AND SD.ID_SINAV			= S.ID_SINAV
			INNER JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
																AND SA.KOD IS NOT NULL
			LEFT JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD-- KONU 
			WHERE	S.AKTIF			= 1
				AND S.DURUM			= 2
				AND O.DONEM			= @OGRENCIDONEM
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		

			DROP TABLE IF EXISTS #TEMP

			SELECT  DURUM, COUNT(DURUM) DURUMSAYISI,0 KISISAYISI, DERSAD, KOD, KAZANIM, KONU, UNITE, ID_SINIF
			INTO #TEMP
			FROM #TEMP_OGRENCI T
			GROUP BY KOD, DURUM, DERSAD, ID_SINIF, KAZANIM, KONU, UNITE

			UPDATE T
			SET KISISAYISI = (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.KOD=T.KOD AND G.DERSAD = T.DERSAD AND G.ID_SINIF = T.ID_SINIF)
			FROM #TEMP T

			SELECT DERSAD, KOD, KAZANIM, KONU, UNITE, ID_SINIF, CONVERT(decimal(8,2), CONVERT(decimal(8,2), DURUMSAYISI) / (KISISAYISI) * 100.0) BASARIYUZDESI
					,ISNULL((SELECT DURUMSAYISI FROM #TEMP SUBT WHERE SUBT.ID_SINIF = T.ID_SINIF AND SUBT.KOD = T.KOD AND SUBT.DERSAD = T.DERSAD AND SUBT.DURUM = 'D'), 0) AS DOGRUSAYISI		
					,ISNULL((SELECT DURUMSAYISI FROM #TEMP SUBT WHERE SUBT.ID_SINIF = T.ID_SINIF AND SUBT.KOD = T.KOD AND SUBT.DERSAD = T.DERSAD AND SUBT.DURUM = 'Y'), 0) AS YANLISSAYISI		
					,ISNULL((SELECT DURUMSAYISI FROM #TEMP SUBT WHERE SUBT.ID_SINIF = T.ID_SINIF AND SUBT.KOD = T.KOD AND SUBT.DERSAD = T.DERSAD AND SUBT.DURUM = 'B'), 0) AS BOSSAYISI		
			INTO #VERI
			FROM #TEMP T	
			WHERE DURUM	= 'D'
			GROUP BY KOD, DURUMSAYISI, KISISAYISI, ID_SINIF, KAZANIM, KONU, UNITE, DERSAD
 			ORDER BY ID_SINIF,KOD, KAZANIM, KONU, UNITE
			

			SELECT ID_SINIF,DERSAD, CONVERT(decimal(8,2),CONVERT(decimal(8,2),SUM(DURUMSAYISI))/(SUM(KISISAYISI))*100.0) BOLUMYUZDESI  						
			INTO #BOLUM
			FROM #TEMP	
			WHERE DURUM	= 'D'
			GROUP BY ID_SINIF,DERSAD

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 	
						(		
							SELECT   SINAVAD
									,SINAVTARIH
									,SINAVKATILIM	= COUNT(DISTINCT TCKIMLIKNO) 		
									,ID_SUBE
									,ID_SINIF			
									,SUBEAD
									,SINIFAD	
									,( 
											SELECT ID_SINIF,DERSAD, BOLUMYUZDESI  						
											FROM #BOLUM B
											WHERE B.ID_SINIF = O.ID_SINIF											
 											ORDER BY ID_SINIF	
											FOR JSON PATH
									) as DERSLIST
									,( 
											SELECT DERSAD, KOD, KAZANIM, KONU, UNITE, ID_SINIF, BASARIYUZDESI, DOGRUSAYISI, YANLISSAYISI, BOSSAYISI									
											FROM #VERI V
											WHERE V.ID_SINIF = O.ID_SINIF										
 											ORDER BY ID_SINIF	
											FOR JSON PATH
									) as KAZANIMLIST
							FROM #TEMP_OGRENCI  O
							GROUP BY SINAVAD,SINAVTARIH,SINIFAD,ID_SINIF,ID_SUBE,SUBEAD
							ORDER BY SUBEAD,SINIFAD
							FOR JSON PATH
						) as TblVeri				
						
					) as tablo FOR JSON AUTO
				) as tt				

			END
			ELSE IF @ISLEM = 3
			BEGIN
				SELECT
				(
					SELECT	ID_SUBE,
							ID_SINIF, 
							SUBEAD,
							SINIFAD,
							SINAVLIST = 
									(
										SELECT ID_SINAV, 
												SINAVAD, 
												SINAVTARIH,
												SINAVKATILIM = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP_OGRENCI SUBO WHERE SUBO.ID_SINIF = O.ID_SINIF AND SUBO.ID_SINAV = O.ID_SINAV)
										FROM #TEMP_OGRENCI O 
										WHERE O.ID_SINIF = SS.ID_SINIF 
										GROUP BY O.ID_SINIF, ID_SINAV, SINAVAD, SINAVTARIH 
										FOR JSON PATH
									),
							KAZANIMLIST =
									(
										SELECT DERSAD, KAZANIM, KONU, UNITE, BASARIYUZDESI, DOGRUSAYISI, YANLISSAYISI, BOSSAYISI									
										FROM #VERI V
										WHERE V.ID_SINIF = SS.ID_SINIF AND (KAZANIM <> '' OR KONU <> '' OR UNITE <> '')
 										ORDER BY ID_SINIF, DERSAD, UNITE, KONU, KAZANIM
										FOR JSON PATH
									),
							DERSLIST =
									(
										SELECT ID_SINIF, DERSAD, BOLUMYUZDESI  						
										FROM #BOLUM B
										WHERE B.ID_SINIF = SS.ID_SINIF											
 										ORDER BY DERSAD, ID_SINIF	
										FOR JSON PATH
									)
					FROM #TEMP_OGRENCI SS
					GROUP BY ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
					ORDER BY ID_SUBE, ID_SINIF
					FOR JSON PATH
				) as j
			END
			ELSE IF @ISLEM = 4
			BEGIN
				SELECT	ID_SUBE,
						ID_SINIF, 
						SUBEAD,
						SINIFAD
				FROM #TEMP_OGRENCI SS
				GROUP BY ID_SUBE, ID_SINIF, SUBEAD, SINIFAD
				ORDER BY ID_SUBE, ID_SINIF

				SELECT  ID_SINIF,
						ID_SINAV, 
						SINAVAD, 
						SINAVTARIH,
						SINAVKATILIM = (SELECT COUNT(DISTINCT TCKIMLIKNO) FROM #TEMP_OGRENCI SUBO WHERE SUBO.ID_SINIF = O.ID_SINIF AND SUBO.ID_SINAV = O.ID_SINAV),
						SINIFAD,
						SUBEAD
				FROM #TEMP_OGRENCI O 
				GROUP BY ID_SINIF, SINIFAD, SUBEAD, ID_SINAV, SINAVAD, SINAVTARIH 

				SELECT ID_SINIF, ID_SINIF, DERSAD, BOLUMYUZDESI  						
				FROM #BOLUM B										
 				ORDER BY B.DERSAD, B.ID_SINIF	

				SELECT ID_SINIF, DERSAD, KAZANIM, KONU, UNITE, BASARIYUZDESI, DOGRUSAYISI, YANLISSAYISI, BOSSAYISI									
				FROM #VERI V
				WHERE KAZANIM <> '' OR KONU <> '' OR UNITE <> ''
 				ORDER BY ID_SINIF, DERSAD, UNITE, KONU, KAZANIM
			END
			ELSE
			BEGIN			
				SELECT * FROM #VERI
 				ORDER BY DERSAD,ID_SINIF

				SELECT * FROM #BOLUM
 				ORDER BY DERSAD,ID_SINIF

				SELECT   SINAVAD
						,SINAVTARIH
						,SINAVKATILIM	= COUNT(DISTINCT TCKIMLIKNO) 		
						,ID_SUBE
						,ID_SINIF			
						,SUBEAD
						,SINIFAD	
				FROM #TEMP_OGRENCI 
				GROUP BY SINAVAD,SINAVTARIH,SINIFAD,ID_SINIF,ID_SUBE,SUBEAD
				ORDER BY SUBEAD,SINIFAD				
			END

			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #BOLUM
			DROP TABLE IF EXISTS #VERI
		END			
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_SinifMaddeAnalizi]...';


GO
ALTER procedure [dbo].[sp_SinifMaddeAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	-- kullanılmıyor
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_DERSs					= @ID_DERSs		
			,ID_KADEME3					= @ID_KADEME3		
			,TC_OGRENCI					= @TC_OGRENCI		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBE					= @ID_SUBE		
			,ID_DERS					= @ID_DERS		
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
						
		Declare  @SQL		as varchar(max)=null
				,@Columns	as varchar(max)=null
				,@Columns2	as varchar(max)=null
				,@Columns3	as varchar(max)=null

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )

		IF (@ISLEM = 1 OR @ISLEM = 3)  -- SINIF
		BEGIN
			
		
		------------------------------------------ SINIF		
			--DECLARE  
			--		 @ID_SUBEs		VARCHAR(MAX)= '[11]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2018'
			--		,@OGRENCIDONEM	VARCHAR(MAX)= '2018'
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #k
			DROP TABLE IF EXISTS #TblOrtalama
			DROP TABLE IF EXISTS #DERS

			
			
			SELECT DERSAD INTO #DERS from eokul_v2.dbo.Ders DA
			WHERE ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs)) OR @ID_DERSs ='[]'

			SELECT	DISTINCT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD DERSAD--,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A, SD.BOLUMNO
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE						= O.ID_SUBE
			JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF						= O.ID_SINIF
			JOIN	v3SubeGrupSinifTum		GS	WITH (NOLOCK)	ON	GS.ID_SINIF						= SN.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			JOIN	#DERS					VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK	WITH (NOLOCK)	ON	SK.ID_SINAV						= SO.ID_SINAV  
																AND SK.AD							= SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																AND SA.SORUNO						= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
	   left JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD							= SA.KOD
			WHERE	S.AKTIF			=	1
				AND S.DURUM			=	2
				AND GS.ID_KADEME3	=	@ID_KADEME3
				AND O.DONEM			=	@OGRENCIDONEM
				AND (S.OZEL = 0		OR	@OZELSINAVGOR	= 1)
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
			
			DROP TABLE IF EXISTS #SINIF_DYB
			SELECT KOD, KAZANIM, ID_SINIF, SINIFAD, ID_DERS, DERSAD, ID_SINAV, SINAVAD, SINAVTARIH, SUBEAD, ID_SUBE, COUNT(DURUM) DURUMSAYISI, DURUM , 0 OGRSAY, SORUNO_A, BOLUMNO
			INTO #SINIF_DYB 
			FROM #TEMP_SINIF T
			GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#SINIF_DYB	S
			JOIN    (SELECT SORUNO_A,ID_SINIF,ID_DERS,SUM(DURUMSAYISI)	OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO_A,ID_SINIF, ID_DERS) AS G	ON G.ID_SINIF=S.ID_SINIF  AND G.SORUNO_A = S.SORUNO_A AND S.ID_DERS = G.ID_DERS
			--JOIN    (SELECT SORUNO_A,ID_SINIF,SUM(DURUMSAYISI)	OGRSAY	FROM #SINIF_DYB GROUP BY SORUNO_A,ID_SINIF) AS G	ON G.ID_SINIF=S.ID_SINIF  AND G.SORUNO_A = S.SORUNO_A 
							
			SELECT *, CAST(	(	SELECT CAST(DURUMSAYISI AS DECIMAL(8,2))/OGRSAY*100 
								FROM #SINIF_DYB G 
								WHERE	G.DURUM		= S.DURUM 
									AND G.ID_SINIF	= S.ID_SINIF 
									AND G.KOD		= S.KOD 
									AND G.SORUNO_A	= S.SORUNO_A  
									AND G.BOLUMNO	= S.BOLUMNO
							) AS DECIMAL(8,2)) AS YUZDE
			INTO #SINIF
			FROM #SINIF_DYB S
			ORDER BY SORUNO_A
		
			SELECT ID_SINIF, BOLUMNO,ID_SUBE, SORUNO_A, COUNT(DISTINCT TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
			INTO #OGRSAY
			FROM #TEMP_SINIF
			GROUP BY ID_SINIF, BOLUMNO, SORUNO_A, SUBEAD, SINIFAD, ID_SUBE
			
			Select distinct ID_SINIF,SINIFAD, ID_SUBE,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 
		
				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
				from 
					( Select DISTINCT ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,SINIFAD
				
				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
				ORDER BY SUBEAD,COL DESC,SINIFAD

				Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,COL DESC,SINIFAD
								
			

			Set @SQL='	
				Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into ##TblSinif
				from (
					Select *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF WHERE DURUM=''D''
					UNION ALL 
					Select *,SUBEAD COL from #SINIF WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
				GROUP BY SORUNO_A,KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
				
				INSERT INTO ##TblSinif
				SELECT '''',ID_DERS,DERSAD,''SINIF ORTALAMASI'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						, '+@Columns3+'
				FROM ##TblSinif
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM,ID_DERS,DERSAD
				
			'
			
			PRINT @SQL
			EXEC (@SQL)
			
				SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
				INTO #TblOrtalama
				FROM #SINIF
				WHERE DURUM='D'
				GROUP BY ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD
			UNION ALL				
				SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,0 ID_SUBE,'' SUBEAD, CAST(AVG(YUZDE) AS DECIMAL(8,2)) YUZDE
				FROM #SINIF
				WHERE DURUM='D'
				GROUP BY ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

			If (OBJECT_ID('tempdb..##TblSinif ') Is Null)			
			BEGIN
				SELECT KOD = NULL,ID_DERS= NULL,DERSAD= NULL,KAZANIM= NULL,SORUNO_A= NULL,ID_SINAV= NULL,SINAVAD= NULL,SINAVTARIH= NULL,DURUM= NULL,BOLUMNO= NULL INTO  ##TblSinif 
				DELETE FROM ##TblSinif 
			END

			BEGIN
				IF @ISLEM = 1  -- DEVEXPRESS
				BEGIN
					Select ID_SINIF, SINIFAD, SUBEAD, COL 
					from #k 
					ORDER BY SUBEAD, SINIFAD

					SELECT * FROM ##TblSinif 

					SELECT DISTINCT ID_SINIF,ID_SUBE,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF, OGRSAY

				
					SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD, YUZDE
					FROM #TblOrtalama
					ORDER BY SUBEAD,DERSAD

				END
				ELSE
				BEGIN
					select(
						select * from(
							select 
							(					
								Select ID_SINIF, SINIFAD, SUBEAD, COL 
								from #k 
								ORDER BY SUBEAD, SINIFAD
								FOR JSON AUTO,INCLUDE_NULL_VALUES
							) as TblSinifListesi,					
							(					
								SELECT * FROM ##TblSinif order by BOLUMNO,SORUNO_A
								FOR JSON AUTO
							) as TblVeri,
							(					
								SELECT DISTINCT ID_SINIF,OGRSAY,COL FROM #OGRSAY ORDER BY COL, ID_SINIF, OGRSAY
								FOR JSON AUTO
							) as TblOgrSay,
							(	
								SELECT ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO,ID_SUBE,SUBEAD, YUZDE
								FROM #TblOrtalama
								ORDER BY SUBEAD,DERSAD
								FOR JSON AUTO
							) as TblOrtalama
						) as tablo FOR JSON AUTO
					) as tt
				
				
				END
			END

			DROP TABLE IF EXISTS #k
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #TblOrtalama
			DROP TABLE IF EXISTS #DERS

		END
		-- kullanılmıyor
		IF @ISLEM = 2 -- OKUL
		BEGIN
			------------------------------------------ OKUL
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[11,444]'
			--		,@ID_DERSs		VARCHAR(MAX)= '[942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			DROP TABLE IF EXISTS ##TblOkul

		

			SELECT DISTINCT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,VD.ID_DERS,VD.DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A,BOLUMNO
			INTO	#TEMP_OKUL
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS

			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM

			JOIN	SinavKitapcik			SK	WITH (NOLOCK)	ON	SK.ID_SINAV = SO.ID_SINAV  AND SK.AD = SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK

			JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (SD.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs ='[]')		
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	


			
			DROP TABLE IF EXISTS #OKUL_DYB
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE		,COUNT(DURUM) DURUMSAYISI,DURUM ,0 OGRSAY,SORUNO_A,BOLUMNO
			INTO #OKUL_DYB 
			FROM #TEMP_OKUL T
			GROUP BY KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			--SELECT * FROM #OKUL_DYB 
		
			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#OKUL_DYB S
			JOIN    (
			SELECT SORUNO_A,ID_SUBE,SUM(DURUMSAYISI) OGRSAY FROM #OKUL_DYB
			GROUP BY SORUNO_A,ID_SUBE) AS G ON G.ID_SUBE=S.ID_SUBE   AND G.SORUNO_A = S.SORUNO_A --AND (G.KOD=S.KOD OR (G.KOD IS NULL AND S.KOD IS NULL))
		
			DROP TABLE IF EXISTS #OKUL
			SELECT *, CAST((SELECT CAST(DURUMSAYISI AS DECIMAL(8,2))/OGRSAY*100 FROM #OKUL_DYB G WHERE G.DURUM=S.DURUM AND G.ID_SUBE=S.ID_SUBE AND G.KOD=S.KOD AND G.SORUNO_A=S.SORUNO_A  AND G.BOLUMNO=S.BOLUMNO) AS DECIMAL(8,2)) AS YUZDE
			INTO #OKUL
			FROM #OKUL_DYB S
			ORDER BY SORUNO_A


				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SUBEAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SUBEAD)+'=''-'' then null else '+QUOTENAME(SUBEAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD


			Set @SQL='	
			
				Select  KOD,ID_DERS,DERSAD,KAZANIM,SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into ##TblOkul
				from (
					Select * from #OKUL WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR SUBEAD IN('+@Columns+')) as P1	
				GROUP BY SORUNO_A,KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

				INSERT INTO ##TblOkul
				SELECT '''',0,'''',''ORTALAMA'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						,'+@Columns3+'
				FROM ##TblOkul
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM

			'
			PRINT @SQL
			EXEC (@SQL)

			Select distinct ID_SUBE,SUBEAD,SUBEAD COL from #TEMP_OKUL ORDER BY SUBEAD

			SELECT * FROM ##TblOkul ORDER BY BOLUMNO, SORUNO_A
		
		
			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			DROP TABLE IF EXISTS ##TblOkul
		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SinifNetPuanOrtalamalari]...';


GO
ALTER procedure [dbo].[sp_SinifNetPuanOrtalamalari]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='32051057542',@OTURUM='10F4322D-70ED-4AB6-B4C6-0ECC61118DFC',@DONEM='2017',@ID_SINAVTURU=8,@ID_KADEME3=15,@ID_SINAVs='[243,330,286]',@ID_SUBEs='[427,11]',@ID_SINIFS='[107210,107209,108612,107251]',@ID_DERSs='[0,147,150,152,873,962,1119]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
	
	
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
				
		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11


		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null

		------------------------------------------ DERS NET
		BEGIN
		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18

		SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,DOGRU,YANLIS,BOS
				,O.ID_SUBE,SU.AD SUBEAD
		INTO	#Temp
		FROM	Sinav					S	WITH (NOLOCK)
		JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO 
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
		JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
		JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
		WHERE	S.DURUM			= 2
			AND S.AKTIF			= 1
			AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))

		--SELECT * FROM #Temp

			SELECT ID_SINAV,SINAVAD,ID_DERS,DERSAD,SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			INTO #Net
			FROM #Temp	T
			GROUP BY ID_DERS,ID_SINAV,SINAVTARIH,SINAVAD,DERSAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		--UNION ALL 
		--	SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(DOGRU+YANLIS+BOS)/COUNT(1)) TS, CAST(AVG(NET) AS DECIMAL(8,2)) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
		--	FROM #Temp	T
		--	GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			
			INSERT INTO #Net			
			SELECT ID_SINAV,SINAVAD,0,'TOPLAM',SINAVTARIH,(SUM(TS)) TS, sum( CAST(NET AS DECIMAL(8,2))) NET ,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD
			FROM #Net	T
			GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINIF,SINIFAD

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH

			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH

			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp  ) as b 
			order by b.SINAVTARIH
				
			
			--Select  SINAVAD, ID_SINAV, SINAVTARIH, ID_DERS, ID_SUBE, SUBEAD, DERSAD, NET into ##pivots from #Net
			--DELETE FROM ##pivots
			--SELECT TOP 1 ID_DERS,DERSAD INTO ##GenelOrt FROM #Net
			--DELETE FROM ##GenelOrt

			

			if not exists (select * from #Net)
			begin
				Select 				
					ID_DERS=null,
					ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					DERSAD=null
				into ##pivots

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt
			end

		

		Set @SQL='	
			
			Select
				ID_DERS,
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				DERSAD,
				999 BOLUMNO,
				'+@Columns2+' 
			into ##pivots
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_DERS,
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					DERSAD,
					-- TS,
					NET
				from #Net
			) AS S
			PIVOT (MAX(NET) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY DERSAD,SUBEAD,ID_SUBE,ID_DERS,ID_SINIF,SINIFAD	
				
			SELECT ID_DERS,DERSAD,999 BOLUMNO,'+@Columns3+'
			INTO ##GenelOrt
			FROM ##pivots 
			GROUP BY ID_DERS,DERSAD		
		'
		PRINT @SQL
		EXEC (@SQL)
		
		SELECT * 
		INTO #PIVOTS
		FROM ##pivots 
		DROP TABLE IF EXISTS ##pivots
		
		SELECT * 
		INTO #GENELORT
		FROM ##GenelOrt 		
		DROP TABLE IF EXISTS ##GenelOrt


		BEGIN

			SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,VD.ID_DERS,SD.TAKMAAD DERSAD,NET,SO.TCKIMLIKNO
			INTO	#Temp11
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV		
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			WHERE	S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))

			SELECT SINAVAD,DERSAD,CAST(AVG(NET) AS decimal(8,2)) AS ORT INTO #ORT  FROM #Temp11 
			GROUP BY DERSAD,SINAVAD
		INSERT INTO #ORT
			SELECT SINAVAD,'TOPLAM',CAST(SUM(NET)/COUNT(DISTINCT TCKIMLIKNO) AS decimal(8,2)) AS ORT  FROM #Temp11
			GROUP BY SINAVAD
			

			SELECT value SINAVAD INTO #COL FROM string_split(@Columns,',')
			WHILE EXISTS (SELECT * FROM #COL)
			BEGIN
				DECLARE @COL VARCHAR(MAX)= (SELECT TOP 1  SINAVAD FROM #COL ORDER BY 1 DESC)
			SET @SQL = N'
					UPDATE P
					SET	P.'+@COL+' = O.ORT
					FROM #GENELORT P
					JOIN #ORT	O ON O.DERSAD = P.DERSAD AND ''[''+ O.SINAVAD +'']'' = '''+@COL+'''
				'
				PRINT @SQL
				EXEC (@SQL)
				DELETE FROM #COL WHERE SINAVAD = (SELECT TOP 1 SINAVAD FROM #COL ORDER BY 1 DESC)
			END
		END

		DECLARE @ID_EGITIMTURU VARCHAR(15)=
		CASE @ID_SINAVTURU 
										WHEN  0 THEN 6 
										WHEN  2 THEN 7 
										WHEN  3 THEN 8 
										WHEN  6 THEN 9 
										WHEN  5 THEN 10
										--YENENLEEKLENEİ 
										WHEN  8  THEN 11
										WHEN  9 THEN 12
										WHEN  7 THEN 13
										WHEN  10 THEN 14
										
										END

			--CASE  WHEN @ID_SINAVTURU = 2 THEN 7
			--	  WHEN @ID_SINAVTURU = 3 THEN 8
			--	  WHEN @ID_SINAVTURU = 6 THEN 9
			--	  ELSE @ID_SINAVTURU 
			--	  END 

	


		
		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp T ON '['+T.SINAVAD+']'=FN.Value

		DECLARE @ILK_ID_SINAV INT=(SELECT TOP 1 VALUE FROM OPENJSON(@ID_SINAVs) WHERE VALUE > 0)


		SELECT		DISTINCT SD.TAKMAAD , SD.TAKMAAD AS DERSAD,SD.BOLUMNO	BOLUM	
		INTO #BOLUMLER		
		FROM		#PIVOTS				G
		JOIN		Sinav				S	ON	S.ID_SINAV	= @ILK_ID_SINAV
		JOIN		SinavDers			SD	ON	SD.ID_SINAV	= S.ID_SINAV 
		JOIN		eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= SD.ID_DERS
		ORDER BY BOLUM
		
		INSERT INTO #BOLUMLER (TAKMAAD,DERSAD,BOLUM)
		SELECT DISTINCT DERSAD,DERSAD,(SELECT MAX(BOLUM) FROM #BOLUMLER)+ ROW_NUMBER() OVER(ORDER BY DERSAD ASC) FROM #PIVOTS  P
		WHERE DERSAD !='TOPLAM' AND  DERSAD NOT IN (SELECT DERSAD FROM #BOLUMLER )


		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS	G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		
		UPDATE G
		SET G.BOLUMNO=T.BOLUM
		FROM #PIVOTS G
		JOIN #BOLUMLER	T	ON T.DERSAD=G.DERSAD

		SELECT distinct P.*,isnull(K.AD+' '+K.SOYAD,'') ADSOYAD 
		INTO #T1
		FROM #PIVOTS p		
		JOIN eokul_v2.DBO.Ders				D	ON	D.ID_DERS = P.ID_DERS
		JOIN eokul_v2.DBO.Ders				D2	ON	D2.DERSAD = D.DERSAD
												AND D2.ID_KADEME3 = D.ID_KADEME3
												AND D2.AKTIF = 1
		left JOIN eokul_v2.DBO.dersOgretmen do	on	do.ID_SINIF=p.ID_SINIF 
												AND DO.ID_DERS=D2.ID_DERS 
												and do.ID_EGITIMTURU=@ID_EGITIMTURU
		left JOIN v3Kullanici	K	ON	K.TCKIMLIKNO=DO.TC_OGRETMEN
		where P.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))	
		ORDER BY ID_DERS DESC

		END
		------------------------------------------ PUAN
		BEGIN


		--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[444]'
		--		,@ID_SINAVs		VARCHAR(MAX)= '[125]'
		--		,@DONEM			VARCHAR(MAX)= '2017'
		--		,@ID_SINAVTURU	INT			= 3
		--		,@ID_KADEME3	INT			= 18
		SELECT	S.ID_SINAV,S.AD SINAVAD,SINAVTARIH,SO.TCKIMLIKNO
				,SN.ID_SINIF,SN.AD SINIFAD
				,O.ID_SUBE,SU.AD SUBEAD
				,PT.ID_SINAVPUANTURU,PT.AD PUANTURU
				,SOS.PUAN
		INTO	#Temp2
		FROM	Sinav					S	WITH (NOLOCK)
		JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
		JOIN	SinavOgrenciPuan		SOS WITH (NOLOCK)	ON	SOS.ID_SINAV		= SO.ID_SINAV
															AND SOS.TCKIMLIKNO		= SO.TCKIMLIKNO
		JOIN	SinavPuanTuru			PT	WITH (NOLOCK)	ON	PT.ID_SINAVPUANTURU = SOS.ID_SINAVPUANTURU
		JOIN	v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
															AND O.DONEM				= @DONEM
		JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
		JOIN	v3SinifTum				SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
		WHERE	S.DURUM			= 2
			AND S.AKTIF			= 1
			AND (OZEL=0 OR @OZELSINAVGOR=1)
			AND S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))
			--AND O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
			--AND O.ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
			--AND PT.ID_SINAVTURU	= @ID_SINAVTURU
			--AND S.ID_KADEME3	= @ID_KADEME3

		--SELECT * FROM #Temp

		SELECT ID_SINAV,SINAVAD,SINAVTARIH,CAST(AVG(PUAN) AS DECIMAL(8,2)) PUAN ,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU,ID_SINIF,SINIFAD
		INTO #Net2
		FROM #Temp2	T
		GROUP BY ID_SINAV,SINAVTARIH,SINAVAD,ID_SUBE,SUBEAD,ID_SINAVPUANTURU,PUANTURU,ID_SINIF,SINIFAD


		SET @SQL 	  =NULL
		SET @Columns  =NULL
		SET @Columns2 =NULL
		SET @Columns3 =NULL

			Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b 
			order by b.SINAVTARIH

		--Select @Columns2=Coalesce(@Columns2+',','')+'MAX(CAST(ISNULL(CAST('+QUOTENAME(SINAVAD)+' AS VARCHAR),''-'') AS VARCHAR)) AS ' +QUOTENAME(SINAVAD) from (
			Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SINAVAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b 
			order by b.SINAVTARIH
				
				
			Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SINAVAD)+'=''-'' then null else '+QUOTENAME(SINAVAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SINAVAD) 
			from 
				( Select distinct SINAVAD, ID_SINAV, SINAVTARIH from #Temp2  ) as b 
			order by b.SINAVTARIH

			

			if not exists (select * from #Net2)
			begin
				Select 				
				ID_SUBE=null,
					SUBEAD=null,
					ID_SINIF=null,
					SINIFAD=null,
					ID_SINAVPUANTURU=null,
					PUANTURU=null
				into ##pivots2

				SELECT ID_SINAVPUANTURU=null,PUANTURU=null
				INTO ##GenelOrt2
			end

		Set @SQL='	
			
			Select 				
				ID_SUBE,
				SUBEAD,
				ID_SINIF,
				SINIFAD,
				ID_SINAVPUANTURU,
				PUANTURU,
				'+@Columns2+' 
			into ##pivots2
			from (
				Select 
					SINAVAD,
					ID_SINAV,
					SINAVTARIH,
					ID_SUBE,
					SUBEAD,
					ID_SINIF,
					SINIFAD,
					ID_SINAVPUANTURU,
					PUANTURU,
					-- TS,
					PUAN
				from #Net2
			) AS S
			PIVOT (MAX(PUAN) FOR SINAVAD IN('+@Columns+')) as P1	
			GROUP BY SUBEAD,ID_SUBE,ID_SINAVPUANTURU,PUANTURU,ID_SINIF,SINIFAD

	
			SELECT ID_SINAVPUANTURU,PUANTURU,'+@Columns3+'
			INTO ##GenelOrt2
			FROM ##pivots2 
			GROUP BY ID_SINAVPUANTURU,PUANTURU	
		'
		PRINT @SQL
		EXEC (@SQL)

		
		SELECT * 
		INTO #PIVOTS2
		FROM ##pivots2 
		DROP TABLE ##pivots2
		
		SELECT * 
		INTO #GENELORT2
		FROM ##GenelOrt2 		
		DROP TABLE ##GenelOrt2




		SELECT DISTINCT T.ID_SINAV,T.SINAVAD,T.SINAVTARIH 
		INTO #SinavList2
		FROM dbo.fn_Split(@Columns,',',NULL) FN
		JOIN #Temp2 T ON '['+T.SINAVAD+']'=FN.Value
		--SELECT DISTINCT ID_SUBE,SUBEAD FROM #Temp2
		--SELECT DISTINCT ID_SINAVPUANTURU,PUANTURU FROM #Temp2

		
		END
		------------------------------------------ JSON SEND
		
		 select(
				select * from(
						select 
						(					
							SELECT		*
							FROM		#T1 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
								AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							ORDER BY	BOLUMNO 
							FOR JSON AUTO
						) as t1,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList
							ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t2,
						(					
							SELECT		*
							FROM		#PIVOTS2 
							WHERE	ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))
								AND ID_SINIF	IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))
							ORDER BY ID_SINAVPUANTURU
							FOR JSON AUTO
						) as t3,
						(					
							SELECT ID_SINAV,SINAVAD FROM #SinavList2
							ORDER BY SINAVTARIH
							FOR JSON AUTO
						) as t4,

						(					
							SELECT		*
							FROM		#GENELORT 
							ORDER BY	ID_DERS DESC
							FOR JSON AUTO
						) as t5,
						(					
							SELECT		*
							FROM		#GENELORT2
							ORDER BY	ID_SINAVPUANTURU DESC
							FOR JSON AUTO
						) as t6
						
												
					) as tablo FOR JSON AUTO
				) as tt

		
		DROP TABLE IF EXISTS #SinavList
		DROP TABLE IF EXISTS ##GenelOrt
		DROP TABLE IF EXISTS #GENELORT
		DROP TABLE IF EXISTS ##pivots
		DROP TABLE IF EXISTS #PIVOTS
		DROP TABLE IF EXISTS #Temp
		DROP TABLE IF EXISTS #Net
		DROP TABLE IF EXISTS #T1

		DROP TABLE IF EXISTS #SinavList2
		DROP TABLE IF EXISTS ##GenelOrt2
		DROP TABLE IF EXISTS #GENELORT2
		DROP TABLE IF EXISTS ##pivots2
		DROP TABLE IF EXISTS #PIVOTS2
		DROP TABLE IF EXISTS #Temp2
		DROP TABLE IF EXISTS #Net2
		DROP TABLE IF EXISTS #BOLUMLER
		DROP TABLE IF EXISTS #COL
		DROP TABLE IF EXISTS #ORT
		DROP TABLE IF EXISTS #Temp11

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_SoruMaddeAnaliziOS]...';


GO
ALTER procedure [dbo].[sp_SoruMaddeAnaliziOS]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,SQLJSON					= @SQLJSON		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--		exec dbo.sp_sinifNetPuanOrtalamalari @TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834',@DONEM='2017',@ID_SINAVTURU=6,@ID_KADEME3=17,@ID_SINAVs='[0,168,158,160,145,70,78,144,143,67,69]',@ID_SUBEs='[427,11]',@ID_SINIFS='[0,104795,102205,102206,101684,101674,101675,101673,101681,102311]',@ID_DERSs='[914,977,978,980,981,1016,1047,1051]'

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	--declare @sID_SINAVTURU INT=@ID_SINAVTURU,@sDONEM varchar(4)=@DONEM,@sTC_OGRENCI varchar(11)=@TC_OGRENCI

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END
		--AND (OZEL=0 OR @OZELSINAVGOR=1)
						
		Declare @SQL as varchar(max)=null
		Declare @Columns as varchar(max)=null
		Declare @Columns2 as varchar(max)=null
		Declare @Columns3 as varchar(max)=null


		IF (@ISLEM = 1 OR @ISLEM = 3)  -- SINIF
		BEGIN
			
		
		------------------------------------------ SINIF
		
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[11]'
			--		,@ID_SINIFs		VARCHAR(MAX)= '[0,101677,101671,101679,101672,101676,101680]'
			--		,@ID_DERSs		VARCHAR(MAX)= '[942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 2
			--		,@ID_KADEME3	INT			= 18
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif

			SELECT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,O.ID_SINIF, SN.AD SINIFAD,VD.ID_DERS,VD.DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A, SD.BOLUMNO
			INTO	#TEMP_SINIF
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	v3Sinif					SN  WITH (NOLOCK)	ON	SN.ID_SINIF			= O.ID_SINIF
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	eokul_v2.dbo.Ders		VD2	WITH (NOLOCK)	ON	VD2.DERSAD			= VD.DERSAD

			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.ID_SINAV			= SO.ID_SINAV
																AND SK.AD				= SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
		left	JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (VD2.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs ='[]')		
				AND (O.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV		IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')
				AND (O.ID_SINIF		IN	(SELECT VALUE FROM OPENJSON(@ID_SINIFs))	OR @ID_SINIFs='[]' OR @ID_SINIFs IS NULL)		


			
			DROP TABLE IF EXISTS #SINIF_DYB
			SELECT KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE		,COUNT(DURUM) DURUMSAYISI,DURUM ,0 OGRSAY,SORUNO_A,BOLUMNO
			INTO #SINIF_DYB 
			FROM #TEMP_SINIF T
			GROUP BY KOD,KAZANIM,ID_SINIF,SINIFAD,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			--SELECT * FROM #SINIF_DYB 
		
			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#SINIF_DYB S
			JOIN    (
			SELECT KOD,ID_SINIF,SUM(DURUMSAYISI) OGRSAY FROM #SINIF_DYB
			GROUP BY KOD,ID_SINIF) AS G ON G.ID_SINIF=S.ID_SINIF AND (G.KOD=S.KOD OR (G.KOD IS NULL AND S.KOD IS NULL))
			
		
			DROP TABLE IF EXISTS #SINIF
			SELECT *
				, CAST((	SELECT	CAST(SUM (DURUMSAYISI )AS DECIMAL(8,2))/OGRSAY*100 
							FROM #SINIF_DYB G 
							WHERE	G.DURUM=S.DURUM 
								AND G.ID_SINIF=S.ID_SINIF 
								AND G.KOD=S.KOD 
								--AND G.SORUNO_A=S.SORUNO_A  
								AND G.BOLUMNO=S.BOLUMNO							
							group by g.OGRSAY
							) 
						AS DECIMAL(8,2)
					) AS YUZDE
			INTO #SINIF
			FROM #SINIF_DYB S
			ORDER BY SORUNO_A



			SELECT ID_SINIF, BOLUMNO, SORUNO_A, COUNT(TCKIMLIKNO) AS OGRSAY, SUBEAD + ' / ' + SINIFAD AS COL
			INTO #OGRSAY
			FROM #TEMP_SINIF
			GROUP BY ID_SINIF, BOLUMNO, SORUNO_A, SUBEAD, SINIFAD


			Select distinct ID_SINIF,SINIFAD,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL into #k from #TEMP_SINIF 


				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k  ) as b 
				ORDER BY SUBEAD,SINIFAD
				
				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(COL)+') AS VARCHAR),''-'') AS ' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,SINIFAD

				Select @Columns3=Coalesce(@Columns3+',','')+'ISNULL(Cast(AVG(CAst( case when '+QUOTENAME(COL)+'=''-'' then null else '+QUOTENAME(COL)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)),0) AS' +QUOTENAME(COL) 
				from 
					( Select ID_SINIF,SINIFAD,SUBEAD, COL from #k   ) as b 
				ORDER BY SUBEAD,SINIFAD
				

			Set @SQL='	
				DROP TABLE IF EXISTS #TblSinif

				Select  KOD,ID_DERS,DERSAD,KAZANIM,MIN(SORUNO_A) SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into #TblSinif
				from (
					Select *,SUBEAD + '' / '' + SINIFAD AS COL from #SINIF WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR COL IN('+@Columns+')) as P1	
				GROUP BY KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

				INSERT INTO #TblSinif
				SELECT '''',0,'''',''SINIF ORTALAMA'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						, '+@Columns3+'
				FROM #TblSinif
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM

				SELECT	DISTINCT F.*
						,SORULIST	= ISNULL( (SELECT STUFF((SELECT   '' - '' + CAST(K.SORUNO_A AS VARCHAR)	FROM #SINIF K WHERE K.KOD = F.KOD AND K.ID_DERS = F.ID_DERS GROUP BY K.ID_DERS,K.SORUNO_A ORDER BY K.SORUNO_A FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 3, '''')),''-'')
				FROM #TblSinif F
				ORDER BY SORUNO_A

				SELECT	DISTINCT F.*						
				INTO ##TblSinif
				FROM #TblSinif F
				ORDER BY SORUNO_A

				DROP TABLE IF EXISTS #TblSinif
			'
			
			PRINT @SQL
			--EXEC (@SQL)
			


			--Select distinct ID_SINIF,SINIFAD,SUBEAD, SUBEAD + ' / ' + SINIFAD AS COL from #TEMP_SINIF ORDER BY SUBEAD,SINIFAD
			
			IF @ISLEM = 1  -- DEVEXPRESS
			BEGIN
				Select ID_SINIF,SINIFAD,SUBEAD, COL from #k ORDER BY SUBEAD,SINIFAD
				
				EXEC (@SQL)

				SELECT DISTINCT ID_SINIF,BOLUMNO,OGRSAY,COL FROM #OGRSAY ORDER BY COL, BOLUMNO, ID_SINIF, OGRSAY

			END
			ELSE
			BEGIN
				select(
					select * from(
						select 
						(					
							Select ID_SINIF, SINIFAD, SUBEAD, COL from #k ORDER BY SUBEAD, SINIFAD
							FOR JSON AUTO
						) as TblSinifListesi,					
						(					
							SELECT * FROM ##TblSinif order by BOLUMNO,SORUNO_A
							FOR JSON AUTO
						) as TblVeri,					
						(					
							SELECT DISTINCT ID_SINIF,BOLUMNO,OGRSAY,COL FROM #OGRSAY ORDER BY COL, BOLUMNO, ID_SINIF, OGRSAY
							FOR JSON AUTO
						) as TblOgrSay
					) as tablo FOR JSON AUTO
				) as tt
				
				
			END




			DROP TABLE IF EXISTS #k
			DROP TABLE IF EXISTS #TEMP_SINIF
			DROP TABLE IF EXISTS #SINIF
			DROP TABLE IF EXISTS #SINIF_DYB
			DROP TABLE IF EXISTS ##TblSinif





		END
		IF @ISLEM = 2 -- OKUL
		BEGIN
			------------------------------------------ OKUL
			--DECLARE  @ID_SUBEs		VARCHAR(MAX)= '[11,444]'
			--		,@ID_SINIFs		VARCHAR(MAX)= '[0,101677,101671,101679,101672,101676,101680]'
			--		,@ID_DERSs		VARCHAR(MAX)= '[942]'
			--		,@ID_SINAVs		VARCHAR(MAX)= '[152]'
			--		,@DONEM			VARCHAR(MAX)= '2017'
			--		,@ID_SINAVTURU	INT			= 2
			--		,@ID_KADEME3	INT			= 18
			--Declare @SQL as varchar(max)=null
			--Declare @Columns as varchar(max)=null
			--Declare @Columns2 as varchar(max)=null
			--Declare @Columns3 as varchar(max)=null

			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			DROP TABLE IF EXISTS ##TblOkul

		

			SELECT	S.ID_SINAV,S.AD SINAVAD,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH,SO.TCKIMLIKNO,VD.ID_DERS,VD.DERSAD,NET,DOGRU,YANLIS,BOS
					,O.ID_SUBE,SU.AD SUBEAD,OC.DURUM
					,ISNULL(U.KOD,'') KOD,ISNULL(U.AD,'') KAZANIM,SA.SORUNO_A,BOLUMNO
			INTO	#TEMP_OKUL
			FROM	Sinav					S	WITH (NOLOCK)
			JOIN	SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV			= S.ID_SINAV
			JOIN	v3Ogrenci				O	WITH (NOLOCK)	ON	O.TCKIMLIKNO		= SO.TCKIMLIKNO
			JOIN	v3Sube					SU	WITH (NOLOCK)	ON	SU.ID_SUBE			= O.ID_SUBE
			JOIN	SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI
			JOIN	SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS		= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders		VD	WITH (NOLOCK)	ON	VD.ID_DERS			= SD.ID_DERS
			JOIN	SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM =SB.ID_SINAVOGRENCICEVAPBOLUM
			JOIN	SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.ID_SINAV			= SO.ID_SINAV
																AND SK.AD				= SO.KITAPCIK
			JOIN	SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
																AND SA.SORUNO			= OC.SORUNO
																AND SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK
			JOIN	v3SinavDersUnite		U	WITH (NOLOCK)	ON	U.KOD				= SA.KOD
			WHERE	S.DONEM			= @DONEM
				AND S.DURUM			= 2
				AND S.AKTIF			= 1
				AND (OZEL=0 OR @OZELSINAVGOR=1)
				AND (SD.ID_DERS	IN	(SELECT VALUE FROM OPENJSON(@ID_DERSs))		OR @ID_DERSs ='[]')		
				AND (O.ID_SUBE	IN	(SELECT VALUE FROM OPENJSON(@ID_SUBEs))		OR @ID_SUBEs ='[]')
				AND (S.ID_SINAV	IN	(SELECT VALUE FROM OPENJSON(@ID_SINAVs))	OR @ID_SINAVs='[]')	


			
			DROP TABLE IF EXISTS #OKUL_DYB
			SELECT KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE		,COUNT(DURUM) DURUMSAYISI,DURUM ,0 OGRSAY,SORUNO_A,BOLUMNO
			INTO #OKUL_DYB 
			FROM #TEMP_OKUL T
			GROUP BY KOD,KAZANIM,ID_DERS,DERSAD,ID_SINAV,SINAVAD,SINAVTARIH,SUBEAD,ID_SUBE,DURUM,SORUNO_A,BOLUMNO

			--SELECT * FROM #OKUL_DYB 
		
			UPDATE	S 
			SET		S.OGRSAY=G.OGRSAY
			FROM	#OKUL_DYB S
			JOIN    (
			SELECT KOD,ID_SUBE,SUM(DURUMSAYISI) OGRSAY FROM #OKUL_DYB
			GROUP BY KOD,ID_SUBE) AS G ON G.ID_SUBE=S.ID_SUBE AND (G.KOD=S.KOD OR (G.KOD IS NULL AND S.KOD IS NULL))
	

			DROP TABLE IF EXISTS #OKUL
			SELECT *
				, CAST((	SELECT CAST(SUM(DURUMSAYISI) AS DECIMAL(8,2))/OGRSAY*100 
							FROM #OKUL_DYB G 
							WHERE	G.DURUM		= S.DURUM 
								AND G.ID_SUBE	= S.ID_SUBE 
								AND G.KOD		= S.KOD 
								--AND G.SORUNO_A	= S.SORUNO_A  
								AND G.BOLUMNO	= S.BOLUMNO												
							group by g.OGRSAY
							) AS DECIMAL(8,2)
						) AS YUZDE
			INTO #OKUL
			FROM #OKUL_DYB S
			ORDER BY SORUNO_A


				Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL(CAST(MAX('+QUOTENAME(SUBEAD)+') AS VARCHAR),''-'') AS ' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD

				Select @Columns3=Coalesce(@Columns3+',','')+'CAst(AVG(CAst( case when '+QUOTENAME(SUBEAD)+'=''-'' then null else '+QUOTENAME(SUBEAD)+' end AS DECIMAL(8,2))) AS DECIMAL(8,2)) AS' +QUOTENAME(SUBEAD) 
				from 
					( Select distinct ID_SUBE,SUBEAD from #TEMP_OKUL  ) as b 
				ORDER BY SUBEAD


			Set @SQL='	
				DROP TABLE IF EXISTS #TblOkul
				Select  KOD,ID_DERS,DERSAD,KAZANIM,MIN(SORUNO_A) SORUNO_A,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO
					,'+@Columns2+' 
				into #TblOkul
				from (
					Select * from #OKUL WHERE DURUM=''D''
				) AS S
				PIVOT (MAX(YUZDE) FOR SUBEAD IN('+@Columns+')) as P1	
				GROUP BY KOD,ID_DERS,DERSAD,KAZANIM,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,BOLUMNO

				INSERT INTO #TblOkul
				SELECT '''',0,'''',''ORTALAMA'',0,ID_SINAV,SINAVAD,SINAVTARIH,DURUM,99
						,'+@Columns3+'
				FROM #TblOkul
				GROUP BY ID_SINAV,SINAVAD,SINAVTARIH,DURUM

				SELECT	DISTINCT F.*
						,SORULIST	= ISNULL( (SELECT STUFF((SELECT   '' - '' + CAST(K.SORUNO_A AS VARCHAR)	FROM #OKUL K WHERE K.KOD = F.KOD AND K.ID_DERS = F.ID_DERS GROUP BY K.ID_DERS,K.SORUNO_A ORDER BY K.SORUNO_A FOR XML PATH(''''), TYPE).value(''.'', ''VARCHAR(MAX)''), 1, 3, '''')),''-'')
				FROM #TblOkul F
				ORDER BY SORUNO_A
				
				DROP TABLE IF EXISTS #TblOkul
			'

			Select distinct ID_SUBE,SUBEAD,SUBEAD COL from #TEMP_OKUL ORDER BY SUBEAD

			PRINT @SQL
			EXEC (@SQL)


			--Select distinct ID_SUBE,SUBEAD,SUBEAD COL from #TEMP_OKUL ORDER BY SUBEAD
			--SELECT * FROM ##TblOkul ORDER BY BOLUMNO, SORUNO_A
		
		
			DROP TABLE IF EXISTS #TEMP_OKUL
			DROP TABLE IF EXISTS #OKUL
			DROP TABLE IF EXISTS #OKUL_DYB
			--DROP TABLE IF EXISTS ##TblOkul
		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_TopluSinavSonuclari]...';


GO
ALTER procedure [dbo].[sp_TopluSinavSonuclari]
	@ISLEM			INT				= NULL,
	@TCKIMLIKNO		VARCHAR(11)		= NULL,
	@TC_OGRENCI		VARCHAR(MAX)	= '[]',
	@OTURUM			VARCHAR(36)		= NULL,
	@ID_MENU		INT				= NULL,
	@ID_SINAV		INT				= NULL,
	@ID_SUBE		VARCHAR(MAX)	= '[]',
	@ID_SINIF		VARCHAR(MAX)	= '[]'
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM					= @ISLEM		
			,TCKIMLIKNO				= @TCKIMLIKNO	
			,TC_OGRENCI				= @TC_OGRENCI	
			,OTURUM					= @OTURUM		
			,ID_MENU				= @ID_MENU	
			,ID_SINAV				= @ID_SINAV	
			,ID_SUBE				= @ID_SUBE	
			,ID_SINIF				= @ID_SINIF	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

declare 
	 @sISLEM			INT				= @ISLEM		
	,@sTCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO
	,@sTC_OGRENCI		VARCHAR(MAX)	= @TC_OGRENCI
	,@sOTURUM			VARCHAR(36)		= @OTURUM	
	,@sID_MENU			INT				= @ID_MENU	
	,@sID_SINAV			INT				= @ID_SINAV	
	,@sID_SUBE			VARCHAR(MAX)	= @ID_SUBE	
	,@sID_SINIF			VARCHAR(MAX)	= @ID_SINIF		


BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
		
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		
--	exec [sp_TopluSinavSonuclari] @ISLEM=2,@TCKIMLIKNO='32051057542',@OTURUM='CFA249F9-6FA9-46BF-AC6B-0896681CD805',@ID_MENU= 1031,@ID_SINAV=43,@ID_SUBE='[444]',@ID_SINIF='[102077]',@TC_OGRENCI='[17978633802,23210156572]'

	IF @ID_LOG > 1
	BEGIN
		IF (@sISLEM = 1 OR @sISLEM = 2)	--	TOPLU SINAV SONUÇLARI
		BEGIN
		
			DROP TABLE IF EXISTS #PUAN
			DROP TABLE IF EXISTS #KONU
			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #RE
			DROP TABLE IF EXISTS #GRAFIK
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			--DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #ALINANBURS
			DROP TABLE IF EXISTS #BurslulukSinavOgrenci
			DROP TABLE IF EXISTS #BURSOGRENCI
			DROP TABLE IF EXISTS #OGRENCIBURS

			DECLARE @GENEL INT = 999

			SELECT   distinct
					 B.TCKIMLIKNO
					,B.DOGRU
					,B.YANLIS
					,B.BOS
					,B.NET
					,YUZDENET
					,O.ID_SINAV
					,ID_SINIF	= ISNULL(VO.ID_SINIF,0) 
					,ID_SUBE	= ISNULL(VO.ID_SUBE,0) 
					,D.ID_DERS
					,D.TAKMAAD DERSAD
					,O.AD +' ' +O.SOYAD ADSOYAD
					,VS.ILCE ILCE
					,VS.IL IL
					,VS.AD SUBEAD
					,O.SINIF
					,B.PUAN
					,S.OLCEKSINAVI
					,(SELECT COUNT(1) FROM SinavAnahtar A WHERE A.ID_SINAVDERS=D.ID_SINAVDERS AND  A.ID_SINAVKITAPCIK=B.ID_SINAVKITAPCIK ) TOPLAMSORU
					,d.BOLUMNO
					,D.ID_SINAVDERS
					,O.SUBENO
			INTO #PUAN
			FROM vw_SinavOgrenciBolum	B
			JOIN Sinav					S	ON	S.ID_SINAV		= B.ID_SINAV
			JOIN SinavDers				D	ON	D.ID_SINAVDERS	= B.ID_SINAVDERS
			JOIN SinavOgrenci			O	ON	O.TCKIMLIKNO	= B.TCKIMLIKNO	
											AND O.ID_SINAV		= B.ID_SINAV	
											AND O.KITAPCIK		= B.KITAPCIK
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT) = CAST(O.SUBENO AS INT)
			LEFT JOIN V3Ogrenci			VO	ON	VO.TCKIMLIKNO	= O.TCKIMLIKNO
			WHERE B.ID_SINAV = @ID_SINAV

			--SELECT * FROM #PUAN

			--	INTO #KONU
			SELECT	O.TCKIMLIKNO,
					count(DISTINCT c.SORUNO_A) SORUSAYISI,
					c.DURUM,
					d.TAKMAAD DERSAD,
					isnull(u.KOD,'') KOD,
					isnull(u.AD,'') KONUAD,
					max(b.YUZDEDOGRU) YUZDE,
					(SELECT COUNT(1) FROM SinavAnahtar WHERE ID_SINAVDERS=D.ID_SINAVDERS AND  ID_SINAVKITAPCIK=B.ID_SINAVKITAPCIK) TOPLAMSORU,
					o.ID_SINAV
					,b.BOLUMNO
					,(	SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR) 
						FROM SinavOgrenci K WITH(NOLOCK) 
						INNER JOIN SinavDosya D ON D.ID_SINAVDOSYA = K.ID_SINAVDOSYA
						WHERE K.TCKIMLIKNO = o.TCKIMLIKNO and k.ID_SINAV = o.ID_SINAV 
						ORDER BY D.OTURUM
						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
			into #KONU
			from SinavOgrenci			o
			JOIN v3Sube					S	ON	CAST(S.SUBENO AS INT)	= CAST(O.SUBENO AS INT)
			LEFT JOIN V3Ogrenci			v	ON  v.TCKIMLIKNO			= o.TCKIMLIKNO
			JOIN vw_SinavOgrenciBolum	b	ON	B.TCKIMLIKNO			= O.TCKIMLIKNO 
											AND B.ID_SINAV				= O.ID_SINAV
											AND B.KITAPCIK				= O.KITAPCIK
			JOIN vw_SinavOgrenciSoru	c	ON	C.TCKIMLIKNO			= B.TCKIMLIKNO 
											AND C.ID_SINAVDERS			= B.ID_SINAVDERS
											AND C.ID_SINAVKITAPCIK		= B.ID_SINAVKITAPCIK
			JOIN SinavDers				d	ON	d.ID_SINAVDERS			= b.ID_SINAVDERS
											and d.ID_SINAV				= o.ID_SINAV					
			JOIN v3SinavDersUnite		u	ON  u.KOD					= C.KOD
			WHERE	(o.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')
				AND (S.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((V.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	or (@sID_SINIF	='[]' and o.SINIF LIKE 'OKY-%') )
				AND O.ID_SINAV=@sID_SINAV
			GROUP BY c.DURUM,d.TAKMAAD,u.kod,U.AD,D.ID_SINAVDERS,o.ID_SINAV,B.ID_SINAVKITAPCIK,O.TCKIMLIKNO,b.BOLUMNO
			ORDER BY d.TAKMAAD

			SELECT DISTINCT
					TCKIMLIKNO,
					KONUAD,
					DERSAD,
					KOD,					
					BOLUMNO,
					YUZDE AS BOLUMYUZDE,TOPLAMSORU,ISNULL([D],0) DOGRU,ISNULL([Y],0) YANLIS,ISNULL([B],0) BOS,ID_SINAV,
					ISNULL(
						CAST(
							((100 
								/ NULLIF(
										CAST(
											(CAST(ISNULL([D],0) AS INT)+CAST(ISNULL([Y],0) AS INT)+CAST(ISNULL([B],0) AS INT)) 
										AS DECIMAL(11,2) 
									),0) )
								* CAST([D] AS INT) 
						) AS DECIMAL(11,2)) 
					,0) AS YUZDE,
					(	SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR) 
						FROM SinavOgrenci K WITH(NOLOCK) 
						INNER JOIN SinavDosya D ON D.ID_SINAVDOSYA = K.ID_SINAVDOSYA
						WHERE K.TCKIMLIKNO = p.TCKIMLIKNO and k.ID_SINAV = p.ID_SINAV 
						ORDER BY D.OTURUM
						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
			INTO #TT
			FROM ( SELECT * FROM #KONU  )AS GTABLO
			PIVOT ( SUM(SORUSAYISI) FOR DURUM IN ([D],[Y],[B]) ) AS p
			order by ID_SINAV,DERSAD,TOPLAMSORU,KOD
			
			---------------------------------------------------------- SORGULAR ------------------------------------------------------

			--SORGU 1
			SELECT	DISTINCT  
					 O.TCKIMLIKNO
					,O.AD+' '+O.SOYAD ADSOYAD
					,O.SINIF
					,VS.AD SUBEAD
					,S.AD SINAVAD
					,CONVERT(VARCHAR, S.SINAVTARIH ,105) SINAVTARIH
					,(	SELECT STUFF((SELECT   ',' +CAST(K.KITAPCIK AS VARCHAR) 
						FROM SinavOgrenci K WITH(NOLOCK) 
						INNER JOIN SinavDosya D ON D.ID_SINAVDOSYA = K.ID_SINAVDOSYA
						WHERE K.TCKIMLIKNO = SOT.TCKIMLIKNO and k.ID_SINAV = S.ID_SINAV 
						ORDER BY D.OTURUM
						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 1, '')) KITAPCIK
					,OS.PUAN
					,PT.AD PUANTURU
					--,UPPER(ST.KISAAD+' SINAV SONUÇ BELGESİ') AS SINAVTURU
					,UPPER(S.RAPORBASLIK) AS SINAVTURU
					--,UPPER(ST.AD) AS SINAVTURUUZUN
					,'Testlerdeki Doğru ve Yanlış Sayıları' AS SINAVTURUUZUN
					,ST.ID_SINAVTURU
					,VD.ACIKLAMA+' Eğitim Öğretim Yılı' DONEM
					,OS.SINIFSIRA
					,OS.OKULSIRA
					,OS.ILCESIRA
					,OS.ILSIRA
					,OS.GENELSIRA
					,S.PUANGIZLE
					,SINIFKATILIM	= SOT.KATILIM_SINIF
					,SUBEKATILIM	= SOT.KATILIM_OKUL
					,ILCEKATILIM	= SOT.KATILIM_ILCE
					,ILKATILIM		= SOT.KATILIM_IL
					,GENELKATILIM	= SOT.KATILIM_GENEL
					,ID_KADEME		= ISNULL((SELECT TOP 1 ID_KADEME FROM v3KademeBilgi KB WHERE KB.ID_KADEME3 = S.ID_KADEME3),0)
			INTO #T1
			FROM SinavOgrenci		O
			JOIN Sinav				S	ON	S.ID_SINAV			= O.ID_SINAV
			JOIN SinavTuru			ST	ON	ST.ID_SINAVTURU		= S.ID_SINAVTURU
			JOIN SinavOgrenciToplam	SOT	ON	SOT.ID_SINAV		= O.ID_SINAV
										AND SOT.TCKIMLIKNO		= O.TCKIMLIKNO
		LEFT JOIN SinavOgrenciPuan	OS	ON	OS.ID_SINAV			= O.ID_SINAV
										AND OS.TCKIMLIKNO		= O.TCKIMLIKNO
		LEFT JOIN SinavPuanTuru		PT	ON	PT.ID_SINAVPUANTURU	= OS.ID_SINAVPUANTURU	
		LEFT JOIN V3Ogrenci			VO	ON	VO.TCKIMLIKNO		= O.TCKIMLIKNO
			JOIN V3Sube				VS	ON	CAST(VS.SUBENO AS INT) = CAST(O.SUBENO AS INT)
			JOIN v3AktifDonem		VD	ON  VD.DONEM			= S.DONEM
			JOIN SinavKitapcik		K	ON	K.ID_SINAV			= O.ID_SINAV
										AND	K.AD				= O.KITAPCIK
			WHERE	(o.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI	='[]')
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((VO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF))) or (@sID_SINIF	='[]' and o.SINIF LIKE 'OKY-%') )
				AND	O.ID_SINAV		= @sID_SINAV
			ORDER BY SUBEAD,SINIF,ADSOYAD

			--SORGU 2
			SELECT DISTINCT  P.TCKIMLIKNO,P.DERSAD,TOPLAMSORU,P.DOGRU,P.YANLIS,P.BOS,P.NET
				,P.PUAN,P.OLCEKSINAVI

				,SINIFNETORTALAMA	= OB.NET_SINIFORT
				,SINIFDOGRUORTALAMA	= OB.DOGRU_SINIFORT
				,GENELDOGRUORTALAMA	= OB.DOGRU_GENELORT
				,YUZDEBASARI		= OB.YUZDENET

				--,RANK() over(partition by P.ID_DERS,P.ID_SINIF			order by p.NET desc)	SINIFSIRA
				--,RANK() over(partition by P.ID_DERS,P.ID_SUBE			order by p.NET desc)		OKULSIRA
				--,RANK() over(partition by P.ID_DERS,P.ILCE				order by p.NET desc)	ILCESIRA
				--,RANK() over(partition by P.ID_DERS,P.IL				order by p.NET desc)		ILSIRA
				--,RANK() over(partition by P.ID_DERS						order by p.NET desc)	GENELSIRA
				,SINIFSIRA	= OB.NET_SINIFSIRA
				,OKULSIRA	= OB.NET_OKULSIRA
				,ILCESIRA	= OB.NET_ILCESIRA
				,ILSIRA		= OB.NET_ILSIRA
				,GENELSIRA	= OB.NET_GENELSIRA

				,P.BOLUMNO
				,OB.ID_SINAV
			INTO #T2
			FROM #PUAN	P
			JOIN vw_SinavOgrenciBolum	OB	ON	OB.ID_SINAV		= P.ID_SINAV 
											AND OB.TCKIMLIKNO	= P.TCKIMLIKNO 
											AND OB.ID_SINAVDERS = P.ID_SINAVDERS
			JOIN SinavOgrenci			O	ON	O.TCKIMLIKNO	= OB.TCKIMLIKNO
											AND O.ID_SINAV		= OB.ID_SINAV	
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT) = CAST(O.SUBENO AS INT)	
			WHERE	(P.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((P.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF))) or (@sID_SINIF	='[]' and o.SINIF LIKE 'OKY-%') )
				AND P.ID_SINAV=@sID_SINAV

			INSERT INTO #T2			
			SELECT DISTINCT  T.TCKIMLIKNO,'TOPLAM',SUM(TOPLAMSORU), ST.TD,ST.TY,ST.TB,ST.TN
				,0 PUAN
				,T.OLCEKSINAVI
				
				,cast(avg(T.SINIFNETORTALAMA		 ) as decimal(8,2))	
				,cast(avg(T.SINIFDOGRUORTALAMA		 ) as decimal(8,2))	
				,cast(avg(T.GENELDOGRUORTALAMA		 ) as decimal(8,2))	
				,cast((ST.TN/SUM(TOPLAMSORU)*100.0	 ) as decimal(8,2))	

				,ST.TN_SINIFSIRA	
				,ST.TN_OKULSIRA
				,ST.TN_ILCESIRA
				,ST.TN_ILSIRA
				,ST.TN_GENELSIRA
				,@GENEL 
				,T.ID_SINAV
			FROM #T2 T
			JOIN SinavOgrenciToplam	ST	ON	ST.ID_SINAV		= T.ID_SINAV
										AND	ST.TCKIMLIKNO	= T.TCKIMLIKNO
			JOIN Sinav				S	ON	S.ID_SINAV		= T.ID_SINAV
			WHERE (SELECT TOP 1 ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = S.ID_KADEME3) = 4
			GROUP BY T.TCKIMLIKNO,T.OLCEKSINAVI, ST.TD,ST.TY,ST.TB,ST.TN
				,ST.TN_SINIFSIRA	
				,ST.TN_OKULSIRA
				,ST.TN_ILCESIRA
				,ST.TN_ILSIRA
				,ST.TN_GENELSIRA
				,T.ID_SINAV

			
			--SORGU 3
			SELECT DISTINCT O.TCKIMLIKNO,C.SORUNO,C.CEVAP OGRENCICEVAP,C.DOGRUCEVAP DOGRUCEVAP,DURUM,C.ID_SINAVDERS,D.TAKMAAD DERSAD,BOLUMNO
			INTO #T3
			FROM  vw_SinavOgrenciSoru	c	
			JOIN SinavOgrenci			O	ON	O.TCKIMLIKNO			= C.TCKIMLIKNO
											AND O.ID_SINAV				= C.ID_SINAV			
			JOIN SinavDers				D	ON	D.ID_SINAVDERS			= C.ID_SINAVDERS	
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT)	= CAST(O.SUBENO AS INT)	
		LEFT JOIN V3OGRENCi				VO  ON  VO.TCKIMLIKNO			= O.TCKIMLIKNO
			WHERE	(o.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI = '[]')		
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	= '[]')
				AND ((VO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	or (@sID_SINIF	= '[]' and o.SINIF LIKE 'OKY-%') )
				AND O.ID_SINAV=@sID_SINAV
			
			--SORGU 4

			
			SELECT	TCKIMLIKNO	= B.TCKIMLIKNO,
					DERSAD		= SD.TAKMAAD,
					OGRENCI		= B.YUZDENET,
					--ID_SINIF	= PO.ID_SINIF,
					SINIF		= YUZDENET_SINIFORT,
					GENEL		= YUZDENET_GENELORT,
					BOLUMNO		= SD.BOLUMNO
			INTO #GRAFIK
			FROM vw_SinavOgrenciBolum	B
			JOIN SinavDers				SD	ON	SD.ID_SINAVDERS = B.ID_SINAVDERS
			JOIN #PUAN					PO	ON	PO.TCKIMLIKNO	= B.TCKIMLIKNO 
											AND PO.DERSAD		= SD.TAKMAAD
			JOIN V3Sube					VS	ON	CAST(VS.SUBENO AS INT)	= CAST(PO.SUBENO AS INT)			
			WHERE	B.ID_SINAV = @sID_SINAV 
				AND	(PO.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')	
				AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
				AND ((PO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	OR(@sID_SINIF	= '[]' and PO.SINIF LIKE 'OKY-%') )		


		--	SELECT	YUZDENETORT	=CONVERT(DECIMAL(18,2),AVG(CONVERT(DECIMAL(18,2),YUZDENET))) ,					
		--			DERSAD		= DERSAD,
		--			ISLEM		= 'OGRENCI',
		--			DEGER		= CAST(TCKIMLIKNO AS VARCHAR(20)),
		--			BOLUMNO		= BOLUMNO
		--	INTO	#T4 
		--	FROM	#PUAN P
		--	WHERE	(TCKIMLIKNO IN (SELECT value FROM OPENJSON (@sTC_OGRENCI)) OR @sTC_OGRENCI ='[]')
		--		AND ID_SINAV=@sID_SINAV				
		--	GROUP BY ID_SINAV,TCKIMLIKNO,DERSAD,BOLUMNO
		--UNION ALL
		--	SELECT	CONVERT(DECIMAL(18,2),AVG(CONVERT(DECIMAL(18,2),YUZDENET)))YUZDENETORT,
		--			DERSAD,
		--			ISLEM='SINIF',
		--			DEGER=	CAST(ID_SINIF AS VARCHAR(20)) 
		--			,BOLUMNO
		--	FROM	#PUAN 
		--	WHERE	(ID_SINIF IN (SELECT value FROM OPENJSON (@sID_SINIF)) OR @sID_SINIF ='[]') AND ID_SINAV=@sID_SINAV				
		--	GROUP BY ID_SINAV,ID_SINIF,DERSAD,BOLUMNO
		--UNION ALL
		--	SELECT	CONVERT(DECIMAL(18,2),AVG(CONVERT(DECIMAL(18,2),YUZDENET)))YUZDENETORT,
		--			DERSAD,
		--			ISLEM='GENEL',
		--			'GENEL'  AS DEGER
		--			,BOLUMNO
		--	FROM	#PUAN 
		--	WHERE	ID_SINAV=@sID_SINAV			
		--	GROUP BY ID_SINAV,DERSAD,BOLUMNO
		--	ORDER BY DERSAD,ISLEM,DEGER	,BOLUMNO		

			--SORGU 5
			SELECT	TCKIMLIKNO,
					KONUAD,
					DERSAD,
					KOD,
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE 
					,BOLUMNO
					,KITAPCIK
			INTO	#T5
			FROM	#TT
			GROUP BY KOD,KONUAD,DERSAD,TCKIMLIKNO,BOLUMNO,KITAPCIK
		union all
			SELECT  TCKIMLIKNO,
					DERSAD,
					DERSAD,
					'',
					CAST(AVG(BOLUMYUZDE)AS DECIMAL(11,2)) BOLUMYUZDE,
					SUM(DOGRU+YANLIS+BOS) SORU,
					SUM(DOGRU) DOGRU,
					SUM(YANLIS) YANLIS,
					SUM(BOS) BOS,
					CAST(AVG(YUZDE)AS DECIMAL(11,2)) YUZDE 
					,BOLUMNO
					,KITAPCIK
			FROM	#TT
			GROUP BY DERSAD,TCKIMLIKNO,BOLUMNO,KITAPCIK
			order by TCKIMLIKNO,DERSAD,KOD
			--------------------------------------------------------------------------------------------------
			SELECT COUNT(ID_SINAVDERS) ASS 
			INTO #RE 
			FROM #T3 
			WHERE TCKIMLIKNO=(SELECT TOP 1 TCKIMLIKNO FROM #T3)
			GROUP BY ID_SINAVDERS

		
			--SELECT DISTINCT  PO.TCKIMLIKNO,T.DERSAD,T.YUZDENETORT OGRENCI,PO.ID_SINIF ,CAST(0 AS float) SINIF,CAST(0 AS float) GENEL,T.BOLUMNO
			--INTO #GRAFIK
			--FROM #T4	T
			--JOIN #PUAN  PO	ON	PO.TCKIMLIKNO=T.DEGER AND T.ISLEM='OGRENCI'  AND T.DERSAD = PO.DERSAD
			--JOIN V3Sube	VS	ON	CAST(VS.SUBENO AS INT)	= CAST(PO.SUBENO AS INT)									
			--WHERE	(PO.TCKIMLIKNO	IN (SELECT value FROM OPENJSON (@sTC_OGRENCI))	OR @sTC_OGRENCI ='[]')	
			--	AND (VS.ID_SUBE		IN (SELECT value FROM OPENJSON (@sID_SUBE))		OR @sID_SUBE	='[]')
			--	AND ((PO.ID_SINIF	IN (SELECT value FROM OPENJSON (@sID_SINIF)))	or (@sID_SINIF	= '[]' and PO.SINIF LIKE 'OKY-%') )
			--	
			--UPDATE K
			--SET K.SINIF=T.YUZDENETORT
			--	,K.GENEL=T1.YUZDENETORT
			--FROM #GRAFIK		K 			
			--JOIN #T4	T	ON K.ID_SINIF=T.DEGER AND T.ISLEM='SINIF' AND T.DERSAD = K.DERSAD
			--JOIN #T4	T1	ON T1.ISLEM='GENEL'  AND T1.DERSAD = K.DERSAD



			
		SELECT TCKIMLIKNO,BURSORANI,ID_SINAVDERS,BURSTUR,ROW_NUMBER () OVER(ORDER BY BURSORANI DESC ,BURSTUR) RN
		INTO #BURSOGRENCI
		FROM BurslulukSinavOgrenciSonuc
		WHERE ID_SINAV = @sID_SINAV

		SELECT TCKIMLIKNO,MIN(RN) RN
		INTO #ALINANBURS
		FROM #BURSOGRENCI
		GROUP BY TCKIMLIKNO

		SELECT TCKIMLIKNO,MAX(ID_BURSOGRENCI) ID_BURSOGRENCI
		INTO #BurslulukSinavOgrenci
		FROM BurslulukSinavOgrenci 
		WHERE ID_SINAV	= @sID_SINAV
		GROUP BY TCKIMLIKNO
		
		SELECT BO.TCKIMLIKNO
			,BO.BURSORANI
			,BURSTUR
			,BURS_IDSINAVDERS	= ISNULL(SD.ID_SINAVDERS,0)
			,BURS_BOLUMNO		= ISNULL(SD.BOLUMNO,0)
			,BURS_DERSAD		= ISNULL(SD.TAKMAAD,'')
		INTO #OGRENCIBURS
		FROM #BURSOGRENCI	BO
		JOIN #ALINANBURS	AB	ON	AB.RN			= BO.RN
		LEFT JOIN SinavDers	SD	ON	SD.ID_SINAVDERS = BO.ID_SINAVDERS



			IF @sISLEM = 1						--JSON SEND
			BEGIN
					select(
						select * from(
							select 
							(						 
								SELECT * FROM #T1
								FOR JSON AUTO
							) as t1
							,( 
								SELECT * FROM #T2
								FOR JSON AUTO
							)as t2
							,(
								SELECT *,MAXSORU=(SELECT MAX (ASS) FROM #RE),DERSSAYISI=(SELECT COUNT (1) FROM #RE) FROM #T3 
								ORDER BY ID_SINAVDERS,SORUNO
								FOR JSON AUTO
							) as t3 
							,( 
								SELECT * FROM #GRAFIK
								ORDER BY ID_SINIF,TCKIMLIKNO					
								FOR JSON AUTO
							)as t4
							,(
								SELECT * FROM #T5
								ORDER BY DERSAD,KOD
								FOR JSON AUTO
							) as t5 
						) as tablo FOR JSON AUTO
					) as tt
			END
			
			IF @sISLEM = 2						--DATASET SEND
			BEGIN
				SELECT DISTINCT * FROM #T1

				SELECT DISTINCT * FROM #T2

				SELECT DISTINCT *,MAXSORU=(SELECT MAX (ASS) FROM #RE),DERSSAYISI=(SELECT COUNT (1) FROM #RE) FROM #T3 
				ORDER BY ID_SINAVDERS,SORUNO

				SELECT DISTINCT * FROM #GRAFIK				

				SELECT DISTINCT * FROM #T5
				ORDER BY DERSAD,KOD
				
				SELECT distinct TCKIMLIKNO, ADSOYAD, SINIF, SINAVAD, SINAVTARIH, KITAPCIK, SUBEAD, SINIFKATILIM, SUBEKATILIM, GENELKATILIM, SINAVTURU, PUANGIZLE, TCKIMLIKNO, ID_KADEME FROM #T1

				SELECT DISTINCT T.TCKIMLIKNO
						,BURS_DERSAD	= ISNULL(OB.BURS_DERSAD	,'')
						,BURSTUR		= ISNULL(OB.BURSTUR		,0)
						,BURSORANI		= ISNULL(OB.BURSORANI	,0)
				FROM	#PUAN						T
				LEFT JOIN #OGRENCIBURS				OB	ON	OB.TCKIMLIKNO		= T.TCKIMLIKNO
				LEFT JOIN #BurslulukSinavOgrenci	BS2	ON	BS2.TCKIMLIKNO		= T.TCKIMLIKNO 
				LEFT JOIN BurslulukSinavOgrenci		BSO	ON	BSO.ID_BURSOGRENCI	= BS2.ID_BURSOGRENCI 

			END
			
			DROP TABLE IF EXISTS #PUAN
			DROP TABLE IF EXISTS #KONU
			DROP TABLE IF EXISTS #TT
			DROP TABLE IF EXISTS #RE
			DROP TABLE IF EXISTS #GRAFIK
			DROP TABLE IF EXISTS #T1
			DROP TABLE IF EXISTS #T2
			DROP TABLE IF EXISTS #T3
			--DROP TABLE IF EXISTS #T4
			DROP TABLE IF EXISTS #T5
			DROP TABLE IF EXISTS #ALINANBURS
			DROP TABLE IF EXISTS #BurslulukSinavOgrenci
			DROP TABLE IF EXISTS #BURSOGRENCI
			DROP TABLE IF EXISTS #OGRENCIBURS

		END
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_v2FrekansKampus]...';


GO
ALTER procedure [dbo].[sp_v2FrekansKampus]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,	
	@ID_SUBE			INT				= NULL,	
	@ID_SUBEs			VARCHAR(MAX)	= NULL,	
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,	
	@DERSAD				VARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	
AS
BEGIN
	
	DECLARE 
	@_ISLEM				INT				= @ISLEM			,
	@_TCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO		,
	@_TC_OGRENCI		VARCHAR(11)		= @TC_OGRENCI		,
	@_TC_OGRETMEN		VARCHAR(11)		= @TC_OGRETMEN		,
	@_OTURUM			VARCHAR(36)		= @OTURUM			,
	@_ID_MENU			INT				= @ID_MENU			,
	@_DONEM				char(4)			= @DONEM			,
	@_ID_KADEME			INT				= @ID_KADEME		,
	@_ID_KADEMEs		VARCHAR(MAX)	= @ID_KADEMEs		,
	@_ID_KADEME3		VARCHAR(MAX)	= @ID_KADEME3		,
	@_ID_SINAVTURU		VARCHAR(MAX)	= @ID_SINAVTURU		,	
	@_ID_SUBE			INT				= @ID_SUBE			,	
	@_ID_SUBEs			VARCHAR(MAX)	= @ID_SUBEs			,	
	@_DERSLIST			VARCHAR(MAX)	= @DERSLIST			,
	@_ID_SINIF			INT				= @ID_SINIF			,	
	@_DERSAD			VARCHAR(MAX)	= @DERSAD			,
	@_FREKANSKARNE		BIT				= @FREKANSKARNE	
	
	DECLARE @_PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @_LOGJSON VARCHAR(MAX)
	SET @_LOGJSON = (
		SELECT	 ISLEM			= @_ISLEM			
				,TCKIMLIKNO		= @_TCKIMLIKNO		
				,TC_OGRENCI		= @_TC_OGRENCI		
				,TC_OGRETMEN	= @_TC_OGRETMEN	
				,OTURUM			= @_OTURUM			
				,ID_MENU		= @_ID_MENU		
				,DONEM			= @_DONEM			
				,ID_KADEME		= @_ID_KADEME		
				,ID_KADEMEs		= @_ID_KADEMEs
				,ID_KADEME3		= @_ID_KADEME3		
				,ID_SINAVTURU	= @_ID_SINAVTURU	
				,ID_SUBE		= @_ID_SUBE		
				,ID_SUBEs		= @_ID_SUBEs	
				,DERSLIST		= @_DERSLIST		
				,ID_SINIF		= @_ID_SINIF		
				,DERSAD			= @_DERSAD			
				,FREKANSKARNE	= @_FREKANSKARNE	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @_OTURUM, @TCKIMLIKNO = @_TCKIMLIKNO, @ID_MENU = @_ID_MENU, @LOGJSON = @_LOGJSON, @ISLEM = @_ISLEM, @PROSEDURADI = @_PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			
			BEGIN

				DECLARE @_ID_STGENEL INT=999999 
				--1,2,8
				
				IF @_DONEM='' OR @_DONEM IS NULL
					SET @_DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
				--2,5
						
				BEGIN
						DROP TABLE IF EXISTS #ORTALAMA3
						DROP TABLE IF EXISTS #T2
						DROP TABLE IF EXISTS #T1
						DROP TABLE IF EXISTS #Filtre2
						DROP TABLE IF EXISTS #GenelFiltre2
						DROP TABLE IF EXISTS #FiltreFrekans2
						DROP TABLE IF EXISTS #OgrenciSinifListe2 
						DROP TABLE IF EXISTS #GenelFrekans2
						DROP TABLE IF EXISTS #GenelSira2
						DROP TABLE IF EXISTS #GenelZumreFrekans2
						DROP TABLE IF EXISTS #GenelZumreSira2
						DROP TABLE IF EXISTS #GenelKampusFrekans2
						DROP TABLE IF EXISTS #GenelKampusSira2			
						DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
						DROP TABLE IF EXISTS #GenelZumreKampusSira2				
						DROP TABLE IF EXISTS #T
						DROP TABLE IF EXISTS #Filtre
						DROP TABLE IF EXISTS #FiltreFrekans
						DROP TABLE IF EXISTS #OgrenciSinifListe 
						DROP TABLE IF EXISTS #GenelFrekans
						DROP TABLE IF EXISTS #GenelSira
						DROP TABLE IF EXISTS #GenelZumreFrekans
						DROP TABLE IF EXISTS #GenelZumreSira
						DROP TABLE IF EXISTS #GenelKampusFrekans
						DROP TABLE IF EXISTS #GenelKampusSira
						DROP TABLE IF EXISTS #GenelZumreKampusFrekans
						DROP TABLE IF EXISTS #GenelZumreKampusSira
						DROP TABLE IF EXISTS #GenelFrekansKatki
						DROP TABLE IF EXISTS #ARALIK
						DROP TABLE IF EXISTS #DERSLER
						DROP TABLE IF EXISTS #ETKI
						DROP TABLE IF EXISTS #SINAVTURU
						DROP TABLE IF EXISTS #SUBELER
						DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem
					END

				IF @_ISLEM NOT IN (6, 7, 9)
				BEGIN
				
					DECLARE @_SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
					--INSERT INTO @_SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
					INSERT INTO @_SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
					SELECT * INTO #SINAVTURU FROM @_SINAVTURU	
					--2,3,4,5
										
					SELECT	 T.ID_FREKANSOGRENCIDETAY
							,T.ID_SINAVTURU
							,T.ID_KADEME3
							,T.ID_OGRENCI
							,T.TC_OGRENCI
							,T.TAKMAAD
							,T.ID_SINAV
							,T.NET
							,T.SS
							,T.ILK_ID_SINAV
							,T.ILK_NET
							,T.ILK_SS
							,T.FREKANS
							,T.DONEM
							,T.ID_SINIF
							,T.ID_SUBE
							,T.ID_DERS
							,T.TC_OGRETMEN
							,T.OGRETMENADSOYAD
							,T.DERSAD
							,T.SUBEAD
							,T.SINIFAD
							,T.HBNET
							,KB.ID_KADEME
					into #v2FrekansOgrenciDetayDonem 
					from v2FrekansOgrenciDetay	T
					join v3KademeBilgi			KB	ON	KB.ID_KADEME3	= T.ID_KADEME3
					where	DONEM = @_DONEM 
					--1,2,3,4,5,6,8
				
				END		
				
				IF @_ISLEM IN (1,2)
				BEGIN
				
					DECLARE @ID_FREKANSSORGU	 INT = NULL
					DECLARE @ID_FREKANSSORGUDERS INT = NULL
					
					SET @ID_FREKANSSORGU	= (	SELECT ID_FREKANSSORGU 
												FROM v2FrekansSorgu 
												WHERE	DONEM			= @_DONEM 
													AND ID_SINAVTURULIST= @_ID_SINAVTURU 
													AND ID_KADEME3LIST	= @_ID_KADEME3
													AND DERSLIST		IS NULL
											)				
					IF @ID_FREKANSSORGU IS NULL		
					BEGIN
						DECLARE @TABLEADD TABLE (ID INT)
						INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
						OUTPUT inserted.ID_FREKANSSORGU INTO @TABLEADD(ID)
						VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, NULL)

						SET @ID_FREKANSSORGU = (SELECT TOP 1 ID FROM @TABLEADD)

						INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
						SELECT @ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY
						FROM v2FrekansOgrenciDetay WITH(NOLOCK) 
						WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) )--OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	))
							AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) )--OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	))
							AND DONEM = @_DONEM
						ORDER BY FREKANS

					END

					SET @ID_FREKANSSORGUDERS= (	SELECT ID_FREKANSSORGU 
												FROM v2FrekansSorgu 
												WHERE	DONEM			= @_DONEM 
													AND ID_SINAVTURULIST= @_ID_SINAVTURU 
													AND ID_KADEME3LIST	= @_ID_KADEME3
													AND (DERSLIST		= @_DERSLIST  OR (@_DERSLIST IS NULL AND DERSLIST IS NULL) )
											)
					IF @ID_FREKANSSORGUDERS IS NULL	
					BEGIN
						DELETE FROM @TABLEADD 
						INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
						OUTPUT INSERTED.ID_FREKANSSORGU INTO @TABLEADD(ID)
						VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, @_DERSLIST)

						SET @ID_FREKANSSORGUDERS = (SELECT TOP 1 ID FROM @TABLEADD)

						INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
						SELECT @ID_FREKANSSORGUDERS , S.ID_FREKANSOGRENCIDETAY
						FROM v2FrekansSorguDetay	S
						JOIN v2FrekansOgrenciDetay	T WITH(NOLOCK) 	ON	T.ID_FREKANSOGRENCIDETAY = S.ID_FREKANSOGRENCIDETAY
						WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) )--OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		))
							AND S.ID_FREKANSSORGU	= @ID_FREKANSSORGU
							AND DONEM				= @_DONEM
						ORDER BY FREKANS

					END

				END

			END
			
			IF @_ISLEM = 1	--	İLK LİSTE (FR KAMPUS)		
			BEGIN 
				
				SELECT DISTINCT ID_SUBE INTO #SUBELER FROM v3SubeYetki WHERE TCKIMLIKNO = @_TCKIMLIKNO AND ID_KULLANICITIPI NOT IN (4,5)

				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 DERSAD
						,T.ID_SUBE
						,ID_KADEME
						,T.SUBEAD
				INTO #Filtre
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER						S	ON	S.ID_SUBE	= T.ID_SUBE
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBEs		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBEs		)))
				GROUP BY DERSAD, SUBEAD, T.ID_SUBE, SUBEAD,ID_KADEME

				---- KAMPÜS Genel ve KADEME Genel SIRALAMA
				SELECT ID_SUBE, ID_KADEME, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)),ADET = 0
				INTO #GenelFrekans
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
				GROUP BY ID_SUBE, ID_KADEME
			
				UPDATE GF SET 
					GF.ADET = G.ADET
				FROM #GenelFrekans GF
				JOIN (SELECT COUNT(ID_KADEME) ADET,ID_KADEME FROM #GenelFrekans GROUP BY ID_KADEME) G ON G.ID_KADEME = GF.ID_KADEME

				DECLARE @_GENELADET INT = (SELECT COUNT(1) FROM #GenelFrekans)

				SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC), SNKADEME =  ROW_NUMBER() OVER (PARTITION BY ID_KADEME ORDER BY FREKANS DESC)
				INTO #GenelSira FROM #GenelFrekans
				WHERE FREKANS IS NOT NULL
				-----------


				-- Liste
				DROP TABLE IF EXISTS #T
				SELECT   DISTINCT
						 ID_KADEME		= K.ID_KADEME
						,ID_SUBE		= F.ID_SUBE
						,[SIRA]			= ISNULL(G.SN,@_ID_STGENEL) 		
						,[KAMPÜS]		= F.SUBEAD
						,[KADEME]		= K.AD	
					
						,[FREKANS]		= G.FREKANS--= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')					
						,[KADEME SIRA]	= CASE WHEN (SELECT COUNT(DISTINCT ID_KADEME) FROM #GenelSira) > 1 THEN ISNULL(CAST(G.SNKADEME AS VARCHAR) + ' / ' + CAST(G.ADET AS VARCHAR),'-') ELSE NULL END
						,[GENEL]		= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET AS VARCHAR),'-')
				INTO		#T
				FROM		#Filtre				F
				INNER JOIN	v3Kademe			K	ON	K.ID_KADEME	= F.ID_KADEME
				LEFT  JOIN	#GenelSira			G	ON	G.ID_KADEME	= F.ID_KADEME
													AND G.ID_SUBE	= F.ID_SUBE

				select(
					select * from(
						select 
						(					
							SELECT  
									ID_KADEME		
								   ,ID_SUBE		
								   ,[SIRA]			
						 		   ,[KAMPÜS]		
								   ,[KADEME]						
								   ,[FREKANS]	= ISNULL(CAST(FREKANS AS VARCHAR),'-')	
								   ,[KADEME SIRA]	
								   ,[GENEL]						
							FROM #T t order by t.[FREKANS] desc
							FOR JSON AUTO
						) as t												
					) as tablo FOR JSON AUTO
				) as tt					

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

			END
			IF @_ISLEM = 2	--	GENEL SIRALAMA				
			BEGIN 
		
				BEGIN
		
					SELECT	 ID_SINAVTURU
							,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
					INTO #GenelFiltre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					GROUP BY ID_SINAVTURU


					SELECT	 DERSAD
							,T.ID_SINIF
							,ID_SINAVTURU
							,ID_KADEME3
					INTO #Filtre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
						AND ID_SINIF	= @_ID_SINIF
					GROUP BY  ID_SINIF,DERSAD, ID_SINAVTURU, ID_KADEME3
				
			
					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					INTO #FiltreFrekans2 FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.DERSAD = O.DERSAD AND D.ID_SINIF = O.ID_SINIF AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU		
				UNION ALL			
					SELECT O.ID_SINIF, O.DERSAD,  @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) = 1
					GROUP BY O.ID_SINIF, O.DERSAD
				UNION ALL			
					SELECT O.ID_SINIF, 'GENEL',  @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) > 1
					GROUP BY O.ID_SINIF
			



				-- Frekans Katkı İçin
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					INTO #GenelFrekansKatki 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					GROUP BY ID_SINIF, ID_SINAVTURU, DERSAD
				UNION ALL				
					SELECT ID_SINIF, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					FROM #v2FrekansOgrenciDetayDonem	T
					WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					GROUP BY ID_SINIF, DERSAD


					-- Öğretmen Genel
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SINAVTURU
				UNION ALL				
					SELECT ID_SINIF, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM #v2FrekansOgrenciDetayDonem	T			
					GROUP BY ID_SINIF

					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
					INTO #GenelSira2 FROM #GenelFrekans2 T
					WHERE FREKANS IS NOT NULL
				
					--------------------------------------------------------------------

					-- Öğretmen Zümre Genel
					SELECT ID_SINIF, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD, ID_SINAVTURU
				UNION ALL			
					SELECT ID_SINIF, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD


					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
					INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
					WHERE FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Kampus Genel
					SELECT ID_SINIF, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))					
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE


					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Zümre Kampus Genel
					SELECT ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD

					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------


					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
					INTO #OgrenciSinifListe2 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 														
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU
				UNION ALL 			
					SELECT O.ID_SINIF, O.DERSAD, @_ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD

			

					INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@_ID_STGENEL,'GENEL','GNL',1,2)



					SELECT ID_SINAVTURU
						,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
						,MAX(GF.FREKANS) MAXIMUM
						,MIN(GF.FREKANS) MINIMUM 						
						--,MINIMUM	= IIF(MIN(GF.FREKANS) < 0, 0 , MIN(GF.FREKANS) )
						, DERSAD
					INTO #ARALIK 
					FROM #GenelFrekansKatki	GF
					GROUP BY ID_SINAVTURU, DERSAD


					SELECT ID_SINAVTURU
						,KADEME1 = MINIMUM + ARALIK
						,KADEME2 = MINIMUM + (ARALIK*2)
						,KADEME3 = MINIMUM + (ARALIK*3)
						,KADEME4 = MINIMUM + (ARALIK*4)
						, DERSAD
					INTO #ETKI
					FROM #ARALIK
				

				
					SELECT 
						 [SINAV TÜRÜ]		= S.AD 
						,[STKISAAD]			= S.KISAAD
						,[BRANŞ]			= F.DERSAD
						,[ID_SINAVTURU]		= F.ID_SINAVTURU
						,[FREKANS]			= ISNULL( MAX(F.FREKANS) ,0)
						,[FREKANS KATKI]	= --CASE WHEN AVG(F.FREKANS) < 0 THEN 'NEGATİF EKTİ'
												--ELSE 
													CASE
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME1 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİSİZ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME2 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'AZ ETKİLİ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME3 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'NORMAL'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİLİ'
														WHEN AVG(F.FREKANS) >= (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ÇOK ETKİLİ'
														ELSE '---'
													END
												--END
						,[KAMPÜS ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira2	tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira2	K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU  AND K.DERSAD = F.DERSAD	ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[KAMPÜS GENEL]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU								)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU							ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')					
						,[GENEL ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU	AND K.DERSAD = F.DERSAD						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR),'---')
					INTO	#T1
					FROM #FiltreFrekans2				F
					INNER JOIN #OgrenciSinifListe2	O	ON	O.ID_SINIF		= F.ID_SINIF		
														AND O.ID_SINAVTURU	= F.ID_SINAVTURU		
														AND O.DERSAD		= F.DERSAD		
					INNER JOIN #SINAVTURU			S	ON	S.ID_SINAVTURU	= F.ID_SINAVTURU
					LEFT  JOIN #GenelSira2			G	ON	G.ID_SINIF		= F.ID_SINIF		
														AND G.ID_SINAVTURU	= S.ID_SINAVTURU
					WHERE F.FREKANS IS NOT NULL
					GROUP BY S.AD, F.ID_SINIF, F.ID_SINAVTURU, F.DERSAD, G.SN, S.KISAAD

		
				END


				-------------------------------------------------	(2.2)	2. SAYFA ALT


				print 11
				SELECT	 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,MAX(T.SS) SORUSAYISI
						,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
						,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
						,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
						,TC_OGRETMEN
						,ID_DERS
						,T.ID_SUBE
						,T.ID_SINAVTURU
						,ID_SINIF
						,SINIFAD
						,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
						,AVG(ILK_SS) ILK_SS
				INTO	#ORTALAMA3
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU	= @ID_FREKANSSORGU
					AND ID_SINIF			= @_ID_SINIF
				GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD


				SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
						,[BRANŞ]		= DERSAD
						,[SINAV TÜRÜ]	= ST.AD
						,[KAMPÜS]		= SUBEAD
						,[SINIF]		= ORT.SINIFAD	
						,[H.B. NET ORT.]= ORT.HBNET	
						,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
						,ORT.FREKANS		
						,SD.ID_SINIF
						,TC_OGRETMEN
						,SIRA
						,ORT.ID_SINAVTURU
						--,TC_DANISMAN	= K.TCKIMLIKNO
						,[DANIŞMAN]		= K.AD+' '+K.SOYAD
				INTO	#T2
				FROM	#ORTALAMA3	ORT
				JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
										AND ST.SIRA			<> 2
				JOIN	OkyanusDB.DBO.v3SinifPersonel	SD	ON	SD.ID_SINIF = ORT.ID_SINIF AND SD.ID_KULLANICITIPI = 100
				JOIN	OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= SD.TCKIMLIKNO
				WHERE	ORT.FREKANS IS NOT NULL
				ORDER BY ST.SIRA





					select(
							select * from(
								select 
								(						 
									SELECT * FROM #T1
									ORDER BY BRANŞ,ID_SINAVTURU
									FOR JSON AUTO
								) as t1
								,( 
									SELECT * FROM #T2
									ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
									FOR JSON AUTO
								)as t2							
							) as tablo FOR JSON AUTO
						) as tt


					
					
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 

				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2

				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2

				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2
			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

				DROP TABLE IF EXISTS #GenelFrekansKatki


			END
			IF @_ISLEM = 3	--	SINIF ÖĞRENCİ LİSTESİ		
			BEGIN 

				SELECT	[KAMPÜS]			= SUBEAD,
						[SINIF]				= SINIFAD,
						[BRANŞ]				= TAKMAAD,
						[SINAV TÜRÜ]		= ST.AD,
						[AD SOYAD]			= K.AD+' '+K.SOYAD,
						[SORU SAYISI]		= MAX(T.ILK_SS),
						[H.B NET]			= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
						[NET ORT]			= CAST(AVG(T.NET) AS DECIMAL(8,2)),
						[HEDEFE UZAKLIK]	= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),				
					
						--[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
						[FREKANS]	= CAST(		CASE
										WHEN T.ID_SINAVTURU=0 THEN AVG(NET) 
										WHEN T.ID_SINAVTURU IN (5,6)  THEN (	SELECT FREKANS 
																				FROM #v2FrekansOgrenciDetayDonem DD
																				JOIN (SELECT TOP 1 S.ID_SINAV
																							FROM #v2FrekansOgrenciDetayDonem D 
																							JOIN Sinav						 S	ON	S.ID_SINAV	= D.ID_SINAV
																							WHERE	D.TC_OGRENCI	= T.TC_OGRENCI 
																								AND D.ID_SINAVTURU	= T.ID_SINAVTURU
																								AND D.TC_OGRETMEN	= T.TC_OGRETMEN
																								AND D.DERSAD		= T.DERSAD
																							ORDER BY S.SINAVTARIH DESC, ID_SINAV
																				) AS SD  ON DD.TC_OGRENCI	= T.TC_OGRENCI 
																						AND DD.ID_SINAVTURU	= T.ID_SINAVTURU
																						AND DD.TC_OGRETMEN	= T.TC_OGRETMEN
																						AND DD.DERSAD		= T.DERSAD
																						AND DD.ID_SINAV		= SD.ID_SINAV
																			) 
										ELSE 	AVG(FREKANS) 
									END 
							AS DECIMAL(8,2) ) ,-- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					
								
						[TC_OGRENCI]	    = TC_OGRENCI,		
						[TC_OGRETMEN]	    = TC_OGRETMEN,	
						[ID_SINIF]			= T.ID_SINIF,		
						[ID_SINAVTURU]		= T.ID_SINAVTURU	
				INTO	#v2FrekansOgrenciDetay
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				WHERE 	T.ID_SINIF	= @_ID_SINIF
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND T.DERSAD	= @_DERSAD
					AND FREKANS		IS NOT NULL
					AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
				GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET,T.DERSAD
			
				select(
							select * from(
								select 
								(					
									SELECT		* 
									FROM		#v2FrekansOgrenciDetay
									ORDER BY	[AD SOYAD]
									FOR JSON AUTO
								) as t3
												
							) as tablo FOR JSON AUTO
						) as tt
				DROP TABLE #v2FrekansOgrenciDetay
			END
			IF @_ISLEM = 4	--	ÖĞRENCİ FREKANS SINAV LST	
			BEGIN 

				SELECT	 SUBEAD
						,TAKMAAD
						,ST.AD SINAVTURU
						,CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
							ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
						END SINAVADI
						,CAST(CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (	
															SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
															INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
															WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
															GROUP BY YO.TELAFI
														) 
							ELSE						(	T.FREKANS
														)
						END AS decimal(8,2)) SINAVPUANI
						,K.AD+' '+K.SOYAD ADSOYAD
						,SINIFAD
						,SS 
						,CAST(HBNET AS DECIMAL(8,2)) HBNET
						,ILK_SS HEDEF
						,CAST(NET AS DECIMAL(8,2))	 NET
						,S.SINAVTARIH
						,S.ID_SINAVTURU
				INTO	#OGRENCISINAV
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				LEFT JOIN Sinav			S	ON	S.ID_SINAV		= T.ID_SINAV
				WHERE	TC_OGRENCI		=	@_TC_OGRENCI
					AND TAKMAAD			=	@_DERSAD
					AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
					AND T.FREKANS IS NOT NULL
				GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET,S.SINAVTARIH,S.ID_SINAVTURU


				IF (SELECT COUNT(1) FROM #OGRENCISINAV WHERE ID_SINAVTURU != 6 )>1
				BEGIN
					INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET,SINAVTARIH)
					SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,CAST(AVG(HBNET) AS decimal(8,2)),HEDEF,CAST(AVG(NET) AS DECIMAL(8,2)),GETDATE()
					FROM	#OGRENCISINAV 
					GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HEDEF
				END

				select(
							select * from(
								select 
								(					
									SELECT		[KAMPÜS]		= SUBEAD,
												[SINIF]			= SINIFAD,
												[BRANŞ]			= TAKMAAD,
												[SINAV TÜRÜ]	= SINAVTURU,
												[SINAV]			= SINAVADI,
												[SORU SAYISI]	= SS,
												[H.B. NET ORT.] = HBNET,
												[HEDEFE UZAKLIK]= HEDEF-HBNET,
												[ÖĞR NET]		= NET,
												[PUAN]			= SINAVPUANI,
												[FREKANS]		= SINAVPUANI,
												ADSOYAD
									FROM		#OGRENCISINAV 
									ORDER BY SINAVTARIH
									FOR JSON AUTO
								) as t4
												
							) as tablo FOR JSON AUTO
						) as tt
			
				DROP TABLE IF EXISTS #OGRENCISINAV
			END
			IF @_ISLEM = 5	--	ÖĞRETMEN SINIF GRAFİĞİ		
			BEGIN 
			
					
			

				DECLARE @_SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
				IF (0 IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
				BEGIN
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

						SELECT	ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,'FREKANS' SINAVADI
						INTO	#FREKANSOGRETMEN2
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND FREKANS IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND T.DONEM		= @_DONEM
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

						SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO #PIVOT  FROM #FREKANSOGRETMEN2

						INSERT INTO @_SINAVLAR (SINAVADI) VALUES ('FREKANS')

						select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#PIVOT 
									FOR JSON AUTO
								) as t5,
								(					
									SELECT	SINAVADI
									FROM	@_SINAVLAR
									FOR JSON AUTO
								) as t6
												
							) as tablo FOR JSON AUTO
						) as tt

					
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

				END
				ELSE
				BEGIN
			
						DROP TABLE IF EXISTS #v2FrekansOgretmen
					
						SELECT	ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,CASE 
									WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
									ELSE (SELECT TOP 1 SUBSTRING(K.AD ,1, CHARINDEX('.',K.AD)-1 )+'-'+S.AD FROM Sinav S JOIN v3Kademe3 K ON K.ID_KADEME3 = S.ID_KADEME3 WHERE S.ID_SINAV=T.ID_SINAV) 
								END SINAVADI
						INTO	#v2FrekansOgretmen
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU				ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
						GROUP BY ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

						--TAHSİN--
						INSERT INTO #v2FrekansOgretmen
						SELECT	ID_SINIF,T.ID_SINAVTURU,999999999 as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,ST.KISAAD+' ORT' as SINAVADI
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND ST.ID_SINAVTURU NOT IN (5,6) -- AAYKS VEYA YDS DEĞİLSE
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
						--TAHSİN--
					
						DECLARE @_cols	AS NVARCHAR(MAX),
								@_cols2	AS NVARCHAR(MAX),
								@_cols3	AS NVARCHAR(MAX),
								@_SQL	AS NVARCHAR(MAX);
												
						--TAHSİN--
						SET @_cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
		
						SET @_cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SUM DAN DOLAYI SORUN OLABILIR
						SET @_cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
						--TAHSİN--

						INSERT INTO @_SINAVLAR (SINAVADI)
							SELECT	DISTINCT SINAVADI
							FROM	#v2FrekansOgretmen

						SET @_SQL='
					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1


							SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols2 AS varchar(MAX))+' INTO #PVT1 FROM (
								SELECT * FROM #v2FrekansOgretmen
							)AS TABLO
							PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@_cols AS varchar(MAX))+')) AS P
					

							SELECT		ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols3 AS varchar(MAX))+'
										INTO		#PVT
										FROM		#PVT1 
										group by ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]
					
							select(
								select * from(
									select 
									(					
										SELECT		*
										FROM		#PVT 
										FOR JSON AUTO
									) as t5,
									(					
										SELECT	DISTINCT SINAVADI
										FROM	#v2FrekansOgretmen
										FOR JSON AUTO
									) as t6
												
								) as tablo FOR JSON AUTO
							) as tt

					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1

						'
					
						print @_SQL
						EXECUTE (@_SQL)

						--set @_SQL='
						--	'

						--			execute (@_SQL)
								

				DROP TABLE IF EXISTS #v2FrekansOgretmen
					
				END
			

			
			END
			IF @_ISLEM = 6	--	DERSLER						
			BEGIN 


				SELECT	D.* 
				INTO	#DERSLER 
				FROM	v3SinavDers D
				INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD
				--6
			
				select(
							select * from(
								select 
								(	

									SELECT	DISTINCT D.AD
									FROM	#DERSLER				D
									JOIN	v2FrekansOgrenciDetay	OD	ON	OD.DERSAD=D.AD
									WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 
										AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@_ID_SINAVTURU)) 
										AND OD.DONEM = @_DONEM
									FOR JSON AUTO
								) as t5
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @_ISLEM = 7	--	SINAV TURU					
			BEGIN 
			
			

				select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
				INTO #GrupSinavTuru 
				from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
			union 
				select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
			--union 
			--	select 0,15 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,16 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,17 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,18 , 'YAZILI', 'YAZ'

					INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
					FROM v3Kademe3	K
					JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
					WHERE ID_KADEME3 IN ( 11,12,13,14)


					--INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					--SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
					--FROM v3Kademe3	K
					--WHERE ID_KADEME3 IN ( 11,12,13,14)

					
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 


				drop table #GrupSinavTuru
			END
			IF @_ISLEM = 8	--	İKİNCİ LİSTE (FR SINIF)		
			BEGIN 
				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 
						 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
						,T.ID_SINIF
						,SD.TCKIMLIKNO TC_DANISMAN
				INTO #Filtre8 
				FROM #v2FrekansOgrenciDetayDonem		T
				JOIN [OkyanusDB].DBO.[v3SinifPersonel]	SD	ON	SD.ID_SINIF	= T.ID_SINIF AND SD.ID_KULLANICITIPI = 100
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )))
					AND (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					--AND (ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
					AND (T.ID_SUBE = @_ID_SUBE OR @_ID_SUBE = 0) 
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3,T.ID_SINIF,SD.TCKIMLIKNO

				SELECT	 O.ID_SINIF
						,FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS))
						,HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET))
						,SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
						,D.TC_DANISMAN
				INTO #FiltreFrekans8 
				FROM #Filtre8						O
				JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_DANISMAN		= O.TC_DANISMAN
														AND D.DERSAD		= O.DERSAD 
														AND D.ID_SUBE		= O.ID_SUBE 
														AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
														AND D.ID_KADEME3	= O.ID_KADEME3
				GROUP BY O.ID_SINIF,D.TC_DANISMAN
			

				-- Öğretmen Genel
				SELECT ID_SINIF, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans8 FROM #v2FrekansOgrenciDetayDonem	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )))
					AND (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
				GROUP BY ID_SINIF

				DECLARE @_GENELADET8 INT = (SELECT COUNT(DISTINCT ID_SINIF) FROM #GenelFrekans8)

				SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC)
				INTO #GenelSira8 FROM #GenelFrekans8
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------
			
				-- Öğretmen Kampus Genel
				SELECT ID_SINIF, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans8 FROM #v2FrekansOgrenciDetayDonem	T
				WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)) OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
					AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )) OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3  )))
					AND (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
				GROUP BY ID_SINIF, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans8 G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
				INTO #GenelKampusSira8 FROM #GenelKampusFrekans8	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

			
				-- Liste

				DROP TABLE IF EXISTS #T8
				SELECT   ID_SINIF				= GS.ID_SINIF
						,[SIRA]					= ISNULL(G.SN,@_ID_STGENEL) 		
						,[KAMPÜS]				= GS.SUBEAD
						,[SINIF]				= GS.SINIF	
						,[DANIŞMAN ÖĞRETMEN]	= K.AD + ' ' + K.SOYAD 
						--,[BRANŞ]				= ISNULL( (SELECT STUFF((SELECT '<br>' +  CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM eokul_v2.DBO.DERSOGRETMEN DO WHERE DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =K.TCKIMLIKNO  ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[BRANŞ]				= ( SELECT ISNULL( (SELECT STUFF((SELECT DISTINCT '<br>' +  D.DERSAD  FROM OKYANUSDB.DBO.v3DersProgram DO  JOIN eokul_v2.DBO.Ders D ON D.ID_DERS = DO.ID_DERS WHERE  DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =F.TC_DANISMAN ORDER BY '<br>' +  D.DERSAD  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-') )

						,[TC_DANISMAN]			= F.TC_DANISMAN
						,[FREKANS]				= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')
						,[KAMPÜS GENEL]			= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira8		 tt  WHERE tt.ID_SINIF=k.ID_SINIF)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira8		K WHERE K.ID_SINIF = F.ID_SINIF ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL]				= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET8 AS VARCHAR),'-')					
				INTO		#T8
				FROM		#FiltreFrekans8		F
				INNER JOIN	vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= F.ID_SINIF 
				INNER JOIN	v3Kullanici			K	ON	K.TCKIMLIKNO	= F.TC_DANISMAN
				LEFT  JOIN	#GenelSira8			G	ON	G.ID_SINIF		= F.ID_SINIF

				select(
					select * from(
						select 
						(					
							SELECT * FROM #T8 order by SIRA
							FOR JSON AUTO
						) as t												
					) as tablo FOR JSON AUTO
				) as tt					

			
				DROP TABLE IF EXISTS #T8
				DROP TABLE IF EXISTS #Filtre8
				DROP TABLE IF EXISTS #FiltreFrekans8

				DROP TABLE IF EXISTS #GenelFrekans8
				DROP TABLE IF EXISTS #GenelSira8

				DROP TABLE IF EXISTS #GenelKampusFrekans8
				DROP TABLE IF EXISTS #GenelKampusSira8

			END
			IF @_ISLEM = 9	--	SON FİLTRE GETİR			
			BEGIN 

				--DECLARE @_TC VARCHAR(11) 
				--SET @_TC = @_TCKIMLIKNO


				SELECT ISNULL((
					SELECT TOP 1 PARAMETRELER
					FROM [Log]
					WHERE	TCKIMLIKNO	= @_TCKIMLIKNO
						AND ID_MENU		= 1200
						AND ISLEM		= 1
					ORDER BY KYE_TARIH DESC
				),'[]')
			END
				
			BEGIN

				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 
				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira
				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira
				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #DERSLER
				DROP TABLE IF EXISTS #ETKI
				DROP TABLE IF EXISTS #SINAVTURU
				DROP TABLE IF EXISTS #SUBELER
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem

			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_v2FrekansSinif]...';


GO
ALTER procedure [dbo].[sp_v2FrekansSinif]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,	
	@ID_SUBE			VARCHAR(MAX)	= NULL,	
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,	
	@DERSAD				VARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	
AS
BEGIN
	
	DECLARE 
		@_ISLEM				INT				=	@ISLEM			,
		@_TCKIMLIKNO		VARCHAR(11)		=	@TCKIMLIKNO		,
		@_TC_OGRENCI		VARCHAR(11)		=	@TC_OGRENCI		,
		@_TC_OGRETMEN		VARCHAR(11)		=	@TC_OGRETMEN	,
		@_OTURUM			VARCHAR(36)		=	@OTURUM			,
		@_ID_MENU			INT				=	@ID_MENU		,
		@_ID_KADEME			INT				=	@ID_KADEME		,
		@_DONEM				char(4)			=	@DONEM			,
		@_ID_KADEMEs		VARCHAR(MAX)	=	@ID_KADEMEs		,
		@_ID_KADEME3		VARCHAR(MAX)	=	@ID_KADEME3		,
		@_ID_SINAVTURU		VARCHAR(MAX)	=	@ID_SINAVTURU	,
		@_ID_SUBE			VARCHAR(MAX)	=	@ID_SUBE		,
		@_DERSLIST			VARCHAR(MAX)	=	@DERSLIST		,
		@_ID_SINIF			INT				=	@ID_SINIF		,
		@_DERSAD			VARCHAR(MAX)	=	@DERSAD			,
		@_FREKANSKARNE		BIT				=	@FREKANSKARNE




	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @_ISLEM			
				,TCKIMLIKNO		= @_TCKIMLIKNO		
				,TC_OGRENCI		= @_TC_OGRENCI		
				,TC_OGRETMEN	= @_TC_OGRETMEN	
				,OTURUM			= @_OTURUM			
				,ID_MENU		= @_ID_MENU		
				,ID_KADEME		= @_ID_KADEME	
				,ID_KADEMEs		= @_ID_KADEMEs
				,DONEM			= @_DONEM			
				,ID_KADEME3		= @_ID_KADEME3		
				,ID_SINAVTURU	= @_ID_SINAVTURU	
				,ID_SUBE		= @_ID_SUBE		
				,DERSLIST		= @_DERSLIST		
				,ID_SINIF		= @_ID_SINIF		
				,DERSAD			= @_DERSAD			
				,FREKANSKARNE	= @_FREKANSKARNE	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0



	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @_OTURUM, @TCKIMLIKNO = @_TCKIMLIKNO, @ID_MENU = @_ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @_ISLEM, @PROSEDURADI = @PROCNAME
		
		IF @ID_LOG > 0
		BEGIN
		
			DECLARE @ID_STGENEL INT=999999

			IF @_DONEM='' OR @_DONEM IS NULL
				SET @_DONEM=(SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)


			BEGIN

				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 
				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira
				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira
				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #DERSLER
				DROP TABLE IF EXISTS #ETKI
				DROP TABLE IF EXISTS #SINAVTURU
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem

			END

			IF @_ISLEM IN (1,2,3,4,5)
			BEGIN
			


				DECLARE @SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				INSERT INTO @SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				INSERT INTO @SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
				SELECT * INTO #SINAVTURU FROM @SINAVTURU
				-- 2,3,4,5
										
				select 
					T.ID_FREKANSOGRENCIDETAY
					,T.ID_SINAVTURU
					,T.ID_KADEME3
					,T.ID_OGRENCI
					,T.TC_OGRENCI
					,T.TAKMAAD
					,T.ID_SINAV
					,T.NET
					,T.SS
					,T.ILK_ID_SINAV
					,T.ILK_NET
					,T.ILK_SS
					,T.FREKANS
					,T.DONEM
					,T.ID_SINIF
					,T.ID_SUBE
					,T.ID_DERS
					,T.TC_OGRETMEN
					,T.OGRETMENADSOYAD
					,T.DERSAD
					,T.SUBEAD
					,T.SINIFAD
					,T.HBNET
					,SD.TCKIMLIKNO TC_DANISMAN
					,S.ID_KADEME
				into #v2FrekansOgrenciDetayDonem 
				from v2FrekansOgrenciDetay T WITH (NOLOCK)
				JOIN [OkyanusDB].[dbo].[vw_SinifDanisman]	SD	ON	SD.ID_SINIF	= T.ID_SINIF
				JOIN [OkyanusDB].[dbo].[vw_v4SinifDetay]	S	ON	S.ID_SINIF	= SD.ID_SINIF
																AND S.DONEM		= T.DONEM
				where	S.DONEM = @_DONEM 
				-- 1,2,3,4,5,6


			END
		
			IF @_ISLEM IN (1,2)
			BEGIN
				
				DECLARE @ID_FREKANSSORGU	 INT = NULL
				DECLARE @ID_FREKANSSORGUDERS INT = NULL
					
				SET @ID_FREKANSSORGU	= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND DERSLIST		IS NULL
										)				
				IF @ID_FREKANSSORGU IS NULL		
				BEGIN
					DECLARE @TABLEADD TABLE (ID INT)
					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT inserted.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, NULL)

					SET @ID_FREKANSSORGU = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY
					FROM v2FrekansOgrenciDetay WITH(NOLOCK) 
					WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) )--OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	))
						AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) )--OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	))
						AND DONEM = @_DONEM
					ORDER BY FREKANS

				END

				SET @ID_FREKANSSORGUDERS= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND (DERSLIST		= @_DERSLIST  OR (@_DERSLIST IS NULL AND DERSLIST IS NULL) )
										)
				IF @ID_FREKANSSORGUDERS IS NULL	
				BEGIN
					DELETE FROM @TABLEADD 
					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT INSERTED.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, @_DERSLIST)

					SET @ID_FREKANSSORGUDERS = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGUDERS , S.ID_FREKANSOGRENCIDETAY
					FROM v2FrekansSorguDetay	S
					JOIN v2FrekansOgrenciDetay	T WITH(NOLOCK) 	ON	T.ID_FREKANSOGRENCIDETAY = S.ID_FREKANSOGRENCIDETAY
					WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) ) --OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		))
						AND S.ID_FREKANSSORGU	= @ID_FREKANSSORGU
						AND DONEM				= @_DONEM
					ORDER BY FREKANS

				END

			END
		
			IF @_ISLEM = 1	--	İLK LİSTE (FR SINIF)		
			BEGIN 
			
				SELECT DISTINCT ID_SUBE INTO #SUBELER FROM v3SubeYetki WHERE TCKIMLIKNO = @_TCKIMLIKNO AND ID_KULLANICITIPI NOT IN (4,5)

				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 
						 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
						,T.ID_SINIF
						,SD.TCKIMLIKNO TC_DANISMAN
				INTO #Filtre 
				FROM v2FrekansSorguDetay				D
				JOIN #v2FrekansOgrenciDetayDonem		T	ON	D.ID_FREKANSOGRENCIDETAY	= T.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER							S	ON	S.ID_SUBE	= T.ID_SUBE
				JOIN [OkyanusDB].DBO.[vw_SinifDanisman]	SD	ON	SD.ID_SINIF	= T.ID_SINIF
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
					--AND (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 
					--AND (ID_SUBE = @_ID_SUBE OR @_ID_SUBE = 0) 
					AND (@_ID_KADEME IS NULL OR @_ID_KADEME = ID_KADEME OR @_ID_KADEME = 0)
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3,T.ID_SINIF,SD.TCKIMLIKNO

				SELECT	 O.ID_SINIF
						,FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS))
						,HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET))
						,SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
						,D.TC_DANISMAN
				INTO #FiltreFrekans 
				FROM #Filtre						O
				JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_DANISMAN	= O.TC_DANISMAN
														AND D.DERSAD		= O.DERSAD 
														AND D.ID_SUBE		= O.ID_SUBE 
														AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
														AND D.ID_KADEME3	= O.ID_KADEME3
				GROUP BY O.ID_SINIF,D.TC_DANISMAN
			

				-- Öğretmen Genel
				SELECT ID_SINIF, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans 
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
				GROUP BY ID_SINIF

				DECLARE @GENELADET INT = (SELECT COUNT(DISTINCT ID_SINIF) FROM #GenelFrekans)

				SELECT *, SN = ROW_NUMBER() OVER (ORDER BY FREKANS DESC)
				INTO #GenelSira FROM #GenelFrekans
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------
			
				-- Öğretmen Kampus Genel
				SELECT ID_SINIF, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
				GROUP BY ID_SINIF, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
				INTO #GenelKampusSira FROM #GenelKampusFrekans	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

			
				-- Liste

				DROP TABLE IF EXISTS #T
				SELECT   ID_SINIF				= GS.ID_SINIF
						,[SIRA]					= ISNULL(G.SN,@ID_STGENEL) 		
						,[KAMPÜS]				= GS.SUBEAD
						,[SINIF]				= GS.SINIF	
						,[DANIŞMAN ÖĞRETMEN]	= K.AD + ' ' + K.SOYAD 
						--,[BRANŞ]				= ISNULL( (SELECT STUFF((SELECT '<br>' +  CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM eokul_v2.DBO.DERSOGRETMEN DO WHERE DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =K.TCKIMLIKNO  ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[BRANŞ]				= ( SELECT ISNULL( (SELECT STUFF((SELECT DISTINCT '<br>' +  D.DERSAD  FROM OKYANUSDB.DBO.v3DersProgram DO  JOIN eokul_v2.DBO.Ders D ON D.ID_DERS = DO.ID_DERS WHERE  DO.ID_SINIF = F.ID_SINIF AND DO.TCKIMLIKNO =F.TC_DANISMAN ORDER BY '<br>' +  D.DERSAD  FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-') )

						,[TC_DANISMAN]			= F.TC_DANISMAN
						,[FREKANS]				= ISNULL(CAST(G.FREKANS AS VARCHAR),'-')
						,[KAMPÜS GENEL]			= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira		 tt  WHERE tt.ID_SINIF=k.ID_SINIF)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira		K WHERE K.ID_SINIF = F.ID_SINIF ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL]				= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@GENELADET AS VARCHAR),'-')					
				INTO		#T
				FROM		#FiltreFrekans		F
				INNER JOIN	[OkyanusDB].[dbo].[vw_v4SinifDetay]	GS	ON	GS.ID_SINIF		= F.ID_SINIF 
				INNER JOIN	v3Kullanici			K	ON	K.TCKIMLIKNO	= F.TC_DANISMAN
				LEFT  JOIN	#GenelSira			G	ON	G.ID_SINIF		= F.ID_SINIF

				select(
					select * from(
						select 
						(					
							SELECT * FROM #T order by SIRA
							FOR JSON AUTO
						) as t												
					) as tablo FOR JSON AUTO
				) as tt					

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

			END
			IF @_ISLEM = 2	--	GENEL SIRALAMA				
			BEGIN 
		
				BEGIN
		
					SELECT	 ID_SINAVTURU
							,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
					INTO #GenelFiltre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
						AND DONEM = @_DONEM
					GROUP BY ID_SINAVTURU


					SELECT	 DERSAD
							,T.ID_SINIF
							,ID_SINAVTURU
							,ID_KADEME3
					INTO #Filtre2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU	= @ID_FREKANSSORGUDERS
						AND ID_SINIF			= @_ID_SINIF
					GROUP BY  ID_SINIF,DERSAD, ID_SINAVTURU, ID_KADEME3
				
			
					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					INTO #FiltreFrekans2 FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.DERSAD = O.DERSAD AND D.ID_SINIF = O.ID_SINIF AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU		
				UNION ALL			
					SELECT O.ID_SINIF, O.DERSAD,  @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) = 1
					GROUP BY O.ID_SINIF, O.DERSAD
				UNION ALL			
					SELECT O.ID_SINIF, 'GENEL',  @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.ID_SINIF = O.ID_SINIF AND D.DERSAD = O.DERSAD AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					WHERE-- @_DERSAD != 'Tümü'
				  		 (SELECT count(VALUE) FROM OPENJSON( @_DERSLIST		)) > 1
					GROUP BY O.ID_SINIF
			



				-- Frekans Katkı İçin
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					INTO #GenelFrekansKatki 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					GROUP BY ID_SINIF, ID_SINAVTURU, DERSAD
				UNION ALL				
					SELECT ID_SINIF, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					FROM #v2FrekansOgrenciDetayDonem	T
					WHERE (DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
					GROUP BY ID_SINIF, DERSAD


					-- Öğretmen Genel
					SELECT ID_SINIF, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SINAVTURU
				UNION ALL				
					SELECT ID_SINIF, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM #v2FrekansOgrenciDetayDonem	T			
					GROUP BY ID_SINIF

					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
					INTO #GenelSira2 FROM #GenelFrekans2 T
					WHERE FREKANS IS NOT NULL
				
					--------------------------------------------------------------------

					-- Öğretmen Zümre Genel
					SELECT ID_SINIF, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD, ID_SINAVTURU
				UNION ALL			
					SELECT ID_SINIF, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, DERSAD


					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
					INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
					WHERE FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Kampus Genel
					SELECT ID_SINIF, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE


					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Zümre Kampus Genel
					SELECT ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreKampusFrekans2 
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD, ID_SINAVTURU
				UNION ALL
					SELECT ID_SINIF, ID_SUBE, DERSAD, @ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			D
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
					WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY ID_SINIF, ID_SUBE, DERSAD

					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.ID_SINIF) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------


					SELECT O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
					INTO #OgrenciSinifListe2 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 														
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD, O.ID_SINAVTURU
				UNION ALL 			
					SELECT O.ID_SINIF, O.DERSAD, @ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
					FROM #Filtre2						O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.ID_SINIF		= O.ID_SINIF 
															AND D.DERSAD		= O.DERSAD 
															AND D.ID_SINAVTURU	= O.ID_SINAVTURU 
															AND D.ID_KADEME3	= O.ID_KADEME3
					GROUP BY O.ID_SINIF, O.DERSAD

			

					INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@ID_STGENEL,'GENEL','GNL',1,2)



					SELECT ID_SINAVTURU
						,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
						,MAX(GF.FREKANS) MAXIMUM
						,MIN(GF.FREKANS) MINIMUM 						
						--,MINIMUM	= IIF(MIN(GF.FREKANS) < 0, 0 , MIN(GF.FREKANS) )
						, DERSAD
					INTO #ARALIK 
					FROM #GenelFrekansKatki	GF
					GROUP BY ID_SINAVTURU, DERSAD


					SELECT ID_SINAVTURU
						,KADEME1 = MINIMUM + ARALIK
						,KADEME2 = MINIMUM + (ARALIK*2)
						,KADEME3 = MINIMUM + (ARALIK*3)
						,KADEME4 = MINIMUM + (ARALIK*4)
						, DERSAD
					INTO #ETKI
					FROM #ARALIK
				

				
					SELECT 
						 [SINAV TÜRÜ]		= S.AD 
						,[STKISAAD]			= S.KISAAD
						,[BRANŞ]			= F.DERSAD
						,[ID_SINAVTURU]		= F.ID_SINAVTURU
						,[FREKANS]			= ISNULL( MAX(F.FREKANS) ,0)
						,[FREKANS KATKI]	= --CASE WHEN AVG(F.FREKANS) < 0 THEN 'NEGATİF EKTİ'
												--ELSE 
													CASE
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME1 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİSİZ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME2 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'AZ ETKİLİ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME3 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'NORMAL'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİLİ'
														WHEN AVG(F.FREKANS) >= (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ÇOK ETKİLİ'
														ELSE '---'
													END
												--END
						,[KAMPÜS ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira2	tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira2	K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU  AND K.DERSAD = F.DERSAD	ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[KAMPÜS GENEL]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU								)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU							ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')					
						,[GENEL ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2			tt  WHERE tt.ID_SINIF=k.ID_SINIF AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.ID_SINIF = F.ID_SINIF AND K.ID_SINAVTURU=F.ID_SINAVTURU	AND K.DERSAD = F.DERSAD						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR),'---')
					INTO	#T1
					FROM #FiltreFrekans2				F
					INNER JOIN #OgrenciSinifListe2	O	ON	O.ID_SINIF		= F.ID_SINIF		
														AND O.ID_SINAVTURU	= F.ID_SINAVTURU		
														AND O.DERSAD		= F.DERSAD		
					INNER JOIN #SINAVTURU			S	ON	S.ID_SINAVTURU	= F.ID_SINAVTURU
					LEFT  JOIN #GenelSira2			G	ON	G.ID_SINIF		= F.ID_SINIF		
														AND G.ID_SINAVTURU	= S.ID_SINAVTURU
					WHERE F.FREKANS IS NOT NULL
					GROUP BY S.AD, F.ID_SINIF, F.ID_SINAVTURU, F.DERSAD, G.SN, S.KISAAD

		
				END


				-------------------------------------------------	(2.2)	2. SAYFA ALT


				print 11
				SELECT	 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,MAX(T.SS) SORUSAYISI
						,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
						,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
						,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
						,TC_OGRETMEN
						,ID_DERS
						,T.ID_SUBE
						,T.ID_SINAVTURU
						,ID_SINIF
						,SINIFAD
						,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
						,AVG(ILK_SS) ILK_SS
				INTO	#ORTALAMA3
				FROM v2FrekansSorguDetay			D
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY = D.ID_FREKANSOGRENCIDETAY
				WHERE	D.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND ID_SINIF	= @_ID_SINIF
				GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD


				SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
						,[BRANŞ]		= DERSAD
						,[SINAV TÜRÜ]	= ST.AD
						,[KAMPÜS]		= SUBEAD
						,[SINIF]		= ORT.SINIFAD	
						,[H.B. NET ORT.]= ORT.HBNET	
						,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
						,ORT.FREKANS		
						,SD.ID_SINIF
						,TC_OGRETMEN
						,SIRA
						,ORT.ID_SINAVTURU
						--,TC_DANISMAN	= K.TCKIMLIKNO
						,[DANIŞMAN]		= K.AD+' '+K.SOYAD
				INTO	#T2
				FROM	#ORTALAMA3	ORT
				JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
										AND ST.SIRA			<> 2
				JOIN	OkyanusDB.DBO.vw_SinifDanisman	SD	ON	SD.ID_SINIF = ORT.ID_SINIF
				JOIN	OkyanusDB.DBO.v3Kullanici		K	ON	K.TCKIMLIKNO= SD.TCKIMLIKNO
				WHERE	ORT.FREKANS IS NOT NULL
				ORDER BY ST.SIRA





					select(
							select * from(
								select 
								(						 
									SELECT * FROM #T1
									ORDER BY BRANŞ,ID_SINAVTURU
									FOR JSON AUTO
								) as t1
								,( 
									SELECT * FROM #T2
									ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
									FOR JSON AUTO
								)as t2							
							) as tablo FOR JSON AUTO
						) as tt


					
					
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 

				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2

				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2

				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2
			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2

			
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

				DROP TABLE IF EXISTS #GenelFrekansKatki


			END
			IF @_ISLEM = 3	--	SINIF ÖĞRENCİ LİSTESİ		
			BEGIN 

				SELECT	[KAMPÜS]			= SUBEAD,
						[SINIF]				= SINIFAD,
						[BRANŞ]				= TAKMAAD,
						[SINAV TÜRÜ]		= ST.AD,
						[AD SOYAD]			= K.AD+' '+K.SOYAD,
						[SORU SAYISI]		= MAX(T.ILK_SS),
						[H.B NET]			= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
						[NET ORT]			= CAST(AVG(T.NET) AS DECIMAL(8,2)),
						[HEDEFE UZAKLIK]	= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),				
					
						--[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
						[FREKANS]	= CAST(		CASE
										WHEN T.ID_SINAVTURU=0 THEN AVG(NET) 
										WHEN T.ID_SINAVTURU IN (5,6)  THEN (	SELECT FREKANS 
																				FROM #v2FrekansOgrenciDetayDonem DD
																				JOIN (SELECT TOP 1 S.ID_SINAV
																							FROM #v2FrekansOgrenciDetayDonem D 
																							JOIN Sinav						 S	ON	S.ID_SINAV	= D.ID_SINAV
																							WHERE	D.TC_OGRENCI	= T.TC_OGRENCI 
																								AND D.ID_SINAVTURU	= T.ID_SINAVTURU
																								AND D.TC_OGRETMEN	= T.TC_OGRETMEN
																								AND D.DERSAD		= T.DERSAD
																							ORDER BY S.SINAVTARIH DESC, ID_SINAV
																				) AS SD  ON DD.TC_OGRENCI	= T.TC_OGRENCI 
																						AND DD.ID_SINAVTURU	= T.ID_SINAVTURU
																						AND DD.TC_OGRETMEN	= T.TC_OGRETMEN
																						AND DD.DERSAD		= T.DERSAD
																						AND DD.ID_SINAV		= SD.ID_SINAV
																			) 
										ELSE 	AVG(FREKANS) 
									END 
							AS DECIMAL(8,2) ) ,-- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					
								
						[TC_OGRENCI]	    = TC_OGRENCI,		
						[TC_OGRETMEN]	    = TC_OGRETMEN,	
						[ID_SINIF]			= T.ID_SINIF,		
						[ID_SINAVTURU]		= T.ID_SINAVTURU	
				INTO	#v2FrekansOgrenciDetay
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				WHERE 	T.ID_SINIF	= @_ID_SINIF
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND T.DERSAD	= @_DERSAD
					AND FREKANS		IS NOT NULL
					AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
				GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET,T.DERSAD
			
				select(
							select * from(
								select 
								(					
									SELECT		* 
									FROM		#v2FrekansOgrenciDetay
									ORDER BY	[AD SOYAD]
									FOR JSON AUTO
								) as t3
												
							) as tablo FOR JSON AUTO
						) as tt
				DROP TABLE #v2FrekansOgrenciDetay
			END
			IF @_ISLEM = 4	--	ÖĞRENCİ FREKANS SINAV LST	
			BEGIN 

				SELECT	 SUBEAD
						,TAKMAAD
						,ST.AD SINAVTURU
						,CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
							ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
						END SINAVADI
						,CAST(CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (	
															SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
															INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
															WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
															GROUP BY YO.TELAFI
														) 
							ELSE						(	T.FREKANS
														)
						END AS decimal(8,2)) SINAVPUANI
						,K.AD+' '+K.SOYAD ADSOYAD
						,SINIFAD
						,SS 
						,CAST(HBNET AS DECIMAL(8,2)) HBNET
						,ILK_SS HEDEF
						,CAST(NET AS DECIMAL(8,2))	 NET
						,S.SINAVTARIH
						,S.ID_SINAVTURU
				INTO	#OGRENCISINAV
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				LEFT JOIN Sinav			S	ON	S.ID_SINAV		= T.ID_SINAV
				WHERE	TC_OGRENCI		=	@_TC_OGRENCI
					AND TAKMAAD			=	@_DERSAD
					AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
					AND T.FREKANS IS NOT NULL
				GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET,S.SINAVTARIH,S.ID_SINAVTURU


				IF (SELECT COUNT(1) FROM #OGRENCISINAV WHERE ID_SINAVTURU != 6 )>1
				BEGIN
					INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET,SINAVTARIH)
					SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,CAST(AVG(HBNET) AS decimal(8,2)),HEDEF,CAST(AVG(NET) AS DECIMAL(8,2)),GETDATE()
					FROM	#OGRENCISINAV 
					GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HEDEF
				END

				select(
							select * from(
								select 
								(					
									SELECT		[KAMPÜS]		= SUBEAD,
												[SINIF]			= SINIFAD,
												[BRANŞ]			= TAKMAAD,
												[SINAV TÜRÜ]	= SINAVTURU,
												[SINAV]			= SINAVADI,
												[SORU SAYISI]	= SS,
												[H.B. NET ORT.] = HBNET,
												[HEDEFE UZAKLIK]= HEDEF-HBNET,
												[ÖĞR NET]		= NET,
												[PUAN]			= SINAVPUANI,
												[FREKANS]		= SINAVPUANI,
												ADSOYAD
									FROM		#OGRENCISINAV 
									ORDER BY SINAVTARIH
									FOR JSON AUTO
								) as t4
												
							) as tablo FOR JSON AUTO
						) as tt
			
				DROP TABLE IF EXISTS #OGRENCISINAV
			END
			IF @_ISLEM = 5	--	ÖĞRETMEN SINIF GRAFİĞİ		
			BEGIN 
			
					
			

				DECLARE @SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
				IF (0 IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
				BEGIN
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

						SELECT	ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,'FREKANS' SINAVADI
						INTO	#FREKANSOGRETMEN2
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND FREKANS IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND T.DONEM		= @_DONEM
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

						SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO #PIVOT  FROM #FREKANSOGRETMEN2

						INSERT INTO @SINAVLAR (SINAVADI) VALUES ('FREKANS')

						select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#PIVOT 
									FOR JSON AUTO
								) as t5,
								(					
									SELECT	SINAVADI
									FROM	@SINAVLAR
									FOR JSON AUTO
								) as t6
												
							) as tablo FOR JSON AUTO
						) as tt

					
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

				END
				ELSE
				BEGIN
			
						DROP TABLE IF EXISTS #v2FrekansOgretmen
					
						SELECT	ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,CASE 
									WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
									ELSE (SELECT TOP 1 SUBSTRING(K.AD ,1, CHARINDEX('.',K.AD)-1 )+'-'+S.AD FROM Sinav S JOIN v3Kademe3 K ON K.ID_KADEME3 = S.ID_KADEME3 WHERE S.ID_SINAV=T.ID_SINAV) 
								END SINAVADI
						INTO	#v2FrekansOgretmen
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU				ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND		ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
						GROUP BY ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

						--TAHSİN--
						INSERT INTO #v2FrekansOgretmen
						SELECT	ID_SINIF,T.ID_SINAVTURU,@ID_STGENEL as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,ST.KISAAD+' ORT' as SINAVADI
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	ID_SINIF	= @_ID_SINIF
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND ST.ID_SINAVTURU NOT IN (5,6) -- AAYKS VEYA YDS DEĞİLSE
						GROUP BY ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
						--TAHSİN--
					
						DECLARE @cols	AS NVARCHAR(MAX),
								@cols2	AS NVARCHAR(MAX),
								@cols3	AS NVARCHAR(MAX),
								@SQL	AS NVARCHAR(MAX);
												
						--TAHSİN--
						SET @cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
		
						SET @cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SUM DAN DOLAYI SORUN OLABILIR
						SET @cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
						--TAHSİN--

						INSERT INTO @SINAVLAR (SINAVADI)
							SELECT	DISTINCT SINAVADI
							FROM	#v2FrekansOgretmen

						SET @SQL='
					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1


							SELECT ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols2 AS varchar(MAX))+' INTO #PVT1 FROM (
								SELECT * FROM #v2FrekansOgretmen
							)AS TABLO
							PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@cols AS varchar(MAX))+')) AS P
					

							SELECT		ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@cols3 AS varchar(MAX))+'
										INTO		#PVT
										FROM		#PVT1 
										group by ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]
					
							select(
								select * from(
									select 
									(					
										SELECT		*
										FROM		#PVT 
										FOR JSON AUTO
									) as t5,
									(					
										SELECT	DISTINCT SINAVADI
										FROM	#v2FrekansOgretmen
										FOR JSON AUTO
									) as t6
												
								) as tablo FOR JSON AUTO
							) as tt

					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1

						'
					
						print @SQL
						EXECUTE (@SQL)

						--set @SQL='
						--	'

						--			execute (@SQL)
								

				DROP TABLE IF EXISTS #v2FrekansOgretmen
					
				END
			

			
			END
			IF @_ISLEM = 6	--	DERSLER						
			BEGIN 
			
				--	INTO #DERSLER					
				SELECT	D.* 
				INTO	#DERSLER 
				FROM	v3SinavDers D
				INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD

				select(
							select * from(
								select 
								(	

									SELECT	DISTINCT D.AD
									FROM	#DERSLER				D
									JOIN	v2FrekansOgrenciDetay	OD WITH (NOLOCK) 	ON	OD.DERSAD=D.AD
									WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 
										AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@_ID_SINAVTURU)) 
										AND OD.DONEM = @_DONEM
									FOR JSON AUTO
								) as t5
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @_ISLEM = 7	--	SINAV TURU					
			BEGIN 
			
			

				select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
				INTO #GrupSinavTuru 
				from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
			union 
				select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
			--union 
			--	select 0,15 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,16 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,17 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,18 , 'YAZILI', 'YAZ'

					INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
					FROM v3Kademe3	K
					JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
					WHERE ID_KADEME3 IN ( 11,12,13,14)


					--INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					--SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
					--FROM v3Kademe3	K
					--WHERE ID_KADEME3 IN ( 11,12,13,14)

					
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 


				drop table #GrupSinavTuru
			END
			IF @_ISLEM = 8	--	SON FİLTRE GETİR			
			BEGIN
				
				SELECT ISNULL((
					SELECT TOP 1 PARAMETRELER
					FROM [Log]
					WHERE	TCKIMLIKNO	= @_TCKIMLIKNO
						AND ID_MENU		= 1193
						AND ISLEM		= 1
					ORDER BY KYE_TARIH DESC
				),'[]')

			END
				
			BEGIN
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
				DROP TABLE IF EXISTS #T1
				DROP TABLE IF EXISTS #Filtre2
				DROP TABLE IF EXISTS #GenelFiltre2
				DROP TABLE IF EXISTS #FiltreFrekans2
				DROP TABLE IF EXISTS #OgrenciSinifListe2 
				DROP TABLE IF EXISTS #GenelFrekans2
				DROP TABLE IF EXISTS #GenelSira2
				DROP TABLE IF EXISTS #GenelZumreFrekans2
				DROP TABLE IF EXISTS #GenelZumreSira2
				DROP TABLE IF EXISTS #GenelKampusFrekans2
				DROP TABLE IF EXISTS #GenelKampusSira2			
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans2
				DROP TABLE IF EXISTS #GenelZumreKampusSira2				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 
				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira
				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira
				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira
				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira
				DROP TABLE IF EXISTS #GenelFrekansKatki
				DROP TABLE IF EXISTS #ARALIK
				DROP TABLE IF EXISTS #DERSLER
				DROP TABLE IF EXISTS #ETKI
				DROP TABLE IF EXISTS #SINAVTURU
				DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity, @STATE = @ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_v2FrekansSistem]...';


GO
ALTER procedure [dbo].[sp_v2FrekansSistem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,	
	@ID_SUBE			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,		
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@FREKANSKARNE		BIT				= 0	,
	@RAPOR_DONUS_TIP    BIT				= 0
AS
BEGIN
	
	DECLARE
	@_ISLEM				INT				= @ISLEM			,
	@_TCKIMLIKNO		VARCHAR(11)		= @TCKIMLIKNO		,
	@_TC_OGRENCI		VARCHAR(11)		= @TC_OGRENCI		,
	@_TC_OGRETMEN		VARCHAR(11)		= @TC_OGRETMEN		,
	@_OTURUM			VARCHAR(36)		= @OTURUM			,
	@_ID_MENU			INT				= @ID_MENU			,
	@_DONEM				char(4)			= @DONEM			,
	@_ID_KADEMEs		VARCHAR(MAX)	= @ID_KADEMEs		,
	@_ID_KADEME3		VARCHAR(MAX)	= @ID_KADEME3		,
	@_ID_SINAVTURU		VARCHAR(MAX)	= @ID_SINAVTURU		,	
	@_ID_SUBE			VARCHAR(MAX)	= @ID_SUBE			,
	@_ID_SINIF			INT				= @ID_SINIF			,		
	@_DERSLIST			VARCHAR(MAX)	= @DERSLIST			,
	@_DERSAD			VARCHAR(MAX)	= @DERSAD			,
	@_FREKANSKARNE		BIT				= @FREKANSKARNE		,
	@_RAPOR_DONUS_TIP   BIT				= @RAPOR_DONUS_TIP

	DECLARE @_PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @_LOGJSON VARCHAR(MAX)
	SET @_LOGJSON = (
		SELECT	 ISLEM				= @_ISLEM				
				,TCKIMLIKNO			= @_TCKIMLIKNO			
				,TC_OGRENCI			= @_TC_OGRENCI			
				,TC_OGRETMEN		= @_TC_OGRETMEN	
				,OTURUM				= @_OTURUM				
				,ID_MENU			= @_ID_MENU		
				,DONEM				= @_DONEM				
				,ID_KADEMEs			= @_ID_KADEMEs			
				,ID_KADEME3			= @_ID_KADEME3			
				,ID_SINAVTURU		= @_ID_SINAVTURU		
				,ID_SUBE			= @_ID_SUBE		
				,ID_SINIF			= @_ID_SINIF		
				,DERSLIST			= @_DERSLIST		
				,DERSAD				= @_DERSAD			
				,FREKANSKARNE		= @_FREKANSKARNE		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
	
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @_OTURUM, @TCKIMLIKNO = @_TCKIMLIKNO, @ID_MENU = @_ID_MENU, @LOGJSON = @_LOGJSON, @ISLEM = @_ISLEM, @PROSEDURADI = @_PROCNAME
		
		IF @_ID_LOG > 0
		BEGIN
			
			DECLARE @_ID_STGENEL INT=999999

			IF @_DONEM='' OR @_DONEM IS NULL			
				SET @_DONEM= (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)			

				
			SELECT DISTINCT ID_SUBE INTO #SUBELER FROM v3SubeYetki WHERE TCKIMLIKNO = @_TCKIMLIKNO AND ID_KULLANICITIPI NOT IN (4,5)

			IF @_ISLEM NOT IN (6,7,8)
			BEGIN
				--	INTO #SINAVTURU
				--DECLARE @_SINAVTURU TABLE(ID_SINAVTURU INT,AD VARCHAR(MAX),KISAAD VARCHAR(MAX),AKTIF BIT,SIRA INT)
				--INSERT INTO @_SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(0,'YAZILI','YAZ',1,0)
				--INSERT INTO @_SINAVTURU SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 FROM SinavTuru
				--SELECT * INTO #SINAVTURU FROM @_SINAVTURU

				SELECT ID_SINAVTURU,AD,KISAAD,AKTIF,1 AS SIRA INTO #SINAVTURU FROM SinavTuru
				SET IDENTITY_INSERT #SINAVTURU ON
				-- 2,3,4,5
					
				
					select	 F.ID_FREKANSOGRENCIDETAY
							,F.DERSAD
							,F.SUBEAD
							,F.OGRETMENADSOYAD
							,F.TC_OGRETMEN
							,F.ID_SUBE
							,F.ID_SINAVTURU
							,F.FREKANS
							,F.HBNET
							,F.ILK_SS
							,F.ID_KADEME3
							,F.TC_OGRENCI
							,F.ID_SINIF
							,F.TAKMAAD
							,F.SINIFAD
							,F.NET
							,F.ID_SINAV
							,F.ILK_NET
							,F.SS
							,F.DONEM
							,F.ID_DERS
							,kb.ID_KADEME 
				into #v2FrekansOgrenciDetayDonem 
				from v2FrekansOgrenciDetay			F
				join OkyanusDB.dbo.v3KademeBilgi	kb	on	kb.ID_KADEME3	= F.ID_KADEME3
				where	DONEM = @_DONEM 
					AND (TC_OGRETMEN IS NOT NULL AND TC_OGRETMEN <> '')
				-- 1,2,3,4,5,6
			END
		
			
			IF @_ISLEM IN (1,2)
			BEGIN
				
				DECLARE @ID_FREKANSSORGU	 INT = NULL
				DECLARE @ID_FREKANSSORGUDERS INT = NULL
					
				SET @ID_FREKANSSORGU	= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND DERSLIST		IS NULL
										)				
				IF @ID_FREKANSSORGU IS NULL		
				BEGIN
					DECLARE @TABLEADD TABLE (ID INT)

					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT inserted.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, NULL)

					SET @ID_FREKANSSORGU = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY
					FROM v2FrekansOgrenciDetay WITH(NOLOCK) 
					WHERE	(ID_SINAVTURU	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) )--OR  -1	IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	))
						AND (ID_KADEME3		IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) )--OR  0	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	))
						AND DONEM = @_DONEM
					ORDER BY FREKANS

				END

				SET @ID_FREKANSSORGUDERS= (	SELECT ID_FREKANSSORGU 
											FROM v2FrekansSorgu 
											WHERE	DONEM			= @_DONEM 
												AND ID_SINAVTURULIST= @_ID_SINAVTURU 
												AND ID_KADEME3LIST	= @_ID_KADEME3
												AND (DERSLIST		= @_DERSLIST  OR (@_DERSLIST IS NULL AND DERSLIST IS NULL) )
										)
				IF @ID_FREKANSSORGUDERS IS NULL	
				BEGIN
					DELETE FROM @TABLEADD 
					INSERT INTO v2FrekansSorgu (DONEM, ID_SINAVTURULIST, ID_KADEME3LIST, DERSLIST) 
					OUTPUT INSERTED.ID_FREKANSSORGU INTO @TABLEADD(ID)
					VALUES (@_DONEM , @_ID_SINAVTURU, @_ID_KADEME3, @_DERSLIST)

					SET @ID_FREKANSSORGUDERS = (SELECT TOP 1 ID FROM @TABLEADD)

					INSERT INTO v2FrekansSorguDetay (ID_FREKANSSORGU , ID_FREKANSOGRENCIDETAY)--, ID_SINAVTURU, TC_OGRETMEN, DERSAD, ID_SUBE, FREKANS)
					SELECT @ID_FREKANSSORGUDERS , S.ID_FREKANSOGRENCIDETAY
					FROM v2FrekansSorguDetay	S
					JOIN v2FrekansOgrenciDetay	T WITH(NOLOCK) 	ON	T.ID_FREKANSOGRENCIDETAY = S.ID_FREKANSOGRENCIDETAY
					WHERE	(DERSAD			IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)) OR  'Tümü'	IN	(SELECT VALUE FROM OPENJSON( @_DERSLIST		)))
						AND S.ID_FREKANSSORGU	= @ID_FREKANSSORGU
						AND DONEM				= @_DONEM
					ORDER BY FREKANS

				END

			END

			
			IF @_ISLEM = 1	--	İLK LİSTE (FR SİSTEM)		
			BEGIN 
		
				SET @_DERSAD = CASE WHEN (SELECT COUNT(VALUE) FROM OPENJSON( @_DERSLIST)) = 1 THEN  (SELECT TOP 1 VALUE FROM OPENJSON( @_DERSLIST)) ELSE 'Tümü' END

				SELECT	 
						 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,TC_OGRETMEN
						,T.ID_SUBE
						,ID_SINAVTURU
						,ID_KADEME3
				INTO #Filtre 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER						S	ON	S.ID_SUBE				= T.ID_SUBE
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGUDERS
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
				GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
				INTO #FiltreFrekans FROM #Filtre	O
				INNER JOIN #v2FrekansOgrenciDetayDonem	D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
				ORDER BY O.OGRETMENADSOYAD


				-- Öğretmen Genel
				SELECT TC_OGRETMEN, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, DERSAD

				DECLARE @_GENELADET INT = (SELECT COUNT(DISTINCT TC_OGRETMEN) FROM #GenelFrekans)

				SELECT *, SN = ROW_NUMBER() OVER (/*PARTITION BY DERSAD*/  ORDER BY FREKANS DESC)
				INTO #GenelSira FROM #GenelFrekans
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Zümre Genel
				SELECT TC_OGRETMEN, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, DERSAD


				SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans G WHERE G.DERSAD = F.DERSAD)
				INTO #GenelZumreSira FROM #GenelZumreFrekans	F
				WHERE FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelKampusFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, ID_SUBE


				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE), SUBEAD = S.AD
				INTO #GenelKampusSira FROM #GenelKampusFrekans	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------

				-- Öğretmen Zümre Kampus Genel
				SELECT TC_OGRETMEN, ID_SUBE, DERSAD, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
				INTO #GenelZumreKampusFrekans 
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
				GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

				SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD), SUBEAD = S.AD
				INTO #GenelZumreKampusSira FROM #GenelZumreKampusFrekans	F
				INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
				WHERE F.FREKANS IS NOT NULL
				--------------------------------------------------------------------


				SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
				INTO #OgrenciSinifListe 
				FROM #Filtre					O
				INNER JOIN #v2FrekansOgrenciDetayDonem	D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
				GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

				-- Liste
				SELECT   [SIRA]				= F.FREKANS--ISNULL(G.SN,@_ID_STGENEL) --CASE WHEN @_DERSAD = 'Tümü' THEN ISNULL(G.SN,@_ID_STGENEL) ELSE (SELECT MIN(SN) FROM #GenelZumreSira K WHERE K.TC_OGRETMEN=F.TC_OGRETMEN AND K.DERSAD=@_DERSAD )   END
						,[BRANŞ]			= F.DERSAD 
						,[KAMPÜS]			= ISNULL( (SELECT STUFF((SELECT   '<br>' +CAST(K.SUBEAD AS VARCHAR)	FROM #GenelKampusSira K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[ÖĞRETMEN]			= F.OGRETMENADSOYAD 
						,[SORU SAYISI]		= SORUSAYISI
						,[HB NET]			= F.HBNET
						,[TC_OGRETMEN]		= F.TC_OGRETMEN
						,[FREKANS]			= ISNULL(CAST(F.FREKANS AS VARCHAR),'-')
						,[SINIF SAYISI]		= O.SINIFSAY
						,[ÖĞRENCİ SAYISI]	= O.OGRSAY
						,[KAMPÜS ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN  AND K.DERSAD = tt.DERSAD )>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira	K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[KAMPÜS GENEL]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN ORDER BY K.SUBEAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL ZÜMRE]		= ISNULL( (SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira		 tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND K.DERSAD = tt.DERSAD )>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.DERSAD = F.DERSAD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'-')
						,[GENEL]			= ISNULL(CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET AS VARCHAR),'-')
					
				INTO		#T
				FROM		#FiltreFrekans		F
				INNER JOIN #OgrenciSinifListe	O ON O.TC_OGRETMEN = F.TC_OGRETMEN AND O.DERSAD = F.DERSAD
				LEFT  JOIN #GenelSira			G ON G.TC_OGRETMEN = F.TC_OGRETMEN AND G.DERSAD = F.DERSAD

				IF @RAPOR_DONUS_TIP=0
				BEGIN 
				select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#T 
									--ORDER BY [GENEL]--[ÖĞRETMEN]	,[GENEL]
									order by SIRA DESC
									FOR JSON AUTO
								) as t												
							) as tablo FOR JSON AUTO
						) as tt
				END
				ELSE
				BEGIN
				SELECT		*
									FROM		#T 
									--ORDER BY [GENEL]--[ÖĞRETMEN]	,[GENEL]
									order by SIRA DESC
				END
		
				
					
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

		


			END
			IF @_ISLEM = 2	--	GENEL SIRALAMA				
			BEGIN 

				SELECT	 [SINAV TÜRÜ]	= SINAVTURU
						,STKISAAD
						,[BRANŞ]		= BRANS
						,TC_OGRETMEN
						,FREKANS
						,[FREKANS KATKI]= FREKANSKATKI
						,[KAMPÜS KADEME ZÜMRE] = KAMPUSKADEMEZUMRE
						,[KAMPÜS ZÜMRE] = KAMPUSZUMRE
						,[KAMPÜS GENEL]	= KAMPUSGENEL
						,[KADEME ZÜMRE] = KADEMEZUMRE
						,[GENEL ZÜMRE]	= GENELZUMRE
						,GENEL
						,ID_SINAVTURU 
				INTO	#T1
				FROM	v2FrekansOgretmen
				WHERE	TC_OGRETMEN	= @_TC_OGRETMEN
					AND DONEM = @_DONEM
				


				-- frekans karne değil ise  veya (ders,sinav türü,sınıf)tümü seçilmemişse Frekansogretmendeki gösterecek
				IF (@_FREKANSKARNE=0 
					OR (	@_DERSAD <>	'Tümü' 					 
						AND -1	NOT IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU	)) 
						AND 0	NOT IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3	)) 					
						)
					)
				BEGIN
		
					SELECT	 ID_SINAVTURU
							,FREKANS = CONVERT(DECIMAL(18, 2), AVG(T.FREKANS))
					INTO #GenelFiltre2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
						AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
						AND DONEM = @_DONEM
					GROUP BY ID_SINAVTURU


					SELECT	 
								DERSAD
							,SUBEAD
							,OGRETMENADSOYAD
							,TC_OGRETMEN
							,T.ID_SUBE
							,ID_SINAVTURU
							,ID_KADEME3
					INTO #Filtre2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					JOIN #SUBELER						S	ON	S.ID_SUBE	= T.ID_SUBE
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
						AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
						AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
						AND TC_OGRETMEN	= @_TC_OGRETMEN
						AND DONEM = @_DONEM
					GROUP BY TC_OGRETMEN, DERSAD, SUBEAD, OGRETMENADSOYAD, T.ID_SUBE, SUBEAD,ID_SINAVTURU,ID_KADEME3


			
					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					INTO #FiltreFrekans2 FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
				UNION ALL			
					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(D.FREKANS)), HBNET =  CONVERT(DECIMAL(18, 2), AVG(D.HBNET)), SORUSAYISI = CONVERT(DECIMAL(18, 2), AVG(D.ILK_SS))
					FROM #Filtre2	O
					INNER JOIN #v2FrekansOgrenciDetayDonem		D	ON D.TC_OGRETMEN = O.TC_OGRETMEN AND D.DERSAD = O.DERSAD AND D.ID_SUBE = O.ID_SUBE AND D.ID_SINAVTURU = O.ID_SINAVTURU AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD
				ORDER BY O.OGRETMENADSOYAD



				-- Frekans Katkı İçin
					SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					INTO #GenelFrekansKatki 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
						AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
					GROUP BY TC_OGRETMEN, ID_SINAVTURU, DERSAD
				UNION ALL				
					SELECT TC_OGRETMEN, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS)), DERSAD
					FROM #v2FrekansOgrenciDetayDonem	T
					WHERE  (DERSAD	= @_DERSAD OR @_DERSAD = 'Tümü') 						
					GROUP BY TC_OGRETMEN, DERSAD

					-- Öğretmen Genel
					SELECT TC_OGRETMEN, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SINAVTURU
				UNION ALL				
					SELECT TC_OGRETMEN, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM #v2FrekansOgrenciDetayDonem	T			
					GROUP BY TC_OGRETMEN

					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelFrekans2 G WHERE G.ID_SINAVTURU=T.ID_SINAVTURU)
					INTO #GenelSira2 FROM #GenelFrekans2 T
					WHERE FREKANS IS NOT NULL
				
					--------------------------------------------------------------------

					-- Öğretmen Zümre Genel
					SELECT TC_OGRETMEN, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, DERSAD, ID_SINAVTURU
				UNION ALL			
					SELECT TC_OGRETMEN, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, DERSAD


					SELECT *, SN = ROW_NUMBER() OVER (PARTITION BY DERSAD, ID_SINAVTURU ORDER BY FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreFrekans2 G WHERE G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU)
					INTO #GenelZumreSira2 FROM #GenelZumreFrekans2	F
					WHERE FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Kampus Genel
					SELECT TC_OGRETMEN, ID_SUBE, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelKampusFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE, ID_SINAVTURU
				UNION ALL
					SELECT TC_OGRETMEN, ID_SUBE, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE


					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND  G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelKampusSira2 FROM #GenelKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------

					-- Öğretmen Zümre Kampus Genel
					SELECT TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					INTO #GenelZumreKampusFrekans2 
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD, ID_SINAVTURU
				UNION ALL
					SELECT TC_OGRETMEN, ID_SUBE, DERSAD, @_ID_STGENEL, FREKANS = CONVERT(DECIMAL(18, 2), AVG(FREKANS))
					FROM v2FrekansSorguDetay			SD
					JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
					WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU
					GROUP BY TC_OGRETMEN, ID_SUBE, DERSAD

					SELECT F.*, SN = ROW_NUMBER() OVER (PARTITION BY F.ID_SUBE, F.DERSAD, ID_SINAVTURU ORDER BY F.FREKANS DESC), OGRTSAY = (SELECT COUNT(DISTINCT G.TC_OGRETMEN) FROM #GenelZumreKampusFrekans2 G WHERE G.ID_SUBE = F.ID_SUBE AND G.DERSAD = F.DERSAD  AND G.ID_SINAVTURU=F.ID_SINAVTURU), SUBEAD = S.AD
					INTO #GenelZumreKampusSira2 FROM #GenelZumreKampusFrekans2	F
					INNER JOIN V3Sube	S ON S.ID_SUBE = F.ID_SUBE
					WHERE F.FREKANS IS NOT NULL
					--------------------------------------------------------------------


					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 
					INTO #OgrenciSinifListe2 
					FROM #Filtre2				O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
													AND D.DERSAD = O.DERSAD 
													AND D.ID_SUBE = O.ID_SUBE 
													AND D.ID_SINAVTURU = O.ID_SINAVTURU 
													AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, O.ID_SINAVTURU
				UNION ALL 			
					SELECT O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD, @_ID_STGENEL, OGRSAY = COUNT(DISTINCT D.TC_OGRENCI) , SINIFSAY = COUNT(DISTINCT D.ID_SINIF) 			 
					FROM #Filtre2				O
					JOIN #v2FrekansOgrenciDetayDonem	D	ON	D.TC_OGRETMEN = O.TC_OGRETMEN 
													AND D.DERSAD = O.DERSAD 
													AND D.ID_SUBE = O.ID_SUBE 
													AND D.ID_SINAVTURU = O.ID_SINAVTURU 
													AND D.ID_KADEME3 = O.ID_KADEME3
					GROUP BY O.TC_OGRETMEN, O.DERSAD, O.OGRETMENADSOYAD

			
					INSERT INTO #SINAVTURU (ID_SINAVTURU,AD,KISAAD,AKTIF,SIRA) VALUES(@_ID_STGENEL,'GENEL','GNL',1,2)

					-- Liste
					DELETE FROM #T1


					SELECT ID_SINAVTURU
						,(MAX(GF.FREKANS)- MIN(GF.FREKANS) )/5 ARALIK
						,MAX(GF.FREKANS) MAXIMUM
						,MIN(GF.FREKANS) MINIMUM 
						--,MINIMUM	= IIF(MIN(GF.FREKANS) < 0, 0 , MIN(GF.FREKANS) )
						, DERSAD
					INTO #ARALIK 
					FROM #GenelFrekansKatki	GF
					GROUP BY ID_SINAVTURU, DERSAD

					--INSERT INTO #ARALIK
					--SELECT 
					--	 @_ID_STGENEL
					--	,(MAX(GF.FREKANS)-MIN(GF.FREKANS))/5 ARALIK
					--	,MAX(GF.FREKANS) MAXIMUM
					--	,MIN(GF.FREKANS) MINIMUM 
					--FROM #GenelFiltre2	GF


					SELECT ID_SINAVTURU
						,KADEME1 = MINIMUM + ARALIK
						,KADEME2 = MINIMUM + (ARALIK*2)
						,KADEME3 = MINIMUM + (ARALIK*3)
						,KADEME4 = MINIMUM + (ARALIK*4)
						, DERSAD
					INTO #ETKI
					FROM #ARALIK
				

					INSERT INTO #T1 (
					 [SINAV TÜRÜ]	
					,STKISAAD
					,[BRANŞ]		
					,TC_OGRETMEN
					,FREKANS
					,[FREKANS KATKI]
					,[KAMPÜS ZÜMRE] 
					,[KAMPÜS GENEL]	
					,[GENEL ZÜMRE]	
					,GENEL
					,ID_SINAVTURU 
					)
					SELECT 
						 [SINAV TÜRÜ]		= S.AD 
						,[STKISAAD]			= S.KISAAD
						,[BRANŞ]			= F.DERSAD
						,[TC_OGRETMEN]		= F.TC_OGRETMEN
						,[FREKANS]			= ISNULL( MAX(F.FREKANS) ,0)
						--,[FREKANS KATKI]	= CASE 
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>75	THEN	'ÇOK ETKİLİ'
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>50	THEN	'ETKİLİ'
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>25	THEN	'NORMAL ETKİLİ'
						--						WHEN (AVG(F.FREKANS)/(SELECT MAX(FREKANS) FROM #GenelFiltre2 GF WHERE GF.ID_SINAVTURU = F.ID_SINAVTURU )*100.0 )>-1	THEN	'AZ ETKİLİ'
						--						ELSE 'ETKİSİZ'
						--					END

						,[FREKANS KATKI]	= --CASE WHEN AVG(F.FREKANS) < 0 THEN 'NEGATİF EKTİ'
												--ELSE 
													CASE
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME1 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİSİZ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME2 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'AZ ETKİLİ'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME3 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'NORMAL'
														WHEN AVG(F.FREKANS) <  (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ETKİLİ'
														WHEN AVG(F.FREKANS) >= (SELECT E.KADEME4 FROM #ETKI E WHERE E.ID_SINAVTURU = F.ID_SINAVTURU AND E.DERSAD = F.DERSAD) THEN 'ÇOK ETKİLİ'
														ELSE '---'
													END
												--END
						,[KAMPÜS ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreKampusSira2	tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreKampusSira2	K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU  AND K.DERSAD = F.DERSAD ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[KAMPÜS GENEL]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelKampusSira2			tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU							)>1 then k.SUBEAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelKampusSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU							 ORDER BY K.SUBEAD	FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')					
						,[GENEL ZÜMRE]		= ISNULL((SELECT STUFF((SELECT '<br>' + (case when (select count(1)  FROM #GenelZumreSira2			tt  WHERE tt.TC_OGRETMEN=k.TC_OGRETMEN AND F.ID_SINAVTURU=TT.ID_SINAVTURU AND K.DERSAD = tt.DERSAD	)>1 then k.DERSAD +' : ' else '' end )+ CAST(K.SN AS VARCHAR) + ' / ' + CAST(K.OGRTSAY AS VARCHAR)	FROM #GenelZumreSira2		K WHERE K.TC_OGRETMEN = F.TC_OGRETMEN AND K.ID_SINAVTURU=F.ID_SINAVTURU AND K.DERSAD = F.DERSAD						FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')),'---')
						,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(MAX(G.OGRTSAY) AS VARCHAR)
						--,[GENEL]			= CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET2 AS VARCHAR)
						--,[GENEL]			= CASE WHEN G.ID_SINAVTURU=@_ID_STGENEL THEN CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET3 AS VARCHAR) ELSE CAST(G.SN AS VARCHAR) + ' / ' + CAST(@_GENELADET2 AS VARCHAR) END 
							,F.ID_SINAVTURU
					--INTO	#T1
					FROM #FiltreFrekans2				F
					INNER JOIN #OgrenciSinifListe2	O ON O.TC_OGRETMEN	= F.TC_OGRETMEN		AND O.ID_SINAVTURU = F.ID_SINAVTURU		AND O.DERSAD = F.DERSAD		
					INNER JOIN #SINAVTURU			S ON S.ID_SINAVTURU = F.ID_SINAVTURU
					LEFT  JOIN #GenelSira2			G ON G.TC_OGRETMEN	= F.TC_OGRETMEN		AND G.ID_SINAVTURU = S.ID_SINAVTURU
					GROUP BY S.AD, F.TC_OGRETMEN, F.ID_SINAVTURU, F.DERSAD, G.SN,S.KISAAD

		

				END


				-------------------------------------------------	(2.2)	2. SAYFA ALT


				print 11
				SELECT	 DERSAD
						,SUBEAD
						,OGRETMENADSOYAD
						,MAX(T.SS) SORUSAYISI
						,[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) )
						--,CAST(AVG(FREKANS) AS decimal(8,2)) FREKANS --coalesce(some_column, 0)
						,COUNT(DISTINCT ID_SINIF) SINIFSAYISI
						,COUNT(DISTINCT TC_OGRENCI) OGRENCISAYISI
						,TC_OGRETMEN
						,ID_DERS
						,T.ID_SUBE
						,T.ID_SINAVTURU
						,ID_SINIF
						,SINIFAD
						,CAST(AVG(HBNET) AS DECIMAL(8,2)) HBNET
						,AVG(ILK_SS) ILK_SS
				INTO	#ORTALAMA3
				FROM v2FrekansSorguDetay			SD
				JOIN #v2FrekansOgrenciDetayDonem	T	ON	T.ID_FREKANSOGRENCIDETAY= SD.ID_FREKANSOGRENCIDETAY
				JOIN #SUBELER						S	ON	S.ID_SUBE	= T.ID_SUBE
				WHERE SD.ID_FREKANSSORGU = @ID_FREKANSSORGU								
					AND (T.ID_SUBE		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)) OR  0		IN	(SELECT VALUE FROM OPENJSON( @_ID_SUBE		)))
					AND (DERSAD		= @_DERSAD OR @_DERSAD = 'Tümü') 
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND DONEM		= @_DONEM
					
				GROUP BY TC_OGRETMEN,DERSAD,SUBEAD,OGRETMENADSOYAD,ID_DERS,T.ID_SUBE,ID_SINAVTURU,ID_SINIF,SINIFAD
			
				SELECT	[ÖĞRETMEN]		= OGRETMENADSOYAD
						,[BRANŞ]		= DERSAD
						,[SINAV TÜRÜ]	= ST.AD
						,[KAMPÜS]		= SUBEAD
						,[SINIF]		= ORT.SINIFAD	
						,[H.B. NET ORT.]= ORT.HBNET	
						,[HEDEFE UZAKLIK] = cast( ILK_SS-HBNET as decimal(8,2))
						,ORT.FREKANS		
						,ID_SINIF
						,TC_OGRETMEN
						,SIRA
						,ORT.ID_SINAVTURU
				INTO	#T2
				FROM	#ORTALAMA3	ORT
				JOIN	#SINAVTURU	ST	ON	ST.ID_SINAVTURU	= ORT.ID_SINAVTURU 
										AND ST.SIRA			<> 2
				WHERE	ORT.FREKANS IS NOT NULL
				ORDER BY ST.SIRA


				select(
							select * from(
								select 
								(						 
									SELECT * FROM #T1
									ORDER BY BRANŞ,ID_SINAVTURU
									FOR JSON AUTO
								) as t1
								,( 
									SELECT * FROM #T2
									ORDER BY FREKANS desc--SIRA,ID_SINAVTURU,[KAMPÜS],[SINIF]
									FOR JSON AUTO
								)as t2							
							) as tablo FOR JSON AUTO
						) as tt


					
					
				DROP TABLE IF EXISTS #ORTALAMA3
				DROP TABLE IF EXISTS #T2
					DROP TABLE #T1
					DROP TABLE #Filtre2
					DROP TABLE #GenelFiltre2
					DROP TABLE #FiltreFrekans2
					DROP TABLE #OgrenciSinifListe2 

					DROP TABLE #GenelFrekans2
					DROP TABLE #GenelSira2

					DROP TABLE #GenelZumreFrekans2
					DROP TABLE #GenelZumreSira2

					DROP TABLE #GenelKampusFrekans2
					DROP TABLE #GenelKampusSira2

					DROP TABLE #GenelZumreKampusFrekans2
					DROP TABLE #GenelZumreKampusSira2

				
				DROP TABLE IF EXISTS #T
				DROP TABLE IF EXISTS #Filtre
				DROP TABLE IF EXISTS #FiltreFrekans
				DROP TABLE IF EXISTS #OgrenciSinifListe 

				DROP TABLE IF EXISTS #GenelFrekans
				DROP TABLE IF EXISTS #GenelSira

				DROP TABLE IF EXISTS #GenelZumreFrekans
				DROP TABLE IF EXISTS #GenelZumreSira

				DROP TABLE IF EXISTS #GenelKampusFrekans
				DROP TABLE IF EXISTS #GenelKampusSira

				DROP TABLE IF EXISTS #GenelZumreKampusFrekans
				DROP TABLE IF EXISTS #GenelZumreKampusSira

				DROP TABLE IF EXISTS #GenelFrekansKatki


			END	
			IF @_ISLEM = 3	--	SINIF ÖĞRENCİ LİSTESİ		
			BEGIN 

				SELECT	[KAMPÜS]	= SUBEAD,
						[SINIF]		= SINIFAD,
						[BRANŞ]		= TAKMAAD,
						[SINAV TÜRÜ]= ST.AD,
						[AD SOYAD]	= K.AD+' '+K.SOYAD,
						[SORU SAYISI]=MAX(T.ILK_SS),
						[H.B NET]	= CAST(MAX(T.HBNET) AS DECIMAL(8,2)),
						[NET ORT]	= CAST(AVG(T.NET) AS DECIMAL(8,2)),
						[HEDEFE UZAKLIK]= cast(AVG(T.ILK_SS)-AVG(T.NET) as decimal(8,2)),
						--[FREKANS]	= CAST( CASE WHEN T.ID_SINAVTURU=0 THEN AVG(NET) ELSE 	AVG(FREKANS) END AS DECIMAL(8,2) ) -- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
						[FREKANS]	= CAST(		CASE
										WHEN T.ID_SINAVTURU = 0		  THEN AVG(NET) 
										WHEN T.ID_SINAVTURU IN (5,6)  THEN (	SELECT TOP 1 FREKANS 
																				FROM #v2FrekansOgrenciDetayDonem DD
																				JOIN (SELECT TOP 1 S.ID_SINAV
																							FROM #v2FrekansOgrenciDetayDonem D 
																							JOIN Sinav						 S	ON	S.ID_SINAV	= D.ID_SINAV
																							WHERE	D.TC_OGRENCI	= T.TC_OGRENCI 
																								AND D.ID_SINAVTURU	= T.ID_SINAVTURU
																								AND D.TC_OGRETMEN	= T.TC_OGRETMEN
																								AND D.DERSAD		= T.DERSAD
																							ORDER BY S.SINAVTARIH DESC, ID_SINAV
																				) AS SD  ON DD.TC_OGRENCI	= T.TC_OGRENCI 
																						AND DD.ID_SINAVTURU	= T.ID_SINAVTURU
																						AND DD.TC_OGRETMEN	= T.TC_OGRETMEN
																						AND DD.DERSAD		= T.DERSAD
																						AND DD.ID_SINAV		= SD.ID_SINAV
																			) 
										ELSE 	AVG(FREKANS) 
									END 
							AS DECIMAL(8,2) ) ,-- YAZILI İSE FREKANSI YERİNE PUAN ORTLAMASI İSTENİYOR.
					
					
						[TC_OGRENCI]	    = TC_OGRENCI,		
						[TC_OGRETMEN]	    = TC_OGRETMEN,	
						[ID_SINIF]			= T.ID_SINIF,		
						[ID_SINAVTURU]		= T.ID_SINAVTURU	
				INTO	#v2FrekansOgrenciDetay
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				WHERE 	T.ID_SINIF	= @_ID_SINIF
					AND TC_OGRETMEN	= @_TC_OGRETMEN
					AND T.DERSAD	= @_DERSAD
					AND FREKANS		IS NOT NULL
					AND T.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
				GROUP BY TC_OGRETMEN,T.ID_SINIF,T.ID_SINAVTURU,SUBEAD,SINIFAD ,TAKMAAD,ST.AD ,K.AD+' '+K.SOYAD ,TC_OGRENCI,T.ILK_SS-T.ILK_NET,T.DERSAD
			
				select(
							select * from(
								select 
								(					
									SELECT		* 
									FROM		#v2FrekansOgrenciDetay
									ORDER BY	[AD SOYAD]
									FOR JSON AUTO
								) as t3
												
							) as tablo FOR JSON AUTO
						) as tt
				DROP TABLE #v2FrekansOgrenciDetay
			END
			IF @_ISLEM = 4	--	ÖĞRENCİ FREKANS SINAV LST	
			BEGIN 

				SELECT	 SUBEAD
						,TAKMAAD
						,ST.AD SINAVTURU
						,CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
							ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 
						END SINAVADI
						,CAST(CASE 
							WHEN ST.ID_SINAVTURU=0 THEN (	SELECT ISNULL(YO.TELAFI, SUM(YOC.PUAN)) FROM YaziliOgrenci YO
															INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
															WHERE YO.ID_YAZILI = T.ID_SINAV AND YO.TCKIMLIKNO = T.TC_OGRENCI AND YO.AKTIF = 1 AND YO.KATILMADI = 0
															GROUP BY YO.TELAFI	) 
							ELSE						(	T.FREKANS			)
						END AS decimal(8,2)) SINAVPUANI
						,K.AD+' '+K.SOYAD ADSOYAD
						,SINIFAD
						,SS 
						,CAST(HBNET AS DECIMAL(8,2)) HBNET
						,ILK_SS HEDEF
						,CAST(NET AS DECIMAL(8,2)) NET
						,S.SINAVTARIH
						,S.ID_SINAVTURU
				INTO	#OGRENCISINAV
				FROM	#v2FrekansOgrenciDetayDonem	T
				JOIN	#SINAVTURU		ST	ON	ST.ID_SINAVTURU	= T.ID_SINAVTURU
				JOIN	v3Kullanici		K	ON	K.TCKIMLIKNO	= T.TC_OGRENCI
				LEFT JOIN Sinav			S	ON	S.ID_SINAV		= T.ID_SINAV
				WHERE	TC_OGRENCI		=	@_TC_OGRENCI
					AND TAKMAAD			=	@_DERSAD
					AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
					AND T.FREKANS IS NOT NULL
				GROUP BY	SUBEAD,TAKMAAD,ST.AD,ST.ID_SINAVTURU,K.AD+' '+K.SOYAD,T.ID_SINAV,T.TC_OGRENCI ,T.FREKANS	, SINIFAD,SS,HBNET,ILK_SS,NET,S.SINAVTARIH,S.ID_SINAVTURU


				IF (SELECT COUNT(1) FROM #OGRENCISINAV WHERE ID_SINAVTURU != 6 )>1
				BEGIN
					INSERT INTO #OGRENCISINAV (SUBEAD,TAKMAAD,SINAVTURU,SINAVADI,SINAVPUANI		,SINIFAD,SS,HBNET,HEDEF,NET,SINAVTARIH)
					SELECT	SUBEAD,TAKMAAD,SINAVTURU,'ORTALAMA',AVG(SINAVPUANI)		,SINIFAD,SS,CAST(AVG(HBNET) AS decimal(8,2)),HEDEF,CAST(AVG(NET) AS DECIMAL(8,2)),GETDATE()
					FROM	#OGRENCISINAV 
					GROUP BY SUBEAD,TAKMAAD,SINAVTURU	,SINIFAD,SS,HEDEF
				END

				select(
							select * from(
								select 
								(					
									SELECT		[KAMPÜS]		= SUBEAD,
												[SINIF]			= SINIFAD,
												[BRANŞ]			= TAKMAAD,
												[SINAV TÜRÜ]	= SINAVTURU,
												[SINAV]			= SINAVADI,
												[SORU SAYISI]	= SS,
												[H.B. NET ORT.] = HBNET,
												[HEDEFE UZAKLIK]= HEDEF-HBNET,
												[ÖĞR NET]		= NET,
												[PUAN]			= SINAVPUANI,
												[FREKANS]		= SINAVPUANI,
												ADSOYAD
									FROM		#OGRENCISINAV 
									ORDER BY SINAVTARIH
									FOR JSON AUTO
								) as t4
												
							) as tablo FOR JSON AUTO
						) as tt
			
				DROP TABLE IF EXISTS #OGRENCISINAV
			END
			IF @_ISLEM = 5	--	ÖĞRETMEN SINIF GRAFİĞİ		
			BEGIN 
			
					
			

				DECLARE @_SINAVLAR TABLE(SINAVADI VARCHAR(MAX))
				IF (0 IN (SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU)))
				BEGIN
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

						SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,'FREKANS' SINAVADI
						INTO	#FREKANSOGRETMEN2
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	TC_OGRETMEN	= @_TC_OGRETMEN --'56377383260'
							AND FREKANS IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND T.DONEM		= @_DONEM
						GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU

						SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],FREKANS,SINAVADI INTO #PIVOT  FROM #FREKANSOGRETMEN2

						INSERT INTO @_SINAVLAR (SINAVADI) VALUES ('FREKANS')

						select(
							select * from(
								select 
								(					
									SELECT		*
									FROM		#PIVOT 
									FOR JSON AUTO
								) as t5,
								(					
									SELECT	SINAVADI
									FROM	@_SINAVLAR
									FOR JSON AUTO
								) as t6
												
							) as tablo FOR JSON AUTO
						) as tt

					
						DROP TABLE IF EXISTS #PIVOT
						DROP TABLE IF EXISTS #FREKANSOGRETMEN2

				END
				ELSE
				BEGIN
			
						DROP TABLE IF EXISTS #v2FrekansOgretmen


						SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,CASE 
									WHEN ST.ID_SINAVTURU=0 THEN (SELECT AD FROM Yazili WHERE ID_YAZILI=T.ID_SINAV) 
									ELSE (SELECT TOP 1 SUBSTRING(K.AD ,1, CHARINDEX('.',K.AD)-1 )+'-'+S.AD FROM Sinav S JOIN v3Kademe3 K ON K.ID_KADEME3 = S.ID_KADEME3 WHERE S.ID_SINAV=T.ID_SINAV) 
									--ELSE (SELECT TOP 1 AD FROM Sinav S WHERE S.ID_SINAV=T.ID_SINAV) 								
								END SINAVADI
						INTO	#v2FrekansOgretmen
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU				ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	TC_OGRETMEN	= @_TC_OGRETMEN --'56377383260'
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
						GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,ID_SINAV,SINIFAD,ST.AD,ST.ID_SINAVTURU

						--TAHSİN--
						INSERT INTO #v2FrekansOgretmen
						SELECT	TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,999999999 as ID_SINAV,SINIFAD SINIF,ST.AD [SINAV TÜRÜ],cast(AVG(FREKANS) as decimal(8,2)) FREKANS
								,ST.KISAAD+' ORT' as SINAVADI
						FROM	#v2FrekansOgrenciDetayDonem	T
						JOIN	#SINAVTURU		ST	ON ST.ID_SINAVTURU	= T.ID_SINAVTURU
						WHERE 	TC_OGRETMEN	= @_TC_OGRETMEN --'56377383260'
							AND T.DONEM		= @_DONEM
							AND FREKANS		IS NOT NULL
							AND ST.ID_SINAVTURU IN	(SELECT VALUE FROM OPENJSON( @_ID_SINAVTURU))
							AND (	T.ID_KADEME3	IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3)) 
								OR	0				IN	(SELECT VALUE FROM OPENJSON( @_ID_KADEME3))
								)
							AND ST.ID_SINAVTURU NOT IN (5,6) -- AAYKS VEYA YDS DEĞİLSE
						GROUP BY TC_OGRETMEN,ID_SINIF,T.ID_SINAVTURU,SINIFAD,ST.AD,ST.ID_SINAVTURU, ST.KISAAD
						--TAHSİN--
					
						DECLARE @_cols	AS NVARCHAR(MAX),
								@_cols2	AS NVARCHAR(MAX),
								@_cols3	AS NVARCHAR(MAX),
								@_SQL	AS NVARCHAR(MAX);

						--SET @_cols = STUFF((SELECT distinct ',' + QUOTENAME(c.SINAVADI) 
						--			FROM #v2FrekansOgretmen c
						--			FOR XML PATH(''), TYPE
						--			).value('.', 'NVARCHAR(MAX)') 
						--		,1,1,'')

						--SET @_cols2 = STUFF((SELECT distinct ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						----',' + QUOTENAME(c.SINAVADI) 
						--			FROM #v2FrekansOgretmen c
						--			FOR XML PATH(''), TYPE
						--			).value('.', 'NVARCHAR(MAX)') 
						--		,1,1,'')

						--		--SUM DAN DOLAYI SORUN OLABILIR
						--SET @_cols3 = STUFF((SELECT distinct ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						----',' + QUOTENAME(c.SINAVADI) 
						--			FROM #v2FrekansOgretmen c
						--			FOR XML PATH(''), TYPE
						--			).value('.', 'NVARCHAR(MAX)') 
						--		,1,1,'')

						--TAHSİN--
						SET @_cols = STUFF((SELECT ',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
		
						SET @_cols2 = STUFF((SELECT ',ISNULL(' + QUOTENAME(c.SINAVADI) + ', ''0'') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')

								--SUM DAN DOLAYI SORUN OLABILIR
						SET @_cols3 = STUFF((SELECT ',SUM(' + QUOTENAME(c.SINAVADI) + ') ' + QUOTENAME(c.SINAVADI)
						--',' + QUOTENAME(c.SINAVADI) 
									FROM #v2FrekansOgretmen c GROUP BY c.SINAVADI, c.ID_SINAV ORDER BY c.ID_SINAV
									FOR XML PATH(''), TYPE
									).value('.', 'NVARCHAR(MAX)') 
								,1,1,'')
						--TAHSİN--

						INSERT INTO @_SINAVLAR (SINAVADI)
							SELECT	DISTINCT SINAVADI
							FROM	#v2FrekansOgretmen

						SET @_SQL='
					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1


							SELECT TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols2 AS varchar(MAX))+' INTO #PVT1 FROM (
								SELECT * FROM #v2FrekansOgretmen
							)AS TABLO
							PIVOT (MAX(FREKANS) FOR SINAVADI IN ('+CAST(@_cols AS varchar(MAX))+')) AS P
					

							SELECT		TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ],'+CAST(@_cols3 AS varchar(MAX))+'
										INTO		#PVT
										FROM		#PVT1 
										group by TC_OGRETMEN,ID_SINIF,ID_SINAVTURU,SINIF,[SINAV TÜRÜ]
					
							select(
								select * from(
									select 
									(					
										SELECT		*
										FROM		#PVT 
										FOR JSON AUTO
									) as t5,
									(					
										SELECT	DISTINCT SINAVADI
										FROM	#v2FrekansOgretmen
										FOR JSON AUTO
									) as t6
												
								) as tablo FOR JSON AUTO
							) as tt

					
							DROP TABLE IF EXISTS #PVT
							DROP TABLE IF EXISTS #PVT1

						'
					
						print @_SQL
						EXECUTE (@_SQL)

						--set @_SQL='
						--	'

						--			execute (@_SQL)
								

				DROP TABLE IF EXISTS #v2FrekansOgretmen
					
				END
			

			
			END
			IF @_ISLEM = 6	--	DERSLER						
			BEGIN 
			
				--	INTO #DERSLER
				SELECT	D.* 
				INTO	#DERSLER 
				FROM	v3SinavDers D
				INNER JOIN [OkyanusDB].[dbo].[v3FrekansDers] FD ON FD.ID_KADEME3=D.ID_KADEME3 AND FD.AD=D.AD

				select(
							select * from(
								select 
								(	

									SELECT	DISTINCT D.AD
									FROM	#DERSLER			D
									JOIN	v2FrekansOgrenciDetay OD	ON	OD.DERSAD=D.AD
									WHERE	OD.ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 
										AND OD.ID_SINAVTURU	in (SELECT VALUE FROM OPENJSON(@_ID_SINAVTURU)) 
										AND OD.DONEM = @_DONEM

									FOR JSON AUTO
								) as t5
												
							) as tablo FOR JSON AUTO
						) as tt
			END
			IF @_ISLEM = 7	--	SINAV TURU					
			BEGIN 
			
			

				select ID_SINAVTURU,15 ID_KADEME3 , AD, KISAAD 
				INTO #GrupSinavTuru 
				from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,16 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5)
			union 
				select ID_SINAVTURU,17 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (6,5,2)
			union 
				select ID_SINAVTURU,18 , AD, KISAAD from SinavTuru s where ID_SINAVTURU in (3,2)
			--union 
			--	select 0,15 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,16 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,17 , 'YAZILI', 'YAZ'
			--union 
			--	select 0,18 , 'YAZILI', 'YAZ'

					INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					SELECT ST.ID_SINAVTURU,K.ID_KADEME3,ST.AD,ST.KISAAD
					FROM v3Kademe3	K
					JOIN SinavTuru	ST	ON ST.ID_SINAVTURU IN (8,9)	
					WHERE ID_KADEME3 IN ( 11,12,13,14)


					--INSERT INTO #GrupSinavTuru (ID_SINAVTURU, ID_KADEME3 , AD, KISAAD )
					--SELECT 0,K.ID_KADEME3,'YAZILI', 'YAZ'
					--FROM v3Kademe3	K
					--WHERE ID_KADEME3 IN ( 11,12,13,14)

					
				SELECT distinct	ID_SINAVTURU,AD,KISAAD
				FROM	#GrupSinavTuru 
				WHERE	ID_KADEME3	in (SELECT VALUE FROM OPENJSON(@_ID_KADEME3)) 


				drop table #GrupSinavTuru
			END		
			IF @_ISLEM = 8	--	SON FİLTRE GETİR			
			BEGIN 


				SELECT ISNULL((
					SELECT TOP 1 PARAMETRELER
					FROM [Log]
					WHERE	TCKIMLIKNO	= @_TCKIMLIKNO
						AND ID_MENU		= 1099
						AND ISLEM		= 1
					ORDER BY KYE_TARIH DESC
				),'[]')
			END
		
			DROP TABLE IF EXISTS #DERSLER
			DROP TABLE IF EXISTS #SINAVTURU
			DROP TABLE IF EXISTS #ARALIK
			DROP TABLE IF EXISTS #ETKI
			DROP TABLE IF EXISTS #v2FrekansOgrenciDetayDonem

		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_v2FrekansSistemEksikKazanim]...';


GO
ALTER procedure [dbo].[sp_v2FrekansSistemEksikKazanim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMKOD			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@EOKUL				INT				=	0
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMKOD					= @DONEMKOD		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON					= @SQLJSON		
			,EOKUL						= @EOKUL			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--select* from OkyanusDB.dbo.v3Kullanici where TCKIMLIKNO= '27296533692'
--	exec sp_FrekansSistemEksikKazanim @ID_MENU=1,@ISLEM=2,@DERSAD='Geometri',@DONEM='2017',@ID_SUBE=309,@ID_KADEME3='[0,15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='27296533692',@TC_OGRENCI='10987583618',@TCKIMLIKNO='27296533692',@OTURUM='E888F3FF-7DC1-4743-B683-4CE6141E16DC',@ID_SINIF=101525

BEGIN TRY    
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
	

	IF @DONEM = '' OR @DONEM IS NULL	
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF=1)
 
 	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1 or @EOKUL=1
	BEGIN
		drop table if exists #temp4T
		drop table if exists #TEMPORTT
		drop table if exists #t1
		drop table if exists #t3
		drop table if exists #temp
		drop table if exists #temp3
		drop table if exists #temp4
		drop table if exists #TEMPORT
		drop table if exists #TEMPORTS
		drop table if exists #tempY2
		drop table if exists #ttemp
		drop table if exists #ttemp3
		drop table if exists #TTEMPORTS
	
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		--OGRENCI 
		IF @ISLEM = 1
		BEGIN
		--Declare @UNITEDONEMKOD varchar(4)=(select DONEM from OKYANUSDB.DBO.v3AktifDonem WHERE AKTIF=1)
			IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY

				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.AD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempsY
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND YO.TCKIMLIKNO = @TC_OGRENCI AND Y.DONEM = @DONEM AND D.AD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.AD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempY
					  from #tempsY t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempY2
					  from #tempsY t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTY
						from #tempY
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempY2
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivots
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTY WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2
						 from ##pivots p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY
			END
			ELSE	-- SINAVLAR
			BEGIN
			
					SELECT
						 S.ID_SINAV AS ID_SINAVBILGI
						,S.AD AS ACIKLAMA
						,SD.TAKMAAD AS DERSAD
						,SUBSTRING(SA.KOD,1,9) AS KONUKODU
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU						
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)) AS KAZANIM
						,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
						,SUM(1) AS KONUSAYISI
						,D.ID_DERS
						,S.SINAVTARIH
					INTO #temp
					FROM	   [Pusulam].dbo.Sinav					S	 WITH (NOLOCK) 
					INNER JOIN [Pusulam].dbo.SinavOgrenci			SO	 WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
					--INNER JOIN OkyanusDB.dbo.v3OgrenciTum			O	 WITH (NOLOCK) ON O.TCKIMLIKNO=SO.TCKIMLIKNO
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB WITH (NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevap		SOC  WITH (NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
					INNER JOIN [Pusulam].dbo.SinavKitapcik			SK	 WITH (NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
					INNER JOIN [Pusulam].dbo.SinavDers				SD   WITH (NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
					INNER JOIN OkyanusDB.dbo.v3SinavDers			D    WITH (NOLOCK) ON D.ID_DERS=SD.ID_DERS
					INNER JOIN [Pusulam].dbo.SinavAnahtar			SA   WITH (NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
					--INNER JOIN OkyanusDB.dbo.v3Kademe3				K3   WITH (NOLOCK) ON K3.IDNNN_KADEME3=S.ID_KADEME3
					WHERE		S.FREKANSHESAPLA=1
							AND S.AKTIF=1
							AND S.DURUM=2
							--AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
							--AND (O.ID_SINIF=@ID_SINIF)
							AND S.DONEM = @DONEM
							AND (D.AD=@DERSAD)
							AND SO.TCKIMLIKNO = @TC_OGRENCI							
							AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
					GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD, SOC.DURUM,D.ID_DERS,SINAVTARIH
					ORDER BY S.ID_SINAV,SA.KOD

				  Select t2.ID_SINAVBILGI,  
						 t2.ACIKLAMA,
						 t2.ID_DERS,
						 t2.DERSAD,
						 t2.KONUKODU,
						 t2.UNITE,
						 t2.KONU,
						 t2.KONUSAYISI,
						 t2.DOGRUSAYISI,SINAVTARIH,
						(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
					into #temp3
					from #temp t2
				order by t2.ID_SINAVBILGI,t2.KONUKODU

				  Select KONUKODU,
						 ID_DERS,
						 SUM(KONUSAYISI) as KONUSAYISI,
						 SUM(DOGRUSAYISI) as DOGRUSAYISI
					into #TEMPORTS
					from #temp3 
				group by KONUKODU,ID_DERS

				  Select KONUKODU,
						 ID_DERS,
						 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
					into #TEMPORT
					from #TEMPORTS 

					
select KONUKODU,ID_SINAVBILGI,sum(KONUSAYISI) KONUSAYISI, sum(DOGRUSAYISI) DOGRUSAYISI,(Convert(decimal(6,2),(Convert(decimal(7,2),sum(DOGRUSAYISI))/convert(decimal(7,2),sum(KONUSAYISI)))*100))  as YUZDE into #k  from #temp group by KONUKODU,ID_SINAVBILGI

	  
				  Select t3.ID_SINAVBILGI,  
						 t3.ACIKLAMA,
						 t3.ID_DERS,
						 t3.DERSAD,
						 t3.KONUKODU,
						 t3.UNITE,
						 t3.KONU,
						 t3.KONUSAYISI,SINAVTARIH,
						 '('+Cast(k.KONUSAYISI as varchar)+') / '+Cast(k.YUZDE as varchar)+' %' as YUZDE
					into #temp4
					from #temp3 t3
					join #k		k	on k.ID_SINAVBILGI=t3.ID_SINAVBILGI and k.KONUKODU=t3.KONUKODU
				order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

				   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
				  from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI	
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI

				  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA+' (S.S.) / %')
					from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI
		   



		   DROP TABLE IF EXISTS ##pivot
				  Set @SQL='
						  with PivotData as
						  (
							Select 
							 ACIKLAMA,
							 ID_DERS,
							 DERSAD,
							 KONUKODU,
							 UNITE,
							 KONU,
							 YUZDE
							from #temp4
						  )

						  Select 
						   ID_DERS,
						   DERSAD,
						   KONUKODU,
						   ISNULL(UNITE,''-'') UNITE,
						   ISNULL(KONU,''-'') KONU,
						   '+@Columns2+'
						   into ##pivot
						   from PivotData
						   PIVOT
						   (
							MAX(YUZDE)
							FOR ACIKLAMA
							IN('+@Columns+')
						   ) as PivotResult
						   ORDER BY DERSAD,KONUKODU,UNITE
				   '
				   PRINT @SQL
				   PRINT '11'
				   EXEC (@SQL)
				   
--	exec sp_FrekansSistemEksikKazanim @ISLEM=1,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[6]',@TC_OGRETMEN='41318131710',@TC_OGRENCI='13882709862',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'

				   Select (Select Count(DERSAD) from ##pivot pp where pp.DERSAD=p.DERSAD) DERSADET,
						  p.*,
						  '('+Cast((SELECT SUM(KONUSAYISI) FROM #temp3 WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU) as varchar)+') / '+
						  Cast(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORT WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU)) as varchar)
						  +' %' 
						  as 'KAZANIM YÜZDE (T.S.S) / %'
					INTO #t1
					 from ##pivot p


					 select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t1 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
		   END
		END
	
		-- SINIF 
		IF @ISLEM = 2
		BEGIN
		IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT

				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.AD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempOgrtYazili
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OKYANUSDB.DBO.V3DONEM DN ON DN.ID_DONEM = O.ID_DONEM AND DN.KOD = Y.DONEM
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND O.ID_SINIF = @ID_SINIF AND Y.DONEM = @DONEM AND D.AD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.AD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempYO
					  from #tempOgrtYazili t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempPivot
					  from #tempOgrtYazili t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTYOGRT
						from #tempYO
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempPivot
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivotOgrtY
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTYOGRT WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2Y
						 from ##pivotOgrtY p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2Y 
										FOR JSON AUTO
									) as t3											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT


			END
		ELSE	-- SINAVLAR
			BEGIN
				SELECT
					 S.ID_SINAV AS ID_SINAVBILGI
					,S.SINAVTARIH
					,S.AD AS ACIKLAMA
					,SD.TAKMAAD AS DERSAD
					--,SUBSTRING(SA.KOD,1,9) AS KONUKODU				
					,SA.KOD AS KONUKODU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)),'-') AS UNITE
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)),'-') AS KONU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)),'-') AS KAZANIM
					,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
					,SUM(1) AS KONUSAYISI
				INTO #ttemp
				FROM	   [Pusulam].dbo.Sinav S
				INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK)ON SO.ID_SINAV=S.ID_SINAV
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO				
				INNER JOIN OKYANUSDB.DBO.V3DONEM DN ON DN.ID_DONEM = O.ID_DONEM AND DN.KOD = S.DONEM
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
				INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
				INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
				INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS=SD.ID_DERS
				INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
				--INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
				WHERE		S.FREKANSHESAPLA=1  
						AND S.AKTIF=1
						AND S.DURUM=2
						--AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
						AND S.DONEM = @DONEM
						AND (D.AD=@DERSAD)
						AND O.ID_SINIF=@ID_SINIF
						AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
				GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,S.SINAVTARIH
				ORDER BY S.ID_SINAV,SA.KOD


			  Select t2.ID_SINAVBILGI,  
					 t2.ACIKLAMA,
					 t2.SINAVTARIH,
					 t2.DERSAD,
					 t2.KONUKODU,
					 t2.UNITE,
					 t2.KONU,
					 t2.KAZANIM,
					 t2.KONUSAYISI,
					 t2.DOGRUSAYISI,
					(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				into #ttemp3
				from #ttemp t2
			order by t2.ID_SINAVBILGI,t2.KONUKODU


			  Select KONUKODU,
					 SUM(KONUSAYISI) as KONUSAYISI,
					 SUM(DOGRUSAYISI) as DOGRUSAYISI
				into #TTEMPORTS
				from #ttemp3 
			group by KONUKODU

			  Select KONUKODU,
					 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
				into #TEMPORTT
				from #TTEMPORTS 


			  Select t3.ID_SINAVBILGI,  
					 t3.ACIKLAMA,
					 t3.DERSAD,
					 t3.SINAVTARIH,
					 t3.KONUKODU,
					 t3.UNITE,
					 t3.KONU,
					 t3.KAZANIM,
					 '('+ cast ( t3.KONUSAYISI as varchar)+') / ' + Cast(t3.YUZDE as varchar)+'%' as YUZDE
				into #temp4T
				from #ttemp3 t3
			order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

	  
		
			   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
			  from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH				   	
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI

			  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
				from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI
		  
		  
		   
		   
			if exists (Select * from #temp4T)
			begin
					drop table if exists ##pivotS
					drop table if exists ##TT
					  Set @SQL='
					  with PivotData as
					  (
						Select 
						 ACIKLAMA,
						 DERSAD,
						 KONUKODU,
						-- UNITE,
						 KONU,
						 KAZANIM,
						 YUZDE
						from #temp4T
					  )

					  Select 
					   DERSAD,
					   KONUKODU,
					  -- UNITE,
					   KONU,
						 KAZANIM,
					   '+@Columns2+'
					   into ##pivotS
					   from PivotData
					   PIVOT
					   (
						MAX(YUZDE)
						FOR ACIKLAMA
						IN('+@Columns+')
					   ) as PivotResult
					   ORDER BY DERSAD,KONUKODU--,UNITE

					   SELECT * 
					   INTO ##TT
					   FROM ##pivotS
					   GROUP BY DERSAD,KONUKODU,KONU,KAZANIM,'+@Columns+'
							--,UNITE
					   '
					   PRINT @SQL
					   PRINT '1'
					   EXECute (@SQL)
					   PRINT '1'
		  
					  Select  p.*,ORTALAMA = '('+ cast( (SELECT sum(KONUSAYISI) FROM #ttemp3 WHERE KONUKODU = p.KONUKODU) as varchar) +') / '+ Cast(   
														CONVERT(DECIMAL(10,2),
																(SELECT ORTALAMA FROM #TEMPORTT WHERE KONUKODU = p.KONUKODU)
															   ) 
														  as varchar(10))+'%'
							  INTO #t3
						 from ##TT p
			 
					   PRINT '2'
				IF @EOKUL=1
				BEGIN 
					SELECT * FROM #t3 
				END
				ELSE
				BEGIN 
			--	drop table if exists ##pivotS
			--	exec sp_FrekansSistemEksikKazanim @ISLEM=2,@DERSAD='Biyoloji',@DONEM='2017',@ID_SINIF=101549,@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'
	
							select(
									select * from(
											select 
											(					
												SELECT		*
												FROM		#t3 
												FOR JSON AUTO
											) as t3											
										) as tablo FOR JSON AUTO
									) as tt
				END
			end
			else 
			begin
			select(
										select * from(
												select 
												(					
													SELECT		null
										
												) as t3											
											) as tablo FOR JSON AUTO
										) as tt
			end
			   --drop table if exists ##pivotS
			   drop table if exists #temp4T
			   drop table if exists #TEMPORTT
			   drop table if exists #t1
			   drop table if exists #t3
			   drop table if exists #temp
			   drop table if exists #temp3
			   drop table if exists #temp4
			   drop table if exists #TEMPORT
			   drop table if exists #TEMPORTS
			   drop table if exists #tempY2
			   drop table if exists #ttemp
			   drop table if exists #ttemp3
			   drop table if exists #TTEMPORTS
		   
			END
		END
		
		-- OGRETMEN
		IF @ISLEM = 3
		BEGIN
		
--	exec sp_FrekansSistemEksikKazanim @ISLEM=3,@DERSAD='Matematik',@DONEM='2017',@ID_SUBE=427,@ID_KADEME3='[15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='45103215326',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'


			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO
		   DROP table IF EXISTS #ID_KADEME3
		   DROP table IF EXISTS #ID_SINAVTURU
		   DROP table IF EXISTS #OGRENCILIST

		   SELECT VALUE AS ID_KADEME3   INTO #ID_KADEME3	FROM OPENJSON (@ID_KADEME3)
		   SELECT VALUE AS ID_SINAVTURU INTO #ID_SINAVTURU	FROM OPENJSON (@ID_SINAVTURU)
		   

		SELECT DISTINCT O.TCKIMLIKNO
		INTO #OGRENCILIST
		FROM v3OgrenciTum	O
		JOIN eokul_v2.dbo.DersOgretmen	DO	ON	DO.ID_SINIF		= O.ID_SINIF
		WHERE O.DONEM			= @DONEM
			AND DO.TC_OGRETMEN	= @TC_OGRETMEN

		SELECT 
			 ID_SINAVBILGI	= S.ID_SINAV
			,ACIKLAMA		= S.AD +'('+CAST(S.ID_SINAV AS varchar(10))+')'
			,DERSAD			= SD.TAKMAAD
			,KONUKODU		= SR.KOD
			,UNITE			= (SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SR.KOD,1,6))
			,KONU			= (SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SR.KOD,1,9))			
			,DOGRUSAYISI	= SUM(CASE WHEN SR.DURUM='D' THEN 1 ELSE 0 END)
			,KONUSAYISI		= COUNT(1)
			,K3.ID_KADEME3
			,K3.AD GRUP
			,S.SINAVTARIH
		INTO #tempO
		FROM Sinav						S
		JOIN #ID_SINAVTURU				IST	ON	IST.ID_SINAVTURU= S.ID_SINAVTURU
		JOIN v3Kademe3					K3	ON	K3.ID_KADEME3	= S.ID_KADEME3
		JOIN #ID_KADEME3				IK	ON	IK.ID_KADEME3	= K3.ID_KADEME3
		JOIN SinavDers					SD	ON	SD.ID_SINAV		= S.ID_SINAV 
		JOIN v3SinavDers				D	ON	D.ID_DERS		= SD.ID_DERS
		JOIN SinavOgrenci				SO	ON	SO.ID_SINAV		= S.ID_SINAV
		JOIN #OGRENCILIST				O	ON	O.TCKIMLIKNO	= SO.TCKIMLIKNO
		JOIN vw_SinavOgrenciSoru		SR	ON	SR.ID_SINAVDERS = SD.ID_SINAVDERS AND SR.TCKIMLIKNO = O.TCKIMLIKNO
		WHERE	S.DONEM				= @DONEM
			AND S.FREKANSHESAPLA	= 1
			AND S.AKTIF				= 1
			AND S.DURUM				= 2
			AND D.AD				= @DERSAD
		GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SR.KOD,K3.ID_KADEME3,SINAVTARIH,K3.AD 
		ORDER BY S.ID_SINAV,SR.KOD
		--SELECT
		--	 S.ID_SINAV AS ID_SINAVBILGI
		--	,S.AD +'('+CAST(S.ID_SINAV AS varchar(10))+')' AS ACIKLAMA
		--	,SD.TAKMAAD AS DERSAD
		--	,SA.KOD AS KONUKODU
		--	,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
		--	,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU
		--	,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
		--	,SUM(1) AS KONUSAYISI
		--	,K3.ID_KADEME3
		--	,K3.AD GRUP
		--	,S.SINAVTARIH
		--INTO #tempO
		--FROM	   [Pusulam].dbo.Sinav S
		--INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
		--INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
		--INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
		--INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
		--INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
		--INNER JOIN OkyanusDB.dbo.v3SinavDers D ON D.ID_DERS=SD.ID_DERS
		--INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
		--INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
		--INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
		--INNER JOIN OKYANUSDB.DBO.V3DONEM DN ON DN.ID_DONEM = O.ID_DONEM AND DN.KOD = S.DONEM
		--INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF=O.ID_SINIF	AND DO.DONEMKOD=@DONEM								
		--WHERE		S.FREKANSHESAPLA=1  
		--		AND S.AKTIF=1
		--		AND S.DURUM=2
		--		AND K3.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON (@ID_KADEME3))
		--		AND S.DONEM = @DONEM
		--		AND (D.AD = @DERSAD)
		--		AND DO.TC_OGRETMEN=@TC_OGRETMEN
		--		AND S.AKTIF=1
		--		AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))
		--GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,K3.ID_KADEME3,SINAVTARIH,K3.AD 
		--ORDER BY S.ID_SINAV,SA.KOD


		  Select t2.ID_SINAVBILGI,  
		         t2.ACIKLAMA,
			     t2.DERSAD,
			     t2.KONUKODU,
			     t2.UNITE,
				 t2.KONU,
				 t2.KONUSAYISI,
				 t2.DOGRUSAYISI,SINAVTARIH,
			    (Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				,ID_KADEME3,GRUP
		    into #temp3O
		    from #tempO t2
	    order by t2.ID_SINAVBILGI,t2.KONUKODU


		  Select KONUKODU,
				 SUM(KONUSAYISI) as KONUSAYISI,
		         SUM(DOGRUSAYISI) as DOGRUSAYISI
			into #TEMPORTSO
	        from #temp3O
		group by KONUKODU

		  Select KONUKODU,
		         (Convert(decimal(10,0),(Convert(decimal(10,2),DOGRUSAYISI)/convert(decimal(10,2),KONUSAYISI))*100)) as ORTALAMA
			into #TEMPORTO
	        from #TEMPORTSO

	      Select t3.ID_SINAVBILGI,  
		         t3.ACIKLAMA,
			     t3.DERSAD,
			     t3.KONUKODU,
			     t3.UNITE,
				 t3.KONU,SINAVTARIH,
			     Cast(t3.YUZDE as varchar)+'%' as YUZDE
				 ,ID_KADEME3,GRUP
		    into #temp4O
		    from #temp3O t3
	    order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

		drop table #temp3O


		   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
		  from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
				   	
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI

		  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
		    from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI
--		   exec sp_FrekansSistem @ISLEM=3,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'




print '1'

IF EXISTS(Select *from #temp4O)
BEGIN

		  Set @SQL='
		  

		  Select 
		   DERSAD,
		   KONU2 KONUKODU,
		   UNITE,
		   KONU,ID_KADEME3,GRUP,
		   '+@Columns2+',
		   ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTO TOR WHERE TOR.KONUKODU = KONU2))
		   into ##t4
		   from(
				Select 
				 ACIKLAMA,
				 DERSAD,			 
				KONUKODU KONU2,
				 UNITE,
				 KONU,
				 YUZDE
				 ,ID_KADEME3,GRUP
				from #temp4O) PivotData
		   PIVOT
		   (
				MAX(YUZDE)
				FOR ACIKLAMA
				IN('+@Columns+')
		   ) as PivotResult
		   ORDER BY DERSAD,KONU2,UNITE
		   
		   '
		   PRINT @SQL
		   
print '2'
		   EXEC (@SQL)

		  
					select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		##t4 
										FOR JSON AUTO
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt

							END
							ELSE
							BEGIN 
								select(
							select * from(
									select 
									(					
										SELECT NULL
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt
							END
			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO
		END
	END
	
	drop table if exists #temp4T
	drop table if exists #TEMPORTT
	drop table if exists #t1
	drop table if exists #t3
	drop table if exists #temp
	drop table if exists #temp3
	drop table if exists #temp4
	drop table if exists #TEMPORT
	drop table if exists #TEMPORTS
	drop table if exists #tempY2
	drop table if exists #ttemp
	drop table if exists #ttemp3
	drop table if exists #TTEMPORTS

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp___TASLAK_SP]...';


GO
ALTER procedure [dbo].[sp___TASLAK_SP]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@SQLJSON				NVARCHAR(MAX)	= NULL

AS
BEGIN
/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 11.09.2020
	
	--	sp Alter 
		--	ISLEM = 12 ADD
	--	ONLINE SINAV DA OPTIK ÇOKLU KITAPCIK

*/	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN
				
				SELECT 1 
				
			END

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Abide]...';


GO
ALTER procedure [dbo].[sp_Abide]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@AD					VARCHAR(MAX)	= NULL,
	@ID_ABIDESINAV		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@O_TCKIMLIKNO		VARCHAR(11)		= NULL,
	@DERS				VARCHAR(MAX)	= NULL,
	@ID_ABIDERESIM		INT				= NULL,
	@ID_ABIDESAYFATUR	INT				= NULL,
	@SIRA				INT				= NULL,
	@KITAPCIKSAYISI		INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@OVGORSUN			BIT				= NULL,
	@ID_ABIDEKITAPCIK	INT				= NULL		
AS
BEGIN

	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM
				,TCKIMLIKNO			= @TCKIMLIKNO
				,OTURUM				= @OTURUM
				,ID_MENU			= @ID_MENU
				,DONEM				= @DONEM
				,AD					= @AD
				,ID_ABIDESINAV		= @ID_ABIDESINAV
				,SQLJSON			= @SQLJSON
				,ID_SINIF			= @ID_SINIF
				,ID_SUBE			= @ID_SUBE
				,O_TCKIMLIKNO		= @O_TCKIMLIKNO
				,DERS				= @DERS
				,ID_ABIDERESIM		= @ID_ABIDERESIM
				,ID_ABIDESAYFATUR	= @ID_ABIDESAYFATUR
				,SIRA				= @SIRA
				,KITAPCIKSAYISI		= @KITAPCIKSAYISI
				,ID_KADEME3			= @ID_KADEME3
				,OVGORSUN			= @OVGORSUN
				,ID_ABIDEKITAPCIK	= @ID_ABIDEKITAPCIK
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    

		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		DECLARE @_ID_ABIDESINAV INT			= @ID_ABIDESINAV
		DECLARE @_ID_SINIF		INT			= @ID_SINIF
		DECLARE @_DONEM			VARCHAR(4)	= ISNULL(@DONEM, OkyanusDB.dbo.fn_AktifDonem() )

		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	SINAV TANIMLA
			BEGIN
				DECLARE @INSERTED TABLE(ID INT NOT NULL);  

				INSERT INTO AbideSinav(AD, DONEM, KYE_TCKIMLIKNO, ID_KADEME3)
				OUTPUT inserted.ID_ABIDESINAV
				INTO @INSERTED
				SELECT @AD, @DONEM, @TCKIMLIKNO, @ID_KADEME3

				DECLARE @cnt INT = 0;

				WHILE @cnt < @KITAPCIKSAYISI
				BEGIN
					INSERT INTO AbideKitapcik(ID_ABIDESINAV, AD)
					SELECT ID, CHAR(65 + @cnt) FROM @INSERTED
					SET @cnt = @cnt + 1;
				END;
			END

			IF @ISLEM = 2	--	SINAV LİSTELE
			BEGIN
				SELECT
				(
					SELECT	 S.ID_ABIDESINAV
							,S.AD
							,KADEME3		= K3.AD
							,TARIH			= CONVERT(varchar, S.KYE_TARIH, 104) 
							,ADSOYAD		= K.AD + ' ' + K.SOYAD 
							,KITAPCIKSAYISI	= (SELECT COUNT(*) FROM AbideKitapcik SK WHERE SK.ID_ABIDESINAV = S.ID_ABIDESINAV) 
							,S.OVGORSUN
					FROM AbideSinav S 
					INNER JOIN OkyanusDb.dbo.v3Kullanici K ON K.TCKIMLIKNO = S.KYE_TCKIMLIKNO
					INNER JOIN v3Kademe3				 K3 ON K3.ID_KADEME3	= S.ID_KADEME3
					WHERE	S.DONEM		 = @DONEM 
						AND S.ID_KADEME3 = @ID_KADEME3
						AND S.AKTIF		 = 1 
					ORDER BY S.KYE_TARIH DESC 
					FOR JSON PATH
				)
			END

			IF @ISLEM = 3	--	SINAV DUZENLE
			BEGIN
				UPDATE AbideSinav SET 
					 AD			= @AD
					,ID_KADEME3 = @ID_KADEME3 
				WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				DECLARE @MEVCUTKITAPCIKSAYISI INT = (SELECT COUNT(*) FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV)

				IF @KITAPCIKSAYISI <> @MEVCUTKITAPCIKSAYISI
				BEGIN
					IF @KITAPCIKSAYISI > @MEVCUTKITAPCIKSAYISI
					BEGIN
						DECLARE @cntx INT = @MEVCUTKITAPCIKSAYISI;

						WHILE @cntx < @KITAPCIKSAYISI
						BEGIN
							INSERT INTO AbideKitapcik(ID_ABIDESINAV, AD)
							SELECT @ID_ABIDESINAV, CHAR(65 + @cntx)

							DECLARE @YENIID_ABIDEKITAPCIK INT = (SELECT ID_ABIDEKITAPCIK FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV AND AD = CHAR(65 + @cntx))

							IF EXISTS (SELECT * FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
							BEGIN
								INSERT INTO AbideSoruKarsilik(ID_ABIDESORU, ID_ABIDEKITAPCIK, SORUNO)
								SELECT S.ID_ABIDESORU, @YENIID_ABIDEKITAPCIK, S.SORUNO
								FROM AbideSoru S
							END
							
							SET @cntx = @cntx + 1;
						END;
					END
					ELSE
					BEGIN
						SELECT TOP(@MEVCUTKITAPCIKSAYISI - @KITAPCIKSAYISI) ID_ABIDEKITAPCIK 
						INTO #TEMPKITAPCIK
						FROM AbideKitapcik WHERE ID_ABIDESINAV = @ID_ABIDESINAV
						ORDER BY ID_ABIDEKITAPCIK DESC

						DELETE SK FROM AbideSoruKarsilik SK
						INNER JOIN #TEMPKITAPCIK K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK

						DELETE K FROM AbideKitapcik K
						INNER JOIN #TEMPKITAPCIK T ON T.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK
					END
				END
			END

			IF @ISLEM = 4	--	SINAV SİL
			BEGIN
				UPDATE AbideSinav SET AKTIF = 0 WHERE ID_ABIDESINAV = @ID_ABIDESINAV
			END

			IF @ISLEM = 5	--	SINAV EXCEL YÜKLE
			BEGIN
				IF EXISTS (	
							SELECT * FROM AbideOgrenci O 
							INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
							WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
						)
				BEGIN
					RAISERROR ('Seçilen sınav için öğrenci girişi yapıldığından güncelleme işlemi yapılamaz!', 16, 1);
				END
				ELSE
				BEGIN
					DELETE SK 
					FROM AbideSoruKarsilik	SK
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU	= SK.ID_ABIDESORU 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
				
					DELETE FROM AbideSoru		WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbideYorum		WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbidePuanAralik WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					DELETE FROM AbideBeceri		WHERE ID_ABIDESINAV = @ID_ABIDESINAV

					DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  

					INSERT INTO AbideSoru (ID_ABIDESINAV, DERS, SORUNO, KAZANIM, BECERI, PUAN, ID_BILGI, ID_BILISSELSUREC)
					OUTPUT inserted.ID_ABIDESORU, inserted.SORUNO
					INTO @INSERTEDSORU
					SELECT @ID_ABIDESINAV, DERS, SORUNO, KAZANIM, BECERI, PUAN, ID_BILGI, ID_BILISSELSUREC 
					FROM OPENJSON(@SQLJSON, '$.SORULIST')
					WITH (
						DERS				VARCHAR(MAX),
						SORUNO				INT,
						KAZANIM				VARCHAR(MAX),
						BECERI				VARCHAR(MAX),
						PUAN				INT,
						ID_BILGI			INT,
						ID_BILISSELSUREC	INT
					)

					INSERT INTO AbideSoruKarsilik
					SELECT ID, K.ID_ABIDEKITAPCIK, S.SORUNO FROM @INSERTEDSORU S
					CROSS JOIN AbideKitapcik K WHERE K.ID_ABIDESINAV = @ID_ABIDESINAV
				
					INSERT INTO AbideYorum (ID_ABIDESINAV, DERS, DUZEY, YORUM, ONERI)
					SELECT @ID_ABIDESINAV, DERS, DUZEY, YORUM, ONERI FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
					WITH (
						DERS  VARCHAR(MAX),
						DUZEY VARCHAR(MAX),
						YORUM VARCHAR(MAX),
						ONERI VARCHAR(MAX)
					)
				
					INSERT INTO AbidePuanAralik(ID_ABIDESINAV, MAXIMUMPUAN, DUZEY)
					SELECT @ID_ABIDESINAV, MAXIMUMPUAN, DUZEY FROM OPENJSON(@SQLJSON, '$.PUANARALIKLIST')
					WITH (
						MAXIMUMPUAN INT,
						DUZEY		VARCHAR(MAX)
					)
				
					INSERT INTO AbideBeceri(ID_ABIDESINAV, DERS, BECERI, ACIKLAMA)
					SELECT @ID_ABIDESINAV, DERS, BECERI, ACIKLAMA FROM OPENJSON(@SQLJSON, '$.BECERILIST')
					WITH (
						DERS		VARCHAR(MAX),
						BECERI		VARCHAR(MAX),
						ACIKLAMA	VARCHAR(MAX)
					)
				END
			END

			IF @ISLEM = 6	--	SINAV EXCEL LİSTELE
			BEGIN
				SELECT
				(
					SELECT
					(SELECT [ID_ABIDESORU] ,[ID_ABIDESINAV] ,[DERS] ,[SORUNO] ,[KAZANIM] ,[BECERI] ,[PUAN] ,ID_BILGI = ISNULL([ID_BILGI], 0) ,ID_BILISSELSUREC = ISNULL([ID_BILISSELSUREC], 0) FROM [Pusulam].[dbo].[AbideSoru] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS SORULIST,
					(SELECT * FROM [Pusulam].[dbo].[AbideYorum] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS YORUMLIST,
					(SELECT * FROM [Pusulam].[dbo].[AbidePuanAralik] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS PUANARALIKLIST,
					(SELECT * FROM [Pusulam].[dbo].[AbideBeceri] WHERE ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH) AS BECERILIST
					FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
				)
			END

			IF @ISLEM = 7	--	ÖĞRENCİ LİSTELE
			BEGIN
			

				SELECT
				(
					SELECT	O.OGRNO 
							,O.TCKIMLIKNO
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT S.DERS, SUM(CASE WHEN AO.PUAN IS NULL THEN 0 ELSE 1 END) AS CEVAPSAYISI 
								FROM AbideSoru S
								LEFT JOIN AbideOgrenci AO ON AO.ID_ABIDESORU = S.ID_ABIDESORU AND AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1
								WHERE S.ID_ABIDESINAV = @_ID_ABIDESINAV
								GROUP BY S.DERS
								FOR JSON PATH
							 ) AS CEVAP
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					WHERE O.ID_SINIF = @_ID_SINIF AND O.DONEM = @_DONEM
					ORDER BY K.AD + ' ' + K.SOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 8	--	ÖĞRENCİ PUAN LİSTELE
			BEGIN
				SELECT
				(
					SELECT S.ID_ABIDESORU, SK.SORUNO, S.KAZANIM, S.BECERI, S.PUAN AS MAXPUAN, AO.PUAN
					FROM AbideSoru S
					INNER JOIN AbideSoruKarsilik SK ON SK.ID_ABIDESORU = S.ID_ABIDESORU
					LEFT JOIN AbideOgrenci AO ON AO.ID_ABIDESORU = S.ID_ABIDESORU AND AO.TCKIMLIKNO = @O_TCKIMLIKNO AND AO.AKTIF = 1
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV AND S.DERS = @DERS AND (@ID_ABIDEKITAPCIK IS NULL OR SK.ID_ABIDEKITAPCIK = @ID_ABIDEKITAPCIK)
					ORDER BY SK.SORUNO
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 9	--	ÖĞRENCİ PUAN KAYDET
			BEGIN
				UPDATE AbideOgrenci SET AKTIF = 0 WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND ID_ABIDESORU IN (SELECT ID_ABIDESORU FROM OPENJSON(@SQLJSON) WITH (ID_ABIDESORU INT))

				INSERT INTO AbideOgrenci (ID_ABIDESORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO, ID_ABIDEKITAPCIK)
				SELECT ID_ABIDESORU, @O_TCKIMLIKNO, PUAN, @TCKIMLIKNO, @ID_ABIDEKITAPCIK FROM OPENJSON(@SQLJSON)
				WITH
				(
					ID_ABIDESORU INT,
					PUAN INT
				)
				WHERE PUAN IS NOT NULL
			END

			IF @ISLEM = 10	--	ÖĞRENCİ DERS PUAN SİL
			BEGIN
				UPDATE AO SET AO.AKTIF = 0 
				FROM AbideOgrenci AO 
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = AO.ID_ABIDESORU
				WHERE TCKIMLIKNO = @O_TCKIMLIKNO AND S.DERS = @DERS AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			END

			IF @ISLEM = 11	--	RAPOR SAYFA TUR LİSTELE
			BEGIN
				
				DROP TABLE IF EXISTS #BOLUMNO11
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO11
				FROM AB

				SELECT * FROM (
					SELECT(
						SELECT
						(
							SELECT ST.ID_ABIDESAYFATUR
								,ST.AD
								,SIRA		= ISNULL(RD.SIRA, '')
								,RESIMGOR	= ISNULL(RD.RESIMGOR,0)
								,RD.AKTIF
								,ST.RESIMMI
								,RESIMLER	= (	SELECT	 R.ID_ABIDERESIM
														,R.SIRA
														,R.AD
														,R.ID_ABIDESAYFATUR 
														,R.DERS
												FROM AbideResim R 
												WHERE	R.ID_ABIDESAYFATUR	= ST.ID_ABIDESAYFATUR 
													AND R.ID_ABIDESINAV		= @ID_ABIDESINAV 
												ORDER BY SIRA 
												FOR JSON PATH, INCLUDE_NULL_VALUES
											)
							FROM AbideSayfaTur			ST
							LEFT JOIN AbideRaporDuzen	RD	ON	RD.ID_ABIDESAYFATUR = ST.ID_ABIDESAYFATUR 
															AND RD.ID_ABIDESINAV	= @ID_ABIDESINAV 
															AND RD.AKTIF			= 1
							ORDER BY ISNULL(CASE WHEN RD.SIRA = 0 THEN 999 ELSE RD.SIRA END, ST.ID_ABIDESAYFATUR)
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS LIST
						,(
							SELECT BOLUMNO, DERS, ID_ABIDESINAV
							FROM #BOLUMNO11
							ORDER BY BOLUMNO
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS DERSLIST
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)AS LIST
				)AS J
								
				DROP TABLE IF EXISTS #BOLUMNO11

			END

			IF @ISLEM = 12	--	RAPOR SAYFA SIRA KAYDET
			BEGIN
				UPDATE AbideRaporDuzen SET AKTIF = 0 WHERE ID_ABIDESINAV = @ID_ABIDESINAV
				DELETE AbideResim WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

				INSERT INTO AbideRaporDuzen(ID_ABIDESAYFATUR, ID_ABIDESINAV, SIRA, RESIMGOR)
				SELECT ID_ABIDESAYFATUR, @ID_ABIDESINAV, SIRA, RESIMGOR FROM OPENJSON(@SQLJSON)
				WITH
				(
					ID_ABIDESAYFATUR INT,
					RESIMGOR INT,
					SIRA INT
				)

				INSERT INTO AbideResim(ID_ABIDESINAV, ID_ABIDESAYFATUR, AD ,SIRA, DERS)
				SELECT	@ID_ABIDESINAV
						,JSON_Value (S.value, '$.ID_ABIDESAYFATUR') AS ID_ABIDESAYFATUR 
						,JSON_Value (S.value, '$.AD') AS AD 
						,JSON_Value (S.value, '$.SIRA') AS SIRA 
						,JSON_Value (S.value, '$.DERS') AS DERS 
				FROM OPENJSON (@SQLJSON) AS D
				CROSS APPLY OPENJSON (D.value, '$.RESIMLER') AS S
			END

			IF @ISLEM = 13	--	RESİM SİL
			BEGIN
				SELECT
				(
					SELECT AD, ID_ABIDESAYFATUR, ID_ABIDESINAV FROM AbideResim WHERE ID_ABIDERESIM = @ID_ABIDERESIM FOR JSON PATH, WITHOUT_ARRAY_WRAPPER 
				)
				DELETE FROM AbideResim WHERE ID_ABIDERESIM = @ID_ABIDERESIM
			END

			IF @ISLEM = 14	--	RESİM EKLE
			BEGIN
				INSERT INTO AbideResim(ID_ABIDESINAV, ID_ABIDESAYFATUR, AD ,SIRA,DERS)
				SELECT @ID_ABIDESINAV, @ID_ABIDESAYFATUR, @AD, @SIRA, @DERS
			END

			IF @ISLEM = 15	--	ÖĞRENCİ LİSTELE (RAPOR)
			BEGIN
				
				--DECLARE @ID_ABIDESINAV15	INT = @ID_ABIDESINAV
				--DECLARE @ID_SINIF15			INT = @ID_SINIF

				SELECT
				(
					SELECT	O.OGRNO 
							,O.TCKIMLIKNO
							,K.AD + ' ' + K.SOYAD AS ADSOYAD
							,(	
								SELECT COUNT(1) 
								FROM AbideSoru S
								WHERE S.ID_ABIDESINAV = @_ID_ABIDESINAV 
								AND S.ID_ABIDESORU NOT IN (SELECT AO.ID_ABIDESORU FROM AbideOgrenci AO WHERE AO.TCKIMLIKNO = O.TCKIMLIKNO AND AO.AKTIF = 1)
							) AS GIRILMEYENCEVAPSAYISI
					FROM OkyanusDB.dbo.v3OgrenciTum O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
					WHERE O.ID_SINIF = @_ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				)
			END

			IF @ISLEM = 16	--	RAPOR
			BEGIN

				DROP TABLE IF EXISTS #BOLUMNO
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO
				FROM AB


				DECLARE @SORUSAYISI INT = (SELECT COUNT(1) FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)



				
				SELECT	 K.TCKIMLIKNO
						,O.ID_SINIF
						,AD		= K.AD + ' ' + K.SOYAD
						,SUBE	= SB.AD 
						,SINIF	= S.AD
						,KADEME3= UPPER(K3.AD)
						,ID_KADEME
						,YARIYIL= IIF ( EXISTS (SELECT 1 FROM AbideSinav A WHERE A.ID_ABIDESINAV = @ID_ABIDESINAV AND MONTH(A.KYE_TARIH) IN (9,10,11,12,1)) , '1. DÖNEM' , '2. DÖNEM')
				INTO #OGRENCI
				FROM OkyanusDB.dbo.v3Kullanici			K
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	O	ON	O.TCKIMLIKNO	= K.TCKIMLIKNO 
				INNER JOIN OkyanusDB.dbo.v3SinifTum		S	ON	S.ID_SINIF		= O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON	SB.ID_SUBE		= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SatisTuru	ST	ON	ST.ID_SATISTURU	= S.ID_SATISTURU
				INNER JOIN OkyanusDB.dbo.v3Kademe3		K3	ON	K3.ID_KADEME3	= ST.ID_KADEME3
				INNER JOIN OkyanusDB.dbo.v3Donem		D	ON	D.ID_DONEM		= O.ID_DONEM
															AND D.KOD			= O.DONEM
				WHERE	O.DONEM = @DONEM
					AND (@ID_SUBE		IS NULL OR @ID_SUBE			= 0  OR O.ID_SUBE	= @ID_SUBE		)
					AND (@ID_SINIF		IS NULL OR @ID_SINIF		= 0  OR O.ID_SINIF	= @ID_SINIF		)
					AND (@O_TCKIMLIKNO	IS NULL OR @O_TCKIMLIKNO	= '' OR K.TCKIMLIKNO= @O_TCKIMLIKNO	)

				SELECT * FROM #OGRENCI

				SELECT ST.ID_ABIDESAYFATUR
						,ST.AD
						,ST.RESIMMI
						,RD.SIRA
						,RD.RESIMGOR
				INTO #DUZEN
				FROM AbideRaporDuzen RD
				INNER JOIN AbideSayfaTur ST ON ST.ID_ABIDESAYFATUR = RD.ID_ABIDESAYFATUR
				WHERE RD.AKTIF = 1 AND RD.SIRA > 0 AND RD.ID_ABIDESINAV = @ID_ABIDESINAV
				
				SELECT * FROM #DUZEN ORDER BY SIRA

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 1)	--	Kapak Sayfa
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 1 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 2)	--	Önsöz
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 2 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 3)	--	Rapor Neyi İçerir
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 3 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 4)	--	Arka Kapak
				BEGIN
					SELECT * FROM AbideResim WHERE ID_ABIDESAYFATUR = 4 AND ID_ABIDESINAV = @ID_ABIDESINAV ORDER BY SIRA
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 5)	--	Beceri Adı ve Açıklama
				BEGIN

				
				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

					DECLARE @RESIMGOR INT = (SELECT TOP 1 ISNULL(RESIMGOR,0) FROM #DUZEN WHERE ID_ABIDESAYFATUR = 5)
									   
					SELECT T.*,B.BOLUMNO, @RESIMGOR AS RESIMGOR
					FROM AbideBeceri	T
					JOIN #BOLUMNO		B	ON	B.DERS	= T.DERS
					WHERE T.ID_ABIDESINAV = @ID_ABIDESINAV
					ORDER BY DERS, ID_ABIDEBECERI
										
					SELECT R.AD, R.DERS, B.BOLUMNO
					FROM AbideResim R 
					JOIN #BOLUMNO	B	ON	B.DERS	= R.DERS
					WHERE	R.ID_ABIDESINAV		= @ID_ABIDESINAV 
						AND R.ID_ABIDESAYFATUR	= 5
				END
				ELSE
				BEGIN
					SELECT 1
					
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 6)	--	Kazanım ve Alt Becerileri
				BEGIN
					SELECT *
					INTO #TEMP6
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 
	
					SELECT T.TCKIMLIKNO
							,CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END AS SORUNO
							,T.DERS
							,B.BOLUMNO
							,T.KAZANIM
							,T.BECERI
							,ISNULL((CASE	WHEN T.PUAN = AO.PUAN THEN ':)'
									WHEN AO.PUAN > 0 AND T.PUAN > AO.PUAN THEN ':|'
									WHEN AO.PUAN = 0 THEN ':(' 
								END), '') AS DURUM
					FROM #TEMP6				T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					LEFT JOIN AbideOgrenci	AO	ON	AO.TCKIMLIKNO = T.TCKIMLIKNO AND AO.ID_ABIDESORU = T.ID_ABIDESORU AND AO.AKTIF = 1
					ORDER BY TCKIMLIKNO, DERS, SORUNO

					DROP TABLE #TEMP6
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 7)	--	Soruların Çözülme Oranı
				BEGIN
					SELECT *
					INTO #TEMP7
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 	

					SELECT	 T.DERS
							,B.BOLUMNO
							,CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END AS SORUNO
							,T.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,AO.PUAN AS PUAN
							,T.PUAN AS MAXPUAN
							,T.ID_ABIDESORU
					INTO #OP
					FROM #TEMP7	T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = T.TCKIMLIKNO AND OO.DONEM = @DONEM
					LEFT JOIN AbideOgrenci AO ON AO.TCKIMLIKNO = T.TCKIMLIKNO AND AO.ID_ABIDESORU = T.ID_ABIDESORU AND AO.AKTIF = 1	

					SELECT   S.DERS
							,B.BOLUMNO
							,SK.SORUNO
							,O.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,O.PUAN
							,S.PUAN AS MAXPUAN
							,S.ID_ABIDESORU
					INTO #OPGENEL
					FROM AbideOgrenci O
					INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
					JOIN #BOLUMNO			B	ON	B.DERS	= S.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum OO ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = @DONEM
					INNER JOIN AbideSoruKarsilik SK ON SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = O.ID_ABIDESORU
					WHERE O.AKTIF = 1 AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			
					SELECT	OP.TCKIMLIKNO
							,DERS
							,BOLUMNO
							,SORUNO
							,ID_ABIDESORU
							,OP.ID_SINIF
							,CASE WHEN PUAN IS NULL THEN '-' ELSE CAST(CONVERT(decimal(5,0), CAST(PUAN AS FLOAT) / CAST(MAXPUAN AS FLOAT) * 100.0) AS varchar) END AS OGRENCI 
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.ID_SINIF = OP.ID_SINIF AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS SINIF
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.ID_SUBE = OP.ID_SUBE AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS OKUL
							,(SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL AS SUBOP WHERE SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU) AS GENEL
					FROM #OP AS OP
					INNER JOIN #OGRENCI O ON O.TCKIMLIKNO = OP.TCKIMLIKNO
					ORDER BY OP.TCKIMLIKNO, DERS, SORUNO

					DROP TABLE #OP
					DROP TABLE #OPGENEL
					DROP TABLE #TEMP7
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 8)	--	Öğrenci Performansı
				BEGIN
					SELECT *
					INTO #TEMP8
					FROM #OGRENCI O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

					SELECT	T.TCKIMLIKNO
							,T.DERS
							,B.BOLUMNO
							,T.ID_ABIDESINAV
							,SUM(O.PUAN) AS PUAN
							,DUZEY	=	CASE	WHEN SUM(O.PUAN) IS NULL				THEN NULL 
												WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), '1') AS VARCHAR)												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					INTO #DERSPUAN
					FROM #TEMP8 T
					JOIN #BOLUMNO			B	ON	B.DERS	= T.DERS
					LEFT JOIN AbideOgrenci O ON O.TCKIMLIKNO = T.TCKIMLIKNO AND O.ID_ABIDESORU = T.ID_ABIDESORU AND O.AKTIF = 1
					GROUP BY T.TCKIMLIKNO, T.DERS, T.ID_ABIDESINAV,B.BOLUMNO, B.DERS

					SELECT	 DP.TCKIMLIKNO
							,DP.DERS
							,DP.BOLUMNO
							,ISNULL(DP.DUZEY + '. Düzey', '-') AS DUZEY
							,ISNULL(Y.YORUM, '-') AS YORUM
							,ISNULL(Y.ONERI, '-') AS ONERI
					FROM #DERSPUAN DP
					LEFT JOIN AbideYorum Y ON Y.DERS = DP.DERS AND Y.DUZEY = DP.DUZEY AND Y.ID_ABIDESINAV = DP.ID_ABIDESINAV
					ORDER BY DP.TCKIMLIKNO, DP.DERS					
					
					
					SELECT B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI, SUM(T.PUAN) MAXPUAN, SUM(O.PUAN) OGRPUAN, CAST( SUM(O.PUAN) / CAST(SUM(T.PUAN) AS float) * 100.0  AS decimal(8,2)) ORT
					FROM #TEMP8			T
					JOIN #BOLUMNO		B	ON	B.DERS			= T.DERS
					JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
											AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
											AND O.AKTIF			= 1
					GROUP BY B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI

					DROP TABLE #DERSPUAN
					DROP TABLE #TEMP8
				END
				ELSE
				BEGIN
					SELECT *
					FROM #BOLUMNO
					
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 9)	--	Grafiksel Gösterim (Her bir ders ayrı)
				BEGIN


--*********************************************************************************
					SELECT	O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)
							--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
							
							,DUZEY	=	CASE	WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') AS VARCHAR) 												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					FROM AbideOgrenci O
					INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO			B	ON	B.DERS	= S.DERS
					INNER JOIN AbideSinav SN ON SN.ID_ABIDESINAV = S.ID_ABIDESINAV
					WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END
				ELSE
				BEGIN
					SELECT 1
				END

				IF EXISTS (SELECT * FROM #DUZEN WHERE ID_ABIDESAYFATUR = 10)	--	Grafiksel Gösterim (Tek grafikte tüm dersler)
				BEGIN
					SELECT	O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)
							
							,DUZEY	=	CASE WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1')
											 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') 
										END 
							--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS DUZEY
							,(SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV) AS MAXDUZEY
					FROM AbideOgrenci		O
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU	 = O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO		B	ON	B.DERS			 = S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV = S.ID_ABIDESINAV
					WHERE O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI) AND O.AKTIF = 1 AND SN.AKTIF = 1
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END
				ELSE
				BEGIN
					SELECT 1
				END

				SELECT   S.DERS
						,S.SORUNO
						,B.BOLUMNO
				FROM AbideSoru	S				
				JOIN #BOLUMNO	B	ON	B.DERS	= S.DERS
				WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

				DROP TABLE #DUZEN
				DROP TABLE #OGRENCI
				DROP TABLE #BOLUMNO

			END
						
			IF @ISLEM = 17	--	SINAV LİSTELE by OGRENCI
			BEGIN
				SELECT
				(
					SELECT DISTINCT S.ID_ABIDESINAV, S.AD, CONVERT(varchar, S.KYE_TARIH, 104) AS TARIH, K.AD + ' ' + K.SOYAD AS ADSOYAD,S.KYE_TARIH
					FROM AbideSinav		S 
					JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= S.KYE_TCKIMLIKNO
					JOIN AbideSoru		SO	ON	SO.ID_ABIDESINAV= S.ID_ABIDESINAV
					JOIN AbideOgrenci	O	ON	O.ID_ABIDESORU	= SO.ID_ABIDESORU
					WHERE	S.DONEM			= @DONEM 
						AND O.TCKIMLIKNO	= @O_TCKIMLIKNO
						AND S.AKTIF			= 1 
						AND S.OVGORSUN		= 1
					ORDER BY S.KYE_TARIH DESC
					FOR JSON PATH
				)
			END

			IF @ISLEM = 18	--	PUAN LİSTESİ GETİR (EXCEL)
			BEGIN
				SELECT DERS, MAX(SORUNO) AS SORUNO 
				FROM AbideSinav S
				INNER JOIN AbideSoru SS ON SS.ID_ABIDESINAV = S.ID_ABIDESINAV 
				WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV
				GROUP BY DERS ORDER BY DERS

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DERS

				SELECT 
						SB.AD AS SUBE
						,K3.AD AS GRUP
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,SN.AD AS SINIF
						,SN.ID_SINIF
						,AO.TCKIMLIKNO
						,SORU.DERS
						,SORU.SORUNO
						,AO.PUAN
				INTO #TEMP
				FROM AbideOgrenci AO
				INNER JOIN AbideSoru SORU ON SORU.ID_ABIDESORU = AO.ID_ABIDESORU
				INNER JOIN AbideSinav SINAV ON SINAV.ID_ABIDESINAV = SORU.ID_ABIDESINAV
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = AO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum O ON O.TCKIMLIKNO = AO.TCKIMLIKNO AND O.DONEM = SINAV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum SN ON SN.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = SN.ID_SATISTURU
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = ST.ID_KADEME3
				WHERE	SINAV.ID_ABIDESINAV = @ID_ABIDESINAV 
					AND SINAV.DONEM = @DONEM
					AND SINAV.AKTIF = 1 
					AND AO.AKTIF = 1
					AND (@ID_SUBE	IS NULL OR @ID_SUBE		= 0 OR O.ID_SUBE	= @ID_SUBE)
					AND (@ID_SINIF	IS NULL OR @ID_SINIF	= 0 OR O.ID_SINIF	= @ID_SINIF)

				DECLARE 
						@COLS AS NVARCHAR(MAX),
						@QUERY  AS NVARCHAR(MAX)

				SELECT DERS+'-'+CAST(SORUNO AS VARCHAR) AS DERS
				INTO #DERS
				FROM #TEMP
				GROUP BY DERS, SORUNO
				ORDER BY DERS, SORUNO

				SELECT @COLS = STUFF((SELECT ','+QUOTENAME(DERS2)+' VARCHAR(MAX) DEFAULT ''-''' 
									  FROM (
												SELECT
													T.DERS + '-' + CAST(T.SORUNO AS VARCHAR) AS DERS2
												FROM #TEMP T 
												GROUP BY T.DERS, T.SORUNO
											) AS S
										FOR XML PATH(''), TYPE
										).value('.', 'NVARCHAR(MAX)') 
									,1,1,'')

				SET @QUERY = '
					DROP TABLE IF EXISTS #T
					CREATE TABLE #T (SUBE VARCHAR(MAX), GRUP VARCHAR(MAX), ADSOYAD VARCHAR(MAX), SINIF VARCHAR(MAX), TCKIMLIKNO VARCHAR(MAX),' + @COLS + ')

					INSERT INTO #T (SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO)
					SELECT SUBE, GRUP, ADSOYAD, SINIF, TCKIMLIKNO FROM #TEMP

					WHILE EXISTS ( SELECT *  FROM #DERS)
					BEGIN

						DECLARE @DERSAD VARCHAR(100) = (SELECT TOP(1) DERS FROM #DERS ORDER BY DERS)	
						DECLARE @QUERY2 NVARCHAR(MAX)

						SET @QUERY2=	
						''
							UPDATE T
							SET T.[''+@DERSAD+''] = P.PUAN
							FROM #T T
							JOIN #TEMP P ON T.TCKIMLIKNO = P.TCKIMLIKNO AND P.DERS + ''''-'''' +  CAST(P.SORUNO AS VARCHAR) = ''''''+@DERSAD+''''''
						''
						EXEC sp_executesql @QUERY2; 

						DELETE FROM #DERS WHERE DERS = @DERSAD
					END
					SELECT DISTINCT * FROM #T
					DROP TABLE IF EXISTS #T
				'
				PRINT @QUERY
				EXEC sp_executesql @QUERY; 

				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #DERS
			END

			IF @ISLEM = 19	--	SINAV KARŞILIK YÜKLE
			BEGIN
				SELECT   ID_ABIDESINAV = JSON_Value (D.value, '$.ID_ABIDESINAV')
						,ID_ABIDESORU = JSON_Value (D.value, '$.ID_ABIDESORU')
						,ID_ABIDEKITAPCIK = JSON_Value (s.value, '$.ID_ABIDEKITAPCIK')
						,KITAPCIK = JSON_Value (s.value, '$.KITAPCIK')
						,SORUNO = JSON_Value (s.value, '$.SORUNO')
				INTO #TEMPKARSILIK
				FROM OPENJSON(@SQLJSON) d
				CROSS APPLY OPENJSON (d.value, '$.KARSILIKLIST') as s

				DELETE SK FROM AbideSoruKarsilik SK
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = SK.ID_ABIDESORU
				INNER JOIN AbideKitapcik K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK
				WHERE S.ID_ABIDESINAV = (SELECT TOP 1 ID_ABIDESINAV FROM #TEMPKARSILIK) AND K.AD <> 'A'

				--DELETE FROM AbideKitapcik WHERE ID_ABIDESINAV = (SELECT TOP 1 ID_ABIDESINAV FROM #TEMPKARSILIK) AND AD <> 'A'

				--DECLARE @INSERTEDKITAPCIK TABLE(ID_ABIDEKITAPCIK INT NOT NULL, KITAPCIK CHAR(1) NOT NULL);  

				--INSERT INTO AbideKitapcik (ID_ABIDESINAV, AD)
				--OUTPUT inserted.ID_ABIDEKITAPCIK, inserted.ad
				--INTO @INSERTEDKITAPCIK
				--SELECT DISTINCT ID_ABIDESINAV, KITAPCIK
				--FROM #TEMPKARSILIK

				INSERT INTO AbideSoruKarsilik(ID_ABIDESORU, ID_ABIDEKITAPCIK, SORUNO)
				SELECT T.ID_ABIDESORU, T.ID_ABIDEKITAPCIK, T.SORUNO
				FROM #TEMPKARSILIK T

				DROP TABLE #TEMPKARSILIK
			END

			IF @ISLEM = 20	--	SINAV KARŞILIK LİSTELE
			BEGIN
				SELECT
				(	
					SELECT  S.ID_ABIDESINAV, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.KAZANIM, S.BECERI, S.PUAN, 
							(
								SELECT K.ID_ABIDEKITAPCIK, SK.SORUNO, K.AD AS KITAPCIK FROM AbideSoruKarsilik SK
								INNER JOIN AbideKitapcik K ON K.ID_ABIDEKITAPCIK = SK.ID_ABIDEKITAPCIK AND K.ID_ABIDESINAV = S.ID_ABIDESINAV
								WHERE SK.ID_ABIDESORU = S.ID_ABIDESORU AND K.AD <> 'A'
								FOR JSON PATH
							) AS KARSILIKLIST
					FROM AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV FOR JSON PATH
				)
			END

			IF @ISLEM = 21	--	SINAV KİTAPÇIK LİSTELE
			BEGIN
				SELECT	DISTINCT K.ID_ABIDEKITAPCIK
						,K.AD
						,CASE WHEN EXISTS(	
							SELECT 1 
							FROM AbideOgrenci O 
							INNER JOIN AbideSoru S ON S.ID_ABIDESORU = O.ID_ABIDESORU
							WHERE O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND S.DERS = @DERS AND O.TCKIMLIKNO = @O_TCKIMLIKNO AND O.AKTIF = 1
						)
						THEN 1
						ELSE 0 
						END AS SECILI
				INTO #TEMPKITAPCIKSEC
				FROM AbideKitapcik K
				WHERE K.ID_ABIDESINAV = @ID_ABIDESINAV

				--IF NOT EXISTS (SELECT * FROM #TEMPKITAPCIKSEC WHERE SECILI = 1)
				--BEGIN
				--	UPDATE #TEMPKITAPCIKSEC SET SECILI = 1 WHERE AD = 'A'
				--END

				SELECT
				(
					SELECT * FROM #TEMPKITAPCIKSEC
					ORDER BY AD
					FOR JSON PATH
				)

				DROP TABLE #TEMPKITAPCIKSEC
			END

			IF @ISLEM = 22	--	PUANA GÖRE SIRALI GENEL SONUÇ LİSTELERİ
			BEGIN
				SELECT SNV.ID_ABIDESINAV, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, K.AD AS KITAPCIK, SK.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN AbideSoruKarsilik			SK	ON SK.ID_ABIDESORU = S.ID_ABIDESORU AND SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SNV.ID_ABIDESINAV = @ID_ABIDESINAV AND (@ID_KADEME3 = 0 OR SGS.ID_KADEME3 = @ID_KADEME3)

				SELECT * 
				FROM #OGRENCISORULIST
				ORDER BY KAMPUS, SINIF, TCKIMLIKNO, DERS, SORUNO

				SELECT 
					 TCKIMLIKNO
					,DERS
					,SUM(PUAN) AS TOPLAMPUAN
					,SUM(MAXPUAN) AS TOPLAMMAXPUAN
					,MAX(SORUNO) AS SORUSAYISI
					--,ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), 1) AS DUZEY					
					,DUZEY	=	CASE WHEN O.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') 
										THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), '1')  
									 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV),'1') 
								END 
				INTO #OGRENCILIST
				FROM #OGRENCISORULIST O
				GROUP BY TCKIMLIKNO, DERS, ID_ABIDESINAV


				SELECT   TCKIMLIKNO
						,DERS
						,TOPLAMPUAN
						,DUZEY 
						,SORUSAYISI
						,TOPLAMMAXPUAN
				FROM #OGRENCILIST ORDER BY DERS, TCKIMLIKNO DESC

				SELECT DERS, SORUSAYISI, TOPLAMMAXPUAN FROM #OGRENCILIST GROUP BY DERS, SORUSAYISI, TOPLAMMAXPUAN ORDER BY DERS

				DROP TABLE #OGRENCISORULIST
				DROP TABLE #OGRENCILIST
			END

			IF @ISLEM = 23	--	SINIFLARA GÖRE SORULARIN ÇÖZÜLME ORANLARI
			BEGIN
				SELECT SNV.ID_ABIDESINAV, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST2
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SNV.ID_ABIDESINAV = @ID_ABIDESINAV AND (@ID_KADEME3 = 0 OR SGS.ID_KADEME3 = @ID_KADEME3)

				SELECT OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, OS.KAMPUS, OS.SINIF, CONVERT(decimal(18,2), (CAST(SUM(OS.PUAN) AS FLOAT) / CAST(SUM(OS.MAXPUAN) AS FLOAT) * 100.0)) AS ORAN
				FROM #OGRENCISORULIST2 OS
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = OS.ID_ABIDESORU
				GROUP BY OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, OS.KAMPUS, OS.SINIF
				
				SELECT OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM, 'GENEL', 'GENEL', CONVERT(decimal(18,2), (CAST(SUM(OS.PUAN) AS FLOAT) / CAST(SUM(OS.MAXPUAN) AS FLOAT) * 100.0)) AS ORAN
				FROM #OGRENCISORULIST2 OS
				INNER JOIN AbideSoru S ON S.ID_ABIDESORU = OS.ID_ABIDESORU
				GROUP BY OS.DERS, OS.SORUNO, S.BECERI, S.KAZANIM
				ORDER BY DERS, SORUNO
				
				SELECT KAMPUS, SINIF FROM #OGRENCISORULIST2 GROUP BY KAMPUS, SINIF ORDER BY KAMPUS, SINIF
				SELECT DERS, MAX(SORUNO) AS SORUSAYISI FROM #OGRENCISORULIST2 GROUP BY DERS ORDER BY DERS

				DROP TABLE #OGRENCISORULIST2
			END

			IF @ISLEM = 24	--	Yeterlilik Düzeylerine Göre Kampüs Öğrenci Sayıları
			BEGIN
			
				DECLARE @ID_KADEME3_ INT = @ID_KADEME3
				DECLARE @ID_ABIDESINAV_ INT = @ID_ABIDESINAV
				DECLARE @DONEM_ VARCHAR(4) = @DONEM

				SELECT SNV.ID_ABIDESINAV, SNV.AD AS SINAVAD, SB.AD AS KAMPUS, SNF.AD AS SINIF, O.TCKIMLIKNO, KO.AD + ' ' + KO.SOYAD AS ADSOYAD, S.DERS, S.ID_ABIDESORU, S.SORUNO, S.PUAN AS MAXPUAN, O.PUAN
				INTO #OGRENCISORULIST3
				FROM AbideSinav							SNV 
				INNER JOIN AbideSoru					S	ON S.ID_ABIDESINAV = SNV.ID_ABIDESINAV
				INNER JOIN AbideKitapcik				K	ON K.ID_ABIDESINAV = SNV.ID_ABIDESINAV 
				INNER JOIN AbideOgrenci					O	ON O.ID_ABIDESORU = S.ID_ABIDESORU AND O.ID_ABIDEKITAPCIK = K.ID_ABIDEKITAPCIK AND O.AKTIF = 1
				INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON OO.TCKIMLIKNO = O.TCKIMLIKNO AND OO.DONEM = SNV.DONEM
				INNER JOIN OkyanusDB.dbo.v3Sube			SB	ON SB.ID_SUBE = OO.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3SinifTum		SNF ON SNF.ID_SINIF = OO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS ON SGS.ID_SINIF = SNF.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici	KO	ON KO.TCKIMLIKNO = OO.TCKIMLIKNO
				WHERE SGS.ID_KADEME3 = @ID_KADEME3 AND (@ID_ABIDESINAV = 0 OR SNV.ID_ABIDESINAV = @ID_ABIDESINAV) AND SNV.DONEM = @DONEM

				SELECT 
					 SINAVAD
					,DERS
					,KAMPUS
					,TCKIMLIKNO					
					,DUZEY	=	CASE WHEN O.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') 
										THEN ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV), '1')  
								  	 ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = O.ID_ABIDESINAV),'1') 
								END 
				INTO #OGRENCILIST3
				FROM #OGRENCISORULIST3 O
				GROUP BY KAMPUS, TCKIMLIKNO, DERS, ID_ABIDESINAV, SINAVAD
				ORDER BY SINAVAD, DERS, KAMPUS, TCKIMLIKNO

				--DÜZEY ÖĞRENCİ SAYILARI KAMPÜS--
				SELECT DERS, SINAVAD, KAMPUS, DUZEY, COUNT(1) AS DUZEYOGRENCISAYISI
				INTO #KAMPUSDUZEYOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, SINAVAD, KAMPUS, DUZEY
				ORDER BY DERS, SINAVAD, KAMPUS, DUZEY

				--TOPLAM ÖĞRENCİ SAYILARI KAMPÜS--
				SELECT DERS, KAMPUS, COUNT(1) AS TOPLAMOGRENCISAYISI
				INTO #KAMPUSTOPLAMOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, KAMPUS
				ORDER BY DERS, KAMPUS

				--DÜZEY ÖĞRENCİ SAYILARI--
				SELECT DERS, SINAVAD, DUZEY, COUNT(1) AS DUZEYOGRENCISAYISI
				INTO #DUZEYOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS, SINAVAD, DUZEY
				ORDER BY DERS, SINAVAD, DUZEY

				--TOPLAM ÖĞRENCİ SAYILARI--
				SELECT DERS, COUNT(1) AS TOPLAMOGRENCISAYISI
				INTO #TOPLAMOGRENCISAYILIST
				FROM #OGRENCILIST3
				GROUP BY DERS
				ORDER BY DERS

				--SONUÇ--
				SELECT 1 AS TUR, TOS.DERS, TOS.KAMPUS, TOS.TOPLAMOGRENCISAYISI, DOS.DUZEY, DOS.SINAVAD, DOS.DUZEYOGRENCISAYISI, CONVERT(DECIMAL(18,2), (CAST(DOS.DUZEYOGRENCISAYISI AS FLOAT) / CAST(TOS.TOPLAMOGRENCISAYISI AS FLOAT) * 100.0)) AS ORAN
				FROM #KAMPUSDUZEYOGRENCISAYILIST DOS
				INNER JOIN #KAMPUSTOPLAMOGRENCISAYILIST TOS ON TOS.KAMPUS = DOS.KAMPUS AND TOS.DERS = DOS.DERS
				UNION
				SELECT 2 AS TUR, TOS.DERS, 'TOPLAM', TOS.TOPLAMOGRENCISAYISI, DOS.DUZEY, DOS.SINAVAD, DOS.DUZEYOGRENCISAYISI, CONVERT(DECIMAL(18,2), (CAST(DOS.DUZEYOGRENCISAYISI AS FLOAT) / CAST(TOS.TOPLAMOGRENCISAYISI AS FLOAT) * 100.0)) AS ORAN
				FROM #DUZEYOGRENCISAYILIST DOS
				INNER JOIN #TOPLAMOGRENCISAYILIST TOS ON TOS.DERS = DOS.DERS
				ORDER BY DERS, TUR, KAMPUS, SINAVAD, DUZEY

				SELECT DUZEY FROM #DUZEYOGRENCISAYILIST GROUP BY DUZEY ORDER BY DUZEY
				SELECT KAMPUS FROM #KAMPUSDUZEYOGRENCISAYILIST GROUP BY KAMPUS ORDER BY KAMPUS
				SELECT SINAVAD FROM #DUZEYOGRENCISAYILIST GROUP BY SINAVAD ORDER BY SINAVAD
				SELECT DERS FROM #DUZEYOGRENCISAYILIST GROUP BY DERS ORDER BY DERS

				DROP TABLE #OGRENCISORULIST3
				DROP TABLE #OGRENCILIST3
				DROP TABLE #KAMPUSDUZEYOGRENCISAYILIST
				DROP TABLE #KAMPUSTOPLAMOGRENCISAYILIST
				DROP TABLE #DUZEYOGRENCISAYILIST
				DROP TABLE #TOPLAMOGRENCISAYILIST
			END
						
			IF @ISLEM = 25	--	OVGORSUN DEĞİŞTİR
			BEGIN
				UPDATE AbideSinav SET OVGORSUN = @OVGORSUN WHERE ID_ABIDESINAV = @ID_ABIDESINAV

				select 1
			END

			IF @ISLEM = 26	--	RAPOR ÖĞRENCİ HTML(JSON)
			BEGIN
				DROP TABLE IF EXISTS #BOLUMNO26
				DROP TABLE IF EXISTS #DUZEN26
				DROP TABLE IF EXISTS #OGRENCI26
				DROP TABLE IF EXISTS #TEMP5_1_26
				DROP TABLE IF EXISTS #TEMP5_2_26
				DROP TABLE IF EXISTS #TEMP6_26
				DROP TABLE IF EXISTS #TEMP7_26
				DROP TABLE IF EXISTS #TEMP8_1_26
				DROP TABLE IF EXISTS #TEMP8_2_26
				DROP TABLE IF EXISTS #TEMP9_26
				DROP TABLE IF EXISTS #TEMP10_26
				--DROP TABLE IF EXISTS #TEMP_SON_26
				
				;WITH AB AS (
					SELECT DERS, MIN(ID_ABIDESORU) RN
					FROM AbideSoru
					WHERE ID_ABIDESINAV = @ID_ABIDESINAV
					GROUP BY DERS
				)
				SELECT @ID_ABIDESINAV AS ID_ABIDESINAV, DERS, ROW_NUMBER() OVER(ORDER BY RN) AS BOLUMNO
				INTO #BOLUMNO26
				FROM AB
				ORDER BY BOLUMNO

				--DECLARE @SORUSAYISI INT = (SELECT COUNT(1) FROM AbideSoru WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
				
				SELECT DISTINCT
					 TCKIMLIKNO	= OD.TCKIMLIKNO
					,ID_SINIF	= OD.ID_SINIF
					,AD			= OD.AD + ' ' + OD.SOYAD
					,SUBE		= OD.SUBEAD
					,SINIF		= OD.SINIFAD
					,KADEME3	= UPPER(OD.KADEME3)
					,ID_KADEME	= KB.ID_KADEME
					,YARIYIL	= IIF ( EXISTS (SELECT TOP 1 1 FROM AbideSinav A WHERE A.ID_ABIDESINAV = @ID_ABIDESINAV AND MONTH(A.KYE_TARIH) IN (9,10,11,12,1)) , '1. DÖNEM' , '2. DÖNEM')
				INTO #OGRENCI26
				FROM OkyanusDB..vw_OgrenciDetayTum	OD
				JOIN OkyanusDB..v3KademeBilgi		KB	ON	KB.ID_KADEME3	= OD.ID_KADEME3
				WHERE	OD.DONEM = @_DONEM
					AND (@ID_SUBE		IS NULL OR @ID_SUBE			= 0  OR OD.ID_SUBE		= @ID_SUBE		)
					AND (@ID_SINIF		IS NULL OR @ID_SINIF		= 0  OR OD.ID_SINIF		= @ID_SINIF		)
					AND (@O_TCKIMLIKNO	IS NULL OR @O_TCKIMLIKNO	= '' OR OD.TCKIMLIKNO	= @O_TCKIMLIKNO	)
	
				SELECT	 ST.ID_ABIDESAYFATUR
						,ST.AD
						,ST.RESIMMI
						,RD.SIRA
						,RD.RESIMGOR
				INTO #DUZEN26
				FROM AbideRaporDuzen	RD
				JOIN AbideSayfaTur		ST	ON	ST.ID_ABIDESAYFATUR	= RD.ID_ABIDESAYFATUR
				WHERE	RD.AKTIF		= 1 
					AND RD.SIRA			> 0 
					AND RD.ID_ABIDESINAV= @ID_ABIDESINAV
					AND ST.ID_ABIDESAYFATUR NOT IN (1,2,3,4)

				
				-- CREATE TEMP TABLE
				BEGIN
				CREATE TABLE #TEMP5_1_26 
				(	
					 ID_ABIDEBECERI	INT
					,ID_ABIDESINAV	INT
					,DERS			VARCHAR(MAX)
					,BECERI			VARCHAR(MAX)
					,ACIKLAMA		VARCHAR(MAX)
					,BOLUMNO		INT
					,RESIMGOR		INT
				)

				CREATE TABLE #TEMP5_2_26 (
					AD	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT
				)
				END
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 5)	--	Beceri Adı ve Açıklama							
				BEGIN

				
				/*		RESIMGOR (Beceri Adı ve Açıklama)
					0 => Resim + Aciklama
					1 => Sadece Aciklama 
					2 => Sadece Resim
				*/

					DECLARE @RESIMGOR_26 INT = (SELECT TOP 1 ISNULL(RESIMGOR,0) FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 5)
									   
					INSERT INTO #TEMP5_1_26
					SELECT	 T.ID_ABIDEBECERI
							,T.ID_ABIDESINAV
							,T.DERS
							,T.BECERI
							,T.ACIKLAMA
							,B.BOLUMNO
							,RESIMGOR	= @RESIMGOR_26
					FROM AbideBeceri	T
					JOIN #BOLUMNO26		B	ON	B.DERS	= T.DERS
					WHERE T.ID_ABIDESINAV = @ID_ABIDESINAV
					ORDER BY DERS, ID_ABIDEBECERI
										
					INSERT INTO #TEMP5_2_26
					SELECT R.AD, R.DERS, B.BOLUMNO
					FROM AbideResim R 
					JOIN #BOLUMNO26	B	ON	B.DERS	= R.DERS
					WHERE	R.ID_ABIDESINAV		= @ID_ABIDESINAV 
						AND R.ID_ABIDESAYFATUR	= 5
				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP6_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SORUNO		INT,
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					KAZANIM		VARCHAR(MAX),
					BECERI		VARCHAR(MAX),
					DURUM		VARCHAR(2),
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 6)	--	Kazanım ve Alt Becerileri						
				BEGIN

	
					;WITH TEMP6 AS(
						SELECT O.TCKIMLIKNO, S.SORUNO, S.DERS, S.KAZANIM, S.BECERI, S.PUAN, S.ID_ABIDESORU		
						FROM #OGRENCI26		 O
						CROSS JOIN AbideSoru S 
						WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 
					)
					INSERT INTO #TEMP6_26
					SELECT   T.TCKIMLIKNO
							,SORUNO	= CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END 
							,T.DERS
							,B.BOLUMNO
							,T.KAZANIM
							,T.BECERI
							,DURUM	= ISNULL((CASE	WHEN T.PUAN = AO.PUAN THEN ':)'
													WHEN AO.PUAN > 0 AND T.PUAN > AO.PUAN THEN ':|'
													WHEN AO.PUAN = 0 THEN ':(' 
												END), '')
					FROM TEMP6				T
					JOIN #BOLUMNO26			B	ON	B.DERS			= T.DERS
					LEFT JOIN AbideOgrenci	AO	ON	AO.TCKIMLIKNO	= T.TCKIMLIKNO 
												AND AO.ID_ABIDESORU = T.ID_ABIDESORU 
												AND AO.AKTIF		= 1
					ORDER BY TCKIMLIKNO, DERS, SORUNO

				END


				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP7_26 (
					TCKIMLIKNO		VARCHAR(MAX),
					DERS			VARCHAR(MAX),
					BOLUMNO			INT,
					SORUNO			INT,
					ID_ABIDESORU	INT,
					ID_SINIF		INT,
					OGRENCI			VARCHAR(MAX),
					SINIF			decimal(5,0),
					OKUL			decimal(5,0),
					GENEL			decimal(5,0)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 7)	--	Soruların Çözülme Oranı							
				BEGIN
	
					WITH TEMP7 AS (
						SELECT O.TCKIMLIKNO, S.DERS, S.SORUNO, S.PUAN, S.ID_ABIDESORU	
						FROM #OGRENCI26 O
						CROSS JOIN AbideSoru S 
						WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV 	
					)
					SELECT	 T.DERS
							,B.BOLUMNO
							,SORUNO	= CASE WHEN AO.ID_ABIDEOGRENCI IS NULL THEN T.SORUNO ELSE (SELECT SK.SORUNO FROM AbideSoruKarsilik SK WHERE SK.ID_ABIDEKITAPCIK = AO.ID_ABIDEKITAPCIK AND SK.ID_ABIDESORU = AO.ID_ABIDESORU) END
							,T.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,AO.PUAN
							,MAXPUAN	= T.PUAN 
							,T.ID_ABIDESORU
					INTO #OP26
					FROM TEMP7	T
					JOIN #BOLUMNO26							B	ON	B.DERS			= T.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON	OO.TCKIMLIKNO	= T.TCKIMLIKNO 
																AND OO.DONEM		= @_DONEM
					LEFT JOIN AbideOgrenci					AO	ON	AO.TCKIMLIKNO	= T.TCKIMLIKNO 
																AND AO.ID_ABIDESORU = T.ID_ABIDESORU 
																AND AO.AKTIF		= 1	

					SELECT   S.DERS
							,B.BOLUMNO
							,SK.SORUNO
							,O.TCKIMLIKNO
							,OO.ID_SINIF
							,OO.ID_SUBE
							,O.PUAN
							,MAXPUAN	= S.PUAN 
							,S.ID_ABIDESORU
					INTO #OPGENEL26
					FROM AbideOgrenci						O
					INNER JOIN AbideSoru					S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					JOIN #BOLUMNO26							B	ON	B.DERS				= S.DERS
					INNER JOIN OkyanusDB.dbo.v3OgrenciTum	OO	ON	OO.TCKIMLIKNO		= O.TCKIMLIKNO 
																AND OO.DONEM			= @_DONEM
					INNER JOIN AbideSoruKarsilik			SK	ON	SK.ID_ABIDEKITAPCIK = O.ID_ABIDEKITAPCIK 
																AND SK.ID_ABIDESORU		= O.ID_ABIDESORU
					WHERE	O.AKTIF			= 1 
						AND S.ID_ABIDESINAV = @ID_ABIDESINAV
			
					INSERT INTO #TEMP7_26
					SELECT	OP.TCKIMLIKNO
							,DERS
							,BOLUMNO
							,SORUNO
							,ID_ABIDESORU
							,OP.ID_SINIF
							,OGRENCI= CASE WHEN PUAN IS NULL THEN '-' ELSE CAST(CONVERT(decimal(5,0), CAST(PUAN AS FLOAT) / CAST(MAXPUAN AS FLOAT) * 100.0) AS varchar) END 
							,SINIF	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.ID_SINIF = OP.ID_SINIF AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
							,OKUL	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.ID_SUBE = OP.ID_SUBE AND SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
							,GENEL	= (SELECT CONVERT(decimal(5,0), CAST(SUM(PUAN) AS FLOAT) / CAST(SUM(MAXPUAN) AS FLOAT) * 100.0) FROM #OPGENEL26 AS SUBOP WHERE SUBOP.DERS = OP.DERS AND SUBOP.ID_ABIDESORU = OP.ID_ABIDESORU GROUP BY SUBOP.DERS, SUBOP.ID_ABIDESORU)
					FROM #OP26			OP
					INNER JOIN #OGRENCI26 O	ON	O.TCKIMLIKNO	= OP.TCKIMLIKNO
					ORDER BY OP.TCKIMLIKNO, DERS, SORUNO

					DROP TABLE IF EXISTS #OP26
					DROP TABLE IF EXISTS #OPGENEL26
				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP8_1_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX),
					YORUM		VARCHAR(MAX),
					ONERI		VARCHAR(MAX)
				)
				CREATE TABLE #TEMP8_2_26 (
					BOLUMNO		INT,
					TCKIMLIKNO	VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BECERI		VARCHAR(MAX),
					MAXPUAN		INT,
					OGRPUAN		INT,
					ORT			decimal(8,2)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 8)	--	Öğrenci Performansı								
				BEGIN
					SELECT O.TCKIMLIKNO, S.DERS, S.ID_ABIDESINAV, S.ID_ABIDESORU, S.BECERI, S.PUAN
					INTO #TEMP8_26
					FROM #OGRENCI26 O
					CROSS JOIN AbideSoru S 
					WHERE S.ID_ABIDESINAV = @ID_ABIDESINAV

					SELECT	T.TCKIMLIKNO
							,T.DERS
							,B.BOLUMNO
							,T.ID_ABIDESINAV
							,SUM(O.PUAN) AS PUAN
							,DUZEY	=	CASE	WHEN SUM(O.PUAN) IS NULL				THEN NULL 
												WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), '1') AS VARCHAR)												
												ELSE CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = T.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 
					INTO #DERSPUAN26
					FROM #TEMP8_26			T
					JOIN #BOLUMNO26			B	ON	B.DERS			= T.DERS
					LEFT JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
												AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
												AND O.AKTIF			= 1
					GROUP BY T.TCKIMLIKNO, T.DERS, T.ID_ABIDESINAV,B.BOLUMNO, B.DERS

					INSERT INTO #TEMP8_1_26
					SELECT	 DP.TCKIMLIKNO
							,DP.DERS
							,DP.BOLUMNO
							,DUZEY	= ISNULL(DP.DUZEY + '. Düzey', '-')
							,YORUM	= REPLACE( ISNULL(Y.YORUM, '-'),N'*','<br>*') 
							,ONERI	= REPLACE( ISNULL(Y.ONERI, '-'),N'*','<br>*')
					FROM #DERSPUAN26 DP
					LEFT JOIN AbideYorum Y ON Y.DERS = DP.DERS AND Y.DUZEY = DP.DUZEY AND Y.ID_ABIDESINAV = DP.ID_ABIDESINAV
					ORDER BY DP.TCKIMLIKNO, DP.DERS					
					
					
					INSERT INTO #TEMP8_2_26
					SELECT	 B.BOLUMNO
							,T.TCKIMLIKNO
							, T.DERS
							, T.BECERI
							, SUM(T.PUAN) MAXPUAN
							, SUM(O.PUAN) OGRPUAN
							, CAST( SUM(O.PUAN) / CAST(SUM(T.PUAN) AS float) * 100.0  AS decimal(8,2)) ORT
					FROM #TEMP8_26		T
					JOIN #BOLUMNO26		B	ON	B.DERS			= T.DERS
					JOIN AbideOgrenci	O	ON	O.TCKIMLIKNO	= T.TCKIMLIKNO 
											AND O.ID_ABIDESORU	= T.ID_ABIDESORU 
											AND O.AKTIF			= 1
					GROUP BY B.BOLUMNO, T.TCKIMLIKNO, T.DERS, T.BECERI

					DROP TABLE IF EXISTS #DERSPUAN26
					DROP TABLE IF EXISTS #TEMP8_26
				END		

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP9_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SINAV		VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 9)	--	Grafiksel Gösterim (Her bir ders ayrı)			
				BEGIN

					INSERT INTO #TEMP9_26
					SELECT	 O.TCKIMLIKNO
							,SN.AD AS SINAV
							,S.DERS
							,BOLUMNO = ISNULL(B.BOLUMNO, 999)							
							,DUZEY	=	CASE	WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN 
													CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') AS VARCHAR) 												
												ELSE 
													CAST(ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), 1) AS VARCHAR) 
										END 	
					FROM AbideOgrenci		O
					INNER JOIN #OGRENCI26		SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO26		B	ON	B.DERS				= S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV	= S.ID_ABIDESINAV
					WHERE	O.AKTIF = 1 
						AND SN.AKTIF = 1
						--AND EXISTS (SELECT TOP 1 1 FROM #OGRENCI26 SO WHERE SO.TCKIMLIKNO = O.TCKIMLIKNO) 
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC

				END

				-- CREATE TEMP TABLE
				CREATE TABLE #TEMP10_26 (
					TCKIMLIKNO	VARCHAR(MAX),
					SINAV		VARCHAR(MAX),
					DERS		VARCHAR(MAX),
					BOLUMNO		INT,
					DUZEY		VARCHAR(MAX),
					MAXDUZEY	VARCHAR(MAX)
				)
				IF EXISTS (SELECT TOP 1 1 FROM #DUZEN26 WHERE ID_ABIDESAYFATUR = 10)--	Grafiksel Gösterim (Tek grafikte tüm dersler)	
				BEGIN
					INSERT INTO #TEMP10_26
					SELECT	 O.TCKIMLIKNO
							,SINAV		= SN.AD
							,S.DERS
							,BOLUMNO	= ISNULL(B.BOLUMNO, 999)
							
							,DUZEY		=	CASE WHEN B.DERS IN ('Türkçe', 'Türk Dili ve Edebiyatı', 'Fen Bilimleri') THEN 
													 ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE DUZEY != '1' AND SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1')
												ELSE ISNULL((SELECT MIN(DUZEY) FROM AbidePuanAralik PA WHERE SUM(O.PUAN) <= PA.MAXIMUMPUAN AND PA.ID_ABIDESINAV = S.ID_ABIDESINAV), '1') 
											END 
							,MAXDUZEY	= (SELECT MAX(DUZEY) FROM AbidePuanAralik PA WHERE PA.ID_ABIDESINAV = S.ID_ABIDESINAV)
					FROM AbideOgrenci		O
					INNER JOIN #OGRENCI26		SO	ON	SO.TCKIMLIKNO		= O.TCKIMLIKNO
					INNER JOIN AbideSoru	S	ON	S.ID_ABIDESORU		= O.ID_ABIDESORU
					LEFT  JOIN #BOLUMNO26		B	ON	B.DERS				= S.DERS
					INNER JOIN AbideSinav	SN	ON	SN.ID_ABIDESINAV	= S.ID_ABIDESINAV
					WHERE	O.AKTIF		= 1 
						AND SN.AKTIF	= 1
						--O.TCKIMLIKNO IN (SELECT TCKIMLIKNO FROM #OGRENCI26) AND 
					GROUP BY O.TCKIMLIKNO, SN.AD, S.DERS, S.ID_ABIDESINAV,B.BOLUMNO, B.DERS
					ORDER BY O.TCKIMLIKNO, S.DERS, SN.AD DESC
				END

				--SELECT   S.DERS
				--		,S.SORUNO
				--		,B.BOLUMNO
				--INTO #TEMP_SON_26
				--FROM AbideSoru	S				
				--JOIN #BOLUMNO26	B	ON	B.DERS	= S.DERS
				--WHERE S.ID_ABIDESINAV	= @ID_ABIDESINAV

				SELECT (
					SELECT (	SELECT *, SINAVAD = (SELECT AD FROM AbideSinav WHERE ID_ABIDESINAV = @ID_ABIDESINAV)
								FROM #OGRENCI26
								FOR JSON PATH
							) OGRENCI,
							(	SELECT * FROM #DUZEN26 --ORDER BY SIRA
								FOR JSON PATH
							) DUZEN,
							(SELECT	 DERS
									,BOLUMNO
									,BECERI				= JSON_QUERY(IIF (NOT EXISTS(SELECT TOP 1 1 FROM #TEMP5_1_26),
																NULL,
																(SELECT 
																	(	SELECT *
																		FROM #TEMP5_1_26	T
																		WHERE T.BOLUMNO = B.BOLUMNO
																		FOR JSON PATH
																	  ) AS BECERI,
																	  (	SELECT *
																		FROM #TEMP5_2_26	T
																		WHERE T.BOLUMNO = B.BOLUMNO
																		FOR JSON PATH
																	  ) AS RESIM
																	FOR JSON PATH
																)
															))
									,KAZANIMALTBECERI	= (	SELECT *
															FROM #TEMP6_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,SORUCOZULMEORANI	= (	SELECT *
															FROM #TEMP7_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,OGRENCIPERFORMANS	= JSON_QUERY(IIF (NOT EXISTS(SELECT TOP 1 1 FROM #TEMP8_1_26),NULL,
														(SELECT 
															(	SELECT *
																FROM #TEMP8_1_26	T
																WHERE T.BOLUMNO = B.BOLUMNO
																FOR JSON PATH
															  ) AS ONERI,
															  (	SELECT *
																FROM #TEMP8_2_26	T
																WHERE T.BOLUMNO = B.BOLUMNO
																FOR JSON PATH
															  ) AS PUAN
															FOR JSON PATH
															)))
									,GRAFIK				= (	SELECT *
															FROM #TEMP9_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									,TEKGRAFIK			= (	SELECT *
															FROM #TEMP10_26	T
															WHERE T.BOLUMNO = B.BOLUMNO
															FOR JSON PATH
														  )
									--,SORULIST			= (	SELECT *
									--						FROM #TEMP_SON_26	T
									--						WHERE T.BOLUMNO = B.BOLUMNO
									--						FOR JSON PATH
									--					  )
								FROM #BOLUMNO26	B
								FOR JSON PATH
								) DERS
					FOR JSON PATH
				)

				DROP TABLE IF EXISTS #BOLUMNO26
				DROP TABLE IF EXISTS #DUZEN26
				DROP TABLE IF EXISTS #OGRENCI26
				DROP TABLE IF EXISTS #TEMP5_1_26
				DROP TABLE IF EXISTS #TEMP5_2_26
				DROP TABLE IF EXISTS #TEMP6_26
				DROP TABLE IF EXISTS #TEMP7_26
				DROP TABLE IF EXISTS #TEMP8_1_26
				DROP TABLE IF EXISTS #TEMP8_2_26
				DROP TABLE IF EXISTS #TEMP9_26
				DROP TABLE IF EXISTS #TEMP10_26
				--DROP TABLE IF EXISTS #TEMP_SON_26

			END
		END
	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_AnaSayfa]...';


GO
ALTER procedure [dbo].[sp_AnaSayfa]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL

AS
BEGIN	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU
				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME		

		IF @_ID_LOG > 0
		BEGIN			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN

				SELECT ID_DUYURU
				INTO #DUYURULIST14
				FROM eokul_v2.dbo.Tbl_Duyuru TD
				WHERE	TD.BAS_TARIH <= CAST(GETDATE() AS DATE)
					AND TD.BIT_TARIH >= CAST(GETDATE() AS DATE)
					AND AKTIF = 1

		
				SELECT DISTINCT TCKIMLIKNO, ID_KADEME, ID_KADEME3, ID_SUBE
				INTO #TEMP14
				FROM OkyanusDB.dbo.v3KullaniciSubeKademe3 
				WHERE TCKIMLIKNO	= @TCKIMLIKNO

				SELECT ISNULL((
					SELECT DISTINCT --TOP 5	
						 TD.ID_DUYURU
						,TD.BASLIK
						,TD.ICERIK
						,TD.BANNER
						,TARIH			= CONVERT(VARCHAR, TD.BIT_TARIH, 104)
						,YAYINTARIHI	= CONVERT(VARCHAR, TD.BAS_TARIH, 104) +' - ' + CONVERT(VARCHAR, TD.BIT_TARIH, 104)
						,FOTOGRAF		= ISNULL(TD.FOTOGRAF,'') 
						,FOTOGRAF_MOBIL	= ISNULL(TD.FOTOGRAF_MOBIL,'') 
						,DOSYALIST	= ISNULL((	SELECT DISTINCT DOSYAYOL AS DOSYA
												FROM eokul_v2.dbo.Tbl_DuyuruDosya DD
												WHERE DD.ID_DUYURU = TD.ID_DUYURU
												FOR JSON PATH, INCLUDE_NULL_VALUES
											),'[]')
					FROM eokul_v2.dbo.Tbl_Duyuru	TD
					JOIN (	SELECT D.ID_DUYURU
							FROM #DUYURULIST14					D
							JOIN eokul_v2.dbo.Tbl_DuyuruYetki	DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN OkyanusDB.dbo.v3SubeYetki		SY	ON	SY.ID_KULLANICITIPI	= DY.ID_KULLANICITIPI
																	AND SY.ID_SUBE			= DY.ID_SUBE
							WHERE	DY.ID_KULLANICITIPI	NOT IN (4,5)
								AND SY.TCKIMLIKNO	= @TCKIMLIKNO
						UNION
							SELECT D.ID_DUYURU
							FROM #DUYURULIST14							D
							JOIN eokul_v2.dbo.Tbl_DuyuruYetki			DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN OkyanusDB.dbo.v3KullaniciSinif			KS	ON	KS.ID_SINIF			= DY.ID_SINIF
							JOIN OkyanusDB.DBO.v3OgrenciVeli			OV	ON	OV.TCKIMLIKNO		= KS.TCKIMLIKNO
																			OR	OV.TCKIMLIKNO_OGR	= KS.TCKIMLIKNO
							WHERE	DY.ID_KULLANICITIPI	IN (4,5)
								AND KS.TCKIMLIKNO	= @TCKIMLIKNO
						UNION
							SELECT D.ID_DUYURU
							FROM #DUYURULIST14					D
							JOIN eokul_v2.dbo.Tbl_DuyuruYetki	DY	ON	DY.ID_DUYURU		= D.ID_DUYURU
							JOIN #TEMP14						KS	ON	KS.ID_SUBE			= DY.ID_SUBE
																	AND (	(KS.ID_KADEME3 IS NULL AND  KS.ID_KADEME	= DY.ID_KADEME)
																		OR	KS.ID_KADEME3	= DY.ID_KADEME3)
							JOIN OkyanusDB.dbo.v3OgrenciVeli	OV	ON	OV.TCKIMLIKNO		= KS.TCKIMLIKNO
																	OR	OV.TCKIMLIKNO_OGR	= KS.TCKIMLIKNO
							WHERE	DY.ID_KULLANICITIPI	IN (4,5)
								AND KS.TCKIMLIKNO	= @TCKIMLIKNO
					) SD ON SD.ID_DUYURU = TD.ID_DUYURU
					FOR JSON PATH,INCLUDE_NULL_VALUES
				),'[]')

				DROP TABLE #TEMP14
				DROP TABLE #DUYURULIST14

			END

			IF @ISLEM = 2	--	FATURA LİSETESİ
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT
						M.ID_MESAJ,
						ISNULL(K.AD, '') + ' ' + ISNULL(K.SOYAD,'') AS GONDEREN,
						RTRIM(ISNULL(M.KONU, '')) AS KONU,
						RTRIM(ISNULL(M.ICERIK, '')) AS ICERIK,
						TARIH = CONVERT(VARCHAR(MAX), M.TARIH, 104) + ' ' + CONVERT(VARCHAR(MAX), M.TARIH, 108)
					FROM [eokul_v2].[dbo].[MesajV2] M
					INNER JOIN [eokul_v2].[dbo].[MesajDetayV2] MD ON MD.ID_MESAJ = M.ID_MESAJ
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH (NOLOCK) ON K.TCKIMLIKNO = MD.TC_GONDEREN 
					WHERE MD.TC_ALAN = @TCKIMLIKNO AND MD.SIL = 0 AND MD.TC_GONDEREN = '99999999999' AND NOT EXISTS (SELECT 1 FROM OkyanusDB.dbo.v3Ogrenci O WHERE O.TCKIMLIKNO = MD.TC_ALAN )
					ORDER BY M.ID_MESAJ DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				), '[]') AS FATURALIST
			END
		END
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Assessment]...';


GO
ALTER procedure [dbo].[sp_Assessment]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@DONEM					VARCHAR(MAX)	= NULL,
	@ID_KADEME3				INT				= NULL,
	@PASIFGORUNSUN			BIT				= NULL,
	@AKTIF					BIT				= NULL,
	@ID_ASSESSMENTOGRENCI	INT				= NULL,
	@ID_ASSESSMENT			INT				= NULL,
	@SINAV					VARCHAR(MAX)	= NULL,
	@SORULIST				VARCHAR(MAX)	= NULL,
	@EXCEL					NVARCHAR(MAX)	= NULL

AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,TC_OGRENCI				= @TC_OGRENCI				
				,DONEM					= @DONEM						
				,AKTIF					= @AKTIF				
				,ID_KADEME3				= @ID_KADEME3				
				,ID_ASSESSMENTOGRENCI	= @ID_ASSESSMENTOGRENCI	
				,ID_ASSESSMENT			= @ID_ASSESSMENT		
				,PASIFGORUNSUN			= @PASIFGORUNSUN		
				,SINAV					= @SINAV					
				,SORULIST				= @SORULIST				
				,EXCEL					= @EXCEL					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	KATEGORI LİSTESİ			
			BEGIN
				SELECT (
					SELECT * 
					FROM AssessmentKategori
					FOR JSON AUTO				
				)
			END

			IF @ISLEM = 2	--	SINAV EKLE					
			BEGIN
			
				IF @ID_ASSESSMENT = 0 OR @ID_ASSESSMENT IS NULL
				BEGIN
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #SORULIST
				
					CREATE TABLE #TEMP ( ID_SINAV			INT
										,ID_KADEME3			INT
										,DONEM				VARCHAR(4)
										,AD			VARCHAR(MAX)
										,SUTUN_TCKIMLIKNO	VARCHAR(2)
										,SUTUN_ADSOYAD		VARCHAR(2)
										,SUTUN_SESKAYDI		VARCHAR(2)
										,SUTUN_FOTOGRAF		VARCHAR(2)
										,SUTUN_OZELNOT		VARCHAR(2)
										,SORULIST			NVARCHAR(MAX))

					INSERT INTO #TEMP (  ID_SINAV			
										,ID_KADEME3			
										,DONEM				
										,AD			
										,SUTUN_TCKIMLIKNO	
										,SUTUN_ADSOYAD
										,SUTUN_SESKAYDI		
										,SUTUN_FOTOGRAF		
										,SUTUN_OZELNOT		
										,SORULIST)
					SELECT * 
					FROM OPENJSON (@SINAV)
					WITH (	 ID_SINAV			INT
							,ID_KADEME3			INT
							,DONEM				VARCHAR(4)
							,AD			VARCHAR(MAX)
							,SUTUN_TCKIMLIKNO	VARCHAR(2)
							,SUTUN_ADSOYAD		VARCHAR(2)
							,SUTUN_SESKAYDI		VARCHAR(2)
							,SUTUN_FOTOGRAF		VARCHAR(2)
							,SUTUN_OZELNOT		VARCHAR(2)
							,SORULIST			NVARCHAR(MAX))

					DECLARE @ID TABLE (ID INT)
					INSERT INTO Assessment ( DONEM				
											,ID_KADEME3
											,AD			
											,SUTUN_TCKIMLIKNO	
											,SUTUN_ADSOYAD	
											,SUTUN_SESKAYDI		
											,SUTUN_FOTOGRAF		
											,SUTUN_OZELNOT		
											,KYE_TCKIMLIKNO
											)
					OUTPUT inserted.ID_ASSESSMENT INTO @ID(ID)
					SELECT TOP 1 DONEM				
								,ID_KADEME3
								,AD			
								,SUTUN_TCKIMLIKNO	
								,SUTUN_ADSOYAD		
								,SUTUN_SESKAYDI		
								,SUTUN_FOTOGRAF		
								,SUTUN_OZELNOT		
								,@TCKIMLIKNO
					FROM #TEMP
					SET @ID_ASSESSMENT = (SELECT TOP 1 ID FROM @ID)



					CREATE TABLE #SORULIST ( SORUNO					INT
											,SUTUN					VARCHAR(2)
											,ID_ASSESSMENT			INT
											,ID_ASSESSMENTKATEGORI	INT
											,CEVAP					VARCHAR(MAX)
											,SORU					VARCHAR(MAX)
											)
					SET @SORULIST = ( SELECT TOP 1 SORULIST FROM #TEMP )
					INSERT INTO #SORULIST (SORUNO, SUTUN, ID_ASSESSMENTKATEGORI, CEVAP, SORU, ID_ASSESSMENT)
					SELECT 
						 SORUNO					
						,SUTUN					
						,ID_ASSESSMENTKATEGORI	
						,CEVAP
						,SORU
						,@ID_ASSESSMENT
					FROM OPENJSON( @SORULIST )
					WITH (	 SORUNO		INT
							,SUTUN		VARCHAR(2)
							,ID_ASSESSMENTKATEGORI	INT
							,CEVAP		VARCHAR(MAX)
							,SORU		VARCHAR(MAX)
					)

					--SELECT * FROM AssessmentSoru

					INSERT INTO AssessmentSoru (ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,KYE_TCKIMLIKNO)
					SELECT ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,@TCKIMLIKNO FROM #SORULIST

				
					DROP TABLE IF EXISTS #TEMP
					DROP TABLE IF EXISTS #SORULIST

					SELECT @ID_ASSESSMENT
				END
				ELSE IF  EXISTS ( SELECT TOP 1 1 FROM Assessment WHERE ID_ASSESSMENT = @ID_ASSESSMENT)
				BEGIN
					
					DROP TABLE IF EXISTS #TEMP2
					DROP TABLE IF EXISTS #SORULIST2
				
					CREATE TABLE #TEMP2 (ID_ASSESSMENT		INT
										,ID_KADEME3			INT
										,DONEM				VARCHAR(4)
										,AD			VARCHAR(MAX)
										,SUTUN_TCKIMLIKNO	VARCHAR(2)
										,SUTUN_ADSOYAD		VARCHAR(2)
										,SUTUN_SESKAYDI		VARCHAR(2)
										,SUTUN_FOTOGRAF		VARCHAR(2)
										,SUTUN_OZELNOT		VARCHAR(2)
										,SORULIST			NVARCHAR(MAX))

					INSERT INTO #TEMP2 ( ID_ASSESSMENT			
										,ID_KADEME3			
										,DONEM				
										,AD			
										,SUTUN_TCKIMLIKNO	
										,SUTUN_ADSOYAD		
										,SUTUN_SESKAYDI		
										,SUTUN_FOTOGRAF		
										,SUTUN_OZELNOT		
										,SORULIST)
					SELECT * 
					FROM OPENJSON (@SINAV)
					WITH (	 ID_ASSESSMENT		INT
							,ID_KADEME3			INT
							,DONEM				VARCHAR(4)
							,AD			VARCHAR(MAX)
							,SUTUN_TCKIMLIKNO	VARCHAR(2)
							,SUTUN_ADSOYAD		VARCHAR(2)
							,SUTUN_SESKAYDI		VARCHAR(2)
							,SUTUN_FOTOGRAF		VARCHAR(2)
							,SUTUN_OZELNOT		VARCHAR(2)
							,SORULIST			NVARCHAR(MAX))

					
					UPDATE A SET
						 A.DONEM			= T.DONEM
						,A.ID_KADEME3		= T.ID_KADEME3
						,A.AD				= T.AD
						,A.SUTUN_TCKIMLIKNO	= T.SUTUN_TCKIMLIKNO
						,A.SUTUN_ADSOYAD	= T.SUTUN_ADSOYAD
						,A.SUTUN_SESKAYDI	= T.SUTUN_SESKAYDI
						,A.SUTUN_FOTOGRAF	= T.SUTUN_FOTOGRAF
						,A.SUTUN_OZELNOT	= T.SUTUN_OZELNOT
						,A.KYD_TARIH		= GETDATE()
						,A.KYD_TCKIMLIKNO	= @TCKIMLIKNO
					FROM Assessment	A
					JOIN #TEMP2		T	ON	T.ID_ASSESSMENT	= A.ID_ASSESSMENT

					UPDATE S SET
						 S.AKTIF			= 0
						,S.KYI_TARIH		= GETDATE()
						,S.KYI_TCKIMLIKNO	= @TCKIMLIKNO
					FROM AssessmentSoru S
					JOIN #TEMP2			T	ON	T.ID_ASSESSMENT	= S.ID_ASSESSMENT

					UPDATE O SET
						O.AKTIF = 0
						,O.KYI_TARIH = GETDATE()
						,O.KYI_TCKIMLIKNO = @TCKIMLIKNO
					FROM AssessmentOgrenci O
					WHERE O.ID_ASSESSMENT = @ID_ASSESSMENT


					CREATE TABLE #SORULIST2 ( SORUNO				INT
											,SUTUN					VARCHAR(2)
											,ID_ASSESSMENT			INT
											,ID_ASSESSMENTKATEGORI	INT
											,CEVAP					VARCHAR(MAX)
											,SORU					VARCHAR(MAX)
											)
					
					SET @SORULIST = ( SELECT TOP 1 SORULIST FROM #TEMP2 )
					INSERT INTO #SORULIST2 (SORUNO, SUTUN, ID_ASSESSMENTKATEGORI, CEVAP, SORU, ID_ASSESSMENT)
					SELECT 
						 SORUNO					
						,SUTUN					
						,ID_ASSESSMENTKATEGORI	
						,CEVAP
						,SORU
						,@ID_ASSESSMENT
					FROM OPENJSON( @SORULIST )
					WITH (	 SORUNO		INT
							,SUTUN		VARCHAR(2)
							,ID_ASSESSMENTKATEGORI	INT
							,CEVAP		VARCHAR(MAX)
							,SORU		VARCHAR(MAX)
					)

					--SELECT * FROM AssessmentSoru

					INSERT INTO AssessmentSoru (ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,KYE_TCKIMLIKNO)
					SELECT ID_ASSESSMENT,SORUNO,SUTUN,ID_ASSESSMENTKATEGORI,CEVAP,SORU,@TCKIMLIKNO FROM #SORULIST2
									
					DROP TABLE IF EXISTS #TEMP2
					DROP TABLE IF EXISTS #SORULIST2
										
					SELECT @ID_ASSESSMENT
				END

			END

			IF @ISLEM = 3	--	SINAV LİSTE					
			BEGIN

				SELECT ISNULL((
					SELECT	 A.AD
							,A.DONEM
							,A.ID_ASSESSMENT
							,A.ID_KADEME3
							,KL.AD+ ' ' + KL.SOYAD AS ADSOYAD							
							,K.AD AS KADEME3
							,KYE_TARIH = CONVERT(VARCHAR, A.KYE_TARIH ,104)
							,KYD_TARIH = ISNULL( CONVERT(VARCHAR, A.KYD_TARIH ,104) , '-')
							,A.AKTIF
					FROM Assessment			A
					JOIN v3Kademe3			K	ON	K.ID_KADEME3	= A.ID_KADEME3
					JOIN v3Kullanici		KL	ON	KL.TCKIMLIKNO	= A.KYE_TCKIMLIKNO
					LEFT JOIN v3Kullanici	KLD	ON	KLD.TCKIMLIKNO	= A.KYE_TCKIMLIKNO
					WHERE	( @PASIFGORUNSUN = 1 OR A.AKTIF = 1 )
						AND	A.ID_KADEME3 = @ID_KADEME3
						AND A.DONEM		 = @DONEM
					ORDER BY A.KYE_TARIH DESC
					FOR JSON PATH
				),'[]')

			END

			IF @ISLEM = 4	--	SINAV DETAY					
			BEGIN
			
				SELECT ISNULL((
					SELECT	 A.AD
							,A.DONEM
							,A.ID_KADEME3
							,A.SUTUN_FOTOGRAF
							,A.SUTUN_OZELNOT
							,A.SUTUN_ADSOYAD
							,A.SUTUN_SESKAYDI
							,A.SUTUN_TCKIMLIKNO
							,SORULIST.ID_ASSESSMENTSORU
							,SORULIST.CEVAP
							,SORULIST.SORU
							,SORULIST.ID_ASSESSMENTKATEGORI
							,SORULIST.SORUNO
							,SORULIST.SUTUN
							,[COUNT] = 1000
					FROM Assessment		A
					JOIN AssessmentSoru	SORULIST	ON	SORULIST.ID_ASSESSMENT	= A.ID_ASSESSMENT
					WHERE	A.AKTIF			= 1
						AND SORULIST.AKTIF	= 1
						AND A.ID_ASSESSMENT	= @ID_ASSESSMENT
					ORDER BY A.KYE_TARIH DESC, SORULIST.SORUNO
					FOR JSON AUTO
				),'[]')


			END

			IF @ISLEM = 5	--	ÖĞRENCİ YÜKLE				
			BEGIN
			
			
				DROP TABLE IF EXISTS #YEDEK
				DROP TABLE IF EXISTS #TEMP5
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #SORU
				DROP TABLE IF EXISTS #SORUDONGU

				DROP TABLE IF EXISTS #TEKOGR
				DROP TABLE IF EXISTS #TEKSORU

				DECLARE  @SUTUN_TCKIMLIKNO	VARCHAR(2)
						,@SUTUN_OZELNOT		VARCHAR(2)
						,@SUTUN_ADSOYAD		VARCHAR(2)
						,@SUTUN_SESKAYDI	VARCHAR(2)
						,@SUTUN_FOTOGRAF	VARCHAR(2)

				SELECT	 @SUTUN_TCKIMLIKNO	= SUTUN_TCKIMLIKNO
						,@SUTUN_OZELNOT		= SUTUN_OZELNOT
						,@SUTUN_SESKAYDI	= SUTUN_SESKAYDI
						,@SUTUN_FOTOGRAF	= SUTUN_FOTOGRAF
						,@SUTUN_ADSOYAD		= SUTUN_ADSOYAD
				FROM Assessment
				WHERE ID_ASSESSMENT = @ID_ASSESSMENT

				SELECT S.SORUNO, S.SUTUN, S.ID_ASSESSMENTSORU
				INTO #SORU
				FROM Assessment		A
				JOIN AssessmentSoru	S	ON	S.ID_ASSESSMENT = A.ID_ASSESSMENT
										AND S.AKTIF			= 1
				WHERE A.ID_ASSESSMENT = @ID_ASSESSMENT

				CREATE TABLE #TEMP5 (ID						INT IDENTITY(1,1)
									,ID_ASSESSMENTOGRENCI	INT
									,TCKIMLIKNO				VARCHAR(MAX)
									,OZELNOT				VARCHAR(MAX)
									,ADSOYAD				VARCHAR(MAX)
									,SESKAYDI				VARCHAR(MAX)
									,FOTOGRAF				VARCHAR(MAX)
									,JSONVALUE				VARCHAR(MAX) )

				
				SELECT 
					 RN						= ROW_NUMBER() OVER(PARTITION BY JSON_VALUE(E.VALUE, '$.'+@SUTUN_TCKIMLIKNO)  ORDER BY JSON_VALUE(E.VALUE, '$.'+@SUTUN_ADSOYAD))
					,TCKIMLIKNO				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_TCKIMLIKNO)
					,OZELNOT				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_OZELNOT)
					,ADSOYAD				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_ADSOYAD)
					,SESKAYDI				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_SESKAYDI)
					,FOTOGRAF				= JSON_VALUE(E.VALUE, '$.'+@SUTUN_FOTOGRAF)
					,JSONVALUE				= E.VALUE
				INTO #YEDEK
				FROM OPENJSON (@EXCEL) E
				WHERE	JSON_VALUE(E.VALUE, '$.'+@SUTUN_TCKIMLIKNO) != ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_OZELNOT)	!= ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_ADSOYAD)	!= ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_SESKAYDI)	!= ''
					OR	JSON_VALUE(E.VALUE, '$.'+@SUTUN_FOTOGRAF)	!= ''


				INSERT INTO #TEMP5 (ID_ASSESSMENTOGRENCI, TCKIMLIKNO, OZELNOT, ADSOYAD, SESKAYDI, FOTOGRAF, JSONVALUE)
				SELECT NULL, SUBSTRING( TCKIMLIKNO,1,11), OZELNOT, ADSOYAD, SESKAYDI, FOTOGRAF, JSONVALUE FROM #YEDEK WHERE RN = 1

				DECLARE @ID5 TABLE(ID INT IDENTITY(1,1),ID_ASSESSMENTOGRENCI INT)

				UPDATE AssessmentOgrenci SET
					AKTIF = 0
					,KYI_TARIH = GETDATE()
					,KYI_TCKIMLIKNO = @TCKIMLIKNO
				WHERE ID_ASSESSMENT = @ID_ASSESSMENT

				UPDATE T SET
					T.ADSOYAD = K.AD + ' ' + K.SOYAD
				FROM #TEMP5 T
				JOIN v3Kullanici K ON K.TCKIMLIKNO = T.TCKIMLIKNO				


				INSERT INTO AssessmentOgrenci (ID_ASSESSMENT, TCKIMLIKNO, ADSOYAD, SESKAYDI, FOTOGRAF, OZELNOT, KYE_TCKIMLIKNO)
				OUTPUT inserted.ID_ASSESSMENTOGRENCI INTO @ID5(ID_ASSESSMENTOGRENCI)
				SELECT @ID_ASSESSMENT, TCKIMLIKNO, ADSOYAD, SESKAYDI, FOTOGRAF, OZELNOT, @TCKIMLIKNO FROM #TEMP5 T ORDER BY T.ID
							
				
				UPDATE T SET
					ID_ASSESSMENTOGRENCI = I.ID_ASSESSMENTOGRENCI
				FROM #TEMP5	T
				JOIN @ID5	I	ON	I.ID = T.ID

				
				INSERT INTO AssessmentOgrenciCevap (ID_ASSESSMENTOGRENCI,ID_ASSESSMENTSORU,CEVAP)
				SELECT	 ID_ASSESSMENTOGRENCI
						,S.ID_ASSESSMENTSORU
						,CASE WHEN JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) IN ('Not answered','NOT ANSWERED') THEN NULL ELSE JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) END
				FROM #TEMP5  T
				CROSS APPLY #SORU S	


				--SELECT * INTO #DONGU FROM #TEMP5
				--WHILE EXISTS (SELECT TOP 1 ID FROM #DONGU)
				--BEGIN	
				--	DROP TABLE IF EXISTS #TEKOGR
				--	SELECT * INTO #TEKOGR FROM #DONGU ORDER BY 1 	
				--	DROP TABLE IF EXISTS #SORUDONGU
				--	SELECT * INTO #SORUDONGU FROM #SORU
				--	WHILE EXISTS (SELECT TOP 1 SORUNO FROM #SORUDONGU)
				--	BEGIN		
				--		DROP TABLE IF EXISTS #TEKSORU
				--		SELECT * INTO #TEKSORU FROM #SORUDONGU ORDER BY 1 
				--		INSERT INTO AssessmentOgrenciCevap (ID_ASSESSMENTOGRENCI,ID_ASSESSMENTSORU,CEVAP)
				--		SELECT	 ID_ASSESSMENTOGRENCI
				--				,S.ID_ASSESSMENTSORU
				--				,CASE WHEN JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) IN ('Not answered','NOT ANSWERED') THEN NULL ELSE JSON_VALUE(T.JSONVALUE,'$.'+S.SUTUN) END
				--		FROM #TEKOGR  T
				--		CROSS APPLY #TEKSORU S	
				--		DELETE SD 
				--		FROM #SORUDONGU SD
				--		JOIN #TEKSORU	TS ON TS.ID_ASSESSMENTSORU = SD.ID_ASSESSMENTSORU
				--	END
				--	DELETE D 
				--	FROM #DONGU D
				--	JOIN #TEKOGR T	ON T.ID_ASSESSMENTOGRENCI = D.ID_ASSESSMENTOGRENCI
				--END

				
				DROP TABLE IF EXISTS #YEDEK
				DROP TABLE IF EXISTS #TEMP5
				DROP TABLE IF EXISTS #DONGU
				DROP TABLE IF EXISTS #SORU
				DROP TABLE IF EXISTS #SORUDONGU

				DROP TABLE IF EXISTS #TEKOGR
				DROP TABLE IF EXISTS #TEKSORU

			END
						
			IF @ISLEM = 6	--	EŞLEŞMEYEN ÖĞRENCİ LİSTESİ	
			BEGIN
			
				SELECT  VK.TCKIMLIKNO,VK.AD,VK.SOYAD,RIGHT('000'+ VS.SUBENO,3)SUBENO,VS.AD SUBEAD,VSN.AD SINIF
				INTO	#T6
				FROM	V3Ogrenci			VO
				JOIN	V3Kullanici			VK	ON	VK.TCKIMLIKNO=VO.TCKIMLIKNO
				JOIN	V3SUBE				VS	ON	VS.ID_SUBE=VO.ID_SUBE
				JOIN	V3Sinif				VSN	ON	VSN.ID_SINIF=VO.ID_SINIF
				JOIN	v3KullaniciKademe3	VKK	ON	VKK.TCKIMLIKNO=VO.TCKIMLIKNO
				WHERE	ID_KADEME3 = @ID_KADEME3
					AND NOT EXISTS (SELECT TCKIMLIKNO FROM AssessmentOgrenci AO WHERE AO.TCKIMLIKNO = VK.TCKIMLIKNO AND ID_ASSESSMENT = @ID_ASSESSMENT)
				
				select(
					select * from(
						select 
						(
							SELECT * 
							FROM AssessmentOgrenci	AO
							WHERE	NOT EXISTS (SELECT TCKIMLIKNO FROM v3Kullanici K WHERE K.TCKIMLIKNO = AO.TCKIMLIKNO)
								AND	AO.ID_ASSESSMENT	= @ID_ASSESSMENT
								AND	AO.AKTIF			= 1
							FOR JSON AUTO
						) as t1,
						(
							select * from #T6
							order by SUBENO,SUBEAD,SINIF,AD,SOYAD
							FOR JSON AUTO
						) as t2					
					) as tablo FOR JSON AUTO
				) as tt
			

				DROP TABLE IF EXISTS #T6	
			END

			IF @ISLEM = 7	--	ÖĞRENCİ TC GUNCELLE			
			BEGIN
			
				UPDATE AO SET
					 AO.TCKIMLIKNO	= @TC_OGRENCI
					,AO.ADSOYAD		= CASE WHEN K.AD IS NULL THEN AO.ADSOYAD ELSE K.AD+' '+ K.SOYAD END
				FROM AssessmentOgrenci	AO
				LEFT JOIN v3Kullanici	K	ON	K.TCKIMLIKNO = @TC_OGRENCI
				WHERE ID_ASSESSMENTOGRENCI = @ID_ASSESSMENTOGRENCI

				SELECT ISNULL((
					SELECT ADSOYAD 
					FROM AssessmentOgrenci	AO
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = AO.TCKIMLIKNO
					WHERE ID_ASSESSMENTOGRENCI = @ID_ASSESSMENTOGRENCI
					FOR JSON AUTO
				),'[]')

			END
			
			IF @ISLEM = 8	--	ÖĞRENCİ SİL					
			BEGIN
			
				UPDATE AssessmentOgrenci SET
					 AKTIF = 0
					,KYI_TARIH = GETDATE()
					,KYI_TCKIMLIKNO = @TCKIMLIKNO
				WHERE ID_ASSESSMENTOGRENCI = @ID_ASSESSMENTOGRENCI

			END
			
			IF @ISLEM = 9	--	SINAV AKTİF PASİF YAP		
			BEGIN
			
				UPDATE Assessment SET
					 AKTIF = @AKTIF
					,KYD_TARIH = GETDATE()
					,KYD_TCKIMLIKNO = @TCKIMLIKNO
				WHERE ID_ASSESSMENT = @ID_ASSESSMENT

			END


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_AssessmentOgrenciSinavRaporu]...';


GO
ALTER procedure [dbo].[sp_AssessmentOgrenciSinavRaporu]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@ID_SUBEs				VARCHAR(MAX)= NULL,
	@DONEM					VARCHAR(MAX)= NULL,
	@ID_KADEME3				INT			= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU

				,ID_SUBEs		= @ID_SUBEs				
				,DONEM			= @DONEM				
				,ID_KADEME3		= @ID_KADEME3			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN

			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU
			
			SELECT D.*
			INTO #TEMP
			FROM vw_AssessmentOgrenciCevapDurum	D
			JOIN Assessment						A	ON	A.ID_ASSESSMENT = D.ID_ASSESSMENT
			WHERE	A.ID_KADEME3	= @ID_KADEME3	
				AND A.DONEM			= @DONEM
				AND A.AKTIF			= 1
							
			SELECT  K.ID_ASSESSMENTKATEGORI, COUNT(1) SORUSAYISI,UPPER(K.AD) KATEGORI, S.ID_ASSESSMENT
			INTO #SORUSAYISI
			FROM AssessmentSoru		S			
			JOIN AssessmentKategori	K	ON	K.ID_ASSESSMENTKATEGORI = S.ID_ASSESSMENTKATEGORI
			WHERE	S.AKTIF	= 1
				AND S.ID_ASSESSMENT IN (SELECT DISTINCT ID_ASSESSMENT FROM #TEMP)
			GROUP BY K.ID_ASSESSMENTKATEGORI,K.AD, S.ID_ASSESSMENT
				
			SELECT DISTINCT T.ID_ASSESSMENTOGRENCI, ID_ASSESSMENTKATEGORI, A.ID_ASSESSMENT, O.TCKIMLIKNO
			INTO #OGRLIST
			FROM #TEMP				T
			JOIN Assessment			A	ON	A.ID_ASSESSMENT			= T.ID_ASSESSMENT
			JOIN AssessmentOgrenci	AO	ON	AO.ID_ASSESSMENTOGRENCI = T.ID_ASSESSMENTOGRENCI
			JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
			JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF
			WHERE	A.AKTIF	= 1
				AND AO.AKTIF= 1
				AND GS.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				
			SELECT 
				 ID_ASSESSMENTOGRENCI
				,ID_ASSESSMENT
				,TCKIMLIKNO
				,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.DURUM = 1) AS float) / NULLIF((SELECT SUM(SORUSAYISI) FROM #SORUSAYISI SS WHERE SS.ID_ASSESSMENT = O.ID_ASSESSMENT) , 0) * 100.0 AS decimal(8,2))
			INTO #GENELYUZDE
			FROM #OGRLIST O
			GROUP BY O.ID_ASSESSMENTOGRENCI, ID_ASSESSMENT, TCKIMLIKNO
			
			DECLARE @cols NVARCHAR(MAX)
			DECLARE @cols2 NVARCHAR(MAX)
			DECLARE @cols3 NVARCHAR(MAX)
			DECLARE @SQL NVARCHAR(MAX)
			DECLARE @SQL2 NVARCHAR(MAX) = ''

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.ID_ASSESSMENT )  FROM (SELECT DISTINCT T.ID_ASSESSMENT FROM #TEMP T) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols2 = STUFF((SELECT DISTINCT ',' +  'MAX(P.[' + CAST(C.ID_ASSESSMENT AS varchar)+']) AS '+ QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols3 = STUFF((SELECT			',' +  QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c ORDER BY ID_ASSESSMENT FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			
			DROP TABLE IF EXISTS #TEMP_TBL
			CREATE TABLE #TEMP_TBL( [TCKIMLIKNO]	VARCHAR(MAX),
									[KAMPÜS]		VARCHAR(MAX),
									[GRUP]			VARCHAR(MAX),
									[SINIF]			VARCHAR(MAX),
									[AD SOYAD]		VARCHAR(MAX))

			SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD INTO #DONGU FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT
			WHILE EXISTS(SELECT * FROM #DONGU)
			BEGIN
				DECLARE @SINAVAD VARCHAR(MAX) 
				DECLARE @ID_ASSESSMENT INT 

				SELECT TOP 1 @SINAVAD = SINAVAD, @ID_ASSESSMENT = ID_ASSESSMENT FROM #DONGU ORDER BY ID_ASSESSMENT
		 
				SET @SQL2  = @SQL2 + ' 
					ALTER TABLE #TEMP_TBL ADD ['+CAST(@SINAVAD AS varchar)+'] DECIMAL(8,2)
				'
				DELETE FROM #DONGU WHERE ID_ASSESSMENT = @ID_ASSESSMENT
			END

			EXEC(@SQL2)

			SET @SQL = '
					INSERT INTO #TEMP_TBL (  TCKIMLIKNO
											,'+@cols3+'
											,[AD SOYAD]				
											,[KAMPÜS]			
											,[GRUP]					
											,[SINIF]				
											)
					SELECT	 O.TCKIMLIKNO
							,'+@cols2+'
							,ADSOYAD = K.AD+'' ''+ K.SOYAD
							,GS.SUBEAD
							,GS.KADEME3
							,GS.SINIF							
					FROM (
						SELECT TCKIMLIKNO,YUZDE,ID_ASSESSMENT
						FROM #GENELYUZDE
					) AS D
					PIVOT ( SUM(YUZDE) FOR ID_ASSESSMENT IN ('+@cols+') ) AS P			
					JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= P.TCKIMLIKNO
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO			= O.TCKIMLIKNO
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF			
					GROUP BY K.AD+'' ''+ K.SOYAD,O.TCKIMLIKNO,SUBEAD,KADEME3,SINIF
			'

			PRINT @SQL
			EXEC(@SQL)
			
			IF @ISLEM = 1	--	JSON
			BEGIN
				SELECT ISNULL((				
					SELECT * FROM #TEMP_TBL
					ORDER BY [KAMPÜS], GRUP, SINIF, [AD SOYAD]
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END
			IF @ISLEM = 2	--	DATASET
			BEGIN
				SELECT * FROM #TEMP_TBL
				ORDER BY [KAMPÜS], GRUP, SINIF, [AD SOYAD]

			END

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU

		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_AssessmentSinifSinavRaporu]...';


GO
ALTER procedure [dbo].[sp_AssessmentSinifSinavRaporu]
	@ISLEM					INT			= NULL,
	@TCKIMLIKNO				VARCHAR(11)	= NULL,
	@OTURUM					VARCHAR(36)	= NULL,
	@ID_MENU				INT			= NULL,
	
	@DONEM					VARCHAR(MAX)= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM			= @ISLEM	
				,TCKIMLIKNO		= @TCKIMLIKNO
				,OTURUM			= @OTURUM
				,ID_MENU		= @ID_MENU
			
				,DONEM			= @DONEM				
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN

			IF NOT EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM = @DONEM)
				SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
					
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU
			DROP TABLE IF EXISTS #SINIFGENEL
			
			SELECT D.*
			INTO #TEMP
			FROM vw_AssessmentOgrenciCevapDurum	D
			JOIN Assessment						A	ON	A.ID_ASSESSMENT = D.ID_ASSESSMENT
			WHERE	A.DONEM	= @DONEM
				AND A.AKTIF	= 1

			SELECT  K.ID_ASSESSMENTKATEGORI, COUNT(1) SORUSAYISI,UPPER(K.AD) KATEGORI, S.ID_ASSESSMENT
			INTO #SORUSAYISI
			FROM AssessmentSoru		S			
			JOIN AssessmentKategori	K	ON	K.ID_ASSESSMENTKATEGORI = S.ID_ASSESSMENTKATEGORI
			WHERE	S.AKTIF	= 1
				AND S.ID_ASSESSMENT IN (SELECT DISTINCT ID_ASSESSMENT FROM #TEMP)
			GROUP BY K.ID_ASSESSMENTKATEGORI,K.AD, S.ID_ASSESSMENT

			SELECT DISTINCT T.ID_ASSESSMENTOGRENCI, ID_ASSESSMENTKATEGORI, A.ID_ASSESSMENT, O.TCKIMLIKNO, O.ID_SINIF
			INTO #OGRLIST
			FROM #TEMP				T
			JOIN Assessment			A	ON	A.ID_ASSESSMENT			= T.ID_ASSESSMENT
			JOIN AssessmentOgrenci	AO	ON	AO.ID_ASSESSMENTOGRENCI = T.ID_ASSESSMENTOGRENCI
			JOIN v3Ogrenci			O	ON	O.TCKIMLIKNO			= AO.TCKIMLIKNO
			JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF				= O.ID_SINIF
			WHERE	A.AKTIF	 = 1
				AND AO.AKTIF = 1
				
			SELECT 
				 ID_ASSESSMENTOGRENCI
				,ID_ASSESSMENT
				,TCKIMLIKNO
				,ID_SINIF
				,YUZDE = CAST( CAST((SELECT COUNT(1) FROM #TEMP T WHERE T.ID_ASSESSMENTOGRENCI = O.ID_ASSESSMENTOGRENCI AND T.DURUM = 1) AS float) / NULLIF((SELECT SUM(SORUSAYISI) FROM #SORUSAYISI SS WHERE SS.ID_ASSESSMENT = O.ID_ASSESSMENT) , 0) * 100.0 AS decimal(8,2))
			INTO #GENELYUZDE
			FROM #OGRLIST O
			GROUP BY O.ID_ASSESSMENTOGRENCI, ID_ASSESSMENT, TCKIMLIKNO, ID_SINIF

			SELECT	 ID_SINIF
					,ID_ASSESSMENT
					,YUZDE = CAST(AVG(YUZDE) AS decimal(8,2))
			INTO #SINIFGENEL
			FROM #GENELYUZDE	GY
			GROUP BY ID_SINIF, ID_ASSESSMENT
			


			DECLARE @cols NVARCHAR(MAX)
			DECLARE @cols2 NVARCHAR(MAX)
			DECLARE @cols3 NVARCHAR(MAX)
			DECLARE @SQL NVARCHAR(MAX)
			DECLARE @SQL2 NVARCHAR(MAX) = ''
			
			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.ID_ASSESSMENT )  FROM (SELECT DISTINCT T.ID_ASSESSMENT FROM #TEMP T) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols2 = STUFF((SELECT DISTINCT ',' +  'MAX(P.[' + CAST(C.ID_ASSESSMENT AS varchar)+']) AS '+ QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			SET @cols3 = STUFF((SELECT			',' +  QUOTENAME(C.SINAVAD) FROM (SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD  FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT) c  ORDER BY ID_ASSESSMENT FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			
			DROP TABLE IF EXISTS #TEMP_TBL
			CREATE TABLE #TEMP_TBL( [ID_SINIF]		VARCHAR(MAX),
									[KAMPÜS]		VARCHAR(MAX),
									[GRUP]			VARCHAR(MAX),
									[SINIF]			VARCHAR(MAX),)

			SELECT DISTINCT A.ID_ASSESSMENT, A.AD SINAVAD INTO #DONGU FROM #TEMP T JOIN Assessment A ON A.ID_ASSESSMENT = T.ID_ASSESSMENT
			WHILE EXISTS(SELECT * FROM #DONGU)
			BEGIN
				DECLARE @SINAVAD VARCHAR(MAX) 
				DECLARE @ID_ASSESSMENT INT 

				SELECT TOP 1 @SINAVAD = SINAVAD, @ID_ASSESSMENT = ID_ASSESSMENT FROM #DONGU ORDER BY ID_ASSESSMENT
		 
				SET @SQL2  = @SQL2 + ' 
					ALTER TABLE #TEMP_TBL ADD ['+CAST(@SINAVAD AS varchar)+'] DECIMAL(8,2)
				'
				DELETE FROM #DONGU WHERE ID_ASSESSMENT = @ID_ASSESSMENT
			END
			EXEC(@SQL2)
			
			SET @SQL = '
					INSERT INTO #TEMP_TBL (  ID_SINIF
											,'+@cols3+'
											,[KAMPÜS]
											,[GRUP]
											,[SINIF]
											)
					SELECT	 P.ID_SINIF
							,'+@cols2+'
							,GS.SUBEAD
							,GS.KADEME3
							,GS.SINIF							
					FROM (
						SELECT ID_SINIF,YUZDE,ID_ASSESSMENT
						FROM #SINIFGENEL
					) AS D
					PIVOT ( SUM(YUZDE) FOR ID_ASSESSMENT IN ('+@cols+') ) AS P			
					JOIN vw_SubeGrupSinif	GS	ON	GS.ID_SINIF		= P.ID_SINIF		
					GROUP BY P.ID_SINIF,SUBEAD,KADEME3,SINIF
							
					
			'

			PRINT @SQL
			EXEC(@SQL)
			
			IF @ISLEM = 1	--	JSON
			BEGIN
				SELECT ISNULL((				
					SELECT * FROM #TEMP_TBL
					ORDER BY [KAMPÜS], GRUP, SINIF
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				),'[]')
			END
			IF @ISLEM = 2	--	DATASET
			BEGIN
				SELECT * FROM #TEMP_TBL
				ORDER BY [KAMPÜS], GRUP, SINIF

			END

			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #OGRLIST
			DROP TABLE IF EXISTS #SORUSAYISI
			DROP TABLE IF EXISTS #GENELYUZDE
			DROP TABLE IF EXISTS #KATEGORIYUZDE
			DROP TABLE IF EXISTS #DONGU


		END


	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_BirimYetki]...';


GO
ALTER procedure [dbo].[sp_BirimYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPI	INT				= NULL
		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENUS			= @ID_MENUS		
			,ID_MENU			= @ID_MENU		
			,ID_KADEME			= @ID_KADEME		
			,ID_SUBEs			= @ID_SUBEs		
			,ID_KULLANICITIPI	= @ID_KULLANICITIPI
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kademe Listele
		BEGIN
			SELECT DISTINCT KD.ID_KADEME, KD.AD
			FROM v3KullaniciKademe	S
			INNER JOIN OkyanusDB.[dbo].v3Kademe		KD	ON KD.ID_KADEME	= S.ID_KADEME
			--WHERE S.TCKIMLIKNO = @TCKIMLIKNO
			ORDER BY ID_KADEME ASC
		END
				
		IF @ISLEM = 2	--	Kullanici Tipi Listele
		BEGIN			
			select * from [dbo].[v3KullaniciTipi]
			--WHERE S.TCKIMLIKNO = @TCKIMLIKNO
			--WHERE ID_KULLANICITIPI<>1
			ORDER BY AD ASC
		END
				
		IF @ISLEM = 3	--	Birim Yetki Kaydet
		BEGIN			

			DELETE MenuYetki WHERE ID_KADEME=@ID_KADEME and ID_KULLANICITIPI=@ID_KULLANICITIPI			

			INSERT INTO MenuYetki(ID_KADEME,ID_KULLANICITIPI,ID_MENU) 
			((SELECT @ID_KADEME,@ID_KULLANICITIPI,Value FROM dbo.fn_Split(@ID_MENUS, ',', null) ) )

			--SELECT KOD,LEN(KOD) / 3 AS SAYI 
			--INTO #K 
			--FROM Menu M 
			--WHERE M.ID_MENU IN (SELECT ID_MENU FROM MenuYetki MY WHERE MY.ID_KADEME=@ID_KADEME and MY.ID_KULLANICITIPI=@ID_KULLANICITIPI)
			

			--DECLARE @TABLE TABLE (ID_MENU INT)
			--DECLARE @I INT=0

			--WHILE @I<(SELECT MAX(SAYI) FROM #K)
			--BEGIN
			--	INSERT INTO @TABLE(ID_MENU)
			--	SELECT M.ID_MENU FROM MENU M WHERE M.KOD IN (SELECT SUBSTRING(KOD,1,(@I*3)) FROM #K)
				
			--	SET @I+=1
			--END


			--INSERT INTO MenuYetki(ID_KADEME,ID_KULLANICITIPI,ID_MENU) 			
			--(SELECT @ID_KADEME,@ID_KULLANICITIPI,ID_MENU FROM @TABLE T WHERE T.ID_MENU NOT IN (SELECT ID_MENU FROM MenuYetki MY WHERE MY.ID_KADEME=@ID_KADEME and MY.ID_KULLANICITIPI=@ID_KULLANICITIPI))
			
			--DROP TABLE #K


			
		END
			
		IF @ISLEM = 4	--	Kullanıcı Kademe Listele
		BEGIN

			SELECT ISNULL((
				SELECT DISTINCT KD.ID_KADEME, KD.AD
				FROM		v3KullaniciKademe			S
				INNER JOIN	v3SubeYetki					SY	ON	SY.TCKIMLIKNO	= S.TCKIMLIKNO
				INNER JOIN	OkyanusDB.[dbo].v3Kademe	KD	ON	KD.ID_KADEME	= S.ID_KADEME
				WHERE	S.TCKIMLIKNO = @TCKIMLIKNO
					AND SY.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBEs))
				ORDER BY ID_KADEME ASC
				FOR JSON AUTO
			),'[]')
		END

	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_BurslulukBursOraniBelirle]...';


GO
ALTER procedure [dbo].[sp_BurslulukBursOraniBelirle]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SINAVDERS		INT				= NULL,
	@BURSTUR			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL		
AS
BEGIN
		DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
		DECLARE @LOGJSON VARCHAR(MAX)

		SET @LOGJSON = (
			SELECT	 
			ISLEM				= @ISLEM			
			,TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ID_MENU			= @ID_MENU		
			,ID_SINAV			= @ID_SINAV		
			,ID_SINAVDERS		= @ID_SINAVDERS	
			,BURSTUR			= @BURSTUR		
			,SQLJSON			= @SQLJSON		
			FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
		)	

		DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	EXCEL OGRENCI KAYDETME	
		BEGIN
			SELECT (
				SELECT *
				FROM BurslulukSinavBursOrani
				WHERE	ID_SINAV = @ID_SINAV
					AND BURSTUR  = @BURSTUR
					AND (	@BURSTUR = 1 
						OR	(@BURSTUR= 2 AND ID_SINAVDERS = @ID_SINAVDERS ))
				FOR JSON AUTO
			) AS J
		END

		IF @ISLEM = 2	--	BURS ORANI EKLE			
		BEGIN
			SELECT 
				 ID_SINAV		= ID_SINAV	
				,MIN_DEGER		= MIN_DEGER	
				,MAX_DEGER		= MAX_DEGER	
				,BURSORANI		= BURSORANI
				,BURSTUR		= BURSTUR
				,OGRENCISAYISI	= OGRENCISAYISI	
			INTO #BURSORAN	
			FROM OPENJSON (@SQLJSON)
			WITH (
				 ID_SINAV		INT
				,MIN_DEGER		DECIMAL(8,3)
				,MAX_DEGER		DECIMAL(8,3)
				,BURSORANI		DECIMAL(8,3)
				,BURSTUR		INT
				,OGRENCISAYISI	INT
			) AS J


			SELECT * 
			INTO #ORANKAYDET
			FROM #BURSORAN
			WHERE	(MIN_DEGER		> 0 AND MIN_DEGER		IS NOT NULL)
			--	AND (MAX_DEGER		> 0 AND MAX_DEGER		IS NOT NULL)
				AND (BURSORANI		> 0 AND BURSORANI		IS NOT NULL)
				AND (	BURSTUR = 1
					OR	(	BURSTUR != 1 
						AND (MAX_DEGER		> 0 AND MAX_DEGER		IS NOT NULL)
						)
					)
				AND (	BURSTUR != 1
					OR	(	BURSTUR = 1 
						AND (OGRENCISAYISI	> 0 AND OGRENCISAYISI	IS NOT NULL)
						)
					)


			DELETE FROM BO
			FROM BurslulukSinavBursOrani BO
			JOIN #BURSORAN				 B	ON	B.ID_SINAV	= BO.ID_SINAV
											AND	B.BURSTUR	= BO.BURSTUR
											AND (	(B.BURSTUR	= 2 AND BO.ID_SINAVDERS = @ID_SINAVDERS)
												OR	B.BURSTUR	= 1
												)


			INSERT INTO BurslulukSinavBursOrani (
				 ID_SINAV	
				,MIN_DEGER	
				,MAX_DEGER	
				,BURSORANI	
				,BURSTUR
				,OGRENCISAYISI
				,ID_SINAVDERS
			)
			SELECT   ID_SINAV	
					,MIN_DEGER	
					,MAX_DEGER	
					,BURSORANI	
					,BURSTUR
					,CASE WHEN BURSTUR = 1 THEN OGRENCISAYISI ELSE NULL END
					,CASE WHEN BURSTUR = 2 THEN @ID_SINAVDERS ELSE NULL END
			FROM #ORANKAYDET
			ORDER BY BURSORANI desc, MAX_DEGER desc, MIN_DEGER desc

			SELECT COUNT(1) FROM #ORANKAYDET

		END
		

	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_CevapAnahtariKullaniciYetki]...';


GO
ALTER procedure [dbo].[sp_CevapAnahtariKullaniciYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@DERSLIST			VARCHAR(MAX)	= NULL,
	@ID_MENU			INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	 
			ISLEM			 = @ISLEM		
			,TCKIMLIKNO		 = @TCKIMLIKNO	
			,OTURUM			 = @OTURUM		
			,TC_YETKI		 = @TC_YETKI	
			,DERSLIST		 = @DERSLIST	
			,ID_MENU			 = @ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG = 1
		BEGIN
			IF @ISLEM = 1	--	DERS LİSTESİ
			BEGIN

				SELECT DISTINCT D.AD DERSAD,CASE WHEN C.DERSAD IS NULL THEN 0 ELSE 1 END YETKILI
				INTO #TEMP
				FROM OKYANUSDB.DBO.v3SinavDers		D	
		   LEFT JOIN CevapAnahtariKullaniciYetki	C	ON	C.DERSAD	= D.AD 
														AND	C.TCKIMLIKNO= @TC_YETKI

				select(
						select * from(
							select 
							(						 
								SELECT DERSAD,YETKILI
								FROM #TEMP
								FOR JSON AUTO
							) as DersList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #TEMP
			END

			IF @ISLEM = 2 
			BEGIN
				DELETE FROM CevapAnahtariKullaniciYetki WHERE TCKIMLIKNO=@TC_YETKI

				INSERT INTO CevapAnahtariKullaniciYetki (TCKIMLIKNO,DERSAD,KYE_TCKIMLIKNO)
				SELECT @TC_YETKI,JSON_VALUE( J.VALUE,'$.DERSAD')  AS DERSAD , @TCKIMLIKNO
				FROM OPENJSON(@DERSLIST) AS J
				WHERE CAST(JSON_VALUE( J.VALUE,'$.YETKILI') AS BIT) = 1

				SELECT 1 
			END

		
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Degerlendirme]...';


GO
ALTER PROCEDURE [dbo].[sp_Degerlendirme]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@SQLJSON					VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPI			INT				= NULL,
	@ID_KADEME					INT				= NULL,
	@ID_SUBE					INT				= NULL,
	@TCPERSONEL					VARCHAR(MAX)	= NULL,
	@TCPERSONELLIST				VARCHAR(MAX)	= NULL,
	@ID_LISTELEMETIPI			INT				= NULL,
	@ID_SINIF					INT				= NULL,
	@ID_DEGERLENDIRMEPERIYOT	INT				= NULL,
	@ID_DEGERLENDIRMESORU		INT				= NULL,
	@ID_DEGERLENDIRMEYORUM		INT				= NULL,
	@YORUM						VARCHAR(MAX)	= NULL,
	@ID_DEGERLENDIRMEKATEGORI	INT				= NULL,
	@YORUMTUR					INT				= NULL,
	@ID_KADEMELIST				VARCHAR(MAX)	= NULL,
	@ID_KULLANICITIPILIST		VARCHAR(MAX)	= NULL,
	@RAPORTIPI					INT				= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@KUR_SINIF					BIT				= 0,
	@DURUM						INT				= 0,
	@TC_DEGERLENDIREN			VARCHAR(11)		= NULL,
	@TC_DEGERLENDIRILEN			VARCHAR(11)		= NULL,
	@IDAREKULLANICITIPI			VARCHAR(10)     = NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	
			ISLEM						 	= @ISLEM						
			,TCKIMLIKNO					 	= @TCKIMLIKNO					
			,OTURUM						 	= @OTURUM						
			,ID_MENU					 	= @ID_MENU					
			,DONEM						 	= @DONEM						
			,SQLJSON					 	= @SQLJSON					
			,ID_KULLANICITIPI			 	= @ID_KULLANICITIPI			
			,ID_KADEME					 	= @ID_KADEME					
			,ID_SUBE					 	= @ID_SUBE					
			,TCPERSONEL					 	= @TCPERSONEL					
			,TCPERSONELLIST				 	= @TCPERSONELLIST				
			,ID_LISTELEMETIPI			 	= @ID_LISTELEMETIPI			
			,ID_SINIF					 	= @ID_SINIF					
			,ID_DEGERLENDIRMEPERIYOT	 	= @ID_DEGERLENDIRMEPERIYOT	
			,ID_DEGERLENDIRMESORU		 	= @ID_DEGERLENDIRMESORU		
			,ID_DEGERLENDIRMEYORUM		 	= @ID_DEGERLENDIRMEYORUM		
			,YORUM						 	= @YORUM						
			,ID_DEGERLENDIRMEKATEGORI	 	= @ID_DEGERLENDIRMEKATEGORI	
			,YORUMTUR					 	= @YORUMTUR					
			,ID_KADEMELIST				 	= @ID_KADEMELIST				
			,ID_KULLANICITIPILIST		 	= @ID_KULLANICITIPILIST		
			,RAPORTIPI					 	= @RAPORTIPI					
			,ID_SUBELIST				 	= @ID_SUBELIST				
			,KUR_SINIF					 	= @KUR_SINIF					
			,DURUM						 	= @DURUM						
			,TC_DEGERLENDIREN			 	= @TC_DEGERLENDIREN			
			,TC_DEGERLENDIRILEN			 	= @TC_DEGERLENDIRILEN			
			,IDAREKULLANICITIPI			    = @IDAREKULLANICITIPI			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		 
	
		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	PERİYOT TANIMLA
			BEGIN
				IF CAST(JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEPERIYOT') AS INT) > 0
				BEGIN
					--IF  NOT EXISTS (SELECT * FROM DegerlendirmeYorum WHERE ID_DEGERLENDIRMEPERIYOT = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEPERIYOT'))
					--AND NOT EXISTS (SELECT * FROM DegerlendirmePuan WHERE ID_DEGERLENDIRMEPERIYOT = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEPERIYOT'))
					--BEGIN
						UPDATE DP SET DP.BASLANGIC = J.BASLANGIC, DP.BITIS = J.BITIS FROM DegerlendirmePeriyot DP 
						INNER JOIN OPENJSON(@SQLJSON) WITH(
							ID_DEGERLENDIRMEPERIYOT INT,
							BASLANGIC DATE,
							BITIS DATE
						) J ON J.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
					--END
					--ELSE
					--BEGIN
					--	RAISERROR ('Düzenlenmeye çalışan periyot için giriş yapıldığından düzenleme işlemi yapılamaz!' , -- Message text.
					--				16, -- Severity.
					--				1 -- State.
					--				);
					--END
				END
				ELSE
				BEGIN
					INSERT INTO DegerlendirmePeriyot ( [ID_KADEME]
													  ,[ID_KULLANICITIPI]
													  ,[BASLANGIC]
													  ,[BITIS]
													  ,[DONEM]
													  ,[KYE_TCKIMLIKNO])
					SELECT @ID_KADEME, @ID_KULLANICITIPI, BASLANGIC, BITIS, @DONEM, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
					WITH(
						BASLANGIC DATE,
						BITIS DATE
					)
				END

				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
							,[ID_KADEME]
							,[ID_KULLANICITIPI]
							--,[SIRA]
							,CONVERT(VARCHAR, [BASLANGIC], 104) AS [BASLANGIC]
							,CONVERT(VARCHAR, [BITIS], 104) AS [BITIS]
							,[DONEM]
							,[KYE_TCKIMLIKNO]
							,[KYE_TARIH] 
					FROM DegerlendirmePeriyot 
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
					ORDER BY CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END
			
			IF @ISLEM = 2	--	PERİYOT GETİR
			BEGIN
				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
						  ,[ID_KADEME]
						  ,[ID_KULLANICITIPI]
						  --,[SIRA]
						  ,CONVERT(VARCHAR, [BASLANGIC], 104) AS [BASLANGIC]
						  ,CONVERT(VARCHAR, [BITIS], 104) AS [BITIS]
						  ,[DONEM]
						  ,[KYE_TCKIMLIKNO]
						  ,[KYE_TARIH]  
					FROM DegerlendirmePeriyot 
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
					ORDER BY CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 3	--	SORU TANIMLA
			BEGIN
				IF CAST(JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMESORU') AS INT) > 0
				BEGIN
					--IF NOT EXISTS (SELECT * FROM DegerlendirmePuan WHERE ID_DEGERLENDIRMESORU = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMESORU'))
					--BEGIN
						UPDATE DS SET DS.SORU = J.SORU, DS.ID_DEGERLENDIRMEKATEGORI = J.ID_DEGERLENDIRMEKATEGORI FROM DegerlendirmeSoru DS 
						INNER JOIN OPENJSON(@SQLJSON) WITH(
							ID_DEGERLENDIRMESORU INT,
							ID_DEGERLENDIRMEKATEGORI INT,
							SORU VARCHAR(MAX)
						) J ON J.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU
					--END
					--ELSE
					--BEGIN
					--	RAISERROR ('Düzenlenmeye çalışan soru için giriş yapıldığından düzenleme işlemi yapılamaz!' , -- Message text.
					--				16, -- Severity.
					--				1 -- State.
					--				);
					--END
				END
				ELSE
				BEGIN
					INSERT INTO DegerlendirmeSoru (	   [ID_KADEME]
													  ,[ID_KULLANICITIPI]
													  ,[DONEM]
													  ,[ID_DEGERLENDIRMEPERIYOT]
													  ,[SORU]
													  ,[ID_DEGERLENDIRMEKATEGORI]
													  ,[KYE_TCKIMLIKNO])
					SELECT @ID_KADEME, @ID_KULLANICITIPI, @DONEM, @ID_DEGERLENDIRMEPERIYOT, SORU, ID_DEGERLENDIRMEKATEGORI, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
					WITH(
						SORU VARCHAR(MAX),
						ID_DEGERLENDIRMEKATEGORI INT
					)
				END

				
				SELECT
				(
					SELECT DS.[ID_DEGERLENDIRMESORU]
						  ,DS.[ID_KADEME]
						  ,DS.[ID_KULLANICITIPI]
						  ,DS.[ID_DEGERLENDIRMEPERIYOT]
						  ,DS.[SORU]
						  ,DS.[ID_DEGERLENDIRMEKATEGORI]
						  ,DK.[AD] AS KATEGORI
						  ,DS.[DONEM]
						  ,DS.[KYE_TCKIMLIKNO]
						  ,DS.[KYE_TARIH]  
					FROM DegerlendirmeSoru DS
					LEFT JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME AND ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END
			
			IF @ISLEM = 4	--	SORU GETİR
			BEGIN
				SELECT
				(
					SELECT DS.[ID_DEGERLENDIRMESORU]
						  ,DS.[ID_KADEME]
						  ,DS.[ID_KULLANICITIPI]
						  ,DS.[ID_DEGERLENDIRMEPERIYOT]
						  ,DS.[SORU]
						  ,DS.[ID_DEGERLENDIRMEKATEGORI]
						  ,DK.[AD] AS KATEGORI
						  ,DS.[DONEM]
						  ,DS.[KYE_TCKIMLIKNO]
						  ,DS.[KYE_TARIH]  
					FROM DegerlendirmeSoru DS
					LEFT JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME AND ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					FOR JSON PATH, INCLUDE_NULL_VALUES
				)
			END

			IF @ISLEM = 5	--	PERSONEL GETİR
			BEGIN
				SELECT
				(
					SELECT DISTINCT k.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD 
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ KK ON KK.TCKIMLIKNO = K.TCKIMLIKNO/* AND KK.ID_SUBE = SY.ID_SUBE*/
					--WHERE SY.ID_KULLANICITIPI = @ID_KULLANICITIPI 
					WHERE SY.ID_KULLANICITIPI  IN (SELECT    CAST( value AS INT)  FROM  STRING_SPLIT(@IDAREKULLANICITIPI, ',')) 
					AND (KK.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0)
					AND SY.ID_SUBE = @ID_SUBE
					ORDER BY ADSOYAD
					FOR JSON AUTO 
				) AS J
			END

			IF @ISLEM = 6	--	SORU - PUAN - YORUM GETİR
			BEGIN		
				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				IF @ID_DEGERLENDIRMEPERIYOT IS NULL
				BEGIN
					RAISERROR ('Puan Eklenecek Periyot Bulunamadı!' , -- Message text.
					16, -- Severity.
					1 -- State.
					);
				END
				ELSE
				BEGIN
					SELECT	@YORUM = DY.YORUM
					FROM DegerlendirmeYorum DY
					WHERE DY.KYE_TCKIMLIKNO = @TCKIMLIKNO
					AND DY.TCKIMLIKNO = @TCPERSONEL
					AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					AND DY.TUR = @YORUMTUR

					SELECT
					(
						SELECT	YORUM = ISNULL(@YORUM, ''),
								TCPERSONEL = @TCPERSONEL,
								ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT,
								SORULAR = (	
											SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, PUAN = ISNULL(DP.PUAN, 0)
											FROM DegerlendirmeSoru DS
											LEFT JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU 
																			AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT 
																			AND DP.TCKIMLIKNO = @TCPERSONEL 
																			AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
											WHERE DS.ID_KADEME = @ID_KADEME
											AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
											AND DS.DONEM = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
											AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
											ORDER BY DS.ID_DEGERLENDIRMESORU
											FOR JSON PATH
										)
						FOR JSON PATH
					) AS J
				END
			END

			IF @ISLEM = 7	--	SORU - PUAN - YORUM KAYDET
			BEGIN
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT, @TCPERSONEL = TCPERSONEL, @YORUM = YORUM
				FROM OPENJSON(@SQLJSON)
				WITH(
					ID_DEGERLENDIRMEPERIYOT INT,
					TCPERSONEL VARCHAR(11),
					YORUM VARCHAR(MAX)
				)

				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END
				
				DELETE FROM DegerlendirmeYorum WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND TCKIMLIKNO = @TCPERSONEL AND KYE_TCKIMLIKNO = @TCKIMLIKNO AND TUR = @YORUMTUR
				DELETE FROM DegerlendirmePuan WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND TCKIMLIKNO = @TCPERSONEL AND KYE_TCKIMLIKNO = @TCKIMLIKNO

				INSERT INTO DegerlendirmeYorum (ID_DEGERLENDIRMEPERIYOT, TCKIMLIKNO, YORUM, KYE_TCKIMLIKNO, TUR)
				SELECT @ID_DEGERLENDIRMEPERIYOT, @TCPERSONEL, @YORUM, @TCKIMLIKNO, @YORUMTUR

				INSERT INTO DegerlendirmePuan (ID_DEGERLENDIRMEPERIYOT, ID_DEGERLENDIRMESORU, TCKIMLIKNO, PUAN, KYE_TCKIMLIKNO)
				SELECT @ID_DEGERLENDIRMEPERIYOT, ID_DEGERLENDIRMESORU, @TCPERSONEL, PUAN, KYE_TCKIMLIKNO = @TCKIMLIKNO
				FROM OPENJSON(@SQLJSON, '$.SORULAR') 
				WITH(
					ID_DEGERLENDIRMESORU INT,
					PUAN TINYINT
				)

				SELECT	@YORUM = DY.YORUM
				FROM DegerlendirmeYorum DY
				WHERE DY.KYE_TCKIMLIKNO = @TCKIMLIKNO
				AND DY.TCKIMLIKNO = @TCPERSONEL
				AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

				SELECT
				(
					SELECT	YORUM = ISNULL(@YORUM, ''),
							TCPERSONEL = @TCPERSONEL,
							ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT,
							SORULAR = (	
										SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, PUAN = ISNULL(DP.PUAN, 0)
										FROM DegerlendirmeSoru DS
										LEFT JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU 
																		AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT 
																		AND DP.TCKIMLIKNO = @TCPERSONEL 
																		AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
										WHERE DS.ID_KADEME = @ID_KADEME
										AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
										AND DS.DONEM = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
										AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
										ORDER BY DS.ID_DEGERLENDIRMESORU
										FOR JSON PATH
									)
					FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 8	--	ÖĞRENCİ LİSTELE
			BEGIN
				CREATE TABLE #OGRENCI (AD VARCHAR(100) ,SOYAD VARCHAR(100),TCKIMLIKNO VARCHAR(11))

				INSERT INTO #OGRENCI (AD,SOYAD,TCKIMLIKNO)
				SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
				FROM OkyanusDB.DBO.vw_SinifOgrenci	O
				JOIN OkyanusDB.DBO.v3Kullanici		K	ON K.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE ID_SINIF = @ID_SINIF

				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = (SELECT ID_KADEME FROM v3SinifTum WHERE ID_SINIF = @ID_SINIF)
				AND ID_KULLANICITIPI = 4

				IF @ID_LISTELEMETIPI = 0	--	TÜMÜ
				BEGIN
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCI
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 1	--	DEĞERLENDİRİLENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCI O
						WHERE O.TCKIMLIKNO IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 2	--	DEĞERLENDİRİLMEYENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCI O
						WHERE O.TCKIMLIKNO NOT IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END		
				
				DROP TABLE #OGRENCI		
			END

			IF @ISLEM = 9	--	ÖĞRETMEN - SORU - PUAN - YORUM GETİR
			BEGIN		
				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END

				IF @DONEM IS NULL
				BEGIN
					SELECT @DONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
				INTO #OGRETMEN
				FROM OkyanusDB.dbo.v3Ogrenci O
				INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
				WHERE O.TCKIMLIKNO = @TCPERSONEL
				GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

				INSERT INTO #OGRETMEN
				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
				FROM OkyanusDB.dbo.v3Ogrenci O
				INNER JOIN OkyanusDB.dbo.v3DersProgram DP ON DP.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DP.TCKIMLIKNO
				WHERE O.TCKIMLIKNO = @TCPERSONEL AND K.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #OGRETMEN)
				GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

				SELECT O.TCKIMLIKNO, @TCPERSONEL AS TCPERSONEL, O.ADSOYAD AS ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM AS GENELYORUM, DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS
						,(
							SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, SUBDP.PUAN 
							FROM DegerlendirmeSoru DS
							LEFT JOIN DegerlendirmePuan SUBDP ON DS.ID_DEGERLENDIRMESORU = SUBDP.ID_DEGERLENDIRMESORU AND SUBDP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND SUBDP.TCKIMLIKNO = @TCPERSONEL AND SUBDP.KYE_TCKIMLIKNO = O.TCKIMLIKNO
							WHERE DS.DONEM = @DONEM AND DS.ID_KADEME = @ID_KADEME AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
							ORDER BY DS.ID_DEGERLENDIRMESORU
							FOR JSON PATH, INCLUDE_NULL_VALUES
						) AS SORULIST
						,TUR = 0
				INTO #NORMALTABLO
				FROM #OGRETMEN O
				LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = @TCPERSONEL AND DY.KYE_TCKIMLIKNO = O.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR=0
				LEFT JOIN DegerlendirmeYorum DYI ON DYI.TCKIMLIKNO = @TCPERSONEL AND DYI.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DYI.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DYI.TUR=@YORUMTUR
				LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
				GROUP BY O.ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM, DYD.DURUM, O.TCKIMLIKNO

				INSERT INTO #NORMALTABLO(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
				SELECT DISTINCT DY.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 1    
				FROM DegerlendirmeYorum DY 
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = DY.KYE_TCKIMLIKNO AND SY.ID_KULLANICITIPI IN (26, 91)
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
				WHERE DY.TCKIMLIKNO = @TCPERSONEL AND DY.TUR=1
				AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

				INSERT INTO #NORMALTABLO(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
				SELECT DISTINCT O.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 2    
				FROM OkyanusDB.dbo.v3Ogrenci O
				INNER JOIN OkyanusDB.dbo.v3SinifPersonel SD ON SD.ID_SINIF = O.ID_SINIF AND SD.ID_KULLANICITIPI = 100
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SD.TCKIMLIKNO
				LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = O.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = K.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR=2
				LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
				WHERE O.TCKIMLIKNO = @TCPERSONEL

				SELECT
				(
					SELECT * FROM #NORMALTABLO
					ORDER BY TUR, GIRIS DESC, ADSOYAD
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) AS J

				DROP TABLE #OGRETMEN
				DROP TABLE #NORMALTABLO
			END

			IF @ISLEM = 10	--	ÖĞRETMEN - SORU - PUAN - YORUM KAYDET
			BEGIN
				IF @TCPERSONEL IS NULL
				BEGIN
					SET @TCPERSONEL = JSON_VALUE(@SQLJSON, '$.TCPERSONEL')
				END

				IF @ID_KADEME IS NULL	-- ÖĞRENCİ İSE KADEME GÖNDERİLMİYOR
				BEGIN
					SELECT @ID_KADEME = ID_KADEME FROM OkyanusDB.dbo.v3KullaniciKademe WHERE TCKIMLIKNO = @TCPERSONEL
				END

				IF @DONEM IS NULL
				BEGIN
					SELECT @DONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				IF @ID_DEGERLENDIRMEPERIYOT IS NULL
				BEGIN
					RAISERROR ('Puan Eklenecek Periyot Bulunamadı!' , -- Message text.
					16, -- Severity.
					1 -- State.
					);
				END
				ELSE
				BEGIN
					SELECT ID_DEGERLENDIRMEYORUM, DURUM, @TCKIMLIKNO AS TCKIMLIKNO
					INTO #YORUMDURUM
					FROM OPENJSON(@SQLJSON, '$.YORUMLIST')
					WITH(
						ID_DEGERLENDIRMEYORUM INT,
						DURUM BIT
					)

					DELETE DYD FROM DegerlendirmeYorumDurum DYD
					INNER JOIN #YORUMDURUM YD ON /*YD.TCKIMLIKNO = DYD.KYE_TCKIMLIKNO AND*/ YD.ID_DEGERLENDIRMEYORUM = DYD.ID_DEGERLENDIRMEYORUM

					INSERT INTO DegerlendirmeYorumDurum ([ID_DEGERLENDIRMEYORUM], [DURUM] ,[KYE_TCKIMLIKNO])
					SELECT ID_DEGERLENDIRMEYORUM, DURUM, @TCKIMLIKNO FROM #YORUMDURUM

					DELETE DY FROM DegerlendirmeYorum DY 
					WHERE DY.KYE_TCKIMLIKNO = @TCKIMLIKNO 
					AND DY.TCKIMLIKNO = JSON_VALUE(@SQLJSON, '$.TCPERSONEL') 
					AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					AND DY.TUR = @YORUMTUR

					INSERT INTO DegerlendirmeYorum ([ID_DEGERLENDIRMEPERIYOT]
						  ,[TCKIMLIKNO]
						  ,[YORUM]
						  ,[KYE_TCKIMLIKNO]
						  ,TUR)
					SELECT @ID_DEGERLENDIRMEPERIYOT, JSON_VALUE(@SQLJSON, '$.TCPERSONEL'), JSON_VALUE(@SQLJSON, '$.YORUM'), @TCKIMLIKNO, @YORUMTUR
					WHERE JSON_VALUE(@SQLJSON, '$.YORUM') IS NOT NULL

					DROP TABLE #YORUMDURUM

					--LİSTELE				

					SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					INTO #OGRETMEN2
					FROM OkyanusDB.dbo.v3Ogrenci O
					INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DO.TC_OGRETMEN
					WHERE O.TCKIMLIKNO = @TCPERSONEL
					GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

					INSERT INTO #OGRETMEN2
					SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					FROM OkyanusDB.dbo.v3Ogrenci O
					INNER JOIN OkyanusDB.dbo.v3DersProgram DP ON DP.ID_SINIF = O.ID_SINIF
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DP.TCKIMLIKNO
					WHERE O.TCKIMLIKNO = @TCPERSONEL AND K.TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #OGRETMEN2)
					GROUP BY K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD

					SELECT O.TCKIMLIKNO, @TCPERSONEL AS TCPERSONEL, O.ADSOYAD AS ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM AS GENELYORUM, DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS
							,(
								SELECT DS.ID_DEGERLENDIRMESORU, DS.SORU, SUBDP.PUAN 
								FROM DegerlendirmeSoru DS
								LEFT JOIN DegerlendirmePuan SUBDP ON DS.ID_DEGERLENDIRMESORU = SUBDP.ID_DEGERLENDIRMESORU AND SUBDP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND SUBDP.TCKIMLIKNO = @TCPERSONEL AND SUBDP.KYE_TCKIMLIKNO = O.TCKIMLIKNO
								WHERE DS.DONEM = @DONEM AND DS.ID_KADEME = @ID_KADEME AND DS.ID_KULLANICITIPI = @ID_KULLANICITIPI AND DS.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
								ORDER BY DS.ID_DEGERLENDIRMESORU
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS SORULIST
							,TUR = 0
					INTO #NORMALTABLO2
					FROM #OGRETMEN2 O
					LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = @TCPERSONEL AND DY.KYE_TCKIMLIKNO = O.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = 0
					LEFT JOIN DegerlendirmeYorum DYI ON DYI.TCKIMLIKNO = @TCPERSONEL AND DYI.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DYI.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = @YORUMTUR
					LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
					GROUP BY O.ADSOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, DYI.YORUM, DYD.DURUM, O.TCKIMLIKNO

					INSERT INTO #NORMALTABLO2(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
					SELECT DISTINCT DY.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 1    
					FROM DegerlendirmeYorum DY 
					INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = DY.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = DY.KYE_TCKIMLIKNO AND SY.ID_KULLANICITIPI IN (26, 91)
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
					LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
					WHERE DY.TCKIMLIKNO = @TCPERSONEL AND DY.TUR = 1
					AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

					INSERT INTO #NORMALTABLO2(TCKIMLIKNO, TCPERSONEL, ADSOYAD, YORUM, ID_DEGERLENDIRMEYORUM, GENELYORUM, DURUM, GIRIS, SORULIST, TUR)
					SELECT DISTINCT DY.TCKIMLIKNO, @TCPERSONEL, K.AD + ' ' + K.SOYAD, DY.YORUM, DY.ID_DEGERLENDIRMEYORUM, '', DYD.DURUM, CASE WHEN DY.YORUM IS NULL THEN 0 ELSE 1 END AS GIRIS, '', 2    
					FROM OkyanusDB.dbo.v3Ogrenci O
					INNER JOIN OkyanusDB.dbo.v3SinifPersonel SD ON SD.ID_SINIF = O.ID_SINIF AND SD.ID_KULLANICITIPI = 100
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = SD.TCKIMLIKNO
					LEFT JOIN DegerlendirmeYorum DY ON DY.TCKIMLIKNO = O.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = K.TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = 2
					LEFT JOIN DegerlendirmeYorumDurum DYD ON DYD.ID_DEGERLENDIRMEYORUM = DY.ID_DEGERLENDIRMEYORUM-- AND DYD.KYE_TCKIMLIKNO = @TCKIMLIKNO
					WHERE O.TCKIMLIKNO = @TCPERSONEL

					SELECT
					(
						SELECT * FROM #NORMALTABLO2
						ORDER BY TUR, GIRIS DESC, ADSOYAD
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS J

					DROP TABLE #OGRETMEN2
					DROP TABLE #NORMALTABLO2
				END

				
			END

			IF @ISLEM = 11	--	PERİYOT SİL
			BEGIN
				BEGIN TRY
					DELETE FROM DegerlendirmePeriyot WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
					SELECT
					(
						SELECT [ID_DEGERLENDIRMEPERIYOT]
								,[ID_KADEME]
								,[ID_KULLANICITIPI]
								--,[SIRA]
								,CONVERT(VARCHAR, [BASLANGIC], 104) AS [BASLANGIC]
								,CONVERT(VARCHAR, [BITIS], 104) AS [BITIS]
								,[DONEM]
								,[KYE_TCKIMLIKNO]
								,[KYE_TARIH] 
						FROM DegerlendirmePeriyot 
						WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
						ORDER BY CAST(BASLANGIC AS DATE)
						FOR JSON AUTO
					)
				END TRY
				BEGIN CATCH
					RAISERROR ('Silinmeye çalışan periyot için giriş yapıldığından silme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
				END CATCH
			END

			IF @ISLEM = 12	--	SORU SİL
			BEGIN
				BEGIN TRY
					DELETE FROM DegerlendirmeSoru WHERE ID_DEGERLENDIRMESORU = @ID_DEGERLENDIRMESORU
					SELECT
					(
						SELECT DS.[ID_DEGERLENDIRMESORU]
							  ,DS.[ID_KADEME]
							  ,DS.[ID_KULLANICITIPI]
							  ,DS.[ID_DEGERLENDIRMEPERIYOT]
							  ,DS.[SORU]
							  ,DS.[ID_DEGERLENDIRMEKATEGORI]
							  ,DK.[AD] AS KATEGORI
							  ,[DONEM]
							  ,DS.[KYE_TCKIMLIKNO]
							  ,DS.[KYE_TARIH]  
						FROM DegerlendirmeSoru DS
						LEFT JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
						WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME AND ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END TRY
				BEGIN CATCH
					RAISERROR ('Silinmeye çalışan soru için giriş yapıldığından silme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
				END CATCH
			END

			IF @ISLEM = 13	--	PUAN TÜR LİSTELE
			BEGIN
				SELECT
				(
					SELECT * 
					FROM DegerlendirmePuanTur 
					ORDER BY PUAN
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 14	--	SINIF YORUM LİSTELE
			BEGIN
				IF @ID_KADEME IS NULL
				BEGIN
					SELECT @ID_KADEME = ST.ID_KADEME 
					FROM OkyanusDB.dbo.v3Sinif S 
					INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
					WHERE S.ID_SINIF = @ID_SINIF
				END
				
				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = @ID_KADEME
				AND ID_KULLANICITIPI = @ID_KULLANICITIPI

				IF @ID_DEGERLENDIRMEPERIYOT IS NULL
				BEGIN
					RAISERROR ('Periyot Bulunamadı!' , -- Message text.
					16, -- Severity.
					1 -- State.
					);
				END
				ELSE
				BEGIN
					IF @ID_LISTELEMETIPI = 0	--	TÜMÜ
					BEGIN
						SELECT
						(
							SELECT	O.TCKIMLIKNO, K.AD + ' ' +K.SOYAD AS ADSOYAD, ISNULL(DY.YORUM, '') AS YORUM, ISNULL(DY.ID_DEGERLENDIRMEYORUM, 0) AS ID_DEGERLENDIRMEYORUM, @ID_DEGERLENDIRMEPERIYOT as ID_DEGERLENDIRMEPERIYOT
							FROM OkyanusDB.dbo.v3Ogrenci O
							INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
							LEFT JOIN DegerlendirmeYorum DY ON O.TCKIMLIKNO = DY.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = @YORUMTUR
							WHERE O.ID_SINIF = @ID_SINIF
							ORDER BY ADSOYAD
							FOR JSON PATH
						) AS J
					END
					ELSE IF @ID_LISTELEMETIPI = 1	--	DEĞERLENDİRİLENLER
					BEGIN	
						SELECT
						(
							SELECT	O.TCKIMLIKNO, K.AD + ' ' +K.SOYAD AS ADSOYAD, ISNULL(DY.YORUM, '') AS YORUM, ISNULL(DY.ID_DEGERLENDIRMEYORUM, 0) AS ID_DEGERLENDIRMEYORUM, @ID_DEGERLENDIRMEPERIYOT as ID_DEGERLENDIRMEPERIYOT
							FROM OkyanusDB.dbo.v3Ogrenci O
							INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
							INNER JOIN DegerlendirmeYorum DY ON O.TCKIMLIKNO = DY.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
							WHERE O.ID_SINIF = @ID_SINIF AND DY.TUR = @YORUMTUR
							ORDER BY ADSOYAD
							FOR JSON PATH
						) AS J
					END
					ELSE IF @ID_LISTELEMETIPI = 2	--	DEĞERLENDİRİLMEYENLER
					BEGIN	
						SELECT
						(
							SELECT	O.TCKIMLIKNO, K.AD + ' ' +K.SOYAD AS ADSOYAD, ISNULL(DY.YORUM, '') AS YORUM, ISNULL(DY.ID_DEGERLENDIRMEYORUM, 0) AS ID_DEGERLENDIRMEYORUM, @ID_DEGERLENDIRMEPERIYOT as ID_DEGERLENDIRMEPERIYOT
							FROM OkyanusDB.dbo.v3Ogrenci O
							INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
							LEFT JOIN DegerlendirmeYorum DY ON O.TCKIMLIKNO = DY.TCKIMLIKNO AND DY.KYE_TCKIMLIKNO = @TCKIMLIKNO AND DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TUR = @YORUMTUR
							WHERE O.ID_SINIF = @ID_SINIF AND DY.ID_DEGERLENDIRMEYORUM IS NULL
							ORDER BY ADSOYAD
							FOR JSON PATH
						) AS J
					END						
				END
			END

			IF @ISLEM = 15	--	YORUM KAYDET
			BEGIN
				IF @ID_DEGERLENDIRMEYORUM = 0
				BEGIN
					INSERT INTO DegerlendirmeYorum ([ID_DEGERLENDIRMEPERIYOT]
												,[TCKIMLIKNO]
												,[YORUM]
												,[KYE_TCKIMLIKNO]
												,[TUR])
					SELECT @ID_DEGERLENDIRMEPERIYOT, @TCPERSONEL, @YORUM, @TCKIMLIKNO, @YORUMTUR
				END
				ELSE
				BEGIN
					UPDATE DegerlendirmeYorum SET YORUM = @YORUM WHERE ID_DEGERLENDIRMEYORUM = @ID_DEGERLENDIRMEYORUM AND TUR = @YORUMTUR
				END				
			END

			IF @ISLEM = 16	--	KATEGORİ GETİR
			BEGIN
				SELECT
				(
					SELECT *
					FROM DegerlendirmeKategori 
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 17	--	KATEGORİ TANIMLA
			BEGIN
				IF CAST(JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEKATEGORI') AS INT) > 0
				BEGIN
					IF NOT EXISTS (SELECT TOP 1 1 FROM DegerlendirmeSoru WHERE ID_DEGERLENDIRMEKATEGORI = JSON_VALUE(@SQLJSON, '$.ID_DEGERLENDIRMEKATEGORI'))
					BEGIN
						UPDATE DK SET DK.AD = J.AD FROM DegerlendirmeKategori DK
						INNER JOIN OPENJSON(@SQLJSON) WITH(
							ID_DEGERLENDIRMEKATEGORI INT,
							AD VARCHAR(MAX)
						) J ON J.ID_DEGERLENDIRMEKATEGORI = DK.ID_DEGERLENDIRMEKATEGORI
					END
					ELSE
					BEGIN
						RAISERROR ('Düzenlenmeye çalışan soru için giriş yapıldığından düzenleme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
					END
				END
				ELSE
				BEGIN
					INSERT INTO DegerlendirmeKategori ([AD]
													  ,[KYE_TCKIMLIKNO])
					SELECT AD, @TCKIMLIKNO FROM OPENJSON(@SQLJSON)
					WITH(
						AD VARCHAR(MAX)
					)
				END

				
				SELECT
				(
					SELECT	*
					FROM DegerlendirmeKategori 
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 18	--	KATEGORİ SİL
			BEGIN
				BEGIN TRY
					DELETE FROM DegerlendirmeKategori WHERE ID_DEGERLENDIRMEKATEGORI = @ID_DEGERLENDIRMEKATEGORI
					SELECT
					(
						SELECT *
						FROM DegerlendirmeKategori 
						FOR JSON AUTO
					)
				END TRY
				BEGIN CATCH
					RAISERROR ('Silinmeye çalışan kategori için giriş yapıldığından silme işlemi yapılamaz!' , -- Message text.
									16, -- Severity.
									1 -- State.
									);
				END CATCH
			END

			IF @ISLEM = 19	--	PERSONEL KADEME ŞUBE GETİR
			BEGIN
				IF (SELECT [dbo].[fn_GenelHak](@TCKIMLIKNO)) > 0
				BEGIN
					SELECT
					(
						SELECT DISTINCT K.ID_KADEME, K.AD 
						FROM OkyanusDB.dbo.v3SubeGrupSinif SGS
						INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = SGS.ID_KADEME3
						INNER JOIN OkyanusDB.dbo.v3KademeBilgi KB ON KB.ID_KADEME3 = SGS.ID_KADEME3
						INNER JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = KB.ID_KADEME
						WHERE SGS.ID_SUBE = @ID_SUBE
						FOR JSON PATH
					) AS J
				END
				ELSE
				BEGIN
					SELECT
					(
						SELECT DISTINCT PSK.ID_KADEME, K.AD
						FROM OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PSK
						INNER JOIN OkyanusDB.dbo.v3Kademe K ON K.ID_KADEME = PSK.ID_KADEME
						WHERE PSK.TCKIMLIKNO = @TCKIMLIKNO
						FOR JSON PATH
					) AS J
				END
			END

			IF @ISLEM = 20	--	KULLANICI TİPİ
			BEGIN
				SELECT
				(
					select * from [dbo].[v3KullaniciTipi]
					WHERE ID_KULLANICITIPI IN (53, 54, 59)
					ORDER BY AD ASC
				FOR JSON PATH
				) AS J
			END

			IF @ISLEM = 21	--	PERSONEL GETİR - MULTİ
			BEGIN
				SELECT
				(
					SELECT DISTINCT k.TCKIMLIKNO, K.AD + ' ' + K.SOYAD + ' (' + KD.AD + ' - ' + KT.AD + ')' AS ADSOYAD 
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ KK ON KK.TCKIMLIKNO = K.TCKIMLIKNO /*AND KK.ID_SUBE = SY.ID_SUBE*/
					--INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = SY.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = SY.ID_KULLANICITIPI
					INNER JOIN OkyanusDB.dbo.v3Kademe KD ON KD.ID_KADEME = KK.ID_KADEME
					WHERE SY.ID_SUBE = @ID_SUBE
					AND (@ID_KADEMELIST IS NULL OR @ID_KADEMELIST='' OR KK.ID_KADEME IN (SELECT Value FROM OPENJSON(@ID_KADEMELIST)))
					AND (@ID_KULLANICITIPILIST IS NULL OR @ID_KULLANICITIPILIST='' OR SY.ID_KULLANICITIPI IN (SELECT Value FROM OPENJSON(@ID_KULLANICITIPILIST)))
					ORDER BY ADSOYAD
					FOR JSON AUTO 
				) AS J
			END

			IF @ISLEM = 22	--	PERİYOT GETİR - MULTİ
			BEGIN
				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
						  ,CONVERT(VARCHAR, [BASLANGIC], 104) + ' - ' + CONVERT(VARCHAR, [BITIS], 104) AS [AD]
					FROM DegerlendirmePeriyot DP
					WHERE DONEM = @DONEM AND ID_KULLANICITIPI = @ID_KULLANICITIPI AND ID_KADEME = @ID_KADEME 
					ORDER BY CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 23	--	PDS RAPOR
			BEGIN
				DECLARE  @KULLANICITIPI VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
						,@KADEME		VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
						,@PUANTURSAYISI INT			 = (SELECT COUNT(1) FROM DegerlendirmePuanTur)

				SELECT DISTINCT SY.TCKIMLIKNO, SY.ID_SUBE 
				INTO #SUBETCLIST 
				FROM v3SubeYetki SY 
				INNER JOIN OkyanusDB.dbo.v4KullaniciKademe PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND PSK.ID_KADEME = @ID_KADEME
				WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI				

				SELECT DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				INTO #TOPLAMPUANLIST
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
				GROUP BY DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #GENELPUANORTALAMALARI
				FROM #TOPLAMPUANLIST
				GROUP BY BOLUM

				SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARI
				FROM #TOPLAMPUANLIST TC
				WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				GROUP BY TCKIMLIKNO, BOLUM

				SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #TOPLAMPUANORTALAMALARI
				FROM #TOPLAMPUANLIST TC
				GROUP BY TCKIMLIKNO, BOLUM

				SELECT TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				INTO #GENELSIRA
				FROM #TOPLAMPUANORTALAMALARI TC

				SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRA SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				INTO #GENELSIRA2
				FROM #GENELSIRA SS

				SELECT TCKIMLIKNO, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				INTO #SONSIRALI
				FROM #TOPLAMPUANLIST
				GROUP BY TCKIMLIKNO

				SELECT   DISTINCT
							SSS.SIRA
						,K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,@KADEME AS KADEME
						,@KULLANICITIPI AS KULLANICITIPI
				FROM OkyanusDB.dbo.v3Kullanici K
				INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = STC.ID_SUBE
				INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = STC.TCKIMLIKNO
				WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				ORDER BY SSS.SIRA

				SELECT DISTINCT K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, G.ORTALAMA AS GENEL,GS.SIRA AS GENELSIRA, SSS.SIRA
				FROM #KENDIPUANORTALAMALARI K
				INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				INNER JOIN #GENELPUANORTALAMALARI G ON G.BOLUM = K.BOLUM
				INNER JOIN #GENELSIRA2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = K.TCKIMLIKNO
				ORDER BY SSS.SIRA, K.BOLUM	

				SELECT	 DISTINCT
							DY.TCKIMLIKNO
						,K.AD + ' ' +K.SOYAD AS ADSOYAD
						,UPPER(DY.YORUM) AS YORUM
						,CONVERT(varchar, DY.KYE_TARIH, 104) AS TARIH
						,DY.KYE_TARIH
				FROM DegerlendirmeYorum DY
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				WHERE DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT 
				AND (DY.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				AND DY.YORUM <> ''
				ORDER BY DY.KYE_TARIH DESC

				SELECT DISTINCT S.* FROM #SONSIRALI S
				INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = S.TCKIMLIKNO 
				ORDER BY SIRA

				DROP TABLE IF EXISTS #GENELPUANORTALAMALARI
				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARI
				DROP TABLE IF EXISTS #GENELSIRA
				DROP TABLE IF EXISTS #GENELSIRA2
				DROP TABLE IF EXISTS #TOPLAMPUANLIST
				DROP TABLE IF EXISTS #SUBETCLIST
				DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARI
				DROP TABLE IF EXISTS #SONSIRALI
				--DECLARE  @KULLANICITIPI VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
				--		,@KADEME		VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
				--		,@PUANTURSAYISI INT			 = (SELECT COUNT(*) FROM DegerlendirmePuanTur)

				--SELECT SY.TCKIMLIKNO, SY.ID_SUBE 
				--INTO #SUBETCLIST 
				--FROM v3SubeYetki SY 
				--INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND /*PSK.ID_SUBE = SY.ID_SUBE AND*/ PSK.ID_KADEME = @ID_KADEME
				--WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI				

				--SELECT DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISI) AS MAXPUAN
				--INTO #TOPLAMPUANLIST
				--FROM DegerlendirmeSoru DS
				--INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				--INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				--WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
				--GROUP BY DK.AD, DP.TCKIMLIKNO
				--ORDER BY DP.TCKIMLIKNO

				--SELECT BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #GENELPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST
				--GROUP BY BOLUM

				--SELECT BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA, STC.ID_SUBE
				--INTO #SUBEPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST TC
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO
				--GROUP BY BOLUM, STC.ID_SUBE

				--SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #KENDIPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST TC
				--WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--GROUP BY TCKIMLIKNO, BOLUM

				--SELECT TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #TOPLAMPUANORTALAMALARI
				--FROM #TOPLAMPUANLIST TC
				--GROUP BY TCKIMLIKNO, BOLUM

				--SELECT TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY BOLUM, STC.ID_SUBE ORDER BY ORTALAMA DESC) AS SIRA, STC.ID_SUBE 
				--INTO #SUBESIRA
				--FROM #TOPLAMPUANORTALAMALARI TC
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #SUBESIRA SUBSS WHERE SUBSS.BOLUM = SS.BOLUM AND SUBSS.ID_SUBE = SS.ID_SUBE) AS VARCHAR) AS SIRA, SS.ID_SUBE 
				--INTO #SUBESIRA2
				--FROM #SUBESIRA SS

				--SELECT TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				--INTO #GENELSIRA
				--FROM #TOPLAMPUANORTALAMALARI TC

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRA SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				--INTO #GENELSIRA2
				--FROM #GENELSIRA SS

				--SELECT TCKIMLIKNO, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				--INTO #SONSIRALI
				--FROM #TOPLAMPUANLIST
				--GROUP BY TCKIMLIKNO

				--SELECT   DISTINCT
				--		 SSS.SIRA
				--		,K.TCKIMLIKNO
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,CASE WHEN @ID_KULLANICITIPI = 59 THEN '-' ELSE SB.AD END AS SUBE
				--		--,SB.ID_SUBE
				--		,@KADEME AS KADEME
				--		,@KULLANICITIPI AS KULLANICITIPI
				--FROM OkyanusDB.dbo.v3Kullanici K
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = STC.TCKIMLIKNO
				--WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--ORDER BY SSS.SIRA

				--SELECT DISTINCT K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, S.ORTALAMA AS SUBE, G.ORTALAMA AS GENEL, SS.SIRA AS SUBESIRA, GS.SIRA AS GENELSIRA, SSS.SIRA
				--FROM #KENDIPUANORTALAMALARI K
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN #SUBEPUANORTALAMALARI S ON S.BOLUM = K.BOLUM AND S.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELPUANORTALAMALARI G ON G.BOLUM = K.BOLUM
				--INNER JOIN #SUBESIRA2 SS ON SS.TCKIMLIKNO = K.TCKIMLIKNO AND SS.BOLUM = K.BOLUM AND SS.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELSIRA2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				--INNER JOIN #SONSIRALI SSS ON SSS.TCKIMLIKNO = K.TCKIMLIKNO
				--ORDER BY SSS.SIRA, K.BOLUM	

				--SELECT	 DISTINCT
				--		 DY.TCKIMLIKNO
				--		,K.AD + ' ' +K.SOYAD AS ADSOYAD
				--		,UPPER(DY.YORUM) AS YORUM
				--		,CONVERT(varchar, DY.KYE_TARIH, 104) AS TARIH
				--		,DY.KYE_TARIH
				--FROM DegerlendirmeYorum DY
				--INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.KYE_TCKIMLIKNO
				--WHERE DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT 
				--AND (DY.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--AND DY.YORUM <> ''
				--ORDER BY DY.KYE_TARIH DESC

				--SELECT DISTINCT S.* FROM #SONSIRALI S
				--INNER JOIN #SUBETCLIST STC ON STC.TCKIMLIKNO = S.TCKIMLIKNO 
				--ORDER BY SIRA

				--DROP TABLE IF EXISTS #GENELPUANORTALAMALARI
				--DROP TABLE IF EXISTS #SUBEPUANORTALAMALARI
				--DROP TABLE IF EXISTS #KENDIPUANORTALAMALARI
				--DROP TABLE IF EXISTS #SUBESIRA
				--DROP TABLE IF EXISTS #GENELSIRA
				--DROP TABLE IF EXISTS #SUBESIRA2
				--DROP TABLE IF EXISTS #GENELSIRA2
				--DROP TABLE IF EXISTS #TOPLAMPUANLIST
				--DROP TABLE IF EXISTS #SUBETCLIST
				--DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARI
				--DROP TABLE IF EXISTS #SONSIRALI
			END

			IF @ISLEM = 24	--	PDS EXCEL
			BEGIN
				DECLARE  @KULLANICITIPIEXCEL	VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
						,@KADEMEEXCEL			VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
						,@PUANTURSAYISIEXCEL	INT			 = (SELECT COUNT(*) FROM DegerlendirmePuanTur)
				
				SELECT DISTINCT SY.TCKIMLIKNO, SY.ID_SUBE 
				INTO #SUBETCLISTEXCEL 
				FROM v3SubeYetki SY 
				INNER JOIN OkyanusDB.dbo.v4KullaniciKademe PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND PSK.ID_KADEME = @ID_KADEME
				WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI

				SELECT   DISTINCT
						 K.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,@KADEMEEXCEL AS KADEME
						,@KULLANICITIPIEXCEL AS KULLANICITIPI
				FROM OkyanusDB.dbo.v3Kullanici K
				INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))

				SELECT CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISIEXCEL) AS MAXPUAN
				INTO #TOPLAMPUANLISTEXCEL
				FROM DegerlendirmeSoru DS
				INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				WHERE	((DS.DONEM = @DONEM AND @ID_DEGERLENDIRMEPERIYOT = 0)
				OR		(DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT))
				AND		DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
				AND		DS.ID_KADEME = @ID_KADEME
				GROUP BY PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				ORDER BY DP.TCKIMLIKNO

				SELECT PERIYOT, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #GENELPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL
				GROUP BY PERIYOT, BOLUM

				SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #KENDIPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				INTO #TOPLAMPUANORTALAMALARIEXCEL
				FROM #TOPLAMPUANLISTEXCEL TC
				GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				SELECT PERIYOT, TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY PERIYOT, BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				INTO #GENELSIRAEXCEL
				FROM #TOPLAMPUANORTALAMALARIEXCEL TC

				SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRAEXCEL SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				INTO #GENELSIRAEXCEL2
				FROM #GENELSIRAEXCEL SS

				SELECT DISTINCT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, G.ORTALAMA AS GENEL, GS.SIRA AS GENELSIRA
				FROM #KENDIPUANORTALAMALARIEXCEL K
				INNER JOIN #GENELPUANORTALAMALARIEXCEL G ON G.BOLUM = K.BOLUM
				INNER JOIN #GENELSIRAEXCEL2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				ORDER BY K.TCKIMLIKNO, PERIYOT, K.BOLUM

				SELECT DISTINCT T.TCKIMLIKNO, PERIYOT, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (PARTITION BY PERIYOT ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				FROM #TOPLAMPUANLISTEXCEL T
				INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = T.TCKIMLIKNO
				GROUP BY T.TCKIMLIKNO, PERIYOT

				DROP TABLE IF EXISTS #GENELPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				DROP TABLE IF EXISTS #GENELSIRAEXCEL
				DROP TABLE IF EXISTS #GENELSIRAEXCEL2
				DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
				DROP TABLE IF EXISTS #SUBETCLISTEXCEL
				DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARIEXCEL
				--DECLARE  @KULLANICITIPIEXCEL	VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3KullaniciTipi WHERE ID_KULLANICITIPI = @ID_KULLANICITIPI)
				--		,@KADEMEEXCEL			VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)
				--		,@PUANTURSAYISIEXCEL	INT			 = (SELECT COUNT(*) FROM DegerlendirmePuanTur)
				
				--SELECT DISTINCT SY.TCKIMLIKNO, SY.ID_SUBE 
				--INTO #SUBETCLISTEXCEL 
				--FROM v3SubeYetki SY 
				--INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PSK ON PSK.TCKIMLIKNO = SY.TCKIMLIKNO AND /*PSK.ID_SUBE = SY.ID_SUBE AND*/ PSK.ID_KADEME = @ID_KADEME
				--WHERE SY.ID_SUBE IN (SELECT value FROM OPENJSON(@ID_SUBELIST)) AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI

				--SELECT   K.TCKIMLIKNO
				--		,K.AD + ' ' + K.SOYAD AS ADSOYAD
				--		,CASE WHEN @ID_KULLANICITIPI = 59 THEN '-' ELSE SB.AD END AS SUBE
				--		--,SB.ID_SUBE
				--		,@KADEMEEXCEL AS KADEME
				--		,@KULLANICITIPIEXCEL AS KULLANICITIPI
				--FROM OkyanusDB.dbo.v3Kullanici K
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = STC.ID_SUBE
				--WHERE (K.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))

				--SELECT CONVERT(VARCHAR, PER.BASLANGIC, 104) + ' - ' + CONVERT(VARCHAR, PER.BITIS, 104) AS PERIYOT, DK.AD AS BOLUM, DP.TCKIMLIKNO, SUM(DP.PUAN) AS PUAN, SUM(@PUANTURSAYISIEXCEL) AS MAXPUAN
				--INTO #TOPLAMPUANLISTEXCEL
				--FROM DegerlendirmeSoru DS
				--INNER JOIN DegerlendirmeKategori DK ON DK.ID_DEGERLENDIRMEKATEGORI = DS.ID_DEGERLENDIRMEKATEGORI
				--INNER JOIN DegerlendirmePuan DP ON DP.ID_DEGERLENDIRMESORU = DS.ID_DEGERLENDIRMESORU AND DP.ID_DEGERLENDIRMEPERIYOT = DS.ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO <> '0'
				--INNER JOIN DegerlendirmePeriyot PER ON PER.ID_DEGERLENDIRMEPERIYOT = DP.ID_DEGERLENDIRMEPERIYOT
				----INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = DP.TCKIMLIKNO
				--WHERE	((DS.DONEM = @DONEM AND @ID_DEGERLENDIRMEPERIYOT = 0)
				--OR		(DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT))
				--AND		DS.ID_KULLANICITIPI = @ID_KULLANICITIPI
				--AND		DS.ID_KADEME = @ID_KADEME
				--GROUP BY PER.BASLANGIC, PER.BITIS, DK.AD, DP.TCKIMLIKNO
				--ORDER BY DP.TCKIMLIKNO

				--SELECT PERIYOT, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #GENELPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL
				--GROUP BY PERIYOT, BOLUM

				--SELECT PERIYOT, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA, STC.ID_SUBE
				--INTO #SUBEPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL TC
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO
				--GROUP BY PERIYOT, BOLUM, STC.ID_SUBE

				--SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #KENDIPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL TC
				--WHERE (TC.TCKIMLIKNO IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)) OR '-1' IN (SELECT value FROM OPENJSON(@TCPERSONELLIST)))
				--GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				--SELECT PERIYOT, TCKIMLIKNO, BOLUM, CONVERT(decimal(18,2), CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) AS ORTALAMA
				--INTO #TOPLAMPUANORTALAMALARIEXCEL
				--FROM #TOPLAMPUANLISTEXCEL TC
				--GROUP BY PERIYOT, TCKIMLIKNO, BOLUM

				--SELECT PERIYOT, TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY PERIYOT, BOLUM, STC.ID_SUBE ORDER BY ORTALAMA DESC) AS SIRA, STC.ID_SUBE
				--INTO #SUBESIRAEXCEL
				--FROM #TOPLAMPUANORTALAMALARIEXCEL TC
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = TC.TCKIMLIKNO

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #SUBESIRAEXCEL SUBSS WHERE SUBSS.BOLUM = SS.BOLUM AND SUBSS.ID_SUBE = SS.ID_SUBE) AS VARCHAR) AS SIRA, SS.ID_SUBE
				--INTO #SUBESIRAEXCEL2
				--FROM #SUBESIRAEXCEL SS

				--SELECT PERIYOT, TC.TCKIMLIKNO, TC.BOLUM, ORTALAMA, RANK() OVER (PARTITION BY PERIYOT, BOLUM ORDER BY ORTALAMA DESC) AS SIRA  
				--INTO #GENELSIRAEXCEL
				--FROM #TOPLAMPUANORTALAMALARIEXCEL TC

				--SELECT TCKIMLIKNO, BOLUM, ORTALAMA, CAST(SIRA AS VARCHAR) + '/' + CAST((SELECT COUNT(1) FROM #GENELSIRAEXCEL SUBSS WHERE SUBSS.BOLUM = SS.BOLUM) AS VARCHAR) AS SIRA
				--INTO #GENELSIRAEXCEL2
				--FROM #GENELSIRAEXCEL SS

				--SELECT DISTINCT K.PERIYOT, K.TCKIMLIKNO, K.BOLUM, K.ORTALAMA AS KENDI, S.ORTALAMA AS SUBE, G.ORTALAMA AS GENEL, SS.SIRA AS SUBESIRA, GS.SIRA AS GENELSIRA
				--FROM #KENDIPUANORTALAMALARIEXCEL K
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = K.TCKIMLIKNO
				--INNER JOIN #SUBEPUANORTALAMALARIEXCEL S ON S.BOLUM = K.BOLUM AND S.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELPUANORTALAMALARIEXCEL G ON G.BOLUM = K.BOLUM
				--INNER JOIN #SUBESIRAEXCEL2 SS ON SS.TCKIMLIKNO = K.TCKIMLIKNO AND SS.BOLUM = K.BOLUM AND SS.ID_SUBE = STC.ID_SUBE
				--INNER JOIN #GENELSIRAEXCEL2 GS ON GS.TCKIMLIKNO = K.TCKIMLIKNO AND GS.BOLUM = K.BOLUM
				--ORDER BY K.TCKIMLIKNO, PERIYOT, K.BOLUM

				--SELECT DISTINCT T.TCKIMLIKNO, PERIYOT, CONVERT(DECIMAL(18, 2), (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100)) AS PUAN, RANK() OVER (PARTITION BY PERIYOT ORDER BY (CAST(SUM(PUAN) AS float) / CAST(SUM(MAXPUAN) AS float) * 100) DESC) AS SIRA
				--FROM #TOPLAMPUANLISTEXCEL T
				--INNER JOIN #SUBETCLISTEXCEL STC ON STC.TCKIMLIKNO = T.TCKIMLIKNO
				--GROUP BY T.TCKIMLIKNO, PERIYOT

				--DROP TABLE IF EXISTS #GENELPUANORTALAMALARIEXCEL
				--DROP TABLE IF EXISTS #SUBEPUANORTALAMALARIEXCEL
				--DROP TABLE IF EXISTS #KENDIPUANORTALAMALARIEXCEL
				--DROP TABLE IF EXISTS #SUBESIRAEXCEL
				--DROP TABLE IF EXISTS #GENELSIRAEXCEL
				--DROP TABLE IF EXISTS #SUBESIRAEXCEL2
				--DROP TABLE IF EXISTS #GENELSIRAEXCEL2
				--DROP TABLE IF EXISTS #TOPLAMPUANLISTEXCEL
				--DROP TABLE IF EXISTS #SUBETCLISTEXCEL
				--DROP TABLE IF EXISTS #TOPLAMPUANORTALAMALARIEXCEL
			END

			IF @ISLEM = 25	--	KADEME GETİR
			BEGIN
				SELECT
				(
					SELECT ID_KADEME, AD FROM OkyanusDB.dbo.v3Kademe
					ORDER BY ID_KADEME
					FOR JSON PATH
				) AS J
			
			END

			IF @ISLEM = 26	--	PERİYOT GETİR - TİPSİZ
			BEGIN
				SELECT
				(
					SELECT [ID_DEGERLENDIRMEPERIYOT]
						  ,'('+ KT.AD + ')' + ' - ' + CONVERT(VARCHAR, [BASLANGIC], 104) + ' - ' + CONVERT(VARCHAR, [BITIS], 104) AS [AD]
					FROM DegerlendirmePeriyot DP
					INNER JOIN OkyanusDB.dbo.v3KullaniciTipi KT ON KT.ID_KULLANICITIPI = DP.ID_KULLANICITIPI
					WHERE DONEM = @DONEM 
					AND ((DP.ID_KULLANICITIPI IN (53, 54, 59) AND @RAPORTIPI = 1) OR (DP.ID_KULLANICITIPI = 4 AND @RAPORTIPI = 2))
					AND ID_KADEME = @ID_KADEME 
					ORDER BY KT.AD, CAST(BASLANGIC AS DATE)
					FOR JSON AUTO
				)
			END

			IF @ISLEM = 27	--	DEĞERLENDİRME YAPMAYANLAR
			BEGIN
				IF @DURUM = 0 -- DEĞERLENDİRME YAPMAYANLAR
				BEGIN
					SELECT DISTINCT KYE_TCKIMLIKNO
					INTO #DEGERLENDIRMEYAPANLAR
					FROM DegerlendirmePuan P
					WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND P.TCKIMLIKNO <> '0'

					SELECT DISTINCT O.TCKIMLIKNO
					INTO #DEGERLENDIRMEYAPMAYANLAR
					FROM OkyanusDB.dbo.v3Ogretmen O
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ PK ON PK.TCKIMLIKNO = O.TCKIMLIKNO
					LEFT JOIN #DEGERLENDIRMEYAPANLAR D ON D.KYE_TCKIMLIKNO = O.TCKIMLIKNO
					WHERE PK.ID_KADEME = @ID_KADEME 
					AND D.KYE_TCKIMLIKNO IS NULL
					--AND (PK.ID_SUBE IN (SELECT ID_SUBE FROM #SUBELIST) OR @GENELYETKI = 1)

					DECLARE @KADEMEAD VARCHAR(MAX) = (SELECT AD FROM OkyanusDB.dbo.v3Kademe WHERE ID_KADEME = @ID_KADEME)

					SELECT	 DY.TCKIMLIKNO
							,K.AD
							,K.SOYAD
							,STUFF(
									(	
										SELECT DISTINCT ', ' + S.AD
										FROM OkyanusDB.dbo.v3Sube S
										INNER JOIN OkyanusDB.dbo.v3SubeYetki SUBSY ON SUBSY.ID_SUBE = S.ID_SUBE AND SUBSY.TCKIMLIKNO = DY.TCKIMLIKNO
										ORDER BY ', ' + S.AD
										FOR XML PATH('')
									)
								  , 1, 1, '') SUBE
							,@KADEMEAD AS KADEME
							,ISNULL(O.BRANS, '-') AS BRANS
							,CASE WHEN ISNULL(KB.EMAIL, KB.EMAIL2) LIKE '%@%' THEN ISNULL(KB.EMAIL, KB.EMAIL2) ELSE '' END AS EPOSTA
					FROM #DEGERLENDIRMEYAPMAYANLAR DY 
					INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = DY.TCKIMLIKNO
					LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
					LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi KB ON KB.TCKIMLIKNO = DY.TCKIMLIKNO
					ORDER BY SUBE, AD, SOYAD

					DROP TABLE #DEGERLENDIRMEYAPANLAR
					DROP TABLE #DEGERLENDIRMEYAPMAYANLAR
				END
				ELSE IF @DURUM = 2
				BEGIN
					DECLARE @P_ID_KADEME INT, @P_ID_KULLANICITIPI INT, @P_DONEM VARCHAR(MAX)

					SELECT @P_ID_KADEME = ID_KADEME, @P_ID_KULLANICITIPI = ID_KULLANICITIPI, @P_DONEM = DONEM 
					FROM DegerlendirmePeriyot P
					WHERE P.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

					IF @P_ID_KULLANICITIPI = 4
					BEGIN
						SELECT	DISTINCT 
								O.TCKIMLIKNO
								,K.AD
								,K.SOYAD
								,SUBE.AD AS SUBE
								,KD.AD AS KADEME
								,'-' AS BRANS
								,CASE WHEN ISNULL(KB.EMAIL, KB.EMAIL2) LIKE '%@%' THEN ISNULL(KB.EMAIL, KB.EMAIL2) ELSE '' END AS EPOSTA
						FROM OkyanusDB.dbo.v3OgrenciTum O
						INNER JOIN OkyanusDB.dbo.v3Satislar S ON S.ID_SOZLESME = O.ID_SOZLESME
						INNER JOIN OkyanusDB.dbo.v3SatisTuru ST ON ST.ID_SATISTURU = S.ID_SATISTURU
						INNER JOIN OkyanusDB.dbo.v3Sube SUBE ON SUBE.ID_SUBE = O.ID_SUBE
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kademe KD ON KD.ID_KADEME = ST.ID_KADEME
						LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi KB ON KB.TCKIMLIKNO = O.TCKIMLIKNO
						WHERE ST.ID_KADEME = @P_ID_KADEME AND O.DONEM = @P_DONEM AND NOT EXISTS (SELECT TCKIMLIKNO FROM DegerlendirmePuan DP WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO = O.TCKIMLIKNO)
						ORDER BY SUBE, AD, SOYAD
					END
					ELSE
					BEGIN
						SELECT  DISTINCT 
								KK.TCKIMLIKNO
								,K.AD
								,K.SOYAD
								,STUFF(
										(	
											SELECT DISTINCT ', ' + S.AD
											FROM OkyanusDB.dbo.v3Sube S
											INNER JOIN OkyanusDB.dbo.v3SubeYetki SUBSY ON SUBSY.ID_SUBE = S.ID_SUBE AND SUBSY.TCKIMLIKNO = KK.TCKIMLIKNO
											ORDER BY ', ' + S.AD
											FOR XML PATH('')
										)
									, 1, 1, '') SUBE
								,KD.AD AS KADEME
								,ISNULL(O.BRANS, '-') AS BRANS
								,CASE WHEN ISNULL(KB.EMAIL, KB.EMAIL2) LIKE '%@%' THEN ISNULL(KB.EMAIL, KB.EMAIL2) ELSE '' END AS EPOSTA
						FROM OkyanusDB.dbo.v4KullaniciKademe KK
						INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = KK.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = KK.TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kademe KD ON KD.ID_KADEME = KK.ID_KADEME
						LEFT JOIN OkyanusDB.dbo.v3Ogretmen O ON O.TCKIMLIKNO = K.TCKIMLIKNO
						LEFT JOIN OkyanusDB.dbo.v3KullaniciBilgi KB ON KB.TCKIMLIKNO = KK.TCKIMLIKNO
						WHERE KK.ID_KADEME = @P_ID_KADEME AND SY.ID_KULLANICITIPI = @P_ID_KULLANICITIPI AND NOT EXISTS (SELECT TCKIMLIKNO FROM DegerlendirmePuan DP WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO = KK.TCKIMLIKNO)
						ORDER BY SUBE, AD, SOYAD
					END
				END
				ELSE IF @DURUM = 1
				BEGIN
					SELECT
					(
						SELECT DISTINCT P.ID_DEGERLENDIRMEPERIYOT, K.TCKIMLIKNO AS TC_DEGERLENDIREN, K2.TCKIMLIKNO AS TC_DEGERLENDIRILEN, K.AD + ' ' + K.SOYAD AS DEGERLENDIREN, K2.AD + ' ' + K2.SOYAD AS DEGERLENDIRILEN, ISNULL(O.BRANS,'') AS BRANS
						FROM DegerlendirmePuan P
						INNER JOIN OkyanusDB.dbo.v3Kullanici K	ON K.TCKIMLIKNO = P.KYE_TCKIMLIKNO
						INNER JOIN OkyanusDB.dbo.v3Kullanici K2 ON K2.TCKIMLIKNO = P.TCKIMLIKNO
						LEFT  JOIN v3Ogretmen				 O	ON O.TCKIMLIKNO  = K.TCKIMLIKNO 
						WHERE ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND P.TCKIMLIKNO <> '0'
						ORDER BY DEGERLENDIREN, DEGERLENDIRILEN
						FOR JSON PATH
					)
				END
			END

			IF @ISLEM = 28	--	PERSONEL GETİR - MULTİ ŞUBE
			BEGIN
				SELECT
				(
					SELECT DISTINCT k.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD 
					FROM OkyanusDB.dbo.v3Kullanici K
					INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO = K.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v4KullaniciKademe/*v3PersonelSubeKademe*/ KK ON KK.TCKIMLIKNO = K.TCKIMLIKNO /*AND KK.ID_SUBE = SY.ID_SUBE*/
					WHERE SY.ID_KULLANICITIPI = @ID_KULLANICITIPI 
					AND KK.ID_KADEME = @ID_KADEME 
					AND (@ID_SUBELIST IS NULL OR @ID_SUBELIST='' OR SY.ID_SUBE IN (SELECT Value FROM OPENJSON(@ID_SUBELIST)))
					ORDER BY ADSOYAD
					FOR JSON AUTO 
				) AS J
			END

			IF @ISLEM = 29	--	ÖĞRENCİ LİSTELE V4
			BEGIN
				CREATE TABLE #OGRENCIV4 (AD VARCHAR(100) ,SOYAD VARCHAR(100),TCKIMLIKNO VARCHAR(11))

				IF @ID_SINIF < 0 
				BEGIN
					INSERT INTO #OGRENCIV4 (AD,SOYAD,TCKIMLIKNO)
					SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
					FROM OkyanusDB.dbo.v4SinifOgrenci	O
					JOIN v3Kullanici	K	ON K.TCKIMLIKNO	= O.TC_OGRENCI
					WHERE O.ID_SINIF = @ID_SINIF AND O.AKTIF = 1
				END
				ELSE
				BEGIN
				
					INSERT INTO #OGRENCIV4 (AD,SOYAD,TCKIMLIKNO)
					SELECT K.AD ,K.SOYAD ,K.TCKIMLIKNO
					FROM v3OgrenciTum		O
					JOIN v3Kullanici		K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
					WHERE O.ID_SINIF = @ID_SINIF

				END

				SELECT @ID_DEGERLENDIRMEPERIYOT = ID_DEGERLENDIRMEPERIYOT FROM DegerlendirmePeriyot
				WHERE BASLANGIC <= CAST(GETDATE() AS DATE)
				AND BITIS >= CAST(GETDATE() AS DATE)
				AND ID_KADEME = (SELECT ID_KADEME FROM v3SinifTum WHERE ID_SINIF = @ID_SINIF)
				AND ID_KULLANICITIPI = 4

				IF @ID_LISTELEMETIPI = 0	--	TÜMÜ
				BEGIN
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCIV4
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 1	--	DEĞERLENDİRİLENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCIV4 O
						WHERE O.TCKIMLIKNO IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END
				ELSE IF @ID_LISTELEMETIPI = 2	--	DEĞERLENDİRİLMEYENLER
				BEGIN	
					SELECT
					(
						SELECT TCKIMLIKNO, AD, SOYAD FROM #OGRENCIV4 O
						WHERE O.TCKIMLIKNO NOT IN ( 
												--SELECT DP.TCKIMLIKNO FROM DegerlendirmePuan DP 
												--WHERE DP.TCKIMLIKNO = O.TCKIMLIKNO 
												--AND DP.KYE_TCKIMLIKNO = @TCKIMLIKNO
												--AND DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT

												SELECT Dy.TCKIMLIKNO FROM DegerlendirmeYorum Dy 
												WHERE Dy.TCKIMLIKNO = O.TCKIMLIKNO 
												AND Dy.KYE_TCKIMLIKNO = @TCKIMLIKNO
												AND Dy.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT
												AND Dy.TUR = @YORUMTUR
											)
						ORDER BY AD,SOYAD,TCKIMLIKNO
						FOR JSON AUTO
					) AS J
				END		
				
				DROP TABLE #OGRENCIV4		
			END

			IF @ISLEM = 30	--	DEĞERLENDİRME SİL
			BEGIN
				DELETE DP
				FROM DegerlendirmePuan DP
				WHERE DP.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DP.TCKIMLIKNO = @TC_DEGERLENDIRILEN AND DP.KYE_TCKIMLIKNO = @TC_DEGERLENDIREN
				
				SELECT ID_DEGERLENDIRMEYORUM
				INTO #TEMPYORUM
				FROM DegerlendirmeYorum DY
				WHERE DY.ID_DEGERLENDIRMEPERIYOT = @ID_DEGERLENDIRMEPERIYOT AND DY.TCKIMLIKNO = @TC_DEGERLENDIRILEN AND DY.KYE_TCKIMLIKNO = @TC_DEGERLENDIREN

				DELETE YD
				FROM DegerlendirmeYorumDurum YD
				INNER JOIN #TEMPYORUM Y ON Y.ID_DEGERLENDIRMEYORUM = YD.ID_DEGERLENDIRMEYORUM

				DELETE Y
				FROM DegerlendirmeYorum Y 
				WHERE Y.ID_DEGERLENDIRMEYORUM IN (SELECT TY.ID_DEGERLENDIRMEYORUM FROM #TEMPYORUM TY)

				DROP TABLE #TEMPYORUM
			END
		END
	
	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_DemoOgrenci]...';


GO
ALTER procedure [dbo].[sp_DemoOgrenci]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINAVGRUP		INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SINIFS			VARCHAR(MAX)	= NULL,
	@SINIFLAR			VARCHAR(MAX)	= NULL,
	@ID_TKTZEKATURUS	VARCHAR(MAX)	= NULL,
	@ID_TKTSINAV		INT				= NULL,
	@ID_TKTTEST			INT				= NULL,
	@TARIH				Date			= NULL	
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)

	SET @LOGJSON = (
		SELECT	  
			ISLEM				 	= @ISLEM			
			,TCKIMLIKNO			 	= @TCKIMLIKNO		
			,OTURUM				 	= @OTURUM			
			,TC_OGRENCI			 	= @TC_OGRENCI		
			,ID_MENU			 	= @ID_MENU		
			,ID_SUBE			 	= @ID_SUBE		
			,ID_SINAVGRUP		 	= @ID_SINAVGRUP	
			,ID_SINIF			 	= @ID_SINIF		
			,ID_KADEME3			 	= @ID_KADEME3		
			,ID_SINIFS			 	= @ID_SINIFS		
			,SINIFLAR			 	= @SINIFLAR		
			,ID_TKTZEKATURUS	 	= @ID_TKTZEKATURUS
			,ID_TKTSINAV		 	= @ID_TKTSINAV	
			,ID_TKTTEST			 	= @ID_TKTTEST		
			,TARIH				 	= @TARIH			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = NULL, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = NULL, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @ISLEM = 1	--	Demo Öğrenci Listele 
			BEGIN
				SELECT	 [FOTOGRAF]		= ISNULL(R.FOTOGRAF,'')
						,[ADSOYAD]		= K.AD +' '+ K.SOYAD
						,[OGRNO]	= O.OGRNO
						,[SINIF]		= SN.AD
						,[TCKIMLIKNO]	= O.TCKIMLIKNO
						,[OTURUM]		= K.OTURUM
						--,[İŞLEM]		= '<input style="float:right;margin: 10px;" type="button" class="btn btn-success" v-on:click="DemoLogin('+O.TCKIMLIKNO+')" value="Giriş Yap">'
				INTO #DemoOgrenciList
				FROM v3Ogrenci						O
				JOIN OkyanusDB.DBO.v3SubeGrupSinif	S	ON	S.ID_SINIF		= O.ID_SINIF
				JOIN v3Sinif						SN	ON	SN.ID_SINIF		= O.ID_SINIF
				JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.DBO.v3Resim		R	ON	R.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE	(O.ID_SUBE	= @ID_SUBE			OR @ID_SUBE		= 0 )
					AND (O.ID_SINIF = @ID_SINIF			OR @ID_SINIF	= 0 )
					AND (ID_KADEME3 = @ID_KADEME3		OR @ID_KADEME3	= 0 )
					--AND (K.AD		LIKE '%'+@AD+'%'	OR @AD			= '')
					--AND (K.SOYAD	LIKE '%'+@SOYAD+'%'	OR @SOYAD		= '')
				ORDER BY [ADSOYAD]--,[ÖĞRENCİ NO]


				select(
						select * from(
							select 
							(						 
								SELECT * FROM #DemoOgrenciList
								ORDER BY [ADSOYAD]
								FOR JSON AUTO
							) as DemoOgrenciList	
						) as tablo FOR JSON AUTO
					) as tt

				DROP TABLE #DemoOgrenciList

			END

			IF @ISLEM = 2
			BEGIN
			
				select(
						select * from(
							select 
							(						 
								SELECT TCKIMLIKNO,OTURUM FROM OkyanusDB.DBO.v3Kullanici WHERE TCKIMLIKNO = @TC_OGRENCI
								FOR JSON AUTO
							) as DemoOgrenciLogin	
						) as tablo FOR JSON AUTO
					) as tt
				
			END
		
		END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_DersUnite]...';


GO
ALTER procedure [dbo].[sp_DersUnite]
	@TCKIMLIKNO			NVARCHAR(11)	    = NULL,
	@TC_OGRENCI			NVARCHAR(11)	    = '',
	@OTURUM				NVARCHAR(36)	    = NULL,
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					= NULL,
	@ID_KADEME3         INT                 = NULL,
	@ID_DERS            INT                 = NULL,
	@ID_DERSUNITE       INT                 = NULL,
	@ID_KAZANIMDOSYA	INT                 = NULL,
	@AD                 NVARCHAR(250)       = NULL,
	@KOD                NVARCHAR(20)        = NULL,
	@DONEM              NVARCHAR(4)         = NULL,
	@LINKLIST           NVARCHAR(MAX)		= NULL,
	@SQLJSON            NVARCHAR(MAX)		= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

	IF @ID_LOG > 1
	BEGIN
	    IF @ISLEM = 1	--	Sınav Ders Liste		
		BEGIN					
			SELECT d.ID_DERS, d.AD FROM [dbo].[v3SinavDers] d where d.ID_KADEME3=@ID_KADEME3 
	    END
		IF @ISLEM = 2	--	Ders ünite listesi		
		BEGIN	

			SELECT ISNULL((
				SELECT	 D1.ID_DERS
						,D1.ID_DERSUNITE
						,D1.KOD
						,D1.AD
						,LINKLIST = ISNULL((SELECT LINK
											FROM OKYANUSDB.DBO.v3SinavDersUniteLink L
											WHERE	L.KOD	= D1.KOD
												AND L.AKTIF = 1
											FOR JSON PATH, INCLUDE_NULL_VALUES
										),'[{"LINK":""}]')
						,DOSYASAYISI = (SELECT COUNT(1) FROM KazanimDosya KD WHERE KD.KOD = D1.KOD AND KD.AKTIF = 1)
				FROM v3SinavDersUnite		D1
				inner join v3SinavDers		SD  ON SD.ID_DERS = D1.ID_DERS
				WHERE SD.ID_KADEME3=@ID_KADEME3 AND  D1.ID_DERS = @ID_DERS AND D1.AKTIF=1
				ORDER BY d1.KOD
				FOR JSON PATH, INCLUDE_NULL_VALUES
			),'[]')


		END
		IF @ISLEM = 3	--	unite silme				
		BEGIN		
			
			IF EXISTS (select TOP 1 1 from OKYANUSDB.DBO.v3SinavDersUnite U JOIN SinavAnahtar SA ON SA.KOD=U.KOD where ID_DERSUNITE=@ID_DERSUNITE)
			BEGIN
				RAISERROR ('Daha önce bir sınavda kullanıldığı için silinemez' , -- Message text.
				16, -- Severity.
				1-- State.
				);
			END
			ELSE
			BEGIN
				DELETE OKYANUSDB.DBO.v3SinavDersUnite
				WHERE ID_DERSUNITE=@ID_DERSUNITE			
			END



			--Update OKYANUSDB.DBO.v3SinavDersUnite SET AKTIF=0  where  ID_DERSUNITE=@ID_DERSUNITE AND 
		END
	    IF @ISLEM = 4	--	unite detay				
		BEGIN		
			select * from OKYANUSDB.DBO.v3SinavDersUnite where ID_DERSUNITE=@ID_DERSUNITE
		END
	    IF @ISLEM = 5	--	unite güncelle			
		BEGIN		
			
			UPDATE OKYANUSDB.DBO.v3SinavDersUnite
			SET AD= @AD--, KOD = @KOD
			WHERE ID_DERSUNITE=@ID_DERSUNITE

			SET @KOD = ( SELECT KOD FROM OKYANUSDB.DBO.v3SinavDersUnite WHERE ID_DERSUNITE = @ID_DERSUNITE )
			
			UPDATE OKYANUSDB.DBO.v3SinavDersUniteLink SET
				AKTIF = 0 
			WHERE KOD = @KOD

			INSERT INTO  OKYANUSDB.DBO.v3SinavDersUniteLink (KOD, LINK, KYE_TCKIMLIKNO) 
			SELECT @KOD, LINK, @TCKIMLIKNO FROM OPENJSON(@LINKLIST) WITH (LINK VARCHAR(MAX))


		END
		IF @ISLEM = 6	--	unite ekle				
		BEGIN
			
			IF EXISTS (select TOP 1 1 from OKYANUSDB.DBO.v3SinavDersUnite  where KOD=@KOD)
			BEGIN
				RAISERROR ('Bu kod daha önce eklenmiştir.' , -- Message text.
				16, -- Severity.
				1-- State.
				);
			END
			ELSE
			BEGIN
				INSERT INTO  OKYANUSDB.DBO.v3SinavDersUnite (ID_DERS, KOD, AD) values (@ID_DERS, @KOD, @AD)		

				UPDATE OKYANUSDB.DBO.v3SinavDersUniteLink SET
					AKTIF = 0 
				WHERE KOD = @KOD

				INSERT INTO  OKYANUSDB.DBO.v3SinavDersUniteLink (KOD, LINK, KYE_TCKIMLIKNO) 
				SELECT @KOD, LINK, @TCKIMLIKNO FROM OPENJSON(@LINKLIST) WITH (LINK VARCHAR(MAX))

			END

		END
		IF @ISLEM = 7	--	Genel Ders Liste		
		BEGIN
		
			IF EXISTS (SELECT TOP 1 1 FROM v3AktifDonem WHERE DONEM=@DONEM)
			BEGIN
				DECLARE @SIRA INT=	(SELECT SIRA FROM v3Kademe3 WHERE ID_KADEME3 =  @ID_KADEME3 )
				SET @ID_KADEME3 =	(SELECT ID_KADEME3 FROM v3Kademe3 WHERE SIRA=@SIRA  - (CAST((SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1) AS INT) - CAST(@DONEM AS INT)))
			END
			

			IF @ID_KADEME3 IS NULL OR @ID_KADEME3=0
			BEGIN
				SELECT ID_KADEME3 INTO #KADEME3 FROM v3KullaniciKademe3 WHERE TCKIMLIKNO=@TCKIMLIKNO
				
					SELECT SD.ID_DERS, SD.AD 
					FROM v3SinavDers				SD
					INNER JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = SD.ID_DERS
					WHERE	SD.ID_KADEME3 IN (SELECT ID_KADEME3 FROM #KADEME3)		
						AND D.AKTIF = 1 
						AND D.SNVDERS = 1
				UNION 
					SELECT D.ID_DERS,D.DERSAD 
					FROM eokul_v2.dbo.Ders			 D
					JOIN eokul_v2.dbo.DersEgitimTuru E ON E.ID_DERS = D.ID_DERS
					WHERE E.ID_EGITIMTURU = 6 -- YAZILI
						AND D.AKTIF =1 
						AND D.SNVDERS = 1
						AND d.ID_KADEME3 IN (SELECT ID_KADEME3 FROM #KADEME3)	
				ORDER BY AD					
			END
			ELSE
			BEGIN
					SELECT SD.ID_DERS, SD.AD 
					FROM v3SinavDers				SD
					INNER JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = SD.ID_DERS	
					where d.ID_KADEME3 = @ID_KADEME3 
						AND D.AKTIF = 1 
						AND D.SNVDERS = 1
				UNION
					SELECT D.ID_DERS,D.DERSAD 
					FROM eokul_v2.dbo.Ders			 D
					JOIN eokul_v2.dbo.DersEgitimTuru E ON E.ID_DERS = D.ID_DERS
					WHERE E.ID_EGITIMTURU = 6 -- YAZILI
						AND D.AKTIF =1 
						AND d.ID_KADEME3 = @ID_KADEME3
						AND D.SNVDERS = 1
				ORDER BY AD
			END
			
			DROP TABLE IF EXISTS #KADEME3	
		END
		IF @ISLEM = 8	--	UNITE EKLE EXCEL		
		BEGIN
			DROP TABLE IF EXISTS #JSEXEL
			DROP TABLE IF EXISTS #UNITE_VAR
			DROP TABLE IF EXISTS #UNITE_YOK

			SELECT KOD,AD	INTO #JSEXEL	FROM OPENJSON(@SQLJSON) WITH(KOD VARCHAR(MAX), AD VARCHAR(MAX)) JS 			
			SELECT JS.*		INTO #UNITE_VAR FROM OKYANUSDB.DBO.v3SinavDersUnite DU JOIN #JSEXEL JS ON JS.KOD = DU.KOD
			SELECT *		INTO #UNITE_YOK FROM #JSEXEL JS where JS.KOD NOT IN (SELECT DISTINCT V.KOD FROM #UNITE_VAR V)

			IF EXISTS (SELECT TOP 1 1 FROM #UNITE_YOK)
			BEGIN

				INSERT INTO OkyanusDB.dbo.v3SinavDersUnite (ID_DERS,KOD,AD,AKTIF)
				SELECT @ID_DERS, KOD, AD, 1 FROM #UNITE_YOK
					
			END

			IF EXISTS (SELECT TOP 1 1 FROM #UNITE_VAR)
			BEGIN

				UPDATE U SET
					U.AD = V.AD
				FROM OkyanusDB.dbo.v3SinavDersUnite U
				JOIN #UNITE_VAR V ON V.KOD = U.KOD

				--DECLARE @EKLENECEKLER INT = (SELECT COUNT(1) FROM #UNITE_YOK)
				--DECLARE @HATAMETNI VARCHAR(MAX) = 'Excel tablosundaki kodların tümü daha önce eklendiği için işlem yapılmamıştır.'
				--IF @EKLENECEKLER > 0
				--BEGIN
				--	SET @HATAMETNI = CAST(@EKLENECEKLER AS varchar)+' Adet ünite eklenmiştir. Aşağıdaki kodlar daha önce eklendiği için işlem yapılmamıştır.<br><br>'+(SELECT (SELECT STUFF((SELECT   '<br>' +CAST(K.KOD AS VARCHAR)	FROM #UNITE_VAR K ORDER BY KOD FOR XML PATH(''), TYPE).value('.', 'VARCHAR(MAX)'), 1, 4, '')))
				--END
								
				----SELECT @HATAMETNI
				--RAISERROR (@HATAMETNI , -- Message text.
				--16, -- Severity.
				--1-- State.
				--);
			END
			
			

			
			DROP TABLE IF EXISTS #JSEXEL
			DROP TABLE IF EXISTS #UNITE_VAR
			DROP TABLE IF EXISTS #UNITE_YOK
		END
		IF @ISLEM = 9	--	Derse ait Uniteleri Sil	
		BEGIN

				DELETE FROM OKYANUSDB.DBO.v3SinavDersUnite
				WHERE KOD NOT IN (
					select SA.KOD 
					from SinavAnahtar SA
				) AND ID_DERS = @ID_DERS

			SELECT 1

		END
	    IF @ISLEM = 10	--	YAZILI Ders Liste		
		BEGIN	
			SELECT d.ID_DERS, ED.DERSAD AD 
			FROM [dbo].[v3SinavDers] d
			JOIN eokul_v2.dbo.Ders	ED ON ED.ID_DERS = d.ID_DERS
			where d.ID_KADEME3=@ID_KADEME3 			
				AND ED.AKTIF =1 
				AND ED.SNVDERS = 1
			UNION 
			SELECT D.ID_DERS,D.DERSAD 
			FROM eokul_v2.dbo.Ders			 D
			JOIN eokul_v2.dbo.DersEgitimTuru E ON E.ID_DERS = D.ID_DERS
			WHERE E.ID_EGITIMTURU = 6 -- YAZILI
				AND D.AKTIF =1 
				AND d.ID_KADEME3=@ID_KADEME3 
				AND D.SNVDERS = 1
			ORDER BY AD
	    END
	    IF @ISLEM = 11	--	Sınav Ders Liste		
		BEGIN
			SELECT	DISTINCT DAK.ID_DERS
					,[Sınıf Düzeyi]		= K.AD 
					,[Ders Adı]			= D.AD

					,[Ünite Kodu]		= DU.KOD	
					,[Ünite Adı]		= DU.AD 
					
					,[Konu Kodu]		= DK.KOD	
					,[Konu Adı]			= DK.AD 
					
					,[Alt Konu Kodu]	= DAK.KOD	
					,[Alt Konu Adı]		= DAK.AD 

			FROM v3SinavDersUnite		DAK
			inner join v3SinavDers		SD  ON SD.ID_DERS	= DAK.ID_DERS
			inner join v3Ders			D	ON D.ID_DERS	= DAK.ID_DERS
			inner join v3Kademe3		K	ON K.ID_KADEME3 = SD.ID_KADEME3

			INNER JOIN v3SinavDersUnite DU	ON	DU.KOD		= SUBSTRING(DAK.KOD,1,6)
			INNER JOIN v3SinavDersUnite DK	ON	DK.KOD		= SUBSTRING(DAK.KOD,1,9)

			WHERE SD.ID_KADEME3=@ID_KADEME3 AND  DAK.ID_DERS = @ID_DERS AND DAK.AKTIF=1 AND LEN(DAK.KOD) = 12
			ORDER BY DAK.KOD
	    END
		IF @ISLEM = 12	--	UNITE LINK EXCEL		
		BEGIN
			DROP TABLE IF EXISTS #JSEXEL12

			SELECT KOD, LINK
			INTO #JSEXEL12	
			FROM OPENJSON(@SQLJSON) 
			WITH(KOD VARCHAR(MAX), LINK VARCHAR(MAX)) 
					
			UPDATE L SET
				L.AKTIF = 0 
			FROM OkyanusDB.DBO.v3SinavDersUniteLink L
			JOIN OkyanusDB.DBO.v3SinavDersUnite		U	ON	U.KOD	= L.KOD
			JOIN #JSEXEL12							J	ON	J.KOD	= U.KOD			
			WHERE U.ID_DERS	= @ID_DERS

			INSERT INTO OkyanusDB.DBO.v3SinavDersUniteLink (KOD, LINK, KYE_TCKIMLIKNO)
			SELECT J.KOD, LINK, @TCKIMLIKNO 
			FROM #JSEXEL12						J			
			JOIN OkyanusDB.DBO.v3SinavDersUnite	U	ON	U.KOD	= J.KOD	
			WHERE U.ID_DERS	= @ID_DERS

			
			DROP TABLE IF EXISTS #JSEXEL12
		END
		IF @ISLEM = 13	--	UNITE DOSYA LISTE		
		BEGIN

			SELECT ISNULL((
				SELECT ID_KAZANIMDOSYA, KOD, GUID
				FROM KazanimDosya
				WHERE	KOD		= @KOD
					AND AKTIF	= 1
				FOR JSON PATH
			),'[]')

		END
		IF @ISLEM = 14	--	UNITE DOSYA PASIF		
		BEGIN

			UPDATE KazanimDosya SET
				AKTIF = 0 
			WHERE ID_KAZANIMDOSYA = @ID_KAZANIMDOSYA

		END
		IF @ISLEM = 15	--	UNITE DOSYA EKLE		
		BEGIN

			DECLARE @GUID_DOSYA VARCHAR(36) = NEWID()
			DECLARE @TABLEADD15 TABLE (ID_KAZANIMDOSYA INT)
			
			WHILE EXISTS(SELECT TOP 1 1 FROM KazanimDosya D WHERE D.GUID = @GUID_DOSYA)
			BEGIN
				SET @GUID_DOSYA = NEWID()
			END

			INSERT INTO KazanimDosya (KOD, GUID, KYE_TCKIMLIKNO)
			OUTPUT inserted.ID_KAZANIMDOSYA INTO @TABLEADD15(ID_KAZANIMDOSYA)
			VALUES (@KOD, @GUID_DOSYA, @TCKIMLIKNO)

			SELECT	 GUID				= @GUID_DOSYA
					,ID_KAZANIMDOSYA	= (SELECT TOP 1 ID_KAZANIMDOSYA FROM @TABLEADD15)
			FOR JSON PATH


		END
	END
END TRY
BEGIN CATCH	
	DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Dokuman]...';


GO
ALTER procedure [dbo].[sp_Dokuman]
	@TCKIMLIKNO			VARCHAR(11)			= NULL,
	@OTURUM				VARCHAR(36)			= NULL,
	@ISLEM				INT					= NULL,
	@ID_MENU			INT					= NULL,
	@ID_DOKUMAN			INT					= NULL,
	@ID_DOKUMANTUR		INT					= NULL,
	@ID					INT					= NULL,--İlişkili tablonun birincil anahtarı (etkinlik, mesaj...)
	@DOSYAAD			VARCHAR(250)		= NULL,
	@DOSYAUZANTI		VARCHAR(5)			= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT 
			TCKIMLIKNO			= @TCKIMLIKNO		
			,OTURUM				= @OTURUM			
			,ISLEM				= @ISLEM			
			,ID_MENU			= @ID_MENU		
			,ID_DOKUMAN			= @ID_DOKUMAN		
			,ID_DOKUMANTUR		= @ID_DOKUMANTUR	
			,ID					= @ID				
			,DOSYAAD			= @DOSYAAD		
			,DOSYAUZANTI		= @DOSYAUZANTI	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 

	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1 --Döküman Ekle
		BEGIN
			--VARSA SİL UPGRADE--
			DECLARE @ID_DOKUMANTEMP INT = (SELECT ID_DOKUMAN FROM DokumanDetay WHERE ID = @ID)	
			DELETE DD 
			FROM DokumanDetay DD
			INNER JOIN Dokuman D ON D.ID_DOKUMAN = DD.ID_DOKUMAN
			WHERE DD.ID = @ID AND D.ID_DOKUMANTUR=1
			DELETE FROM Dokuman WHERE ID_DOKUMAN = @ID_DOKUMANTEMP AND ID_DOKUMANTUR=1
			--VARSA SİL UPGRADE--

			DECLARE @ID_DOKUMANLIST TABLE (ID_DOKUMAN INT)

			INSERT INTO Dokuman (ID_DOKUMANTUR,DOSYAAD,DOSYAUZANTI,KYE_KULLANICI)
			OUTPUT INSERTED.ID_DOKUMAN INTO @ID_DOKUMANLIST(ID_DOKUMAN)
			VALUES (@ID_DOKUMANTUR,@DOSYAAD,@DOSYAUZANTI,@TCKIMLIKNO)

			INSERT INTO DokumanDetay(ID_DOKUMAN, ID) VALUES((select TOP 1 ID_DOKUMAN from @ID_DOKUMANLIST), @ID)
		END

		IF @ISLEM = 2 --Dokuman Listele
		BEGIN

			SELECT ID_DOKUMAN
				  ,ID_DOKUMANTUR
				  ,DOKUMANTUR
				  ,DOSYAAD
				  ,DOSYAUZANTI
				  ,ID
				  ,KYE_KULLANICI
				  ,KYE_TARIH
			  FROM dbo.vw_Dokuman
			  WHERE
				(@ID IS NULL OR @ID=0 OR ID=@ID) AND
				(@ID_DOKUMAN IS NULL OR @ID_DOKUMAN=0 OR ID_DOKUMAN=@ID_DOKUMAN) AND
				(@ID_DOKUMANTUR IS NULL OR @ID_DOKUMANTUR=0 OR ID_DOKUMANTUR=@ID_DOKUMANTUR) 
			  ORDER BY KYE_TARIH Desc
		END


	END
END TRY
BEGIN CATCH	
	DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Donem]...';


GO
ALTER procedure [dbo].[sp_Donem]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM				 	=	@ISLEM		
			,TCKIMLIKNO			 	=	@TCKIMLIKNO	
			,OTURUM				 	=	@OTURUM		
			,ID_MENU			 	=	@ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY  
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 

	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	DONEM Listele
		BEGIN
			SELECT * FROM [dbo].[v3AktifDonem]
			ORDER BY AKTIF DESC,DONEM DESC
		END
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2

	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_EtutProgramiOV]...';


GO
ALTER procedure [dbo].[sp_EtutProgramiOV]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= '',
	@AKTIFDONEM			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@KOD				VARCHAR(MAX)	= '',
	@ETUT				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@SAAT				VARCHAR(MAX)	= NULL,
	@SURE				VARCHAR(MAX)	= NULL,	
	@YER				VARCHAR(MAX)	= NULL,	
	@ID_ETUTTURU		INT				= NULL,
	@TC_OGRENCIs		VARCHAR(MAX)	= NULL,		
	@KODs				VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ETUTJSON			VARCHAR(MAX)	= NULL,
	@BAS_TARIH			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@KATILDI			BIT				= 0,
	@KATILACAK			BIT				= 0




	--ETUT,TARIH,SAAT,SURE,ID_SUBE,YER,ID_DERS,DONEM,AKTIF,KYE_TCKIMLIKNO,ID_KADEME3,TC_OGRETMEN,ID_ETUTTURU
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,AKTIFDONEM					= @AKTIFDONEM		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,ID_SINAVs					= @ID_SINAVs		
			,KOD						= @KOD			
			,ETUT						= @ETUT			
			,TARIH						= @TARIH			
			,SAAT						= @SAAT			
			,SURE						= @SURE			
			,YER						= @YER			
			,ID_ETUTTURU				= @ID_ETUTTURU	
			,TC_OGRENCIs				= @TC_OGRENCIs	
			,KODs						= @KODs			
			,DERSAD						= @DERSAD			
			,ETUTJSON					= @ETUTJSON		
			,BAS_TARIH					= @BAS_TARIH		
			,ID_ETUT					= @ID_ETUT		
			,KATILDI					= @KATILDI		
			,KATILACAK					= @KATILACAK		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY  
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	 
	

	IF @ID_LOG > 1
	BEGIN
		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		
		SELECT @AKTIFDONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		PRINT @DONEM
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
			PRINT @DONEM
		END

		IF @ISLEM = 1	--	SABİT ETÜT LİSTESİ				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										  TC_OGRETMEN	
										 ,D.ID_DERS	
										 ,ID_GUN		
										 ,DERSSAAT	
										 ,O.ID_SINIF	
										 ,KYE_TCKIMLIKNO
										 ,ADSOYAD		= K.AD+' '+K.SOYAD
										 ,D.DERSAD
								FROM EtutSabit			ES
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = ES.TC_OGRETMEN
								JOIN eokul_v2.DBO.Ders	D	ON	D.ID_DERS	 = ES.ID_DERS
								JOIN v3Ogrenci			O	ON	O.ID_SINIF	 = ES.ID_SINIF								
								WHERE O.TCKIMLIKNO =@TC_OGRENCI
								ORDER BY ID_GUN,DERSSAAT
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
				
		IF @ISLEM = 2	--	SINAV ETÜT LİSTESİ				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT  DISTINCT
									 E.ID_ETUT
									,E.ETUT
									,YER									
									,D.DERSAD
									,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
									,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
									,ADSOYAD	= K.AD+' '+ K.SOYAD									
									,SAAT
									,CASE WHEN GETDATE()>CAST(TARIH AS datetime) THEN EO.KATILDI ELSE NULL END KATILDI 
								FROM Etut				E
								JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
								JOIN EtutOgrenci		EO	ON	EO.ID_ETUT	= E.ID_ETUT
								WHERE	EO.TC_OGRENCI	= @TC_OGRENCI
									AND DONEM			= @DONEM
									AND E.AKTIF			= 1																		
								ORDER BY ADSOYAD,DERSAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END
						
		IF @ISLEM = 3	--	SINAV ETÜT GRAFİĞİ				
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT COUNT(1) TOPLAMETUTSAYISI
									, (SELECT COUNT(1) FROM EtutOgrenci O WHERE O.ID_ETUT_OGRENCI = EO.ID_ETUT_OGRENCI AND O.AKTIF=1 AND O.KATILDI = 1)  KATILIMSAYISI
								FROM Etut			E
								JOIN EtutOgrenci	EO	ON	EO.ID_ETUT	= E.ID_ETUT
								WHERE	EO.TC_OGRENCI = @TC_OGRENCI
									AND	GETDATE()>CAST(TARIH AS datetime) 
								GROUP BY EO.ID_ETUT_OGRENCI
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_EtutSabitOlustur]...';


GO
ALTER procedure [dbo].[sp_EtutSabitOlustur]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIF			INT				= NULL,
	@ETUTLIST			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0


AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,TC_OGRENCI					= @TC_OGRENCI	
			,TC_OGRETMEN				= @TC_OGRETMEN
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,DONEM						= @DONEM		
			,ID_SINIF					= @ID_SINIF	
			,ETUTLIST					= @ETUTLIST	
			,ID_ETUT					= @ID_ETUT	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
 
	IF @ID_LOG > 1
	BEGIN
		
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		END

		IF @ISLEM = 1	--	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										 K.AD+' '+K.SOYAD ADSOYAD
										,D.DERSAD
										,k.TCKIMLIKNO
										,D.ID_DERS
								FROM eokul_v2.dbo.DersOgretmen	DO
								JOIN eokul_v2.dbo.Ders			D	ON	D.ID_DERS	= DO.ID_DERS
								JOIN v3Kullanici				K	ON	K.TCKIMLIKNO= DO.TC_OGRETMEN
								WHERE DO.ID_SINIF = @ID_SINIF
								ORDER BY ADSOYAD
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
		IF @ISLEM = 2
		BEGIN
			delete from EtutSabit
			where ID_SINIF = @ID_SINIF

			INSERT INTO EtutSabit (TC_OGRETMEN,ID_DERS,ID_GUN,DERSSAAT,ID_SINIF,KYE_TCKIMLIKNO)
			SELECT
				 TC_OGRETMEN= JSON_VALUE(J.VALUE,'$.NESNE.TCKIMLIKNO')		
				,ID_DERS	= JSON_VALUE(J.VALUE,'$.NESNE.ID_DERS')	
				,GUN		= JSON_VALUE(J.VALUE,'$.NESNE.GUN')		
				,DERSSAAT	= JSON_VALUE(J.VALUE,'$.NESNE.DERSSAAT')	
				,ID_SINIF	= @ID_SINIF 
				,TCKIMLIKNO	= @TCKIMLIKNO
				FROM OPENJSON (@ETUTLIST) AS J
			WHERE JSON_VALUE(J.VALUE,'$.NESNE.ID_DERS')>0
			 			 
			SELECT 1 
		END
		IF @ISLEM = 3	--	
		BEGIN
				select(
						select * from(
							select 
							(	
								SELECT DISTINCT
										  TC_OGRETMEN	
										 ,D.ID_DERS	
										 ,ID_GUN		
										 ,DERSSAAT	
										 ,ID_SINIF	
										 ,KYE_TCKIMLIKNO
										 ,ADSOYAD		= K.AD+' '+K.SOYAD
										 ,D.DERSAD
								FROM EtutSabit			ES
								JOIN v3Kullanici		K	ON	K.TCKIMLIKNO = ES.TC_OGRETMEN
								JOIN eokul_v2.DBO.Ders	D	ON	D.ID_DERS	 = ES.ID_DERS
								WHERE ID_SINIF = @ID_SINIF
								ORDER BY ID_GUN,DERSSAAT
								FOR JSON PATH
							) as LISTE												
						) as tablo FOR JSON PATH
					) as tt
		END
		
			
		
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_EtutSinifRapor]...';


GO
ALTER procedure [dbo].[sp_EtutSinifRapor]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@DONEM				VARCHAR(4)		= NULL,
	@BASLANGIC_TARIH	VARCHAR(25)		= NULL,
	@BITIS_TARIH		VARCHAR(25)		= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM				 	= @ISLEM			
			,TCKIMLIKNO			 	= @TCKIMLIKNO		
			,OTURUM				 	= @OTURUM			
			,ID_MENU			 	= @ID_MENU		
			,ID_SINIF			 	= @ID_SINIF		
			,TC_OGRETMEN		 	= @TC_OGRETMEN	
			,DONEM				 	= @DONEM			
			,BASLANGIC_TARIH	 	= @BASLANGIC_TARIH
			,BITIS_TARIH		 	= @BITIS_TARIH	
			,SQLJSON			 	= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		SET @DONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)

		IF @ISLEM = 1	--	ETÜT SINIF LIST
		BEGIN
		
			DROP TABLE IF EXISTS #LISTE
			DROP TABLE IF EXISTS #OGRETMENETUTLERI
			DROP TABLE IF EXISTS #OGRETMENLIST
			
			SELECT DISTINCT O.TCKIMLIKNO, O.BRANS, ADSOYAD = K.AD + ' ' + K.SOYAD
			INTO #OGRETMENLIST
			FROM eokul_v2.dbo.DersOgretmen	DO
			JOIN OkyanusDB.dbo.v3Ogretmen	O	ON	O.TCKIMLIKNO	= DO.TC_OGRETMEN
			JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
			WHERE	DO.ID_SINIF = @ID_SINIF
				AND DONEMKOD = @DONEM
		UNION	
			SELECT DISTINCT O.TCKIMLIKNO,O.BRANS, ADSOYAD = K.AD + ' ' + K.SOYAD
			FROM OkyanusDB.dbo.v3DersProgram	DP
			JOIN OkyanusDB.dbo.v3Ogretmen		O	ON	O.TCKIMLIKNO	= DP.TCKIMLIKNO
			JOIN v3Kullanici					K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO	
			WHERE	DP.ID_SINIF = @ID_SINIF
	
			SELECT DISTINCT E.TC_OGRETMEN, E.ID_ETUT, CAST( E.SURE AS INT) SURE
			INTO #OGRETMENETUTLERI
			FROM Etut			E	  
			JOIN EtutOgrenci	EO	ON	EO.ID_ETUT		= E.ID_ETUT
			JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= EO.TC_OGRENCI
			WHERE	O.ID_SINIF		= @ID_SINIF
				AND CAST(E.TARIH AS date) >= CAST(@BASLANGIC_TARIH AS date)
				AND CAST(E.TARIH AS date) <= CAST(@BITIS_TARIH	   AS date)
	
			DECLARE @SUBEAD VARCHAR(100),@SINIFAD VARCHAR(100)

			SELECT @SUBEAD = SB.AD, @SINIFAD = SN.AD FROM OkyanusDB.dbo.v3SubeGrupSinif GS 
			JOIN v3Sube	SB ON SB.ID_SUBE = GS.ID_SUBE 
			JOIN v3Sinif SN	ON SN.ID_SINIF = GS.ID_SINIF
			WHERE GS.ID_SINIF = @ID_SINIF
	
			SELECT	 TC_OGRETMEN= OL.TCKIMLIKNO
					,ADSOYAD	= OL.ADSOYAD
					,BRANS		= OL.BRANS
					,SUBEAD		= @SUBEAD
					,SINIFAD	= @SINIFAD
					,SURE		= ISNULL(SUM(OE.SURE),0) 
			INTO #LISTE
			FROM #OGRETMENLIST			OL
			LEFT JOIN #OGRETMENETUTLERI	OE	ON	OE.TC_OGRETMEN	= OL.TCKIMLIKNO
			GROUP BY OL.TCKIMLIKNO, OL.BRANS, OL.ADSOYAD


				select(
						select * from(
							select 
							(	
								SELECT * FROM #LISTE
								ORDER BY ADSOYAD
								FOR JSON PATH,INCLUDE_NULL_VALUES
							) as LISTE												
						) as tablo FOR JSON PATH,INCLUDE_NULL_VALUES
					) as tt
					
			DROP TABLE IF EXISTS #LISTE
			DROP TABLE IF EXISTS #OGRETMENETUTLERI
			DROP TABLE IF EXISTS #OGRETMENLIST
		END

		IF @ISLEM = 2	--	ETÜT ÖĞRETMEN DETAY
		BEGIN
			SELECT (
				SELECT * FROM (
					SELECT (
						SELECT DISTINCT
							 E.ID_ETUT
							,E.ETUT
							,ETUT_TARIH = CONVERT(varchar(MAX), E.TARIH,104) +' '+E.SAAT 
							,E.YER
							,SURE
							--,ISNULL(EU.KOD,'')KOD
							, (SELECT U.AD UNITE FROM EtutUnite EU JOIN v3SinavDersUnite U ON U.KOD = EU.KOD WHERE EU.ID_ETUT = E.ID_ETUT  FOR JSON AUTO)  AS 'EU'
							,E.TARIH
						FROM Etut					E
						JOIN EtutOgrenci			EO	ON	EO.ID_ETUT		= E.ID_ETUT
						JOIN v3Ogrenci				O	ON	O.TCKIMLIKNO	= EO.TC_OGRENCI
						--LEFT JOIN EtutUnite			EU	ON	EU.ID_ETUT		= E.ID_ETUT
						--LEFT JOIN v3SinavDersUnite	U	ON	U.KOD			= EU.KOD
						WHERE	O.ID_SINIF		= @ID_SINIF
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND CAST(E.TARIH AS date) >= CAST(@BASLANGIC_TARIH AS date)
							AND CAST(E.TARIH AS date) <= CAST(@BITIS_TARIH	   AS date)
						ORDER BY E.TARIH
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS UNITELISTE ,
					(	
						SELECT DISTINCT  
							 E.ID_ETUT
							,EO.TC_OGRENCI
							,EO.KATILDI
							,ADSOYAD = K.AD + ' ' + K.SOYAD
						FROM Etut			E
						JOIN EtutOgrenci	EO	ON	EO.ID_ETUT		= E.ID_ETUT
						JOIN v3Ogrenci		O	ON	O.TCKIMLIKNO	= EO.TC_OGRENCI
						JOIN v3Kullanici	K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
						WHERE	O.ID_SINIF		= @ID_SINIF
							AND E.TC_OGRETMEN	= @TC_OGRETMEN
							AND CAST(E.TARIH AS date) >= CAST(@BASLANGIC_TARIH AS date)
							AND CAST(E.TARIH AS date) <= CAST(@BITIS_TARIH	   AS date)
						FOR JSON AUTO, INCLUDE_NULL_VALUES
					) AS OGRENCILISTE
				) AS XX	
				FOR JSON AUTO, INCLUDE_NULL_VALUES
			) AS X
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_EtutTakvimi]...';


GO
ALTER procedure [dbo].[sp_EtutTakvimi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= '',
	@AKTIFDONEM			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@KOD				VARCHAR(MAX)	= '',
	@ETUT				VARCHAR(MAX)	= NULL,
	@TARIH				VARCHAR(MAX)	= NULL,
	@SAAT				VARCHAR(MAX)	= NULL,
	@SURE				VARCHAR(MAX)	= NULL,	
	@YER				VARCHAR(MAX)	= NULL,	
	@ID_ETUTTURU		INT				= NULL,
	@TC_OGRENCIs		VARCHAR(MAX)	= NULL,		
	@KODs				VARCHAR(MAX)	= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@ETUTJSON			VARCHAR(MAX)	= NULL,
	@BAS_TARIH			VARCHAR(MAX)	= NULL,
	@ID_ETUT			INT				= 0,
	@KATILDI			BIT				= 0,
	@OGRETMEN			BIT				= 0,
	@SABITETUT			BIT				= 0




	--ETUT,TARIH,SAAT,SURE,ID_SUBE,YER,ID_DERS,DONEM,AKTIF,KYE_TCKIMLIKNO,ID_KADEME3,TC_OGRETMEN,ID_ETUTTURU
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,AKTIFDONEM					= @AKTIFDONEM		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINIFs					= @ID_SINIFs		
			,ID_DERSs					= @ID_DERSs		
			,ID_SINAVs					= @ID_SINAVs		
			,KOD						= @KOD			
			,ETUT						= @ETUT			
			,TARIH						= @TARIH			
			,SAAT						= @SAAT			
			,SURE						= @SURE			
			,YER						= @YER			
			,ID_ETUTTURU				= @ID_ETUTTURU	
			,TC_OGRENCIs				= @TC_OGRENCIs	
			,KODs						= @KODs			
			,DERSAD						= @DERSAD			
			,ETUTJSON					= @ETUTJSON		
			,BAS_TARIH					= @BAS_TARIH		
			,ID_ETUT					= @ID_ETUT		
			,KATILDI					= @KATILDI		
			,OGRETMEN					= @OGRETMEN		
			,SABITETUT					= @SABITETUT		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	

	IF @ID_LOG > 1
	BEGIN
		
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		
		SELECT @AKTIFDONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
		PRINT @DONEM
		IF @DONEM='' OR @DONEM = NULL
		BEGIN
			SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
			PRINT @DONEM
		END

						
		IF @ISLEM = 1	--	ETÜT TAKVİMİ					
		BEGIN
				
			DECLARE @DATE DATE = CONVERT(DATE, @BAS_TARIH, 104), @FIRSTDAY DATE, @LASTDAY DATE, @FIRSTWEEKDAY INT, @LASTWEEKDAY INT, @STARTDATE DATETIME, @ENDDATE DATETIME

			DROP TABLE IF EXISTS #DateList

			SELECT @FIRSTDAY = DATEADD(MONTH, DATEDIFF(MONTH, 0, @DATE), 0)
			SELECT @LASTDAY  = DATEADD(S, -1, DATEADD(MM, DATEDIFF(M, 0, @DATE) + 1, 0))

			SELECT @FIRSTWEEKDAY = DATEPART(DW, @FIRSTDAY)
			SELECT @LASTWEEKDAY  = DATEPART(DW, @LASTDAY)


			SELECT @STARTDATE = DATEADD(DAY, DATEDIFF(DAY, @FIRSTWEEKDAY - 1	, @FIRSTDAY), 0)
			SELECT @ENDDATE	  = DATEADD(DAY, DATEDIFF(DAY, -(7 - @LASTWEEKDAY)	, @LASTDAY ), 0)

			;WITH DateList
			AS
			(
			SELECT @STARTDATE [Date]
			UNION ALL
			SELECT [Date] + 1 FROM DateList WHERE [Date] < @ENDDATE
			)
			SELECT [Date] = CAST([Date] AS DATE) INTO #DateList FROM DateList option (maxrecursion 0);

			IF @TC_OGRETMEN = '' OR @TC_OGRETMEN IS NULL
			BEGIN
				SELECT
			(
				SELECT 
					CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
					,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
					,GUN	= DAY(Date)
					,YIL	= YEAR(Date)
					,GUNAD	= DATENAME(DW, Date) 
					,AYAD	= DATENAME(MONTH, Date)
					,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
					,(
						SELECT * FROM (
								SELECT DISTINCT
									 E.ETUT								AS 'AD'
									,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BAS_TARIH'
									,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BIT_TARIH'
									,'#5C9BD1'							AS 'RENK'
									,E.ID_ETUT							AS 'ID_ETUT'
									,0									AS 'SABITETUT'				
									FROM Etut			E
									JOIN EtutOgrenci	EO	ON	EO.ID_ETUT = E.ID_ETUT
									WHERE	E.AKTIF		= 1
										AND EO.AKTIF	= 1
										AND TC_OGRENCI	= @TC_OGRENCI
										AND CONVERT(date,E.TARIH)	= CONVERT(date,DL.DATE)
							UNION ALL
								SELECT DISTINCT
									 D.DERSAD												AS 'AD'
									,CONVERT(VARCHAR(10), E.KYE_TARIH, 104)					AS 'BAS_TARIH'
									,CONVERT(VARCHAR(10), DATEADD(YEAR,1,E.KYE_TARIH), 104)	AS 'BIT_TARIH'
									,'#E43A45'												AS 'RENK'
									,E.ID_ETUTSABIT											AS 'ID_ETUT'
									,1														AS 'SABITETUT'				
									FROM EtutSabit			E		
									JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = E.ID_DERS	
									JOIN v3Ogrenci			O	ON	O.ID_SINIF= E.ID_SINIF			
									WHERE	E.ID_GUN	=DATEPART(weekday,CONVERT(date,DL.DATE)) 
										AND O.TCKIMLIKNO=@TC_OGRENCI

						) AS SS
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)AS 'Liste'
				FROM		#DateList		DL
				ORDER BY DL.Date ASC
				FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS J
			END
			ELSE
			BEGIN
				SELECT
				(
					SELECT 
						CONVERT(VARCHAR(10), DL.Date, 104)		AS 'TARIH'
						,CONVERT(INT, CAST(Date AS DATETIME))	AS 'Date'
						,GUN	= DAY(Date)
						,YIL	= YEAR(Date)
						,GUNAD	= DATENAME(DW, Date) 
						,AYAD	= DATENAME(MONTH, Date)
						,CASE WHEN CAST(Date AS DATETIME)=CAST(GETDATE() AS DATE) THEN 1 ELSE 0 END AS 'Bugun'
						,(
							SELECT * FROM (
									SELECT DISTINCT
										 E.ETUT								AS 'AD'
										,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), E.TARIH, 104)	AS 'BIT_TARIH'
										,'#5C9BD1'							AS 'RENK'
										,E.ID_ETUT							AS 'ID_ETUT'
										,0									AS 'SABITETUT'				
										FROM Etut			E										
										WHERE	E.AKTIF		= 1											
											AND TC_OGRETMEN	= @TC_OGRETMEN
											AND CONVERT(date,E.TARIH)	= CONVERT(date,DL.DATE)
								UNION ALL
									SELECT DISTINCT
										 D.DERSAD												AS 'AD'
										,CONVERT(VARCHAR(10), E.KYE_TARIH, 104)					AS 'BAS_TARIH'
										,CONVERT(VARCHAR(10), DATEADD(YEAR,1,E.KYE_TARIH), 104)	AS 'BIT_TARIH'
										,'#E43A45'												AS 'RENK'
										,E.ID_ETUTSABIT											AS 'ID_ETUT'
										,1														AS 'SABITETUT'				
										FROM EtutSabit			E		
										JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS = E.ID_DERS	
										JOIN v3Ogrenci			O	ON	O.ID_SINIF= E.ID_SINIF			
										WHERE	E.ID_GUN	=DATEPART(weekday,CONVERT(date,DL.DATE)) 
											AND E.TC_OGRETMEN=@TC_OGRETMEN

							) AS SS
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)AS 'Liste'
					FROM		#DateList		DL
					ORDER BY DL.Date ASC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				) AS J
			END

			DROP TABLE #DateList
		END

		IF @ISLEM = 2	--	ETÜT DETAY				
		BEGIN
			IF @SABITETUT = 1
			BEGIN
				SELECT  DISTINCT
					 E.ID_ETUTSABIT AS ID_ETUT
					,DERSAD			AS ETUT
					,S.AD			AS YER
					,D.ID_DERS
					,D.DERSAD
					,null			AS UNITELIST 
					,G.GUN			AS TARIH
					,K.AD+' '+ K.SOYAD	AS ADSOYAD
					,E.TC_OGRETMEN
					,E.DERSSAAT			AS SAAT
					,40					AS SURE					
				FROM EtutSabit			E
				JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
				JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
				JOIN v3Sinif			S	ON	S.ID_SINIF	= E.ID_SINIF
				JOIN Gun				G	ON	G.ID_GUN	= E.ID_GUN
				WHERE E.ID_ETUTSABIT= @ID_ETUT						
				ORDER BY ADSOYAD,DERSAD
				FOR JSON PATH,INCLUDE_NULL_VALUES
			END
			ELSE	
			BEGIN
				SELECT  DISTINCT
					 E.ID_ETUT
					,E.ETUT
					,YER
					,D.ID_DERS
					,D.DERSAD
					,UNITELIST = (SELECT U.AD UNITEAD FROM OkyanusDB.dbo.v3SinavDersUnite U JOIN EtutUnite EU ON EU.KOD=U.KOD WHERE EU.ID_ETUT = E.ID_ETUT ORDER BY U.KOD FOR JSON PATH,INCLUDE_NULL_VALUES  )
					,CONVERT(VARCHAR(MAX), TARIH, 104 ) TARIH
					,ADSOYAD	= K.AD+' '+ K.SOYAD
					,E.TC_OGRETMEN
					,SAAT					
					,E.SURE					
				FROM Etut				E
				JOIN eokul_v2.dbo.Ders	D	ON	D.ID_DERS	= E.ID_DERS
				JOIN v3Kullanici		K	ON	K.TCKIMLIKNO= E.TC_OGRETMEN 
				WHERE E.ID_ETUT = @ID_ETUT
				AND E.AKTIF = 1				
				ORDER BY ADSOYAD,DERSAD
				FOR JSON PATH,INCLUDE_NULL_VALUES
			END
		END

	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_FrekansSistemEksikKazanim]...';


GO
ALTER procedure [dbo].[sp_FrekansSistemEksikKazanim]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@TC_OGRETMEN		VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@IL					VARCHAR(36)		= NULL,
	@ILCE				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@DONEM				char(4)			= NULL,
	@DONEMKOD			char(4)			= NULL,
	@ID_KADEME3			VARCHAR(MAX)	= NULL,
	@ID_SINAVTURU		VARCHAR(MAX)	= NULL,
	--@KADEME				INT			= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DOSYAADI			varchar(100)	= NULL,
	@DOSYAGUID			varchar(50)		= NULL,
	@ID_SINAVDOSYA		int				= NULL,
	@DERSAD				VARCHAR(MAX)	= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@EOKUL				INT		=	0
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,TC_OGRENCI					= @TC_OGRENCI		
			,TC_OGRETMEN				= @TC_OGRETMEN	
			,OTURUM						= @OTURUM			
			,IL							= @IL				
			,ILCE						= @ILCE			
			,ID_MENU					= @ID_MENU		
			,DONEM						= @DONEM			
			,DONEMKOD					= @DONEMKOD		
			,ID_KADEME3					= @ID_KADEME3		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,DOSYAADI					= @DOSYAADI		
			,DOSYAGUID					= @DOSYAGUID		
			,ID_SINAVDOSYA				= @ID_SINAVDOSYA	
			,DERSAD						= @DERSAD			
			,SQLJSON					= @SQLJSON		
			,EOKUL				 		= @EOKUL			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
--select* from OkyanusDB.dbo.v3Kullanici where TCKIMLIKNO= '27296533692'
--	exec sp_FrekansSistemEksikKazanim @ID_MENU=1,@ISLEM=2,@DERSAD='Geometri',@DONEM='2017',@ID_SUBE=309,@ID_KADEME3='[0,15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='27296533692',@TC_OGRENCI='10987583618',@TCKIMLIKNO='27296533692',@OTURUM='E888F3FF-7DC1-4743-B683-4CE6141E16DC',@ID_SINIF=101525

BEGIN TRY    
	 EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	

	IF @DONEM=''
	BEGIN
		SELECT @DONEM=DONEM FROM v3AktifDonem WHERE AKTIF=1
	END
		
	 
	
	IF @ID_LOG > 1 or @EOKUL=1
	BEGIN
		drop table if exists #temp4T
		drop table if exists #TEMPORTT
		drop table if exists #t1
		drop table if exists #t3
		drop table if exists #temp
		drop table if exists #temp3
		drop table if exists #temp4
		drop table if exists #TEMPORT
		drop table if exists #TEMPORTS
		drop table if exists #tempY2
		drop table if exists #ttemp
		drop table if exists #ttemp3
		drop table if exists #TTEMPORTS
	
		Declare @SQL as varchar(max)
		Declare @Columns as varchar(max)
		Declare @Columns2 as varchar(max)

		--OGRENCI 
		IF @ISLEM = 1
		BEGIN
		--Declare @UNITEDONEMKOD varchar(4)=(select DONEM from OKYANUSDB.DBO.v3AktifDonem WHERE AKTIF=1)
			IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY


				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.DERSAD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempsY
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND YO.TCKIMLIKNO = @TC_OGRENCI AND Y.DONEM = @DONEM AND D.DERSAD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.DERSAD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempY
					  from #tempsY t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempY2
					  from #tempsY t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTY
						from #tempY
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempY --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempY2
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivots
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTY WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2
						 from ##pivots p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivots
				drop table IF EXISTS #t2
				drop table IF EXISTS #tempY
				drop table IF EXISTS #tempsY
				drop table IF EXISTS #TEMPORTY
			END
			ELSE	-- SINAVLAR
			BEGIN
			
					SELECT
						 S.ID_SINAV AS ID_SINAVBILGI
						,S.AD AS ACIKLAMA
						,SD.TAKMAAD AS DERSAD
						,SUBSTRING(SA.KOD,1,9) AS KONUKODU
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU						
						,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)) AS KAZANIM
						,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
						,SUM(1) AS KONUSAYISI
						,D.ID_DERS
						,S.SINAVTARIH
					INTO #temp
					FROM	   [Pusulam].dbo.Sinav					S	 WITH (NOLOCK) 
					INNER JOIN [Pusulam].dbo.SinavOgrenci			SO	 WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
					INNER JOIN OkyanusDB.dbo.v3Ogrenci				O	 WITH (NOLOCK) ON O.TCKIMLIKNO=SO.TCKIMLIKNO
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB WITH (NOLOCK) ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
					INNER JOIN [Pusulam].dbo.SinavOgrenciCevap		SOC  WITH (NOLOCK) ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
					INNER JOIN [Pusulam].dbo.SinavKitapcik			SK	 WITH (NOLOCK) ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
					INNER JOIN [Pusulam].dbo.SinavDers				SD   WITH (NOLOCK) ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
					INNER JOIN eokul_v2.dbo.Ders					D    WITH (NOLOCK) ON D.ID_DERS=SD.ID_DERS
					INNER JOIN [Pusulam].dbo.SinavAnahtar			SA   WITH (NOLOCK) ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
					INNER JOIN OkyanusDB.dbo.v3Kademe3				K3   WITH (NOLOCK) ON K3.ID_KADEME3=S.ID_KADEME3
					WHERE		S.FREKANSHESAPLA=1
							AND S.AKTIF=1
							AND S.DURUM=2
							AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
							--AND (O.ID_SINIF=@ID_SINIF)
							AND S.DONEM = @DONEM
							AND (D.DERSAD=@DERSAD)
							AND SO.TCKIMLIKNO = @TC_OGRENCI							
							AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
					GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD, SOC.DURUM,D.ID_DERS,SINAVTARIH
					ORDER BY S.ID_SINAV,SA.KOD

				  Select t2.ID_SINAVBILGI,  
						 t2.ACIKLAMA,
						 t2.ID_DERS,
						 t2.DERSAD,
						 t2.KONUKODU,
						 t2.UNITE,
						 t2.KONU,
						 t2.KONUSAYISI,
						 t2.DOGRUSAYISI,SINAVTARIH,
						(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
					into #temp3
					from #temp t2
				order by t2.ID_SINAVBILGI,t2.KONUKODU

				  Select KONUKODU,
						 ID_DERS,
						 SUM(KONUSAYISI) as KONUSAYISI,
						 SUM(DOGRUSAYISI) as DOGRUSAYISI
					into #TEMPORTS
					from #temp3 
				group by KONUKODU,ID_DERS

				  Select KONUKODU,
						 ID_DERS,
						 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
					into #TEMPORT
					from #TEMPORTS 

					
select KONUKODU,ID_SINAVBILGI,sum(KONUSAYISI) KONUSAYISI, sum(DOGRUSAYISI) DOGRUSAYISI,(Convert(decimal(6,2),(Convert(decimal(7,2),sum(DOGRUSAYISI))/convert(decimal(7,2),sum(KONUSAYISI)))*100))  as YUZDE into #k  from #temp group by KONUKODU,ID_SINAVBILGI

	  
				  Select t3.ID_SINAVBILGI,  
						 t3.ACIKLAMA,
						 t3.ID_DERS,
						 t3.DERSAD,
						 t3.KONUKODU,
						 t3.UNITE,
						 t3.KONU,
						 t3.KONUSAYISI,SINAVTARIH,
						 '('+Cast(k.KONUSAYISI as varchar)+') / '+Cast(k.YUZDE as varchar)+' %' as YUZDE
					into #temp4
					from #temp3 t3
					join #k		k	on k.ID_SINAVBILGI=t3.ID_SINAVBILGI and k.KONUKODU=t3.KONUKODU
				order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

				   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
				  from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI	
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI

				  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA+' (S.S.) / %')
					from
				  (
					Select distinct 
						   ACIKLAMA,SINAVTARIH,
						   ID_SINAVBILGI
					  from #temp4 --order by ID_SINAVBILGI
				  ) as b
				  order by SINAVTARIH,b.ID_SINAVBILGI
		   



		   DROP TABLE IF EXISTS ##pivot
				  Set @SQL='
						  with PivotData as
						  (
							Select 
							 ACIKLAMA,
							 ID_DERS,
							 DERSAD,
							 KONUKODU,
							 UNITE,
							 KONU,
							 YUZDE
							from #temp4
						  )

						  Select 
						   ID_DERS,
						   DERSAD,
						   KONUKODU,
						   ISNULL(UNITE,''-'') UNITE,
						   ISNULL(KONU,''-'') KONU,
						   '+@Columns2+'
						   into ##pivot
						   from PivotData
						   PIVOT
						   (
							MAX(YUZDE)
							FOR ACIKLAMA
							IN('+@Columns+')
						   ) as PivotResult
						   ORDER BY DERSAD,KONUKODU,UNITE
				   '
				   PRINT @SQL
				   PRINT '11'
				   EXEC (@SQL)
				   
--	exec sp_FrekansSistemEksikKazanim @ISLEM=1,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[6]',@TC_OGRETMEN='41318131710',@TC_OGRENCI='13882709862',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'

				   Select (Select Count(DERSAD) from ##pivot pp where pp.DERSAD=p.DERSAD) DERSADET,
						  p.*,
						  '('+Cast((SELECT SUM(KONUSAYISI) FROM #temp3 WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU) as varchar)+') / '+
						  Cast(CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORT WHERE ID_DERS = p.ID_dERS AND KONUKODU = p.KONUKODU)) as varchar)
						  +' %' 
						  as 'KAZANIM YÜZDE (T.S.S) / %'
					INTO #t1
					 from ##pivot p


					 select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t1 
										FOR JSON AUTO
									) as t1											
								) as tablo FOR JSON AUTO
							) as tt
		   END
		END
	
		-- SINIF 
		IF @ISLEM = 2
		BEGIN
		IF (0 IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))) -- YAZILI
			BEGIN
			
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT


				SELECT	Y.ID_YAZILI AS ID_SINAVRAPOR
						,Y.AD AS ACIKLAMA
						,Y.ID_DERS
						,D.DERSAD AS DERSAD
						,YS.KOD AS KONUKODU
						,SDU.AD AS UNITE
						,SUM(YS.PUAN) AS PUANDEGERI
						,ISNULL(YO.TELAFI, SUM(YOC.PUAN)) AS PUAN
						,Y.YAZILITARIH AS SINAVTARIH
				INTO #tempOgrtYazili
				FROM Yazili Y
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.AKTIF = 1 AND YO.AKTIF = 1 AND O.ID_SINIF = @ID_SINIF AND Y.DONEM = @DONEM AND D.DERSAD = @DERSAD
				GROUP BY Y.ID_YAZILI 
						,Y.AD 
						,Y.ID_DERS
						,D.DERSAD 
						,YS.KOD 
						,SDU.AD 
						,Y.YAZILITARIH
						,YO.TELAFI


					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,SINAVTARIH,
						   Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) as YUZDE
					  into #tempYO
					  from #tempOgrtYazili t

					Select t.ID_SINAVRAPOR,
						   t.ACIKLAMA,
						   t.ID_DERS,
						   t.DERSAD,
						   t.UNITE,
						   t.KONUKODU,
						   CAST( Convert(decimal(8,0),(Convert(decimal(8,2),t.PUAN)/t.PUANDEGERI)*100) AS varchar(10))as YUZDE
					  into #tempPivot
					  from #tempOgrtYazili t

					  Select KONUKODU,
							 ID_DERS,
							 AVG(YUZDE) as ORTALAMA
						into #TEMPORTYOGRT
						from #tempYO
					group by KONUKODU,ID_DERS

		  
					   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
					  from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR	
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR

					  Select @Columns2=Coalesce(@Columns2+',','')+'CAST(ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS VARCHAR(100)) AS ' +QUOTENAME(ACIKLAMA)
						from
					  (
						Select distinct 
							   ACIKLAMA,SINAVTARIH,
							   ID_SINAVRAPOR
						  from #tempYO --order by ID_SINAVBILGI
					  ) as b
					  order by SINAVTARIH,b.ID_SINAVRAPOR
		   
		  

					  Set @SQL='
							  with PivotData as
							  (
								Select 
								 ACIKLAMA,
								 ID_DERS,
								 DERSAD,
								 UNITE,
								 KONUKODU,
								 YUZDE
								from #tempPivot
							  )

							  Select 
							   ID_DERS,
							   DERSAD as DERS,
							   UNITE,
							   KONUKODU,
							   '+@Columns2+'
							   into ##pivotOgrtY
							   from PivotData
							   PIVOT
							   (
								MAX(YUZDE)
								FOR ACIKLAMA
								IN('+@Columns+')
							   ) as PivotResult
							   ORDER BY UNITE
					   '
					   PRINT @SQL
					   EXEC (@SQL)

					    Select p.*,
							  ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTYOGRT WHERE ID_DERS = p.ID_DERS AND KONUKODU = p.KONUKODU))
							  INTO #t2Y
						 from ##pivotOgrtY p


					    select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		#t2Y 
										FOR JSON AUTO
									) as t3											
								) as tablo FOR JSON AUTO
							) as tt
	
	
				drop table IF EXISTS ##pivotOgrtY
				drop table IF EXISTS #t2Y
				drop table IF EXISTS #tempYO
				drop table IF EXISTS #tempOgrtYazili
				drop table IF EXISTS #TEMPORTYOGRT


			END
		ELSE	-- SINAVLAR
			BEGIN
				SELECT
					 S.ID_SINAV AS ID_SINAVBILGI
					,S.SINAVTARIH
					,S.AD AS ACIKLAMA
					,SD.TAKMAAD AS DERSAD
					--,SUBSTRING(SA.KOD,1,9) AS KONUKODU				
					,SA.KOD AS KONUKODU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)),'-') AS UNITE
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)),'-') AS KONU
					,ISNULL((SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,12)),'-') AS KAZANIM
					,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
					,SUM(1) AS KONUSAYISI
				INTO #ttemp
				FROM	   [Pusulam].dbo.Sinav S
				INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK)ON SO.ID_SINAV=S.ID_SINAV
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
				INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
				INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
				INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=SD.ID_DERS
				INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
				WHERE		S.FREKANSHESAPLA=1  
						AND S.AKTIF=1
						AND S.DURUM=2
						AND K3.AD IN ('12. SINIF','11. SINIF','10. SINIF','9. SINIF')
						AND S.DONEM = @DONEM
						AND (D.DERSAD=@DERSAD)
						AND O.ID_SINIF=@ID_SINIF
						AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON(@ID_SINAVTURU))
				GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,S.SINAVTARIH
				ORDER BY S.ID_SINAV,SA.KOD


			  Select t2.ID_SINAVBILGI,  
					 t2.ACIKLAMA,
					 t2.SINAVTARIH,
					 t2.DERSAD,
					 t2.KONUKODU,
					 t2.UNITE,
					 t2.KONU,
					 t2.KAZANIM,
					 t2.KONUSAYISI,
					 t2.DOGRUSAYISI,
					(Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				into #ttemp3
				from #ttemp t2
			order by t2.ID_SINAVBILGI,t2.KONUKODU


			  Select KONUKODU,
					 SUM(KONUSAYISI) as KONUSAYISI,
					 SUM(DOGRUSAYISI) as DOGRUSAYISI
				into #TTEMPORTS
				from #ttemp3 
			group by KONUKODU

			  Select KONUKODU,
					 (Convert(decimal(6,0),(Convert(decimal(7,2),DOGRUSAYISI)/convert(decimal(7,2),KONUSAYISI))*100)) as ORTALAMA
				into #TEMPORTT
				from #TTEMPORTS 


			  Select t3.ID_SINAVBILGI,  
					 t3.ACIKLAMA,
					 t3.DERSAD,
					 t3.SINAVTARIH,
					 t3.KONUKODU,
					 t3.UNITE,
					 t3.KONU,
					 t3.KAZANIM,
					 '('+ cast ( t3.KONUSAYISI as varchar)+') / ' + Cast(t3.YUZDE as varchar)+'%' as YUZDE
				into #temp4T
				from #ttemp3 t3
			order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

	  
		
			   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
			  from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH				   	
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI

			  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
				from
			  (
				Select distinct 
					   ACIKLAMA,
					   ID_SINAVBILGI,SINAVTARIH
				  from #temp4T --order by ID_SINAVBILGI
			  ) as b
			  order by SINAVTARIH,ACIKLAMA,ID_SINAVBILGI
		  
		  
		   
		   
			if exists (Select TOP 1 1 from #temp4T)
			begin
					drop table if exists ##pivotS
					drop table if exists ##TT
					  Set @SQL='
					  with PivotData as
					  (
						Select 
						 ACIKLAMA,
						 DERSAD,
						 KONUKODU,
						-- UNITE,
						 KONU,
						 KAZANIM,
						 YUZDE
						from #temp4T
					  )

					  Select 
					   DERSAD,
					   KONUKODU,
					  -- UNITE,
					   KONU,
						 KAZANIM,
					   '+@Columns2+'
					   into ##pivotS
					   from PivotData
					   PIVOT
					   (
						MAX(YUZDE)
						FOR ACIKLAMA
						IN('+@Columns+')
					   ) as PivotResult
					   ORDER BY DERSAD,KONUKODU--,UNITE

					   SELECT * 
					   INTO ##TT
					   FROM ##pivotS
					   GROUP BY DERSAD,KONUKODU,KONU,KAZANIM,'+@Columns+'
							--,UNITE
					   '
					   PRINT @SQL
					   PRINT '1'
					   EXECute (@SQL)
					   PRINT '1'
		  
					  Select  p.*,ORTALAMA = '('+ cast( (SELECT sum(KONUSAYISI) FROM #ttemp3 WHERE KONUKODU = p.KONUKODU) as varchar) +') / '+ Cast(   
														CONVERT(DECIMAL(10,2),
																(SELECT ORTALAMA FROM #TEMPORTT WHERE KONUKODU = p.KONUKODU)
															   ) 
														  as varchar(10))+'%'
							  INTO #t3
						 from ##TT p
			 
					   PRINT '2'
				IF @EOKUL=1
				BEGIN 
					SELECT * FROM #t3 
				END
				ELSE
				BEGIN 
			--	drop table if exists ##pivotS
			--	exec sp_FrekansSistemEksikKazanim @ISLEM=2,@DERSAD='Biyoloji',@DONEM='2017',@ID_SINIF=101549,@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'
	
							select(
									select * from(
											select 
											(					
												SELECT		*
												FROM		#t3 
												FOR JSON AUTO
											) as t3											
										) as tablo FOR JSON AUTO
									) as tt
				END
			end
			else 
			begin
			select(
										select * from(
												select 
												(					
													SELECT		null
										
												) as t3											
											) as tablo FOR JSON AUTO
										) as tt
			end
			   --drop table if exists ##pivotS
			   drop table if exists #temp4T
			   drop table if exists #TEMPORTT
			   drop table if exists #t1
			   drop table if exists #t3
			   drop table if exists #temp
			   drop table if exists #temp3
			   drop table if exists #temp4
			   drop table if exists #TEMPORT
			   drop table if exists #TEMPORTS
			   drop table if exists #tempY2
			   drop table if exists #ttemp
			   drop table if exists #ttemp3
			   drop table if exists #TTEMPORTS
		   
			END
		END
		
		-- OGRETMEN
		IF @ISLEM = 3
		BEGIN
		
--	exec sp_FrekansSistemEksikKazanim @ISLEM=3,@DERSAD='Matematik',@DONEM='2017',@ID_SUBE=427,@ID_KADEME3='[15,16,17,18]',@ID_SINAVTURU='[2]',@TC_OGRETMEN='45103215326',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'


			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO

		SELECT
			 S.ID_SINAV AS ID_SINAVBILGI
			,S.AD +'('+CAST(S.ID_SINAV AS varchar(10))+')' AS ACIKLAMA
			,SD.TAKMAAD AS DERSAD
			,SA.KOD AS KONUKODU
			,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,6)) AS UNITE
			,(SELECT TOP 1 AD FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD=SUBSTRING(SA.KOD,1,9)) AS KONU
			,SUM(CASE WHEN SOC.DURUM='D' THEN 1 ELSE 0 END) AS DOGRUSAYISI
			,SUM(1) AS KONUSAYISI
			,K3.ID_KADEME3
			,K3.AD GRUP
			,S.SINAVTARIH
		INTO #tempO
		FROM	   [Pusulam].dbo.Sinav S
		INNER JOIN [Pusulam].dbo.SinavOgrenci SO WITH (NOLOCK) ON SO.ID_SINAV=S.ID_SINAV
		INNER JOIN [Pusulam].dbo.SinavOgrenciCevapBolum SOCB ON SOCB.ID_SINAVOGRENCI=SO.ID_SINAVOGRENCI
		INNER JOIN [Pusulam].dbo.SinavOgrenciCevap SOC ON SOC.ID_SINAVOGRENCICEVAPBOLUM=SOCB.ID_SINAVOGRENCICEVAPBOLUM
		INNER JOIN [Pusulam].dbo.SinavKitapcik SK ON SK.ID_SINAV=SO.ID_SINAV AND SK.AD=SO.KITAPCIK
		INNER JOIN [Pusulam].dbo.SinavDers SD ON SD.ID_SINAVDERS=SOCB.ID_SINAVDERS
		INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS=SD.ID_DERS
		INNER JOIN [Pusulam].dbo.SinavAnahtar SA ON SA.ID_SINAVDERS=SOCB.ID_SINAVDERS AND SA.ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND SA.SORUNO=SOC.SORUNO
		INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3=S.ID_KADEME3
		INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=SO.TCKIMLIKNO
		INNER JOIN eokul_v2.dbo.DersOgretmen DO ON DO.ID_SINIF=O.ID_SINIF	AND DO.DONEMKOD=@DONEM								
		WHERE		S.FREKANSHESAPLA=1  
				AND S.AKTIF=1
				AND S.DURUM=2
				AND K3.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON (@ID_KADEME3))
				AND S.DONEM = @DONEM
				AND (D.DERSAD = @DERSAD)
				AND DO.TC_OGRETMEN=@TC_OGRETMEN
				AND S.AKTIF=1
				AND S.ID_SINAVTURU IN (SELECT VALUE FROM OPENJSON (@ID_SINAVTURU))
		GROUP BY S.ID_SINAV ,S.AD ,SD.TAKMAAD ,SA.KOD,K3.ID_KADEME3,SINAVTARIH,K3.AD 
		ORDER BY S.ID_SINAV,SA.KOD


		  Select t2.ID_SINAVBILGI,  
		         t2.ACIKLAMA,
			     t2.DERSAD,
			     t2.KONUKODU,
			     t2.UNITE,
				 t2.KONU,
				 t2.KONUSAYISI,
				 t2.DOGRUSAYISI,SINAVTARIH,
			    (Convert(decimal(6,0),(Convert(decimal(7,2),t2.DOGRUSAYISI)/convert(decimal(7,2),t2.KONUSAYISI))*100))  as YUZDE
				,ID_KADEME3,GRUP
		    into #temp3O
		    from #tempO t2
	    order by t2.ID_SINAVBILGI,t2.KONUKODU


		  Select KONUKODU,
				 SUM(KONUSAYISI) as KONUSAYISI,
		         SUM(DOGRUSAYISI) as DOGRUSAYISI
			into #TEMPORTSO
	        from #temp3O
		group by KONUKODU

		  Select KONUKODU,
		         (Convert(decimal(10,0),(Convert(decimal(10,2),DOGRUSAYISI)/convert(decimal(10,2),KONUSAYISI))*100)) as ORTALAMA
			into #TEMPORTO
	        from #TEMPORTSO

	      Select t3.ID_SINAVBILGI,  
		         t3.ACIKLAMA,
			     t3.DERSAD,
			     t3.KONUKODU,
			     t3.UNITE,
				 t3.KONU,SINAVTARIH,
			     Cast(t3.YUZDE as varchar)+'%' as YUZDE
				 ,ID_KADEME3,GRUP
		    into #temp4O
		    from #temp3O t3
	    order by t3.ID_SINAVBILGI,t3.KONUKODU,t3.DERSAD

		drop table #temp3O


		   Select @Columns=Coalesce(@Columns+',','')+QUOTENAME(ACIKLAMA)
		  from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
				   	
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI

		  Select @Columns2=Coalesce(@Columns2+',','')+'ISNULL('+QUOTENAME(ACIKLAMA)+',''-'') AS ' +QUOTENAME(ACIKLAMA)
		    from
		  (
			Select distinct 
			       ACIKLAMA,SINAVTARIH,
				   ID_SINAVBILGI
			  from #temp4O --order by ID_SINAVBILGI
		  ) as b
		  order by SINAVTARIH,b.ID_SINAVBILGI
--		   exec sp_FrekansSistem @ISLEM=3,@DERSAD='Biyoloji',@DONEM='2017',@ID_SUBE=11,@ID_KADEME3='[15]',@ID_SINAVTURU='[0]',@TC_OGRETMEN='41318131710',@TCKIMLIKNO='56545519606',@OTURUM='669AA9B9-0A41-45D6-B253-1DCBD6DE0834'




print '1'

IF EXISTS(Select TOP 1 1 from #temp4O)
BEGIN

		  Set @SQL='
		  

		  Select 
		   DERSAD,
		   KONU2 KONUKODU,
		   UNITE,
		   KONU,ID_KADEME3,GRUP,
		   '+@Columns2+',
		   ORTALAMA = CONVERT(DECIMAL(10,2),(SELECT ORTALAMA FROM #TEMPORTO TOR WHERE TOR.KONUKODU = KONU2))
		   into ##t4
		   from(
				Select 
				 ACIKLAMA,
				 DERSAD,			 
				KONUKODU KONU2,
				 UNITE,
				 KONU,
				 YUZDE
				 ,ID_KADEME3,GRUP
				from #temp4O) PivotData
		   PIVOT
		   (
				MAX(YUZDE)
				FOR ACIKLAMA
				IN('+@Columns+')
		   ) as PivotResult
		   ORDER BY DERSAD,KONU2,UNITE
		   
		   '
		   PRINT @SQL
		   
print '2'
		   EXEC (@SQL)

		  
					select(
							select * from(
									select 
									(					
										SELECT		*
										FROM		##t4 
										FOR JSON AUTO
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt

							END
							ELSE
							BEGIN 
								select(
							select * from(
									select 
									(					
										SELECT NULL
									) as t4											
								) as tablo FOR JSON AUTO
							) as tt
							END
			DROP table IF EXISTS #tempO
		   drop table IF EXISTS ##t4
		   drop table IF EXISTS #temp4O
		   drop table IF EXISTS #TEMPORTO
		   DROP table IF EXISTS #TEMPORTSO
		END
	END
	
	drop table if exists #temp4T
	drop table if exists #TEMPORTT
	drop table if exists #t1
	drop table if exists #t3
	drop table if exists #temp
	drop table if exists #temp3
	drop table if exists #temp4
	drop table if exists #TEMPORT
	drop table if exists #TEMPORTS
	drop table if exists #tempY2
	drop table if exists #ttemp
	drop table if exists #ttemp3
	drop table if exists #TTEMPORTS

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_GenelKazanimAnalizi]...';


GO

--EXEC	[dbo].[sp_GenelKazanimAnalizi]
--		@TCKIMLIKNO = N'56545519606',
--		@OTURUM = N'9ECE89E5-DD7E-4EBC-A920-A0B75E540AFF',
--		@ID_MENU = 1093,
--		@ID_SUBELER = 236,
--		@ISLEM = 1,
--		@DONEM = N'2017'

ALTER procedure [dbo].[sp_GenelKazanimAnalizi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= 0,
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SUBE					= @ID_SUBE	
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			IF @ISLEM = 1	--	Genel Kazanım Analizi Getir
			BEGIN
				SELECT	A.ID_SINAVRAPOR,
						ID_SUBE,
						SUBE,
						A.GRUP,
						DERS,
						A.SINAVADI,
						SINIF,
						ADSOYAD,
						K.KAZANIM,
						SORUNO,
						PUAN,
						PUANDEGERI 
				FROM eokul_v2.dbo.YaziliKazanimAnalizi A
				INNER JOIN eokul_v2.dbo.SinavRapor R ON R.ID_SINAVRAPOR=A.ID_SINAVRAPOR
				INNER JOIN eokul_v2.dbo.YaziliKazanimList K ON K.ID_KAZANIM=A.ID_KAZANIM
				WHERE (ID_SUBE=@ID_SUBE or @ID_SUBE=0) AND R.isActive=1 AND R.DONEMKOD=@DONEM
				ORDER BY SUBE, SINIF, DERS, SINAVADI, ADSOYAD, SORUNO
			END

			IF @ISLEM = 2	--	Genel Kazanım Analizi Getir Yeni
			BEGIN
				SELECT  Y.ID_SINAVRAPOR
						,SB.ID_SUBE
						,SB.AD AS SUBE
						,K3.AD AS GRUP
						,D.DERSAD AS DERS
						,Y.AD AS SINAVADI
						,S.AD AS SINIF
						,K.AD + ' ' +K.SOYAD AS ADSOYAD
						,U.AD AS KAZANIM
						,YS.SORUNO
						,YOC.PUAN
						,YS.PUAN AS PUANDEGERI
				--INTO #tablosY
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 ON K3.ID_KADEME3 = Y.ID_KADEME3
				INNER JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = Y.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite U ON U.KOD = YS.KOD
				WHERE Y.DONEM = @DONEM AND O.ID_SUBE = @ID_SUBE
				ORDER BY SB.AD, S.AD, D.DERSAD, Y.AD, K.AD + ' ' +K.SOYAD, YS.SORUNO
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_GenelListeler]...';


GO
ALTER procedure [dbo].[sp_GenelListeler]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL	
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN	
			IF @ISLEM = 1 -- Bilgi Listele
			BEGIN
				SELECT
				ISNULL(
					(
						SELECT *
						FROM Bilgi
						FOR JSON PATH
					)
				, '[]')
			END

			IF @ISLEM = 2 -- Bilişsel Süreç Listele
			BEGIN
				SELECT
				ISNULL(
					(
						SELECT *
						FROM BilisselSurec
						FOR JSON PATH
					)
				, '[]')
			END
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_Grup]...';


GO
ALTER procedure [dbo].[sp_Grup]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@SUBELER			VARCHAR(MAX)	= NULL	,
	@ID_KADEMEs			VARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SUBE					= @ID_SUBE	
			,ID_KADEME					= @ID_KADEME	
			,SUBELER					= @SUBELER	
			,ID_KADEMEs					= @ID_KADEMEs		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		SELECT ID_KADEME INTO #KADEMELER FROM v3KullaniciKademe WHERE TCKIMLIKNO=@TCKIMLIKNO
		
		SELECT ID_KULLANICITIPI 
		INTO #KULLANICITIPLER 
		FROM OkyanusDB.[dbo].[v3Kullanici]			K
		INNER JOIN OkyanusDB.[dbo].[v3SubeYetki]	SY	ON	SY.TCKIMLIKNO	= K.TCKIMLIKNO
		WHERE K.TCKIMLIKNO=@TCKIMLIKNO
		
		IF @ISLEM = 1	--	Grup Listele
		BEGIN
			--IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			--BEGIN
			--	select distinct st.ID_KADEME3 as ID_SINAVGRUP, k.AD as GRUP
			--	from		  [dbo].[vw_SubeGrupSinif]	sgs
			--	Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
			--	Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
			--	Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
			--	Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
			--	Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
			--	where (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sgs.ID_SUBE=@ID_SUBE)
			--END
			--ELSE
			--BEGIN
				select distinct st.ID_KADEME3 as ID_SINAVGRUP, k.AD as GRUP
				from		  [dbo].[vw_SubeGrupSinif]	sgs
				Inner Join	  [dbo].[v3Sinif]			s		on s.ID_SINIF		=	sgs.ID_SINIF
				Inner Join	  [dbo].[v3Donem]			d		on d.ID_DONEM		=	s.ID_DONEM
				Inner Join	  [dbo].[v3AktifDonem]		ad		on ad.DONEM			=	d.KOD			and ad.AKTIF=1
				Inner Join	  [dbo].[v3SatisTuru]		st		on st.ID_SATISTURU	=	s.ID_SATISTURU
				Inner Join	  [dbo].[v3Kademe3]			k		on k.ID_KADEME3		=	st.ID_KADEME3
				where (@ID_SUBE IS NULL OR @ID_SUBE=0 OR sgs.ID_SUBE=@ID_SUBE)  AND
						(@SUBELER IS NULL OR @SUBELER='[]' OR sgs.ID_SUBE in (select value from openjson( @SUBELER)))  AND
					  (st.ID_KADEME IN (SELECT ID_KADEME FROM #KADEMELER)) 

				

			--END
		END
				
		IF @ISLEM = 2	--	Grup Listele by Kullanici
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN

				SELECT DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
				INTO #TEMP
				FROM [dbo].[vw_SubeGrupSinif]	K
				JOIN v3KullaniciKademe3			KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 				
				WHERE	(K.ID_SUBE=@ID_SUBE or @ID_SUBE=0 or @ID_SUBE is null)
					AND (KK.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0 OR @ID_KADEME IS NULL)
			UNION 
				SELECT K.ID_KADEME3 ID_SINAVGRUP, AD GRUP,SIRA 
				FROM v3Kademe3		K
				JOIN v3KademeBilgi	KB	ON	KB.ID_KADEME3	=	K.ID_KADEME3
				WHERE @ID_SUBE IN (706, 730)
					AND (KB.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0 OR @ID_KADEME IS NULL)

				SELECT * FROM #TEMP
				ORDER BY SIRA

				DROP TABLE #TEMP
			END
			ELSE
			BEGIN 	
				SELECT	K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP
				FROM	v3Kademe3			K
				JOIN	v3KullaniciKademe3	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	TCKIMLIKNO=@TCKIMLIKNO
					AND (KK.ID_KADEME = @ID_KADEME OR @ID_KADEME = 0 OR @ID_KADEME IS NULL)

			END
		END
				
		IF @ISLEM = 3	--	Grup Listele MULTİ SUBE
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
				INTO	#TEMP1
				FROM	[dbo].[vw_SubeGrupSinif]	K
				JOIN	v3KullaniciKademe3			KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	(	K.ID_SUBE IN (SELECT value FROM OPENJSON(@SUBELER)) 
							or (0 IN (SELECT VALUE FROM OPENJSON(@SUBELER))) 
							or @SUBELER='[]' 
							or @SUBELER is null)
					AND (	@ID_KADEMEs IS NULL 
						OR	@ID_KADEMEs = ''
						OR	@ID_KADEMEs = '[]'
						OR	KK.ID_KADEME IN (SELECT VALUE FROM OPENJSON(@ID_KADEMEs)))
				
				
				SELECT ID_SINAVGRUP, GRUP, SIRA FROM #TEMP1				
				UNION
				SELECT K.ID_KADEME3 ID_SINAVGRUP, AD GRUP,SIRA FROM v3Kademe3	K
				JOIN v3KademeBilgi	KB ON KB.ID_KADEME3 = K.ID_KADEME3
				WHERE (
					(706 IN (SELECT VALUE FROM OPENJSON(@SUBELER))) 
				OR	(730 IN (SELECT VALUE FROM OPENJSON(@SUBELER))) )
					AND (	@ID_KADEMEs IS NULL 
						OR	@ID_KADEMEs = ''
						OR	@ID_KADEMEs = '[]'
						OR	KB.ID_KADEME IN (SELECT VALUE FROM OPENJSON(@ID_KADEMEs)))

				ORDER BY SIRA

				DROP TABLE #TEMP1
			END
			ELSE
			BEGIN 	
				SELECT	K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP
				FROM	v3Kademe3			K
				JOIN	v3KullaniciKademe3	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 				
				WHERE	TCKIMLIKNO=@TCKIMLIKNO
					AND (	@ID_KADEMEs IS NULL 
						OR	@ID_KADEMEs = ''
						OR	@ID_KADEMEs = '[]'
						OR	KK.ID_KADEME IN (SELECT VALUE FROM OPENJSON(@ID_KADEMEs)))

			END
		END

		IF @ISLEM=4		--	TÜM Grup Listele MULTİ SUBE
		BEGIN
			SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
			INTO	#TEMP2
			FROM	[dbo].[vw_SubeGrupSinif]	K
			WHERE	(	   (K.ID_SUBE	IN	(SELECT value FROM OPENJSON(@SUBELER)))
						or (0			IN	(SELECT VALUE FROM OPENJSON(@SUBELER))) 
						or @SUBELER='[]' 
						or @SUBELER is null
					)

			SELECT * FROM #TEMP2
			ORDER BY SIRA

			DROP TABLE #TEMP2
		END

		IF @ISLEM=5		--	Tüm Grup Listele Şubesiz
		BEGIN
			SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
			FROM	[dbo].[vw_SubeGrupSinif]	K
			INNER JOIN OkyanusDB.dbo.v3KullaniciKademe3 K3 ON K3.ID_KADEME3=K.ID_KADEME3
			WHERE K3.TCKIMLIKNO=@TCKIMLIKNO
			ORDER BY SIRA
		END
		
		IF @ISLEM = 6	--	Grup Listele by Kullanici
		BEGIN
			IF DBO.fn_GenelHak(@TCKIMLIKNO)=1 OR 1 IN (SELECT ID_KULLANICITIPI FROM #KULLANICITIPLER)
			BEGIN
				SELECT	DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.KADEME3 GRUP,SIRA
				INTO	#TEMP6
				FROM	[dbo].[vw_SubeGrupSinif]	K
				JOIN	v3KullaniciKademe3			KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	(K.ID_SUBE=@ID_SUBE or @ID_SUBE=0)

				SELECT * FROM #TEMP6
				ORDER BY SIRA

				DROP TABLE #TEMP6
			END
			ELSE
			BEGIN 	
				SELECT	K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP,SIRA
				FROM	v3Kademe3			K
				JOIN	v3KullaniciKademe3	KK	ON	KK.ID_KADEME3	= K.ID_KADEME3 
				WHERE	TCKIMLIKNO=@TCKIMLIKNO
			UNION 
				SELECT DISTINCT K.ID_KADEME3 ID_SINAVGRUP,K.AD GRUP,SIRA
				from v3Kademe3					K
				JOIN eokul_v2.DBO.KurSinifi		KS	ON	KS.ID_KADEME3	= K.ID_KADEME3
				JOIN v3Ogretmen					OG	ON	OG.ID_OGRETMEN	= KS.ID_DANISMAN
				where	OG.TCKIMLIKNO = @TCKIMLIKNO
					AND DONEMKOD = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1)
				ORDER BY SIRA

			END
		END
		
		DROP TABLE IF EXISTS #KADEMELER
		DROP TABLE IF EXISTS #KULLANICITIPLER
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_KazanimAnalizi]...';


GO

--EXEC	[dbo].[sp_KazanimAnalizi]
--		@TCKIMLIKNO = '52432651008',
--		@OTURUM = 'B06FE75D-2862-4589-946B-E4EB16D4B15F',
--		@ID_MENU = 1096,
--		@ID_SINIFLAR = '[0,101926,101927,101924,101925,101873,101875]',
--		@ID_SINAVLAR = '[0,11]',
--		@ISLEM = 1,
--		@DONEM = '2017'

ALTER procedure [dbo].[sp_KazanimAnalizi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVLAR		VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAVLAR				= @ID_SINAVLAR
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END

			IF @ISLEM = 1 OR @ISLEM = 2	--	Kazanım Analizi
			BEGIN
				SELECT	--COUNT(*)
						Y.ID_YAZILI
						,Y.AD						AS SINAVAD
						,Y.YAZILITARIH
						,O.ID_SUBE
						,SU.AD						AS SUBE
						,S.AD						AS SINIF
						,S.ID_SINIF
						,Y.ID_DERS
						,D.DERSAD					AS DERSAD
						,SDU.KOD
						,SDU.AD						AS KAZANIM
						,ISNULL(YOC.PUAN, 0)		AS PUAN
						,ISNULL(YS.PUAN, 0)			AS MAXPUAN
						,YS.SORUNO
				INTO #GENEL
				FROM Yazili									Y
				INNER JOIN eokul_v2.dbo.Ders				D	 ON	D.ID_DERS		= Y.ID_DERS
				INNER JOIN YaziliSoru						YS	 ON	YS.ID_YAZILI	= Y.ID_YAZILI
				INNER JOIN YaziliOgrenci					YO	 ON	YO.ID_YAZILI	= Y.ID_YAZILI
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite	SDU  ON	SDU.KOD			= YS.KOD
				INNER JOIN YaziliOgrenciCevap				YOC	 ON	YOC.ID_YAZILISORU = YS.ID_YAZILISORU AND YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI
				INNER JOIN OkyanusDB.dbo.v3Ogrenci			O	 ON	O.TCKIMLIKNO	= YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube				SU   ON	SU.ID_SUBE		= O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Sinif			S	 ON	S.ID_SINIF		= O.ID_SINIF
				WHERE	Y.ID_YAZILI IN (SELECT VALUE FROM OPENJSON(@ID_SINAVLAR))
				--AND		S.ID_SINIF  IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))
				AND		YO.KATILMADI = 0 AND YO.AKTIF = 1
				ORDER BY ID_SUBE, S.ID_SINIF, YO.TCKIMLIKNO, Y.ID_YAZILI, YS.SORUNO

				SELECT  g.ID_YAZILI,
						g.SINAVAD,
						g.YAZILITARIH,
						g.ID_DERS,
						g.ID_SUBE,
						g.SUBE,
						g.SINIF,
						g.ID_SINIF,
						g.DERSAD,
						g.KOD,
						g.KAZANIM,
						(Select SUM(MAXPUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI) as GENELMAXPUAN,
						(Select SUM(PUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI) as GENELPUAN,
						(Select SUM(MAXPUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE) as SUBEMAXPUAN,
						(Select SUM(PUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE) as SUBEPUAN,
						(Select SUM(MAXPUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE and gg.SINIF=g.SINIF ) as SINIFMAXPUAN,
						(Select SUM(PUAN) from #GENEL gg where gg.KOD=g.KOD and gg.ID_YAZILI=g.ID_YAZILI and gg.ID_SUBE=g.ID_SUBE and gg.SINIF=g.SINIF) as SINIFPUAN
				INTO #GENEL2
				FROM #GENEL g				
				GROUP BY	g.ID_YAZILI,
							g.YAZILITARIH,
							g.SINAVAD, 
							g.ID_SUBE,
							g.SUBE, 
							g.SINIF,
							g.ID_DERS,
							g.DERSAD,
							g.KOD,
							g.KAZANIM
							,g.ID_SINIF
				ORDER BY g.ID_YAZILI,g.DERSAD,g.KAZANIM

					
				SELECT DISTINCT 
						su.ID_YAZILI, 
						su.ID_DERS,
						su.KOD,
						su.SORUNO
				INTO #tempsorusayilari --uniteye göre
				FROM #GENEL su
				ORDER BY su.ID_YAZILI,su.KOD

				SELECT	su.ID_YAZILI, 
						su.ID_DERS,
						su.KOD,
						Count(su.SORUNO) as SORUSAYISI
				INTO #UniteSoruSayilari
				FROM #tempsorusayilari su
				GROUP BY su.ID_YAZILI,su.ID_DERS,su.KOD
				ORDER BY su.ID_YAZILI,su.KOD

				drop table #GENEL
				drop table #tempsorusayilari

				SELECT	t2.ID_YAZILI,
						t2.YAZILITARIH,
						t2.SINAVAD, 
						t2.ID_SUBE,
						t2.SUBE, 
						t2.SINIF,
						t2.ID_DERS,
						t2.DERSAD,
						t2.KOD,
						t2.KAZANIM,
						USS.SORUSAYISI,
						(Convert(decimal(7,2),(Convert(decimal(7,2),t2.GENELPUAN)/convert(decimal(7,2),t2.GENELMAXPUAN))*100)) as GENELYUZDE,
						(Convert(decimal(7,2),(Convert(decimal(7,2),t2.SUBEPUAN) /convert(decimal(7,2),t2.SUBEMAXPUAN ))*100)) as SUBEYUZDE,
						(Convert(decimal(7,2),(Convert(decimal(7,2),t2.SINIFPUAN)/convert(decimal(7,2),t2.SINIFMAXPUAN))*100)) as SINIFYUZDE
				INTO #temp3
				FROM #GENEL2 t2
				INNER JOIN #UniteSoruSayilari USS ON USS.ID_YAZILI = t2.ID_YAZILI AND USS.KOD = t2.KOD
				where t2.ID_SINIF  IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))
				


				DECLARE @SATIRSAYISI int=(SELECT COUNT(DISTINCT KAZANIM) FROM #temp3)

				Select distinct 
					ID_SUBE,
					SUBE,
					ID_YAZILI,
					YAZILITARIH,
					SINAVAD,
					SINIF
				into #temp4
				from #temp3
				--where ID_SINIF  IN (SELECT VALUE FROM OPENJSON(@ID_SINIFLAR))

				Declare @SUBEADET int=(Select COUNT(distinct SUBE) from #temp4)
				Declare @SINAVADET int=(Select COUNT(distinct SINAVAD) from #temp4)

				IF @ISLEM = 1
				BEGIN
					SELECT
					(
						SELECT * FROM
						(
							SELECT
							(
								Select distinct 
										ID_SUBE,
										SUBE,
										SINAVAD,
										YAZILITARIH,
										SINIF,
										(Select Count(SUBE) from #temp4 t1 where t1.SUBE=t2.SUBE) as SUBESAYI,
										(Select Count(SINAVAD) from #temp4 t1 where t1.SINAVAD=t2.SINAVAD and t1.SUBE=t2.SUBE) as SINIFSAYI,
										@SUBEADET as SUBEADET,
										ISNULL((Select COUNT(distinct SINAVAD) from #temp4 WHERE ID_SUBE=t2.ID_SUBE),0) as SINAVADET
								from #temp4 t2
								order by SUBE,YAZILITARIH desc,SINIF
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T1,
							(
								SELECT  t3.ID_SUBE,
										t3.SUBE,
										t3.SINIF, 
										t3.DERSAD,
										t3.KOD,
										t3.SINAVAD,
										t3.KAZANIM,
										t3.SORUSAYISI,
										t3.GENELYUZDE,
										t3.SUBEYUZDE,
										t3.SINIFYUZDE,
								(SELECT COUNT(KOD) FROM #temp3 tt where tt.KOD=t3.KOD) as KONUSATIRSAYISI,
								@SATIRSAYISI as TOPLAMSATIRSAYISI
								from #temp3 t3
								order by t3.KOD,t3.DERSAD,t3.SUBE,t3.YAZILITARIH desc,t3.SINIF
								FOR JSON PATH, INCLUDE_NULL_VALUES
							) AS T2
						) AS SUBTABLE
						FOR JSON PATH, INCLUDE_NULL_VALUES
					)
				END
				ELSE
				BEGIN
					Select distinct 
							ID_SUBE,
							SUBE,
							SINAVAD,
							YAZILITARIH,
							SINIF,
							(Select Count(SUBE) from #temp4 t1 where t1.SUBE=t2.SUBE) as SUBESAYI,
							(Select Count(SINAVAD) from #temp4 t1 where t1.SINAVAD=t2.SINAVAD and t1.SUBE=t2.SUBE) as SINIFSAYI,
							@SUBEADET as SUBEADET,
							ISNULL((Select COUNT(distinct SINAVAD) from #temp4 WHERE ID_SUBE=t2.ID_SUBE),0) as SINAVADET
					from #temp4 t2

					SELECT  t3.ID_SUBE,
							t3.SUBE,
							t3.SINIF, 
							t3.DERSAD,
							t3.KOD,
							t3.SINAVAD,
							t3.YAZILITARIH,
							t3.KAZANIM,
							t3.SORUSAYISI,
							t3.GENELYUZDE,
							t3.SUBEYUZDE,
							t3.SINIFYUZDE,
					(SELECT COUNT(KOD) FROM #temp3 tt where tt.KOD=t3.KOD) as KONUSATIRSAYISI,
					@SATIRSAYISI as TOPLAMSATIRSAYISI
					from #temp3 t3
					order by t3.KOD,t3.DERSAD,t3.SUBE,t3.YAZILITARIH,t3.SINIF
				END
				
				drop table #GENEL2
				DROP TABLE IF EXISTS #temp1
				DROP TABLE IF EXISTS #temp2
				DROP TABLE IF EXISTS #temp3
				DROP TABLE IF EXISTS #temp4
				drop table #UniteSoruSayilari
			END 
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_KazanimAnaliziOO]...';


GO

ALTER procedure [dbo].[sp_KazanimAnaliziOO]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_YAZILI			INT				= 0,
	@ID_SINIF			INT				= 0,
	@ISLEM				INT				= 0
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_YAZILI					= @ID_YAZILI	
			,ID_SINIF					= @ID_SINIF	
			,ISLEM						= @ISLEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
						
			IF @ISLEM = 1	--	Kazanım Analizi Orta Okul
			BEGIN

				SELECT  Y.AD AS SINAVAD
						,YS.KOD
						,SDU.AD AS KAZANIM 
						,YO.TCKIMLIKNO
						,K.AD + ' ' + K.SOYAD AS ADSOYAD
						,Y.DONEM
						,YS.PUAN AS SORUPUAN
						,YOC.PUAN AS OGRENCIPUAN
				INTO #TEMPOO
				FROM Yazili Y 
				INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
				INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
				INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3SinavDersUnite SDU ON SDU.KOD = YS.KOD
				WHERE Y.ID_YAZILI = @ID_YAZILI AND YO.KATILMADI = 0 AND YO.AKTIF = 1 AND O.ID_SINIF = @ID_SINIF


				SELECT	SINAVAD
						,KOD
						,KAZANIM
						,TCKIMLIKNO
						,ADSOYAD
						,DONEM
						,CONVERT(DECIMAL(18,2), CONVERT(DECIMAL(18,2), SUM(OGRENCIPUAN)) / CONVERT(DECIMAL(18,2), SUM(SORUPUAN)) * 100.0) AS YUZDE
						,SUM(SORUPUAN) AS KAZANIMPUANI
				FROM #TEMPOO
				GROUP BY SINAVAD, KOD, TCKIMLIKNO, KAZANIM, ADSOYAD, DONEM
				ORDER BY ADSOYAD,KOD


				SELECT	SINAVAD
						,KOD
						,KAZANIM
						,DONEM
						,CONVERT(DECIMAL(18,2), CONVERT(DECIMAL(18,2), SUM(OGRENCIPUAN)) / CONVERT(DECIMAL(18,2), SUM(SORUPUAN)) * 100.0) AS YUZDE
						,SUM(SORUPUAN) AS KAZANIMPUANI
				FROM #TEMPOO
				GROUP BY SINAVAD, KOD, KAZANIM, DONEM
				ORDER BY KOD, SINAVAD, KAZANIM


				DROP TABLE #TEMPOO

				SELECT	 S.AD AS SINIF
						,SB.AD AS SUBE
						,D.KOD + '-' + CAST(CAST(D.KOD AS INT) + 1 AS VARCHAR) AS DONEM
						,(SELECT AD FROM Yazili WHERE ID_YAZILI = @ID_YAZILI) AS SINAVAD
				FROM OkyanusDB.dbo.v3Sinif S
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinif SGS ON SGS.ID_SINIF = S.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube	SB ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Donem D ON D.ID_DONEM = S.ID_DONEM
				WHERE S.ID_SINIF = @ID_SINIF

			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Kullanici]...';


GO
ALTER procedure [dbo].[sp_Kullanici]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(150)	= NULL,
	@ID_MENU			INT				= NULL,
	--@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@ID_KULLANICITIPI	INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM					= @ISLEM	
				,TCKIMLIKNO				= @TCKIMLIKNO
				,OTURUM					= @OTURUM
				,ID_MENU				= @ID_MENU

				,SQLJSON				= @SQLJSON						
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kullanıcıya Tipi Listele
		BEGIN
			IF EXISTS(SELECT TCKIMLIKNO FROM DisOgrenci WHERE TCKIMLIKNO=@TCKIMLIKNO)
			BEGIN
				SELECT	DISTINCT SY.ID_KULLANICITIPI
				FROM	[dbo].[v3SubeYetki]	SY	
				WHERE	SY.ID_KULLANICITIPI=4
			END
			ELSE
			BEGIN
				SELECT	DISTINCT SY.ID_KULLANICITIPI
				FROM	[dbo].[v3Kullanici]	K
				JOIN	[dbo].[v3SubeYetki]	SY	ON	K.TCKIMLIKNO=SY.TCKIMLIKNO
				WHERE	K.TCKIMLIKNO=@TCKIMLIKNO AND K.AKTIF=1
			END
		END
			
	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_KullaniciYetki]...';


GO
ALTER procedure [dbo].[sp_KullaniciYetki]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENUS			VARCHAR(150)	= NULL,
	@ID_MENU			INT				= NULL,
	@ID_KADEME			INT				= NULL,
	@ID_KADEME3			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@TC_YETKI			VARCHAR(11)		= NULL,
	@ID_KULLANICITIPI	INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	  
			ISLEM						= @ISLEM				
			,TCKIMLIKNO					= @TCKIMLIKNO			
			,OTURUM						= @OTURUM				
			,ID_MENUS					= @ID_MENUS			
			,ID_MENU					= @ID_MENU			
			,ID_KADEME					= @ID_KADEME			
			,ID_KADEME3					= @ID_KADEME3			
			,ID_SUBE					= @ID_SUBE			
			,TC_YETKI					= @TC_YETKI			
			,ID_KULLANICITIPI			= @ID_KULLANICITIPI	
			,SQLJSON					= @SQLJSON			
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
		
		IF @ISLEM = 1	--	Kullanıcıya Yetkilerini Listele
		BEGIN
			SELECT DISTINCT KD.ID_KADEME, KD.AD
			FROM OkyanusDB.[dbo].v3KullaniciKademe	S
			INNER JOIN OkyanusDB.[dbo].v3Kademe		KD	ON KD.ID_KADEME	= S.ID_KADEME
			WHERE S.TCKIMLIKNO = @TCKIMLIKNO
			ORDER BY ID_KADEME ASC
		END
			
		
		IF @ISLEM = 3	-- Kullanıcı Tipine Göre Kullanıcı Listele
		BEGIN
			--SELECT K.TCKIMLIKNO,K.AD + ' ' + K.SOYAD ADSOYAD
			--FROM [dbo].[v3SubeYetki]	S
			--JOIN [dbo].[v3Kullanici]	K	ON K.TCKIMLIKNO=S.TCKIMLIKNO
			--WHERE ID_KULLANICITIPI=@ID_KULLANICITIPI  AND LEN(AD)>0
			--order by ADSOYAD
			SELECT DISTINCT KL.TCKIMLIKNO,KL.AD + ' ' + KL.SOYAD ADSOYAD 
			FROM	   [dbo].[v3Sube]				SB
			INNER JOIN [dbo].[v3SubeKademe]			SK	ON SK.ID_SUBE		= SB.ID_SUBE
			INNER JOIN [dbo].[v3KullaniciKademe3]	K3	ON K3.ID_KADEME		= SK.ID_KADEME
			INNER JOIN [dbo].[v3SubeYetki]			SY	ON SY.ID_SUBE = SB.ID_SUBE AND SY.TCKIMLIKNO = K3.TCKIMLIKNO
			INNER JOIN [dbo].[v3Kullanici]			KL	ON KL.TCKIMLIKNO	= K3.TCKIMLIKNO	AND KL.AKTIF = 1
			WHERE	SY.ID_SUBE			= @ID_SUBE 
				AND SY.ID_KULLANICITIPI = @ID_KULLANICITIPI
				AND (K3.ID_KADEME3		= @ID_KADEME3	OR @ID_KADEME3 IS NULL OR @ID_KADEME3 = ''OR @ID_KADEME3 = 0)
		END
		
		IF @ISLEM = 4	--	Kullanıcı Menü Yetki Kaydet
		BEGIN			

			DELETE MenuKullaniciYetki where TCKIMLIKNO=@TC_YETKI

			INSERT INTO MenuKullaniciYetki(TCKIMLIKNO,ID_MENU) 
			select @TC_YETKI, ID_MENU from OPENJSON(@SQLJSON)
			WITH (   
						  ID_MENU int,
						  YETKILI bit
			 )
			WHERE YETKILI=1


			SELECT KOD,LEN(KOD) / 3 AS SAYI 
			INTO #K 
			FROM Menu M 
			WHERE M.ID_MENU IN (SELECT ID_MENU FROM MenuKullaniciYetki MY WHERE MY.TCKIMLIKNO=@TC_YETKI)
			

			DECLARE @TABLE TABLE (ID_MENU INT)
			DECLARE @I INT=0

			WHILE @I<(SELECT MAX(SAYI) FROM #K)
			BEGIN
				INSERT INTO @TABLE(ID_MENU)
				SELECT M.ID_MENU FROM MENU M WHERE M.KOD IN (SELECT SUBSTRING(KOD,1,(@I*3)) FROM #K)
				
				SET @I+=1
			END

			INSERT INTO MenuKullaniciYetki(TCKIMLIKNO,ID_MENU) 			
			(SELECT @TC_YETKI,ID_MENU FROM @TABLE T WHERE T.ID_MENU NOT IN (SELECT ID_MENU FROM MenuKullaniciYetki MY WHERE MY.TCKIMLIKNO=@TC_YETKI))
			
			DROP TABLE #K


		END

		IF @ISLEM = 5	--	Kullanıcı Şube Sınıf Getir
		BEGIN
			SELECT
			(
				SELECT K.AD, K.SOYAD, S.AD AS SUBE, S.ID_SUBE, SNF.AD AS SINIF, SNF.ID_SINIF FROM OkyanusDB.dbo.v3Kullanici K 
				INNER JOIN OkyanusDB.dbo.v3SubeYetki SY ON SY.TCKIMLIKNO=K.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Sube S ON S.ID_SUBE=SY.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO=K.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Satislar SAT ON SAT.ID_SOZLESME=O.ID_SOZLESME
				INNER JOIN OkyanusDB.dbo.v3Donem D ON D.ID_DONEM=SAT.ID_DONEM
				INNER JOIN OkyanusDB.dbo.v3Sinif SNF ON SNF.ID_SINIF=SAT.ID_SINIF
				WHERE K.TCKIMLIKNO=@TCKIMLIKNO AND D.KOD=(SELECT KOD FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF=1)
				FOR JSON PATH
			) AS J
		END
	END

	END TRY
			BEGIN CATCH
			
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_MaddeFrekansAnalizi]...';


GO
ALTER procedure [dbo].[sp_MaddeFrekansAnalizi]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@OGRENCIDONEM		char(4)			= NULL,
	@ID_SUBEs			VARCHAR(MAX)	= NULL,
	@ID_SINAVs			VARCHAR(MAX)	= NULL,
	@ID_DERSs			VARCHAR(MAX)	= NULL,
	@SINIFALANLIST		VARCHAR(MAX)	= NULL,
	@ID_KADEME3			INT				= NULL,
	@SQLJSON			NVARCHAR(MAX)	= NULL,
	@DONEM				char(4)			= NULL,
	@ID_SINIFs			VARCHAR(MAX)	= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_DERS			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@ID_SINAVTURU		INT				= NULL,
	@ICDISOGRENCI		INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM						= @ISLEM			
			,TCKIMLIKNO					= @TCKIMLIKNO		
			,OTURUM						= @OTURUM			
			,ID_MENU					= @ID_MENU		
			,OGRENCIDONEM				= @OGRENCIDONEM	
			,ID_SUBEs					= @ID_SUBEs		
			,ID_SINAVs					= @ID_SINAVs		
			,ID_DERSs					= @ID_DERSs		
			,SINIFALANLIST				= @SINIFALANLIST	
			,ID_KADEME3					= @ID_KADEME3		
			,SQLJSON					= @SQLJSON		
			,DONEM						= @DONEM			
			,ID_SINIFs					= @ID_SINIFs		
			,ID_SINAV					= @ID_SINAV		
			,ID_DERS					= @ID_DERS		
			,ID_SUBE					= @ID_SUBE		
			,ID_SINIF					= @ID_SINIF		
			,ID_SINAVTURU				= @ID_SINAVTURU	
			,ICDISOGRENCI				= @ICDISOGRENCI	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

	IF @ID_LOG > 1
	BEGIN
		DECLARE  @OZELSINAVGOR BIT=0
		IF EXISTS ( SELECT TOP 1 1 FROM OkyanusDB.DBO.v3SubeYetki WHERE TCKIMLIKNO= @TCKIMLIKNO AND ID_KULLANICITIPI IN (1,60) ) -- ADMİN VEYA ÖD İSE ÖZEL SINAVLARI GÖRECEK
		BEGIN
			SET @OZELSINAVGOR=1
		END

		IF @OGRENCIDONEM IS NULL OR @OGRENCIDONEM = '' SET @OGRENCIDONEM = (SELECT DONEM FROM v3AktifDonem WHERE AKTIF = 1 )


		IF (@ISLEM = 1 OR @ISLEM = 2)  -- 
		BEGIN
					
			IF @ICDISOGRENCI IS NULL 
				SET @ICDISOGRENCI = 0
			
			DROP TABLE IF EXISTS #ALTCEVAPLAR
			DROP TABLE IF EXISTS #ALTGRUP
			DROP TABLE IF EXISTS #DERECE
			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TEMP_OGRENCI
			DROP TABLE IF EXISTS #USTCEVAPLAR
			DROP TABLE IF EXISTS #USTGRUP
			DROP TABLE IF EXISTS #SINAVBILGI
			DROP TABLE IF EXISTS #CEVAPLAR
			DROP TABLE IF EXISTS #DERS
			DROP TABLE IF EXISTS #OGRSAY
			DROP TABLE IF EXISTS #SINIFALAN
			DROP TABLE IF EXISTS #SINIFLIST
			DROP TABLE IF EXISTS #SUBE
			DROP TABLE IF EXISTS #SINAV
			
			DROP TABLE IF EXISTS #ID_DERS
			SELECT VALUE ID_DERS INTO #ID_DERS FROM OPENJSON(@ID_DERSs)

			SELECT DERSAD INTO #DERS 
			from eokul_v2.dbo.Ders DA
			WHERE	(EXISTS(SELECT 1 FROM #ID_DERS D WHERE D.ID_DERS = DA.ID_DERS))
				OR (NOT EXISTS (SELECT 1 FROM #ID_DERS)  AND @ID_DERSs ='[]' AND DA.ID_KADEME3	=  @ID_KADEME3)
			DROP TABLE IF EXISTS #ID_DERS
			
			SELECT VALUE ALAN		INTO #SINIFALAN	FROM OPENJSON(@SINIFALANLIST)
			SELECT VALUE ID_SUBE	INTO #SUBE		FROM OPENJSON(@ID_SUBEs )
			SELECT VALUE ID_SINAV	INTO #SINAV		FROM OPENJSON(@ID_SINAVs)

			
			SELECT T.* 
			INTO #SINIFLIST
			FROM v3SinifTum	T
			JOIN v3Donem	D	ON	D.ID_DONEM	= T.ID_DONEM
			JOIN #SUBE		S	ON	S.ID_SUBE	= D.ID_SUBE
			WHERE	T.DONEM			= @OGRENCIDONEM
				AND @ICDISOGRENCI	IN (0,1)
				AND (	(SELECT COUNT(1) FROM #SINIFALAN) = 0
					OR	EXISTS (SELECT 1 FROM #SINIFALAN A WHERE T.AD LIKE '%'+ A.ALAN +'%')
					)

			SELECT	 S.ID_SINAV
					,S.AD SINAVAD
					,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH
					,SO.TCKIMLIKNO
					,VD.DERSAD DERSAD
					,SB.NET
					,DOGRU
					,OC.DURUM
					,OC.CEVAP OGRENCICEVAP
					,SA.CEVAP DOGRUCEVAP 
					,SA.SORUNO_A
					,SD.BOLUMNO 
					,ISNULL(SA.KOD,'') KOD 
					,S.OLCEKSINAVI 
					,SA.KATSAYI
			INTO	#TEMP_OGRENCI
			FROM	Pusulam.dbo.Sinav					S	WITH (NOLOCK)
			JOIN	#SINAV								TS					ON	TS.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.v3OgrenciTum			O	WITH (NOLOCK)	ON	O.TCKIMLIKNO					= SO.TCKIMLIKNO
			JOIN	#SINIFLIST							SL	WITH (NOLOCK)	ON	SL.ID_SINIF						= O.ID_SINIF	
			JOIN	Pusulam.dbo.SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI 
			JOIN	Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders					VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			JOIN	#DERS								VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			JOIN	Pusulam.dbo.SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM 
			JOIN	Pusulam.dbo.SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD							= SO.KITAPCIK 
																			AND SD.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																			AND SA.SORUNO						= OC.SORUNO
																			AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
			WHERE	S.AKTIF			=  1
				AND S.DURUM			=  2
				AND (OZEL = 0		OR @OZELSINAVGOR = 1)
				AND @ICDISOGRENCI	= 1

		UNION 

			SELECT	 S.ID_SINAV
					,S.AD SINAVAD
					,CONVERT(VARCHAR,SINAVTARIH,103) SINAVTARIH
					,SO.TCKIMLIKNO
					,VD.DERSAD DERSAD
					,SB.NET
					,DOGRU
					,OC.DURUM
					,OC.CEVAP OGRENCICEVAP
					,SA.CEVAP DOGRUCEVAP 
					,SA.SORUNO_A
					,SD.BOLUMNO 
					,ISNULL(SA.KOD,'') KOD 
					,S.OLCEKSINAVI 
					,SA.KATSAYI
			FROM	Pusulam.dbo.Sinav					S	WITH (NOLOCK)
			JOIN	#SINAV								TS					ON	TS.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavOgrenci			SO	WITH (NOLOCK)	ON	SO.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.v3Sube					SUB	WITH (NOLOCK)	ON	CAST(SUB.SUBENO AS INT)			= CAST(SO.SUBENO AS INT)
			JOIN	#SUBE								TB					ON	TB.ID_SUBE						= SUB.ID_SUBE
			JOIN	Pusulam.dbo.SinavOgrenciCevapBolum	SB	WITH (NOLOCK)	ON	SB.ID_SINAVOGRENCI				= SO.ID_SINAVOGRENCI 
			JOIN	Pusulam.dbo.SinavDers				SD	WITH (NOLOCK)	ON	SD.ID_SINAVDERS					= SB.ID_SINAVDERS
			JOIN	eokul_v2.dbo.Ders					VD	WITH (NOLOCK)	ON	VD.ID_DERS						= SD.ID_DERS
			JOIN	#DERS								VD2	WITH (NOLOCK)	ON	VD2.DERSAD						= VD.DERSAD
			JOIN	Pusulam.dbo.SinavOgrenciCevap		OC  WITH (NOLOCK)	ON	OC.ID_SINAVOGRENCICEVAPBOLUM	= SB.ID_SINAVOGRENCICEVAPBOLUM 
			JOIN	Pusulam.dbo.SinavKitapcik			SK  WITH (NOLOCK)	ON	SK.AD							= SO.KITAPCIK 
																			AND SD.ID_SINAV						= S.ID_SINAV
			JOIN	Pusulam.dbo.SinavAnahtar			SA	WITH (NOLOCK)	ON	SA.ID_SINAVDERS					= SD.ID_SINAVDERS
																			AND SA.SORUNO						= OC.SORUNO
																			AND SA.ID_SINAVKITAPCIK				= SK.ID_SINAVKITAPCIK
			WHERE	S.AKTIF			=  1
				AND S.DURUM			=  2
				AND (OZEL = 0		OR @OZELSINAVGOR = 1)
				AND (@ICDISOGRENCI	= 0
					OR (	@ICDISOGRENCI	= 2  
						AND SUBSTRING(SO.SINIF,1,4) = 'OKY-'
						)
					)

			DROP TABLE IF EXISTS #TEMP
			SELECT  DURUM, COUNT(DURUM) DURUMSAYISI,0 KISISAYISI, DERSAD, BOLUMNO, SORUNO_A, 0 CEVAPLAYANSAYISI
			INTO #TEMP
			FROM #TEMP_OGRENCI T
			GROUP BY BOLUMNO, SORUNO_A,DURUM, DERSAD

			UPDATE T
			SET  KISISAYISI			=		 (SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO)				
				,CEVAPLAYANSAYISI	= ISNULL((SELECT SUM(DURUMSAYISI) FROM #TEMP G WHERE G.SORUNO_A=T.SORUNO_A AND G.BOLUMNO = T.BOLUMNO AND DURUM != 'B'),0)
			FROM #TEMP T

			DROP TABLE IF EXISTS #OGRENCIBOLUMNET
			SELECT DISTINCT TCKIMLIKNO,BOLUMNO,DOGRU NET, RN = 0 ,MAX_RN = 0
			INTO #OGRENCIBOLUMNET
			FROM #TEMP_OGRENCI 

			UPDATE O 
			SET O.RN=G.RN2
			FROM #OGRENCIBOLUMNET O 
			JOIN (	SELECT D.BOLUMNO, D.TCKIMLIKNO, RN2 = ROW_NUMBER() OVER(PARTITION BY D.BOLUMNO ORDER BY D.NET DESC,D.TCKIMLIKNO)  
					FROM #OGRENCIBOLUMNET D
				) AS G	ON	G.TCKIMLIKNO	= O.TCKIMLIKNO 
						AND G.BOLUMNO		= O.BOLUMNO
				
			UPDATE O 
			SET O.MAX_RN = D.MAX_RN
			FROM #OGRENCIBOLUMNET O 
			JOIN (
				SELECT MAX(RN) MAX_RN , BOLUMNO
				FROM #OGRENCIBOLUMNET S 
				GROUP BY S.BOLUMNO 
			) AS D ON D.BOLUMNO = O.BOLUMNO
				
				DROP TABLE IF EXISTS #OGRSAY
				SELECT BOLUMNO, OGRSAY = IIF( O.MAX_RN > 100, cast(O.MAX_RN * 27 / 100.0 as int) ,CAST(CAST(O.MAX_RN AS DECIMAL(8,2)) / 2 AS DECIMAL(8,2)))
				INTO #OGRSAY
				FROM #OGRENCIBOLUMNET O
				GROUP BY BOLUMNO, MAX_RN

				--DECLARE @OGRSAY INT = (SELECT TOP 1 cast(O.MAX_RN * 27 / 100.0 as int)  FROM #OGRENCIBOLUMNET O)

				DROP TABLE IF EXISTS #ALTGRUP
				SELECT O.* 
				INTO #ALTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN >= O.MAX_RN - S.OGRSAY + 1
					--	(	O.MAX_RN > 100	AND RN >= O.MAX_RN - S.OGRSAY + 1 )
					--OR	(	O.MAX_RN <= 100 AND RN > CAST(O.MAX_RN / 2 AS INT) )
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
								
				DROP TABLE IF EXISTS #USTGRUP
				SELECT O.* 
				INTO #USTGRUP
				FROM #OGRENCIBOLUMNET	O
				JOIN #OGRSAY			S	ON	S.BOLUMNO = O.BOLUMNO
				WHERE	RN <= S.OGRSAY
					--(	O.MAX_RN > 100  AND RN <= S.OGRSAY )
					--OR (	O.MAX_RN <= 100 AND RN <= CAST(O.MAX_RN / 2 AS INT))
				ORDER BY BOLUMNO,RN,NET DESC,TCKIMLIKNO
			
				--SELECT * FROM #OGRSAY where bolumno = 1
				--SELECT * FROM #USTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #ALTGRUP where bolumno = 1 ORDER BY rn
				--SELECT * FROM #TEMP_OGRENCI where bolumno = 1 and SORUNO_A = 1

			DROP TABLE IF EXISTS #DERECE
			SELECT 
				 O.BOLUMNO
				,O.SORUNO_A
				,O.DURUM
				,O.DERSAD
				,O.DOGRUCEVAP
				,O.KOD
				,TOPLAMYANIT		= T.KISISAYISI
				,DOGRUSAYISI		= ISNULL(T.DURUMSAYISI,0)
				,YANLISSAYISI		= 0
				,BOSSAYISI			= 0
				,USTKISISAYISI		= COUNT(DISTINCT U.TCKIMLIKNO)
				,ALTKISISAYISI		= COUNT(DISTINCT A.TCKIMLIKNO)
				,ZORLUKDERECESI		= CONVERT(DECIMAL(8,2),	CASE	WHEN	O.OLCEKSINAVI = 0 THEN	CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float) /NULLIF(CAST((S.OGRSAY * 2) AS float),0.0)
																	ELSE	CAST(COUNT(DISTINCT U.TCKIMLIKNO) + COUNT(DISTINCT A.TCKIMLIKNO) AS float) /  (NULLIF(CAST((S.OGRSAY * 2) AS float),0.0) * O.KATSAYI)
																	END
															)
				,AYIRICILIK			= CONVERT(DECIMAL(8,2),	CASE	WHEN	O.OLCEKSINAVI = 0 THEN	CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  NULLIF(CAST(S.OGRSAY AS float),0.0)
																	ELSE	CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  (NULLIF(CAST(S.OGRSAY AS float),0.0) * O.KATSAYI)
																	END
															)
				--CAST((COUNT(DISTINCT U.TCKIMLIKNO) - COUNT(DISTINCT A.TCKIMLIKNO)) AS float) /  NULLIF(CAST(S.OGRSAY AS float),0.0) ) 
				,SAPMA				= CONVERT(DECIMAL(8,2),0)
				,VARYANS			= CONVERT(DECIMAL(8,2),0)
				,MADDEGUVENILIRLIK	= CONVERT(DECIMAL(8,2),0)
				,KR20				= CONVERT(DECIMAL(8,2),0)
			INTO #DERECE
			FROM #TEMP			T
			JOIN #TEMP_OGRENCI	O	ON	O.BOLUMNO		= T.BOLUMNO
									AND O.SORUNO_A		= T.SORUNO_A
									AND O.DURUM			= T.DURUM
			JOIN #OGRSAY		S	ON	S.BOLUMNO		= O.BOLUMNO
			LEFT JOIN #USTGRUP	U	ON	U.TCKIMLIKNO	= O.TCKIMLIKNO 
									AND U.BOLUMNO		= O.BOLUMNO
			LEFT JOIN #ALTGRUP	A	ON	A.TCKIMLIKNO	= O.TCKIMLIKNO
									AND A.BOLUMNO		= O.BOLUMNO
			WHERE O.DURUM = 'D'
			GROUP BY O.BOLUMNO, O.SORUNO_A,O.DURUM,O.DERSAD,T.KISISAYISI,O.DOGRUCEVAP,T.DURUMSAYISI,O.KOD,T.CEVAPLAYANSAYISI,S.OGRSAY,O.OLCEKSINAVI, O.KATSAYI
			
			UPDATE #DERECE	SET
				BOSSAYISI	= B.DURUMSAYISI
			FROM #DERECE	T
			JOIN #TEMP		B	ON	B.BOLUMNO		= T.BOLUMNO
								AND B.SORUNO_A		= T.SORUNO_A
								AND B.DURUM			= 'B'
								
			UPDATE #DERECE	SET
				YANLISSAYISI	= Y.DURUMSAYISI
			FROM #DERECE	T
			JOIN #TEMP		Y	ON	Y.BOLUMNO		= T.BOLUMNO
								AND Y.SORUNO_A		= T.SORUNO_A
								AND Y.DURUM			= 'Y'

			DECLARE @VARYANS FLOAT,@V1  FLOAT,@P FLOAT,@KR20 DECIMAL(8,4)

			SET @V1			= (SELECT CONVERT(DECIMAL(8,2),SUM(DOGRUSAYISI))/MAX(TOPLAMYANIT) FROM #DERECE)				
			SET @VARYANS	= (SELECT SQUARE(SUM(CONVERT(DECIMAL(8,2),DOGRUSAYISI)-@V1)) / MAX(TOPLAMYANIT) FROM #DERECE)
			SET @P			= (SELECT SUM(  (CAST(DOGRUSAYISI AS DECIMAL(8,2))/TOPLAMYANIT)*ABS(1-CAST(DOGRUSAYISI AS DECIMAL(8,2))/TOPLAMYANIT)  ) FROM #DERECE)
			SET @KR20		= (SELECT CONVERT(DECIMAL(8,4), (COUNT(1)/(COUNT(1)-1))*(1-(@P/NULLIF(@VARYANS, 0.0)))) FROM #DERECE)

			--DECLARE @TOPLAMSORUSAYISI INT 
			--SET @TOPLAMSORUSAYISI = 
			--(SELECT SUM(SORUSAYISI) FROM (SELECT COUNT(DISTINCT SORUNO_A) SORUSAYISI				
			--FROM #TEMP
			--GROUP BY BOLUMNO, DERSAD) AS SS)

			DROP TABLE IF EXISTS #OGRBOLUMDOGRU
			SELECT BOLUMNO, MAX(DOGRU) DOGRU, TCKIMLIKNO
			INTO #OGRBOLUMDOGRU
			FROM #TEMP_OGRENCI 
			GROUP BY BOLUMNO,TCKIMLIKNO

			SELECT DISTINCT 
				 SINAVAD
				,SINAVTARIH
				,SINAVKATILIM		= COUNT(DISTINCT TCKIMLIKNO) 
				,TOPLAMSORUSAYISI	= (SELECT COUNT(1) FROM(SELECT G.BOLUMNO, G.SORUNO_A FROM #TEMP G GROUP BY G.BOLUMNO, G.SORUNO_A) AS TS) 
				,ORTALAMADOGRU		= (SELECT CAST(CAST( SUM(DOGRU)  AS FLOAT) / COUNT(DISTINCT TCKIMLIKNO) AS DECIMAL(8,2)) FROM #OGRBOLUMDOGRU )  --(SELECT CONVERT(DECIMAL(8,2),AVG(CONVERT(DECIMAL(8,2),DOGRUSAYISI))) FROM #DERECE)
				,KR20				= ISNULL(@KR20, 0)
			INTO #SINAVBILGI
			FROM #TEMP_OGRENCI 
			GROUP BY SINAVAD,SINAVTARIH
			
			DROP TABLE IF EXISTS #OGRBOLUMDOGRU

			--DECLARE @StandartSapma INT
			--SELECT @StandartSapma=STDEV(NET) FROM #TEMP_OGRENCI

			UPDATE D
			SET	 VARYANS			= ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI))
				,SAPMA				= SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)))
				,MADDEGUVENILIRLIK	= Convert(Decimal(8,2),isnull(D.AYIRICILIK*SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI))),0.00))
										--((	-- (Select AVG(Convert(Decimal(8,2),DOGRUSAYISI))-AVG(Convert(Decimal(8,2),YANLISSAYISI)) from #DERECE G WHERE G.BOLUMNO = D.BOLUMNO)
										--	--*(SQRT(ABS(ZORLUKDERECESI * ( 1 - ZORLUKDERECESI)))))
										--	D.AYIRICILIK
										--)
										--	*NULLIF(@StandartSapma,0)))
										--,0)
					
			FROM #DERECE D
				
			SELECT	 BOLUMNO,SORUNO_A
					,A	= ISNULL(P.A,0)
					,B	= ISNULL(P.B,0)
					,C	= ISNULL(P.C,0)
					,D	= ISNULL(P.D,0)
					,E	= ISNULL(P.E,0)
					,BOS= ISNULL(P.BOS,0)
					,TOPLAM= ISNULL(P.A,0)+ISNULL(P.B,0)+ISNULL(P.C,0)+ISNULL(P.D,0)+ISNULL(P.E,0)+ISNULL(P.BOS,0)
			INTO #CEVAPLAR
			FROM (
				SELECT CASE WHEN OGRENCICEVAP = '' THEN 'BOS' ELSE OGRENCICEVAP END OGRENCICEVAP,COUNT(OGRENCICEVAP) AS  CEVAPSAYISI,BOLUMNO,SORUNO_A FROM #TEMP_OGRENCI
				GROUP BY OGRENCICEVAP,BOLUMNO,SORUNO_A
			) AS G
			PIVOT ( MAX(CEVAPSAYISI) FOR OGRENCICEVAP IN ([A],[B],[C],[D],[E],[BOS]))  AS P
			ORDER BY BOLUMNO,SORUNO_A

			IF @ISLEM = 1  -- JSON
			BEGIN
				select(
					select * from(
						select 
						(	
							
								SELECT  DISTINCT
										 BOLUMNO		 AS 'BOLUMNO'
										,DERSAD			 AS 'DERSAD'
										,COUNT(DISTINCT SORUNO_A) SORUSAYISI
										,(
													SELECT  
														 G.SORUNO_A				AS 'SORUNO_A'
														,G.DOGRUCEVAP			AS 'DOGRUCEVAP'
														,G.KOD					AS 'KOD'
														,G.TOPLAMYANIT			AS 'TOPLAMYANIT'
														,G.DOGRUSAYISI			AS 'DOGRUSAYISI'
														,G.YANLISSAYISI			AS 'YANLISSAYISI'
														,G.BOSSAYISI			AS 'BOSSAYISI'
														,G.USTKISISAYISI		AS 'USTKISISAYISI'
														,G.ALTKISISAYISI		AS 'ALTKISISAYISI'
														,G.ZORLUKDERECESI		AS 'ZORLUKDERECESI'
														,G.AYIRICILIK			AS 'AYIRICILIK'			
														,G.SAPMA				AS 'SAPMA'	
														,G.VARYANS				AS 'VARYANS'	
														,G.MADDEGUVENILIRLIK	AS 'MADDEGUVENILIRLIK'	
														,
															case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
																	when ZORLUKDERECESI < 0.35 then 'Zor'
																	when ZORLUKDERECESI < 0.65 then 'Önerilen'
																	when ZORLUKDERECESI < 0.80 then 'Kolay'
																	when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
															end as 'ZORLUKACIKLAMA',
															case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     														when AYIRICILIK < 0.30 then 'Sınırda'
		   															when AYIRICILIK < 0.40 then 'İyi'
		     														when AYIRICILIK > 0.39 then 'Çok İyi' 
															end as 'AYIRICILIKACIKLAMA'
														,isnull((case	WHEN ((ZORLUKDERECESI< 0.60	)						AND (AYIRICILIK < 0.20 ))		THEN 'Zor ve ayırt edici olmayan madde'
																		WHEN ((ZORLUKDERECESI< 0.60	)						AND (AYIRICILIK >=0.20 ))		THEN 'Zor fakat ayırt edici bir madde'
																		WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK < 0.20 ))	THEN 'Üzerinde çalışılması gereken madde'
																		WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK >=0.20 ))	THEN 'Tipik iyi madde'
																		WHEN ((ZORLUKDERECESI> 0.90))														THEN 'Eğer etkili bir öğretim varsa tercih edilir.'
																END),-1)  AS 'KALITE' --AS KALITE
														,C.A AS 'CEVAPLIST.A'
														,C.B AS 'CEVAPLIST.B'
														,C.C AS 'CEVAPLIST.C'
														,C.D AS 'CEVAPLIST.D'
														,C.E AS 'CEVAPLIST.E'
													FROM #DERECE	G
													JOIN #CEVAPLAR	C	ON	C.BOLUMNO	= G.BOLUMNO
																		AND C.SORUNO_A	= G.SORUNO_A
													WHERE G.BOLUMNO = D.BOLUMNO
													ORDER BY SORUNO_A
													FOR JSON PATH							
										) AS 'SORULIST'					
								FROM #DERECE D
								GROUP BY BOLUMNO,DERSAD
								FOR JSON PATH, INCLUDE_NULL_VALUES
						) as TblVeri,					
						(									
							SELECT 
								 SINAVAD
								,SINAVTARIH
								,SINAVKATILIM		
								,TOPLAMSORUSAYISI	
								,ORTALAMADOGRU		
								,KR20			
							FROM #SINAVBILGI
							FOR JSON AUTO, INCLUDE_NULL_VALUES
						) as TblSinavOzellik	,		
						(		
							SELECT BOLUMNO, DERSAD, COUNT(DISTINCT SORUNO_A) SORUSAYISI
							FROM #TEMP
							GROUP BY BOLUMNO, DERSAD
							ORDER BY BOLUMNO,DERSAD
							FOR JSON AUTO, INCLUDE_NULL_VALUES
						) as TblDersList						
						
					) as tablo 
					FOR JSON AUTO, INCLUDE_NULL_VALUES
				) as tt				

			END
			ELSE
			BEGIN
				SELECT D.*,
								case	when ZORLUKDERECESI < 0.20 then 'Çok Zor'
										when ZORLUKDERECESI < 0.35 then 'Zor'
										when ZORLUKDERECESI < 0.65 then 'Önerilen'
										when ZORLUKDERECESI < 0.80 then 'Kolay'
										when ZORLUKDERECESI > 0.79 then 'Çok Kolay' 
								end as [ZORLUKACIKLAMA],
								case 	when AYIRICILIK < 0.20 then 'Zayıf'
		     							when AYIRICILIK < 0.30 then 'Sınırda'
		   								when AYIRICILIK < 0.40 then 'İyi'
		     							when AYIRICILIK > 0.39 then 'Çok İyi' 
								end as [AYIRICILIKACIKLAMA],
					isnull((case	WHEN ((ZORLUKDERECESI< 0.60	)							AND (AYIRICILIK < 0.20 ))	THEN 'Zor ve ayırt edici olmayan madde'
									WHEN ((ZORLUKDERECESI< 0.60	)							AND (AYIRICILIK >=0.20 ))	THEN 'Zor fakat ayırt edici bir madde'
									WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK < 0.20 ))	THEN 'Üzerinde çalışılması gereken madde'
									WHEN ((ZORLUKDERECESI>=0.60	AND	ZORLUKDERECESI <=0.90)	AND (AYIRICILIK >=0.20 ))	THEN 'Tipik iyi madde'
									WHEN ((ZORLUKDERECESI> 0.90))														THEN 'Eğer etkili bir öğretim varsa tercih edilir.'
							END),-1)  AS 'KALITE' --AS KALITE
					,ASAYISI	= C.A 
					,BSAYISI	= C.B 
					,CSAYISI	= C.C 
					,DSAYISI	= C.D 
					,ESAYISI	= C.E 
					,C.BOLUMNO,C.SORUNO_A
				FROM #DERECE	D
				JOIN #CEVAPLAR	C	ON	C.BOLUMNO	= D.BOLUMNO
									AND C.SORUNO_A	= D.SORUNO_A 
				ORDER BY D.BOLUMNO,D.SORUNO_A
				
				SELECT 
					 SINAVAD
					,SINAVTARIH
					,SINAVKATILIM		
					,TOPLAMSORUSAYISI	
					,ORTALAMADOGRU		
					,KR20				
				FROM #SINAVBILGI
									
				SELECT BOLUMNO, DERSAD, COUNT(DISTINCT SORUNO_A) SORUSAYISI
				FROM #TEMP
				GROUP BY BOLUMNO, DERSAD
				ORDER BY BOLUMNO,DERSAD
				
			END
			


			
			
			
				DROP TABLE IF EXISTS #ALTCEVAPLAR
				DROP TABLE IF EXISTS #ALTGRUP
				DROP TABLE IF EXISTS #DERECE
				DROP TABLE IF EXISTS #OGRENCIBOLUMNET
				DROP TABLE IF EXISTS #TEMP
				DROP TABLE IF EXISTS #TEMP_OGRENCI
				DROP TABLE IF EXISTS #USTCEVAPLAR
				DROP TABLE IF EXISTS #USTGRUP
				DROP TABLE IF EXISTS #SINAVBILGI
				DROP TABLE IF EXISTS #CEVAPLAR
				DROP TABLE IF EXISTS #DERS
				DROP TABLE IF EXISTS #OGRSAY
				DROP TABLE IF EXISTS #SINIFALAN
				DROP TABLE IF EXISTS #SINIFLIST



		END
			
	END

	END TRY
			BEGIN CATCH
				DECLARE @_ErrorSeverity INT;
				DECLARE @_ErrorState INT;

				SELECT 
					@_ErrorSeverity	= ERROR_SEVERITY(),
					@_ErrorState		= ERROR_STATE()
				
				DECLARE @_MSG VARCHAR(4000)
				SELECT @_MSG = ERROR_MESSAGE()

				EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
			END CATCH;
	
	END
GO
PRINT N'Altering [dbo].[sp_Morpa]...';


GO
ALTER procedure [dbo].[sp_Morpa]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	
	@ID_KADEME3			INT				= NULL,
	@ID_MORPAKAZANIM	INT				= NULL,
	@ID_MORPAMATERYAL	INT				= NULL,
	@ID					INT				= NULL,
	@PASIFGORUNSUN		BIT				= NULL,
	@AKTIF				BIT				= NULL,
	@DERSAD				VARCHAR(100)	= NULL,

	@AD					VARCHAR(100)	= NULL,
	@KOD				VARCHAR(100)	= NULL,
	@KOD_OKY			VARCHAR(100)	= NULL,

	@ID_MORPADERS		INT				= NULL,
	@SQLJSON			VARCHAR(MAX)	= NULL
AS
BEGIN
	
	
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM				= @ISLEM				
				,TCKIMLIKNO			= @TCKIMLIKNO			
				,OTURUM				= @OTURUM				
				,ID_MENU			= @ID_MENU		

				,ID_KADEME3			= @ID_KADEME3			
				,ID_MORPAKAZANIM	= @ID_MORPAKAZANIM	
				,ID_MORPAMATERYAL	= @ID_MORPAMATERYAL	
				,ID					= @ID
				,PASIFGORUNSUN		= @PASIFGORUNSUN		
				,AKTIF				= @AKTIF				
				,DERSAD				= @DERSAD		

				,AD					= @AD					
				,KOD				= @KOD				
				,KOD_OKY			= @KOD_OKY			
				
				,ID_MORPADERS		= @ID_MORPADERS		
				,SQLJSON			= @SQLJSON		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @_ID_LOG INT = 0

	BEGIN TRY    
		DECLARE @_DESTEK_KONTROL INT
		EXEC @_ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		

		IF @_ID_LOG > 0
		BEGIN
			
			IF @ISLEM = 1	--	DERS LİSTESİ	
			BEGIN
				SELECT ISNULL((
					SELECT DISTINCT ID_MORPADERS, AD, AKTIF
					FROM MorpaDers
					WHERE	ID_KADEME3 = @ID_KADEME3
						AND	(AKTIF = 1 OR @PASIFGORUNSUN = 1 )
					FOR JSON PATH
				),'[]')
			END
			
			IF @ISLEM = 2	--	DERS EKLE		
			BEGIN
				IF NOT EXISTS( SELECT 1 FROM MorpaDers WHERE ID_MORPADERS = @ID_MORPADERS)
				BEGIN

					INSERT INTO MorpaDers (ID_MORPADERS, AD, ID_KADEME3, KYE_TCKIMLIKNO)
					VALUES (@ID_MORPADERS, @DERSAD, @ID_KADEME3, @TCKIMLIKNO)

				END
				ELSE
				BEGIN
					DECLARE @YAZ VARCHAR(150)= CAST(@ID_MORPADERS AS varchar) + ' ID li Ders Daha Önce Eklenmiştir.'
					RAISERROR(@YAZ, 16,1)
				END
			END

			IF @ISLEM = 3	--	AKTIF/PASIF		
			BEGIN

				UPDATE MorpaDers SET
					AKTIF = @AKTIF
				WHERE ID_MORPADERS = @ID_MORPADERS
				
			END
			
			IF @ISLEM = 4	--	DERS DÜZENLE	
			BEGIN
				UPDATE MorpaDers SET
					AD = @DERSAD
				WHERE ID_MORPADERS = @ID_MORPADERS
			END

			---------------------------------------	KAZANIM
			
			IF @ISLEM = 5	--	KAZANIM LİSTESİ	
			BEGIN
				SELECT ISNULL((
					SELECT DISTINCT ID_MORPADERS, ID_MORPAKAZANIM, AD, KOD, KOD_OKY, AKTIF
					FROM MorpaKazanim
					WHERE	ID_MORPADERS = @ID_MORPADERS
						AND	(AKTIF = 1 OR @PASIFGORUNSUN = 1 )
					ORDER BY KOD
					FOR JSON PATH
				),'[]')
			END
			
			IF @ISLEM = 6	--	KAZANIM EKLE	
			BEGIN
				IF @KOD_OKY = ''
					SET @KOD_OKY = NULL

				IF (NOT EXISTS( SELECT 1 FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD = @KOD_OKY) AND @KOD_OKY IS NOT NULL)				
				BEGIN
					DECLARE @YAZ66 VARCHAR(150)= @KOD + ' Kodlu Kazanım Okyanus Kazanımlarda Bulunmamaktadır.'
					RAISERROR(@YAZ66, 16,1)
					RETURN
				END
				ELSE
				BEGIN
					--IF NOT EXISTS( SELECT * FROM MorpaKazanim WHERE KOD = @KOD)
					--BEGIN

						INSERT INTO MorpaKazanim (ID_MORPADERS, AD, KOD, KOD_OKY, KYE_TCKIMLIKNO)
						VALUES (@ID_MORPADERS, @AD, @KOD, @KOD_OKY, @TCKIMLIKNO)

					--END
					--ELSE
					--BEGIN
					--	DECLARE @YAZ6 VARCHAR(150)= @KOD + ' Kodlu Kazanım Daha Önce Eklenmiştir.'
					--	RAISERROR(@YAZ6, 16,1)
					--END
				END
			END

			IF @ISLEM = 7	--	AKTIF/PASIF		
			BEGIN
				--IF EXISTS (SELECT * FROM ODEV O JOIN OdevMorpaKazanim OK ON OK.ID_ODEV = O.ID_ODEV WHERE OK.ID_MORPAKAZANIM = @ID_MORPAKAZANIM AND O.AKTIF = 1)
				--BEGIN
				--	EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = 'Bu kazanım ödevlerde kullanıldığından pasif yapılamaz!', @SEVERITY = 16, @STATE = 1, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 3
				--END
				--ELSE
				--BEGIN
					UPDATE MorpaKazanim SET
						AKTIF = @AKTIF
					WHERE ID_MORPAKAZANIM = @ID_MORPAKAZANIM
				--END				
			END
			
			IF @ISLEM = 8	--	KAZANIM DÜZENLE	
			BEGIN
				IF @KOD_OKY = ''
					SET @KOD_OKY = NULL

				IF (NOT EXISTS( SELECT 1 FROM OkyanusDB.dbo.v3SinavDersUnite WHERE KOD = @KOD_OKY) AND @KOD_OKY IS NOT NULL)				
				BEGIN
					DECLARE @YAZ8 VARCHAR(150)= @KOD + ' Kodlu Kazanım Okyanus Kazanımlarda Bulunmamaktadır.'
					RAISERROR(@YAZ8, 16,1)
					RETURN
				END
				ELSE
				BEGIN
					UPDATE MorpaKazanim SET
						AD		= @AD,
						KOD		= @KOD,
						KOD_OKY	= @KOD_OKY
					WHERE ID_MORPAKAZANIM = @ID_MORPAKAZANIM
				END
			END

			---------------------------------------	MATERYAL
			
			IF @ISLEM = 9	--	MATERYAL LİSTESİ
			BEGIN
				SELECT ISNULL((
					SELECT DISTINCT ID, ID_MORPADERS, ID_MORPAMATERYAL, AD, AKTIF
					FROM MorpaMateryal 
					WHERE	ID_MORPADERS = @ID_MORPADERS
						AND	(AKTIF = 1 OR @PASIFGORUNSUN = 1 )
					ORDER BY AD
					FOR JSON PATH
				),'[]')
			END
			
			IF @ISLEM = 10	--	MATERYAL EKLE	
			BEGIN
				
				INSERT INTO MorpaMateryal(ID_MORPAMATERYAL, ID_MORPADERS, AD, KYE_TCKIMLIKNO)
				VALUES (@ID_MORPAMATERYAL, @ID_MORPADERS, @AD, @TCKIMLIKNO)

			END

			IF @ISLEM = 11	--	AKTIF/PASIF		
			BEGIN

				UPDATE MorpaMateryal SET
					AKTIF = @AKTIF
				WHERE ID = @ID
				
			END
			
			IF @ISLEM = 12	--	MATERYAL DÜZENLE
			BEGIN
				UPDATE MorpaMateryal SET
					AD	= @AD
				WHERE ID = @ID
			END

			IF @ISLEM = 13	--	KAZANIM EXCEL YÜKLE
			BEGIN			
				SELECT @ID_MORPADERS AS ID_MORPADERS, KOD, AD, KOD_OKY, @TCKIMLIKNO AS KYE_TCKIMLIKNO
				INTO #T13
				FROM OPENJSON(@SQLJSON)
				WITH(
					KOD VARCHAR(MAX),
					AD VARCHAR(MAX),
					KOD_OKY VARCHAR(MAX)
				)

				IF EXISTS(	
							SELECT 1
							FROM #T13
							WHERE KOD_OKY <> '' AND KOD_OKY NOT IN (SELECT KOD FROM OkyanusDB.dbo.v3SinavDersUnite)
				)
				BEGIN
					DECLARE @YAZ13 VARCHAR(150)= 'Okyanus karşılıklarında okyanus sisteminde yer almayan bir kazanım kodu girilmiş!'
					EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @YAZ13, @SEVERITY = 16, @STATE = 1, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 3
				END
				ELSE
				BEGIN				
					UPDATE K SET K.AD = J.AD, K.KOD_OKY = J.KOD_OKY, K.AKTIF = 1
					FROM MorpaKazanim K
					JOIN #T13 J ON J.KOD = K.KOD 
					WHERE K.ID_MORPADERS = @ID_MORPADERS

					INSERT INTO MorpaKazanim (ID_MORPADERS, KOD, AD, KOD_OKY, KYE_TCKIMLIKNO)
					SELECT ID_MORPADERS, KOD, AD, KOD_OKY, KYE_TCKIMLIKNO FROM #T13
					WHERE KOD NOT IN (SELECT KOD FROM MorpaKazanim K WHERE K.ID_MORPADERS = @ID_MORPADERS)	
				END	
				
				DROP TABLE #T13
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState	= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @_ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_Odev]...';


GO
ALTER procedure [dbo].[sp_Odev]
	@ISLEM						INT				= NULL,
	@TCKIMLIKNO					VARCHAR(11)		= NULL,
	@OTURUM						VARCHAR(36)		= NULL,
	@ID_MENU					INT				= NULL,

	@ID_KADEME					INT				= NULL,
	@ID_ODEVTUR					INT				= NULL,
	@DURUM						BIT				= NULL,
	@ID_ODEV					INT				= NULL,
	@ID_SINIF					INT				= NULL,
	@TC_ODEVVEREN				VARCHAR(11)		= NULL,
	@SQLJSON					VARCHAR(MAX)	= NULL,

	@TC_OGRENCI					VARCHAR(11)		= NULL,
	@BASLANGIC_TARIHI			VARCHAR(MAX)	= NULL,
	@BITIS_TARIHI				VARCHAR(MAX)	= NULL,
	@DONEM						VARCHAR(4)		= NULL,
	@ID_DERS					INT				= NULL,

	@ID_DERSLIST				VARCHAR(MAX)	= NULL,
	@ID_KADEME3LIST				VARCHAR(MAX)	= NULL,
	@ID_SUBELIST				VARCHAR(MAX)	= NULL,
	@TC_OGRETMENLIST			VARCHAR(MAX)	= NULL,
	@TUR						INT				= NULL,
	@TC_OGRETMEN				VARCHAR(11)		= NULL,
	@RAPORMU					BIT				= 0,
	@APIKEY						VARCHAR(MAX)	= NULL,
	@GUNCELLEME					BIT				= NULL,
	@ID_ODEVSINIFOGRENCIDOSYA	INT				= NULL,
	@TAMAMLANDIDURUM			INT				= NULL,
	@OGRETMENODEVAD				VARCHAR(MAX)	= NULL,
	@OGRETMENODEVGUID			NVARCHAR(MAX)	= NULL,
	@OGRETMENUZANTI				NVARCHAR(MAX)	= NULL,
	@DOSYA						VARCHAR(MAX)	= NULL

AS
BEGIN

/*

	Değiştiren Adı		: Kadir Cengiz
	Değiştirilen Tarih	: 23.10.2020
	
	Öğrenci Ödev Dosya İşlemleri

	--	sp Alter
	--	ISLEM 6  UPDATE
	--	ISLEM 9  UPDATE
	--	ISLEM 10 UPDATE
	--	ISLEM 24 ADD
	--	ISLEM 24 ADD

*/

	DECLARE @ODEVKONTROLSURESI INT = -16
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 ISLEM						= @ISLEM
				,TCKIMLIKNO					= @TCKIMLIKNO
				,OTURUM						= @OTURUM
				,ID_MENU					= @ID_MENU

				,ID_KADEME					= @ID_KADEME			
				,ID_ODEVTUR					= @ID_ODEVTUR			
				,DURUM						= @DURUM				
				,ID_ODEV					= @ID_ODEV			
				,ID_SINIF					= @ID_SINIF			
				,TC_ODEVVEREN				= @TC_ODEVVEREN		
				,SQLJSON					= @SQLJSON			
											 
				,TC_OGRENCI					= @TC_OGRENCI			
				,BASLANGIC_TARIHI			= @BASLANGIC_TARIHI	
				,BITIS_TARIHI				= @BITIS_TARIHI		
				,DONEM						= @DONEM				
				,ID_DERS					= @ID_DERS			
											
				,ID_DERSLIST				= @ID_DERSLIST		
				,ID_KADEME3LIST				= @ID_KADEME3LIST		
				,ID_SUBELIST				= @ID_SUBELIST		
				,TC_OGRETMENLIST			= @TC_OGRETMENLIST	
				,TUR						= @TUR				
				,TC_OGRETMEN				= @TC_OGRETMEN		
				,RAPORMU					= @RAPORMU			
				,APIKEY						= @APIKEY
				,GUNCELLEME					= @GUNCELLEME
				,ID_ODEVSINIFOGRENCIDOSYA	= @ID_ODEVSINIFOGRENCIDOSYA
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
	DECLARE @ID_ODEVSINIFOGRENCI	INT 

	--BEGIN TRANSACTION [TranOdev]
	BEGIN TRY   
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
		IF @ID_LOG > 0
		BEGIN
			IF @ISLEM = 1 -- KADEME ÖDEV TÜR LİSTELE
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT OT.ID_ODEVTUR, OT.AD, CASE WHEN OTK.ID_KADEME IS NULL THEN 0 ELSE 1 END AS DURUM, @ID_KADEME AS ID_KADEME
					FROM OdevTur OT WITH(NOLOCK)
					LEFT JOIN OdevTurKademe OTK WITH(NOLOCK) ON OTK.ID_ODEVTUR = OT.ID_ODEVTUR AND OTK.ID_KADEME = @ID_KADEME
					ORDER BY OT.ID_ODEVTUR
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 2 -- KADEME ÖDEV TÜR DURUM EKLE/GÜNCELLE
			BEGIN
				IF @DURUM = 0
				BEGIN
					DELETE FROM OdevTurKademe WHERE ID_ODEVTUR = @ID_ODEVTUR AND ID_KADEME = @ID_KADEME
				END

				IF @DURUM = 1 AND NOT EXISTS (SELECT TOP 1 1 FROM OdevTurKademe WITH(NOLOCK) WHERE ID_ODEVTUR = @ID_ODEVTUR AND ID_KADEME = @ID_KADEME)
				BEGIN
					INSERT INTO OdevTurKademe(ID_ODEVTUR, ID_KADEME, KYE_KULLANICI)
					VALUES (@ID_ODEVTUR, @ID_KADEME, @TCKIMLIKNO)
				END
			END	
			
			IF @ISLEM = 3 -- ÖDEV KAYDET
			BEGIN
				DECLARE @AKTIFDONEM VARCHAR(4) 
				SELECT @AKTIFDONEM = DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1

				DECLARE @ID_ODEVTABLE TABLE (ID_ODEV INT)
				DECLARE @ID_ODEV3 INT

				INSERT INTO Odev (DONEM, ID_KADEME3, ID_DERS, ID_MORPADERS, ID_ODEVTUR, BASLIK, ACIKLAMA, VERILIS_TARIHI, TESLIM_TARIHI, KYE_KULLANICI)
				OUTPUT inserted.ID_ODEV INTO @ID_ODEVTABLE
				SELECT @AKTIFDONEM, ID_KADEME3, ID_DERS, ID_MORPADERS, ID_ODEVTUR, BASLIK, ACIKLAMA, VERILIS_TARIHI, TESLIM_TARIHI, @TCKIMLIKNO 
				FROM OPENJSON (@SQLJSON)
				WITH(
					ID_SUBE			INT,
					ID_KADEME		INT,
					ID_KADEME3		INT,
					ID_ODEVTUR		INT,
					ID_DERS			INT,
					ID_MORPADERS	INT,
					VERILIS_TARIHI	VARCHAR(MAX),
					TESLIM_TARIHI	VARCHAR(MAX),
					BASLIK			VARCHAR(MAX),
					ACIKLAMA		VARCHAR(MAX)
				)

				SELECT @ID_ODEV3 = ID_ODEV FROM @ID_ODEVTABLE

				SELECT DISTINCT ID_SINIF = SO.ID_SINIF, VALUE = JO.VALUE
				INTO #OGRENCISINIF
				FROM OPENJSON (@SQLJSON, '$.TC_OGRENCILIST') JO
				INNER JOIN OkyanusDB.dbo.vw_SinifOgrenci SO ON SO.TCKIMLIKNO = JO.VALUE

				INSERT INTO OdevSinif (ID_ODEV, ID_SINIF)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_SINIFLIST')
				WHERE VALUE <> '0' AND VALUE IN (SELECT ID_SINIF FROM #OGRENCISINIF)

				INSERT INTO OdevSinifOgrenci (ID_ODEVSINIF, TCKIMLIKNO)
				SELECT DISTINCT OS.ID_ODEVSINIF, SO.VALUE
				FROM #OGRENCISINIF SO
				INNER JOIN OdevSinif OS ON OS.ID_SINIF = SO.ID_SINIF AND OS.ID_ODEV = @ID_ODEV3
				WHERE SO.VALUE <> '0'

				DROP TABLE IF EXISTS #OGRENCISINIF

				INSERT INTO OdevLink (ID_ODEV, AD, LINK)
				SELECT @ID_ODEV3, AD, LINK
				FROM OPENJSON (@SQLJSON, '$.LINKLIST')
				WITH(
					AD VARCHAR(MAX),
					LINK VARCHAR(MAX)
				)
				WHERE LINK <> ''

				IF @DOSYA != ''
					INSERT INTO OdevDosya (ID_ODEV, AD, GUID, UZANTI)
					SELECT @ID_ODEV3, AD,GUID,UZANTI
					FROM OPENJSON(@DOSYA,'$.DOSYA')
					WITH(
						AD		VARCHAR(MAX),
						GUID	VARCHAR(MAX),
						UZANTI  VARCHAR(MAX)
					)			
				

				INSERT INTO OdevMorpaKazanim (ID_ODEV, ID_MORPAKAZANIM)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_MORPAKAZANIMLIST')
				WHERE VALUE <> 0

				INSERT INTO OdevMorpaMateryal(ID_ODEV, ID_MORPAMATERYAL)
				SELECT @ID_ODEV3, VALUE
				FROM OPENJSON (@SQLJSON, '$.ID_MORPAMATERYALLIST')
				WHERE VALUE <> 0

				SET @ISLEM		= 19
				SET @ID_ODEV	= @ID_ODEV3
				SET @GUNCELLEME	= 0
				GOTO Branch_Islem19;
			END	

			IF @ISLEM = 4 -- SINIF ÖDEV LİSTELE
			BEGIN
				SELECT
				ISNULL((
					SELECT	 O.ID_ODEV
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR, O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR, O.TESLIM_TARIHI, 104)
							,DURUM =	CASE 
										WHEN O.KONTROL = 1 AND EXISTS (SELECT TOP 1 1 FROM OdevSinifOgrenci OSO WHERE OSO.ID_ODEVSINIF = S.ID_ODEVSINIF AND OSO.ID_ODEVDURUM IS NOT NULL) THEN 1
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
										WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
										END
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif S WITH(NOLOCK) ON S.ID_ODEV = O.ID_ODEV
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					WHERE O.AKTIF = 1 
					AND KYE_KULLANICI = @TCKIMLIKNO
					AND S.ID_SINIF = @ID_SINIF
					ORDER BY O.VERILIS_TARIHI DESC
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 5 -- ÖDEV SİL
			BEGIN
				UPDATE Odev SET AKTIF = 0 WHERE ID_ODEV = @ID_ODEV
			END

			IF @ISLEM = 6 -- ÖDEV ÖĞRENCİ LİSTELE
			BEGIN
				SELECT ISNULL((
					SELECT OSO.ID_ODEVSINIFOGRENCI
						,ADSOYAD			=  K.AD + ' ' + K.SOYAD
						,ID_ODEVDURUM		= ISNULL(CAST(OSO.ID_ODEVDURUM AS VARCHAR), '')
						,ACIKLAMA			= ISNULL(OSO.ACIKLAMA, '')
						,OGRENCIDOSYALIST	= ISNULL((	SELECT OD.GUID
														FROM OdevSinifOgrenciDosya OD
														WHERE OD.ID_ODEVSINIFOGRENCI	= OSO.ID_ODEVSINIFOGRENCI
															AND OD.AKTIF				= 1
														FOR JSON PATH
												),'[]')
					FROM OdevSinifOgrenci					OSO WITH(NOLOCK)
					INNER JOIN OdevSinif					OS	WITH(NOLOCK) ON	 OS.ID_ODEVSINIF		= OSO.ID_ODEVSINIF
					INNER JOIN Odev							O	WITH(NOLOCK) ON	 O.ID_ODEV				= OS.ID_ODEV
					INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON	 K.TCKIMLIKNO			= OSO.TCKIMLIKNO
					WHERE	O.AKTIF		= 1
						AND O.ID_ODEV	= @ID_ODEV
						AND OS.ID_SINIF = @ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				), '[]')
			END

			IF @ISLEM = 7 -- DANIŞMAN MI
			BEGIN
				IF EXISTS (SELECT TOP 1 1 FROM OkyanusDB.dbo.v3SinifPersonel WITH(NOLOCK) WHERE TCKIMLIKNO = @TCKIMLIKNO AND ID_KULLANICITIPI = 100)
				BEGIN
					SELECT CAST(1 AS BIT)
				END
				ELSE
				BEGIN
					SELECT CAST(0 AS BIT)
				END
			END
			
			IF @ISLEM = 8 -- SINIF ÖDEV VEREN LİSTESİ
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT DISTINCT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
					WHERE OS.ID_SINIF = @ID_SINIF
					ORDER BY ADSOYAD
					FOR JSON PATH
				)
				, '[]')
			END

			IF @ISLEM = 9 -- ÖDEV VEREN ÖDEV LİSTELE
			BEGIN
				SELECT ISNULL((
					SELECT   ID_ODEV		= O.ID_ODEV
							,DERSAD			= ISNULL(D.DERSAD, '')
							,BASLIK			= O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR, O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI	= CONVERT(VARCHAR, O.TESLIM_TARIHI , 104)
							,ADSOYAD		= K.AD + ' ' + K.SOYAD
							,DURUM			=	CASE 
													WHEN O.KONTROL = 1 AND EXISTS (SELECT TOP 1  1 FROM OdevSinifOgrenci OSO WITH(NOLOCK) WHERE OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF AND OSO.ID_ODEVDURUM IS NOT NULL) THEN 1
													WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
													WHEN DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) <  @ODEVKONTROLSURESI THEN 3
												END							
							,DOSYASAYISI	= (SELECT COUNT(1) FROM OdevDosya OD WITH(NOLOCK) WHERE OD.ID_ODEV = O.ID_ODEV)
					FROM Odev								O	WITH(NOLOCK)
					INNER JOIN OdevSinif					OS	WITH(NOLOCK) ON OS.ID_ODEV		= O.ID_ODEV
					LEFT  JOIN eokul_v2.dbo.Ders			D	WITH(NOLOCK) ON D.ID_DERS		= O.ID_DERS
					INNER JOIN OkyanusDB.dbo.v3Kullanici	K	WITH(NOLOCK) ON K.TCKIMLIKNO	= O.KYE_KULLANICI
					WHERE	O.AKTIF				= 1
						AND OS.ID_SINIF			= @ID_SINIF
						AND (	O.KYE_KULLANICI	= @TC_ODEVVEREN
							OR	@TC_ODEVVEREN	= ''
							OR	@TC_ODEVVEREN IS NULL 
							)
					ORDER BY O.TESLIM_TARIHI DESC
					FOR JSON PATH, INCLUDE_NULL_VALUES
				), '[]')
			END

			IF @ISLEM = 10 -- ÖDEV DETAY GETİR
			BEGIN
				SELECT ISNULL((
					SELECT	 O.ID_ODEV
							,O.ID_MORPADERS
							,ISNULL(D.DERSAD, '') AS DERSAD
							,O.BASLIK
							,O.ACIKLAMA
							,LINKLIST				= ISNULL((SELECT OL.AD, OL.LINK				FROM OdevLink			OL	WITH(NOLOCK) WHERE OL.ID_ODEV  = O.ID_ODEV FOR JSON PATH), '[]')
							,DOSYALIST				= ISNULL((SELECT OD.AD , OD.GUID, OD.UZANTI FROM OdevDosya			OD	WITH(NOLOCK) WHERE OD.ID_ODEV  = O.ID_ODEV FOR JSON PATH), '[]')
							,ID_MORPAKAZANIMLIST	= ISNULL((SELECT OMK.ID_MORPAKAZANIM		FROM OdevMorpaKazanim	OMK WITH(NOLOCK) WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,ID_MORPAMATERYALLIST	= ISNULL((SELECT OMM.ID_MORPAMATERYAL		FROM OdevMorpaMateryal	OMM WITH(NOLOCK) WHERE OMM.ID_ODEV = O.ID_ODEV FOR JSON PATH), '[]')
							,VERILIS_TARIHI			= O.VERILIS_TARIHI
							,TESLIM_TARIHI			= O.TESLIM_TARIHI
							,OGRENCIDOSYALIST		= ISNULL((	SELECT DISTINCT OD.ID_ODEVSINIFOGRENCIDOSYA, OD.GUID
																FROM OdevSinif				OS	 WITH(NOLOCK)
																JOIN OdevSinifOgrenci		OSO	 WITH(NOLOCK)ON	OSO.ID_ODEVSINIF		= OS.ID_ODEVSINIF
																JOIN OdevSinifOgrenciDosya	OD	 WITH(NOLOCK)ON	OD.ID_ODEVSINIFOGRENCI	= OSO.ID_ODEVSINIFOGRENCI
																WHERE	OS.ID_ODEV		= O.ID_ODEV
																	AND OSO.TCKIMLIKNO	= @TC_OGRENCI
																	AND OD.AKTIF		= 1
																	--AND EXISTS (SELECT TOP 1 1  FROM v3SubeYetki SY WHERE SY.ID_KULLANICITIPI = 4 AND SY.TCKIMLIKNO = @TC_OGRENCI )
																FOR JSON PATH
														),'[]')
					FROM Odev					O WITH(NOLOCK)
					LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
					WHERE	O.AKTIF		= 1
						AND O.ID_ODEV	= @ID_ODEV
					FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER
				), '{}')
			END

			IF @ISLEM = 11 -- ÖDEV KONTROL KAYDET
			BEGIN
				UPDATE OSO SET OSO.ID_ODEVDURUM = J.ID_ODEVDURUM, OSO.ACIKLAMA = J.ACIKLAMA
				FROM OdevSinifOgrenci OSO
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEVSINIFOGRENCI INT,
					ID_ODEVDURUM INT,
					ACIKLAMA VARCHAR(MAX)				
				) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI

				UPDATE Odev SET KONTROL = 1 WHERE ID_ODEV = (SELECT TOP 1 ID_ODEV FROM OdevSinif OS WITH(NOLOCK) JOIN OdevSinifOgrenci OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF JOIN OPENJSON(@SQLJSON) WITH(ID_ODEVSINIFOGRENCI INT) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI)

				--BİLDİRİM--
				SELECT	OV.TCKIMLIKNO, 
						OV.TCKIMLIKNO_OGR, SUBSTRING(K.AD + ' ' + K.SOYAD + ' ' + ISNULL(D.DERSAD + ' - ', '') + O.BASLIK + ' ' + 'ödevi yapılmamıştır.', 0, 249) AS ACIKLAMA
				INTO #VELILIST
				FROM OdevSinifOgrenci OSO
				JOIN OdevSinif OS ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				JOIN Odev O ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D ON D.ID_DERS = O.ID_DERS
				JOIN OkyanusDB.dbo.v3Kullanici K ON K.TCKIMLIKNO = OSO.TCKIMLIKNO
				JOIN OkyanusDB.dbo.v3OgrenciVeli OV ON OV.TCKIMLIKNO_OGR = OSO.TCKIMLIKNO
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEVSINIFOGRENCI INT,
					ID_ODEVDURUM INT,
					ACIKLAMA VARCHAR(MAX)				
				) J ON J.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI 
				WHERE J.ID_ODEVDURUM = 3

				DECLARE @VELITCTEMP VARCHAR(11) = '', @OGRENCITCTEMP VARCHAR(11) = ''
				DECLARE @BILDIRIM11 VARCHAR(250)		= ''
				DECLARE @BILDIRIMTAM11 VARCHAR(MAX)	= ''

				WHILE EXISTS (SELECT TOP 1 1 FROM #VELILIST)
				BEGIN
					SELECT TOP 1 @VELITCTEMP = TCKIMLIKNO, 
								 @OGRENCITCTEMP = TCKIMLIKNO_OGR,
								 @BILDIRIM11 = ACIKLAMA,
								 @BILDIRIMTAM11 = ACIKLAMA
					FROM #VELILIST

					DECLARE @LINK11 VARCHAR(MAX) = '', @LINK_ETIKET11 VARCHAR(MAX) = ''
					SET @LINK11			='https://pusulam.okyanuskoleji.k12.tr/AnaSayfaOutSide.html#OutSide/OSOdevListesi?TC_OGRENCI='+@OGRENCITCTEMP+'&TCKIMLIKNO='+@VELITCTEMP
					SET @LINK_ETIKET11	= 'Ödeve Git'

					SELECT @VELITCTEMP, 
						   @OGRENCITCTEMP,
						   @BILDIRIM11,
						   @BILDIRIMTAM11

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Ödev'
						,@MESAJ				= @BILDIRIM11
						,@LINK				= @LINK11
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @VELITCTEMP
						,@ID_UYGULAMA		= 2
						,@MESAJTAM			= @BILDIRIMTAM11
						,@LINK_ETIKET		= @LINK_ETIKET11

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
						 @TCKIMLIKNO		= @TCKIMLIKNO
						,@HEADER			= 'Interaktif Ödev'
						,@MESAJ				= @BILDIRIM11
						,@LINK				= @LINK11
						,@MENU				= '000'
						,@TCKIMLIKNO_KIME	= @VELITCTEMP
						,@ID_UYGULAMA		= 1
						,@MESAJTAM			= @BILDIRIMTAM11
						,@LINK_ETIKET		= @LINK_ETIKET11

					DELETE FROM #VELILIST WHERE TCKIMLIKNO = @VELITCTEMP
				END

				DROP TABLE #VELILIST
			END

			IF @ISLEM = 12 -- ÖDEV GÜNCELLE
			BEGIN
				DECLARE @ID_ODEV12 INT
				SELECT @ID_ODEV12 = ID_ODEV
				FROM OPENJSON(@SQLJSON)
				WITH(ID_ODEV INT)

				UPDATE O SET O.BASLIK = J.BASLIK, O.ACIKLAMA = J.ACIKLAMA, O.VERILIS_TARIHI = J.VERILIS_TARIHI, O.TESLIM_TARIHI = J.TESLIM_TARIHI
				FROM Odev O
				INNER JOIN OPENJSON(@SQLJSON)
				WITH(
					ID_ODEV INT,
					BASLIK VARCHAR(MAX),
					ACIKLAMA VARCHAR(MAX),
					VERILIS_TARIHI VARCHAR(MAX),
					TESLIM_TARIHI VARCHAR(MAX)
				) J ON J.ID_ODEV = O.ID_ODEV

				DELETE FROM OdevDosya 
				WHERE ID_ODEV = @ID_ODEV12

					IF @OGRETMENODEVGUID != ''
					INSERT INTO OdevDosya (ID_ODEV, AD, GUID, UZANTI)
					SELECT @ID_ODEV, @OGRETMENODEVAD, @OGRETMENODEVGUID, @OGRETMENUZANTI

				DELETE FROM OdevLink 
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevLink (ID_ODEV, AD, LINK)
				SELECT @ID_ODEV12, AD, LINK
				FROM OPENJSON(@SQLJSON, '$.LINKLIST')
				WITH (
					AD VARCHAR(MAX),
					LINK VARCHAR(MAX)
				) WHERE LINK <> ''

				DELETE FROM OdevMorpaKazanim
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevMorpaKazanim (ID_ODEV, ID_MORPAKAZANIM)
				SELECT @ID_ODEV12, VALUE
				FROM OPENJSON(@SQLJSON, '$.ID_MORPAKAZANIMLIST')
				WHERE VALUE <> 0

				DELETE FROM OdevMorpaMateryal
				WHERE ID_ODEV = @ID_ODEV12

				INSERT INTO OdevMorpaMateryal (ID_ODEV, ID_MORPAMATERYAL)
				SELECT @ID_ODEV12, VALUE
				FROM OPENJSON(@SQLJSON, '$.ID_MORPAMATERYALLIST')
				WHERE VALUE <> 0

				EXEC Pusulam.dbo.sp_Odev
								 @TCKIMLIKNO		= @TCKIMLIKNO
								,@OTURUM			= @OTURUM
								,@ID_ODEV			= @ID_ODEV12
								,@ID_MENU			= @ID_MENU
								,@GUNCELLEME		= 1
								,@ISLEM				= 19
			END

			IF @ISLEM = 13 -- ÖDEV RAPOR
			BEGIN
				SELECT	 TCKIMLIKNO = SO.TCKIMLIKNO
						,ADSOYAD = K.AD + ' ' + K.SOYAD
						,KAMPUS = SD.SUBEAD
						,SINIF = SD.SINIF
						,OGRENCINO = OT.OGRNO
						,FOTOGRAF = ISNULL(R.FOTOGRAF,'')
				INTO #OGRENCI13
				FROM OkyanusDB.dbo.vw_SinifOgrenci SO WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = SO.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay SD WITH(NOLOCK) ON SD.ID_SINIF = SO.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Ogrenci OT WITH(NOLOCK) ON OT.TCKIMLIKNO = SO.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3Resim R WITH(NOLOCK) ON R.TCKIMLIKNO = SO.TCKIMLIKNO AND R.SIRANO = 1
				WHERE SO.ID_SINIF = @ID_SINIF AND SO.TCKIMLIKNO = @TC_OGRENCI

				SELECT	 DONEM = DO.ACIKLAMA
						,TARIH = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
						,DERS = ISNULL(D.DERSAD, '') 
						,DEGERLENDIRME = OD.AD
						,O.BASLIK
						,OSO.ID_ODEVDURUM
						,O.VERILIS_TARIHI
				INTO #OGRENCIODEV13
				FROM OdevSinifOgrenci OSO WITH(NOLOCK)
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3AktifDonem DO WITH(NOLOCK) ON DO.DONEM = O.DONEM
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND OS.ID_SINIF = @ID_SINIF
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND O.VERILIS_TARIHI BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI

				SELECT * FROM #OGRENCI13

				SELECT	 O.ID_ODEVDURUM
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI		
				FROM	#OGRENCIODEV13 O
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = O.ID_ODEVDURUM
				GROUP BY O.ID_ODEVDURUM, OD.AD

				SELECT * FROM #OGRENCIODEV13 ORDER BY VERILIS_TARIHI DESC

				DROP TABLE #OGRENCI13
				DROP TABLE #OGRENCIODEV13
			END

			IF @ISLEM = 14 -- ÖĞRENCİ ÖDEV LİSTESİ
			BEGIN
				
				DROP TABLE IF EXISTS #TEMP14
				DECLARE @OGRENCIMI14 BIT = IIF(EXISTS(SELECT TOP 1 1 FROM v3Ogrenci OG WHERE OG.TCKIMLIKNO = @TCKIMLIKNO),1,0)
				SELECT	 ID_ODEV		= O.ID_ODEV
						,DERSAD			= ISNULL(D.DERSAD, '')
						,VERILIS_TARIHI	= O.VERILIS_TARIHI
						,TESLIM_TARIHI	= O.TESLIM_TARIHI
						,DURUM			= ISNULL(OD.AD, 'Kontrol Edilmedi')
						,BASLIK			= O.BASLIK
						,ADSOYAD		= K.AD + ' ' + K.SOYAD
						,ID_ODEVTUR		= O.ID_ODEVTUR
						,DOSYASAYISI	= IIF(@OGRENCIMI14 = 0, 0 , (	SELECT COUNT(1) 
																		FROM OdevSinifOgrenciDosya	SOD	WITH(NOLOCK)
																		WHERE	SOD.ID_ODEVSINIFOGRENCI = OSO.ID_ODEVSINIFOGRENCI
																			AND SOD.AKTIF				= 1
																		)
											)
						,TAMAMLANDI		= IIF(EXISTS (SELECT TOP 1 1 FROM OdevTamamlandi OT	WITH(NOLOCK) WHERE OT.ID_ODEV = O.ID_ODEV AND TCKIMLIKNO = @TCKIMLIKNO), 1, 0)
				INTO #TEMP14
				FROM		Odev				O	WITH(NOLOCK)
				INNER JOIN	OdevSinif			OS	WITH(NOLOCK) ON	OS.ID_ODEV		= O.ID_ODEV
				INNER JOIN	OdevSinifOgrenci	OSO	WITH(NOLOCK) ON	OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
				LEFT  JOIN	eokul_v2.dbo.Ders	D	WITH(NOLOCK) ON	D.ID_DERS		= O.ID_DERS
				INNER JOIN	v3Kullanici			K	WITH(NOLOCK) ON	K.TCKIMLIKNO	= O.KYE_KULLANICI
				LEFT  JOIN	OdevDurum			OD	WITH(NOLOCK) ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
				WHERE	O.AKTIF			= 1 
					AND O.DONEM			= @DONEM 
					AND OSO.TCKIMLIKNO	= @TC_OGRENCI 
					AND (	O.ID_DERS	= @ID_DERS 
						OR	@ID_DERS	= 0 
						OR	@ID_DERS IS NULL
						)

				SELECT (
					SELECT LISTE = (
						SELECT ISNULL((
							SELECT	 ID_ODEV
									,DERSAD
									,VERILIS_TARIHI= CONVERT(VARCHAR(MAX), VERILIS_TARIHI, 104)
									,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), TESLIM_TARIHI , 104)
									,DURUM
									,BASLIK
									,ADSOYAD
									,ID_ODEVTUR
									,DOSYASAYISI
							FROM #TEMP14 T
							WHERE TAMAMLANDI = 0
							ORDER BY T.TESLIM_TARIHI DESC
							FOR JSON PATH
						), '[]')			
					)
					,TAMAMLANAN = (
						SELECT ISNULL((
							SELECT	 ID_ODEV
									,DERSAD
									,VERILIS_TARIHI= CONVERT(VARCHAR(MAX), VERILIS_TARIHI, 104)
									,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), TESLIM_TARIHI , 104)
									,DURUM
									,BASLIK
									,ADSOYAD
									,ID_ODEVTUR
									,DOSYASAYISI
							FROM #TEMP14 T
							WHERE TAMAMLANDI = 1
							ORDER BY T.TESLIM_TARIHI DESC
							FOR JSON PATH
						), '[]')			
					)
					FOR JSON PATH
				)
				DROP TABLE IF EXISTS #TEMP14

			END

			IF @ISLEM = 15 -- VELİ ÖDEV RAPOR
			BEGIN
				SELECT	 TCKIMLIKNO = O.TCKIMLIKNO
						,ADSOYAD = K.AD + ' ' + K.SOYAD
						,KAMPUS = SB.AD
						,SINIF = S.AD
						,OGRENCINO = O.OGRNO
						,FOTOGRAF = ISNULL(R.FOTOGRAF,'')
				INTO #OGRENCI15
				FROM OkyanusDB.dbo.v3OgrenciTum O WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3SinifTum S WITH(NOLOCK) ON S.ID_SINIF = O.ID_SINIF AND S.DONEM = O.DONEM
				INNER JOIN OkyanusDB.dbo.v3SubeGrupSinifTum SGS WITH(NOLOCK) ON SGS.ID_SINIF = O.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Sube SB WITH(NOLOCK) ON SB.ID_SUBE = SGS.ID_SUBE
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
				LEFT JOIN OkyanusDB.dbo.v3Resim R WITH(NOLOCK) ON R.TCKIMLIKNO = K.TCKIMLIKNO AND R.SIRANO = 1
				WHERE O.TCKIMLIKNO = @TC_OGRENCI AND O.DONEM = @DONEM

				SELECT	 DONEM = O.DONEM
						,TARIH = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
						,DERS = ISNULL(D.DERSAD, '') 
						,DEGERLENDIRME = OD.AD
						,O.BASLIK
						,OSO.ID_ODEVDURUM
						,O.VERILIS_TARIHI
				INTO #OGRENCIODEV15
				FROM OdevSinifOgrenci OSO WITH(NOLOCK)
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = OSO.ID_ODEVDURUM
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
				INNER JOIN Odev O WITH(NOLOCK) ON O.ID_ODEV = OS.ID_ODEV
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND (O.ID_DERS = @ID_DERS OR @ID_DERS = 0 OR @ID_DERS IS NULL)
				WHERE OSO.TCKIMLIKNO = @TC_OGRENCI
				AND O.DONEM = @DONEM
				AND ((@ID_DERS > 0 AND O.ID_ODEVTUR <> 5) OR (@ID_DERS = 0 OR @ID_DERS IS NULL))

				SELECT * FROM #OGRENCI15

				SELECT	 O.ID_ODEVDURUM
						,OD.AD AS ODEVDURUM
						,COUNT(1) AS SAYI		
				FROM	#OGRENCIODEV15 O
				INNER JOIN OdevDurum OD WITH(NOLOCK) ON OD.ID_ODEVDURUM = O.ID_ODEVDURUM
				GROUP BY O.ID_ODEVDURUM, OD.AD

				SELECT * FROM #OGRENCIODEV15 
				ORDER BY VERILIS_TARIHI DESC

				IF @ID_DERS > 0
				BEGIN
					SELECT DERSAD + ' Ödev Durumu' AS TITLE
					FROM eokul_v2.dbo.Ders WITH(NOLOCK)
					WHERE ID_DERS= @ID_DERS
				END
				ELSE
				BEGIN
					SELECT 'Genel Ödev Durumu' AS TITLE
				END

				DROP TABLE #OGRENCI15
				DROP TABLE #OGRENCIODEV15
			END

			IF @ISLEM = 16 -- ÖĞRETMEN ÖDEV RAPORU
			BEGIN
				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #TUMODEVLER
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))	
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #KONTROLEDILENODEVLER
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 1
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #KONTROLTARIHIGECMEYEN
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 0
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				SELECT K.TCKIMLIKNO, K.AD + ' ' + K.SOYAD AS ADSOYAD, S.SUBEAD, S.SINIF AS SINIFAD, S.ID_SINIF, ISNULL(D.DERSAD, '') AS DERSAD, ISNULL(D.ID_DERS, 0) AS ID_DERS, COUNT(1) AS SAYI
				INTO #KONTROLTARIHIGECEN
				FROM Odev O WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders D WITH(NOLOCK) ON D.ID_DERS = O.ID_DERS AND D.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST)) AND D.ID_DERS IN (SELECT VALUE FROM OPENJSON(@ID_DERSLIST))
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.vw_v4SinifDetay S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.KYE_KULLANICI
				WHERE O.AKTIF = 1 AND O.KONTROL = 0
				AND O.ID_KADEME3 IN (SELECT VALUE FROM OPENJSON(@ID_KADEME3LIST))
				AND O.KYE_KULLANICI IN (SELECT VALUE FROM OPENJSON(@TC_OGRETMENLIST))
				AND S.ID_SUBE IN (SELECT VALUE FROM OPENJSON(@ID_SUBELIST))				
				AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
				AND O.DONEM = @DONEM
				AND O.ID_ODEVTUR = @ID_ODEVTUR
				AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI
				GROUP BY K.TCKIMLIKNO, K.AD, K.SOYAD, S.SUBEAD, S.SINIF, S.ID_SINIF, D.DERSAD, D.ID_DERS

				IF @RAPORMU = 0
				BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 T.ID_SINIF
							,T.ID_DERS
							,T.TCKIMLIKNO
							,T.ADSOYAD
							,T.SUBEAD
							,T.SINIFAD
							,T.DERSAD
							,T.SAYI AS VERILEN
							,ISNULL(K.SAYI, 0) AS KONTROLEDILEN
							,ISNULL(KG.SAYI, 0) AS KONTROLEDILMEYEN
							,ISNULL(KGM.SAYI, 0) AS KONTROLSURESIDOLMAYAN
					FROM #TUMODEVLER T
					LEFT JOIN #KONTROLEDILENODEVLER K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND K.ID_SINIF = T.ID_SINIF AND K.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECEN KG ON KG.TCKIMLIKNO = T.TCKIMLIKNO AND KG.ID_SINIF = T.ID_SINIF AND KG.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECMEYEN KGM ON KGM.TCKIMLIKNO = T.TCKIMLIKNO AND KGM.ID_SINIF = T.ID_SINIF AND KGM.ID_DERS = T.ID_DERS
					ORDER BY T.TCKIMLIKNO, T.ADSOYAD, T.SINIFAD, T.DERSAD
					FOR JSON PATH
				)
				, '[]')
				END
				ELSE 
				BEGIN
					SELECT	 T.ID_SINIF
							,T.ID_DERS
							,T.TCKIMLIKNO
							,T.ADSOYAD
							,T.SUBEAD
							,T.SINIFAD
							,T.DERSAD
							,T.SAYI AS VERILEN
							,ISNULL(K.SAYI, 0) AS KONTROLEDILEN
							,ISNULL(KG.SAYI, 0) AS KONTROLEDILMEYEN
							,ISNULL(KGM.SAYI, 0) AS KONTROLSURESIDOLMAYAN
					FROM #TUMODEVLER T
					LEFT JOIN #KONTROLEDILENODEVLER K ON K.TCKIMLIKNO = T.TCKIMLIKNO AND K.ID_SINIF = T.ID_SINIF AND K.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECEN KG ON KG.TCKIMLIKNO = T.TCKIMLIKNO AND KG.ID_SINIF = T.ID_SINIF AND KG.ID_DERS = T.ID_DERS
					LEFT JOIN #KONTROLTARIHIGECMEYEN KGM ON KGM.TCKIMLIKNO = T.TCKIMLIKNO AND KGM.ID_SINIF = T.ID_SINIF AND KGM.ID_DERS = T.ID_DERS
					ORDER BY T.TCKIMLIKNO, T.ADSOYAD, T.SINIFAD, T.DERSAD
				END

				DROP TABLE #TUMODEVLER
				DROP TABLE #KONTROLEDILENODEVLER
				DROP TABLE #KONTROLTARIHIGECMEYEN
				DROP TABLE #KONTROLTARIHIGECEN
			END

			IF @ISLEM = 17 -- ÖĞRETMEN ÖDEV RAPOR DETAY
			BEGIN
				SELECT
				ISNULL(
				(
					SELECT	 O.ID_ODEV
							,O.BASLIK
							,VERILIS_TARIHI = CONVERT(VARCHAR(MAX), O.VERILIS_TARIHI, 104)
							,TESLIM_TARIHI = CONVERT(VARCHAR(MAX), O.TESLIM_TARIHI, 104)
							,DURUM = CASE 
									WHEN O.KONTROL = 1 THEN 1
									WHEN O.KONTROL = 0 and DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI THEN 2
									WHEN O.KONTROL = 0 and DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI THEN 3
									END
					FROM Odev O WITH(NOLOCK)
					INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
					WHERE O.KYE_KULLANICI = @TC_OGRETMEN
					AND (@ID_DERS IS NULL OR @ID_DERS = 0 OR O.ID_DERS = @ID_DERS)
					AND O.ID_ODEVTUR = @ID_ODEVTUR
					AND OS.ID_SINIF = @ID_SINIF
					AND CAST(O.VERILIS_TARIHI AS DATE) BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
					AND (
						@TUR = 1
						OR (@TUR = 2 AND O.KONTROL = 1)
						OR (@TUR = 3 AND O.KONTROL = 0 AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) < @ODEVKONTROLSURESI)
						OR (@TUR = 4 AND O.KONTROL = 0 AND DATEDIFF(DAY, GETDATE(), CONVERT(DATETIME,O.TESLIM_TARIHI)) >= @ODEVKONTROLSURESI)
					)
					FOR JSON PATH
				)
				, '[]')
			END	

			IF @ISLEM = 18 -- MORPA API
			BEGIN
				IF @APIKEY = 'D16EB1CA-062F-4CF8-8E3B-8700E44A06A0'
				BEGIN
					SELECT 
					(
						SELECT SUCCESS = 1,
							   DESCRIPTION = 'Başarılı!',
							   LIST = (
											ISNULL((
												SELECT	 O.ID_ODEV
														,O.ID_MORPADERS	
														,OS.ID_ODEVSINIF
														,SINIF = K3.DUZEY
														,SINIFAD = S.AD
														,BASLIK
														,ACIKLAMA
														,VERILIS_TARIHI
														,TESLIM_TARIHI
														--,KYE_KULLANICI
														,KYE_KULLANICI = (CASE WHEN O.ID_KADEME3 IN (7, 8, 9, 10) THEN (SELECT TOP 1 TCKIMLIKNO FROM OkyanusDB.dbo.v3SinifPersonel P WHERE P.ID_SINIF = OS.ID_SINIF AND P.ID_KULLANICITIPI = 100) ELSE O.KYE_KULLANICI END)
														,KYE_TARIH
														,MATERYALLIST = (SELECT DISTINCT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM JOIN MorpaMateryal MM ON MM.ID_MORPAMATERYAL = OMM.ID_MORPAMATERYAL AND MM.ID_MORPADERS = O.ID_MORPADERS WHERE OMM.ID_ODEV = O.ID_ODEV AND MM.AKTIF = 1 FOR JSON PATH)
														,KAZANIMLIST = (SELECT DISTINCT MK.KOD as ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK JOIN MorpaKazanim MK ON MK.ID_MORPAKAZANIM = OMK.ID_MORPAKAZANIM AND MK.AKTIF = 1 WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH)
														,OGRENCILIST = (
																			SELECT DISTINCT TCKIMLIKNO
																			FROM OdevSinifOgrenci OSO 
																			WHERE OS.ID_ODEV = O.ID_ODEV AND OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF FOR JSON PATH
																		)
												FROM Odev O WITH(NOLOCK)
												INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 WITH(NOLOCK) ON K3.ID_KADEME3 = O.ID_KADEME3
												INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
												INNER JOIN OkyanusDB.dbo.v3Sinif S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
												WHERE O.AKTIF = 1
												AND O.ID_ODEVTUR = 5
												AND O.VERILIS_TARIHI BETWEEN @BASLANGIC_TARIHI AND @BITIS_TARIHI
												ORDER BY O.ID_ODEV
												FOR JSON PATH
											), '[]')
								)
						FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
					)
				END
				ELSE
				BEGIN
					SELECT 
					(
						SELECT SUCCESS = 0,
							   DESCRIPTION = 'Gönderilen apikey hatalı!',
							   LIST = '[]'
						FOR JSON PATH, WITHOUT_ARRAY_WRAPPER
					)
				END
			END

			Branch_Islem19:

			IF @ISLEM = 19 -- ÖDEV BİLDİRİM - MAİL GÖNDER
			BEGIN
				DECLARE	@TC_ALAN VARCHAR(11)

				--DECLARE @MAIL VARCHAR(MAX)
				--DECLARE @MAILKONU VARCHAR(150)
				--DECLARE @ALANMAIL VARCHAR(MAX)
				DECLARE @DERSAD VARCHAR(100)
				DECLARE @ADSOYAD VARCHAR(150)
				DECLARE @BASLIK VARCHAR(150)
				DECLARE @ACIKLAMA VARCHAR(500)
				DECLARE @VERILISTARIHI VARCHAR(50)
				DECLARE @TESLIMTARIHI VARCHAR(50)
	   
				SELECT	 @DERSAD           = ISNULL(D.DERSAD, '')
						,@ADSOYAD          = ISNULL(K.AD + ' ' + K.SOYAD, '')
						,@BASLIK           = OD.BASLIK
						,@ACIKLAMA         = OD.ACIKLAMA
						,@VERILISTARIHI    = CONVERT(VARCHAR(MAX), OD.VERILIS_TARIHI, 104)
						,@TESLIMTARIHI     = CONVERT(VARCHAR(MAX), OD.TESLIM_TARIHI, 104)
				FROM Odev OD WITH(NOLOCK)
				LEFT JOIN eokul_v2.dbo.Ders				D WITH(NOLOCK) ON OD.ID_DERS = D.ID_DERS
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K WITH(NOLOCK) ON K.TCKIMLIKNO = OD.KYE_KULLANICI
				WHERE OD.ID_ODEV = @ID_ODEV 
		

				--SET @MAIL = '<html><head>
				--<style>body{font-family:verdana;}.baslik{background-color:rgb(176, 229, 231);width:150px;}table{width:100%;}td {border:1px solid #e3e3e3;}</style>
				--</head><body><table><tr>
				--<td class="baslik">Öğretmen Ad</td>
				--<td>' + @ADSOYAD + '</td>
				--<td class="baslik">Ders</td>
				--<td>' + @DERSAD + '</td>
				--</tr><tr>
				--<td class="baslik">Konu</td>
				--<td>' + @BASLIK + '</td>
				--<td class="baslik">Veriliş-Teslim Tarihleri</td>
				--<td>' + @VERILISTARIHI + '-' + @TESLIMTARIHI+'</td>
				--</tr><tr>
				--<td colspan="4"><br>' + @ACIKLAMA + '<br></td>
				--</tr><tr>
				--<td colspan="4"><a href="http://interaktif.okyanuskoleji.k12.tr/" target="_blank">Giriş yapmak için tıklayın...</a></td>
				--</tr></table></body></html>'

				--SET @MAILKONU = (SELECT 'Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN 'Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK)

				SELECT DISTINCT OSO.TCKIMLIKNO
				INTO #OGRENCILIST
				FROM Odev O WITH(NOLOCK)
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OdevSinifOgrenci OSO WITH(NOLOCK) ON OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF
				WHERE O.ID_ODEV = @ID_ODEV
				
				/*
				IF @MAIL IS NOT NULL
				BEGIN
					SELECT DISTINCT
						KO.EMAIL,
						K.TCKIMLIKNO
					INTO #MAILLIST
					FROM #OGRENCILIST O
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3KullaniciBilgi KO WITH(NOLOCK) ON KO.TCKIMLIKNO = K.TCKIMLIKNO
					WHERE KO.EMAIL LIKE '%_@_%_.__%' AND K.AKTIF=1
					UNION 
					SELECT  
						KB.EMAIL,
						K.TCKIMLIKNO
					FROM #OGRENCILIST O
					INNER JOIN OkyanusDB.dbo.v3OgrenciVeli OV WITH(NOLOCK) ON OV.TCKIMLIKNO_OGR = O.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = OV.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3KullaniciBilgi KB WITH(NOLOCK) ON KB.TCKIMLIKNO = K.TCKIMLIKNO
					WHERE KB.EMAIL LIKE '%_@_%_.__%' AND K.AKTIF=1

					WHILE EXISTS (SELECT TOP 1 * FROM #MAILLIST)
					BEGIN	
						SELECT TOP 1 
							 @TC_ALAN	= TCKIMLIKNO
							,@ALANMAIL	= EMAIL
						FROM #MAILLIST ORDER BY TCKIMLIKNO 


						EXEC OkyanusIletisim.dbo.sp_SendPushMail
								 @TCKIMLIKNO		= @TCKIMLIKNO
								,@HEADER			= @MAILKONU
								,@MESAJ				= @MAIL
								,@MAILADRES			= @ALANMAIL
								,@LINK				= ''
								,@TCKIMLIKNO_KIME	= @TC_ALAN
								,@ID_UYGULAMA		= 2

						DELETE FROM #MAILLIST WHERE TCKIMLIKNO = @TC_ALAN
					END
				END
				*/
				DECLARE @BILDIRIM VARCHAR(250)		= (SELECT SUBSTRING('Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN ' Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK, 0, 249))
				DECLARE @BILDIRIMTAM VARCHAR(MAX)	= (SELECT			'Ödev' + (CASE WHEN @GUNCELLEME = 1 THEN ' Güncellendi' ELSE '' END) + ': ' + @DERSAD + ' - ' + @BASLIK)

				SELECT DISTINCT
					O.TCKIMLIKNO , O.TCKIMLIKNO AS TC_OGRENICI
				INTO #BILDIRIMLIST
				FROM #OGRENCILIST O
				INNER JOIN OkyanusDB.dbo.v3Kullanici K WITH(NOLOCK) ON K.TCKIMLIKNO = O.TCKIMLIKNO
				WHERE K.AKTIF=1
				UNION 
				SELECT DISTINCT
					K.TCKIMLIKNO, OV.TCKIMLIKNO_OGR AS TC_OGRENICI
				FROM #OGRENCILIST O
				INNER JOIN OkyanusDB.dbo.v3OgrenciVeli	OV WITH(NOLOCK)	ON OV.TCKIMLIKNO_OGR = O.TCKIMLIKNO
				INNER JOIN OkyanusDB.dbo.v3Kullanici	K WITH(NOLOCK)	ON K.TCKIMLIKNO = ov.TCKIMLIKNO
				WHERE K.AKTIF = 1

				WHILE EXISTS (SELECT TOP 1 1 FROM #BILDIRIMLIST)
				BEGIN
					SELECT TOP 1 
						@TC_ALAN	= TCKIMLIKNO,
						@TC_OGRENCI	= TC_OGRENICI
					FROM #BILDIRIMLIST 
					ORDER BY TCKIMLIKNO 

			
					DECLARE @LINK VARCHAR(MAX) = '', @LINK_ETIKET VARCHAR(MAX) = ''

					IF @TC_ALAN <> @TC_OGRENCI
					BEGIN
						SET @LINK			='https://pusulam.okyanuskoleji.k12.tr/AnaSayfaOutSide.html#OutSide/OSOdevListesi?TC_OGRENCI='+@TC_OGRENCI+'&TCKIMLIKNO='+@TC_ALAN
						SET @LINK_ETIKET	= 'Ödeve Git'
					END

					EXEC OkyanusIletisim.dbo.sp_SendPushMessage
							 @TCKIMLIKNO		= @TCKIMLIKNO
							,@HEADER			= 'Interaktif Ödev'
							,@MESAJ				= @BILDIRIM
							,@LINK				= @LINK
							,@MENU				= '000'
							,@TCKIMLIKNO_KIME	= @TC_ALAN
							,@ID_UYGULAMA		= 2
							,@MESAJTAM			= @BILDIRIMTAM
							,@LINK_ETIKET		= @LINK_ETIKET

						EXEC OkyanusIletisim.dbo.sp_SendPushMessage
							 @TCKIMLIKNO		= @TCKIMLIKNO
							,@HEADER			= 'Interaktif Ödev'
							,@MESAJ				= @BILDIRIM
							,@LINK				= @LINK
							,@MENU				= '000'
							,@TCKIMLIKNO_KIME	= @TC_ALAN
							,@ID_UYGULAMA		= 1
							,@MESAJTAM			= @BILDIRIMTAM
							,@LINK_ETIKET		= @LINK_ETIKET

					DELETE FROM #BILDIRIMLIST WHERE TCKIMLIKNO = @TC_ALAN
				END
	
				DROP TABLE IF EXISTS #BILDIRIMLIST
				--DROP TABLE IF EXISTS #MAILLIST
				DROP TABLE IF EXISTS #OGRENCILIST
			END

			IF @ISLEM = 20 -- MORPA API -- METE KONTROL
			BEGIN
				SELECT	 O.ID_ODEV
						,O.ID_MORPADERS	
						,OS.ID_ODEVSINIF
						,SINIF = K3.DUZEY
						,SINIFAD = S.AD
						,BASLIK
						,ACIKLAMA
						,VERILIS_TARIHI
						,TESLIM_TARIHI
						--,KYE_KULLANICI
						,KYE_KULLANICI = (CASE WHEN O.ID_KADEME3 IN (7, 8, 9, 10) THEN (SELECT TOP 1 TCKIMLIKNO FROM OkyanusDB.dbo.v3SinifPersonel P WITH(NOLOCK) WHERE P.ID_SINIF = OS.ID_SINIF AND P.ID_KULLANICITIPI = 100) ELSE O.KYE_KULLANICI END)
						,KYE_TARIH
						,MATERYALLIST = (SELECT DISTINCT OMM.ID_MORPAMATERYAL FROM OdevMorpaMateryal OMM WITH(NOLOCK) JOIN MorpaMateryal MM WITH(NOLOCK) ON MM.ID_MORPAMATERYAL = OMM.ID_MORPAMATERYAL AND MM.ID_MORPADERS = O.ID_MORPADERS WHERE OMM.ID_ODEV = O.ID_ODEV AND MM.AKTIF = 1 FOR JSON PATH)
						,KAZANIMLIST = (SELECT DISTINCT MK.KOD as ID_MORPAKAZANIM FROM OdevMorpaKazanim OMK WITH(NOLOCK) JOIN MorpaKazanim MK WITH(NOLOCK) ON MK.ID_MORPAKAZANIM = OMK.ID_MORPAKAZANIM AND MK.AKTIF = 1 WHERE OMK.ID_ODEV = O.ID_ODEV FOR JSON PATH)
						,OGRENCILIST = (
											SELECT DISTINCT TCKIMLIKNO
											FROM OdevSinifOgrenci OSO  WITH(NOLOCK)
											WHERE OS.ID_ODEV = O.ID_ODEV AND OSO.ID_ODEVSINIF = OS.ID_ODEVSINIF FOR JSON PATH
										)
				FROM Odev O WITH(NOLOCK)
				INNER JOIN OkyanusDB.dbo.v3Kademe3 K3 WITH(NOLOCK) ON K3.ID_KADEME3 = O.ID_KADEME3
				INNER JOIN OdevSinif OS WITH(NOLOCK) ON OS.ID_ODEV = O.ID_ODEV
				INNER JOIN OkyanusDB.dbo.v3Sinif S WITH(NOLOCK) ON S.ID_SINIF = OS.ID_SINIF
				WHERE O.AKTIF = 1
				AND O.ID_ODEVTUR = 5
				AND O.VERILIS_TARIHI >= CAST(DATEADD(DAY, -7, GETDATE()) AS DATE)
				ORDER BY O.ID_ODEV
			END

			IF @ISLEM = 21 -- ÖDEV TAMAMLA
			BEGIN
				INSERT INTO OdevTamamlandi(ID_ODEV,TCKIMLIKNO)
				SELECT @ID_ODEV, @TCKIMLIKNO
			END

			IF @ISLEM = 23 -- ÖĞRENCİ ÖDEV DOSYA EKLE
			BEGIN

				DECLARE @GUID_DOSYA VARCHAR(36) = NEWID()
				WHILE EXISTS(SELECT TOP 1 1 FROM OdevSinifOgrenciDosya D WHERE D.GUID = @GUID_DOSYA)
				BEGIN
					SET @GUID_DOSYA = NEWID()
				END

				SET @ID_ODEVSINIFOGRENCI = (SELECT OSO.ID_ODEVSINIFOGRENCI
											FROM Odev				O
											JOIN OdevSinif			OS	ON	OS.ID_ODEV		= O.ID_ODEV
											JOIN OdevSinifOgrenci	OSO	ON	OSO.ID_ODEVSINIF= OS.ID_ODEVSINIF
											WHERE	O.ID_ODEV	= @ID_ODEV
												AND TCKIMLIKNO	= @TC_OGRENCI)

				DECLARE @INSERT23 TABLE(ID INT)
				INSERT INTO OdevSinifOgrenciDosya (ID_ODEVSINIFOGRENCI, GUID) 
				OUTPUT inserted.ID_ODEVSINIFOGRENCIDOSYA INTO @INSERT23
				VALUES (@ID_ODEVSINIFOGRENCI, @GUID_DOSYA)

				SELECT	 GUID						= @GUID_DOSYA
						,ID_ODEVSINIFOGRENCIDOSYA	= (SELECT TOP 1 ID FROM @INSERT23)
				FOR JSON PATH

			END

			IF @ISLEM = 24 -- ÖĞRENCİ ÖDEV DOSYA SİL
			BEGIN

				UPDATE OdevSinifOgrenciDosya SET
					AKTIF		= 0,
					KYI_TARIH	= GETDATE()
				WHERE ID_ODEVSINIFOGRENCIDOSYA = @ID_ODEVSINIFOGRENCIDOSYA

			END
			IF @ISLEM = 25 -- ÖĞRENCİ ÖDEV İPTAL
			BEGIN
				DELETE FROM OdevTamamlandi WHERE ID_ODEV=@ID_ODEV  
			END
		END
	
	--COMMIT TRANSACTION [TranOdev]
	END TRY
	BEGIN CATCH
		--ROLLBACK TRANSACTION [TranOdev]
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT 
			@ErrorSeverity 	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
				
		DECLARE @MSG VARCHAR(4000)
		SELECT @MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @MSG, @SEVERITY = @ErrorSeverity , @STATE = @ErrorState , @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_OdevTakibi]...';


GO
ALTER procedure [dbo].[sp_OdevTakibi]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@TC_OGRENCI				VARCHAR(11)		= NULL,
	@ID_KADEME3				INT				= NULL,
	@ID_SINIF				INT				= NULL,
	@ID_REHBERLIKENVANTER	INT				= NULL,
	@DONEM					VARCHAR(4)		= NULL,
	@TESTADI				VARCHAR(MAX)	= NULL,
	@KLASOR					VARCHAR(MAX)	= NULL

		
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM							= @ISLEM					
			,TCKIMLIKNO						= @TCKIMLIKNO				
			,OTURUM							= @OTURUM					
			,ID_MENU						= @ID_MENU				
			,TC_OGRENCI						= @TC_OGRENCI				
			,ID_KADEME3						= @ID_KADEME3				
			,ID_SINIF						= @ID_SINIF				
			,ID_REHBERLIKENVANTER			= @ID_REHBERLIKENVANTER	
			,DONEM							= @DONEM					
			,TESTADI						= @TESTADI				
			,KLASOR							= @KLASOR					
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0
BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
	IF @ID_LOG > 1
	BEGIN
	
		IF @ISLEM = 1	--	
		BEGIN
			
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TOPLAM

			SELECT	D.ID_DERS		[ID_DERS] ,
					D.DERSAD		[DERSAD] ,
					OD.AD			[ODEVDURUM] ,
					COUNT(1)		[SAYI]
			INTO #TEMP
			FROM	OdevSinifOgrenci			OSO 
			JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
			JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
			JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
			JOIN	eokul_v2.dbo.Ders			D	ON	D.ID_DERS		= ODV.ID_DERS AND D.AKTIF = 1 AND D.IPTAL = 0
			WHERE	(OSO.TCKIMLIKNO	= @TC_OGRENCI)
				AND (ODV.DONEM	= @DONEM or @DONEM = '')			
			GROUP BY D.DERSAD,D.ID_DERS,OD.AD
			UNION ALL 
			SELECT	0				,
					'Tümü'			,
					OD.AD AS ODEVDURUM	,
					COUNT(1)		
			FROM	OdevSinifOgrenci			OSO 
			JOIN	OdevSinif					OS	ON	OS.ID_ODEVSINIF = OSO.ID_ODEVSINIF
			JOIN	Odev						ODV	ON	ODV.ID_ODEV = OS.ID_ODEV AND ODV.AKTIF = 1
			JOIN	OdevDurum					OD	ON	OD.ID_ODEVDURUM	= OSO.ID_ODEVDURUM
			WHERE	(OSO.TCKIMLIKNO	= @TC_OGRENCI)
				AND (ODV.DONEM	= @DONEM or @DONEM = '')		
			GROUP BY OD.AD

			SELECT ID_DERS, SUM(SAYI) TS 
			INTO #TOPLAM
			FROM #TEMP
			GROUP BY ID_DERS

			SELECT(
				SELECT (
					SELECT DISTINCT ID_DERS,DERSAD,
						(SELECT  ODEVDURUM
								,SAYI
								,YUZDE = CONVERT(DECIMAL(8,2),(CONVERT(DECIMAL(8,2),SAYI)/TS)*100.0) 
								FROM #TEMP		G 
								JOIN #TOPLAM	K	ON	K.ID_DERS = G.ID_DERS 
								WHERE G.ID_DERS	= T.ID_DERS 
								FOR JSON AUTO
						) AS DURUM
					FROM #TEMP T
					ORDER BY ID_DERS,DERSAD
					FOR JSON AUTO
				) AS LISTE FOR JSON PATH, INCLUDE_NULL_VALUES
			) AS SS
	
			DROP TABLE IF EXISTS #TEMP
			DROP TABLE IF EXISTS #TOPLAM

		END	
 
	END

	END TRY
	BEGIN CATCH
			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OgrenciDersMuaf]...';


GO
ALTER procedure [dbo].[sp_OgrenciDersMuaf]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SUBE			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DERS				BIT				= NULL,
	@DONEM				char(4)			= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,TC_OGRENCI					= @TC_OGRENCI	
			,ID_MENU					= @ID_MENU	
			,ID_SUBE					= @ID_SUBE	
			,ID_SINIF					= @ID_SINIF	
			,DERS						= @DERS		
			,DONEM						= @DONEM		
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
						
	IF @ID_LOG > 1
	BEGIN

		IF @ISLEM = 1	--	ÖĞRENCİ LİSTESİ SINIFA GÖRE
		BEGIN
			SELECT (
				SELECT	 O.TCKIMLIKNO
						,K.AD
						,K.SOYAD
						,DIN_MUAF		= ISNULL(DM.DIN_MUAF,0)				
						,ING_MUAF		= ISNULL(DM.INGILIZCE_MUAF,0)
				FROM v3Ogrenci				O
				JOIN v3Kullanici			K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
				LEFT JOIN OgrenciDersMuaf	DM	ON	DM.TCKIMLIKNO	= O.TCKIMLIKNO
				WHERE O.ID_SINIF = @ID_SINIF
				ORDER BY AD,SOYAD
				FOR JSON PATH
			)
		END

		IF @ISLEM = 2
		BEGIN			
			DECLARE @DIN BIT= (SELECT CASE WHEN @DERS = 0 THEN 1 ELSE 0 END)
			DECLARE @ING BIT= (SELECT CASE WHEN @DERS = 1 THEN 1 ELSE 0 END)

			IF EXISTS (SELECT TOP 1 1 FROM OgrenciDersMuaf WHERE TCKIMLIKNO = @TC_OGRENCI)
			BEGIN
				UPDATE OgrenciDersMuaf
				SET	 DIN_MUAF	= CASE WHEN DIN_MUAF = 0 THEN 1 ELSE 0 END					
				WHERE	TCKIMLIKNO  = @TC_OGRENCI
					AND @DIN		= 1

				UPDATE OgrenciDersMuaf
				SET	 INGILIZCE_MUAF = CASE WHEN INGILIZCE_MUAF = 0 THEN 1 ELSE 0 END			
				WHERE	TCKIMLIKNO  = @TC_OGRENCI
					AND @ING = 1 

				DELETE FROM OgrenciDersMuaf 
				WHERE	TCKIMLIKNO		= @TC_OGRENCI 
					AND INGILIZCE_MUAF	= 0
					AND DIN_MUAF		= 0
			END
			ELSE
			BEGIN

				INSERT INTO OgrenciDersMuaf (TCKIMLIKNO,DIN_MUAF,INGILIZCE_MUAF,KYE_TCKIMLIKNO)
				VALUES (@TC_OGRENCI,@DIN,@ING,@TCKIMLIKNO)
			END

			SELECT 1
		END

		IF @ISLEM = 3	--	ÖĞRENCİ LİSTESİ GENEL (EXCEL)
		BEGIN
			SELECT	 OD.SUBEAD
					,OD.KADEME3
					,OD.SINIFAD
					,OD.TCKIMLIKNO
					,OD.AD
					,OD.SOYAD
					,DIN_MUAF		= CASE WHEN ISNULL(DM.DIN_MUAF,0) = 0 THEN '' ELSE 'X' END
					,ING_MUAF		= CASE WHEN ISNULL(DM.INGILIZCE_MUAF,0) = 0 THEN '' ELSE 'X' END
			FROM OkyanusDB.dbo.v3Ogrenci			O
			JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.TCKIMLIKNO = O.TCKIMLIKNO AND OD.ID_SINIF = O.ID_SINIF
			JOIN OgrenciDersMuaf					DM	ON	DM.TCKIMLIKNO	= O.TCKIMLIKNO
			ORDER BY SUBEAD,OD.ID_KADEME3,SINIFAD,AD,SOYAD
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OgrenciFrekansMuaf]...';


GO
ALTER procedure [dbo].[sp_OgrenciFrekansMuaf]
	@ISLEM				INT				= NULL,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@TC_OGRENCI			VARCHAR(11)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINIF			INT				= NULL,
	@DERS				VARCHAR(100)	= NULL,
	@MUAF				BIT				= NULL,
	@ID_KADEME3			INT				= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			ISLEM						= @ISLEM		
			,TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,TC_OGRENCI					= @TC_OGRENCI	
			,ID_MENU					= @ID_MENU	
			,ID_SINIF					= @ID_SINIF	
			,DERS						= @DERS		
			,MUAF						= @MUAF		
			,ID_KADEME3					= @ID_KADEME3	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

BEGIN TRY    
	EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
						
	IF @ID_LOG > 1
	BEGIN
		DECLARE  @cols NVARCHAR(MAX)
				,@SQL NVARCHAR(MAX)

		IF @ISLEM = 1	--	ÖĞRENCİ LİSTESİ SINIFA GÖRE
		BEGIN
			DECLARE @ID_KADEME3X INT
			DROP TABLE IF EXISTS #TEMP

			SET @ID_KADEME3X = (SELECT ID_KADEME3 FROM vw_SubeSinifGrupKademe WHERE ID_SINIF = @ID_SINIF)

			SELECT	 TCKIMLIKNO	= O.TCKIMLIKNO
					,ADSOYAD	= K.AD+' '+K.SOYAD
					,DERSAD		= REPLACE(FD.AD,'.','')
					,MUAF		= CASE WHEN FM.ID_OGRENCIFREKANSMUAF IS NULL THEN NULL ELSE 1 END
			INTO #TEMP
			FROM v3Ogrenci					O
			JOIN v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			JOIN v3FrekansDers				FD	ON	FD.ID_KADEME3	= @ID_KADEME3X
			LEFT JOIN OgrenciFrekansMuaf	FM	ON	FM.TCKIMLIKNO	= O.TCKIMLIKNO
												AND FM.DERSAD		= FD.AD
			WHERE O.ID_SINIF = @ID_SINIF
			ORDER BY DERSAD

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.DERSAD)  FROM #TEMP c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

			SET @SQL = 'SELECT (
							SELECT * FROM (
								SELECT * FROM #TEMP
							) AS T
							PIVOT (MAX(MUAF) FOR DERSAD IN ('+CAST(@cols AS varchar(MAX))+')) AS P				
							ORDER BY ADSOYAD
							FOR JSON PATH, INCLUDE_NULL_VALUES
						)'

			IF @SQL IS NULL 
				SELECT '[{}]' 
			ELSE
				EXEC (@SQL)
			
			DROP TABLE IF EXISTS #TEMP
		END

		IF @ISLEM = 2
		BEGIN			
			
			
			SET @DERS = (	SELECT FD.AD 
							FROM vw_SubeSinifGrupKademe GS 
							JOIN v3Ogrenci				O	ON	O.ID_SINIF		= GS.ID_SINIF 
							JOIN v3FrekansDers			FD	ON	FD.ID_KADEME3	= GS.ID_KADEME3
							WHERE	O.TCKIMLIKNO = @TC_OGRENCI
								AND REPLACE(FD.AD,'.','') = @DERS
						)


			DELETE OgrenciFrekansMuaf WHERE TCKIMLIKNO = @TC_OGRENCI AND DERSAD = @DERS

			IF @MUAF = 1 
				INSERT INTO OgrenciFrekansMuaf (TCKIMLIKNO,DERSAD,KYE_TCKIMLIKNO)
				VALUES (@TC_OGRENCI,@DERS,@TCKIMLIKNO)

			SELECT 1
		END

		IF @ISLEM = 3	--	ÖĞRENCİ LİSTESİ GENEL (EXCEL)
		BEGIN
			DROP TABLE IF EXISTS #TEMP3

			SELECT	 TCKIMLIKNO	= O.TCKIMLIKNO
					,DERSAD		= REPLACE(FD.AD,'.','')
					,MUAF		= CASE WHEN FM.ID_OGRENCIFREKANSMUAF IS NULL THEN NULL ELSE 1 END
			INTO #TEMP3
			FROM OgrenciFrekansMuaf						FM
			JOIN OkyanusDB.dbo.vw_OgrenciDetayTum		O	ON	O.TCKIMLIKNO	= FM.TCKIMLIKNO
			JOIN OkyanusDB.dbo.v3AktifDonem				D	ON	D.DONEM			= O.DONEM AND D.AKTIF = 1
			JOIN OkyanusDB.dbo.v3FrekansDers			FD	ON	FD.ID_KADEME3	= O.ID_KADEME3 AND FD.AD = FM.DERSAD
			JOIN OkyanusDB.dbo.v3Kullanici				K	ON	K.TCKIMLIKNO	= O.TCKIMLIKNO
			WHERE O.ID_KADEME3 = @ID_KADEME3
			ORDER BY DERSAD

			SET @cols = STUFF((	SELECT DISTINCT ',' +  QUOTENAME( C.DERSAD) FROM #TEMP3 c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
			DECLARE @cols2 VARCHAR(MAX)
			SET @cols2 = STUFF((SELECT DISTINCT ',CASE WHEN ' + QUOTENAME(C.DERSAD) + ' IS NULL THEN '''' ELSE ''X'' END AS ' + QUOTENAME(C.DERSAD) + '' FROM #TEMP3 c FOR XML PATH(''), TYPE ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')

			SET @SQL = '	SELECT	 Şube		= OD.SUBEAD
									,Grup		= OD.KADEME3
									,Sınıf		= OD.SINIFAD
									,TCKIMLIKNO = OD.TCKIMLIKNO
									,AD			= OD.AD
									,SOYAD		= OD.SOYAD
									,'+ CAST(@cols2 AS varchar(MAX)) +' 
							FROM (
								SELECT * FROM (
									SELECT * FROM #TEMP3
								) AS T
								PIVOT (MAX(MUAF) FOR DERSAD IN ('+CAST(@cols AS varchar(MAX))+')) AS P			
							) X
							JOIN OkyanusDB.dbo.v3Ogrenci			O	ON	O.TCKIMLIKNO = X.TCKIMLIKNO
							JOIN OkyanusDB.dbo.vw_OgrenciDetayTum	OD	ON	OD.TCKIMLIKNO = O.TCKIMLIKNO AND OD.ID_SINIF = O.ID_SINIF
							ORDER BY SUBEAD,OD.ID_KADEME3,SINIFAD,AD,SOYAD
					'

			EXEC (@SQL)
			
			DROP TABLE IF EXISTS #TEMP3
		END
	END

END TRY
		BEGIN CATCH
			DECLARE @_ErrorSeverity INT;
			DECLARE @_ErrorState INT;

			SELECT 
				@_ErrorSeverity	= ERROR_SEVERITY(),
				@_ErrorState		= ERROR_STATE()
				
			DECLARE @_MSG VARCHAR(4000)
			SELECT @_MSG = ERROR_MESSAGE()

			EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
		END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OgrenciTakvim]...';


GO
ALTER procedure [dbo].[sp_OgrenciTakvim]
	@ISLEM					INT				= NULL,
	@TCKIMLIKNO				VARCHAR(11)		= NULL,
	@OTURUM					VARCHAR(36)		= NULL,
	@ID_MENU				INT				= NULL,
	@baslangic				VARCHAR(36) 	= NULL
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	 
			ISLEM							= @ISLEM		
			,TCKIMLIKNO						= @TCKIMLIKNO	
			,OTURUM							= @OTURUM		
			,ID_MENU						= @ID_MENU	
			,baslangic						= @baslangic	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME

		IF @ID_LOG > 1
		BEGIN

			IF @ISLEM = 1	--	Takvim Listele
			BEGIN
				DECLARE @ID_KULLANICI INT = (SELECT ID_KULLANICI FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO)
				--DECLARE @OTURUM2 varchar(max) = (SELECT OTURUM FROM OkyanusDB.dbo.v3Kullanici WHERE TCKIMLIKNO=@TCKIMLIKNO)
				DECLARE @DATE date = (select convert(date,@baslangic,103))

				CREATE TABLE #DUYURULAR (ID_ETKINLIK int
										,ID_KULLANICITIP int
										,GRUP varchar(max)
										,ETKINLIK varchar(max)
										,ACIKLAMA varchar(max)
										,BASTARIH varchar(max)
										,BITTARIH varchar(max)
										,ID_KULLANICI int
										,TARIH varchar(max)
										,UZUNLUK int
										,RENK varchar(max)
										,TIP varchar(max)
										,KullaniciTipi varchar(max))
										
				INSERT INTO #DUYURULAR
				EXEC eokul_v2.dbo.spTakvim_EtkinlikListOgrenci @ID_KULLANICI= @ID_KULLANICI, @OTURUM=@OTURUM, @BASTARIH=@DATE, @ID_TAKVIMLER=''

				SELECT
				(
					SELECT * FROM #DUYURULAR
					FOR JSON PATH
				) AS J

				DROP TABLE #DUYURULAR
			END
		END
	END TRY
	BEGIN CATCH			
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;	
END
GO
PRINT N'Altering [dbo].[sp_OrtalamaListesi]...';


GO

--EXEC	[dbo].[sp_OrtalamaListesi]
--		@TCKIMLIKNO = N'32051057542',
--		@OTURUM = N'7555E2BC-B486-44B4-946C-6E2FCB4BDB42',
--		@ID_MENU = 1090,
--		@ID_SINAV = 9826,
--		@ID_SUBELER = N'[0,427,289,652,11,385,236,690,411,134,123,598,580,702,581,368,576,200,335,442,594,447,448,706,444,446,443,309,256,430]',
--		@ID_SINIFLAR = N'[0,102208,102207,102293,104343,101677,101671,101679,101672,101676,101680,101926,101927,101924,101925,101873,101875,101435,101434,101709,101710,101707,101708,101826,102174,101497,101498,101417,101419,101613,101615,101614,101861,104756,101860,101867,100987,105219,105416,105417,102307,102306,102087,102086,102147,102146,104554,101943,101946,101525,101526,104673,104676]',
--		@ISLEM = 2,
--		@DONEM = N'2017'

ALTER procedure [dbo].[sp_OrtalamaListesi]
(
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAV			INT				= 0,
	@ID_SUBELER			VARCHAR(MAX)	= '',
	@ID_SINIFLAR		VARCHAR(MAX)	= '',
	@ISLEM				INT				= 0,
	@DONEM				CHAR(4)			= null,
	@RAPORTUR			BIT				= 0
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO					= @TCKIMLIKNO	
			,OTURUM						= @OTURUM		
			,ID_MENU					= @ID_MENU	
			,ID_SINAV					= @ID_SINAV	
			,ID_SUBELER					= @ID_SUBELER	
			,ID_SINIFLAR				= @ID_SINIFLAR
			,ISLEM						= @ISLEM		
			,DONEM						= @DONEM		
			,RAPORTUR					= @RAPORTUR	
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			
			IF @ISLEM = 1 OR @ISLEM = 2	--	Ortalama Listesi Getir
			BEGIN
				IF 0 IN (SELECT VALUE FROM Openjson (@ID_SUBELER))
				BEGIN 
					SELECT  sb.AD                                                       AS SUBE, 
							''															AS SINIF, 
							o.SORUNO, 
							s.PUANDEGERI, 
							CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), o.PUAN))) AS ORTALAMA ,
							SR.SINAVADI SINAVAD,
							cast(SR.DONEMKOD+ ' - ' + cast(sr.DONEMKOD+1 as varchar)as varchar) DONEMKOD
					INTO   #ogrencinot 
					FROM   eokul_v2.dbo.OgrenciNot o 
					INNER JOIN eokul_v2.dbo.SinavRaporDetay s ON s.ID_SINAVRAPOR = o.ID_SINAVRAPOR AND s.SORUNO = o.SORUNO 
					INNER JOIN eokul_v2.dbo.SinavRapor SR ON SR.ID_SINAVRAPOR = o.ID_SINAVRAPOR 
					INNER JOIN OkyanusDb.dbo.v3Sinif sn ON sn.ID_SINIF = o.ID_SINIF 
					INNER JOIN OkyanusDb.dbo.v3Donem dn ON dn.ID_DONEM = sn.ID_DONEM 
					INNER JOIN OkyanusDb.dbo.v3Sube sb ON sb.ID_SUBE = dn.ID_SUBE 
					WHERE	o.ID_SINAVRAPOR = @ID_SINAV
							AND o.KATILMADI = 0 
					GROUP  BY sb.AD, o.SORUNO, s.PUANDEGERI	,SR.SINAVADI , SR.DONEMKOD

					IF @ISLEM = 1 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinot 
									ORDER BY SUBE, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinot o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 2 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinot 
						ORDER BY SUBE, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinot o 
						ORDER  BY o.SORUNO 
					END

					DROP TABLE #ogrencinot
				END 
				ELSE 
				BEGIN 
					SELECT  sb.AD                                                       AS SUBE, 
							sn.AD														AS SINIF, 
							o.SORUNO, 
							s.PUANDEGERI, 
							CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), o.PUAN))) AS ORTALAMA ,
							SR.SINAVADI SINAVAD,
							cast(SR.DONEMKOD+ ' - ' + cast(sr.DONEMKOD+1 as varchar)as varchar) DONEMKOD
					INTO   #ogrencinot2 
					FROM   eokul_v2.dbo.OgrenciNot o 
					INNER JOIN eokul_v2.dbo.SinavRaporDetay s ON s.ID_SINAVRAPOR = o.ID_SINAVRAPOR AND s.SORUNO = o.SORUNO 
					INNER JOIN eokul_v2.dbo.SinavRapor SR ON SR.ID_SINAVRAPOR = o.ID_SINAVRAPOR 
					INNER JOIN OkyanusDb.dbo.v3Sinif sn ON sn.ID_SINIF = o.ID_SINIF 
					INNER JOIN OkyanusDb.dbo.v3Donem dn ON dn.ID_DONEM = sn.ID_DONEM 
					INNER JOIN OkyanusDb.dbo.v3Sube sb ON sb.ID_SUBE = dn.ID_SUBE 
					WHERE   o.ID_SINAVRAPOR = @ID_SINAV
							AND o.KATILMADI = 0 
							AND ( ( sb.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
							AND ( ( o.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
					GROUP  BY sb.AD, 
							sn.AD, 
							o.SORUNO, 
							s.PUANDEGERI,
							SR.SINAVADI,
							SR.DONEMKOD

					IF @ISLEM = 1 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinot2 
									ORDER BY SUBE, SINIF, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinot2 o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 2 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinot2 
						ORDER BY SUBE, SINIF, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinot2 o 
						ORDER  BY o.SORUNO 

					END

					DROP TABLE #ogrencinot2
				END 				
			END

			IF @ISLEM = 3 OR @ISLEM = 4	--	Ortalama Listesi Getir YENİ
			BEGIN
				IF @RAPORTUR = 0--0 IN (SELECT VALUE FROM Openjson (@ID_SUBELER))
				BEGIN 
					SELECT  SB.AD AS SUBE
							,'' AS SINIF
							,YS.SORUNO
							,YS.PUAN AS PUANDEGERI
							,CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), YOC.PUAN))) AS ORTALAMA
							,Y.AD AS SINAVAD
							,CAST(Y.DONEM+ ' - ' + cast(Y.DONEM+1 AS VARCHAR) as VARCHAR) DONEMKOD
					INTO #ogrencinotY
					FROM Yazili Y 
					INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
					INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					WHERE Y.ID_YAZILI = @ID_SINAV
						AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' OR 0 IN (SELECT VALUE FROM Openjson (@ID_SUBELER))) 
						--AND ( ( O.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
						AND YO.KATILMADI = 0 
					GROUP  BY SB.AD, YS.SORUNO, YS.PUAN, Y.AD, Y.DONEM

					IF @ISLEM = 3 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinotY 
									ORDER BY SUBE, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinotY o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 4 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinotY 
						ORDER BY SUBE, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinotY o 
						ORDER  BY o.SORUNO 
					END

					DROP TABLE #ogrencinotY
				END 
				ELSE 
				BEGIN 
					SELECT  SB.AD AS SUBE
							,S.AD AS SINIF
							,YS.SORUNO
							,YS.PUAN AS PUANDEGERI
							,CONVERT(DECIMAL(5, 2), Avg(CONVERT(DECIMAL(5, 2), YOC.PUAN))) AS ORTALAMA
							,Y.AD AS SINAVAD
							,CAST(Y.DONEM+ ' - ' + cast(Y.DONEM+1 AS VARCHAR) as VARCHAR) DONEMKOD
					INTO #ogrencinotY2
					FROM Yazili Y 
					INNER JOIN YaziliSoru YS ON YS.ID_YAZILI = Y.ID_YAZILI
					INNER JOIN YaziliOgrenci YO ON YO.ID_YAZILI = Y.ID_YAZILI AND YO.AKTIF = 1
					INNER JOIN YaziliOgrenciCevap YOC ON YOC.ID_YAZILIOGRENCI = YO.ID_YAZILIOGRENCI AND YOC.ID_YAZILISORU = YS.ID_YAZILISORU
					INNER JOIN OkyanusDB.dbo.v3Ogrenci O ON O.TCKIMLIKNO = YO.TCKIMLIKNO
					INNER JOIN OkyanusDB.dbo.v3Sube SB ON SB.ID_SUBE = O.ID_SUBE
					INNER JOIN OkyanusDB.dbo.v3Sinif S ON S.ID_SINIF = O.ID_SINIF
					WHERE Y.ID_YAZILI = @ID_SINAV
						AND YO.KATILMADI = 0 
						AND ( ( O.ID_SUBE IN (SELECT VALUE FROM Openjson (@ID_SUBELER)) ) OR @ID_SUBELER = '' ) 
						AND ( ( O.ID_SINIF IN (SELECT VALUE FROM Openjson (@ID_SINIFLAR)) ) OR @ID_SINIFLAR = '' ) 
					GROUP  BY SB.AD, S.AD, YS.SORUNO, YS.PUAN, Y.AD, Y.DONEM

					IF @ISLEM = 3 -- HTML
					BEGIN
						SELECT
						(
							SELECT * FROM 
							(
								SELECT
								(
									SELECT * 
									FROM   #ogrencinotY2 
									ORDER BY SUBE, SINIF, SORUNO
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T1,
								(
									SELECT DISTINCT o.SORUNO, 
													o.PUANDEGERI 
									FROM   #ogrencinotY2 o 
									ORDER  BY o.SORUNO 
									FOR JSON PATH, INCLUDE_NULL_VALUES
								) AS T2
							) AS SUBTABLE
							FOR JSON PATH
						) AS J
					END 
					ELSE IF @ISLEM = 4 -- DEVEXPRESS
					BEGIN
						SELECT * 
						FROM   #ogrencinotY2 
						ORDER BY SUBE, SINIF, SORUNO

						SELECT DISTINCT o.SORUNO, 
										o.PUANDEGERI 
						FROM   #ogrencinotY2 o 
						ORDER  BY o.SORUNO 

					END

					DROP TABLE #ogrencinotY2
				END 				
			END
		END

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_OSYM]...';


GO

ALTER procedure [dbo].[sp_OSYM]
(
	@TCKIMLIKNO									VARCHAR(11)		 = NULL,
	@OTURUM										VARCHAR(36)		 = NULL,
	@ID_MENU									INT				 = NULL,
	@PROGRAMKODU								VARCHAR(MAX)	 = '',
	@UNIVERSITE									VARCHAR(MAX)	 = '',
	@FAKULTE									VARCHAR(MAX)	 = '',
	@BOLUM										VARCHAR(MAX)	 = '',
	@BOLUM2										VARCHAR(MAX)	 = '',
	@EGITIMDILI									VARCHAR(MAX)	 ='',
	@UCRETBURS									VARCHAR(MAX)	 ='',
	@IL											VARCHAR(MAX)	 ='',
	@UNIVERSITETURU								VARCHAR(MAX)	 ='',
	@OGRENIMSURESI								VARCHAR(MAX)	 ='',
	@OGRENIMTURU								VARCHAR(MAX)	 ='',
	@PUANTURU									VARCHAR(MAX)	 ='',
	@YIL										CHAR(4)			 ='',
	@TABANPUAN									VARCHAR(MAX)	 ='',
	@KONTENJAN									VARCHAR(MAX)	 ='',
	@PROGRAMTURU								VARCHAR(MAX)	 ='',
	@SONYGSYERLESTIRME							VARCHAR(MAX)	 ='',
	@OKULBIRINCILIGIKONTENJANI					VARCHAR(MAX)	 ='',
	@YERONCELIKLERI								VARCHAR(MAX)	 ='',
	@ENBUYUKPUAN								VARCHAR(MAX)	 ='',
	@BASARISIRALAMA								VARCHAR(MAX)	 ='',
	@OZELKOSULACIKLAMA							VARCHAR(MAX)	 ='',
	@displayLength								INT				 = 0,
	@displayStart								INT				 = 0,
	@whereClause								VARCHAR(MAX)	 ='',
	@orderByClause								VARCHAR(MAX)	 ='',
	@ISLEM										INT				 =0,
	@DATATABLE dbo.UniversiteTabanPuanlariYeni READONLY,
	@SQLJSON									VARCHAR(MAX)	 ='',
	@DONEM										CHAR(4)			 =null,
	@FILTER										VARCHAR(MAX)	 =''
)
AS
BEGIN
	DECLARE @PROCNAME VARCHAR(MAX) = (SELECT OBJECT_NAME(@@PROCID))
	DECLARE @LOGJSON VARCHAR(MAX)
	SET @LOGJSON = (
		SELECT	
			TCKIMLIKNO										 =	 @TCKIMLIKNO									
			,OTURUM											 =	 @OTURUM										
			,ID_MENU										 =	 @ID_MENU									
			,PROGRAMKODU									 =	 @PROGRAMKODU								
			,UNIVERSITE										 =	 @UNIVERSITE									
			,FAKULTE										 =	 @FAKULTE									
			,BOLUM											 =	 @BOLUM										
			,BOLUM2											 =	 @BOLUM2										
			,EGITIMDILI										 =	 @EGITIMDILI									
			,UCRETBURS										 =	 @UCRETBURS									
			,IL												 =	 @IL											
			,UNIVERSITETURU									 =	 @UNIVERSITETURU								
			,OGRENIMSURESI									 =	 @OGRENIMSURESI								
			,OGRENIMTURU									 =	 @OGRENIMTURU								
			,PUANTURU										 =	 @PUANTURU									
			,YIL											 =	 @YIL										
			,TABANPUAN										 =	 @TABANPUAN									
			,KONTENJAN										 =	 @KONTENJAN									
			,PROGRAMTURU									 =	 @PROGRAMTURU								
			,SONYGSYERLESTIRME								 =	 @SONYGSYERLESTIRME							
			,OKULBIRINCILIGIKONTENJANI						 =	 @OKULBIRINCILIGIKONTENJANI					
			,YERONCELIKLERI									 =	 @YERONCELIKLERI								
			,ENBUYUKPUAN									 =	 @ENBUYUKPUAN								
			,BASARISIRALAMA									 =	 @BASARISIRALAMA								
			,OZELKOSULACIKLAMA								 =	 @OZELKOSULACIKLAMA							
			,displayLength									 =	 @displayLength								
			,displayStart									 =	 @displayStart								
			,whereClause									 =	 @whereClause								
			,orderByClause									 =	 @orderByClause								
			,ISLEM											 =	 @ISLEM										
 			,SQLJSON										 =	 @SQLJSON									
			,DONEM											 =	 @DONEM										
			,[FILTER]										 =	 @FILTER										
		FOR JSON PATH, WITHOUT_ARRAY_WRAPPER	   
	)	

	DECLARE @ID_LOG INT = 0

	BEGIN TRY    
		EXEC @ID_LOG = dbo.sp_OturumKontrolMenuYetkiLog @OTURUM = @OTURUM, @TCKIMLIKNO = @TCKIMLIKNO, @ID_MENU = @ID_MENU, @LOGJSON = @LOGJSON, @ISLEM = @ISLEM, @PROSEDURADI = @PROCNAME
	
		IF @ID_LOG > 1
		BEGIN
			IF @DONEM IS NULL
			BEGIN
				SET @DONEM=(SELECT DONEM FROM [dbo].[v3AktifDonem] WHERE AKTIF=1)
			END
			IF @ISLEM = 0	--	Üniversite taban puan insert
			BEGIN
				--UPDATE [dbo].[UniversiteTabanPuanlari]
				--	   SET [PROGRAMKODU] = d.PROGRAMKODU
				--		  ,[UNIVERSITE] = d.UNIVERSITE
				--		  ,[FAKULTE] = d.FAKULTE
				--		  ,[BOLUM] = d.BOLUM
				--		  ,[EGITIMDILI] = d.EGITIMDILI
				--		  ,[UCRETBURS] = d.UCRETBURS
				--		  ,[IL] = d.IL
				--		  ,[UNIVERSITETURU] = d.UNIVERSITETURU
				--		  ,[OGRENIMSURESI] = d.OGRENIMSURESI
				--		  ,[OGRENIMTURU] = d.OGRENIMTURU
				--		  ,[PUANTURU] = d.[PUANTURU]--CASE WHEN d.[PUANTURU] LIKE 'YGS%' THEN 'TYT' WHEN d.[PUANTURU] LIKE 'MF%' THEN 'SAY' WHEN d.[PUANTURU] LIKE 'TS%' THEN 'SOZ' WHEN d.[PUANTURU] LIKE 'TM%' THEN 'EA' WHEN d.[PUANTURU] LIKE 'DİL%' THEN 'DİL' END
				--		  ,[YIL] = d.YIL
				--		  ,[TABANPUAN] = d.[TABANPUAN] --CASE WHEN d.[TABANPUAN] is null THEN '0' ELSE d.[TABANPUAN] END
				--		  ,[KONTENJAN] = d.KONTENJAN
				--		  ,[PROGRAMTURU] = d.PROGRAMTURU
				--		  ,[SONYGSYERLESTIRME] = d.SONYGSYERLESTIRME
				--		  ,[OKULBIRINCILIGIKONTENJANI] = d.OKULBIRINCILIGIKONTENJANI
				--		  ,[YERONCELIKLERI] = d.YERONCELIKLERI
				--		  ,[ENBUYUKPUAN] = d.ENBUYUKPUAN
				--		  ,[BASARISIRALAMA] = d.BASARISIRALAMA
				--		  ,[OZELKOSULACIKLAMA] = d.OZELKOSULACIKLAMA
				--		FROM [dbo].[UniversiteTabanPuanlari] u
				--		INNER JOIN @DATATABLE d ON u.PROGRAMKODU = d.PROGRAMKODU and u.YIL=d.YIL;


				DELETE UniversiteTabanPuanlari WHERE YIL = (SELECT TOP 1 YIL FROM @DATATABLE d)

				INSERT INTO [dbo].[UniversiteTabanPuanlari]
						   ([PROGRAMKODU]
						   ,[UNIVERSITE]
						   ,[FAKULTE]
						   ,[BOLUM]
						   ,[BOLUM2]
						   ,[EGITIMDILI]
						   ,[UCRETBURS]
						   ,[IL]
						   ,[UNIVERSITETURU]
						   ,[OGRENIMSURESI]
						   ,[OGRENIMTURU]
						   ,[PUANTURU]
						   ,[YIL]
						   ,[TABANPUAN]
						   ,[KONTENJAN]
						   ,[PROGRAMTURU]
						   ,[SONYGSYERLESTIRME]
						   ,[OKULBIRINCILIGIKONTENJANI]
						   ,[YERONCELIKLERI]
						   ,[ENBUYUKPUAN]
						   ,[BASARISIRALAMA]
						   ,[OZELKOSULACIKLAMA])
					Select 
						[PROGRAMKODU]
						,[UNIVERSITE]
						,[FAKULTE]
						,[BOLUM]
						,[BOLUM2]
						,[EGITIMDILI]
						,[UCRETBURS]
						,[IL]
						,[UNIVERSITETURU]
						,[OGRENIMSURESI]
						,[OGRENIMTURU]
						,[PUANTURU]--CASE WHEN [PUANTURU] LIKE 'YGS%' THEN 'TYT' WHEN [PUANTURU] LIKE 'MF%' THEN 'SAY' WHEN [PUANTURU] LIKE 'TS%' THEN 'SOZ' WHEN [PUANTURU] LIKE 'TM%' THEN 'EA' WHEN [PUANTURU] LIKE 'DİL%' THEN 'DİL' END
						,[YIL]
						,[TABANPUAN]--CASE WHEN [TABANPUAN] is null THEN '0' ELSE [TABANPUAN] END
						,[KONTENJAN]
						,[PROGRAMTURU]
						,[SONYGSYERLESTIRME]
						,[OKULBIRINCILIGIKONTENJANI]
						,[YERONCELIKLERI]
						,[ENBUYUKPUAN]
						,[BASARISIRALAMA]
						,[OZELKOSULACIKLAMA]
					FROM @DATATABLE d -- Where [PROGRAMKODU] NOT IN (SELECT [PROGRAMKODU] FROM UniversiteTabanPuanlari u where u.[YIL]=d.[YIL])
			END

			IF @ISLEM = 1 	--	Üniversite taban puan select
			BEGIN
				DECLARE @COLUMNNAME VARCHAR(MAX)=(SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'UniversiteTabanPuanlari' AND TABLE_SCHEMA='dbo' AND ORDINAL_POSITION = (SELECT JSON_Value (value, '$.column') FROM OPENJSON(@SQLJSON,'$.order')))
				SET @orderByClause = (SELECT ' ORDER BY '+ @COLUMNNAME + ' ' + J.TUR FROM (SELECT JSON_Value (value, '$.column') AS SIRA, JSON_Value (value, '$.dir') AS TUR FROM OPENJSON(@SQLJSON,'$.order')) J)
				SET @whereClause = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				SET @displayStart = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT))
				SET @displayLength = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF	@whereClause=''
				BEGIN
					SET @whereClause='where YIL='''+@DONEM+''''
				END
				ELSE
				BEGIN
					DECLARE @COLUMNS VARCHAR(max) = ''
					SET @COLUMNS='('+(SELECT ' ' + COLUMN_NAME + ' LIKE ''%' + @whereClause + '%'' OR' AS [text()] FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'UniversiteTabanPuanlari' AND TABLE_SCHEMA = 'dbo'
					For XML PATH (''))+')'
					SET @COLUMNS = SUBSTRING(@COLUMNS,1,LEN(@COLUMNS)-3)+') '
					SET @whereClause='WHERE '+@COLUMNS
					SET @whereClause=@whereClause+' and YIL='''+@DONEM+''''
				END
				Declare @query varchar(MAX)
				set @query='
							SELECT * INTO #TEMP FROM   
									(
										SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * FROM(
											SELECT
											*  FROM UniversiteTabanPuanlari 
											'+@whereClause+'
										) 
									RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT * FROM #TEMP
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM UniversiteTabanPuanlari) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'
				execute (@query)
			END

			IF @ISLEM = 2	--	Üniversite taban puan delete
			BEGIN
				DELETE UniversiteTabanPuanlari WHERE YIL = @DONEM
			END

			IF @ISLEM = 3 	--	Üniversite taban puan select ÖĞRENCİ
			BEGIN
				DECLARE @TUR VARCHAR(10), @SIRA INT
				SELECT @SIRA=JSON_Value (value, '$.column'), @TUR=JSON_Value (value, '$.dir') FROM OPENJSON(@SQLJSON,'$.order')

				SET @orderByClause = ' ORDER BY '
								+ CASE WHEN @SIRA=0  THEN 'IL'
									   WHEN @SIRA=1  THEN 'UNIVERSITE'
									   WHEN @SIRA=2  THEN 'FAKULTE'
									   WHEN @SIRA=3  THEN 'BOLUM'
									   WHEN @SIRA=4  THEN 'UNIVERSITETURU'
									   WHEN @SIRA=5  THEN 'UCRETBURS'
									   WHEN @SIRA=6  THEN 'OGRENIMSURESI'
									   WHEN @SIRA=7  THEN 'PUANTURU'
									   WHEN @SIRA=8  THEN 'YIL'
									   WHEN @SIRA=9  THEN 'TABANPUAN'
									   WHEN @SIRA=10 THEN 'KONTENJAN' 
									   ELSE 'TABANPUAN' END
								+ ' ' +	@TUR					
				
				SET @whereClause = (SELECT value FROM OPENJSON(@SQLJSON,'$.search') WITH (value VARCHAR(MAX)))
				SET @displayStart = (SELECT start FROM OPENJSON(@SQLJSON) WITH (start INT))
				SET @displayLength = (SELECT length FROM OPENJSON(@SQLJSON) WITH (length INT))
		
				IF	@whereClause=''
				BEGIN
					SET @whereClause='where YIL='''+@DONEM+''''
				END
				ELSE
				BEGIN
					DECLARE @COLUMNSOGRENCI VARCHAR(max) = ''
					SET @COLUMNSOGRENCI='(IL				LIKE ''%'+@whereClause+'%'' OR
										  UNIVERSITE		LIKE ''%'+@whereClause+'%'' OR
										  FAKULTE			LIKE ''%'+@whereClause+'%'' OR
										  BOLUM				LIKE ''%'+@whereClause+'%'' OR
										  UNIVERSITETURU	LIKE ''%'+@whereClause+'%'' OR
										  UCRETBURS			LIKE ''%'+@whereClause+'%'' OR
										  OGRENIMSURESI		LIKE ''%'+@whereClause+'%'' OR
										  PUANTURU			LIKE ''%'+@whereClause+'%'' OR
										  YIL				LIKE ''%'+@whereClause+'%'' OR
										  TABANPUAN			LIKE ''%'+@whereClause+'%'' OR
										  KONTENJAN			LIKE ''%'+@whereClause+'%'')'

					SET @whereClause='WHERE '+@COLUMNSOGRENCI
					SET @whereClause=@whereClause+' and YIL='''+@DONEM+''''
				END
				SET @whereClause+=' AND PROGRAMKODU NOT IN (SELECT PROGRAMKODU FROM OgrenciHedef WHERE TCKIMLIKNO='''+@TCKIMLIKNO+''' AND AKTIF=1 AND DONEM = ''' + @DONEM + ''')'
				Declare @queryogrenci varchar(MAX)
				set @queryogrenci='
							SELECT * INTO #TEMP FROM   
									(
										SELECT ROW_NUMBER() OVER('+@orderByClause+') AS RowNumber, * FROM(
											SELECT 
												   *
											FROM UniversiteTabanPuanlari tp
											'+@whereClause+@FILTER+'
										) 
									RawResults)  DATA 


							DECLARE @DATA VARCHAR(MAX)=(
									SELECT RowNumber, [PROGRAMKODU]
												  ,[UNIVERSITE]
												  ,[FAKULTE]
												  ,[BOLUM]
												  ,[BOLUM2]
												  ,[EGITIMDILI]
												  ,[UCRETBURS]
												  ,[IL]
												  ,[UNIVERSITETURU]
												  ,[OGRENIMSURESI]
												  ,[OGRENIMTURU]
												  ,[PUANTURU]
												  ,[YIL]
												  ,[TABANPUAN]
												  ,[KONTENJAN]
												  ,[PROGRAMTURU]
												  ,[SONYGSYERLESTIRME]
												  ,[OKULBIRINCILIGIKONTENJANI]
												  ,[YERONCELIKLERI]
												  ,[ENBUYUKPUAN]
												  ,[BASARISIRALAMA]
												  ,REPLACE((STUFF((SELECT CAST(''@@** '' + [KOSUL] AS VARCHAR(MAX)) 
															 FROM UniversiteOzelKosul ok
															 WHERE ok.NO IN (SELECT value FROM STRING_SPLIT(REPLACE(tp.OZELKOSULACIKLAMA,'' '','''') , '',''))
															 FOR XML PATH ('''')), 1, 2, '''')),''@@'',''<br /><br />'') AS [OZELKOSULACIKLAMA] FROM #TEMP tp
									WHERE RowNumber BETWEEN '+CONVERT(VARCHAR(MAX),@displayStart)+' AND '+CONVERT(VARCHAR(MAX),(@displayStart+@displayLength))+ 'FOR JSON AUTO, INCLUDE_NULL_VALUES
							)

							SELECT(
								SELECT (SELECT draw FROM OPENJSON('''+@SQLJSON+''') WITH(draw INT)) AS draw, 
								(SELECT COUNT(1) FROM UniversiteTabanPuanlari) AS recordsTotal, 
								(SELECT COUNT(1) FROM #TEMP) AS recordsFiltered, 
								@DATA  
								AS data FOR JSON PATH, INCLUDE_NULL_VALUES
							)AS JSONDATA

							DROP TABLE #TEMP
				'
				execute (@queryogrenci)
			END

			IF @ISLEM = 4	--	Üniversite İl Listele
			BEGIN
				SELECT
				(
					SELECT IL FROM UniversiteTabanPuanlari 
					GROUP BY IL
					ORDER BY COUNT(IL) DESC
					FOR JSON PATH
				) ILLER
			END 

			IF @ISLEM = 5	--	Üniversite Tür Listele
			BEGIN
				SELECT
				(
					SELECT UNIVERSITETURU FROM UniversiteTabanPuanlari 
					GROUP BY UNIVERSITETURU
					ORDER BY COUNT(UNIVERSITETURU) DESC
					FOR JSON PATH
				) TURLER
			END 

			IF @ISLEM = 6	--	Üniversite Puan Türü Listele
			BEGIN
				SELECT
				(
					SELECT DISTINCT SPT.* FROM SinavOgrenciSonuc SOS
					INNER JOIN SinavOgrenci SO ON SO.ID_SINAVOGRENCI=SOS.ID_SINAVOGRENCI
					INNER JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU=SOS.ID_SINAVPUANTURU
					WHERE SO.TCKIMLIKNO=@TCKIMLIKNO AND SPT.ID_SINAVTURU IN (2,3)
					FOR JSON AUTO
				) PUANTURLER
			END 

			IF @ISLEM = 7	--	Üniversite Bölüm Listele
			BEGIN
				SELECT
				(
					SELECT BOLUM FROM UniversiteTabanPuanlari 
					WHERE 
							BOLUM IS NOT NULL 
						AND (@IL='' or @IL='0' or IL=@IL) 
						AND (@UNIVERSITETURU='' or @UNIVERSITETURU='0' or UNIVERSITETURU=@UNIVERSITETURU) 
						AND (@PUANTURU='' or @PUANTURU='0' or PUANTURU=(SELECT KOD FROM SinavPuanTuru WHERE ID_SINAVPUANTURU=@PUANTURU)) 
						AND YIL = (SELECT DONEM FROM OkyanusDB.dbo.v3AktifDonem WHERE AKTIF = 1)
					GROUP BY BOLUM
					ORDER BY BOLUM ASC
					FOR JSON AUTO
				) PUANTURLER
			END 

			IF @ISLEM = 8	--	Üniversite Puan Türü Listele Genel
			BEGIN
				SELECT
				(
					SELECT DISTINCT SPT.* FROM SinavPuanTuru SPT
					WHERE SPT.ID_SINAVTURU IN (2,3, 4)
					FOR JSON AUTO
				) PUANTURLER
			END 


			IF @ISLEM = 9	--	OSYM OZEL KOŞULLAR EXCEL YÜKLE
			BEGIN

				
					DELETE FROM [Pusulam].[dbo].[UniversiteOzelKosul]
					


					--DECLARE @INSERTEDSORU TABLE(ID INT NOT NULL, SORUNO INT NOT NULL);  
					INSERT INTO [Pusulam].[dbo].[UniversiteOzelKosul] ([NO],KOSUL)
					--OUTPUT inserted.NUMARA, inserted.KOSUL
					--INTO @INSERTEDSORU
					SELECT Kosul_No, Aciklama FROM OPENJSON(@SQLJSON)
					WITH (
						Kosul_No		INT,
						Aciklama	VARCHAR(MAX)
					)

					
					
				END
			END
		

	END TRY
	BEGIN CATCH
		DECLARE @_ErrorSeverity INT;
		DECLARE @_ErrorState INT;

		SELECT 
			@_ErrorSeverity	= ERROR_SEVERITY(),
			@_ErrorState		= ERROR_STATE()
				
		DECLARE @_MSG VARCHAR(4000)
		SELECT @_MSG = ERROR_MESSAGE()

		EXEC [dbo].[sp_CustomRaiseError] @MESSAGE = @_MSG, @SEVERITY = @_ErrorSeverity, @STATE = @_ErrorState, @ID_LOG = @ID_LOG, @ID_LOGTUR = 2
	END CATCH;
END
GO
PRINT N'Altering [dbo].[sp_OptikIslemleriOnline]...';


GO
ALTER procedure [dbo].[sp_OptikIslemleriOnline]
	@ISLEM				INT				= 0,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVDOSYA		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBE			INT				= NULL	
AS

--SET XACT_ABORT ON

BEGIN

BEGIN TRY    
	--BEGIN TRAN
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
	DECLARE @ID				INT				= NULL
	DECLARE @SINAVOTURUM	TINYINT			= NULL
	DECLARE @SQL			VARCHAR(max)	= NULL
	DECLARE @DOSYAYOL		VARCHAR(max)	= NULL
	DECLARE @DOSYAGUID		VARCHAR(50)		= NULL
	DECLARE @ID_KADEME		INT				= NULL

	SET @ID_KADEME=(SELECT DISTINCT ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = (SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV))
	IF @ISLEM = 0	--	Sınav Dosya İşleme
	BEGIN

		
		UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 1 where ID_SINAV = @ID_SINAV


		DECLARE @BASLANGIC1 INT, @BASLANGIC2 INT, @BASLANGIC3 INT, @BASLANGIC4 INT, @BASLANGIC5 INT, @BASLANGIC6 INT
		DECLARE @OPTIKKARAKTERSAYISI1 INT, @OPTIKKARAKTERSAYISI2 INT, @OPTIKKARAKTERSAYISI3 INT, @OPTIKKARAKTERSAYISI4 INT, @OPTIKKARAKTERSAYISI5 INT, @OPTIKKARAKTERSAYISI6 INT

		SET @BASLANGIC1 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
		SET @BASLANGIC2 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 2)
		SET @BASLANGIC3 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 3)
		SET @BASLANGIC4 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 4)
		SET @BASLANGIC5 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 5)
		SET @BASLANGIC6 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 6)

		SET @OPTIKKARAKTERSAYISI1 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
		SET @OPTIKKARAKTERSAYISI2 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 2)
		SET @OPTIKKARAKTERSAYISI3 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 3)
		SET @OPTIKKARAKTERSAYISI4 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 4)
		SET @OPTIKKARAKTERSAYISI5 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 5)
		SET @OPTIKKARAKTERSAYISI6 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 6)

		DECLARE @YANLISSAYISI DECIMAL(18, 2)
		SET @YANLISSAYISI = (SELECT ISNULL(YANLISSAYISI, 0) FROM Sinav	WHERE ID_SINAV = @ID_SINAV)


		DROP TABLE IF EXISTS #SinavDers

		SELECT SD.ID_SINAV, SD.ID_SINAVDERS, OD.BASLANGIC, OD.OPTIKKARAKTERSAYISI, OD.OTURUM
		INTO #SinavDers FROM SinavDers	SD
		INNER JOIN SinavOptikDers		OD	ON OD.ID_SINAVDERS = SD.ID_SINAVDERS
		WHERE SD.ID_SINAV = @ID_SINAV 

		PRINT '1: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
		
			--IF @ID_SINAVDOSYA IS NOT NULL AND NOT EXISTS(SELECT * FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA)
			--BEGIN
				
			--	PRINT '2: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--	SET @DOSYAGUID = (SELECT GUID FROM SinavDosya where ID_SINAVDOSYA=@ID_SINAVDOSYA)
			--	create table #tmp (
			--		line nvarchar(max)
			--	);
			--	BEGIN TRY  
			--		SET @DOSYAYOL = '\\172.18.194.207\$SinavOptik\'+@DOSYAGUID+'.txt'
			--		SET @SQL=
			--		'BULK INSERT #tmp
			--		FROM '''+@DOSYAYOL+'''
			--		WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
			--		EXEC(@SQL) 
			--	END TRY  
			--	BEGIN CATCH  
			--		SET @DOSYAYOL = '\\172.18.194.207\$SinavOptik\'+@DOSYAGUID+'.dat'
			--		SET @SQL=
			--		'BULK INSERT #tmp
			--		FROM '''+@DOSYAYOL+'''
			--		WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
			--		EXEC(@SQL) 
			--	END CATCH 
				
			--	INSERT INTO SinavOptikTemp (LINE,ID_SINAVDOSYA)
			--	SELECT line, @ID_SINAVDOSYA FROM #tmp
			--	WHERE line IS NOT NULL
			--	DROP TABLE IF EXISTS #tmp

			--	PRINT '3: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--END			 

			PRINT '4: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			IF (SELECT COUNT(1) FROM SinavKitapcik WHERE ID_SINAV=@ID_SINAV)=1
			BEGIN
				
				PRINT '5: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				UPDATE SOT SET LINE=ISNULL(STUFF(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4,'A'),'') 
				FROM SinavOptikTemp SOT 
				INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA=SOT.ID_SINAVDOSYA 
				WHERE SD.ID_SINAV = @ID_SINAV

				PRINT '6: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE
			BEGIN
				
				PRINT '7: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DROP TABLE IF EXISTS #KITAPCIKSIZLAR

				SELECT 
				ID_SINAVOPTIKTEMP, LINE, RN = ROW_NUMBER() OVER (ORDER BY ID_SINAVOPTIKTEMP) 
				INTO #KITAPCIKSIZLAR
				FROM SinavOptikTemp	  SOT
				INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA=SOT.ID_SINAVDOSYA
				WHERE 
						SD.ID_SINAV = @ID_SINAV
					AND SUBSTRING(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4)=' '
		

				PRINT '8: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				IF (SELECT COUNT(1) FROM #KITAPCIKSIZLAR)>0
				BEGIN
					
					PRINT '9: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
					
					DROP TABLE IF EXISTS #KITAPCIKLAR

					SELECT ROW_NUMBER() OVER (ORDER BY AD) AS RN, SK.ID_SINAVKITAPCIK, AD, SD.ID_SINAVDERS, SOD.BASLANGIC, SOD.OPTIKKARAKTERSAYISI, STUFF((SELECT ''+CEVAP FROM SinavAnahtar WHERE ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND ID_SINAVDERS=SD.ID_SINAVDERS ORDER BY SORUNO FOR XML PATH('')),1,0,'') CEVAPLAR
					INTO #KITAPCIKLAR 
					FROM SinavKitapcik			SK
					INNER JOIN SinavDers		SD ON SD.ID_SINAV=SK.ID_SINAV
					INNER JOIN SinavOptikDers	SOD ON SOD.ID_SINAVDERS=SD.ID_SINAVDERS
					WHERE SK.ID_SINAV=@ID_SINAV

					PRINT '10: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

					DECLARE @COUNTER INT = 1
					DECLARE @COUNTKITAPCIKSIZLAR INT=(SELECT COUNT(1) FROM #KITAPCIKSIZLAR)
					WHILE @COUNTER <= @COUNTKITAPCIKSIZLAR
					BEGIN
						
						PRINT '11: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						DECLARE @KSIZLINE VARCHAR(MAX)
						DECLARE @KSIZID_SINAVOPTIKTEMP INT
						SELECT @KSIZID_SINAVOPTIKTEMP=ID_SINAVOPTIKTEMP ,@KSIZLINE=LINE FROM #KITAPCIKSIZLAR WHERE RN=@COUNTER

						DECLARE @KITAPCIKDOGRUSAYISI TABLE (KITAPCIK VARCHAR(1), DOGRUSAYISI INT)
												
						DECLARE @COUNTER2 INT = 1
						DECLARE @COUNTKITAPCIKLAR INT=(SELECT COUNT(1) FROM #KITAPCIKLAR)
						WHILE @COUNTER2 <= @COUNTKITAPCIKLAR
						BEGIN
							
							PRINT '12: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

							INSERT INTO @KITAPCIKDOGRUSAYISI(KITAPCIK, DOGRUSAYISI)
							VALUES 
							(
								(SELECT AD FROM #KITAPCIKLAR WHERE RN=@COUNTER2)
								,(
									SELECT SUM(DS) FROM (SELECT dbo.fn_SayiBul2(
												 RTRIM(SUBSTRING(@KSIZLINE,K.BASLANGIC,K.OPTIKKARAKTERSAYISI))
												,K.CEVAPLAR
											) AS DS
										FROM #KITAPCIKLAR K WHERE RN=@COUNTER2) XTABLE
								)
							)
							SET @COUNTER2 += 1
						END
						
						PRINT '13: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						DECLARE @KITAPCIK CHAR
						DECLARE @DOGRUSAYISI INT 
		
						SELECT TOP 1 @KITAPCIK = KITAPCIK, @DOGRUSAYISI=SUM(DOGRUSAYISI) FROM @KITAPCIKDOGRUSAYISI GROUP BY KITAPCIK ORDER BY SUM(DOGRUSAYISI) DESC
						UPDATE SinavOptikTemp SET LINE = ISNULL(STUFF(LINE,@BASLANGIC4,@OPTIKKARAKTERSAYISI4,@KITAPCIK),'') WHERE ID_SINAVOPTIKTEMP=@KSIZID_SINAVOPTIKTEMP

						DELETE FROM @KITAPCIKDOGRUSAYISI
						SET @COUNTER += 1

						PRINT '14: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

					END
					DROP TABLE IF EXISTS #KITAPCIKLAR

					PRINT '15: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				END

				DROP TABLE IF EXISTS #KITAPCIKSIZLAR

				PRINT '16: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			

			PRINT '17: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #SinavOgrenci

			CREATE TABLE #SinavOgrenci(
				 ID_SINAVOGRENCI int NOT NULL IDENTITY(1,1)
				,[ID_SINAV] INT
				,[TCKIMLIKNO] VARCHAR(MAX)
				,[AD] VARCHAR(MAX)
				,[SOYAD] VARCHAR(MAX)
				,[KITAPCIK] VARCHAR(MAX)
				,[SUBENO] VARCHAR(MAX)
				,[SINIF] VARCHAR(MAX)
				,[ID_SINAVDOSYA] INT
				,[ID_SINAVOPTIKTEMP] INT
				)


				DECLARE @GUID NVARCHAR(MAX) = NEWID()

			DECLARE @TBL_OGRENCI TABLE(ID_SINAVOGRENCI INT, ID_SINAVOPTIKTEMP INT, ID_SINAV INT, ID_SINAVDOSYA INT, TCKIMLIKNO VARCHAR(MAX))
			INSERT INTO #SinavOgrenci
				([ID_SINAV]
				,[TCKIMLIKNO]
				,[AD]
				,[SOYAD]
				,[KITAPCIK]
				,[SUBENO]
				,[SINIF]
				,[ID_SINAVDOSYA]
				,[ID_SINAVOPTIKTEMP])
			OUTPUT INSERTED.ID_SINAVOGRENCI, INSERTED.ID_SINAVOPTIKTEMP, INSERTED.ID_SINAV, INSERTED.ID_SINAVDOSYA, INSERTED.TCKIMLIKNO INTO @TBL_OGRENCI
			SELECT 
			 @ID_SINAV
			,RTRIM(SUBSTRING(LINE, @BASLANGIC1, @OPTIKKARAKTERSAYISI1))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC2, @OPTIKKARAKTERSAYISI2))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC3, @OPTIKKARAKTERSAYISI3))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC5, @OPTIKKARAKTERSAYISI5))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC6, @OPTIKKARAKTERSAYISI6))
			,SD.ID_SINAVDOSYA 
			,S.ID_SINAVOPTIKTEMP
			FROM SinavOptikTemp S
			INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA = S.ID_SINAVDOSYA AND SD.ID_SINAV = @ID_SINAV AND SD.AKTIF = 1
			
			
			PRINT '18: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--------------------------------------------------------------------------------------------------

			DROP TABLE IF EXISTS #SinavOgrenciCevapBolum

			CREATE TABLE #SinavOgrenciCevapBolum(
				ID_SINAVOGRENCICEVAPBOLUM INT NOT NULL IDENTITY(1, 1)
					,[ID_SINAVOGRENCI] INT
					,[ID_SINAVDERS] INT
					,[CEVAPLAR] VARCHAR(MAX)
					,[DOGRU] INT
					,[YANLIS] INT
					,[BOS] INT
					,[NET] DECIMAL(18, 2)
					,[YUZDEDOGRU] DECIMAL(18, 2)
					,[YUZDENET] DECIMAL(18, 2)
					,[PUAN] DECIMAL(18, 3)
					,TCKIMLIKNO VARCHAR(MAX)
					)

			INSERT INTO #SinavOgrenciCevapBolum
					([ID_SINAVOGRENCI]
					,[ID_SINAVDERS]
					,[CEVAPLAR]
					,[DOGRU]
					,[YANLIS]
					,[BOS]
					,[NET]
					,[YUZDEDOGRU]
					,[YUZDENET]
					,[PUAN]
					,TCKIMLIKNO)
			SELECT	 TEMP.ID_SINAVOGRENCI
					,SD.ID_SINAVDERS
					,SUBSTRING(SOT.LINE,SDT.BASLANGIC,SDT.OPTIKKARAKTERSAYISI) as CEVAPLAR
					,0,0,0,0,0,0,0, TEMP.TCKIMLIKNO
			FROM @TBL_OGRENCI TEMP
			INNER JOIN SinavOptikTemp	SOT		WITH (NOLOCK) on SOT.ID_SINAVOPTIKTEMP = TEMP.ID_SINAVOPTIKTEMP
			INNER JOIN SinavDosya		SDO		WITH (NOLOCK) on SDO.ID_SINAVDOSYA = TEMP.ID_SINAVDOSYA
			INNER JOIN SinavDers		SD		WITH (NOLOCK) on SD.ID_SINAV = TEMP.ID_SINAV
			INNER JOIN #SinavDers		SDT					  on SDT.ID_SINAVDERS = SD.ID_SINAVDERS and SDT.OTURUM=SDO.OTURUM
			
			PRINT '19: ' + CONVERT( VARCHAR(24), GETDATE(), 121)	

			---------------------------
			--SinavOgrenciCevapInsert--
			---------------------------
			DECLARE @SORUDOGRU	INT=1,
					@SORUBOS	INT=2,
					@SORUxDOGRU	INT=3,
					@SORUIPTAL	INT=4
			
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Temp2


			DROP TABLE IF EXISTS #SinavSoruIslem

			SELECT DISTINCT SS.ID_SINAVANAHTAR, SS.ID_SORUISLEM 
			INTO #SinavSoruIslem FROM SinavSoruIslem	SS
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVANAHTAR	= SS.ID_SINAVANAHTAR
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
			WHERE SK.ID_SINAV = @ID_SINAV


			SELECT I.* 
			INTO #ASSISLEM
			FROM SinavDers SD
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= SD.ID_SINAV
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
			JOIN SinavSoruIslem  I	ON	I.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
			WHERE	SD.ID_SINAV		= @ID_SINAV
				AND SK.AD			= 'A'
				AND I.ID_SORUISLEM	= 3

			IF EXISTS(SELECT TOP 1 1 FROM #ASSISLEM)
			BEGIN
				DELETE FROM I
				FROM SinavDers SD
				JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= SD.ID_SINAV
				JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
										AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
				JOIN SinavSoruIslem  I	ON	I.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
				WHERE	SD.ID_SINAV		= @ID_SINAV
					AND I.ID_SORUISLEM	= 3
		
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) 					
					SELECT A.ID_SINAVANAHTAR						
						,I.ID_SORUISLEM
						,I.OGRENCICEVAP 
					FROM #ASSISLEM			I
					JOIN SinavAnahtar		SA	ON	I.ID_SINAVANAHTAR =SA.ID_SINAVANAHTAR
					JOIN SinavDers			SD	ON	SD.ID_SINAVDERS = SA.ID_SINAVDERS
					JOIN SinavAnahtar		A	ON	A.ID_SINAVDERS	= SD.ID_SINAVDERS AND A.SORUNO_A = SA.SORUNO_A
			END
			 
			DROP TABLE IF EXISTS #ASSISLEM

			SELECT 
				 SO.ID_SINAVOGRENCI, CB.ID_SINAVOGRENCICEVAPBOLUM, CB.ID_SINAVDERS, CB.CEVAPLAR, SK.AD, SA.SORUNO, SA.OPTIKKARAKTERSAYISI, ANAHTAR = SA.CEVAP
				 ,SS.ID_SORUISLEM, SA.ID_SINAVANAHTAR
			INTO #Temp 
			FROM #SinavOgrenciCevapBolum	CB  WITH (NOLOCK) 
			INNER JOIN #SinavOgrenci		SO	WITH (NOLOCK) ON SO.ID_SINAVOGRENCI		= CB.ID_SINAVOGRENCI
			INNER JOIN SinavKitapcik		SK	WITH (NOLOCK) ON SK.AD					= SO.KITAPCIK
			INNER JOIN SinavAnahtar			SA	WITH (NOLOCK) ON SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK	AND SA.ID_SINAVDERS = CB.ID_SINAVDERS
			LEFT  JOIN #SinavSoruIslem		SS	WITH (NOLOCK) ON SS.ID_SINAVANAHTAR		= SA.ID_SINAVANAHTAR
			WHERE SO.ID_SINAV = @ID_SINAV
			--ORDER BY SO.ID_SINAVOGRENCI, CB.ID_SINAVDERS, SA.SORUNO

			PRINT '20: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			SELECT *
				,BASLANGIC_OPTIKSIRA = ISNULL((	
						SELECT 
							SUM(TSUB.OPTIKKARAKTERSAYISI) 
						FROM #Temp TSUB 
						WHERE TSUB.ID_SINAVOGRENCICEVAPBOLUM = T.ID_SINAVOGRENCICEVAPBOLUM AND TSUB.ID_SINAVDERS = T.ID_SINAVDERS AND TSUB.SORUNO < T.SORUNO
					), 0) + 1
			INTO #Temp2 FROM #Temp	T
			--ORDER BY T.ID_SINAVOGRENCI, T.ID_SINAVDERS, T.SORUNO

			PRINT '21: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #K

			SELECT DISTINCT SS.ID_SINAVANAHTAR, SS.ID_SORUISLEM, SI.OGRENCICEVAP 
			INTO #K FROM #SinavSoruIslem SS
			JOIN SinavSoruIslem SI	ON	SI.ID_SINAVANAHTAR = SS.ID_SINAVANAHTAR
			WHERE SS.ID_SORUISLEM = @SORUxDOGRU

			PRINT '22: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #SinavOgrenciCevap

			CREATE TABLE #SinavOgrenciCevap
			(
				 [ID_SINAVOGRENCICEVAPBOLUM]	INT
				,[SORUNO]						INT
				,[CEVAP]				VARCHAR(MAX)
				,[DURUM]				VARCHAR(MAX)
				,ANAHTAR				VARCHAR(MAX)
				,ID_SORUISLEM					INT
				,ID_SINAVANAHTAR				INT
			)

			INSERT INTO #SinavOgrenciCevap
								([ID_SINAVOGRENCICEVAPBOLUM]
								,[SORUNO]
								,[CEVAP]
								,[DURUM]
								,ANAHTAR
								,ID_SORUISLEM
								,ID_SINAVANAHTAR)
				SELECT	T.ID_SINAVOGRENCICEVAPBOLUM, SORUNO, CEVAP = SUBSTRING(CEVAPLAR, BASLANGIC_OPTIKSIRA, OPTIKKARAKTERSAYISI)
						,DURUM			= ''
						,ANAHTAR		= ANAHTAR
						,ID_SORUISLEM	= T.ID_SORUISLEM
						,ID_SINAVANAHTAR= T.ID_SINAVANAHTAR
				FROM #Temp2	T
				

				UPDATE #SinavOgrenciCevap SET DURUM = CASE 
														WHEN CEVAP = ''						THEN 'B'
														WHEN CEVAP = ANAHTAR				THEN 'D'
														WHEN CEVAP = '*' AND @ID_KADEME=  4	THEN 'B' --5,6,7,8 DE * GELİRSE BOŞ SAYILACAK (ÇİFT CEVAP)
													ELSE 'Y' END


				UPDATE SO SET DURUM = CASE
									WHEN SO.ID_SORUISLEM	= @SORUDOGRU	THEN 'D' 
									WHEN SO.ID_SORUISLEM	= @SORUBOS		THEN 'B'
									WHEN SO.ID_SORUISLEM	= @SORUIPTAL	THEN 'I'
									WHEN SO.ID_SORUISLEM	= @SORUxDOGRU	THEN 
										CASE WHEN  SO.CEVAP IN (SELECT OGRENCICEVAP FROM #K WHERE #K.ID_SINAVANAHTAR = SO.ID_SINAVANAHTAR)	THEN 'D'
											 ELSE  DURUM
										END
								ELSE DURUM
							END
				FROM #SinavOgrenciCevap	SO
				WHERE SO.ID_SORUISLEM IS NOT NULL

				
			PRINT '23: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


			;WITH t2( ID_SINAVOGRENCICEVAPBOLUM, DOGRU, YANLIS, BOS, PUAN) AS
			(
					SELECT 
							 OC.ID_SINAVOGRENCICEVAPBOLUM
							,DOGRU		= SUM(CASE WHEN OC.DURUM = 'D' THEN 1 ELSE 0 END) 
							,YANLIS		= SUM(CASE WHEN OC.DURUM = 'Y' THEN 1 ELSE 0 END) 
							,BOS		= SUM(CASE WHEN OC.DURUM = 'B' THEN 1 ELSE 0 END)
							,PUAN		= SUM(CASE WHEN OC.DURUM = 'D' THEN ISNULL(SA.KATSAYI, 0) ELSE 0 END)
					FROM #SinavOgrenciCevapBolum	CB  WITH (NOLOCK) 
					JOIN #SinavOgrenciCevap			OC	WITH (NOLOCK) ON OC.ID_SINAVOGRENCICEVAPBOLUM	= CB.ID_SINAVOGRENCICEVAPBOLUM
					JOIN #SinavOgrenci				OG	WITH (NOLOCK) ON OG.ID_SINAVOGRENCI				= CB.ID_SINAVOGRENCI
					JOIN SinavKitapcik				SK	WITH (NOLOCK) ON SK.AD							= OG.KITAPCIK
					JOIN SinavAnahtar				SA	WITH (NOLOCK) ON SK.ID_SINAVKITAPCIK			= SA.ID_SINAVKITAPCIK AND SA.ID_SINAVDERS = CB.ID_SINAVDERS AND SA.SORUNO = OC.SORUNO
					WHERE OG.ID_SINAV = @ID_SINAV
					GROUP BY OC.ID_SINAVOGRENCICEVAPBOLUM
			)
			UPDATE   CB 
			SET		 DOGRU		= t2.DOGRU
					,YANLIS		= t2.YANLIS
					,BOS		= t2.BOS
					,PUAN		= t2.PUAN
					,NET		= (CASE @YANLISSAYISI WHEN 0 THEN t2.DOGRU ELSE t2.DOGRU - t2.YANLIS / @YANLISSAYISI END)
					,YUZDEDOGRU	= CAST(t2.DOGRU AS FLOAT) / (t2.DOGRU + t2.YANLIS + t2.BOS) * 100.0
					,YUZDENET	= CAST((CASE @YANLISSAYISI WHEN 0 THEN t2.DOGRU ELSE t2.DOGRU - t2.YANLIS / @YANLISSAYISI END) AS FLOAT) / (t2.DOGRU + t2.YANLIS + t2.BOS) * 100.0
			FROM #SinavOgrenciCevapBolum CB WITH (NOLOCK)
			INNER JOIN t2 ON t2.ID_SINAVOGRENCICEVAPBOLUM = CB.ID_SINAVOGRENCICEVAPBOLUM

			PRINT '24: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #K

			---------------
			--PUAN KRİTER--
			---------------
			SELECT DISTINCT  SNK.ID_SINAVPUANTURU
							,SNK.ID_SINAVNETKRITER
							,SNK.NET
							,ID_DERSLIST = (
								SELECT ID_SINAVDERS
								FROM SinavNetKriterDers SNKD
								WHERE SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
								FOR JSON PATH
							) 
			INTO #KRITERLIST
			FROM SinavNetKriterDers SNKD
			JOIN SinavNetKriter SNK ON SNK.ID_SINAVNETKRITER = SNKD.ID_SINAVNETKRITER
			WHERE SNKD.ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV)

			SELECT	 SO.TCKIMLIKNO
					,SPT.ID_SINAVPUANTURU
					,HESAPDURUM =	CASE 
									WHEN NOT EXISTS (SELECT 1 FROM #KRITERLIST K WHERE K.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU) THEN 1 -- PUAN TÜRÜNDE KRİTER YOK İSE
									WHEN ( 
											SELECT CASE WHEN EXISTS -- PUAN TÜRÜNDE KRİTER SAĞLANMAYAN BİR DURUM VAR İSE
											(
												SELECT 1 
												FROM (	
													SELECT /*SOCB.ID_SINAVOGRENCI, K.ID_SINAVNETKRITER, */CASE WHEN SUM(SOCB.NET) < K.NET THEN 0 ELSE 1 END AS DURUM
													FROM #SinavOgrenciCevapBolum SOCB 
													JOIN #KRITERLIST K ON K.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU AND SOCB.ID_SINAVDERS IN (SELECT JSON_Value (value, '$.ID_SINAVDERS') FROM OPENJSON(K.ID_DERSLIST))
													WHERE SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI 
													GROUP BY SOCB.ID_SINAVOGRENCI, K.ID_SINAVNETKRITER, K.NET
												) X WHERE X.DURUM = 1
											) 
											THEN 1
											ELSE 0 
											END
										) = 0 THEN 0
									ELSE 1 -- PUAN TÜRÜNDE BÜTÜN KRİTERLER SAĞLANIYOR İSE
									END
			INTO #OGRENCISINAVPUANKRITER
			FROM Sinav S
			JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU = S.ID_SINAVTURU
			JOIN #SinavOgrenci SO ON SO.ID_SINAV = S.ID_SINAV
			WHERE S.ID_SINAV = @ID_SINAV
			ORDER BY SO.TCKIMLIKNO

			DROP TABLE #KRITERLIST
			---------------
			--PUAN KRİTER--
			---------------

			-------------------------------
			--SinavOgrenciSonucPuanInsert--
			-------------------------------
			DECLARE @ID_SINAVTURU INT, @ID_SINAVTYT INT, @ID_SINAVDEGERLENDIR INT
			SELECT @ID_SINAVTURU = ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV
			
			DROP TABLE IF EXISTS #SinavOgrenciPuan
			CREATE TABLE #SinavOgrenciPuan(
							 TCKIMLIKNO VARCHAR(MAX)
							,[ID_SINAVPUANTURU] INT
							,[PUAN] DECIMAL(18, 3)
							,GENELSIRA INT
							,ILSIRA INT
							,ILCESIRA INT
							,OKULSIRA INT
							,SINIFSIRA INT
							)


			DROP TABLE IF EXISTS #SinavSonTyt
			CREATE TABLE #SinavSonTyt(TCKIMLIKNO VARCHAR(MAX), ID_SINAV INT, TYTPUAN DECIMAL(18, 3))

			IF @ID_SINAVTURU = 3 or @ID_SINAVTURU = 4	--	YKS
			BEGIN
				DECLARE @ID_TYTSECIMTUR INT, @TYTBARAJ DECIMAL(18, 3)
				SELECT @ID_TYTSECIMTUR = ISNULL(ID_TYTSECIMTUR, 1), @TYTBARAJ = ISNULL(PUAN, -999) FROM SinavTYTSecimTurKriter WHERE ID_SINAV = @ID_SINAV
				
				PRINT '25: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DECLARE @SINAVTARIHI DATE = (SELECT SINAVTARIH FROM Sinav WHERE ID_SINAV = @ID_SINAV)

				IF @ID_TYTSECIMTUR = 1 ------ Önceki Son Tyt Sınavının TYT Puanı
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, ID_SINAV = MAX(S.ID_SINAV), TYTPUAN = (SELECT PUAN FROM SinavOgrenciPuan WHERE ID_SINAV = MAX(S.ID_SINAV) AND TCKIMLIKNO = SP.TCKIMLIKNO)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					GROUP BY SP.TCKIMLIKNO
				END
				ELSE IF @ID_TYTSECIMTUR = 2 ------ Önceki Son Tyt Sınavının TYT Puanı (0 DAN BÜYÜK OLAN)
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, ID_SINAV = MAX(S.ID_SINAV), TYTPUAN = (SELECT PUAN FROM SinavOgrenciPuan WHERE ID_SINAV = MAX(S.ID_SINAV) AND TCKIMLIKNO = SP.TCKIMLIKNO)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					AND SP.PUAN				> 0
					GROUP BY SP.TCKIMLIKNO
				END
				ELSE IF @ID_TYTSECIMTUR = 3 ------ Önceki Tüm Tyt Sınavının TYT Puan Ortalamaları
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, 0, TYTPUAN = AVG(SP.PUAN)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					GROUP BY SP.TCKIMLIKNO
				END
				
				PRINT '28: ' + CONVERT( VARCHAR(24), GETDATE(), 121)			
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT 
							yTABLE.TCKIMLIKNO
							,yTABLE.ID_SINAVPUANTURU
							,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = yTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = yTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
									THEN 0
									ELSE (
											CASE 
												WHEN yTABLE.TYTPUAN IS NULL 
												THEN (yTABLE.TABANPUAN+yTABLE.SKATSAYI)
												ELSE (
														CASE
														WHEN @TYTBARAJ > yTABLE.TYTPUAN
														THEN 0
														ELSE ((yTABLE.TABANPUAN+yTABLE.SKATSAYI)*0.6)+(yTABLE.TYTPUAN*0.4)
														END
													)
											END
										)
							 END
							 AS PUAN
				FROM
				(
					SELECT xTABLE.TCKIMLIKNO
							,ID_SINAVPUANTURU
							,xTABLE.TABANPUAN
							,SUM(xTABLE.NET*xTABLE.KATSAYI) as SKATSAYI
							,TYT.TYTPUAN
					FROM
					(
						SELECT so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, s.SINAVTARIH 
						FROM #SinavOgrenci so WITH (NOLOCK)
						INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
						INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
						INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
						INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
						INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
						INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND SK.ID_SINAV=S.ID_SINAV
						WHERE so.ID_SINAV=@ID_SINAV
					) xTABLE
					LEFT JOIN #SinavSonTyt TYT ON TYT.TCKIMLIKNO = xTABLE.TCKIMLIKNO
					GROUP BY xTABLE.TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN, TYT.TYTPUAN
					
				) yTABLE


				PRINT '29: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU = 6	--	ADIM ADIM YKS
			BEGIN
				
				PRINT '30: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
				
				
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT xTABLE.TCKIMLIKNO, xTABLE.ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI))) 
						 END AS PUAN 
				FROM
				(
					SELECT so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS 
					FROM #SinavOgrenci so WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN

				UPDATE SOS SET SOS.PUAN = SOS.PUAN * 0.6 + (SELECT SUBSOS.PUAN FROM #SinavOgrenciPuan SUBSOS WITH (NOLOCK) WHERE SUBSOS.TCKIMLIKNO = SOS.TCKIMLIKNO AND SUBSOS.ID_SINAVPUANTURU = 9) * 0.4
				FROM #SinavOgrenciPuan SOS WITH (NOLOCK)
				WHERE SOS.ID_SINAVPUANTURU IN (11, 12, 13)


				

				PRINT '32: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU = 2	--	TYT
			BEGIN
				
				PRINT '33: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN


				PRINT '34: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU IN(8, 9)
			BEGIN

				PRINT '35: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
				
				SELECT SD.BOLUMNO, STANDARTSAPMA = STDEV(CB.NET) 
				INTO #StandartSapma 
				FROM #SinavOgrenciCevapBolum	CB WITH (NOLOCK)
				INNER JOIN SinavDers			SD WITH (NOLOCK)	ON SD.ID_SINAVDERS = CB.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				GROUP BY SD.BOLUMNO
				ORDER BY SD.BOLUMNO

				SELECT SD.BOLUMNO, NET = AVG(CB.NET) 
				INTO #OrtalamaNet 
				FROM #SinavOgrenciCevapBolum	CB WITH (NOLOCK)
				INNER JOIN SinavDers			SD WITH (NOLOCK)	ON SD.ID_SINAVDERS = CB.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				GROUP BY SD.BOLUMNO
				ORDER BY SD.BOLUMNO

				SELECT SD.ID_SINAV, SO.TCKIMLIKNO, SD.BOLUMNO, CB.KATSAYI, TASP = CASE WHEN ST.STANDARTSAPMA = 0 THEN 0 ELSE (CB.KATSAYI * (OG.NET - OT.NET) / CAST(ST.STANDARTSAPMA AS FLOAT) * 10) + 50 END
				INTO #Tasp FROM SinavKatsayi		CB	WITH (NOLOCK)
				INNER JOIN SinavDers				SD	WITH (NOLOCK)	ON SD.ID_SINAVDERS		= CB.ID_SINAVDERS
				INNER JOIN #OrtalamaNet				OT	WITH (NOLOCK)	ON OT.BOLUMNO			= SD.BOLUMNO
				INNER JOIN #StandartSapma			ST	WITH (NOLOCK)	ON ST.BOLUMNO			= SD.BOLUMNO
				INNER JOIN #SinavOgrenci			SO	WITH (NOLOCK)	ON SO.ID_SINAV			= SD.ID_SINAV
				INNER JOIN #SinavOgrenciCevapBolum	OG	WITH (NOLOCK)	ON OG.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI	AND OG.ID_SINAVDERS = SD.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				ORDER BY SO.TCKIMLIKNO, SD.BOLUMNO

				IF @ID_SINAVTURU = 8 
				BEGIN
				
					DROP TABLE IF EXISTS #MAX_TASP
					DROP TABLE IF EXISTS #MUAF_TASP
					DROP TABLE IF EXISTS #OGRTOPLAMTASP
					DROP TABLE IF EXISTS #OgrenciDersMuaf

					SELECT	 DM.TCKIMLIKNO
							,DM.DIN_MUAF
							,DM.INGILIZCE_MUAF 
					INTO #OgrenciDersMuaf
					FROM OgrenciDersMuaf	DM
					JOIN #SinavOgrenci		SO	ON	SO.TCKIMLIKNO = DM.TCKIMLIKNO 

					IF EXISTS (SELECT TOP 1 * FROM #OgrenciDersMuaf)
					BEGIN
						SELECT BOLUMNO, MAX(TASP) MAX_TASP
						INTO #MAX_TASP
						FROM #Tasp 
						GROUP BY BOLUMNO

						DECLARE	 @DIN INT = 0
								,@ING INT = 0

						SELECT @DIN = SD.BOLUMNO 
						FROM SinavDers			SD					
						JOIN eokul_v2.dbo.Ders	ED	ON	ED.ID_DERS = SD.ID_DERS 
						WHERE	SD.ID_SINAV = @ID_SINAV
							AND ED.DERSAD LIKE '%Din Kült. Ve A. B.%'
						
						SELECT @ING = SD.BOLUMNO 
						FROM SinavDers			SD					
						JOIN eokul_v2.dbo.Ders	ED	ON	ED.ID_DERS = SD.ID_DERS 
						WHERE	SD.ID_SINAV = @ID_SINAV
							AND ED.DERSAD LIKE '%İngilizce%'

						DECLARE @DI_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @DIN AND ST.BOLUMNO != @ING	)
								,@D_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @DIN							)
								,@I_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @ING							)
								,@D_MAX_TASP	FLOAT = (SELECT MAX(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO =  @DIN							)
								,@I_MAX_TASP	FLOAT = (SELECT MAX(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO =  @ING							)

						SELECT	DISTINCT
								DI_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @DIN AND ST.BOLUMNO != @ING AND ST.TCKIMLIKNO = T.TCKIMLIKNO	)
								,D_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @DIN AND ST.TCKIMLIKNO = T.TCKIMLIKNO							)
								,I_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @ING AND ST.TCKIMLIKNO = T.TCKIMLIKNO							)
								,TCKIMLIKNO	= T.TCKIMLIKNO
								,MUAF		=  CASE	WHEN M.INGILIZCE_MUAF	= 1 AND M.DIN_MUAF = 1	THEN 1
													WHEN M.INGILIZCE_MUAF	= 1						THEN 2
													WHEN M.DIN_MUAF			= 1						THEN 3
																									ELSE 0
												END 
						INTO #OGRTOPLAMTASP
						FROM #Tasp				T
						JOIN #OgrenciDersMuaf	M	ON	M.TCKIMLIKNO = T.TCKIMLIKNO 
					
						SELECT	 ING = CASE	WHEN M.MUAF = 1 THEN (M.DI_OGR_TASP/@DI_T_TASP) * @I_MAX_TASP
											WHEN M.MUAF = 2 THEN (M.I_OGR_TASP / @I_T_TASP) * @I_MAX_TASP
											ELSE NULL
									   END 
								,DIN = CASE	WHEN M.MUAF = 1 THEN (M.DI_OGR_TASP/@DI_T_TASP) * @D_MAX_TASP
											WHEN M.MUAF = 3 THEN (M.D_OGR_TASP / @D_T_TASP) * @D_MAX_TASP
											ELSE NULL
									   END 
								,M.MUAF
								,T.TCKIMLIKNO
						INTO #MUAF_TASP
						FROM #Tasp			T
						JOIN #OGRTOPLAMTASP	M	ON	M.TCKIMLIKNO = T.TCKIMLIKNO 
					
						UPDATE T
						SET T.TASP = MT.DIN
						FROM #Tasp		T
						JOIN #MUAF_TASP	MT	ON	MT.TCKIMLIKNO	= T.TCKIMLIKNO
						WHERE	T.BOLUMNO = @DIN
							AND MT.DIN	IS NOT NULL

						UPDATE T
						SET T.TASP = MT.ING
						FROM #Tasp		T
						JOIN #MUAF_TASP	MT	ON	MT.TCKIMLIKNO	= T.TCKIMLIKNO
						WHERE	T.BOLUMNO = @ING
							AND MT.ING	IS NOT NULL

					END


					DROP TABLE IF EXISTS #MAX_TASP
					DROP TABLE IF EXISTS #MUAF_TASP
					DROP TABLE IF EXISTS #OGRTOPLAMTASP
					DROP TABLE IF EXISTS #OgrenciDersMuaf

				END


				
				--DECLARE @MIN_TASP FLOAT, @MAX_TASP FLOAT
				--SELECT @MIN_TASP = MIN(TASP), @MAX_TASP = MAX(TASP) FROM #Tasp
				DECLARE @MIN_TASP FLOAT, @MAX_TASP FLOAT
				SELECT SUM(TASP) AS TASP, TCKIMLIKNO INTO #TASPOGRENCI FROM #Tasp GROUP BY TCKIMLIKNO
				SELECT @MIN_TASP = MIN(TASP), @MAX_TASP = MAX(TASP) FROM #TASPOGRENCI

				
								
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT SO.TCKIMLIKNO, PT.ID_SINAVPUANTURU
						,PUAN = CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = PT.ID_SINAVPUANTURU AND TCKIMLIKNO = SO.TCKIMLIKNO AND HESAPDURUM = 0)
										THEN 0
										ELSE (SP.TABANPUAN + 400 * ((SELECT SUM(Z.TASP) FROM #TASP Z WHERE Z.TCKIMLIKNO=SO.TCKIMLIKNO) - @MIN_TASP) / (CASE (@MAX_TASP - @MIN_TASP) WHEN 0 THEN 1 ELSE (@MAX_TASP - @MIN_TASP) END))
								END
				FROM SinavTabanPuan			SP WITH (NOLOCK)
				INNER JOIN Sinav			SN WITH (NOLOCK)	ON SN.ID_SINAV		= SP.ID_SINAV
				INNER JOIN SinavPuanTuru	PT WITH (NOLOCK)	ON PT.ID_SINAVTURU	= SN.ID_SINAVTURU
				INNER JOIN #SinavOgrenci	SO WITH (NOLOCK)	ON SO.ID_SINAV		= SN.ID_SINAV
				where SN.ID_SINAV=@ID_SINAV


				PRINT '36: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DROP TABLE IF EXISTS #OrtalamaNet
				DROP TABLE IF EXISTS #StandartSapma
				DROP TABLE IF EXISTS #Tasp
				DROP TABLE IF EXISTS #TASPOGRENCI

			END
			ELSE IF	@ID_SINAVTURU = 12	--	BURSLULUK
					AND EXISTS (SELECT TOP 1 ID_SINAV FROM Sinav WHERE ID_SINAV = @ID_SINAV AND OLCEKSINAVI = 1)
			BEGIN
				
				PRINT '37: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),SUM(xTABLE.PUAN)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, socb.ID_SINAVDERS,socb.PUAN
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					--INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					--INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					--INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU


				PRINT '38: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
			END
			ELSE	-- STANDART
			BEGIN
				
				PRINT '37: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN


				PRINT '38: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
			END


			PRINT '39: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		IF @ID_SINAVTURU = 12 -- BURSLULUK İSE 
		BEGIN
			UPDATE SO SET 				
					 AD		= SUBSTRING(OGRENCI_ADSOYAD,0,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+1) 
					,SOYAD	= SUBSTRING(OGRENCI_ADSOYAD,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+2,LEN(OGRENCI_ADSOYAD)) 
					,SUBENO	= RIGHT('000' + SB.SUBENO, 3)
			FROM #SinavOgrenci						SO  WITH (NOLOCK) 
			INNER JOIN BurslulukSinavOgrenci		BS  WITH (NOLOCK)	ON	BS.ID_SINAV		= SO.ID_SINAV
																		AND BS.TCKIMLIKNO	= SO.TCKIMLIKNO
			INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
			LEFT  JOIN OKYANUSDB.DBO.v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= BS.ID_SUBE
		END

		UPDATE SO SET 
				 AD		= KL.AD
				,SOYAD	= KL.SOYAD
				,SINIF	= SN.AD
				,SUBENO	= RIGHT('000' + SB.SUBENO, 3)
		FROM #SinavOgrenci						SO  WITH (NOLOCK) 
		INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
		INNER JOIN OKYANUSDB.DBO.v3Kullanici	KL	WITH (NOLOCK) ON	KL.TCKIMLIKNO	= SO.TCKIMLIKNO
		INNER JOIN OKYANUSDB.DBO.v3OgrenciTum	KS	WITH (NOLOCK) ON	KS.TCKIMLIKNO	= KL.TCKIMLIKNO AND KS.DONEM = SV.DONEM
		INNER JOIN OKYANUSDB.DBO.v3SinifTum		SN	WITH (NOLOCK) ON	SN.ID_SINIF		= KS.ID_SINIF
		INNER JOIN OKYANUSDB.DBO.v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= KS.ID_SUBE
		

		PRINT '40: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
		
		select distinct SO.TCKIMLIKNO 
		into #OKY_OGRENCI
		FROM #SinavOgrenci						SO	WITH (NOLOCK) 
		INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
		INNER JOIN OKYANUSDB.DBO.v3OgrenciTum	KS	WITH (NOLOCK) ON	KS.TCKIMLIKNO	= SO.TCKIMLIKNO AND KS.DONEM = SV.DONEM
		

		PRINT '41: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		UPDATE SO SET 
			 SUBENO	= RIGHT('000' + ISNULL( SB.SUBENO,SO.SUBENO), 3)
			,SINIF	= 'OKY-'+ SO.SINIF						
		FROM #SinavOgrenci			SO	WITH (NOLOCK) 
		INNER JOIN SinavDosya		SD	WITH (NOLOCK) ON	SD.ID_SINAVDOSYA= SO.ID_SINAVDOSYA	
		LEFT  JOIN v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= SD.ID_SUBE
		WHERE SO.TCKIMLIKNO  NOT IN (SELECT DISTINCT TCKIMLIKNO	   FROM #OKY_OGRENCI)

		DROP TABLE IF EXISTS #OKY_OGRENCI
		
		PRINT '42: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		
		

		DROP TABLE IF EXISTS #SinavDers

		PRINT '57: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

	END

	BEGIN		
				

		PRINT '59: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
	

		----- TOPLAMLAR
		SELECT 
				SO.TCKIMLIKNO
			,SO.ID_SINAV
			,TD = SUM(CB.DOGRU)
			,TY = SUM(CB.YANLIS)
			,TB = SUM(CB.BOS)
			,TN = (CASE @YANLISSAYISI WHEN 0 THEN SUM(CB.DOGRU) ELSE SUM(CB.DOGRU) - (SUM(CB.YANLIS) / @YANLISSAYISI) END)
			,ID_SUBE		= ISNULL(SB.ID_SUBE , 0)
			,ID_SINIF		= ISNULL(OG.ID_SINIF, 0)
			,IL				= ISNULL(SB.IL, '')
			,ILCE			= ISNULL(SB.ILCE, '')
			,SINIF			= SO.SINIF
		INTO #SinavOgrenciToplam 
		FROM #SinavOgrenci						SO
		INNER JOIN Sinav						SV	ON	SV.ID_SINAV				= SO.ID_SINAV
		INNER JOIN #SinavOgrenciCevapBolum		CB	ON	CB.ID_SINAVOGRENCI		= SO.ID_SINAVOGRENCI
		LEFT  JOIN OkyanusDB.dbo.V3Sube			SB	ON	CASt(SB.SUBENO AS INT)	= CASt(SO.SUBENO AS INT)
		LEFT  JOIN OkyanusDB.dbo.V3OgrenciTum	OG	ON	OG.TCKIMLIKNO			= SO.TCKIMLIKNO		AND OG.DONEM = SV.DONEM
		GROUP BY SO.TCKIMLIKNO, SO.ID_SINAV, SB.ID_SUBE, OG.ID_SINIF, SB.IL, SB.ILCE, SO.SINIF
		----------------------------------------------------------------------------------------------------		


	--BEGIN TRAN T_SINAV;

	BEGIN

		DELETE FROM SinavOgrenci 
		WHERE ID_SINAV = @ID_SINAV

		DELETE FROM SinavOgrenciToplam
		WHERE ID_SINAV = @ID_SINAV

		DELETE FROM SinavOgrenciPuan
		WHERE ID_SINAV = @ID_SINAV
				
		DELETE FROM BurslulukSinavOgrenciSonuc
		WHERE ID_SINAV = @ID_SINAV

	END

	PRINT '60: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	INSERT INTO [dbo].[SinavOgrenci]
				([ID_SINAV]
				,[TCKIMLIKNO]
				,[AD]
				,[SOYAD]
				,[KITAPCIK]
				,[SUBENO]
				,[SINIF]
				,[ID_SINAVDOSYA]
				,[ID_SINAVOPTIKTEMP]
				,TEMP_ID_SINAVOGRENCI
				,TEMP_GUID)
			SELECT
				 SO.[ID_SINAV]
				,SO.[TCKIMLIKNO]
				,SO.[AD]
				,SO.[SOYAD]
				,SO.[KITAPCIK]
				,SO.[SUBENO]
				,SO.[SINIF]
				,SO.[ID_SINAVDOSYA]
				,SO.[ID_SINAVOPTIKTEMP]
				,SO.ID_SINAVOGRENCI
				,@GUID
			FROM #SinavOgrenci				SO


	PRINT '61: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	UPDATE CB SET CB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
	FROM #SinavOgrenciCevapBolum	CB
	JOIN SinavOgrenci				SO	ON	SO.TEMP_ID_SINAVOGRENCI = CB.ID_SINAVOGRENCI AND SO.TEMP_GUID = @GUID AND SO.ID_SINAV = @ID_SINAV

	PRINT '62: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

	

			--	PUANLAR
			INSERT INTO SinavOgrenciPuan(ID_SINAV, TCKIMLIKNO, ID_SINAVPUANTURU, PUAN, GENELSIRA, ILSIRA, ILCESIRA, OKULSIRA, SINIFSIRA)
			SELECT DISTINCT
			 @ID_SINAV
			,TCKIMLIKNO
			,ID_SINAVPUANTURU
			,PUAN
			,GENELSIRA
			,ILSIRA
			,ILCESIRA
			,OKULSIRA
			,SINIFSIRA
			FROM #SinavOgrenciPuan

		
		
			SELECT DISTINCT
				 SO.TCKIMLIKNO
				,SO.ID_SINAV
				,SC.ID_SINAVPUANTURU
				,SC.PUAN
				,ID_SUBE		= ISNULL(ST.ID_SUBE , 0)
				,ID_SINIF		= ISNULL(ST.ID_SINIF, 0)
				,IL				= ISNULL(ST.IL, '')
				,ILCE			= ISNULL(ST.ILCE, '')
				,SINIF			= SO.SINIF
			INTO #SinavOgrenciPuanSiraPuan
			FROM SinavOgrenci						SO
			INNER JOIN Sinav						SV	ON	SV.ID_SINAV	= SO.ID_SINAV
			INNER JOIN SinavOgrenciPuan				SC	ON	SC.ID_SINAV	= SV.ID_SINAV	AND SC.TCKIMLIKNO	= SO.TCKIMLIKNO	
			LEFT JOIN  #SinavOgrenciToplam			ST  ON  ST.ID_SINAV	= SV.ID_SINAV	AND ST.TCKIMLIKNO	= SO.TCKIMLIKNO
			--LEFT  JOIN OkyanusDB.dbo.V3Sube			SB	ON	CASt(SB.SUBENO AS INT)	= CASt(SO.SUBENO AS INT)
			--LEFT  JOIN OkyanusDB.dbo.v3OgrenciTum	OG	ON	OG.TCKIMLIKNO			= SO.TCKIMLIKNO AND OG.DONEM = SV.DONEM
			WHERE SV.ID_SINAV = @ID_SINAV	

			SELECT	 *
					,GENELSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU								ORDER BY PUAN DESC)
					,ILSIRA			= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, IL							ORDER BY PUAN DESC)
					,ILCESIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, IL, ILCE					ORDER BY PUAN DESC) 
					,OKULSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, ID_SUBE					ORDER BY PUAN DESC)
					,SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, ID_SUBE, ID_SINIF, SINIF	ORDER BY PUAN DESC)
			INTO #SinavOgrenciPuanSira
			FROM #SinavOgrenciPuanSiraPuan

			UPDATE SC	set 
					 GENELSIRA		= OG.GENELSIRA	
					,ILSIRA			= OG.ILSIRA		
					,ILCESIRA		= OG.ILCESIRA	
					,OKULSIRA		= OG.OKULSIRA	
					,SINIFSIRA		= OG.SINIFSIRA	
			FROM SinavOgrenciPuan				SC
			INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO = SC.TCKIMLIKNO
			INNER JOIN #SinavOgrenciPuanSira	OG	ON	OG.TCKIMLIKNO = SO.TCKIMLIKNO AND OG.ID_SINAV = SO.ID_SINAV AND OG.ID_SINAVPUANTURU = SC.ID_SINAVPUANTURU
			WHERE SC.ID_SINAV = @ID_SINAV

			DROP TABLE #SinavOgrenciPuanSiraPuan
			DROP TABLE #SinavOgrenciPuanSira 



			INSERT INTO [dbo].[SinavOgrenciSonuc]
				([ID_SINAVOGRENCI]
				,[ID_SINAVPUANTURU]
				,[PUAN]
				,GENELSIRA
				,ILSIRA
				,ILCESIRA
				,OKULSIRA
				,SINIFSIRA)
			SELECT 
				 SO.ID_SINAVOGRENCI
				,SP.ID_SINAVPUANTURU
				,SP.PUAN
				,SP.GENELSIRA
				,SP.ILSIRA
				,SP.ILCESIRA
				,SP.OKULSIRA
				,SP.SINIFSIRA
		FROM SinavOgrenci				SO
		INNER JOIN SinavOgrenciPuan		SP	ON	SP.TCKIMLIKNO = SO.TCKIMLIKNO AND SP.ID_SINAV = SO.ID_SINAV
		WHERE SP.ID_SINAV = @ID_SINAV
			--------------------------------------------------------------------


		PRINT '64: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		SELECT 
				 SO.[ID_SINAVOGRENCI]
				,SO.[ID_SINAVDERS]
				,SO.[CEVAPLAR]
				,SO.[DOGRU]
				,SO.[YANLIS]
				,SO.[BOS]
				,SO.[NET]
				,SO.[YUZDEDOGRU]
				,SO.[YUZDENET]
				,SO.[PUAN]
				,SO.ID_SINAVOGRENCICEVAPBOLUM
				,GUID = @GUID
				,PUAN_GENELSIRA		= 0
				,PUAN_ILSIRA		= 0
				,PUAN_ILCESIRA		= 0
				,PUAN_OKULSIRA		= 0
				,PUAN_SINIFSIRA		= 0
				,ST.IL
				,ST.ILCE
				,ST.ID_SUBE
				,ST.ID_SINIF
				,ST.SINIF
		INTO #SinavOgrenciCevapBolumSira
		FROM #SinavOgrenciCevapBolum	SO
		JOIN #SinavOgrenciToplam		ST	ON	ST.TCKIMLIKNO = SO.TCKIMLIKNO


		INSERT INTO [dbo].[SinavOgrenciCevapBolum]
					([ID_SINAVOGRENCI]
					,[ID_SINAVDERS]
					,[CEVAPLAR]
					,[DOGRU]
					,[YANLIS]
					,[BOS]
					,[NET]
					,[YUZDEDOGRU]
					,[YUZDENET]
					,[PUAN]
					,TEMP_ID_SINAVOGRENCICEVAPBOLUM
					,TEMP_GUID
					,PUAN_GENELSIRA
					,PUAN_ILSIRA
					,PUAN_ILCESIRA
					,PUAN_OKULSIRA
					,PUAN_SINIFSIRA

					,NET_GENELSIRA
					,NET_ILSIRA
					,NET_ILCESIRA
					,NET_OKULSIRA
					,NET_SINIFSIRA

					,DOGRU_GENELSIRA
					,DOGRU_ILSIRA
					,DOGRU_ILCESIRA
					,DOGRU_OKULSIRA
					,DOGRU_SINIFSIRA
					
					
					
					)
		SELECT 
					 SO.[ID_SINAVOGRENCI]
					,SO.[ID_SINAVDERS]
					,SO.[CEVAPLAR]
					,SO.[DOGRU]
					,SO.[YANLIS]
					,SO.[BOS]
					,SO.[NET]
					,SO.[YUZDEDOGRU]
					,SO.[YUZDENET]
					,SO.[PUAN]
					,SO.ID_SINAVOGRENCICEVAPBOLUM
					,@GUID
					,PUAN_GENELSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.PUAN DESC)
					,PUAN_ILSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.PUAN DESC)
					,PUAN_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.PUAN DESC)
					,PUAN_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.PUAN DESC)
					,PUAN_SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.PUAN DESC)
					
					,NET_GENELSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.NET DESC)
					,NET_ILSIRA			= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.NET DESC)
					,NET_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.NET DESC)
					,NET_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.NET DESC)
					,NET_SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.NET DESC)
					
					,DOGRU_GENELSIRA	= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.DOGRU DESC)
					,DOGRU_ILSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.DOGRU DESC)
					,DOGRU_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.DOGRU DESC)
					,DOGRU_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.DOGRU DESC)
					,DOGRU_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.DOGRU DESC)
			FROM #SinavOgrenciCevapBolumSira	SO


			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #GENELORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,IL
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #ILORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,IL

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,IL
				,ILCE
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #ILCEORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,IL,ILCE

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,ID_SUBE
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #OKULORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,ID_SUBE

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,ST.ID_SUBE
				,ST.ID_SINIF
				,ST.SINIF
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #SINIFORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS, ST.ID_SUBE, ST.ID_SINIF, ST.SINIF
			


			UPDATE CB SET
				 CB.NET_GENELORT		=  G.NET_ORT
				,CB.NET_ILORT			=  I.NET_ORT
				,CB.NET_ILCEORT			= IC.NET_ORT
				,CB.NET_OKULORT			=  O.NET_ORT
				,CB.NET_SINIFORT		=  S.NET_ORT
								
				,CB.DOGRU_GENELORT		=  G.DOGRU_ORT
				,CB.DOGRU_ILORT			=  I.DOGRU_ORT
				,CB.DOGRU_ILCEORT		= IC.DOGRU_ORT
				,CB.DOGRU_OKULORT		=  O.DOGRU_ORT
				,CB.DOGRU_SINIFORT		=  S.DOGRU_ORT
				
				,CB.YUZDENET_GENELORT	=  G.YUZDENET_ORT
				,CB.YUZDENET_ILORT		=  I.YUZDENET_ORT
				,CB.YUZDENET_ILCEORT	= IC.YUZDENET_ORT
				,CB.YUZDENET_OKULORT	=  O.YUZDENET_ORT
				,CB.YUZDENET_SINIFORT	=  S.YUZDENET_ORT

			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN  #SinavOgrenciToplam	ST	ON	ST.ID_SINAV			= SO.ID_SINAV		AND ST.TCKIMLIKNO   = SO.TCKIMLIKNO
			LEFT JOIN  #GENELORT			G	ON	 G.ID_SINAVDERS		= CB.ID_SINAVDERS 
			LEFT JOIN  #ILORT				I	ON	 I.ID_SINAVDERS		= CB.ID_SINAVDERS	AND I.IL		= ST.IL
			LEFT JOIN  #ILCEORT				IC	ON	IC.ID_SINAVDERS		= CB.ID_SINAVDERS	AND IC.IL		= ST.IL			AND IC.ILCE = ST.ILCE
			LEFT JOIN  #OKULORT				O	ON	 O.ID_SINAVDERS		= CB.ID_SINAVDERS	AND O.ID_SUBE	= ST.ID_SUBE
			LEFT JOIN  #SINIFORT			S	ON	 S.ID_SINAVDERS		= CB.ID_SINAVDERS	AND S.ID_SUBE	= ST.ID_SUBE	AND S.ID_SINIF	= ST.ID_SINIF	AND S.SINIF	= ST.SINIF
			WHERE SO.ID_SINAV = @ID_SINAV




			DROP TABLE #GENELORT
			DROP TABLE #ILCEORT
			DROP TABLE #ILORT
			DROP TABLE #OKULORT
			DROP TABLE #SINIFORT

			DROP TABLE #SinavOgrenciCevapBolumSira

			
		
		PRINT '65: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		UPDATE CB SET CB.ID_SINAVOGRENCICEVAPBOLUM = SO.ID_SINAVOGRENCICEVAPBOLUM
		FROM #SinavOgrenciCevap			CB
		JOIN SinavOgrenciCevapBolum		SO	ON	SO.TEMP_ID_SINAVOGRENCICEVAPBOLUM = CB.ID_SINAVOGRENCICEVAPBOLUM AND SO.TEMP_GUID = @GUID
		JOIN SinavDers					SD	ON	SD.ID_SINAVDERS	= SO.ID_SINAVDERS	AND SD.ID_SINAV = @ID_SINAV


		PRINT '66: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


		INSERT INTO SinavOgrenciCevap
							([ID_SINAVOGRENCICEVAPBOLUM]
							,[SORUNO]
							,[CEVAP]
							,[DURUM])
		SELECT
							 [ID_SINAVOGRENCICEVAPBOLUM]
							,[SORUNO]
							,[CEVAP]
							,[DURUM]
			FROM #SinavOgrenciCevap

	
	
		INSERT INTO [dbo].[SinavOgrenciToplam]
           ([TCKIMLIKNO]
           ,[ID_SINAV]
           ,[TD]
           ,[TY]
           ,[TB]
           ,[TN]
           ,[TD_GENELSIRA]
           ,[TD_ILSIRA]
           ,[TD_ILCESIRA]
           ,[TD_OKULSIRA]
           ,[TD_SINIFSIRA]
           ,[TN_GENELSIRA]
           ,[TN_ILSIRA]
           ,[TN_ILCESIRA]
           ,[TN_OKULSIRA]
           ,[TN_SINIFSIRA]
		   ,KATILIM_GENEL
		   ,KATILIM_IL
		   ,KATILIM_ILCE
		   ,KATILIM_OKUL
		   ,KATILIM_SINIF)

		SELECT 
			 TCKIMLIKNO
			,ID_SINAV
			,TD
			,TY
			,TB
			,TN
			,TD_GENELSIRA	= DENSE_RANK() OVER(										ORDER BY TD DESC)
			,TD_ILSIRA		= DENSE_RANK() OVER(PARTITION BY IL							ORDER BY TD DESC)
			,TD_ILCESIRA	= DENSE_RANK() OVER(PARTITION BY ILCE						ORDER BY TD DESC)
			,TD_OKULSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE					ORDER BY TD DESC)
			,TD_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE, ID_SINIF, SINIF	ORDER BY TD DESC)
			,TN_GENELSIRA	= DENSE_RANK() OVER(										ORDER BY TN DESC)
			,TN_ILSIRA		= DENSE_RANK() OVER(PARTITION BY IL							ORDER BY TN DESC)
			,TN_ILCESIRA	= DENSE_RANK() OVER(PARTITION BY ILCE						ORDER BY TN DESC)
			,TN_OKULSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE					ORDER BY TN DESC)
			,TN_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE, ID_SINIF, SINIF	ORDER BY TN DESC) 
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.IL = SO.IL)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.IL = SO.IL AND SUB.ILCE = SO.ILCE)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.ID_SUBE	= SO.ID_SUBE)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.ID_SUBE	= SO.ID_SUBE	AND SUB.ID_SINIF = SO.ID_SINIF	AND SUB.SINIF = SO.SINIF)
		FROM #SinavOgrenciToplam	SO

	PRINT '67: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	IF (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV) = 12 -- BURSLULUK İSE
	BEGIN
	
			
		DROP TABLE IF EXISTS #W_BURS
		DROP TABLE IF EXISTS #TEMP_BURS
		DROP TABLE IF EXISTS #BURSPUAN
		DROP TABLE IF EXISTS #BURSDERS

	
			BEGIN	--	PUAN

				SELECT TCKIMLIKNO,PUAN,BO.*,ROW_NUMBER () OVER(PARTITION BY ID_BURSORAN ORDER BY PUAN DESC) RN
				INTO #BURSPUAN
				FROM vw_SinavOgrenciPuan		SP
				JOIN BurslulukSinavBursOrani	BO	ON	BO.BURSTUR		= 1	-- PUAN
													AND BO.MIN_DEGER	<= SP.PUAN
				WHERE SP.ID_SINAV = @ID_SINAV 

				CREATE TABLE #TEMP_BURS (TCKIMLIKNO VARCHAR(11),BURSORANI INT,ID_SINAV INT ,ID_SINAVDERS INT ,BURSTUR INT)

				SELECT MIN_DEGER,BURSORANI,OGRENCISAYISI,ROW_NUMBER () OVER(ORDER BY BURSORANI DESC) RN INTO #W_BURS FROM BurslulukSinavBursOrani WHERE ID_SINAV = @ID_SINAV AND BURSTUR = 1

				DECLARE	 @COUNT_BURS	INT = (SELECT COUNT(1) FROM #W_BURS)
						,@I_BURS		INT = 1
						,@MIN_DEGER		INT
						,@BURSORANI		INT
						,@OGRENCISAYISI INT

				WHILE (@I_BURS <= @COUNT_BURS)
				BEGIN
					SELECT @MIN_DEGER=MIN_DEGER,@BURSORANI=BURSORANI,@OGRENCISAYISI=OGRENCISAYISI FROM #W_BURS WHERE RN = @I_BURS

					INSERT INTO #TEMP_BURS  (TCKIMLIKNO,BURSORANI,ID_SINAV,BURSTUR)
					SELECT TOP (@OGRENCISAYISI) TCKIMLIKNO,@BURSORANI,ID_SINAV,BURSTUR
					FROM #BURSPUAN BP				
					WHERE	PUAN >= @MIN_DEGER
						AND TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #TEMP_BURS)

					SET @I_BURS = @I_BURS +1 
				END
			
				INSERT INTO BurslulukSinavOgrenciSonuc (TCKIMLIKNO,BURSORANI,ID_SINAV,BURSTUR)
				SELECT TCKIMLIKNO,BURSORANI,@ID_SINAV,1 FROM #TEMP_BURS 

			END


			BEGIN	--	DERS
				SELECT TCKIMLIKNO,YUZDENET,BO.*
				INTO #BURSDERS
				FROM vw_SinavOgrenciBolum		SB
				JOIN BurslulukSinavBursOrani	BO	ON	BO.ID_SINAVDERS	= SB.ID_SINAVDERS
													AND	BO.BURSTUR		= 2	-- PUAN
													AND BO.MAX_DEGER	>= SB.YUZDENET
													AND BO.MIN_DEGER	<= SB.YUZDENET
				WHERE SB.ID_SINAV = @ID_SINAV

				INSERT INTO BurslulukSinavOgrenciSonuc (TCKIMLIKNO,BURSORANI,ID_SINAV,ID_SINAVDERS,BURSTUR)
				SELECT TCKIMLIKNO,BURSORANI,ID_SINAV,ID_SINAVDERS,BURSTUR
				FROM #BURSDERS
				ORDER BY BURSORANI DESC
			END

			
		DROP TABLE IF EXISTS #W_BURS
		DROP TABLE IF EXISTS #TEMP_BURS
		DROP TABLE IF EXISTS #BURSPUAN
		DROP TABLE IF EXISTS #BURSDERS

	END

	--COMMIT TRAN T_SINAV

	
	
	UPDATE Sinav	SET DURUM = 2, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV	


	IF EXISTS (SELECT TOP 1 TCKIMLIKNO FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV)
		EXEC [dbo].[sp_SinavHariciPuanSira] @ISLEM = 3, @DOGRULAMA = '693M161f1Sv595Y', @ID_SINAV = @ID_SINAV	-- PUAN VE SIRALAMA BILGILERINI DEĞİŞTİRİYOR


	DROP TABLE IF EXISTS #SinavOgrenci
	DROP TABLE IF EXISTS #SinavOgrenciCevap
	DROP TABLE IF EXISTS #SinavOgrenciCevapBolum
	DROP TABLE IF EXISTS #SinavSonTyt
	DROP TABLE IF EXISTS #SinavOgrenciToplam

	DROP TABLE IF EXISTS #SinavSoruIslem
	DROP TABLE IF EXISTS #Temp
	DROP TABLE IF EXISTS #Temp2
	DROP TABLE IF EXISTS #OGRENCISINAVPUANKRITER

	END
	
	END TRY
	BEGIN CATCH
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = 'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' + ERROR_MESSAGE() + ', ID_SINAV: ' + CAST(@ID_SINAV AS VARCHAR)

		EXEC sp_HataMailiGonder @MSG,
								@ErrorSeverity,@ErrorState,'sp_OptikIslemleri'

		
		UPDATE SinavDegerlendir SET AKTIF = 0							WHERE ID_SINAV	= @ID_SINAV
		UPDATE Sinav			SET DURUM = 0, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV
		
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_OptikIslemleriEski]...';


GO
ALTER procedure [dbo].[sp_OptikIslemleriEski]
	@ISLEM				INT				= 0,
	@TCKIMLIKNO			VARCHAR(11)		= NULL,
	@OTURUM				VARCHAR(36)		= NULL,
	@ID_MENU			INT				= NULL,
	@ID_SINAVDOSYA		INT				= NULL,
	@ID_SINAV			INT				= NULL,
	@ID_SUBE			INT				= NULL	
AS

--SET XACT_ABORT ON

BEGIN

BEGIN TRY    
	--BEGIN TRAN
	DECLARE @MSG			VARCHAR(4000)
	DECLARE @ErrorSeverity	INT
	DECLARE @ErrorState		INT
	DECLARE @ID				INT				= NULL
	DECLARE @SINAVOTURUM	TINYINT			= NULL
	DECLARE @SQL			VARCHAR(max)	= NULL
	DECLARE @DOSYAYOL		VARCHAR(max)	= NULL
	DECLARE @DOSYAGUID		VARCHAR(50)		= NULL
	DECLARE @ID_KADEME		INT				= NULL

	SET @ID_KADEME=(SELECT DISTINCT ID_KADEME FROM OkyanusDB.dbo.v3KademeBilgi WHERE ID_KADEME3 = (SELECT ID_KADEME3 FROM Sinav WHERE ID_SINAV=@ID_SINAV))
	IF @ISLEM = 0	--	Sınav Dosya İşleme
	BEGIN

		
		UPDATE Sinav SET DURUM = 1, DEGERLENDIRILIYOR = 1 where ID_SINAV = @ID_SINAV


		DECLARE @BASLANGIC1 INT, @BASLANGIC2 INT, @BASLANGIC3 INT, @BASLANGIC4 INT, @BASLANGIC5 INT, @BASLANGIC6 INT
		DECLARE @OPTIKKARAKTERSAYISI1 INT, @OPTIKKARAKTERSAYISI2 INT, @OPTIKKARAKTERSAYISI3 INT, @OPTIKKARAKTERSAYISI4 INT, @OPTIKKARAKTERSAYISI5 INT, @OPTIKKARAKTERSAYISI6 INT

		SET @BASLANGIC1 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
		SET @BASLANGIC2 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 2)
		SET @BASLANGIC3 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 3)
		SET @BASLANGIC4 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 4)
		SET @BASLANGIC5 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 5)
		SET @BASLANGIC6 = (SELECT BASLANGIC from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 6)

		SET @OPTIKKARAKTERSAYISI1 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 1)
		SET @OPTIKKARAKTERSAYISI2 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 2)
		SET @OPTIKKARAKTERSAYISI3 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 3)
		SET @OPTIKKARAKTERSAYISI4 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 4)
		SET @OPTIKKARAKTERSAYISI5 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 5)
		SET @OPTIKKARAKTERSAYISI6 = (SELECT OPTIKKARAKTERSAYISI from SinavOptikSabit where ID_SINAV = @ID_SINAV and ID_SINAVOPTIK = 6)

		DECLARE @YANLISSAYISI DECIMAL(18, 2)
		SET @YANLISSAYISI = (SELECT ISNULL(YANLISSAYISI, 0) FROM Sinav	WHERE ID_SINAV = @ID_SINAV)


		DROP TABLE IF EXISTS #SinavDers

		SELECT SD.ID_SINAV, SD.ID_SINAVDERS, OD.BASLANGIC, OD.OPTIKKARAKTERSAYISI, OD.OTURUM
		INTO #SinavDers FROM SinavDers	SD
		INNER JOIN SinavOptikDers		OD	ON OD.ID_SINAVDERS = SD.ID_SINAVDERS
		WHERE SD.ID_SINAV = @ID_SINAV 

		PRINT '1: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
		
			--IF @ID_SINAVDOSYA IS NOT NULL AND NOT EXISTS(SELECT * FROM SinavOptikTemp WHERE ID_SINAVDOSYA=@ID_SINAVDOSYA)
			--BEGIN
				
			--	PRINT '2: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--	SET @DOSYAGUID = (SELECT GUID FROM SinavDosya where ID_SINAVDOSYA=@ID_SINAVDOSYA)
			--	create table #tmp (
			--		line nvarchar(max)
			--	);
			--	BEGIN TRY  
			--		SET @DOSYAYOL = '\\172.18.194.207\$SinavOptik\'+@DOSYAGUID+'.txt'
			--		SET @SQL=
			--		'BULK INSERT #tmp
			--		FROM '''+@DOSYAYOL+'''
			--		WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
			--		EXEC(@SQL) 
			--	END TRY  
			--	BEGIN CATCH  
			--		SET @DOSYAYOL = '\\172.18.194.207\$SinavOptik\'+@DOSYAGUID+'.dat'
			--		SET @SQL=
			--		'BULK INSERT #tmp
			--		FROM '''+@DOSYAYOL+'''
			--		WITH (FIELDTERMINATOR = '','',CODEPAGE=''ACP'')'
			--		EXEC(@SQL) 
			--	END CATCH 
				
			--	INSERT INTO SinavOptikTemp (LINE,ID_SINAVDOSYA)
			--	SELECT line, @ID_SINAVDOSYA FROM #tmp
			--	WHERE line IS NOT NULL
			--	DROP TABLE IF EXISTS #tmp

			--	PRINT '3: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--END			 

			PRINT '4: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			IF (SELECT COUNT(1) FROM SinavKitapcik WHERE ID_SINAV=@ID_SINAV)=1
			BEGIN
				
				PRINT '5: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				UPDATE SOT SET LINE=ISNULL(STUFF(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4,'A'),'') 
				FROM SinavOptikTemp SOT 
				INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA=SOT.ID_SINAVDOSYA 
				WHERE SD.ID_SINAV = @ID_SINAV

				PRINT '6: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE
			BEGIN
				
				PRINT '7: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DROP TABLE IF EXISTS #KITAPCIKSIZLAR

				SELECT 
				ID_SINAVOPTIKTEMP, LINE, RN = ROW_NUMBER() OVER (ORDER BY ID_SINAVOPTIKTEMP) 
				INTO #KITAPCIKSIZLAR
				FROM SinavOptikTemp	  SOT
				INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA=SOT.ID_SINAVDOSYA
				WHERE 
						SD.ID_SINAV = @ID_SINAV
					AND SUBSTRING(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4)=' '
		

				PRINT '8: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				IF (SELECT COUNT(1) FROM #KITAPCIKSIZLAR)>0
				BEGIN
					
					PRINT '9: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
					
					DROP TABLE IF EXISTS #KITAPCIKLAR

					SELECT ROW_NUMBER() OVER (ORDER BY AD) AS RN, SK.ID_SINAVKITAPCIK, AD, SD.ID_SINAVDERS, SOD.BASLANGIC, SOD.OPTIKKARAKTERSAYISI, STUFF((SELECT ''+CEVAP FROM SinavAnahtar WHERE ID_SINAVKITAPCIK=SK.ID_SINAVKITAPCIK AND ID_SINAVDERS=SD.ID_SINAVDERS ORDER BY SORUNO FOR XML PATH('')),1,0,'') CEVAPLAR
					INTO #KITAPCIKLAR 
					FROM SinavKitapcik			SK
					INNER JOIN SinavDers		SD ON SD.ID_SINAV=SK.ID_SINAV
					INNER JOIN SinavOptikDers	SOD ON SOD.ID_SINAVDERS=SD.ID_SINAVDERS
					WHERE SK.ID_SINAV=@ID_SINAV

					PRINT '10: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

					DECLARE @COUNTER INT = 1
					DECLARE @COUNTKITAPCIKSIZLAR INT=(SELECT COUNT(1) FROM #KITAPCIKSIZLAR)
					WHILE @COUNTER <= @COUNTKITAPCIKSIZLAR
					BEGIN
						
						PRINT '11: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						DECLARE @KSIZLINE VARCHAR(MAX)
						DECLARE @KSIZID_SINAVOPTIKTEMP INT
						SELECT @KSIZID_SINAVOPTIKTEMP=ID_SINAVOPTIKTEMP ,@KSIZLINE=LINE FROM #KITAPCIKSIZLAR WHERE RN=@COUNTER

						DECLARE @KITAPCIKDOGRUSAYISI TABLE (KITAPCIK VARCHAR(1), DOGRUSAYISI INT)
												
						DECLARE @COUNTER2 INT = 1
						DECLARE @COUNTKITAPCIKLAR INT=(SELECT COUNT(1) FROM #KITAPCIKLAR)
						WHILE @COUNTER2 <= @COUNTKITAPCIKLAR
						BEGIN
							
							PRINT '12: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

							INSERT INTO @KITAPCIKDOGRUSAYISI(KITAPCIK, DOGRUSAYISI)
							VALUES 
							(
								(SELECT AD FROM #KITAPCIKLAR WHERE RN=@COUNTER2)
								,(
									SELECT SUM(DS) FROM (SELECT dbo.fn_SayiBul2(
												 RTRIM(SUBSTRING(@KSIZLINE,K.BASLANGIC,K.OPTIKKARAKTERSAYISI))
												,K.CEVAPLAR
											) AS DS
										FROM #KITAPCIKLAR K WHERE RN=@COUNTER2) XTABLE
								)
							)
							SET @COUNTER2 += 1
						END
						
						PRINT '13: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

						DECLARE @KITAPCIK CHAR
						DECLARE @DOGRUSAYISI INT 
		
						SELECT TOP 1 @KITAPCIK = KITAPCIK, @DOGRUSAYISI=SUM(DOGRUSAYISI) FROM @KITAPCIKDOGRUSAYISI GROUP BY KITAPCIK ORDER BY SUM(DOGRUSAYISI) DESC
						UPDATE SinavOptikTemp SET LINE = ISNULL(STUFF(LINE,@BASLANGIC4,@OPTIKKARAKTERSAYISI4,@KITAPCIK),'') WHERE ID_SINAVOPTIKTEMP=@KSIZID_SINAVOPTIKTEMP

						DELETE FROM @KITAPCIKDOGRUSAYISI
						SET @COUNTER += 1

						PRINT '14: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

					END
					DROP TABLE IF EXISTS #KITAPCIKLAR

					PRINT '15: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				END

				DROP TABLE IF EXISTS #KITAPCIKSIZLAR

				PRINT '16: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			

			PRINT '17: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #SinavOgrenci

			CREATE TABLE #SinavOgrenci(
				 ID_SINAVOGRENCI int NOT NULL IDENTITY(1,1)
				,[ID_SINAV] INT
				,[TCKIMLIKNO] VARCHAR(MAX)
				,[AD] VARCHAR(MAX)
				,[SOYAD] VARCHAR(MAX)
				,[KITAPCIK] VARCHAR(MAX)
				,[SUBENO] VARCHAR(MAX)
				,[SINIF] VARCHAR(MAX)
				,[ID_SINAVDOSYA] INT
				,[ID_SINAVOPTIKTEMP] INT
				)


				DECLARE @GUID NVARCHAR(MAX) = NEWID()

			DECLARE @TBL_OGRENCI TABLE(ID_SINAVOGRENCI INT, ID_SINAVOPTIKTEMP INT, ID_SINAV INT, ID_SINAVDOSYA INT, TCKIMLIKNO VARCHAR(MAX))
			INSERT INTO #SinavOgrenci
				([ID_SINAV]
				,[TCKIMLIKNO]
				,[AD]
				,[SOYAD]
				,[KITAPCIK]
				,[SUBENO]
				,[SINIF]
				,[ID_SINAVDOSYA]
				,[ID_SINAVOPTIKTEMP])
			OUTPUT INSERTED.ID_SINAVOGRENCI, INSERTED.ID_SINAVOPTIKTEMP, INSERTED.ID_SINAV, INSERTED.ID_SINAVDOSYA, INSERTED.TCKIMLIKNO INTO @TBL_OGRENCI
			SELECT 
			 @ID_SINAV
			,RTRIM(SUBSTRING(LINE, @BASLANGIC1, @OPTIKKARAKTERSAYISI1))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC2, @OPTIKKARAKTERSAYISI2))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC3, @OPTIKKARAKTERSAYISI3))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC4, @OPTIKKARAKTERSAYISI4))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC5, @OPTIKKARAKTERSAYISI5))
			,RTRIM(SUBSTRING(LINE, @BASLANGIC6, @OPTIKKARAKTERSAYISI6))
			,SD.ID_SINAVDOSYA 
			,S.ID_SINAVOPTIKTEMP
			FROM SinavOptikTemp S
			INNER JOIN SinavDosya SD ON SD.ID_SINAVDOSYA = S.ID_SINAVDOSYA AND SD.ID_SINAV = @ID_SINAV AND SD.AKTIF = 1
			
			
			PRINT '18: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			--------------------------------------------------------------------------------------------------

			DROP TABLE IF EXISTS #SinavOgrenciCevapBolum

			CREATE TABLE #SinavOgrenciCevapBolum(
				ID_SINAVOGRENCICEVAPBOLUM INT NOT NULL IDENTITY(1, 1)
					,[ID_SINAVOGRENCI] INT
					,[ID_SINAVDERS] INT
					,[CEVAPLAR] VARCHAR(MAX)
					,[DOGRU] INT
					,[YANLIS] INT
					,[BOS] INT
					,[NET] DECIMAL(18, 2)
					,[YUZDEDOGRU] DECIMAL(18, 2)
					,[YUZDENET] DECIMAL(18, 2)
					,[PUAN] DECIMAL(18, 3)
					,TCKIMLIKNO VARCHAR(MAX)
					)

			INSERT INTO #SinavOgrenciCevapBolum
					([ID_SINAVOGRENCI]
					,[ID_SINAVDERS]
					,[CEVAPLAR]
					,[DOGRU]
					,[YANLIS]
					,[BOS]
					,[NET]
					,[YUZDEDOGRU]
					,[YUZDENET]
					,[PUAN]
					,TCKIMLIKNO)
			SELECT	 TEMP.ID_SINAVOGRENCI
					,SD.ID_SINAVDERS
					,SUBSTRING(SOT.LINE,SDT.BASLANGIC,SDT.OPTIKKARAKTERSAYISI) as CEVAPLAR
					,0,0,0,0,0,0,0, TEMP.TCKIMLIKNO
			FROM @TBL_OGRENCI TEMP
			INNER JOIN SinavOptikTemp	SOT		WITH (NOLOCK) on SOT.ID_SINAVOPTIKTEMP = TEMP.ID_SINAVOPTIKTEMP
			INNER JOIN SinavDosya		SDO		WITH (NOLOCK) on SDO.ID_SINAVDOSYA = TEMP.ID_SINAVDOSYA
			INNER JOIN SinavDers		SD		WITH (NOLOCK) on SD.ID_SINAV = TEMP.ID_SINAV
			INNER JOIN #SinavDers		SDT					  on SDT.ID_SINAVDERS = SD.ID_SINAVDERS and SDT.OTURUM=SDO.OTURUM
			
			PRINT '19: ' + CONVERT( VARCHAR(24), GETDATE(), 121)	

			---------------------------
			--SinavOgrenciCevapInsert--
			---------------------------
			DECLARE @SORUDOGRU	INT=1,
					@SORUBOS	INT=2,
					@SORUxDOGRU	INT=3,
					@SORUIPTAL	INT=4
			
			DROP TABLE IF EXISTS #Temp
			DROP TABLE IF EXISTS #Temp2


			DROP TABLE IF EXISTS #SinavSoruIslem

			SELECT DISTINCT SS.ID_SINAVANAHTAR, SS.ID_SORUISLEM 
			INTO #SinavSoruIslem FROM SinavSoruIslem	SS
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVANAHTAR	= SS.ID_SINAVANAHTAR
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAVKITAPCIK	= SA.ID_SINAVKITAPCIK
			WHERE SK.ID_SINAV = @ID_SINAV


			SELECT I.* 
			INTO #ASSISLEM
			FROM SinavDers SD
			JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= SD.ID_SINAV
			JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
									AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
			JOIN SinavSoruIslem  I	ON	I.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
			WHERE	SD.ID_SINAV		= @ID_SINAV
				AND SK.AD			= 'A'
				AND I.ID_SORUISLEM	= 3

			IF EXISTS(SELECT TOP 1 1 FROM #ASSISLEM)
			BEGIN
				DELETE FROM I
				FROM SinavDers SD
				JOIN SinavKitapcik	SK	ON	SK.ID_SINAV			= SD.ID_SINAV
				JOIN SinavAnahtar	SA	ON	SA.ID_SINAVDERS		= SD.ID_SINAVDERS
										AND SA.ID_SINAVKITAPCIK = SK.ID_SINAVKITAPCIK
				JOIN SinavSoruIslem  I	ON	I.ID_SINAVANAHTAR	= SA.ID_SINAVANAHTAR
				WHERE	SD.ID_SINAV		= @ID_SINAV
					AND I.ID_SORUISLEM	= 3
		
				INSERT INTO SinavSoruIslem (ID_SINAVANAHTAR,ID_SORUISLEM,OGRENCICEVAP) 					
					SELECT A.ID_SINAVANAHTAR						
						,I.ID_SORUISLEM
						,I.OGRENCICEVAP 
					FROM #ASSISLEM			I
					JOIN SinavAnahtar		SA	ON	I.ID_SINAVANAHTAR =SA.ID_SINAVANAHTAR
					JOIN SinavDers			SD	ON	SD.ID_SINAVDERS = SA.ID_SINAVDERS
					JOIN SinavAnahtar		A	ON	A.ID_SINAVDERS	= SD.ID_SINAVDERS AND A.SORUNO_A = SA.SORUNO_A
			END
			 
			DROP TABLE IF EXISTS #ASSISLEM

			SELECT 
				 SO.ID_SINAVOGRENCI, CB.ID_SINAVOGRENCICEVAPBOLUM, CB.ID_SINAVDERS, CB.CEVAPLAR, SK.AD, SA.SORUNO, SA.OPTIKKARAKTERSAYISI, ANAHTAR = SA.CEVAP
				 ,SS.ID_SORUISLEM, SA.ID_SINAVANAHTAR
			INTO #Temp 
			FROM #SinavOgrenciCevapBolum	CB  WITH (NOLOCK) 
			INNER JOIN #SinavOgrenci		SO	WITH (NOLOCK) ON SO.ID_SINAVOGRENCI		= CB.ID_SINAVOGRENCI
			INNER JOIN SinavKitapcik		SK	WITH (NOLOCK) ON SK.AD					= SO.KITAPCIK
			INNER JOIN SinavAnahtar			SA	WITH (NOLOCK) ON SA.ID_SINAVKITAPCIK	= SK.ID_SINAVKITAPCIK	AND SA.ID_SINAVDERS = CB.ID_SINAVDERS
			LEFT  JOIN #SinavSoruIslem		SS	WITH (NOLOCK) ON SS.ID_SINAVANAHTAR		= SA.ID_SINAVANAHTAR
			WHERE SO.ID_SINAV = @ID_SINAV
			--ORDER BY SO.ID_SINAVOGRENCI, CB.ID_SINAVDERS, SA.SORUNO

			PRINT '20: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			SELECT
				 *
				,BASLANGIC_OPTIKSIRA = 
					ISNULL((	SELECT 
							SUM(TSUB.OPTIKKARAKTERSAYISI) 
						FROM #Temp TSUB 
						WHERE TSUB.ID_SINAVOGRENCICEVAPBOLUM = T.ID_SINAVOGRENCICEVAPBOLUM AND TSUB.ID_SINAVDERS = T.ID_SINAVDERS AND TSUB.SORUNO < T.SORUNO
					), 0) + 1
			INTO #Temp2 FROM #Temp	T
			--ORDER BY T.ID_SINAVOGRENCI, T.ID_SINAVDERS, T.SORUNO

			PRINT '21: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #K

			SELECT DISTINCT SS.ID_SINAVANAHTAR, SS.ID_SORUISLEM, SI.OGRENCICEVAP 
			INTO #K FROM #SinavSoruIslem SS
			JOIN SinavSoruIslem SI	ON	SI.ID_SINAVANAHTAR = SS.ID_SINAVANAHTAR
			WHERE SS.ID_SORUISLEM = @SORUxDOGRU

			PRINT '22: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #SinavOgrenciCevap

			CREATE TABLE #SinavOgrenciCevap
			(
				 [ID_SINAVOGRENCICEVAPBOLUM]	INT
				,[SORUNO]						INT
				,[CEVAP]				VARCHAR(MAX)
				,[DURUM]				VARCHAR(MAX)
				,ANAHTAR				VARCHAR(MAX)
				,ID_SORUISLEM					INT
				,ID_SINAVANAHTAR				INT
			)

			INSERT INTO #SinavOgrenciCevap
								([ID_SINAVOGRENCICEVAPBOLUM]
								,[SORUNO]
								,[CEVAP]
								,[DURUM]
								,ANAHTAR
								,ID_SORUISLEM
								,ID_SINAVANAHTAR)
				SELECT	T.ID_SINAVOGRENCICEVAPBOLUM, SORUNO, CEVAP = SUBSTRING(CEVAPLAR, BASLANGIC_OPTIKSIRA, OPTIKKARAKTERSAYISI)
						,DURUM			= ''
						,ANAHTAR		= ANAHTAR
						,ID_SORUISLEM	= T.ID_SORUISLEM
						,ID_SINAVANAHTAR= T.ID_SINAVANAHTAR
				FROM #Temp2	T
				

				UPDATE #SinavOgrenciCevap SET DURUM = CASE 
														WHEN CEVAP = ''						THEN 'B'
														WHEN CEVAP = ANAHTAR				THEN 'D'
														WHEN CEVAP = '*' AND @ID_KADEME=  4	THEN 'B' --5,6,7,8 DE * GELİRSE BOŞ SAYILACAK (ÇİFT CEVAP)
													ELSE 'Y' END


				UPDATE SO SET DURUM = CASE
									WHEN SO.ID_SORUISLEM	= @SORUDOGRU	THEN 'D' 
									WHEN SO.ID_SORUISLEM	= @SORUBOS		THEN 'B'
									WHEN SO.ID_SORUISLEM	= @SORUIPTAL	THEN 'I'
									WHEN SO.ID_SORUISLEM	= @SORUxDOGRU	THEN 
										CASE WHEN  SO.CEVAP IN (SELECT OGRENCICEVAP FROM #K WHERE #K.ID_SINAVANAHTAR = SO.ID_SINAVANAHTAR)	THEN 'D'
											 ELSE  DURUM
										END
								ELSE DURUM
							END
				FROM #SinavOgrenciCevap	SO
				WHERE SO.ID_SORUISLEM IS NOT NULL

				
			PRINT '23: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


			;WITH t2( ID_SINAVOGRENCICEVAPBOLUM, DOGRU, YANLIS, BOS, PUAN) AS
			(
					SELECT 
							 OC.ID_SINAVOGRENCICEVAPBOLUM
							,DOGRU		= SUM(CASE WHEN OC.DURUM = 'D' THEN 1 ELSE 0 END) 
							,YANLIS		= SUM(CASE WHEN OC.DURUM = 'Y' THEN 1 ELSE 0 END) 
							,BOS		= SUM(CASE WHEN OC.DURUM = 'B' THEN 1 ELSE 0 END)
							,PUAN		= SUM(CASE WHEN OC.DURUM = 'D' THEN ISNULL(SA.KATSAYI, 0) ELSE 0 END)
					FROM #SinavOgrenciCevapBolum	CB  WITH (NOLOCK) 
					JOIN #SinavOgrenciCevap			OC	WITH (NOLOCK) ON OC.ID_SINAVOGRENCICEVAPBOLUM	= CB.ID_SINAVOGRENCICEVAPBOLUM
					JOIN #SinavOgrenci				OG	WITH (NOLOCK) ON OG.ID_SINAVOGRENCI				= CB.ID_SINAVOGRENCI
					JOIN SinavKitapcik				SK	WITH (NOLOCK) ON SK.AD							= OG.KITAPCIK
					JOIN SinavAnahtar				SA	WITH (NOLOCK) ON SK.ID_SINAVKITAPCIK			= SA.ID_SINAVKITAPCIK AND SA.ID_SINAVDERS = CB.ID_SINAVDERS AND SA.SORUNO = OC.SORUNO
					WHERE OG.ID_SINAV = @ID_SINAV
					GROUP BY OC.ID_SINAVOGRENCICEVAPBOLUM
			)
			UPDATE   CB 
			SET		 DOGRU		= t2.DOGRU
					,YANLIS		= t2.YANLIS
					,BOS		= t2.BOS
					,PUAN		= t2.PUAN
					,NET		= (CASE @YANLISSAYISI WHEN 0 THEN t2.DOGRU ELSE t2.DOGRU - t2.YANLIS / @YANLISSAYISI END)
					,YUZDEDOGRU	= CAST(t2.DOGRU AS FLOAT) / (t2.DOGRU + t2.YANLIS + t2.BOS) * 100.0
					,YUZDENET	= CAST((CASE @YANLISSAYISI WHEN 0 THEN t2.DOGRU ELSE t2.DOGRU - t2.YANLIS / @YANLISSAYISI END) AS FLOAT) / (t2.DOGRU + t2.YANLIS + t2.BOS) * 100.0
			FROM #SinavOgrenciCevapBolum CB WITH (NOLOCK)
			INNER JOIN t2 ON t2.ID_SINAVOGRENCICEVAPBOLUM = CB.ID_SINAVOGRENCICEVAPBOLUM

			PRINT '24: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			DROP TABLE IF EXISTS #K

			---------------
			--PUAN KRİTER--
			---------------
			SELECT DISTINCT  SNK.ID_SINAVPUANTURU
							,SNK.ID_SINAVNETKRITER
							,SNK.NET
							,ID_DERSLIST = (
								SELECT ID_SINAVDERS
								FROM SinavNetKriterDers SNKD
								WHERE SNKD.ID_SINAVNETKRITER = SNK.ID_SINAVNETKRITER
								FOR JSON PATH
							) 
			INTO #KRITERLIST
			FROM SinavNetKriterDers SNKD
			JOIN SinavNetKriter SNK ON SNK.ID_SINAVNETKRITER = SNKD.ID_SINAVNETKRITER
			WHERE SNKD.ID_SINAVDERS IN (SELECT ID_SINAVDERS FROM SinavDers WHERE ID_SINAV = @ID_SINAV)

			SELECT	 SO.TCKIMLIKNO
					,SPT.ID_SINAVPUANTURU
					,HESAPDURUM =	CASE 
									WHEN NOT EXISTS (SELECT 1 FROM #KRITERLIST K WHERE K.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU) THEN 1 -- PUAN TÜRÜNDE KRİTER YOK İSE
									WHEN ( 
											SELECT CASE WHEN EXISTS -- PUAN TÜRÜNDE KRİTER SAĞLANMAYAN BİR DURUM VAR İSE
											(
												SELECT 1 
												FROM (	
													SELECT /*SOCB.ID_SINAVOGRENCI, K.ID_SINAVNETKRITER, */CASE WHEN SUM(SOCB.NET) < K.NET THEN 0 ELSE 1 END AS DURUM
													FROM #SinavOgrenciCevapBolum SOCB 
													JOIN #KRITERLIST K ON K.ID_SINAVPUANTURU = SPT.ID_SINAVPUANTURU AND SOCB.ID_SINAVDERS IN (SELECT JSON_Value (value, '$.ID_SINAVDERS') FROM OPENJSON(K.ID_DERSLIST))
													WHERE SOCB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI 
													GROUP BY SOCB.ID_SINAVOGRENCI, K.ID_SINAVNETKRITER, K.NET
												) X WHERE X.DURUM = 1
											) 
											THEN 1
											ELSE 0 
											END
										) = 0 THEN 0
									ELSE 1 -- PUAN TÜRÜNDE BÜTÜN KRİTERLER SAĞLANIYOR İSE
									END
			INTO #OGRENCISINAVPUANKRITER
			FROM Sinav S
			JOIN SinavPuanTuru SPT ON SPT.ID_SINAVTURU = S.ID_SINAVTURU
			JOIN #SinavOgrenci SO ON SO.ID_SINAV = S.ID_SINAV
			WHERE S.ID_SINAV = @ID_SINAV
			ORDER BY SO.TCKIMLIKNO

			DROP TABLE #KRITERLIST
			---------------
			--PUAN KRİTER--
			---------------

			-------------------------------
			--SinavOgrenciSonucPuanInsert--
			-------------------------------
			DECLARE @ID_SINAVTURU INT, @ID_SINAVTYT INT, @ID_SINAVDEGERLENDIR INT
			SELECT @ID_SINAVTURU = ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV
			
			DROP TABLE IF EXISTS #SinavOgrenciPuan
			CREATE TABLE #SinavOgrenciPuan(
							 TCKIMLIKNO VARCHAR(MAX)
							,[ID_SINAVPUANTURU] INT
							,[PUAN] DECIMAL(18, 3)
							,GENELSIRA INT
							,ILSIRA INT
							,ILCESIRA INT
							,OKULSIRA INT
							,SINIFSIRA INT
							)


			DROP TABLE IF EXISTS #SinavSonTyt
			CREATE TABLE #SinavSonTyt(TCKIMLIKNO VARCHAR(MAX), ID_SINAV INT, TYTPUAN DECIMAL(18, 3))

			IF @ID_SINAVTURU = 3 or @ID_SINAVTURU = 4	--	YKS
			BEGIN
				DECLARE @ID_TYTSECIMTUR INT, @TYTBARAJ DECIMAL(18, 3)
				SELECT @ID_TYTSECIMTUR = ISNULL(ID_TYTSECIMTUR, 1), @TYTBARAJ = ISNULL(PUAN, -999) FROM SinavTYTSecimTurKriter WHERE ID_SINAV = @ID_SINAV
				
				PRINT '25: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DECLARE @SINAVTARIHI DATE = (SELECT SINAVTARIH FROM Sinav WHERE ID_SINAV = @ID_SINAV)

				IF @ID_TYTSECIMTUR = 1 ------ Önceki Son Tyt Sınavının TYT Puanı
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, ID_SINAV = MAX(S.ID_SINAV), TYTPUAN = (SELECT PUAN FROM SinavOgrenciPuan WHERE ID_SINAV = MAX(S.ID_SINAV) AND TCKIMLIKNO = SP.TCKIMLIKNO)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					GROUP BY SP.TCKIMLIKNO
				END
				ELSE IF @ID_TYTSECIMTUR = 2 ------ Önceki Son Tyt Sınavının TYT Puanı (0 DAN BÜYÜK OLAN)
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, ID_SINAV = MAX(S.ID_SINAV), TYTPUAN = (SELECT PUAN FROM SinavOgrenciPuan WHERE ID_SINAV = MAX(S.ID_SINAV) AND TCKIMLIKNO = SP.TCKIMLIKNO)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					AND SP.PUAN				> 0
					GROUP BY SP.TCKIMLIKNO
				END
				ELSE IF @ID_TYTSECIMTUR = 3 ------ Önceki Tüm Tyt Sınavının TYT Puan Ortalamaları
				BEGIN
					INSERT INTO #SinavSonTyt(TCKIMLIKNO, ID_SINAV, TYTPUAN)
					SELECT SP.TCKIMLIKNO, 0, TYTPUAN = AVG(SP.PUAN)
					FROM Sinav								S
					INNER JOIN [dbo].[vw_SinavOgrenciPuan]	SP		WITH (NOLOCK) ON SP.ID_SINAV	=	S.ID_SINAV AND SP.ID_SINAVPUANTURU = CAST(1 AS INT)
					INNER JOIN #SinavOgrenci				SO		WITH (NOLOCK) ON SO.TCKIMLIKNO	=	SP.TCKIMLIKNO
					WHERE 
						S.ID_SINAVTURU		= 2 
					AND S.SINAVTARIH		< @SINAVTARIHI 
					GROUP BY SP.TCKIMLIKNO
				END
				
				PRINT '28: ' + CONVERT( VARCHAR(24), GETDATE(), 121)			
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT 
							yTABLE.TCKIMLIKNO
							,yTABLE.ID_SINAVPUANTURU
							,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = yTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = yTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
									THEN 0
									ELSE (
											CASE 
												WHEN yTABLE.TYTPUAN IS NULL 
												THEN (yTABLE.TABANPUAN+yTABLE.SKATSAYI)
												ELSE (
														CASE
														WHEN @TYTBARAJ > yTABLE.TYTPUAN
														THEN 0
														ELSE ((yTABLE.TABANPUAN+yTABLE.SKATSAYI)*0.6)+(yTABLE.TYTPUAN*0.4)
														END
													)
											END
										)
							 END
							 AS PUAN
				FROM
				(
					SELECT xTABLE.TCKIMLIKNO
							,ID_SINAVPUANTURU
							,xTABLE.TABANPUAN
							,SUM(xTABLE.NET*xTABLE.KATSAYI) as SKATSAYI
							,TYT.TYTPUAN
					FROM
					(
						SELECT so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, s.SINAVTARIH 
						FROM #SinavOgrenci so WITH (NOLOCK)
						INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
						INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
						INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
						INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
						INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
						INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND SK.ID_SINAV=S.ID_SINAV
						WHERE so.ID_SINAV=@ID_SINAV
					) xTABLE
					LEFT JOIN #SinavSonTyt TYT ON TYT.TCKIMLIKNO = xTABLE.TCKIMLIKNO
					GROUP BY xTABLE.TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN, TYT.TYTPUAN
					
				) yTABLE


				PRINT '29: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU = 6	--	ADIM ADIM YKS
			BEGIN
				
				PRINT '30: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
				
				
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT xTABLE.TCKIMLIKNO, xTABLE.ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI))) 
						 END AS PUAN 
				FROM
				(
					SELECT so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS 
					FROM #SinavOgrenci so WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN

				UPDATE SOS SET SOS.PUAN = SOS.PUAN * 0.6 + (SELECT SUBSOS.PUAN FROM #SinavOgrenciPuan SUBSOS WITH (NOLOCK) WHERE SUBSOS.TCKIMLIKNO = SOS.TCKIMLIKNO AND SUBSOS.ID_SINAVPUANTURU = 9) * 0.4
				FROM #SinavOgrenciPuan SOS WITH (NOLOCK)
				WHERE SOS.ID_SINAVPUANTURU IN (11, 12, 13)


				

				PRINT '32: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU = 2	--	TYT
			BEGIN
				
				PRINT '33: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN


				PRINT '34: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

			END
			ELSE IF	@ID_SINAVTURU IN(8, 9)
			BEGIN

				PRINT '35: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
				
				SELECT SD.BOLUMNO, STANDARTSAPMA = STDEV(CB.NET) 
				INTO #StandartSapma 
				FROM #SinavOgrenciCevapBolum	CB WITH (NOLOCK)
				INNER JOIN SinavDers			SD WITH (NOLOCK)	ON SD.ID_SINAVDERS = CB.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				GROUP BY SD.BOLUMNO
				ORDER BY SD.BOLUMNO

				SELECT SD.BOLUMNO, NET = AVG(CB.NET) 
				INTO #OrtalamaNet 
				FROM #SinavOgrenciCevapBolum	CB WITH (NOLOCK)
				INNER JOIN SinavDers			SD WITH (NOLOCK)	ON SD.ID_SINAVDERS = CB.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				GROUP BY SD.BOLUMNO
				ORDER BY SD.BOLUMNO

				SELECT SD.ID_SINAV, SO.TCKIMLIKNO, SD.BOLUMNO, CB.KATSAYI, TASP = CASE WHEN ST.STANDARTSAPMA = 0 THEN 0 ELSE (CB.KATSAYI * (OG.NET - OT.NET) / CAST(ST.STANDARTSAPMA AS FLOAT) * 10) + 50 END
				INTO #Tasp FROM SinavKatsayi		CB	WITH (NOLOCK)
				INNER JOIN SinavDers				SD	WITH (NOLOCK)	ON SD.ID_SINAVDERS		= CB.ID_SINAVDERS
				INNER JOIN #OrtalamaNet				OT	WITH (NOLOCK)	ON OT.BOLUMNO			= SD.BOLUMNO
				INNER JOIN #StandartSapma			ST	WITH (NOLOCK)	ON ST.BOLUMNO			= SD.BOLUMNO
				INNER JOIN #SinavOgrenci			SO	WITH (NOLOCK)	ON SO.ID_SINAV			= SD.ID_SINAV
				INNER JOIN #SinavOgrenciCevapBolum	OG	WITH (NOLOCK)	ON OG.ID_SINAVOGRENCI	= SO.ID_SINAVOGRENCI	AND OG.ID_SINAVDERS = SD.ID_SINAVDERS
				WHERE SD.ID_SINAV = @ID_SINAV
				ORDER BY SO.TCKIMLIKNO, SD.BOLUMNO

				IF @ID_SINAVTURU = 8 
				BEGIN
				
					DROP TABLE IF EXISTS #MAX_TASP
					DROP TABLE IF EXISTS #MUAF_TASP
					DROP TABLE IF EXISTS #OGRTOPLAMTASP
					DROP TABLE IF EXISTS #OgrenciDersMuaf

					SELECT	 DM.TCKIMLIKNO
							,DM.DIN_MUAF
							,DM.INGILIZCE_MUAF 
					INTO #OgrenciDersMuaf
					FROM OgrenciDersMuaf	DM
					JOIN #SinavOgrenci		SO	ON	SO.TCKIMLIKNO = DM.TCKIMLIKNO 

					IF EXISTS (SELECT TOP 1 1 FROM #OgrenciDersMuaf)
					BEGIN
						SELECT BOLUMNO, MAX(TASP) MAX_TASP
						INTO #MAX_TASP
						FROM #Tasp 
						GROUP BY BOLUMNO

						DECLARE	 @DIN INT = 0
								,@ING INT = 0

						SELECT @DIN = SD.BOLUMNO 
						FROM SinavDers			SD					
						JOIN eokul_v2.dbo.Ders	ED	ON	ED.ID_DERS = SD.ID_DERS 
						WHERE	SD.ID_SINAV = @ID_SINAV
							AND ED.DERSAD LIKE '%Din Kült. Ve A. B.%'
						
						SELECT @ING = SD.BOLUMNO 
						FROM SinavDers			SD					
						JOIN eokul_v2.dbo.Ders	ED	ON	ED.ID_DERS = SD.ID_DERS 
						WHERE	SD.ID_SINAV = @ID_SINAV
							AND ED.DERSAD LIKE '%İngilizce%'

						DECLARE @DI_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @DIN AND ST.BOLUMNO != @ING	)
								,@D_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @DIN							)
								,@I_T_TASP		FLOAT = (SELECT SUM(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO != @ING							)
								,@D_MAX_TASP	FLOAT = (SELECT MAX(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO =  @DIN							)
								,@I_MAX_TASP	FLOAT = (SELECT MAX(ST.MAX_TASP) FROM #MAX_TASP ST WHERE ST.BOLUMNO =  @ING							)

						SELECT	DISTINCT
								DI_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @DIN AND ST.BOLUMNO != @ING AND ST.TCKIMLIKNO = T.TCKIMLIKNO	)
								,D_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @DIN AND ST.TCKIMLIKNO = T.TCKIMLIKNO							)
								,I_OGR_TASP = (SELECT SUM(ST.TASP) FROM #Tasp ST WHERE ST.BOLUMNO != @ING AND ST.TCKIMLIKNO = T.TCKIMLIKNO							)
								,TCKIMLIKNO	= T.TCKIMLIKNO
								,MUAF		=  CASE	WHEN M.INGILIZCE_MUAF	= 1 AND M.DIN_MUAF = 1	THEN 1
													WHEN M.INGILIZCE_MUAF	= 1						THEN 2
													WHEN M.DIN_MUAF			= 1						THEN 3
																									ELSE 0
												END 
						INTO #OGRTOPLAMTASP
						FROM #Tasp				T
						JOIN #OgrenciDersMuaf	M	ON	M.TCKIMLIKNO = T.TCKIMLIKNO 
					
						SELECT	 ING = CASE	WHEN M.MUAF = 1 THEN (M.DI_OGR_TASP/@DI_T_TASP) * @I_MAX_TASP
											WHEN M.MUAF = 2 THEN (M.I_OGR_TASP / @I_T_TASP) * @I_MAX_TASP
											ELSE NULL
									   END 
								,DIN = CASE	WHEN M.MUAF = 1 THEN (M.DI_OGR_TASP/@DI_T_TASP) * @D_MAX_TASP
											WHEN M.MUAF = 3 THEN (M.D_OGR_TASP / @D_T_TASP) * @D_MAX_TASP
											ELSE NULL
									   END 
								,M.MUAF
								,T.TCKIMLIKNO
						INTO #MUAF_TASP
						FROM #Tasp			T
						JOIN #OGRTOPLAMTASP	M	ON	M.TCKIMLIKNO = T.TCKIMLIKNO 
					
						UPDATE T
						SET T.TASP = MT.DIN
						FROM #Tasp		T
						JOIN #MUAF_TASP	MT	ON	MT.TCKIMLIKNO	= T.TCKIMLIKNO
						WHERE	T.BOLUMNO = @DIN
							AND MT.DIN	IS NOT NULL

						UPDATE T
						SET T.TASP = MT.ING
						FROM #Tasp		T
						JOIN #MUAF_TASP	MT	ON	MT.TCKIMLIKNO	= T.TCKIMLIKNO
						WHERE	T.BOLUMNO = @ING
							AND MT.ING	IS NOT NULL

					END


					DROP TABLE IF EXISTS #MAX_TASP
					DROP TABLE IF EXISTS #MUAF_TASP
					DROP TABLE IF EXISTS #OGRTOPLAMTASP
					DROP TABLE IF EXISTS #OgrenciDersMuaf

				END


				
				--DECLARE @MIN_TASP FLOAT, @MAX_TASP FLOAT
				--SELECT @MIN_TASP = MIN(TASP), @MAX_TASP = MAX(TASP) FROM #Tasp
				DECLARE @MIN_TASP FLOAT, @MAX_TASP FLOAT
				SELECT SUM(TASP) AS TASP, TCKIMLIKNO INTO #TASPOGRENCI FROM #Tasp GROUP BY TCKIMLIKNO
				SELECT @MIN_TASP = MIN(TASP), @MAX_TASP = MAX(TASP) FROM #TASPOGRENCI

				
								
				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT SO.TCKIMLIKNO, PT.ID_SINAVPUANTURU
						,PUAN = CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = PT.ID_SINAVPUANTURU AND TCKIMLIKNO = SO.TCKIMLIKNO AND HESAPDURUM = 0)
										THEN 0
										ELSE (SP.TABANPUAN + 400 * ((SELECT SUM(Z.TASP) FROM #TASP Z WHERE Z.TCKIMLIKNO=SO.TCKIMLIKNO) - @MIN_TASP) / (CASE (@MAX_TASP - @MIN_TASP) WHEN 0 THEN 1 ELSE (@MAX_TASP - @MIN_TASP) END))
								END
				FROM SinavTabanPuan			SP WITH (NOLOCK)
				INNER JOIN Sinav			SN WITH (NOLOCK)	ON SN.ID_SINAV		= SP.ID_SINAV
				INNER JOIN SinavPuanTuru	PT WITH (NOLOCK)	ON PT.ID_SINAVTURU	= SN.ID_SINAVTURU
				INNER JOIN #SinavOgrenci	SO WITH (NOLOCK)	ON SO.ID_SINAV		= SN.ID_SINAV
				where SN.ID_SINAV=@ID_SINAV


				PRINT '36: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				DROP TABLE IF EXISTS #OrtalamaNet
				DROP TABLE IF EXISTS #StandartSapma
				DROP TABLE IF EXISTS #Tasp
				DROP TABLE IF EXISTS #TASPOGRENCI

			END
			ELSE IF	@ID_SINAVTURU = 12	--	BURSLULUK
					AND EXISTS (SELECT TOP 1 ID_SINAV FROM Sinav WHERE ID_SINAV = @ID_SINAV AND OLCEKSINAVI = 1)
			BEGIN
				
				PRINT '37: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),SUM(xTABLE.PUAN)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, socb.ID_SINAVDERS,socb.PUAN
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					--INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					--INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					--INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU


				PRINT '38: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
			END
			ELSE	-- STANDART
			BEGIN
				
				PRINT '37: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

				

				-- #SinavOgrenciPuan
				INSERT INTO #SinavOgrenciPuan(TCKIMLIKNO, ID_SINAVPUANTURU, PUAN)
				SELECT TCKIMLIKNO, ID_SINAVPUANTURU
						,CASE	WHEN EXISTS(SELECT 1 FROM #OGRENCISINAVPUANKRITER WHERE ID_SINAVPUANTURU = xTABLE.ID_SINAVPUANTURU AND TCKIMLIKNO = xTABLE.TCKIMLIKNO AND HESAPDURUM = 0)
								THEN 0
								ELSE (CONVERT(DECIMAL(10,3),xTABLE.TABANPUAN + SUM(xTABLE.NET*xTABLE.KATSAYI)))
						 END AS PUAN 
				FROM
				(
					SELECT	   so.TCKIMLIKNO, spt.ID_SINAVPUANTURU, stp.TABANPUAN, socb.NET, sk.KATSAYI, sd.ID_SINAVDERS
					FROM	   #SinavOgrenci so				WITH (NOLOCK)
					INNER JOIN #SinavOgrenciCevapBolum socb	WITH (NOLOCK) ON socb.ID_SINAVOGRENCI=so.ID_SINAVOGRENCI
					INNER JOIN Sinav s						WITH (NOLOCK) ON s.ID_SINAV=SO.ID_SINAV
					INNER JOIN SinavPuanTuru spt			WITH (NOLOCK) ON spt.ID_SINAVTURU=s.ID_SINAVTURU
					INNER JOIN SinavTabanPuan stp			WITH (NOLOCK) ON stp.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND stp.ID_SINAV=@ID_SINAV
					INNER JOIN SinavDers sd					WITH (NOLOCK) ON sd.ID_SINAVDERS=socb.ID_SINAVDERS
					INNER JOIN SinavKatsayi SK				WITH (NOLOCK) ON sk.ID_SINAVDERS=sd.ID_SINAVDERS AND SK.ID_SINAVPUANTURU=spt.ID_SINAVPUANTURU AND sk.ID_SINAV=s.ID_SINAV
					WHERE so.ID_SINAV=@ID_SINAV
				) xTABLE
				GROUP BY TCKIMLIKNO, ID_SINAVPUANTURU, TABANPUAN


				PRINT '38: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
			END


			PRINT '39: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		IF @ID_SINAVTURU = 12 -- BURSLULUK İSE 
		BEGIN
			UPDATE SO SET 				
					 AD		= SUBSTRING(OGRENCI_ADSOYAD,0,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+1) 
					,SOYAD	= SUBSTRING(OGRENCI_ADSOYAD,LEN(OGRENCI_ADSOYAD)-CHARINDEX(' ',REVERSE(OGRENCI_ADSOYAD),0)+2,LEN(OGRENCI_ADSOYAD)) 
					,SUBENO	= RIGHT('000' + SB.SUBENO, 3)
			FROM #SinavOgrenci						SO  WITH (NOLOCK) 
			INNER JOIN BurslulukSinavOgrenci		BS  WITH (NOLOCK)	ON	BS.ID_SINAV		= SO.ID_SINAV
																		AND BS.TCKIMLIKNO	= SO.TCKIMLIKNO
			INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
			LEFT  JOIN OKYANUSDB.DBO.v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= BS.ID_SUBE
		END

		UPDATE SO SET 
				 AD		= KL.AD
				,SOYAD	= KL.SOYAD
				,SINIF	= SN.AD
				,SUBENO	= RIGHT('000' + SB.SUBENO, 3)
		FROM #SinavOgrenci						SO  WITH (NOLOCK) 
		INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
		INNER JOIN OKYANUSDB.DBO.v3Kullanici	KL	WITH (NOLOCK) ON	KL.TCKIMLIKNO	= SO.TCKIMLIKNO
		INNER JOIN OKYANUSDB.DBO.v3OgrenciTum	KS	WITH (NOLOCK) ON	KS.TCKIMLIKNO	= KL.TCKIMLIKNO AND KS.DONEM = SV.DONEM
		INNER JOIN OKYANUSDB.DBO.v3SinifTum		SN	WITH (NOLOCK) ON	SN.ID_SINIF		= KS.ID_SINIF
		INNER JOIN OKYANUSDB.DBO.v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= KS.ID_SUBE
		

		PRINT '40: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
		
		select distinct SO.TCKIMLIKNO 
		into #OKY_OGRENCI
		FROM #SinavOgrenci						SO	WITH (NOLOCK) 
		INNER JOIN Sinav						SV	WITH (NOLOCK) ON	SV.ID_SINAV		= SO.ID_SINAV
		INNER JOIN OKYANUSDB.DBO.v3OgrenciTum	KS	WITH (NOLOCK) ON	KS.TCKIMLIKNO	= SO.TCKIMLIKNO AND KS.DONEM = SV.DONEM
		

		PRINT '41: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		UPDATE SO SET 
				 SUBENO	= RIGHT('000' + ISNULL( SB.SUBENO,SO.SUBENO), 3)
				,SINIF	= 'OKY-'+ SO.SINIF						
		FROM #SinavOgrenci			SO	WITH (NOLOCK) 
		INNER JOIN SinavDosya		SD	WITH (NOLOCK) ON	SD.ID_SINAVDOSYA= SO.ID_SINAVDOSYA	
		LEFT  JOIN v3Sube			SB	WITH (NOLOCK) ON	SB.ID_SUBE		= SD.ID_SUBE
		WHERE SO.TCKIMLIKNO  NOT IN (SELECT DISTINCT TCKIMLIKNO	   FROM #OKY_OGRENCI)

		DROP TABLE IF EXISTS #OKY_OGRENCI
		
		PRINT '42: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		
		

		DROP TABLE IF EXISTS #SinavDers

		PRINT '57: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

	END

	BEGIN		
				

		PRINT '59: ' + CONVERT( VARCHAR(24), GETDATE(), 121)
	

		----- TOPLAMLAR
		SELECT 
				SO.TCKIMLIKNO
			,SO.ID_SINAV
			,TD = SUM(CB.DOGRU)
			,TY = SUM(CB.YANLIS)
			,TB = SUM(CB.BOS)
			,TN = (CASE @YANLISSAYISI WHEN 0 THEN SUM(CB.DOGRU) ELSE SUM(CB.DOGRU) - (SUM(CB.YANLIS) / @YANLISSAYISI) END)
			,ID_SUBE		= ISNULL(SB.ID_SUBE , 0)
			,ID_SINIF		= ISNULL(OG.ID_SINIF, 0)
			,IL				= ISNULL(SB.IL, '')
			,ILCE			= ISNULL(SB.ILCE, '')
			,SINIF			= SO.SINIF
		INTO #SinavOgrenciToplam 
		FROM #SinavOgrenci						SO
		INNER JOIN Sinav						SV	ON	SV.ID_SINAV				= SO.ID_SINAV
		INNER JOIN #SinavOgrenciCevapBolum		CB	ON	CB.ID_SINAVOGRENCI		= SO.ID_SINAVOGRENCI
		LEFT  JOIN OkyanusDB.dbo.V3Sube			SB	ON	CASt(SB.SUBENO AS INT)	= CASt(SO.SUBENO AS INT)
		LEFT  JOIN OkyanusDB.dbo.V3OgrenciTum	OG	ON	OG.TCKIMLIKNO			= SO.TCKIMLIKNO		AND OG.DONEM = SV.DONEM
		GROUP BY SO.TCKIMLIKNO, SO.ID_SINAV, SB.ID_SUBE, OG.ID_SINIF, SB.IL, SB.ILCE, SO.SINIF
		----------------------------------------------------------------------------------------------------		


	--BEGIN TRAN T_SINAV;

	BEGIN
		DELETE FROM SinavOgrenci 
		WHERE ID_SINAV = @ID_SINAV


		DELETE FROM SinavOgrenciToplam
		WHERE ID_SINAV = @ID_SINAV

		DELETE FROM SinavOgrenciPuan
		WHERE ID_SINAV = @ID_SINAV
				
		DELETE FROM BurslulukSinavOgrenciSonuc
		WHERE ID_SINAV = @ID_SINAV

	END

	PRINT '60: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	INSERT INTO [dbo].[SinavOgrenci]
				([ID_SINAV]
				,[TCKIMLIKNO]
				,[AD]
				,[SOYAD]
				,[KITAPCIK]
				,[SUBENO]
				,[SINIF]
				,[ID_SINAVDOSYA]
				,[ID_SINAVOPTIKTEMP]
				,TEMP_ID_SINAVOGRENCI
				,TEMP_GUID)
			SELECT
				 SO.[ID_SINAV]
				,SO.[TCKIMLIKNO]
				,SO.[AD]
				,SO.[SOYAD]
				,SO.[KITAPCIK]
				,SO.[SUBENO]
				,SO.[SINIF]
				,SO.[ID_SINAVDOSYA]
				,SO.[ID_SINAVOPTIKTEMP]
				,SO.ID_SINAVOGRENCI
				,@GUID
			FROM #SinavOgrenci				SO


	PRINT '61: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	UPDATE CB SET CB.ID_SINAVOGRENCI = SO.ID_SINAVOGRENCI
	FROM #SinavOgrenciCevapBolum	CB
	JOIN SinavOgrenci				SO	ON	SO.TEMP_ID_SINAVOGRENCI = CB.ID_SINAVOGRENCI AND SO.TEMP_GUID = @GUID AND SO.ID_SINAV = @ID_SINAV

	PRINT '62: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

	

			--	PUANLAR
			INSERT INTO SinavOgrenciPuan(ID_SINAV, TCKIMLIKNO, ID_SINAVPUANTURU, PUAN, GENELSIRA, ILSIRA, ILCESIRA, OKULSIRA, SINIFSIRA)
			SELECT DISTINCT
			 @ID_SINAV
			,TCKIMLIKNO
			,ID_SINAVPUANTURU
			,PUAN
			,GENELSIRA
			,ILSIRA
			,ILCESIRA
			,OKULSIRA
			,SINIFSIRA
			FROM #SinavOgrenciPuan

		
		
			SELECT DISTINCT
				 SO.TCKIMLIKNO
				,SO.ID_SINAV
				,SC.ID_SINAVPUANTURU
				,SC.PUAN
				,ID_SUBE		= ISNULL(ST.ID_SUBE , 0)
				,ID_SINIF		= ISNULL(ST.ID_SINIF, 0)
				,IL				= ISNULL(ST.IL, '')
				,ILCE			= ISNULL(ST.ILCE, '')
				,SINIF			= SO.SINIF
			INTO #SinavOgrenciPuanSiraPuan
			FROM SinavOgrenci						SO
			INNER JOIN Sinav						SV	ON	SV.ID_SINAV	= SO.ID_SINAV
			INNER JOIN SinavOgrenciPuan				SC	ON	SC.ID_SINAV	= SV.ID_SINAV	AND SC.TCKIMLIKNO	= SO.TCKIMLIKNO	
			LEFT JOIN  #SinavOgrenciToplam			ST  ON  ST.ID_SINAV	= SV.ID_SINAV	AND ST.TCKIMLIKNO	= SO.TCKIMLIKNO
			--LEFT  JOIN OkyanusDB.dbo.V3Sube			SB	ON	CASt(SB.SUBENO AS INT)	= CASt(SO.SUBENO AS INT)
			--LEFT  JOIN OkyanusDB.dbo.v3OgrenciTum	OG	ON	OG.TCKIMLIKNO			= SO.TCKIMLIKNO AND OG.DONEM = SV.DONEM
			WHERE SV.ID_SINAV = @ID_SINAV	

			SELECT	 *
					,GENELSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU								ORDER BY PUAN DESC)
					,ILSIRA			= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, IL							ORDER BY PUAN DESC)
					,ILCESIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, IL, ILCE					ORDER BY PUAN DESC) 
					,OKULSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, ID_SUBE					ORDER BY PUAN DESC)
					,SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY ID_SINAV, ID_SINAVPUANTURU, ID_SUBE, ID_SINIF, SINIF	ORDER BY PUAN DESC)
			INTO #SinavOgrenciPuanSira
			FROM #SinavOgrenciPuanSiraPuan

			UPDATE SC	set 
					 GENELSIRA		= OG.GENELSIRA	
					,ILSIRA			= OG.ILSIRA		
					,ILCESIRA		= OG.ILCESIRA	
					,OKULSIRA		= OG.OKULSIRA	
					,SINIFSIRA		= OG.SINIFSIRA	
			FROM SinavOgrenciPuan				SC
			INNER JOIN SinavOgrenci				SO	ON	SO.TCKIMLIKNO = SC.TCKIMLIKNO
			INNER JOIN #SinavOgrenciPuanSira	OG	ON	OG.TCKIMLIKNO = SO.TCKIMLIKNO AND OG.ID_SINAV = SO.ID_SINAV AND OG.ID_SINAVPUANTURU = SC.ID_SINAVPUANTURU
			WHERE SC.ID_SINAV = @ID_SINAV

			DROP TABLE #SinavOgrenciPuanSiraPuan
			DROP TABLE #SinavOgrenciPuanSira 



			INSERT INTO [dbo].[SinavOgrenciSonuc]
							([ID_SINAVOGRENCI]
							,[ID_SINAVPUANTURU]
							,[PUAN]
							,GENELSIRA
							,ILSIRA
							,ILCESIRA
							,OKULSIRA
							,SINIFSIRA)

		SELECT 
							 SO.ID_SINAVOGRENCI
							,SP.ID_SINAVPUANTURU
							,SP.PUAN
							,SP.GENELSIRA
							,SP.ILSIRA
							,SP.ILCESIRA
							,SP.OKULSIRA
							,SP.SINIFSIRA
		FROM SinavOgrenci				SO
		INNER JOIN SinavOgrenciPuan		SP	ON	SP.TCKIMLIKNO = SO.TCKIMLIKNO AND SP.ID_SINAV = SO.ID_SINAV
		WHERE SP.ID_SINAV = @ID_SINAV
			--------------------------------------------------------------------


		PRINT '64: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		SELECT 
				 SO.[ID_SINAVOGRENCI]
				,SO.[ID_SINAVDERS]
				,SO.[CEVAPLAR]
				,SO.[DOGRU]
				,SO.[YANLIS]
				,SO.[BOS]
				,SO.[NET]
				,SO.[YUZDEDOGRU]
				,SO.[YUZDENET]
				,SO.[PUAN]
				,SO.ID_SINAVOGRENCICEVAPBOLUM
				,GUID = @GUID
				,PUAN_GENELSIRA		= 0
				,PUAN_ILSIRA		= 0
				,PUAN_ILCESIRA		= 0
				,PUAN_OKULSIRA		= 0
				,PUAN_SINIFSIRA		= 0
				,ST.IL
				,ST.ILCE
				,ST.ID_SUBE
				,ST.ID_SINIF
				,ST.SINIF
		INTO #SinavOgrenciCevapBolumSira
		FROM #SinavOgrenciCevapBolum	SO
		JOIN #SinavOgrenciToplam		ST	ON	ST.TCKIMLIKNO = SO.TCKIMLIKNO


		INSERT INTO [dbo].[SinavOgrenciCevapBolum]
					([ID_SINAVOGRENCI]
					,[ID_SINAVDERS]
					,[CEVAPLAR]
					,[DOGRU]
					,[YANLIS]
					,[BOS]
					,[NET]
					,[YUZDEDOGRU]
					,[YUZDENET]
					,[PUAN]
					,TEMP_ID_SINAVOGRENCICEVAPBOLUM
					,TEMP_GUID
					,PUAN_GENELSIRA
					,PUAN_ILSIRA
					,PUAN_ILCESIRA
					,PUAN_OKULSIRA
					,PUAN_SINIFSIRA

					,NET_GENELSIRA
					,NET_ILSIRA
					,NET_ILCESIRA
					,NET_OKULSIRA
					,NET_SINIFSIRA

					,DOGRU_GENELSIRA
					,DOGRU_ILSIRA
					,DOGRU_ILCESIRA
					,DOGRU_OKULSIRA
					,DOGRU_SINIFSIRA
					
					
					
					)
		SELECT 
					 SO.[ID_SINAVOGRENCI]
					,SO.[ID_SINAVDERS]
					,SO.[CEVAPLAR]
					,SO.[DOGRU]
					,SO.[YANLIS]
					,SO.[BOS]
					,SO.[NET]
					,SO.[YUZDEDOGRU]
					,SO.[YUZDENET]
					,SO.[PUAN]
					,SO.ID_SINAVOGRENCICEVAPBOLUM
					,@GUID
					,PUAN_GENELSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.PUAN DESC)
					,PUAN_ILSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.PUAN DESC)
					,PUAN_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.PUAN DESC)
					,PUAN_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.PUAN DESC)
					,PUAN_SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.PUAN DESC)
					
					,NET_GENELSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.NET DESC)
					,NET_ILSIRA			= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.NET DESC)
					,NET_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.NET DESC)
					,NET_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.NET DESC)
					,NET_SINIFSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.NET DESC)
					
					,DOGRU_GENELSIRA	= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS										ORDER BY SO.DOGRU DESC)
					,DOGRU_ILSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL									ORDER BY SO.DOGRU DESC)
					,DOGRU_ILCESIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.IL, SO.ILCE						ORDER BY SO.DOGRU DESC)
					,DOGRU_OKULSIRA		= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE							ORDER BY SO.DOGRU DESC)
					,DOGRU_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY SO.ID_SINAVDERS, SO.ID_SUBE, SO.ID_SINIF, SO.SINIF		ORDER BY SO.DOGRU DESC)
			FROM #SinavOgrenciCevapBolumSira	SO


			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #GENELORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,IL
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #ILORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,IL

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,IL
				,ILCE
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #ILCEORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,IL,ILCE

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,ID_SUBE
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #OKULORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS,ID_SUBE

			SELECT
				 SO.ID_SINAV
				,CB.ID_SINAVDERS
				,ST.ID_SUBE
				,ST.ID_SINIF
				,ST.SINIF
				,NET_ORT		= AVG(NET)
				,DOGRU_ORT		= AVG(CAST(DOGRU AS float))
				,YUZDENET_ORT	= AVG(YUZDENET)
			INTO #SINIFORT
			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN #SinavOgrenciToplam	ST	ON	ST.ID_SINAV = SO.ID_SINAV AND ST.TCKIMLIKNO = SO.TCKIMLIKNO
			WHERE SO.ID_SINAV = @ID_SINAV
			GROUP BY  SO.ID_SINAV, CB.ID_SINAVDERS, ST.ID_SUBE, ST.ID_SINIF, ST.SINIF
			


			UPDATE CB SET
				 CB.NET_GENELORT		=  G.NET_ORT
				,CB.NET_ILORT			=  I.NET_ORT
				,CB.NET_ILCEORT			= IC.NET_ORT
				,CB.NET_OKULORT			=  O.NET_ORT
				,CB.NET_SINIFORT		=  S.NET_ORT
								
				,CB.DOGRU_GENELORT		=  G.DOGRU_ORT
				,CB.DOGRU_ILORT			=  I.DOGRU_ORT
				,CB.DOGRU_ILCEORT		= IC.DOGRU_ORT
				,CB.DOGRU_OKULORT		=  O.DOGRU_ORT
				,CB.DOGRU_SINIFORT		=  S.DOGRU_ORT
				
				,CB.YUZDENET_GENELORT	=  G.YUZDENET_ORT
				,CB.YUZDENET_ILORT		=  I.YUZDENET_ORT
				,CB.YUZDENET_ILCEORT	= IC.YUZDENET_ORT
				,CB.YUZDENET_OKULORT	=  O.YUZDENET_ORT
				,CB.YUZDENET_SINIFORT	=  S.YUZDENET_ORT

			FROM SinavOgrenciCevapBolum		CB
			JOIN SinavOgrenci				SO	ON	SO.ID_SINAVOGRENCI	= CB.ID_SINAVOGRENCI
			LEFT JOIN  #SinavOgrenciToplam	ST	ON	ST.ID_SINAV			= SO.ID_SINAV		AND ST.TCKIMLIKNO   = SO.TCKIMLIKNO
			LEFT JOIN  #GENELORT			G	ON	 G.ID_SINAVDERS		= CB.ID_SINAVDERS 
			LEFT JOIN  #ILORT				I	ON	 I.ID_SINAVDERS		= CB.ID_SINAVDERS	AND I.IL		= ST.IL
			LEFT JOIN  #ILCEORT				IC	ON	IC.ID_SINAVDERS		= CB.ID_SINAVDERS	AND IC.IL		= ST.IL			AND IC.ILCE = ST.ILCE
			LEFT JOIN  #OKULORT				O	ON	 O.ID_SINAVDERS		= CB.ID_SINAVDERS	AND O.ID_SUBE	= ST.ID_SUBE
			LEFT JOIN  #SINIFORT			S	ON	 S.ID_SINAVDERS		= CB.ID_SINAVDERS	AND S.ID_SUBE	= ST.ID_SUBE	AND S.ID_SINIF	= ST.ID_SINIF	AND S.SINIF	= ST.SINIF
			WHERE SO.ID_SINAV = @ID_SINAV




			DROP TABLE #GENELORT
			DROP TABLE #ILCEORT
			DROP TABLE #ILORT
			DROP TABLE #OKULORT
			DROP TABLE #SINIFORT

			DROP TABLE #SinavOgrenciCevapBolumSira

			
		
		PRINT '65: ' + CONVERT( VARCHAR(24), GETDATE(), 121)

		UPDATE CB SET CB.ID_SINAVOGRENCICEVAPBOLUM = SO.ID_SINAVOGRENCICEVAPBOLUM
		FROM #SinavOgrenciCevap			CB
		JOIN SinavOgrenciCevapBolum		SO	ON	SO.TEMP_ID_SINAVOGRENCICEVAPBOLUM = CB.ID_SINAVOGRENCICEVAPBOLUM AND SO.TEMP_GUID = @GUID
		JOIN SinavDers					SD	ON	SD.ID_SINAVDERS	= SO.ID_SINAVDERS	AND SD.ID_SINAV = @ID_SINAV


		PRINT '66: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


		INSERT INTO SinavOgrenciCevap
							([ID_SINAVOGRENCICEVAPBOLUM]
							,[SORUNO]
							,[CEVAP]
							,[DURUM])
		SELECT
							 [ID_SINAVOGRENCICEVAPBOLUM]
							,[SORUNO]
							,[CEVAP]
							,[DURUM]
			FROM #SinavOgrenciCevap

	
	
		INSERT INTO [dbo].[SinavOgrenciToplam]
           ([TCKIMLIKNO]
           ,[ID_SINAV]
           ,[TD]
           ,[TY]
           ,[TB]
           ,[TN]
           ,[TD_GENELSIRA]
           ,[TD_ILSIRA]
           ,[TD_ILCESIRA]
           ,[TD_OKULSIRA]
           ,[TD_SINIFSIRA]
           ,[TN_GENELSIRA]
           ,[TN_ILSIRA]
           ,[TN_ILCESIRA]
           ,[TN_OKULSIRA]
           ,[TN_SINIFSIRA]
		   ,KATILIM_GENEL
		   ,KATILIM_IL
		   ,KATILIM_ILCE
		   ,KATILIM_OKUL
		   ,KATILIM_SINIF)

		SELECT 
			 TCKIMLIKNO
			,ID_SINAV
			,TD
			,TY
			,TB
			,TN
			,TD_GENELSIRA	= DENSE_RANK() OVER(										ORDER BY TD DESC)
			,TD_ILSIRA		= DENSE_RANK() OVER(PARTITION BY IL							ORDER BY TD DESC)
			,TD_ILCESIRA	= DENSE_RANK() OVER(PARTITION BY ILCE						ORDER BY TD DESC)
			,TD_OKULSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE					ORDER BY TD DESC)
			,TD_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE, ID_SINIF, SINIF	ORDER BY TD DESC)
			,TN_GENELSIRA	= DENSE_RANK() OVER(										ORDER BY TN DESC)
			,TN_ILSIRA		= DENSE_RANK() OVER(PARTITION BY IL							ORDER BY TN DESC)
			,TN_ILCESIRA	= DENSE_RANK() OVER(PARTITION BY ILCE						ORDER BY TN DESC)
			,TN_OKULSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE					ORDER BY TN DESC)
			,TN_SINIFSIRA	= DENSE_RANK() OVER(PARTITION BY ID_SUBE, ID_SINIF, SINIF	ORDER BY TN DESC) 
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.IL = SO.IL)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.IL = SO.IL AND SUB.ILCE = SO.ILCE)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.ID_SUBE	= SO.ID_SUBE)
			,(SELECT COUNT(DISTINCT SUB.TCKIMLIKNO) FROM #SinavOgrenciToplam	SUB	WHERE SUB.ID_SUBE	= SO.ID_SUBE	AND SUB.ID_SINIF = SO.ID_SINIF	AND SUB.SINIF = SO.SINIF)
		FROM #SinavOgrenciToplam	SO

	PRINT '67: ' + CONVERT( VARCHAR(24), GETDATE(), 121)


	IF (SELECT ID_SINAVTURU FROM Sinav WHERE ID_SINAV = @ID_SINAV) = 12 -- BURSLULUK İSE
	BEGIN
	
			
		DROP TABLE IF EXISTS #W_BURS
		DROP TABLE IF EXISTS #TEMP_BURS
		DROP TABLE IF EXISTS #BURSPUAN
		DROP TABLE IF EXISTS #BURSDERS

	
			BEGIN	--	PUAN

				SELECT TCKIMLIKNO,PUAN,BO.*,ROW_NUMBER () OVER(PARTITION BY ID_BURSORAN ORDER BY PUAN DESC) RN
				INTO #BURSPUAN
				FROM vw_SinavOgrenciPuan		SP
				JOIN BurslulukSinavBursOrani	BO	ON	BO.BURSTUR		= 1	-- PUAN
													AND BO.MIN_DEGER	<= SP.PUAN
				WHERE SP.ID_SINAV = @ID_SINAV 

				CREATE TABLE #TEMP_BURS (TCKIMLIKNO VARCHAR(11),BURSORANI INT,ID_SINAV INT ,ID_SINAVDERS INT ,BURSTUR INT)

				SELECT MIN_DEGER,BURSORANI,OGRENCISAYISI,ROW_NUMBER () OVER(ORDER BY BURSORANI DESC) RN INTO #W_BURS FROM BurslulukSinavBursOrani WHERE ID_SINAV = @ID_SINAV AND BURSTUR = 1

				DECLARE	 @COUNT_BURS	INT = (SELECT COUNT(1) FROM #W_BURS)
						,@I_BURS		INT = 1
						,@MIN_DEGER		INT
						,@BURSORANI		INT
						,@OGRENCISAYISI INT

				WHILE (@I_BURS <= @COUNT_BURS)
				BEGIN
					SELECT @MIN_DEGER=MIN_DEGER,@BURSORANI=BURSORANI,@OGRENCISAYISI=OGRENCISAYISI FROM #W_BURS WHERE RN = @I_BURS

					INSERT INTO #TEMP_BURS  (TCKIMLIKNO,BURSORANI,ID_SINAV,BURSTUR)
					SELECT TOP (@OGRENCISAYISI) TCKIMLIKNO,@BURSORANI,ID_SINAV,BURSTUR
					FROM #BURSPUAN BP				
					WHERE	PUAN >= @MIN_DEGER
						AND TCKIMLIKNO NOT IN (SELECT TCKIMLIKNO FROM #TEMP_BURS)

					SET @I_BURS = @I_BURS +1 
				END
			
				INSERT INTO BurslulukSinavOgrenciSonuc (TCKIMLIKNO,BURSORANI,ID_SINAV,BURSTUR)
				SELECT TCKIMLIKNO,BURSORANI,@ID_SINAV,1 FROM #TEMP_BURS 

			END


			BEGIN	--	DERS
				SELECT TCKIMLIKNO,YUZDENET,BO.*
				INTO #BURSDERS
				FROM vw_SinavOgrenciBolum		SB
				JOIN BurslulukSinavBursOrani	BO	ON	BO.ID_SINAVDERS	= SB.ID_SINAVDERS
													AND	BO.BURSTUR		= 2	-- PUAN
													AND BO.MAX_DEGER	>= SB.YUZDENET
													AND BO.MIN_DEGER	<= SB.YUZDENET
				WHERE SB.ID_SINAV = @ID_SINAV

				INSERT INTO BurslulukSinavOgrenciSonuc (TCKIMLIKNO,BURSORANI,ID_SINAV,ID_SINAVDERS,BURSTUR)
				SELECT TCKIMLIKNO,BURSORANI,ID_SINAV,ID_SINAVDERS,BURSTUR
				FROM #BURSDERS
				ORDER BY BURSORANI DESC
			END

			
		DROP TABLE IF EXISTS #W_BURS
		DROP TABLE IF EXISTS #TEMP_BURS
		DROP TABLE IF EXISTS #BURSPUAN
		DROP TABLE IF EXISTS #BURSDERS

	END

	--COMMIT TRAN T_SINAV

	
	
	UPDATE Sinav	SET DURUM = 2, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV	


	IF EXISTS (SELECT TOP 1 TCKIMLIKNO FROM SinavOgrenciHariciPuanSiralama WHERE ID_SINAV = @ID_SINAV)
		EXEC [dbo].[sp_SinavHariciPuanSira] @ISLEM = 3, @DOGRULAMA = '693M161f1Sv595Y', @ID_SINAV = @ID_SINAV	-- PUAN VE SIRALAMA BILGILERINI DEĞİŞTİRİYOR


	DROP TABLE IF EXISTS #SinavOgrenci
	DROP TABLE IF EXISTS #SinavOgrenciCevap
	DROP TABLE IF EXISTS #SinavOgrenciCevapBolum
	DROP TABLE IF EXISTS #SinavSonTyt
	DROP TABLE IF EXISTS #SinavOgrenciToplam

	DROP TABLE IF EXISTS #SinavSoruIslem
	DROP TABLE IF EXISTS #Temp
	DROP TABLE IF EXISTS #Temp2
	DROP TABLE IF EXISTS #OGRENCISINAVPUANKRITER

	END
	
	END TRY
	BEGIN CATCH
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = 'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' + ERROR_MESSAGE() + ', ID_SINAV: ' + CAST(@ID_SINAV AS VARCHAR)

		EXEC sp_HataMailiGonder @MSG,
								@ErrorSeverity,@ErrorState,'sp_OptikIslemleri'

		
		UPDATE SinavDegerlendir SET AKTIF = 0							WHERE ID_SINAV	= @ID_SINAV
		UPDATE Sinav			SET DURUM = 0, DEGERLENDIRILIYOR = 0	WHERE ID_SINAV	= @ID_SINAV
		
		--IF(@@TRANCOUNT > 0)
		--	ROLLBACK TRAN T_SINAV
		
		--IF (XACT_STATE()) = -1
		--  BEGIN
		--	 ROLLBACK TRAN T_SINAV;
		--  END;
	  	
		RAISERROR (@MSG , -- Message text.
					@ErrorSeverity, -- Severity.
					@ErrorState -- State.
					);
	END CATCH;
	
END
GO
PRINT N'Altering [dbo].[sp_SinavDegerlendir]...';


GO
-- =============================================
-- Author:		Tahsin Dalman
-- Create date: 17.11.2017
-- Description:	Sınav Değerlendirme işlemleri. (Job)
-- =============================================
ALTER procedure [dbo].[sp_SinavDegerlendir]
AS
BEGIN
	BEGIN TRY
		--BEGIN TRAN
			
			DECLARE @ID_SINAV int, @ID_SINAVDEGERLENDIR INT, @ID_SINAVDOSYA INT

			INSERT INTO SinavDegerlendir (ID_SINAV,  KYE_TCKIMLIKNO)
			SELECT DISTINCT S.ID_SINAV, '32051057542'
			FROM Sinav					S
			JOIN Tbl_OnlineSinavDetay	SD	ON	SD.ID_SINAV	= S.ID_SINAV
			WHERE	S.AKTIF				= 1
				AND S.DURUM				!= 2
				AND S.ONLINESINAV		= 1
				AND S.DEGERLENDIRILIYOR = 0
				AND SD.AKTIF			= 1
				AND SD.ACIKLANMATARIH	<= GETDATE()
				AND SD.BITACIKLANMATARIH >= GETDATE()
				AND NOT EXISTS (SELECT TOP 1 1 FROM SinavDegerlendir D WHERE D.ID_SINAV = S.ID_SINAV)

				
			SELECT S.ID_SINAV, MINTARIH = MIN(SD.KYE_TARIH)
			INTO #Sinav 
			FROM SinavDegerlendir	SD
			JOIN Sinav				S	ON	S.ID_SINAV			= SD.ID_SINAV 
										AND S.DEGERLENDIRILIYOR = 0
			WHERE SD.AKTIF = 1 
			GROUP BY S.ID_SINAV
		


			SELECT TOP 1 @ID_SINAV = S.ID_SINAV
			FROM #Sinav	S
			ORDER BY MINTARIH


			SELECT TOP 1 @ID_SINAV = D.ID_SINAV, @ID_SINAVDEGERLENDIR = D.ID_SINAVDEGERLENDIR
			FROM SinavDegerlendir	D
			WHERE D.ID_SINAV = @ID_SINAV AND D.AKTIF = 1
			ORDER BY D.ID_SINAVDEGERLENDIR DESC

			DROP TABLE #Sinav
			
						
			IF @ID_SINAV IS NOT NULL
			BEGIN			
				
				DECLARE @TBL_LOG TABLE(ID_LOG INT)

				INSERT INTO [dbo].[SinavDegerlendirLog](ID_SINAV, ID_SINAVDEGERLENDIR) 
				OUTPUT INSERTED.ID_LOG INTO @TBL_LOG
				VALUES(@ID_SINAV, @ID_SINAVDEGERLENDIR)

				DECLARE @BASLANGIC DATETIME = NULL, @BITIS DATETIME = NULL, @FARK INT = NULL

				SET @BASLANGIC = GETDATE()

				-- Optik Değerlendirme İşlemleri
				EXEC	[dbo].[sp_OptikIslemleri]
						@ID_SINAV = @ID_SINAV,
						@ISLEM = 0,
						@ID_SINAVDOSYA = NULL--@ID_SINAVDOSYA

				SET @BITIS = GETDATE()

				SET @FARK = datediff(SECOND, @BASLANGIC, @BITIS)

				UPDATE [dbo].[SinavDegerlendirLog] 
					SET 
						SURE = @FARK
				WHERE ID_LOG IN(SELECT T.ID_LOG FROM @TBL_LOG	T)

				UPDATE SinavDegerlendir SET AKTIF = 0 WHERE ID_SINAV = @ID_SINAV AND ID_SINAVDEGERLENDIR <= @ID_SINAVDEGERLENDIR

			END
		
			--UPDATE SinavDegerlendir SET AKTIF = 0 WHERE ID_SINAV = @ID_SINAV
			--UPDATE Sinav			SET DURUM = 2 WHERE ID_SINAV = @ID_SINAV
		--COMMIT TRAN

	END TRY
	BEGIN CATCH
		DECLARE @MSG			VARCHAR(4000)
		DECLARE @ErrorSeverity	INT
		DECLARE @ErrorState		INT
		SELECT 
			@ErrorSeverity	= ERROR_SEVERITY(),
			@ErrorState		= ERROR_STATE()
							
		SELECT @MSG = 'Prosedür: ' + ISNULL(ERROR_PROCEDURE(), '') + ', Satır: ' + CAST(ERROR_LINE() as varchar) + ', Hata: ' + ERROR_MESSAGE()
		
		UPDATE SinavDegerlendir SET AKTIF = 0 WHERE ID_SINAV	= @ID_SINAV
		UPDATE Sinav			SET DURUM = 0 WHERE ID_SINAV	= @ID_SINAV

		EXEC sp_HataMailiGonder @MSG,
								@ErrorSeverity,@ErrorState,'sp_SinavDegerlendir'

		--IF(@@TRANCOUNT > 0)
		--	ROLLBACK TRAN

	END CATCH
END
GO
PRINT N'Refreshing [dbo].[fn_SinavOgrenciToplamDYBN]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[fn_SinavOgrenciToplamDYBN]';


GO
PRINT N'Refreshing [dbo].[sp_v2FrekansOgrenciHesapla]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_v2FrekansOgrenciHesapla]';


GO
PRINT N'Refreshing [dbo].[sp_OnlineSinavMailYolla]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OnlineSinavMailYolla]';


GO
PRINT N'Refreshing [dbo].[sp_Filtre]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Filtre]';


GO
PRINT N'Refreshing [dbo].[sp_RehberlikOnlineYukle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_RehberlikOnlineYukle]';


GO
PRINT N'Refreshing [dbo].[sp_OnlineDers]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OnlineDers]';


GO
PRINT N'Refreshing [dbo].[sp_AkilliOgretimBarkod]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AkilliOgretimBarkod]';


GO
PRINT N'Refreshing [dbo].[sp_AmazonChime]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AmazonChime]';


GO
PRINT N'Refreshing [dbo].[sp_AssessmentSinavaKatilmayanlar]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AssessmentSinavaKatilmayanlar]';


GO
PRINT N'Refreshing [dbo].[sp_AssessmentSinavOgrenciRaporu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AssessmentSinavOgrenciRaporu]';


GO
PRINT N'Refreshing [dbo].[sp_AssessmentSinavSoruAnalizi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_AssessmentSinavSoruAnalizi]';


GO
PRINT N'Refreshing [dbo].[sp_Bulten]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Bulten]';


GO
PRINT N'Refreshing [dbo].[sp_CurpusStudyYukle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_CurpusStudyYukle]';


GO
PRINT N'Refreshing [dbo].[sp_DegerlendirmeFormu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_DegerlendirmeFormu]';


GO
PRINT N'Refreshing [dbo].[sp_Fatura]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Fatura]';


GO
PRINT N'Refreshing [dbo].[sp_FrekansEtkiListesi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_FrekansEtkiListesi]';


GO
PRINT N'Refreshing [dbo].[sp_GenelHak]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_GenelHak]';


GO
PRINT N'Refreshing [dbo].[sp_MentalUp]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_MentalUp]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciBilgiSistemi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciBilgiSistemi]';


GO
PRINT N'Refreshing [dbo].[sp_OgrenciHarcama]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OgrenciHarcama]';


GO
PRINT N'Refreshing [dbo].[sp_OsOdevListele]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OsOdevListele]';


GO
PRINT N'Refreshing [dbo].[sp_OzelSayfaIslemleri]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OzelSayfaIslemleri]';


GO
PRINT N'Refreshing [dbo].[sp_Parametre]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Parametre]';


GO
PRINT N'Refreshing [dbo].[sp_RehberDanismanYoklama]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_RehberDanismanYoklama]';


GO
PRINT N'Refreshing [dbo].[sp_SinifDersProgram]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifDersProgram]';


GO
PRINT N'Refreshing [dbo].[sp_SinifListeRaporu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifListeRaporu]';


GO
PRINT N'Refreshing [dbo].[sp_SinifOgretmenListesi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinifOgretmenListesi]';


GO
PRINT N'Refreshing [dbo].[sp_TercihListeRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_TercihListeRapor]';


GO
PRINT N'Refreshing [dbo].[sp_UniteTaramaSinavSonucListesi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_UniteTaramaSinavSonucListesi]';


GO
PRINT N'Refreshing [dbo].[sp_UniteTaramaTopluKarne]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_UniteTaramaTopluKarne]';


GO
PRINT N'Refreshing [dbo].[sp_UyariSistemleri]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_UyariSistemleri]';


GO
PRINT N'Refreshing [dbo].[sp_v2FrekansEtkiListesi]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_v2FrekansEtkiListesi]';


GO
PRINT N'Refreshing [dbo].[sp_VeliUniteTaramaRaporu]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_VeliUniteTaramaRaporu]';


GO
PRINT N'Refreshing [dbo].[sp_ViuBildirimRapor]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_ViuBildirimRapor]';


GO
PRINT N'Refreshing [dbo].[sp_ViuRandevuTakip]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_ViuRandevuTakip]';


GO
PRINT N'Refreshing [dbo].[sp_WhatsApp]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_WhatsApp]';


GO
PRINT N'Refreshing [dbo].[sp_YG_KotaBelirle]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YG_KotaBelirle]';


GO
PRINT N'Refreshing [dbo].[sp_YG_SecimYapmayanlar]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_YG_SecimYapmayanlar]';


GO
PRINT N'Refreshing [dbo].[sp_Yillik]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_Yillik]';


GO
PRINT N'Refreshing [dbo].[sp_FiltreEk]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_FiltreEk]';


GO
PRINT N'Refreshing [dbo].[sp_FrekansSinavOgrenci]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_FrekansSinavOgrenci]';


GO
PRINT N'Refreshing [dbo].[sp_OptikIslemleri]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_OptikIslemleri]';


GO
PRINT N'Refreshing [dbo].[sp_SinavDegerlendirTumSinavlar]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[sp_SinavDegerlendirTumSinavlar]';


GO
PRINT N'Reenabling DDL triggers...'
GO
ENABLE TRIGGER [CaptureStoredProcedureChanges] ON DATABASE
GO
PRINT N'Update complete.';


GO
